ä½ å¥½ï¼Œæˆ‘æ˜¯æŸ³èƒœã€‚

ä¸Šä¸€è®²ï¼Œæˆ‘ä»¬å†™äº†OrderServiceTestæµ‹è¯•ç±»ï¼Œæ¥æµ‹è¯•FoodComeçš„OrderServiceç±»ã€‚è¿™æ ·ä¸ç®¡å¼€å‘ä»£ç è¿˜æ˜¯æµ‹è¯•ä»£ç ï¼Œéƒ½æ˜¯ç®€å•æ¸…æ¥šçš„ã€‚è¿™æ˜¯å› ä¸ºFoodComeçš„å¼€å‘äººå‘˜å¯¹ä»£ç æœ‰ä¸€ä¸ªå¥½çš„è®¾è®¡ï¼Œå®ç°äº†Controllerã€Serviceã€Repositoryç­‰Classçš„èŒèƒ½åˆ’åˆ†ï¼ŒOrderServiceç±»é‡Œä¸“æ³¨è®¢å•ç®¡ç†ï¼Œæˆ‘ä»¬å†™å‡ºçš„OrderServiceTestæ‰èƒ½é›†ä¸­ç«åŠ›æµ‹è¯•ã€‚

ä½†æ˜¯å¥½çš„è®¾è®¡ä¸æ˜¯å¤©ä¸Šæ‰ä¸‹æ¥çš„ï¼Œæœ‰çš„å›¢é˜Ÿåœ¨åˆšä¸€å¼€å§‹å†™çš„ä»£ç ç»“æ„æ€§å¹¶ä¸å¥½ï¼Œè¿™æœ‰å¯èƒ½æ˜¯é¡¹ç›®çš„é—®é¢˜ï¼Œéœ€æ±‚ä¸æ˜ç¡®ã€èµ¶è¿›åº¦ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å¼€å‘äººå‘˜çš„æŠ€æœ¯åŠŸåº•ä¸æ‰å®ã€æŠ½è±¡èƒ½åŠ›ä¸å¤Ÿã€‚æ‰€ä»¥ï¼Œåœ¨è½¯ä»¶ç”Ÿå‘½å‘¨æœŸå†…ï¼Œéœ€è¦æŒç»­é‡æ„ï¼Œæ‰èƒ½æ‰“ç£¨å‡ºå¥½çš„è®¾è®¡ã€‚

ä»Šå¤©æˆ‘ä»¬å°±ç”¨ä¸€ä¸ªä¾‹å­ï¼Œæ¥çœ‹çœ‹å¥½çš„ä»£ç è®¾è®¡æ˜¯æ€ä¹ˆæ‰“ç£¨å‡ºæ¥çš„ï¼Œè€Œä¸”ï¼Œæˆ‘ä»¬è¦ä»æµ‹è¯•çš„è§’åº¦æ¥è¯„ä¼°è®¾è®¡çš„æ•ˆæœï¼Œé‚£å°±æ˜¯å•å…ƒæµ‹è¯•å®¹æ˜“å†™ã€è¦†ç›–ç‡é«˜ã€å¹²å‡€æ˜“æ‡‚ï¼Œè¿™åˆå«ä»£ç å¯æµ‹è¯•æ€§ã€‚

ä½œä¸ºè‡ªåŠ¨åŒ–æµ‹è¯•æ¶æ„å¸ˆï¼Œä½ éœ€è¦æŒæ¡è§‚å¯Ÿå’Œè¯„ä¼°ä»£ç å¯æµ‹è¯•æ€§çš„èƒ½åŠ›ï¼Œæœ‰èƒ½åŠ›æ¨åŠ¨ä½ çš„å¼€å‘å›¢é˜Ÿåšå¥½ä»£ç è®¾è®¡ï¼Œèµ°å‘å•å…ƒæµ‹è¯•ã€‚

## ä»ä¸€ä¸ªéœ€æ±‚è¯´èµ·

æœ‰ä¸€å¤©ï¼Œè€æ¿ç»™FoodComeè®¢é¤ç³»ç»Ÿæäº†ä¸€ä¸ªéœ€æ±‚ï¼Œå¸Œæœ›ç”¨æˆ·åœ¨é¡µé¢ä¸Šå¯ä»¥ä¿®æ”¹è‡ªå·±çš„é‚®ç®±åœ°å€ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/7a/45/7aa7d008a286da48897364228a21cc45.jpg?wh=1920x1284)

è¿™ä¸ªä¿®æ”¹è¡Œä¸ºåç«¯å®ç°èµ·æ¥ä¼¼ä¹å¾ˆç®€å•ï¼Œä¿®æ”¹é‚®ç®±å°±æ˜¯æ›´æ–°æ•°æ®åº“é‡Œçš„ç”¨æˆ·ä¿¡æ¯ã€‚ä½†åœ¨FoodComeå¹³å°ä¸Šæœ‰ä¸€ä¸ªä¸šåŠ¡é€»è¾‘ï¼Œé‚®ç®±åœ°å€åŸŸåå¦‚æœæ˜¯@foodcome.comï¼Œè¿™è¯´æ˜æ˜¯å¹³å°ä¸Šæ³¨å†Œçš„é¤é¦†å•†å®¶ï¼Œå¦åˆ™ï¼Œå°±æ˜¯æ™®é€šé¡¾å®¢ã€‚

è¿™æ ·ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨ç”¨æˆ·ä¿®æ”¹é‚®ç®±çš„æ—¶å€™ï¼ŒåŠ å…¥ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœé‚®ç®±åœ°å€çš„ä¿®æ”¹æ˜¯ä»æ™®é€šåŸŸåˆ°@FoodComeåŸŸï¼Œå•†å®¶åœ¨å¹³å°é‡Œçš„æ•°é‡å°±+1ï¼Œå¦åˆ™ï¼Œå°±-1ã€‚

è¿™ä¸ªéœ€æ±‚çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œæ˜¯å§ã€‚ä½†æ˜¯æˆ‘è¦å‘Šè¯‰ä½ ï¼Œå³ä½¿è¿™ä¹ˆç®€å•çš„é€»è¾‘ï¼Œä¹Ÿéœ€è¦åšå¥½è®¾è®¡ï¼Œå¦åˆ™ï¼Œå†™å‡ºæ¥çš„ä»£ç å¯èƒ½å®Œå…¨æ— æ³•å•å…ƒæµ‹è¯•ï¼Œä¸ä¿¡å°±æ¥çœ‹çœ‹å§ã€‚

## ç‰ˆæœ¬V1

æ—¢ç„¶è€æ¿æäº†éœ€æ±‚ï¼Œè‡ªç„¶è¦èµ¶ç´§å®Œæˆã€‚å¼€å‘äººå‘˜å°èƒœåŒå­¦ç«‹åˆ»åœ¨ä¸‹ç­å‰å®Œæˆäº†ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ–°å»ºäº†ä¸€ä¸ªUserç±»ï¼Œåœ¨Userç±»é‡Œæœ‰ä¸€ä¸ªchangeEmailçš„æ–¹æ³•ï¼Œè´Ÿè´£ä¿®æ”¹é‚®ç®±åœ°å€ã€‚è¿™æ˜¯ç¬¬ä¸€ç‰ˆä»£ç **User.java**ä¸‹çš„å†…å®¹ï¼š

```java
public class User
{
    public int UserId { get; private set; }
    public string Email { get; private set; }
    public UserType Type { get; private set; }

    public void ChangeEmail(int userId, string newEmail)
    {
        //æŸ¥è¯¢å‡ºæ¥ç”¨æˆ·çš„IDï¼Œemailå’Œtype
Â Â Â Â Â Â Â Â object[]Â dataÂ =Â Database.GetUserById(userId);Â Â Â Â Â Â Â Â Â Â Â Â Â 
        UserId = userId;
        Email = (string)data[1];
        Type = (UserType)data[2];
        //å¦‚æœå’Œä¿®æ”¹å‰çš„emailç›¸åŒï¼Œç›´æ¥è¿”å›
        if (Email == newEmail)
            return;
        //ä»æ•°æ®åº“é‡Œè·å¾—å•†å®¶çš„æ•°é‡
        int numberOfRestaurtants = Database.GetRestaurant();
        //åˆ¤æ–­ç”¨æˆ·è¦ä¿®æ”¹çš„ç±»å‹æ˜¯å•†å®¶è¿˜æ˜¯é¡¾å®¢
        string emailDomain = newEmail.Split('@')[1];
        bool isEmailRestaurant = emailDomain == "foodcome.com";
Â Â Â Â Â Â Â Â UserTypeÂ newTypeÂ =Â isEmailRestaurantÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â ?Â UserType.RestaurantÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â :Â UserType.Customer;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
        //å¦‚æœæ˜¯ä¿®æ”¹æˆä¸ºå•†å®¶ï¼Œé‚£ä¹ˆå•†å®¶æ•°é‡+1ï¼Œå¦‚æœæ˜¯ä¿®æ”¹ä¸ºé¡¾å®¢ï¼Œå•†å®¶æ•°é‡-1  
        if (Type != newType)
        {
            int delta = newType == UserType.Restaurant ? 1 : -1;
            int newNumber = numberOfRestaurtants + delta;
            Database.SaveRestaurant(newNumber);   
            MessageBus.SendEmailChangedMessage(UserId, newEmail);                     
        }
        //æäº¤ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹ï¼Œå…¥åº“
        Database.SaveUser(this);                                  
           
    }
}
public enum UserType
{
    Restaurant = 1,
    Employee = 2
}
```

ä¸Šé¢çš„ä»£ç å¹¶ä¸å¤æ‚ï¼Œä¸»è¦åŠŸèƒ½æ˜¯åˆ¤æ–­é‚®ä»¶åœ°å€æ˜¯å¦ä¸ºFoodComeï¼Œç„¶åæ›´æ–°æ•°æ®åº“ï¼Œå‘é€é€šçŸ¥åˆ°æ¶ˆæ¯æ€»çº¿ä¸Šã€‚

é‚£å®ƒçš„å¯æµ‹è¯•æ€§æ€ä¹ˆæ ·å‘¢ï¼Ÿ

æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªä»£ç å¤æ‚åº¦å››è±¡é™æ³•åˆ™æ¥å®Œæˆè¿™ä¸ªè¯„ä¼°ï¼Œå®ƒçš„åŸç†æ˜¯ï¼Œç”¨ä»¥ä¸‹2ä¸ªç»´åº¦æ¥è¯„ä¼°ä»£ç ï¼š

1.é¢†åŸŸå¤æ‚åº¦ï¼Œä»£ç çš„é¢†åŸŸå¤æ‚åº¦è¶Šé«˜ï¼Œé‡Œé¢çš„ä¸šåŠ¡é€»è¾‘å°±è¶Šå¤šã€‚  
2.å¯¹å¤–ä¾èµ–åº¦ï¼Œä¾èµ–åº¦è¶Šé«˜ï¼Œè¯´æ˜ä»£ç å’Œå¤–éƒ¨çš„Classäº¤äº’ç‚¹å¤šã€‚

æ¯ä¸ªç»´åº¦éƒ½æœ‰é«˜ä½ï¼Œ2ä¸ªç»´åº¦çš„é«˜ä½ç»„åˆåœ¨ä¸€èµ·å°±æˆäº†å››ä¸ªè±¡é™ã€‚

1.ä¸šåŠ¡å¤æ‚ã€ä¾èµ–åˆå°‘ï¼Œæ˜¯ä¸šåŠ¡é€»è¾‘é›†ä¸­çš„ä»£ç ã€‚æ¯”å¦‚ä¸šåŠ¡ç®—æ³•ã€‚  
2.ä¸šåŠ¡ç®€å•ã€ä¾èµ–åˆå°‘ï¼Œæ˜¯ä¸€äº›ç®€å•ä»£ç ï¼Œæ¯”å¦‚æ„é€ å‡½æ•°ï¼Œæ•°æ®å¯¹è±¡ç­‰ã€‚  
3.ä¸šåŠ¡å¤æ‚ã€ä¾èµ–å¤šï¼Œæ˜¯å¤æ‚åº¦é«˜çš„ä»£ç ï¼Œæµ‹è¯•èµ·æ¥ä¹Ÿä¼šæ¯”è¾ƒå›°éš¾ã€‚  
4.ä¸šåŠ¡ç®€å•ã€ä¾èµ–å¤šï¼Œæ˜¯ç®¡ç†ä¾èµ–çš„ä»£ç ã€‚æ¯”å¦‚æ¶ˆæ¯æ€»çº¿ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/b8/00/b828cec1b566e1df1ff6640fe5f32900.jpg?wh=1920x1547)

æˆ‘ä»¬è¦æŠŠå¼€å‘çš„ä»£ç æ”¾åˆ°å››ä¸ªè±¡é™é‡Œï¼Œæ¯ä¸ªè±¡é™å¯¹åº”ä¸åŒçš„æµ‹è¯•ç­–ç•¥ã€‚é‚£å°èƒœåŒå­¦çš„User Classï¼Œåº”è¯¥æ”¾åˆ°å“ªä¸ªè±¡é™å‘¢ï¼Ÿ

User Classé‡ŒåŒ…å«äº†changeEmailçš„ä¸šåŠ¡é€»è¾‘ï¼Œå°±æ˜¯æ ¹æ®Emailçš„åœ°å€å†³å®šå¦‚ä½•å˜æ›´Restaurantçš„æ•°é‡ã€‚åŒæ—¶ï¼ŒUser Classé‡Œè¿˜æœ‰2ä¸ªå¤–éƒ¨ä¾èµ–ï¼šDatabaseå’ŒMessageBusï¼Œè¿™ä¸ªä¾èµ–è¿˜æ˜¯éšå¼çš„ï¼Œæ²¡æœ‰å£°æ˜åœ¨æˆå‘˜å˜é‡é‡Œï¼Œä½ å¾—çœ‹ä»£ç æ‰èƒ½æ‰¾åˆ°2ä¸ªå¤–éƒ¨ä¾èµ–æ˜¯æ€ä¹ˆä½¿ç”¨çš„ã€‚

æ˜¾ç„¶ï¼ŒUser classå±äºé¢†åŸŸå’Œä¾èµ–æ··åˆçš„ä»£ç ï¼Œåº”è¯¥å½’å±äº**å¤æ‚ä»£ç **è±¡é™ã€‚

é‚£ä¹ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ€ä¹ˆæµ‹è¯•User Classå‘¢ï¼Ÿ

ä¸ºäº†è°ƒç”¨changeEmailæ–¹æ³•ï¼Œä½ å¯èƒ½ä¼šæƒ³åˆ°Mock Databaseå’ŒMessageBusä¸¤ä¸ªå¯¹è±¡ï¼Œä½†éš¾ç‚¹æ˜¯ï¼Œæ ¹æœ¬æ²¡æœ‰åŠæ³•æŠŠMockå¯¹è±¡ä¼ é€’changeEmailæ–¹æ³•é‡Œå»ã€‚

æ‰€ä»¥ï¼Œç°åœ¨æˆ‘ä»¬æ˜¯æ²¡æœ‰åŠæ³•å•å…ƒæµ‹è¯•User Classçš„ï¼Œå®ƒçš„å¯æµ‹è¯•æ€§ä¸º0ã€‚

å› æ­¤ï¼Œå°èƒœåŒå­¦éœ€è¦é‡æ„ä»£ç ï¼ŒæŠŠ**å¤æ‚ä»£ç **è±¡é™çš„ä»£ç åˆ†è§£åˆ°**é¢†åŸŸä»£ç **è±¡é™å’Œ**ä¾èµ–ä»£ç **è±¡é™ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/02/16/0257c4ff30f7be0e4fb0e3f14aa82e16.jpg?wh=1920x1571)

## ç‰ˆæœ¬V2

ä¸‹é¢æ¥åˆ°ç¬¬äºŒä¸ªç‰ˆæœ¬ï¼Œå°èƒœå°†ä¸šåŠ¡é€»è¾‘å’Œä¸å¤–éƒ¨ä¾èµ–çš„äº¤äº’åˆ†ç¦»ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„UserController Classæ¥ä¸“æ³¨ç®¡ç†å¤–éƒ¨ä¾èµ–ã€‚

**UserController.java**çš„ä»£ç å¦‚ä¸‹ï¼š

```java
public class UserController
{
    //åœ¨controlleré‡Œå£°æ˜ä¸¤ä¸ªå¤–éƒ¨ä¾èµ–
    private readonly Database _database = new Database();
    private readonly MessageBus _messageBus = new MessageBus();
    //changeEmailæ–¹æ³•é‡Œè°ƒç”¨ä¾èµ–
    public void ChangeEmail(int userId, string newEmail)
    {
        object[] data = _database.GetUserById(userId);
        string email = (string)data[1];
        UserType type = (UserType)data[2];
        var user = new User(userId, email, type);

        int numberOfRestaurants = _database.GetRestauruant();
        string companyDomainName = "foodcome.com";
        //è°ƒç”¨Userçš„changeEmailï¼Œè¿”å›å˜åŒ–çš„å•†å®¶æ•°é‡ã€‚
        int newNumberOfRestaurants = user.ChangeEmail(
            newEmail, companyDomainName, numberOfRestaurants);
        //è°ƒç”¨ä¾èµ–ï¼Œå˜æ›´æ•°æ®åº“å’Œå‘å¸ƒæ¶ˆæ¯
        if(newNumberOfRestaurants!=numberOfRestaurants){
          _database.SaveCompany(newNumberOfRestaurants);
          _database.SaveUser(user);
          _messageBus.SendEmailChangedMessage(userId, newEmail);
        }
    }
}
```

åŒæ—¶æˆ‘ä»¬è¦ä¿®æ”¹User Classï¼Œå®ƒä¸è´Ÿè´£ä»»ä½•ä¾èµ–ï¼Œåªå…³æ³¨changeEmailçš„ä¸šåŠ¡é€»è¾‘ï¼Œæ ¹æ®è¾“å…¥å‚æ•°ï¼Œç®—å‡ºæ¥æ–°çš„å•†å®¶çš„æ•°é‡ã€‚

**User.java**çš„ä»£ç å¦‚ä¸‹ï¼š

```java
public class User
{
    public int ChangeEmail(string newEmail,
    string companyDomainName, int numberOfRestaurants)
   {
    if (Email == newEmail)
        return numberOfRestaurants;

    string emailDomain = newEmail.Split('@')[1];
    bool isEmailCorporate = emailDomain == companyDomainName;
    UserType newType = isEmailCorporate
        ? UserType.Restaurant
        : UserType.Customer;
    if (Type != newType)
    {
        int delta = newType == UserType.Employee ? 1 : -1;
        int newNumber = numberOfRestaurants + delta;
        numberOfRestaurants = newNumber;
    }
    return numberOfRestaurants;
Â Â }
}
```

æˆ‘ä»¬å‘ç°ï¼Œç›¸æ¯”ç‰ˆæœ¬1 ï¼Œç‰ˆæœ¬2æœ‰äº†è¿›æ­¥ï¼Œå¤šäº†UserController Classæ¥ä¸“é—¨è´Ÿè´£ç®¡ç†å¤–éƒ¨äº¤äº’ï¼Œéšå¼ä¾èµ–çš„Databaseå’ŒMessageBuså˜æˆäº†æ˜¾å¼æˆå‘˜å˜é‡ã€‚User classä¸“é—¨è´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼Œåˆ¤æ–­ä¸ºé¤é¦†è¿˜æ˜¯å®¢æˆ·ã€‚

æˆ‘ä»¬å†ç”¨å¤æ‚åº¦å››è±¡é™æ¥è§‚å¯Ÿç°åœ¨çš„ä»£ç ï¼Œå®ƒçš„åˆ†å¸ƒæƒ…å†µå˜ä¸ºä¸‹å›¾è¿™æ ·ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œå¤æ‚ä»£ç æ¶ˆå¤±äº†ï¼ŒåŸå…ˆä¸€ä¸ªUser.javaæ–‡ä»¶é‡Œçš„é€»è¾‘è¢«åˆ†æ•£åˆ°äº†ä¸¤ä¸ªæ–‡ä»¶é‡Œï¼Œä¸€ä¸ªæ˜¯UserController.javaï¼Œå®ƒä¸“æ³¨äºç®¡ç†ä¾èµ–ï¼Œä½äºä¾èµ–ä»£ç è±¡é™ï¼›è¿˜æœ‰ä¿®æ”¹åçš„User.javaï¼Œä¸“æ³¨äºä¸šåŠ¡é€»è¾‘å®ç°ï¼Œä½äºé¢†åŸŸä»£ç è±¡é™ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/18/86/181afae377e2d60f74916703810a8386.jpg?wh=1920x1526)

ç°åœ¨å¯ä»¥æµ‹è¯•äº†ï¼

User Classåªæœ‰ä¸€ä¸ªchangeEmailçš„æ–¹æ³•ï¼Œæ–¹æ³•é‡Œåªæ˜¯å¯¹é‚®ä»¶åœ°å€åšåˆ¤æ–­ï¼Œå¹¶è®¡ç®—æ–°çš„é¤é¦†æ•°é‡ï¼Œå°†æ–°å€¼è¿”å›ï¼Œä¸ä¼šæ¶‰åŠåˆ°æ“ä½œæ•°æ®åº“å’Œæ¶ˆæ¯æ€»çº¿ã€‚User Classå¯ä»¥æµ‹è¯•äº†ï¼Œå› ä¸ºä¸éœ€è¦åšä»»ä½•Mockï¼Œæˆ‘å«å®ƒ**ç®€å•æµ‹è¯•**ã€‚

è€Œ2ä¸ªå¤–éƒ¨ä¾èµ–Databaseå’ŒMessageBuséƒ½è¢«æ˜¾å¼åœ°å°è£…åœ¨UserController Classé‡Œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æ¥ä¼ é€’Mockå¯¹è±¡ï¼ŒUserControllerä¹Ÿæ˜¯å¯ä»¥æµ‹è¯•çš„ï¼Œæˆ‘å«å®ƒ**Mockæµ‹è¯•**ã€‚

ä½†æ˜¯ï¼Œç‰ˆæœ¬2ä¾æ—§ä¸å¤Ÿæ¸…çˆ½ï¼Œè¿˜å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ã€‚

1. UserControlleré‡Œå®ä¾‹åŒ–äº†User classï¼Œè¿™åŒ…å«äº†ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚ä½•æ„é€ ä¸€ä¸ªUserå¯¹è±¡ï¼‰ï¼Œè€Œæˆ‘ä»¬å¸Œæœ›UserControlleræ›´ä¸ºçº¯ç²¹ï¼Œä¸“æ³¨ä¾èµ–ç®¡ç†ï¼›
2. User classå’ŒRestaurantæ•°æ®ä¹Ÿå­˜åœ¨è€¦åˆï¼Œé€šè¿‡UserÂ Classçš„ChangeEmailå‡½æ•°è¿”å›äº†Restaurantçš„newNumofRestaurantï¼Œè¿™å’ŒUserçš„è¡Œä¸ºæ¨¡å‹æ¯«æ— å…³ç³»ã€‚

å¥½ï¼Œæ’¸èµ·è¢–å­åŠ æ²¹å¹²ï¼Œæˆ‘ä»¬æ¥å®Œæˆç¬¬ä¸‰ä¸ªç‰ˆæœ¬ï¼Œä¸€æ¬¡æ€§è§£å†³ä¸Šé¢æåˆ°çš„é—®é¢˜ã€‚

## ç‰ˆæœ¬V3

é¦–å…ˆï¼Œä½¿ç”¨UserFactoryæ¨¡å¼å°è£…Userå®ä¾‹åŒ–é€»è¾‘ï¼Œå¦‚ä¸‹ï¼š

```java
public class UserFactory
{
    public static User Create(object[] data)
    {
        Precondition.Requires(data.Length >= 3);
        int id = (int)data[0];
        string email = (string)data[1];
        UserType type = (UserType)data[2];

        return new User(id, email, type);
    }
}
```

å¯ä»¥çœ‹åˆ°UserFactoryä¹Ÿæ˜¯å¯ä»¥ç®€å•æµ‹è¯•çš„âœŒï¸ï¼è¿™æ˜¯é˜¶æ®µæ€§èƒœåˆ©ï¼Œå¯å–œå¯è´ºã€‚

ç„¶åï¼Œæˆ‘ä»¬å¸¸è§ä¸€ä¸ªRestaurant Classç”¨æ¥å°è£…å…³äºRestaurantçš„ä¸šåŠ¡é€»è¾‘ï¼Œå¦‚ä¸‹ï¼š

```java
public class Restaurant
{
    public string DomainName { get; private set; }
    public int NumberOfRestaurant { get; private set; }

    public void ChangeNumberOfRestaurants(int delta)
    {
        Precondition.Requires(NumberOfRestaurants + delta >= 0);
        NumberOfRestaurants += delta;
    }
    public bool IsEmailCorporate(string email)
    {
        string emailDomain = email.Split('@')[1];
        return emailDomain == DomainName;
    }
}
```

Restaurant Classä¹Ÿæ˜¯å¯ä»¥ç®€å•æµ‹è¯•çš„ï¼

å‚è€ƒUserFactoryçš„æ€è·¯ï¼Œå†åšä¸€ä¸ªRestaurantFactoryï¼Œä¸“é—¨åšRestaurantå¯¹è±¡çš„æ„å»ºï¼Œæ­¤å¤„çœç•¥ä»£ç ï¼Œå®ç°èµ·æ¥å…¶å®å¹¶ä¸å¤æ‚ï¼Œæœ‰å…´è¶£ä½ å¯ä»¥è‡ªå·±å†™å†™çœ‹ã€‚

è€ŒUserControlleræ›´å…³æ³¨ä¸å¤–éƒ¨ä¾èµ–çš„ç®¡ç†å’Œäº¤äº’ï¼Œå¦‚ä¸‹ï¼š

```java
public class UserController
{
    private readonly Database _database = new Database();
    private readonly MessageBus _messageBus = new MessageBus();

    public void ChangeEmail(int userId, string newEmail)
    {
        object[] userData = _database.GetUserById(userId);
        User user = UserFactory.Create(userData);

        object[] restaurantData = _database.GetRestaurant();
        Restaurant restaurant = RestaurantFactory.Create(restaurantData);
        user.ChangeEmail(newEmail, restaurant);
        
        _database.SaveUser(user);
        //å¦‚æœrestaurantæ•°é‡æœ‰å˜åŒ–ï¼Œå°±å†™æ•°æ®åº“ï¼Œå‘é€é€šçŸ¥ä¿¡æ¯
        if(restaurant.numberChanged()){
          _database.SaveRestaurant(restaurant);
          _messageBus.SendEmailChangedMessage(userId, newEmail);
         }
    }
}
```

UserController Classé‡Œæ²¡æœ‰ä¸šåŠ¡é€»è¾‘ï¼Œåªæœ‰Databaseå’ŒMessageBusçš„ç®¡ç†å’Œæ“ä½œã€‚åœ¨å•å…ƒæµ‹è¯•æ—¶ï¼Œåªéœ€è¦ç”¨Mockæ›¿ä»£ï¼Œå°±OKäº†ï¼UserControlleræ˜¯å¯ä»¥è½»æ¾Mockæµ‹è¯•çš„ï¼

ç»è¿‡å‰é¢çš„æ“ä½œï¼ŒUser Classå˜åŒ–å¦‚ä¸‹ï¼š

```java
public class User
{
    public int UserId { get; private set; }
    public string Email { get; private set; }
    public UserType Type { get; private set; }

    public void ChangeEmail(string newEmail, Restaurant restaurant)
    {
        if (Email == newEmail)
            return;

        UserType newType = company.IsEmailCorporate(newEmail)
            ? UserType.Employee
            : UserType.Customer;

        if (Type != newType)
        {
            int delta = newType == UserType.Employee ? 1 : -1;
            restaurant.ChangeNumberOfRestaurants(delta);
        }
    }
}
```

Oh Yeah, User Classæ˜¯å¯ä»¥ç®€å•æµ‹è¯•çš„ï¼

ç°åœ¨æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹V3ç‰ˆæœ¬ä»£ç åœ¨å¤æ‚åº¦å››è±¡é™çš„ä½ç½®ï¼Œå˜æˆäº†è¿™æ ·ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/8e/9b/8e678e078dd95b5ae0e2aa95f2ede29b.jpg?wh=1920x1521)

ç»è¿‡3ä¸ªç‰ˆæœ¬åï¼Œæˆ‘ä»¬æŠŠä»£ç é‡æ„å®Œï¼Œå¤æ‚ä»£ç å®Œå…¨è¢«æ¶ˆè§£æ‰äº†ï¼Œåˆ†è§£åˆ°äº†å…¶ä»–3ä¸ªè±¡é™ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸ºä¸åŒè±¡é™çš„ä»£ç ï¼Œåˆ¶å®šå¥½å•å…ƒæµ‹è¯•ç­–ç•¥å’Œä¼˜å…ˆçº§äº†ã€‚æˆ‘ç‰¹æ„å‡†å¤‡äº†ä¸€å¼ æ€»ç»“è¡¨æ”¾åœ¨äº†åé¢ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/8e/4e/8e17702d4ab6f9af4555cbc88837634e.jpg?wh=1920x889)

æœ‰äº†è¿™å¼ è¡¨ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨[ä¸Šä¸€è®²](https://time.geekbang.org/column/article/505695)æåˆ°çš„æµ‹è¯•æ–¹æ³•æ¥åšä¸šåŠ¡é€»è¾‘æµ‹è¯•å’ŒMockæµ‹è¯•äº†ï¼

## å°ç»“

å‘ç€æé«˜ä»£ç å¯æµ‹è¯•æ€§çš„ç›®æ ‡ï¼Œå¤æ‚ä»£ç ç»è¿‡ä¸€æ­¥æ­¥çš„é‡æ„ï¼Œè¢«åˆ†è§£åˆ°äº†ä¾èµ–ç®¡ç†å’Œä¸šåŠ¡é€»è¾‘ä¸¤ä¸ªé¢†åŸŸï¼Œå¦‚æœä¹Ÿç®—ä¸Šæ•°æ®åº“ä»£ç çš„è¯ï¼Œæ­£å¥½å’Œè½¯ä»¶æ¶æ„çš„MVCæ¨¡å¼ä¸€è‡´ã€‚è¿™ä¸æ˜¯å‡‘å·§ï¼Œè¿™æ°æ°è¯´æ˜å¥½çš„ä»£ç ç»“æ„ç­‰åŒäºå•å…ƒæµ‹è¯•é«˜è¦†ç›–ç‡ã€‚å¦‚æœä½ çš„é¡¹ç›®ï¼Œå•å…ƒæµ‹è¯•åšä¸ä¸‹å»ï¼Œæµ‹è¯•è¦†ç›–ç‡æä¸ä¸Šæ¥ï¼Œé‚£åº”è¯¥é‡æ„ä»£ç äº†ã€‚

åä¹‹ä¹Ÿä¸€æ ·ï¼Œå¦‚æœå¼€å‘äººå‘˜å£°ç§°åšäº†éå¸¸å¥½çš„è®¾è®¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬é€šè¿‡å•å…ƒæµ‹è¯•ï¼Œå°±åº”è¯¥èƒ½ç›´è§‚æ„Ÿå—åˆ°è¿™ä¸ªå¥½çš„è®¾è®¡ã€‚æœŸå¾…ä»Šå¤©è¿™è®²å†…å®¹æˆä¸ºä½ å¼€å¯å¼€å‘é¢†åŸŸå¤§é—¨çš„ä¸€æŠŠé’¥åŒ™ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/35/6b/35ddf28fc9c17585e7ef43c40f574f6b.jpg?wh=1920x999)

å¦å¤–ï¼Œç»“åˆä»Šå¤©çš„ä¸‰ä¸ªç‰ˆæœ¬çš„ä»£ç ä¾‹å­ï¼Œä½ ä¹Ÿåº”è¯¥å‘ç°äº†ï¼Œå•å…ƒæµ‹è¯•å¹¶ä¸æ˜¯çœ‰æ¯›èƒ¡å­ä¸€æŠŠæŠ“ã€‚

é¦–å…ˆï¼Œä½ åº”è¯¥å…³æ³¨ä¸šåŠ¡é€»è¾‘èƒ½å¦åœ¨å•å…ƒæµ‹è¯•é‡Œå……åˆ†æµ‹è¯•ï¼Œè¿™æ˜¯è·Ÿæˆ‘ä»¬è‡ªåŠ¨åŒ–æµ‹è¯•é«˜åº¦å…³è”çš„åœ°æ–¹ã€‚è€ŒMockçš„ç›®æ ‡ï¼Œåˆ™æ˜¯è¾…åŠ©ä¸šåŠ¡é€»è¾‘èƒ½å¤Ÿæ›´æ—©æ›´å¿«åœ°æµ‹è¯•ã€‚ä»¥åï¼Œå½“å¼€å‘äººå‘˜éª„å‚²åœ°è·Ÿä½ è¯´ï¼šâ€œä»£ç è¡Œè¦†ç›–ç‡è¾¾åˆ°80%â€çš„æ—¶å€™ï¼Œä½ åº”è¯¥å’Œä»–ä¸€èµ·æ£€æŸ¥ä¸‹ï¼Œä»–åˆ°åº•æµ‹äº†ä»€ä¹ˆã€‚

å•å…ƒæµ‹è¯•çœ‹èµ·æ¥å·²ç»æ˜¯ä¸ªå®Œç¾çš„æµ‹è¯•æ–¹æ¡ˆäº†ï¼Œé‚£åœ¨å•å…ƒæµ‹è¯•å±‚é¢è¿˜æœ‰ä»€ä¹ˆåšä¸åˆ°çš„äº‹ä¹ˆï¼Œä¸‹ä¸€è®²æˆ‘ä»¬å°±æ¥æ­æ™“ç­”æ¡ˆã€‚

## æ€è€ƒé¢˜

åˆ¶å®šå•å…ƒæµ‹è¯•è¦†ç›–ç‡100%çš„ç›®æ ‡æœ‰ä»·å€¼ä¹ˆï¼Ÿå¦‚æœè®©ä½ åˆ¶å®šç›®æ ‡ï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿ

æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè·Ÿæˆ‘äº¤æµäº’åŠ¨ï¼Œä¹Ÿæ¨èä½ æŠŠè¿™è®²å†…å®¹åˆ†äº«ç»™æ›´å¤šåŒäº‹ã€æœ‹å‹ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ5ï¼‰</strong></div><ul>
<li><span>lisa</span> ğŸ‘ï¼ˆ9ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¾©è¯æ¥çœ‹ï¼Œå•å…ƒæµ‹è¯•çš„è¡Œè¦†ç›–ç‡æ˜¯æœ‰ä»·å€¼çš„ï¼Œä½†æ˜¯åˆ¶å®š100%çš„è¦†ç›–ç‡æ˜¯ä¸€ç§é”™è¯¯çš„ç®¡ç†æ‰‹æ®µã€‚æµ‹è¯•çš„æœ¬è´¨æ˜¯å‘ç°é—®é¢˜ï¼Œé˜²æ­¢é—®é¢˜å¤–æ¼ï¼Œæ‰€ä»¥æ— è®ºæ˜¯å•å…ƒæµ‹è¯•è¿˜æ˜¯å…¶ä»–æµ‹è¯•ï¼Œéƒ½æ˜¯ä»ä»£ç çš„é£é™©å‡ºå‘æ¥è®¾è®¡ç”¨ä¾‹ï¼Œè€Œä¸æ˜¯ä»è¡Œè¦†ç›–çš„è§’åº¦å‡ºå‘ã€‚</p>2022-04-14</li><br/><li><span>swordman</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¦‚æœä¸€å®šè¦å®šä¸€ä¸ªè¦†ç›–ç‡ç›®æ ‡ï¼Œé¢†åŸŸä»£ç è¿™éƒ¨åˆ†çš„è¦†ç›–ç‡ï¼Œä¼šæ›´æœ‰ä»·å€¼ã€‚è¿™åˆå¼•å‡ºä¸€ä¸ªæ–°é—®é¢˜ï¼Œå¦‚ä½•åˆ¤æ–­è®¾è®¡æ—¶åšäº†é¢†åŸŸä»£ç å’Œä¾èµ–ä»£ç çš„æ‹†åˆ†ã€‚é™¤äº†å’Œå¼€å‘äººå‘˜ä¸€èµ·æ£€æŸ¥ä»¥å¤–ï¼Œæˆ‘è§‰å¾—å¯ä»¥åŠ ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ä½¿ç”¨Mockå‡½æ•°çš„è‡ªåŠ¨æ‰«æï¼šå¦‚æœåšäº†æ‹†åˆ†ï¼Œé¢†åŸŸä»£ç éƒ¨åˆ†çš„ç”¨ä¾‹ï¼Œæ˜¯æ— éœ€åšMockçš„ï¼Œå¦‚æœæµ‹è¯•ç”¨ä¾‹é«˜é¢‘çš„ä½¿ç”¨Mockå‡½æ•°ï¼Œè¯´æ˜äº§å“ä»£ç æœ¬èº«ï¼Œå¹¶æ²¡æœ‰æŠŠå¤æ‚ä»£ç åˆ†è§£å¹²å‡€ã€‚ï¼ˆè¿™æ˜¯æˆ‘ä¸ªäººçš„ç†è§£ï¼Œæ³è¯·è€å¸ˆæŒ‡æ­£ï¼‰</p>2022-05-14</li><br/><li><span>ç¾Šç¾Š</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä»¥å‰å­¦ä¹ è®¾è®¡æ¨¡å¼ï¼Œå…¶ä¸­æœ‰ä¸€æ¡æ³•åˆ™ï¼šè¿ªç±³ç‰¹æ³•åˆ™ï¼Œä¹Ÿå«åšâ€œä¸å’Œé™Œç”Ÿäººè¯´è¯â€ã€‚ä¸€ç›´éƒ½ä¸çŸ¥é“è¿™æ¡æ³•åˆ™åˆ°åº•å¦‚ä½•åº”ç”¨ï¼Œç›®çš„æ˜¯ä»€ä¹ˆã€‚çœ‹åˆ°è€å¸ˆçš„ä»£ç å¯æµ‹æ€§æ”¹é€ ï¼Œæ‰æ˜ç™½ï¼Œç¬¦åˆäº†è¿ªç±³ç‰¹æ³•åˆ™çš„ä»£ç ï¼Œå¯ä»¥æ˜¾å¼å¤–éƒ¨ä¾èµ–é¡¹ï¼Œæ–¹ä¾¿æµ‹è¯•æ—¶ Moke å¤–éƒ¨ä¾èµ–ã€‚</p>2022-07-29</li><br/><li><span>Rachel</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ„Ÿè§‰è¿™èŠ‚ä¸»è¦åˆ†æäº†å¼€å‘çš„é€»è¾‘ã€‚ã€‚ã€‚å®é™…ä¸Šå¦‚æœå¼€å‘æ²¡é‚£ä¹ˆå¤šï¼Œè¿˜æ˜¯å¾ˆå¤šé—®é¢˜</p>2022-07-27</li><br/><li><span>chin</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å•çº¯è¿½æ±‚è¦†ç›–ç‡æ²¡æœ‰æ„ä¹‰ï¼Œè¿½æ±‚å…³é”®ä»£ç è¦†ç›–åˆ°å°±å¯ä»¥äº†ã€‚é¢†åŸŸä»£ç åº”è¯¥å°±æ˜¯è¿™éƒ¨åˆ†å…³é”®ä»£ç äº†</p>2022-04-16</li><br/>
</ul>