ä½ å¥½ï¼Œæˆ‘æ˜¯é«˜æ¥¼ã€‚

ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘ç”¨å•†å“åŠ å…¥è´­ç‰©è½¦æ¥å£ï¼Œæ¥ç»™ä½ è®²ä¸€è®²SQLä¼˜åŒ–å’Œå‹åŠ›å·¥å…·ä¸­çš„å‚æ•°åˆ†æã€‚

å¯¹äºSQLçš„ä¼˜åŒ–ï¼Œå¾ˆå¤šäººä¸€çœ‹åˆ°æ•°æ®åº“èµ„æºä½¿ç”¨ç‡é«˜ï¼Œå°±çŒœæµ‹æ˜¯SQLæœ‰é—®é¢˜ã€‚è¿™ä¸ªæ–¹å‘çœ‹èµ·æ¥æ²¡é”™ï¼Œä½†æ˜¯ï¼Œå…·ä½“æ˜¯å“ªä¸ªSQLæœ‰é—®é¢˜ï¼Œä»¥åŠæœ‰ä»€ä¹ˆæ ·çš„é—®é¢˜ï¼Œå¾€å¾€å›ç­”ä¸å‡ºæ¥ã€‚å› æ­¤ï¼Œè¿™èŠ‚è¯¾æˆ‘ä¼šæ•™ä½ æ€ä¹ˆæ ¹æ®èµ„æºä½¿ç”¨ç‡é«˜ï¼Œå¿«é€Ÿå®šä½åˆ°æœ‰é—®é¢˜çš„SQLï¼Œå¹¶åšå‡ºç›¸åº”çš„è°ƒæ•´ã€‚æ­¤å¤–ï¼Œä½ è¿˜å°†çœ‹åˆ°ï¼Œå½“å‹åŠ›å·¥å…·çš„å‚æ•°ä½¿ç”¨ä¸åˆç†æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•å¤„ç†ç”±æ­¤äº§ç”Ÿçš„æ•°æ®åº“é”çš„é—®é¢˜ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å°±å¼€å§‹è¿™èŠ‚è¯¾çš„åˆ†æã€‚

## å‹åŠ›æ•°æ®

å¯¹äºå•†å“åŠ å…¥è´­ç‰©è½¦è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡è¿è¡Œçš„æ€§èƒ½åœºæ™¯ç»“æœå¦‚ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/f8/8c/f871d42d3e4528def48fe1202e219a8c.png?wh=1789%2A789)

çœ‹ç€æœ‰ä¸€ç§æƒ³å“­çš„æ„Ÿè§‰ï¼Œæœ‰æ²¡æœ‰ï¼Ÿä»è¿™å¼ å›¾æ¥çœ‹ï¼Œé—®é¢˜ä¸æ­¢ä¸€ä¸ªã€‚æˆ‘ç”¨è‡ªå·±åœ¨æœ‰é™çš„èŒä¸šç”Ÿæ¶¯ä¸­å¸æ”¶çš„å¤©åœ°ä¹‹çµæ°”ï¼Œæ‰“å¼€å¤©çœ¼ä¸€çœ‹ï¼Œæ„Ÿè§‰è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š

- TPSå³ä½¿åœ¨å³°å€¼çš„æ—¶å€™ï¼Œä¹Ÿä¸å¤Ÿé«˜ï¼Œæ‰50å·¦å³ï¼›
- TPSåœ¨å³°å€¼çš„æ—¶å€™ï¼Œæœ‰å¤§é‡çš„é”™è¯¯äº§ç”Ÿã€‚

é‚£å“ªä¸ªé—®é¢˜æ›´é‡è¦å‘¢ï¼Ÿæœ‰äººå¯èƒ½è¯´ï¼Œæ˜æ˜¾åº”è¯¥å¤„ç†é”™è¯¯å‘€ï¼Œæœ‰é”™è¯¯çœ‹ç€ä¸çœ¼æ™•å—ï¼Ÿå¦‚æœä½ æ˜¯æœ‰å¼ºè¿«ç—‡çš„äººï¼Œé‚£æ²¡åŠæ³•ï¼Œå¯ä»¥å…ˆå¤„ç†é”™è¯¯ã€‚

ä¸è¿‡ï¼Œåœ¨æˆ‘çœ‹æ¥ï¼Œå…ˆå¤„ç†TPSä¸é«˜çš„é—®é¢˜ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚å› ä¸ºè™½ç„¶æœ‰é”™è¯¯äº§ç”Ÿï¼Œä½†å¹¶ä¸æ˜¯å…¨é”™å‘€ï¼Œåªæœ‰5%çš„é”™ï¼Œä½ ç€ä¸ªå•¥æ€¥ã€‚

å¯æ˜¯ï¼Œä¸ç®¡æ€ä¹ˆç€ï¼Œæˆ‘ä»¬éƒ½è¦èµ°æ€§èƒ½åˆ†æå†³ç­–æ ‘çš„æ€è·¯ã€‚

## çœ‹æ¶æ„å›¾

![](https://static001.geekbang.org/resource/image/e0/e0/e0035b408239e31deb2c31771f9acbe0.png?wh=1335%2A770)

è¿™ä¸ªæ¥å£çš„é€»è¾‘æ¸…æ™°æ˜äº†ï¼šå‹åŠ›å·¥å…· - Gateway - Cart - Memberã€‚

æˆ‘æ‰“ç®—å…ˆåˆ†æTPSä¸é«˜ã€å“åº”æ—¶é—´å˜é•¿çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥åœ¨å‹åŠ›æ›²çº¿å›¾çš„å‰åŠæ®µä¸­çœ‹å‡ºæ¥ã€‚æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çš„åˆ†æå°±ä»æ‹†åˆ†å“åº”æ—¶é—´å¼€å§‹ã€‚

å¦‚æœä½ æƒ³åœ¨è¿™æ ·çš„åœºæ™¯ä¸­å…ˆå¤„ç†é”™è¯¯ ï¼Œé‚£å°±ä»æŸ¥æ—¥å¿—å¼€å§‹ã€‚å…¶å®ï¼Œè¿™äº›é”™è¯¯æ˜¯å®¹æ˜“å¤„ç†çš„ï¼Œå› ä¸ºå®ƒä»¬ç»™å‡ºäº†éå¸¸æ˜ç¡®çš„æ–¹å‘æŒ‡ç¤ºã€‚

## åˆ†æçš„ç¬¬ä¸€é˜¶æ®µ

### æ‹†åˆ†å“åº”æ—¶é—´

è¿™æ¬¡æˆ‘ä»¬æˆªå°å›¾ã€‚

- User - Gatewayï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/a1/39/a18fyyf8936d3b906bbe4ccecf661539.png?wh=328%2A178)

- Gateway - Cartï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/c6/c5/c6c3fe9faed90d3476844b293fbc86c5.png?wh=330%2A184)

- Cart - Member ï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/7f/b5/7f5eb3a78a4efcb35855a54bfd71fbb5.png?wh=317%2A176)

- Cart - MySQLï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/ac/2a/acfc5fc9a600a6b2d29dc1e0c980d82a.png?wh=322%2A156)

- Member - MySQLï¼š

![](https://static001.geekbang.org/resource/image/11/71/117406c267046fe0771ba8109f801871.png?wh=314%2A180)

ä»å“åº”æ—¶é—´ä¸Šæ¥çœ‹ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ”¶æ‹¾MySQLï¼Œå¹¶ä¸”æ˜¯å’ŒCartæœåŠ¡ç›¸å…³çš„SQLï¼Œå› ä¸ºCart - MySQLä¹‹é—´çš„å“åº”æ—¶é—´æœ‰ç‚¹é•¿ã€‚

### å…¨å±€åˆ†æ

æŒ‰ç…§æˆ‘ä»¬çš„æƒ¯ä¾‹ï¼Œè¿˜æ˜¯å¾—æ¥çœ‹ä¸€ä¸‹å…¨å±€ç›‘æ§ã€‚

![](https://static001.geekbang.org/resource/image/42/a3/42f4042fa1100d96df9989b57f69c9a3.png?wh=1809%2A473)

æ—¢ç„¶worker-1ä¸Šçš„CPUä½¿ç”¨ç‡å¾ˆé«˜ï¼Œé‚£æˆ‘ä»¬å°±å»çœ‹çœ‹worker-1ä¸Šè¿è¡Œç€ä»€ä¹ˆæœåŠ¡ã€‚

ä½ ä¹Ÿè®¸ä¼šé—®ï¼Œç½‘ç»œçš„ä¸‹è½½å¸¦å®½ä¹Ÿé£˜çº¢äº†å•Šï¼Œå·²ç»è¾¾åˆ°100Mbä»¥ä¸Šäº†ã€‚è¿™å°±æ¶‰åŠåˆ°æ€ä¹ˆç†è§£è®¡æ•°å™¨çš„é—®é¢˜äº†ã€‚è¿™é‡Œçš„ç½‘ç»œè™½ç„¶é£˜çº¢äº†ï¼Œä½†ä¹Ÿåªæœ‰100å¤šMbï¼Œå®ƒé£˜çº¢åªæ˜¯å› ä¸ºGrafana DashBoardçš„é˜ˆå€¼è®¾ç½®é—®é¢˜ã€‚å¦‚æœä½ ä¸æƒ³è®©å®ƒé£˜çº¢ï¼Œä¹Ÿå¯ä»¥æŠŠé˜ˆå€¼è®¾ç½®å¾—é«˜ä¸€ç‚¹ã€‚å¹¶ä¸”å¯¹äºç½‘ç»œæ¥è¯´ï¼Œ100å¤šMbï¼ŒçœŸçš„ä¸ç®—å¤§ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹worker-1ä¸Šæœ‰ä»€ä¹ˆã€‚

```
[root@k8s-master-2 ~]# kubectl get pods -o wide|grep k8s-worker-1
elasticsearch-data-1                        1/1     Running   1          11d     10.100.230.57    k8s-worker-1   <none>           <none>
elasticsearch-master-0                      1/1     Running   0          3d11h   10.100.230.60    k8s-worker-1   <none>           <none>
mysql-min-d564fc4df-vs7d6                   1/1     Running   0          22h     10.100.230.1     k8s-worker-1   <none>           <none>
[root@k8s-master-2 ~]# 
```

ä½ çœ‹ï¼Œè¿™ä¸ªworker-1ä¸Šä¸æ­¢æœ‰MySQLï¼Œè¿˜æœ‰ES dataï¼Œè¿™æ˜¯ä¸€ä¸ªåƒç½‘ç»œçš„å¤§æˆ·ã€‚ä¸è¿‡ï¼Œç°åœ¨é—®é¢˜å¹¶æ²¡æœ‰æŒ‡å‘å®ƒã€‚

æˆ‘ä»¬åœ¨å‰é¢çœ‹åˆ°çš„æ˜¯MySQLçš„å“åº”æ—¶é—´é•¿ï¼Œæ‰€ä»¥æˆ‘ä»¬å†åˆ°worker-1ä¸Šï¼Œæ¥ç€çœ‹å…¨å±€ç›‘æ§çš„æ•°æ®ã€‚

```
[root@k8s-worker-1 ~]# top
top - 23:08:21 up 3 days, 11:30,  5 users,  load average: 29.90, 28.54, 23.00
Tasks: 309 total,   1 running, 307 sleeping,   0 stopped,   1 zombie
%Cpu0  : 94.1 us,  0.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  2.9 si,  2.9 st
%Cpu1  : 94.1 us,  2.9 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  2.9 si,  0.0 st
%Cpu2  : 90.9 us,  3.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  6.1 st
%Cpu3  : 89.7 us,  3.4 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  3.4 si,  3.4 st
%Cpu4  : 87.9 us,  6.1 sy,  0.0 ni,  3.0 id,  0.0 wa,  0.0 hi,  0.0 si,  3.0 st
%Cpu5  : 87.9 us,  9.1 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  3.0 st
KiB Mem : 16265992 total,  1176564 free,  8436112 used,  6653316 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  7422832 avail Mem 


  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                      
21344 27        20   0 8222204 628452  12892 S 331.4  3.9 141:36.72 /opt/rh/rh-mysql57/root/usr/libexec/mysqld --defaults-file=/etc/my.cnf       
 5128 techstar  20   0 5917564   1.4g  21576 S 114.3  8.8 233:09.48 /usr/share/elasticsearch/jdk/bin/java -Xshare:auto -Des.networkaddress.cache+
 5127 techstar  20   0   14.1g   3.5g  25756 S  40.0 22.8   1647:28 /usr/share/elasticsearch/jdk/bin/java -Xshare:auto -Des.networkaddress.cache+
 1091 root      20   0 1145528 108228  29420 S  25.7  0.7 263:51.49 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock       
 1078 root      20   0 2504364 106288  38808 S  14.3  0.7 429:13.57 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.co+
17108 root      20   0  164472   2656   1712 R  14.3  0.0   0:00.66 top  
```

ä»ä¸Šé¢çš„æ•°æ®ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½çœ‹åˆ°MySQLçš„è¿›ç¨‹æ¶ˆè€—çš„CPUæ¯”è¾ƒå¤šï¼Œè¿™è¯´æ˜æˆ‘ä»¬ç°åœ¨èµ°çš„è¯æ®é“¾æ˜¯æ­£ç¡®çš„ã€‚æ—¢ç„¶èµ°åˆ°äº†æ•°æ®åº“ï¼Œé‚£æˆ‘ä»¬ä¸»è¦çœ‹ä»€ä¹ˆå‘¢ï¼Ÿå½“ç„¶æ˜¯çœ‹MySQLçš„å…¨å±€ç›‘æ§äº†ã€‚æ‰€ä»¥ï¼Œæˆ‘æ‰“å°äº†MySQL Reportï¼Œè¿‡æ»¤æ‰ä¸€äº›æ²¡é—®é¢˜çš„æ•°æ®ä¹‹åå¾—åˆ°å¦‚ä¸‹ç»“æœï¼ˆä¸ç„¶å†…å®¹å°±å¤ªé•¿äº†ï¼‰ï¼š

```
__ Questions ___________________________________________________________
Total         637.05k     8.0/s
  DMS         293.57k     3.7/s  %Total:  46.08
  Com_        235.02k     2.9/s           36.89
.............................
Slow 20 ms    119.50k     1.5/s           18.76  %DMS:  40.70  Log:
DMS           293.57k     3.7/s           46.08
  SELECT      224.80k     2.8/s           35.29         76.57
  UPDATE       51.86k     0.6/s            8.14         17.66
  INSERT       16.92k     0.2/s            2.66          5.76
  REPLACE           0       0/s            0.00          0.00
  DELETE            0       0/s            0.00          0.00
.............................


__ SELECT and Sort _____________________________________________________
Scan          137.84k     1.7/s %SELECT:  61.32
.............................
```

ä»ä¸Šé¢çš„æ•°æ®æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨Totalçš„éƒ¨åˆ†ä¸­ï¼ŒDMSï¼ˆData Manipulation Statements ï¼Œæ•°æ®ç»´æŠ¤è¯­å¥ï¼‰å æ¯”46.08%ã€‚è€Œåœ¨DMSä¸­ï¼ŒSELECTå æ¯”76.57%ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦æŠŠåç»­åˆ†æçš„é‡ç‚¹æ”¾åœ¨SELECTè¯­å¥ä¸Šã€‚

é€šè¿‡Slowè¿™ä¸€è¡Œï¼Œçœ‹åˆ°æ…¢æ—¥å¿—ä¹Ÿå·²ç»å‡ºç°ï¼Œå› ä¸ºæˆ‘æŠŠæ…¢æ—¥å¿—é˜ˆå€¼è®¾ç½®çš„æ¯”è¾ƒä½ï¼Œåªæœ‰20msï¼Œæ‰€ä»¥ï¼Œä½ èƒ½çœ‹åˆ°æ¯ç§’äº§ç”Ÿäº†1.5ä¸ªæ…¢æ—¥å¿—ã€‚æˆ‘ä¹‹æ‰€ä»¥æŠŠæ…¢æ—¥å¿—é˜ˆå€¼è®¾çš„æ¯”è¾ƒä½ï¼Œä¸»è¦æ˜¯æƒ³æŠŠç¨å¾®æ…¢ä¸€ç‚¹çš„SQLéƒ½è®°å½•ä¸‹æ¥ã€‚ä¸è¿‡ï¼Œåœ¨ä½ çš„åº”ç”¨ä¸­ï¼Œè¦æ ¹æ®å®é™…çš„æƒ…å†µæ¥ï¼Œä¸è¦è®¾ç½®è¿‡å¤§ï¼Œä¹Ÿä¸è¦è¿‡å°ï¼Œä¸ç„¶éƒ½æ˜¯æ³ªã€‚

### å®šå‘åˆ†æ

ä¸‹é¢å°±æ˜¯çœ‹æ…¢æ—¥å¿—å–½ã€‚è¯·ä½ è®°ä½ï¼Œåœ¨çœ‹MySQLæ…¢æ—¥å¿—ä¹‹å‰ï¼Œæœ€å¥½å…ˆæŠŠæ—¥å¿—æ¸…ä¸€éï¼Œè®©è¿™ä¸ªæ—¥å¿—åªè®°å½•å‹åŠ›åœºæ™¯æ‰§è¡Œæ—¶é—´æ®µå†…çš„æ…¢SQLï¼Œä¸ç„¶å—å½±å“çš„æ•°æ®ä¼šå¾ˆå¤šã€‚

```
[root@7dgroup1 gaolou]# pt-query-digest slow-query.log


# 7.2s user time, 70ms system time, 36.78M rss, 106.05M vsz
# Current date: Wed Dec 30 23:30:14 2020
# Hostname: 7dgroup1
# Files: slow-query.log
# Overall: 36.60k total, 7 unique, 89.06 QPS, 17.17x concurrency _________
# Time range: 2020-12-30T15:22:00 to 2020-12-30T15:28:51
# Attribute          total     min     max     avg     95%  stddev  median
# ============     ======= ======= ======= ======= ======= ======= =======
# Exec time          7055s    20ms      1s   193ms   501ms   160ms   128ms
# Lock time             7s       0    39ms   194us   247us   696us   125us
# Rows sent         35.45k       0       1    0.99    0.99    0.09    0.99
# Rows examine       2.33G       0 112.76k  66.71k 112.33k  46.50k 112.33k
# Query size        14.26M       6    1016  408.53  592.07  195.17  202.40


# Profile
# Rank Query ID                      Response time   Calls R/Call V/M   It
# ==== ============================= =============== ===== ====== ===== ==
#    1 0xB8BDB35AD896842FAC41202B... 5744.3322 81.4% 18420 0.3119  0.07 SELECT pms_sku_stock
#    2 0xC71984B4087F304BE41AC8F8... 1309.1841 18.6% 18138 0.0722  0.03 SELECT oms_cart_item
# MISC 0xMISC                           1.4979  0.0%    46 0.0326   0.0 <5 ITEMS>


# Query 1: 44.82 QPS, 13.98x concurrency, ID 0xB8BDB35AD896842FAC41202BB9C908E8 at byte 6504041
# This item is included in the report because it matches --limit.
# Scores: V/M = 0.07
# Time range: 2020-12-30T15:22:00 to 2020-12-30T15:28:51
# Attribute    pct   total     min     max     avg     95%  stddev  median
# ============ === ======= ======= ======= ======= ======= ======= =======
# Count         50   18420
# Exec time     81   5744s    76ms      1s   312ms   580ms   148ms   279ms
# Lock time     47      3s    70us    37ms   184us   224us   673us   119us
# Rows sent     50  17.99k       1       1       1       1       0       1
# Rows examine  85   1.98G 112.76k 112.76k 112.76k 112.76k       0 112.76k
# Query size    26   3.72M     212     212     212     212       0     212
# String:
# Hosts        10.100.5.54
# Users        reader
# Query_time distribution
#   1us
#  10us
# 100us
#   1ms
#  10ms  #
# 100ms  ################################################################
#    1s  #
#  10s+
# Tables
#    SHOW TABLE STATUS LIKE 'pms_sku_stock'\G
#    SHOW CREATE TABLE `pms_sku_stock`\G
# EXPLAIN /*!50100 PARTITIONS*/
select


    id, product_id, sku_code, price, stock, low_stock, pic, sale, promotion_price, lock_stock,
    sp_data

    from pms_sku_stock


     WHERE (  sku_code = '202008270027906' )\G


# Query 2: 44.13 QPS, 3.19x concurrency, ID 0xC71984B4087F304BE41AC8F82A88B245 at byte 20901845
# This item is included in the report because it matches --limit.
# Scores: V/M = 0.03
# Time range: 2020-12-30T15:22:00 to 2020-12-30T15:28:51
# Attribute    pct   total     min     max     avg     95%  stddev  median
# ============ === ======= ======= ======= ======= ======= ======= =======
# Count         49   18138
# Exec time     18   1309s    20ms   419ms    72ms   148ms    43ms    59ms
# Lock time     52      4s    76us    39ms   205us   260us   719us   138us
# Rows sent     49  17.45k       0       1    0.99    0.99    0.12    0.99
# Rows examine  14 356.31M  19.96k  20.22k  20.12k  19.40k       0  19.40k
# Query size    73  10.51M     604     610  607.81  592.07       0  592.07
# String:
# Hosts        10.100.5.54
# Users        reader
# Query_time distribution
#   1us
#  10us
# 100us
#   1ms
#  10ms  ################################################################
# 100ms  ##################
#    1s
#  10s+
# Tables
#    SHOW TABLE STATUS LIKE 'oms_cart_item'\G
#    SHOW CREATE TABLE `oms_cart_item`\G
# EXPLAIN /*!50100 PARTITIONS*/
select


    id, product_id, product_sku_id, member_id, quantity, price, product_pic, product_name,
    product_sub_title, product_sku_code, member_nickname, create_date, modify_date, delete_status,
    product_category_id, product_brand, product_sn, product_attr
    from oms_cart_item
     WHERE (  member_id = 381920
                       and product_id = 317
                  and delete_status = 0
                  and product_sku_id = 317 )\G
```

ä»ä¸Šé¢çš„æ•°æ®æ¥çœ‹ï¼Œæˆ‘ä»¬çš„ä¼˜åŒ–æ–¹å‘æ¯”è¾ƒç®€å•æ˜äº†ï¼šå ç”¨æ€»æ—¶é—´æœ€é•¿çš„ä¸¤ä¸ªSQLéœ€è¦æ”¶æ‹¾ï¼Œå…¶ä¸­ï¼Œä¸€ä¸ªå ç”¨äº†æ€»æ—¶é—´çš„81.4%ï¼Œå¦ä¸€ä¸ªå ç”¨äº†18.6%ã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹æœ€æ…¢çš„é‚£ä¸ªSQLï¼š

```
select
    id, product_id, sku_code, price, stock, low_stock, pic, sale, promotion_price, lock_stock,
    sp_data
    from pms_sku_stock
     WHERE (  sku_code = '202008270027906' )\G
```

è¦æƒ³çŸ¥é“ä¸€ä¸ªè¯­å¥å“ªé‡Œæ…¢ï¼Œå°±å¾—æ¥çœ‹ä¸€ä¸‹æ‰§è¡Œè®¡åˆ’ï¼š

![](https://static001.geekbang.org/resource/image/17/b0/17a4e2d2df0bebda224068869262feb0.png?wh=1094%2A74)

åœ¨æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œtypeè¿™ä¸€åˆ—çš„å‚æ•°å€¼ä¸ºALLï¼Œè¯´æ˜è¿™ä¸ªSQLæ²¡æœ‰ç”¨åˆ°ç´¢å¼•ã€‚ä½ æƒ³æƒ³ï¼Œä¸€ä¸ªæœ‰whereæ¡ä»¶çš„è¯­å¥ï¼Œåˆæ²¡æœ‰ç”¨åˆ°ç´¢å¼•ï¼Œé‚£å®ƒä¸Šæ–¹çš„ç´¢å¼•åˆ°åº•åˆä¸åˆç†å‘¢ï¼Ÿæˆ‘ä»¬ä¸å¦¨æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ªç´¢å¼•ï¼š

![](https://static001.geekbang.org/resource/image/9f/2c/9fb5d843506d87c40660058bab5e4d2c.png?wh=1081%2A60)

é€šè¿‡æ£€æŸ¥ç´¢å¼•ï¼Œæˆ‘ä»¬çœ‹åˆ°åªæœ‰ä¸€ä¸ªIDåˆ—ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªä¸»é”®ç´¢å¼•ï¼Œå¹¶æ²¡æœ‰whereæ¡ä»¶ä¸­çš„sku\_codeåˆ—ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å…ˆç»™sku\_codeåŠ ä¸€ä¸ªç´¢å¼•æ¥å®ç°ç²¾å‡†æŸ¥è¯¢ï¼Œè¿™æ ·å°±ä¸ç”¨æ‰«ææ•´è¡¨çš„æ•°æ®äº†ï¼š

```
ALTER TABLE pms_sku_stock ADD INDEX sku_code_index (sku_code);
```

ä¿®æ”¹ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æ­¤æ—¶çš„æ‰§è¡Œè®¡åˆ’ï¼š

![](https://static001.geekbang.org/resource/image/ba/c3/ba4c981ce540dd1fbaf74547483fa7c3.png?wh=870%2A55)

ç°åœ¨ï¼Œtypeåˆ—çš„å‚æ•°å€¼å˜ä¸ºäº†refï¼Œè¯´æ˜whereæ¡ä»¶ç¡®å®èµ°äº†ç´¢å¼•äº†ã€‚é‚£æˆ‘ä»¬å†æŠŠåœºæ™¯æ‰§è¡Œèµ·æ¥ï¼Œçœ‹çœ‹æ•ˆæœï¼š

![](https://static001.geekbang.org/resource/image/bb/d8/bbbe15d314ab1fab1798bf4f7bc229d8.png?wh=1792%2A779)

ä»ç»“æœæ¥çœ‹ï¼ŒTPSä»50å¢åŠ åˆ°äº†150ä»¥ä¸Šã€‚å“åº”æ—¶é—´ä¹Ÿä»750mså·¦å³é™åˆ°250msä»¥ä¸‹ã€‚æ•ˆæœæ˜¾è‘—ã€‚

æ”¶æ‹¾å®Œäº†ç¬¬ä¸€ä¸ªSQLåï¼Œæˆ‘ä»¬å†æ¥æ”¶æ‹¾å¦ä¸€ä¸ªSQLã€‚åŒæ ·åœ°ï¼Œæˆ‘ä»¬å…ˆçœ‹å®ƒçš„æ‰§è¡Œè®¡åˆ’ï¼š

![](https://static001.geekbang.org/resource/image/9a/61/9ab86c87e0496699628d4d50a244d161.png?wh=940%2A92)

typeåˆ—çš„å‚æ•°å€¼ä¸ºALLï¼Œè¡¨æ˜whereæ¡ä»¶æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ã€‚ä½†æ˜¯ï¼Œç¬¬äºŒä¸ªè¯­å¥ç”¨äº†å¥½å‡ ä¸ªwhereæ¡ä»¶ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬ç›´æ¥åŠ ä¸€ä¸ªç»„åˆç´¢å¼•ï¼Œè®©whereæ¡ä»¶å¯ä»¥èµ°åˆ°ç´¢å¼•è¿™é‡Œï¼š

```
ALTER TABLE oms_cart_item ADD INDEX mix_index (member_id,product_id,product_sku_id);
```

åŠ äº†ç»„åˆç´¢å¼•åï¼Œè¿™ä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’å¦‚ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/a1/5c/a1dd2eabfa7e4903f33013241f145d5c.png?wh=1059%2A57)

è¿˜æ˜¯ä¸€æ ·ï¼Œæˆ‘ä»¬å†æ¬¡æŠŠåœºæ™¯è·‘èµ·æ¥ï¼Œçœ‹çœ‹ä¼˜åŒ–äº†è¿™ä¸¤ä¸ªæœ€æ…¢çš„SQLä¹‹åï¼Œæ•ˆæœå¦‚ä½•ã€‚

### ä¼˜åŒ–æ•ˆæœ

ä¼˜åŒ–æ•ˆæœå¦‚ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/dc/3c/dcfc2e05c8f4a767b284a9a6eb82313c.png?wh=1802%2A650)

ä¼˜åŒ–å‰åçš„å¯¹æ¯”å›¾å¦‚ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/10/50/100f25cbb012cd7d8902byy884528850.png?wh=1100%2A720)

å»ºè®®ä½ åœ¨å†™æŠ¥å‘Šçš„æ—¶å€™ï¼Œç”»è¿™ç§å¯¹æ¯”å›¾ï¼Œç”¨å®ƒæ¥è¯´æ˜ä¼˜åŒ–æ•ˆæœæ˜¯éå¸¸ç›´æ¥æ˜æ˜¾çš„ã€‚

## åˆ†æçš„ç¬¬äºŒé˜¶æ®µ

ç°åœ¨æˆ‘ä»¬å°±è¦æ¥åˆ†æé”™è¯¯äº†ï¼Œåæ­£ä¹Ÿå¿½æ‚ ä¸è¿‡å»ã€‚

### å‹åŠ›æ•°æ®

ä¸‹é¢æ˜¯å¯¹åº”çš„é”™è¯¯å›¾ï¼Œæˆ‘æŠŠå›¾æˆªå¤šä¸€ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°è¶‹åŠ¿å¦‚ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/37/ec/372bfab0665388228fe36b1e167c0cec.png?wh=819%2A647)

ä½ çœ‹ï¼Œ**TPSä¸­æœ‰å¯¹çš„ï¼Œä¹Ÿæœ‰é”™çš„ï¼Œå¹¶ä¸”TPSè¶Šé«˜çš„æ—¶å€™ï¼Œé”™è¯¯ç‡ä¹Ÿè¶Šé«˜**ã€‚è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå¸Œæœ›ä½ èƒ½è®°ä½ã€‚

ç´§æ¥ç€ï¼Œæˆ‘ä»¬æ¥æ‹†åˆ†å“åº”æ—¶é—´ã€‚

### æ‹†åˆ†å“åº”æ—¶é—´

å…ˆè®¾ç½®skywalkingçš„æ—¶é—´æ®µï¼š

![](https://static001.geekbang.org/resource/image/c2/38/c2a3c6e60cd14b69980cbaf8207be638.png?wh=636%2A329)

è¯·ä½ æ³¨æ„ï¼Œåœ¨çœ‹æ€§èƒ½è®¡æ•°å™¨çš„æ—¶å€™ï¼Œæ¯ä¸€ä¸ªå·¥å…·ä¸Šçš„æ—¶é—´çª—å£ä¸€å®šè¦å¯¹åº”ä¸Šã€‚

- User - Gatewayï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/64/71/64abda597f27856747bc2b7afaa76371.png?wh=305%2A182)

- Gateway - Cartï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/fe/6b/febd0fc79be360bf4b6b477afc26e06b.png?wh=327%2A222)  
![](https://static001.geekbang.org/resource/image/75/71/75764747266a66d64cfcaf648e93aa71.png?wh=312%2A218)

- Cart - Memberï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/ec/aa/ec6b494ca14142f920861c198a3d08aa.png?wh=317%2A212)![](https://static001.geekbang.org/resource/image/d1/b9/d15c9575a080cd2066ba962b7c5517b9.png?wh=327%2A221)

- Cart - MySQLï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/6d/c8/6d9f71f3eeab6705389cf7e7b0ded8c8.png?wh=324%2A218)

- Member - MySQLï¼š

![](https://static001.geekbang.org/resource/image/9f/96/9fcaef4474c9696ea5a8ffe83315f796.png?wh=324%2A219)

ç½—åˆ—äº†ä¸€å †ä¿¡æ¯ä¹‹åâ€¦â€¦å¹¶æ²¡æœ‰ä»€ä¹ˆå‘ç°ã€‚

ä½ å¯èƒ½ä¼šå¥‡æ€ªï¼Œä¸ºä»€ä¹ˆè¯´æ²¡æœ‰å‘ç°å‘¢ï¼ŒCartä¸Šçš„å“åº”æ—¶é—´ä¸æ˜¯æ¯”è¾ƒé•¿å—ï¼Ÿè¿™é‡Œä½ å°±è¦æ³¨æ„äº†ï¼Œæˆ‘ä»¬ç°åœ¨åˆ†æçš„é—®é¢˜æ˜¯é”™è¯¯ï¼Œè€Œä¸æ˜¯å“åº”æ—¶é—´ï¼Œæ‰€ä»¥æ—¶é—´é•¿å°±é•¿å‘—ã€‚**åœ¨åˆ†æçš„è¿‡ç¨‹ä¸­ï¼Œä½ ä¸€å®šè¦æ—¶åˆ»è®°å¾—è‡ªå·±æŸ¥çš„æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Œä¸è¦èµ°åˆ°åŠè·¯å°±èµ°å²”äº†ï¼Œé‚£æ ·ä¼šé™·å…¥æ··ä¹±çš„çŠ¶æ€ã€‚**

### å…¨å±€åˆ†æ

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„å…¨å±€åˆ†æéƒ½æ˜¯ä»èµ„æºå¼€å§‹çš„å¯¹å§ï¼Œä¹Ÿå°±æ˜¯ä»æ€§èƒ½åˆ†æå†³ç­–æ ‘ä¸­ä¸€å±‚å±‚æŸ¥ä¸‹å»ã€‚å¯¹åº”æˆ‘ä»¬ç¬¬4èŠ‚è¯¾è®²çš„å†…å®¹ï¼Œä½ å¯ä»¥æŠŠæ‰€æœ‰çš„ç¬¬ä¸€å±‚è®¡æ•°å™¨æŸ¥ä¸€éã€‚

è€Œåœ¨æˆ‘ä»¬çš„è¿™ä¸ªé—®é¢˜çš„åˆ†æä¸­ï¼Œå…¶å®ä¸ç”¨é‚£ä¹ˆéº»çƒ¦ï¼Œå› ä¸ºåœ¨å‰é¢çœ‹åˆ°å‹åŠ›æ•°æ®çš„æ—¶å€™ï¼Œå·²ç»çœ‹åˆ°äº†å¤§é‡çš„æŠ¥é”™äº†ï¼Œè¦æƒ³åˆ†æé”™è¯¯ï¼Œè‚¯å®šå¾—å…ˆçŸ¥é“é”™è¯¯åœ¨å“ªï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥æŸ¥æ—¥å¿—ç›¸å…³çš„å†…å®¹å°±å¯ä»¥ã€‚æŸ¥åˆ°æ—¥å¿—çš„æ—¶å€™ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸‹é¢è¿™äº›é”™è¯¯ä¿¡æ¯ï¼š

```
2020-12-30 23:44:06.754 ERROR 1 --- [io-8086-exec-41] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is org.springframework.dao.DeadlockLoserDataAccessException: 
### Error updating database.  Cause: com.mysql.cj.jdbc.exceptions.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction
### The error may involve com.dunshan.mall.mapper.OmsCartItemMapper.updateByPrimaryKey-Inline
### The error occurred while setting parameters
### SQL: update oms_cart_item     set product_id = ?,       product_sku_id = ?,       member_id = ?,       quantity = ?,       price = ?,       product_pic = ?,       product_name = ?,       product_sub_title = ?,       product_sku_code = ?,       member_nickname = ?,       create_date = ?,       modify_date = ?,       delete_status = ?,       product_category_id = ?,       product_brand = ?,       product_sn = ?,       product_attr = ?     where id = ?
### Cause: com.mysql.cj.jdbc.exceptions.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction
; Deadlock found when trying to get lock; try restarting transaction; nested exception is com.mysql.cj.jdbc.exceptions.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction] with root cause
...................................
```

è¿™ä¸ªé”™è¯¯å·²ç»ç»™äº†æˆ‘ä»¬æ˜ç¡®çš„æŒ‡å‘ï¼šæ­»é”ã€‚å¯æ˜¯ä¸ºä»€ä¹ˆä¼šæ­»é”å‘¢ï¼Ÿ

åœ¨æ€§èƒ½åˆ†æä¸­ï¼Œä½ è¦è®°å¾—ï¼Œæ­»é”å…¶å®æ˜¯ç›¸å¯¹å®¹æ˜“åˆ†æçš„å†…å®¹ã€‚**æœ‰äº‰ç”¨æ‰æœ‰é”ï¼Œè€Œæ­»é”ï¼Œå°±æ˜¯è¯´é”è¢«äº‰å¾—æ­»æ­»çš„ã€‚**

ä¸‹é¢æˆ‘ä»¬å¼€å§‹å®šå‘åˆ†æä¸ºä»€ä¹ˆä¼šäº§ç”Ÿé”ã€‚

### å®šå‘åˆ†æ

é¦–å…ˆï¼Œæˆ‘ä»¬æ‰¾åˆ°å•†å“åŠ å…¥è´­ç‰©è½¦ä¸šåŠ¡å¯¹åº”çš„ä»£ç ï¼š

```
/**
     * å¢åŠ è´­ç‰©è½¦
     * @param productSkuCode åº“å­˜å•†å“ç¼–å·
     * @param quantity å•†å“æ•°é‡
     * @return
     */
    @Override
    public int addCart(String productSkuCode, Integer quantity) {
     .........................................
        OmsCartItem existCartItem = getCartItem(cartItem);
        if (existCartItem == null) {
            cartItem.setCreateDate(new Date());
            count = cartItemMapper.insert(cartItem);
        } else {
            cartItem.setModifyDate(new Date());
            existCartItem.setQuantity(existCartItem.getQuantity() + cartItem.getQuantity());
            count = cartItemMapper.updateByPrimaryKey(existCartItem);
        }


        return count;
    }
```

å¼•ç”¨è¿™æ®µä»£ç çš„äº‹åŠ¡å¦‚ä¸‹ï¼š

```
@Transactional
int addCart(String productSkuCode, Integer quantity);
```

æ ¹æ®ä¸Šé¢çš„å…³ç³»ï¼Œå¯¹äºå•†å“åŠ å…¥è´­ç‰©è½¦æ¥è¯´ï¼Œä»€ä¹ˆèƒ½å¼•èµ·æ­»é”å‘¢ï¼Ÿä½ çœ‹ï¼Œåœ¨ä»£ç ä¸­æœ‰ä¸€ä¸ªupdateï¼Œå®ƒå¯¹åº”çš„ä¹Ÿå°±æ˜¯å‰é¢æ—¥å¿—ä¸­çš„updateè¯­å¥ã€‚æ‰€ä»¥ï¼Œè¦æ˜¯å‘ç”Ÿæ­»é”çš„è¯ï¼Œé‚£æŒ‡å®šå°±æ˜¯IDå†²çªäº†ï¼Œè€Œè¿™ä¸ªIDå¯¹åº”çš„å°±æ˜¯ä¼šå‘˜IDã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶æƒ³æ›´æ–°åŒä¸€ä¸ªä¼šå‘˜çš„è´­ç‰©è½¦ï¼Œè¿™æ€ä¹ˆèƒ½è¡Œï¼

æ—¢ç„¶æ˜¯ä¼šå‘˜IDå†²çªäº†ï¼Œé‚£æ˜¯è°ç»™çš„ä¼šå‘˜ä¿¡æ¯å‘¢ï¼Ÿæƒ³éƒ½ä¸ç”¨æƒ³ï¼Œè¿™ä¸ªä¼šå‘˜ä¿¡æ¯è‚¯å®šæ˜¯ä»è„šæœ¬ä¸­ä¼ è¿‡æ¥çš„å‘€ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŸ¥æŸ¥è„šæœ¬ã€‚

å¯¹åº”çš„è„šæœ¬å¦‚ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/79/a7/7986171dedc7108ac44eb8f216fdc9a7.png?wh=1852%2A539)

ä½ çœ‹ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªproductSkuCodeå‚æ•°ï¼Œå…±ç”¨äº†1000è¡Œæ•°æ®é‡ã€‚

![](https://static001.geekbang.org/resource/image/08/12/08bb30112213e9450cd77ee698yy3812.png?wh=1415%2A379)

ä¸Šé¢çš„å›¾å¯¹åº”çš„JMeterè„šæœ¬æ˜¯è¿™æ ·çš„ï¼š

![](https://static001.geekbang.org/resource/image/33/4c/331479527f3ef875426ce77d899d724c.png?wh=862%2A306)

æˆ‘ä»¬æ¥çœ‹JMeterè„šæœ¬ä¸­çš„è¿™ä¸‰ä¸ªå‚æ•°ï¼š

```
quotedData: false
recycle: true
stopThread: false
```

è¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬æ‰€æœ‰çš„çº¿ç¨‹éƒ½åœ¨å…±ç”¨è¿™1000æ¡æ•°æ®ï¼Œå¹¶ä¸”åœ¨ä¸æ–­å¾ªç¯ã€‚è¿™ä¼šå¯¼è‡´æ•°æ®ä½¿ç”¨é‡å¤ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæœ‰ä¸¤ä¸ªä»¥ä¸Šçš„çº¿ç¨‹ç”¨åˆ°äº†ç›¸åŒçš„ç”¨æˆ·æ•°æ®ï¼Œå°±ä¼šæ›´æ–°åŒä¸€ä¸ªè´­ç‰©è½¦ï¼Œäºæ˜¯äº§ç”Ÿå†²çªæŠ¥é”™ã€‚

æˆ‘ä»¬ç°åœ¨æŠŠä¸Šé¢ä¸‰ä¸ªå‚æ•°æ”¹ä¸€ä¸‹ï¼š

```
quotedData: true
recycle: false
stopThread: true
```

è¿™æ ·å°±ä¿è¯äº†æ¯ä¸ªçº¿ç¨‹å¯ä»¥åˆ†åˆ°ä¸åŒçš„æ•°æ®ã€‚

å¯æ˜¯ï¼Œå¦ä¸€ä¸ªé—®é¢˜æ¥äº†ï¼šæˆ‘ä»¬åšè¿™æ ·å¤„ç†çš„è¯ï¼Œ1000æ¡æ•°æ®æ˜¯ä¸å¤Ÿç”¨çš„ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿé‚£æˆ‘ä»¬å°±åªæœ‰æŠŠç”¨æˆ·æ•°æ®åŠ å¤§ï¼Œç­‰ç”Ÿæˆæ›´å¤šçš„Tokenä¹‹åï¼Œæˆ‘ä»¬å†æ¥æ‰§è¡Œåœºæ™¯ã€‚

é€šè¿‡ä¸€æ™šä¸Šçš„é€ æ•°ï¼Œæ—¶é—´æ¥åˆ°äº†ç¬¬äºŒå¤©ã€‚

### ä¼˜åŒ–æ•ˆæœ

äºæ˜¯ï¼Œæˆ‘ä»¬å¾—åˆ°äº†å¦‚ä¸‹ç»“æœï¼š

![](https://static001.geekbang.org/resource/image/18/4b/188e028b8ef2f7c3994ba4a1f483bb4b.png?wh=1799%2A644)

ä»æ•°æ®ä¸Šæ¥çœ‹ï¼ŒæŠ¥é”™æ²¡æœ‰äº†ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆç†çš„ç»“æœã€‚

## æ€»ç»“

ç°åœ¨ï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹è¿™èŠ‚è¯¾ã€‚

â€œå“ï¼Œå“ï¼Œä½ å…ˆåˆ«æ€»ç»“å‘€ï¼Œé—®é¢˜éƒ½æ²¡è§£å†³å®Œï¼Œä½ çœ‹è¿™ä¸æ˜¯è¿˜æœ‰TPSæ‰ä¸‹æ¥çš„æƒ…å†µå—ï¼Ÿâ€

â€œå¹´è½»äººï¼Œåˆ«æ‰æ€¥ï¼Œé¥­éƒ½å¾—ä¸€å£ä¸€å£åƒï¼Œé—®é¢˜è‡ªç„¶è¦ä¸€ä¸ªä¸€ä¸ªè§£å†³äº†ã€‚è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä¼šæ”¾åœ¨åé¢çš„è¯¾ç¨‹ä¸­è§£å†³ã€‚â€

åœ¨è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬ä»TPSä¸é«˜å¼€å§‹ï¼Œä¸€ç›´åˆ†æåˆ°äº†å…·ä½“çš„SQLï¼Œçœ‹ä¼¼æ˜¯ä¸¤ä¸ªç®€å•çš„ç´¢å¼•å°±æå®šçš„äº‹æƒ…ï¼Œé€»è¾‘ä¹Ÿå¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯ï¼Œè¿™ä¸ªåˆ†ææ€è·¯éå¸¸é‡è¦ã€‚

å¯¹äºç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä»é”™è¯¯æ•°æ®æŸ¥åˆ°äº†æ—¥å¿—ä¸­å‡ºç°çš„æ­»é”ä¿¡æ¯ï¼Œè¿™ä¸€ç‚¹å¤§éƒ¨åˆ†äººåº”è¯¥éƒ½å¯ä»¥åšå¾—åˆ°ã€‚åªä¸è¿‡ï¼Œèƒ½ç«‹å³æƒ³åˆ°å‚æ•°å†²çªçš„ï¼Œå°±æ˜¯æœ‰ç»éªŒçš„äººäº†ã€‚

æ­¤å¤–ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé‡ç‚¹å°±æ˜¯ï¼Œ**å‚æ•°åŒ–æ•°æ®ä¸€å®šè¦ç¬¦åˆçœŸå®åœºæ™¯**ï¼é«˜è€å¸ˆå·²ç»åå¤å¼ºè°ƒå¾ˆå¤šéäº†ï¼Œå¸Œæœ›ä½ èƒ½è®°å¾—ä½ã€‚

## è¯¾åä½œä¸š

æœ€åï¼Œæˆ‘ç»™ä½ ç•™ä¸¤é“é¢˜ï¼Œè¯·ä½ æ€è€ƒä¸€ä¸‹ï¼š

1. é™¤äº†ç”¨æœ¬èŠ‚è¯¾ä¸­çš„æ‰‹æ®µï¼Œä½ è¿˜æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥å¿«é€Ÿå®šä½åˆ°SQLè¯­å¥æ…¢çš„é—®é¢˜ï¼Ÿ
2. ä½ èƒ½ç”»å‡ºåœ¨ç¬¬äºŒé˜¶æ®µåˆ†æä¸­çš„é€»è¾‘å—ï¼Ÿ

è®°å¾—åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºã€äº¤æµä½ çš„æƒ³æ³•ï¼Œæ¯ä¸€æ¬¡æ€è€ƒéƒ½ä¼šè®©ä½ æ›´è¿›ä¸€æ­¥ã€‚

å¦‚æœä½ è¯»å®Œè¿™ç¯‡æ–‡ç« æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå…±åŒå­¦ä¹ è¿›æ­¥ã€‚æˆ‘ä»¬ä¸‹ä¸€è®²å†è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ6ï¼‰</strong></div><ul>
<li><span>é¦’å¤´å¤§ç‹</span> ğŸ‘ï¼ˆ9ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ ¹æ®ç³»ç»ŸæŒ‡æ ‡ç°è±¡çœ‹é—®é¢˜

ä¸€ã€TPSä½&#47;å“åº”è€—æ—¶é•¿
1ã€åˆ†æé“¾è·¯-æ¨èskywalking
2ã€å‘ç°service-MySQLè€—æ—¶è¾ƒé•¿
3ã€ç¡®å®šæ…¢SQL
	æ–¹æ³•1ï¼šMySQL Report-pt-query-digestï¼ˆè§£ææ…¢æ—¥å¿—ï¼‰
	æ–¹æ³•2ï¼šRDSâ†’æ—¥å¿—ç®¡ç†
	æ³¨ï¼šä¸€èˆ¬ä¼´éšç€DB CPUé«˜
4ã€â€æ‰§è¡Œè®¡åˆ’â€œåˆ†ææ…¢SQL
	ï¼ˆæ‰§è¡Œ explain æˆ– desc  + SQLï¼‰
5ã€æ·»åŠ ç›¸å…³ç´¢å¼•
	æ— æ³•é€šè¿‡ç´¢å¼•è§£å†³çš„æ ¹æ®ä¸šåŠ¡ä¼˜åŒ–ä»£ç 
6ã€é—®é¢˜è§£å†³

äºŒã€æŠ¥é”™&#47;é”™è¯¯ç‡é«˜
1ã€æŸ¥æ—¥å¿—
2ã€å…·ä½“é—®é¢˜å…·ä½“åˆ†æ
	è­¬å¦‚ï¼š
	1ï¼‰å‚æ•°
	2ï¼‰ä¸»é”®å†²çª
	3ï¼‰è¶…æ—¶
	4ï¼‰æœåŠ¡é™çº§
	~~~~</p>2021-04-27</li><br/><li><span>åŒå¿ƒé£ç¿”</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è€å¸ˆï¼Œæ˜¯å¦å¯ä»¥æ¨èä¸ªæœ‰å„ç§æ€§èƒ½é—®é¢˜çš„å¼€æºç³»ç»Ÿï¼Œå¤§å®¶æ¥ç»ƒæ‰‹ã€‚è¿˜æ˜¯è¦è‡ªå·±å®è·µ</p>2021-04-26</li><br/><li><span>z-Amy</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆä½ å¥½ï¼Œè¯·é—®MySQL Report æ˜¯ä»€ä¹ˆå‘½ä»¤æ‰“å°å‡ºæ¥çš„ï¼Ÿ</p>2024-02-22</li><br/><li><span>å§‘å°„ä»™äºº</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä¸ºä»€ä¹ˆæ˜¯Cart - MySQLå½±å“æœ€å¤§ï¼Œçœ‹å›¾ä¸Šæ‰113msã€‚User - Gatewayï¼ŒGateway - Cartå¹³å‡å“åº”æ—¶é—´ä¹Ÿå¾ˆå¤§å‘€ï¼Œè¿™å—æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</p>2022-01-20</li><br/><li><span>å®‰é™ã€‚ã€‚ã€‚</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>2. ä½ èƒ½ç”»å‡ºåœ¨ç¬¬äºŒé˜¶æ®µåˆ†æä¸­çš„é€»è¾‘å—ï¼Ÿ
å› ä¸ºé”™è¯¯æ•°é‡éšç€è¯·æ±‚æ•°é‡çš„å¢åŠ è€Œå¢åŠ 
æŸ¥çœ‹é”™è¯¯çš„æ—¥å¿—ï¼Œç¡®å®šä»£ç æ˜¯åœ¨addçš„æ—¶å€™æŠ¥é”™
é‚£ä¹ˆåŒæ—¶è¯·æ±‚addçš„åœºæ™¯ï¼Œè·Ÿå®é™…çš„åœºæ™¯æœ‰å…³ç³»
å®é™…ä¸Šå¯èƒ½ä¸ä¼šæœ‰å¤šä¸ªç”¨æˆ·åŒæ—¶è¯·æ±‚çš„åœºæ™¯ï¼Œéœ€è¦ä¿®æ”¹å‹æµ‹æ•°æ®</p>2021-07-12</li><br/><li><span>å…¬ç‘¾</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œæ…¢æ—¥å¿—é˜ˆå€¼ä¸€èˆ¬è®¾ç½®æˆå¤šå°‘ï¼Œ100mså·¦å³å—ï¼Ÿ</p>2021-06-17</li><br/>
</ul>