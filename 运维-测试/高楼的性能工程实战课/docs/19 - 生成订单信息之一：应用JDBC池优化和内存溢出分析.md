ä½ å¥½ï¼Œæˆ‘æ˜¯é«˜æ¥¼ã€‚

åœ¨è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç”Ÿæˆè®¢å•æ¥å£çš„åŸºå‡†åœºæ™¯æ˜¯ä»€ä¹ˆç»“æœã€‚

ä½ å°†çœ‹åˆ°ä¸€äº›é‡å¤çš„é—®é¢˜ï¼Œæ¯”å¦‚SQLçš„é—®é¢˜å®šä½ï¼Œè™½ç„¶å…·ä½“çš„é—®é¢˜ä¸åŒï¼Œä½†æˆ‘ä»¬çš„åˆ†æé€»è¾‘æ²¡æœ‰åŒºåˆ«ï¼Œæˆ‘ä¼šç®€å•å¸¦è¿‡ã€‚åŒæ—¶ï¼Œä½ ä¹Ÿä¼šçœ‹åˆ°ä¸€äº›æ–°çš„é—®é¢˜ï¼Œæ¯”å¦‚JDBCæ± å¢åŠ ä¹‹åï¼Œç”±äºæ•°æ®é‡è¿‡å¤§å¯¼è‡´JVMå†…å­˜è¢«æ¶ˆè€—å…‰ï¼›æ‰¹é‡ä¸šåŠ¡å’Œå®æ—¶ä¸šåŠ¡å…±å­˜å¯¼è‡´çš„é”é—®é¢˜ç­‰ã€‚è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬é‡ç‚¹æ¥çœ‹çœ‹è¿™æ ·çš„é—®é¢˜å¦‚ä½•è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚

è¯ä¸å¤šè¯´ï¼Œå¼€æ•´ï¼

## åœºæ™¯è¿è¡Œæ•°æ®

å¯¹äºç”Ÿæˆè®¢å•æ¥å£ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡è¯•æ‰§è¡Œæ€§èƒ½åœºæ™¯çš„ç»“æœå¦‚ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/dc/6a/dcbed4b3bc53be11f7d18280b8f1d16a.png?wh=1830%2A831)

ä»åœºæ™¯æ‰§è¡Œçš„ç»“æœæ¥çœ‹ã€‚40ä¸ªå‹åŠ›çº¿ç¨‹åªè·‘å‡ºæ¥50å¤šçš„TPSï¼Œå“åº”æ—¶é—´ä¹Ÿè¹­è¹­è¹­åœ°è·‘äº†è¿‘700msã€‚è¿™æ˜¾ç„¶æ˜¯ä¸€ä¸ªéå¸¸æ…¢çš„æ¥å£äº†ã€‚

ä»è¿™æ ·çš„æ¥å£æ¥çœ‹ï¼Œæˆ‘ä»¬é€‰æ‹©è¿™ä¸ªé¡¹ç›®ç®—æ˜¯é€‰æ‹©å¯¹äº†ï¼Œå› ä¸ºåˆ°å¤„éƒ½æ˜¯æ€§èƒ½é—®é¢˜ã€‚

ä¸‹é¢æˆ‘ä»¬å°±æ¥ä¸€æ­¥æ­¥åˆ†æä¸€ä¸‹ã€‚

## æ¶æ„å›¾

å‰é¢æˆ‘ä»¬åšè¿‡å¤šæ¬¡æè¿°ï¼Œç”»æ¶æ„å›¾æ˜¯ä¸ºäº†çŸ¥é“åˆ†æçš„è·¯å¾„ã€‚æ‰€ä»¥æŒ‰ç…§æƒ¯ä¾‹ï¼Œæˆ‘ä»¬ä»ç„¶æŠŠæ¶æ„å›¾åˆ—åœ¨è¿™é‡Œã€‚

![](https://static001.geekbang.org/resource/image/89/5f/8973byyed69dec259cb6f7d4bf3f4b5f.png?wh=1215%2A731)

ç”±äºè¿™ä¸ªæ¥å£æ¯”è¾ƒå¤æ‚ï¼Œæ¶æ„å›¾çœ‹èµ·æ¥æœ‰ç‚¹ä¹±ï¼Œæˆ‘åˆæ•´äº†ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼š

![](https://static001.geekbang.org/resource/image/c9/aa/c95c8daab26ca52fb2df688986a1c0aa.png?wh=894%2A736)

OrderæœåŠ¡æ˜¯è¿™ä¸ªæ¥å£çš„æ ¸å¿ƒï¼Œå› æ­¤ï¼Œä½ å¯ä»¥çœ‹åˆ°æˆ‘æŠŠOrderç›¸å…³çš„æœåŠ¡éƒ½ç­›é€‰äº†å‡ºæ¥ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å¾ˆæ¸…æ¥šåœ°çŸ¥é“å®ƒè¿æ¥äº†å“ªäº›ä¸œè¥¿ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥æ‹†åˆ†å“åº”æ—¶é—´ã€‚

## æ‹†åˆ†å“åº”æ—¶é—´

å› ä¸ºåœ¨åœºæ™¯è¿è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬çœ‹åˆ°å“åº”æ—¶é—´æ¯”è¾ƒé•¿ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨APMå·¥å…·æ¥æ‹†åˆ†ä¸€ä¸‹ï¼š

- Gateway ï¼š

![](https://static001.geekbang.org/resource/image/b7/5c/b7f6b87b608cc0fc9b8f6e05baf90c5c.png?wh=330%2A183)

ä»ä¸Šå›¾æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°Gatewayä¸Šçš„æ—¶é—´åœ¨700mså·¦å³ï¼Œè¿™ä¸å‰é¢çš„åœºæ™¯æ•°æ®æ˜¯å¯ä»¥å¯¹ä¸Šçš„ã€‚

æˆ‘è¯´æ˜ä¸€ä¸‹ï¼Œè¿™å¼ å°å›¾çš„é‡‡æ ·é—´éš”æ˜¯åˆ†é’Ÿï¼Œå› æ­¤ï¼Œä½ å¯èƒ½ä¼šå‘ç°è¿™ä¸ªæ›²çº¿å’Œå‹åŠ›å·¥å…·ç»™å‡ºçš„TPSæ›²çº¿ï¼Œåœ¨ä¸€äº›ç»†èŠ‚ä¸Šå¯¹åº”ä¸èµ·æ¥ã€‚ä¸è¿‡è¿™æ²¡å…³ç³»ï¼Œæˆ‘ä»¬æ›´åº”è¯¥å…³æ³¨æ•´ä½“çš„è¶‹åŠ¿ã€‚

- Orderï¼š

![](https://static001.geekbang.org/resource/image/c9/01/c9aaa22298a00d7b68a6d89f7cef7501.png?wh=324%2A161)

æˆ‘ä»¬å‰é¢æåˆ°ï¼ŒOrderæ˜¯ç”Ÿäº§è®¢å•ä¿¡æ¯è¿™ä¸ªæ¥å£çš„é‡ç‚¹ï¼Œå¹¶ä¸”å®ƒçš„ä¸šåŠ¡é€»è¾‘ä¹Ÿéå¸¸å¤æ‚ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬è¦å¤šå…³æ³¨è¿™ä¸ªæœåŠ¡ã€‚

ä»æ•°æ®ä¸Šæ¥çœ‹ï¼ŒOrderçš„æ˜¯æ—¶é—´æ¶ˆè€—åœ¨350æ¯«ç§’å·¦å³ï¼Œå åˆ°æ•´ä¸ªå“åº”æ—¶é—´çš„ä¸€åŠã€‚è¿™æ˜¯æˆ‘ä»¬ç€é‡è¦åˆ†æçš„ï¼Œè€ŒGatewayçš„è½¬å‘èƒ½åŠ›ä¹Ÿæ˜¯è¦è€ƒè™‘çš„é—®é¢˜ç‚¹ï¼Œåªæ˜¯Gatewayä¸Šæ²¡æœ‰é€»è¾‘ï¼Œåªåšè½¬å‘ï¼Œå¦‚æœæ˜¯å› ä¸ºæ•°æ®é‡å¤§è€Œå¯¼è‡´çš„Gatewayè½¬å‘æ…¢ï¼Œé‚£æˆ‘ä»¬è§£å†³äº†Orderçš„é—®é¢˜ä¹‹åï¼ŒGatewayçš„é—®é¢˜ä¹Ÿå°±ä¼šè¢«è§£å†³ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å…ˆåˆ†æOrderçš„é—®é¢˜ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬ç°åœ¨å°±æ¥åˆ†æä¸€ä¸‹ã€‚

## ç¬¬ä¸€é˜¶æ®µ

### å…¨å±€ç›‘æ§åˆ†æ

æˆ‘ä»¬å…ˆçœ‹å…¨å±€ç›‘æ§ï¼š

![](https://static001.geekbang.org/resource/image/58/e8/584fc960c184d9c4bba12fae9b6c58e8.png?wh=1826%2A457)

ä¸€çœ¼æ‰«è¿‡å»ï¼Œå•¥ä¹Ÿæ²¡æœ‰ã€‚æ—¢æ²¡æœ‰æ˜æ˜¾çš„CPUèµ„æºæ¶ˆè€—ï¼Œä¹Ÿæ²¡æœ‰æ˜æ˜¾çš„ç½‘ç»œèµ„æºã€IOèµ„æºç“¶é¢ˆã€‚

**é‡åˆ°è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬ä¸€å®šè¦ç•™æ„æ•´ä¸ªé“¾è·¯ä¸Šæœ‰é™åˆ¶çš„ç‚¹**ã€‚ä»€ä¹ˆæ˜¯æœ‰é™åˆ¶çš„ç‚¹ï¼Ÿæ¯”å¦‚è¯´ï¼Œå„ç§æ± ï¼ˆè¿æ¥æ± ã€ç­‰ï¼‰ã€æ ˆä¸­çš„é”ã€æ•°æ®åº“è¿æ¥ã€è¿˜æœ‰æ•°æ®åº“çš„é”ä¹‹ç±»ã€‚å…¶å®ï¼Œæ€»ç»“ä¸‹æ¥å°±æ˜¯ä¸€ä¸ªå…³é”®è¯ï¼š**é˜»å¡**ã€‚

æˆ‘ä»¬åªè¦åˆ†æå‡ºé˜»å¡çš„ç‚¹ï¼Œå°±èƒ½æŠŠé“¾è·¯æ‰©å®½ï¼Œè¿›è€ŒæŠŠèµ„æºéƒ½ç”¨èµ·æ¥ã€‚

å½“ç„¶ï¼Œä¹Ÿæœ‰å¯èƒ½åœ¨ä½ åˆ†æäº†ä¸€åœˆä¹‹åï¼Œå‘ç°æ²¡æœ‰ä»»ä½•æœ‰é˜»å¡çš„ç‚¹ï¼Œå¯æ˜¯èµ„æºå°±æ˜¯ç”¨ä¸ä¸Šå»ã€‚è¿™ç§æƒ…å†µåªæœ‰ä¸€ç§å¯èƒ½ï¼Œé‚£å°±æ˜¯ä½ åˆ†æå¾—è¿˜ä¸å¤Ÿç»†è‡´ã€‚å› ä¸ºå¯èƒ½å­˜åœ¨é˜»å¡çš„åœ°æ–¹å®åœ¨å¤ªå¤šäº†ï¼Œæˆ‘ä»¬åªèƒ½ä¸€æ­¥æ­¥æ‹†è§£ã€‚

### å®šå‘ç›‘æ§åˆ†æ

æ­£æ‰€è°“â€œå¿ƒä¸­å¸¸å¤‡å†³ç­–æ ‘ï¼Œè®©ä½ åˆ†æä¸è¿·è·¯â€ã€‚åˆ°äº†å®šå‘ç›‘æ§åˆ†æè¿™é‡Œï¼ŒæŒ‰ç…§[ç¬¬4è®²](https://time.geekbang.org/column/article/356789)ä¸­å¼ºè°ƒçš„æ€§èƒ½åˆ†æå†³ç­–æ ‘ï¼Œæˆ‘ä»¬å…ˆæ¥åˆ†æOrderæœåŠ¡ï¼š

![](https://static001.geekbang.org/resource/image/3e/84/3e2cd8928022bccf83fe69a71f004784.jpg?wh=2000%2A1706)

åœ¨æˆ‘åˆ†æOrderçš„çº¿ç¨‹æ ˆä¿¡æ¯æ—¶ï¼Œå‘ç°åœ¨Orderçš„æ ˆä¸­ï¼Œæœ‰å¤§é‡è¿™æ ·çš„å†…å®¹ï¼š

```
"http-nio-8086-exec-421" Id=138560 WAITING on java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@a268a48
    at sun.misc.Unsafe.park(Native Method)
    -  waiting on java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@a268a48
    at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
    at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
    at com.alibaba.druid.pool.DruidDataSource.takeLast(DruidDataSource.java:1899)
    at com.alibaba.druid.pool.DruidDataSource.getConnectionInternal(DruidDataSource.java:1460)
    at com.alibaba.druid.pool.DruidDataSource.getConnectionDirect(DruidDataSource.java:1255)
    at com.alibaba.druid.filter.FilterChainImpl.dataSource_connect(FilterChainImpl.java:5007)
    at com.alibaba.druid.filter.stat.StatFilter.dataSource_getConnection(StatFilter.java:680)
    at com.alibaba.druid.filter.FilterChainImpl.dataSource_connect(FilterChainImpl.java:5003)
    at com.alibaba.druid.pool.DruidDataSource.getConnection(DruidDataSource.java:1233)
    at com.alibaba.druid.pool.DruidDataSource.getConnection(DruidDataSource.java:1225)
    at com.alibaba.druid.pool.DruidDataSource.getConnection(DruidDataSource.java:90)
    ..........................
    at com.dunshan.mall.order.service.impl.PortalOrderServiceImpl$$EnhancerBySpringCGLIB$$f64f6aa2.generateOrder(<generated>)
    at com.dunshan.mall.order.controller.PortalOrderController.generateOrder$original$hak2sOst(PortalOrderController.java:48)
    at com.dunshan.mall.order.controller.PortalOrderController.generateOrder$original$hak2sOst$accessor$NTnIbuo7(PortalOrderController.java)
    at com.dunshan.mall.order.controller.PortalOrderController$auxiliary$MTWkGopH.call(Unknown Source)
    ..........................
    at com.dunshan.mall.order.controller.PortalOrderController.generateOrder(PortalOrderController.java)
    ..........................
```

ä½ çœ‹ï¼Œæ ˆä¿¡æ¯ä¸­æœ‰å¾ˆå¤šgetConnectionï¼Œè¿™æ˜æ˜¾æ˜¯OrderæœåŠ¡åœ¨ç­‰æ•°æ®åº“è¿æ¥æ± ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯æŠŠJDBCæ± åŠ å¤§ï¼š

```
åŸé…ç½®ï¼š
      initial-size: 5 #è¿æ¥æ± åˆå§‹åŒ–å¤§å°
      min-idle: 10 #æœ€å°ç©ºé—²è¿æ¥æ•°
      max-active: 20 #æœ€å¤§è¿æ¥æ•°


ä¿®æ”¹ä¸ºï¼š
      initial-size: 20 #è¿æ¥æ± åˆå§‹åŒ–å¤§å°
      min-idle: 10 #æœ€å°ç©ºé—²è¿æ¥æ•°
      max-active: 40 #æœ€å¤§è¿æ¥æ•°
```

ä½ å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘åœ¨è¿™é‡Œå¹¶æ²¡æœ‰æŠŠJDBCæ± ä¸€æ¬¡æ€§ä¿®æ”¹å¾—å¤ªå¤§ï¼Œä¸»è¦æ˜¯å› ä¸ºæˆ‘ä¸æƒ³ä¸ºäº†ç»´æŠ¤è¿æ¥æ± è€Œäº§ç”Ÿè¿‡å¤šçš„CPUæ¶ˆè€—ã€‚æˆ‘ä¹Ÿå»ºè®®ä½ åœ¨å¢åŠ èµ„æºæ± çš„æ—¶å€™ï¼Œå…ˆä¸€ç‚¹ç‚¹å¢åŠ ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰æ•ˆæœï¼Œç­‰æœ‰äº†æ•ˆæœåå†æ¥ç€å¢åŠ ã€‚

ä¿®æ”¹JDBCæ± åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹å‹åŠ›åœºæ™¯çš„æ‰§è¡Œæ•°æ®ï¼š

![](https://static001.geekbang.org/resource/image/a8/bb/a8e672d9f5f829509a68216ed0146ebb.png?wh=1829%2A834)

ä»æ•°æ®ä¸Šçœ‹ï¼ŒTPSæœ‰ä¸Šå‡çš„è¶‹åŠ¿ï¼Œå¹¶ä¸”ä¸€åº¦è¾¾åˆ°äº†150ä»¥ä¸Šã€‚å¯æ˜¯ç´§æ¥ç€ï¼ŒTPSå°±æ‰ä¸‹æ¥äº†ï¼Œè¿™ä¸ªæ—¶å€™çš„å“åº”æ—¶é—´å€’æ˜¯æ²¡æœ‰æ˜æ˜¾å¢åŠ ã€‚è€Œä¸”ä½ çœ‹ï¼ŒTPSä¸ä»…æ‰ä¸‹æ¥äº†ï¼Œè€Œä¸”è¿˜æ–­æ–­ç»­ç»­çš„ï¼Œæä¸ºä¸ç¨³å®šã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å‘ç°ï¼Œåœ¨åç»­çš„å‹åŠ›ä¸­ä¸ä»…æœ‰é”™è¯¯ä¿¡æ¯äº§ç”Ÿï¼Œå“åº”æ—¶é—´ä¹Ÿåœ¨ä¸Šå‡ã€‚ä¸æ­¤åŒæ—¶ï¼Œæˆ‘æŸ¥çœ‹äº†å…¨å±€ç›‘æ§çš„èµ„æºï¼Œå¹¶æ²¡æœ‰å‘ç°å¤ªå¤§çš„èµ„æºæ¶ˆè€—ã€‚æ—¢ç„¶æœ‰é”™è¯¯äº§ç”Ÿï¼Œæ²¡äºŒè¯ï¼Œæˆ‘ä»¬åªèƒ½æ•´å®ƒï¼

## ç¬¬äºŒé˜¶æ®µ

### å…¨å±€ç›‘æ§åˆ†æ

å› ä¸ºæˆ‘ä»¬åœ¨å‰é¢ä¿®æ”¹äº†Orderçš„JDBCæ± ï¼Œæ‰€ä»¥åœ¨å‡ºç°æ–°çš„é—®é¢˜ä¹‹åï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹OrderæœåŠ¡çš„å¥åº·çŠ¶æ€ã€‚åœ¨æŸ¥çœ‹OrderæœåŠ¡çš„topæ—¶ï¼Œçœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š

```
top - 01:28:17 up 19 days, 11:54,  3 users,  load average: 1.14, 1.73, 2.27
Tasks: 316 total,   1 running, 315 sleeping,   0 stopped,   0 zombie
%Cpu0  :100.0 us,  0.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
%Cpu1  :  3.0 us,  2.7 sy,  0.0 ni, 93.6 id,  0.0 wa,  0.0 hi,  0.3 si,  0.3 st
%Cpu2  :  3.4 us,  3.4 sy,  0.0 ni, 93.3 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
%Cpu3  :  3.7 us,  2.8 sy,  0.0 ni, 93.5 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
%Cpu4  :  3.6 us,  2.1 sy,  0.0 ni, 93.6 id,  0.0 wa,  0.0 hi,  0.3 si,  0.3 st
%Cpu5  :  2.8 us,  1.8 sy,  0.0 ni, 95.4 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem : 16265992 total,  2229060 free,  9794944 used,  4241988 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  6052732 avail Mem 


  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                                                                  
29349 root      20   0 8836040   4.3g  16828 S  99.7 27.4  20:51.90 java                                                                                                                     
 1089 root      20   0 2574864  98144  23788 S   6.6  0.6   2066:38 kubelet  
```

æ‚²å‚¬çš„æ•°æ®è¿˜æ˜¯æ¥äº†ï¼Œä½ çœ‹ï¼Œæœ‰ä¸€ä¸ªus cpuè¾¾åˆ°äº†100%ï¼è¿™æ˜¯å•¥æƒ…å†µï¼Ÿ

è¿›å…¥åˆ°å®¹å™¨ä¸­ï¼Œæˆ‘é€šè¿‡ top -Hpå’Œjstack -l 1 ä¸¤ä¸ªå‘½ä»¤æŸ¥çœ‹è¿›ç¨‹åå‘ç°ï¼ŒåŸæ¥æ˜¯VM Threadçº¿ç¨‹å ç”¨äº†CPUï¼Œè¿™ä¸ªçº¿ç¨‹æ˜¯åšåƒåœ¾å›æ”¶ï¼ˆGCï¼‰çš„ã€‚ æ—¢ç„¶å¦‚æ­¤ï¼Œé‚£æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹å†…å­˜çš„å›æ”¶çŠ¶æ€ï¼ŒæŸ¥çœ‹jstatå¦‚ä¸‹ï¼š

```
[root@svc-mall-order-7fbdd7b85f-ks828 /]# jstat -gcutil 1 1s
  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT   
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    93  652.664  681.486
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    93  652.664  681.486
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    93  652.664  681.486
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    93  652.664  681.486
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    93  652.664  681.486
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    93  652.664  681.486
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    93  652.664  681.486
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    94  659.863  688.685
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    94  659.863  688.685
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    94  659.863  688.685
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    94  659.863  688.685
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    94  659.863  688.685
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    94  659.863  688.685
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    94  659.863  688.685
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    95  667.472  696.294
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    95  667.472  696.294
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    95  667.472  696.294
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    95  667.472  696.294
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    95  667.472  696.294
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    95  667.472  696.294
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    95  667.472  696.294
  0.00 100.00 100.00 100.00  94.86  93.15    168   28.822    95  667.472  696.294
  0.00 100.00 100.00 100.00  94.85  93.14    168   28.822    96  674.816  703.638
  0.00 100.00 100.00 100.00  94.85  93.14    168   28.822    96  674.816  703.638
  0.00 100.00 100.00 100.00  94.85  93.14    168   28.822    96  674.816  703.638
  0.00 100.00 100.00 100.00  94.85  93.14    168   28.822    96  674.816  703.638
  0.00 100.00 100.00 100.00  94.85  93.14    168   28.822    96  674.816  703.638
  0.00 100.00 100.00 100.00  94.85  93.14    168   28.822    96  674.816  703.638
  0.00 100.00 100.00 100.00  94.85  93.14    168   28.822    96  674.816  703.638
```

ä»ä¸Šé¢çš„æ•°æ®æ¥çœ‹ï¼ŒFullGCåœ¨ä¸æ–­å‡ºç°ï¼Œä½†æ˜¯åˆå›æ”¶ä¸äº†å†…å­˜ï¼Œè¿™ä¸ªé—®é¢˜å°±ä¸¥é‡äº†ã€‚

ä½ è¦æ³¨æ„ï¼Œå¯¹äºè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬æ­£å¸¸çš„åˆ¤æ–­é€»è¾‘åº”è¯¥æ˜¯ï¼šä¸€**ä¸ªå®æ—¶çš„ä¸šåŠ¡ç³»ç»Ÿå°±ç®—æ˜¯æœ‰FullGCï¼Œä¹Ÿåº”è¯¥æ˜¯æ¯æ¬¡éƒ½å›æ”¶åˆ°æ­£å¸¸çš„çŠ¶æ€ã€‚å¦‚æœHEAPå†…å­˜ç¡®å®ä¸å¤Ÿç”¨ï¼Œé‚£æˆ‘ä»¬å¯ä»¥å¢åŠ ã€‚ä½†æ˜¯å¦‚æœHEAPä¸€ç›´åœ¨å‡å°‘ï¼Œç›´åˆ°FullGCä¹Ÿå›æ”¶ä¸äº†ï¼Œé‚£å°±æœ‰é—®é¢˜äº†ã€‚**

å› æ­¤ï¼Œå¯¹äºè¿™æ ·çš„é—®é¢˜ï¼Œæˆ‘ä»¬è¦åšä¸¤æ–¹é¢çš„åˆ†æï¼š

1. å†…å­˜ç¡®å®åœ¨è¢«ä½¿ç”¨ï¼Œæ‰€ä»¥ï¼ŒFullGCå›æ”¶ä¸äº†ã€‚
2. å†…å­˜æœ‰æ³„éœ²ï¼Œå¹¶ä¸”å·²ç»æ³„éœ²å®Œï¼Œæ‰€ä»¥ï¼ŒFullGCæ— æ³•å›æ”¶ã€‚

é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨åšå®šå‘ç›‘æ§åˆ†ææ—¶å°±è¦ä»è¿™ä¸¤ä¸ªè§’åº¦æ¥æ€è€ƒã€‚

### å®šå‘ç›‘æ§åˆ†æ

æ—¢ç„¶å†…å­˜å·²ç»æ»¡äº†ï¼Œæˆ‘ä»¬å°±æ‰§è¡Œä¸€ä¸‹jmap -histo:live 1|head -n 50ï¼Œæ¥çœ‹çœ‹å æ¯”ç›¸å¯¹è¾ƒå¤šçš„å†…å­˜æ˜¯ä»€ä¹ˆï¼š

```
[root@svc-mall-order-7fbdd7b85f-ks828 /]# jmap -histo:live 1|head -n 50


 num     #instances         #bytes  class name
----------------------------------------------
   1:      74925020     2066475600  [B
   2:       2675397      513676056  [[B
   3:       2675385       85612320  com.mysql.cj.protocol.a.result.ByteArrayRow
   4:       2675386       42806176  com.mysql.cj.protocol.a.MysqlTextValueDecoder
   5:        246997       27488016  [C
   6:         80322       16243408  [Ljava.lang.Object;
   7:         14898        7514784  [Ljava.util.HashMap$Node;
   8:        246103        5906472  java.lang.String
   9:        109732        3511424  java.util.concurrent.ConcurrentHashMap$Node
  10:         37979        3342152  java.lang.reflect.Method
  11:         24282        2668712  java.lang.Class
  12:         55296        2654208  java.util.HashMap
  13:         15623        2489384  [I
  14:         81370        1952880  java.util.ArrayList
  15:         50199        1204776  org.apache.skywalking.apm.agent.core.context.util.TagValuePair
  16:         36548        1169536  java.util.HashMap$Node
  17:           566        1161296  [Ljava.util.concurrent.ConcurrentHashMap$Node;
  18:         28143        1125720  java.util.LinkedHashMap$Entry
  19:         13664        1093120  org.apache.skywalking.apm.agent.core.context.trace.ExitSpan
  20:         23071         922840  com.sun.org.apache.xerces.internal.dom.DeferredTextImpl
  21:         35578         853872  java.util.LinkedList$Node
  22:         15038         842128  java.util.LinkedHashMap
  23:         52368         837888  java.lang.Object
  24:         17779         711160  com.sun.org.apache.xerces.internal.dom.DeferredAttrImpl
  25:         11260         630560  com.sun.org.apache.xerces.internal.dom.DeferredElementImpl
  26:         18743         599776  java.util.LinkedList
  27:         26100         598888  [Ljava.lang.Class;
  28:         22713         545112  org.springframework.core.MethodClassKey
  29:           712         532384  [J
  30:          6840         492480  org.apache.skywalking.apm.agent.core.context.trace.LocalSpan
  31:          6043         483440  org.apache.skywalking.apm.dependencies.net.bytebuddy.pool.TypePool$Default$LazyTypeDescription$MethodToken
  32:          7347         352656  org.aspectj.weaver.reflect.ShadowMatchImpl
  33:          6195         297360  org.springframework.core.ResolvableType
  34:          6249         271152  [Ljava.lang.String;
  35:         11260         270240  com.sun.org.apache.xerces.internal.dom.AttributeMap
  36:          3234         258720  java.lang.reflect.Constructor
  37:           390         255840  org.apache.skywalking.apm.dependencies.io.netty.util.internal.shaded.org.jctools.queues.MpscArrayQueue
  38:          7347         235104  org.aspectj.weaver.patterns.ExposedState
  39:          5707         228280  java.lang.ref.SoftReference
  40:          3009         216648  org.apache.skywalking.apm.agent.core.context.TracingContext
  41:         13302         212832  org.apache.ibatis.scripting.xmltags.StaticTextSqlNode
  42:          8477         203448  org.apache.skywalking.apm.dependencies.net.bytebuddy.pool.TypePool$Default$LazyTypeDescription$MethodToken$ParameterToken
  43:          5068         162176  java.util.concurrent.locks.ReentrantLock$NonfairSync
  44:          2995         143760  org.apache.skywalking.apm.agent.core.context.trace.TraceSegmentRef
  45:          2426         135856  java.lang.invoke.MemberName
  46:          3262         130480  java.util.WeakHashMap$Entry
  47:          1630         130400  org.apache.skywalking.apm.agent.core.context.trace.EntrySpan
[root@svc-mall-order-7fbdd7b85f-ks828 /]# 
```

åœ¨åˆ†æå†…å­˜æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿‡æ»¤æ‰javaè‡ªå·±çš„å¯¹è±¡ï¼Œåªçœ‹å’Œä¸šåŠ¡ç›¸å…³çš„å¯¹è±¡ã€‚ä»ä¸Šé¢çš„ç¬¬3ã€4æ¡å¯ä»¥çœ‹å‡ºï¼Œcom.mysql.cj.protocolå’ŒSQLç›¸å…³ï¼Œé‚£æˆ‘ä»¬å°±åˆ°innodb\_trxè¡¨ä¸­å»æŸ¥ä¸€ä¸‹ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰æ‰§è¡Œæ—¶é—´æ¯”è¾ƒé•¿çš„SQLã€‚

åœ¨æŸ¥è¯¢è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†è¿™æ ·ä¸€æ¡SQLï¼š

```
select id, member_id, coupon_id, order_sn, create_time, member_username, total_amount pay_amount,  freight_amount, promotion_amount, integration_amount, coupon_amount discount_amount,  pay_type, source_type, status, order_type, delivery_company, delivery_sn auto_confirm_day,  integration, growth, promotion_info, bill_type, bill_header, bill_content bill_receiver_phone,  bill_receiver_email, receiver_name, receiver_phone, receiver_post_code receiver_province,  receiver_city, receiver_region, receiver_detail_address, note, confirm_status delete_status,  use_integration, payment_time, delivery_time, receive_time, comment_time modify_time from oms_order  WHERE (  id = 0 and status = 0 and delete_status = 0 )
```

è¿›è€Œæˆ‘åˆæŸ¥è¯¢äº†è¿™ä¸ªè¯­å¥ï¼Œå‘ç°æ¶‰åŠåˆ°çš„æ•°æ®æœ‰4358761æ¡ï¼Œè¿™æ˜¾ç„¶æ˜¯ä»£ç å†™çš„æœ‰é—®é¢˜ã€‚é‚£æˆ‘ä»¬å°±å»æŸ¥çœ‹ä¸€ä¸‹åœ¨ä»£ç ä¸­ï¼Œå“ªé‡Œè°ƒç”¨äº†è¿™ä¸ªSQLã€‚

é€šè¿‡æŸ¥çœ‹ä»£ç ï¼Œçœ‹åˆ°å¦‚ä¸‹é€»è¾‘ï¼š

```
example.createCriteria().andIdEqualTo(orderId).andStatusEqualTo(0).andDeleteStatusEqualTo(0);
List<OmsOrder> cancelOrderList = orderMapper.selectByExample(example);
```

è¿™æ®µä»£ç å¯¹åº”çš„selectè¯­å¥æ˜¯ï¼š

```
 <select id="selectByExample" parameterType="com.dunshan.mall.model.OmsOrderExample" resultMap="BaseResultMap">
    select
    <if test="distinct">
      distinct
    </if>
    <include refid="Base_Column_List" />
    from oms_order
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null">
      order by ${orderByClause}
    </if>
  </select>
```

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„è¯­å¥æ²¡è¿‡æ»¤çš„é—®é¢˜ã€‚åƒè¿™æ ·çš„å¼€å‘é¡¹ç›®ï¼Œä¹Ÿæœ€å¤šå°±æ˜¯åšä¸ªDemoç”¨ã€‚è¦æ˜¯åœ¨çœŸå®çš„çº¿ä¸Šé¡¹ç›®ä¸­ï¼Œæ—©å°±ä¸çŸ¥é“ä¼¤å®³äº†å¤šå°‘äººã€‚

æˆ‘ä»¬åœ¨è¿™é‡Œç›´æ¥ä¿®æ”¹ä»£ç åŠ ä¸Šlimitï¼Œä¸è®©å®ƒä¸€æ¬¡æ€§æŸ¥è¯¢å‡ºæ‰€æœ‰çš„æ•°æ®ã€‚

ç„¶åï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ä¼˜åŒ–æ•ˆæœï¼š

![](https://static001.geekbang.org/resource/image/42/5c/42d0c383e03acf38b31e4fc7879c2f5c.png?wh=1830%2A829)

ä½ çœ‹ï¼Œæ²¡æœ‰å‡ºç°TPSæ–­è£‚çš„æƒ…å†µäº†ï¼Œä¼˜åŒ–æ•ˆæœè¿˜æ˜¯æœ‰çš„ï¼Œè¯´æ˜é‚£æ¡SQLè¯­å¥ä¸ä¼šå†æŸ¥å‡ºå¤ªå¤šæ•°æ®æŠŠå†…å­˜ç»™å æ»¡äº†ã€‚

ä¸è¿‡ï¼ŒTPSå€¼å¹¶æ²¡æœ‰å¢åŠ å¤šå°‘ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åšç¬¬ä¸‰é˜¶æ®µçš„åˆ†æã€‚

## ç¬¬ä¸‰é˜¶æ®µ

è¿™æ¬¡æˆ‘ä»¬ä¸ä»å…¨å±€ç›‘æ§æ•°æ®æ¥çœ‹äº†ï¼Œæœ‰äº†å‰é¢çš„ç»éªŒï¼Œæˆ‘ä»¬ç›´æ¥æ¥åšå®šå‘ç›‘æ§åˆ†æã€‚

### å®šå‘ç›‘æ§åˆ†æ

å› ä¸ºæˆ‘ä»¬åœ¨å‰é¢æ”¹äº†SQLï¼Œæ‰€ä»¥åœ¨æ‰§è¡ŒSQLä¹‹åï¼Œæˆ‘ä»¬è¦å»æŸ¥ä¸€ä¸‹innodb\_trxè¡¨ï¼Œçœ‹çœ‹è¿˜æœ‰æ²¡æœ‰æ…¢çš„SQLã€‚ ç»“æœï¼Œçœ‹åˆ°äº†å¦‚ä¸‹SQLï¼š

![](https://static001.geekbang.org/resource/image/cb/73/cb7cd20de10b8d55b3c94f47c2576273.png?wh=1889%2A222)

æŠŠè¿™ä¸ªSQLæ‹¿å‡ºæ¥ï¼Œçœ‹çœ‹å®ƒçš„æ‰§è¡Œè®¡åˆ’ï¼š

![](https://static001.geekbang.org/resource/image/67/54/67785136ea6b3748d5ab7c148445ff54.png?wh=1016%2A63)

åˆæ˜¯ä¸€ä¸ªå…¸å‹çš„å…¨è¡¨æ‰«æï¼Œå¹¶ä¸”æ˜¯ç”±ä¸€ä¸ªupdateä½¿ç”¨çš„ã€‚çœ‹åˆ°è¿™é‡Œï¼Œä½ æ˜¯ä¸æ˜¯æœ‰ç§æƒ³æŠŠå¼€å‘æ‹‰å‡ºå»ç¥­æ——çš„å†²åŠ¨ï¼Ÿ

ç”±äºç”Ÿæˆè®¢å•ä¿¡æ¯æ˜¯ä¸€ä¸ªå¤æ‚çš„æ¥å£ï¼Œæˆ‘ä»¬ä¸æ€¥ç€æ”¶æ‹¾è¿™ä¸ªSQLï¼Œå…ˆæŠŠslow logå…¨éƒ½æ‹¿å‡ºæ¥åˆ†æä¸€éã€‚

è¯·ä½ æ³¨æ„ï¼Œæœ‰æ—¶å€™é¡¹ç›®æ‰§è¡Œçš„åœºæ™¯å¤šäº†ï¼Œæ•°æ®ç›¸äº’ä¹‹é—´çš„å½±å“å°±ä¼šå¾ˆå¤§ï¼Œå®¹æ˜“å¯¼è‡´æˆ‘ä»¬åˆ†æçš„æ–¹å‘ä¸å‡†ç¡®ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æœ€å¥½æŠŠslow logéƒ½æ¸…ä¸€éã€‚åæ­£æˆ‘é€šå¸¸éƒ½ä¼šè¿™ä¹ˆå¹²ï¼Œå› ä¸ºæˆ‘ä¸æƒ³çœ‹åˆ°ä¹±ä¸ƒå…«ç³Ÿçš„æ•°æ®ã€‚

åœ¨æ¸…ç†å®Œæ…¢SQLã€é‡æ–°æ‰§è¡Œåœºæ™¯ä¹‹åï¼Œæˆ‘åˆæŠŠslow logæ‹¿å‡ºæ¥ï¼Œç”¨pt-digest-queryåˆ†æäº†ä¸€éï¼ˆå…³äºè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åœ¨[ç¬¬16è®²](https://time.geekbang.org/column/article/367285)ä¸­è®²è¿‡ï¼Œå¦‚æœä½ ä¸è®°å¾—çš„è¯ï¼Œå»ºè®®ä½ å†å›é¡¾ä¸€ä¸‹ï¼‰ï¼Œçœ‹åˆ°å¦‚ä¸‹çš„æ•°æ®ï¼š

```
# Profile
# Rank Query ID                     Response time   Calls R/Call   V/M   I
# ==== ============================ =============== ===== ======== ===== =
#    1 0x2D9130DB1449730048AA1B5... 1233.4054 70.5%     3 411.1351  2.73 UPDATE oms_order
#    2 0x68BC6C5F4E7FFFC7D17693A...  166.3178  9.5%  2677   0.0621  0.60 INSERT oms_order
#    3 0xB86E9CC7B0BA539BD447915...   91.3860  5.2%  1579   0.0579  0.01 SELECT ums_member
#    4 0x3135E50F729D62260977E0D...   61.9424  3.5%     4  15.4856  0.30 SELECT oms_order
#    5 0xAE72367CD45AD907195B3A2...   59.6041  3.4%     3  19.8680  0.13 SELECT oms_order
#    6 0x695C8FFDF15096AAE9DBFE2...   49.1613  2.8%  1237   0.0397  0.01 SELECT ums_member_receive_address
#    7 0xD732B16862C1BC710680BB9...   25.5382  1.5%   471   0.0542  0.01 SELECT oms_cart_item
# MISC 0xMISC                         63.2937  3.6%  1795   0.0353   0.0 <9 ITEMS>
```

é€šè¿‡ä¸Šé¢çš„Profileä¿¡æ¯æˆ‘ä»¬çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ªè¯­å¥æ¶ˆè€—äº†æ€»æ—¶é—´çš„70.5%ï¼Œç¬¬äºŒä¸ªè¯­å¥æ¶ˆè€—äº†æ€»æ—¶é—´çš„9.5%ã€‚æˆ‘ä»¬è¯´è¦è§£å†³æ€§èƒ½é—®é¢˜ï¼Œå…¶å®è§£å†³çš„å°±æ˜¯è¿™ç§æ¶ˆè€—æ—¶é—´é•¿çš„è¯­å¥ã€‚è€Œåé¢çš„SQLæ‰§è¡Œæ—¶é—´çŸ­ï¼Œæˆ‘ä»¬å¯ä»¥æš‚æ—¶ä¸ç®¡ã€‚

é€šå¸¸åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥åªè§£å†³ç¬¬ä¸€ä¸ªè¯­å¥ï¼Œç„¶åå†å›å½’æµ‹è¯•çœ‹çœ‹æ•ˆæœï¼Œå†æ¥å†³å®šæ˜¯å¦è§£å†³ç¬¬äºŒä¸ªé—®é¢˜ã€‚æˆ‘å…ˆæŠŠè¿™ä¸¤ä¸ªå®Œæ•´çš„SQLè¯­å¥åˆ—åœ¨è¿™é‡Œï¼š

```
1. UPDATE oms_order SET member_id = 260869, order_sn = '202102030100205526', create_time = '2021-02-03 01:05:56.0', member_username = '7dcmppdtest15176472465', total_amount = 0.00, pay_amount = 0.00, freight_amount = 0.00, promotion_amount = 0.00, integration_amount = 0.00, coupon_amount = 0.00, discount_amount = 0.00, pay_type = 0, source_type = 1, STATUS = 4, order_type = 0, auto_confirm_day = 15, integration = 0, growth = 0, promotion_info = '', receiver_name = '6mtf3', receiver_phone = '18551479920', receiver_post_code = '66343', receiver_province = 'åŒ—äº¬', receiver_city = '7dGruopæ€§èƒ½å®æˆ˜', receiver_region = '7dGruopæ€§èƒ½å®æˆ˜åŒº', receiver_detail_address = '3d16zå‰åœ°12å·', confirm_status = 0, delete_status = 0 WHERE id = 0;


2. insert into oms_order (member_id, coupon_id, order_sn,   create_time, member_username, total_amount,   pay_amount, freight_amount, promotion_amount,   integration_amount, coupon_amount, discount_amount,   pay_type, source_type, status,   order_type, delivery_company, delivery_sn,   auto_confirm_day, integration, growth,   promotion_info, bill_type, bill_header,   bill_content, bill_receiver_phone, bill_receiver_email,   receiver_name, receiver_phone, receiver_post_code,   receiver_province, receiver_city, receiver_region,   receiver_detail_address, note, confirm_status,   delete_status, use_integration, payment_time,   delivery_time, receive_time, comment_time,   modify_time)values (391265, null, '202102030100181755',   '2021-02-03 01:01:03.741', '7dcmpdtest17793405657', 0,   0, 0, 0,   0, 0, 0,   0, 1, 0,   0, null, null,   15, 0, 0,   '', null, null,   null, null, null,   'belod', '15618648303', '93253',   'åŒ—äº¬', '7dGruopæ€§èƒ½å®æˆ˜', '7dGruopæ€§èƒ½å®æˆ˜åŒº',   'hc9r1å‰åœ°12å·', null, 0,   0, null, null,   null, null, null,   null);
```

æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªè¯­å¥ã€‚è¿™ä¸ªupdateè¯­å¥è™½ç„¶è¢«è°ƒç”¨çš„æ¬¡æ•°ä¸å¤šï¼Œä½†æ˜¯ç‰¹åˆ«æ…¢ã€‚è¿™æ˜¾ç„¶ä¸åº”è¯¥æ˜¯å®æ—¶æ¥å£åœ¨è°ƒç”¨ï¼Œé‚£æˆ‘ä»¬å°±è¦æŸ¥ä¸€ä¸‹åˆ°åº•æ˜¯ä»€ä¹ˆä¸šåŠ¡è°ƒç”¨äº†è¿™ä¸ªè¯­å¥ã€‚ä½ çœ‹ï¼Œåœ¨è¿™ä¸ªè¯­å¥ä¸­ï¼Œupdateæ›´æ–°çš„æ˜¯whereæ¡ä»¶ä¸­IDä¸º0çš„æ•°æ®ï¼Œè¿™çœ‹ä¸Šå»å°±æ˜¯ä¸€ä¸ªæ‰¹é‡ä¸šåŠ¡ã€‚

æˆ‘ä»¬å†æ¥çœ‹ç¬¬äºŒä¸ªè¯­å¥ã€‚ç¬¬äºŒä¸ªinsertè¯­å¥è°ƒç”¨æ¬¡æ•°å¤šï¼Œåº”è¯¥æ˜¯å®æ—¶äº¤æ˜“çš„SQLã€‚é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡æ‰¹é‡æ’å…¥æ•°æ®æ¥ä¼˜åŒ–insertï¼Œæ‰€ä»¥ï¼Œå°±éœ€è¦è°ƒæ•´bulk\_insert\_buffer\_sizeå‚æ•°ï¼ˆé»˜è®¤æ˜¯8Mï¼‰æ¥å®ç°è¿™ä¸€ç‚¹ã€‚å› ä¸ºbulk\_insert\_buffer\_sizeå°±æ˜¯åœ¨æ‰¹é‡æ’å…¥æ•°æ®æ—¶æé«˜æ•ˆç‡çš„ã€‚æˆ‘å»æŸ¥è¯¢äº†ä¸€ä¸‹è¿™ä¸ªå‚æ•°ï¼Œç¡®å®æ²¡æœ‰ä¼˜åŒ–è¿‡ï¼Œè¿˜æ˜¯é»˜è®¤å€¼ã€‚

è¿™é‡Œä½ è¦æ³¨æ„ä¸€ç‚¹ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå› ä¸ºOrderè¡¨ä¸­è¦åŠ ç´¢å¼•ï¼Œæ‰€ä»¥åœ¨æ¶æ„è®¾è®¡æ—¶ä¹Ÿæœ€å¥½æ˜¯ä¸»ä»åˆ†ç¦»ï¼Œè®©updateã€insertå’Œselectä¸ä¼šç›¸äº’å½±å“ã€‚

åˆ†æå®Œè¿™ä¸¤ä¸ªSQLè¯­å¥ï¼Œæˆ‘ä»¬å…ˆæ¥æŸ¥æ‰¾ç¬¬ä¸€ä¸ªSQLçš„æ¥æºã€‚é€šè¿‡æŸ¥æ‰¾ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº†è¯¥è¯­å¥ï¼š

```
orderMapper.updateByPrimaryKeySelective(cancelOrder);
```

ä½†æ˜¯ï¼Œè¯·æ³¨æ„ï¼Œè¿™ä¸ªupdateByPrimaryKeySelectiveæ–¹æ³•æ˜¯æ‰¹é‡ä»»åŠ¡ä¸­çš„ï¼Œè€Œæ‰¹é‡ä»»åŠ¡åº”è¯¥å’Œå®æ—¶äº¤æ˜“åˆ†å¼€æ‰æ˜¯ã€‚å¦‚æœä½ æ˜¯ä½œä¸ºæ€§èƒ½å›¢é˜Ÿçš„äººç»™æ¶æ„æˆ–å¼€å‘æä¼˜åŒ–å»ºè®®ï¼Œé‚£ä½ å¯ä»¥è¿™æ ·ç»™å»ºè®®ï¼š

1. è¯»å†™åˆ†ç¦»ï¼›
2. æ‰¹é‡ä¸šåŠ¡å’Œå®æ—¶ä¸šåŠ¡åˆ†ç¦»ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘å…ˆæŠŠè¿™ä¸ªæ‰¹é‡ä¸šåŠ¡ç»™åˆ†ç¦»å¼€ï¼Œå¹¶ä¸”ä¹Ÿä¸å»è°ƒç”¨å®ƒã€‚ä½†æ˜¯ï¼Œåœ¨çœŸå®çš„ä¸šåŠ¡é€»è¾‘ä¸­ï¼Œä½ å¯ä¸èƒ½è¿™ä¹ˆå¹²ã€‚æˆ‘ä¹‹æ‰€ä»¥è¿™ä¹ˆåšï¼Œæ˜¯ä¸ºäº†çœ‹åç»­æ€§èƒ½ä¼˜åŒ–çš„æ•ˆæœå’Œæ–¹å‘ã€‚

åšäº†ä¸Šè¿°ä¿®æ”¹ä¹‹åï¼ŒTPSå¦‚ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/20/3d/20e420c49edcd201cc68c0698e7ddf3d.png?wh=1836%2A836)

ä»æ•ˆæœä¸Šæ¥çœ‹ï¼ŒTPSèƒ½è¾¾åˆ°300å·¦å³äº†ï¼Œå“åº”æ—¶é—´çœ‹èµ·æ¥ä¹Ÿç¨³å®šäº†ã€‚æˆ‘ä»¬ç»ˆäºå¯ä»¥è¿›å…¥æ­£å¸¸çš„æ€§èƒ½åˆ†æé˜¶æ®µäº†ï¼Œå“ˆå“ˆã€‚

ä¸è¿‡ï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„å·¥ä½œå¹¶æ²¡æœ‰ç»“æŸï¼Œä»ä¸Šå›¾æ¥çœ‹ï¼ŒTPSåœ¨300å·¦å³ï¼Œæ ¹æ®æˆ‘ä»¬çš„æ•´ä½“ç³»ç»Ÿèµ„æºæ¥è€ƒè™‘ï¼Œè¿™ä¸ªTPSè¿˜æ˜¯åä½çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ¥å£æ˜¾ç„¶è¿˜æœ‰ä¼˜åŒ–çš„ç©ºé—´ã€‚æ‰€ä»¥ï¼Œåœ¨ä¸‹èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬æ¥ç€æ¥å” ã€‚

## æ€»ç»“

åœ¨è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬åšäº†ä¸‰ä¸ªé˜¶æ®µçš„åˆ†æä¼˜åŒ–ã€‚

åœ¨ç¬¬ä¸€é˜¶æ®µä¸­ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†JDBCæ± ï¼Œè™½ç„¶TPSæœ‰ä¸Šå‡çš„è¶‹åŠ¿ï¼Œä½†æ˜¯ï¼Œæ–°é—®é¢˜ä¹ŸåŒæ ·å‡ºç°äº†ï¼šTPSéå¸¸ä¸ç¨³å®šï¼Œè¿˜æœ‰æ–­æ–­ç»­ç»­çš„æƒ…å†µã€‚

åœ¨ç¬¬äºŒé˜¶æ®µä¸­ï¼Œæˆ‘ä»¬åˆ†æäº†å†…å­˜æº¢å‡ºçš„é—®é¢˜ï¼Œå®šä½å‡ºäº†åŸå› å¹¶ä¼˜åŒ–äº†å†…å­˜é—®é¢˜ã€‚è™½ç„¶æˆ‘ä»¬åœ¨TPSæ›²çº¿ä¸Šæ˜æ˜¾çœ‹åˆ°äº†ä¼˜åŒ–çš„æ•ˆæœï¼Œä½†ä»ç„¶æ²¡æœ‰è¾¾åˆ°ç†æƒ³çš„ç¨‹åº¦ã€‚

åœ¨ç¬¬ä¸‰é˜¶æ®µä¸­ï¼Œæˆ‘ä»¬åˆ†æå®šä½äº†SQLçš„é—®é¢˜ï¼Œè¿™æ˜¯éå¸¸åˆä¹é€»è¾‘çš„ã€‚å› ä¸ºæˆ‘ä»¬åœ¨ç¬¬äºŒé˜¶æ®µä¸­ä¿®æ”¹äº†SQLï¼Œæ‰€ä»¥åˆ°äº†ç¬¬ä¸‰é˜¶æ®µï¼Œå°±è¦ç›´æ¥åˆ°æ•°æ®åº“ä¸­åšç›¸åº”çš„å®šä½ã€‚ä»ç»“æœä¸Šçœ‹ï¼Œæ•ˆæœä¸é”™ï¼ŒTPSå·²ç»æœ‰æ˜æ˜¾æ­£å¸¸çš„è¶‹åŠ¿äº†ã€‚ä¸è¿‡ï¼Œä½ è¦æ³¨æ„çš„æ˜¯ï¼Œå½“æ‰¹é‡ä¸šåŠ¡å’Œå®æ—¶ä¸šåŠ¡åŒæ—¶å‡ºç°åœ¨åŒä¸€ä¸ªæ•°æ®åº“ä¸­ï¼Œå¹¶ä¸”æ˜¯å¯¹åŒæ ·çš„è¡¨è¿›è¡Œæ“ä½œï¼Œè¿™æ—¶ï¼Œä½ å°±å¾—è€ƒè™‘ä¸€ä¸‹æ¶æ„è®¾è®¡æ˜¯å¦åˆç†äº†ã€‚

æ€»ä¹‹ï¼Œåœ¨è¿™èŠ‚è¯¾ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œå½“SQLæŸ¥è¯¢å‡ºæ¥çš„æ•°æ®åˆ°äº†åº”ç”¨å†…å­˜çš„æ—¶å€™ï¼Œå¯¼è‡´äº†å†…å­˜çš„å¢åŠ ã€‚è€Œåº”ç”¨å†…å­˜çš„å¢åŠ ä¹Ÿå¢åŠ äº†GCçš„æ¬¡æ•°ï¼Œè¿›è€Œæ¶ˆè€—äº†æ›´å¤šçš„CPUèµ„æºã€‚

## è¯¾åä½œä¸š

æœ€åï¼Œè¯·ä½ æ€è€ƒä¸¤ä¸ªé—®é¢˜ï¼š

1. ä¸ºä»€ä¹ˆJDKä¸­çœ‹åˆ°VM Threadçº¿ç¨‹æ¶ˆè€—CPUé«˜ï¼Œä¼šå»æŸ¥çœ‹å†…å­˜æ¶ˆè€—æ˜¯å¦åˆç†ï¼Ÿ
2. åœ¨MySQLä¸­åˆ†æSQLé—®é¢˜æ—¶ä¸ºä»€ä¹ˆè¦å…ˆæŸ¥è¯¢innodb\_trxè¡¨ï¼Ÿ

è®°å¾—åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºã€äº¤æµä½ çš„æƒ³æ³•ï¼Œæ¯ä¸€æ¬¡æ€è€ƒéƒ½ä¼šè®©ä½ æ›´è¿›ä¸€æ­¥ã€‚

å¦‚æœä½ è¯»å®Œè¿™ç¯‡æ–‡ç« æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå…±åŒå­¦ä¹ è¿›æ­¥ã€‚æˆ‘ä»¬ä¸‹ä¸€è®²å†è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ7ï¼‰</strong></div><ul>
<li><span>å¼ ä¸œç‚«</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>1.VM Thread çº¿ç¨‹æ¶ˆè€— CPU é«˜çš„å¼‚å¸¸ï¼ŒæŸ¥çœ‹JAVA gc æ˜¯å¦åˆç†
2.innodb_trxè¡¨æä¾›äº†å½“å‰innodbå¼•æ“å†…æ¯ä¸ªäº‹åŠ¡çš„ä¿¡æ¯ï¼ˆåªè¯»äº‹åŠ¡é™¤å¤–ï¼‰ï¼ŒåŒ…æ‹¬å½“ä¸€ä¸ªäº‹åŠ¡å¯åŠ¨ï¼Œäº‹åŠ¡æ˜¯å¦åœ¨ç­‰å¾…ä¸€ä¸ªé”ï¼Œä»¥åŠäº¤æ˜“æ­£åœ¨æ‰§è¡Œçš„è¯­å¥</p>2021-05-06</li><br/><li><span>jy</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆä½ å¥½ï¼ŒæŸ¥äº†ä¸‹èµ„æ–™ï¼Œbulk_insert_buffer_sizeæ˜¯ç”¨äºmyisamå­˜å‚¨å¼•æ“ï¼Œæˆ‘çœ‹ä½ çš„å»ºè¡¨sqlï¼Œæ˜¯innodbï¼Œè¯·ç¡®è®¤ä¸‹å‘¢ï¼Ÿ</p>2021-07-28</li><br/><li><span>é˜¿å¬·</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œæ¶æ„å›¾æ˜¯ç”¨ä»€ä¹ˆç”»çš„ï¼Ÿ</p>2022-02-14</li><br/><li><span>steve</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>aixæœåŠ¡å™¨çš„javaè·¯å¾„ä¸‹æ²¡æ‰¾åˆ°jstack</p>2021-09-06</li><br/><li><span>jy</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>1ã€ç¬¬äºŒé˜¶æ®µé‡Œé¢
åœ¨æŸ¥çœ‹ Order æœåŠ¡çš„ top æ—¶ï¼Œå ç”¨cpuæœ€å¤šçš„æ˜¯pid 29349 ï¼Œä¸ºä»€ä¹ˆåé¢æ˜¯jstack -l 1ï¼Œè€Œä¸æ˜¯jstack -l  29349ï¼Ÿ


2ã€â€œå½“æ‰¹é‡ä¸šåŠ¡å’Œå®æ—¶ä¸šåŠ¡åŒæ—¶å‡ºç°åœ¨åŒä¸€ä¸ªæ•°æ®åº“ä¸­ï¼Œå¹¶ä¸”æ˜¯å¯¹åŒæ ·çš„è¡¨è¿›è¡Œæ“ä½œï¼Œè¿™æ—¶ï¼Œä½ å°±å¾—è€ƒè™‘ä¸€ä¸‹æ¶æ„è®¾è®¡æ˜¯å¦åˆç†äº†ã€‚â€
è¯·é—®ä¸‹åº”è¯¥å¦‚ä½•è®¾è®¡æ¶æ„å‘¢ï¼Ÿ

è°¢è°¢</p>2021-07-16</li><br/><li><span>zwm</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p> ä»ä¸Šå›¾æ¥çœ‹ï¼Œç³»ç»Ÿèµ„æºå¹¶æ²¡æœ‰å®Œå…¨ç”¨èµ·æ¥ï¼Œè¿™ä¸ªæ¥å£æ˜¾ç„¶è¿˜æœ‰ä¼˜åŒ–çš„ç©ºé—´

è€å¸ˆè¿™ä¸ªæ˜¯æ€ä¹ˆçœ‹å‡ºæ¥çš„ï¼Œå°±é€šè¿‡TPSå’Œå“åº”æ—¶é—´ï¼Ÿ</p>2021-07-13</li><br/><li><span>Hant</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é«˜è€å¸ˆï¼Œæ€ä¹ˆåˆ¤æ–­GCæ­£ä¸æ­£å¸¸å‘€ï¼Ÿ</p>2021-06-27</li><br/>
</ul>