ä½ å¥½ï¼Œæˆ‘æ˜¯é«˜æ¥¼ã€‚

æˆ‘ä»¬ä»Šå¤©æ¥çœ‹ä¸€ä¸‹è´­ç‰©è½¦ä¿¡æ¯ç¡®å®šè®¢å•è¿™ä¸ªæ¥å£çš„æ€§èƒ½æ€ä¹ˆæ ·ï¼Œæœ‰å“ªäº›éœ€è¦ä¼˜åŒ–çš„åœ°æ–¹ã€‚

åœ¨è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘å°†ç»™ä½ å±•ç¤ºå¦‚ä½•è¿›è¡Œæ–¹æ³•çº§çš„è·Ÿè¸ªï¼Œæ¥åˆ¤æ–­å‚æ•°çš„é—®é¢˜ã€‚è€Œè¿™ä¸ªå‚æ•°ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬è¿™ä¸ªæ¥å£ç›´æ¥ç”¨åˆ°çš„ï¼Œå®ƒæœ‰ä¸åŒçš„ä½¿ç”¨å±‚æ¬¡ã€‚

ç›´æ¥çš„å‚æ•°åŒ–æˆ‘ä»¬éƒ½èƒ½ç†è§£ï¼Œå¯¹å§ã€‚ä½†æ˜¯å½“ä¸€ä¸ªå‚æ•°äº§ç”Ÿæ–°çš„æ•°æ®ï¼Œè€Œæ–°çš„æ•°æ®åˆä¼šåœ¨åç»­çš„åŠ¨ä½œä¸­ç”¨åˆ°æ—¶ï¼Œä½ å°±å¾—æ³¨æ„äº†ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰å¯èƒ½åœ¨ç¬¬ä¸€å±‚æ•°æ®ä¸­æ²¡æœ‰å‘ç°é—®é¢˜ï¼Œä½†æ˜¯åœ¨åç»­çš„åŠ¨ä½œä¸­ä¼šé‡åˆ°é—®é¢˜ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸€å®šè¦å…³æ³¨å‚æ•°åŒ–çš„å˜åŒ–ï¼Œä¹Ÿå°±æ˜¯åŠ¨æ€çš„å‚æ•°åŒ–çš„æ•°æ®ã€‚

æ­¤å¤–ï¼Œåœ¨è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘è¿˜å°†å¸¦ä½ ä¸€èµ·æ¥çœ‹çœ‹åœ¨åº”ç”¨æœ‰å¤šä¸ªèŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼ŒæŸä¸ªèŠ‚ç‚¹æ¶ˆè€—èµ„æºè¿‡å¤šå¯¼è‡´çš„å¤æ‚é—®é¢˜è¯¥æ€ä¹ˆå¤„ç†ã€‚

è¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬å¼€å§‹ä»Šå¤©çš„åˆ†æå§ï¼

## åœºæ™¯è¿è¡Œæ•°æ®

å¯¹äºè´­ç‰©è½¦ä¿¡æ¯ç¡®å®šè®¢å•è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡è¿è¡Œçš„æ€§èƒ½åœºæ™¯ç»“æœå¦‚ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/5f/70/5fbbac9cbfa5f14d55b60a5ec2e15970.png?wh=1814%2A655)

åœ¨å›¾ä¸­ï¼Œå“åº”æ—¶é—´éšç€å‹åŠ›çš„å¢åŠ è€Œå¢åŠ ï¼Œè€ŒTPSåªåˆ°äº†160å¤šï¼Œè¿˜æ˜¯æœ‰ç‚¹ä½äº†ï¼Œæˆ‘ä»¬ç°åœ¨å°±å¾—è€ƒè™‘æŠŠTPSæå‡ã€‚

æ³¨æ„ï¼Œ**è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„TPSä¸é«˜ï¼Œå“åº”æ—¶é—´ä¸æ–­å¢åŠ çš„æ€§èƒ½é—®é¢˜ã€‚**

æŒ‰ç…§RESARæ€§èƒ½åˆ†æé€»è¾‘ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„æ¶æ„å›¾ã€‚

## çœ‹æ¶æ„å›¾

![](https://static001.geekbang.org/resource/image/7a/6e/7ae3703b51010e62aeb9b0928b0d096e.png?wh=1173%2A773)

å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ¥å£æ¶‰åŠåˆ°çš„æœåŠ¡æ¯”è¾ƒå¤šï¼Œæ¶æ„å›¾ä¹Ÿæ¯”ä¹‹å‰å…¶ä»–æ¥å£çš„è¦å¤æ‚ä¸€äº›ã€‚

ç´§æ¥ç€ï¼Œæˆ‘ä»¬å°±æ¥æ‹†åˆ†å“åº”æ—¶é—´ã€‚

## æ‹†åˆ†å“åº”æ—¶é—´

- Gatewayï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/70/90/7043a3e4fbf19c3c4292d15f1d30d390.png?wh=339%2A215)

- Orderï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/29/95/293933826488236680ae2cc01a634995.png?wh=328%2A227)

- Memberï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/4c/0b/4caf56a16fba5334f5ca89d264cc750b.png?wh=325%2A216)

- Cartï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/0d/0a/0dd52c35102e5c2ffa6yy8820d6ffa0a.png?wh=316%2A221)

- Portalï¼š

![](https://static001.geekbang.org/resource/image/5c/yy/5cddd9c4a31a7d832057e31b2d0075yy.png?wh=263%2A175)

ä»ä¸Šé¢çš„æ—¶é—´æ‹†åˆ†æ¥çœ‹ï¼ŒCartæ¶ˆè€—äº†æœ€é•¿çš„æ—¶é—´ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å…ˆåˆ†æCartã€‚

æˆ‘ä»¬å†é¡ºæ‰‹ç‚¹ä¸€ä¸‹Cartå’ŒMySQLä¹‹é—´çš„æ—¶é—´æ¶ˆè€—ï¼Œçœ‹çœ‹æ˜¯ä»€ä¹ˆæƒ…å†µï¼š

![](https://static001.geekbang.org/resource/image/43/b0/433ea4910e4d00yy144b47c0d0c3eab0.png?wh=327%2A221)

è¿™ä¸ªCartå’ŒMySQLä¹‹é—´çš„æ—¶é—´çœ‹èµ·æ¥ä¸é•¿ï¼Œé‚£æˆ‘ä»¬å°±ä¸ç”¨è€ƒè™‘æ•°æ®åº“çš„SQLæ—¶é—´æ¶ˆè€—äº†ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥åˆ†æå“åº”æ—¶é—´é•¿çš„CartæœåŠ¡ã€‚

## ç¬¬ä¸€é˜¶æ®µ

### å…¨å±€åˆ†æ

æŒ‰ç…§æƒ¯ä¾‹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹workerå±‚é¢çš„èµ„æºæ¶ˆè€—æƒ…å†µï¼š

![](https://static001.geekbang.org/resource/image/1d/aa/1d64ede0a356a10767ce714e0b16a0aa.png?wh=1811%2A471)

ä»ä¸Šå›¾æ¥çœ‹ï¼Œworker-3ä¸Šæ¶ˆè€—çš„èµ„æºè¾ƒå¤šã€‚é‚£æˆ‘ä»¬å°±æ¥æŸ¥çœ‹ä¸€ä¸‹worker-3ä¸Šæœ‰ä»€ä¹ˆæœåŠ¡ã€‚

```
[root@k8s-master-2 ~]# kubectl get pods -o wide | grep k8s-worker-3
cloud-nacos-registry-685b8957d7-vskb6       1/1     Running     0          2d11h   10.100.69.199    k8s-worker-3   <none>           <none>
cloud-redis-7f7db7f45c-t5g46                2/2     Running     0          2d8h    10.100.69.196    k8s-worker-3   <none>           <none>
elasticsearch-master-2                      1/1     Running     0          3h28m   10.100.69.209    k8s-worker-3   <none>           <none>
svc-mall-cart-558d787dc7-g6qgh              1/1     Running     0          2d11h   10.100.69.201    k8s-worker-3   <none>           <none>
svc-mall-order-fbfd8b57c-kbczh              1/1     Running     0          2d11h   10.100.69.202    k8s-worker-3   <none>           <none>
svc-mall-portal-846d9994f8-m7jbq            1/1     Running     0          38h     10.100.69.207    k8s-worker-3   <none>           <none>
svc-mall-search-c9c8bc847-h7sgv             1/1     Running     0          161m    10.100.69.210    k8s-worker-3   <none>           <none>
[root@k8s-master-2 ~]# 
```

å¯ä»¥çœ‹åˆ°ï¼Œworker-3ä¸Šæœ‰8ä¸ªæœåŠ¡ï¼Œå“ªä¸ªæœåŠ¡æ¶ˆè€—çš„èµ„æºæœ€å¤šå‘¢ï¼Ÿç°åœ¨æˆ‘ä»¬è¿›å…¥worker-3ï¼ŒæŸ¥çœ‹ä¸‹topï¼š

```
[root@k8s-worker-3 ~]# top
top - 01:51:35 up 2 days, 12:18,  2 users,  load average: 19.48, 18.40, 17.07
Tasks: 319 total,   1 running, 318 sleeping,   0 stopped,   0 zombie
%Cpu0  : 68.6 us,  6.4 sy,  0.0 ni, 19.9 id,  0.0 wa,  0.0 hi,  5.1 si,  0.0 st
%Cpu1  : 66.7 us,  5.8 sy,  0.0 ni, 22.8 id,  0.0 wa,  0.0 hi,  4.8 si,  0.0 st
%Cpu2  : 66.4 us,  6.1 sy,  0.0 ni, 22.7 id,  0.0 wa,  0.0 hi,  4.7 si,  0.0 st
%Cpu3  : 65.7 us,  5.4 sy,  0.0 ni, 23.6 id,  0.0 wa,  0.0 hi,  5.4 si,  0.0 st
%Cpu4  : 66.6 us,  5.7 sy,  0.0 ni, 22.0 id,  0.0 wa,  0.0 hi,  5.7 si,  0.0 st
%Cpu5  : 67.6 us,  5.8 sy,  0.0 ni, 22.5 id,  0.0 wa,  0.0 hi,  4.1 si,  0.0 st
KiB Mem : 16265992 total,  2525940 free,  7015104 used,  6724948 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  8848464 avail Mem 


  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                      
32216 root      20   0 8878548 658820  16980 S 280.5  4.1 375:31.82 java -Dapp.id=svc-mall-cart -javaagent:/opt/skywalking/agent/skywalking-agen+
32589 root      20   0 8839408 589196  15892 S  84.1  3.6 171:16.88 java -Dapp.id=svc-mall-order -javaagent:/opt/skywalking/agent/skywalking-age+
24119 root      20   0 8798548 549804  15892 S  65.9  3.4 115:52.74 java -Dapp.id=svc-mall-portal -javaagent:/opt/skywalking/agent/skywalking-ag+
 1089 root      20   0 2438956 105708  37776 S   6.3  0.6 248:21.71 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.co+
 5470 root      20   0 1154816  14992   1816 S   3.6  0.1  20:15.93 redis-server 0.0.0.0:6379             
```

ä»ä»¥ä¸Šæ•°æ®æ¥çœ‹ï¼Œçš„ç¡®æ˜¯CartæœåŠ¡æ¶ˆè€—çš„CPUæ¯”è¾ƒé«˜ã€‚ä¸è¿‡ï¼Œå®ƒ**è¿˜æ²¡æœ‰æŠŠ6ä¸ªCPUéƒ½ç”¨å®Œ**ï¼Œè¿™ä¸€ç‚¹æˆ‘ä»¬è¦è®°ä¸€ä¸‹ã€‚

ä¸‹é¢å¼€å§‹å®šå‘åˆ†æã€‚

### å®šå‘åˆ†æ

æ—¢ç„¶CartæœåŠ¡æ¶ˆè€—çš„CPUå¤šï¼Œé‚£æˆ‘ä»¬å½“ç„¶è¦çœ‹ä¸€ä¸‹Cartä¸­çš„çº¿ç¨‹éƒ½åœ¨å¹²å•¥ã€‚

![](https://static001.geekbang.org/resource/image/65/ab/654fae31cc93e59a4ef32b8146bf34ab.png?wh=1659%2A727)

è¿™äº›çº¿ç¨‹çŠ¶æ€åŸºæœ¬éƒ½åœ¨ç»¿è‰²çš„RunnableçŠ¶æ€ï¼Œçœ‹èµ·æ¥éƒ½æ¯”è¾ƒç¹å¿™ï¼Œæœ‰å¯èƒ½æ˜¯å› ä¸ºçº¿ç¨‹æ•°é…ç½®çš„å¤ªä½äº†ï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸‹é…ç½®ï¼š

```
server:
  port: 8086
  tomcat:
    accept-count: 1000
    threads:
      max: 20
      min-spare: 5
    max-connections: 500
```

çŸ¥é“äº†Spring Bootå†…ç½®çš„Tomcatçº¿ç¨‹æ•°é…ç½®ï¼Œæˆ‘ä»¬æ‹†åˆ†ä¸€ä¸‹åœ¨Cartä¸Šæ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•ï¼Œçœ‹çœ‹æˆ‘ä»¬çš„å®šä½æ–¹æ³•æ˜¯ä¸æ˜¯åˆç†ï¼š

![](https://static001.geekbang.org/resource/image/74/5d/7470ab205c982e07bd36a38d1bca405d.png?wh=1388%2A1488)

çœ‹è¿™å¼ å›¾çš„æ—¶å€™ï¼Œä½ è¦æ³¨æ„æ¶ˆè€—æ—¶é—´é•¿çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­å³ä¾§çº¿æ®µæ¯”è¾ƒé•¿çš„åœ°æ–¹ã€‚è¿™é‡Œé¢æœ‰ä¸¤ä¸ªç¯èŠ‚çš„é—®é¢˜ï¼š

1. MySQLçš„æ‰§è¡Œæ—¶é—´é•¿ã€‚ä½ è¦æ³¨æ„å“¦ï¼Œè™½ç„¶è¿™é‡Œçš„MySQL/JDBI/PreparedStatement/executeå¹¶æ²¡æœ‰æ¶ˆè€—å¾ˆé•¿çš„æ—¶é—´ï¼Œä½†æ˜¯å®ƒçš„ä¸‹ä¸€æ­¥Balance/Promotion/Cart/CartPromotionæ¶ˆè€—çš„æ—¶é—´æ˜¯é•¿çš„ï¼›
2. Promotionnewæ–¹æ³•æœ¬èº«çš„æ—¶é—´é•¿ã€‚

ç”±äºæ…¢çš„èŠ‚ç‚¹å’ŒMySQLæœ‰å…³ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªï¼Œmysqlreportæ¥çœ‹MySQLæ•´ä½“çš„ç›‘æ§æ•°æ®ï¼š

```
__ Connections _________________________________________________________
Max used          152 of  151      %Max: 100.66
Total             540     0.0/s
```

åŸæ¥æ˜¯è¿æ¥ç”¨å®Œäº†ï¼æˆ‘ä»¬èµ¶ç´§æ”¹ä¸€ä¸‹ï¼Œä»151æ”¹åˆ°500ã€‚

ä¸è¿‡ï¼Œé‡æµ‹ä¹‹åå“åº”æ—¶é—´è¿˜æ˜¯æ²¡æœ‰å˜åŒ–ï¼Œé‚£æˆ‘ä»¬å°±åªèƒ½æ¥ç€è·Ÿè¸ªCartä¸Šçš„æ–¹æ³•äº†ã€‚

#### æ–¹æ³•çº§è·Ÿè¸ª

äºæ˜¯ï¼Œæˆ‘ä»¬ä¸å¾—ä¸æ¥åˆ°æ–¹æ³•çº§è·Ÿè¸ªï¼Œ çœ‹ä¸€ä¸‹æˆ‘ä»¬å…³æ³¨çš„æ–¹æ³•Promotionnewæ…¢åœ¨å“ªé‡Œã€‚

ç”±ä¸Šé¢é‚£å¼ è°ƒç”¨è§†å›¾ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸‹é¢è¿™æ ·çš„è·Ÿè¸ªè¯­å¥ï¼š

trace -E com.dunshan.mall.cart.controller.CartItemController listPromotionnew -n 5 -v --skipJDKMethod false '1==1'

ç„¶åå¾—åˆ°äº†ä¸‹é¢è¿™ä¸ªç»“æœï¼š

```
`---ts=2021-01-16 15:08:58;thread_name=http-nio-8086-exec-34;id=f8;is_daemon=true;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@56887c8f
    `---[97.827186ms] com.dunshan.mall.cart.service.imp.CartItemServiceImpl$$EnhancerBySpringCGLIB$$ac8f5a97:listPromotion()
        `---[97.750962ms] org.springframework.cglib.proxy.MethodInterceptor:intercept() #57
            `---[97.557484ms] com.dunshan.mall.cart.service.imp.CartItemServiceImpl:listPromotion()
                +---[72.273747ms] com.dunshan.mall.cart.service.imp.CartItemServiceImpl:list() #166
                +---[0.003516ms] cn.hutool.core.collection.CollUtil:isNotEmpty() #172
                +---[0.004207ms] java.util.List:stream() #173
                +---[0.003893ms] java.util.stream.Stream:filter() #57
                +---[0.003018ms] java.util.stream.Collectors:toList() #57
                +---[0.060052ms] java.util.stream.Stream:collect() #57
                +---[0.002017ms] java.util.ArrayList:<init>() #177
                +---[0.003013ms] org.springframework.util.CollectionUtils:isEmpty() #179
                `---[25.152532ms] com.dunshan.mall.cart.feign.CartPromotionService:calcCartPromotion() #181
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æˆ‘ä»¬è·Ÿè¸ªçš„æ–¹æ³•com.dunshan.mall.cart.service.imp.CartItemServiceImpl:listPromotion()ä¸­ï¼Œæœ‰ä¸¤å¤„listPromotionå’ŒcalcCartPromotionæ—¶é—´æ¶ˆè€—è¾ƒå¤§ï¼Œåˆ†åˆ«æ˜¯ï¼š

1. com.dunshan.mall.cart.service.imp.CartItemServiceImpl:list()
2. com.dunshan.mall.cart.feign.CartPromotionService:calcCartPromotion()

#### è·Ÿè¸ªListå‡½æ•°

æˆ‘ä»¬åœ¨Arthasä¸­æ‰§è¡Œtraceè·Ÿè¸ªè¯­å¥å¦‚ä¸‹ï¼š

```
trace com.dunshan.mall.cart.service.imp.CartItemServiceImpl list -v -n 5 --skipJDKMethod false '1==1'
```

ç„¶åå¾—åˆ°è¿™æ ·çš„ç»“æœï¼š

```
`---ts=2021-01-16 15:19:45;thread_name=http-nio-8086-exec-65;id=23ce;is_daemon=true;priority=5;TCCL=org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader@56887c8f
    `---[70.158793ms] com.dunshan.mall.cart.service.imp.CartItemServiceImpl:list()
        +---[0.003501ms] com.dunshan.mall.model.OmsCartItemExample:<init>() #150
        +---[0.002642ms] com.dunshan.mall.model.OmsCartItemExample:createCriteria() #151
        +---[0.002932ms] com.dunshan.mall.model.OmsCartItemExample$Criteria:andDeleteStatusEqualTo() #57
        +---[0.00304ms] com.dunshan.mall.model.OmsCartItemExample$Criteria:andMemberIdEqualTo() #57
        `---[70.078976ms] com.dunshan.mall.mapper.OmsCartItemMapper:selectByExample() #152
```

åœ¨ä¸€é˜µæ— èŠçš„traceä¹‹åï¼Œçœ‹åˆ°ä¸€ä¸ªselectè¯­å¥æ¶ˆè€—æ—¶é—´è¾ƒé•¿ï¼Œè¿™ä¸ªselectè¯­å¥æ˜¯ï¼š

```
select id, product_id, product_sku_id, member_id, quantity, price, product_pic, product_name,     product_sub_title, product_sku_code, member_nickname, create_date, modify_date, delete_status,     product_category_id, product_brand, product_sn, product_attr       from oms_cart_item                 WHERE (  delete_status = ?                                                            and member_id = ? )
```

ä¸€ä¸ªç®€å•çš„selectè¯­å¥ï¼Œæ€ä¹ˆä¼šè€—æ—¶è¿™ä¹ˆä¹…å‘¢ï¼Ÿæˆ‘ä»¬å…ˆä¸ç®¡ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Œå…ˆæ¥çœ‹çœ‹è¿™ä¸ªoms\_cart\_itemçš„æ•°æ®æœ‰å¤šå°‘ã€‚æˆ‘è¿ä¸Šæ•°æ®åº“åä¸€æŸ¥ï¼Œå‘ç°åœ¨oms\_cart\_itemé‡Œé¢æœ‰10612æ¡æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®é‡å¹¶ä¸å¤§ã€‚

æ­¤å¤–ï¼Œæˆ‘è¿˜æŸ¥çœ‹äº†ä¸€ä¸‹ç´¢å¼•ï¼Œä¹Ÿæ˜¯æœ‰çš„ï¼Œå¹¶ä¸”æ‰§è¡Œè®¡åˆ’ä¹Ÿèµ°åˆ°äº†ç´¢å¼•è¿™é‡Œã€‚é‚£ä¸ºä»€ä¹ˆä¼šæ…¢å‘¢ï¼Ÿåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¾—è€ƒè™‘ä¸€ä¸‹æ˜¯ä¸æ˜¯å’Œæ•°æ®é‡æœ‰å…³äº†ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªselectè¯­å¥ç©¶ç«ŸæŸ¥å‡ºäº†å¤šå°‘æ¡æ•°æ®ã€‚

åœ¨æˆ‘è¡¥å…¨SQLåä¸€æŸ¥ï¼Œå‘ç°ä¸€ä¸ªmember\_idå¯¹åº”500å¤šæ¡è®°å½•ï¼Œè¿™æ˜¯ä¸€ä¸ªäººä¸€æ¬¡ä¹°äº†500ä¸ªä¸œè¥¿ï¼Ÿ

æ—¢ç„¶åœ¨è´­ç‰©è½¦ä¿¡æ¯é‡Œï¼ŒåŒä¸€ä¸ªäººæœ‰è¿™ä¹ˆå¤šè®°å½•ï¼Œé‚£ä¸€å®šæ˜¯åœ¨å•†å“åŠ å…¥è´­ç‰©è½¦æ—¶åŠ è¿›å»çš„ã€‚è€Œè¦å¾€ä¸€ä¸ªäººçš„è´­ç‰©è½¦é‡ŒåŠ ä¸œè¥¿ï¼Œæ˜¾ç„¶æ˜¯åœ¨æ€§èƒ½è„šæœ¬æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ·»åŠ ï¼Œå› ä¸ºæ¯ä¸ªç”¨æˆ·çš„è´­ç‰©è½¦ä¸€å¼€å§‹éƒ½æ˜¯ç©ºçš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦å»æŸ¥ä¸€ä¸‹å•†å“åŠ å…¥è´­ç‰©è½¦çš„è„šæœ¬æ˜¯æ€ä¹ˆå›äº‹ã€‚

å•†å“åŠ å…¥è´­ç‰©è½¦çš„è„šæœ¬å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªpostï¼ŒåŠ ä¸Šå•†å“IDï¼Œåœ¨HTTPåè®®çš„è¯·æ±‚å¤´é‡Œé¢æœ‰ä¸€ä¸ªTokenæ¥æ ‡è¯†æ˜¯å“ªä¸ªç”¨æˆ·ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è¦æŸ¥çš„å°±æ˜¯tokenæœ‰æ²¡æœ‰ç”¨é‡ï¼ŒJMeterä¸­çš„Tokenå‚æ•°åŒ–é…ç½®å¦‚ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/e9/4d/e9697bc38ed69b485656591c013b7e4d.png?wh=710%2A395)

çœ‹èµ·æ¥æŒºå¥½ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè®¾è®¡äº†ä¸é‡ç”¨æ•°æ®ï¼Œæ‰€ä»¥åœ¨è®¾ç½®ä¸ŠTokenä¸ä¼šè¢«é‡ç”¨ã€‚é‚£ä¹ˆï¼Œåªæœ‰ä¸€ç§å¯èƒ½ï¼Œå°±æ˜¯Tokené‡äº†ã€‚

![](https://static001.geekbang.org/resource/image/14/d9/14d832cb3a32b51cb3a979c4043a66d9.png?wh=1901%2A114)![](https://static001.geekbang.org/resource/image/d2/0a/d213650cffee80d88b495cfc0bfe010a.png?wh=1886%2A931)

åœ¨éšæœºæ£€æŸ¥äº†å‡ æ¡Tokenä¹‹åï¼Œæˆ‘å‘ç°æœ‰å¤§é‡çš„Tokené‡å¤ã€‚è¿™ä¹Ÿå°±è§£é‡Šäº†ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¼šåœ¨ä¸€ä¸ªäººçš„è´­ç‰©è½¦é‡Œçœ‹åˆ°é‚£ä¹ˆå¤šå•†å“æ•°æ®ã€‚

å¯æ˜¯ï¼Œè¿™ä¸ªé€»è¾‘å°±æœ‰é—®é¢˜äº†ã€‚ä½ æƒ³æƒ³ï¼Œæˆ‘ä»¬è®¾ç½®äº†å‚æ•°åŒ–ä¸­æ•°æ®ä¸é‡å¤ä½¿ç”¨ï¼Œä½†å®é™…ä¸Šç¡®å®æœ‰å¤§é‡çš„Tokenè¢«é‡ç”¨ï¼Œè¿™å°±è¯´æ˜Tokençš„å‚æ•°åŒ–æ–‡ä»¶æœ¬èº«å°±é‡å¤äº†ã€‚

é‚£æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬åªæœ‰æŠŠæ‰€æœ‰çš„Tokenå…¨éƒ¨æ¸…æ‰ï¼Œè®©Tokenæ•°æ®åœ¨å•†å“åŠ å…¥è´­ç‰©è½¦çš„æ—¶å€™ä¸ä¼šè¢«é‡ç”¨ï¼Œä»¥æ­¤æ¥é¿å…åœ¨ä¸€ä¸ªäººçš„è´­ç‰©è½¦ä¸­åŠ å…¥å¤ªå¤šå•†å“çš„æƒ…å†µã€‚

æ¥ç€æ€ä¹ˆåŠï¼Ÿåªæœ‰ä¸€æ‹›äº†ï¼Œå°±æ˜¯æŠŠæ‰€æœ‰çš„æ•°æ®éƒ½æ¸…æ‰ï¼Œç„¶åç”¨æ‰€æœ‰çš„ç”¨æˆ·åˆ›å»ºåˆç†çš„è´­ç‰©è½¦æ•°æ®ã€‚äºæ˜¯ï¼Œæˆ‘åœ¨è¿™é‡ŒåˆèŠ±äº†å‡ ä¸ªå°æ—¶ï¼Œé€ å‡ºäº†130å¤šä¸‡æ•°æ®ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å†å›å½’ä¸€ä¸‹åœºæ™¯ï¼š

![](https://static001.geekbang.org/resource/image/d9/bd/d995e490eba886f2cd1b1eb96e27d4bd.png?wh=1807%2A654)

ä½ çœ‹ï¼ŒTPSå¢åŠ åˆ°äº†300ï¼

æœ¬æ¥è¿™æ˜¯ä¸€ä¸ªç¾å¥½åˆ°å¯ä»¥å–ä¸‹åˆèŒ¶çš„ç»“æœï¼Œç„¶è€Œâ€¦â€¦å¤©ä¸éšäººæ„¿ï¼Œæˆ‘åœ¨åœºæ™¯æŒç»­æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œåˆå‘ç°äº†é—®é¢˜ï¼Œè¿™è®©æˆ‘ä»¬ä¸å¾—ä¸å¼€å¯ç¬¬äºŒé˜¶æ®µçš„åˆ†æã€‚

## ç¬¬äºŒé˜¶æ®µ

### åœºæ™¯è¿è¡Œæ•°æ®

æ˜¯ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿæˆ‘åœ¨å‹åŠ›è¿è¡Œçš„æ•°æ®ä¸­ï¼Œç«Ÿç„¶çœ‹åˆ°äº†è¿™ç§TPSæ›²çº¿ï¼š

![](https://static001.geekbang.org/resource/image/86/1c/866308ac100a2f7fe4aff4cb545baa1c.png?wh=1825%2A825)

ä½ çœ‹ï¼ŒTPSç›¸å½“è§„å¾‹åœ°å¾€ä¸‹æ‰ï¼Œä¸ä»…ä¼šæ‰ä¸‹å»ï¼Œè€Œä¸”è¿˜ä¼šæ¢å¤å›å»ï¼Œå½¢æˆä¸€ä¸ªæ˜æ˜¾çš„é”¯é½¿çŠ¶ï¼Œå¹¶ä¸”è¿™é”¯é½¿è¿˜æŒºå¤§ã€‚

æ€ä¹ˆåŠï¼Ÿæ ¹æ®é«˜è€å¸ˆçš„æ€è·¯ï¼Œç°åœ¨æˆ‘ä»¬å°±å¾—æŒ‰ç…§RESARæ€§èƒ½åˆ†æé€»è¾‘æ¥æ”¶æ‹¾è¿™ä¸ªé—®é¢˜äº†ã€‚æˆ‘ä»¬åœ¨å‰é¢å·²ç»çœ‹è¿‡æ¶æ„å›¾ï¼Œæ‰€ä»¥ï¼Œç°åœ¨ç›´æ¥æ¥æ‹†åˆ†å“åº”æ—¶é—´ã€‚

### æ‹†åˆ†å“åº”æ—¶é—´

- Gatewayï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/cf/ee/cfd701a0577144f42b5be4834ebce7ee.png?wh=259%2A173)

- Orderï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/32/c1/32c9cb7568648c06e7eb969bbd0d3bc1.png?wh=253%2A175)

- Cartï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/0d/18/0d2e5444036c7f48e8006469b5788f18.png?wh=257%2A172)

- Portalï¼š

![](https://static001.geekbang.org/resource/image/50/27/50baae9e1f86a718c21e470d9da8ea27.png?wh=260%2A177)

ä»ä¸Šé¢çš„æ•°æ®æ¥çœ‹ï¼Œä¼¼ä¹æ¯ä¸€å±‚éƒ½æœ‰æ—¶é—´æ¶ˆè€—ï¼Œæ€§èƒ½éƒ½ä¸æ€ä¹ˆæ ·ã€‚

### å…¨å±€åˆ†æ

é‚£æˆ‘ä»¬å°±æŸ¥çœ‹ä¸‹å½“å‰çš„å…¨å±€ç›‘æ§æ•°æ®ï¼Œå¯ä»¥çœ‹åˆ°worker-3ä¸Šçš„CPUæ¶ˆè€—æœ€å¤šï¼š

![](https://static001.geekbang.org/resource/image/38/15/381218081130641a582b92e7849ea515.png?wh=1809%2A484)

å› æ­¤ï¼Œæˆ‘ä»¬æ¥æŸ¥ä¸€ä¸‹worker-3ä¸Šæœ‰å“ªäº›Podï¼š

```
[root@k8s-master-3 ~]# kubectl get pods -o wide | grep k8s-worker-3
cloud-nacos-registry-685b8957d7-vskb6       1/1     Running     0          3d7h    10.100.69.199    k8s-worker-3   <none>           <none>
cloud-redis-7f7db7f45c-t5g46                2/2     Running     1          3d4h    10.100.69.196    k8s-worker-3   <none>           <none>
elasticsearch-master-2                      1/1     Running     0          23h     10.100.69.209    k8s-worker-3   <none>           <none>
svc-mall-cart-79c667bf56-j76h6              1/1     Running     0          20h     10.100.69.213    k8s-worker-3   <none>           <none>
svc-mall-order-fbfd8b57c-kbczh              1/1     Running     0          3d7h    10.100.69.202    k8s-worker-3   <none>           <none>
svc-mall-portal-846d9994f8-m7jbq            1/1     Running     0          2d10h   10.100.69.207    k8s-worker-3   <none>           <none>
svc-mall-search-c9c8bc847-h7sgv             1/1     Running     0          23h     10.100.69.210    k8s-worker-3   <none>           <none>
[root@k8s-master-3 ~]#
```

å±…ç„¶æœ‰è¿™ä¹ˆå¤šæœåŠ¡éƒ½åœ¨worker-3ä¸Šã€‚

æˆ‘ä»¬ç°åœ¨ç™»å½•åˆ°worker-3ä¸Šï¼Œçœ‹ä¸€ä¸‹topèµ„æºã€‚å…¶å®ï¼Œæˆ‘åœ¨è¿™é‡Œä¸»è¦æƒ³çœ‹çš„æ˜¯process tableï¼Œå› ä¸ºæˆ‘æƒ³å…ˆç¡®å®šä¸€ä¸‹å“ªä¸ªæœåŠ¡æ¶ˆè€—çš„èµ„æºæœ€é«˜ï¼Œç„¶åå†å†³å®šæ”¶æ‹¾å“ªä¸ªæœåŠ¡ã€‚

```
[root@k8s-worker-3 ~]# top
top - 22:13:01 up 3 days,  8:39,  3 users,  load average: 40.34, 30.03, 18.02
Tasks: 326 total,   6 running, 320 sleeping,   0 stopped,   0 zombie
%Cpu0  : 74.5 us, 13.4 sy,  0.0 ni,  7.7 id,  0.0 wa,  0.0 hi,  4.4 si,  0.0 st
%Cpu1  : 66.3 us, 12.1 sy,  0.0 ni, 16.5 id,  0.0 wa,  0.0 hi,  4.7 si,  0.3 st
%Cpu2  : 49.7 us, 32.4 sy,  0.0 ni, 14.9 id,  0.0 wa,  0.0 hi,  2.7 si,  0.3 st
%Cpu3  : 73.2 us,  9.7 sy,  0.0 ni, 12.4 id,  0.0 wa,  0.0 hi,  4.7 si,  0.0 st
%Cpu4  : 76.4 us, 10.5 sy,  0.0 ni,  8.8 id,  0.0 wa,  0.0 hi,  4.1 si,  0.3 st
%Cpu5  : 62.4 us, 16.4 sy,  0.0 ni, 16.1 id,  0.0 wa,  0.0 hi,  4.7 si,  0.3 st
KiB Mem : 16265992 total,   211212 free,  9204800 used,  6849980 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  6650068 avail Mem 


  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                                                                  
32485 root      20   0 8895760 700564  16896 S 101.6  4.3 723:03.52 java -Dapp.id=svc-mall-cart -javaagent:/opt/skywalking/agent/skywalking-agent.jar -Dskywalking.agent.service_name=svc-ma+
32589 root      20   0 8845576 778684  15896 S  93.6  4.8 427:04.44 java -Dapp.id=svc-mall-order -javaagent:/opt/skywalking/agent/skywalking-agent.jar -Dskywalking.agent.service_name=svc-m+
24119 root      20   0 8825208 600956  15888 S  67.9  3.7 262:00.83 java -Dapp.id=svc-mall-portal -javaagent:/opt/skywalking/agent/skywalking-agent.jar -Dskywalking.agent.service_name=svc-+
............
```

åœ¨ä¸Šè¿°topèµ„æºä¸­ï¼Œæˆ‘ä»¬ä¸»è¦æ¥çœ‹å‡ ä¸ªåƒCPUçš„å¤§æˆ·ã€‚ä¸éš¾å‘ç°ï¼ŒCart/Order/Portalè¿™ä¸‰ä¸ªæœåŠ¡åœ¨è´­ç‰©è½¦ä¿¡æ¯ç¡®å®šè®¢å•çš„ä¸šåŠ¡ä¸­éƒ½æœ‰ç”¨åˆ°ï¼Œå¹¶ä¸”éƒ½åœ¨åŒä¸€ä¸ªworkerä¸Šã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ª6Cçš„workerä¸­ï¼Œç°åœ¨çš„CPUé˜Ÿåˆ—å·²ç»è¾¾åˆ°40äº†ã€‚

### å®šå‘åˆ†æ

ä»ç³»ç»Ÿä¸Šæ¥çœ‹ï¼ŒCPUé˜Ÿåˆ—é•¿çš„é—®é¢˜ä¸»è¦æ˜¯ç”±äºèµ„æºçš„äº‰ç”¨ï¼Œå› ä¸ºçº¿ç¨‹åœ¨ä¸æ–­åœ°å”¤é†’ï¼Œé€šè¿‡start\_threadå°±èƒ½çœ‹å‡ºæ¥ï¼š

![](https://static001.geekbang.org/resource/image/15/1a/15cae37yy8db5883c6cf2fd4b944ed1a.png?wh=1355%2A144)

ç°åœ¨æˆ‘ä»¬è¦åšçš„å°±æ˜¯æŠŠçº¿ç¨‹é™ä¸‹å»ã€‚

æ€ä¹ˆé™å‘¢ï¼Ÿæœ‰ä¸¤ç§æ‰‹æ®µï¼š

1. æŠŠæœåŠ¡ç§»èµ°ï¼Œå…ˆä¸€ä¸ªä¸ªæ”¶æ‹¾ï¼Œåˆ†è€Œæ²»ä¹‹ã€‚
2. æŠŠæœåŠ¡çš„çº¿ç¨‹å‡å°‘ã€‚

è¿™ä¸¤ç§æ–¹å¼éƒ½æ˜¯èƒ½å‡å°‘èµ„æºäº‰ç”¨ï¼Œä½†æ˜¯ä¼šå¸¦æ¥ä¸åŒçš„å½±å“ã€‚å…¶ä¸­ï¼Œç¬¬ä¸€ç§æ‰‹æ®µæ¯”è¾ƒåˆç†ï¼Œåªæ˜¯ä¼šæ¶ˆè€—æ›´å¤šçš„æ•´ä½“èµ„æºï¼›ç¬¬äºŒç§æ‰‹æ®µè™½ç„¶ä¼šå‡å°‘äº‰ç”¨ï¼Œä½†æ˜¯ä¼šå¯¼è‡´å“åº”æ—¶é—´å¢åŠ ã€‚

æˆ‘è¿™ä¹ˆè·Ÿä½ ä¸€è®²ï¼Œä½ å¯èƒ½å·²ç»å‘ç°äº†ï¼Œè¿™ä¸¤ç§æ‰‹æ®µéƒ½ä¸èƒ½è§£é‡ŠTPSä¸ç¨³å®šçš„é—®é¢˜ã€‚é‚£ä¸ºä»€ä¹ˆTPSä¸€ä¼šå„¿æ‰ä¸‹å»ï¼Œä¸€ä¼šå„¿åˆæ¢å¤å‘¢ï¼Ÿç°åœ¨æˆ‘ä»¬è¿˜ä¸çŸ¥é“ç­”æ¡ˆï¼Œä¸è¿‡åŸºäºæˆ‘ä»¬â€œå…¨å±€-å®šå‘â€çš„åˆ†ææ€è·¯ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹worker-3çš„èµ„æºæ¶ˆè€—ï¼š

![](https://static001.geekbang.org/resource/image/94/8a/94635d74fa68485c9b5f240efe25448a.png?wh=1881%2A733)

åœ¨åŒä¸€æ—¶é—´æ®µï¼Œæˆ‘ä¹ŸæŸ¥çœ‹äº†åŒä¸€å°ç‰©ç†æœºä¸Šçš„å…¶ä»–workerçš„èµ„æºæ¶ˆè€—æƒ…å†µï¼Œå‘ç°worker-8çš„èµ„æºæ¶ˆè€—æœ‰ç‚¹ä¸å¤ªæ­£å¸¸ã€‚è¯·ä½ æ³¨æ„ï¼Œæˆ‘æ­¤æ—¶çš„æŸ¥çœ‹é€»è¾‘ï¼Œä»ç„¶ä¾æ®çš„æ˜¯[ç¬¬3](https://time.geekbang.org/column/article/355982)[è®²](https://time.geekbang.org/column/article/355982)ä¸­æè¿°çš„é€»è¾‘ï¼Œä»¥åŠå¯¹åº”[ç¬¬4](https://time.geekbang.org/column/article/356789)[è®²](https://time.geekbang.org/column/article/356789)ä¸­çš„æ€§èƒ½åˆ†æå†³ç­–æ ‘ã€‚å¸Œæœ›ä½ ä¸è¦è§‰å¾—è¿™é‡Œæœ‰è·³è·ƒï¼Œå®é™…ä¸Šæˆ‘ä»¬è¿˜æ˜¯åœ¨å…¨å±€ç›‘æ§çš„ç¬¬ä¸€å±‚è®¡æ•°å™¨ä¸Šã€‚

æˆ‘ä»¬å…·ä½“æ¥çœ‹ä¸€ä¸‹worker-8çš„èµ„æºæ¶ˆè€—ï¼š

![](https://static001.geekbang.org/resource/image/5f/7d/5ffbabcbaab9c75bbd9702e8c6bc397d.png?wh=1891%2A740)

å†æ¥çœ‹ä¸€ä¸‹å‹åŠ›åœºæ™¯çš„æ‰§è¡Œæ•°æ®ï¼š

![](https://static001.geekbang.org/resource/image/53/22/53yy0beb312b256b881aa7f2b13d5422.png?wh=1829%2A576)

ä»ä¸Šé¢worker-8çš„èµ„æºä½¿ç”¨ç‡æ¥çœ‹ï¼Œç¡®å®æœ‰å¾ˆé«˜çš„æ—¶å€™ã€‚è€ƒè™‘åˆ°åŒä¸€ç‰©ç†æœºä¸Šèµ„æºçš„äº‰ç”¨é—®é¢˜ï¼Œæˆ‘ä»¬ç°åœ¨æŠŠcartç§»åˆ°Worker-7ä¸Šå»ï¼ŒæŠŠorderç§»åˆ°worker-9ä¸Šå»ï¼Œå†æ¥çœ‹TPSï¼š

![](https://static001.geekbang.org/resource/image/da/c7/da51bcc4719030dfca91d6ayyd4bafc7.png?wh=1828%2A574)

èŠ±èŠ±ç»¿ç»¿ï¼Œèµ·èµ·ä¼ä¼ï¼ŒçœŸæ˜¯å¥½çœ‹â€¦â€¦æˆ‘ä»¬å…ˆä¸ç®¡è¿™æ ·åšæœ‰æ²¡æœ‰å¢åŠ TPSï¼Œå…‰çœ‹è¿™ä¸ªè¶‹åŠ¿ï¼Œå°±è¶³ä»¥è®©äººå¿ƒç¢äº†ã€‚æ—¢ç„¶ç»“æœè¿˜æ˜¯è¿™æ ·ï¼Œé‚£æˆ‘ä»¬å°±ç”¨è€å¥—è·¯ï¼Œç»§ç»­æ‹†åˆ†æ—¶é—´æ¥çœ‹çœ‹ã€‚

- Gatewayï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/15/38/15e776926d852b45437d162cbb3e7d38.png?wh=319%2A217)

- Orderï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/8c/35/8c9dbf53ba48148205dda9056c576a35.png?wh=325%2A221)

- Cartï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/03/d9/03e79a09e74234a155cba30b83b9e4d9.png?wh=326%2A214)

- Portalï¼š

<!--THE END-->

![](https://static001.geekbang.org/resource/image/3f/77/3f887ef22afd45f5aaa1dcfd8c9b0b77.png?wh=324%2A220)

- Memberï¼š

![](https://static001.geekbang.org/resource/image/d7/e2/d7dbe6944ea0efd7db8eee2999c917e2.png?wh=329%2A217)

ä»ä¸Šé¢çš„æ—¶é—´æ¥çœ‹ï¼ŒGatewayæ¶ˆè€—çš„æ—¶é—´æ¯”è¾ƒé•¿ï¼Œè¿™å°±å¥‡æ€ªäº†ï¼Œè¿™éƒ½æ¢äº†åˆ°äº†GatewayæœåŠ¡ä¸Šæœ‰é—®é¢˜äº†ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åˆ°Gatewayæœºå™¨ä¸Šçœ‹ä¸€ä¸‹åˆ°åº•æœ‰å“ªäº›æœåŠ¡ï¼š

![](https://static001.geekbang.org/resource/image/18/28/18653de1d1182584c7792bd0e46ecd28.png?wh=2720%2A778)

å‘€å‘€å‘€ï¼Œé‚£ä¸ªå ç¬¬ä¸€ä½çš„æ˜¯ä¸ªå•¥ï¼ŸåŸæ¥æ˜¯ESçš„ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™ä¸ªè¿›ç¨‹æ¶ˆè€—äº†å¤šä¸ªCPUã€‚çœ‹åˆ°è¿™ï¼Œæˆ‘æƒ³èµ·æ¥å‰å‡ å¤©ä¸ºäº†å¢åŠ ESçš„èƒ½åŠ›ï¼Œæˆ‘ä»¬ç»™ES dataå’ŒES clientå¢åŠ è¿‡CPUã€‚å½“æ—¶è€ƒè™‘åˆ°å®ƒä»¬éƒ½æ˜¯åƒCPUçš„å¤§æˆ·ï¼Œåªèƒ½ç”¨ä¸€ä¸ªCPUå®åœ¨å¤ªå§”å±ˆå®ƒä»¬äº†ï¼Œæ‰€ä»¥å¢åŠ äº†CPUæ•°é‡ï¼Œæƒ³è®©å®ƒä»¬çš„æ€§èƒ½å¥½ä¸€äº›ã€‚

å¯æ˜¯æ²¡æƒ³åˆ°ï¼ŒES dataå’ŒES clientå¯¹åº”ç”¨çš„å½±å“æœ‰è¿™ä¹ˆå¤§ã€‚

æˆ‘å½“æ—¶æ”¹ESçš„CPUï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬æ¶æ„ä¸­çš„ä¸€ä¸ªæœç´¢æœåŠ¡ç”¨åˆ°äº†å®ƒï¼Œè€Œå½“æ—¶çš„CPUç»™çš„æ˜¯ä¸€ä¸ªCï¼Œè¿™å¯¼è‡´SearchæœåŠ¡çš„TPSå¾ˆä½ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œæˆ‘åœ¨[ç¬¬](https://time.geekbang.org/column/article/366020)[15](https://time.geekbang.org/column/article/366020)[è®²](https://time.geekbang.org/column/article/366020)ä¸­æœ‰æè¿°ï¼Œä½ å¦‚æœä¸æ¸…æ¥šï¼Œå¯ä»¥å†çœ‹çœ‹ã€‚

åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜è¦æ³¨æ„ä¸€ç‚¹ï¼ŒES dataå’ŒES clientéƒ½ä¸æ˜¯å•ä¸€çš„èŠ‚ç‚¹ï¼Œè€Œæ˜¯æœ‰å‡ ä¸ªèŠ‚ç‚¹ã€‚ç”±æ­¤äº§ç”Ÿçš„é—®é¢˜å°±æ˜¯ï¼Œä»»æ„ä¸€ä¸ªESèŠ‚ç‚¹å‡ºç°èµ„æºæ¶ˆè€—è¿‡å¤šçš„æ—¶å€™ï¼Œéƒ½ä¼šå½±å“åˆ°å®ƒæ‰€åœ¨çš„workeræœºå™¨èµ„æºï¼Œè¿›è€Œå½±å“åˆ°è¿™ä¸ªESèŠ‚ç‚¹æ‰€åœ¨çš„æ•´ä¸ªç‰©ç†æœºã€‚

æ—¢ç„¶ESçš„è¿›ç¨‹æ¶ˆè€—èµ„æºå å±…é¦–ä½ï¼Œé‚£æˆ‘ä»¬è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿä¸ºäº†éªŒè¯é—®é¢˜ï¼Œæˆ‘å…ˆæŠŠESç»™åœæ‰ï¼Œçœ‹çœ‹TPSèƒ½ä¸èƒ½ä¸Šæ¥ï¼Œå¦‚æœèƒ½ä¸Šæ¥ï¼Œæˆ‘ä»¬å†è€ƒè™‘æ€ä¹ˆé™åˆ¶ESçš„èµ„æºã€‚

åœäº†ESä¹‹åï¼ŒTPSå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://static001.geekbang.org/resource/image/43/c6/4399eb3a375812e4d08a26680e8978c6.png?wh=1824%2A524)

çœ‹åˆ°æ²¡æœ‰ï¼ŸTPSå¢åŠ äº†ä¸€å€ï¼Œå¹¶ä¸”ä¹Ÿæ²¡æœ‰æ‰ä¸‹æ¥ï¼éå¸¸ç†æƒ³ï¼

æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±è¦è€ƒè™‘æŠŠESé™åˆ¶åˆ°å›ºå®šçš„workerä¸Šï¼Œè®©å®ƒä¸å½±å“ç°åœ¨çš„åº”ç”¨ã€‚

## æ€»ç»“

åœ¨è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªé˜¶æ®µçš„åˆ†æã€‚

åœ¨ç¬¬ä¸€ä¸ªé˜¶æ®µä¸­ï¼Œæˆ‘ä»¬å®šä½äº†æ•°æ®é—®é¢˜ã€‚å¯¹äºæ€§èƒ½æ¥è¯´ï¼Œ**æ•°æ®æ˜¯éå¸¸é‡è¦çš„åŸºç¡€èµ„æºï¼Œè€Œæ•°æ®çš„åˆç†æ€§ç›´æ¥å½±å“äº†æµ‹è¯•çš„ç»“æœã€‚**

ç»å¸¸æœ‰åˆå…¥æ€§èƒ½è¡Œä¸šçš„äººè®¨è®ºï¼šæ€§èƒ½è„šæœ¬ä¸­çš„æ•°æ®åˆ°åº•åº”è¯¥ç”¨å¤šå°‘ï¼Ÿæˆ‘è§‰å¾—è¿™æ˜¯ä¸€ä¸ªéå¸¸æ˜ç¡®çš„é—®é¢˜ï¼Œ**åœ¨æ‰€æœ‰çš„æ€§èƒ½åœºæ™¯ä¸­ï¼Œä½¿ç”¨çš„èµ„æºéƒ½åº”è¯¥æŒ‰çœŸå®å‘ç”Ÿçš„ä¸šåŠ¡é€»è¾‘æ¥ç¡®å®šï¼Œæœ‰ä¸”åªæœ‰è¿™æ ·ï¼Œæ‰èƒ½ä¿è¯ç»“æœæ˜¯æœ‰æ•ˆçš„**ã€‚

åœ¨ç¬¬äºŒé˜¶æ®µä¸­ï¼Œæˆ‘ä»¬å®šä½äº†ä¸€ä¸ªæœ‰æ„æ€çš„é—®é¢˜ï¼Œè€Œè¿™ä¸ªé—®é¢˜çš„å¤æ‚æ€§åœ¨äºæ•´ä½“çš„æ¶æ„ã€‚å› ä¸ºæˆ‘ä»¬æ˜¯ç”¨KVMã€Kuberneteså’ŒDockerä½œä¸ºåŸºç¡€è®¾æ–½çš„ï¼Œè€Œæˆ‘ä»¬é€‰æ‹©çš„åº”ç”¨åŸæœ¬ä¹Ÿä¸æ˜¯çœŸæ­£çš„å¾®æœåŠ¡ï¼Œæ˜¯å¯¹ä¸€ä¸ªå¼€æºç³»ç»Ÿæ¶æ„åšäº†æ›´æ”¹ï¼ŒæŠŠå®ƒæ”¹æˆäº†çœŸæ­£çš„å¾®æœåŠ¡ã€‚

åœ¨è¿™æ ·çš„ç¯å¢ƒä¸­ï¼Œå¦‚æœä¸€ä¸ªåº”ç”¨æœ‰é—®é¢˜ï¼Œé‚£åœ¨ä¿®æ”¹é‡å¯çš„æ—¶å€™ï¼Œåº”ç”¨ä¼šè¢«Kubernetesè°ƒåº¦åˆ°å“ªä¸ªèŠ‚ç‚¹ä¸Šï¼Œæ˜¯ä¸ç¡®å®šçš„ã€‚ä¹Ÿæ­£æ˜¯å‡ºäºè¿™æ ·çš„åŸå› ï¼Œæˆ‘ä»¬ä¸€ä¼šå„¿çœ‹åˆ°è¿™é‡Œæœ‰é—®é¢˜ï¼Œä¸€ä¼šå„¿çœ‹åˆ°é‚£é‡Œæœ‰é—®é¢˜ï¼Œå®šä½çš„é€»è¾‘å…¨éƒ½å¯¹ï¼Œä½†æ˜¯å°±æ˜¯å±‚é¢ä¸å¯¹ã€‚è¿™ä¹Ÿæ˜¯[ä¸ŠèŠ‚è¯¾](https://time.geekbang.org/column/article/368125)ä¸­éšæœºé—®é¢˜å‡ºç°çš„åŸå› ã€‚

æ‰€ä»¥ï¼Œæ ¹æ®æˆ‘ä»¬åœ¨[ç¬¬4è®²](https://time.geekbang.org/column/article/356789)ä¸­æåˆ°çš„æ€§èƒ½åˆ†æå†³ç­–æ ‘ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦æœ‰å…¨å±€ç›‘æ§ã€å®šå‘ç›‘æ§çš„æ€è·¯ï¼Œå¹¶ä¸”è¿˜è¦æ‰¾åˆ°è®¡æ•°å™¨çš„ç›¸å…³æ€§ã€‚è¿™æ ·ä¸€æ¥ï¼Œå½“çœ‹åˆ°ç›¸å…³è®¡æ•°å™¨æœ‰é—®é¢˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±èƒ½çŸ¥é“å®ƒä»¬ä¹‹é—´çš„å…³è”å…³ç³»äº†ã€‚

å¸Œæœ›ä½ åœ¨è¿™èŠ‚è¯¾ä¸­ï¼Œèƒ½æŠŠæ€§èƒ½åˆ†æçš„é€»è¾‘è®°åœ¨å¿ƒä¸­ã€‚

## è¯¾åä½œä¸š

æœ€åï¼Œè¯·ä½ æ€è€ƒä¸€ä¸‹ï¼š

1. æ€§èƒ½è„šæœ¬ä¸­çš„å‚æ•°åº”è¯¥å¦‚ä½•è®¾è®¡ï¼Ÿ
2. å¦‚ä½•å®šä½TPSä¼šæ‰ä¸‹æ¥çš„æƒ…å†µï¼Ÿå¤§æ¦‚æè¿°ä¸€ä¸‹ä½ çš„æ€è·¯ã€‚

è®°å¾—åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºã€äº¤æµä½ çš„æƒ³æ³•ï¼Œæ¯ä¸€æ¬¡æ€è€ƒéƒ½ä¼šè®©ä½ æ›´è¿›ä¸€æ­¥ã€‚

å¦‚æœä½ è¯»å®Œè¿™ç¯‡æ–‡ç« æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå…±åŒå­¦ä¹ è¿›æ­¥ã€‚æˆ‘ä»¬ä¸‹è¿™èŠ‚è¯¾å†è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ4ï¼‰</strong></div><ul>
<li><span>Technological life</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>â€œåŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ª 6C çš„ worker ä¸­ï¼Œç°åœ¨çš„ CPU é˜Ÿåˆ—å·²ç»è¾¾åˆ° 40 äº†ã€‚â€


è¿™ä¸ª40æ˜¯åœ¨å“ªä¸ªä½ç½®çœ‹åˆ°çš„å‘¢ï¼Ÿ</p>2021-05-20</li><br/><li><span>Geek_xbye50</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é«˜è€å¸ˆè¿™èŠ‚è¯¾è²Œä¼¼è¿˜æ²¡è¯´æ˜ä¸Šä¸€èŠ‚è¯¾çš„é—®é¢˜</p>2021-05-08</li><br/><li><span>ææ²…å³°</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œ ä½ grafana ç”¨æ¨¡ç‰ˆidæ˜¯å¤šå°‘å‘€ï¼Ÿæœ‰æ¨èçš„ä¹ˆï¼Ÿ</p>2022-07-01</li><br/><li><span>zwm</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>1 ç¬¬ä¸€ä¸ªåŸåˆ™æ˜¯ç¬¦åˆä¸šåŠ¡é€»è¾‘ï¼Œæˆ‘ç°åœ¨çš„åšæ³•æ˜¯æŠŠè¢«æµ‹æ¥å£çš„æ–¹æ³•æ‹¿å‡ºæ¥ï¼Œå…ˆåœ¨æ•°æ®åº“æ‰§è¡Œä¸€éï¼Œç±»ä¼¼ä¿è¯æ¯ä¸€ä¸ªè®¢å•æ•°é‡ä¸æ˜¯5000ï¼Œè€Œæ˜¯groupbyä½¿å¾—æ»¡è¶³çœŸå®æƒ…å†µ
2 ç¬¬äºŒä¸ªé—®é¢˜ï¼ŒçŸ¥é“äº†esåƒCPUå½±å“æ€§èƒ½ï¼Œä½†æ˜¯æ˜¯æ€ä¹ˆå½±å“æ˜¯å› ä¸ºåœ¨å‘¨æœŸè¿›è¡ŒæŸ¥è¯¢æœåŠ¡å—?
   æ‰€ä»¥æ‰å¯¼è‡´getwayæ‰€åœ¨å®ä¾‹æœºå™¨çš„CPUåˆ©ç”¨ç‡å‘¨æœŸæ€§å˜åŒ–å¿½é«˜å¿½ä½ä»è€Œå¯¼è‡´äº†æˆ‘ä»¬çš„æµ‹è¯•ç»“æ„æ˜¯å‘¨æœŸ 
   æ€§æ³¢åŠ¨?      ã€æƒ³çŸ¥é“ä¸ºä»€ä¹ˆesæ¶ˆè€—CPUæ˜¯å‘¨æœŸæ€§çš„å’ŒTPSæ›²çº¿å·®ä¸å¤š è€Œä¸æ˜¯ä¸€ç›´é«˜ã€‘</p>2021-07-12</li><br/>
</ul>