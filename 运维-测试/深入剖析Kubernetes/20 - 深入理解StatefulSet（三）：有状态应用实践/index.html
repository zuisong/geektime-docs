<!--geek time docs 🚀, MIT license-->


<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="极客时间文档">
      
      
        <meta name="author" content="zkep">
      
      
        <link rel="canonical" href="https://github.com/uaxe/geektime-docs/%E8%BF%90%E7%BB%B4-%E6%B5%8B%E8%AF%95/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes/20%20-%20%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3StatefulSet%EF%BC%88%E4%B8%89%EF%BC%89%EF%BC%9A%E6%9C%89%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5/">
      
      
        <link rel="prev" href="../19%20-%20%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3StatefulSet%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E5%AD%98%E5%82%A8%E7%8A%B6%E6%80%81/">
      
      
        <link rel="next" href="../21%20-%20%E5%AE%B9%E5%99%A8%E5%8C%96%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%84%8F%E4%B9%89%EF%BC%9ADaemonSet/">
      
      
      <link rel="icon" href="../../../None">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.5">
    
    
      
        <title>20 深入理解StatefulSet（三）：有状态应用实践 - 极客时间文档</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/style.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            


          </div>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="极客时间文档" class="md-header__button md-logo" aria-label="极客时间文档" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            极客时间文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              20   深入理解StatefulSet（三）：有状态应用实践
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/zkep/my-geektime" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zkep/my-geektime
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../AI-%E5%A4%A7%E6%95%B0%E6%8D%AE/" class="md-tabs__link">
          
  
    
  
  AI-大数据

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E4%BA%A7%E5%93%81-%E8%BF%90%E8%90%A5/" class="md-tabs__link">
          
  
    
  
  产品-运营

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E5%89%8D%E7%AB%AF-%E7%A7%BB%E5%8A%A8/" class="md-tabs__link">
          
  
    
  
  前端-移动

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E5%90%8E%E7%AB%AF-%E6%9E%B6%E6%9E%84/" class="md-tabs__link">
          
  
    
  
  后端-架构

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E7%AE%A1%E7%90%86-%E6%88%90%E9%95%BF/" class="md-tabs__link">
          
  
    
  
  管理-成长

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" class="md-tabs__link">
          
  
    
  
  计算机基础

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
    
  
  运维-测试

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="极客时间文档" class="md-nav__button md-logo" aria-label="极客时间文档" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    极客时间文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/zkep/my-geektime" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zkep/my-geektime
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../AI-%E5%A4%A7%E6%95%B0%E6%8D%AE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    AI-大数据
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../%E4%BA%A7%E5%93%81-%E8%BF%90%E8%90%A5/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    产品-运营
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../%E5%89%8D%E7%AB%AF-%E7%A7%BB%E5%8A%A8/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    前端-移动
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../%E5%90%8E%E7%AB%AF-%E6%9E%B6%E6%9E%84/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    后端-架构
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../%E7%AE%A1%E7%90%86-%E6%88%90%E9%95%BF/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    管理-成长
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    计算机基础
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    运维-测试
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            运维-测试
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../AI%E9%87%8D%E5%A1%91%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/AI%E9%87%8D%E5%A1%91%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    AI重塑云原生应用开发实战
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../DevOps%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/DevOps%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    DevOps实战笔记
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../Kubernetes%E5%85%A5%E9%97%A8%E5%AE%9E%E6%88%98%E8%AF%BE/Kubernetes%E5%85%A5%E9%97%A8%E5%AE%9E%E6%88%98%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Kubernetes入门实战课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../Linux%E5%86%85%E6%A0%B8%E6%8A%80%E6%9C%AF%E5%AE%9E%E6%88%98%E8%AF%BE/Linux%E5%86%85%E6%A0%B8%E6%8A%80%E6%9C%AF%E5%AE%9E%E6%88%98%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Linux内核技术实战课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../Linux%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/Linux%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Linux性能优化实战
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../SRE%E5%AE%9E%E6%88%98%E6%89%8B%E5%86%8C/SRE%E5%AE%9E%E6%88%98%E6%89%8B%E5%86%8C/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    SRE实战手册
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../SRE%E5%AE%9E%E8%B7%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%A1%88%E4%BE%8B%E8%AF%BE/SRE%E5%AE%9E%E8%B7%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%A1%88%E4%BE%8B%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    SRE实践：服务可靠性案例课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../Serverless%E8%BF%9B%E9%98%B6%E5%AE%9E%E6%88%98%E8%AF%BE/Serverless%E8%BF%9B%E9%98%B6%E5%AE%9E%E6%88%98%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Serverless进阶实战课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../Web%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%AE%9E%E6%88%98/Web%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E5%AE%9E%E6%88%98/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Web漏洞挖掘实战
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../eBPF%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E6%88%98/eBPF%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E6%88%98/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    eBPF核心技术与实战
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E4%BA%91%E5%8E%9F%E7%94%9F%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%E5%AE%9E%E6%88%98%E8%AF%BE/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%E5%AE%9E%E6%88%98%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    云原生基础架构实战课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E5%8F%8D%E7%88%AC%E8%99%AB%E5%85%B5%E6%B3%95%E6%BC%94%E7%BB%8E20%E8%AE%B2/%E5%8F%8D%E7%88%AC%E8%99%AB%E5%85%B5%E6%B3%95%E6%BC%94%E7%BB%8E20%E8%AE%B2/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    反爬虫兵法演绎20讲
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E6%8A%80%E8%83%BD30%E8%AE%B2/%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2%E6%8A%80%E8%83%BD30%E8%AE%B2/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    安全攻防技能30讲
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E5%AE%B9%E5%99%A8%E5%AE%9E%E6%88%98%E9%AB%98%E6%89%8B%E8%AF%BE/%E5%AE%B9%E5%99%A8%E5%AE%9E%E6%88%98%E9%AB%98%E6%89%8B%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    容器实战高手课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E9%AB%98%E6%89%8B%E8%AF%BE/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E9%AB%98%E6%89%8B%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    性能优化高手课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E6%88%9830%E8%AE%B2/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E6%88%9830%E8%AE%B2/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    性能测试实战30讲
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%9836%E8%AE%B2/%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%9836%E8%AE%B2/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    持续交付36讲
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95%E5%85%A5%E9%97%A8%E8%AF%BE/%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95%E5%85%A5%E9%97%A8%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    接口测试入门课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_20" checked>
        
          
          <label class="md-nav__link" for="__nav_7_20" id="__nav_7_20_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    深入剖析Kubernetes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_20_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7_20">
            <span class="md-nav__icon md-icon"></span>
            深入剖析Kubernetes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90Kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    深入剖析Kubernetes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%BC%80%E7%AF%87%E8%AF%8D%20-%20%E6%89%93%E9%80%9A%E2%80%9C%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF%E2%80%9D%E7%9A%84%E4%BB%BB%E7%9D%A3%E4%BA%8C%E8%84%89/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开篇词   打通“容器技术”的任督二脉
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../01%20-%20%E9%A2%84%E4%B9%A0%E7%AF%87%20%C2%B7%20%E5%B0%8F%E9%B2%B8%E9%B1%BC%E5%A4%A7%E4%BA%8B%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E5%88%9D%E5%87%BA%E8%8C%85%E5%BA%90/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    01   预习篇 · 小鲸鱼大事记（一）：初出茅庐
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../02%20-%20%E9%A2%84%E4%B9%A0%E7%AF%87%20%C2%B7%20%E5%B0%8F%E9%B2%B8%E9%B1%BC%E5%A4%A7%E4%BA%8B%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E5%B4%AD%E9%9C%B2%E5%A4%B4%E8%A7%92/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    02   预习篇 · 小鲸鱼大事记（二）：崭露头角
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../03%20-%20%E9%A2%84%E4%B9%A0%E7%AF%87%20%C2%B7%20%E5%B0%8F%E9%B2%B8%E9%B1%BC%E5%A4%A7%E4%BA%8B%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89%EF%BC%9A%E7%BE%A4%E9%9B%84%E5%B9%B6%E8%B5%B7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    03   预习篇 · 小鲸鱼大事记（三）：群雄并起
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../04%20-%20%E9%A2%84%E4%B9%A0%E7%AF%87%20%C2%B7%20%E5%B0%8F%E9%B2%B8%E9%B1%BC%E5%A4%A7%E4%BA%8B%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9A%E5%B0%98%E5%9F%83%E8%90%BD%E5%AE%9A/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    04   预习篇 · 小鲸鱼大事记（四）：尘埃落定
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../05%20-%20%E7%99%BD%E8%AF%9D%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E4%BB%8E%E8%BF%9B%E7%A8%8B%E8%AF%B4%E5%BC%80%E5%8E%BB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    05   白话容器基础（一）：从进程说开去
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../06%20-%20%E7%99%BD%E8%AF%9D%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E9%9A%94%E7%A6%BB%E4%B8%8E%E9%99%90%E5%88%B6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    06   白话容器基础（二）：隔离与限制
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../07%20-%20%E7%99%BD%E8%AF%9D%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%EF%BC%88%E4%B8%89%EF%BC%89%EF%BC%9A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    07   白话容器基础（三）：深入理解容器镜像
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../08%20-%20%E7%99%BD%E8%AF%9D%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9A%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86Docker%E5%AE%B9%E5%99%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    08   白话容器基础（四）：重新认识Docker容器
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../09%20-%20%E4%BB%8E%E5%AE%B9%E5%99%A8%E5%88%B0%E5%AE%B9%E5%99%A8%E4%BA%91%EF%BC%9A%E8%B0%88%E8%B0%88Kubernetes%E7%9A%84%E6%9C%AC%E8%B4%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    09   从容器到容器云：谈谈Kubernetes的本质
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../10%20-%20Kubernetes%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2%E5%88%A9%E5%99%A8%EF%BC%9Akubeadm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    10   Kubernetes一键部署利器：kubeadm
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../11%20-%20%E4%BB%8E0%E5%88%B01%EF%BC%9A%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84Kubernetes%E9%9B%86%E7%BE%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    11   从0到1：搭建一个完整的Kubernetes集群
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../12%20-%20%E7%89%9B%E5%88%80%E5%B0%8F%E8%AF%95%EF%BC%9A%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8%E5%8C%96%E5%BA%94%E7%94%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    12   牛刀小试：我的第一个容器化应用
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../13%20-%20%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81Pod%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    13   为什么我们需要Pod？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../14%20-%20%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90Pod%E5%AF%B9%E8%B1%A1%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    14   深入解析Pod对象（一）：基本概念
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../15%20-%20%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90Pod%E5%AF%B9%E8%B1%A1%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    15   深入解析Pod对象（二）：使用进阶
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../16%20-%20%E7%BC%96%E6%8E%92%E5%85%B6%E5%AE%9E%E5%BE%88%E7%AE%80%E5%8D%95%EF%BC%9A%E8%B0%88%E8%B0%88%E2%80%9C%E6%8E%A7%E5%88%B6%E5%99%A8%E2%80%9D%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    16   编排其实很简单：谈谈“控制器”模型
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../17%20-%20%E7%BB%8F%E5%85%B8PaaS%E7%9A%84%E8%AE%B0%E5%BF%86%EF%BC%9A%E4%BD%9C%E4%B8%9A%E5%89%AF%E6%9C%AC%E4%B8%8E%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    17   经典PaaS的记忆：作业副本与水平扩展
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../18%20-%20%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3StatefulSet%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E6%8B%93%E6%89%91%E7%8A%B6%E6%80%81/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    18   深入理解StatefulSet（一）：拓扑状态
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../19%20-%20%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3StatefulSet%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E5%AD%98%E5%82%A8%E7%8A%B6%E6%80%81/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    19   深入理解StatefulSet（二）：存储状态
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    20   深入理解StatefulSet（三）：有状态应用实践
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    20   深入理解StatefulSet（三）：有状态应用实践
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      思考题
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../21%20-%20%E5%AE%B9%E5%99%A8%E5%8C%96%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%84%8F%E4%B9%89%EF%BC%9ADaemonSet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    21   容器化守护进程的意义：DaemonSet
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../22%20-%20%E6%92%AC%E5%8A%A8%E7%A6%BB%E7%BA%BF%E4%B8%9A%E5%8A%A1%EF%BC%9AJob%E4%B8%8ECronJob/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    22   撬动离线业务：Job与CronJob
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../23%20-%20%E5%A3%B0%E6%98%8E%E5%BC%8FAPI%E4%B8%8EKubernetes%E7%BC%96%E7%A8%8B%E8%8C%83%E5%BC%8F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    23   声明式API与Kubernetes编程范式
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../24%20-%20%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90%E5%A3%B0%E6%98%8E%E5%BC%8FAPI%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9AAPI%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A5%A5%E7%A7%98/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    24   深入解析声明式API（一）：API对象的奥秘
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../25%20-%20%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90%E5%A3%B0%E6%98%8E%E5%BC%8FAPI%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E7%BC%96%E5%86%99%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%A7%E5%88%B6%E5%99%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    25   深入解析声明式API（二）：编写自定义控制器
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../26%20-%20%E5%9F%BA%E4%BA%8E%E8%A7%92%E8%89%B2%E7%9A%84%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%EF%BC%9ARBAC/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    26   基于角色的权限控制：RBAC
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../27%20-%20%E8%81%AA%E6%98%8E%E7%9A%84%E5%BE%AE%E5%88%9B%E6%96%B0%EF%BC%9AOperator%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E8%A7%A3%E8%AF%BB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    27   聪明的微创新：Operator工作原理解读
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../28%20-%20PV%E3%80%81PVC%E3%80%81StorageClass%EF%BC%8C%E8%BF%99%E4%BA%9B%E5%88%B0%E5%BA%95%E5%9C%A8%E8%AF%B4%E5%95%A5%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    28   PV、PVC、StorageClass，这些到底在说啥？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../29%20-%20PV%E3%80%81PVC%E4%BD%93%E7%B3%BB%E6%98%AF%E4%B8%8D%E6%98%AF%E5%A4%9A%E6%AD%A4%E4%B8%80%E4%B8%BE%EF%BC%9F%E4%BB%8E%E6%9C%AC%E5%9C%B0%E6%8C%81%E4%B9%85%E5%8C%96%E5%8D%B7%E8%B0%88%E8%B5%B7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    29   PV、PVC体系是不是多此一举？从本地持久化卷谈起
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../30%20-%20%E7%BC%96%E5%86%99%E8%87%AA%E5%B7%B1%E7%9A%84%E5%AD%98%E5%82%A8%E6%8F%92%E4%BB%B6%EF%BC%9AFlexVolume%E4%B8%8ECSI/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    30   编写自己的存储插件：FlexVolume与CSI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../31%20-%20%E5%AE%B9%E5%99%A8%E5%AD%98%E5%82%A8%E5%AE%9E%E8%B7%B5%EF%BC%9ACSI%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99%E6%8C%87%E5%8D%97/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    31   容器存储实践：CSI插件编写指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../32%20-%20%E6%B5%85%E8%B0%88%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    32   浅谈容器网络
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../33%20-%20%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90%E5%AE%B9%E5%99%A8%E8%B7%A8%E4%B8%BB%E6%9C%BA%E7%BD%91%E7%BB%9C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    33   深入解析容器跨主机网络
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../34%20-%20Kubernetes%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B%E4%B8%8ECNI%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    34   Kubernetes网络模型与CNI网络插件
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../35%20-%20%E8%A7%A3%E8%AF%BBKubernetes%E4%B8%89%E5%B1%82%E7%BD%91%E7%BB%9C%E6%96%B9%E6%A1%88/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    35   解读Kubernetes三层网络方案
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../36%20-%20%E4%B8%BA%E4%BB%80%E4%B9%88%E8%AF%B4Kubernetes%E5%8F%AA%E6%9C%89soft%20multi-tenancy%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    36   为什么说Kubernetes只有soft multi tenancy？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../37%20-%20%E6%89%BE%E5%88%B0%E5%AE%B9%E5%99%A8%E4%B8%8D%E5%AE%B9%E6%98%93%EF%BC%9AService%E3%80%81DNS%E4%B8%8E%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    37   找到容器不容易：Service、DNS与服务发现
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../38%20-%20%E4%BB%8E%E5%A4%96%E7%95%8C%E8%BF%9E%E9%80%9AService%E4%B8%8EService%E8%B0%83%E8%AF%95%E2%80%9C%E4%B8%89%E6%9D%BF%E6%96%A7%E2%80%9D/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    38   从外界连通Service与Service调试“三板斧”
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../39%20-%20%E8%B0%88%E8%B0%88Service%E4%B8%8EIngress/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    39   谈谈Service与Ingress
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../40%20-%20Kubernetes%E7%9A%84%E8%B5%84%E6%BA%90%E6%A8%A1%E5%9E%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    40   Kubernetes的资源模型与资源管理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../41%20-%20%E5%8D%81%E5%AD%97%E8%B7%AF%E5%8F%A3%E4%B8%8A%E7%9A%84Kubernetes%E9%BB%98%E8%AE%A4%E8%B0%83%E5%BA%A6%E5%99%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    41   十字路口上的Kubernetes默认调度器
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../42%20-%20Kubernetes%E9%BB%98%E8%AE%A4%E8%B0%83%E5%BA%A6%E5%99%A8%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5%E8%A7%A3%E6%9E%90/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    42   Kubernetes默认调度器调度策略解析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../43%20-%20Kubernetes%E9%BB%98%E8%AE%A4%E8%B0%83%E5%BA%A6%E5%99%A8%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%E4%B8%8E%E6%8A%A2%E5%8D%A0%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    43   Kubernetes默认调度器的优先级与抢占机制
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../44%20-%20Kubernetes%20GPU%E7%AE%A1%E7%90%86%E4%B8%8EDevice%20Plugin%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    44   Kubernetes GPU管理与Device Plugin机制
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../45%20-%20%E5%B9%95%E5%90%8E%E8%8B%B1%E9%9B%84%EF%BC%9ASIG-Node%E4%B8%8ECRI/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    45   幕后英雄：SIG Node与CRI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../46%20-%20%E8%A7%A3%E8%AF%BB%20CRI%20%E4%B8%8E%20%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    46   解读 CRI 与 容器运行时
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../47%20-%20%E7%BB%9D%E4%B8%8D%E4%BB%85%E4%BB%85%E6%98%AF%E5%AE%89%E5%85%A8%EF%BC%9AKata%20Containers%20%E4%B8%8E%20gVisor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    47   绝不仅仅是安全：Kata Containers 与 gVisor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../48%20-%20Prometheus%E3%80%81Metrics%20Server%E4%B8%8EKubernetes%E7%9B%91%E6%8E%A7%E4%BD%93%E7%B3%BB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    48   Prometheus、Metrics Server与Kubernetes监控体系
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../49%20-%20Custom%20Metrics%EF%BC%9A%20%E8%AE%A9Auto%20Scaling%E4%B8%8D%E5%86%8D%E2%80%9C%E9%A3%9F%E4%B9%8B%E6%97%A0%E5%91%B3%E2%80%9D/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    49   Custom Metrics： 让Auto Scaling不再“食之无味”
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../50%20-%20%E8%AE%A9%E6%97%A5%E5%BF%97%E6%97%A0%E5%A4%84%E5%8F%AF%E9%80%83%EF%BC%9A%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E4%B8%8E%E7%AE%A1%E7%90%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    50   让日志无处可逃：容器日志收集与管理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../51%20-%20%E8%B0%88%E8%B0%88Kubernetes%E5%BC%80%E6%BA%90%E7%A4%BE%E5%8C%BA%E5%92%8C%E6%9C%AA%E6%9D%A5%E8%B5%B0%E5%90%91/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    51   谈谈Kubernetes开源社区和未来走向
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../52%20-%20%E7%AD%94%E7%96%91%EF%BC%9A%E5%9C%A8%E9%97%AE%E9%A2%98%E4%B8%AD%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98%EF%BC%8C%E5%9C%A8%E6%80%9D%E8%80%83%E4%B8%AD%E4%BA%A7%E7%94%9F%E6%80%9D%E8%80%83/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    52   答疑：在问题中解决问题，在思考中产生思考
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%89%B9%E5%88%AB%E6%94%BE%E9%80%81%20-%202019%20%E5%B9%B4%EF%BC%8C%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF%E7%94%9F%E6%80%81%E4%BC%9A%E5%8F%91%E7%94%9F%E4%BA%9B%E4%BB%80%E4%B9%88%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    特别放送   2019 年，容器技术生态会发生些什么？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%89%B9%E5%88%AB%E6%94%BE%E9%80%81%20-%20%E5%9F%BA%E4%BA%8E%20Kubernetes%20%E7%9A%84%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E7%AE%A1%E7%90%86%EF%BC%8C%E5%88%B0%E5%BA%95%E5%BA%94%E8%AF%A5%E6%80%8E%E4%B9%88%E5%81%9A%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    特别放送   基于 Kubernetes 的云原生应用管理，到底应该怎么做？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%BB%93%E6%9D%9F%E8%AF%AD%20-%20Kubernetes%EF%BC%9A%E8%B5%A2%E5%BC%80%E5%8F%91%E8%80%85%E8%B5%A2%E5%A4%A9%E4%B8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    结束语   Kubernetes：赢开发者赢天下
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%BB%93%E8%AF%BE%E6%B5%8B%E8%AF%95-%E8%BF%99%E4%BA%9BKubernetes%E7%9A%84%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%8C%E4%BD%A0%E9%83%BD%E6%8E%8C%E6%8F%A1%E4%BA%86%E5%90%97%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    结课测试 这些Kubernetes的相关知识，你都掌握了吗？
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E4%BA%91%E8%AE%A1%E7%AE%97/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E4%BA%91%E8%AE%A1%E7%AE%97/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    深入浅出云计算
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E6%B5%8B%E8%AF%95%E8%AF%BE/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E6%B5%8B%E8%AF%95%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    程序员的测试课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    网络排查案例课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E9%AB%98%E6%89%8B%E8%AF%BE/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E9%AB%98%E6%89%8B%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    自动化测试高手课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E8%AF%B4%E9%80%8F%E6%95%8F%E6%8D%B7/%E8%AF%B4%E9%80%8F%E6%95%8F%E6%8D%B7/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    说透敏捷
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E8%B5%B5%E6%88%90%E7%9A%84%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB%E7%AE%A1%E7%90%86%E8%AF%BE/%E8%B5%B5%E6%88%90%E7%9A%84%E8%BF%90%E7%BB%B4%E4%BD%93%E7%B3%BB%E7%AE%A1%E7%90%86%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    赵成的运维体系管理课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E8%BD%AF%E4%BB%B6%E6%B5%8B%E8%AF%9552%E8%AE%B2/%E8%BD%AF%E4%BB%B6%E6%B5%8B%E8%AF%9552%E8%AE%B2/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    软件测试52讲
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E8%BF%90%E7%BB%B4%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/%E8%BF%90%E7%BB%B4%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    运维监控系统实战笔记
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E9%9B%B6%E5%9F%BA%E7%A1%80%E6%8B%BF%E4%B8%8B%E4%BA%91%E5%8E%9F%E7%94%9FCKA%E8%AE%A4%E8%AF%81/%E9%9B%B6%E5%9F%BA%E7%A1%80%E6%8B%BF%E4%B8%8B%E4%BA%91%E5%8E%9F%E7%94%9FCKA%E8%AE%A4%E8%AF%81/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    零基础拿下云原生CKA认证
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/%E9%AB%98%E6%A5%BC%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    高楼的性能工程实战课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      思考题
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>20   深入理解StatefulSet（三）：有状态应用实践</h1>

<p>你好，我是张磊。今天我和你分享的主题是：深入理解StatefulSet之有状态应用实践。</p>
<p>在前面的两篇文章中，我详细讲解了StatefulSet的工作原理，以及处理拓扑状态和存储状态的方法。而在今天这篇文章中，我将通过一个实际的例子，再次为你深入解读一下部署一个StatefulSet的完整流程。</p>
<p>今天我选择的实例是部署一个MySQL集群，这也是Kubernetes官方文档里的一个经典案例。但是，很多工程师都曾向我吐槽说这个例子“完全看不懂”。</p>
<p>其实，这样的吐槽也可以理解：相比于Etcd、Cassandra等“原生”就考虑了分布式需求的项目，MySQL以及很多其他的数据库项目，在分布式集群的搭建上并不友好，甚至有点“原始”。</p>
<p>所以，这次我就直接选择了这个具有挑战性的例子，和你分享如何使用StatefulSet将它的集群搭建过程“容器化”。</p>
<blockquote>
<p>备注：在开始实践之前，请确保我们之前一起部署的那个Kubernetes集群还是可用的，并且网络插件和存储插件都能正常运行。具体的做法，请参考第11篇文章<a href="https://time.geekbang.org/column/article/39724">《从0到1：搭建一个完整的Kubernetes集群》</a>的内容。</p>
</blockquote>
<p>首先，用自然语言来描述一下我们想要部署的“有状态应用”。</p>
<ol>
<li>是一个“主从复制”（Maser-Slave Replication）的MySQL集群；</li>
<li>有1个主节点（Master）；</li>
<li>有多个从节点（Slave）；</li>
<li>从节点需要能水平扩展；</li>
<li>所有的写操作，只能在主节点上执行；</li>
<li>读操作可以在所有节点上执行。</li>
</ol>
<p>这就是一个非常典型的主从模式的MySQL集群了。我们可以把上面描述的“有状态应用”的需求，通过一张图来表示。</p>
<p><img alt="" src="https://static001.geekbang.org/resource/image/bb/02/bb2d7f03443392ca40ecde6b1a91c002.png?wh=785%2A735" /><br />
在常规环境里，部署这样一个主从模式的MySQL集群的主要难点在于：如何让从节点能够拥有主节点的数据，即：如何配置主（Master）从（Slave）节点的复制与同步。</p>
<p>所以，在安装好MySQL的Master节点之后，你需要做的第一步工作，就是<strong>通过XtraBackup将Master节点的数据备份到指定目录。</strong></p>
<blockquote>
<p>备注：XtraBackup是业界主要使用的开源MySQL备份和恢复工具。</p>
</blockquote>
<p>这一步会自动在目标目录里生成一个备份信息文件，名叫：xtrabackup_binlog_info。这个文件一般会包含如下两个信息：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>$ cat xtrabackup_binlog_info
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>TheMaster-bin.000001     481
</code></pre></div>
<p>这两个信息会在接下来配置Slave节点的时候用到。</p>
<p><strong>第二步：配置Slave节点</strong>。Slave节点在第一次启动前，需要先把Master节点的备份数据，连同备份信息文件，一起拷贝到自己的数据目录（/var/lib/mysql）下。然后，我们执行这样一句SQL：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>TheSlave|mysql&gt; CHANGE MASTER TO
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>                MASTER_HOST=&#39;$masterip&#39;,
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>                MASTER_USER=&#39;xxx&#39;,
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>                MASTER_PASSWORD=&#39;xxx&#39;,
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>                MASTER_LOG_FILE=&#39;TheMaster-bin.000001&#39;,
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>                MASTER_LOG_POS=481;
</code></pre></div>
<p>其中，MASTER_LOG_FILE和MASTER_LOG_POS，就是该备份对应的二进制日志（Binary Log）文件的名称和开始的位置（偏移量），也正是xtrabackup_binlog_info文件里的那两部分内容（即：TheMaster-bin.000001和481）。</p>
<p><strong>第三步，启动Slave节点</strong>。在这一步，我们需要执行这样一句SQL：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>TheSlave|mysql&gt; START SLAVE;
</code></pre></div>
<p>这样，Slave节点就启动了。它会使用备份信息文件中的二进制日志文件和偏移量，与主节点进行数据同步。</p>
<p><strong>第四步，在这个集群中添加更多的Slave节点</strong>。</p>
<p>需要注意的是，新添加的Slave节点的备份数据，来自于已经存在的Slave节点。</p>
<p>所以，在这一步，我们需要将Slave节点的数据备份在指定目录。而这个备份操作会自动生成另一种备份信息文件，名叫：xtrabackup_slave_info。同样地，这个文件也包含了MASTER_LOG_FILE和MASTER_LOG_POS两个字段。</p>
<p>然后，我们就可以执行跟前面一样的“CHANGE MASTER TO”和“START SLAVE” 指令，来初始化并启动这个新的Slave节点了。</p>
<p>通过上面的叙述，我们不难看到，<strong>将部署MySQL集群的流程迁移到Kubernetes项目上，需要能够“容器化”地解决下面的“三座大山”：</strong></p>
<ol>
<li>Master节点和Slave节点需要有不同的配置文件（即：不同的my.cnf）；</li>
<li>Master节点和Slave节点需要能够传输备份信息文件；</li>
<li>在Slave节点第一次启动之前，需要执行一些初始化SQL操作；</li>
</ol>
<p>而由于MySQL本身同时拥有拓扑状态（主从节点的区别）和存储状态（MySQL保存在本地的数据），我们自然要通过StatefulSet来解决这“三座大山”的问题。</p>
<p><strong>其中，“第一座大山：Master节点和Slave节点需要有不同的配置文件”，很容易处理</strong>：我们只需要给主从节点分别准备两份不同的MySQL配置文件，然后根据Pod的序号（Index）挂载进去即可。</p>
<p>正如我在前面文章中介绍过的，这样的配置文件信息，应该保存在ConfigMap里供Pod使用。它的定义如下所示：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>apiVersion: v1
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>kind: ConfigMap
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>metadata:
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>  name: mysql
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>  labels:
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    app: mysql
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>data:
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>  master.cnf: |
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>    # 主节点MySQL的配置文件
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    [mysqld]
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>    log-bin
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>  slave.cnf: |
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>    # 从节点MySQL的配置文件
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>    [mysqld]
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>    super-read-only
</code></pre></div>
<p>在这里，我们定义了master.cnf和slave.cnf两个MySQL的配置文件。</p>
<ul>
<li>master.cnf开启了log-bin，即：使用二进制日志文件的方式进行主从复制，这是一个标准的设置。</li>
<li>slave.cnf的开启了super-read-only，代表的是从节点会拒绝除了主节点的数据同步操作之外的所有写操作，即：它对用户是只读的。</li>
</ul>
<p>而上述ConfigMap定义里的data部分，是Key-Value格式的。比如，master.cnf就是这份配置数据的Key，而“|”后面的内容，就是这份配置数据的Value。这份数据将来挂载进Master节点对应的Pod后，就会在Volume目录里生成一个叫作master.cnf的文件。</p>
<blockquote>
<p>备注：如果你对ConfigMap的用法感到陌生的话，可以稍微复习一下第15篇文章<a href="https://time.geekbang.org/column/article/40466">《深入解析Pod对象（二）：使用进阶》</a>中，我讲解Secret对象部分的内容。因为，ConfigMap跟Secret，无论是使用方法还是实现原理，几乎都是一样的。</p>
</blockquote>
<p>接下来，我们需要创建两个Service来供StatefulSet以及用户使用。这两个Service的定义如下所示：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>apiVersion: v1
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>kind: Service
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>metadata:
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>  name: mysql
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>  labels:
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    app: mysql
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>spec:
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>  ports:
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>  - name: mysql
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    port: 3306
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>  clusterIP: None
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>  selector:
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    app: mysql
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>---
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>apiVersion: v1
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>kind: Service
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>metadata:
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>  name: mysql-read
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>  labels:
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>    app: mysql
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>spec:
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>  ports:
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>  - name: mysql
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>    port: 3306
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>  selector:
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>    app: mysql
</code></pre></div>
<p>可以看到，这两个Service都代理了所有携带app=mysql标签的Pod，也就是所有的MySQL Pod。端口映射都是用Service的3306端口对应Pod的3306端口。</p>
<p>不同的是，第一个名叫“mysql”的Service是一个Headless Service（即：clusterIP= None）。所以它的作用，是通过为Pod分配DNS记录来固定它的拓扑状态，比如“mysql-0.mysql”和“mysql-1.mysql”这样的DNS名字。其中，编号为0的节点就是我们的主节点。</p>
<p>而第二个名叫“mysql-read”的Service，则是一个常规的Service。</p>
<p>并且我们规定，所有用户的读请求，都必须访问第二个Service被自动分配的DNS记录，即：“mysql-read”（当然，也可以访问这个Service的VIP）。这样，读请求就可以被转发到任意一个MySQL的主节点或者从节点上。</p>
<blockquote>
<p>备注：Kubernetes中的所有Service、Pod对象，都会被自动分配同名的DNS记录。具体细节，我会在后面Service部分做重点讲解。</p>
</blockquote>
<p>而所有用户的写请求，则必须直接以DNS记录的方式访问到MySQL的主节点，也就是：“mysql-0.mysql“这条DNS记录。</p>
<p>接下来，我们再一起解决“第二座大山：Master节点和Slave节点需要能够传输备份文件”的问题。</p>
<p><strong>翻越这座大山的思路，我比较推荐的做法是：先搭建框架，再完善细节。其中，Pod部分如何定义，是完善细节时的重点。</strong></p>
<p><strong>所以首先，我们先为StatefulSet对象规划一个大致的框架，如下图所示：</strong></p>
<p><img alt="" src="https://static001.geekbang.org/resource/image/16/09/16aa2e42034830a0e64120ecc330a509.png?wh=612%2A1058" /></p>
<p>在这一步，我们可以先为StatefulSet定义一些通用的字段。</p>
<p>比如：selector表示，这个StatefulSet要管理的Pod必须携带app=mysql标签；它声明要使用的Headless Service的名字是：mysql。</p>
<p>这个StatefulSet的replicas值是3，表示它定义的MySQL集群有三个节点：一个Master节点，两个Slave节点。</p>
<p>可以看到，StatefulSet管理的“有状态应用”的多个实例，也都是通过同一份Pod模板创建出来的，使用的是同一个Docker镜像。这也就意味着：如果你的应用要求不同节点的镜像不一样，那就不能再使用StatefulSet了。对于这种情况，应该考虑我后面会讲解到的Operator。</p>
<p>除了这些基本的字段外，作为一个有存储状态的MySQL集群，StatefulSet还需要管理存储状态。所以，我们需要通过volumeClaimTemplate（PVC模板）来为每个Pod定义PVC。比如，这个PVC模板的resources.requests.strorage指定了存储的大小为10 GiB；ReadWriteOnce指定了该存储的属性为可读写，并且一个PV只允许挂载在一个宿主机上。将来，这个PV对应的的Volume就会充当MySQL Pod的存储数据目录。</p>
<p><strong>然后，我们来重点设计一下这个StatefulSet的Pod模板，也就是template字段。</strong></p>
<p>由于StatefulSet管理的Pod都来自于同一个镜像，这就要求我们在编写Pod时，一定要保持清醒，用“人格分裂”的方式进行思考：</p>
<ol>
<li>如果这个Pod是Master节点，我们要怎么做；</li>
<li>如果这个Pod是Slave节点，我们又要怎么做。</li>
</ol>
<p>想清楚这两个问题，我们就可以按照Pod的启动过程来一步步定义它们了。</p>
<p><strong>第一步：从ConfigMap中，获取MySQL的Pod对应的配置文件。</strong></p>
<p>为此，我们需要进行一个初始化操作，根据节点的角色是Master还是Slave节点，为Pod分配对应的配置文件。此外，MySQL还要求集群里的每个节点都有一个唯一的ID文件，名叫server-id.cnf。</p>
<p>而根据我们已经掌握的Pod知识，这些初始化操作显然适合通过InitContainer来完成。所以，我们首先定义了一个InitContainer，如下所示：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>      ...
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>      # template.spec
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>      initContainers:
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>      - name: init-mysql
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>        image: mysql:5.7
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>        command:
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>        - bash
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>        - &quot;-c&quot;
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>        - |
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>          set -ex
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>          # 从Pod的序号，生成server-id
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>          ordinal=${BASH_REMATCH[1]}
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>          echo [mysqld] &gt; /mnt/conf.d/server-id.cnf
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>          # 由于server-id=0有特殊含义，我们给ID加一个100来避开它
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>          echo server-id=$((100 + $ordinal)) &gt;&gt; /mnt/conf.d/server-id.cnf
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>          # 如果Pod序号是0，说明它是Master节点，从ConfigMap里把Master的配置文件拷贝到/mnt/conf.d/目录；
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>          # 否则，拷贝Slave的配置文件
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>          if [[ $ordinal -eq 0 ]]; then
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>            cp /mnt/config-map/master.cnf /mnt/conf.d/
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>          else
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>            cp /mnt/config-map/slave.cnf /mnt/conf.d/
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>          fi
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>        volumeMounts:
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>        - name: conf
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>          mountPath: /mnt/conf.d
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>        - name: config-map
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>          mountPath: /mnt/config-map
</code></pre></div>
<p>在这个名叫init-mysql的InitContainer的配置中，它从Pod的hostname里，读取到了Pod的序号，以此作为MySQL节点的server-id。</p>
<p>然后，init-mysql通过这个序号，判断当前Pod到底是Master节点（即：序号为0）还是Slave节点（即：序号不为0），从而把对应的配置文件从/mnt/config-map目录拷贝到/mnt/conf.d/目录下。</p>
<p>其中，文件拷贝的源目录/mnt/config-map，正是ConfigMap在这个Pod的Volume，如下所示：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>      ...
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>      # template.spec
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>      volumes:
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>      - name: conf
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>        emptyDir: {}
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>      - name: config-map
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>        configMap:
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>          name: mysql
</code></pre></div>
<p>通过这个定义，init-mysql在声明了挂载config-map这个Volume之后，ConfigMap里保存的内容，就会以文件的方式出现在它的/mnt/config-map目录当中。</p>
<p>而文件拷贝的目标目录，即容器里的/mnt/conf.d/目录，对应的则是一个名叫conf的、emptyDir类型的Volume。基于Pod Volume共享的原理，当InitContainer复制完配置文件退出后，后面启动的MySQL容器只需要直接声明挂载这个名叫conf的Volume，它所需要的.cnf配置文件已经出现在里面了。这跟我们之前介绍的Tomcat和WAR包的处理方法是完全一样的。</p>
<p><strong>第二步：在Slave Pod启动前，从Master或者其他Slave Pod里拷贝数据库数据到自己的目录下。</strong></p>
<p>为了实现这个操作，我们就需要再定义第二个InitContainer，如下所示：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>      ...
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>      # template.spec.initContainers
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>      - name: clone-mysql
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>        image: gcr.io/google-samples/xtrabackup:1.0
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>        command:
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>        - bash
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>        - &quot;-c&quot;
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>        - |
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>          set -ex
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>          # 拷贝操作只需要在第一次启动时进行，所以如果数据已经存在，跳过
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>          [[ -d /var/lib/mysql/mysql ]] &amp;&amp; exit 0
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>          # Master节点(序号为0)不需要做这个操作
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>          ordinal=${BASH_REMATCH[1]}
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>          [[ $ordinal -eq 0 ]] &amp;&amp; exit 0
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>          # 使用ncat指令，远程地从前一个节点拷贝数据到本地
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>          ncat --recv-only mysql-$(($ordinal-1)).mysql 3307 | xbstream -x -C /var/lib/mysql
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>          # 执行--prepare，这样拷贝来的数据就可以用作恢复了
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>          xtrabackup --prepare --target-dir=/var/lib/mysql
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>        volumeMounts:
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>        - name: data
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>          mountPath: /var/lib/mysql
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>          subPath: mysql
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>        - name: conf
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>          mountPath: /etc/mysql/conf.d
</code></pre></div>
<p>在这个名叫clone-mysql的InitContainer里，我们使用的是xtrabackup镜像（它里面安装了xtrabackup工具）。</p>
<p>而在它的启动命令里，我们首先做了一个判断。即：当初始化所需的数据（/var/lib/mysql/mysql 目录）已经存在，或者当前Pod是Master节点的时候，不需要做拷贝操作。</p>
<p>接下来，clone-mysql会使用Linux自带的ncat指令，向DNS记录为“mysql-&lt;当前序号减一&gt;.mysql”的Pod，也就是当前Pod的前一个Pod，发起数据传输请求，并且直接用xbstream指令将收到的备份数据保存在/var/lib/mysql目录下。</p>
<blockquote>
<p>备注：3307是一个特殊端口，运行着一个专门负责备份MySQL数据的辅助进程。我们后面马上会讲到它。</p>
</blockquote>
<p>当然，这一步你可以随意选择用自己喜欢的方法来传输数据。比如，用scp或者rsync，都没问题。</p>
<p>你可能已经注意到，这个容器里的/var/lib/mysql目录，<strong>实际上正是一个名为data的PVC</strong>，即：我们在前面声明的持久化存储。</p>
<p>这就可以保证，哪怕宿主机宕机了，我们数据库的数据也不会丢失。更重要的是，由于Pod Volume是被Pod里的容器共享的，所以后面启动的MySQL容器，就可以把这个Volume挂载到自己的/var/lib/mysql目录下，直接使用里面的备份数据进行恢复操作。</p>
<p>不过，clone-mysql容器还要对/var/lib/mysql目录，执行一句xtrabackup --prepare操作，目的是让拷贝来的数据进入一致性状态，这样，这些数据才能被用作数据恢复。</p>
<p>至此，我们就通过InitContainer完成了对“主、从节点间备份文件传输”操作的处理过程，也就是翻越了“第二座大山”。</p>
<p>接下来，我们可以开始定义MySQL容器,启动MySQL服务了。由于StatefulSet里的所有Pod都来自用同一个Pod模板，所以我们还要“人格分裂”地去思考：这个MySQL容器的启动命令，在Master和Slave两种情况下有什么不同。</p>
<p>有了Docker镜像，在Pod里声明一个Master角色的MySQL容器并不是什么困难的事情：直接执行MySQL启动命令即可。</p>
<p>但是，如果这个Pod是一个第一次启动的Slave节点，在执行MySQL启动命令之前，它就需要使用前面InitContainer拷贝来的备份数据进行初始化。</p>
<p>可是，别忘了，<strong>容器是一个单进程模型。</strong></p>
<p>所以，一个Slave角色的MySQL容器启动之前，谁能负责给它执行初始化的SQL语句呢？</p>
<p>这就是我们需要解决的“第三座大山”的问题，即：如何在Slave节点的MySQL容器第一次启动之前，执行初始化SQL。</p>
<p>你可能已经想到了，我们可以为这个MySQL容器额外定义一个sidecar容器，来完成这个操作，它的定义如下所示：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>      ...
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>      # template.spec.containers
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>      - name: xtrabackup
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>        image: gcr.io/google-samples/xtrabackup:1.0
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>        ports:
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>        - name: xtrabackup
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>          containerPort: 3307
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>        command:
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>        - bash
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>        - &quot;-c&quot;
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>        - |
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>          set -ex
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>          cd /var/lib/mysql
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>          # 从备份信息文件里读取MASTER_LOG_FILEM和MASTER_LOG_POS这两个字段的值，用来拼装集群初始化SQL
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>          if [[ -f xtrabackup_slave_info ]]; then
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>            # 如果xtrabackup_slave_info文件存在，说明这个备份数据来自于另一个Slave节点。这种情况下，XtraBackup工具在备份的时候，就已经在这个文件里自动生成了&quot;CHANGE MASTER TO&quot; SQL语句。所以，我们只需要把这个文件重命名为change_master_to.sql.in，后面直接使用即可
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>            mv xtrabackup_slave_info change_master_to.sql.in
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>            # 所以，也就用不着xtrabackup_binlog_info了
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>            rm -f xtrabackup_binlog_info
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>          elif [[ -f xtrabackup_binlog_info ]]; then
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>            # 如果只存在xtrabackup_binlog_inf文件，那说明备份来自于Master节点，我们就需要解析这个备份信息文件，读取所需的两个字段的值
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>            [[ `cat xtrabackup_binlog_info` =~ ^(.*?)[[:space:]]+(.*?)$ ]] || exit 1
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>            rm xtrabackup_binlog_info
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>            # 把两个字段的值拼装成SQL，写入change_master_to.sql.in文件
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>            echo &quot;CHANGE MASTER TO MASTER_LOG_FILE=&#39;${BASH_REMATCH[1]}&#39;,\
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>                  MASTER_LOG_POS=${BASH_REMATCH[2]}&quot; &gt; change_master_to.sql.in
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>          fi
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>          # 如果change_master_to.sql.in，就意味着需要做集群初始化工作
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>          if [[ -f change_master_to.sql.in ]]; then
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>            # 但一定要先等MySQL容器启动之后才能进行下一步连接MySQL的操作
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>            echo &quot;Waiting for mysqld to be ready (accepting connections)&quot;
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>            until mysql -h 127.0.0.1 -e &quot;SELECT 1&quot;; do sleep 1; done
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a>            echo &quot;Initializing replication from clone position&quot;
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>            # 将文件change_master_to.sql.in改个名字，防止这个Container重启的时候，因为又找到了change_master_to.sql.in，从而重复执行一遍这个初始化流程
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>            mv change_master_to.sql.in change_master_to.sql.orig
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>            # 使用change_master_to.sql.orig的内容，也是就是前面拼装的SQL，组成一个完整的初始化和启动Slave的SQL语句
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>            mysql -h 127.0.0.1 &lt;&lt;EOF
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a>          $(&lt;change_master_to.sql.orig),
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>            MASTER_HOST=&#39;mysql-0.mysql&#39;,
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a>            MASTER_USER=&#39;root&#39;,
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>            MASTER_PASSWORD=&#39;&#39;,
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a>            MASTER_CONNECT_RETRY=10;
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a>          START SLAVE;
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a>          EOF
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a>          fi
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a>
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a>          # 使用ncat监听3307端口。它的作用是，在收到传输请求的时候，直接执行&quot;xtrabackup --backup&quot;命令，备份MySQL的数据并发送给请求者
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a>          exec ncat --listen --keep-open --send-only --max-conns=1 3307 -c \
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a>            &quot;xtrabackup --backup --slave-info --stream=xbstream --host=127.0.0.1 --user=root&quot;
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a>        volumeMounts:
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a>        - name: data
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a>          mountPath: /var/lib/mysql
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a>          subPath: mysql
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a>        - name: conf
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a>          mountPath: /etc/mysql/conf.d
</code></pre></div>
<p>可以看到，<strong>在这个名叫xtrabackup的sidecar容器的启动命令里，其实实现了两部分工作。</strong></p>
<p><strong>第一部分工作，当然是MySQL节点的初始化工作</strong>。这个初始化需要使用的SQL，是sidecar容器拼装出来、保存在一个名为change_master_to.sql.in的文件里的，具体过程如下所示：</p>
<p>sidecar容器首先会判断当前Pod的/var/lib/mysql目录下，是否有xtrabackup_slave_info这个备份信息文件。</p>
<ul>
<li>如果有，则说明这个目录下的备份数据是由一个Slave节点生成的。这种情况下，XtraBackup工具在备份的时候，就已经在这个文件里自动生成了"CHANGE MASTER TO" SQL语句。所以，我们只需要把这个文件重命名为change_master_to.sql.in，后面直接使用即可。</li>
<li>如果没有xtrabackup_slave_info文件、但是存在xtrabackup_binlog_info文件，那就说明备份数据来自于Master节点。这种情况下，sidecar容器就需要解析这个备份信息文件，读取MASTER_LOG_FILE和MASTER_LOG_POS这两个字段的值，用它们拼装出初始化SQL语句，然后把这句SQL写入到change_master_to.sql.in文件中。</li>
</ul>
<p>接下来，sidecar容器就可以执行初始化了。从上面的叙述中可以看到，只要这个change_master_to.sql.in文件存在，那就说明接下来需要进行集群初始化操作。</p>
<p>所以，这时候，sidecar容器只需要读取并执行change_master_to.sql.in里面的“CHANGE MASTER TO”指令，再执行一句START SLAVE命令，一个Slave节点就被成功启动了。</p>
<blockquote>
<p>需要注意的是：Pod里的容器并没有先后顺序，所以在执行初始化SQL之前，必须先执行一句SQL（select 1）来检查一下MySQL服务是否已经可用。</p>
</blockquote>
<p>当然，上述这些初始化操作完成后，我们还要删除掉前面用到的这些备份信息文件。否则，下次这个容器重启时，就会发现这些文件存在，所以又会重新执行一次数据恢复和集群初始化的操作，这是不对的。</p>
<p>同理，change_master_to.sql.in在使用后也要被重命名，以免容器重启时因为发现这个文件存在又执行一遍初始化。</p>
<p><strong>在完成MySQL节点的初始化后，这个sidecar容器的第二个工作，则是启动一个数据传输服务。</strong></p>
<p>具体做法是：sidecar容器会使用ncat命令启动一个工作在3307端口上的网络发送服务。一旦收到数据传输请求时，sidecar容器就会调用xtrabackup --backup指令备份当前MySQL的数据，然后把这些备份数据返回给请求者。这就是为什么我们在InitContainer里定义数据拷贝的时候，访问的是“上一个MySQL节点”的3307端口。</p>
<p>值得一提的是，由于sidecar容器和MySQL容器同处于一个Pod里，所以它是直接通过Localhost来访问和备份MySQL容器里的数据的，非常方便。</p>
<p>同样地，我在这里举例用的只是一种备份方法而已，你完全可以选择其他自己喜欢的方案。比如，你可以使用innobackupex命令做数据备份和准备，它的使用方法几乎与本文的备份方法一样。</p>
<p>至此，我们也就翻越了“第三座大山”，完成了Slave节点第一次启动前的初始化工作。</p>
<p>扳倒了这“三座大山”后，我们终于可以定义Pod里的主角，MySQL容器了。有了前面这些定义和初始化工作，MySQL容器本身的定义就非常简单了，如下所示：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>      ...
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>      # template.spec
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>      containers:
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>      - name: mysql
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>        image: mysql:5.7
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>        env:
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>        - name: MYSQL_ALLOW_EMPTY_PASSWORD
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>          value: &quot;1&quot;
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>        ports:
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>        - name: mysql
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>          containerPort: 3306
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>        volumeMounts:
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>        - name: data
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>          mountPath: /var/lib/mysql
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>          subPath: mysql
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>        - name: conf
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>          mountPath: /etc/mysql/conf.d
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>        resources:
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>          requests:
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>            cpu: 500m
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>            memory: 1Gi
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>        livenessProbe:
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>          exec:
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>            command: [&quot;mysqladmin&quot;, &quot;ping&quot;]
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>          initialDelaySeconds: 30
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>          periodSeconds: 10
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>          timeoutSeconds: 5
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>        readinessProbe:
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>          exec:
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>            # 通过TCP连接的方式进行健康检查
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>            command: [&quot;mysql&quot;, &quot;-h&quot;, &quot;127.0.0.1&quot;, &quot;-e&quot;, &quot;SELECT 1&quot;]
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>          initialDelaySeconds: 5
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>          periodSeconds: 2
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a>          timeoutSeconds: 1
</code></pre></div>
<p>在这个容器的定义里，我们使用了一个标准的MySQL 5.7 的官方镜像。它的数据目录是/var/lib/mysql，配置文件目录是/etc/mysql/conf.d。</p>
<p>这时候，你应该能够明白，如果MySQL容器是Slave节点的话，它的数据目录里的数据，就来自于InitContainer从其他节点里拷贝而来的备份。它的配置文件目录/etc/mysql/conf.d里的内容，则来自于ConfigMap对应的Volume。而它的初始化工作，则是由同一个Pod里的sidecar容器完成的。这些操作，正是我刚刚为你讲述的大部分内容。</p>
<p>另外，我们为它定义了一个livenessProbe，通过mysqladmin ping命令来检查它是否健康；还定义了一个readinessProbe，通过查询SQL（select 1）来检查MySQL服务是否可用。当然，凡是readinessProbe检查失败的MySQL Pod，都会从Service里被摘除掉。</p>
<p>至此，一个完整的主从复制模式的MySQL集群就定义完了。</p>
<p>现在，我们就可以使用kubectl命令，尝试运行一下这个StatefulSet了。</p>
<p><strong>首先，我们需要在Kubernetes集群里创建满足条件的PV</strong>。如果你使用的是我们在第11篇文章《<a href="https://time.geekbang.org/column/article/39724">从0到1：搭建一个完整的Kubernetes集群》</a>里部署的Kubernetes集群的话，你可以按照如下方式使用存储插件Rook：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>$ kubectl create -f rook-storage.yaml
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>$ cat rook-storage.yaml
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>apiVersion: ceph.rook.io/v1beta1
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>kind: Pool
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>metadata:
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>  name: replicapool
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>  namespace: rook-ceph
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>spec:
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>  replicated:
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>    size: 3
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>---
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>apiVersion: storage.k8s.io/v1
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>kind: StorageClass
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>metadata:
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>  name: rook-ceph-block
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>provisioner: ceph.rook.io/block
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>parameters:
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>  pool: replicapool
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>  clusterNamespace: rook-ceph
</code></pre></div>
<p>在这里，我用到了StorageClass来完成这个操作。它的作用，是自动地为集群里存在的每一个PVC，调用存储插件（Rook）创建对应的PV，从而省去了我们手动创建PV的机械劳动。我在后续讲解容器存储的时候，会再详细介绍这个机制。</p>
<blockquote>
<p>备注：在使用Rook的情况下，mysql-statefulset.yaml里的volumeClaimTemplates字段需要加上声明storageClassName=rook-ceph-block，才能使用到这个Rook提供的持久化存储。</p>
</blockquote>
<p><strong>然后，我们就可以创建这个StatefulSet了</strong>，如下所示：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>$ kubectl create -f mysql-statefulset.yaml
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>$ kubectl get pod -l app=mysql
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>NAME      READY     STATUS    RESTARTS   AGE
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>mysql-0   2/2       Running   0          2m
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>mysql-1   2/2       Running   0          1m
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>mysql-2   2/2       Running   0          1m
</code></pre></div>
<p>可以看到，StatefulSet启动成功后，会有三个Pod运行。</p>
<p><strong>接下来，我们可以尝试向这个MySQL集群发起请求，执行一些SQL操作来验证它是否正常：</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>$ kubectl run mysql-client --image=mysql:5.7 -i --rm --restart=Never --\
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>  mysql -h mysql-0.mysql &lt;&lt;EOF
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>CREATE DATABASE test;
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>CREATE TABLE test.messages (message VARCHAR(250));
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>INSERT INTO test.messages VALUES (&#39;hello&#39;);
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>EOF
</code></pre></div>
<p>如上所示，我们通过启动一个容器，使用MySQL client执行了创建数据库和表、以及插入数据的操作。需要注意的是，我们连接的MySQL的地址必须是mysql-0.mysql（即：Master节点的DNS记录）。因为，只有Master节点才能处理写操作。</p>
<p>而通过连接mysql-read这个Service，我们就可以用SQL进行读操作，如下所示：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>$ kubectl run mysql-client --image=mysql:5.7 -i -t --rm --restart=Never --\
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a> mysql -h mysql-read -e &quot;SELECT * FROM test.messages&quot;
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>Waiting for pod default/mysql-client to be running, status is Pending, pod ready: false
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>+---------+
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>| message |
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>+---------+
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>| hello   |
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>+---------+
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>pod &quot;mysql-client&quot; deleted
</code></pre></div>
<p>在有了StatefulSet以后，你就可以像Deployment那样，非常方便地扩展这个MySQL集群，比如：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>$ kubectl scale statefulset mysql  --replicas=5
</code></pre></div>
<p>这时候，你就会发现新的Slave Pod mysql-3和mysql-4被自动创建了出来。</p>
<p>而如果你像如下所示的这样，直接连接mysql-3.mysql，即mysql-3这个Pod的DNS名字来进行查询操作：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>$ kubectl run mysql-client --image=mysql:5.7 -i -t --rm --restart=Never --\
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>  mysql -h mysql-3.mysql -e &quot;SELECT * FROM test.messages&quot;
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>Waiting for pod default/mysql-client to be running, status is Pending, pod ready: false
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>+---------+
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>| message |
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>+---------+
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>| hello   |
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>+---------+
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>pod &quot;mysql-client&quot; deleted
</code></pre></div>
<p>就会看到，从StatefulSet为我们新创建的mysql-3上，同样可以读取到之前插入的记录。也就是说，我们的数据备份和恢复，都是有效的。</p>
<h2 id="_1">总结</h2>
<p>在今天这篇文章中，我以MySQL集群为例，和你详细分享了一个实际的StatefulSet的编写过程。这个YAML文件的<a href="https://kubernetes.io/docs/tasks/run-application/run-replicated-stateful-application/#statefulset">链接在这里</a>，希望你能多花一些时间认真消化。</p>
<p>在这个过程中，有以下几个关键点（坑）特别值得你注意和体会。</p>
<ol>
<li>“人格分裂”：在解决需求的过程中，一定要记得思考，该Pod在扮演不同角色时的不同操作。</li>
<li>“阅后即焚”：很多“有状态应用”的节点，只是在第一次启动的时候才需要做额外处理。所以，在编写YAML文件时，你一定要考虑“容器重启”的情况，不要让这一次的操作干扰到下一次的容器启动。</li>
<li>“容器之间平等无序”：除非是InitContainer，否则一个Pod里的多个容器之间，是完全平等的。所以，你精心设计的sidecar，绝不能对容器的顺序做出假设，否则就需要进行前置检查。</li>
</ol>
<p>最后，相信你也已经能够理解，StatefulSet其实是一种特殊的Deployment，只不过这个“Deployment”的每个Pod实例的名字里，都携带了一个唯一并且固定的编号。这个编号的顺序，固定了Pod的拓扑关系；这个编号对应的DNS记录，固定了Pod的访问方式；这个编号对应的PV，绑定了Pod与持久化存储的关系。所以，当Pod被删除重建时，这些“状态”都会保持不变。</p>
<p>而一旦你的应用没办法通过上述方式进行状态的管理，那就代表了StatefulSet已经不能解决它的部署问题了。这时候，我后面讲到的Operator，可能才是一个更好的选择。</p>
<h2 id="_2">思考题</h2>
<p>如果我们现在的需求是：所有的读请求，只由Slave节点处理；所有的写请求，只由Master节点处理。那么，你需要在今天这篇文章的基础上再做哪些改动呢？</p>
<p>感谢你的收听，欢迎你给我留言，也欢迎分享给更多的朋友一起阅读。</p>
<div><strong>精选留言（15）</strong></div>
<ul>
<li><span>Vincen</span> 👍（127） 💬（13）<p>因为是通过一个statefulset来实现的 感觉太复杂了，master和slave做成两个statefulset就非常简单了</p>2018-10-08</li><br/><li><span>DJH</span> 👍（46） 💬（5）<p>有一点我还是没想通，为啥数据复制操作要用sidecar容器来处理，而不用mysql主容器来一并解决。如果把数据复制操作和启动mysql服务一并写到同一个sh -c后面，这样算不算一个单一进程呢？</p>2018-10-10</li><br/><li><span>sam700000</span> 👍（39） 💬（1）<p>通过这节我才更清晰理解了，kubernetes最小的管理单位是pod的概念，把思维从容器这层抽出来。然后也更清楚的理解了statefulset实现有状态，就是把特定的状态配置绑定在某个对象名称上面，然后通过之前说的控制循环不断的维护这个对象的特性，只要这写特定对象和它们各自绑定的状态配置不变就实现了有状态的应用部署和维护。果然实践出真知👍</p>2019-08-14</li><br/><li><span>彭锐</span> 👍（36） 💬（3）<p>这样的有状态应用有个约束，pod标识一旦确定，角色就确定了。但实际应用中，不能有这样的约束，主挂了，要有一个从升主。这就要求至少有选主机制，所有的配置文件也不能依赖id确定角色。
这怎么玩呢？operater吗？operater可以看成一个特定应用的sre保姆吗？</p>2018-10-18</li><br/><li><span>侯操宇</span> 👍（16） 💬（3）<p>老师，我发现在initContainers 的ini-mysql容器中，执行的只是简单的文件拷贝工作，但镜像却用的是mysql的镜像，可以用其他镜像取代吗？镜像的选择有什么讲究吗？</p>2018-10-11</li><br/><li><span>风轨</span> 👍（15） 💬（1）<p>集群中的master&#47;slave节点关系不对等。Service是通过label来绑定pod的，一个statefulSet中所有pod的label都是一样的，无法区分，因此service也是无法区别绑定slave pod的。所以答案应该是老师在文中多次提及的Operator，一次编排多个角色不同甚至镜像不同的服务。</p>2018-10-08</li><br/><li><span>wtcctw</span> 👍（14） 💬（8）<p>张大大你好，
我之前自己玩过docker，在看这个专栏之前，特意简单过了一下《Docker容器与容器云 第二版》，之前一些章节看得非常过瘾，讲解得非常透彻。
但是看到StateFulSet的时候感觉有点晕。。。特别是里面的Pod YAML定义，感觉要记的东西非常多，学习曲线也比较陡峭，一段时间不用肯定就忘了。
所以想问一下，作为非专业的运维人员，对于k8s的掌握大致要到何种程度，多谢多谢。</p>2018-10-08</li><br/><li><span>mazhen</span> 👍（8） 💬（4）<p>总结里给的&#39;mysql-statefulset.yaml&#39;好像有点问题，在声明&#39;volumeClaimTemplates&#39;时，是不是应该通过&#39;storageClassName&#39;属性引用前面定义的&#39;StorageClass&#39;:

storageClassName: rook-ceph-block

我开始一直遇到&quot;pod has unbound immediate PersistentVolumeClaims&quot; 错误，增加了这个属性就好了。</p>2018-10-08</li><br/><li><span>xfan</span> 👍（7） 💬（1）<p>感觉实现起来很复杂，不优美</p>2018-12-26</li><br/><li><span>eden</span> 👍（5） 💬（1）<p>老师，请问mysql persistent volume需要扩容怎么做？通过kubectl scale不能修改volume大小。</p>2018-12-11</li><br/><li><span>侯操宇</span> 👍（5） 💬（3）<p>如果master和slave用两个StatefulSet的话，怎么来保证master和slave的启动顺序呢？</p>2018-10-11</li><br/><li><span>Caesar</span> 👍（5） 💬（2）<p>前面看大神说在搞kata-container，我有一个疑问，kata-container其实也是虚拟机加容器的方式，那它和docker加虚拟机的优势相比在哪呢</p>2018-10-08</li><br/><li><span>彰玉</span> 👍（3） 💬（1）<p>集群建好了  数据也插入成功了  集群也正常后  主从节点的任何节点重启 是重新按yamL启动 还是直接挂数据盘启幼</p>2019-06-03</li><br/><li><span>强者之风</span> 👍（3） 💬（3）<p>看不出来用MySQL-read  service</p>2019-04-13</li><br/><li><span>Joe Black</span> 👍（3） 💬（3）<p>其实给slave节点增加一个新的标签，创建读Service的时候选择这个标签的容器就行了吧？</p>2018-10-15</li><br/>
</ul>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../19%20-%20%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3StatefulSet%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E5%AD%98%E5%82%A8%E7%8A%B6%E6%80%81/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 19   深入理解StatefulSet（二）：存储状态">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                19   深入理解StatefulSet（二）：存储状态
              </div>
            </div>
          </a>
        
        
          
          <a href="../21%20-%20%E5%AE%B9%E5%99%A8%E5%8C%96%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%84%8F%E4%B9%89%EF%BC%9ADaemonSet/" class="md-footer__link md-footer__link--next" aria-label="下一页: 21   容器化守护进程的意义：DaemonSet">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                21   容器化守护进程的意义：DaemonSet
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2025-Present zkep
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.annotate", "content.code.copy", "content.tooltips", "toc.follow", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.prune", "navigation.footer", "navigation.tracking", "navigation.instant", "navigation.instant.progress", "navigation.indexes", "content.tabs.link"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
        <script src="../../../javascript/extra.js"></script>
      
        <script src="../../../javascript/giscus.js"></script>
      
    
  </body>
</html>