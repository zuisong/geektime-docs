ä½ å¥½ï¼Œæˆ‘æ˜¯é‚¢äº‘é˜³ã€‚

ç»è¿‡äº†å‡ èŠ‚è¯¾çš„äº§å“ä½“éªŒå’Œæºç å­¦ä¹ åï¼Œç»ˆäºè¦æ¥åˆ°å®è·µç¯èŠ‚äº†ã€‚åœ¨æœ¬èŠ‚è¯¾ä»¥åŠä¸‹ä¸€èŠ‚è¯¾ï¼Œæˆ‘ä¼šå¸¦ä½ å‚è€ƒ Dify Agent çš„æ€è·¯ï¼Œç”¨ Go è¯­è¨€åšä¸€ä¸ªé›¶ä»£ç å¯é…ç½®çš„ API Agent äº§å“å‡ºæ¥ã€‚

ä¹‹å‰æœ‰åŒå­¦é—®è¿‡æˆ‘ï¼Œè¿™ä¸ªè¯¾ç¨‹ä¸ºä»€ä¹ˆè¦ç”¨ Go è¯­è¨€æ¥åšï¼Œåš AI å¼€å‘çš„ä¸»æµè¯­è¨€ä¸åº”è¯¥æ˜¯ Python å—ï¼Ÿåœ¨è¿™é‡Œï¼Œæˆ‘åšä¸€ä¸‹ç»Ÿä¸€å›ç­”ã€‚

æˆ‘ä»¬çŸ¥é“äº‘åŸç”Ÿåº”ç”¨å¼€å‘çš„â€œæ¯è¯­â€æ˜¯ Goï¼Œè€Œå­¦ä¹ è¿™ä¸ªè¯¾ç¨‹çš„åŒå­¦å¤§å¤šæ•°æ˜¯åšäº‘åŸç”Ÿå¼€å‘ï¼Œå¸Œæœ›é¢å¤–å­¦ä¹  AI ç›¸å…³çš„çŸ¥è¯†æå‡è‡ªå·±çš„ã€‚å› æ­¤ï¼Œä½¿ç”¨ Go è¯­è¨€æ¥åšè¯¾ç¨‹ï¼Œä¼šè®©å¤§å¤šæ•°åŒå­¦ä¸Šæ‰‹æ›´åŠ æ–¹ä¾¿ï¼Œç†è§£èµ·æ¥ä¹Ÿä¼šæ›´åŠ å®¹æ˜“ã€‚è¯•æƒ³ï¼Œå¦‚æœåŸç†çœŸçš„ç†è§£äº†ï¼Œèƒ½ç”¨è‡ªå·±æœ€ç†Ÿæ‚‰çš„è¯­è¨€é›¶æ¡†æ¶æ‰‹æ’¸å‡ºæ¥äº†ï¼Œé‚£éœ€è¦ç”¨åˆ° Python æˆ–è€…ä¸€äº›ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œæ¯”å¦‚ LangChain æ—¶ï¼Œä¸Šæ‰‹ä¹Ÿä¼šéå¸¸çš„å¿«ã€‚

ç¬¬äºŒç‚¹æ˜¯åœ¨äº‘åŸç”Ÿçš„æŸäº›åœºæ™¯ä¸‹ï¼Œæ— æ³•ä½¿ç”¨ Python è¯­è¨€è¿›è¡Œå¼€å‘ï¼Œæ¯”å¦‚ä¸‹ä¸€ç« èŠ‚è¦ç»™ä½ è®²è§£çš„äº‘åŸç”Ÿç½‘å…³ä»¥åŠ wasm æŠ€æœ¯ï¼Œå°±æš‚æ—¶ä¸æ”¯æŒ Python è¯­è¨€ã€‚æ‰€ä»¥æˆ‘åœ¨ç»¼åˆè€ƒè™‘åï¼Œå†³å®šå…¨ç¨‹ç”¨ Go è¯­è¨€æ¥åšè¯¾ç¨‹ã€‚åœ¨è¿™é‡Œä¹Ÿå¸Œæœ›ä½ èƒ½å¤Ÿæ‘†è„±è¯­è¨€çš„æŸç¼šï¼Œé‡ç‚¹å­¦ä¹ åŸç†ä»¥åŠå¥—è·¯ï¼Œå°†æ¥ä¸ç®¡ç”¨åˆ°ä»€ä¹ˆå·¥å…·æ—¶éƒ½èƒ½å¤Ÿä»å®¹åº”å¯¹ã€‚

é‚£ä¹ˆè¨€å½’æ­£ä¼ ï¼Œæˆ‘ä»¬å¼€å§‹è¿›å…¥ä»Šå¤©çš„å®æˆ˜ç¼–ç ç¯èŠ‚ã€‚

## ReAct æ¨¡æ¿

é¦–å…ˆæ¥æå®š Agent çš„å¤§è„‘ã€‚Dify çš„ ReAct æ¨¡æ¿æ˜¯ç”¨ python å†™çš„ï¼Œå› æ­¤å®ƒå¯ä»¥ä½¿ç”¨ç±»ä¼¼æ¨¡æ¿çš„è¯­æ³•ï¼Œå°±åƒè¿™æ ·ï¼š

```python
ENGLISH_REACT_COMPLETION_PROMPT_TEMPLATES = """Respond to the human as helpfully and accurately as possible.Â 

{{instruction}}

You have access to the following tools:

{{tools}}
""" 
```

è¿™é‡Œæˆ‘åªæ˜¯æˆªå–äº†æ¨¡æ¿ä¸­çš„å‡ è¡Œï¼Œä½ ç†è§£æˆ‘è¦è¡¨è¾¾çš„æ„æ€å³å¯ï¼Œå®Œæ•´æ¨¡æ¿å¯ä»¥å»ä¸ŠèŠ‚è¯¾æŸ¥çœ‹ã€‚åœ¨è¿™ä¸ªæ¨¡æ¿ä¸­ï¼Œ{{instruction}} å’Œ {{tools}} ä½œä¸ºå ä½ç¬¦ï¼Œè®©æˆ‘ä»¬æ˜ç¡®çŸ¥é“åœ¨æ¨¡æ¿ä¸­çš„å“ªä¸ªéƒ¨åˆ†éœ€è¦æ’å…¥ç‰¹å®šçš„ä¿¡æ¯ã€‚é‚£ä¹ˆï¼Œä½¿ç”¨ Go è¯­è¨€èƒ½å¦å®ç°ç±»ä¼¼çš„æ•ˆæœå‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚

Go è¯­è¨€æœ¬èº«æä¾›äº†å¼ºå¤§çš„æ¨¡æ¿å¼•æ“ï¼Œtext/template åŒ…å¯ä»¥å¸®åŠ©æˆ‘ä»¬åŠ¨æ€å¡«å……æ¨¡æ¿å†…å®¹ã€‚è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨ Go ä¸­è½»æ¾å®ç°ä¸ Python ç±»ä¼¼çš„åŠŸèƒ½ï¼ŒåŠ¨æ€ç”Ÿæˆæ‰€éœ€çš„å­—ç¬¦ä¸²è¾“å‡ºã€‚Go çš„æ¨¡æ¿å¼•æ“ä¸ä»…æ”¯æŒåŸºç¡€çš„å­—ç¬¦ä¸²æ›¿æ¢ï¼Œè¿˜èƒ½å¤„ç†å¤æ‚çš„é€»è¾‘å’Œæ¡ä»¶åˆ¤æ–­ï¼Œä»è€Œè®©æ¨¡æ¿æ›´åŠ çµæ´»å’Œæ™ºèƒ½ã€‚

åœ¨ Go ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å®šä¹‰ä¸€ä¸ªç±»ä¼¼çš„æ¨¡æ¿ï¼š

```python
const EN_Template = `
Respond to the human as helpfully and accurately as possible.

{{.Instruction}}

You have access to the following tools:

{{.Tools}}
`
```

é‚£ä¸ºäº†å¡«å……è¿™ä¸ªæ¨¡æ¿ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æµ‹è¯•ä»£ç æ‰€ç¤ºçš„æ–¹æ³•ï¼š

```go
package main

import (
	"fmt"
	"text/template"
	"os"
)

type PromptData struct {
	Instruction string
	ToolsÂ  Â  Â  Â string
}

func main() {
	// åˆ›å»ºæ¨¡æ¿å¯¹è±¡
	tmpl, err := template.New("reactPrompt").Parse(EN_Template)
	if err != nil {
		fmt.Println("Error parsing template:", err)
		return
	}

	// å®šä¹‰æ¨¡æ¿æ•°æ®
	data := PromptData{
		Instruction: "Provide a detailed explanation of how AI can improve cloud-native architectures.",
		Tools:Â  Â  Â  Â "AI tools, Cloud-Native tools",
	}

	// æ‰§è¡Œæ¨¡æ¿å¹¶è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º
	err = tmpl.Execute(os.Stdout, data)
	if err != nil {
		fmt.Println("Error executing template:", err)
	}
}
```

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬èƒ½å¤Ÿåœ¨ Go è¯­è¨€ä¸­å®ç°ä¸ Python ç›¸ä¼¼çš„æ¨¡æ¿åŠŸèƒ½ï¼Œä½¿æ¨¡æ¿å¢åŠ å¯é˜…è¯»æ€§ï¼Œè¿˜ä¾¿äºè°ƒæ•´å­—æ®µã€‚

## OpenAPI æ–‡æ¡£è§£æ

### é…ç½®å¯¼å…¥

åœ¨ Dify ä¸­ï¼Œæ˜¯é€šè¿‡åœ¨ UI ä¸Šå¡«å†™å·¥å…·ä¿¡æ¯çš„æ–¹å¼æ¥å®Œæˆå·¥å…·åˆ›å»ºçš„ã€‚åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­ï¼Œæ²¡æœ‰å‰ç«¯ï¼Œå°±ä½¿ç”¨æœ¬åœ° YAML é…ç½®æ–‡ä»¶è§£æçš„æ–¹å¼æ¥å¤§æ¦‚æ¨¡æ‹Ÿä¸€ä¸‹ã€‚

YAML é…ç½®æ–‡ä»¶ï¼Œç”¨æ¥å­˜æ”¾ OpenAPI æ–‡æ¡£ï¼ŒAPI Keyç­‰ä¿¡æ¯ã€‚å…ˆå®šä¹‰å­—æ®µæè¿°å¦‚ä¸‹ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/8b/cc/8bece259d819bdeea91b0ca414e12bcc.png?wh=1920x479)

apis çš„é…ç½®å­—æ®µè¯´æ˜å¦‚ä¸‹ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/f8/3b/f83943e01e4208f9a183d446fcde083b.png?wh=1920x459)

apiProvider çš„é…ç½®å­—æ®µè¯´æ˜å¦‚ä¸‹ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/e7/3a/e7c348a2yyc0cbf98526176a4975713a.png?wh=1920x389)

apiKey çš„é…ç½®å­—æ®µè¯´æ˜å¦‚ä¸‹ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/a8/85/a880c9cc3b0c20b616c76a852d3c5e85.png?wh=1920x719)

æœ€åå½¢æˆçš„æ ·å¼å¦‚ä¸‹æ‰€ç¤ºï¼š

```yaml
instruction: xxxx
apis:
- apiProviderï¼š
    apikey:
      name: key
      value: xxx
      in: header
  api: |
    openapi: 3.1.0
    info: xxx
```

è®¾è®¡å¥½å…·ä½“çš„æ ¼å¼åï¼Œä»£ç å°±å¾ˆç®€å•äº†ã€‚å®šä¹‰ç»“æ„ä½“å¦‚ä¸‹ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/92/74/92da391211b7444f937d2e49ed4fc474.png?wh=574x541)

ä¹‹ååˆå§‹åŒ–ä¸€ä¸‹ç»“æ„ä½“ï¼Œå°† YAML æ–‡ä»¶ä»æœ¬åœ°åŠ è½½è¿›æ¥ï¼Œååºåˆ—åŒ–åˆ°ç»“æ„ä½“å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼š

```go
func InitConfig() *models.Config {
Â  Â  config := newSysConfig()

Â  Â  if b := LoadConfigFile(); b != nil { //è¯»å– system.yamlæ–‡ä»¶å†…å®¹
Â  Â  Â  Â  err := yaml.Unmarshal(b, config) //å°†byteååºåˆ—åŒ–æˆç»“æ„ä½“
Â  Â  Â  Â  if err != nil {
Â  Â  Â  Â  Â  Â  log.Fatal(err)
Â  Â  Â  Â  }
Â  Â  }
Â  Â  return config
}
```

### OpenAPI è§£æ

åœ¨å®Œæˆé…ç½®æ–‡ä»¶çš„å¯¼å…¥åï¼Œæˆ‘ä»¬å°±æ‹¿åˆ°äº† OpenAPI æ–‡æ¡£ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘å°±ä¸åš Swagger åˆ° OpenAPI çš„è½¬æ¢äº†ã€‚æˆ‘ä»¬è§„å®šç”¨æˆ·åªèƒ½ä½¿ç”¨ OpenAPI 3.0 åŠä»¥ä¸Šç‰ˆæœ¬çš„æ ¼å¼ï¼Œä½ç‰ˆæœ¬çš„ Swagger æ ¼å¼ä¸æ”¯æŒã€‚

### ç»“æ„ä½“å®šä¹‰

OpenAPI è§£æçš„è¿‡ç¨‹ï¼Œæ˜¯å°† OpenAPI æ–‡æ¡£è½¬åŒ–æˆ APIToolBundle çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å®šä¹‰å¥½ç»“æ„ä½“ã€‚æ ¹æ®ä¸ŠèŠ‚è®²è¿‡çš„ OpenAPI æ–‡æ¡£çš„æ ¼å¼ï¼Œå…¶ä¸»è¦åŒ…å« OpenAPIã€Infoã€Serversã€Pathsã€Components ç­‰äº”ä¸ªéƒ¨åˆ†ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å®šä¹‰ç»“æ„ä½“å¦‚ä¸‹ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/b3/c3/b3ca8524c93e1c9c3bf30973e7aa8ec3.png?wh=801x202)

Infoã€Servers ä¸‹éƒ½æ˜¯ k-v å½¢å¼çš„å‚æ•°ï¼Œä½¿ç”¨ map æœ€åˆé€‚ã€‚Paths å’Œ Components ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œæ˜¯ map åµŒå¥—çš„å½¢å¼ã€‚åœ¨é…ç½®å¯¼å…¥ç¯èŠ‚ï¼Œæˆ‘ä»¬å·²ç»å¾—åˆ°äº†å­—ç¬¦ä¸²æ ¼å¼çš„ OpenAPI æ–‡æ¡£ï¼Œåœ¨è¿™é‡ŒåŒæ ·å¯ä»¥åˆ©ç”¨ YAML ååºåˆ—åŒ–ï¼Œå°†æ–‡æ¡£çš„å„æ®µæ³¨å…¥åˆ°ç»“æ„ä½“ä¸­ã€‚ã€

æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ APIToolBundle çš„ç»“æ„ä½“å®šä¹‰ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/53/c1/53074aa1fbefc66bab0eeebd4edecec1.png?wh=451x490)

APIToolBundle å‚è€ƒ Dify çš„è®¾è®¡ï¼Œéœ€è¦å°† URLã€Methodã€Summaryã€OperationIDã€Parameters æ‹†è§£å‡ºæ¥ï¼Œä¸€æ–¹é¢éœ€è¦æ‹¼æ¥ ReAct æ¨¡æ¿çš„å·¥å…·éƒ¨åˆ†ï¼Œå¦ä¸€æ–¹é¢åœ¨åé¢è°ƒç”¨é€šç”¨ HTTP æ–¹æ³•æ—¶ä¹Ÿä¼šä½¿ç”¨ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜è®¾è®¡äº† OpenAPI å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°åœ¨ä¸ŠèŠ‚è¯¾è®²è¿‡ï¼Œå­˜å‚¨çš„æ˜¯æ¯ä¸€æ¡è·¯ç”±çš„ Method æ‰€å¯¹åº”çš„å€¼ï¼Œç›®çš„æ˜¯åœ¨åç»­åšå‚æ•°è§£ææ‹¼è£…æ—¶ï¼Œåˆ¤æ–­å‚æ•°æ˜¯ query å‚æ•°è¿˜æ˜¯ requestBody å‚æ•°ã€‚

### è§£æå‡½æ•°

æ¸…æ¥šç»“æ„ä½“åŠŸèƒ½åï¼Œæˆ‘ä»¬æ¥çœ‹è§£æå‡½æ•°ã€‚åœ¨è§£æè¿™ä¸€éƒ¨åˆ†ï¼Œå…¶ä»–çš„å¸¸è§„ k-v æ˜ å°„éƒ½æ¯”è¾ƒç®€å•ï¼Œåœ¨ä¸Šä¸€èŠ‚è¯¾çš„åŸç†ç¯‡è®²è¿‡ï¼Œéº»çƒ¦çš„æ˜¯å‚æ•°çš„å¤„ç†ã€‚å‚æ•°é¦–å…ˆåˆ†ä¸º parameters å’Œ requestBody ä¸¤ç§ç±»å‹ï¼Œåˆ†åˆ«é’ˆå¯¹çš„æ˜¯å‚æ•°åœ¨ url ä¸­ä»¥åŠå‚æ•°åœ¨è¯·æ±‚ä½“ä¸­æƒ…å†µã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå‚æ•°è¿˜ä¼šæ¶‰åŠåˆ°å…¬å…±å‚æ•°è¢«æ”¾ç½®åˆ° Components çš„ schema ä¸­ï¼Œä¹‹åç”¨ $ref å»å¯»å€çš„è¿‡ç¨‹ã€‚

é¦–å…ˆçœ‹ä¸€ä¸‹ parameters çš„å¤„ç†ï¼Œæˆ‘å°† parameters çš„ç¤ºä¾‹æ–‡æ¡£å’Œä»£ç éƒ½æ”¾ä¸Šï¼Œæˆ‘ä»¬å¯¹æ¯”ç€çœ‹ä¼šæ›´åŠ æ¸…æ™°ã€‚

æ–‡æ¡£ï¼š

```plain
parameters:
- name: keywords
Â  in: query
Â  description: POIåç§°ï¼Œå¿…é¡»æ˜¯ä¸­æ–‡
Â  required: true
Â  schema:
Â  Â  type: string
```

ä»£ç ï¼š

```go
if params, ok := operation["parameters"].([]interface{}); ok {
Â  Â  for _, param := range params {
Â  Â  Â  Â  paramMap := param.(map[string]interface{})
Â  Â  Â  Â  toolParam := models.ToolParameter{
Â  Â  Â  Â  Â  Â  Name: Â  Â  Â  Â  Â  paramMap["name"].(string),
Â  Â  Â  Â  Â  Â  Type: Â  Â  Â  Â  Â  "string", // é»˜è®¤ç±»å‹
Â  Â  Â  Â  Â  Â  Required: Â  Â  Â  paramMap["required"].(bool),
Â  Â  Â  Â  Â  Â  LLMDescription: paramMap["description"].(string),
Â  Â  Â  Â  Â  Â  Default: Â  Â  Â  Â getDefault(paramMap),
Â  Â  Â  Â  }

Â  Â  Â  Â  // ç±»å‹å¤„ç†
Â  Â  Â  Â  if typ := getParameterType(paramMap); typ != "" {
Â  Â  Â  Â  Â  Â  toolParam.Type = typ
Â  Â  Â  Â  }

Â  Â  Â  Â  parameters = append(parameters, toolParam)
Â  Â  }
}
```

ä»£ç é€»è¾‘è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œå°±æ˜¯ä» map ä¸­å–å€¼ï¼Œèµ‹å€¼åˆ° ToolParameter å®ä¾‹çš„è¿‡ç¨‹ï¼Œè¿™å…¶ä¸­æ¶‰åŠåˆ°äº†æ¯”è¾ƒå¤šçš„å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œæˆ‘æ˜¯ç›´æ¥å°±ç”¨äº†ï¼Œæ²¡æœ‰åšæ˜¯å¦å­˜åœ¨çš„éªŒè¯ã€‚ä½†å®é™…ä¸Šéƒ½åº”è¯¥ç”¨åƒç¬¬ä¸€è¡Œä»£ç ä¸€æ ·çš„ if xx,ok çš„æ–¹å¼åšä¸€ä¸‹åˆ¤æ–­ï¼Œé¿å…å› è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„åœ°å€è€Œå‡ºç° panicã€‚

ä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ requestBody ä»¥åŠ ref å¼•ç”¨çš„å¤„ç†é€»è¾‘ã€‚

æ–‡æ¡£ï¼š

```plain
requestBody:
Â  required: true
Â  content:
Â  Â  application/json:
Â  Â  Â  schema:
Â  Â  Â  Â  type: object
Â  Â  Â  Â  required:
Â  Â  Â  Â  Â  - text
Â  Â  Â  Â  Â  - target_lang
Â  Â  Â  Â  properties:
Â  Â  Â  Â  Â  text:
Â  Â  Â  Â  Â  Â  $ref: '#/components/schemas/TranslationText'
...
components:
Â  schemas:
Â  Â  TranslationText:
Â  Â  Â  description: |
Â  Â  Â  Â  Text to be translated. Only UTF-8-encoded plain text is supported. The parameter may be specified
Â  Â  Â  Â  up to 50 times in a single request. Translations are returned in the same order as they are requested.
Â  Â  Â  type: array
Â  Â  Â  maxItems: 50
Â  Â  Â  items:
Â  Â  Â  Â  type: string
Â  Â  Â  Â  example: Hello, World!
```

ä»£ç ï¼š

```go
if requestBody, ok := operation["requestBody"].(map[string]interface{}); ok {
Â  Â  if content, ok := requestBody["content"].(map[string]interface{}); ok {
Â  Â  Â  Â  for _, contentType := range content {
Â  Â  Â  Â  Â  Â  if bodySchema, ok := contentType.(map[string]interface{})["schema"].(map[string]interface{}); ok {
Â  Â  Â  Â  Â  Â  Â  Â  required := bodySchema["required"].([]interface{})
Â  Â  Â  Â  Â  Â  Â  Â  properties := bodySchema["properties"].(map[string]interface{})
Â  Â  Â  Â  Â  Â  Â  Â  for name, prop := range properties {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  propMap := prop.(map[string]interface{})
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¤„ç†å¼•ç”¨ï¼Œå¦‚æœæœ‰
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if ref, ok := propMap["$ref"].(string); ok {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  root := openAPI.Components["schemas"]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  segments := strings.Split(ref, "/")[1:]

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastSegment := segments[len(segments)-1]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  propMap = root[lastSegment].(map[string]interface{})
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toolParam := models.ToolParameter{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Name: Â  Â  Â  Â  Â  name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Type: Â  Â  Â  Â  Â  "string", // é»˜è®¤ç±»å‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Required: Â  Â  Â  contains(required, name),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  LLMDescription: propMap["description"].(string),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Default: Â  Â  Â  Â propMap["default"],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¦‚æœå‚æ•°åŒ…å« enumï¼Œåˆ™æ·»åŠ æšä¸¾å€¼
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if enum, ok := propMap["enum"].([]interface{}); ok {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  var enumValues []string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for _, e := range enum {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  enumValues = append(enumValues, e.(string))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toolParam.Enum = enumValues
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ç±»å‹å¤„ç†
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if typ := getParameterType(propMap); typ != "" {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toolParam.Type = typ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  parameters = append(parameters, toolParam)
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
}
```

ä»£ç é¦–å…ˆé€šè¿‡ map è¿›è¡Œä¸€å±‚å±‚åœ°æ‹†è§£ï¼Œå¾—åˆ° schemaï¼Œå¹¶è¿›ä¸€æ­¥å¾—åˆ° propertiesã€‚ä¹‹åä¾¿å¼€å§‹éå† propertiesï¼Œå¦‚æœåŒ…å« $ref å­—æ®µï¼Œåˆ™é¦–å…ˆé€šè¿‡ strings.Split(ref, â€œ/â€)\[1:] å°† #/components/schemas/TranslationText åˆ‡åˆ†æˆæ•°ç»„ï¼Œå³\[componentes schemas TranslationText]ï¼Œè¿™æ ·ä¾¿å¯ä»¥å–æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ çš„æ–¹å¼æ‹¿åˆ°å‚æ•°çš„åå­—ã€‚ä¹‹åå†é€šè¿‡ openAPI.Components\[â€œschemasâ€]\[lastSegment] å¾—åˆ°å‚æ•°çš„æ–‡æ¡£ï¼Œå°†å…¶æ›¿æ¢æ‰ $refã€‚æœ€ç»ˆæ–‡æ¡£ä¼šå˜æˆå¦‚ä¸‹å½¢å¼ï¼š

```plain
...
properties:
Â  text:
    TranslationText:
Â  Â  Â  description: |
Â  Â  Â  Â  Text to be translated. Only UTF-8-encoded plain text is supported. The parameter may be specified
Â  Â  Â  Â  up to 50 times in a single request. Translations are returned in the same order as they are requested.
Â  Â  Â  type: array
...
```

æ¥ä¸‹æ¥çš„éƒ¨åˆ†å°±å¾ˆç®€å•äº†ï¼Œä»£ç ç±»ä¼¼ä¸Šé¢çš„ parameters çš„å¤„ç†ï¼Œä¹Ÿæ˜¯é€šè¿‡ä» map ä¸­å–å€¼å¹¶èµ‹å€¼ ToolParameter çš„æ–¹å¼å®Œæˆæ‹†è§£ã€‚

## ç»„è£…å·¥å…·

åœ¨å¾—åˆ° APIToolBundle åï¼Œä¾¿å¯ä»¥ç»„è£… tools æè¿°ï¼Œå¹¶æµ‹è¯•ä¸€ä¸‹å¡«å……åˆ° ReAct æ¨¡æ¿ã€‚åœ¨ä¹‹å‰çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»„è£… tools æ—¶ä¼šç”¨åˆ°ä¸‰ä»¶å¥—ï¼Œå³ nameã€descriptionã€paramï¼Œå…¶ä¸­ param ä¼šç”¨ json æ ¼å¼è¿›è¡Œæè¿°ã€‚Dify ä¹Ÿå·®ä¸å¤šï¼Œåªä¸è¿‡æ¯”æˆ‘ä»¬è¯¾ç¨‹ä¸­çš„è¿˜è¦å†ä¸°å¯Œä¸€ç‚¹ï¼Œæˆ‘ä»¬å°±å€Ÿé‰´ä¸€ä¸‹ Dify çš„æ ¼å¼ã€‚å®šä¹‰ç»“æ„ä½“å¦‚ä¸‹ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/57/55/574561aef8abd9f86a9612a98026f155.png?wh=384x518)

ä¸‰ä»¶å¥—æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«åœ¨äº Dify å¢åŠ äº† Required å­—æ®µï¼Œç”¨æ¥å‘Šè¯‰å¤§æ¨¡å‹å“ªä¸ªå‚æ•°æ˜¯å¿…å¡«çš„ã€‚å‚æ•°æè¿°ä¸­ä¹Ÿå¢åŠ äº† Enum æšä¸¾å­—æ®µï¼Œä¾¿äºå¤„ç†å¸¦å¯é€‰å€¼çš„å‚æ•°çš„æƒ…å†µã€‚

ä»£ç éå¸¸ç®€å•ï¼Œå°±æ˜¯ä» APIToolBundle å–ç›¸å…³å€¼å¹¶å¤åˆ¶åˆ°ä¸Šè¿°ç»“æ„ä½“ä¸­å³å¯ã€‚åœ¨è¿™å°±ä¸å†è´´ä»£ç æ¼”ç¤ºäº†ï¼Œä½ å¯åœ¨æˆ‘çš„ Github ä¸ŠæŸ¥çœ‹å®Œæ•´ä»£ç ã€‚æœ€åï¼Œå°†ç»“æ„ä½“è¿›è¡Œ JSON åºåˆ—åŒ–ï¼Œè½¬æˆ JSON å­—ç¬¦ä¸²ã€‚ä½¿ç”¨é…ç½®å¯¼å…¥å°èŠ‚è®²è§£çš„ template èµ‹å€¼è¯­æ³•å¡«å……åˆ° ReAct æ¨¡æ¿å³å¯ã€‚

## æµ‹è¯•

æˆ‘æ‰¾äº†ä¸€ä¸ª DeepL ç¿»è¯‘çš„ OpenAPI ä¾‹å­æ¥æµ‹è¯•ä¸€ä¸‹æ•ˆæœã€‚YAML é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š

```plain
instruction: ä½ æ˜¯ä¸€ä¸ªç²¾é€šå¤šå›½è¯­è¨€çš„ç¿»è¯‘ä¸“å®¶ï¼Œå¯ä»¥ç¿»è¯‘ä»»ä½•æ–‡æœ¬ã€‚
apis:
- apiProvider:
Â  Â  apiKey: 
Â  Â  Â  name: DeepL-Auth-Key
Â  Â  Â  value: xxxxxxxxxxxxxxxxxxx
Â  Â  Â  in: header
Â  api: |
Â  Â  openapi: 3.1.0
Â  Â  info:
Â  Â  Â  title: DeepL API Documentation
Â  Â  Â  description: The DeepL API provides programmatic access to DeepLâ€™s machine translation technology.
Â  Â  Â  version: v1.0.0
Â  Â  servers:
Â  Â  Â  - url: https://api-free.deepl.com/v2
Â  Â  paths:
Â  Â  Â  /translate:
Â  Â  Â  Â  post:
Â  Â  Â  Â  Â  description: Request Translation
Â  Â  Â  Â  Â  operationId: translateText
Â  Â  Â  Â  Â  requestBody:
Â  Â  Â  Â  Â  Â  required: true
Â  Â  Â  Â  Â  Â  content:
Â  Â  Â  Â  Â  Â  Â  application/json:
Â  Â  Â  Â  Â  Â  Â  Â  schema:
Â  Â  Â  Â  Â  Â  Â  Â  Â  type: object
Â  Â  Â  Â  Â  Â  Â  Â  Â  required:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  - text
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  - target_lang
Â  Â  Â  Â  Â  Â  Â  Â  Â  properties:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $ref: '#/components/schemas/TranslationText'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  target_lang:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $ref: '#/components/schemas/LanguageCode'
Â  Â  Â  Â  Â  responses:
Â  Â  Â  Â  Â  Â  '200':
Â  Â  Â  Â  Â  Â  Â  description: Successful response
Â  Â  components:
Â  Â  Â  schemas:
Â  Â  Â  Â  TranslationText:
Â  Â  Â  Â  Â  description: |
Â  Â  Â  Â  Â  Â  Text to be translated. Only UTF-8-encoded plain text is supported. The parameter may be specified
Â  Â  Â  Â  Â  Â  up to 50 times in a single request. Translations are returned in the same order as they are requested.
Â  Â  Â  Â  Â  type: array
Â  Â  Â  Â  Â  maxItems: 50
Â  Â  Â  Â  Â  items:
Â  Â  Â  Â  Â  Â  type: string
Â  Â  Â  Â  Â  Â  example: Hello, World!
Â  Â  Â  Â  LanguageCode:
Â  Â  Â  Â  Â  description: The language into which the text should be translated.
Â  Â  Â  Â  Â  type: string
Â  Â  Â  Â  Â  enum:
Â  Â  Â  Â  Â  Â  - BG
Â  Â  Â  Â  Â  Â  ...
Â  Â  Â  Â  Â  Â  - ZH-HANS
Â  Â  Â  Â  Â  example: DE
```

è§£æå¹¶æ³¨å…¥ ReAct æ¨¡æ¿åçš„æ•ˆæœæ˜¯è¿™æ ·çš„ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/b4/f5/b49f4c09c7c57025b5a2561cf5c40ff5.png?wh=1291x529)

å¯ä»¥çœ‹åˆ°è§£æå¾—æ²¡æœ‰é—®é¢˜ã€‚

## æ€»ç»“

æœ¬èŠ‚è¯¾ï¼Œæˆ‘ä»¬å¼€å§‹ç”¨ Go è¯­è¨€ä»¿ç…§ Dify Agent çš„æ€è·¯æ‰‹æ’¸å¯å®šåˆ¶ API Agentã€‚ç”±äºä»£ç é‡ä»¥åŠç»†èŠ‚æ¯”è¾ƒå¤šï¼Œå› æ­¤æˆ‘æ‹†åˆ†æˆäº†ä¸¤ä¸ªè¯¾æ—¶ã€‚

æœ¬è¯¾æ—¶æˆ‘è®²è§£äº†å¦‚ä½•è®¾è®¡æœ¬åœ° YAML é…ç½®æ–‡ä»¶çš„æ–¹å¼æ¥æ¨¡ä»¿ Dify å‰ç«¯é…ç½®å·¥å…·å‚æ•°çš„è¿‡ç¨‹ï¼Œä»¥åŠç”¨ Go æ¨¡æ¿è¯­æ³•å®ç° python æ¨¡æ¿çš„åŒæ¬¾æ•ˆæœï¼Œä»è€Œè®© ReAct æ¨¡æ¿å˜å¾—ç›´è§‚ï¼Œæ˜“æ‰©å±•ã€‚æ­¤å¤–æˆ‘è¿˜è®²è§£äº† OpenAPI æ–‡æ¡£çš„è§£æï¼Œè¿™ä¸€éƒ¨åˆ†åœ¨ Python ä¸­ç”±äºæœ‰å­—æ®µæ•°æ®ç±»å‹ï¼Œå› æ­¤éå¸¸å®¹æ˜“å®ç°ï¼Œä½†åœ¨ Go è¯­è¨€ä¸­åªèƒ½ä½¿ç”¨å¤§é‡çš„ map\[string]interface{} æ¥è¿›è¡Œæ¨¡æ‹Ÿã€‚æœ€åï¼Œæˆ‘ä»¬ç»„è£…äº†å·¥å…·å¹¶æ˜ å°„åˆ° ReAct æ¨¡æ¿ä¸­åšäº†æµ‹è¯•ã€‚æœ¬èŠ‚è¯¾çš„ä»£ç ï¼Œæˆ‘å·²ç»ä¸Šä¼ åˆ°äº†æˆ‘çš„ [Github](https://github.com/xingyunyang01/Geek/tree/main/agent) ä¸Šï¼Œä½ å¯ä¸‹è½½æˆ‘çš„æºç äº†è§£æ›´å¤šçš„å®ç°ç»†èŠ‚å¹¶åšæµ‹è¯•ã€‚

åœ¨ä¸‹ä¸€èŠ‚è¯¾ï¼Œæˆ‘ä¼šç»§ç»­å¸¦ä½ å®Œæˆ output\_parserï¼Œé€šç”¨ HTTP æ–¹æ³•ï¼Œä»¥åŠAgent å¤šè½®å¯¹è¯é€»è¾‘çš„ä»£ç ç¼–å†™ï¼Œæœ€åæˆ‘ä»¬ç”¨ gin è¿›è¡Œå°è£…ï¼Œæ¨¡æ‹Ÿä¸€ä¸‹ Dify é€šè¿‡ API è®¿é—® Agent çš„æ–¹å¼ã€‚

## æ€è€ƒé¢˜

ä½ å¯ä»¥æ€è€ƒä¸€ä¸‹ output\_parser éƒ¨åˆ†çš„ä»£ç è¯¥å¦‚ä½•å†™ï¼Œç”¨éæµå¼æ¨¡å¼å®ç°å³å¯ã€‚åœ¨ä¸‹ä¸€èŠ‚è¯¾ï¼Œæˆ‘ä¼šæ”¾å‡ºä»£ç å¹¶åšè®²è§£ã€‚

æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„ä»£ç è®¾è®¡æ€è·¯ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥è®¨è®ºã€‚å¦‚æœä½ è§‰å¾—è¿™èŠ‚è¯¾çš„å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ1ï¼‰</strong></div><ul>
<li><span>ğŸ¤¡</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä½¿ç”¨è¿™ä¸ª openai-go åº“è¿›è¡Œè°ƒç”¨å¤§æ¨¡å‹apiå’Œ ä½¿ç”¨langchain-go æ¡†æ¶è°ƒç”¨å¤§æ¨¡å‹apiè¿›è¡Œç¼–ç¨‹æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œæˆ‘å¯ä»¥ç†è§£ä¸º langchain æ˜¯ä¸€ä¸ªæ›´é«˜å±‚æ¬¡æŠ½è±¡çš„å°è£…å—ï¼Ÿ</p>2025-02-03</li><br/>
</ul>