ä½ å¥½ï¼Œæˆ‘æ˜¯ç‹æ˜Šå¤©ã€‚

åœ¨ä¸ŠèŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬è®¤è¯†äº†ä¸€æ¬¾è‡ªåŠ¨åŒ–æ³¨å…¥æµ‹è¯•å·¥å…·sqlmapï¼Œå¹¶å¯¹å®ƒçš„åˆå§‹åŒ–è¿‡ç¨‹æœ‰äº†æ·±å…¥äº†è§£ã€‚åœ¨å®Œæˆäº†åˆå§‹åŒ–ä¹‹åï¼Œå¤§éƒ¨åˆ†è½¯ä»¶å°±ä¼šå¼€å§‹è¿›å…¥æ­£å¼çš„å·¥ä½œæµç¨‹äº†ï¼Œè€Œè¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±å°†å¼€å§‹å­¦ä¹ sqlmapçš„å·¥ä½œæµç¨‹ã€‚

åœ¨ä»‹ç»sqlmapçš„å·¥ä½œæµç¨‹ä¹‹å‰ï¼Œä½ å¯ä»¥å…ˆæ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¹³æ—¶æ˜¯å¦‚ä½•è¿›è¡ŒSQLæ³¨å…¥æµ‹è¯•çš„ï¼Ÿå¦‚æœè®©ä½ æ¥è®¾è®¡ä¸€ä¸ªè‡ªåŠ¨åŒ–æ³¨å…¥æµ‹è¯•å·¥å…·ï¼Œå°†å¹³æ—¶æ‰‹åŠ¨å®ç°çš„SQLæ³¨å…¥æµ‹è¯•æ­¥éª¤è½¬åŒ–ä¸ºæœºå™¨çš„è‡ªåŠ¨åŒ–å®ç°ï¼Œä¼šé‡åˆ°ä»€ä¹ˆå›°éš¾å—ï¼Ÿ

è‡ªåŠ¨åŒ–æ³¨å…¥çš„ä¸»è¦éš¾ç‚¹ä¸äººå·¥æ³¨å…¥ä¼šæœ‰ä¸€äº›å·®å¼‚ï¼Œæ¯”å¦‚ï¼Œäººå·¥å¾ˆå®¹æ˜“åˆ¤æ–­ç›®æ ‡æ˜¯å¦å—åˆ°wafä¿æŠ¤ï¼Œä¹Ÿå¯ä»¥æ›´å¥½åœ°è§‚æµ‹æ³¨å…¥ç»“æœï¼Œè€Œè®©æœºå™¨åšåŒæ ·çš„äº‹æƒ…ï¼Œåˆ™æ˜¯ä¸€ä»¶ä¸å®¹æ˜“çš„äº‹æƒ…ã€‚

å¯¹äºäººå·¥è€Œè¨€ï¼Œä½ å¯ä»¥å‘é€ä¸€ä¸ªå®¹æ˜“è¢«wafæ‹¦æˆªçš„payloadï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼æ¥è§‚å¯Ÿé¡µé¢çš„å“åº”ï¼Œè¿›è€Œåˆ¤æ–­wafæ˜¯å¦å­˜åœ¨ã€‚å¯æ˜¯æœºå™¨è¦å¦‚ä½•å®ç°å‘¢ï¼Ÿç›¸ä¿¡å­¦å®Œè¿™ç¯‡è¯¾ç¨‹ï¼Œä½ å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

åœ¨ä¸Šä¸€èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å¯¹sqlmap.pyä¸­çš„mainå‡½æ•°è¿›è¡Œäº†æ‹†è§£ï¼Œå…·ä½“åˆ†æäº†initå‡½æ•°çš„ä¸»è¦åŠŸèƒ½ï¼Œè€Œinitå‡½æ•°ä¹‹åï¼Œå°±æ˜¯startå‡½æ•° ã€‚æ‰€ä»¥åœ¨è¿™èŠ‚è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šæ¥ç€ä¸Šä¸€èŠ‚è¯¾çš„å†…å®¹ï¼Œç»§ç»­åˆ†æsqlmap.pyä¸­çš„mainå‡½æ•°ï¼Œä¸»è¦è®²è§£startå‡½æ•°å®ç°çš„åŠŸèƒ½å’Œæ–¹æ³•ã€‚

## startå‡½æ•°

åœ¨ç³»ç»Ÿè¿è¡Œå®Œsqlmapçš„åˆå§‹åŒ–æµç¨‹åï¼Œå°±ä¼šè¿›å…¥åˆ°startå‡½æ•°ä¸­ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¿™èŠ‚è¯¾éœ€è¦å­¦ä¹ çš„ä¸»è¦å†…å®¹ã€‚ä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œå¯ä»¥å°†å®ƒä¸»è¦åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼Œå³å‡†å¤‡å·¥ä½œã€å¾ªç¯éå†ç›®æ ‡ã€å¤„ç†è¾“å…¥å‚æ•°ï¼Œä»¥åŠåˆ¤æ–­wafçš„å­˜åœ¨ã€‚

è¿™æ˜¯æˆ‘ç»˜åˆ¶çš„ä¸€å¹…startå‡½æ•°æ‹†è§£å›¾ï¼Œå›¾ä¸­è§£é‡Šäº†å››ä¸ªéƒ¨åˆ†åˆ†åˆ«åšäº†å“ªäº›å·¥ä½œã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/5b/6d/5bdfb19549a69df4603b542db49edc6d.png?wh=1241x1029)

ä¸ºäº†è®©ä½ æ›´å¥½çš„ç†è§£startå‡½æ•°çš„åŠŸèƒ½ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹startå‡½æ•°çš„å†…å®¹ã€‚

```python
@stackedmethod
def start():
    """
    This function calls a function that performs checks on both URL
    stability and all GET, POST, Cookie and User-Agent parameters to
    check if they are dynamic and SQL injection affected
    """

    # è¿™ä¸ªé…ç½®å¹¶æ²¡æœ‰ä½“ç°åœ¨å‘½ä»¤è¡Œä¸Šï¼Œå±äºæµ‹è¯•åŠŸèƒ½ï¼Œå¯å¿½ç•¥ã€‚
    if conf.hashFile:
        crackHashFile(conf.hashFile)

    if conf.direct:
        initTargetEnv()
        setupTargetEnv()
        action()
        return True
    
    # è¿™ä¸ªé…ç½®è®¾å®šurlå’Œçˆ¬è™«æ·±åº¦ã€‚
    if conf.url and not any((conf.forms, conf.crawlDepth)):
        kb.targets.add((conf.url, conf.method, conf.data, conf.cookie, None))

        if conf.configFile and not kb.targets:
        errMsg = "you did not edit the configuration file properly, set "
        errMsg += "the target URL, list of targets or google dork"
        logger.error(errMsg)
        return False

    if kb.targets and isListLike(kb.targets) and len(kb.targets) > 1:
        infoMsg = "found a total of %d targets" % len(kb.targets)
        logger.info(infoMsg)

    targetCount = 0
    initialHeaders = list(conf.httpHeaders)

    for targetUrl, targetMethod, targetData, targetCookie, targetHeaders in kb.targets:
        # è¿™ä¸ªé…ç½®è¾“å‡ºç›®æ ‡æ•°é‡ä¿¡æ¯ã€‚
        targetCount += 1
        try:
            if conf.checkInternet:
                infoMsg = "checking for Internet connection"
                logger.info(infoMsg)
```

è¿™é‡Œä½ å¯ä»¥ç»“åˆä»£ç ä¸­çš„æ³¨é‡Šè¿›è¡Œé˜…è¯»ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šè¯¦ç»†å±•å¼€startå‡½æ•°çš„æ¯ä¸€éƒ¨åˆ†ï¼Œå› æ­¤è¿™é‡Œä½ åªéœ€è¦å¯¹startå‡½æ•°çš„è¡Œä¸ºæœ‰ä¸ªå¤§æ¦‚äº†è§£å³å¯ã€‚

### å‡†å¤‡å·¥ä½œ

startå‡½æ•°é¦–å…ˆä¼šè¿›è¡Œä¸€äº›é’ˆå¯¹ç›®æ ‡çš„é…ç½®å·¥ä½œï¼Œé…ç½®ç»“æŸä¹‹åï¼Œç¨‹åºå°†å¼€å§‹åˆ©ç”¨forå¾ªç¯å¯¹æ¯ä¸€ä¸ªç›®æ ‡è¿›è¡Œç‰¹å®šçš„æ“ä½œï¼ŒåŒ…æ‹¬ï¼Œæ£€æµ‹ç½‘ç»œçš„è¿é€šæ€§ï¼Œæ£€æµ‹æ˜¯å¦ä½¿ç”¨éšæœºUAä¿¡æ¯ã€æ˜¯å¦é…ç½®postæ•°æ®ã€æå–æ£€æµ‹å‚æ•°ã€ä»¥åŠè¿‡æ»¤ç”¨æˆ·æ’é™¤çš„ç›®æ ‡ç­‰ã€‚

ä¸‹é¢è®©æˆ‘ä»¬é€ä¸€è§‚å¯Ÿå®ƒä»¬å¯¹åº”çš„ä»£ç ç»“æ„ï¼Œæ¥å¸®åŠ©ä½ åŠ æ·±ç†è§£ã€‚

### å¾ªç¯éå†ç›®æ ‡

é¦–å…ˆï¼Œæ˜¯ç”¨forå¾ªç¯å¤„ç†æ¯ä¸€ä¸ªç›®æ ‡çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°forå¾ªç¯å¤„ç†ç›®æ ‡çš„ä»£ç ä¸­ï¼ŒåŒ…å«äº†å¯¹ç½‘ç»œè¿é€šæ€§çš„æµ‹è¯•ã€‚

```
for targetUrl, targetMethod, targetData, targetCookie, targetHeaders in kb.targets:
    targetCount += 1
    try:
        # ç½‘ç»œè¿é€šæ€§æµ‹è¯•
        if conf.checkInternet:
            infoMsg = "checking for Internet connection"
            logger.info(infoMsg)
            if not checkInternet():
                warnMsg = "[%s] [WARNING] no connection detected" % time.strftime("%X")
                dataToStdout(warnMsg)
                valid = False
                for _ in xrange(conf.retries):
                    if checkInternet():
                        valid = True
                        break
                    else:
                        dataToStdout('.')
                        time.sleep(5)
                if not valid:
                    errMsg = "please check your Internet connection and rerun"
                    raise SqlmapConnectionException(errMsg)
                else:
                    dataToStdout("\n")
        conf.url = targetUrl
        conf.method = targetMethod.upper().strip() if targetMethod else targetMethod
        conf.data = targetData
        conf.cookie = targetCookie
        conf.httpHeaders = list(initialHeaders)
        conf.httpHeaders.extend(targetHeaders or [])

```

æ¥ä¸‹æ¥ç³»ç»Ÿä¼šå¼€å§‹æå–ä¸€ç³»åˆ—æ•°æ®ï¼Œè¿™äº›æ•°æ®ä¼šåœ¨HTTPè¯·æ±‚ä¸­ç”¨åˆ°ï¼ŒåŒ…æ‹¬è¯·æ±‚çš„ç½‘å€ã€cookiesä¿¡æ¯ç­‰ã€‚

```python
conf.url = targetUrl
conf.method = targetMethod.upper().strip() if targetMethod else targetMethod
conf.data = targetData
conf.cookie = targetCookie
conf.httpHeaders = list(initialHeaders)
conf.httpHeaders.extend(targetHeaders or [])
 

```

å®Œæˆäº†æ•°æ®æå–ï¼Œç³»ç»Ÿä¼šæ£€æŸ¥è¯·æ±‚å‚æ•°ï¼Œè¿™ä¸ªæ­¥éª¤ä¼šåˆ†ä¸º3ä¸ªå­æ­¥éª¤ï¼Œåˆ†åˆ«æ˜¯é…ç½®éšæœºçš„User-Agentä¿¡æ¯ã€åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æŒ‡å®šäº†ç”¨POSTæ–¹å¼ä¸Šä¼ çš„æ•°æ®ã€ä»¥åŠå¯¹ç›®æ ‡çš„urlè¿›è¡Œåˆç†æ€§æ£€æŸ¥ã€‚

```python
# é…ç½®éšæœºUAä¿¡æ¯
if conf.randomAgent or conf.mobile:
    for header, value in initialHeaders:
        if header.upper() == HTTP_HEADER.USER_AGENT.upper():
            conf.httpHeaders.append((header, value))
            break
# ...

# åˆ¤æ–­æ˜¯å¦æŒ‡å®šäº†POSTæ•°æ®
if conf.data:
# Note: explicitly URL encode __ ASP(.NET) parameters (e.g. to avoid problems with Base64 encoded '+' character) - standard procedure in web browsers
conf.data = re.sub(r"\b(__\w+)=([^&]+)", lambda match: "%s=%s" % (match.group(1), urlencode(match.group(2), safe='%')), conf.data)
conf.httpHeaders = [conf.httpHeaders[i] for i in xrange(len(conf.httpHeaders)) if conf.httpHeaders[i][0].upper() not in (__[0].upper() for __ in conf.httpHeaders[i + 1:])]
# ...

# URLåˆç†æ€§æ£€æŸ¥
initTargetEnv()
parseTargetUrl()
```

å®Œæˆè¿™éƒ¨åˆ†å·¥ä½œä¹‹åï¼Œsqlmapä¼šæœ‰ä¸€ä¸ªé­”æ³•æ“ä½œï¼Œå¦‚æœä½ ç†è§£äº†sqlmapçš„å·¥ä½œåŸç†ï¼Œå°±å¯ä»¥å¾ˆå®¹æ˜“ç†è§£è¿™ä¸ªé­”æ³•æ“ä½œäº†ï¼Œä½†å¦‚æœä½ ä¸ç†è§£ï¼Œå®ƒä¸€å®šä¼šå¸¦ç»™ä½ ä¸å°‘ç—›è‹¦ï¼Œè¿™ä¸ªé­”æ³•æ“ä½œå°±æ˜¯ç¼“å­˜æ£€æŸ¥ã€‚

sqlmapä¼šåˆ¤æ–­å½“å‰çš„æŸ¥è¯¢åœ¨ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œå°±è¯´æ˜sqlmapä¹‹å‰å·²ç»è¿›è¡Œè¿‡åŒæ ·çš„æ£€æŸ¥äº†ï¼Œè¿™æ—¶å®ƒå°±ä¼šè·³è¿‡å½“å‰çš„æ£€æŸ¥ç›®æ ‡ï¼›å¦‚æœå½“å‰æŸ¥è¯¢ä¸å­˜åœ¨ï¼Œæ‰ä¼šæ‰§è¡ŒSQLæ³¨å…¥æ”»å‡»ã€‚æˆ‘å°±æ›¾ç»å¯¹åŒä¸€ç›®æ ‡æ‰§è¡Œå¤šæ¬¡SQLæ³¨å…¥æ”»å‡»ï¼Œç„¶åé™·å…¥äº†è¿™ä¸ªé—®é¢˜ä¸­ï¼Œæ’æŸ¥äº†å¾ˆä¹…æ‰å¾—ä»¥è„±èº«ã€‚

```python
if testSqlInj and conf.hostname in kb.vulnHosts:
    if kb.skipVulnHost is None:
        message = "SQL injection vulnerability has already been detected "
        message += "against '%s'. Do you want to skip " % conf.hostname
        message += "further tests involving it? [Y/n]"

        kb.skipVulnHost = readInput(message, default='Y', boolean=True)

    testSqlInj = not kb.skipVulnHost

if not testSqlInj:
    infoMsg = "skipping '%s'" % targetUrl
    logger.info(infoMsg)
    continue
```

### å¤„ç†è¾“å…¥å‚æ•°

æ­¤æ—¶ï¼Œsqlmapä¼šè¿›å…¥startå‡½æ•°å†…éƒ¨çš„ç¬¬å››ä¸ªæ­¥éª¤ï¼Œä¹Ÿå°±æ˜¯å¤„ç†è¾“å…¥å‚æ•°ã€‚é™¤äº†è®¾ç½®ä¸€äº›å­˜å‚¨ä¿¡æ¯å’Œé…ç½®ç»“æœæ–‡ä»¶ï¼Œè¿˜ä¼šé’ˆå¯¹æ€§åœ°å¤„ç†ä¸€äº›è¯·æ±‚æ•°æ®ï¼Œè¿™éƒ¨åˆ†çš„å¤„ç†è¿‡ç¨‹ï¼Œä¼šåœ¨setRequestParamså‡½æ•°ä¸­è¿›è¡Œã€‚

ä¸ºäº†å¤§å®¶æ›´å¥½çš„ç†è§£`_setRequestParams()`è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘åœ¨ä¸‹é¢åˆ—å‡ºäº†å®ƒçš„éƒ¨åˆ†ä»£ç ï¼Œå…¶ä¸­åŒ…æ‹¬äº†å®ƒå¯¹è¯·æ±‚å‚æ•°getã€postã€æ³¨å…¥ç‚¹æ ‡è®°ã€cookieã€headerä»¥åŠcsrf-tokençš„å¤„ç†è¿‡ç¨‹ï¼Œå¤§å®¶å¯ä»¥ç»“åˆä»£ç ä¸­çš„æ³¨é‡Šï¼Œæ›´åŠ æ·±å…¥åœ°ç†è§£è¿™ä¸ªå‡½æ•°ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å¤„ç†è¯·æ±‚å‚æ•°çš„ã€‚

```python
def _setRequestParams():

# ...  
# æ£€æŸ¥è¯·æ±‚çš„getå‚æ•°ï¼Œè‹¥æœ‰å°†å®ƒå­˜å‚¨èµ·æ¥ï¼Œä¾›æµ‹è¯•æ—¶ä½¿ç”¨ã€‚
    if conf.parameters.get(PLACE.GET):
        parameters = conf.parameters[PLACE.GET]
        paramDict = paramToDict(PLACE.GET, parameters)

        if paramDict:
            conf.paramDict[PLACE.GET] = paramDict
            testableParameters = True

# æ£€æŸ¥è¯·æ±‚çš„postå‚æ•°ï¼Œè‹¥æœ‰å°†å®ƒå­˜å‚¨èµ·æ¥ï¼Œä¾›æµ‹è¯•ä½¿ç”¨ã€‚
    if conf.method == HTTPMETHOD.POST and conf.data is None:
        logger.warn("detected empty POST body")
        conf.data = ""
    if conf.data is not None:
          conf.method = conf.method or HTTPMETHOD.POST
# ...
    conf.parameters[PLACE.POST] = conf.data

# ...
# æ£€æŸ¥æ˜¯å¦æœ‰getå‚æ•°ã€postå‚æ•°ã€‚ 
    if re.search(URI_INJECTABLE_REGEX, conf.url, re.I) and not any(place in conf.parameters for place in (PLACE.GET, PLACE.POST)) and not kb.postHint and kb.customInjectionMark not in (conf.data or "") and conf.url.startswith("http"):

# è‹¥æ²¡æœ‰æ‰¾åˆ°getå‚æ•°å’Œpostå‚æ•°ï¼Œç³»ç»Ÿä¼šå‘å‡ºè­¦å‘Šä¿¡æ¯ã€‚
      warnMsg = "you've provided target URL without any GET "
warnMsg += "parameters (e.g. 'http://www.site.com/article.php?id=1') "
warnMsg += "and without providing any POST parameters "
warnMsg += "through option '--data'"
logger.warn(warnMsg)
message = "do you want to try URI injections "
message += "in the target URL itself? [Y/n/q] "

# ...
# å¾ªç¯æ£€æŸ¥ç›®æ ‡æ˜¯å¦æœ‰æ³¨å…¥ç‚¹æ ‡è®°å‚æ•°ã€‚
for place, value in ((PLACE.URI, conf.url), (PLACE.CUSTOM_POST, conf.data), (PLACE.CUSTOM_HEADER, str(conf.httpHeaders))):
    if place == PLACE.CUSTOM_HEADER and any((conf.forms, conf.crawlDepth)):
        continue

    _ = re.sub(PROBLEMATIC_CUSTOM_INJECTION_PATTERNS, "", value or "") if place == PLACE.CUSTOM_HEADER else value or ""
    if kb.customInjectionMark in _:

#     ...
# æ‰¾åˆ°äº†æ³¨å…¥ç‚¹æ ‡è®°å‚æ•°å°±å°†å®ƒå­˜å‚¨åœ¨å­—å…¸ä¸­ï¼Œä¾›åé¢æµ‹è¯•ä½¿ç”¨ã€‚
conf.paramDict[place]["%s #%d%s" % (header, i + 1, kb.customInjectionMark)] = "%s,%s" % (header, "".join("%s%s" % (parts[j], kb.customInjectionMark if i == j else "") for j in xrange(len(parts))))

# æ£€æŸ¥æ˜¯å¦æœ‰cookieå‚æ•°ï¼Œè‹¥æœ‰å°±å°†å®ƒå­˜å‚¨èµ·æ¥ï¼Œä¾›åé¢æµ‹è¯•ä½¿ç”¨ã€‚
if conf.cookie:
    conf.parameters[PLACE.COOKIE] = conf.cookie
    paramDict = paramToDict(PLACE.COOKIE, conf.cookie)

    if paramDict:
        conf.paramDict[PLACE.COOKIE] = paramDict
        testableParameters = True

#    ...
# æ£€æŸ¥æ˜¯å¦æœ‰headerå‚æ•°ï¼Œè‹¥æœ‰å°±å°†å®ƒå­˜å‚¨èµ·æ¥ï¼Œä¾›åé¢æµ‹è¯•ä½¿ç”¨ã€‚
if conf.httpHeaders:
    for httpHeader, headerValue in list(conf.httpHeaders):
        # Url encoding of the header values should be avoided
        # Reference: http://stackoverflow.com/questions/5085904/is-ok-to-urlencode-the-value-in-headerlocation-value
        if httpHeader.upper() == HTTP_HEADER.USER_AGENT.upper():
            conf.parameters[PLACE.USER_AGENT] = urldecode(headerValue)

#    ...
# æ£€æŸ¥csrf tokenå‚æ•°ã€‚
#å½“csrf tokenå‚æ•°å­˜åœ¨ã€‚
if conf.csrfToken:

# æ£€æŸ¥getã€postã€cookieã€header valueså‚æ•°ä¸­æ˜¯å¦æœ‰anti-csrf tokenå‚æ•°ã€‚ï¼ˆanti-csrf tokenæ˜¯ä¸€ä¸ªç”¨æ¥é˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ è®¾ç½®çš„å‚æ•°ã€‚ï¼‰
    if not any(re.search(conf.csrfToken, ' '.join(_), re.I) for _ in (conf.paramDict.get(PLACE.GET, {}), conf.paramDict.get(PLACE.POST, {}), conf.paramDict.get(PLACE.COOKIE, {}))) and not re.search(r"\b%s\b" % conf.csrfToken, conf.data or "") and conf.csrfToken not in set(_[0].lower() for _ in conf.httpHeaders) and conf.csrfToken not in conf.paramDict.get(PLACE.COOKIE, {}) and not all(re.search(conf.csrfToken, _, re.I) for _ in conf.paramDict.get(PLACE.URI, {}).values()):
        errMsg = "anti-CSRF token parameter '%s' not " % conf.csrfToken._original
        errMsg += "found in provided GET, POST, Cookie or header values"

# å¦‚æœè¿™äº›å‚æ•°ä¸­éƒ½æ²¡æœ‰anti-csrf tokenå‚æ•°ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šæŠ¥é”™ã€‚
        raise SqlmapGenericException(errMsg)

# å½“csrf tokenå‚æ•°ä¸å­˜åœ¨ã€‚
else:
    for place in (PLACE.GET, PLACE.POST, PLACE.COOKIE):
        if conf.csrfToken:
            break

# åˆ¤æ–­æ³¨å…¥ç‚¹æ ‡è®°çš„å‚æ•°æ˜¯å¦éœ€è¦csrf tokenä¿¡æ¯ã€‚
        for parameter in conf.paramDict.get(place, {}):
            if any(parameter.lower().count(_) for _ in CSRF_TOKEN_PARAMETER_INFIXES):
                message = "%sparameter '%s' appears to hold anti-CSRF token. " % ("%s " % place if place != parameter else "", parameter)
                message += "Do you want sqlmap to automatically update it in further requests? [y/N] "
                if readInput(message, default='N', boolean=True):
                    class _(six.text_type):
                        pass
# è®¾ç½®csrf tokenå‚æ•°ã€‚
                    conf.csrfToken = _(re.escape(getUnicode(parameter)))
                    conf.csrfToken._original = getUnicode(parameter)
                    break
```

### æ£€æµ‹waf

åœ¨å®Œæˆä¸Šè¿°æ­¥éª¤ä¹‹åï¼Œsqlmapå°±å®Œæˆäº†é’ˆå¯¹æ³¨å…¥æµ‹è¯•ç›®æ ‡çš„å‚æ•°é…ç½®å·¥ä½œã€‚é…ç½®å®Œå‚æ•°åï¼Œsqlmapå°±å¯ä»¥å¼€å§‹è¿é€šæ€§çš„æ£€æµ‹äº†ï¼Œé€šè¿‡è¿™ä¸€æ­¥æ¥åˆ¤æ–­ç›®æ ‡æ˜¯å¦å¯ä»¥è®¿é—®ã€‚å¦‚æœè¯¥ç›®æ ‡æ— æ³•è¿æ¥ä¸Šï¼Œé‚£ä¹ˆsqlmapå°±ä¼šè·³è¿‡å¯¹å½“å‰ç›®æ ‡çš„æ£€æµ‹ï¼›å¦‚æœå¯ä»¥è¿æ¥åˆ°ç›®æ ‡ï¼Œé‚£ä¹ˆsqlmapå°±ä¼šå¼€å§‹åˆ¤æ–­è¯¥ç›®æ ‡æ˜¯å¦æœ‰wafä¿æŠ¤ã€‚è¿™æ˜¯å› ä¸ºwafçš„å­˜åœ¨ä¼šå¯¹sqlmapçš„SQLæ³¨å…¥æµ‹è¯•æœ‰å¾ˆå¤§çš„å½±å“ï¼Œæ‰€ä»¥sqlmapä¼šåœ¨æ³¨å…¥æµ‹è¯•å‰ï¼Œåˆ¤æ–­wafæ˜¯å¦å­˜åœ¨ã€‚

```python
# é€ä¸ªç›®æ ‡åˆ¤æ–­ã€‚
for targetUrl, targetMethod, targetData, targetCookie, targetHeaders in kb.targets:

# ...
setupTargetEnv()

# å¦‚æœè¿æ¥ä¸ä¸Šï¼Œè·³è¿‡å½“å‰æµ‹è¯•ç›®æ ‡ã€‚
if not checkConnection(suppressOutput=conf.forms):
    continue

# ...
# å¦‚æœå¯ä»¥è¿æ¥ä¸Šï¼Œåˆ¤æ–­ç›®æ ‡æ˜¯å¦å­˜åœ¨wafã€‚
checkWaf()
```

è¿›å…¥åˆ°checkWafå‡½æ•°ä¹‹åï¼Œå¤§å®¶å¯ä»¥ç»“åˆæˆ‘å†™çš„æ³¨é‡Šï¼Œå¯¹è¿™ä¸ªå‡½æ•°è¿›è¡Œç†è§£å’Œå­¦ä¹ ã€‚æˆ‘ä»¬ä¼šå‘ç°ï¼Œç¨‹åºé¦–å…ˆä¼šä»å‡†å¤‡å¥½çš„æ–‡ä»¶ä¸­ï¼Œè·å–å®¹æ˜“å¼•èµ·wafå“åº”çš„ä»£ç ç‰‡æ®µç»„ï¼Œç„¶åç»“åˆä¹‹å‰è®¾ç½®çš„æ³¨å…¥ä½ç½®ä¿¡æ¯ï¼Œå°†å®ƒç»„åˆæˆä¸€ä¸ªpayloadå‘é€ç»™ç›®æ ‡ã€‚è¿™æ ·å°±å¯ä»¥è·å–åˆ°è¯¥payloadå“åº”çš„å€¼ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªå€¼å’Œæ­£å¸¸çš„å“åº”åšæ¯”è¾ƒï¼Œè®¡ç®—å‡ºé¡µé¢ç›¸ä¼¼åº¦çš„å€¼ã€‚

```python
# åˆ¤æ–­wafæ˜¯å¦å­˜åœ¨ã€‚ 
def checkWaf():

# ...
# é»˜è®¤è®¾ç½®ä¸ºæ²¡æœ‰wafï¼Œå¹¶ä¸”é…ç½®å®¹æ˜“å¼•èµ·wafæ‹¦æˆªçš„payloadã€‚
retVal = False
payload = "%d %s" % (randomInt(), IPS_WAF_CHECK_PAYLOAD)

# æ ¹æ®æ³¨å…¥ç‚¹çš„ä½ç½®ï¼Œå†³å®špayloadæ’å…¥çš„ä½ç½®ï¼Œç„¶åå‘é€æµ‹è¯•è¯·æ±‚ï¼Œè·å–å“åº”çš„è¿”å›å€¼ã€‚
if PLACE.URI in conf.parameters:
    place = PLACE.POST
    value = "%s=%s" % (randomStr(), agent.addPayloadDelimiters(payload))
else:
    place = PLACE.GET
    value = "" if not conf.parameters.get(PLACE.GET) else conf.parameters[PLACE.GET] + DEFAULT_GET_POST_DELIMITER
    value += "%s=%s" % (randomStr(), agent.addPayloadDelimiters(payload))

# ...
    try:

# åˆ¤æ–­retValå³é¡µé¢ç›¸ä¼¼åº¦å’Œé¢„è®¾çš„é˜ˆå€¼å¤§å°æ¯”è¾ƒå…³ç³»ã€‚
        retVal = (Request.queryPage(place=place, value=value, getRatioValue=True, noteResponseTime=False, silent=True, raise404=False, disableTampering=True)[1] or 0) < IPS_WAF_CHECK_RATIO
    except SqlmapConnectionException:
        retVal = True
    finally:
        kb.matchRatio = None

# ...
    if retVal:
# ...
        message = "are you sure that you want to "
        message += "continue with further target testing? [Y/n] "

# ...
    return retVal
```

é€šè¿‡æ¯”è¾ƒé¡µé¢ç›¸ä¼¼åº¦çš„å€¼å’Œè®¾å®šçš„é˜ˆå€¼ï¼Œsqlmapå¯ä»¥åˆ¤å®šç›®æ ‡æ˜¯å¦è¢«wafä¿æŠ¤ã€‚å¦‚æœå°äºè®¾å®šçš„é˜ˆå€¼ï¼Œåˆ™ä»£è¡¨è¿™ä¸¤ä¸ªé¡µé¢çš„å†…å®¹å·®åˆ«å¾ˆå¤§ï¼Œsqlmapå°±ä¼šè®¤å®šç›®æ ‡è¢«wafä¿æŠ¤ï¼Œå¦åˆ™å°±ä¼šè®¤ä¸ºç›®æ ‡æ²¡æœ‰wafä¿æŠ¤ã€‚

è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°äº†å¦å¤–ä¸€ä¸ªéå¸¸é‡è¦çš„å‡½æ•°`Request.queryPage`å’Œä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œé¡µé¢ç›¸ä¼¼åº¦ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥ä¸€èµ·å­¦ä¹ ä¸€ä¸‹ä»€ä¹ˆæ˜¯é¡µé¢ç›¸ä¼¼åº¦ï¼Œè€Œå…³äº`Request.queryPage`çš„åŠŸèƒ½å’Œé¡µé¢ç›¸ä¼¼åº¦ç®—æ³•ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€è®²è¯¦ç»†å­¦ä¹ ã€‚

## é¡µé¢ç›¸ä¼¼åº¦

é¡µé¢ç›¸ä¼¼åº¦ï¼Œç®€å•æ¥è®²ï¼Œå°±æ˜¯ä¸¤ä¸ªé¡µé¢å†…å®¹ç›¸ä¼¼ç¨‹åº¦çš„è¡¡é‡ç³»æ•°ã€‚åœ¨sqlmapä¸­ï¼Œè®¡ç®—é¡µé¢ç›¸ä¼¼åº¦ä¸»ä½“ä½¿ç”¨çš„æ˜¯`difflib`æ¨¡å—ä¸­çš„`SequenceMatcher`åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½ç”¨äºæ¯”è¾ƒå¯å“ˆå¸Œç±»å‹çš„åºåˆ—çš„ç›¸ä¼¼ç¨‹åº¦ã€‚å¯å“ˆå¸Œç±»å‹åºåˆ—æŒ‡çš„æ˜¯ï¼Œä¸å¯å˜çš„æ•°æ®ç»“æ„ä¾‹å¦‚å­—ç¬¦ä¸²ã€å…ƒç»„ç­‰ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªè½»æ¾çš„å°ä¾‹å­ï¼Œæ¥åŠ æ·±ä½ å¯¹é¡µé¢ç›¸ä¼¼åº¦çš„ç†è§£ã€‚

```python
import difflib
a='abcd'
b='ab123'
seq=difflib.SequenceMatcher(None,a,b)
d=seq.ratio()
print(d)
# d=0.44444444... 
```

åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬ç”¨SequenceMatcherå‡½æ•°è®¡ç®—äº†å­—ç¬¦ä¸²aå’Œå­—ç¬¦ä¸²bçš„ç›¸ä¼¼åº¦ï¼Œè®¡ç®—çš„ç»“æœä¸ºâ€œ0.4444â€¦â€ã€‚

è¿™ä¸ªå€¼æ˜¯ç”¨â€œ2*M/Tâ€è¿™ä¸ªè¡¨è¾¾å¼è®¡ç®—å‡ºæ¥çš„ï¼Œè¦æƒ³å¾—å‡ºç»“æœï¼Œæˆ‘ä»¬éœ€è¦è·å¾—å˜é‡Må’ŒTçš„å€¼ã€‚å…¶ä¸­Mä¸ºaå’Œbç›¸åŒéƒ¨åˆ†çš„é•¿åº¦ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå› ä¸º`a`å’Œ`b`ç›¸åŒéƒ¨åˆ†ä¸º`ab`ï¼Œæ‰€ä»¥Mçš„ å€¼å°±æ˜¯2ã€‚Tåˆ™æ˜¯aå’Œbçš„é•¿åº¦ä¹‹å’Œï¼Œæ‰€ä»¥Tçš„å€¼ä¸º9ã€‚å› æ­¤ï¼Œè®¡ç®—ç»“æœä¸ºâ€œ2*2/9=0.4444â€¦â€ã€‚

ç›¸ä¿¡é€šè¿‡è¿™ä¸ªä¾‹å­çš„å­¦ä¹ ï¼Œä½ å·²ç»å¯ä»¥æŒæ¡SequenceMatcherå‡½æ•°çš„ç”¨æ³•ï¼Œä¸‹é¢è®©æˆ‘ä»¬è¶çƒ­æ‰“é“ï¼Œè¿›å…¥åˆ°å®æˆ˜è®­ç»ƒä¸­ï¼Œæ¥å·©å›ºæˆ‘ä»¬å¯¹é¡µé¢ç›¸ä¼¼åº¦çš„ç†è§£ã€‚

## å®æˆ˜è®­ç»ƒ

é€šè¿‡åˆšæ‰çš„å­¦ä¹ æˆ‘ä»¬çŸ¥é“ï¼Œsqlmapä¼šè¿ç”¨é¡µé¢ç›¸ä¼¼åº¦æ¥åˆ¤æ–­wafå­˜åœ¨ã€‚ä¸ºäº†è®©ä½ æœ‰æ›´åŠ ç›´è§‚çš„æ„Ÿå—ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å¼€è°œå›¢ä¸­çš„â€œå®‰å…¨ç‹—4.0é¶åœºâ€è¿›è¡Œå®æˆ˜æµ‹è¯•ã€‚

æ‰“å¼€é¶åœºåï¼Œæˆ‘ä»¬è®¿é—®é¶åœº`80`ç«¯å£ä¸‹çš„`inject.php`è·¯å¾„ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰wafä¿æŠ¤çš„ç½‘ç«™ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡getæ–¹å¼ï¼Œä¸Šä¼ ä¸€ä¸ªåä¸º`id`çš„å‚æ•°ã€‚

æˆ‘ä»¬é¦–å…ˆå°†`id`å‚æ•°çš„å€¼è®¾ä¸º1ï¼Œæ­£å¸¸è·å¾—çš„å“åº”å†…å®¹å¦‚ä¸‹ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/40/73/4004325c2d156d4d5660346d77d9f873.png?wh=1084x230)

éšåæˆ‘ä»¬å°†`id`çš„å‚æ•°å€¼è®¾ä¸ºå®¹æ˜“è¢«wafæ‹¦æˆªçš„payloadã€‚

```
*1' and 1=2 union select database(),2 --+*
```

è¿™æ ·å®ƒå°±ä¼šè¢«wafæ‹¦æˆª

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/4c/f9/4c67d223a6e4cde8128a2234386ac7f9.png?wh=1790x1094)

æˆ‘ä»¬å°†è¿™ä¸¤ä¸ªå“åº”çš„å†…å®¹è¿›è¡Œè®°å½•ï¼Œç„¶åè®¡ç®—å®ƒä»¬çš„é¡µé¢ç›¸ä¼¼åº¦ã€‚

```plain
# æ­£å¸¸å“åº”
talent&nbspsec<br /><br/>SELECT first_name,last_name FROM users WHERE user_id = '1'; 

# wafæ‹¦æˆªçš„å“åº”
æ‚¨çš„è¯·æ±‚å¸¦æœ‰ä¸åˆæ³•å‚æ•°ï¼Œå·²è¢«ç½‘ç«™ç®¡ç†å‘˜è®¾ç½®æ‹¦æˆª!å¯èƒ½åŸå› ï¼šæ‚¨æäº¤çš„å†…å®¹åŒ…å«å±é™©çš„æ”»å‡»è¯·æ±‚ã€‚
```

è®¡ç®—å‘ç°ä»–ä»¬çš„é¡µé¢ç›¸ä¼¼åº¦ä¸ºé›¶ï¼Œè¿™ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œå³å­˜åœ¨wafçš„æ‹¦æˆªï¼Œé‚£ä¹ˆä½¿ç”¨payloadå‰åçš„é¡µé¢ç›¸ä¼¼åº¦å°±ä¼šè¾ƒä½ã€‚

## æ€»ç»“

è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å­¦ä¹ äº†sqlmapåœ¨å·¥ä½œæµç¨‹ä¸­è°ƒç”¨çš„ä¸€ä¸ªé‡è¦çš„å‡½æ•°startï¼Œäº†è§£äº†å®ƒçš„åŠŸèƒ½å’Œå¯¹åº”çš„å®ç°æ–¹æ³•ã€‚

ç§‰æŒç€â€œçŸ¥å…¶ç„¶ï¼Œè¿˜è¦çŸ¥å…¶æ‰€ä»¥ç„¶â€çš„ç†å¿µï¼Œæˆ‘ä»¬é™¤äº†è¦çŸ¥é“sqlmapçš„ä½¿ç”¨æ–¹æ³•ï¼Œæ›´è¦äº†è§£å®ƒçš„è®¾è®¡æ€æƒ³å’Œå·¥ä½œåŸç†ã€‚æˆ‘ä»¬åˆ†æäº†å®ƒçš„æºä»£ç ï¼Œäº†è§£åˆ°å®ƒå…·æœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½åŒ…æ‹¬ï¼Œå¾ªç¯å¤„ç†é’ˆå¯¹ç›®æ ‡é…ç½®ã€æµ‹è¯•ç½‘ç»œè¿é€šæ€§ã€é…ç½®HTTPè¯·æ±‚ä¿¡æ¯ã€ä»¥åŠåˆ¤æ–­wafæ˜¯å¦å­˜åœ¨ã€‚

ç”±äºåˆ¤æ–­wafæ˜¯å¦å­˜åœ¨è¾ƒéš¾ç†è§£ï¼Œå¹¶ä¸”å­˜åœ¨ä¸€ä¸ªè¾ƒä¸ºç”Ÿåƒ»çš„æ¦‚å¿µï¼Œé¡µé¢ç›¸ä¼¼åº¦ï¼Œæ‰€ä»¥æˆ‘ç»™ä½ ä»‹ç»äº†sqlmapæ˜¯å¦‚ä½•åˆ¤æ–­wafæ˜¯å¦å­˜åœ¨çš„ã€‚ç»è¿‡åˆ†ææˆ‘ä»¬å‘ç°ï¼Œsqlmapä¼šä½¿ç”¨æ˜“äºå¼•èµ·wafæ‹¦æˆªçš„payloadæ¥è·å–å“åº”ï¼Œå¹¶ä¸”å°†å®ƒå’Œä¸ä½¿ç”¨payloadçš„æ­£å¸¸å“åº”è¿›è¡Œæ¯”è¾ƒï¼Œé€šè¿‡å®ƒä»¬çš„ç›¸ä¼¼åº¦æ¥åˆ¤æ–­wafå­˜åœ¨ã€‚å¦‚æœé¡µé¢ç›¸ä¼¼åº¦é«˜ï¼Œå°±è®¤ä¸ºç›®æ ‡æ²¡æœ‰wafçš„ä¿æŠ¤ï¼Œå¦åˆ™æˆ‘ä»¬å°±è®¤ä¸ºæœ‰wafçš„ä¿æŠ¤ã€‚æœ€åï¼Œæˆ‘ä»¬åœ¨å®æˆ˜ä¸­éªŒè¯äº†è¿™ä¸ªæƒ³æ³•ï¼Œè¯å®äº†sqlmapé€šè¿‡é¡µé¢ç›¸ä¼¼åº¦åˆ¤æ–­wafå­˜åœ¨çš„å¯è¡Œæ€§ã€‚

æˆªæ­¢åˆ°ç›®å‰ï¼Œä½ å·²ç»äº†è§£äº†sqlmapçš„åˆå§‹åŒ–æµç¨‹ï¼Œå’Œé’ˆå¯¹æ¯ä¸ªæµ‹è¯•ç›®æ ‡çš„é…ç½®å’Œæ£€æµ‹æ­¥éª¤ï¼Œä¸‹èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°†ä¼šæ›´åŠ æ·±å…¥åœ°å‰–æsqlmapçš„é¡µé¢ç›¸ä¼¼åº¦ç®—æ³•ï¼Œå¹¶ä¸”ä¼šæ­£å¼ä¸ºä½ è®²è§£SQLæ³¨å…¥æµ‹è¯•ä¹‹å‰çš„å¿…ç»æ­¥éª¤â€“å¯å‘å¼æ³¨å…¥æµ‹è¯•ã€‚

## æ€è€ƒ

é¡µé¢ç›¸ä¼¼åº¦åˆ¤æ–­çš„é˜ˆå€¼åº”è¯¥ä¸å“ªäº›å› ç´ ç›¸å…³å‘¢ï¼Ÿ

æ¬¢è¿åœ¨è¯„è®ºåŒºç•™ä¸‹ä½ çš„æ€è€ƒï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ2ï¼‰</strong></div><ul>
<li><span>DoHer4S</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å¾ˆå¤šWAFè®¾å¤‡ä¼šé˜»æ–­æ¶æ„IPåœ°å€ï¼Œé˜»æ–­çš„å«ä¹‰ä¸ºæ ‡è®°è¯¥IPåœ°å€ï¼Œåœ¨æŸä¸€ä¸ªæ—¶é—´æ®µä¸­è¯¥IPå‘é€çš„è¯·æ±‚éƒ½ä¼šè¢«æ‹¦æˆªï¼Œé‚£ä¹ˆåœ¨æ²¡æœ‰è®¾ç½®WAFçš„å“åº”å†…å®¹æ—¶ï¼Œæ€ä¹ˆåˆ¤æ–­æœªå“åº”ä¸ºWAFæ‹¦æˆªé—®é¢˜è¿˜æ˜¯ç½‘ç»œé—®é¢˜å‘¢ï¼Ÿ

å¯¹äº â€œé¡µé¢ç›¸ä¼¼åº¦åˆ¤æ–­çš„é˜ˆå€¼åº”è¯¥ä¸å“ªäº›å› ç´ ç›¸å…³å‘¢ï¼Ÿâ€ é—®é¢˜ç­”æ¡ˆæˆ‘è®¤ä¸ºï¼š

+ åœ¨æ‹¥æœ‰è¿”å›æŠ¥æ–‡å†…å®¹ä¿¡æ¯çš„æ—¶å€™ï¼Œæ¶ˆé™¤ç›¸åŒçš„å“åº”é¡µé¢ä»£ç  - é¡µè„šã€é¡µçœ‰ã€ç½‘é¡µè¡¨è¯†ã€ç½‘é¡µç±»å‹ã€å†…å®¹ç±»åˆ«ã€æ ‡é¢˜ã€å…³é”®è¯ã€æ‘˜è¦ã€æ­£æ–‡ã€ç›¸å…³é“¾æ¥ç­‰å®¹æ˜“é‡å¤è¦ç´ ï¼Œå†ä½¿ç”¨ç®—æ³•è¿›è¡Œå¯¹æ¯”ã€‚</p>2022-01-25</li><br/><li><span>ifelse</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å­¦ä¹ äº†</p>2023-03-14</li><br/>
</ul>