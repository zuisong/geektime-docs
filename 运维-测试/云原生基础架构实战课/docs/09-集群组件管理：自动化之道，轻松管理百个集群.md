ä½ å¥½ï¼Œæˆ‘æ˜¯æ½˜é‡ã€‚

é€šè¿‡å‰é¢çš„è¯¾ç¨‹ï¼Œæˆ‘ä»¬å­¦ä¹ äº†é€šè¿‡GitOpsçš„æ–¹å¼æ¥ç®¡ç†å…¬æœ‰äº‘é‡Œçš„èµ„æºï¼Œä¹Ÿé¡ºåˆ©åœ°å¯åŠ¨äº†ä¸€ä¸ªKubernetesé›†ç¾¤ã€‚

ä½†æ˜¯åœ¨çœŸæ­£çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸€ä¸ªâ€œå…‰ç§ƒç§ƒâ€çš„é›†ç¾¤ä¸šåŠ¡äººå‘˜æ˜¯æ— æ³•ä½¿ç”¨çš„ã€‚æ¯”å¦‚ä¸šåŠ¡éœ€è¦Ingressæ¥å¯¹å¤–æš´éœ²æµé‡ï¼ŒSREéœ€è¦é›†ç¾¤å†…æœ‰Prometheusæ¥ç›‘æ§æ•´ä¸ªåº”ç”¨çš„çŠ¶æ€ã€‚æ‰€ä»¥åƒIngressã€Prometheusè¿™äº›ç»„ä»¶ä¾ç„¶å±äºåŸºç¡€è®¾æ–½çš„ç®¡ç†èŒƒç•´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¿«é€Ÿã€å¯é å’Œå¯é‡å¤çš„ç®¡ç†Kubernetesé›†ç¾¤ç»„ä»¶ä¹Ÿæ˜¯IaCä¸­çš„ä¸€ç¯ã€‚

æˆ‘ä»¬ä¸å¦¨è¯•ç€æƒ³è±¡ä¸€ä¸‹ï¼Œå‡å¦‚ä½ æ˜¯å…¬å¸Kuberneteså¹³å°ç®¡ç†å‘˜ï¼Œéœ€è¦ç®¡ç†100ä¸ªKubernetesé›†ç¾¤ï¼Œè€Œæ¯ä¸ªé›†ç¾¤éƒ½æœ‰10ä¸ªç»„ä»¶çš„æ—¶å€™ï¼Œä½ åº”è¯¥å¦‚ä½•æ¥åšå‘¢ï¼Ÿ

## å¸¸è§çš„Kubernetesé›†ç¾¤ç»„ä»¶

æˆ‘ä»¬å…ˆçœ‹çœ‹äº¤ä»˜ç»™ä¸šåŠ¡å›¢é˜Ÿä½¿ç”¨çš„Kubernetesé›†ç¾¤ä¸€èˆ¬éœ€è¦å“ªäº›ç»„ä»¶ã€‚

è¿™äº›ç»„ä»¶åˆ†æˆä¸¤ç±»ï¼Œä¸€ç±»æ˜¯æ§åˆ¶å¹³é¢ç»„ä»¶ï¼Œä¸€ç±»æ˜¯æ•°æ®å¹³é¢ç»„ä»¶ã€‚æ§åˆ¶å¹³é¢çš„ç»„ä»¶é‡Œé¢æ¶‰åŠåˆ°ç½‘ç»œæ’ä»¶ã€å®‰å…¨ç»„ä»¶ç­‰ï¼Œæ•°æ®å¹³é¢çš„ç»„ä»¶ä¸»è¦æ˜¯ä»¥Ingressã€cert-mangerå’ŒGrafanaè¿™æ ·çš„ä¸šåŠ¡è¾…åŠ©ç»„ä»¶ä¸ºä¸»ã€‚æˆ‘å°†å¸¸ç”¨çš„Kubernetesé›†ç¾¤ç»„ä»¶ç”¨è¡¨æ ¼çš„å½¢å¼åˆ—åœ¨ä¸‹é¢ï¼Œä¾›ä½ å‚è€ƒã€‚

![](https://static001.geekbang.org/resource/image/1d/9e/1d103fed492785b688ea6066d0becf9e.jpg?wh=3849x2179)

å‰é¢æˆ‘ä»¬é¢„è®¾çš„åœºæ™¯æ˜¯100ä¸ªé›†ç¾¤ï¼Œæ¯ä¸ªé›†ç¾¤10ä¸ªç»„ä»¶ï¼Œé‚£ä¹ˆä¸€å…±å°±æœ‰1000ä¸ªç»„ä»¶ã€‚æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹æœ‰å“ªäº›é€šç”¨çš„ç®¡ç†éœ€æ±‚ï¼Œä¸»è¦æ˜¯ä¸‰ç±»ã€‚

1. **ç»„ä»¶ç±»å‹ç®¡ç†**ï¼šå› ä¸º100ä¸ªé›†ç¾¤å¯èƒ½å› ä¸ºç”¨é€”ä¸åŒï¼Œå°±éœ€è¦é’ˆå¯¹æ€§çš„å®‰è£…ä¸åŒçš„ç»„ä»¶ã€‚ä¾‹å¦‚ç»™AIç”¨çš„GPUé›†ç¾¤å°±éœ€è¦å®‰è£…device-pluginè¿™äº›ç»„ä»¶ï¼Œè€Œæ™®é€šé›†ç¾¤æ˜¾ç„¶ä¸éœ€è¦è¿™æ ·çš„ç»„ä»¶ã€‚
2. **ç»„ä»¶ç‰ˆæœ¬ç®¡ç†**ï¼šè¿™100ä¸ªé›†ç¾¤çš„Kubernetesç‰ˆæœ¬å¯èƒ½ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆä¾èµ–çš„ç»„ä»¶ç‰ˆæœ¬ä¹Ÿä¼šä¸ä¸€æ ·ã€‚ä¾‹å¦‚HPAçš„API versionåœ¨1.21æ—¶å€™æ˜¯v2beta1ï¼Œä½†æ˜¯åˆ°äº†1.24ä¹‹åå°±å‡çº§åˆ°äº†v2ï¼Œé‚£ä¹ˆåœ¨1.21é›†ç¾¤ä¸Šæ¶‰åŠåˆ°HPAçš„ç»„ä»¶å¯èƒ½å°±ä¸èƒ½å®‰è£…æœ€æ–°ç‰ˆæœ¬ã€‚
3. **ç»„ä»¶åŠŸèƒ½ç®¡ç†**ï¼šæˆ‘ä»¬è¿˜å¾—è€ƒè™‘ä¸åŒç¯å¢ƒä¸‹ç»„ä»¶é…ç½®ä¸ä¸€æ ·çš„é—®é¢˜ã€‚æ¯”å¦‚åœ¨æµ‹è¯•ç¯å¢ƒçš„é›†ç¾¤ï¼Œæˆ‘ä»¬éœ€è¦å¼€å¯ç»„ä»¶çš„ä¸€äº›åŠŸèƒ½æ¥åšæµ‹è¯•ï¼Œè€Œåˆ°äº†æ­£å¼çš„ç”Ÿäº§ç¯å¢ƒï¼Œè¿™äº›ç»„ä»¶ä¸­ç”¨æ¥æµ‹è¯•çš„åŠŸèƒ½å°±éœ€è¦å…³é—­ã€‚

åŸºäºè¿™ä¸‰ç±»çš„éœ€è¦ï¼Œæˆ‘ä»¬æ€ä¹ˆåšæ‰èƒ½åŒæ—¶å®ç°éœ€æ±‚å®šåˆ¶ï¼Œè¿˜æœ‰é›†ä¸­ç®¡ç†ç»„ä»¶è¿™ä¸¤ä¸ªè¦æ±‚å‘¢ï¼Ÿ

## å¦‚ä½•æŒ‰éœ€å®šåˆ¶é›†ç¾¤ç»„ä»¶

å…¶å®æˆ‘ä»¬ä»”ç»†æƒ³ä¸€æƒ³ï¼Œè¿™100ä¸ªKubernetesé›†ç¾¤ï¼Œå³ä¾¿æ˜¯ä¸šåŠ¡åœºæ™¯ä¸åŒï¼Œä½†æ˜¯å…¶ä¸­éƒ¨åˆ†é›†ç¾¤ç»„ä»¶éƒ½æ˜¯ä¸€æ ·çš„ã€‚

æˆ‘ä»¬ç»“åˆè‡ªå·±çš„ç»éªŒï¼Œå¾ˆå®¹æ˜“å°±èƒ½æ‰¾åˆ°ä¸€äº›å…±æ€§è§„å¾‹ã€‚æ¯”å¦‚è¯´ï¼Œé›†ç¾¤æ€»éœ€è¦ç›‘æ§å§ï¼Ÿé‚£ä¹ˆå°±éœ€è¦é‡‡é›†èŠ‚ç‚¹çŠ¶æ€node-exportorï¼›å†æ¯”å¦‚ï¼Œåº”ç”¨æ€»éœ€è¦å¯¹å¤–æš´éœ²è‡ªå·±æœåŠ¡çš„è®¿é—®åœ°å€å§ï¼Ÿé‚£ä¹ˆingress-controllerä¹Ÿæ˜¯å¿…ä¸å¯å°‘çš„ï¼Œæ‰€ä»¥è¿™äº›å±äºå¿…è¦ç»„ä»¶ã€‚

å’Œå¿…è¦ç»„ä»¶ç›¸å¯¹åº”ï¼Œè¿˜æœ‰ä¸€äº›æ˜¯å¯é€‰çš„åŠŸèƒ½ã€‚æ¯”å¦‚è¯´ï¼Œè™½ç„¶æˆ‘ä»¬è¦å¯¹æ‰€æœ‰é›†ç¾¤è¿›è¡Œç›‘æ§ï¼Œä½†æ˜¯æŸ¥çœ‹ç›‘æ§æ•°æ®çš„ç»„ä»¶Grafanaå¹¶ä¸æ˜¯æ¯ä¸ªé›†ç¾¤éƒ½è¦å®‰è£…ï¼Œåªéœ€è¦å®‰è£…åœ¨æŸä¸€ä¸ªé›†ç¾¤å³å¯ï¼Œæ‰€ä»¥è¿™ç±»ç»„ä»¶å°±å±äºå¯é€‰ç»„ä»¶ã€‚

é‚£ä¹ˆæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥ç»´æŠ¤ä¸€ä¸ªé›†åˆï¼Œæ¥è¡¨è¿°ä¸€ä¸ªé›†ç¾¤éœ€è¦å®‰è£…å“ªäº›ç»„ä»¶å‘¢ï¼Ÿä¸ºäº†å¸®ä½ ç†è§£è¿™ä¸ªé›†ç¾¤ç»„ä»¶é›†åˆå¦‚ä½•å®ç°ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€æ®µéå¸¸ç®€å•çš„yamlé…ç½®æ–‡ä»¶ç¤ºä¾‹ã€‚

```yaml
---
addons:
  ingress:
    enabled: true
  grafana:
    enabled: false
  node-exportor:
    enabled: true
```

ç†Ÿæ‚‰helmçš„åŒå­¦ï¼Œçœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯è§‰å¾—æœ‰ç‚¹çœ¼ç†Ÿï¼Ÿåœ¨helmçš„values.yamlä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šçœ‹åˆ° `enabled: false` æˆ–è€…æ˜¯ `enabled: true` è¿™ä¸ªå­—æ®µï¼Ÿæ—¢ç„¶åœ¨helmä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `enabled` è¿™ä¸ªå…³é”®è¯æ¥å†³å®šæ˜¯å¦å¼€å¯åŠŸèƒ½ï¼Œé‚£æˆ‘ä»¬æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥å¥—ç”¨åœ¨è¿™é‡Œå‘¢ï¼Ÿ

è¿™è‚¯å®šæ˜¯å¯ä»¥çš„ã€‚è¿™æ—¶å€™æˆ‘ä»¬è¿˜éœ€è¦é…å¥—ä½¿ç”¨ä¸€ä¸ª[æŠ€å·§](https://helm.sh/docs/howto/charts_tips_and_tricks/#complex-charts-with-many-dependencies)ï¼Œè¿™ä¸ªæŠ€å·§æ¥è‡ªå®˜æ–¹æ–‡æ¡£ã€‚

> The current best practice for composing a complex application from discrete parts is to create a top-level umbrella chart that exposes the global configurations, and then use the charts/ subdirectory to embed each of the components.

ä¸­æ–‡ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼š

> æ„å»ºå¤æ‚åº”ç”¨çš„æœ€ä½³å®è·µæ˜¯åˆ›å»ºé¡¶å±‚çš„ä¼çŠ¶ Chart (umbrella chart)ï¼Œç”¨äºæš´éœ²å…¨å±€é…ç½®ï¼Œç„¶åä½¿ç”¨ charts/ å­ç›®å½•åµŒå…¥æ¯ä¸ªç»„ä»¶ã€‚

é‚£ä¹ˆå¦‚ä½•ç†è§£é¡¶å±‚çš„umbrella chartå‘¢ï¼Ÿ

ç»“åˆæˆ‘ä»¬ä¸Šé¢ç¤ºä¾‹çš„yamlé…ç½®æ–‡ä»¶ï¼Œaddonsè¿™ä¸ªé¡¶å±‚çš„ä¼çŠ¶chartï¼Œåœ¨addonsè¿™ä¸ªcharté‡Œï¼Œä¼šé€šè¿‡ `enabled` è¿™ä¸ªå­—æ®µæ¥å†³å®šæ˜¯å¦åœ¨é›†ç¾¤ä¸Šå¯ç”¨è¿™äº›ç»„ä»¶ã€‚ä½ å¯ä»¥ç»“åˆä¸‹å›¾æ¥ç†è§£åŸç†ã€‚

![](https://static001.geekbang.org/resource/image/30/3d/3077273aee4bf9dc72452b27127d793d.jpg?wh=3000x2093)

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œåœ¨é¡¶å±‚çš„chartä¸­åŒ…å«å­ç³»ç»Ÿçš„chartï¼Œè¿™ä¸ªéœ€æ±‚è¦å¦‚ä½•å®ç°å‘¢ï¼Ÿ

æˆ‘ä»¬éœ€è¦ç»“åˆéƒ¨ç½²é›†ç¾¤ç»„ä»¶çš„è¿‡ç¨‹æ¥æ‰¾åˆ°ç­”æ¡ˆã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±åˆ†ä¸‰æ­¥èµ°ï¼Œå…ˆä»éƒ¨ç½²å•ä¸ªé›†ç¾¤ç»„ä»¶å…¥æ‰‹ï¼Œç„¶åå‡çº§åˆ°åŒæ—¶éƒ¨ç½²å¤šä¸ªé›†ç¾¤ç»„ä»¶ï¼Œæœ€åå†è¿›å…¥å¦‚ä½•éƒ¨ç½²å¤šä¸ªé›†ç¾¤çš„ç»„ä»¶ã€‚

## ArgoCDï¼šå¦‚ä½•éƒ¨ç½²å•ä¸ªç»„ä»¶

æˆ‘ä»¬ä¸€èˆ¬ä¼šé€šè¿‡Helmé…åˆArgoCDè¿™ä¸ªå·¥å…·æ¥éƒ¨ç½²**å•ä¸ª**é›†ç¾¤ç»„ä»¶ã€‚è¿™é‡Œæˆ‘ä»¥éƒ¨ç½²Grafanaä¸ºä¾‹ï¼Œå¿«é€Ÿåœ°è®²ä¸€ä¸‹ArgoCDéƒ¨ç½²å•ä¸ªç»„ä»¶çš„è¿‡ç¨‹ï¼Œä¸€å…±åˆ†ä¸¤æ­¥ã€‚

ç¬¬ä¸€æ­¥ï¼Œåœ¨ArgoCDä¸­é…å¥½Helmçš„ä»“åº“ã€‚ä½ å¯ä»¥é€šè¿‡ArgoCDçš„UIæ¥æ·»åŠ Helmä»“åº“ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œæ¥æ·»åŠ ä»“åº“ã€‚è¿™é‡Œçš„æ“ä½œä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬å…ˆåœ¨UIä¸­ç‚¹å‡»settings -&gt; Repositories -&gt; connect repoï¼Œç„¶åé€‰æ‹©repoçš„ç±»å‹ä¸ºhelmï¼Œå†å¡«ä¸Šrepoçš„URLå³å¯ã€‚

![](https://static001.geekbang.org/resource/image/78/7e/78769a24cee8330100d23af66eb79d7e.jpg?wh=2000x2308)  
å½“æ­£ç¡®é…ç½®äº†helm repoä¹‹åï¼ŒArgoCDä¸­å°±ä¼šæ˜¾ç¤ºsuccessfulçš„æç¤ºã€‚

![](https://static001.geekbang.org/resource/image/d3/e1/d3a5b1952d74955b2384abcaf66313e1.jpg?wh=2020x204)

ç¬¬äºŒæ­¥ï¼Œé€šè¿‡UIæˆ–è€…Kuberneteså‘½ä»¤è¡Œåˆ›å»ºArgoCDçš„Applicationï¼Œé…ç½®å¥½ç›¸å…³å‚æ•°å³å¯éƒ¨ç½²ã€‚

```go
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: grafana
  namespace: argocd
spec:
  destination:
    namespace: addons-system
    server: https://Kubernetes.default.svc
  project: default
  source:
    chart: grafana
    repoURL: https://grafana.github.io/helm-charts
    targetRevision: 7.2.4
  syncPolicy:
    automated: {}
```

å®Œæˆä¸Šé¢çš„æ­¥éª¤ä»¥åï¼Œæœ€ç»ˆæˆ‘ä»¬å°±ä¼šçœ‹åˆ°Grafanaéƒ¨ç½²åœ¨äº†é›†ç¾¤ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://static001.geekbang.org/resource/image/62/e1/621e075099fe7806609e6e26dc89f3e1.jpg?wh=2020x1344)

## umbrella chart - ç®¡ç†é›†ç¾¤æ‰€æœ‰ç»„ä»¶

ä¸€ä¸ªç»„ä»¶æ˜¯è¿™æ ·éƒ¨ç½²çš„ï¼Œå…¶ä»–ç»„ä»¶ä¹ŸåŒç†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰çš„é›†ç¾¤ç»„ä»¶éƒ½å¯ä»¥é€šè¿‡Helmé…åˆArgoCDéƒ¨ç½²ã€‚è€Œumbrella chartè¦åšçš„äº‹æƒ…ï¼Œå°±æ˜¯æ ¹æ® `enabled` è¿™ä¸ªå­—æ®µï¼Œæ¸²æŸ“å‡ºæ‰€éœ€è¦çš„Applicationï¼Œè¿™æ ·ä¸å°±å¯ä»¥è§£å†³æˆ‘ä»¬çš„éœ€æ±‚äº†å—ï¼Ÿ

æˆ‘ä»¬è¿™å°±æ¥çœ‹çœ‹å…·ä½“å®ç°æ€è·¯ï¼Œæˆ‘ä»¬å…ˆä¸ºArgoCDçš„Applicationè¿™ç±»èµ„æºè‡ªå®šä¹‰ä¸€ä¸ªhelm chartåŒ…ï¼Œå°†å˜åŒ–çš„å‚æ•°è½¬å˜æˆå¯é…ç½®çš„valueã€‚ä½ å¯ä»¥å…ˆçœ‹çœ‹ä¸‹é¢çš„é…ç½®ç¤ºä¾‹ ï¼Œå†å¬æˆ‘åˆ†æã€‚

åœ¨templateä¸­grafana.yamlä¸­ï¼Œæˆ‘ä»¬ç”¨ `addon.enabled` æ¥æ§åˆ¶helmæ˜¯å¦æ¸²æŸ“å‡ºè¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå¦‚æœenabledæ˜¯trueï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ä¼šæ ¹æ®values.yamlé‡Œé¢çš„å€¼ç”ŸæˆçœŸæ­£çš„ArgoCDçš„é…ç½®æ–‡ä»¶ã€‚ä¸‹é¢æ˜¯grafana argocd applicationçš„æ ·ä¾‹ä»£ç ï¼š

```go
{{- $addon := .Values.addons.grafana }}
{{- if $addon.enabled }}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ $addon.names.app }}
  namespace: argocd
spec:
  destination:
    namespace: {{ $addon.namespace | default "addons-system" }}
    server: https://Kubernetes.default.svc
  project: default
  source:
    chart: {{ $addon.names.chart }}
    helm:
      valueFiles:
      - values.yaml
    repoURL: {{ $addon.repoURL}}
    targetRevision: {{ $addon.targetVersion }}
  syncPolicy:
    automated: {}
  {{- end }}
```

åŸºäºä¸Šé¢çš„æ ·ä¾‹ä»£ç ï¼Œæˆ‘ä»¬å‘ç°åœ¨helmä¸­çš„valueå®šä¹‰æ— éå°±æ˜¯è¿™ä¹ˆå‡ ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ç”¨æ¥è¯´æ˜æ˜¯å¦åœ¨é›†ç¾¤ä¸­å¯ç”¨ï¼Œchartçš„ä»“åº“åœ°å€ï¼Œè¿˜æœ‰éœ€è¦åœ¨é›†ç¾¤ä¸­å®‰è£…å“ªä¸ªç‰ˆæœ¬ç­‰ç­‰ä¿¡æ¯ã€‚ä½ å¯ä»¥å‚è€ƒåé¢è¿™ä¸ªä¾‹å­çœ‹ä¸€ä¸‹ã€‚

```go
grafana:
  enabled: false
  names:
    app: grafana
    chart: grafana
  repoURL: https://grafana.github.io/helm-charts
  targetVersion: 7.2.4
```

## å¦‚ä½•é›†ä¸­åŒ–ç®¡ç†é›†ç¾¤ç»„ä»¶

å‰é¢ï¼Œæˆ‘ä»¬è§£å†³äº†é›†ç¾¤ç»„ä»¶å®šåˆ¶çš„éœ€æ±‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•é€šè¿‡ä¸€ä»½ä»£ç æ¥ç®¡ç†100ä¸ªé›†ç¾¤çš„ç»„ä»¶å‘¢ï¼Ÿ

Helmé‡Œçš„values.yamlæ˜¯å¯ä»¥é‡‡ç”¨å±‚å±‚é€’è¿›å¼è¦†ç›–çš„ã€‚ä½ å¯ä»¥ç»“åˆåé¢è¿™ä¸ªé…ç½®æ¡ˆä¾‹æ¥ç†è§£ã€‚

```go
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: addons
  namespace: argocd
spec:
  destination:
    namespace: addons-system
    server: https://Kubernetes.default.svc
  project: default
  source:
    chart: addonsmgr
    helm:
      valueFiles:
        - values.yaml
        - values/aks/infra.yaml
    repoURL: https://cloudnative-automation.github.io/addon-manager/repo
    targetRevision: 0.1.*
  syncPolicy:
    automated: {}
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åªè¦ä¸ºæ¯ä¸ªé›†ç¾¤å•ç‹¬é…ç½®ä¸€ä¸ªvalues.yamlï¼Œå°±èƒ½æ§åˆ¶é›†ç¾¤å¯ä»¥å®‰è£…å“ªäº›ç»„ä»¶ã€‚è¿™æ˜¯å› ä¸ºvalueFilesä¼šé»˜è®¤è¯»å–chartåŒ…ä¸­çš„values.yamlï¼Œå¹¶è¦†ç›–æ‰é»˜è®¤çš„valuesã€‚  
ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨ `values/aks/infra.yaml` ä¸­å®šä¹‰äº†Grafanaå¼€å¯ï¼Œè€ŒingressNginxåˆ™æ²¡æœ‰å¼€å¯ï¼Œè¿™æ ·å°±èƒ½ç²¾ç»†åœ°æ§åˆ¶è¿™ä¸ªé›†ç¾¤å¯ä»¥å®‰è£…å“ªäº›ç»„ä»¶ã€‚

```go
---
clusterURL: infra-dev.hcp.japaneast.azmk8s.io

addons:

Â  grafana:
Â  Â  enabled: true

Â  ingressNginx:
Â  Â  enabled: false
```

## æ•ˆæœå›¾

è®©æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™æ ·åšçš„æ•ˆæœå¦‚ä½•ã€‚

![](https://static001.geekbang.org/resource/image/5c/55/5ce6bed3c34efaeb3100f2f66ef46a55.jpg?wh=2020x873)

å¯¹ç…§æˆªå›¾å¯ä»¥çœ‹åˆ°ï¼Œaddonsæ˜¯é¡¶å±‚çš„umbrella chartï¼Œåœ¨è¿™ä¸ªé›†ç¾¤ä¸­ï¼ŒGrafanaæ˜¯å®ƒçš„å­chartã€‚è¯¦ç»†ä»£ç æˆ‘å·²ç»æ”¾åœ¨ [GitHub](https://github.com/cloudnative-automation/addon-manager/tree/main/addons) ä¸Šï¼Œä½ å¯ä»¥ç»“åˆæˆ‘å‰é¢çš„è®²è¿°æ¥æ·±å…¥ç†è§£ã€‚

çœ‹åˆ°è¿™é‡Œï¼Œæœ‰åŒå­¦å¯èƒ½ä¼šé—®ï¼Œæƒ³è¦å»ºç«‹100ä¸ªé›†ç¾¤ï¼Œå²‚ä¸æ˜¯è¦æ‰§è¡Œ100æ¬¡åˆ›å»ºå‘½ä»¤äº†ä¹ˆï¼Ÿ

è¿™ä¸€ç‚¹å…¶å®ä½ æ— éœ€æ‹…å¿ƒã€‚åœ¨å·¥ä½œä¸­ï¼Œæˆ‘ä»¬åŒæ—¶å»ºç«‹çš„é›†ç¾¤ä¸€èˆ¬ä¸è¶…è¿‡10ä¸ªã€‚æˆ‘ä»¬åªæ˜¯åœ¨é›†ç¾¤åˆå§‹åŒ–æ—¶ï¼Œæ‰ä¼šå»åˆ›å»ºè¿™ä¸ªaddonsçš„applicationï¼Œéƒ¨ç½²addonsè¿™ä¸ªé¡¶å±‚chartã€‚ä¹‹åï¼ŒArgoCDå°†ä¼šé€šè¿‡ `targetRevision: 0.1.*` è¿™æ ·çš„æ–¹å¼æ¥ç›‘å¬Helmä»“åº“çš„å˜åŒ–ï¼Œä¸€æ—¦æœ‰æ–°çš„ç‰ˆæœ¬å‡ºç°ï¼Œä¾¿ä¼šè‡ªå·±åŒæ­¥è¿‡æ¥ï¼Œè¿›è¡Œæ›´æ–°ã€‚

## å¦‚ä½•ç»´æŠ¤helm chartçš„ä»“åº“åœ°å€

é™¤äº†åˆ›å»ºå‘½ä»¤æ‰§è¡Œçš„è‡ªåŠ¨åŒ–ï¼Œå¯¹äºhelm charçš„ä»“åº“åœ°å€çš„ç»´æŠ¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªåŠ¨åŒ–å®ç°ã€‚

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªå­chartéƒ½æœ‰ä¸€ä¸ªrepoURLçš„é…ç½®ï¼Œå¸¸ç”¨çš„ç®¡ç†æ–¹å¼æœ‰ä¸¤ç§æ–¹å¼ã€‚

ç¬¬ä¸€ç§æ˜¯è‡ªå·±ç»´æŠ¤ä¸€ä¸ªchart repoï¼Œå°†æ‰€æœ‰éœ€è¦å®‰è£…çš„chartåŒ…å¯¼å…¥è‡ªå·±ç»´æŠ¤çš„repoä¸­ï¼ŒåŒå­¦ä»¬å¯ä»¥å‚è€ƒè¯¾ç¨‹ [GitHubä»“åº“](https://github.com/cloudnative-automation/addon-manager/tree/main)ä¸­å…³äºè‡ªå»ºchartä»“åº“çš„è¯´æ˜ã€‚

ç¬¬äºŒç§æ˜¯ä¾ç„¶ä½¿ç”¨åŸå§‹chartçš„ä»“åº“åœ°å€ï¼Œè¿™é‡Œéœ€è¦ä¿è¯é›†ç¾¤ç¯å¢ƒç½‘ç»œå¯¹å¤–çš„è¿é€šæ€§ã€‚

```go
source:
  chart: grafana
  repoURL: https://grafana.github.io/helm-charts
  targetRevision: 7.2.4
```

æ— è®ºæ˜¯å“ªä¸€ç§ç®¡ç†æ–¹å¼ï¼Œéƒ½éœ€è¦æå‰å°†Chartçš„Repositorieså¯¼å…¥ArgoCDã€‚è¿™ä¸€è®²é‡Œæˆ‘å·²ç»å†™äº†å¦‚ä½•åœ¨ArgoCDä¸­å¯¼å…¥ä»“åº“çš„æ–¹æ³•ï¼Œè¿™æ­¥åŠ¨ä½œä¹Ÿæ˜¯åœ¨é›†ç¾¤åˆå§‹åŒ–çš„æ—¶å€™å…ˆå®Œæˆï¼Œä½ å¯ä»¥æŠŠåé¢è¿™æ®µä»£ç æ”¾åœ¨Terraformçš„ä»£ç ä¸­ã€‚

```yaml
resource "repo_resource" "add helm repos" {

Â  provisioner "local-exec" {
Â  Â  command = <<EOF
Â  Â  Â  argocd repo add https://charts.jetstack.io --username devops;
Â  Â  EOF

Â  Â  environment = {
Â  Â  Â  AWS_REGION = var.region
Â  Â  }
Â  }
```

## GitOpsç»´æŠ¤

è®²åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†æ‰€æœ‰çš„å·¥ä½œã€‚

å¦‚æœæˆ‘ä»¬æƒ³åœ¨æŸä¸ªé›†ç¾¤é‡Œæ‰“å¼€ä¸€ä¸ªç»„ä»¶ï¼Œåº”è¯¥å¦‚ä½•æ“ä½œå‘¢ï¼Ÿ

ä¾‹å¦‚æˆ‘ä»¬åœ¨é›†ç¾¤ä¸­æ‰“å¼€cert- managerè¿™ä¸ªç»„ä»¶ï¼Œåªéœ€è¦æäº¤ä¸€ä¸ªPRï¼Œç»è¿‡ä»£ç çš„å®¡æ ¸ï¼Œç„¶åmergeè¿›ä»£ç ä¸»å¹²ã€‚  
![](https://static001.geekbang.org/resource/image/e6/90/e6f1770cabd5574dd08ae1fc6d32b090.jpg?wh=2000x1471)

è¿™æ ·å°±èƒ½è§¦å‘GitHub Actionçš„æµæ°´çº¿ï¼Œå°†æˆ‘ä»¬çš„Chartè‡ªåŠ¨æ‰“åŒ…å¹¶ä¸Šä¼ åˆ°é•œåƒä»“åº“ï¼ŒArgoCDç›‘æµ‹åˆ°chartç‰ˆæœ¬å˜åŒ–ä¹‹åå¼€å§‹æ›´æ”¹é›†ç¾¤ç»„ä»¶é…ç½®ã€‚

![](https://static001.geekbang.org/resource/image/5a/eb/5a25ebd86034150591422befe1f18deb.jpg?wh=2000x728)

å¦‚æœæˆ‘ä»¬éœ€è¦å›æ»šæŸä¸ªé…ç½®ï¼Œåªéœ€è¦é‡æ–°æäº¤ä¸€ä¸ªgit revertçš„PRï¼Œä¹‹åGitHub Actionçš„æµæ°´çº¿ä»¥åŠArgoCDä¼šéµå¾ªåŒæ ·çš„æ–¹æ³•éƒ¨ç½²å‡ºå»ã€‚

è¿›è¡Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å®è·µäº†å¦‚ä½•ç”¨GitOpsæ–¹å¼æ¥ç®¡ç†Kubernetesé›†ç¾¤é…ç½®ã€‚åœ¨è¿™ä¸ª[ä»“åº“](https://github.com/cloudnative-automation/addon-manager/tree/main)é‡Œï¼Œä½ å¯ä»¥çœ‹åˆ°æ•´ä¸ªé›†ç¾¤çš„é…ç½®æ›´æ”¹å†å²ï¼Œéƒ½æ˜¾ç¤ºåœ¨Gitçš„commitä¸­ï¼Œè€Œä¸”ä½¿ç”¨äº†Gitä½œä¸ºå”¯ä¸€çœŸå®æ•°æ®æºçš„è¿ç»´æ¨¡å¼ã€‚

![](https://static001.geekbang.org/resource/image/d3/78/d30e37d6753bd0a2fb9babcb6b1e7b78.jpg?wh=2020x709)  
è¿™ç§æ–¹å¼æä¾›äº†ç‰ˆæœ¬æ§åˆ¶ã€å®¡è®¡æ—¥å¿—ä»¥åŠå›æ»šç­‰åŠŸèƒ½ï¼Œå®Œæ•´åœ°å®ç°äº†æˆ‘ä»¬åœ¨è¯¾ç¨‹æœ€åˆæå‡ºæ¥çš„**å¿«é€Ÿ**ã€**å¯é **å’Œ**å¯é‡å¤**çš„éƒ¨ç½²å’Œç®¡ç†è¿‡ç¨‹ã€‚

## æ€»ç»“

ä»Šå¤©è¿™ä¸€è®²æ˜¯åŸºç¡€æ¶æ„è‡ªåŠ¨åŒ–ç®¡ç†ä¸­ç›¸å½“é‡è¦çš„ä¸€èŠ‚è¯¾ã€‚

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®©KubernetesåŸºç¡€ç»„ä»¶æ—¢å¯ä»¥æŒ‰éœ€æ±‚å®šåˆ¶ï¼Œåˆèƒ½å¤Ÿé›†ä¸­ç®¡ç†ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä»æˆ‘ä»¬umbrella chartåˆ‡å…¥ä¸ºä½ åšäº†è¯¦ç»†æ¼”ç¤ºã€‚

æˆ‘ä»¬å…ˆä»éƒ¨ç½²å•ä¸ªé›†ç¾¤ç»„ä»¶å…¥æ‰‹ï¼Œç„¶åå‡çº§åˆ°åŒæ—¶éƒ¨ç½²å¤šä¸ªé›†ç¾¤ç»„ä»¶ï¼Œæœ€åå†è¿›å…¥å¦‚ä½•éƒ¨ç½²å¤šä¸ªé›†ç¾¤çš„ç»„ä»¶ã€‚

ç”±æ­¤ï¼Œæˆ‘ä»¬å°±è§£å†³äº†åŸºç¡€è®¾æ–½è‡ªåŠ¨åŒ–ç®¡ç†çš„æœ€åä¸€å…¬é‡Œ ï¼Œä¹Ÿå°±æ˜¯Kubernetesé›†ç¾¤äº¤ä»˜ã€‚åŒæ—¶ä¹Ÿéµå¾ªäº†æˆ‘ä»¬åœ¨è¯¾ç¨‹æœ€åˆæå‡ºçš„**å¿«é€Ÿ**ã€**å¯é **å’Œ**å¯é‡å¤**çš„éƒ¨ç½²å’Œç®¡ç†è¿‡ç¨‹ã€‚

åˆ°ä»Šå¤©ä¸ºæ­¢ï¼Œæˆ‘ä»¬å®Œæˆäº†åŸºç¡€è®¾æ–½å³ä»£ç ç¯èŠ‚ï¼Œä½†æ˜¯ç›®å‰æˆ‘ä»¬ä»…ä»…å®Œæˆäº†äº¤ä»˜ç»™ä¸šåŠ¡ä½¿ç”¨çš„ç¯èŠ‚ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¦‚ä½•ä¿è¯äº¤ä»˜çš„åŸºç¡€è®¾æ–½çš„å¯ç”¨æ€§ä¸ç¨³å®šæ€§å‘¢ï¼Ÿè¿™äº›é—®é¢˜åé¢æˆ‘ä»¬å†ç»§ç»­è®¨è®ºï¼Œæ•¬è¯·æœŸå¾…ã€‚

## æ€è€ƒé¢˜

è¯·ä½ æ ¹æ®[ä»£ç ä»“åº“](https://github.com/cloudnative-automation/addon-manager/tree/main)é‡Œæä¾›çš„æ ·ä¾‹ï¼Œæ¥å®Œæˆå…¶ä»–é›†ç¾¤ç»„ä»¶çš„éƒ¨ç½²ã€‚

```yaml
---
clusterURL: 127.0.0.1

addons:

  namespaces:
    default: addons-system

  grafana:
    enabled: false
    names:
      app: grafana
      chart: grafana
    repoURL: https://grafana.github.io/helm-charts
    targetVersion: 7.2.4
  
  ingressNginx:
    enabled: false
    names:
      app: ingress-nginx
      chart: ingress-nginx/ingress-nginx
    repoURL: https://kubernetes.github.io/ingress-nginx
    targetVersion: 4.9.0
```

æ¬¢è¿åœ¨è¯„è®ºåŒºä¸æˆ‘è®¨è®ºã€‚å¦‚æœè¿™ä¸€è®²å¯¹ä½ æœ‰å¯å‘ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™èº«è¾¹æ›´å¤šæœ‹å‹ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ5ï¼‰</strong></div><ul>
<li><span>cfanbo</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä¸Šä¸€èŠ‚ä»‹ç»äº†tektonï¼Œä¸ºä»€ä¹ˆè¿™èŠ‚æ‰ç”¨äº†argoCDï¼Œæ˜¯å› ä¸ºä»€ä¹ˆåŸå› ï¼Ÿç”Ÿæ€ï¼Ÿ</p>2024-04-15</li><br/><li><span>cfanbo</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å®ƒä¸argoCDæ¯”è¾ƒæœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ</p>2024-04-15</li><br/><li><span>Geek_45a572</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆæ‚¨å¥½ï¼Œå¦‚ä½•å®Œæ•´çš„æ‹‰èµ·ä¸€å¥—ç³»ç»Ÿå‘¢ï¼Ÿåƒäº‘æœåŠ¡çš„rdsç­‰å…¶ä»–saasæœåŠ¡å¦‚ä½•é›†æˆåˆ°terraformï¼Ÿ æ•°æ®åº“çš„å‚æ•°æ˜¯å¦éœ€è¦terraformç®¡ç†å‘¢ï¼Ÿ
</p>2024-04-15</li><br/><li><span>å’¸è›‹è¶…äºº</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ½˜è€å¸ˆï¼Œèƒ½å¦åˆ†äº«ä¸€ä¸‹å†eBayè¿™ç§å…¬å¸æ˜¯æ€ä¹ˆæ ·æ¥ç®¡ç†å’Œè¿ç»´è¿™ä¹ˆå¤šçš„å¤§è§„æ¨¡K8Sé›†ç¾¤ï¼Ÿæ˜¯å¦æœ‰æ–‡ç« æˆ–è€…èµ„æ–™å¯ä»¥åˆ†äº«ä¸‹ï¼Ÿ</p>2024-04-12</li><br/><li><span>kissyoudyb</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å¤ªæœ‰ç”¨äº†ï¼Œèˆ’æœï¼ŒçœŸæ˜¯å¼€äº†çœ¼ç•Œ</p>2024-08-07</li><br/>
</ul>