ä½ å¥½ï¼Œæˆ‘æ˜¯æ½˜é‡ã€‚

å‰é¢ä¸¤è®²ï¼Œæˆ‘ä»¬åˆ†åˆ«ä½¿ç”¨äº†ä¸¤ç§æŒç»­é›†æˆå·¥å…·ï¼ˆGitHub Actionå’ŒTektonï¼‰æ¥å®ç°IaCçš„GitOpsã€‚æœ‰åŒå­¦å¯èƒ½æœ‰ç–‘é—®ï¼Œè‡ªå·±æ‰€åœ¨å…¬å¸é‡Œçš„çº¿ä¸Šç¯å¢ƒä¸æ˜¯å¾ˆå¤§ï¼Œåªæœ‰ä¸¤ä¸‰ä¸ªKubernetesé›†ç¾¤ï¼Œåº”ç”¨ä¹Ÿä¸æ˜¯å¾ˆå¤šï¼Œåå‡ ä¸ªåº”ç”¨è€Œå·²ã€‚ä¸ºè¿™ä¸ªç¯å¢ƒå•ç‹¬æŠ˜è…¾ä¸€å¥—æŒç»­é›†æˆç¯å¢ƒï¼Œä¼¼ä¹æŠ•å…¥äº§å‡ºæ¯”ä¸é«˜ã€‚

é‚£ä¹ˆæœ‰æ²¡æœ‰ä»€ä¹ˆè½»é‡çº§çš„åŠæ³•ï¼ŒåŒæ ·å¯ä»¥å®ç°GitOpsæ–¹å¼ä¸‹çš„IaCç®¡ç†é…ç½®å‘¢ï¼Ÿ

æ²¡é”™ï¼Œè¿™å°±æ˜¯ä»Šå¤©æˆ‘ä»¬è¦å­¦ä¹ çš„ï¼ŒåŸºäºKubernetes Operatoræ¨¡å¼çš„äº‘èµ„æºç®¡ç†æ–¹å¼ã€‚

## Kubernetes Operator

é¦–å…ˆï¼Œæˆ‘ç»™ä¸ç†Ÿæ‚‰Kubernetes Operatorçš„åŒå­¦ä»‹ç»ä¸‹ä»€ä¹ˆæ˜¯Operatorã€‚

### æ§åˆ¶å™¨

å¦‚æœä½ åœ¨Kubernetesä¸­éƒ¨ç½²è¿‡åº”ç”¨ï¼Œåº”è¯¥å¯¹Deploymentæ§åˆ¶å™¨ã€Statefulsetæ§åˆ¶å™¨ï¼Œè¿˜æœ‰Jobæ§åˆ¶å™¨ç›¸å¯¹ç†Ÿæ‚‰ï¼Œè¿™äº›éƒ½å±äºKubernetes å†…ç½®æ§åˆ¶å™¨ï¼Œç”¨äºç®¡ç† Kubernetes é›†ç¾¤ä¸­çš„å„ç§èµ„æºã€‚

é™¤äº†è¿™äº›å¸¸è§çš„æ§åˆ¶å™¨ï¼Œæˆ‘ä»¬æ—¥å¸¸å·¥ä½œé‡Œï¼Œè¿˜æœ‰ä¸‰ç§æ§åˆ¶å™¨ç”¨å¾—æ¯”è¾ƒå¤šã€‚

ç¬¬ä¸€ä¸ªæ˜¯å¸¸ç”¨åœ¨æ—¥å¿—æ”¶é›†ã€ç›‘æ§æ–¹é¢çš„DaemonSetæ§åˆ¶å™¨ã€‚å®ƒçš„ä½œç”¨æ˜¯åœ¨é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹è¿è¡Œå®ˆæŠ¤è¿›ç¨‹ï¼Œç¡®ä¿é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œä¸€ä¸ªPodå‰¯æœ¬ã€‚

ç¬¬äºŒä¸ªæ˜¯Ingressï¼Œç”¨æ¥æ§åˆ¶å¤–éƒ¨æµé‡å¦‚ä½•è®¿é—®é›†ç¾¤ä¸­çš„æœåŠ¡ï¼Œå®ƒçš„ä½œç”¨æ˜¯æ ¹æ®åŸŸåæˆ–è·¯å¾„å°†æµé‡è·¯ç”±åˆ°ä¸åŒçš„æœåŠ¡ã€‚

ç¬¬ä¸‰ä¸ªæ˜¯Serviceï¼Œå®ƒèƒ½å¤Ÿä¸º Pod æä¾›ä¸€ä¸ªç»Ÿä¸€çš„è®¿é—®åœ°å€ï¼Œå³ä½¿ Pod çš„ IP åœ°å€å‘ç”Ÿå˜åŒ–ï¼Œä¹Ÿä¸å½±å“å¯¹å¤–è®¿é—®ã€‚

è¿™äº›å†…ç½®æ§åˆ¶å™¨çš„åŸºæœ¬åŸç†éƒ½æ˜¯ä¸€æ ·çš„ï¼ŒæŒ‰ç…§å·¥ä½œé¡ºåºå¯ä»¥æ¦‚æ‹¬æˆè¿™å‡ ä¸ªæ­¥éª¤ã€‚

é¦–å…ˆï¼Œæ§åˆ¶å™¨é€šè¿‡ Kubernetes API Server ç›‘è§†é›†ç¾¤ä¸­èµ„æºçš„çŠ¶æ€ï¼Œç„¶åæ§åˆ¶å™¨æ ¹æ®ç”¨æˆ·å®šä¹‰çš„èµ„æºé…ç½®è®¡ç®—å‡ºèµ„æºçš„æœŸæœ›çŠ¶æ€ã€‚

æ¥ä¸‹æ¥ï¼Œå¯¹æ¯”å®é™…çŠ¶æ€å’ŒæœŸæœ›çŠ¶æ€ï¼Œå¹¶æ‰¾å‡ºä¸¤è€…ä¹‹é—´çš„å·®å¼‚ã€‚æœ€åï¼Œæ§åˆ¶å™¨æ ¹æ®å·®å¼‚æ‰§è¡Œç›¸åº”çš„æ§åˆ¶æ“ä½œï¼Œè®©å®é™…çŠ¶æ€ä¸æœŸæœ›çŠ¶æ€ä¸€è‡´ã€‚

æˆ‘ä¸¾ä¸ªä¾‹å­æ¥å¸®ä½ åŠ æ·±ç†è§£ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª Deployment èµ„æºï¼Œè¯¥èµ„æºå®šä¹‰äº†ä¸‰ä¸ª Pod å‰¯æœ¬ã€‚æ§åˆ¶å™¨ä¼šç›‘è§† Deployment çš„çŠ¶æ€ï¼Œå¹¶ç¡®ä¿é›†ç¾¤ä¸­å§‹ç»ˆè¿è¡Œç€ä¸‰ä¸ª Pod å‰¯æœ¬ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ª Pod å‰¯æœ¬å¤±è´¥ï¼Œæ§åˆ¶å™¨å°±ä¼šæ£€æµ‹åˆ°è¿™ä¸ªäº‹ä»¶ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„ Pod å‰¯æœ¬æ¥æ›¿æ¢å¤±è´¥çš„ Pod å‰¯æœ¬ã€‚

Kuberneteså†…ç½®äº†äºŒåå¤šç§æ§åˆ¶å™¨ï¼Œä½ å¯ä»¥åœ¨[å®˜æ–¹çš„ä»£ç åº“](https://github.com/kubernetes/kubernetes/tree/master/pkg/controller)é‡Œçœ‹åˆ°å…·ä½“æœ‰å“ªäº›æ§åˆ¶å™¨ï¼Œä¸Šé¢è®²äº†è¿™äº›æ§åˆ¶å™¨çš„å·¥ä½œåŸç†ï¼Œä½ å¯ä»¥è¯¾åæ‹“å±•é˜…è¯»ã€‚

å› ä¸ºæ§åˆ¶å™¨çš„å…±åŒç‰¹æ€§å°±æ˜¯é€šè¿‡ç›‘è§†ï¼ˆlist-watchï¼‰é›†ç¾¤çŠ¶æ€å¹¶æ‰§è¡Œæ§åˆ¶æ“ä½œï¼Œæ¥ç¡®ä¿èµ„æºå§‹ç»ˆå¤„äºæˆ‘ä»¬çš„æœŸæœ›çŠ¶æ€ã€‚å› æ­¤æˆ‘ä»¬å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œåªéœ€è¦å®šä¹‰è‡ªå·±çš„èµ„æºéœ€æ±‚å°±å¯ä»¥äº†ï¼Œå‰©ä¸‹çš„å·¥ä½œæ§åˆ¶å™¨å°±å¯ä»¥å¸®æˆ‘ä»¬å¤„ç†ã€‚

## Kubernetes Operator

Kubernetesä¸ºäº†èƒ½ç®¡ç†æ›´å¤šç±»å‹çš„èµ„æºï¼Œå¼€å‘äº†ä¸€ç§è‡ªå®šä¹‰Kubernetesæ§åˆ¶å™¨çš„æ–¹æ³•ï¼Œå«Kubernetes Operatorã€‚Operatoræ‰©å±•äº† Kubernetes çš„åŠŸèƒ½ï¼Œæœ‰äº†å®ƒçš„å¸®åŠ©ï¼Œæˆ‘ä»¬å°±èƒ½ç”¨è‡ªåŠ¨åŒ–çš„æ–¹å¼ç®¡ç†å’Œè¿ç»´å¤æ‚çš„åº”ç”¨ç¨‹åºå’Œäº‘èµ„æºã€‚

Operator é€šè¿‡å°†åº”ç”¨ç¨‹åºæˆ–äº‘èµ„æºçš„è¿ç»´çŸ¥è¯†è½¬åŒ–ä¸ºå¯ç¼–ç¨‹çš„ä»£ç ï¼Œè®©ä½ èƒ½å¤Ÿå®šä¹‰å’Œç®¡ç†åº”ç”¨ç¨‹åºæˆ–äº‘èµ„æºçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬å®‰è£…ã€é…ç½®ã€æ‰©å±•ã€ç›‘æ§å’Œå‡çº§ç­‰æ–¹é¢ã€‚

Operator çš„æ ¸å¿ƒæ€æƒ³æ˜¯**å°†åº”ç”¨ç¨‹åºçš„è¿ç»´çŸ¥è¯†ç¼–ç ä¸º Kubernetes èµ„æºå’Œæ§åˆ¶å™¨**ã€‚å…·ä½“æ¥è¯´ï¼ŒOperator ä¼šä¸ºåº”ç”¨ç¨‹åºå®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªè‡ªå®šä¹‰èµ„æº ï¼ˆCRDï¼‰ï¼ŒCRD ç”¨äºæè¿°åº”ç”¨ç¨‹åºçš„çŠ¶æ€å’Œé…ç½®ã€‚Operator è¿˜ä¼šä¸ºæ¯ä¸ª CRD åˆ›å»ºä¸€ä¸ªæ§åˆ¶å™¨ï¼Œè¯¥æ§åˆ¶å™¨ä¼šä¸æ–­ç›‘è§†é›†ç¾¤çš„çŠ¶æ€ï¼Œå¹¶æ ¹æ® CRD çš„å®šä¹‰å¯¹åº”ç”¨ç¨‹åºè¿›è¡Œç›¸åº”çš„æ“ä½œã€‚

### Operator çš„ä¼˜åŠ¿

Operator çš„ä¼˜åŠ¿åœ¨äºï¼Œå®ƒå¯ä»¥å°†åº”ç”¨ç¨‹åºæˆ–äº‘èµ„æºçš„è¿ç»´çŸ¥è¯†ï¼Œä»äººå·¥æ“ä½œè½¬åŒ–ä¸ºè‡ªåŠ¨åŒ–çš„ä»£ç ï¼Œä»è€Œæé«˜åº”ç”¨ç¨‹åºæˆ–äº‘èµ„æºçš„ç®¡ç†æ•ˆç‡å’Œå¯é æ€§ã€‚æ­¤å¤–ï¼ŒOperator è¿˜èƒ½ä¸ Kubernetes çš„å…¶ä»–åŠŸèƒ½ç›¸é›†æˆï¼Œä¾‹å¦‚ RBACã€autoscaler ç­‰ï¼Œä»è€Œæä¾›æ›´å¼ºå¤§çš„åº”ç”¨ç¨‹åºæˆ–äº‘èµ„æºç®¡ç†èƒ½åŠ›ã€‚

è¯´äº†é‚£ä¹ˆå¤šï¼Œé‚£ä¹ˆè¿™ä¸ªOperatorå’Œäº‘ä¸Šèµ„æºç®¡ç†æœ‰ä»€ä¹ˆè”ç³»å‘¢ï¼Ÿ

å› ä¸ºKubernetesè¢«å¹¿æ³›ä½¿ç”¨ï¼Œè¿˜æœ‰æ§åˆ¶å™¨è‰¯å¥½çš„è®¾è®¡æ¨¡å¼ï¼Œå„å¤§äº‘å‚å•†çº·çº·æ¨å‡ºäº†åŸºäºKubernetes Operatoræ–¹å¼æ¥éƒ¨ç½²ä¸ç»´æŠ¤å„ç§äº‘èµ„æºï¼Œå¹¶ä¸”å¼€æºäº†Operatorçš„ä»£ç ï¼Œé¼“åŠ±æ›´å¤šæŠ€æœ¯åŒå­¦å‚ä¸å¼€å‘ã€‚

ä¾‹å¦‚AWSæ¨å‡ºäº† [aws-controller-k8s](https://github.com/aws-controllers-k8s)ï¼ŒAWSæä¾›äº†iam-controllerï¼Œrds-controllerï¼Œä»¥åŠ[å¦‚ä½•ä½¿ç”¨å’Œå¼€å‘è¿™äº›æ§åˆ¶å™¨](https://github.com/aws-controllers-k8s/community)ã€‚Googleçš„GCPä¹Ÿæœ‰ç±»ä¼¼çš„å·¥å…·ï¼Œå« [Config Connector](https://cloud.google.com/config-connector/docs/overview?hl=zh-cn)ï¼Œå®ƒçš„ä»£ç åœ¨[è¿™é‡Œ](https://github.com/GoogleCloudPlatform/k8s-config-connector)ã€‚å½“ç„¶Azureä¹Ÿæœ‰ç±»ä¼¼çš„å·¥å…·ï¼Œå« Azure Service Operatorï¼Œå®ƒçš„æ–‡æ¡£åœ¨[è¿™é‡Œ](https://azure.github.io/azure-service-operator/)ã€‚

å°½ç®¡è¿™äº›Operatoråœ¨ç”¨æ³•ä¸Šæœ‰ä¸€äº›å·®å¼‚ï¼Œä½†å®ƒä»¬çš„ä¸»è¦åŠŸèƒ½åªæœ‰ä¸¤ä¸ªã€‚

ä¸€ä¸ªæ˜¯ä½¿ç”¨ **Kubernetes å‘½ä»¤è¡Œå·¥å…· ï¼ˆkubectlï¼‰ æ¥ç®¡ç†äº‘èµ„æº**ï¼Œä¾‹å¦‚åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ç­‰æ“ä½œã€‚

å¦ä¸€ä¸ªæ˜¯ä½¿ç”¨ **Kubernetes å£°æ˜å¼èµ„æºæ¨¡å‹å®šä¹‰äº‘èµ„æºçš„é…ç½®**ï¼Œä¾‹å¦‚éœ€è¦å‡ ä¸ªè™šæ‹Ÿæœºï¼Œæ¯ä¸ªè™šæ‹Ÿæœºæ˜¯ä»€ä¹ˆé…ç½®ã€‚

## é…ç½®

å‰é¢æˆ‘å¸¦ä½ äº†è§£äº†ä»€ä¹ˆæ˜¯Kubernetes Operatorï¼Œå®ƒçš„å·¥ä½œåŸç†å’Œä¼˜åŠ¿ã€‚

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬è¶çƒ­æ‰“é“ï¼Œä½“éªŒä¸‹æ€ä¹ˆä½¿ç”¨è¿™äº›Operatoræ¥ç®¡ç†äº‘ä¸Šèµ„æºã€‚è¿™é‡Œæˆ‘ç”¨Azureå¹³å°ä½œä¸ºæ ·ä¾‹ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬è¦å®‰è£…Azure Service Operatorï¼Œæ­¥éª¤å¾ˆç®€å•ï¼Œåªæœ‰ä¸‰æ­¥ã€‚

ç¬¬ä¸€æ­¥ï¼Œåœ¨Azureè´¦å·é‡Œç”³è¯·ä¸€ä¸ªClient Secretï¼Œæ§åˆ¶å™¨è®¤è¯çš„æ—¶å€™ä¼šç”¨åˆ°å®ƒã€‚

ç¬¬äºŒæ­¥ï¼Œå®‰è£…Cert-managerä¸Azure Service Operatorã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨å®‰è£…Operatorçš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å°†Azureçš„è®¤è¯çš„å››ä¸ªé‡è¦é…ç½®ä¸€èµ·ä¼ å…¥Azure Service Operatorã€‚

```plain
kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.12.1/cert-manager.yaml

helm repo add aso2 https://raw.githubusercontent.com/Azure/azure-service-operator/main/v2/charts



helm upgrade --install aso2 aso2/azure-service-operator \
    --create-namespace \
    --namespace=azureserviceoperator-system \
    --set azureSubscriptionID=$AZURE_SUBSCRIPTION_ID \
    --set azureTenantID=$AZURE_TENANT_ID \
    --set azureClientID=$AZURE_CLIENT_ID \
    --set azureClientSecret=$AZURE_CLIENT_SECRET \
    --set crdPattern='resources.azure.com/*;containerservice.azure.com/*;keyvault.azure.com/*;managedidentity.azure.com/*;eventhub.azure.com/*'
```

æ¥ä¸‹æ¥æ˜¯ç¬¬ä¸‰æ­¥ï¼Œç¡®ä¿Cert-manangerå’ŒAzure Service Operatorçš„podséƒ½å¯åŠ¨ï¼Œè¿›å…¥runningå¹¶ä¸”readyçš„çŠ¶æ€äº†ã€‚ä¸‹é¢æ˜¯å®‰è£…å®Œæˆçš„å‘½ä»¤è¡Œè¾“å‡ºã€‚

```plain
~ â¯â¯â¯ kubectl get pod -n cert-manager

NAMEÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â READYÂ  Â STATUSÂ  Â  RESTARTSÂ  Â AGE
cert-manager-7bd4d4cdff-2ktwsÂ  Â  Â  Â  Â  Â  Â  1/1Â  Â  Â RunningÂ  Â 0Â  Â  Â  Â  Â  20s
cert-manager-cainjector-5cdc7f9c66-lghmtÂ  Â 1/1Â  Â  Â RunningÂ  Â 0Â  Â  Â  Â  Â  21s
cert-manager-webhook-77c8d4fd8d-74mqvÂ  Â  Â  1/1Â  Â  Â RunningÂ  Â 0Â  Â  Â  Â  Â  19s

ï½ >>> kubectl get pods -n azureserviceoperator-system
NAME                                                READY   STATUS    RESTARTS   AGE
azureserviceoperator-controller-manager-5b4bfc59df-lfpqf   2/2     Running   0          24s
```

å½“è¿™ä¸€åˆ‡éƒ½å‡†å¤‡å¥½äº†ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨Azure Service Operatoræ¥ç®¡ç†Azureä¸­çš„èµ„æºäº†

ç”¨è¿‡Azureçš„åŒå­¦ä»¬åº”è¯¥çŸ¥é“ï¼Œåœ¨Azureä¸­æ‰€æœ‰çš„èµ„æºéƒ½æ˜¯å±äºæŸä¸€ä¸ªç»„çš„ï¼Œå«åšResource Groupã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¦å…ˆå»ºç«‹ä¸€ä¸ªResource Groupï¼Œé…ç½®å¦‚ä¸‹ã€‚

```plain
apiVersion: resources.azure.com/v1api20200601
kind: ResourceGroup
metadata:
  name: cloudnative-iac-gitop
  namespace: default
spec:
  location: westcentralus
```

æˆ‘ä»¬éœ€è¦æ³¨æ„ï¼ŒResource Groupä¸­localtionè¿™ä¸ªå­—æ®µï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯è¿™ä¸ªResource Groupæ‰€åœ¨çš„regionã€‚è¿™æ ·ä¸€æ¥ï¼Œæ¥ä¸‹æ¥æ‰€æœ‰çš„èµ„æºéƒ½ä¼šåœ¨è¿™ä¸ªregionä¸­ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ç”³è¯·ä¸€ä¸ªAzure Redisï¼Œçœ‹çœ‹éƒ½ä¼šå‘ç”Ÿä»€ä¹ˆã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬è¦å®šä¹‰ç”³è¯·Redisçš„é…ç½®æ–‡ä»¶ï¼Œä½ å¯ä»¥å‚è€ƒåé¢çš„é…ç½®ã€‚

```plain
apiVersion: azure.microsoft.com/v1alpha1
kind: RedisCache
metadata:
Â  name: redis01
spec:
Â  location: eastus2
Â  properties:
Â  Â  sku:
Â  Â  Â  name: Basic
Â  Â  Â  family: C
Â  Â  Â  capacity: 1
Â  Â  enableNonSslPort: true
```

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ `kubectl apply -f` æ¥åº”ç”¨è¿™ä¸ªé…ç½®ï¼Œæˆ‘ä»¬ç”¨kubectlå·¥å…·æŸ¥çœ‹è¿™ä¸ªæ•°æ®çš„çŠ¶æ€ï¼Œä½ å¯ä»¥çœ‹åˆ°è¿™ä¸ªRedisæ˜¾ç¤ºåœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ã€‚ç­‰å¾…å‡ åˆ†é’Ÿï¼Œæˆ‘ä»¬å°†ä¼šçœ‹åˆ°redis01å·²ç»è¿›å…¥ReadyçŠ¶æ€ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å·²ç»å¯ä»¥ä½¿ç”¨è¿™ä¸ªRedisäº†ã€‚

## Kubernetes Operatorçš„ä¸è¶³

åˆšåˆšæˆ‘ä»¬å®é™…ä½“éªŒäº†å¦‚ä½•ä½¿ç”¨Kubernetes Operatoræ¥è·å–æˆ‘ä»¬éœ€è¦çš„èµ„æºã€‚é€šè¿‡è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å‘ç°è·å–äº‘çš„èµ„æºå’Œéƒ¨ç½²ä¸€ä¸ªDeploymentçš„æ–¹å¼ä¸€æ ·ç®€å•ï¼Œé‚£ä¹ˆå®ƒçš„å±€é™ç‚¹åœ¨å“ªé‡Œå‘¢ï¼Ÿ

- **ç¤¾åŒºç”Ÿæ€å°šä¸å®Œå–„**ï¼šåŸºäºKubernetes Operatoræ¨¡å¼æ¥ç®¡ç†äº‘èµ„æºæ˜¯ä¸€ä¸ªç›¸å¯¹è¾ƒæ–°çš„é¡¹ç›®ï¼Œç¤¾åŒºæ”¯æŒè¿˜ä¸å¤Ÿå®Œå–„ã€‚ä¸å…¶ä»–æˆç†Ÿçš„ Operator ç›¸æ¯”ï¼Œå…¶æ–‡æ¡£å’Œç¤ºä¾‹ç›¸å¯¹è¾ƒå°‘ï¼Œç¤¾åŒºæ´»è·ƒåº¦ä¹Ÿç›¸å¯¹è¾ƒä½ã€‚
- **æ”¯æŒçš„èµ„æºç±»å‹æœ‰é™**ï¼šAzure Service Operator ç›®å‰æ”¯æŒçš„ Azure èµ„æºç±»å‹æœ‰é™ï¼Œå°šæœªæ¶µç›–æ‰€æœ‰ Azure èµ„æºã€‚å¯¹äºä¸€äº›è¾ƒæ–°çš„æˆ–ä¸å¸¸ç”¨çš„ Azure èµ„æºï¼Œæˆ‘ä»¬å¯èƒ½æ— æ³•ä½¿ç”¨ Azure Service Operator è¿›è¡Œç®¡ç†ã€‚
- **æ‰©å±•é—¨æ§›é«˜**ï¼šå¦‚æœè¦æ‰©å±•Azure Service Operatorï¼Œéœ€è¦ç”¨æˆ·è‡ªå·±å»å¼€å‘ä»£ç ã€‚

äº‘å‚å•†çš„Service Operatoræ˜¯ä¸€ä¸ªå¾ˆæœ‰æ½œåŠ›çš„é¡¹ç›®ï¼Œå¯ä»¥ç®€åŒ–å„è‡ªå…¬æœ‰äº‘çš„èµ„æºçš„ç®¡ç†ã€‚ç„¶è€Œï¼Œå®ƒè¿˜å¤„äºå‘å±•é˜¶æ®µï¼Œå­˜åœ¨ä¸€äº›ä¸è¶³ä¹‹å¤„ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å®ƒä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä»”ç»†è¯„ä¼°å…¶åŠŸèƒ½ã€å…¼å®¹æ€§å’Œå®‰å…¨æ€§ã€‚

## Corssplane

æ—¢ç„¶å„ä¸ªäº‘å‚å•†çš„Service Operatorå­˜åœ¨ä¸€äº›ä¸è¶³ï¼Œåœ¨ç®¡ç†èµ„æºè¿™æ–¹é¢ï¼Œæœ‰æ²¡æœ‰åƒTerraformé‚£æ ·é€‚é…äº†å„ä¸ªäº‘å‚å•†çš„Operatorå‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚

åœ¨ç¬¬äºŒè®²å­¦ä¹ å¦‚ä½•é€‰æ‹©IaCå·¥å…·çš„æ—¶å€™ï¼Œæˆ‘æåˆ°æœ‰ä¸€ä¸ªåŸºäºKubernetesçš„IaCå·¥å…·å«Corssplaneã€‚Crossplane æ˜¯ä¸€ä¸ªå¤šåŠŸèƒ½çš„ Operatorï¼Œå®ƒæä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ§åˆ¶å¹³é¢ï¼Œç”¨äºç®¡ç†å„ç§åŸºç¡€è®¾æ–½å’ŒæœåŠ¡ã€‚å®ƒå…è®¸ç”¨æˆ·ä½¿ç”¨ Kubernetes åŸç”Ÿå·¥å…·å’Œèµ„æºæ¨¡å‹æ¥ç®¡ç†è™šæ‹Ÿæœºã€å­˜å‚¨ã€ç½‘ç»œã€æ•°æ®åº“ç­‰èµ„æºï¼Œæ— è®ºè¿™äº›èµ„æºä½äºä½•å¤„ï¼Œç”±è°æä¾›ã€‚

è¿™é‡Œæˆ‘ä¸ºä½ æ¼”ç¤ºä¸€ä¸‹å¦‚ä½•ä½¿ç”¨Crossplaneç®¡ç†æ•°æ®åº“ï¼Œæ­¥éª¤ä¹Ÿå¹¶ä¸å¤æ‚ï¼Œ

ç¬¬ä¸€æ­¥æ˜¯å®‰è£… Crossplane CLIï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨äºç®¡ç† Crossplane çš„å‘½ä»¤è¡Œå·¥å…·ã€‚å®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼š

```plain
go install sigs.k8s.io/crossplane/cmd/crossplane
```

ç¬¬äºŒæ­¥æ˜¯å®šä¹‰èµ„æºã€‚Crossplane ä¹Ÿæ˜¯ä½¿ç”¨ Kubernetes CRD æ¥å®šä¹‰è¦ç®¡ç†çš„èµ„æºã€‚æˆ‘ä»¬å¯ä»¥åƒè¿™æ ·å®šä¹‰ä¸€ä¸ª RDS æ•°æ®åº“ï¼š

```plain
apiVersion: database.aws.crossplane.io/v1alpha2
kind: RDSInstanceClass
metadata:
Â  name: rdsmysql
Â  namespace: aws-infra-dev
specTemplate:
Â  class: db.t2.small
Â  masterUsername: masteruser
Â  securityGroups:
Â  Â - # sg-ab1cdefg
Â  Â - # sg-05adsfkaj1ksdjak
Â  size: 20
Â  engine: mysql
Â  providerRef:
Â  Â  name: example
Â  Â  namespace: aws-infra-dev
Â  reclaimPolicy: Delete
```

ç¬¬ä¸‰æ­¥ï¼Œè¿æ¥åˆ°äº‘æä¾›å•†ã€‚Crossplane ä¹Ÿä¼šä½¿ç”¨Provideræ¥è¿æ¥åˆ°ç‰¹å®šçš„äº‘æä¾›å•†æˆ–æœåŠ¡ã€‚è¿™ä¸ªProviderå¯ä»¥æ˜¯ Helm chartã€Terraform æ¨¡å—æˆ–ä»»ä½•å…¶ä»–å¯ä»¥éƒ¨ç½²èµ„æºçš„å·¥å…·ã€‚

ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯è¿æ¥åˆ°AWSçš„Provideré…ç½®ã€‚

**å®‰è£… Provider**

```plain
crossplane install provider crossplane/provider-aws:v0.5.0
```

**é…ç½® Provider**

```plain
apiVersion: providers.crossplane.io/v1
kind: Provider
metadata:
  name: aws
spec:
  # AWS æä¾›ç¨‹åºçš„é…ç½®å‚æ•°
  region: cn-north-1
  credentials:
    secretRef:
      name: aws-credentials
```

**å¯ç”¨ Provider**

æˆ‘ä»¬ä½¿ç”¨ `crossplane apply` å‘½ä»¤å¯ç”¨ Provider é…ç½®ï¼š

```plain
crossplane apply -f provider-aws.yaml
```

ç¬¬å››æ­¥ï¼Œåˆ›å»ºèµ„æºã€‚å®ŒæˆProvideré…ç½®ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Crossplane CLI æˆ– Kubernetes API æ¥åˆ›å»ºèµ„æºã€‚ä¾‹å¦‚ï¼Œåƒåé¢è¿™æ ·åˆ›å»ºä¸€ä¸ª MySQLå®ä¾‹ï¼ˆè¿™é‡Œæ²¿ç”¨äº†æˆ‘ä»¬ç¬¬äºŒæ­¥å®šä¹‰çš„RDSæ•°æ®åº“ï¼Œæˆ‘ä»¬éœ€è¦å°†é…ç½®å­˜åœ¨mysql- instance-mainfest.yamlä¸­ï¼‰ï¼š

```plain
crossplane apply -f mysql-instance-manifest.yaml
```

ç¬¬äº”æ­¥æ˜¯ç®¡ç†èµ„æºã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ”¹æ•°æ®åº“çš„å¯†ç ï¼Œå°±å¯ä»¥ç”¨Kubernetesçš„å‘½ä»¤è¡Œå·¥å…·kubectlæ¥æ›´æ–°æ•°æ®åº“å®ä¾‹çš„å¯†ç ã€‚

```plain
kubectl patch database my-database -p '{"spec":{"password":"new-password"}}'
```

å¯ä»¥çœ‹åˆ°ï¼ŒCorssplaneå’Œå„å®¶äº‘å‚å•†çš„Service Operatorçš„ä½¿ç”¨æ–¹å¼åŸºæœ¬å·®ä¸å¤šã€‚æˆ‘åšäº†ä¸€ä¸ªå¯¹æ¯”çš„è¡¨æ ¼æ¥å±•ç¤ºä¸¤è€…ä¹‹é—´çš„å·®å¼‚ã€‚ã€

![](https://static001.geekbang.org/resource/image/97/bb/97b30d18e9ea64d059e9b88b6d3a00bb.jpg?wh=3666x1370)

ä»è¡¨æ ¼çš„åˆ†ææ¥çœ‹ï¼Œé€‰æ‹© Crossplane è¿˜æ˜¯ Cloud Service Operator å–å†³äºå…·ä½“éœ€æ±‚ï¼š

- å¦‚æœéœ€è¦ç®¡ç†å¤šä¸ªäº‘æä¾›å•†ä¸­çš„èµ„æºï¼ŒCrossplane æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚
- å¦‚æœåªéœ€è¦ç®¡ç†å•ä¸ªäº‘æœåŠ¡ï¼ŒCloud Service Operator æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

## æ€»ç»“

ä»Šå¤©ï¼Œæˆ‘ä»¬äº†è§£äº†Kubernetes Operatorçš„åŸºæœ¬åŸç†ï¼Œå®ƒæ˜¯ä¸€ç§Kubernetesè‡ªå®šä¹‰æ§åˆ¶å™¨ï¼Œå¯ä»¥ç›‘è§† Kubernetes èµ„æºå¹¶æ ¹æ®éœ€è¦æ‰§è¡Œæ“ä½œã€‚

ä¹‹åæ˜¯å®æ“ç»ƒä¹ éƒ¨åˆ†ï¼Œæˆ‘ä»¬åœ¨é›†ç¾¤å†…å¯ç”¨äº†äº‘å‚å•†æä¾›çš„Kubernetes Operatorï¼Œå¹¶ä¸”ä½¿ç”¨è¿™ä¸ªOperatorç”³è¯·äº†ä¸€å°RedisæœåŠ¡å™¨ã€‚

è¿˜è®°å¾—æˆ‘ä»¬åœ¨ç¬¬äºŒèŠ‚å¦‚ä½•é€‰æ‹©IaCå·¥å…·æåˆ°çš„ï¼Œé€‰æ‹©å·¥å…·çš„ä¸‰ä¸ªæ ‡å‡†æ˜¯å¿«é€Ÿã€å¯é å’Œå¯é‡å¤æ€§ã€‚å…¶å®ï¼ŒKubernetes Operatorçš„å‡ ä¸ªä¼˜ç‚¹éå¸¸è´´åˆè¿™ä¸‰ä¸ªæ ‡å‡†ï¼š

- æ˜“äºä½¿ç”¨ï¼šä½¿ç”¨ Kubernetes API è¿›è¡Œç®¡ç†ï¼Œæˆ‘ä»¬æ— éœ€å­¦ä¹ æ–°çš„å·¥å…·ã€‚
- å¯æ‰©å±•æ€§ï¼š å¯ä»¥æ‰©å±•åˆ°ç®¡ç†å¤§é‡èµ„æºã€‚
- å¯é æ€§ï¼š ä½¿ç”¨ Kubernetes çš„å†…ç½®åŠŸèƒ½å¯ä»¥ç¡®ä¿èµ„æºçš„å¯ç”¨æ€§å’Œä¸€è‡´æ€§ã€‚
- çµæ´»æ€§ï¼š å¯ä»¥ç”¨äºç®¡ç†ä»»ä½•åº”ç”¨ç¨‹åºæˆ–åŸºç¡€è®¾æ–½ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨Corssplaneæ¥ç®¡ç†æ•°æ®åº“ï¼Œå¹¶å¯¹æ¯”äº†äº‘å‚å•†çš„Service Operatorä¸Corssplaneã€‚Corssplaneæ¯”Service Operatoræ›´é€šç”¨ï¼Œä½†æ˜¯åœ¨æ”¯æŒåŠ›åº¦ä¸Šç¨æœ‰æ¬ ç¼ºï¼Œéšç€äº‘åŸç”ŸæŠ€æœ¯çš„æ™®åŠï¼ŒOperator å°†åœ¨äº‘ä¸Šèµ„æºç®¡ç†é¢†åŸŸå‘æŒ¥æ›´å¤§çš„ä½œç”¨ã€‚

## æ€è€ƒé¢˜

è¯·ä½ æ ¹æ®è¿™ä¸€è®²æä¾›çš„Azure Service Operatorè®²è§£ï¼Œè‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªç”³è¯·PostgreSQLçš„é…ç½®ã€‚

æ¬¢è¿åœ¨è¯„è®ºåŒºä¸æˆ‘è®¨è®ºã€‚å¦‚æœè¿™ä¸€è®²å¯¹ä½ æœ‰å¯å‘ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™èº«è¾¹æ›´å¤šæœ‹å‹ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ1ï¼‰</strong></div><ul>
<li><span>å¤œç©ºä¸­æœ€äº®çš„æ˜Ÿ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<p>ä½¿ç”¨ Crossplane ç®¡ç†æ•°æ®åº“ï¼Œæ˜¯é€šè¿‡åœ¨k8sä¸Šéƒ¨ç½²Operator ï¼Œç›´æ¥åœ¨ k8s æ‰€åœ¨çš„äº‘å‚å•†ä¹‹ä¸Š åˆ›å»ºçš„ï¼Œå°±æ˜¯è¯´æ˜¯ é€šè¿‡ k8s api æ¥ç®¡ç†äº†äº‘èµ„æºï¼Œæ˜¯è¿™æ ·å—ï¼Ÿ</p>2024-04-15</li><br/>
</ul>