ä½ å¥½ï¼Œæˆ‘æ˜¯é›ªé£ã€‚

åˆšå¼€å§‹ä½¿ç”¨ K8s çš„æ—¶å€™ï¼Œæˆ‘ä»¬å›¢é˜Ÿæ­å»ºäº† V1.18 ç¨³å®šç‰ˆæœ¬çš„ K8s é›†ç¾¤ï¼Œåœ¨ä¸Šé¢éƒ¨ç½²äº†å„ç§ä¸šåŠ¡åº”ç”¨ï¼Œè¿™å¥—ç¯å¢ƒé•¿æ—¶é—´æ²¡æœ‰è¿›è¡Œé›†ç¾¤å‡çº§ã€‚éšç€ä¸šåŠ¡è¿­ä»£åŠ å¿«å’Œç³»ç»Ÿå®‰å…¨éœ€æ±‚æå‡ï¼Œæˆ‘ä»¬å‘ç°è€ç‰ˆçš„ K8s é›†ç¾¤æ— æ³•å…¼å®¹ä¸€äº›æ–°ç»„ä»¶ï¼Œå› æ­¤å¿…é¡»è¦å¯¹é›†ç¾¤å‡çº§ã€‚é¢„æœŸå‡çº§åçš„ç‰ˆæœ¬æ˜¯ V1.26 ç‰ˆæœ¬ï¼Œç„¶è€Œï¼Œç”±äºç‰ˆæœ¬è·¨åº¦è¿‡å¤§ï¼Œå‡çº§æ—¶é‡åˆ°äº†è®¸å¤šé—®é¢˜ï¼ŒèŠ±è´¹äº†å¤§é‡æ—¶é—´ã€‚å› æ­¤ï¼ŒåŠæ—¶å‡çº§é›†ç¾¤éå¸¸é‡è¦ï¼Œé¿å…ç•™ä¸‹æŠ€æœ¯å€ºã€‚

é›†ç¾¤å‡çº§èƒ½å¤Ÿå¸¦æ¥å¾ˆå¤šå¥½å¤„ï¼Œæ¯”å¦‚ç¡®ä¿é›†ç¾¤èƒ½åˆ©ç”¨æœ€æ–°ç‰ˆæœ¬çš„æ–°åŠŸèƒ½ã€æ€§èƒ½æå‡å’Œå®‰å…¨è¡¥ä¸ï¼Œå¯ä»¥å¢å¼ºé›†ç¾¤çš„ç¨³å®šæ€§å’Œå¯é æ€§ï¼ŒåŒæ—¶æå‡å…¼å®¹æ€§å’Œæ‰©å±•æ€§ï¼Œæ»¡è¶³ä¸æ–­å˜åŒ–çš„æŠ€æœ¯ä¸ä¸šåŠ¡éœ€æ±‚ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ·±å…¥äº†è§£ K8s çš„å‡çº§è¿‡ç¨‹ã€‚

## K8s å‡çº§è¯´æ˜

åœ¨ K8s å‡çº§è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆéœ€è¦å¤‡ä»½é›†ç¾¤æ•°æ®ã€‚ç”±äºæ‰€æœ‰ K8s é›†ç¾¤ç›¸å…³æ•°æ®éƒ½å­˜å‚¨åœ¨ etcd æ•°æ®åº“ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆå¯¹ etcd ä¸­çš„æ•°æ®è¿›è¡Œæ•´ä½“å¤‡ä»½ã€‚å¦‚æœé›†ç¾¤å‡çº§è¿‡ç¨‹ä¸­å‡ºç°æ„å¤–ï¼Œå¯ä»¥åˆ©ç”¨ etcd çš„å¿«ç…§æ•°æ®è¿›è¡Œå›é€€æ¢å¤ã€‚

æ¥ä¸‹æ¥ï¼ŒæŒ‰ç…§é¡ºåºå…ˆå‡çº§ç®¡ç†èŠ‚ç‚¹ï¼Œå³ Master èŠ‚ç‚¹ï¼Œç„¶åå†å‡çº§å·¥ä½œèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯å…¶ä»–Worker èŠ‚ç‚¹ã€‚ä¸ºé¿å…ä¸šåŠ¡æœåŠ¡ä¸­æ–­ï¼Œé€šå¸¸é‡‡ç”¨æ»šåŠ¨å‡çº§æ–¹å¼ï¼Œé€ä¸ªæˆ–åˆ†æ‰¹å‡çº§å·¥ä½œèŠ‚ç‚¹ï¼Œç¡®ä¿éƒ¨åˆ†èŠ‚ç‚¹ä»èƒ½æ­£å¸¸è¿è¡Œï¼Œä»è€Œä¿éšœèŠ‚ç‚¹ä¸Šçš„ Pod èƒ½æŒç»­å¯¹å¤–æä¾›æœåŠ¡ã€‚

åœ¨å‡çº§å•ä¸ªèŠ‚ç‚¹æ—¶ï¼Œéœ€è¦å…ˆæ¸…ç©ºèŠ‚ç‚¹ä¸Šçš„ Pod å¹¶è®¾ç½®èŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦çŠ¶æ€ï¼Œå¾…å‡çº§å®Œæˆåå†å–æ¶ˆè¿™ä¸€è®¾ç½®ï¼Œç¡®ä¿æ•´ä¸ªé›†ç¾¤çš„å¹³ç¨³è¿‡æ¸¡ã€‚

**æ³¨æ„ï¼š**åœ¨æ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ›´æ–° kubeadmã€kubelet å’Œ kubectl ç­‰å·¥å…·å’Œç»„ä»¶ï¼ŒK8s å»ºè®®è¿™ä¸‰ä¸ªç»„ä»¶çš„ç‰ˆæœ¬åœ¨å‡çº§æ—¶ä¿æŒä¸€è‡´ã€‚

## å¤‡ä»½ etcd æ•°æ®

åœ¨é›†ç¾¤å‡çº§å‰ï¼Œå¤‡ä»½ etcd æ•°æ®è‡³å…³é‡è¦ï¼Œå®é™…ä¸Šï¼Œæ—¥å¸¸è¿ç»´ä¸­ä¹Ÿåº”è¯¥å®šæœŸå¤‡ä»½ etcd æ•°æ®ï¼Œä»è€Œåº”å¯¹ç¾éš¾æ¢å¤åœºæ™¯ï¼ˆå¦‚ç®¡ç†èŠ‚ç‚¹å…¨éƒ¨æ•…éšœï¼‰ã€‚etcd çš„æ•°æ®å¤‡ä»½æ–‡ä»¶åŒ…å«æ‰€æœ‰ K8s èµ„æºå¯¹è±¡ã€é…ç½®å‚æ•°ã€çŠ¶æ€ä¿¡æ¯å’Œå…¶ä»–æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ etcdctl å·¥å…·å¯¼å‡ºæ•°æ®å¤‡ä»½ï¼Œå¹¶å°†å…¶åŠ å¯†å­˜å‚¨åœ¨å®‰å…¨çš„æœåŠ¡å™¨å¤‡ä»½ç›®å½•ä¸­ï¼Œä»¥ç¡®ä¿åœ¨é›†ç¾¤æ•…éšœæ—¶èƒ½å¤Ÿè¿›è¡Œé›†ç¾¤æ¢å¤ã€‚ä¸‹é¢æˆ‘ä»¬æ¥åŠ¨æ‰‹å¤‡ä»½å’Œæ¢å¤ etcd æ•°æ®ã€‚é¦–å…ˆå®‰è£… etcdctl å·¥å…·ã€‚

### å®‰è£… etcdctl å‘½ä»¤å·¥å…·

ç”±äº etcd ç»„ä»¶æ˜¯éƒ¨ç½²åœ¨ç®¡ç†èŠ‚ç‚¹ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬å¤‡ä»½å’Œæ¢å¤æ“ä½œä¹Ÿæ˜¯åœ¨ç®¡ç†èŠ‚ç‚¹ä¸Šè¿›è¡Œã€‚åœ¨ç®¡ç†èŠ‚ç‚¹ä¸Šæ‰§è¡Œå®‰è£… etcd çš„å‘½ä»¤ï¼Œä¼šè‡ªåŠ¨å®‰è£… etcdctl çš„å‘½ä»¤å·¥å…·ã€‚

```bash
[root@k8s-master ~]# yum install -y etcd
[root@k8s-master ~]# etcd --version   # æŸ¥çœ‹å®‰è£…çš„etcdç‰ˆæœ¬
etcd Version: 3.3.11
Git SHA: 2cf9e51
Go Version: go1.10.3
Go OS/Arch: linux/amd64
```

### å¤‡ä»½ etcd æ•°æ®

å®‰è£…å¥½ etcdctl å·¥å…·ï¼Œæ‰§è¡Œ â€œetcdctl snapshot saveâ€ å‘½ä»¤ï¼Œå¯¹ etcd æ•°æ®è¿›è¡Œå¤‡ä»½ã€‚

```yaml
[root@k8s-master ~]# ETCDCTL_API=3 etcdctl snapshot save snap.db --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.keyÂ 
Snapshot saved at snap.db
```

å¤‡ä»½å‘½ä»¤å‚æ•°æœ‰ç‚¹å¤šï¼Œæˆ‘æ¥è§£é‡Šä¸€ä¸‹ï¼š

- **ETCDCTL\_API=3**ï¼šè®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒæŒ‡å®š etcdctl å·¥å…·ä½¿ç”¨çš„ API ç‰ˆæœ¬ä¸º 3ã€‚
- **etcdctl snapshot save snap.dbï¼š**æ‰§è¡Œå…¨éƒ¨æ•°æ®çš„å¿«ç…§ï¼ˆå¿«ç…§å°±æ˜¯ä¸€æ¬¡æ•°æ®å¤‡ä»½ï¼‰ä¿å­˜æ“ä½œï¼Œå¿«ç…§æ–‡ä»¶å‘½åä¸º snap.dbã€‚
- **â€“endpoints**ï¼šæŒ‡å®šé›†ç¾¤ etcd ç»„ä»¶çš„ IP å’Œç«¯å£ã€‚ç”±äºå¤‡ä»½å‘½ä»¤å°±åœ¨ç®¡ç†èŠ‚ç‚¹æ‰§è¡Œï¼Œæ‰€ä»¥etcd ç»„ä»¶çš„ IP å°±æ˜¯æœ¬åœ° IPï¼Œç«¯å£å·ä¸º 2379 ç«¯å£ï¼Œä½¿ç”¨ HTTPS åè®®ã€‚
- **â€“cacert**ï¼šæŒ‡å®šé›†ç¾¤ etcd ç»„ä»¶çš„ CA è¯ä¹¦è·¯å¾„ï¼Œç”¨äºéªŒè¯èº«ä»½ã€‚
- **â€“cert**ï¼šæŒ‡å®šé›†ç¾¤ etcd ç»„ä»¶çš„è¯ä¹¦è·¯å¾„ã€‚
- **â€“key**ï¼šæŒ‡å®šé›†ç¾¤ etcd ç»„ä»¶çš„ç§é’¥è·¯å¾„ã€‚

éƒ¨ç½² K8s é›†ç¾¤æ—¶ï¼Œä¼šè‡ªåŠ¨å®‰è£… etcd ç»„ä»¶çš„è¯ä¹¦ï¼Œé»˜è®¤æ–‡ä»¶è·¯å¾„ä¸ºï¼šâ€œ/etc/kubernetes/pki/etcd/ca.crtâ€ã€â€œ/etc/kubernetes/pki/etcd/server.crtâ€ã€â€œ/etc/kubernetes/pki/etcd/server.keyâ€ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ç®¡ç†èŠ‚ç‚¹ä¸­çœ‹åˆ°è¿™ä¸‰ä¸ªæ–‡ä»¶ã€‚

```bash
[root@k8s-master ~]# cd /etc/kubernetes/pki/etcd
[root@k8s-master etcd]# ls
ca.crtÂ  ca.keyÂ  healthcheck-client.crtÂ  healthcheck-client.keyÂ  peer.crtÂ  peer.keyÂ  server.crtÂ  server.key
```

å¤‡ä»½å‘½ä»¤æ‰§è¡ŒæˆåŠŸåï¼Œå°±å¯ä»¥åœ¨å½“å‰ç›®å½•ä¸‹çœ‹åˆ°åä¸º â€œsnap.dbâ€ çš„å¤‡ä»½æ–‡ä»¶ã€‚

```bash
[root@k8s-master ~]# ls
snap.dbÂ 
```

### æ¢å¤ etcd æ•°æ®

å¦‚æœé›†ç¾¤ç®¡ç†èŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œä¿®å¤åå¯èƒ½å¯¼è‡´ etcd ä¸­å­˜æ”¾çš„æ•°æ®ä¸¢å¤±ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤‡ä»½æ•°æ®æ¥æ¢å¤ etcd æ•°æ®ï¼Œä»è€Œå›é€€åˆ°å¤‡ä»½æ—¶çš„é›†ç¾¤å·¥ä½œçŠ¶æ€ã€‚K8s å®˜æ–¹å»ºè®®ï¼Œåœ¨æ‰§è¡Œæ¢å¤æ•°æ®æ“ä½œå‰ï¼Œåº”å…ˆåœæ­¢æ‰€æœ‰ç³»ç»Ÿæ ¸å¿ƒç»„ä»¶ï¼Œå¦‚Â Scheduler å’Œ Controller Manager ç­‰ï¼Œä»¥ç¡®ä¿å®ƒä»¬ä¸ä¼šä¾èµ–ä¸€äº›è¿‡æ—¶æ•°æ®ã€‚ä»¥ä¸‹æ˜¯æ¢å¤ etcd æ•°æ®çš„å…·ä½“æ­¥éª¤ã€‚

**ç¬¬ä¸€æ­¥ï¼šæš‚åœç³»ç»Ÿç»„ä»¶**

ç”±äºé›†ç¾¤ç³»ç»Ÿç»„ä»¶çš„éƒ¨ç½²æ–‡ä»¶éƒ½å­˜æ”¾åœ¨ â€œ/etc/kubernetes/manifests/â€ ç›®å½•ä¸­ï¼Œå¹¶ä¸”ä»¥é™æ€ Pod çš„å½¢å¼è¿è¡Œï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦æ›´æ”¹è¯¥ç›®å½•çš„åç§°ï¼Œè®© K8s æ‰¾ä¸åˆ°ç»„ä»¶éƒ¨ç½²çš„ YAML æ–‡ä»¶ï¼Œä»è€Œä¼šè‡ªåŠ¨æš‚åœè¿™äº›ç³»ç»Ÿç»„ä»¶è¿è¡Œã€‚**æ³¨æ„ï¼š**ä¿®æ”¹ç›®å½•ä¹‹åï¼Œkubectl å‘½ä»¤ä¹Ÿå°†æ— æ³•ä½¿ç”¨ã€‚

```bash
[root@k8s-master ~]# mv /etc/kubernetes/manifests /etc/kubernetes/manifests.bak
```

**ç¬¬äºŒæ­¥ï¼šå¤‡ä»½å½“å‰etcd çš„æ•°æ®ç›®å½•**

etcd æ•°æ®æ–‡ä»¶ä½äº â€œ/var/lib/etcd/â€ã€‚åœ¨æ¢å¤æ•°æ®å‰ï¼Œéœ€è¦å°†å½“å‰æ•°æ®ç›®å½•ä¿®æ”¹ä¸ºå¦ä¸€ç›®å½•ï¼Œé¿å…æ•°æ®è¢«ç›´æ¥è¦†ç›–ã€‚

```bash
[root@k8s-master ~]# mv /var/lib/etcd/ /var/lib/etcd.bak
```

**ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œæ¢å¤å‘½ä»¤**

åœ¨åˆšæ‰å¤‡ä»½æ–‡ä»¶ snap.db æ‰€åœ¨ç›®å½•æ‰§è¡Œ â€œetcdctl snapshot restoreâ€ æ¢å¤æ•°æ®å‘½ä»¤ï¼ŒæŒ‡å®šæ¢å¤çš„æ•°æ®å­˜æ”¾è‡³ â€œ/var/lib/etcdâ€ ç›®å½•ä¸­ã€‚

```bash
[root@k8s-master ~]# ETCDCTL_API=3 etcdctl snapshot restore snap.db --data-dir=/var/lib/etcdÂ 
2024-07-03 09:35:12.892662 I | mvcc: restore compact to 3393178
2024-07-03 09:35:12.901833 I | etcdserver/membership: added member 8e9e05c52164694d [http://localhost:2380] to cluster cdf818194e3a8c32
```

**ç¬¬å››æ­¥ï¼šé‡å¯ç³»ç»Ÿç»„ä»¶**

å¤‡ä»½æ•°æ®æ¢å¤åï¼Œå°†é›†ç¾¤ç³»ç»Ÿç»„ä»¶çš„éƒ¨ç½²æ–‡ä»¶ç›®å½•æ”¹å›ä¸º â€œ/etc/kubernetes/manifests/â€ï¼Œè¿™æ ·æ‰€æœ‰ç³»ç»Ÿç»„ä»¶ä¼šè‡ªåŠ¨é‡æ–°è¿è¡Œã€‚æœ€åé‡å¯æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„ kubeletã€‚

```bash
[root@k8s-master ~]# mv /etc/kubernetes/manifests.bak /etc/kubernetes/manifests
[root@k8s-master ~]# systemctl restart kubeletÂ  # æ‰€æœ‰èŠ‚ç‚¹é‡å¯ kubelet
```

å¯ä»¥çœ‹åˆ°ï¼Œæ‰€æœ‰é›†ç¾¤ç³»ç»Ÿç»„ä»¶ Pod å¼€å§‹é‡æ–°å¯åŠ¨ï¼Œç¨ç­‰ç‰‡åˆ»ï¼Œæ‰€æœ‰ Pod åŠ è½½æ­£å¸¸ã€‚è¿™æ—¶ï¼Œé›†ç¾¤çŠ¶æ€æ¢å¤åˆ° etcd å¤‡ä»½æ•°æ®æ—¶çš„çŠ¶æ€ã€‚

```bash
[root@k8s-master ~]# kubectl get pod -n kube-system
NAMEÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â READYÂ  Â STATUSÂ  Â  RESTARTSÂ  Â  Â  AGE
coredns-66f779496c-pqwprÂ  Â  Â  Â  Â  Â  Â 1/1Â  Â  Â RunningÂ  Â 0Â  Â  Â  Â  Â  Â  Â 15d
coredns-66f779496c-x7xhfÂ  Â  Â  Â  Â  Â  Â 1/1Â  Â  Â RunningÂ  Â 0Â  Â  Â  Â  Â  Â  Â 15d
etcd-k8s-masterÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  1/1Â  Â  Â RunningÂ  Â 0Â  Â  Â  Â  Â  Â  Â 17d
kube-apiserver-k8s-masterÂ  Â  Â  Â  Â  Â  1/1Â  Â  Â RunningÂ  Â 0Â  Â  Â  Â  Â  Â  Â 10d
kube-controller-manager-k8s-masterÂ  Â 1/1Â  Â  Â RunningÂ  Â 0Â  Â  Â  Â  Â  Â  Â 10d
kube-proxy-84jp5Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 1/1Â  Â  Â RunningÂ  Â 1 (10d ago)Â  Â 10d
kube-proxy-r2mwcÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 1/1Â  Â  Â RunningÂ  Â 0Â  Â  Â  Â  Â  Â  Â 10d
kube-proxy-vchhhÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 1/1Â  Â  Â RunningÂ  Â 0Â  Â  Â  Â  Â  Â  Â 10d
kube-scheduler-k8s-masterÂ  Â  Â  Â  Â  Â  1/1Â  Â  Â RunningÂ  Â 0Â  Â  Â  Â  Â  Â  Â 10d
metrics-server-7f676b86dc-9lpsbÂ  Â  Â  1/1Â  Â  Â RunningÂ  Â 0Â  Â  Â  Â  Â  Â  Â 11d
```

## å‡çº§æ§åˆ¶é¢ä¸»èŠ‚ç‚¹

æˆ‘ä»¬æŒæ¡äº† ectd çš„æ•°æ®å¤‡ä»½ï¼Œå°±å¯ä»¥åœ¨é›†ç¾¤å‡çº§å‰åšå¥½æ•°æ®å¤‡ä»½ï¼Œç„¶åå¼€å§‹å‡çº§é›†ç¾¤èŠ‚ç‚¹ã€‚

å…ˆä»ç®¡ç†èŠ‚ç‚¹å¼€å§‹å‡çº§ï¼Œç¡®ä¿å‡çº§ç‰ˆæœ¬ä¸è¦è·¨åº¦å¤ªå¤§ã€‚é€šè¿‡ â€œkubectl get nodeâ€ å‘½ä»¤æŸ¥çœ‹å½“å‰æˆ‘çš„é›†ç¾¤èŠ‚ç‚¹ç‰ˆæœ¬ä¸º V1.28.0ï¼Œæœ¬æ¬¡å°†å‡çº§åˆ° V1.28.2 ç‰ˆæœ¬ã€‚

```bash
[root@k8s-master ~]# kubectl get node
NAMEÂ  Â  Â  Â  Â  STATUSÂ  Â ROLESÂ  Â  Â  Â  Â  Â AGEÂ  Â VERSION
k8s-masterÂ  Â  ReadyÂ  Â  control-planeÂ  Â 17dÂ  Â v1.28.0
k8s-worker1Â  Â ReadyÂ  Â  <none>Â  Â  Â  Â  Â  15dÂ  Â v1.28.0
k8s-worker2Â  Â ReadyÂ  Â  <none>Â  Â  Â  Â  Â  15dÂ  Â v1.28.0
```

å…ˆå‡çº§ k8s-master èŠ‚ç‚¹ã€‚åœ¨ k8s-master èŠ‚ç‚¹ä¸Šä¾æ¬¡æ‰§è¡Œå‘½ä»¤æ­¥éª¤å¦‚ä¸‹ï¼š

```bash
# 1ã€æŸ¥æ‰¾æœ€æ–°ç‰ˆæœ¬å·ï¼Œç›®å‰èƒ½ä½¿ç”¨çš„æœ€æ–°ç‰ˆæœ¬æ˜¯ 1.28.2
[root@k8s-master ~]# yum list --showduplicates kubeadm
Loaded plugins: fastestmirror, langpacks
Loading mirror speeds from cached hostfile
Installed Packages
kubeadm.x86_64Â  Â  Â  Â  Â  Â  Â  1.28.0-0Â  Â  Â  Â  Â  Â  Â  Â  Â  Â @kubernetes
Available Packages
.......
kubeadm.x86_64Â  Â  Â  Â  Â  Â  Â  1.28.2-0Â  Â  Â  Â  Â  Â  Â  Â  Â  Â kubernetesÂ 

# 2ã€å‡çº§kubeadm
[root@k8s-master ~]# yum install -y kubeadm-1.28.2-0

# 3ã€é©±é€èŠ‚ç‚¹ä¸Šçš„Podï¼Œä¸”è®¾ç½®èŠ‚ç‚¹ä¸å¯è°ƒåº¦
# --ignore-daemonsets è¡¨ç¤ºå¿½ç•¥ Daemonset ç±»å‹çš„ Pod
[root@k8s-master ~]# kubectl drain k8s-master --ignore-daemonsets
node/k8s-master cordoned
Warning: ignoring DaemonSet-managed Pods: calico-system/calico-node-qd57g, calico-system/csi-node-driver-fd2ws, kube-system/kube-proxy-84jp5
node/k8s-master drained

# 4ã€æ£€æŸ¥é›†ç¾¤æ˜¯å¦å¯ä»¥å‡çº§ï¼Œå¹¶è·å–å¯ä»¥å‡çº§çš„ç‰ˆæœ¬ 
[root@k8s-master ~]# kubeadm upgrade plan
[upgrade/config] Making sure the configuration is correct:
[upgrade/config] Reading configuration from the cluster...
......
You can now apply the upgrade by executing the following command:
Â  Â  Â  Â  kubeadm upgrade apply v1.28.11
......

# 5ã€æ‰§è¡Œå‡çº§
[root@k8s-master ~]# kubeadm upgrade apply v1.28.2
[upgrade/config] Making sure the configuration is correct:
[upgrade/config] Reading configuration from the cluster...
.......

# 6ã€å‡çº§ kubelet å’Œ kubectl
[root@k8s-master ~]# yum install -y kubelet-1.28.2-0 kubectl-1.28.2-0
Loaded plugins: fastestmirror, langpacks
Loading mirror speeds from cached hostfile
......

# 7ã€é‡å¯kubelet
[root@k8s-master ~]# systemctl daemon-reload
[root@k8s-master ~]# systemctl restart kubelet

# 8ã€å–æ¶ˆè®¾ç½®èŠ‚ç‚¹ä¸å¯è°ƒåº¦ï¼ŒèŠ‚ç‚¹é‡æ–°ä¸Šçº¿ 
[root@k8s-master ~]# kubectl uncordon k8s-master
node/k8s-master uncordoned
```

**æ³¨æ„ï¼š**åœ¨å‡çº§èŠ‚ç‚¹å‰ï¼Œéœ€è¦å…ˆæ¸…ç©ºèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ Pod å¹¶è®¾ç½®ä¸ºä¸å¯è°ƒåº¦ã€‚å‡çº§å®Œæˆåï¼Œå†å°†èŠ‚ç‚¹é‡æ–°è®¾ç½®ä¸ºå¯è°ƒåº¦çŠ¶æ€ã€‚

ä¸»èŠ‚ç‚¹å‡çº§æˆåŠŸåï¼Œå¯ä»¥é€šè¿‡ â€œkubectl get nodeâ€ å‘½ä»¤æŸ¥çœ‹å‡çº§åçš„ç‰ˆæœ¬ã€‚æˆ‘ä»¬çœ‹åˆ°ä¸»èŠ‚ç‚¹å·²ç»å˜æˆ 1.28.2 ç‰ˆæœ¬ã€‚

```bash
[root@k8s-master ~]# kubectl get node
NAME          STATUS   ROLES           AGE   VERSION
k8s-master    Ready    control-plane   17d   v1.28.2
k8s-worker1   Ready    <none>          15d   v1.28.0
k8s-worker2   Ready    <none>          15d   v1.28.0
```

## å‡çº§å·¥ä½œèŠ‚ç‚¹

ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬å¼€å§‹å‡çº§å·¥ä½œèŠ‚ç‚¹ã€‚ä¸ºäº†ç¡®ä¿é›†ç¾¤ä¸ä¼šå®Œå…¨åœæ­¢è¿è¡Œï¼Œé€šå¸¸ä¼šé€ä¸ªä¾æ¬¡å‡çº§å·¥ä½œèŠ‚ç‚¹ï¼Œè¿™æ ·åœ¨å‡çº§è¿‡ç¨‹ä¸­ä»æœ‰æ­£å¸¸çš„å·¥ä½œèŠ‚ç‚¹å¯ä»¥ç»´æŒåº”ç”¨ Pod çš„è¿è¡Œã€‚

æˆ‘ä»¬å…ˆå‡çº§ k8s-worker1 èŠ‚ç‚¹ã€‚å‡çº§æˆåŠŸåï¼Œå†å‡çº§ k8s-worker2 èŠ‚ç‚¹ã€‚å·¥ä½œèŠ‚ç‚¹çš„å‡çº§æ­¥éª¤å®Œå…¨ç›¸åŒï¼Œåªéœ€è¦åœ¨ä¸åŒèŠ‚ç‚¹ä¸Šæ‰§è¡Œä¸€ç³»åˆ—å‘½ä»¤ã€‚

**æ³¨æ„ï¼š**é©±é€èŠ‚ç‚¹å’Œè®¾ç½®èŠ‚ç‚¹å¯è°ƒåº¦æ—¶éœ€è¦æ›¿æ¢ä¸ºæ¯ä¸ªèŠ‚ç‚¹è‡ªå·±çš„åç§°ï¼Œè€Œä¸”è¿™ä¸¤æ­¥æ“ä½œéƒ½åœ¨ç®¡ç†èŠ‚ç‚¹ä¸Šé€šè¿‡ kubectl å‘½ä»¤æ“ä½œã€‚æ­¥éª¤å¦‚ä¸‹ï¼š

```bash
# 1ã€å‡çº§ kubeadm
[root@k8s-worker1 ~]# yum install -y kubeadm-1.28.2-0
......
Updated:
Â  kubeadm.x86_64 0:1.28.2-0Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Complete!

# 2ã€é©±é€èŠ‚ç‚¹ä¸Šçš„Podï¼Œä¸”è®¾ç½®èŠ‚ç‚¹ä¸å¯è°ƒåº¦
# æ³¨æ„ï¼šåœ¨ç®¡ç†èŠ‚ç‚¹ä¸Šæ‰§è¡Œ
# --ignore-daemonsets è¡¨ç¤ºå¿½ç•¥ Daemonset ç±»å‹çš„ Pod
# --delete-emptydir-data è¡¨ç¤ºåˆ é™¤ Pod ç”¨åˆ°çš„æœ¬åœ°æ•°æ®
[root@k8s-master ~]# kubectl drain k8s-worker1 --ignore-daemonsets --delete-emptydir-data --force
node/k8s-worker1 cordoned
Warning: ignoring DaemonSet-managed Pods: calico-system/calico-node-8g7nn, calico-system/csi-node-driver-hr6ng, kube-system/kube-proxy-vchhh; deleting Pods that declare no controller: default/my-nginx-resources-limit

# 3ã€å‡çº§kubeleté…ç½®
[root@k8s-worker1 ~]# kubeadm upgrade node
[upgrade] Reading configuration from the cluster...
[upgrade] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
[preflight] Running pre-flight checks
[preflight] Skipping prepull. Not a control plane node.
[upgrade] Skipping phase. Not a control plane node.
[upgrade] Backing up kubelet config file to /etc/kubernetes/tmp/kubeadm-kubelet-config2378199440/config.yaml
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[upgrade] The configuration for this node was successfully updated!
[upgrade] Now you should go ahead and upgrade the kubelet package using your package manager.

# 4ã€å‡çº§kubeletå’Œkubectl
[root@k8s-worker1 ~]# yum install -y kubelet-1.28.2-0 kubectl-1.28.2-0
......
Updated:
Â  kubectl.x86_64 0:1.28.2-0Â  Â  Â  Â  Â  Â Â kubelet.x86_64 0:1.28.2-0Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 

Complete!

# 5ã€é‡å¯kubelet
[root@k8s-worker1 ~]# systemctl daemon-reload
[root@k8s-worker1 ~]# systemctl restart kubelet

# 6ã€å–æ¶ˆè®¾ç½®èŠ‚ç‚¹ä¸å¯è°ƒåº¦ï¼ŒèŠ‚ç‚¹é‡æ–°ä¸Šçº¿ã€‚
# æ³¨æ„ï¼šåœ¨ç®¡ç†èŠ‚ç‚¹ä¸Šæ‰§è¡Œ
[root@k8s-master ~]# kubectl uncordon k8s-worker1
node/k8s-worker1 uncordoned
```

æ‰€æœ‰èŠ‚ç‚¹å‡çº§å®Œæˆåï¼Œæˆ‘ä»¬å†æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯ï¼Œç¡®è®¤æ‰€æœ‰èŠ‚ç‚¹å·²æ›´æ–°è‡³ 1.28.2 ç‰ˆæœ¬ã€‚

```bash
[root@k8s-master ~]# kubectl get node
NAMEÂ  Â  Â  Â  Â  STATUSÂ  Â ROLESÂ  Â  Â  Â  Â  Â AGEÂ  Â VERSION
k8s-masterÂ  Â  ReadyÂ  Â  control-planeÂ  Â 18dÂ  Â v1.28.2
k8s-worker1Â  Â ReadyÂ  Â  <none>Â  Â  Â  Â  Â  16dÂ  Â v1.28.2
k8s-worker2Â  Â ReadyÂ  Â  <none>Â  Â  Â  Â  Â  16dÂ  Â v1.28.2
```

## æ•…éšœå›æ»š

å¦‚æœ kubeadm upgrade åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¤±è´¥ï¼Œä¸”æ²¡æœ‰è‡ªåŠ¨å›æ»šï¼Œæ¯”å¦‚å› ä¸ºèŠ‚ç‚¹æ„å¤–å…³é—­ï¼Œè¿™æ—¶ï¼Œä½ å¯ä»¥ç›´æ¥å†æ¬¡è¿è¡Œ kubeadm upgrade å‘½ä»¤ã€‚è¿™ä¸ªå‘½ä»¤å…·æœ‰å¹‚ç­‰æ€§ï¼Œå¯ä»¥ç¡®ä¿æœ€ç»ˆçš„çŠ¶æ€ä¸ä½ çš„é¢„æœŸä¿æŒä¸€è‡´ã€‚

åœ¨å‡çº§è¿‡ç¨‹ä¸­ï¼Œkubeadm ä¼šå°†æ•°æ®å¤‡ä»½åˆ° â€œ/etc/kubernetes/tmpâ€ ç›®å½•ä¸‹çš„ä»¥ä¸‹æ–‡ä»¶å¤¹ï¼š

- kubeadm-backup-etcd-&lt;date&gt;-&lt;time&gt;
- kubeadm-backup-manifests-&lt;date&gt;-&lt;time&gt;

kubeadm-backup-etcd åŒ…å«é›†ç¾¤ etcd ç»„ä»¶æ•°æ®çš„å¤‡ä»½ã€‚å¦‚æœ etcd å‡çº§å¤±è´¥ä¸”è‡ªåŠ¨å›æ»šä¹Ÿæ— æ³•ä¿®å¤ï¼Œå¯ä»¥å°†æ­¤æ–‡ä»¶å¤¹ä¸­çš„å†…å®¹å¤åˆ¶åˆ° â€œ/var/lib/etcdâ€ ç›®å½•ä¸­è¿›è¡Œæ‰‹åŠ¨æ¢å¤ã€‚

kubeadm-backup-manifests åŒ…å«é›†ç¾¤ç»„ä»¶çš„é™æ€ Pod çš„ YAML æ–‡ä»¶çš„å¤‡ä»½ç‰ˆæœ¬ã€‚å¦‚æœå‡çº§å¤±è´¥ä¸”æ— æ³•è‡ªåŠ¨å›æ»šï¼Œåˆ™å¯ä»¥å°†æ­¤æ–‡ä»¶å¤¹ä¸­çš„å†…å®¹å¤åˆ¶åˆ° â€œ/etc/kubernetes/manifestsâ€ ç›®å½•ä¸­ä»¥å®ç°æ‰‹åŠ¨æ¢å¤ã€‚

## å°ç»“

ä»Šå¤©ï¼Œæˆ‘ç»™ä½ ä»‹ç»äº† K8s é›†ç¾¤å‡çº§çš„é‡è¦æ€§å’Œå…·ä½“æ­¥éª¤ã€‚é›†ç¾¤å‡çº§å¯ä»¥ä¿æŒé›†ç¾¤æŠ€æœ¯çš„å…ˆè¿›æ€§å’Œå®‰å…¨æ€§ï¼Œä»è€Œåˆ©ç”¨æœ€æ–°åŠŸèƒ½ã€æ€§èƒ½æ”¹è¿›å’Œå®‰å…¨è¡¥ä¸ï¼Œå¢å¼ºé›†ç¾¤çš„ç¨³å®šæ€§ã€å¯é æ€§ã€å…¼å®¹æ€§å’Œæ‰©å±•æ€§ã€‚

å‡çº§å‰éœ€è¦å¤‡ä»½ etcd æ•°æ®ï¼Œå…ˆå‡çº§ç®¡ç†èŠ‚ç‚¹ï¼ˆMaster Nodeï¼‰ï¼Œå†å‡çº§å·¥ä½œèŠ‚ç‚¹ï¼ˆWorker Nodeï¼‰ï¼Œå·¥ä½œèŠ‚ç‚¹é‡‡ç”¨æ»šåŠ¨å‡çº§çš„æ–¹å¼ï¼Œé€ä¸ªæˆ–åˆ†æ‰¹å‡çº§ï¼Œé¿å…ä¸šåŠ¡ä¸­æ–­ã€‚

ç„¶åæˆ‘å¸¦ä½ åŠ¨æ‰‹å®Œæˆäº† etcd ç»„ä»¶çš„æ•°æ®å¤‡ä»½å’Œæ•°æ®æ¢å¤ï¼Œéœ€è¦å…ˆå®‰è£… etcdctl å‘½ä»¤å·¥å…·ï¼Œç„¶åä½¿ç”¨ â€œetcdctl snapshot saveâ€ å’Œ â€œetcdctl snapshot restoreâ€ è¿™ä¸¤ä¸ªå‘½ä»¤è¿›è¡Œæ•°æ®å¤‡ä»½å’Œæ¢å¤ã€‚åœ¨æ•°æ®æ¢å¤å‰éœ€è¦å…ˆåœæ­¢æ‰€æœ‰ç³»ç»Ÿæ ¸å¿ƒç»„ä»¶ï¼Œç¡®ä¿å®ƒä»¬ä¸ä¼šä¾èµ–ä¸€äº›è¿‡æ—¶æ•°æ®ï¼Œç­‰æ•°æ®æ¢å¤å®Œæˆå†é‡å¯ç»„ä»¶ã€‚

æœ€åï¼Œæˆ‘ç»™ä½ åˆ—å‡ºäº†ç®¡ç†èŠ‚ç‚¹å’Œå·¥ä½œèŠ‚ç‚¹çš„å‡çº§æ­¥éª¤ï¼ŒæŒ‰ç…§æ“ä½œæ­¥éª¤æ‰§è¡Œå‘½ä»¤å°±å¯ä»¥å®Œæˆé›†ç¾¤èŠ‚ç‚¹çš„ç‰ˆæœ¬å‡çº§ï¼Œéœ€è¦æ³¨æ„å‡çº§è¿‡ç¨‹ä¸­éœ€è¦å…ˆé©±é€èŠ‚ç‚¹ä¸Šçš„ Podï¼ŒåŒæ—¶è®¾ç½®èŠ‚ç‚¹ä¸å¯è°ƒåº¦ï¼Œå‡çº§å®Œæˆåå†å–æ¶ˆè®¾ç½®ã€‚

## æ€è€ƒé¢˜

è¿™å°±æ˜¯ä»Šå¤©çš„å…¨éƒ¨å†…å®¹ï¼Œåœ¨ CKA è€ƒè¯•ä¸­ä¼šè€ƒåˆ° etcd å¤‡ä»½å’Œæ¢å¤å‘½ä»¤ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚æˆ‘ç»™ä½ ç•™ä¸€é“ç»ƒä¹ é¢˜ã€‚

å†™ä¸€ä¸ªè„šæœ¬ï¼Œæ¯å¤©å®šæ—¶å¤‡ä»½ etcd æ•°æ®ã€‚

ç›¸ä¿¡ç»è¿‡åŠ¨æ‰‹å®è·µï¼Œä¼šè®©ä½ å¯¹çŸ¥è¯†çš„ç†è§£æ›´åŠ æ·±åˆ»ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ1ï¼‰</strong></div><ul>
<li><span>ä½™æ³½é”‹</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆæ€ä¹ˆæ²¡æœ‰æ•…éšœæ’æŸ¥</p>2024-07-31</li><br/>
</ul>