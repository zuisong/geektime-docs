ä½ å¥½ï¼Œæˆ‘æ˜¯é›ªé£ã€‚

ç½‘ç»œè®¿é—®çš„é—®é¢˜è§£å†³äº†ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹å­˜å‚¨å§ã€‚åº”ç”¨ä¸­å¤„ç†æ•°æ®å­˜å‚¨ä¸»è¦æœ‰ä¸¤ä¸ªåœºæ™¯ï¼šä¸€æ˜¯å°†æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œé€šè¿‡ä»£ç è¿æ¥åˆ°æ•°æ®åº“æœåŠ¡ï¼Œç„¶åä½¿ç”¨æ•°æ®åº“ SQL è¯­å¥è¯»å†™æ•°æ®ï¼Œè¿™ç§æ–¹å¼ä¸éœ€è¦ K8s é›†ç¾¤æä¾›å­˜å‚¨ï¼›äºŒæ˜¯æ–‡ä»¶å­˜å‚¨ï¼Œç”±äº Pod ä¸­çš„å®¹å™¨æ¯æ¬¡é‡å¯åï¼Œéƒ½ä¼šé‡æ–°ç”Ÿæˆå®¹å™¨å†…çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥åº”ç”¨åœ¨å®¹å™¨ä¸­ä¿å­˜çš„æ–‡ä»¶éƒ½æ— æ³•åœ¨ä¸‹æ¬¡é‡å¯åä¿ç•™ã€‚ä½†æ˜¯åº”ç”¨åˆéœ€è¦æŠŠæŸäº›æ–‡ä»¶ï¼ˆå¦‚æ—¥å¿—ã€ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ç­‰ï¼‰é•¿æœŸä¿å­˜ï¼Œä»¥ä¾¿ä¸‹æ¬¡é‡å¯å®¹å™¨åè¿˜èƒ½å†æ¬¡è®¿é—®ä½¿ç”¨ï¼Œè¿™å°±æ˜¯æ–‡ä»¶çš„æŒä¹…åŒ–å­˜å‚¨é—®é¢˜ï¼Œè¿™ç§åœºæ™¯éœ€è¦ K8s é›†ç¾¤æ¥æä¾›å­˜å‚¨æ–¹æ¡ˆã€‚

## è®¤è¯†æ•°æ®å·ï¼ˆVolumeï¼‰

K8s ä½¿ç”¨ä¸€ä¸ªæŠ½è±¡çš„æ•°æ®å·ï¼ˆVolumeï¼‰æ¥è§£å†³æ–‡ä»¶çš„æŒä¹…åŒ–å­˜å‚¨é—®é¢˜ã€‚åœ¨ Pod ä¸­æˆ‘ä»¬å…ˆå®šä¹‰äº†ä»£è¡¨æŸç§å­˜å‚¨ç©ºé—´çš„ Volumeï¼Œç„¶ååœ¨ Pod çš„å®¹å™¨ä¸­ï¼Œé€šè¿‡æŠŠè¿™ä¸ª Volume æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„æŸä¸ªç›®å½•ï¼Œå°±å¯ä»¥å»ºç«‹ä¸€ä¸ªç©ºé—´æ˜ å°„å…³ç³»ï¼Œä¹‹ååœ¨å®¹å™¨ä¸­æ“ä½œè¿™ä¸ªç›®å½•ï¼ˆä¾‹å¦‚åˆ›å»ºç›®å½•ã€è¯»å†™æ–‡ä»¶ç­‰ï¼‰ï¼Œå°±ç›¸å½“äºåœ¨è¯¥å­˜å‚¨ç©ºé—´ä¸­è¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥è¿™äº›æ“ä½œç»“æœå°±è‡ªç„¶åœ°ä¿ç•™åˆ°äº†è¯¥å­˜å‚¨ç©ºé—´ä¸­ï¼Œä»è€Œå®ç°äº†æŒä¹…åŒ–å­˜å‚¨ã€‚

æ•°æ®å·æœ‰å¤šç§ç±»å‹ï¼Œä»¥ä¸‹æ˜¯å¸¸ç”¨çš„å‡ ç§ï¼š

- **èŠ‚ç‚¹æœ¬åœ°å­˜å‚¨ï¼š**è¿™ç±»å­˜å‚¨æ˜¯åœ¨ Pod æ‰€åœ¨çš„èŠ‚ç‚¹å®¿ä¸»æœºæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸Šè¿›è¡Œæ–‡ä»¶å­˜å‚¨ï¼Œå¦‚ emptyDir å’Œ hostPath ç±»å‹ã€‚
- **ç½‘ç»œå…±äº«å­˜å‚¨ï¼š**è¿™ç±»å­˜å‚¨ç›´æ¥ä½¿ç”¨å…±äº«çš„ç½‘ç»œå­˜å‚¨æœåŠ¡ï¼Œå¦‚ NFS å’Œ Ceph ç­‰ç±»å‹ã€‚
- **ConfigMap å’Œ Secretï¼š**è¿™ä¸¤ç§èµ„æºå¯¹è±¡ä¹Ÿå¯ä»¥ä½œä¸º Volumeï¼Œä»¥é…ç½®æ–‡ä»¶çš„å½¢å¼æŒ‚è½½åˆ° Pod ä¸­ä½¿ç”¨ã€‚ä¹‹å‰å·²ç»ä»‹ç»è¿‡å®ƒä»¬ã€‚
- **persistentVolumeï¼ˆPVï¼‰å’Œ persistentVolumeClaimï¼ˆPVCï¼‰ï¼š**å®ƒä»¬æ˜¯ K8s æä¾›çš„ç”¨æ¥è§£è€¦å®é™…å­˜å‚¨ç©ºé—´å’Œå­˜å‚¨éœ€æ±‚çš„èµ„æºå¯¹è±¡ã€‚PV ä»£è¡¨äº†æŸäº›å­˜å‚¨ç©ºé—´ï¼Œè€Œ PVC ä»£è¡¨ Pod å¯¹å­˜å‚¨çš„éœ€æ±‚ï¼ŒK8s ä¼šè‡ªåŠ¨æ ¹æ®å­˜å‚¨éœ€æ±‚ PVC æ¥é€‰æ‹©åˆé€‚çš„å­˜å‚¨ç©ºé—´ PV è¿›è¡Œç»‘å®šï¼Œç„¶å Pod å°±å¯ä»¥åœ¨å®¹å™¨ä¸­æŒ‚è½½ PVC ä»è€Œä½¿ç”¨ PV ä»£è¡¨çš„å­˜å‚¨ç©ºé—´ã€‚è¿™ä¸ªæœºåˆ¶å®ç°äº†å­˜å‚¨ç©ºé—´ç®¡ç†å’Œä½¿ç”¨çš„åˆ†ç¦»ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ4ï¼‰</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/11/ff/28/040f6f01.jpg" width="30px"><span>Y</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ç¬¬ä¸€é¢˜ï¼š
# my-pv-hostpath.yaml 
apiVersion: v1
kind: PersistentVolume
metadata:
  name: my-pv-hostpath-10m # è‡ªå®šä¹‰PVåå­—
spec:
  capacity:
    storage: 10M # å®šä¹‰è¿™ä¸ªPVçš„å­˜å‚¨å¤§å°
  accessModes:
    - ReadWriteMany # è®¿é—®æ¨¡å¼
  persistentVolumeReclaimPolicy: Retain  # é»˜è®¤Retain
  hostPath:
    path: &#47;host&#47;data 

ç¬¬äºŒé¢˜ï¼š

# my-pv.yaml 
apiVersion: v1
kind: PersistentVolume
metadata:
  name: my-pv-20m # è‡ªå®šä¹‰PVåå­—
spec:
  capacity:
    storage: 20M # å®šä¹‰è¿™ä¸ªPVçš„å­˜å‚¨å¤§å°
  accessModes:
    - ReadWriteMany # è®¿é—®æ¨¡å¼
  persistentVolumeReclaimPolicy: Retain  # é»˜è®¤Retain
  nfs:
    server: k8s-worker2 # æŒ‡å®šNFSä¸»æœºçš„IPåœ°å€æˆ–è€…ä¸»æœºå
    path: &#47;nfs&#47;k8s&#47;shared # ç»‘å®šä¸»æœºçš„çš„è·¯å¾„

# my-pvc-20m.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc-20m # è‡ªå®šä¹‰pvcåå­—
spec:
  accessModes:
    - ReadWriteMany  # è®¿é—®æ¨¡å¼
  resources:
    requests:
      storage: 20M # å®šä¹‰è¦ç”³è¯·çš„ç©ºé—´å¤§å°

# my-pvc-deployment.yaml 
apiVersion: apps&#47;v1
kind: Deployment
metadata:
  name: my-pvc-deployment-20m
spec:
  replicas: 3
  selector:
    matchLabels:
      app: pvc-busybox-pod
  template:
    metadata:
      labels:
        app: pvc-busybox-pod
    spec:
      containers:
      - name: busybox-c
        image: swr.cn-north-4.myhuaweicloud.com&#47;ddn-k8s&#47;docker.io&#47;library&#47;busybox:1.28
        command: [&quot;&#47;bin&#47;sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;]
        volumeMounts:
        - name: pvc-shared-data
          mountPath: &#47;tmp&#47;data
      volumes:
        - name: pvc-shared-data
          persistentVolumeClaim:
            claimName: my-pvc-20m  # éƒ¨ç½²å¥½çš„PVC</div>2024-08-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/52/d2/a0a800e9.jpg" width="30px"><span>å¥”è·‘çš„é˜¿é£</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æ¯”è‘«èŠ¦ç”»ç“¢ã€‚
ç¬¬ä¸€é¢˜
# my-pv-10m.yaml 
apiVersion: v1
kind: hostPath
metadata:
  name: my-pv-10m 
spec:
  capacity:
    storage: 10M 
  accessModes:
    - ReadWriteMany 
  persistentVolumeReclaimPolicy: Retain  # é»˜è®¤Retain
volumes:  
- name: host-path-volume    
	hostPath:      
	path: &#47;host&#47;data      
	type: Directory 
	  
ç¬¬äºŒé¢˜	  
# my-pvc-20m.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc-20m # è‡ªå®šä¹‰pvcåå­—
spec:
  accessModes:
    - ReadWriteMany  # è®¿é—®æ¨¡å¼
  resources:
    requests:
      storage: 20M # å®šä¹‰è¦ç”³è¯·çš„ç©ºé—´å¤§å°



# my-pvc-deployment-20m.yaml 
apiVersion: apps&#47;v1
kind: Deployment
metadata:
  name: my-pvc-deployment-20m
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pvc-busybox-pod
  template:
    metadata:
      labels:
        app: pvc-busybox-pod
    spec:
      containers:
      - name: busybox-c
        image: busybox
        command: [&quot;&#47;bin&#47;sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;]
        volumeMounts:
        - name: pvc-shared-data
          mountPath: &#47;tmp
      volumes:
        - name: pvc-shared-data
          persistentVolumeClaim:
            claimName: my-pvc-20m  # éƒ¨ç½²å¥½çš„PVC</div>2024-07-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f4/7f/c3d6b4bc.jpg" width="30px"><span>æ‘©ç¾¯</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div> ReadWriteOnceï¼ˆRWOï¼‰ï¼šè¯»å†™æƒé™ï¼Œä½†æ˜¯åªèƒ½è¢«å•ä¸ªèŠ‚ç‚¹æŒ‚è½½
PVC  å’Œ  PV  éƒ½æœ‰è¿™ä¸ªå±æ€§ã€‚è¿™é‡Œçš„èŠ‚ç‚¹æŒ‡çš„æ˜¯ k8s çš„èŠ‚ç‚¹å—ï¼ŸåŒä¸€ä¸ªèŠ‚ç‚¹çš„å¤šä¸ªä¸åŒpodå¯ä»¥è¯»å†™åŒä¸€ä¸ªpvï¼Ÿè¿™ç§æƒ…å†µä¸‹ï¼Œè¿˜æ˜¯å®¹æ˜“å‡ºç° nfs ç›¸åŒçš„é—®é¢˜å§ï¼Ÿ</div>2024-12-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f4/7f/c3d6b4bc.jpg" width="30px"><span>æ‘©ç¾¯</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>ReadWriteOnceï¼ˆRWOï¼‰ï¼šè¯»å†™æƒé™ï¼Œä½†æ˜¯åªèƒ½è¢«å•ä¸ªèŠ‚ç‚¹æŒ‚è½½</div>2024-12-25</li><br/>
</ul>