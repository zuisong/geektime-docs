ä½ å¥½ï¼Œæˆ‘æ˜¯é›ªé£ã€‚

ç½‘ç»œè®¿é—®çš„é—®é¢˜è§£å†³äº†ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹å­˜å‚¨å§ã€‚åº”ç”¨ä¸­å¤„ç†æ•°æ®å­˜å‚¨ä¸»è¦æœ‰ä¸¤ä¸ªåœºæ™¯ï¼šä¸€æ˜¯å°†æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œé€šè¿‡ä»£ç è¿æ¥åˆ°æ•°æ®åº“æœåŠ¡ï¼Œç„¶åä½¿ç”¨æ•°æ®åº“ SQL è¯­å¥è¯»å†™æ•°æ®ï¼Œè¿™ç§æ–¹å¼ä¸éœ€è¦ K8s é›†ç¾¤æä¾›å­˜å‚¨ï¼›äºŒæ˜¯æ–‡ä»¶å­˜å‚¨ï¼Œç”±äº Pod ä¸­çš„å®¹å™¨æ¯æ¬¡é‡å¯åï¼Œéƒ½ä¼šé‡æ–°ç”Ÿæˆå®¹å™¨å†…çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥åº”ç”¨åœ¨å®¹å™¨ä¸­ä¿å­˜çš„æ–‡ä»¶éƒ½æ— æ³•åœ¨ä¸‹æ¬¡é‡å¯åä¿ç•™ã€‚ä½†æ˜¯åº”ç”¨åˆéœ€è¦æŠŠæŸäº›æ–‡ä»¶ï¼ˆå¦‚æ—¥å¿—ã€ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ç­‰ï¼‰é•¿æœŸä¿å­˜ï¼Œä»¥ä¾¿ä¸‹æ¬¡é‡å¯å®¹å™¨åè¿˜èƒ½å†æ¬¡è®¿é—®ä½¿ç”¨ï¼Œè¿™å°±æ˜¯æ–‡ä»¶çš„æŒä¹…åŒ–å­˜å‚¨é—®é¢˜ï¼Œè¿™ç§åœºæ™¯éœ€è¦ K8s é›†ç¾¤æ¥æä¾›å­˜å‚¨æ–¹æ¡ˆã€‚

## è®¤è¯†æ•°æ®å·ï¼ˆVolumeï¼‰

K8s ä½¿ç”¨ä¸€ä¸ªæŠ½è±¡çš„æ•°æ®å·ï¼ˆVolumeï¼‰æ¥è§£å†³æ–‡ä»¶çš„æŒä¹…åŒ–å­˜å‚¨é—®é¢˜ã€‚åœ¨ Pod ä¸­æˆ‘ä»¬å…ˆå®šä¹‰äº†ä»£è¡¨æŸç§å­˜å‚¨ç©ºé—´çš„ Volumeï¼Œç„¶ååœ¨ Pod çš„å®¹å™¨ä¸­ï¼Œé€šè¿‡æŠŠè¿™ä¸ª Volume æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„æŸä¸ªç›®å½•ï¼Œå°±å¯ä»¥å»ºç«‹ä¸€ä¸ªç©ºé—´æ˜ å°„å…³ç³»ï¼Œä¹‹ååœ¨å®¹å™¨ä¸­æ“ä½œè¿™ä¸ªç›®å½•ï¼ˆä¾‹å¦‚åˆ›å»ºç›®å½•ã€è¯»å†™æ–‡ä»¶ç­‰ï¼‰ï¼Œå°±ç›¸å½“äºåœ¨è¯¥å­˜å‚¨ç©ºé—´ä¸­è¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥è¿™äº›æ“ä½œç»“æœå°±è‡ªç„¶åœ°ä¿ç•™åˆ°äº†è¯¥å­˜å‚¨ç©ºé—´ä¸­ï¼Œä»è€Œå®ç°äº†æŒä¹…åŒ–å­˜å‚¨ã€‚

æ•°æ®å·æœ‰å¤šç§ç±»å‹ï¼Œä»¥ä¸‹æ˜¯å¸¸ç”¨çš„å‡ ç§ï¼š

- **èŠ‚ç‚¹æœ¬åœ°å­˜å‚¨ï¼š**è¿™ç±»å­˜å‚¨æ˜¯åœ¨ Pod æ‰€åœ¨çš„èŠ‚ç‚¹å®¿ä¸»æœºæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸Šè¿›è¡Œæ–‡ä»¶å­˜å‚¨ï¼Œå¦‚ emptyDir å’Œ hostPath ç±»å‹ã€‚
- **ç½‘ç»œå…±äº«å­˜å‚¨ï¼š**è¿™ç±»å­˜å‚¨ç›´æ¥ä½¿ç”¨å…±äº«çš„ç½‘ç»œå­˜å‚¨æœåŠ¡ï¼Œå¦‚ NFS å’Œ Ceph ç­‰ç±»å‹ã€‚
- **ConfigMap å’Œ Secretï¼š**è¿™ä¸¤ç§èµ„æºå¯¹è±¡ä¹Ÿå¯ä»¥ä½œä¸º Volumeï¼Œä»¥é…ç½®æ–‡ä»¶çš„å½¢å¼æŒ‚è½½åˆ° Pod ä¸­ä½¿ç”¨ã€‚ä¹‹å‰å·²ç»ä»‹ç»è¿‡å®ƒä»¬ã€‚
- **persistentVolumeï¼ˆPVï¼‰å’Œ persistentVolumeClaimï¼ˆPVCï¼‰ï¼š**å®ƒä»¬æ˜¯ K8s æä¾›çš„ç”¨æ¥è§£è€¦å®é™…å­˜å‚¨ç©ºé—´å’Œå­˜å‚¨éœ€æ±‚çš„èµ„æºå¯¹è±¡ã€‚PV ä»£è¡¨äº†æŸäº›å­˜å‚¨ç©ºé—´ï¼Œè€Œ PVC ä»£è¡¨ Pod å¯¹å­˜å‚¨çš„éœ€æ±‚ï¼ŒK8s ä¼šè‡ªåŠ¨æ ¹æ®å­˜å‚¨éœ€æ±‚ PVC æ¥é€‰æ‹©åˆé€‚çš„å­˜å‚¨ç©ºé—´ PV è¿›è¡Œç»‘å®šï¼Œç„¶å Pod å°±å¯ä»¥åœ¨å®¹å™¨ä¸­æŒ‚è½½ PVC ä»è€Œä½¿ç”¨ PV ä»£è¡¨çš„å­˜å‚¨ç©ºé—´ã€‚è¿™ä¸ªæœºåˆ¶å®ç°äº†å­˜å‚¨ç©ºé—´ç®¡ç†å’Œä½¿ç”¨çš„åˆ†ç¦»ã€‚

è¿™äº›æ•°æ®å·ä¸ºæˆ‘ä»¬åº”ç”¨çš„æŒä¹…åŒ–å­˜å‚¨éœ€æ±‚æä¾›äº†ä¸°å¯Œçš„é€‰æ‹©ã€‚é¦–å…ˆï¼Œæˆ‘æ¥ä»‹ç»ä¸¤ç§æœ€ç®€å•çš„èŠ‚ç‚¹æœ¬åœ°å­˜å‚¨çš„æ–¹å¼ï¼šemptyDir å’Œ hostPathã€‚

## èŠ‚ç‚¹æœ¬åœ°å­˜å‚¨

#### emptyDir å·

emptyDir å·æ˜¯ä¸€ç§ä¸´æ—¶å­˜å‚¨ï¼Œå®ƒä¼šåœ¨ Pod æ‰€åœ¨çš„èŠ‚ç‚¹å®¿ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œç”¨äº Pod å†…éƒ¨å®¹å™¨çš„ä¸´æ—¶æ•°æ®äº¤æ¢ã€‚å°±åƒåå­—æ„æ€ä¸€æ ·ï¼ŒemptyDirÂ å·åˆ›å»ºæ—¶æ˜¯ç©ºçš„ã€‚Pod ä¸­å®¹å™¨éƒ½å¯ä»¥è¯»å†™ emptyDirÂ å·ä¸­çš„æ–‡ä»¶ã€‚å½“ Pod ä»èŠ‚ç‚¹ä¸Šåˆ é™¤æ—¶ï¼ŒemptyDir å·ä¸­çš„æ•°æ®ä¹Ÿä¼šè¢«æ°¸ä¹…æ¸…ç©ºã€‚å½“ç„¶ï¼ŒPod ä¸­å®¹å™¨å´©æºƒå¹¶ä¸ä¼šå¯¼è‡´ Pod ä»èŠ‚ç‚¹ä¸Šç§»é™¤ï¼Œå› æ­¤å®¹å™¨å´©æºƒæœŸé—´Â emptyDirÂ å·ä¸­çš„æ•°æ®æ˜¯å®‰å…¨çš„ã€‚æˆ‘ä¹‹å‰åœ¨ä»‹ç» Pod çš„å®¹å™¨å…±äº«å­˜å‚¨æ—¶å°±ä½¿ç”¨äº† emptyDir å·ï¼Œè¿™é‡Œå°±ä¸å†ä¸¾ä¾‹ã€‚

#### hostPath å·

hostPath å·ä¹Ÿæ˜¯ä¸€ç§èŠ‚ç‚¹æœ¬åœ°å­˜å‚¨ï¼Œå®ƒå…è®¸ä½ å°† Pod æ‰€åœ¨èŠ‚ç‚¹å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶ç›®å½•æŒ‚è½½åˆ°å®¹å™¨ä¸­ä½¿ç”¨ã€‚é€šè¿‡ä½¿ç”¨ hostPath å·ï¼Œå®¹å™¨ä¸­åº”ç”¨å¯ä»¥ç›´æ¥æ“ä½œèŠ‚ç‚¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„ç›®å½•å’Œæ–‡ä»¶ï¼Œå°±åƒå®ƒä»¬æ˜¯å®¹å™¨å†…éƒ¨æ–‡ä»¶ç³»ç»Ÿç›®å½•å’Œæ–‡ä»¶ä¸€æ ·ã€‚

hostPath å·é€šå¸¸ç”¨äºå®¹å™¨ä¸­çš„åº”ç”¨éœ€è¦è®¿é—®å®¿ä¸»æœºä¸Šçš„æ—¥å¿—æˆ–é…ç½®æ–‡ä»¶ã€‚hostPath å·ä¼šå­˜åœ¨ä¸€äº›å®‰å…¨é£é™©ï¼Œå› ä¸ºå®ƒå¯ä»¥å…è®¸å®¹å™¨ä¸­çš„åº”ç”¨ä¿®æ”¹å®¿ä¸»æœºä¸Šçš„æ•æ„Ÿæ–‡ä»¶ã€‚æ­¤å¤–ï¼Œä½¿ç”¨ hostPath å·ä¹Ÿä¼šå¯¼è‡´å¯¹å®¿ä¸»æœºç¯å¢ƒçš„ä¾èµ–ï¼Œä»è€Œå½±å“åº”ç”¨çš„å¯ç§»æ¤æ€§å’Œä¸€è‡´æ€§ã€‚å› æ­¤ï¼Œå¦‚æœå¿…é¡»ä½¿ç”¨ hostPath å·æ—¶ï¼Œåº”å°†å…¶ä½¿ç”¨èŒƒå›´é™åˆ¶åœ¨å¿…è¦çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œå¹¶ä¸”ä»¥åªè¯»æ–¹å¼æŒ‚è½½ï¼Œä»¥ç¡®ä¿å®‰å…¨æ€§å’Œç¨³å®šæ€§ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ª hostPath å·çš„ YAML æ–‡ä»¶ï¼ˆmy-hostpath.yamlï¼‰ç¤ºä¾‹ã€‚æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª hostPath å·ï¼Œå¹¶å°†å…¶æŒ‚è½½åˆ° busybox å®¹å™¨å†…çš„ â€œ/data/tmpâ€ ç›®å½•ã€‚è¿™æ ·ï¼Œå°±å¯ä»¥åœ¨å®¹å™¨å†…æ“ä½œèŠ‚ç‚¹å®¿ä¸»æœºä¸Šå¯¹åº”çš„ hostPath ç›®å½•ï¼ŒåŒ…æ‹¬åˆ›å»ºå­ç›®å½•ã€è¯»å†™æ–‡ä»¶ç­‰ç­‰ã€‚

```yaml
# my-hostpath.yamlÂ 
apiVersion: v1
kind: Pod
metadata:
Â  name: my-hostpath-pod
spec:
Â  containers:
Â  - name: busybox
Â  Â  image: busybox
    command: ["/bin/sh","-c","sleep 3600"]
Â  Â  volumeMounts:
Â  Â  - name: host-path-volume
Â  Â  Â  mountPath: /data/tmp
    # readOnly: true    # å¦‚æœæŒ‚è½½çš„æ˜¯æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ readOnly é™åˆ¶åªè¯»æ–‡ä»¶
Â  volumes:
Â  - name: host-path-volume
Â  Â  hostPath:
Â  Â  Â  path: /tmp
Â  Â  Â  type: Directory   # è¯´æ˜æŒ‚è½½è·¯å¾„çš„æ˜¯ç›®å½•ï¼ˆDirectoryï¼‰è¿˜æ˜¯æ–‡ä»¶
```

- **volumeMounts**ï¼šè¡¨ç¤ºå®¹å™¨ä¸­æŒ‚è½½çš„æ•°æ®å·ä¿¡æ¯ï¼ŒåŒ…å«è¦æŒ‚è½½çš„æ•°æ®å·åç§°ï¼ˆnameï¼‰å’ŒæŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨æ–‡ä»¶ç³»ç»Ÿçš„è·¯å¾„ï¼ˆmountPathï¼‰ï¼Œæ³¨æ„è¿™ä¸ªå±æ€§çš„å±‚çº§æ˜¯åœ¨å®¹å™¨å†…éƒ¨ï¼Œè€Œä¸”å®ƒæ˜¯åˆ—è¡¨ï¼Œå¯ä»¥åŒæ—¶æŒ‚è½½å¤šä¸ªæ•°æ®å·ã€‚
- **volumes**ï¼šè¡¨ç¤ºåˆ›å»ºæ•°æ®å·ï¼Œæ³¨æ„è¿™ä¸ªå±æ€§çš„å±‚çº§æ˜¯å’Œå®¹å™¨ç›¸åŒï¼Œè€Œä¸”å®ƒæ˜¯åˆ—è¡¨ï¼Œå¯ä»¥åŒæ—¶åˆ›å»ºå¤šä¸ªä¸åŒç§ç±»çš„æ•°æ®å·ã€‚volumes å’Œ volumeMounts æˆå¯¹å‡ºç°ï¼Œå…±åŒå®Œæˆå®¹å™¨æŒ‚è½½å­˜å‚¨ç©ºé—´çš„è¿‡ç¨‹ã€‚

Pod éƒ¨ç½²æˆåŠŸåï¼Œåœ¨ busybox å®¹å™¨å†…å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ â€œ/data/tmpâ€ æ–‡ä»¶ç›®å½•ã€‚æˆ‘ä»¬è¿›å…¥å®¹å™¨å†…éƒ¨å¹¶åˆ›å»ºä¸€ä¸ª â€œaaa.txtâ€ æ–‡ä»¶ï¼Œç„¶åæŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ª Pod è¢«è°ƒåº¦åˆ°çš„èŠ‚ç‚¹æ˜¯ k8s-worker1ã€‚

```yaml
[root@k8s-master ~]# kubectl apply -f my-hostpath.yamlÂ 
pod/my-hostpath-pod created
# è¿›å…¥å®¹å™¨ busybox ä¸­æŸ¥çœ‹æŒ‚è½½çš„æ–‡ä»¶ç›®å½•
[root@k8s-master ~]# kubectl exec -it my-hostpath-pod -c busybox -- sh
/ # cd data/tmp
/data/tmp # echo "Hello hostpath!" > aaa.txt
/data/tmp # cat aaa.txt
Hello hostpath!
/data/tmp # exit
[root@k8s-master ~]# kubectl get pod -o wide
NAMEÂ  Â  Â  Â  Â  Â  Â  READYÂ  Â STATUSÂ  Â  RESTARTSÂ  Â AGEÂ  Â  IPÂ  Â  Â  Â  Â  Â  Â  Â NODEÂ  Â  Â  Â  Â  NOMINATED NODEÂ  Â READINESS GATES
my-hostpath-podÂ  Â 1/1Â  Â  Â RunningÂ  Â 0Â  Â  Â  Â  Â  2m1sÂ  Â 10.244.194.126Â  Â k8s-worker1Â  Â <none>Â  Â  Â  Â  Â  Â <none>
```

è¿™æ—¶ï¼Œæˆ‘ä»¬è¿œç¨‹è¿æ¥åˆ° k8s-worker1 èŠ‚ç‚¹ä¸Šï¼ŒæŸ¥çœ‹ â€œ/tmpâ€ ç›®å½•ï¼Œå°±å¯ä»¥çœ‹åˆ° â€œaaa.txtâ€ æ–‡ä»¶ã€‚è¿™è¡¨æ˜äº† hostPath å·æˆåŠŸå°†å®¿ä¸»æœºçš„ç›®å½•æ˜ å°„åˆ°äº†å®¹å™¨å†…éƒ¨ã€‚

```bash
[root@k8s-worker1 ~]# cd /tmp
[root@k8s-worker1 tmp]# cat aaa.txt
Hello hostpath!
```

## ç½‘ç»œå…±äº«å­˜å‚¨

èŠ‚ç‚¹æœ¬åœ°å­˜å‚¨çš„ä¸¤ç§æ•°æ®å·ç”¨èµ·æ¥éå¸¸ç®€å•æ–¹ä¾¿ï¼Œä½†æ˜¯æ— æ³•è§£å†³ä¸åŒèŠ‚ç‚¹çš„å¤šä¸ª Pod ä¹‹é—´å¯¹æ–‡ä»¶çš„å…±äº«åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ Deployment éƒ¨ç½²äº†å¤šä¸ª Pod åº”ç”¨ï¼Œä½ é¦–æ¬¡è®¿é—® Pod æ—¶ä¸Šä¼ äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œå­˜å‚¨åœ¨è¿™ä¸ª Pod æ‰€åœ¨çš„ k8s-worker1 èŠ‚ç‚¹ä¸Šï¼Œä½†æ˜¯è¿‡ä¸€ä¼šä½ è¦è¯»æ–‡ä»¶æ—¶ï¼ŒService è´Ÿè½½å‡è¡¡æŠŠè¯·æ±‚å‘é€åˆ° k8s-worker2 èŠ‚ç‚¹ä¸Šçš„å¦ä¸€ä¸ª Pod å‰¯æœ¬ï¼Œè¿™æ—¶ä½ è‚¯å®šæ— æ³•å†è¯»å–åˆ°ä¹‹å‰ä¸Šä¼ çš„æ–‡ä»¶ã€‚æ˜¾ç„¶ï¼Œè¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ç»“æœã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–‡ä»¶å…±äº«å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚ä¸‹é¢æˆ‘å°±ä»‹ç»ä¸€ä¸‹æœ€å¸¸ç”¨çš„ NFS æ–‡ä»¶å…±äº«å­˜å‚¨æœåŠ¡ã€‚

#### NFS å·

NFSï¼ˆNetwork File Systemï¼‰æ˜¯ä¸€ç§ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒå…è®¸å¤šä¸ª Pod ä¸­çš„å®¹å™¨è®¿é—®åŒä¸€ä¸ªç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€æœ‰çš„æ–‡ä»¶éƒ½å­˜å‚¨åœ¨ç½‘ç»œæ–‡ä»¶ç³»ç»ŸæœåŠ¡ç«¯çš„å…±äº«ç›®å½•ä¸­ï¼Œè€Œä¸æ˜¯åœ¨ Pod æ‰€åœ¨èŠ‚ç‚¹å®¿ä¸»æœºä¸Šï¼Œæ‰€ä»¥éå¸¸é€‚åˆéœ€è¦æ–‡ä»¶å…±äº«æˆ–æŒä¹…åŒ–å­˜å‚¨çš„åœºæ™¯ã€‚

NFS ç»„æˆåˆ†ä¸ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­æœåŠ¡ç«¯è´Ÿè´£æä¾›å…±äº«æ–‡ä»¶ç›®å½•ï¼Œå®¢æˆ·ç«¯è´Ÿè´£è¿æ¥åˆ°æœåŠ¡ç«¯å¹¶ä½¿ç”¨æœåŠ¡ç«¯æä¾›çš„å…±äº«ç›®å½•ã€‚æ‰€ä»¥ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿå®ç°äº†å¤šä¸ªå®¢æˆ·ç«¯é€šè¿‡ç½‘ç»œä¼ è¾“æ¥å…±äº«æœåŠ¡ç«¯çš„æ–‡ä»¶ç›®å½•ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/08/82/08be30986147415cf3cf340e604f7182.jpg?wh=834x413)

æ¥ä¸‹æ¥ï¼Œæˆ‘å¸¦ä½ æ­å»ºä¸€ä¸ª NFSã€‚é€šå¸¸ NFS æœåŠ¡ç«¯åº”è¯¥éƒ¨ç½²åœ¨ K8s é›†ç¾¤å¤–éƒ¨æœåŠ¡å™¨ä¸Šã€‚ä¸ºäº†èŠ‚çœèµ„æºï¼Œæˆ‘ä»¬é€‰æ‹©é›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ k8s-worker2 ä½œä¸º NFS æœåŠ¡ç«¯ï¼Œå°† k8s-worker1 å’Œ k8s-master ä½œä¸º NFS å®¢æˆ·ç«¯ï¼Œä»¥ä¸‹æ˜¯æ­å»ºè¿‡ç¨‹ã€‚

```bash
# 1ã€å®‰è£… NFS æœåŠ¡ï¼ŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½éœ€è¦å®‰è£…ã€‚
yum install nfs-utils

# 2ã€åœ¨æœåŠ¡ç«¯åˆ›å»ºä¸€ä¸ªå…±äº«ç›®å½•ï¼Œæˆ‘è¿™é‡Œç”¨ç›®å½• "/nfs/k8s/shared"
[root@k8s-worker2 ~]# mkdir -p /nfs/k8s/shared

# 3ã€ç¼–è¾‘ä¿®æ”¹æœåŠ¡ç«¯ä¸Šçš„ "/etc/exports"Â æ–‡ä»¶ï¼Œé…ç½®ä½¿ç”¨è¿™ä¸ªå…±äº«æ–‡ä»¶ç›®å½•
[root@k8s-worker2 ~]# vi /etc/exports
/nfs/k8s/shared *(rw,no_root_squash)  # åœ¨é…ç½®æ–‡ä»¶ä¸­å¢åŠ ä¸€æ¡è®°å½•
# /nfs/k8s/shared æ˜¯å…±äº«æ–‡ä»¶ç›®å½•
# * è¡¨ç¤ºæ‰€æœ‰ IP çš„å®¢æˆ·ç«¯éƒ½å¯ä»¥è®¿é—®
# rw è¡¨ç¤ºå¯ä»¥å®¢æˆ·ç«¯å¯ä»¥è¯»å†™ç›®å½•
# no_root_squash è¡¨ç¤ºä¿æŒå®¢æˆ·ç«¯è®¿é—®ç›®å½•çš„ root ç”¨æˆ·æƒé™ï¼Œæ–¹ä¾¿å®¢æˆ·ç«¯æ“ä½œå…±äº«ç›®å½•

# 4ã€ç”Ÿæ•ˆé…ç½®
[root@k8s-worker2 ~]# exportfs -arv
exporting *:/nfs/k8s/shared

# 5ã€åœ¨æœåŠ¡ç«¯ä¸Šå¼€å¯ NFS æœåŠ¡
[root@k8s-worker2 ~]# systemctl start nfs
[root@k8s-worker2 ~]# systemctl enable nfs   # è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨
Created symlink from /etc/systemd/system/multi-user.target.wants/nfs-server.service to /usr/lib/systemd/system/nfs-server.service.
```

**æ³¨æ„ï¼š**

1. å¦‚æœä½ çš„ NFS æœåŠ¡å™¨å¼€äº†é˜²ç«å¢™æˆ–ä½¿ç”¨äº†äº‘æœåŠ¡å•†çš„é˜²ç«å¢™ï¼Œéœ€è¦å¼€æ”¾ 2049ã€111ã€635ã€892 ç«¯å£ï¼ˆTCP/UDP åè®®éƒ½éœ€è¦å¼€æ”¾ï¼‰ï¼Œå¦åˆ™ä¼šæ— æ³•è®¿é—® NFS æœåŠ¡å™¨ã€‚
2. é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½è¦å®‰è£… nfs-utils å·¥å…·ï¼Œä»¥ç¡®ä¿æ— è®º Pod è¢«è°ƒåº¦åˆ°å“ªä¸ªèŠ‚ç‚¹ï¼Œéƒ½å¯ä»¥é€šè¿‡ NFS å·¥å…·è¿æ¥åˆ° NFS æœåŠ¡å¹¶æ­£å¸¸ä½¿ç”¨ã€‚

NFS æ­å»ºå®Œæˆåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨ K8s é›†ç¾¤ä¸­é€šè¿‡ YAML æ–‡ä»¶ï¼ˆmy-nfs-deployment.yamlï¼‰æ¥ä½¿ç”¨ NFS å·ã€‚

```yaml
# my-nfs-deployment.yamlÂ 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-nfs-deployment
spec:
  selector:
    matchLabels:
      app: busybox-pod
  replicas: 3
  template:
    metadata:
      labels:
        app: busybox-pod
    spec:
      containers:
      - name: busybox-c
        image: busybox
        command: ["/bin/sh","-c","sleep 3600"]
        volumeMounts:
        - name: nfs-shared-data
          mountPath: /tmp/data
      volumes:
      - name: nfs-shared-data
        nfs:
          server: k8s-worker2   # NFS æœåŠ¡å™¨ IPã€åŸŸåæˆ–è€…ä¸»æœºå
          path: /nfs/k8s/shared   # å…±äº«ç›®å½•
```

åœ¨ YAML æ–‡ä»¶çš„ volumes å±æ€§ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåç§°ä¸º â€œnfs-shared-dataâ€ çš„ NFS å·ï¼Œç„¶åæŠŠ NFS å…±äº«ç›®å½• â€œ/nfs/k8s/sharedâ€ æŒ‚è½½åˆ°å®¹å™¨çš„ â€œ/tmp/dataâ€ ç›®å½•ï¼Œä»è€Œå®ç° Deployment çš„å¤šä¸ª Pod å‰¯æœ¬å…±äº«è¯¥ç›®å½•ã€‚éƒ¨ç½² Deploymentï¼ŒæŸ¥çœ‹éƒ¨ç½²æˆåŠŸåçš„ä¸‰ä¸ª Pod å‰¯æœ¬ã€‚

```bash
[root@k8s-master ~]# kubectl apply -f my-nfs-deployment.yaml
deployment.apps/my-nfs-deployment created
[root@k8s-master ~]# kubectl get pod  # æŸ¥çœ‹ Pod
NAMEÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â READYÂ  Â STATUSÂ  Â  RESTARTSÂ  Â  AGE
my-nfs-deployment-6f594bb4c5-fzt7jÂ  Â 1/1Â  Â  Â RunningÂ  Â 0Â  Â  Â  Â  Â  Â 67s
my-nfs-deployment-6f594bb4c5-q6dr2Â  Â 1/1Â  Â  Â RunningÂ  Â 0Â  Â  Â  Â  Â  Â 67s
my-nfs-deployment-6f594bb4c5-r9smmÂ  Â 1/1Â  Â  Â RunningÂ  Â 0Â  Â  Â  Â  Â  Â 67s
```

æˆ‘ä»¬è¿›å…¥å…¶ä¸­ä¸€ä¸ª Pod çš„å®¹å™¨ä¸­æ“ä½œ â€œ/tmp/dataâ€ ç›®å½•ï¼Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åè¿›å…¥åˆ°å…¶ä»–å®¹å™¨ä¸­æŸ¥çœ‹è¯¥æ–‡ä»¶ï¼Œä»ç»“æœä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸‰ä¸ª Pod çš„å®¹å™¨ç¡®å®éƒ½å¯ä»¥å…±äº«è¯¥ç›®å½•ã€‚

```bash
[root@k8s-master ~]# kubectl exec -it my-nfs-deployment-6f594bb4c5-fzt7j -c busybox-c -- sh
/ # cd /tmp/data/
/tmp/data # echo "Hello NFS!" > aaa.txt  # å†™å…¥æ–‡ä»¶åˆ°NFSç›®å½•
/tmp/data # exit
[root@k8s-master ~]# kubectl exec -it my-nfs-deployment-6f594bb4c5-q6dr2 -c busybox-c -- sh
/ # cd /tmp/data/
/tmp/data # cat aaa.txt  # è¯»å–å…±äº«æ–‡ä»¶
Hello NFS!
```

å³ä½¿åˆ é™¤äº† Deployment å’Œ Podï¼ŒNFS æœåŠ¡ç«¯å…±äº«ç›®å½•ä¸­çš„æ–‡ä»¶ä¾æ—§å­˜åœ¨ï¼Œä¸ä¼šéš Pod åˆ é™¤è€Œæ¶ˆå¤±ã€‚

```bash
[root@k8s-master ~]# kubectl delete -f my-nfs-deployment.yaml
deployment.apps "my-nfs-deployment" deleted
```

æŸ¥çœ‹ k8s-worker2 æœåŠ¡ç«¯ä¸Šçš„å…±äº«ç›®å½•ï¼Œä»ç„¶å¯ä»¥çœ‹åˆ°åœ¨å®¹å™¨ä¸­åˆ›å»ºçš„æ–‡ä»¶ã€‚

```bash
[root@k8s-worker2 ~]# cd /nfs/k8s/shared/
[root@k8s-worker2 shared]# cat aaa.txt
Hello NFS!
```

## PV ä¸ PVC

ä½¿ç”¨ NFS å…±äº«å­˜å‚¨è™½ç„¶æ–¹ä¾¿ï¼Œä½†è‹¥å„åº”ç”¨çš„ Pod æ— é™åˆ¶åœ°è¯»å†™å­˜å‚¨èµ„æºï¼Œé•¿æœŸä¸‹æ¥å¯èƒ½å¯¼è‡´ç£ç›˜ç®¡ç†æ··ä¹±ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒK8s é›†ç¾¤å¼•å…¥äº† PV å’Œ PVC èµ„æºå¯¹è±¡ï¼Œé¿å… Pod ç›´æ¥æŒ‚è½½å„ç§å­˜å‚¨ç©ºé—´ï¼Œä»è€Œå¯¹å­˜å‚¨èµ„æºçš„ç®¡ç†å’Œä½¿ç”¨åšäº†è§£è€¦éš”ç¦»ã€‚

PVï¼ˆPersistentVolumeï¼ŒæŒä¹…å·ï¼‰ä¸»è¦ç”¨äºç®¡ç†å­˜å‚¨èµ„æºï¼ŒPV ä¸­æŒ‡å®šäº†å­˜å‚¨ç±»å‹ã€å­˜å‚¨ç©ºé—´å¤§å°å’Œè¯»å†™æ¨¡å¼ç­‰ä¿¡æ¯ã€‚PV å¯ä»¥ç”±è¿ç»´äººå‘˜é¢„å…ˆåˆ†é…ï¼Œæˆ–è€…é€šè¿‡å­˜å‚¨ç±»ï¼ˆStorage Classï¼‰åŠ¨æ€åˆ†é…ã€‚PV æ”¯æŒçš„å­˜å‚¨èµ„æºç±»å‹ä»¥æ’ä»¶çš„å½¢å¼å®ç°ï¼ŒK8s é»˜è®¤æ”¯æŒ HostPath å·ã€NFS å·ã€LocalÂ å·ï¼ˆèŠ‚ç‚¹ä¸ŠæŒ‚è½½çš„æœ¬åœ°å­˜å‚¨è®¾å¤‡ï¼‰ç­‰ï¼Œä½ ä¹Ÿå¯ä»¥å®‰è£… CSI é©±åŠ¨æ’ä»¶ä»è€Œæ”¯æŒæ›´å¤šçš„å­˜å‚¨èµ„æºç±»å‹ã€‚

PVCï¼ˆPersistentVolumeClaimï¼ŒæŒä¹…å·å£°æ˜ï¼‰è¡¨è¾¾äº† Pod å¯¹å­˜å‚¨èµ„æºçš„éœ€æ±‚ï¼Œä¾‹å¦‚å­˜å‚¨ç©ºé—´å¤§å°ã€è¯»å†™æ¨¡å¼ç­‰ã€‚å½“ Pod éœ€è¦å­˜å‚¨ç©ºé—´æ—¶ï¼Œå°±å¯ä»¥åˆ›å»ºå¹¶æŒ‚è½½ PVCï¼Œæ­¤æ—¶ K8s ä¼šç»™è¿™ä¸ª PVC è‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ PV è¿›è¡Œç»‘å®šã€‚ä¸€æ—¦ç»‘å®šæˆåŠŸï¼ŒPod å°±å¯ä»¥ä½¿ç”¨ PV æŒ‡å®šçš„å­˜å‚¨èµ„æºäº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒPod ä¸èƒ½ç›´æ¥æŒ‚è½½ PVï¼Œè€Œæ˜¯é€šè¿‡ PVC æ¥é—´æ¥ä½¿ç”¨ PV çš„å­˜å‚¨ç©ºé—´ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/07/e1/07280c5f5928392131afbd39f7c75ae1.jpg?wh=902x708)

å¦‚å›¾æ‰€ç¤ºï¼ŒPV + PVC è¿™ç§æ¨¡å¼ç¬¦åˆç ”å‘å’Œè¿ç»´å›¢é˜Ÿçš„ç»„ç»‡æ¶æ„éœ€æ±‚ï¼Œå…¶ä¸­ PV ç”±è¿ç»´äººå‘˜é¢„å…ˆåˆ†é…å¹¶ç®¡ç†ï¼Œè€Œ Pod çš„å®é™…å­˜å‚¨ç©ºé—´æ˜¯é€šè¿‡ PVC æ¥ç”³è¯·ï¼Œæ‰€ä»¥ PVC ç”±ç ”å‘äººå‘˜ç»´æŠ¤ï¼Œä»è€Œç¡®ä¿äº†ä¸¤ä¸ªå›¢é˜Ÿåˆ†å·¥å’ŒèŒè´£çš„æ˜ç¡®æ€§ï¼Œæé«˜äº†å­˜å‚¨èµ„æºç®¡ç†çš„æ•ˆç‡å’Œçµæ´»æ€§ã€‚

## éƒ¨ç½² PV ä¸ PVC

ä¸‹é¢æˆ‘ä»¬åŠ¨æ‰‹å®éªŒä¸€ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ª PV å’Œ PVCï¼Œç„¶ååœ¨ Pod ä¸­æŒ‚è½½ PVC æ¥ä½¿ç”¨å­˜å‚¨ç©ºé—´ã€‚

#### éƒ¨ç½² PV

PV çš„éƒ¨ç½²ä¹Ÿæ˜¯é€šè¿‡ YAML æ–‡ä»¶ï¼ˆmy-pv.yamlï¼‰æ¥å®ç°çš„ã€‚

```yaml
# my-pv.yamlÂ 
apiVersion: v1
kind: PersistentVolume
metadata:
Â  name: my-pv-100m # è‡ªå®šä¹‰PVåå­—
spec:
Â  capacity:
Â  Â  storage: 100M # å®šä¹‰è¿™ä¸ªPVçš„å­˜å‚¨å¤§å°
Â  accessModes:
Â  Â  - ReadWriteMany # è®¿é—®æ¨¡å¼
  persistentVolumeReclaimPolicy: Retain  # é»˜è®¤Retain
Â  nfs:
    server: k8s-worker2 # æŒ‡å®šNFSä¸»æœºçš„IPåœ°å€æˆ–è€…ä¸»æœºå
Â  Â  path: /nfs/k8s/shared # ç»‘å®šä¸»æœºçš„çš„è·¯å¾„
```

- **capacity**ï¼šå®šä¹‰ PV çš„å­˜å‚¨ç©ºé—´çš„å®¹é‡å¤§å°ã€‚
- **accessModesï¼š**è®¾ç½® PV çš„è®¿é—®æ¨¡å¼ï¼ŒæŒ‡å®šåº”ç”¨ä½¿ç”¨ PV æ—¶å¯¹å­˜å‚¨èµ„æºçš„è®¿é—®æƒé™ï¼Œè®¿é—®æƒé™åŒ…æ‹¬ä¸‹é¢å‡ ç§æ–¹å¼ï¼š
  
  - ReadWriteOnceï¼ˆRWOï¼‰ï¼šè¯»å†™æƒé™ï¼Œä½†æ˜¯åªèƒ½è¢«å•ä¸ªèŠ‚ç‚¹æŒ‚è½½ã€‚
  - ReadOnlyManyï¼ˆROXï¼‰ï¼šåªè¯»æƒé™ï¼Œå¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½ã€‚
  - ReadWriteManyï¼ˆRWXï¼‰ï¼šè¯»å†™æƒé™ï¼Œå¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½ã€‚
- **persistentVolumeReclaimPolicy**ï¼šæŒ‡å®š PV å›æ”¶ç­–ç•¥ï¼Œé»˜è®¤ä¸º Retainï¼Œä¸‹ä¸€è¯¾ä¼šå†è¯¦ç»†ä»‹ç» PV çš„å›æ”¶ç­–ç•¥ã€‚

éƒ¨ç½² PVï¼Œç„¶åæŸ¥çœ‹ PV çš„çŠ¶æ€ã€‚

```bash
[root@k8s-master ~]# kubectl apply -f my-pv.yamlÂ 
persistentvolume/my-pv-100m created
[root@k8s-master ~]# kubectl get pv
NAMEÂ  Â  Â  Â  Â CAPACITYÂ  Â ACCESS MODESÂ  Â RECLAIM POLICYÂ  Â STATUSÂ  Â  Â  CLAIMÂ  Â STORAGECLASSÂ  Â REASONÂ  Â AGE
my-pv-100mÂ  Â 100MÂ  Â  Â  Â RWXÂ  Â  Â  Â  Â  Â  RetainÂ  Â  Â  Â  Â  Â AvailableÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 7s
```

åœ¨è¿”å›ç»“æœä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°å·²ç»æˆåŠŸéƒ¨ç½²äº† PVï¼Œå…¶ä¸­ STATUS çŠ¶æ€ä¸º Available ï¼Œè¡¨ç¤ºå¯ä»¥ä½¿ç”¨ã€‚

#### éƒ¨ç½² PVC

ç¼–å†™ä¸€ä¸ª PVC çš„ YAML æ–‡ä»¶ï¼ˆmy-pvc.yamlï¼‰ï¼Œç”³è¯·ä¸€ä¸ª 100M å®¹é‡çš„å¯ä»¥è¢«å¤šä¸ª Pod æŒ‚è½½çš„å­˜å‚¨ç©ºé—´ã€‚

```yaml
# my-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc-100m # è‡ªå®šä¹‰pvcåå­—
spec:
  accessModes:
    - ReadWriteMany  # è®¿é—®æ¨¡å¼
  resources:
    requests:
      storage: 100M # å®šä¹‰è¦ç”³è¯·çš„ç©ºé—´å¤§å°
```

éƒ¨ç½² PVCï¼Œç„¶åæŸ¥çœ‹ PVC çš„çŠ¶æ€ã€‚

```bash
[root@k8s-master ~]# kubectl apply -f my-pvc.yamlÂ 
persistentvolumeclaim/my-pvc-100m created
[root@k8s-master ~]# kubectl get pvc
NAMEÂ  Â  Â  Â  Â  STATUSÂ  Â VOLUMEÂ  Â  Â  Â CAPACITYÂ  Â ACCESS MODESÂ  Â STORAGECLASSÂ  Â AGE
my-pvc-100mÂ  Â BoundÂ  Â  my-pv-100mÂ  Â 100MÂ  Â  Â  Â RWXÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 9s
```

å¯ä»¥çœ‹å‡ºï¼Œéƒ¨ç½² PVC çš„æ—¶å€™ï¼ŒK8s ä¼šè‡ªåŠ¨å¯»æ‰¾å¹¶ç»‘å®šæ»¡è¶³æ¡ä»¶çš„ PVã€‚ç›®å‰ï¼ŒSTATUS çŠ¶æ€æ˜¾ç¤ºä¸º Boundï¼ˆå·²ç»‘å®šï¼‰ï¼ŒVOLUME æ˜¾ç¤ºå·²ç»‘å®šåä¸º â€œmy-pv-100mâ€ çš„ PV å·ï¼Œè¿™ä¸ªå°±æ˜¯ä¸Šé¢éƒ¨ç½²å¥½çš„ PVã€‚æ­¤æ—¶ï¼Œè¿™ä¸ª PVC å°±å¯ä»¥è¢« Pod æŒ‚è½½å¹¶ä½¿ç”¨äº†ã€‚

#### æŒ‚è½½ PVC

æˆ‘ä»¬é€šè¿‡ YAML æ–‡ä»¶ï¼ˆmy-pvc-deployment.yamlï¼‰éƒ¨ç½²ä¸€ä¸ª Deploymentï¼Œå®ƒçš„ Pod ä¸­çš„å®¹å™¨ä¼šæŒ‚è½½å·²ç»éƒ¨ç½²å¥½çš„ PVCã€‚

```yaml
# my-pvc-deployment.yamlÂ 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-pvc-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: pvc-busybox-pod
  template:
    metadata:
      labels:
        app: pvc-busybox-pod
    spec:
      containers:
      - name: busybox-c
        image: busybox
        command: ["/bin/sh","-c","sleep 3600"]
        volumeMounts:
        - name: pvc-shared-data
          mountPath: /tmp/data
      volumes:
        - name: pvc-shared-data
          persistentVolumeClaim:
            claimName: my-pvc-100m  # éƒ¨ç½²å¥½çš„PVC
```

éƒ¨ç½²å¥½ Deployment åï¼Œæˆ‘ä»¬å¯ä»¥è¿›å…¥åˆ°ä»»æ„ Pod çš„å®¹å™¨ï¼Œå°±åƒä¸Šé¢ Pod ç›´æ¥æŒ‚è½½ NFS å·çš„ç¤ºä¾‹ä¸€æ ·ï¼Œé€šè¿‡æ“ä½œ â€œ/tmp/dataâ€ ç›®å½•æ¥ä½¿ç”¨æŒ‚è½½çš„å…±äº«ç©ºé—´ã€‚

```bash
[root@k8s-master ~]# kubectl apply -f my-pvc-deployment.yaml
deployment.apps/my-pvc-deployment created
```

## **å°ç»“**

ä»Šå¤©ï¼Œæˆ‘ä»‹ç»äº† K8s ä¸­çš„æ–‡ä»¶æŒä¹…åŒ–å­˜å‚¨æ–¹å¼ï¼šæŒ‚è½½æ•°æ®å· Volumeã€‚åœ¨ Pod ä¸­å…ˆå®šä¹‰ä»£è¡¨æŸç§å­˜å‚¨ç©ºé—´çš„ Volumeï¼Œç„¶ååœ¨ Pod çš„å®¹å™¨ä¸­ï¼Œé€šè¿‡æŠŠè¿™ä¸ª Volume æŒ‚è½½åˆ°å®¹å™¨çš„æŸä¸ªç›®å½•ï¼Œä»è€Œåœ¨å®¹å™¨ä¸­ä½¿ç”¨è¿™ä¸ªç›®å½•ï¼Œå®ç°äº†æŒä¹…åŒ–å­˜å‚¨ã€‚

æ•°æ®å·ä¸»è¦æœ‰èŠ‚ç‚¹æœ¬åœ°å­˜å‚¨ã€ç½‘ç»œå…±äº«å­˜å‚¨ã€ConfigMap å’Œ Secret èµ„æºå¯¹è±¡ï¼Œä»¥åŠ PV å’Œ PVCã€‚æ¥ç€æˆ‘å¸¦ä½ æ­å»ºäº†ä¸€ä¸ª NFS ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿå¹¶åˆ›å»ºäº†å…±äº«ç›®å½•ï¼Œç„¶åéƒ¨ç½²äº†å¤šä¸ª Pod å‰¯æœ¬çš„ Deploymentï¼Œè¿™äº› Pod é€šè¿‡æŒ‚è½½ NFS çš„å…±äº«ç›®å½•å®ç°äº†æ–‡ä»¶çš„å…±äº«å’ŒæŒä¹…åŒ–å­˜å‚¨ã€‚

ä¹‹åï¼Œæˆ‘ä»¬è¯¦ç»†è®¤è¯†äº† PV å’Œ PVC ä¸¤ç§èµ„æºå¯¹è±¡ã€‚PVï¼ˆPersistentVolumeï¼ŒæŒä¹…å·ï¼‰æ˜¯é¢„å…ˆé…ç½®çš„å­˜å‚¨èµ„æºï¼ŒPVCï¼ˆPersistentVolumeClaimï¼ŒæŒä¹…å·å£°æ˜ï¼‰æ˜¯åº”ç”¨å¯¹å­˜å‚¨èµ„æºçš„éœ€æ±‚ï¼Œå½“ Pod éœ€è¦å­˜å‚¨ç©ºé—´æ—¶ï¼Œå°±å¯ä»¥åˆ›å»ºå¹¶åŠ è½½ PVCï¼Œæ­¤æ—¶ K8s ä¼šç»™è¿™ä¸ª PVC è‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ PV è¿›è¡Œç»‘å®šã€‚ä¸€æ—¦ç»‘å®šæˆåŠŸï¼ŒPod å°±å¯ä»¥ä½¿ç”¨ PV æä¾›çš„å­˜å‚¨èµ„æºäº†ã€‚

æœ€åé€šè¿‡ä¸€ä¸ªå®éªŒï¼Œæˆ‘å¸¦ä½ äº†è§£äº† PV å’Œ PVC çš„ YAML æ–‡ä»¶åŠä½¿ç”¨æ–¹å¼ã€‚

## æ€è€ƒé¢˜

è¿™å°±æ˜¯ä»Šå¤©çš„å…¨éƒ¨å†…å®¹ï¼Œåœ¨ CKA ä¸­ä¹Ÿä¼šè€ƒåˆ°ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚æˆ‘ç»™ä½ ç•™ä¸€é“ç»ƒä¹ é¢˜ã€‚

- åˆ›å»ºä¸€ä¸ª hostPath ç±»å‹çš„ PVï¼Œå­˜å‚¨ç©ºé—´ 10Mï¼Œè¯»å†™æ¨¡å¼ä¸º ReadWriteManyï¼Œå®¿ä¸»æœºç›®å½•ä¸º â€œ/host/dataâ€ã€‚
- åˆ›å»ºä¸€ä¸ª Pod å¹¶æŒ‚è½½ä¸€ä¸ª PVCï¼ŒPVC çš„å­˜å‚¨ç©ºé—´è¦æ±‚ 20Mï¼Œè¯»å†™æ¨¡å¼ä¸º ReadWriteManyï¼ŒPod å®¹å™¨æŒ‚è½½ç›®å½•ä¸º â€œ/tmpâ€ã€‚

åŠ¨æ‰‹å®è·µä¸€ä¸‹ï¼Œçœ‹çœ‹ Pod æ˜¯å¦å¯ä»¥æˆåŠŸä½¿ç”¨ PV çš„å­˜å‚¨ç©ºé—´ï¼Œå¦‚æœä¸è¡Œï¼Œéœ€è¦æ€æ ·ä¿®æ”¹æ‰èƒ½æˆåŠŸï¼Ÿç›¸ä¿¡ç»è¿‡åŠ¨æ‰‹å®è·µï¼Œä¼šè®©ä½ å¯¹çŸ¥è¯†çš„ç†è§£æ›´åŠ æ·±åˆ»ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ4ï¼‰</strong></div><ul>
<li><span>Y</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç¬¬ä¸€é¢˜ï¼š
# my-pv-hostpath.yaml 
apiVersion: v1
kind: PersistentVolume
metadata:
  name: my-pv-hostpath-10m # è‡ªå®šä¹‰PVåå­—
spec:
  capacity:
    storage: 10M # å®šä¹‰è¿™ä¸ªPVçš„å­˜å‚¨å¤§å°
  accessModes:
    - ReadWriteMany # è®¿é—®æ¨¡å¼
  persistentVolumeReclaimPolicy: Retain  # é»˜è®¤Retain
  hostPath:
    path: &#47;host&#47;data 

ç¬¬äºŒé¢˜ï¼š

# my-pv.yaml 
apiVersion: v1
kind: PersistentVolume
metadata:
  name: my-pv-20m # è‡ªå®šä¹‰PVåå­—
spec:
  capacity:
    storage: 20M # å®šä¹‰è¿™ä¸ªPVçš„å­˜å‚¨å¤§å°
  accessModes:
    - ReadWriteMany # è®¿é—®æ¨¡å¼
  persistentVolumeReclaimPolicy: Retain  # é»˜è®¤Retain
  nfs:
    server: k8s-worker2 # æŒ‡å®šNFSä¸»æœºçš„IPåœ°å€æˆ–è€…ä¸»æœºå
    path: &#47;nfs&#47;k8s&#47;shared # ç»‘å®šä¸»æœºçš„çš„è·¯å¾„

# my-pvc-20m.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc-20m # è‡ªå®šä¹‰pvcåå­—
spec:
  accessModes:
    - ReadWriteMany  # è®¿é—®æ¨¡å¼
  resources:
    requests:
      storage: 20M # å®šä¹‰è¦ç”³è¯·çš„ç©ºé—´å¤§å°

# my-pvc-deployment.yaml 
apiVersion: apps&#47;v1
kind: Deployment
metadata:
  name: my-pvc-deployment-20m
spec:
  replicas: 3
  selector:
    matchLabels:
      app: pvc-busybox-pod
  template:
    metadata:
      labels:
        app: pvc-busybox-pod
    spec:
      containers:
      - name: busybox-c
        image: swr.cn-north-4.myhuaweicloud.com&#47;ddn-k8s&#47;docker.io&#47;library&#47;busybox:1.28
        command: [&quot;&#47;bin&#47;sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;]
        volumeMounts:
        - name: pvc-shared-data
          mountPath: &#47;tmp&#47;data
      volumes:
        - name: pvc-shared-data
          persistentVolumeClaim:
            claimName: my-pvc-20m  # éƒ¨ç½²å¥½çš„PVC</p>2024-08-07</li><br/><li><span>å¥”è·‘çš„é˜¿é£</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ¯”è‘«èŠ¦ç”»ç“¢ã€‚
ç¬¬ä¸€é¢˜
# my-pv-10m.yaml 
apiVersion: v1
kind: hostPath
metadata:
  name: my-pv-10m 
spec:
  capacity:
    storage: 10M 
  accessModes:
    - ReadWriteMany 
  persistentVolumeReclaimPolicy: Retain  # é»˜è®¤Retain
volumes:  
- name: host-path-volume    
	hostPath:      
	path: &#47;host&#47;data      
	type: Directory 
	  
ç¬¬äºŒé¢˜	  
# my-pvc-20m.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc-20m # è‡ªå®šä¹‰pvcåå­—
spec:
  accessModes:
    - ReadWriteMany  # è®¿é—®æ¨¡å¼
  resources:
    requests:
      storage: 20M # å®šä¹‰è¦ç”³è¯·çš„ç©ºé—´å¤§å°



# my-pvc-deployment-20m.yaml 
apiVersion: apps&#47;v1
kind: Deployment
metadata:
  name: my-pvc-deployment-20m
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pvc-busybox-pod
  template:
    metadata:
      labels:
        app: pvc-busybox-pod
    spec:
      containers:
      - name: busybox-c
        image: busybox
        command: [&quot;&#47;bin&#47;sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;]
        volumeMounts:
        - name: pvc-shared-data
          mountPath: &#47;tmp
      volumes:
        - name: pvc-shared-data
          persistentVolumeClaim:
            claimName: my-pvc-20m  # éƒ¨ç½²å¥½çš„PVC</p>2024-07-22</li><br/><li><span>æ‘©ç¾¯</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p> ReadWriteOnceï¼ˆRWOï¼‰ï¼šè¯»å†™æƒé™ï¼Œä½†æ˜¯åªèƒ½è¢«å•ä¸ªèŠ‚ç‚¹æŒ‚è½½
PVC  å’Œ  PV  éƒ½æœ‰è¿™ä¸ªå±æ€§ã€‚è¿™é‡Œçš„èŠ‚ç‚¹æŒ‡çš„æ˜¯ k8s çš„èŠ‚ç‚¹å—ï¼ŸåŒä¸€ä¸ªèŠ‚ç‚¹çš„å¤šä¸ªä¸åŒpodå¯ä»¥è¯»å†™åŒä¸€ä¸ªpvï¼Ÿè¿™ç§æƒ…å†µä¸‹ï¼Œè¿˜æ˜¯å®¹æ˜“å‡ºç° nfs ç›¸åŒçš„é—®é¢˜å§ï¼Ÿ</p>2024-12-25</li><br/><li><span>æ‘©ç¾¯</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ReadWriteOnceï¼ˆRWOï¼‰ï¼šè¯»å†™æƒé™ï¼Œä½†æ˜¯åªèƒ½è¢«å•ä¸ªèŠ‚ç‚¹æŒ‚è½½</p>2024-12-25</li><br/>
</ul>