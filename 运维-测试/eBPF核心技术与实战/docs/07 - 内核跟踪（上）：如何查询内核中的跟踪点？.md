ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚

åœ¨ä¸Šä¸€ä¸ªæ¨¡å—â€œåŸºç¡€å…¥é—¨ç¯‡â€ä¸­ï¼Œæˆ‘å¸¦ä½ æ­å»ºäº† eBPF çš„å¼€å‘ç¯å¢ƒï¼Œå¹¶è¯¦ç»†ä»‹ç»äº† eBPF ç¨‹åºçš„å·¥ä½œåŸç†ã€ç¼–ç¨‹æ¥å£ä»¥åŠäº‹ä»¶è§¦å‘æœºåˆ¶ã€‚å­¦ä¹ å®Œè¿™äº›å†…å®¹ï¼Œæˆ‘æƒ³ä½ å·²ç»æŒæ¡äº† eBPF å¿…å¤‡çš„åŸºç¡€çŸ¥è¯†ï¼Œå¹¶é€šè¿‡ç®€å•çš„ç¤ºä¾‹ï¼Œåˆæ­¥ä½“éªŒäº† eBPF ç¨‹åºçš„å¼€å‘å’Œæ‰§è¡Œè¿‡ç¨‹ã€‚

æˆ‘åœ¨å‰é¢çš„å†…å®¹ä¸­åå¤å¼ºè°ƒè¿‡ï¼Œå­¦ä¹ ä¸€é—¨æ–°æŠ€æœ¯ï¼Œæœ€å¿«çš„æ–¹æ³•å°±æ˜¯åœ¨ç†è§£åŸç†çš„åŒæ—¶é…åˆå¤§é‡çš„å®è·µï¼ŒeBPF ä¹Ÿä¸ä¾‹å¤–ã€‚æ‰€ä»¥ï¼Œä»è¿™ä¸€è®²èµ·æˆ‘ä»¬å¼€å§‹â€œå®æˆ˜è¿›é˜¶ç¯‡â€çš„å­¦ä¹ ï¼Œä¸€èµ·è¿›å…¥ eBPF çš„å®è·µç¯èŠ‚ï¼Œé€šè¿‡çœŸå®çš„åº”ç”¨æ¡ˆä¾‹æŠŠ eBPF æŠ€æœ¯ç”¨èµ·æ¥ã€‚

ä»Šå¤©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ï¼Œæ€æ ·ä½¿ç”¨ eBPF å»è·Ÿè¸ªå†…æ ¸çš„çŠ¶æ€ï¼Œç‰¹åˆ«æ˜¯æœ€ç®€å•çš„ bpftrace çš„ä½¿ç”¨æ–¹æ³•ã€‚åœ¨ä¸‹ä¸€è®²ä¸­ï¼Œæˆ‘è¿˜å°†ä»‹ç»ä¸¤ç§ eBPF ç¨‹åºçš„è¿›é˜¶ç¼–ç¨‹æ–¹æ³•ã€‚

ä¸Šä¸€è®²æˆ‘æåˆ°è¿‡ï¼Œè·Ÿè¸ªç±» eBPF ç¨‹åºä¸»è¦åŒ…å«å†…æ ¸æ’æ¡©ï¼ˆ`BPF_PROG_TYPE_KPROBE`ï¼‰ã€è·Ÿè¸ªç‚¹ï¼ˆ`BPF_PROG_TYPE_TRACEPOINT`ï¼‰ä»¥åŠæ€§èƒ½äº‹ä»¶ï¼ˆ`BPF_PROG_TYPE_PERF_EVENT`ï¼‰ç­‰ç¨‹åºç±»å‹ï¼Œè€Œæ¯ç±» eBPF ç¨‹åºç±»å‹åˆå¯ä»¥æŒ‚è½½åˆ°ä¸åŒçš„å†…æ ¸å‡½æ•°ã€å†…æ ¸è·Ÿè¸ªç‚¹æˆ–æ€§èƒ½äº‹ä»¶ä¸Šã€‚å½“è¿™äº›å†…æ ¸å‡½æ•°ã€å†…æ ¸è·Ÿè¸ªç‚¹æˆ–æ€§èƒ½äº‹ä»¶è¢«è°ƒç”¨çš„æ—¶å€™ï¼ŒæŒ‚è½½åˆ°å…¶ä¸Šçš„ eBPF ç¨‹åºå°±ä¼šè‡ªåŠ¨æ‰§è¡Œã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ13ï¼‰</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg" width="30px"><span>è«å</span> ğŸ‘ï¼ˆ37ï¼‰ ğŸ’¬ï¼ˆ5ï¼‰<div>1ã€é¦–å…ˆç»™å€ªè€å¸ˆæä¸ªé—®é¢˜ã€‚ã€ä»¥ v5.13.0 ä¸ºä¾‹ï¼Œæ€»çš„å†…æ ¸å‡½æ•°æ•°é‡å·²ç»è¶…è¿‡äº† 16 ä¸‡ã€‘è§‰å¾—è¿™ä¸€è¡¨è¿°ä¸å¤ªå‡†ç¡®ï¼Œå†…æ ¸ç¬¦å·è¡¨ &#47;proc&#47;kallsyms ä¸ä»…åŒ…å«äº†å†…æ ¸å‡½æ•°(staticã€é static)ï¼Œè¿˜åŒ…å«äº†éæ ˆæ•°æ®å˜é‡ã€‚&#47;proc&#47;kallsyms è¾“å‡ºçš„ç¬¬äºŒåˆ—è¡¨ç¤ºç¬¦å·ç±»å‹ï¼ŒåŒ…æ‹¬ Aã€bã€Dã€tã€T ç­‰ï¼Œå…¶ä¸­ T(t) è¡¨ç¤ºä»£ç æ®µç¬¦å·è¡¨ï¼Œå¤§æ¦‚æœ‰ 7w+ å†…æ ¸å‡½æ•°ï¼ˆå…¶å®è¿˜æœ‰æå°‘æ•°å¹¶éçœŸæ­£çš„å†…æ ¸å‡½æ•°ï¼‰ã€‚ è¿™ 7w+ å†…æ ¸å‡½æ•°ä¸­ï¼Œåªæœ‰è¢«æ˜¾å¼å¯¼å‡ºçš„å†…æ ¸å‡½æ•°ï¼ˆ5w+ï¼‰æ‰èƒ½è¢« BPF kprobe ç±»å‹ç¨‹åºåŠ¨æ€è¿½è¸ªã€‚

ä»¥ 5.13 å†…æ ¸ç‰ˆæœ¬ä¸ºä¾‹ï¼Œå¯é€šè¿‡ tracefs æˆ– bpftrace ç»Ÿè®¡ï¼Œå…± 52259 ä¸ªå†…æ ¸å‡½æ•°å¯ä»¥è¢« BPF åˆ©ç”¨ kprobe æŠ€æœ¯åŠ¨æ€è¿½è¸ªï¼š

# cat &#47;sys&#47;kernel&#47;debug&#47;tracing&#47;available_filter_functions | wc -l
52259

# bpftrace -l &#39;kprobe:*&#39; | wc -l
52259

2ã€è¯¾åæ€è€ƒé¢˜ï¼Œå€Ÿç”¨ bpftrace å†…ç½®å‡½æ•° time() è¾“å‡ºæ—¶é—´ &amp; å†…ç½®å˜é‡ curtask è·å–çˆ¶è¿›ç¨‹ pidï¼ˆ$task-&gt;parent-&gt;tgidï¼‰ï¼Œå†™æˆå•è¡Œç¨‹åºçœ‹èµ·æ¥ä¸å¤ªç›´è§‚ï¼Œæ•´ç†ä¸ºä»¥ä¸‹è„šæœ¬ execsnoop.btã€‚

---------------- execsnoop.bt -----------------

#!&#47;usr&#47;bin&#47;bpftrace

#include &lt;linux&#47;sched.h&gt;

BEGIN
{
    printf(&quot;%-9s %-6s %-6s %-16s %s\n&quot;, &quot;TIME&quot;, &quot;PID&quot;, &quot;PPID&quot;, &quot;COMM&quot;, &quot;ARGS&quot;)
}

tracepoint:syscalls:sys_enter_execve,
tracepoint:syscalls:sys_enter_execveat
{
    $task = (struct task_struct *)curtask;

    time(&quot;%H:%M:%S  &quot;);
    printf(&quot;%-6d %-6d %-16s&quot;, pid, $task-&gt;parent-&gt;tgid, comm);
    join(args-&gt;argv);
}</div>2022-01-31</li><br/><li><img src="" width="30px"><span>Geek_508898</span> ğŸ‘ï¼ˆ7ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>bpftrace --include linux&#47;sched.h -e &#39;tracepoint:syscalls:sys_enter_execve,tracepoint:syscalls:sys_enter_execveat { time(&quot;%H:%M:%S &quot;);printf(&quot;%-6d %-6d %-8s &quot;, pid,curtask-&gt;parent-&gt;pid, comm); join(args-&gt;argv)}&#39;</div>2022-02-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/c5/f8/97d4508e.jpg" width="30px"><span>Tok1c</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>Ubuntu 22.04
ERROR: Could not resolve symbol: &#47;proc&#47;self&#47;exe:BEGIN_trigger

è§£å†³æ–¹æ¡ˆï¼š

https:&#47;&#47;github.com&#47;iovisor&#47;bpftrace&#47;issues&#47;2168

echo &quot;deb http:&#47;&#47;ddebs.ubuntu.com $(lsb_release -cs) main restricted universe multiverse
deb http:&#47;&#47;ddebs.ubuntu.com $(lsb_release -cs)-updates main restricted universe multiverse
deb http:&#47;&#47;ddebs.ubuntu.com $(lsb_release -cs)-proposed main restricted universe multiverse&quot; | \
sudo tee -a &#47;etc&#47;apt&#47;sources.list.d&#47;ddebs.list
sudo apt install ubuntu-dbgsym-keyring
sudo apt update
sudo apt install bpftrace-dbgsym

</div>2022-10-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ee/fa/37da6393.jpg" width="30px"><span>muggle</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æ‰§è¡Œ  bpftrace -l &#39;*execve*&#39;
stdin:1:1-8: ERROR: No probe type matched for *execve
*execve*
~~~~~~~
é‡åˆ°è¿™ä¸ªçš„å¯ä»¥å‡çº§ä¸‹bpftraceç‰ˆæœ¬ï¼Œ0.13.0+  
https:&#47;&#47;github.com&#47;iovisor&#47;bpftrace&#47;pull&#47;1775

</div>2022-03-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/d0/d0/a6c6069d.jpg" width="30px"><span>åš</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œæˆ‘çš„ç³»ç»Ÿæ˜¯Ubuntu21.10ï¼Œæˆ‘åœ¨æ‰§è¡Œsudo bpftrace -l &#39;*execve*&#39;çš„æ—¶å€™ï¼Œå‘ç°é™¤äº†å†…æ ¸æ’æ¡©ï¼ˆkprobeï¼‰å’Œè·Ÿè¸ªç‚¹ï¼ˆtracepointï¼‰è¿™ä¸¤ç±»ï¼Œè¿˜æœ‰ä¸€ç±»kfuncï¼Œæˆ‘ç™¾åº¦äº†ä¸€ä¸‹ï¼Œè¿˜æ˜¯ä¸å¤ªäº†è§£è¿™ä¸ªä¸œè¥¿ï¼Œè€å¸ˆå¯ä»¥ç®€å•è¯´è¯´å—ï¼Ÿ</div>2022-02-23</li><br/><li><img src="" width="30px"><span>Geek_b914ab</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>$ sudo bpftrace -e &#39;tracepoint:syscalls:sys_enter_execve { printf(&quot;%ld %s  &quot;, nsecs, comm); join(args-&gt;argv);}&#39;
Attaching 1 probe...
349663019454998 core::system::S  &#47;usr&#47;bin&#47;cat &#47;proc&#47;cpuinfo
349663023173472 core::system::S  &#47;usr&#47;bin&#47;lscpu
349665017216698 core::system::S  &#47;usr&#47;bin&#47;cat &#47;proc&#47;cpuinfo
349665040019654 core::system::S  &#47;usr&#47;bin&#47;lscpu
349667017603472 core::system::S  &#47;usr&#47;bin&#47;cat &#47;proc&#47;cpuinfo
349667040035265 core::system::S  &#47;usr&#47;bin&#47;lscpu
349669017626924 core::system::S  &#47;usr&#47;bin&#47;cat &#47;proc&#47;cpuinfo
349669039803679 core::system::S  &#47;usr&#47;bin&#47;lscpu
349671018720543 core::system::S  &#47;usr&#47;bin&#47;cat &#47;proc&#47;cpuinfo
349671039711997 core::system::S  &#47;usr&#47;bin&#47;lscpu
349673018112968 core::system::S  &#47;usr&#47;bin&#47;cat &#47;proc&#47;cpuinfo
349673039088168 core::system::S  &#47;usr&#47;bin&#47;lscpu
349675016659748 core::system::S  &#47;usr&#47;bin&#47;cat &#47;proc&#47;cpuinfo
349675039289844 core::system::S  &#47;usr&#47;bin&#47;lscpu
349677018311393 core::system::S  &#47;usr&#47;bin&#47;cat &#47;proc&#47;cpuinfo

å‘ç°æ¯éš”2Så°±æœ‰ä¸€ä¸ªcore::system::Sçš„è¿›ç¨‹ä¸æ–­ä½¿ç”¨lscpuå¹¶è¯»å–çš„å†…å®¹&#47;proc&#47;cpuinfoï¼Œè¿™ä¸ªcore::system::Sæ˜¯ä¸ªå•¥å‘¢ï¼Ÿ</div>2022-03-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/3e/87/ff97c31e.jpg" width="30px"><span>Li. Mr</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>è¯·é—®å€ªè€å¸ˆï¼Œebpfèƒ½å¯¹è¿›ç¨‹çš„I&#47;Oè¡Œä¸ºåšæ¯”è¾ƒç»†è‡´ç´§å¯†çš„ç›‘æ§æ¢æµ‹ä¹ˆï¼Ÿ</div>2022-02-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/d0/d0/a6c6069d.jpg" width="30px"><span>åš</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆå¥½ï¼Œæˆ‘æœ‰ä¸ªç–‘é—®ï¼ŒeBPFå’Œftraceræœ‰ä»€ä¹ˆå…³ç³»å—ï¼Ÿæˆ‘çœ‹ä¸¤ä¸ªéƒ½æ˜¯åœ¨debugfsä¸‹çš„tracingè¿™ä¸ªç›®å½•æ“ä½œçš„</div>2022-02-17</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eq30mvo0eATZ3Yfm5POktwic3NJSRkiagtJt1vaxyvCS22PJRm8xrulXqaLJRWQWb6zNI4zL0G2QkCA/132" width="30px"><span>heyhd9475</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è¯·é—®è€å¸ˆï¼Œbpftraceæ— æ³•æ”¯æŒforå¾ªç¯å’Œæ•°ç»„ä¸´æ—¶å˜é‡å—</div>2022-02-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/53/db/858337e3.jpg" width="30px"><span>Ethan Liu</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ä½¿ç”¨bpftraceèƒ½æŸ¥è¯¢æ€§èƒ½äº‹ä»¶å—ï¼Ÿ</div>2022-02-08</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/2UXuSevhia94o9Eky4OfMuSictaldxcqpjGuvRCOcvjIIoVBAENLEZbv2lgwmwC8icK1ZrUcneNtiaeFBV8MT3uzNg/132" width="30px"><span>Gavin</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>1. å…‹éš†è€å¸ˆä»“åº“åæ‰§è¡Œ sudo python3 execsnoop_v2.py
2. å¦å¤–å¼€ç»ˆç«¯æ‰§è¡Œlsæ²¡æœ‰ç»“æœè¾“å‡º
3. å†…æ ¸ç‰ˆæœ¬ Linux version 5.18.0-kali5-arm64
4.   
â”€$ sudo bpftrace -l &quot;*execve*&quot; 
hardware:*execve*:
kfunc:vmlinux:__arm64_compat_sys_execve
kfunc:vmlinux:__arm64_compat_sys_execveat
kfunc:vmlinux:__arm64_sys_execve
kfunc:vmlinux:__arm64_sys_execveat
kfunc:vmlinux:audit_log_execve_info
kfunc:vmlinux:bprm_execve
kfunc:vmlinux:kernel_execve
kprobe:__arm64_compat_sys_execve
kprobe:__arm64_compat_sys_execveat
kprobe:__arm64_sys_execve
kprobe:__arm64_sys_execveat
kprobe:audit_log_execve_info
kprobe:bprm_execve
kprobe:do_execveat_common.isra.0
kprobe:kernel_execve
software:*execve*:
tracepoint:syscalls:sys_enter_execve
tracepoint:syscalls:sys_enter_execveat
tracepoint:syscalls:sys_exit_execve
tracepoint:syscalls:sys_exit_execveat
</div>2023-06-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/cd/db/7467ad23.jpg" width="30px"><span>Bachue Zhou</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>çœ‹æ–‡æ¡£ï¼Œjoin å‡½æ•°å®è´¨ä¸ŠæŒ‡çš„å¹¶ä¸æ˜¯å°†æ•°ç»„è¿æ¥èµ·æ¥ï¼Œè€Œæ˜¯æ‰“å°æ•°ç»„ã€‚è¿™ä¸ªå‡½æ•°åå¾ˆå®¹æ˜“è®©äººè¯¯è§£å•Šï¼Œæ„Ÿè§‰æ˜¯è®¾è®¡å¤±è¯¯ï¼Œæ‰“å°æ•°ç»„å®Œå…¨å¯ä»¥äº¤ç»™ printf è¿›è¡Œï¼Œæ²¡å¿…è¦ç”¨ join è¿™ç§å®¹æ˜“è®©äººè¯¯è§£çš„åå­—ã€‚</div>2023-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/ad/42/f21ae349.jpg" width="30px"><span>17</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>é—®é¢˜æè¿°ï¼š
ä½¿ç”¨bpftrace -lå‘½ä»¤ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š
Could not read symbols from &#47;sys&#47;kernel&#47;debug&#47;tracing&#47;available_filter_functions: Permission denied

å·²ç»å°è¯•ä½¿ç”¨å‘½ä»¤ä½†ä»æ— æ³•è§£å†³
mount -t debugfs none &#47;sys&#47;kernel&#47;debug
chmod 700 &#47;sys&#47;kernel&#47;debug&#47;tracing

ç¯å¢ƒä¿¡æ¯
Ubuntu 22.04 å†…æ ¸ç‰ˆæœ¬5.19.0
bpftrace&#47;jammy,now 0.14.0-1 amd64

éº»çƒ¦è€å¸ˆå¸®çœ‹ä¸€ä¸‹ï¼Œè¿™æ˜¯ä»€ä¹ˆé”™è¯¯ï¼Œè¯¥å¦‚ä½•è§£å†³</div>2023-03-17</li><br/>
</ul>