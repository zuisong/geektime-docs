ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚

ä¸Šä¸€è®²ï¼Œæˆ‘å¸¦ä½ ä½¿ç”¨ sockops å’Œ sk\_msg ç­‰å¥—æ¥å­— eBPF ç¨‹åºï¼Œåœ¨å†…æ ¸æ€å¯¹å¥—æ¥å­—è¿›è¡Œè½¬å‘ï¼Œæå‡äº†è´Ÿè½½å‡è¡¡çš„æ€§èƒ½ã€‚

å¯¹äºç½‘ç»œä¼˜åŒ–æ¥è¯´ï¼Œé™¤äº†å¥—æ¥å­— eBPF ç¨‹åºï¼ŒXDP ç¨‹åºå’Œ TC ç¨‹åºä¹Ÿå¯ä»¥ç”¨æ¥ä¼˜åŒ–ç½‘ç»œçš„æ€§èƒ½ã€‚ç‰¹åˆ«æ˜¯ XDP ç¨‹åºï¼Œç”±äºå®ƒåœ¨ Linux å†…æ ¸åè®®æ ˆä¹‹å‰å°±å¯ä»¥å¤„ç†ç½‘ç»œåŒ…ï¼Œåœ¨è´Ÿè½½å‡è¡¡ã€é˜²ç«å¢™ç­‰éœ€è¦é«˜æ€§èƒ½ç½‘ç»œçš„åœºæ™¯ä¸­å·²ç»å¾—åˆ°å¤§é‡çš„åº”ç”¨ã€‚

XDP ç¨‹åºåœ¨å†…æ ¸åè®®æ ˆåˆå§‹åŒ–ä¹‹å‰è¿è¡Œï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€åœ¨ XDP ç¨‹åºä¸­ï¼Œä½ å¹¶ä¸èƒ½åƒåœ¨ sockops ç­‰ç¨‹åºä¸­é‚£æ ·ç›´æ¥è·å¾—å¥—æ¥å­—çš„è¯¦ç»†ä¿¡æ¯ã€‚ä½¿ç”¨ XDP ç¨‹åºåŠ é€Ÿè´Ÿè½½å‡è¡¡ï¼Œé€šå¸¸ä¹Ÿå°±æ„å‘³ç€éœ€è¦ä»å¤´å¼€å‘ä¸€ä¸ªè´Ÿè½½å‡è¡¡ç¨‹åºã€‚è¿™æ˜¯ä¸æ˜¯è¯´ XDP çš„ä½¿ç”¨å°±ç‰¹åˆ«å¤æ‚ï¼Œéœ€è¦é‡æ–°å®ç°å†…æ ¸åè®®æ ˆçš„å¾ˆå¤šé€»è¾‘å‘¢ï¼Ÿä¸è¦æ‹…å¿ƒï¼Œ**XDP å¤„ç†è¿‡çš„æ•°æ®åŒ…è¿˜å¯ä»¥æ­£å¸¸é€šè¿‡å†…æ ¸åè®®æ ˆç»§ç»­å¤„ç†ï¼Œæ‰€ä»¥ä½ åªéœ€è¦åœ¨ XDP ç¨‹åºä¸­å®ç°æœ€æ ¸å¿ƒçš„ç½‘ç»œé€»è¾‘å°±å¯ä»¥äº†**ã€‚

ä»Šå¤©ï¼Œæˆ‘å°±ä»¥ XDP ç¨‹åºä¸ºä¾‹ï¼Œå¸¦ä½ ç»§ç»­ä¼˜åŒ–å’Œå®Œå–„è´Ÿè½½å‡è¡¡å™¨çš„æ€§èƒ½ã€‚

## æ¡ˆä¾‹å‡†å¤‡

è·Ÿä¸Šä¸€è®²ç±»ä¼¼ï¼Œä¸ºäº†æ–¹ä¾¿ç¯å¢ƒçš„é‡ç°ï¼Œè´Ÿè½½å‡è¡¡å™¨ã€Web æœåŠ¡å™¨ä»¥åŠå®¢æˆ·ç«¯éƒ½è¿˜æ˜¯è¿è¡Œåœ¨å®¹å™¨ä¸­ï¼Œå®ƒä»¬çš„ IP å’Œ MAC ç­‰åŸºæœ¬ä¿¡æ¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/e9/15/e923026f577f7b991be2610734f9e415.jpg?wh=1920x1706)  
æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¯åŠ¨è¿™å‡ ä¸ªå®¹å™¨ï¼š

```bash
# Webserver
docker run -itd --name=http1 --hostname=http1 feisky/webserver
docker run -itd --name=http2 --hostname=http2 feisky/webserver

# Client
docker run -itd --name=client alpine

# LB
docker run -itd --name=lb --privileged -v /sys/kernel/debug:/sys/kernel/debug alpine
```
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ14ï¼‰</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg" width="30px"><span>è«å</span> ğŸ‘ï¼ˆ15ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>1. æŒ‚åœ¨å®¿ä¸»æœºçš„ eth0 ç½‘å¡ï¼Œä¼šå¯¼è‡´å®¿ä¸»æœºç½‘ç»œå—å½±å“ï¼Œæœ€ç›´æ¥çš„å½±å“æ˜¯æ¥è‡ªå¤–éƒ¨çš„ ssh è¿æ¥å¼‚å¸¸ï¼Œä¹‹åå†æ‰§è¡Œ ssh ä¹Ÿç™»ä¸è¿›å®¿ä¸»æœºã€‚ï¼ˆåŸå› æ˜¯æº IP ä¸æ˜¯ CLIENT_IP æ—¶å°†ç›®çš„ IP ç›´æ¥ä¿®æ”¹ä¸º CLIENT_IPï¼Œæº IP æ— è®ºå¦‚ä½•å‡ä¿®æ”¹ä¸º LOADBALANCER_IPï¼Œè¿›æ¥çš„æ•°æ®åŒ…æ— æ³•æ­£å¸¸è¢«æ¥æ”¶ä¸å“åº”ï¼‰

2. ç›®å‰çš„å®ç°æœ‰äº› hardcodeï¼Œä¸åˆ©äºæ‰©å±•ï¼Œè´Ÿè½½å‡è¡¡å™¨é€šå¸¸è¿è¡Œé…ç½®å¤šä¸ª vipï¼Œæ¯ä¸ª vip å¯¹åº”è‹¥å¹²çœŸæ­£çš„åç«¯æœåŠ¡ã€‚è§‰å¾—æ”¹è¿›æªæ–½å¯ä»¥ç”¨ BPF map ç±»å‹å­˜å‚¨ï¼Œæœ€å¥½æœ‰ä¸ªæ–‡æœ¬æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œç¨‹åºåŠ è½½å‰è§£æè¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå¡«å…… BPF mapã€‚xdp ç¨‹åºä¸­æ ¹æ® keyï¼ˆæ¯”å¦‚ vip æˆ–è€… UUIDï¼‰æŸ¥æ‰¾çœŸæ­£çš„åç«¯æœåŠ¡ï¼Œå¦‚æœèƒ½å¤Ÿæ‰¾åˆ°åˆ™ä»ä¸­è¯»å– IPã€Mac ç­‰ä¿¡æ¯ã€‚</div>2022-02-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f6/2f/d3f1dae6.jpg" width="30px"><span>L33K</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>å¦‚æœä¸€ä¸ªä¸Šå±‚çš„å¤§åŒ…è¢«æ‹†æˆä¸€ä¸ªå¤šä¸ªåŒ…å‘è¿‡æ¥ï¼Œç›®å‰è¿™ç§è´Ÿè½½å‡è¡¡æ–¹å¼æ˜¯ä¸æ˜¯å¯èƒ½å°±æœ‰é—®é¢˜äº†ï¼Ÿ</div>2022-02-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/30/6c/de/693fce23.jpg" width="30px"><span>Aiolos</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>åŸç”Ÿnginxå’Œsock_ops+sk_msgä¼˜åŒ–å‡æ˜¯2000QPSï¼Œä½†æ˜¯ä½¿ç”¨XDPä¼˜åŒ–åé™åˆ°äº†400QPSï¼Œè¯·é—®è¿™æ˜¯ä»€ä¹ˆåŸå› ï¼Œå¦‚ä½•ä¿®æ­£</div>2023-02-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/55/54/97419b60.jpg" width="30px"><span>codejw</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œå¦‚æœæœ‰å¤šä¸ªxdpç¨‹åºå¦‚ä½•æŒ‚è½½å‘¢ï¼Œæˆ‘æœ‰å¤šä¸ª.oéƒ½æŒ‚è½½åˆ°xdp</div>2022-02-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/e8/f8/2c1958b6.jpg" width="30px"><span>yuan</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>è€å¸ˆå¥½ï¼Œæˆ‘ç”¨å¦‚ä¸‹å‘½ä»¤ç¼–è¯‘é™æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶æ—¶æŠ¥é”™äº†ï¼Œä»£ç ç”¨çš„æ˜¯githubä¸­çš„ä»£ç ï¼Œè¯·é—®æœ‰å•¥æ€è·¯å—ï¼Ÿ
å‘½ä»¤ï¼šclang -Wall -O2 -g xdp-proxy-v2.o -static -lbpf -lelf -lz -o xdp-proxy-v2
ç»“æœï¼š&#47;usr&#47;bin&#47;ld: cannot find -lbpf
&#47;usr&#47;bin&#47;ld: cannot find -lelf
&#47;usr&#47;bin&#47;ld: cannot find -lz
&#47;usr&#47;bin&#47;ld: cannot find -lc
clang-13: error: linker command failed with exit code 1 (use -v to see invocation)

å¦å¤–ç”¨ip linkæŒ‚è½½ä¹Ÿä¸è¡Œ
å‘½ä»¤ï¼šsudo ip link set dev eth0 xdpgeneric object xdp-proxy-v2.bpf.o sec xdp
ç»“æœï¼š
BTF debug data section &#39;.BTF&#39; rejected: Invalid argument (22)!
 - Length:       1817
Verifier analysis:
... ...
Prog section &#39;xdp&#39; rejected: Permission denied (13)!
 - Type:         6
 - Instructions: 151 (0 over limit)
 - License:      GPL

Verifier analysis:
... ...
processed 25 insns (limit 1000000) max_states_per_insn 0 total_states 1 peak_states 1 mark_read 1

Error fetching program&#47;map!

å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯å¦‚ä¸‹ï¼š
5.14.10-300.fc35.x86_64
Fedora release 35 (Thirty Five)</div>2022-03-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/6d/5f/a937f7f1.jpg" width="30px"><span>ä¹Œæ‹‰å‘†zyb</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>å€ªè€å¸ˆï¼Œè¯·é—®ä¸ºä»€ä¹ˆå°†XDP eBPFç¨‹åºæŒ‚è½½ä¸Šå»ä¹‹åï¼Œä¼˜åŒ–æ•ˆæœåè€Œå¤§å¤§åœ°ä¸‹é™äº†ï¼Ÿä¼˜åŒ–å‰ Requests&#47;sec æ˜¯7500å·¦å³ï¼›XDPä¼˜åŒ–å Requests&#47;sec æ˜¯250 å·¦å³ï¼›ä»£ç éƒ½æ˜¯githubä¸Šçš„ä»£ç ï¼›ä¸¤ä¸ªç‰ˆæœ¬çš„éƒ½è¯•è¿‡äº†ï¼Œéƒ½æ˜¯åå‘ä¼˜åŒ–ï¼Œä¸çŸ¥é“ä¸ºå•¥ ^~^</div>2022-05-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2d/27/c5/d4d00da2.jpg" width="30px"><span>ä¸ºäº†ç»´æŠ¤ä¸–ç•Œå’Œå¹³</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å€ªè€å¸ˆä½ å¥½ï¼Œä½¿ç”¨XDP é€Ÿåº¦æ…¢äº†ï¼Œè¿™å¤§æ¦‚ä»€ä¹ˆåŸå› å‘¢
&#47; # wrk -c100 &quot;http:&#47;&#47;172.17.0.5&quot;
Running 10s test @ http:&#47;&#47;172.17.0.5
  2 threads and 100 connections
  Thread Stats   Avg      Stdev     Max   +&#47;- Stdev
    Latency   272.26ms  386.46ms   1.70s    86.32%
    Req&#47;Sec   122.51     90.04   580.00     73.65%
  2483 requests in 10.06s, 441.31KB read
  Socket errors: connect 0, read 0, write 0, timeout 53
Requests&#47;sec:    246.73
Transfer&#47;sec:     43.85KB
</div>2022-07-20</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erBT5LK5f0w6MHCyX7Tuc1aytDlSazDkFPibwZ113Luz8qLviccotz4k3oIePQzrZhHEBWSDKUIjw7A/132" width="30px"><span>aith</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>XDPç¨‹åºæŠŠæ•°æ®åŒ…éšæœºè°ƒåº¦åˆ°æŸä¸ªWebserverï¼Œæ²¡æœ‰ä¼šè¯ä¿æŒï¼Œä¼šä¸ä¼šå¯¼è‡´åŒä¸€æ¬¡è¯·æ±‚çš„æ•°æ®åŒ…ï¼Œå‘é€åˆ°ä¸åŒçš„åç«¯Webserverä¸Šé¢,ä»è€Œä¸èƒ½æ­£å¸¸ç›¸åº”ï¼Ÿ</div>2022-05-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/6d/5f/a937f7f1.jpg" width="30px"><span>ä¹Œæ‹‰å‘†zyb</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>å€ªè€å¸ˆï¼Œè¿˜æƒ³è¯·æ•™æ‚¨ä¸€ä¸ªé—®é¢˜ï¼š åŠ è½½XDP eBPFç¨‹åºåï¼Œcurl &quot;http:&#47;&#47;172.17.0.5&quot; æµ‹è¯•æ­£å¸¸ï¼Œæœ‰è´Ÿè½½å‡è¡¡èƒ½åŠ›ï¼›ä½† wrk -c 100 &quot;http:&#47;&#47;172.17.0.5&quot; çš„æµ‹è¯•ç»“æœä¸­æœ‰Socker errorsçš„è¿æ¥è¶…æ—¶çš„æŠ¥é”™å¦‚ä¸‹ï¼š
&#47; # wrk -c 100 &quot;http:&#47;&#47;172.17.0.5&quot;
Running 10s test @ http:&#47;&#47;172.17.0.5
  2 threads and 100 connections
  Thread Stats   Avg      Stdev     Max   +&#47;- Stdev
    Latency   274.75ms  384.76ms   1.70s    86.88%
    Req&#47;Sec   127.44     86.42   530.00     69.19%
  2640 requests in 10.09s, 469.22KB read
  Socket errors: connect 0, read 0, write 0, timeout 56
Requests&#47;sec:    261.64
Transfer&#47;sec:     46.50KB
&#47; # </div>2022-05-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/cd/db/7467ad23.jpg" width="30px"><span>Bachue Zhou</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>è¿™ä¸ªç¨‹åºå¯¹ libbpf çš„ç‰ˆæœ¬è¦æ±‚å¾ˆé«˜å•Šï¼Œæˆ‘è¿™è¾¹ç”¨çš„æ˜¯ Ubuntu 22.04 éƒ½ä¸è¡Œï¼Œå¾ˆå¤š symbol æ‰¾ä¸åˆ°çš„ã€‚</div>2023-04-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ce/b4/bb5d7f90.jpg" width="30px"><span>æ—é–</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å€ªéƒ½ä½ å¥½ï¼Œæˆ‘å‚è€ƒtc-bpfæ‰‹å†Œç¼–è¯‘äº†ä¸€ä¸ªtcç¨‹åºï¼Œæºç å¦‚ä¸‹ï¼š
#include &lt;linux&#47;bpf.h&gt;

           #ifndef __section
           # define __section(x)  __attribute__((section(x), used))
           #endif

           __section(&quot;classifier&quot;) int cls_main(struct __sk_buff *skb)
           {
                   return -1;
           }

           char __license[] __section(&quot;license&quot;) = &quot;GPL&quot;;
ç¼–è¯‘å®Œç”¨tcåŠ è½½çš„æ—¶å€™æŠ¥å¦‚ä¸‹é”™è¯¯ï¼š
tc filter add dev eth0 parent 1: bpf obj bcc.o verbose flowid 1:1 skip_sw
libbpf: loading bcc.o
libbpf: elf: section(3) classifier, size 24, link 0, flags 6, type=1
libbpf: elf: section(4) license, size 4, link 0, flags 3, type=1
libbpf: license of bcc.o is GPL
libbpf: elf: section(5) .eh_frame, size 48, link 0, flags 2, type=1
libbpf: elf: skipping unrecognized data section(5) .eh_frame
libbpf: elf: section(6) .rel.eh_frame, size 16, link 7, flags 0, type=9
libbpf: elf: skipping relo section(6) .rel.eh_frame for section(5) .eh_frame
libbpf: elf: section(7) .symtab, size 96, link 1, flags 0, type=2
libbpf: looking for externs among 4 symbols...
libbpf: collected 0 externs total
object file doesn&#39;t contain sec classifier
Unable to load program

è¿™ä¸ªé—®é¢˜æ˜¯æ€ä¹ˆå›äº‹ï¼Œæ‰¾äº†ä¸€ä¸‹åˆéƒ½æ²¡æœ‰å‘ç°é—®é¢˜å‡ºåœ¨å“ª
</div>2022-03-30</li><br/><li><img src="" width="30px"><span>Geek_6acaf8</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>xdp-proxy-v2.c:78:2: warning: implicit declaration of function &#39;LIBBPF_OPTS&#39; is invalid in C99 [-Wimplicit-function-declaration]
        LIBBPF_OPTS(bpf_xdp_attach_opts, attach_opts);
        ^
xdp-proxy-v2.c:78:14: error: use of undeclared identifier &#39;bpf_xdp_attach_opts&#39;
        LIBBPF_OPTS(bpf_xdp_attach_opts, attach_opts);
                    ^
xdp-proxy-v2.c:78:35: error: use of undeclared identifier &#39;attach_opts&#39;
        LIBBPF_OPTS(bpf_xdp_attach_opts, attach_opts);
                                         ^
xdp-proxy-v2.c:79:8: warning: implicit declaration of function &#39;bpf_xdp_attach&#39; is invalid in C99 [-Wimplicit-function-declaration]
        err = bpf_xdp_attach(ifindex, prog_id, xdp_flags, &amp;attach_opts);
              ^
xdp-proxy-v2.c:79:53: error: use of undeclared identifier &#39;attach_opts&#39;
        err = bpf_xdp_attach(ifindex, prog_id, xdp_flags, &amp;attach_opts);
                                                           ^
xdp-proxy-v2.c:91:2: warning: implicit declaration of function &#39;bpf_xdp_detach&#39; is invalid in C99 [-Wimplicit-function-declaration]
        bpf_xdp_detach(ifindex, xdp_flags, &amp;attach_opts);
        ^
xdp-proxy-v2.c:91:38: error: use of undeclared identifier &#39;attach_opts&#39;
        bpf_xdp_detach(ifindex, xdp_flags, &amp;attach_opts);
åœ¨ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶çš„æ—¶å€™æ€»æ˜¯æŠ¥é”™ï¼Œä¹‹å‰çš„ä¾èµ–ä¹Ÿéƒ½å®‰è£…äº†</div>2024-03-20</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/pNKoOAa1QXibrykHNXibW4tyaIIhicocPGXtcVnEianCyOQY9bl0P2JQ3wSialUaolcLVEWycCEBz1Oe4Tj4yghH9yw/132" width="30px"><span>Geek_5aa343</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>libbpfä¸­çš„section_defsé“¾æ¥æ›´æ–°ä¸‹ï¼šhttps:&#47;&#47;github.com&#47;libbpf&#47;libbpf&#47;blob&#47;master&#47;src&#47;libbpf.c#L9003-L9080</div>2022-05-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/ce/b4/bb5d7f90.jpg" width="30px"><span>æ—é–</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>æˆ‘çŸ¥é“äº† åº”è¯¥æ˜¯æˆ‘iproute2æœ‰é—®é¢˜</div>2022-03-30</li><br/>
</ul>