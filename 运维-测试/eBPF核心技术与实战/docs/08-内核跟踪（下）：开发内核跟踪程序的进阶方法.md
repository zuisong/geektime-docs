ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚

ä¸Šä¸€è®²ï¼Œæˆ‘å¸¦ä½ æ¢³ç†äº†æŸ¥è¯¢ eBPF è·Ÿè¸ªç‚¹çš„å¸¸ç”¨æ–¹æ³•ï¼Œå¹¶ä»¥çŸ­æ—¶è¿›ç¨‹çš„è·Ÿè¸ªä¸ºä¾‹ï¼Œé€šè¿‡ bpftrace å®ç°äº†å†…æ ¸è·Ÿè¸ªç‚¹çš„è·Ÿè¸ªç¨‹åºã€‚

bpftrace ç®€å•æ˜“ç”¨ï¼Œéå¸¸é€‚åˆå…¥é—¨ï¼Œå¯ä»¥å¸¦åˆå­¦è€…è½»æ¾ä½“éªŒ eBPF çš„å„ç§è·Ÿè¸ªç‰¹æ€§ã€‚ä½†åœ¨ä¸Šä¸€è®²çš„æ¡ˆä¾‹ä¸­ï¼Œä½ ä¹Ÿå‘ç° bpftrace å¹¶ä¸é€‚ç”¨äºæ‰€æœ‰çš„ eBPF åº”ç”¨ï¼Œå®ƒæœ¬èº«çš„é™åˆ¶å¯¼è‡´æˆ‘ä»¬æ— æ³•åœ¨éœ€è¦å¤æ‚ eBPF ç¨‹åºçš„åœºæ™¯ä¸­ä½¿ç”¨å®ƒã€‚åœ¨å¤æ‚çš„åº”ç”¨ä¸­ï¼Œæˆ‘è¿˜æ˜¯æ¨èä½ ä½¿ç”¨ BCC æˆ–è€… libbpf è¿›è¡Œå¼€å‘ã€‚

é‚£ä¹ˆï¼Œä»Šå¤©æˆ‘å°±å¸¦ä½ çœ‹çœ‹ï¼Œå¦‚ä½•ä½¿ç”¨ BCC å’Œ libbpf è¿™ä¸¤ä¸ªè¿›é˜¶æ–¹æ³•æ¥å¼€å‘å†…æ ¸è·Ÿè¸ªç¨‹åºã€‚

## **BCC æ–¹æ³•**

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ BCC æ¥å¼€å‘ä¸Šä¸€è®²ä¸­çŸ­æ—¶è¿›ç¨‹çš„è·Ÿè¸ªç¨‹åºã€‚è¿™é‡Œå…ˆè¯´æ˜ä¸‹ï¼Œç”±äºÂ execveatÂ çš„å¤„ç†é€»è¾‘åŒÂ execveÂ åŸºæœ¬ç›¸åŒï¼Œé™äºç¯‡å¹…çš„é•¿åº¦ï¼Œæ¥ä¸‹æ¥çš„ BCC å’Œ libbpf ç¨‹åºéƒ½ä»¥Â execveÂ ä¸ºä¾‹ã€‚

è¿™é‡Œæˆ‘ä»¬å…ˆå›é¡¾ä¸‹ [03è®²](https://time.geekbang.org/column/article/481090) çš„å†…å®¹ï¼Œä½¿ç”¨ BCC å¼€å‘çš„ eBPF ç¨‹åºåŒ…å«ä¸¤éƒ¨åˆ†ï¼š

- ç¬¬ä¸€éƒ¨åˆ†æ˜¯ç”¨ C è¯­è¨€å¼€å‘çš„ eBPF ç¨‹åºã€‚åœ¨ eBPF ç¨‹åºä¸­ï¼Œä½ å¯ä»¥åˆ©ç”¨ BCC æä¾›çš„[åº“å‡½æ•°å’Œå®å®šä¹‰](https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md)ç®€åŒ–ä½ çš„å¤„ç†é€»è¾‘ã€‚
- ç¬¬äºŒéƒ¨åˆ†æ˜¯ç”¨ Python è¯­è¨€å¼€å‘çš„å‰ç«¯ç•Œé¢ï¼Œå…¶ä¸­åŒ…å« eBPF ç¨‹åºåŠ è½½ã€æŒ‚è½½åˆ°å†…æ ¸å‡½æ•°å’Œè·Ÿè¸ªç‚¹ï¼Œä»¥åŠé€šè¿‡ BPF æ˜ å°„è·å–å’Œæ‰“å°æ‰§è¡Œç»“æœç­‰éƒ¨åˆ†ã€‚åœ¨å‰ç«¯ç¨‹åºä¸­ï¼Œä½ åŒæ ·å¯ä»¥åˆ©ç”¨ BCC åº“æ¥è®¿é—® BPF æ˜ å°„ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ27ï¼‰</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg" width="30px"><span>è«å</span> ğŸ‘ï¼ˆ12ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>1ã€å¯¹äºå‚æ•°é—®é¢˜ï¼Œå½“å‰ BPF ç¨‹åºå°è¯•æŠŠæ‰€æœ‰å‚æ•°ä¸€æ¬¡æ€§æ”¾å…¥ï¼Œå—é™äºæ ˆæœ€å¤§é•¿åº¦ 512ï¼Œå¾ˆå®¹æ˜“å‡ºç°è¢«æˆªæ–­ç°è±¡ã€‚ä»¥ BCC ç¨‹åºä¸ºä¾‹çš„è§£å†³æ–¹æ³•ï¼šéå†å‚æ•°åˆ—è¡¨ argv æ—¶ï¼Œæ¯ä¸ªå‚æ•°è¯»å–ä¹‹åç›´æ¥è°ƒç”¨ perf_submit æäº¤è‡³ ringbufï¼Œè€Œä¸æ˜¯è¯»å–æ‰€æœ‰å‚æ•°åä»…æäº¤ä¸€æ¬¡ï¼Œæœ€åç”¨æˆ·æ€ç¨‹åºè´Ÿè´£æŠŠè¿™äº›å­—ç¬¦ä¸²æ‹¼æ¥èµ·æ¥ã€‚è¿™æ ·å¯ä»¥åšåˆ°å‚æ•°æœ€å¤§ä¸ªæ•°ä¸å—é™åˆ¶ï¼Œä¸”æ¯ä¸ªå‚æ•°é•¿åº¦å¯æ¥è¿‘æ ˆæœ€å¤§é•¿åº¦ 512ï¼ˆå½“å‰ BPF ç¨‹åºé™åˆ¶ 64 å®¹æ˜“è¢«æˆªæ–­ï¼‰ã€‚

å¦ä¸€ä¸ªè§£å†³æ–¹å¼åº”è¯¥å¯ä»¥é‡‡ç”¨ perf-cpu array æ˜ å°„ç±»å‹ï¼Œé¿å…å ç”¨æœ‰é™çš„æ ˆç©ºé—´ï¼Œå…·ä½“æ²¡å°è¯•è¿‡ã€‚

2ã€ä»¥ BCC ç¨‹åºä¸ºä¾‹è·å–çˆ¶è¿›ç¨‹ï¼Œstruct data_t å¢åŠ  ppid å­—æ®µï¼Œç„¶åç”± task-&gt;real_parent-&gt;tgid èµ‹å€¼ã€‚

struct task_struct *task;

task = (struct task_struct *)bpf_get_current_task();
data.ppid = task-&gt;real_parent-&gt;tgid;</div>2022-02-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg" width="30px"><span>piboye</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<div>golang + libbpf æ˜¯ä¸æ˜¯æ¯”BCC æ–¹æ¡ˆæ›´å¥½ï¼Ÿ</div>2022-03-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/76/b0/14fec62f.jpg" width="30px"><span>ä¸äº†å³°</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è¯·æ•™ä¸€ä¸‹æ–‡ç« ä¸­å…³äº ã€Œlibbpf æ–¹æ³•ã€
ä¸ºä»€ä¹ˆ æ–‡ç« ä¸­æ²¡æœ‰æåŠ  execsnoop.h  è¿™ä¸ªæ–‡ä»¶ã€‚ã€‚
è€Œ  execsnoop.bpf.c è¦ #include &quot;execsnoop.h&quot;  è¿™ä¸ªæ–‡ä»¶ ï¼Ÿ
 å…³äº  execsnoop.h  æ–‡ä»¶å†…å®¹ç”Ÿæˆï¼Œæ˜¯ä¸æ˜¯åœ¨å‰é¢çš„å‡ ç« æœ‰æ¶‰åŠï¼Ÿ</div>2022-02-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/41/38/4f89095b.jpg" width="30px"><span>å†™ç‚¹å•¥å‘¢</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>è¯·æ•™ä¸‹è€å¸ˆï¼š
1. bpfçš„è¾…åŠ©å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡æ˜¯åœ¨å½“å‰è¿›ç¨‹ä¸‹ä¹ˆï¼Œå› ä¸ºæˆ‘çœ‹åƒexecsnoopä¾‹å­ä¸­get_current_pid_tgidè°ƒç”¨èƒ½æ‹¿åˆ°çš„æ˜¯æ–°å¯åŠ¨è¿›ç¨‹pidã€‚
2. libbpfçš„å¼€å‘æ¨¡å¼èƒ½çœ‹åˆ°ä»ç¼–è¯‘å™¨åˆ°bpfåœ¨èƒŒååšäº†å¾ˆå¤šå·¥ä½œï¼Œå¦‚æœæƒ³äº†è§£bpfç¨‹åºçš„å®ç°ï¼Œæ¯”å¦‚å®æ˜¯å¦‚ä½•å®šä¹‰äº†æ˜ å°„å’ŒæŒ‚è½½ç‚¹ï¼Œç¨‹åºåŠ è½½çš„æ—¶å€™å¦‚ä½•ä»ç¨‹åºæ®µä¸­çš„ä¿¡æ¯å®ç°çš„æ˜ å°„åˆ›å»ºå’ŒæŒ‚è½½ï¼Œè€å¸ˆèƒ½å¦ç»™æŒ‡ä¸€ä¸ªå­¦ä¹ è·¯å¾„ï¼Ÿè°¢è°¢å•¦</div>2022-02-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/42/8c/373d4027.jpg" width="30px"><span>é¾è¦</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>æœ€æ–°çš„ä»£ç  https:&#47;&#47;github.com&#47;feiskyer&#47;ebpf-apps&#47;tree&#47;b89ae0f
æ‰§è¡Œ make å‡ºé”™ï¼Œè¿™æ˜¯ gcc-toolset å¯¼è‡´å—ï¼Ÿè€å¸ˆï¼Œå„ä½åŒ
å­¦æ˜¯å¦é‡åˆ°è¿‡ï¼Ÿ

```
[root@Rocky-9 bpf-apps]# make
clang -g -O2 -target bpf -D__TARGET_ARCH_x86 -Ilibbpf&#47;usr&#47;include -I..&#47;libbpf&#47;include&#47;uapi -I&#47;usr&#47;include&#47;x86_64-linux-gnu -I. -c hello.bpf.c -o hello.bpf.o
&#47;usr&#47;sbin&#47;bpftool gen skeleton hello.bpf.o &gt; hello.skel.h
clang -g -O2 -Wall -Ilibbpf&#47;usr&#47;include -I..&#47;libbpf&#47;include&#47;uapi -I&#47;usr&#47;include&#47;x86_64-linux-gnu -I. -c hello.c -o hello.o
clang -Wall -O2 -g hello.o -static &#47;root&#47;ebpf-apps&#47;bpf-apps&#47;libbpf&#47;libbpf.a -lelf -lz -o hello
&#47;usr&#47;bin&#47;ld: cannot find -lelf
&#47;usr&#47;bin&#47;ld: cannot find -lz
&#47;usr&#47;bin&#47;ld: cannot find -lc
clang-14: error: linker command failed with exit code 1 (use -v to see invocation)
make: *** [Makefile:14: hello] Error 1
[root@Rocky-9 bpf-apps]#
[root@Rocky-9 bpf-apps]# clang -v
clang version 14.0.6 (Red Hat 14.0.6-4.el9_1)
Target: x86_64-redhat-linux-gnu
Thread model: posix
InstalledDir: &#47;usr&#47;bin
Found candidate GCC installation: &#47;opt&#47;rh&#47;gcc-toolset-12&#47;root&#47;usr&#47;lib&#47;gcc&#47;x86_64-redhat-linux&#47;12
Selected GCC installation: &#47;opt&#47;rh&#47;gcc-toolset-12&#47;root&#47;usr&#47;lib&#47;gcc&#47;x86_64-redhat-linux&#47;12
Candidate multilib: .;@m64
Candidate multilib: 32;@m32
Selected multilib: .;@m64
```</div>2023-02-21</li><br/><li><img src="" width="30px"><span>ä»è¿œæ–¹è¿‡æ¥</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>è€å¸ˆï¼Œæˆ‘è¿è¡Œä¸‹é¢çš„ä»£ç ï¼Œåœ¨å¦å¤–ä¸€ä¸ªshellä¸Šé¢æ‰§è¡Œchmodå‘½ä»¤ï¼Œä½†æ˜¯bccå´æ²¡æœ‰è¾“å‡ºï¼Œè¯·é—®è¿™ä¸ªæ˜¯ä»€ä¹ˆåŸå› ?

å†…æ ¸ç‰ˆæœ¬ï¼š 4.14.15-1.el7.elrepo.x86_64
æ“ä½œç³»ç»Ÿï¼š CentOS Linux release 7.9.2009 (Core)
bccç‰ˆæœ¬ï¼šbcc-0.21.0-1.el7.x86_64
               bcc-tools-0.21.0-1.el7.x86_64
               python-bcc-0.21.0-1.el7.noarch


#!&#47;usr&#47;bin&#47;env python3
# Tracing execve() system call.
from bcc import BPF
from bcc.utils import printb


chmod_prog = &quot;&quot;&quot;
&#47;* Tracing execve system call. *&#47;
#include &lt;uapi&#47;linux&#47;ptrace.h&gt;
#include &lt;linux&#47;sched.h&gt;
#include &lt;linux&#47;fs.h&gt;


&#47;&#47; perf event map (sharing data to userspace) and hash map (sharing data between tracepoints)
struct data_t {
	u32 pid;
	umode_t mode;
	char * filename;
};
BPF_PERF_OUTPUT(events);  &#47;&#47; ç”Ÿæˆä¸€ä¸ªeventäº‹ä»¶
&#47;&#47; BPF_HASH(tasks, u32, struct data_t);


&#47;&#47; sys_enter_chmod tracepoint.
TRACEPOINT_PROBE(syscalls, sys_enter_chmod)
{


	struct data_t data = {};
	u32 pid = bpf_get_current_pid_tgid();
	umode_t mode = args-&gt;mode;
	char * filename = (char *)args-&gt;filename;
	data.pid = pid ;
	data.mode = mode; 
	data.filename = filename;

	events.perf_submit(args, &amp;data, sizeof(data)); 
	return 0;
}


&quot;&quot;&quot;

# 1) load BPF program
b = BPF(text=chmod_prog)
# b = BPF(src_file=&quot;chmod.c&quot;)

# 2) print header
print(&quot;%-6s %-16s %-3s %s&quot; % (&quot;PID&quot;, &quot;COMM&quot;, &quot;RET&quot;, &quot;ARGS&quot;))


# 3) define the callback for perf event
def print_event(cpu, data, size):
    # event data struct is generated from &quot;struct data_t&quot; by bcc
    event = b[&quot;events&quot;].event(data)
    printb(b&quot;%-6d %-16s %-3d&quot; % (event.pid, event.mode, event.filename))


# 4) loop with callback to print_event
b[&quot;events&quot;].open_perf_buffer(print_event)
while 1:
    try:
        b.perf_buffer_poll()
    except KeyboardInterrupt:
        exit()





</div>2022-03-17</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eq30mvo0eATZ3Yfm5POktwic3NJSRkiagtJt1vaxyvCS22PJRm8xrulXqaLJRWQWb6zNI4zL0G2QkCA/132" width="30px"><span>heyhd9475</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆä½ å¥½ï¼Œæˆ‘æƒ³è¯·é—®ä¸ºä»€ä¹ˆæ¯æ¬¡ä½¿ç”¨bpf_probe_read_user_str()è¯»å–åä¸åœ¨æ¯æ¬¡è¯»å–åˆ°çš„å‚æ•°ä¸­é—´åŠ ä¸Šä¸€ä¸ªç©ºæ ¼å‘¢ï¼Œæˆ‘è¿™è¾¹å°è¯•åŠ è¿™ä¸ªç©ºæ ¼ï¼Œä¸ºä»€ä¹ˆä¼šæç¤ºå¦‚ä¸‹çš„æ— æ•ˆæ— é™åˆ¶å¯å˜åç§»é‡æ ˆå†™å…¥å‘¢ï¼š
invalid unbounded variable-offset write to stack R2

æŠ¥é”™çš„æºç ä¸º: data.args[data.next_arg_index-1]=&#39; &#39;;
æ˜¯å› ä¸ºbccè®¤ä¸ºå‚æ•°data.next_arg_indexæ˜¯æ²¡æœ‰é™åˆ¶èŒƒå›´çš„ï¼Œä¸å®‰å…¨çš„å—ã€‚</div>2022-02-19</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/ibYCL2nbctJDpBLwZXlKIX7Z4XUicBm1ibIbLd0dWMYibxtshnEzOWAl5LC7JgMcjSet5B30s2HUpiabhYyyFWiaWd1Q/132" width="30px"><span>hjydxy</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆå¥½ï¼š
       åœ¨è¿™ä¸ªÂ execsnoop.skel.hÂ æ–‡ä»¶ä¸­ï¼Œæœ‰ä¸€ä¸ªâ€œexecsnoop_bpf__loadâ€å‡½æ•°ï¼Œä½ åœ¨è¯´æ˜ä¸­ä¹Ÿè¯´äº†è¿™ä¸ªå‡½æ•°æ˜¯åŠ è½½ebpfç¨‹åºç”¨çš„ï¼Œæˆ‘æƒ³è¯·æ•™ä¸‹è¿™ä¸ªå‡½æ•°å’Œ&#47;samples&#47;bpf&#47;ä¸‹ä¾‹å­ä¸­ä½¿ç”¨çš„â€œbpf_object__loadâ€æœ‰ä»€ä¹ˆåŒºåˆ«å’Œè”ç³»ï¼Œæˆ‘çš„ç†è§£æ˜¯è¿™ä¸¤ä¸ªå‡½æ•°çš„ä½œç”¨å·®ä¸å¤šï¼Œéƒ½æ˜¯åŠ è½½ebpfç¨‹åºç”¨çš„ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼Œä½¿ç”¨â€œexecsnoop_bpf__loadâ€çš„æ„ä¹‰æˆ–è€…å¥½å¤„åœ¨å“ªé‡Œï¼Ÿè°¢è°¢ã€‚</div>2022-02-16</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/KFgDEHIEpnT0EXnh02VHqHfsle3u6lJUYWjdOtBovSrfHyLwQcKiaicibGia2MJBX8uyicw3prPrcqWhJy9fUCCz1DVFYH0QHAYXc/132" width="30px"><span>c1</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>è¯·æ•™ï¼š
Ubuntu 21.10
Linux u21 5.13.0-28-generic #31-Ubuntu SMP Thu Jan 13 17:41:06 UTC 2022 x86_64 x86_64 x86_64 GNU&#47;Linux

æ‰§è¡Œexecsnoop.pyæŠ¥é”™ï¼š
...
&#47;virtual&#47;main.c:47:42: error: incomplete definition of type &#39;struct tracepoint__syscalls__sys_enter_execve&#39;
        const char **argv = (const char **)(args-&gt;argv);
...
&#47;virtual&#47;main.c:82:22: error: incomplete definition of type &#39;struct tracepoint__syscalls__sys_exit_execve&#39;
                data-&gt;retval = args-&gt;ret;
...</div>2022-02-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/1a/84/c6316817.jpg" width="30px"><span>Haric</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æ–‡ç« æåˆ°ï¼Œä½¿ç”¨libbfpæ–¹å¼åœ¨å¼€å¯äº† BTF çš„å…¶ä»–æœºå™¨éƒ½å¯ä»¥è¿è¡Œï¼Œè¯·é—®åœ¨åµŒå…¥å¼è®¾å¤‡ï¼ˆéœ€è¦äº¤å‰ç¼–è¯‘ï¼‰èƒ½è¿è¡Œå—ï¼Ÿ</div>2022-02-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/36/90/55e8cb1b.jpg" width="30px"><span>CaptainZhao</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>æ‚¨å¥½ï¼Œæˆ‘æœ€è¿‘å°è¯•ç”¨iovisor&#47;gobpfå†™golangçš„bccç¨‹åºï¼Œç”¨bccçš„runqlatæ”¹æˆäº†ç”¨æˆ·æ€æ˜¯golangçš„å®ç°ï¼Œè€ƒè™‘é•¿æ—¶é—´è·‘å¯èƒ½ä¼šå¯¹cfsæ€§èƒ½æœ‰å½±å“ï¼Œäºæ˜¯å°è¯•å†™æˆæ¯15ç§’å¼€å§‹é‡‡é›†ï¼Œç„¶åè·‘100æ¯«ç§’å…³é—­çš„æ–¹å¼ã€‚å¤§æ¦‚æ˜¯bcc.NewModule -&gt; load -&gt; attach -&gt; module.Close()ï¼Œä½†æ˜¯å‘ç°å†…å­˜æŒç»­åœ°ä¸Šæ¶¨ï¼Œç”¨pprofçœ‹äº†ä¸€ä¸‹ç¡®å®šä¸æ˜¯golangçš„å†…å­˜åœ¨ä¸Šæ¶¨ï¼Œç”¨memleakçœ‹äº†ä¸€ä¸‹å¥½åƒæ˜¯NewModuleç¼–è¯‘é˜¶æ®µllvm&#47;clangå¾ˆå¤šå†…å­˜æ²¡é‡Šæ”¾ï¼Œè¿™ä¸ªé—®é¢˜è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</div>2022-04-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/6a/a0/791d0f5e.jpg" width="30px"><span>å¼ ä¸‰</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>è¯·é—®trace_event_raw_sys_enterï¼Œtrace_event_raw_sys_exitè¿™ä¸¤ä¸ªå…¥å‚æ˜¯ç”±ä»€ä¹ˆå†³å®šçš„ï¼Ÿçœ‹åˆ°å…¶å®ƒåœ°æ–¹æœ‰void *çš„å…¥å‚ï¼Œä¹Ÿæœ‰å…¶å®ƒå…¥å‚</div>2023-08-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/27/fb/f7/88ab6f83.jpg" width="30px"><span>è¿›å‡»çš„Lancelot</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>There are two ways to nail down the argument. 
The first one is to base your `vmlinux.h`. Generally, `sys_enter_xx` corresponds to `trace_event_raw_sys_enter`, `sys_exit_xx` corresponds to `trace_event_raw_sys_exit`.  And if not found, you can try the other way. 

The second way is to create your own data structure. There are three steps:
1. confirm the format of arguments (sudo cat &#47;sys&#47;kernel&#47;debug&#47;tracing&#47;event&#47;syscalls&#47;sys_enter_exceve&#47;format)
2. create your own parameter structure, like:
```C
struct sys_enter_execve_args {
    char _[16];
    const char *filename;      &#47;&#47; offset:16
    const char *const *argv;   &#47;&#47; offset:24
    const char *const *envp;   &#47;&#47; offset:32
};
```
3. Implement your handler function
```C
SEC(&quot;tracepoint&#47;syscalls&#47;sys_enter_execve&quot;)
int tracepoint__syscalls__sys_enter_execve(struct sys_enter_execve_args *ctx) {
    struct event *event;
    const char **args = (const char **)(ctx-&gt;argv);
    const char *argp;
    
    &#47;&#47; omit some code ...
  
    &#47;&#47; query the first argument - filename
    unsigned int ret = bpf_probe_read_user_str(event-&gt;args, ARGSIZE, ctx-&gt;filename);
    
    &#47;&#47; omit some code ...
    for(int i = 1; i &lt; TOTAL_MAX_ARGS; ++i) {
       ...
    }
    ...
    return 0;
}
```</div>2024-12-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/68/2a/f16befce.jpg" width="30px"><span>æ·±æ¸…ç§‹</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>åœ¨é«˜ç‰ˆæœ¬ubuntu 6.8.0-40-genericä¸‹ï¼Œè¿™ä¸ªå‘½ä»¤ä¼šæŠ¥é”™ï¼šclang -Wall -O2 -g execsnoop.o -static -lbpf -lelf -lz -o execsnoop

æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š
&#47;usr&#47;bin&#47;ld: &#47;lib&#47;x86_64-linux-gnu&#47;libelf.a(elf_compress.o): in function `__libelf_compress&#39;:
(.text+0x113): undefined reference to `ZSTD_createCCtx&#39;
&#47;usr&#47;bin&#47;ld: (.text+0x2a9): undefined reference to `ZSTD_compressStream2&#39;
&#47;usr&#47;bin&#47;ld: (.text+0x2b4): undefined reference to `ZSTD_isError&#39;
&#47;usr&#47;bin&#47;ld: (.text+0x2db): undefined reference to `ZSTD_freeCCtx&#39;
&#47;usr&#47;bin&#47;ld: (.text+0x5a0): undefined reference to `ZSTD_compressStream2&#39;
&#47;usr&#47;bin&#47;ld: (.text+0x5ab): undefined reference to `ZSTD_isError&#39;
&#47;usr&#47;bin&#47;ld: (.text+0x6b9): undefined reference to `ZSTD_freeCCtx&#39;
&#47;usr&#47;bin&#47;ld: (.text+0x835): undefined reference to `ZSTD_freeCCtx&#39;
&#47;usr&#47;bin&#47;ld: (.text+0x86f): undefined reference to `ZSTD_freeCCtx&#39;
&#47;usr&#47;bin&#47;ld: (.text+0x91b): undefined reference to `ZSTD_freeCCtx&#39;
&#47;usr&#47;bin&#47;ld: (.text+0xa12): undefined reference to `ZSTD_freeCCtx&#39;
&#47;usr&#47;bin&#47;ld: &#47;lib&#47;x86_64-linux-gnu&#47;libelf.a(elf_compress.o): in function `__libelf_decompress&#39;:
(.text+0xbfc): undefined reference to `ZSTD_decompress&#39;
&#47;usr&#47;bin&#47;ld: (.text+0xc04): undefined reference to `ZSTD_isError&#39;
&#47;usr&#47;bin&#47;ld: &#47;lib&#47;x86_64-linux-gnu&#47;libelf.a(elf_compress.o): in function `__libelf_decompress_elf&#39;:
(.text+0xd45): undefined reference to `ZSTD_decompress&#39;
&#47;usr&#47;bin&#47;ld: (.text+0xd4d): undefined reference to `ZSTD_isError&#39;

å»ºè®®å»æ‰ -static ç¼–è¯‘é€‰é¡¹å³å¯ï¼š clang -Wall -O2 -g execsnoop.o -lbpf -lelf -lz -o execsnoop
</div>2024-10-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/97/94/18d2ad82.jpg" width="30px"><span>å››äº”åˆå</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>è€å¸ˆï¼Œæ‚¨å¥½ æˆ‘é‡åˆ°å¦‚ä¸‹é”™è¯¯ï¼›
root@VM-16-8-ubuntu:&#47;home&#47;ubuntu&#47;code&#47;execsnoop# bpftool gen skeleton execsnoop_example.bpf.o &gt; execsnoop_example.skel.h
libbpf: elf: execsnoop_example_bpf is not a valid eBPF object file
Error: failed to open BPF object file: BPF object format invalid

root@VM-16-8-ubuntu:&#47;home&#47;ubuntu&#47;code&#47;execsnoop# uname -r
5.15.0-91-generic

root@VM-16-8-ubuntu:&#47;home&#47;ubuntu&#47;code&#47;execsnoop# bpftool -V
&#47;usr&#47;lib&#47;linux-tools&#47;5.15.0-91-generic&#47;bpftool v5.15.131
features:
root@VM-16-8-ubuntu:&#47;home&#47;ubuntu&#47;code&#47;execsnoop# clang -v
Ubuntu clang version 14.0.0-1ubuntu1.1
Target: x86_64-pc-linux-gnu
Thread model: posix
InstalledDir: &#47;usr&#47;bin
Found candidate GCC installation: &#47;usr&#47;bin&#47;..&#47;lib&#47;gcc&#47;x86_64-linux-gnu&#47;11
Selected GCC installation: &#47;usr&#47;bin&#47;..&#47;lib&#47;gcc&#47;x86_64-linux-gnu&#47;11
Candidate multilib: .;@m64
Selected multilib: .;@m64

</div>2024-03-23</li><br/><li><img src="" width="30px"><span>Geek_46769f</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>è€å¸ˆï¼Œæƒ³é—®ä¸€ä¸‹
SEC(&quot;tracepoint&#47;syscalls&#47;sys_enter_execve&quot;)
int tracepoint__syscalls__sys_enter_execve(struct trace_event_raw_sys_enter *ctx)
ä¸­çš„å‚æ•°çš„ç»“æ„ä½“struct trace_event_raw_sys_enteræ˜¯å¦‚ä½•ç¡®å®šçš„ï¼Ÿ</div>2023-12-15</li><br/><li><img src="" width="30px"><span>Geek_46769f</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>è€å¸ˆï¼Œæœ‰ä¸ªé—®é¢˜ï¼Œä¸Šé¢çš„libbpfåˆ›å»ºäº†ä¸¤ä¸ªæ˜ å°„ï¼Œä¸€ä¸ªæ˜¯eventsä¸€ä¸ªæ˜¯execsï¼Œexecsè¿™ä¸ªæ˜ å°„åªæ˜¯åœ¨å…¥å£å¤„è·å–ä¸€äº›ä¿¡æ¯ï¼Œç„¶ååœ¨å‡ºå£å¤„æŸ¥è¯¢å…ƒç´ å†æ·»åŠ ä¸€äº›ä¿¡æ¯ï¼Œç„¶åå°†è¿™äº›ä¿¡æ¯æ”¾åˆ°eventsæ˜ å°„ä¸­ã€‚ä¸ºä»€ä¹ˆä¸å¯ä»¥åªä½¿ç”¨eventsä¸€ä¸ªæ˜ å°„æ¥å®Œæˆè¿™äº›è¿›ç¨‹ä¿¡æ¯çš„ä¿å­˜ä¾›ç”¨æˆ·æ€ç¨‹åºæŸ¥è¯¢ä½¿ç”¨å‘¢ï¼Ÿä¸æ˜¯è¯´æ˜ å°„å¯ä»¥è¢«ç”¨æˆ·æ€ç¨‹åºè·å–å—ï¼Ÿæ˜¯å› ä¸ºæ€§èƒ½æ˜ å°„çš„mapæ›´å…·ä¼˜åŠ¿å—ï¼Ÿ</div>2023-12-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/37/e5/4f/085cf5bd.jpg" width="30px"><span>å°å®</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>è¿™ä¸€ç« æ˜æ˜¾è®²å¤ªå¿«äº†</div>2023-08-18</li><br/><li><img src="" width="30px"><span>Geek_e2ed4c</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>ä¸ºå•¥å‰ç«¯å¼€å‘ä¸€å®šç”¨pythonå‘¢ï¼Ÿæœ‰å…¶å®ƒè¯­è¨€å¯é€‰æ‹©å—ï¼Ÿ</div>2023-07-10</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/2UXuSevhia94o9Eky4OfMuSictaldxcqpjGuvRCOcvjIIoVBAENLEZbv2lgwmwC8icK1ZrUcneNtiaeFBV8MT3uzNg/132" width="30px"><span>Gavin</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>è€å¸ˆå¸®å¿™çœ‹ä¸‹è¿™ä¸ªé—®é¢˜
1. æŸ¥æ–°æ˜ å°„æœ‰å€¼
â””â”€$ sudo bpftool perf list events   
pid 147013  fd 7: prog_id 2443  tracepoint  sys_enter_execve
pid 147013  fd 9: prog_id 2444  tracepoint  sys_exit_execve

â””â”€$ sudo bpftool map dump name tasks
[{
        &quot;key&quot;: 147692,
        &quot;value&quot;: {
            &quot;pid&quot;: 147692,
            &quot;comm&quot;: &quot;xfce4-panel-gen&quot;,
            &quot;retval&quot;: 0,
            &quot;args_size&quot;: 45,
            &quot;argv&quot;: &quot;grep-o-P(?&lt;=inet )[0-9]{1,3}(\n.[0-9]{1,3}){3}&quot;
        }
    },{
        &quot;key&quot;: 147768,
        &quot;value&quot;: {
            &quot;pid&quot;: 147768,
            &quot;comm&quot;: &quot;xfce4-panel-gen&quot;,
            &quot;retval&quot;: 0,
            &quot;args_size&quot;: 45,
            &quot;argv&quot;: &quot;grep-o-P(?&lt;=inet )[0-9]{1,3}(\n.[0-9]{1,3}){3}&quot;
        }
    },{

2.pythonä¸è¾“å‡ºå†…å®¹
â””â”€$ sudo python execsnoop.py 
PID    COMM             RET ARGS
</div>2023-06-20</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eosHxJVt0mxwBOpxHd8z5enhfqDicuvUAe5Nlaxts0A9OZ0Kd4ZInr3icBA1aVOjmCicjS9IQNibHdPJw/132" width="30px"><span>Geek_d65e2a</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>åœ¨å†…æ ¸ç‰ˆæœ¬5.15.0-56-genericä¸­
perf_buffer__newçš„å®šä¹‰ä¸º
perf_buffer__new(int map_fd, size_t page_cnt,
                 const struct perf_buffer_opts *opts);
éœ€è¦å°†optsçš„å®šä¹‰æ”¹ä¸ºï¼š
const struct perf_buffer_opts pb_opts = {handle_event, handle_lost_events, NULL};
</div>2023-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/cd/db/7467ad23.jpg" width="30px"><span>Bachue Zhou</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>æ²¡æœ‰ kmalloc çœŸçš„æ˜¯å¤ªéš¾å—äº†ã€‚</div>2023-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/1a/f0/29721362.jpg" width="30px"><span>å½­ä¸œæ—</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>è€å¸ˆï¼Œæˆ‘åœ¨çœ‹pwruä»£ç æ˜¯çœ‹åˆ°ï¼š
SEC(&quot;kprobe&#47;skb-1&quot;)
int kprobe_skb_1(struct pt_regs *ctx) {
	struct sk_buff *skb = (struct sk_buff *) PT_REGS_PARM1(ctx);

	return handle_everything(skb, ctx);
}

SEC(&quot;kprobe&#47;skb-2&quot;)
int kprobe_skb_2(struct pt_regs *ctx) {
	struct sk_buff *skb = (struct sk_buff *) PT_REGS_PARM2(ctx);

	return handle_everything(skb, ctx);
}

æ‚¨çŸ¥é“ä¸Šé¢SEC(&quot;kprobe&#47;skb-1&quot;)æ˜¯ä»€ä¹ˆæ„æ€å—ï¼Ÿä»å†…æ ¸ä»£ç é‡Œå¹¶æ²¡æœ‰çœ‹åˆ°æœ‰&quot;skb-1&quot;è¿™ä¸ªå‡½æ•°</div>2022-10-19</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJicp0Ifiax9ibAduMW3SXibfvRkhC0lpPBZ6tEn7iaXIIK0VrG2VUibO1AFq4kDvGsbNqYia5gd7ZqgMnSw/132" width="30px"><span>å®‹ç¥¥</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å¯¹äºè¿™æ®µä»£ç ï¼š
    &#47;&#47; submit to perf event
    size_t len = EVENT_SIZE(event);
    if (len &lt;= sizeof(*event))
        bpf_perf_event_output(ctx, &amp;events, BPF_F_CURRENT_CPU, event,
                              len);


#define BASE_EVENT_SIZE (size_t)(&amp;((struct event*)0)-&gt;args)
#define EVENT_SIZE(e) (BASE_EVENT_SIZE + e-&gt;args_size)


æœ‰ä»€ä¹ˆç‰¹æ®Šçš„å«ä¹‰å—ï¼Ÿä¸ºä»€ä¹ˆæäº¤åªæäº¤EVENT_SIZEå¤§å°</div>2022-10-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/fe/fc/e56c9c4a.jpg" width="30px"><span>A7kou</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆæ‚¨å¥½ï¼Œæƒ³è¯·é—®ä¸‹ï¼Œæˆ‘åœ¨ä»£ç å®šä¹‰ .maps æ˜ å°„æ—¶ï¼Œåªè¦æˆ‘åŠ äº† SEC(&quot;.maps&quot;) æœ€ååœ¨ç»™ tc å» attach çš„æ—¶å€™å°±ä¼šæŠ¥é”™ï¼š
struct {
  __uint(type, BPF_MAP_TYPE_HASH);
  __uint(key_size, sizeof(__u32));
  __uint(value_size, sizeof(__u32));
} events SEC(&quot;.maps&quot;); &#47;&#47; åŠ äº†è¿™ä¸ª SEC(&quot;.maps&quot;) ä¸‹è¾¹å°±ä¸€å®šä¼šæŠ¥é”™


root@ding-test-2:~&#47;go&#47;src&#47;tmp&#47;test_c# tc filter add dev test_veth1 ingress bpf direct-action obj test.o
libbpf: BTF is required, but is missing or corrupted.
ERROR: opening BPF object file failed
Unable to load program


è¯·é—®ä¸‹è€å¸ˆçŸ¥é“è¿™æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„ä¹ˆï¼Ÿ</div>2022-09-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/84/4a/50940078.jpg" width="30px"><span>å¢æ‰¿ç</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>æ±‚åŠ©è€å¸ˆï¼Œæœ‰æ²¡æœ‰æœ€ä¼˜é›…çš„çªç ´512ä¸ªå­—èŠ‚çš„åŠæ³•æ¨èï¼Œæˆ–è€…ä»£ç åº“ä¾›å‚è€ƒ</div>2022-05-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/63/2e/e49116d1.jpg" width="30px"><span>Geek_007</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>libbpf ä¾‹å­ä¸­ï¼Œvmlinux.h æ˜¯ç”Ÿæˆçš„ï¼Œä½†æ˜¯ä¸‹é¢çš„ä¸‰ä¸ªå¤´æ–‡ä»¶åœ¨å“ªå‘¢ï¼Œæˆ‘è¿™é‡ŒæŠ¥é”™æ‰¾ä¸åˆ°å‘¢ã€‚ã€‚
#include &lt;bpf&#47;bpf_core_read.h&gt;
#include &lt;bpf&#47;bpf_helpers.h&gt;
#include &lt;bpf&#47;bpf_tracing.h&gt;</div>2022-05-19</li><br/>
</ul>