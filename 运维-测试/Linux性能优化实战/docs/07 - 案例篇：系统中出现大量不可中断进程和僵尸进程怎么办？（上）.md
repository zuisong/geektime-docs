ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚

ä¸Šä¸€èŠ‚ï¼Œæˆ‘ç”¨ä¸€ä¸ª Nginx+PHP çš„æ¡ˆä¾‹ï¼Œç»™ä½ è®²äº†æœåŠ¡å™¨ CPU ä½¿ç”¨ç‡é«˜çš„åˆ†æå’Œåº”å¯¹æ–¹æ³•ã€‚è¿™é‡Œä½ ä¸€å®šè¦è®°å¾—ï¼Œå½“ç¢°åˆ°æ— æ³•è§£é‡Šçš„ CPU ä½¿ç”¨ç‡é—®é¢˜æ—¶ï¼Œå…ˆè¦æ£€æŸ¥ä¸€ä¸‹æ˜¯ä¸æ˜¯çŸ­æ—¶åº”ç”¨åœ¨æ£é¬¼ã€‚

çŸ­æ—¶åº”ç”¨çš„è¿è¡Œæ—¶é—´æ¯”è¾ƒçŸ­ï¼Œå¾ˆéš¾åœ¨ top æˆ–è€… ps è¿™ç±»å±•ç¤ºç³»ç»Ÿæ¦‚è¦å’Œè¿›ç¨‹å¿«ç…§çš„å·¥å…·ä¸­å‘ç°ï¼Œä½ éœ€è¦ä½¿ç”¨è®°å½•äº‹ä»¶çš„å·¥å…·æ¥é…åˆè¯Šæ–­ï¼Œæ¯”å¦‚ execsnoop æˆ–è€… perf topã€‚

è¿™äº›æ€è·¯ä½ ä¸ç”¨åˆ»æ„å»èƒŒï¼Œå¤šç»ƒä¹ å‡ æ¬¡ï¼Œå¤šåœ¨æ“ä½œä¸­æ€è€ƒï¼Œä½ ä¾¿èƒ½çµæ´»è¿ç”¨ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬è¿˜è®²åˆ° CPU ä½¿ç”¨ç‡çš„ç±»å‹ã€‚é™¤äº†ä¸Šä¸€èŠ‚æåˆ°çš„ç”¨æˆ· CPU ä¹‹å¤–ï¼Œå®ƒè¿˜åŒ…æ‹¬ç³»ç»Ÿ CPUï¼ˆæ¯”å¦‚ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰ã€ç­‰å¾… I/O çš„ CPUï¼ˆæ¯”å¦‚ç­‰å¾…ç£ç›˜çš„å“åº”ï¼‰ä»¥åŠä¸­æ–­ CPUï¼ˆåŒ…æ‹¬è½¯ä¸­æ–­å’Œç¡¬ä¸­æ–­ï¼‰ç­‰ã€‚

æˆ‘ä»¬å·²ç»åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ–‡ç« ä¸­ï¼Œä¸€èµ·åˆ†æäº†ç³»ç»Ÿ CPU ä½¿ç”¨ç‡é«˜çš„é—®é¢˜ï¼Œå‰©ä¸‹çš„ç­‰å¾… I/O çš„ CPU ä½¿ç”¨ç‡ï¼ˆä»¥ä¸‹ç®€ç§°ä¸º iowaitï¼‰å‡é«˜ï¼Œä¹Ÿæ˜¯æœ€å¸¸è§çš„ä¸€ä¸ªæœåŠ¡å™¨æ€§èƒ½é—®é¢˜ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸ªå¤šè¿›ç¨‹I/Oçš„æ¡ˆä¾‹ï¼Œå¹¶åˆ†æè¿™ç§æƒ…å†µã€‚

## è¿›ç¨‹çŠ¶æ€

å½“ iowait å‡é«˜æ—¶ï¼Œè¿›ç¨‹å¾ˆå¯èƒ½å› ä¸ºå¾—ä¸åˆ°ç¡¬ä»¶çš„å“åº”ï¼Œè€Œé•¿æ—¶é—´å¤„äºä¸å¯ä¸­æ–­çŠ¶æ€ã€‚ä» ps æˆ–è€… top å‘½ä»¤çš„è¾“å‡ºä¸­ï¼Œä½ å¯ä»¥å‘ç°å®ƒä»¬éƒ½å¤„äº D çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯ä¸å¯ä¸­æ–­çŠ¶æ€ï¼ˆUninterruptible Sleepï¼‰ã€‚æ—¢ç„¶è¯´åˆ°äº†è¿›ç¨‹çš„çŠ¶æ€ï¼Œè¿›ç¨‹æœ‰å“ªäº›çŠ¶æ€ä½ è¿˜è®°å¾—å—ï¼Ÿæˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ30ï¼‰</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/3f/57/a014199a.jpg" width="30px"><span>ä¹¦æ—</span> ğŸ‘ï¼ˆ78ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>æ¯ä¸ªäººçš„æœºå™¨é…ç½®ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä¼šå‡ºç°æœ‰çš„æœºå™¨iowaitä¸æ˜æ˜¾ï¼Œæœ‰çš„æœºå™¨è¢«æ‰“çˆ†ã€‚è§£å†³åŠæ³•æ˜¯ç”¨docker cgroupé€‰é¡¹å¯¹ block ioåšé™åˆ¶ã€‚å‡è®¾ç¡¬ç›˜è®¾å¤‡ä¸º &#47;dev&#47;nvme0n1ï¼Œæµ‹è¯•å¦‚ä¸‹ï¼š
1. é™åˆ¶å—è®¾å¤‡çš„è¯»å†™ iops ä¸º 3: `docker run --privileged --name=app9 --device &#47;dev&#47;nvme0n1:&#47;dev&#47;nvme0n1 --device-write-iops &#47;dev&#47;nvme0n1:3 --device-read-iops &#47;dev&#47;nvme0n1:3  -itd feisky&#47;app:iowait-new2`
2. å¯ä»¥æŸ¥çœ‹hostæœºå™¨ cgroup å·²ä¸ºå¯¹åº” docker container æ·»åŠ äº†ç›¸å…³é™åˆ¶ï¼š
```
cat &#47;sys&#47;fs&#47;cgroup&#47;blkio&#47;docker&#47;&quot;docker-container-id&quot;&#47;blkio.throttle.write_iops_device
259:0 3
cat &#47;sys&#47;fs&#47;cgroup&#47;blkio&#47;docker&#47;&quot;docker-container-id&quot;&#47;blkio.throttle.read_iops_device
259:0 3
```
3.  
```
docker exec -it  &quot;docker-container-id&quot; &#47;bin&#47;bash
root@4cc5e6c74cc0:&#47;# dd iflag=direct if=&#47;dev&#47;nvme0n1 of=&#47;dev&#47;null bs=1k count=1000
1000+0 records in
1000+0 records out
1024000 bytes (1.0 MB, 1000 KiB) copied, 340.004 s, 3.0 kB&#47;s
```
`dd` æ¯æ¬¡ä» &#47;dev&#47;nvme0n1 è®¾å¤‡è¯»å–æ•°æ®å†™åˆ° &#47;dev&#47;null è®¾å¤‡ï¼Œæ¯æ¬¡è¯»å– 1kBï¼Œä¸€å…±1000æ¬¡ï¼Œå¿…é¡»ä¸º direct é€‰é¡¹ã€‚å¯ä»¥è§‚æµ‹åˆ°æ‹·è´é€Ÿåº¦ä¸º 3 kB&#47;sï¼Œå³ 1kB * 3ï¼Œè¯´æ˜cgroup é™åˆ¶ `blkio.throttle.read_iops_device` ç”Ÿæ•ˆã€‚

4. è§‚å¯Ÿhostæœºå™¨ iowait å·²ç»ä¸Šå»ã€‚
```
top - 12:10:22 up  1:25,  1 user,  load average: 0.88, 0.81, 0.83
ä»»åŠ¡: 780 total,   1 running, 227 sleeping,   0 stopped, 552 zombie
%Cpu0  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 s
%Cpu1  :  2.7 us,  0.0 sy,  0.0 ni, 97.3 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 s
%Cpu2  :  0.0 us,  0.0 sy,  0.0 ni,  0.0 id,100.0 wa,  0.0 hi,  0.0 si,  0.0 s
%Cpu3  :  5.3 us,  7.9 sy,  0.0 ni, 84.2 id,  0.0 wa,  0.0 hi,  2.6 si,  0.0 s
MiB Mem :   7863.3 total,    230.4 free,   3847.2 used,   3785.8 buff&#47;cache
MiB Swap:   8192.0 total,   8191.5 free,      0.5 used.   3191.1 avail Mem 
```
zombieæ•°é‚£ä¹ˆé«˜æ˜¯å› ä¸ºè¿™ä¸ª docker container å·²ç»è¿è¡Œ20å¤šåˆ†é’Ÿäº†ã€‚

ä¾›å¤§å®¶å‚è€ƒ:)</div>2018-12-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/13/52/db1b01fc.jpg" width="30px"><span>ç™½å</span> ğŸ‘ï¼ˆ73ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<div>è€å¸ˆä»¥åçš„æ¡ˆä¾‹èƒ½ä¸èƒ½ä½¿ç”¨centos7ç³»ç»Ÿè¿›è¡Œæ“ä½œï¼Ÿåšçš„å¾ˆå¤šå®éªŒå’Œä½ çš„éƒ½ä¼šæœ‰éƒ¨åˆ†åå·®ï¼Œè¿™æ¬¡åå·®æ›´å¤§ï¼Œç›¸ä¿¡å­¦ä¹ ä½ è¯¾ç¨‹çš„å¤§éƒ¨åˆ†éƒ½æ˜¯ç”¨è™šæ‹Ÿæœºè·‘çš„é¡¹ç›®ï¼Œç”¨centosç³»ç»Ÿä½¿ç”¨ç‡ä¼šå¾ˆé«˜ï¼Œè€Œä¸”å®é™…ç”Ÿäº§ä¸­ç”¨centosç³»ç»Ÿè‚¯å®šå¤§äºUbuntuï¼Œé€ æˆçš„å®éªŒåå·®ä¼šä¸ä¼šä¹Ÿæ˜¯ç³»ç»Ÿçš„åŸå› ã€‚æˆ‘ä¹Ÿé‡åˆ°äº†æ²¡æœ‰å‡ºç°DçŠ¶æ€çš„è¿›ç¨‹ï¼Œå‡ºç°äº†å¤§é‡Zè¿›ç¨‹ã€‚å¹³å‡è´Ÿè½½å¹¶æ²¡æœ‰æå‡ï¼Œåè€Œæ˜¯ä¸‹é™äº†ã€‚iowaitå¹¶æ²¡æœ‰å˜åŒ–ã€‚æ‰€ä»¥æ³è¯·æ‚¨ä½¿ç”¨centosç³»ç»Ÿæ¥æ•™å­¦å§</div>2018-12-05</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/ib8rSTG2Kln7m4M10qpb6ehPaWsA3dsib5OBsMDyol1QuwS6JiaBFJ6a2omytoS4QvLCHIw291IzBYrmj3W1gdNmA/132" width="30px"><span>ä¸å…†é¹</span> ğŸ‘ï¼ˆ34ï¼‰ ğŸ’¬ï¼ˆ8ï¼‰<div>centos7 ä¸­æ¨¡æ‹Ÿä¸€ä¸‹ä¸€èµ·dockerä¸­æ— æ³•å¯åŠ¨app
 docker ps -a
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                     PORTS               NAMES
54a43bfd9ddb        feisky&#47;app:iowait   &quot;&#47;app&quot;              7 seconds ago       Exited (1) 6 seconds ago                       app

docker logs appä¹Ÿä¸ºç©ºã€‚

æ—¢ç„¶æ˜¯cç¨‹åºï¼Œä½¿ç”¨gdbè°ƒè¯•ï¼Œå‘ç°åœ¨select_disk()

	const char *sd_prefix = &quot;sd&quot;;
	const char *xvd_prefix = &quot;xvd&quot;;
...
		if (strncmp(sd_prefix, entry-&gt;d_name, 2) == 0 || strncmp(xvd_prefix, entry-&gt;d_name, 3) == 0)

çœ‹çœ‹æœºå™¨ä¸Šç£ç›˜æ ¼å¼å¦‚ä¸‹ï¼š
df -h
Filesystem      Size  Used Avail Use% Mounted on
&#47;dev&#47;vda1        99G   16G   79G  17% &#47;
&#47;dev&#47;vdb1        99G  5.5G   88G   6% &#47;data1

æ‰¾åˆ°åŸå› äº†,ç£ç›˜å‰ç¼€ä¸åŒï¼Œæ— æ³•æ‰¾åˆ°çš„ç›˜ï¼Œä¿®æ”¹app.cä»£ç 
        const char *sd_prefix = &quot;vd&quot;;
        const char *xvd_prefix = &quot;vdb&quot;;

ç„¶åå°±å¯ä»¥æ­£å¸¸å¯åŠ¨äº†ã€‚
docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
ceb6eec8129a        feisky&#47;app:iowait   &quot;&#47;app&quot;              2 seconds ago       Up 1 second                             app</div>2018-12-17</li><br/><li><img src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIPs72cLhiaib6m4jO15AVuYicMs8ZQxm8nuxA4Ml3Sic1W81ROJK7Pa3Fj56wGX6gstzDQkDyuyKW0aA/0" width="30px"><span>é»„æ¶›</span> ğŸ‘ï¼ˆ13ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>æˆ‘æ˜¯centOSï¼Œä¹Ÿæ˜¯æ— æ³•å¯åŠ¨ï¼Œå‚è€ƒè¯„è®ºä¸­çš„æ–¹å¼ï¼Œä¿®æ”¹å¯åŠ¨å‚æ•°ä¸ºï¼š
docker run --privileged --name=app -itd feisky&#47;app:iowait &#47;app -d &#47;dev&#47;vdb1
å°±å¯ä»¥äº†</div>2019-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/58/25/2088864b.jpg" width="30px"><span>æ—è´»æ°‘</span> ğŸ‘ï¼ˆ13ï¼‰ ğŸ’¬ï¼ˆ5ï¼‰<div>è€å¸ˆæ‚¨å¥½ï¼Œæˆ‘æœ‰ä¸ªç–‘æƒ‘ï¼šä¸å¯ä¸­æ–­çŠ¶æ€ç¡çœ ä¸èƒ½è¢«å…¶ä»–è¿›ç¨‹æˆ–è€…ä¸­æ–­æ‰“æ–­ï¼Œé‚£ç…§é“ç†è¯´å¦‚æœä¸å¯ä¸­æ–­è¿›ç¨‹å¾ˆå¤šï¼ˆè¶…è¿‡CPUï¼‰é€»è¾‘æ ¸æ•°æ—¶ï¼Œç³»ç»Ÿåº”è¯¥å¤„äºå¡æ­»çŠ¶æ€ï¼Œå¯æ˜¯å®é™…ä¸Šå¹¶ä¸æ˜¯è¿™æ ·çš„ï¼Œå…¶ä»–è¿›ç¨‹ç…§æ ·åœ¨æ‰§è¡Œï¼Œè¯´æ˜æ˜¯å­˜åœ¨è¿›ç¨‹è°ƒåº¦ï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨é‡è°ƒåº¦ä¸­æ–­ï¼Œé”®ç›˜è¾“å…¥ä¹Ÿæœ‰å“åº”ï¼Œè¯´æ˜ä¹Ÿå­˜åœ¨ç¡¬ä»¶ä¸­æ–­ï¼Œè¿™ä¸ªä¼¼ä¹å’Œä¸å¯ä¸­æ–­è¿›ç¨‹çŠ¶æ€è¿›ç¨‹çš„ä¸å¯ä¸­æ–­äº§ç”Ÿäº†å†²çªï¼Ÿæ˜¯æˆ‘æœ‰ä»€ä¹ˆåœ°æ–¹ç†è§£é”™äº†å—ï¼Ÿ</div>2019-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9a/f5/71eee10b.jpg" width="30px"><span>æ·±è“</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>åŒé—®ï¼Œå…³äºUninterruptible sleep(D)çŠ¶æ€
çš„è¿›ç¨‹å¦‚ä½•æœ‰æ•ˆçš„å¤„ç†ï¼Œä»¥å‰è¿ç»´çš„æ—¶å€™é‡åˆ°è¿‡ï¼Œè²Œä¼¼åªèƒ½é‡å¯æœºå™¨ï¼Œä¸çŸ¥é“è¿˜æœ‰ä»€ä¹ˆæ›´å¥½çš„åŠæ³•</div>2018-12-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/12/04/5837b21c.jpg" width="30px"><span>Brownç¾Šç¾Š</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>æ²¡æœ‰æ¨¡æ‹Ÿå‡ºæ¥ç³»ç»ŸI&#47;Oç“¶é¢ˆï¼Œå¯ä»¥å¸®å¿™çœ‹ä¸‹å—ï¼š
å®¹å™¨è¿è¡Œèµ·æ¥ååªå‘ç°ä¸€ä¸ªappè¿›ç¨‹
[root@liyang2 ~]# ps aux|grep &#47;app
root     23619  0.0  0.0   4368   380 pts&#47;0    Ss+  17:12   0:00 &#47;app
root     23777  0.0  0.0 112648   952 pts&#47;0    S+   17:12   0:00 grep --color=auto &#47;app

CPUæƒ…å†µ  waä¹Ÿæ²¡æœ‰å¾ˆé«˜
%Cpu(s):  1.0 us,  1.5 sy,  0.0 ni, 94.0 id,  3.3 wa,  0.0 hi,  0.2 si,  0.0 st

ç³»ç»Ÿï¼šredhat7  3.10.0-327.el7.x86_64 x86_64 GNU&#47;Linux  </div>2018-12-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/1b/82/69581d8a.jpg" width="30px"><span>å§œå°é±¼</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>è¿™ä¸ªæ¡ˆä¾‹çš„iowaitæ¯”è¾ƒé«˜ï¼Œä½†æ˜¯å¹¶ä¸å½±å“cpuä½¿ç”¨ç‡ã€‚å› ä¸ºå‡†ç¡®æ¥è¯´ï¼Œiowaitä¹Ÿæ˜¯å±äºcpu idleçŠ¶æ€çš„ä¸€éƒ¨åˆ†ï¼Œä»–å’Œåƒµå°¸è¿›ç¨‹å½±å“çš„åªæ˜¯å¹³å‡è´Ÿè½½å’Œç³»ç»Ÿèµ„æº</div>2018-12-05</li><br/><li><img src="" width="30px"><span>Xg huang</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è¯·æ•™ä¸€ä¸‹è€å¸ˆï¼Œä¸€èˆ¬åœ¨å†™ä»£ç è®¿é—®ioçš„æ—¶å€™ï¼Œæ˜¯ä¸å¯ä¸­æ–­è¿˜æ˜¯å¯ä¸­æ–­ï¼Ÿ</div>2019-01-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/e8/45/c58cb283.jpg" width="30px"><span>å¸†å¸†å¸†å¸†å¸†å¸†å¸†å¸†</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æœ‰ä¸€ä¸ªé—®é¢˜æ²¡æœ‰æƒ³æ˜ç™½ï¼š
å¹³å‡è´Ÿè½½æ˜¯æŒ‡å•ä½æ—¶é—´å†…ï¼Œç³»ç»Ÿå¤„äºå¯è¿è¡ŒçŠ¶æ€å’Œä¸å¯ä¸­æ–­çŠ¶æ€çš„å¹³å‡è¿›ç¨‹æ•°ï¼Œå’Œ CPU ä½¿ç”¨ç‡å¹¶æ²¡æœ‰ç›´æ¥å…³ç³»ã€‚æ¯”å¦‚ä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹å¤šäº†ï¼ˆIOç¹å¿™ï¼‰ï¼Œå¹³å‡è´Ÿè½½ä¼šå‡é«˜ï¼Œä½†æ­¤æ—¶cpuä½¿ç”¨ç‡å¹¶ä¸é«˜ã€‚ä½†é—®é¢˜æ˜¯CPUä½¿ç”¨ç‡=1-ç©ºé—²æ—¶é—´&#47;æ€»CPUæ—¶é—´ï¼ŒIOç¹å¿™ï¼Œé‚£è¿›ç¨‹iowaitå°±åº”è¯¥å¾ˆé«˜ï¼Œæ­¤æ—¶CPUä½¿ç”¨ç‡ä¹Ÿåº”è¯¥å¾ˆé«˜å‘€ã€‚å’Œå‰é¢çš„åˆ†æä¸ä¸€è‡´å‘¢ã€‚æ±‚è§£ç­”ã€‚
</div>2018-12-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/dd/a2/8277208d.jpg" width="30px"><span>è¶…</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è¿‘æ—¥åˆšç¢°åˆ°ä¸€å¥—ç”Ÿäº§ç³»ç»Ÿå‡ºé—®é¢˜ï¼Œæˆ‘ä»¬é€»è¾‘cpuæ˜¯120çš„å®ä½“æœºï¼Œè·‘oracleæ•°æ®åº“ï¼Œä¸šåŠ¡åˆšæ¥è¿›æ¥å°±å¡æ­»äº†ï¼Œä¸€åˆ†é’Ÿå¹³å‡è´Ÿè½½200å¤šï¼Œè¿è¡Œé˜Ÿåˆ—ä¹Ÿä¸¤ç™¾å¤šï¼Œcpuçš„usréƒ¨åˆ†å››äº”åï¼Œsyséƒ¨åˆ†å››åå·¦å³ï¼ŒiowaitåŸºæœ¬æ˜¯é›¶ï¼Œidleä¸ªä½æ•°ï¼Œtopå’Œpidstatéƒ½æ— æ³•è¾“å‡ºï¼Œperftopä¹Ÿæ— æ³•ï¼Œåªèƒ½dstatã€‚è¯·è€å¸ˆæŒ‡å¯¼ä¸‹æ€è·¯ï¼Œåœ¨æŸ¥åˆ°åº•ä»€ä¹ˆé—®é¢˜ã€‚</div>2018-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/62/d7/5bfdecf2.jpg" width="30px"><span>chenæ³½æ—Â¹âµâ¶Â²â¶Â¹â¸â·Â³Â³â¹</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>å®‰è£…dstatåå‡ºç°except getopt.error, excã€‚
dstatå·¥å…·æ”¯æŒpython2 ï¼Œå¯èƒ½ç³»ç»Ÿå®‰è£…äº†python3ã€‚ 
å¦‚æœå®‰è£…äº†python2å’Œ3çš„è¯ï¼Œå¯ä»¥ç”¨
ä½¿ç”¨ &#47;usr&#47;bin&#47;python2 &#47;usr&#47;bin&#47;dstat</div>2019-06-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/41/af/4307867a.jpg" width="30px"><span>JJj</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œä½ å¥½ï¼Œiowaitæ˜¯ä¸æ˜¯å¯ä»¥è®¤ä¸ºæœ‰IOæ€§èƒ½é—®é¢˜ï¼Œioçš„æ“ä½œéœ€è¦ç³»ç»Ÿè°ƒç”¨å§ï¼Œæ¯”å¦‚writeï¼Œreadï¼Œå¯¹åº”sys CPUæ˜¯ä¸æ˜¯ä¼šé«˜ï¼Ÿ</div>2019-03-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/65/ae/9727318e.jpg" width="30px"><span>Boy-struggle</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>RçŠ¶æ€æ˜¯ä¸å¯å±è”½çŠ¶æ€å˜›ï¼Ÿé•¿æ—¶é—´å…³é—­ä¸­æ–­ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</div>2019-03-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/93/43/0e84492d.jpg" width="30px"><span>Maxwell</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ä¸ºä»€ä¹ˆç”¨topå‘½ä»¤èƒ½æŸ¥çœ‹åˆ°appçš„è¿›ç¨‹ä¸ºZçŠ¶æ€ï¼Œä½†æ˜¯ps aux|grep &#47;app ,çŠ¶æ€å´ä¸æ˜¯ZçŠ¶æ€å‘¢ï¼Ÿ
topè¾“å‡ºï¼š
109341 root      20   0       0      0      0 Z   9.8  0.0   0:00.30 app                         
109342 root      20   0       0      0      0 Z   8.9  0.0   0:00.27 app 
ä½¿ç”¨ps aux|grep &#47;app:
root     108152  0.0  0.0   4512  1600 pts&#47;0    Ss+  16:22   0:00 &#47;app
root     109364  0.0  0.0  21536  1048 pts&#47;1    S+   17:06   0:00 grep --color=auto &#47;app</div>2019-02-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/4c/c8/bed1e08a.jpg" width="30px"><span>è¾£æ¤’</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è¯„è®ºé‡Œæ˜¯é«˜æ‰‹è¾ˆå‡ºå•Šï¼Œä¸¤ä¸ªé—®é¢˜éƒ½æ˜¯çœ‹è¯„è®ºåŒºçš„è¯„è®ºéƒ½è§£å†³äº†</div>2019-01-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/0f/53/92a50f01.jpg" width="30px"><span>å¾æ´²æ›´</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>å…³äºä¸å¯ä¸­æ–­çš„IOè´Ÿè·å¯¼è‡´æœåŠ¡å™¨æ€§èƒ½æé«˜ï¼Œè¿™ä¸¤å¤©åˆšå¥½æœ‰äº†ä¸€ä¸ªå®æˆ˜æœºä¼š

https:&#47;&#47;www.jianshu.com&#47;p&#47;d7edbff7dda6</div>2018-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/ec/1a/ef9d89ef.jpg" width="30px"><span>é¾™î“î”¤</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>docker run --privileged --name=app --device &#47;dev&#47;sda5:&#47;dev&#47;sda5 --device-write-iops &#47;dev&#47;sda5:3 --device-read-iops &#47;dev&#47;sda5:3 -itd feisky&#47;app:iowait
æŠ¥é”™ï¼š
   &#47;usr&#47;bin&#47;docker-current: Error response from daemon: oci runtime error: container_linux.go:247: starting container process caused &quot;process_linux.go:327: setting cgroup config for procHooks process caused \&quot;failed to write 8:5 3 to blkio.throttle.read_iops_device: write &#47;sys&#47;fs&#47;cgroup&#47;blkio&#47;system.slice&#47;docker-92e10bae59a6520ef090c08f6718396497edcdc4abaace7d820afb566ac5e41a.scope&#47;blkio.throttle.read_iops_device: invalid argument\&quot;&quot;.
è°çŸ¥é“è¿™æ˜¯å•¥åŸå› å—ï¼Ÿ</div>2018-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/3d/ad/bee0df03.jpg" width="30px"><span>wing</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>centos7,docker é•œåƒæ— æ³•æ­£å¸¸å¯åŠ¨ã€‚
feisky&#47;app:iowait     &quot;&#47;app&quot;                   7 minutes ago       Exited (1) 7 minutes ago </div>2018-12-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/3b/c6/5954cbb7.jpg" width="30px"><span>#</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>#man top    
   20. S  --  Process Status
           The status of the task which can be one of:
               D = uninterruptible sleep
               R = running
               S = sleeping
               T = stopped by job control signal
               t = stopped by debugger during trace
               Z = zombie
#man ps
PROCESS STATE CODES
       Here are the different values that the s, stat and state output specifiers (header &quot;STAT&quot; or &quot;S&quot;) will display to describe the state of a process:

               D    uninterruptible sleep (usually IO)
               R    running or runnable (on run queue)
               S    interruptible sleep (waiting for an event to complete)
               T    stopped by job control signal
               t    stopped by debugger during the tracing
               W    paging (not valid since the 2.6.xx kernel)
               X    dead (should never be seen)
               Z    defunct (&quot;zombie&quot;) process, terminated but not reaped by its parent

       For BSD formats and when the stat keyword is used, additional characters may be displayed:

               &lt;    high-priority (not nice to other users)
               N    low-priority (nice to other users)
               L    has pages locked into memory (for real-time and custom IO)
               s    is a session leader
               l    is multi-threaded (using CLONE_THREAD, like NPTL pthreads do)
               +    is in the foreground process group
åœ¨ubuntuå’Œcentoséƒ½æ²¡çœ‹åˆ°idelçŠ¶æ€ï¼Œæ˜¯å†…æ ¸è¿˜æ˜¯ç‰ˆæœ¬é—®é¢˜å‘¢ï¼Ÿ</div>2018-12-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg" width="30px"><span>æˆ‘æ¥ä¹Ÿ</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>[D7æ‰“å¡]
ç³»ç»Ÿç¯å¢ƒ: ubuntu 18.04è™šæ‹Ÿæœº 4cpu 6Gå†…å­˜.
å¯åŠ¨dockeråè§‚æµ‹åˆ°çš„æ•°æ®å¦‚ä¸‹:
# ps aux | grep &#47;app
root      2134  0.0  0.0   4376  1044 pts&#47;0    Ss+  14:07   0:00 &#47;app
# ps aux | grep app
root      2134  0.0  0.0   4376  1044 pts&#47;0    Ss+  14:07   0:00 &#47;app
root      2189  0.0  0.0      0     0 pts&#47;0    Z+   14:07   0:00 [app] &lt;defunct&gt;
...
# top -d1
top - 14:39:41 up  2:46,  5 users,  load average: 0.03, 0.07, 0.26
ä»»åŠ¡: 1065 total,   1 running, 231 sleeping,   0 stopped, 781 zombie
%Cpu(s):  0.0 us,  3.0 sy,  0.0 ni, 97.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  6098388 total,  2850004 free,  1182712 used,  2065672 buff&#47;cache
#  pidstat -wut -p 2134 1
 cswch&#47;s nvcswch&#47;s åˆ‡æ¢æ¬¡æ•°æä½,å‡ ä¹ä¸º0.
# vmstat 1 11
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b äº¤æ¢ ç©ºé—² ç¼“å†² ç¼“å­˜   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 2852420 203804 1861316    0    0     0     0  333  588  0  1 99  0  0
åŒä¸Š
åŒä¸Š
 0  0      0 2851176 203804 1861412    0    0 131072     0  598  923  1  4 94  2  0
 0  0      0 2850644 203804 1861444    0    0     0     0  438  759  1  1 98  0  0
åŒä¸Š
åŒä¸Š
åŒä¸Š
 0  0      0 2849548 203812 1861388    0    0 131072     0  502  827  0  3 96  1  0
[å‡ ä¹æ¯5ç§’æœ‰ä¸€æ¬¡biå‡é«˜, ä¸”ä¼´éšç€topä¸­zombieå¢åŠ 2ä¸ª.]
# pstree | grep app
        |-dockerd-+-docker-containe-+-docker-containe-+-app---1082*[app]
[å†æ¬¡è¯´æ˜åƒµå°¸è¿›ç¨‹æ˜¯appäº§ç”Ÿçš„]
# perf top -g -p 2134
-   96.67%     0.00%  app      app                [.] main
   - main
      - 86.67% read
           entry_SYSCALL_64_after_hwframe
           do_syscall_64
           sys_read
           vfs_read
           __vfs_read
           new_sync_read
           blkdev_read_iter
           generic_file_read_iter
         - blkdev_direct_IO
            - 72.00% bio_iov_iter_get_pages
                 iov_iter_get_pages
               + get_user_pages_fast
[samplesæ•°ä¸å¤š å¯èƒ½å‚è€ƒæ„ä¹‰ä¸å¤§]
# docker exec -ti app &#47;bin&#47;bash
-rwxr-xr-x    1 root root 13040 Oct 10 07:06 app*
[åªæœ‰å¯æ‰§è¡Œç¨‹åº]
ä¸ªäººæ€»ç»“:è™½ç„¶çŸ¥é“æ˜¯appè¿›ç¨‹å¯¼è‡´çš„,ä¸”å‡ ä¹ä»¥å›ºå®šé¢‘ç‡5så¤šå‡º2ä¸ªåƒµå°¸è¿›ç¨‹.å„é¡¹æŒ‡æ ‡ä¹Ÿç®—æ­£å¸¸,å¹¶æœªæœ‰iowaitå‡é«˜çš„çŠ¶å†µ.å¹¶ä¸çŸ¥é“è¿›ä¸€æ­¥è¯¥å¦‚ä½•åˆ†æäº†</div>2018-12-05</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEL5xnfuicbtRz4F87AAjZX6oCEjMtYiaIu4iaQichQmy0vEBA6Sumic1RDvUCeuBEqj6iatnt2kENbKYmuw/132" width="30px"><span>dexter</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æˆ‘è™šæ‹Ÿæœºæ˜¯reht6.5ï¼Œè¿™å‡ å¤©ç”¨yumå®‰è£…dockerï¼Œä¸€è‡´æ‰¾ä¸åˆ°dockeråŒ…ï¼ˆå…¶ä»–ç¨‹åºå¯ä»¥yumï¼‰ï¼Œä¸çŸ¥é“dockerå®‰è£…æ˜¯åœ¨å“ªä¸ªåº“é‡Œé¢ï¼Œè¿™2å¤©çš„å®éªŒè¿˜æ²¡æœ‰åš</div>2018-12-05</li><br/><li><img src="" width="30px"><span>æ— åè€å’</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>å°†è¯»å†™çš„iopséƒ½é™åˆ¶åœ¨3ï¼š
```bash
root@fdm:~# docker run --privileged --name app2 --device &#47;dev&#47;sda:&#47;dev&#47;sda --device-write-iops &#47;dev&#47;sda:3 --device-read-iops &#47;dev&#47;sda:3 -itd feisky&#47;app:iowait 
c7befa77604a55ac41d31ef6328f4664d544fe4559f5609217c309eae188ffc5
```

æŸ¥çœ‹topï¼Œè´Ÿè½½å·²ç»ä¸Šå»äº†ï¼ŒåŒæ—¶iowaitä¹Ÿåœ¨99%äº†ã€‚

```
top - 14:21:06 up 9 days, 12:36,  9 users,  load average: 148.06, 80.83, 34.35
Tasks: 360 total,   1 running, 283 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.0 us,  0.5 sy,  0.0 ni,  0.0 id, 99.5 wa,  0.0 hi,  0.0 si,  0.0 st
```
ä½¿ç”¨pidstatæ˜¯å¯ä»¥çœ‹åˆ°æ˜¯app è¿™ä¸ªç¨‹åºå¯¼è‡´çš„

```
root@fdm:~# pidstat -d 5 5
...

02:21:01 PM   UID       PID   kB_rd&#47;s   kB_wr&#47;s kB_ccwr&#47;s iodelay  Command
02:21:06 PM     0     74213  13081.04      0.00      0.00   36966  app
02:21:06 PM     0     74214  13081.04      0.00      0.00   37121  app

root@fdm:~# iostat -d -x 5 5 sda

Device            r&#47;s     w&#47;s     rkB&#47;s     wkB&#47;s   rrqm&#47;s   wrqm&#47;s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util
sda              5.39    0.00   3679.04      0.00     0.00     0.00   0.00   0.00    1.78    0.00   0.00   682.67     0.00   0.89   0.48

Device            r&#47;s     w&#47;s     rkB&#47;s     wkB&#47;s   rrqm&#47;s   wrqm&#47;s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util
sda              5.40    0.00   3686.40      0.00     0.00     0.00   0.00   0.00    0.89    0.00   0.00   682.67     0.00   0.44   0.24

Device            r&#47;s     w&#47;s     rkB&#47;s     wkB&#47;s   rrqm&#47;s   wrqm&#47;s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util
sda              6.00    0.00   4096.00      0.00     0.00     0.00   0.00   0.00    3.07    0.00   0.01   682.67     0.00   1.07   0.64
```
ä½†æ˜¯ä½¿ç”¨äº†é™åˆ¶IOæ—¶ï¼Œå°±å‘ç°äº†ä¸€äº›é—®é¢˜ï¼šä¸€æ˜¯è¿è¡Œäº†å¾ˆä¹…ï¼Œä½†æ˜¯åƒµå°¸è¿›ç¨‹æ²¡æœ‰æ¶¨ä¸€ä¸ªï¼Œä½†æ˜¯è´Ÿè½½å°±ä¸Šå»äº†ï¼›äºŒæ˜¯çœ‹è´Ÿè½½ä¸Šå»çš„åŸå› æ˜¯waçš„å ç”¨ç‡ä¸Šå»äº†ï¼Œä½†ä½¿ç”¨iostatçœ‹ç£ç›˜ä½¿ç”¨ç‡è¿˜æ˜¯æ’æ­£å¸¸çš„ï¼›ä¸‰æ˜¯ä¸ºä»€ä¹ˆé™åˆ¶äº†å®¹å™¨ä½¿ç”¨çš„ioé‡ï¼Œä½†è¿˜æ˜¯å¯¼è‡´å®¿ä¸»æœºçš„è´Ÿè½½å‡é«˜è¿™ä¹ˆå¤šï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿè¯·è€å¸ˆæŒ‡ç‚¹ä¸€ä¸‹ã€‚</div>2019-04-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/e1/21/5f0bf9a0.jpg" width="30px"><span>é˜¿æ–‡</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>root@linux:~# docker ps -a
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                     PORTS               NAMES
73e18b629c09        feisky&#47;app:iowait   &quot;&#47;app&quot;              7 seconds ago       Exited (1) 5 seconds ago                       app</div>2019-03-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg" width="30px"><span>ç‹ç››æ­¦</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>å€ªè€å¸ˆï¼Œè¯·é—®ä¸Šä¸€èŠ‚å®éªŒé‡Œçš„dockeré•œåƒæœ‰æ²¡ä¸‹è½½ä»“åº“æˆ–è€…ä¸‹è½½åœ°å€ï¼Ÿè°¢è°¢</div>2019-03-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/65/ae/9727318e.jpg" width="30px"><span>Boy-struggle</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è¿™é‡Œçš„IOæŒ‡çš„æ˜¯ç¡¬ç›˜ioè¿˜æ˜¯cpuæ€»çº¿IO?</div>2019-03-05</li><br/><li><img src="" width="30px"><span>å…ƒå¤©å¤«</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è¡¥å¡ï¼Œå›å¤´çœ‹æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯å¯ä»¥çœ‹çœ‹å¤§å®¶çš„ç•™è¨€ï¼Œè¯„è®ºä¸­ä¹Ÿå¯ä»¥å—ç›ŠåŒªæµ…å•Š</div>2019-02-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/93/43/0e84492d.jpg" width="30px"><span>Maxwell</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œæœ‰ä¸‰ä¸ªé—®é¢˜ï¼š
1.è¿è¡Œps aux|grep &#47;appï¼Œå¹¶æ²¡æœ‰å‡ºç°DçŠ¶æ€çš„è¿›ç¨‹ï¼Œæˆ‘çš„æ˜¯ï¼š
root     108152  0.0  0.0   4512  1600 pts&#47;0    Ss+  16:22   0:00 &#47;app
root     108938  0.0  0.0  21536  1076 pts&#47;1    S+   16:51   0:00 grep --color=auto &#47;app
æˆ‘çš„ç¡¬ä»¶é…ç½®CPUä¸ºå››æ ¸(E2 1230 V2,é€»è¾‘å››æ ¸)ï¼Œåº”è¯¥æ¯”ä½ çš„é…ç½®ç•¥é«˜ï¼Œæ˜¯å¦æ˜¯ç¡¬ä»¶æ–¹é¢çš„é—®é¢˜

2.è¿è¡Œæ¡ˆä¾‹ä¸­ï¼Œä½¿ç”¨vmstat æŸ¥çœ‹å¹¶æ²¡æœ‰å‘ç°iowaitå‡é«˜ï¼Œæ˜¯å¦å’Œæˆ‘çš„ç£ç›˜æœ‰å…³?(æˆ‘ä½¿ç”¨çš„æ˜¯SATA SSDï¼Œä½ç«¯å›ºæ€)
3.topä¸­æŸ¥çœ‹çš„waitåº”è¯¥ä¸æ˜¯iowait å§ï¼Œè¿™ä¸ªå’Œvmstat ä¸­çš„waitåº”è¯¥ä¸æ˜¯ä¸€ä¸ªæ„æ€å§ï¼Ÿ</div>2019-02-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/98/12/a169bdcd.jpg" width="30px"><span>Geek_477c02</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>é‡åˆ°æœ‰å¤§é‡çš„DçŠ¶æ€çš„è¿›ç¨‹ï¼Œå¯¼è‡´è´Ÿè½½åˆ°7000å¤šï¼Œä½†æ˜¯cpuå’Œiowaitéƒ½ä¸é«˜ï¼Œé™¤äº†é‡å¯è®¾å¤‡è¿˜æœ‰ä»€ä¹ˆåŠæ³•è§£å†³ï¼Ÿ</div>2019-02-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/48/d7/8b69bf21.jpg" width="30px"><span>è¯·å«æˆ‘å°å¼º</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ä¸çŸ¥é“æœ‰æ²¡æœ‰åŒå­¦ç¢°åˆ°è¿™ä¸ªé—®é¢˜ï¼šåœ¨ä½¿ç”¨ make build çš„æ—¶å€™å‡ºç°æ— æ³•è®¤è¯çš„é”™è¯¯ã€‚
gcc -o app app.c
docker build -t feisky&#47;app:iowait -f Dockerfile .
Sending build context to Docker daemon 30.72 kB
Step 1&#47;4 : FROM ubuntu
Get https:&#47;&#47;registry-1.docker.io&#47;v2&#47;: x509: certificate signed by unknown authority
make: *** [build] Error 1

è¿™ä¸ªé—®é¢˜å¯ä»¥å°è¯•åœ¨ Dockerfile æ–‡ä»¶ä¸­æŠŠ FROM ubuntu ä¿®æ”¹æˆ FROM daocloud.io&#47;ubuntu æ¥è§£å†³ã€‚

</div>2019-01-09</li><br/>
</ul>