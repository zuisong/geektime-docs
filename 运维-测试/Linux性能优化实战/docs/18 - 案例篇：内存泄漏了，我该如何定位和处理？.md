ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚

é€šè¿‡å‰å‡ èŠ‚å¯¹å†…å­˜åŸºç¡€çš„å­¦ä¹ ï¼Œæˆ‘ç›¸ä¿¡ä½ å¯¹ Linux å†…å­˜çš„å·¥ä½œåŸç†ï¼Œå·²ç»æœ‰äº†åˆæ­¥äº†è§£ã€‚

å¯¹æ™®é€šè¿›ç¨‹æ¥è¯´ï¼Œèƒ½çœ‹åˆ°çš„å…¶å®æ˜¯å†…æ ¸æä¾›çš„è™šæ‹Ÿå†…å­˜ï¼Œè¿™äº›è™šæ‹Ÿå†…å­˜è¿˜éœ€è¦é€šè¿‡é¡µè¡¨ï¼Œç”±ç³»ç»Ÿæ˜ å°„ä¸ºç‰©ç†å†…å­˜ã€‚

å½“è¿›ç¨‹é€šè¿‡ malloc() ç”³è¯·è™šæ‹Ÿå†…å­˜åï¼Œç³»ç»Ÿå¹¶ä¸ä¼šç«‹å³ä¸ºå…¶åˆ†é…ç‰©ç†å†…å­˜ï¼Œè€Œæ˜¯åœ¨é¦–æ¬¡è®¿é—®æ—¶ï¼Œæ‰é€šè¿‡ç¼ºé¡µå¼‚å¸¸é™·å…¥å†…æ ¸ä¸­åˆ†é…å†…å­˜ã€‚

ä¸ºäº†åè°ƒ CPU ä¸ç£ç›˜é—´çš„æ€§èƒ½å·®å¼‚ï¼ŒLinux è¿˜ä¼šä½¿ç”¨ Cache å’Œ Buffer ï¼Œåˆ†åˆ«æŠŠæ–‡ä»¶å’Œç£ç›˜è¯»å†™çš„æ•°æ®ç¼“å­˜åˆ°å†…å­˜ä¸­ã€‚

å¯¹åº”ç”¨ç¨‹åºæ¥è¯´ï¼ŒåŠ¨æ€å†…å­˜çš„åˆ†é…å’Œå›æ”¶ï¼Œæ˜¯æ—¢æ ¸å¿ƒåˆå¤æ‚çš„ä¸€ä¸ªé€»è¾‘åŠŸèƒ½æ¨¡å—ã€‚ç®¡ç†å†…å­˜çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿå¾ˆå®¹æ˜“å‘ç”Ÿå„ç§å„æ ·çš„â€œäº‹æ•…â€ï¼Œæ¯”å¦‚ï¼Œ

- æ²¡æ­£ç¡®å›æ”¶åˆ†é…åçš„å†…å­˜ï¼Œå¯¼è‡´äº†æ³„æ¼ã€‚
- è®¿é—®çš„æ˜¯å·²åˆ†é…å†…å­˜è¾¹ç•Œå¤–çš„åœ°å€ï¼Œå¯¼è‡´ç¨‹åºå¼‚å¸¸é€€å‡ºï¼Œç­‰ç­‰ã€‚

ä»Šå¤©æˆ‘å°±å¸¦ä½ æ¥çœ‹çœ‹ï¼Œå†…å­˜æ³„æ¼åˆ°åº•æ˜¯æ€ä¹ˆå‘ç”Ÿçš„ï¼Œä»¥åŠå‘ç”Ÿå†…å­˜æ³„æ¼ä¹‹åè¯¥å¦‚ä½•æ’æŸ¥å’Œå®šä½ã€‚

è¯´èµ·å†…å­˜æ³„æ¼ï¼Œè¿™å°±è¦å…ˆä»å†…å­˜çš„åˆ†é…å’Œå›æ”¶è¯´èµ·äº†ã€‚

## å†…å­˜çš„åˆ†é…å’Œå›æ”¶

å…ˆå›é¡¾ä¸€ä¸‹ï¼Œä½ è¿˜è®°å¾—åº”ç”¨ç¨‹åºä¸­ï¼Œéƒ½æœ‰å“ªäº›æ–¹æ³•æ¥åˆ†é…å†…å­˜å—ï¼Ÿç”¨å®Œåï¼Œåˆè¯¥æ€ä¹ˆé‡Šæ”¾è¿˜ç»™ç³»ç»Ÿå‘¢ï¼Ÿ

å‰é¢è®²è¿›ç¨‹çš„å†…å­˜ç©ºé—´æ—¶ï¼Œæˆ‘æ›¾ç»æåˆ°è¿‡ï¼Œç”¨æˆ·ç©ºé—´å†…å­˜åŒ…æ‹¬å¤šä¸ªä¸åŒçš„å†…å­˜æ®µï¼Œæ¯”å¦‚åªè¯»æ®µã€æ•°æ®æ®µã€å †ã€æ ˆä»¥åŠæ–‡ä»¶æ˜ å°„æ®µç­‰ã€‚è¿™äº›å†…å­˜æ®µæ­£æ˜¯åº”ç”¨ç¨‹åºä½¿ç”¨å†…å­˜çš„åŸºæœ¬æ–¹å¼ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ30ï¼‰</strong></div><ul>
<li><img src="" width="30px"><span>Scott</span> ğŸ‘ï¼ˆ62ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>æˆ‘æ¯”è¾ƒå…³å¿ƒè€ç‰ˆæœ¬çš„Linuxæ€ä¹ˆåšåŒæ ·çš„äº‹ï¼Œæ¯•ç«Ÿæ²¡æœ‰åŠæ³•å‡çº§å…¬å¸æœåŠ¡å™¨çš„å†…æ ¸ã€‚</div>2019-01-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/58/78/fe19274b.jpg" width="30px"><span>ç¡åœ¨åºŠæ¿ä¸‹</span> ğŸ‘ï¼ˆ41ï¼‰ ğŸ’¬ï¼ˆ9ï¼‰<div>è°ˆè°ˆè‡ªå·±ç”Ÿäº§ç¯å¢ƒè¿è¡Œ3ä¸ªæœˆçš„å†…å­˜æ³„éœ²ç»éªŒå§ï¼š
ç°è±¡ï¼šæœåŠ¡ç¨‹åºè¿è¡Œ90å¤©ï¼Œç›‘æ§ç³»ç»Ÿå‘Šè­¦å†…å­˜è¾¾åˆ°é˜ˆå€¼ï¼Œå†…å­˜æ³„æ¼800Mã€‚ç°å®ï¼šç”Ÿäº§ç¯å¢ƒã€éš¾å¤ç°ã€‚

- ä¿å­˜coreæ–‡ä»¶ã€‚ ç»Ÿè®¡top10 å¤§å°å—å†…å­˜åˆ†é…ç™¾åˆ†æ¯”

- å‘ç°20å­—èŠ‚å¤§å°å†…å­˜ç”³è¯·äº† 3700wæ¬¡ï¼Œå¤§æ¦‚700M

- é€šè¿‡å·¥å…·æœç´¢å·²æœ‰ç¬¦å·æ–‡ä»¶ä¸­å¤§å°ä¸º20å­—èŠ‚çš„ç»“æ„ä½“ã€ç±»ï¼Œä½†æ˜¯å¯èƒ½åŒ…å«ç¬¬ä¸‰æ–¹åº“ã€ç»„ä»¶æ²¡æœ‰ç¬¦å·æ–‡ä»¶ï¼Œå¯¼è‡´åˆ†æé‡é˜»ï¼Œæœªæœ

- é€šè¿‡éšæœºæŠ½æŸ¥20å­—èŠ‚å†…å­˜åœ°å€å†…å®¹ï¼Œå¸Œæœ›æ‰¾åˆ°æœ‰æ•ˆä¿¡æ¯ï¼Œä½†å‡ ä¹éƒ½æ˜¯ 0x00 0x10 0x00 ï¼Œ æ²¡å­—ç¬¦ä¸²ï¼ŒçŒœä¸å‡ºä»€ä¹ˆå†…å®¹ï¼Œæœªæœ

- é€šè¿‡3700wæ¬¡æ•°ç”³è¯·ï¼Œå¹³å‡æ¯å°æ—¶17000æ¬¡å·¦å³ã€‚ é€šè¿‡å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿï¼Œåˆ†æ1w~3wé‡çº§çš„æ¶ˆæ¯ï¼Œå¤§æ¦‚4ä¸ªï¼Œreviewä»£ç ï¼Œé—®é¢˜è§£å†³

- é—®é¢˜å®šä½æ€»å…±èŠ±è´¹äº†4ä¸ªå°æ—¶å·¦å³ã€‚åˆ†æå†…å­˜æ³„æ¼å·¥å…·ã€æ–¹æ³•å¾ˆå¤šï¼Œä½†æ˜¯æˆ‘è§‰çš„æ›´é‡è¦çš„æ˜¯å®Œå–„çš„ç›‘æ§ç³»ç»Ÿå’Œæ—¥å¿—ç³»ç»Ÿã€‚

</div>2020-07-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/93/43/0e84492d.jpg" width="30px"><span>Maxwell</span> ğŸ‘ï¼ˆ23ï¼‰ ğŸ’¬ï¼ˆ6ï¼‰<div>å¦‚æœæ˜¯javaåº”ç”¨ç¨‹åºï¼Œä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•å®šä½ä¹ˆï¼Ÿ</div>2019-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/99/27/47aa9dea.jpg" width="30px"><span>é˜¿å¡ç‰›</span> ğŸ‘ï¼ˆ12ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<div>è€å¸ˆï¼Œä½ è¿™ä¸ªä¾‹å­æ˜¯å·²ç»çŸ¥é“å“ªä¸ªè¿›ç¨‹æœ‰å†…å­˜æ³„éœ²äº†ï¼Œè¯·é—®å¦‚ä½•æ‰¾å‡ºå“ªä¸ªè¿›ç¨‹å‘¢ï¼Ÿ</div>2019-01-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/1b/82/69581d8a.jpg" width="30px"><span>å§œå°é±¼</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œmemleakåªèƒ½æ£€æµ‹ç”¨æˆ·ç¨‹åºçš„å†…å­˜æ³„æ¼å§ï¼Ÿå¦‚æœæ£€æµ‹å†…æ ¸æ€è°‹å’Œæ¨¡å—å†…å­˜æ³„æ¼å‘¢ï¼ŒKmemleakèƒ½å¦è®²ä¸€ä¸‹å‘¢ï¼Ÿ</div>2019-05-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/54/98/52ca7053.jpg" width="30px"><span>VickyğŸ£ğŸ£ğŸ£</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<div>1. å¦‚æœæ‰§è¡Œ&#47;usr&#47;share&#47;bcc&#47;tools&#47;memleak -a -p [pid] å°±ä¼šæŠ¥é”™Exception: Failed to attach BPF to uprobe
ä½†æ˜¯æ‰§è¡Œ&#47;usr&#47;share&#47;bcc&#47;tools&#47;memleak -aï¼Œå°±ä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯é‡Œé¢å¹¶æ²¡æœ‰å’Œappç›¸å…³å‡½æ•°
2. freeè§‚å¯Ÿæƒ…å†µå¦‚ä¸‹ï¼Œæ–°æœºå™¨ï¼Œå¹¶æ²¡æœ‰ä»»ä½•å…¶ä»–é«˜å ç”¨å†…å­˜çš„è¿›ç¨‹ï¼Œå¾ˆæ˜¯å¥‡æ€ª
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 218244 112044 463144    0    0    21    31  148  344  1  0 99  0  0
 0  0      0 218268 112044 463144    0    0     0     0  168  402  0  1 99  0  0
 0  0      0 217928 112044 463144    0    0     0     7  182  427  1  0 99  0  0
 0  0      0 217836 112044 463228    0    0    23     0  317  730  1  1 98  0  0
 0  0      0 217836 112048 463236    0    0     0    17  186  437  1  0 99  0  0
 0  0      0 215804 112052 463232    0    0     0    19  202  476  1  1 98  0  0
 0  0      0 215860 112052 463240    0    0     0     5  221  490  1  1 99  0  0
 0  0      0 217040 112056 463244    0    0     0    15  207  481  1  0 99  0  0
 0  0      0 217040 112056 463244    0    0     0     0  156  363  0  0 100  0  0
 0  0      0  76976 112056 463296    0    0    24    12  221  546 11  3 86  0  0
 0  0      0  77008 112060 463316    0    0     0    11  178  407  1  1 98  0  0
 0  0      0  75140 112060 463324    0    0     0    27  176  812  2  3 95  0  0
 0  0      0  74584 112060 463328    0    0     0     7  174  819  1  1 98  0  0
 0  0      0  74616 112060 463332    0    0     0     0  183  417  0  0 99  0  0
 0  0      0 216884 112060 463332    0    0     0    83  176  403  1  0 98  1  0
 0  0      0 216884 112064 463328    0    0     0     9  180  448  0  1 99  0  0
 0  0      0 217012 112064 463336    0    0     0     4  193  452  0  1 99  0  0
</div>2019-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/54/98/52ca7053.jpg" width="30px"><span>VickyğŸ£ğŸ£ğŸ£</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ5ï¼‰<div>è€å¸ˆï¼Œå¾ˆå¤šåŒå­¦éƒ½é—®è¿™ä¸ªé—®é¢˜äº†ï¼Œéº»çƒ¦è§£ç­”ä¸€ä¸‹å§
ubuntu 4.15.0-29
# &#47;usr&#47;share&#47;bcc&#47;tools&#47;memleak -a -p 21642
Attaching to pid 21642, Ctrl+C to quit.
perf_event_open(&#47;sys&#47;kernel&#47;debug&#47;tracing&#47;events&#47;uprobes&#47;p__lib_x86_64_linux_gnu_libc_2_27_so_0x97070_21642_bcc_21882&#47;id): Input&#47;output error
Traceback (most recent call last):
  File &quot;&#47;usr&#47;share&#47;bcc&#47;tools&#47;memleak&quot;, line 416, in &lt;module&gt;
    attach_probes(&quot;malloc&quot;)
  File &quot;&#47;usr&#47;share&#47;bcc&#47;tools&#47;memleak&quot;, line 406, in attach_probes
    pid=pid)
  File &quot;&#47;usr&#47;lib&#47;python2.7&#47;dist-packages&#47;bcc&#47;__init__.py&quot;, line 989, in attach_uprobe
    raise Exception(&quot;Failed to attach BPF to uprobe&quot;)
Exception: Failed to attach BPF to uprobe
</div>2019-02-23</li><br/><li><img src="" width="30px"><span>Geek_kur7vg</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œâ€è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬ç»ˆäºçœ‹åˆ°äº†å†…å­˜åˆ†é…çš„è°ƒç”¨æ ˆï¼ŒåŸæ¥æ˜¯ fibona...â€œè¿™é‡Œå¦‚ä½•çœ‹åˆ°æ˜¯è¿™å‡½æ•°æœªé‡Šæ”¾å‘¢ï¼Ÿè¾“å‡ºå¯å¦è§£é‡Šä¸‹å‘¢</div>2019-04-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/5e/c6/78e515ee.jpg" width="30px"><span>å”¯å®‰æ ¼</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œæˆ‘è¿è¡Œï¼š$ &#47;usr&#47;share&#47;bcc&#47;tools&#47;memleak -a -p $(pidof app) å¹¶æ²¡æœ‰çœ‹åˆ°å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚ä¹‹åè¿˜çœ‹äº†appçš„æºç ã€‚æºç å†…çš„ç¡®æ²¡æœ‰è°ƒç”¨free()å‡½æ•°ã€‚è¯·é—®è¿™å¯èƒ½æ˜¯ä»€ä¹ˆæƒ…å†µï¼Ÿ
root@ubuntu:&#47;# &#47;usr&#47;share&#47;bcc&#47;tools&#47;memleak -p $(pidof app) -a
Attaching to pid 84307, Ctrl+C to quit.
[02:42:22] Top 10 stacks with outstanding allocations:
[02:42:27] Top 10 stacks with outstanding allocations:
[02:42:32] Top 10 stacks with outstanding allocations:
[02:42:37] Top 10 stacks with outstanding allocations:
[02:42:43] Top 10 stacks with outstanding allocations:
[02:42:48] Top 10 stacks with outstanding allocations:
[02:42:53] Top 10 stacks with outstanding allocations:
[02:42:58] Top 10 stacks with outstanding allocations:
[02:43:03] Top 10 stacks with outstanding allocations:
^Croot@ubuntu:&#47;# docker exec app cat &#47;app.c
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;pthread.h&gt;
#include &lt;unistd.h&gt;

long long *fibonacci(long long *n0, long long *n1)
{
	long long *v = (long long *) calloc(1024, sizeof(long long));
	*v = *n0 + *n1;
	return v;
}

void *child(void *arg)
{
	long long n0 = 0;
	long long n1 = 1;
	long long *v = NULL;
	for (int n = 2; n &gt; 0; n++) {
		v = fibonacci(&amp;n0, &amp;n1);
		n0 = n1;
		n1 = *v;
		printf(&quot;%dth =&gt; %lld\n&quot;, n, *v);
		sleep(1);
	}
}


int main(void)
{
	pthread_t tid;
	pthread_create(&amp;tid, NULL, child, NULL);
	pthread_join(tid, NULL);
	printf(&quot;main thread exit\n&quot;);
	return 0;
</div>2019-03-12</li><br/><li><img src="" width="30px"><span>å…ƒå¤©å¤«</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>è¿˜æœ‰ä¸€ä¸ªå¾ˆlowçš„é—®é¢˜ï¼ŒLinux version 2.6.32-504.23.4.el6.x86_64 (mockbuild@c6b9.bsys.dev.centos.org) (gcc version 4.4.7 20120313 (Red Hat 4.4.7-11)ï¼Œè¿™ä¸ªæ˜¯æˆ‘æŸ¥çœ‹çš„å†…æ ¸ä¿¡æ¯ï¼Œè¿™ä¸ªæ˜¾ç¤ºå†…æ ¸ç‰ˆæœ¬æ˜¯4.4.7å¯¹å—ï¼Ÿ</div>2019-02-22</li><br/><li><img src="" width="30px"><span>å…ƒå¤©å¤«</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œè¯·æ•™ä¸ªé—®é¢˜ï¼Œpmap -xä¸‹ï¼Œçœ‹åˆ°æœ‰çš„è¾“å‡ºé¡¹çš„è„é¡µæ•°æ¯”è¾ƒå¤§ï¼Œæœ‰104ä¸‡ï¼Œè¿™ä¸ªç®—å¤§å—</div>2019-02-22</li><br/><li><img src="" width="30px"><span>é£ä¸€æ ·çš„ç”·å­</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œjava webåº”ç”¨æœ‰æ²¡æœ‰ç±»ä¼¼memleakå¯ä»¥å®šä½ä»£ç çš„å¥½ç”¨å·¥å…·ï¼Ÿ</div>2019-01-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/33/33/30fb3ac3.jpg" width="30px"><span>____çš„æˆ‘</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆ æˆ‘æœ‰ä¸€ä¸ªè¿›ç¨‹å†…å­˜ä½¿ç”¨è¶…å‡ºæ­£å¸¸èŒƒå›´ ç”¨pmapå‘½ä»¤çœ‹åˆ°æœ‰è¾ƒå¤š8mb 60mbçš„åŒ¿åå†…å­˜æ®µä½¿ç”¨ è¿™ä¸ªæœ‰ä»€ä¹ˆå¥½çš„æ–¹å¼å®šä½è¿™äº›å†…å­˜æ®µæ˜¯æ€ä¹ˆåˆ†é…æ¥çš„å—</div>2019-01-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ea/8b/613c162e.jpg" width="30px"><span>nomoshen</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ç›®å‰æˆ‘å¸ç”¨çš„å†…æ ¸ç‰ˆæœ¬è¿˜æ˜¯2.6çš„ï¼›è€Œä¸”ç”¨valgrindä¼šå¯¹çº¿ä¸Šæ­£åœ¨æ‰§è¡Œçš„ç¨‹åºæœ‰å¾ˆå¤§æ€§èƒ½å½±å“å§ï¼›å¯¹å†…å­˜æ³„éœ²è¿™å—è¿˜æ˜¯å¾ˆéš¾æŠŠæ¡çš„ï¼›å¸Œæœ›è€å¸ˆèƒ½xç»†èŠè¿™å—</div>2019-01-03</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/2o1Izf2YyJSnnI0ErZ51pYRlnrmibqUTaia3tCU1PjMxuwyXSKOLUYiac2TQ5pd5gNGvS81fVqKWGvDsZLTM8zhWg/132" width="30px"><span>åˆ’æ—¶ä»£</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>memleakå¥½åƒè¦æ¯”valgrindè¿›è¡Œå†…å­˜æ³„æ¼æ£€æµ‹è¦æ–¹ä¾¿å¾ˆå¤šã€‚</div>2019-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/97/e1/0f4d90ff.jpg" width="30px"><span>ä¹–ï¼Œæ‘¸æ‘¸å¤´</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è¿˜æ˜¯bccå¾—é—®é¢˜ï¼Œè£…ä¸Šè¿è¡Œå°±æŠ¥é”™
[root@VM_0_17_centos tools]# .&#47;cachetop
Traceback (most recent call last):
  File &quot;.&#47;cachetop&quot;, line 263, in &lt;module&gt;
    curses.wrapper(handle_loop, args)
  File &quot;&#47;usr&#47;lib64&#47;python2.7&#47;curses&#47;wrapper.py&quot;, line 43, in wrapper
    return func(stdscr, *args, **kwds)
  File &quot;.&#47;cachetop&quot;, line 171, in handle_loop
    b = BPF(text=bpf_text)
  File &quot;&#47;usr&#47;lib&#47;python2.7&#47;site-packages&#47;bcc&#47;__init__.py&quot;, line 318, in __init__
    raise Exception(&quot;Failed to compile BPF text&quot;)
Exception: Failed to compile BPF text</div>2019-08-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/97/e1/0f4d90ff.jpg" width="30px"><span>ä¹–ï¼Œæ‘¸æ‘¸å¤´</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>æ¯æ¬¡éƒ½è¦æŠ¥è¿™ä¸ªé”™ï¼Œæ— è®ºyumå®‰è£…è¿˜æ˜¯ç¼–è¯‘å®‰è£…éƒ½è¦æŠ¥è¿™ä¸ªé”™
root@VM_0_17_centos tools]# .&#47;cachestat
In file included from &lt;built-in&gt;:3:
In file included from &#47;virtual&#47;include&#47;bcc&#47;helpers.h:23:
In file included from &#47;lib&#47;modules&#47;5.2.5-1.el7.elrepo.x86_64&#47;build&#47;include&#47;linux&#47;log2.h:12:
In file included from &#47;lib&#47;modules&#47;5.2.5-1.el7.elrepo.x86_64&#47;build&#47;include&#47;linux&#47;bitops.h:19:
&#47;lib&#47;modules&#47;5.2.5-1.el7.elrepo.x86_64&#47;build&#47;arch&#47;x86&#47;include&#47;asm&#47;bitops.h:209:9: error: &#39;asm goto&#39; constructs are not supported yet
        return GEN_BINARY_RMWcc(LOCK_PREFIX __ASM_SIZE(bts), *addr, c, &quot;Ir&quot;, nr);
               ^
&#47;lib&#47;modules&#47;5.2.5-1.el7.elrepo.x86_64&#47;build&#47;arch&#47;x86&#47;include&#47;asm&#47;rmwcc.h:60:32: note: expanded from macro &#39;GEN_BINARY_RMWcc&#39;
#define GEN_BINARY_RMWcc(X...) RMWcc_CONCAT(GEN_BINARY_RMWcc_, RMWcc_ARGS(X))(X)
                               ^
&#47;lib&#47;modules&#47;5.2.5-1.el7.elrepo.x86_64&#47;build&#47;arch&#47;x86&#47;include&#47;asm&#47;rmwcc.h:10:28: note: expanded from macro &#39;RMWcc_CONCAT&#39;
#define RMWcc_CONCAT(a, b) __RMWcc_CONCAT(a, b)
                           ^
&#47;lib&#47;modules&#47;5.2.5-1.el7.elrepo.x86_64&#47;build&#47;arch&#47;x86&#47;include&#47;asm&#47;rmwcc.h:9:30: note: expanded from macro &#39;__RMWcc_CONCAT&#39;
#define __RMWcc_CONCAT(a, b) a ## b
                             ^
note: (skipping 2 expansions in backtrace; use -fmacro-backtrace-limit=0 to see all)
&#47;lib&#47;modules&#47;5.2.5-1.el7.elrepo.x86_64&#47;build&#47;arch&#47;x86&#47;include&#47;asm&#47;rmwcc.h:54:2: note: expanded from macro &#39;GEN_BINARY_RMWcc_6&#39;
        __GEN_RMWcc(op &quot; %[val], &quot; arg0, var, cc,                       \
        ^
&#47;lib&#47;modules&#47;5.2.5-1.el7.elrepo.x86_64&#47;build&#47;arch&#47;x86&#47;include&#47;asm&#47;rmwcc.h:21:2: note: expanded from macro &#39;__GEN_RMWcc&#39;
        asm_volatile_goto (fullop &quot;; j&quot; #cc &quot; %l[cc_label]&quot;             \
        ^
&#47;lib&#47;modules&#47;5.2.5-1.el7.elrepo.x86_64&#47;build&#47;include&#47;linux&#47;compiler_types.h:187:37: note: expanded from macro &#39;asm_volatile_goto&#39;
#define asm_volatile_goto(x...) asm goto(x)
                                    ^
In file included from &lt;built-in&gt;:3:</div>2019-08-04</li><br/><li><img src="" width="30px"><span>suke</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆ,çœ‹äº†æ‚¨å¥½å¤šç‰‡æ–‡ç« ,æ‚¨çš„å¯¹é—®é¢˜çš„å¤„ç†æ–¹æ³•éƒ½æ˜¯åŸºäºè£¸æœºçš„,ç°åœ¨å…¬å¸å¥½å¤šéƒ½æ˜¯åŸºäºå®¹å™¨,åŸºäºè™šæ‹Ÿç¯å¢ƒçš„,å¥½å¤šå‘½ä»¤å’Œå·¥å…·ä¸æ˜¯é‚£ä¹ˆèµ·ä½œç”¨,èƒ½ä¸èƒ½è¿™æ–¹é¢å¤šå†™ä¸€äº›</div>2019-08-02</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJlN0AUA3CiaZzorL5Jq1oWPqxOYJwBxnHETFQ7DQFwA7EpQS5tS6mCHribW0rnsyFia88Z0eyqqNYdA/132" width="30px"><span>Geek_638ba5</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>è€å¸ˆ æœ‰ä¸ªé—®é¢˜è®¨è®ºä¸‹
æˆ‘ä»¬çš„ç¯å¢ƒè·‘äº†ä¸€ä¸ªhttpçš„ç¼“å­˜è¿›ç¨‹ï¼Œå½“å¤§é‡httpè¯·æ±‚è¿‡æ¥æ—¶å€™ï¼Œç¼“å­˜è¿›ç¨‹çš„å†…å­˜ä¸€ç›´åœ¨æ¶¨ï¼Œå³ä½¿ç¼“å­˜è¿‡æœŸäº†ä¹Ÿæ²¡æœ‰æ˜æ˜¾é™ä¸‹å»ã€‚ å¯¹äºè¿™ç§å®ˆæŠ¤è¿›ç¨‹çš„æƒ…å†µï¼Œå¦‚ä½•åˆ¤æ–­å†…å­˜å¢é•¿ç©¶ç«Ÿæ˜¯ç”±äºå†…å­˜æ³„æ¼è¿˜æ˜¯å†…å­˜ç¢ç‰‡è¿˜æ˜¯å…¶ä»–åŸå› ï¼Ÿ(æ­¤æ¡ˆä¾‹ä¸­valgrindä¸å¯ç”¨ï¼Œå› ä¸ºè¿™ä¸ªè¿›ç¨‹æ˜¯fork()ä¹‹åè°ƒç”¨exec()äº§ç”Ÿçš„ï¼Œè€Œvalgrindä¸æ”¯æŒæ­¤ç§æƒ…å†µå¤šè¿›ç¨‹çš„è¿½è¸ª)</div>2019-06-25</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIe7XMR0W1B8wWNm18KvfMyLUaMLdsD8bcvfhjpN3tRCuBFTE1Mr3ibdNq54t9QgZe4Hv8WC0Ikpaw/132" width="30px"><span>woniu</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æœ€è¿‘åœ¨çº¿ä¸Šé‡åˆ°ç”¨æˆ·æ€cpuå¾ˆé«˜çš„é—®é¢˜ã€‚apache+phpçš„ç¯å¢ƒï¼Œç”¨strace è¿½è¸ªå‘ç°80%ä»¥ä¸Šçš„ç³»ç»Ÿsyscalléƒ½æ˜¯brk,ä½†æ˜¯ç³»ç»Ÿçš„å†…å­˜å ç”¨å¾ˆä½å¹¶ä¸”å¾ˆå¹³ç¨³ã€‚æ€€ç–‘æ˜¯phpä»£ç é€ æˆçš„å†…å­˜æ³„æ¼ï¼Œä½†æ˜¯apacheå›æ”¶äº†å†…å­˜ã€‚è¯·è€å¸ˆæŒ‡ç‚¹ä¸€ä¸‹ï¼</div>2019-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/9c/f3/e01dfe3a.jpg" width="30px"><span>äºç«¶</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ç›®å‰é‡åˆ°ä¸€ä¸ªç–‘ä¼¼å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼šnginxä»£ç†è¿è¡Œåå†…å­˜ä¼šä¸æ–­çš„å‡å°‘ï¼›æ¯æ¬¡reloadä¹‹åï¼Œå†…å­˜åˆä¼šé‡Šæ”¾ã€‚ç”±äºæœåŠ¡å™¨ä¹Ÿä¸èƒ½éšä¾¿å‡çº§å†…æ ¸å®‰è£…memleakç­‰è¿™äº›é¢å¤–å·¥å…·ï¼Œç›®å‰ä¹Ÿè¿˜æ²¡å®šä½åˆ°å…·ä½“åŸå› åœ¨å“ªã€‚æ€€ç–‘æ˜¯ä¸æ˜¯å› ä¸ºnginxé…ç½®ä¸­æœ‰äº›å˜é‡èµ‹å€¼å’Œifåˆ¤æ–­çš„é…ç½®å¯¼è‡´çš„ã€‚æƒ³è¯·æ•™ä¸‹ï¼Œçœ‹èƒ½ä¸èƒ½ç»™äº›æ€è·¯ã€‚</div>2019-03-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/16/f6/b864cf41.jpg" width="30px"><span>missing</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>è€å¸ˆå¥½ï¼æˆ‘çš„ç³»ç»Ÿæ˜¯ubuntu 14.04,å†…æ ¸ç‰ˆæœ¬æ˜¯4.4.0-31-genericï¼Œå¯ä»¥è·‘cachetop,cachestatï¼Œä½†ä¸€è·‘memleakå°±ä¼šæŠ¥é”™ã€‚æŠ¥é”™å¦‚ä¸‹ï¼š
oot@ubuntu:~# memleak -a -p $(pidof mysqld)
&#47;virtual&#47;main.c:18:1: error: could not open bpf map: Invalid argument
is maps&#47;stacktrace map type enabled in your kernel?
BPF_STACK_TRACE(stack_traces, 10240);
^
&#47;virtual&#47;include&#47;bcc&#47;helpers.h:220:3: note: expanded from macro &#39;BPF_STACK_TRACE&#39;
  BPF_TABLE(&quot;stacktrace&quot;, int, struct bpf_stacktrace, _name, roundup_pow_of_two(_max_entries))
  ^
&#47;virtual&#47;include&#47;bcc&#47;helpers.h:75:76: note: expanded from macro &#39;BPF_TABLE&#39;
#define BPF_TABLE(_table_type, _key_type, _leaf_type, _name, _max_entries) \
                                                                           ^
&#47;virtual&#47;include&#47;bcc&#47;helpers.h:71:4: note: expanded from macro &#39;\
BPF_F_TABLE&#39;
}; \
   ^
&#47;virtual&#47;main.c:83:25: error: bpf_table stack_traces failed to open
        info.stack_id = stack_traces.get_stackid(ctx, BPF_F_REUSE_STACKID|BPF_F_USER_STACK);
                        ^
2 errors generated.
Traceback (most recent call last):
  File &quot;&#47;usr&#47;share&#47;bcc&#47;tools&#47;memleak&quot;, line 394, in &lt;module&gt;
    bpf = BPF(text=bpf_source)
  File &quot;&#47;usr&#47;lib&#47;python2.7&#47;dist-packages&#47;bcc&#47;__init__.py&quot;, line 320, in __init__
    raise Exception(&quot;Failed to compile BPF text&quot;)
Exception: Failed to compile BPF text

è¯·é—®æ˜¯ä»€ä¹ˆåŸå› å‘¢?</div>2019-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/38/5b/26539a0b.jpg" width="30px"><span>marvinren</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æˆ‘åœ¨è¯•ç”¨é˜¿é‡Œäº‘å‘ç°å†…å­˜å¹¶æ²¡æœ‰å‡å°‘ï¼Œè¿™æ˜¯å› ä¸ºæœ‰å…¶ä»–æœºåˆ¶ä¿æŠ¤å†…å­˜æ³„éœ²äº†ä¹ˆï¼Ÿ
root@iZhp35alkngu5crtmh4wjaZ:~&#47;mylab# vmstat 5
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 6445872 692400 810976    0    0  1351     7   15    4  0  1 98  1  0
 0  0      0 6444344 692400 810996    0    0     0     2  579 1071  1  2 97  0  0
 0  0      0 6444348 692400 810968    0    0     0     2  644 1177  1  2 96  0  0
 0  0      0 6462500 692400 810976    0    0     0     3  610 1048  1  2 97  0  0
 0  0      0 6462876 692400 810976    0    0     0     2  663 1131  1  2 97  0  0
 0  0      0 6462692 692400 810996    0    0     0     3  644 1088  1  2 97  0  0
 0  0      0 6462496 692404 810988    0    0     0     2  662 1186  1  2 97  0  0
</div>2019-01-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/97/82/394c88ad.jpg" width="30px"><span>è¥¿çº¢æŸ¿ç‰›è…©</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>è€å¸ˆï¼Œéº»çƒ¦è¯·æ•™ä¸‹åœ¨dockerä¸­æ‰§è¡Œä¼šå‡ºé”™çš„é—®é¢˜ï¼š
ç³»ç»Ÿç‰ˆæœ¬Ubuntu18.04.1
å†…æ ¸ï¼šLinux top 4.15.0-43-generic #46-Ubuntu SMP Thu Dec 6 14:45:28 UTC 2018 x86_64 x86_64 x86_64 GNU&#47;Linux
åœ¨æ‰§è¡Œå®Œï¼š
docker run --name=app -itd feisky&#47;app:mem-leak
docker logs app
æ‰§è¡Œ
&#47;usr&#47;share&#47;bcc&#47;tools&#47;memleak -a -p $(pidof app)
å¼€å§‹æŠ¥é”™ï¼š
root@top:~&#47;app# &#47;usr&#47;share&#47;bcc&#47;tools&#47;memleak -a -p $(pidof app)
&#47;virtual&#47;main.c:18:1: error: could not open bpf map: Cannot allocate memory
is maps&#47;stacktrace map type enabled in your kernel?
BPF_STACK_TRACE(stack_traces, 10240);
^
&#47;virtual&#47;include&#47;bcc&#47;helpers.h:220:3: note: expanded from macro &#39;BPF_STACK_TRACE&#39;
  BPF_TABLE(&quot;stacktrace&quot;, int, struct bpf_stacktrace, _name, roundup_pow_of_two(_max_entries))
  ^
&#47;virtual&#47;include&#47;bcc&#47;helpers.h:75:76: note: expanded from macro &#39;BPF_TABLE&#39;
#define BPF_TABLE(_table_type, _key_type, _leaf_type, _name, _max_entries) \
                                                                           ^
&#47;virtual&#47;include&#47;bcc&#47;helpers.h:71:4: note: expanded from macro &#39;\
BPF_F_TABLE&#39;
}; \
   ^
&#47;virtual&#47;main.c:83:25: error: bpf_table stack_traces failed to open
        info.stack_id = stack_traces.get_stackid(ctx, BPF_F_REUSE_STACKID|BPF_F_USER_STACK);
                        ^
2 errors generated.
Traceback (most recent call last):
  File &quot;&#47;usr&#47;share&#47;bcc&#47;tools&#47;memleak&quot;, line 394, in &lt;module&gt;
    bpf = BPF(text=bpf_source)
  File &quot;&#47;usr&#47;lib&#47;python2.7&#47;dist-packages&#47;bcc&#47;__init__.py&quot;, line 320, in __init__
    raise Exception(&quot;Failed to compile BPF text&quot;)
Exception: Failed to compile BPF text

ä½†æ˜¯æˆ‘æŠŠapp.cå’Œapp-fix.cå•ç‹¬æ‹¿å‡ºæ¥ï¼Œè‡ªè¡Œç¼–è¯‘è¿è¡Œæ—¶ï¼Œæ‰§è¡Œmemleakï¼Œå°±å·¥ä½œæ­£å¸¸äº†ã€‚å¯¹dockeræ“ä½œä¸ç†Ÿï¼Œæä¸æ‡‚ä¸ºä»€ä¹ˆï¼Œè¿˜è¯·è€å¸ˆæœ‰æ—¶é—´æŒ‡æ•™ä¸€ä¸‹ã€‚</div>2019-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/0f/84/d8e63885.jpg" width="30px"><span>ä»²é¬¼</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆå¥½ï¼Œä¹‹å‰å“ªèŠ‚è¯¾è®²è¿‡pmapï¼Ÿå¹¶æ²¡æœ‰æ‰¾åˆ°</div>2019-01-04</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/13/2d/ad1bfe92.jpg" width="30px"><span>æ±Ÿæ¹–ä¸­äºº</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æœ‰ä¸ªç–‘é—®è¯·æ•™ä¸‹ï¼š
for (int n = 2; n &gt; 0; n++) {
        v = fibonacci(&amp;n0, &amp;n1);
        n0 = n1;
        n1 = *v;
        free(v);    &#47;&#47; é‡Šæ”¾å†…å­˜
        printf(&quot;%dth =&gt; %lld\n&quot;, n, *v);
        sleep(1);
    }
è¿™æ®µä»£ç ä¸­ï¼Œåœ¨free(v)ä¹‹å¾Œï¼Œprintfä¸­ä»ç”¨åˆ°äº†vä¸­å­˜å‚¨çš„æ•°æ®ï¼Œä¸ä¼šæœ‰é—®é¢˜å—</div>2019-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d9/47/247fd305.jpg" width="30px"><span>holen</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œ æœ‰æ²¡æœ‰ centos ä¸‹ä¸ç”¨å‡çº§å†…æ ¸å°±å¯ä»¥æ£€æµ‹å†…å­˜çš„å·¥å…·ï¼Œåƒ valgrind å·¥å…·æ²¡åŠæ³•æŒ‡å®š pid æ£€æµ‹,   æœ‰æ²¡æœ‰æ›´å¥½çš„å·¥å…·æ¨èä¸‹å‘¢</div>2019-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/34/bb/0b971fca.jpg" width="30px"><span>walker</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>valgrindä¸æ˜¯å®æ—¶çš„æŸ¥çœ‹å‘½ä»¤ï¼ŒæŠŠæ£€æŸ¥ç»“æœå­˜å…¥åˆ°ä¸€ä¸ªæ–‡æœ¬ä¸­ã€‚
valgrind --tool=memcheck --leak-check=full --xtree-leak=yes --show-mismatched-frees=yes test.txt</div>2019-01-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/57/6e/b6795c44.jpg" width="30px"><span>å¤œç©ºä¸­æœ€äº®çš„æ˜Ÿ</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œä»£ç æ®µé‡Œé¢å¯å¦æŠŠ  ä»£ç å‰é¢çš„ $ æˆ– # å·ï¼Œå»æ‰ã€‚å¸¦ç€è¿˜çš„æ‰‹åŠ¨å»æ‰ä¸‹æ‰èƒ½æ‰§è¡Œä»£ç </div>2019-01-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/2f/f4/2dede51a.jpg" width="30px"><span>å°è€é¼ </span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ç”¨javaå°±ä¸è¦ç”¨freeäº†å§</div>2019-01-02</li><br/>
</ul>