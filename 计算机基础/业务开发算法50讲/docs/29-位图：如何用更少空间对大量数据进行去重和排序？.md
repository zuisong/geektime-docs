ä½ å¥½ï¼Œæˆ‘æ˜¯å¾®æ‰°å›ã€‚

ä»Šå¤©æˆ‘ä»¬ä»ä¸€é“éå¸¸ç»å…¸çš„é¢è¯•é¢˜å¼€å§‹è¯´èµ·ï¼Œçœ‹çœ‹ä½ èƒ½å¦ç”¨ä¹‹å‰å­¦è¿‡çš„çŸ¥è¯†å›ç­”å‡ºæ¥ï¼Œé¢˜ç›®æ˜¯è¿™æ ·çš„ï¼šQQï¼Œç›¸ä¿¡ä½ è‚¯å®šç”¨è¿‡ï¼Œå‡è®¾QQå·ï¼ˆä¹Ÿå°±æ˜¯ç”¨æˆ·çš„IDï¼‰æ˜¯ä¸€ä¸ª10ä½ä»¥å†…çš„æ•°å­—ï¼Œç”¨ä¸€ä¸ªé•¿æ•´å‹æ˜¯å¯ä»¥å­˜å‚¨å¾—ä¸‹çš„ã€‚

ç°åœ¨ï¼Œæœ‰ä¸€ä¸ªæ–‡ä»¶é‡Œå­˜å‚¨äº†å¾ˆå¤šä¸ªQQå·ï¼Œä½†å¯èƒ½ä¼šæœ‰ä¸€å®šçš„é‡å¤ï¼Œå¦‚æœè®©ä½ éå†ä¸€è¾¹æ–‡ä»¶ï¼ŒæŠŠå…¶ä¸­é‡å¤çš„QQå·éƒ½è¿‡æ»¤æ‰ï¼Œç„¶åæŠŠç»“æœè¾“å‡ºåˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶ä¸­ã€‚ä½ ä¼šæ€ä¹ˆåšï¼Ÿå¦‚æœQQå·å¤šè¾¾40äº¿ä¸ªï¼Œä½†æ˜¯ä½ çš„å†…å­˜åˆæ¯”è¾ƒæœ‰é™ï¼ˆæ¯”å¦‚1GBï¼‰ï¼Œåˆä¼šæ€ä¹ˆåšå‘¢ï¼Ÿ

ä½ å¯ä»¥å…ˆæš‚åœï¼Œæ€è€ƒä¸€ä¸‹è¿™ä¸ªé—®é¢˜ï¼Œå¦‚æœæœ‰äº†åˆæ­¥æ€è·¯ï¼Œæˆ‘ä»¬ä¸€èµ·è¿›å…¥ä»Šå¤©çš„å­¦ä¹ ã€‚

## ç›´æ¥åŸºäºå†…å­˜è¿›è¡Œå»é‡

å…ˆæ¥è¯´è¯´å¸¸è§„çš„æ€è·¯ã€‚å‡è®¾æˆ‘ä»¬çš„æ•°æ®å¯ä»¥è¢«å†…å­˜è£…ä¸‹ï¼Œè¿™ä¸ªé—®é¢˜å…¶å®å°±æœ‰å¾ˆå¤šç§æ–¹å¼å¯ä»¥è§£å†³ã€‚

æ¯”å¦‚ï¼Œå¯¹äºå»é‡ï¼Œç›´æ¥é‡‡ç”¨åŸºäºæ•£åˆ—æ€æƒ³çš„hashsetï¼Œæˆ–è€…åŸºäºæ ‘çŠ¶ç»“æ„çš„setå°±å¯ä»¥äº†ï¼Œå‰è€…å¯ä»¥åœ¨O(1)çš„æ—¶é—´å¤æ‚åº¦å†…ï¼Œåˆ¤æ–­æŸä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºé›†åˆä¸­ï¼Œåè€…è™½ç„¶éœ€è¦O(logN)çš„æ—¶é—´å¤æ‚åº¦ï¼Œä½†æ˜¯åœ¨åäº¿çš„æ•°é‡çº§ä¸‹ï¼Œå…¶å®ä¹Ÿå°±æ˜¯æ¯”è¾ƒ30æ¬¡å·¦å³ï¼Œä»£ä»·ä¹Ÿå¹¶ä¸é«˜ï¼›ç„¶åæˆ‘ä»¬éå†ä¸€éæ•´ä¸ªæ–‡ä»¶ï¼Œå­˜å…¥setä¸­ï¼Œå†è¾“å‡ºåˆ°å¦ä¸€ä¸ªæ–‡ä»¶ã€‚æ€»çš„æ—¶é—´å¤æ‚åº¦ï¼Œå‰è€…æ˜¯O(N)ï¼Œåè€…æ˜¯O(N\*logN)ã€‚

å½“ç„¶è¿˜æœ‰ä¸€ç§æ€è·¯ï¼Œæˆ‘ä»¬å…ˆç”¨æ•°ç»„æŠŠæ‰€æœ‰QQå·å­˜å‚¨ä¸‹æ¥ï¼Œè¿›è¡Œæ’åºï¼›ç„¶åé¡ºæ¬¡éå†ï¼Œè·³è¿‡æ‰€æœ‰å’Œå‰ä¸ªQQå·ç›¸åŒçš„QQå·ï¼Œå°±èƒ½å®ç°å»é‡ï¼Œé‡‡ç”¨å¿«æ’åŒæ ·å¯ä»¥è¾¾åˆ°O(N\*logN)çš„æ—¶é—´å¤æ‚åº¦ã€‚

æ‰€ä»¥æ€»çš„æ¥è¯´ï¼ŒåŸºäºå“ˆå¸Œç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ï¼Œç†è®ºä¸Šå·²ç»æ˜¯æœ€ä¼˜çš„äº†ï¼Œè€—æ—¶ä¹Ÿæ˜¯å¯æ¥å—çš„ï¼Œæ¯•ç«Ÿæ— è®ºå¦‚ä½•ï¼Œæƒ³è¦å»é‡ï¼Œæ¯ä¸ªå…ƒç´ è‡³å°‘è¦éå†ä¸€éï¼Œä¸å¯èƒ½å­˜åœ¨æ›´ä¼˜çš„æ—¶é—´å¤æ‚åº¦äº†ã€‚**æˆ‘ä»¬å”¯ä¸€è¿˜èƒ½ä¼˜åŒ–çš„ç‚¹å°±æ˜¯ï¼Œåœ¨åƒQQå·è¿™ç§ä»¥æ•°å­—ä¸ºkeyçš„ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œç›´æ¥åˆ©ç”¨æ•°ç»„æ¥å……å½“hashmapï¼Œé¿å…hashçš„å¼€é”€**ã€‚

ä½†æ˜¯è¿™ä¸ªé¢˜çœŸæ­£çš„é—®é¢˜æ˜¯ï¼Œä»ç©ºé—´ä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬çœŸçš„èƒ½å¼€ç€è¿™ä¹ˆå¤§çš„ä¸€ä¸ªæ•°ç»„å—ï¼Ÿå› ä¸ºå­˜å‚¨çš„æ˜¯10ä½æ•°çš„QQå·ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬çš„æ•°ç»„è‡³å°‘è¦æœ‰10ä½æ•°ä»¥ä¸Šçš„indexï¼Œå‡è®¾æœ€é«˜ä½ä»¥1ã€2ã€3ã€4å¼€å¤´ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°ç»„è‡³å°‘è¦å­˜æ”¾40äº¿çº§åˆ«çš„æ•°æ®ã€‚

å‡è®¾æ•°ç»„ç±»å‹æ˜¯boolï¼Œè¡¨ç¤ºå¯¹åº”indexçš„QQå·æ˜¯å¦å­˜åœ¨ï¼Œé‚£æˆ‘ä»¬æ‰€éœ€è¦çš„å†…å­˜ç©ºé—´å¤§çº¦æ˜¯4GBã€‚è¿™å¯¹ç›®å‰çš„ç¡¬ä»¶æ¥è¯´ä¸æ˜¯ä¸€ä¸ªç‰¹åˆ«é«˜çš„å†…å­˜è¦æ±‚ï¼Œè®¸å¤šä¸ªäººç”µè„‘æ‰€é‡‡ç”¨çš„å†…å­˜æ¡éƒ½è¶³ä»¥æ”¯æ’‘ï¼Œä½†æ˜¯å¦‚æœå­˜11ä½çš„QQå·æˆ–è€…å…¶ä»–æ›´å¤§çš„æ•°æ®é‡ï¼Œæ˜¾ç„¶å°±ä¸å¤Ÿç”¨äº†ã€‚è€Œä¸”è¿™é“é¢è¯•é¢˜çš„åŸå§‹ç‰ˆæœ¬è¦æ±‚æˆ‘ä»¬ç”¨1GBçš„å†…å­˜å®ç°å»é‡ã€‚

æ€»ä¹‹ï¼Œå¦‚æœæœ‰åŠæ³•ç”¨æ›´ä½çš„å†…å­˜ï¼Œæˆ‘ä»¬åº”è¯¥æƒ³åŠæ³•å»å‘æ˜ã€‚

## å¯¹æ–‡ä»¶è¿›è¡Œåˆ†å‰²

ç°åœ¨ï¼Œå†…æ’åºã€ç›´æ¥ä½¿ç”¨hashmapæˆ–è€…æ•°ç»„è®¡æ•°å»é‡çš„æ–¹å¼è‚¯å®šæ˜¯ä¸è¡Œäº†ã€‚

ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æƒ³åˆ°ä¹‹å‰å­¦è¿‡çš„å¤–æ’ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯å¯¹æ–‡ä»¶çš„åˆ†å‰²å’Œé€æ­¥æ’åºã€‚åœ¨æˆ‘ä»¬çš„QQå·åœºæ™¯ä¸‹ï¼Œä¸éœ€è¦çœŸçš„åšæ’åºï¼Œåªæ˜¯éœ€è¦å»é‡ï¼Œæ‰€ä»¥å®Œå…¨å¯ä»¥é€è¡Œè¯»å…¥å¤§æ–‡ä»¶ï¼Œæ ¹æ®QQå·çš„èŒƒå›´ï¼Œåˆ‡åˆ†æˆå¤šä¸ªå¯ä»¥ä¸€æ¬¡æ€§åŠ è½½è¿›å†…å­˜çš„å°æ–‡ä»¶ã€‚

ä¸è¿‡å› ä¸ºä¸åŒèŒƒå›´å†…QQå·é‡å¤çš„æ•°é‡å¯èƒ½ä¸åŒï¼Œåˆ†å‰²èŒƒå›´å¯èƒ½ä¸æ˜¯ç‰¹åˆ«å¥½æŠŠæ¡ï¼Œä¿å®ˆä¸€ç‚¹çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠQQå·æŒ‰ç…§1000Wçš„å¤§å°è¿›è¡Œåˆ†æ®µï¼Œè¿™æ ·å¤§çº¦éœ€è¦åˆ†ä¸º400ä¸ªæ–‡ä»¶ã€‚è¿™æ ·åŸºæœ¬ä¸Šï¼Œç®—ä¸Šé‡å¤çš„QQå·ï¼Œä¹Ÿä¸å¤ªå¯èƒ½è¶…è¿‡1Gå†…å­˜çš„å®¹é‡ï¼Œæ¯ä¸ªæ–‡ä»¶å†ç”¨hashmapä¹‹ç±»çš„æ‰‹æ®µå»é‡ï¼Œæœ€ååˆå¹¶å°±å¯ä»¥äº†ã€‚

å¤–æ’åºæ˜¯ä¸€ä¸ªå¯è¡Œçš„è§£å†³åŠæ³•ï¼Œè€Œä¸”ç†è®ºä¸Šæ¥è¯´ï¼Œåˆ©ç”¨ç±»ä¼¼çš„æ€è·¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å®ç°æ›´å¤§æ•°é‡çº§çš„å»é‡ä»»åŠ¡ï¼Œ**ä½†æ˜¯ä»£ä»·æ˜¯è¦è¿›è¡Œæ›´å¤šæ¬¡çš„IOã€‚æ€§èƒ½æ¯”è¾ƒå·®**ã€‚

äº‹å®ä¸Šï¼Œ40äº¿çº§çš„æ•°æ®èŒƒå›´ï¼Œåœ¨1GBçš„å†…å­˜ä¸‹ï¼Œæˆ‘ä»¬æ˜¯æœ‰åŠæ³•ç›´æ¥åœ¨å†…å­˜ä¸­å¤„ç†å»é‡çš„ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦å­¦ä¹ çš„Bitmapï¼Œå®ƒéå¸¸æœ‰ç”¨ï¼Œåœ¨è®¡ç®—æœºçš„ä¸–ç•Œé‡Œæ— å¤„ä¸åœ¨ï¼Œä»æ–‡ä»¶ç³»ç»Ÿã€æ•°æ®åº“ï¼Œè¿˜æœ‰Redisä¸­éƒ½æœ‰å¹¿æ³›åº”ç”¨ã€‚æˆ‘ä»¬æ¥çœ‹è®¾è®¡æ€è·¯ã€‚

## Bitmap

40äº¿çš„æ•°æ®ç›´æ¥æ”¾åœ¨å†…å­˜é‡Œæ˜¯ä¸è¡Œçš„ï¼Œä½†å»é‡ï¼Œå¿…é¡»è·å¾—æ‰€æœ‰çš„ä¿¡æ¯ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åªåˆ©ç”¨å†…å­˜è¿›è¡Œå»é‡ï¼Œä¹Ÿä»ç„¶éœ€è¦æŠŠæ¯ä¸ªæ•°å­—æ˜¯å¦å‡ºç°åœ¨æ–‡ä»¶ä¸­çš„ä¿¡æ¯ï¼Œé€šè¿‡æŸç§æ–¹å¼è®°å½•ä¸‹æ¥ã€‚

å‰é¢é€šè¿‡æ•°ç»„å­˜boolå€¼çš„æ–¹å¼ï¼Œæ˜¾ç„¶ä¸æ˜¯æœ€ç»æµçš„ä¸€ç§å­˜å‚¨æ–¹å¼ï¼Œå› ä¸ºæ¯ä¸ªboolç±»å‹åœ¨æ•°ç»„ä¸­å æ®äº†ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯8ä¸ªbitã€‚

ä½†æ˜¯å­˜å‚¨ä¸€ä¸ªæ•°å­—æ˜¯å¦å‡ºç°ï¼Œå…¶å®æˆ‘ä»¬åªéœ€è¦ç”¨ä¸€ä¸ªbitæ¥è®°å½•ã€‚**Bitmapçš„æ ¸å¿ƒå°±æ˜¯ç”¨æ•°å­—äºŒè¿›åˆ¶çš„æ¯ä¸€ä½å»æ ‡è®°æŸä¸ªäºŒå€¼çš„çŠ¶æ€**ï¼Œæ¯”å¦‚æ˜¯å¦å­˜åœ¨ï¼Œç”¨0è¡¨ç¤ºä¸å­˜åœ¨ï¼Œç”¨1è¡¨ç¤ºå­˜åœ¨ï¼Œæ‰€ä»¥å¯ä»¥åœ¨éå¸¸é«˜çš„ç©ºé—´åˆ©ç”¨ç‡ä¸‹ä¿å­˜å¤§é‡äºŒå€¼çš„çŠ¶æ€ã€‚

ä¸€ä¸ªåŸºæœ¬çš„Bitmapçš„å›¾ç¤ºï¼Œç›¸ä¿¡ä½ ä¸€çœ‹å°±èƒ½æ˜ç™½ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/9c/7a/9c7c35bd4281fb78bc4386fc88d0f97a.jpg?wh=1920x956)

æ¯”å¦‚å¯ä»¥ç”¨charç±»å‹æ¥å­˜å‚¨8ä¸ªä¸åŒå…ƒç´ æ˜¯å¦å‡ºç°çš„æƒ…å†µï¼Œcharçš„èŒƒå›´åœ¨å„å¤§ä¸»æµè¯­è¨€ä¸­ä¸€èˆ¬ä¸º0ï½255ï¼Œä¸€å…±åŒ…å«8ä½äºŒè¿›åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸‹æ ‡çš„æ¯ä¸€ä½æ¥è¡¨ç¤ºä¸€ä¸ªå…ƒç´ æ˜¯å¦å‡ºç°ã€‚åœ¨è¿™å¼ å›¾ä¸­Bitmapçš„å€¼ä¸º254ï¼Œè¡¨ç¤ºä¸‹æ ‡1ï½7çš„å…ƒç´ éƒ½æœ‰å‡ºç°ï¼Œè€Œä¸‹æ ‡0çš„å…ƒç´ æ²¡æœ‰å‡ºç°ã€‚

**è¿™æ ·ä»…ä»…ç”¨äº†ä¸€ä¸ªå­—èŠ‚ï¼Œå°±è¡¨ç¤ºäº†8ä¸ªå…ƒç´ æ˜¯å¦å‡ºç°çš„æƒ…å†µ**ï¼Œè€Œå¦‚æœç”¨mapæˆ–è€…æ•°ç»„ï¼Œè‡³å°‘éœ€è¦8ä¸ªboolå€¼ä¹Ÿå°±æ˜¯8ä¸ªå­—èŠ‚å¤§å°çš„ç©ºé—´ï¼Œè¿™æ ·æˆ‘ä»¬å°±èŠ‚çº¦äº†8å€çš„ç©ºé—´ã€‚

åŒæ ·å¦‚æœæˆ‘ä»¬ç”¨åˆ«çš„ç±»å‹æ¥å­˜å‚¨Bitmapï¼Œæ¯”å¦‚unsigned intç±»å‹ï¼Œæ¯ä¸€ä¸ªæ•°å­—å°±å¯ä»¥è¡¨ç¤º32ä¸ªå…ƒç´ çš„å­˜åœ¨ä¸å¦ï¼Œé‡‡ç”¨å¤šä¸ªunsigned intç±»å‹æ•°æ®çº§è”ï¼Œå°±å¯ä»¥æ ‡è¯†æ›´å¤šçš„å…ƒç´ æ˜¯å¦å­˜åœ¨ã€‚

åœ¨QQå·çš„åœºæ™¯ä¸‹ï¼Œè¦è¡¨ç¤º40äº¿çš„å…ƒç´ ï¼Œé‡‡ç”¨Bitmapï¼Œæœ€å°‘åªéœ€è¦40äº¿ä¸ªbitsï¼Œæ‰€å æ®çš„ç©ºé—´å¤§çº¦æ˜¯500Må·¦å³ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±å¤§å¤§å‹ç¼©äº†å†…å­˜çš„ä½¿ç”¨ç©ºé—´ï¼Œåœ¨1GBä¹‹å†…å°±å¯ä»¥å®Œæˆå»é‡çš„å·¥ä½œã€‚

è¿™é‡Œæ’å¥é¢˜å¤–è¯ï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ä¸ºä»€ä¹ˆboolç±»å‹ï¼Œåœ¨å¤§éƒ¨åˆ†è¯­è¨€ä¸­ï¼Œéƒ½éœ€è¦ä¸€ä¸ªbyteå»å­˜å‚¨å‘¢ï¼Ÿboolæœ¬èº«è¯­æ„ä¸Šå°±åªæ˜¯äºŒå€¼ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ç”¨ä¸€ä¸ªbitæ¥å®ç°å—ï¼Œè¿™æ ·ä¸æ˜¯æ•ˆç‡é«˜å¾—å¤šï¼Ÿ

è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦æˆ‘ä»¬æœ‰æ¯”è¾ƒå¥½çš„è®¡ç®—æœºç»„æˆåŸç†ç›¸å…³çš„çŸ¥è¯†äº†ã€‚æœ¬è´¨åŸå› æ˜¯åœ¨å¤§éƒ¨åˆ†çš„è®¡ç®—æœºæ¶æ„ä¸­ï¼Œæœ€å°çš„å†…å­˜æ“ä½œå•å…ƒå°±æ˜¯ä¸€ä¸ªbyteï¼Œ**ç›´æ¥é‡‡ç”¨ä¸€ä¸ªbyteä½œä¸ºboolç±»å‹çš„å­˜å‚¨ï¼Œåœ¨ä¸€æ¬¡è¯»å†…å­˜çš„æ“ä½œå†…å³å¯å®Œæˆï¼Œå¦‚æœå­˜å‚¨ä¸ºä¸€ä¸ªbitï¼Œæˆ‘ä»¬è¿˜éœ€è¦åƒBitmapé‚£æ ·ï¼Œä»è‹¥å¹²ä½ä¸­é€šè¿‡ä½è¿ç®—è¿›è¡Œä¸€æ¬¡æå–æ“ä½œï¼Œåè€Œæ›´æ…¢ã€‚**

å½“ç„¶Bitmapçš„æœ¬è´¨ï¼Œå®è´¨ä¸Šå°±æ˜¯æ›´å¥½åœ°åˆ©ç”¨ç©ºé—´æ¥åšäºŒå€¼çš„æ ‡è®°ï¼Œç›¸æ¯”äºä¸€èˆ¬çš„hashç®—æ³•ï¼Œå®ƒèƒ½è·å¾—æ›´å¥½çš„ç©ºé—´æˆæœ¬ï¼Œä»è®¡ç®—ä¸Šæ¥è¯´ï¼Œå…¶å®ä¹Ÿæ˜¯æ›´é«˜æ•ˆçš„ï¼Œåœ¨å»é‡å’Œæ’åºä¸­æœ‰æ¯”è¾ƒè‰¯å¥½çš„åº”ç”¨ã€‚

### å…·ä½“å®ç°

å…·ä½“çš„ä»£ç å®ç°ï¼Œæˆ‘ä»¬éœ€è¦å¼€è¾Ÿä¸€ä¸ªunsigned charçš„æ•°ç»„ï¼Œè®°ä½œflagsã€‚æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½è®°å½•äº†8ä¸ªQQå·æ˜¯å¦å­˜åœ¨ï¼Œå¯ä»¥ç®€å•åœ°ä»0å¼€å§‹å¾€åè®¡æ•°ï¼Œè™½ç„¶ä½æ•°å¾ˆä½çš„QQå·å…¶å®å¹¶ä¸å­˜åœ¨ã€‚

`flags[index]` ä»£è¡¨ç€ç¬¬ `index*8` ~ `index*8+7` è¿™8ä¸ªQQå·æ˜¯å¦å­˜åœ¨çš„æƒ…å†µï¼Œæœ€ä½ä½è¡¨ç¤º `index*8` æ˜¯å¦å­˜åœ¨ï¼Œè€Œæœ€é«˜ä½å°±ä»£è¡¨ `index*8+7` è¿™ä¸ªQQå·æ˜¯å¦å­˜åœ¨ã€‚

å»ºç«‹å¥½Bitmapæ•°ç»„ä¹‹åï¼Œéå†æ–‡ä»¶ä¸­çš„QQå·ï¼Œè¿›è¡Œå¯¹åº”Bitmapæ ‡è®°çš„æ›´æ–°ï¼Œæ ¹æ®QQå·è®¡ç®—å‡ºå¯¹åº”çš„flagsçš„ä¸‹æ ‡å’ŒäºŒè¿›åˆ¶çš„å“ªä¸€ä½ï¼Œè¿›è¡Œå’Œ1çš„æˆ–è¿ç®—å³å¯ã€‚

éå†å®Œæˆåï¼Œæˆ‘ä»¬åªéœ€è¦é¡ºæ¬¡éå†Bitmapçš„æ¯ä¸€ä½ï¼Œå¦‚æœä¸º1ï¼Œè¯´æ˜QQå·å­˜åœ¨ï¼Œè¾“å‡ºåˆ°æ–°æ–‡ä»¶ï¼Œä¸º0çš„ä½ç›´æ¥è·³è¿‡å³å¯ã€‚**æ•´ä¸ªè¿‡ç¨‹å®Œæˆåï¼Œå…¶å®æˆ‘ä»¬ä¸æ­¢åšåˆ°äº†å»é‡ï¼Œä¹Ÿåšåˆ°äº†æ’åº**ã€‚

æ•´ä¸ªè¿‡ç¨‹å¯ä»¥å¾ˆç®€å•åœ°ç”¨C++è¿›è¡Œå®ç°ã€‚é¦–å…ˆè¦å®ç°ä¸€ä¸ªåŸºæœ¬çš„Bitmapï¼Œå¯¹å¤–æä¾›åˆå§‹åŒ–ã€è®¾ç½®æ ‡è®°ã€è·å–æ ‡è®°3ä¸ªåŠŸèƒ½ã€‚

```c++
class BitMap{
private:
    char *flags;
    int size;
public:
Â  Â  BitMap(){
Â  Â  Â  Â  flags = NULL;
Â  Â  Â  Â  size = 0;
Â  Â  }

Â  Â  BitMap(int size){
        // å£°æ˜bitmapæ•°ç»„
Â  Â  Â  Â  flags = NULL;
Â  Â  Â  Â  flags = new char[size];
Â  Â  Â  Â  memset(flags, 0x0, size * sizeof(char));
Â  Â  Â  Â  this->size = size;

Â  Â  }
  
    // æ ¹æ®indexè®¾ç½®å…ƒç´ æ˜¯å¦å‡ºç°è¿‡
Â  Â  int bitmapSet(int index){
Â  Â  Â  Â  int addr = index/8;
Â  Â  Â  Â  int offset = index%8;
Â  Â  Â  Â  unsigned char b = 0x1 << offset;
Â  Â  Â  Â  if (addr > (size+1)) {
Â  Â  Â  Â  Â  Â  return 0;
Â  Â  Â  Â  }else{
Â  Â  Â  Â  Â  Â  flags[addr] |= b;
Â  Â  Â  Â  Â  Â  return 1;
Â  Â  Â  Â  }
Â  Â  }
    
    // æ ¹æ®indexæŸ¥çœ‹å…ƒç´ æ˜¯å¦å‡ºç°è¿‡
Â  Â  int bitmapGet(int index){
Â  Â  Â  Â  int addr = index/8;
Â  Â  Â  Â  int offset = index%8;
Â  Â  Â  Â  unsigned char temp = 0x1 << offset;
Â  Â  Â  Â  if (addr > (size + 1)) {
Â  Â  Â  Â  Â  Â  return 0;
Â  Â  Â  Â  }else{
Â  Â  Â  Â  Â  Â  return (flags[addr] & temp) > 0 ? 1 : 0;
Â  Â  Â  Â  }
Â  Â  }
};
```

æœ‰äº†è¿™æ ·çš„åŸºæœ¬èƒ½åŠ›ï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯éå†æ–‡ä»¶çš„éƒ¨åˆ†ï¼Œç”±äºæ–‡ä»¶IOå’Œè§£æçš„éƒ¨åˆ†ä¸æ˜¯ä»Šå¤©çš„é‡ç‚¹ï¼Œæˆ‘ä»¬ç›´æ¥å¤„ç†ä¸€ä¸ªåœ¨å†…å­˜ä¸­çš„QQå·æ•°ç»„ã€‚

```c++
int remove_dup(vector<unsigned int> qqs) {
  BitMap b = new BitMap(4000000000);
  for (int i = 0; i < qqs.size(); i++) {
    b.bitmapSet(qqs[i]);
  }
  for (int i = 0; i < 4000000000; i++) {
    if (b.bitmapGet(i)) cout << i << endl;
  }
  return 0;
}
```

å¦‚æœå°è£…å¥½äº†åŸºæœ¬çš„Bitmapé€»è¾‘ä¹‹åï¼Œä½¿ç”¨è¿‡ç¨‹å’Œhashmapçœ‹èµ·æ¥æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§åŒºåˆ«ï¼Œä½ å¯ä»¥è®¤ä¸ºBitmapå°±æ˜¯ä¸€ç§å¯¹æ•°å­—çš„æ•£åˆ—æ–¹å¼ï¼Œå’Œæ•°ç»„ç”¨äºå»é‡çš„åœºæ™¯ç›¸ä¼¼ï¼Œé€‚ç”¨äºä¸‹æ ‡æ¯”è¾ƒå¯†é›†çš„æƒ…å†µï¼Œå¦åˆ™ä»ç„¶ä¼šæµªè´¹å¤§é‡çš„ç©ºé—´ï¼Œåœ¨QQå·å»é‡çš„åœºæ™¯ä¸‹å°±éå¸¸å¥½ç”¨ã€‚

## æ•°æ®åº“ä¸­çš„Bitmapç´¢å¼•

Bitmapæ—¢ç„¶å¯ä»¥é€‚ç”¨äºæ’åºï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨æ¥åšç´¢å¼•ã€‚**åœ¨æ•°æ®åº“ä¸­å°±æœ‰ä¸€ç±»ç´¢å¼•è¢«ç§°ä¸ºBitmapç´¢å¼•ï¼Œä½å›¾ç´¢å¼•ï¼Œæ¯”è¾ƒé€‚ç”¨äºæŸä¸ªå­—æ®µåªæœ‰éƒ¨åˆ†å¯é€‰å€¼çš„æƒ…å†µ**ï¼Œæ¯”å¦‚æ€§åˆ«çš„ç”·ã€å¥³ï¼Œæˆ–è€…æ‰€åœ¨åŸå¸‚ä¹‹ç±»ã€‚

é‡‡ç”¨ä½å›¾ç´¢å¼•ï¼Œä¸æ­¢å¯ä»¥é™ä½ç©ºé—´æˆæœ¬ï¼Œåœ¨å¤šæ¡ä»¶æŸ¥è¯¢ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åŸºäºä½è¿ç®—æé«˜ç´¢å¼•çš„åˆ©ç”¨ç‡ã€‚çœ‹ä¸ªå…·ä½“ä¾‹å­ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/9a/d2/9a93d8362bb6f9173541e6ce0ccde0d2.jpg?wh=1920x956)

ç°åœ¨æˆ‘ä»¬æœ‰ä¸€å¼ åŒ—äº¬å¸‚æŸæ‰€å­¦æ ¡çš„å­¦ç”Ÿä¿¡æ¯è¡¨ï¼Œå…¶ä¸­æœ‰ä¸¤åˆ—ï¼Œåˆ†åˆ«è®°å½•äº†æ€§åˆ«å’Œæ‰€åœ¨åŒºï¼Œè¿™ä¸¤åˆ—æ˜¾ç„¶éƒ½å±äºæœ‰å›ºå®šæšä¸¾å€¼çš„æƒ…å†µã€‚è¿™é‡Œä¸ºäº†è®²è§£æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç®€å•å‡è®¾æ‰€åŒ…å«çš„åŒºåªæœ‰æµ·æ·€ã€æœé˜³ã€ä¸œåŸã€è¥¿åŸè¿™å››ä¸ªã€‚

**å¦‚æœé‡‡ç”¨ä¼ ç»Ÿçš„B+æ ‘å»ºç«‹ç´¢å¼•ï¼Œåœ¨æ€§åˆ«è¿™ä¸€æ ä¸ŠåŒºåˆ†åº¦å…¶å®å¾ˆä½ï¼Œå› ä¸ºå¾ˆå¤§çš„æ¦‚ç‡æˆ‘ä»¬ä»»æ„ä¸€ä¸ªç­›é€‰æ¡ä»¶éƒ½è¦ç­›é€‰å‡ºæ¥è¿‘åŠæ•°çš„å…ƒç´ **ï¼Œæ‰€ä»¥ï¼ŒåŸºæœ¬ä¸Šå…ˆåˆ©ç”¨æ€§åˆ«çš„çº¢é»‘æ ‘æ£€ç´¢å°±æ²¡æœ‰ä»€ä¹ˆæŸ¥è¯¢ä¼˜åŠ¿äº†ï¼Œäº‹å®ä¸Šåœ¨å¤§éƒ¨åˆ†çš„æ•°æ®åº“ä¸­ä¹Ÿä¼šç›´æ¥é€‰æ‹©å…¨å±€éå†ã€‚åŒæ ·çš„åœ¨åŒºè¿™ä¸€ç»´åº¦çœ‹ï¼Œç”±äºæˆ‘ä»¬å‡è®¾åªæœ‰4ä¸ªå¯é€‰é¡¹ï¼Œé‡‡ç”¨B+æ ‘ä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«å¤§çš„å¥½å¤„ã€‚

è€Œä½å›¾ç´¢å¼•åœ¨è¿™æ ·å›ºå®šæšä¸¾å€¼çš„åœºæ™¯ä¸‹éå¸¸åˆé€‚ï¼Œå…·ä½“åšæ³•å°±æ˜¯æˆ‘ä»¬ä¼šä¸ºæ€§åˆ«ç”·ã€æ€§åˆ«å¥³ï¼Œæµ·æ·€åŒºã€æœé˜³åŒºã€ä¸œåŸåŒºã€è¥¿åŸåŒºè¿™æ ·å‡ ä¸ªç‹¬ç«‹çš„é€‰é¡¹ï¼Œéƒ½å»ºç«‹ä¸€ä¸ªä½å›¾å‘é‡ï¼Œä½œä¸ºç´¢å¼•ã€‚æ¯”å¦‚ï¼š

```sql
æ€§åˆ«_ç”·= 10010101
æ€§åˆ«_å¥³= 01101010

åŒº_æœé˜³= 00000100
```

å°±æ„å‘³ç€id=7\\4\\3\\0çš„å­¦ç”Ÿæ€§åˆ«ä¸ºç”·ï¼Œid=1\\2\\5\\6 çš„å­¦ç”Ÿä¸ºå¥³ã€‚

å½“ç„¶ç”±äºæ•°æ®åº“å­˜å‚¨çš„æ•°æ®é‡è¦å¤§çš„å¤šï¼Œæˆ‘ä»¬ä¼šé‡‡ç”¨æ›´é•¿çš„Bitmapæ¥å­˜å‚¨æ‰€æœ‰å­¦ç”Ÿåœ¨æŸä¸ªkeyä¸ºä¸åŒå–å€¼çš„æƒ…å†µã€‚

**ä½¿ç”¨ä½å›¾ç´¢å¼•ï¼Œæœ€å¤§çš„å¥½å¤„å°±åœ¨äºå¤šæŸ¥è¯¢æ¡ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡å¯¹Bitmapçš„ä½è¿ç®—æ¥è·å¾—ç»“æœé›†çš„å‘é‡**ã€‚æ¯”å¦‚æƒ³è·å¾—æœé˜³åŒºçš„å¥³ç”Ÿï¼Œåªéœ€è¦å¯¹`åŒº_æœé˜³`å’Œ `æ€§åˆ«_å¥³` è¿™ä¸¤ä¸ªBitmapåšä¸è¿ç®—ï¼Œå°±å¯ä»¥å¾—åˆ°åŒæ—¶ç¬¦åˆä¸¤ä¸ªæ¡ä»¶çš„ç»“æœé›†å‘é‡ï¼Œæ¯”å¦‚åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œä¸¤è€…ä¸å¾—ç»“æœä¸º0ï¼Œè¯´æ˜ä¸å­˜åœ¨è¿™æ ·çš„å­¦ç”Ÿã€‚ç›¸æ¯”äºB+æ ‘ï¼Œä½å›¾ç´¢å¼•æ•ˆç‡å°±ä¼šé«˜å¾ˆå¤šã€‚

## æ€»ç»“

Bitmapä½å›¾ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ç§é€šè¿‡äºŒè¿›åˆ¶ä½æ¥è®°å½•çŠ¶æ€çš„æ•°æ®ç»“æ„ã€‚æ¯”åŸºäºç¡¬ä»¶ç‰¹æ€§è®¾è®¡ã€ç”¨ä¸€ä¸ªå­—èŠ‚æ¥å­˜å‚¨boolç±»å‹çš„æ–¹å¼ï¼Œæé«˜äº†8å€çš„å­˜å‚¨æ•ˆç‡ï¼Œå¯ä»¥ç”¨æ›´å°‘çš„ç©ºé—´æ¥è¡¨ç¤ºçŠ¶æ€ã€‚

Bitmapåœ¨å¤§é‡æ•°æ®å»é‡å’Œæ’åºçš„åœºæ™¯ä¸‹å¾ˆæœ‰ç”¨ï¼Œæ¯”å¦‚å¤§é‡QQå·çš„å»é‡é—®é¢˜ï¼›åœ¨å†…å­˜èµ„æºæ•æ„Ÿã€éœ€è¦æ ‡è®°çŠ¶æ€çš„åœºæ™¯ä¸‹ä¹Ÿå¾ˆå¸¸è§ï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿä¸­å­˜å‚¨æŸä¸ªblockæ˜¯å¦è¢«å ç”¨çš„çŠ¶æ€ï¼Œç”¨åˆ°çš„å°±æ˜¯Bitmapã€‚

åœ¨æ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æšä¸¾ç±»å‹çš„å±æ€§ä¸Šå»ºç«‹ä½å›¾ç´¢å¼•ï¼Œä¸ºå±æ€§çš„æ¯ä¸ªå–å€¼å»ºç«‹ä¸€ä¸ªä½å›¾ï¼Œä»è€Œå¯ä»¥å¤§å¤§æé«˜å¤šæ¡ä»¶è¿‡æ»¤æŸ¥è¯¢çš„æ•ˆç‡ã€‚äº‹å®ä¸Šï¼Œä¹‹åä¼šè®²åˆ°çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œåº•å±‚ä¹Ÿæ˜¯åŸºäºä½å›¾çš„æ€æƒ³ï¼Œå¦‚æœä½ çš„å·¥ä½œä¸­æœ‰å»é‡çš„éœ€è¦ï¼Œä¹Ÿä¸å¦¨è€ƒè™‘ä¸€ä¸‹é‡‡ç”¨ä½å›¾å®ç°çš„æ–¹å¼ï¼Œè¯´ä¸å®šå°±èƒ½å¤§å¤§æé«˜ç³»ç»Ÿçš„æ€§èƒ½ã€‚

### è¯¾åç»ƒä¹ 

ä»Šå¤©ä¸»è¦è®²çš„å°±æ˜¯QQå·é¢è¯•é¢˜ï¼Œè¯¾åä½ å¯ä»¥å°è¯•è‡ªå·±åŠ¨æ‰‹å®ç°ä¸€ä¸‹ï¼Œå¦å¤–æœ‰æ—¶æˆ‘ä»¬çš„Bitmapä¹Ÿä¼šéœ€è¦æŠŠè®¾ç½®ä¸º1çš„çŠ¶æ€æ¸…é™¤ï¼Œç›®å‰æˆ‘ä»¬æ²¡æœ‰æä¾›è¿™æ ·çš„æ¥å£ï¼Œæ¬¢è¿æŠŠä½ çš„ä»£ç è´´åœ¨ç•™è¨€åŒºï¼Œä¸€èµ·è®¨è®ºã€‚

å¦‚æœè§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿è½¬å‘ç»™ä½ çš„æœ‹å‹ä¸€èµ·å­¦ä¹ ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ5ï¼‰</strong></div><ul>
<li><span>Geek_37dde4</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é¢˜ç›®å¾ˆçœŸå® è…¾è®¯3é¢é‡åˆ°è¿‡ åŸé¢˜æ˜¯è®¾è®¡å­˜å‚¨ç»“æ„å­˜å‚¨10ä½qqå·çš„åœ¨çº¿çŠ¶æ€</p>2022-03-17</li><br/><li><span>é™ˆæ°¸å¼º</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œæ˜¯ä¸æ˜¯æœ‰ä¸€è¡Œä»£ç å†™é”™å•¦ï¼Ÿï¼Ÿ

BitMap(int size){
        &#47;&#47; å£°æ˜bitmapæ•°ç»„
        flags = NULL;
        flags = new char[size];
        memset(flags, 0x0, size * sizeof(char));
        this-&gt;size = size;
    }

ä¸­çš„ flags = new char[size]; æ˜¯ä¸æ˜¯sizeè¦é™¤ä»¥8å‘¢ï¼Ÿ</p>2022-04-09</li><br/><li><span>blentle</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å¸ƒéš†è¿‡æ»¤å™¨</p>2022-03-01</li><br/><li><span>æ‹“å±±</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ã€æ•´ä¸ªè¿‡ç¨‹å®Œæˆåï¼Œå…¶å®æˆ‘ä»¬ä¸æ­¢åšåˆ°äº†å»é‡ï¼Œä¹Ÿåšåˆ°äº†æ’åºã€‘

bitMapè¿™ä¸ªæ’åºè¯´çš„ä¸å¯¹å§ï¼ŒbitMapåªèƒ½æ ‡è®° hashä¹‹åçš„æ•°å­—è¢«å‹ç¼©åœ¨æŸä¸€ä¸ªbitä½ä¸Šã€‚æ²¡æœ‰ä»€ä¹ˆæ’åºçš„èƒ½åŠ›</p>2023-08-10</li><br/><li><span>å¥•</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>bitmap ä¸€èˆ¬ç”¨äºè®¡æ•°ï¼Œæ˜¯å¦å­˜åœ¨çš„åœºæ™¯</p>2022-07-24</li><br/>
</ul>