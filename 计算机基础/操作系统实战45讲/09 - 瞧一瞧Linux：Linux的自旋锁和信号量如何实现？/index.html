<!--geek time docs 🚀, MIT license-->


<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="极客时间文档">
      
      
        <meta name="author" content="zkep">
      
      
        <link rel="canonical" href="https://github.com/uaxe/geektime-docs/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E6%88%9845%E8%AE%B2/09%20-%20%E7%9E%A7%E4%B8%80%E7%9E%A7Linux%EF%BC%9ALinux%E7%9A%84%E8%87%AA%E6%97%8B%E9%94%81%E5%92%8C%E4%BF%A1%E5%8F%B7%E9%87%8F%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%EF%BC%9F/">
      
      
        <link rel="prev" href="../08%20-%20%E9%94%81%EF%BC%9A%E5%B9%B6%E5%8F%91%E6%93%8D%E4%BD%9C%E4%B8%AD%EF%BC%8C%E8%A7%A3%E5%86%B3%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E6%B3%95/">
      
      
        <link rel="next" href="../10%20-%20%E8%AE%BE%E7%BD%AE%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E4%B8%8E%E7%8E%AF%E5%A2%83%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E5%BB%BA%E7%AB%8B%E8%AE%A1%E7%AE%97%E6%9C%BA/">
      
      
      <link rel="icon" href="../../../None">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.5">
    
    
      
        <title>09 瞧一瞧Linux：Linux的自旋锁和信号量如何实现？ - 极客时间文档</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/style.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#linux" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            


          </div>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="极客时间文档" class="md-header__button md-logo" aria-label="极客时间文档" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            极客时间文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              09   瞧一瞧Linux：Linux的自旋锁和信号量如何实现？
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/zkep/mygeektime" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zkep/mygeektime
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../AI-%E5%A4%A7%E6%95%B0%E6%8D%AE/" class="md-tabs__link">
          
  
    
  
  AI-大数据

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E4%BA%A7%E5%93%81-%E8%BF%90%E8%90%A5/" class="md-tabs__link">
          
  
    
  
  产品-运营

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E5%89%8D%E7%AB%AF-%E7%A7%BB%E5%8A%A8/" class="md-tabs__link">
          
  
    
  
  前端-移动

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E5%90%8E%E7%AB%AF-%E6%9E%B6%E6%9E%84/" class="md-tabs__link">
          
  
    
  
  后端-架构

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E7%AE%A1%E7%90%86-%E6%88%90%E9%95%BF/" class="md-tabs__link">
          
  
    
  
  管理-成长

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
    
  
  计算机基础

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E8%BF%90%E7%BB%B4-%E6%B5%8B%E8%AF%95/" class="md-tabs__link">
          
  
    
  
  运维-测试

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="极客时间文档" class="md-nav__button md-logo" aria-label="极客时间文档" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    极客时间文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/zkep/mygeektime" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    zkep/mygeektime
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../AI-%E5%A4%A7%E6%95%B0%E6%8D%AE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    AI-大数据
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../%E4%BA%A7%E5%93%81-%E8%BF%90%E8%90%A5/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    产品-运营
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../%E5%89%8D%E7%AB%AF-%E7%A7%BB%E5%8A%A8/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    前端-移动
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../%E5%90%8E%E7%AB%AF-%E6%9E%B6%E6%9E%84/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    后端-架构
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../%E7%AE%A1%E7%90%86-%E6%88%90%E9%95%BF/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    管理-成长
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    计算机基础
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            计算机基础
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../MySQL%20%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A/MySQL%20%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    MySQL 必知必会
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../Python%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8A%9E%E5%85%AC%E5%AE%9E%E6%88%98%E8%AF%BE/Python%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8A%9E%E5%85%AC%E5%AE%9E%E6%88%98%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Python自动化办公实战课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../Vim%20%E5%AE%9E%E7%94%A8%E6%8A%80%E5%B7%A7%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A/Vim%20%E5%AE%9E%E7%94%A8%E6%8A%80%E5%B7%A7%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Vim 实用技巧必知必会
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E4%B8%9A%E5%8A%A1%E5%BC%80%E5%8F%91%E7%AE%97%E6%B3%9550%E8%AE%B2/%E4%B8%9A%E5%8A%A1%E5%BC%80%E5%8F%91%E7%AE%97%E6%B3%9550%E8%AE%B2/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    业务开发算法50讲
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E4%BB%A3%E7%A0%81%E4%B9%8B%E4%B8%91/%E4%BB%A3%E7%A0%81%E4%B9%8B%E4%B8%91/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    代码之丑
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E4%BB%A3%E7%A0%81%E7%B2%BE%E8%BF%9B%E4%B9%8B%E8%B7%AF/%E4%BB%A3%E7%A0%81%E7%B2%BE%E8%BF%9B%E4%B9%8B%E8%B7%AF/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    代码精进之路
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8BC%2B%2B%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8BC%2B%2B%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    快速上手C++数据结构与算法
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E6%89%8B%E6%8A%8A%E6%89%8B%E5%B8%A6%E4%BD%A0%E5%86%99%E4%B8%80%E9%97%A8%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/%E6%89%8B%E6%8A%8A%E6%89%8B%E5%B8%A6%E4%BD%A0%E5%86%99%E4%B8%80%E9%97%A8%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    手把手带你写一门编程语言
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_10" checked>
        
          
          <label class="md-nav__link" for="__nav_6_10" id="__nav_6_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    操作系统实战45讲
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6_10">
            <span class="md-nav__icon md-icon"></span>
            操作系统实战45讲
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E6%88%9845%E8%AE%B2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    操作系统实战45讲
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%BC%80%E7%AF%87%E8%AF%8D%20-%20%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%AD%A6%E5%86%99%E4%B8%80%E4%B8%AA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开篇词   为什么要学写一个操作系统？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../03%20-%20%E9%BB%91%E7%9B%92%E4%B9%8B%E4%B8%AD%E6%9C%89%E4%BB%80%E4%B9%88%EF%BC%9A%E5%86%85%E6%A0%B8%E7%BB%93%E6%9E%84%E4%B8%8E%E8%AE%BE%E8%AE%A1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    03   黑盒之中有什么：内核结构与设计
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../04%20-%20%E9%9C%87%E6%92%BC%E7%9A%84Linux%E5%85%A8%E6%99%AF%E5%9B%BE%EF%BC%9A%E4%B8%9A%E7%95%8C%E6%88%90%E7%86%9F%E7%9A%84%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84%E9%95%BF%E4%BB%80%E4%B9%88%E6%A0%B7%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    04   震撼的Linux全景图：业界成熟的内核架构长什么样？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../08%20-%20%E9%94%81%EF%BC%9A%E5%B9%B6%E5%8F%91%E6%93%8D%E4%BD%9C%E4%B8%AD%EF%BC%8C%E8%A7%A3%E5%86%B3%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E6%B3%95/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    08   锁：并发操作中，解决数据同步的四种方法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    09   瞧一瞧Linux：Linux的自旋锁和信号量如何实现？
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    09   瞧一瞧Linux：Linux的自旋锁和信号量如何实现？
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      Linux的原子变量
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux_1" class="md-nav__link">
    <span class="md-ellipsis">
      Linux控制中断
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux_2" class="md-nav__link">
    <span class="md-ellipsis">
      Linux自旋锁
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Linux自旋锁">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#linux_3" class="md-nav__link">
    <span class="md-ellipsis">
      Linux原始自旋锁
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linux_4" class="md-nav__link">
    <span class="md-ellipsis">
      Linux排队自旋锁
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux_5" class="md-nav__link">
    <span class="md-ellipsis">
      Linux信号量
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux_6" class="md-nav__link">
    <span class="md-ellipsis">
      Linux读写锁
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      重点回顾
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      思考题
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../10%20-%20%E8%AE%BE%E7%BD%AE%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E4%B8%8E%E7%8E%AF%E5%A2%83%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E5%BB%BA%E7%AB%8B%E8%AE%A1%E7%AE%97%E6%9C%BA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    10   设置工作模式与环境（上）：建立计算机
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../11%20-%20%E8%AE%BE%E7%BD%AE%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E4%B8%8E%E7%8E%AF%E5%A2%83%EF%BC%88%E4%B8%AD%EF%BC%89%EF%BC%9A%E5%BB%BA%E9%80%A0%E4%BA%8C%E7%BA%A7%E5%BC%95%E5%AF%BC%E5%99%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    11   设置工作模式与环境（中）：建造二级引导器
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../12%20-%20%E8%AE%BE%E7%BD%AE%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E4%B8%8E%E7%8E%AF%E5%A2%83%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E6%8E%A2%E6%9F%A5%E5%92%8C%E6%94%B6%E9%9B%86%E4%BF%A1%E6%81%AF/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    12   设置工作模式与环境（下）：探查和收集信息
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../13%20-%20%E7%AC%AC%E4%B8%80%E4%B8%AAC%E5%87%BD%E6%95%B0%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%9D%BF%E7%BA%A7%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    13   第一个C函数：如何实现板级初始化？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../14%20-%20Linux%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9AGRUB%E4%B8%8Evmlinuz%E7%9A%84%E7%BB%93%E6%9E%84/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    14   Linux初始化（上）：GRUB与vmlinuz的结构
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../15%20-%20Linux%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E4%BB%8E_start%E5%88%B0%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    15   Linux初始化（下）：从 start到第一个进程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../24%20-%20%E6%B4%BB%E5%8A%A8%E7%9A%84%E6%8F%8F%E8%BF%B0%EF%BC%9A%E5%88%B0%E5%BA%95%E4%BB%80%E4%B9%88%E6%98%AF%E8%BF%9B%E7%A8%8B%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    24   活动的描述：到底什么是进程？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../25%20-%20%E5%A4%9A%E4%B8%AA%E6%B4%BB%E5%8A%A8%E8%A6%81%E5%AE%89%E6%8E%92%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%A6%82%E4%BD%95%E8%B0%83%E5%BA%A6%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    25   多个活动要安排（上）：多进程如何调度？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../26%20-%20%E5%A4%9A%E4%B8%AA%E6%B4%BB%E5%8A%A8%E8%A6%81%E5%AE%89%E6%8E%92%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%AD%89%E5%BE%85%E4%B8%8E%E5%94%A4%E9%86%92%E6%9C%BA%E5%88%B6%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    26   多个活动要安排（下）：如何实现进程的等待与唤醒机制？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../27%20-%20%E7%9E%A7%E4%B8%80%E7%9E%A7Linux%EF%BC%9ALinux%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    27   瞧一瞧Linux：Linux如何实现进程与进程调度？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../28%20-%20%E9%83%A8%E9%97%A8%E5%88%86%E7%B1%BB%EF%BC%9A%E5%A6%82%E4%BD%95%E8%A1%A8%E7%A4%BA%E8%AE%BE%E5%A4%87%E7%B1%BB%E5%9E%8B%E4%B8%8E%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    28   部门分类：如何表示设备类型与设备驱动？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../29%20-%20%E9%83%A8%E9%97%A8%E5%BB%BA%E7%AB%8B%EF%BC%9A%E5%A6%82%E4%BD%95%E5%9C%A8%E5%86%85%E6%A0%B8%E4%B8%AD%E6%B3%A8%E5%86%8C%E8%AE%BE%E5%A4%87%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    29   部门建立：如何在内核中注册设备？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../30%20-%20%E9%83%A8%E9%97%A8%E5%93%8D%E5%BA%94%EF%BC%9A%E8%AE%BE%E5%A4%87%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%86%85%E6%A0%B8I-O%E5%8C%85%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    30   部门响应：设备如何处理内核I O包？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../31%20-%20%E7%9E%A7%E4%B8%80%E7%9E%A7Linux%EF%BC%9A%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E8%AE%BE%E5%A4%87%E4%BF%A1%E6%81%AF%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    31   瞧一瞧Linux：如何获取所有设备信息？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../32%20-%20%E4%BB%93%E5%BA%93%E7%BB%93%E6%9E%84%EF%BC%9A%E5%A6%82%E4%BD%95%E7%BB%84%E7%BB%87%E6%96%87%E4%BB%B6%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    32   仓库结构：如何组织文件？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../33%20-%20%E4%BB%93%E5%BA%93%E5%88%92%E5%88%86%EF%BC%9A%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%8C%96%E6%93%8D%E4%BD%9C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    33   仓库划分：文件系统的格式化操作
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../34%20-%20%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E7%9A%84%E5%85%AD%E5%A4%A7%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    34   仓库管理：如何实现文件的六大基本操作？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../35%20-%20%E7%9E%A7%E4%B8%80%E7%9E%A7Linux%EF%BC%9A%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E7%AE%A1%E7%90%86%E6%96%87%E4%BB%B6%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    35   瞧一瞧Linux：虚拟文件系统如何管理文件？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../36%20-%20%E4%BB%8EURL%E5%88%B0%E7%BD%91%E5%8D%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E5%85%A8%E5%B1%80%E8%A7%82%E5%AF%9F%E7%BD%91%E7%BB%9C%E6%95%B0%E6%8D%AE%E6%B5%81%E5%8A%A8%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    36   从URL到网卡：如何全局观察网络数据流动？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../37%20-%20%E4%BB%8E%E5%86%85%E6%A0%B8%E5%88%B0%E5%BA%94%E7%94%A8%EF%BC%9A%E7%BD%91%E7%BB%9C%E6%95%B0%E6%8D%AE%E5%9C%A8%E5%86%85%E6%A0%B8%E4%B8%AD%E5%A6%82%E4%BD%95%E6%B5%81%E8%BD%AC/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    37   从内核到应用：网络数据在内核中如何流转
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../38%20-%20%E4%BB%8E%E5%8D%95%E6%8E%92%E5%88%B0%E5%9B%A2%E6%88%98%EF%BC%9A%E8%AF%A6%E8%A7%A3%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AE%8F%E8%A7%82%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    38   从单排到团战：详解操作系统的宏观网络架构
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../41%20-%20%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%EF%BC%9A%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BA%E6%B2%9F%E9%80%9A%E6%A1%A5%E6%A2%81%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    41   服务接口：如何搭建沟通桥梁？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../42%20-%20%E7%9E%A7%E4%B8%80%E7%9E%A7Linux%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%B3%BB%E7%BB%9FAPI%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    42   瞧一瞧Linux：如何实现系统API？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../43%20-%20%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%86%85%E6%A0%B8%EF%BC%9AKVM%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    43   虚拟机内核：KVM是什么？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../44%20-%20%E5%AE%B9%E5%99%A8%EF%BC%9A%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    44   容器：如何理解容器的实现机制？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../45%20-%20ARM%E6%96%B0%E5%AE%A0%EF%BC%9A%E8%8B%B9%E6%9E%9C%E7%9A%84M1%E8%8A%AF%E7%89%87%E5%9B%A0%E4%BD%95%E8%80%8C%E5%BF%AB%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    45   ARM新宠：苹果的M1芯片因何而快？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../46%20-%20AArch64%E4%BD%93%E7%B3%BB%EF%BC%9AARM%E6%9C%80%E6%96%B0%E7%BC%96%E7%A8%8B%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%9E%8B%E5%89%96%E6%9E%90/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    46   AArch64体系：ARM最新编程架构模型剖析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%BB%93%E6%9D%9F%E8%AF%AD%20-%20%E7%94%9F%E6%B4%BB%E5%8F%AF%E4%BB%A5%E4%B8%80%E5%9C%B0%E9%B8%A1%E6%AF%9B%EF%BC%8C%E4%BD%86%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8D%B4%E6%98%AF%E5%BF%83%E4%B8%AD%E7%9A%84%E5%85%89/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    结束语   生活可以一地鸡毛，但操作系统却是心中的光
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%BB%93%E8%AF%BE%E6%B5%8B%E8%AF%95%20-%E8%BF%99%E4%BA%9B%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%8C%E4%BD%A0%E9%83%BD%E6%8E%8C%E6%8F%A1%E4%BA%86%E4%B9%88%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    结课测试  这些操作系统的问题，你都掌握了么？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%A4%A7%E5%92%96%E5%8A%A9%E5%9C%BA-%E4%BB%A5%E6%97%A0%E6%B3%95%E4%B8%BA%E6%9C%89%E6%B3%95%EF%BC%8C%E4%BB%A5%E6%97%A0%E9%99%90%E4%B8%BA%E6%9C%89%E9%99%90/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    大咖助场 以无法为有法，以无限为有限
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../LMOS%E6%9D%A5%E4%BF%A1%EF%BC%9A%E7%AC%AC%E4%BA%8C%E5%AD%A3%E8%AF%BE%E7%A8%8B%E5%B8%A6%E4%BD%A0%E2%80%9C%E6%89%8B%E6%92%95%E2%80%9D%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LMOS来信：第二季课程带你“手撕”计算机基础
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%BC%96%E8%BE%91%E6%89%8B%E8%AE%B0%20-%20%E5%8D%87%E7%BA%A7%E8%AE%A4%E7%9F%A5%EF%BC%8C%E8%BF%AD%E4%BB%A3%E8%87%AA%E5%B7%B1%E7%9A%84%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    编辑手记   升级认知，迭代自己的操作系统
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../01%20-%20%E7%A8%8B%E5%BA%8F%E7%9A%84%E8%BF%90%E8%A1%8C%E8%BF%87%E7%A8%8B%EF%BC%9A%E4%BB%8E%E4%BB%A3%E7%A0%81%E5%88%B0%E6%9C%BA%E5%99%A8%E8%BF%90%E8%A1%8C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    01   程序的运行过程：从代码到机器运行
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../02%20-%20%E5%87%A0%E8%A1%8C%E6%B1%87%E7%BC%96%E5%87%A0%E8%A1%8CC%EF%BC%9A%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E6%A0%B8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    02   几行汇编几行C：实现一个最简单的内核
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../05%20-%20CPU%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%EF%BC%9A%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F%E7%9A%84%E4%B8%89%E7%A7%8D%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    05   CPU工作模式：执行程序的三种模式
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../06%20-%20%E8%99%9A%E5%B9%BB%E4%B8%8E%E7%9C%9F%E5%AE%9E%EF%BC%9A%E7%A8%8B%E5%BA%8F%E4%B8%AD%E7%9A%84%E5%9C%B0%E5%9D%80%E5%A6%82%E4%BD%95%E8%BD%AC%E6%8D%A2%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    06   虚幻与真实：程序中的地址如何转换？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../07%20-%20Cache%E4%B8%8E%E5%86%85%E5%AD%98%EF%BC%9A%E7%A8%8B%E5%BA%8F%E6%94%BE%E5%9C%A8%E5%93%AA%E5%84%BF%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    07   Cache与内存：程序放在哪儿？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../16%20-%20%E5%88%92%E5%88%86%E5%9C%9F%E5%9C%B0%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E5%88%92%E5%88%86%E4%B8%8E%E7%BB%84%E7%BB%87%E5%86%85%E5%AD%98%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    16   划分土地（上）：如何划分与组织内存？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../17%20-%20%E5%88%92%E5%88%86%E5%9C%9F%E5%9C%B0%EF%BC%88%E4%B8%AD%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%86%85%E5%AD%98%E9%A1%B5%E9%9D%A2%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    17   划分土地（中）：如何实现内存页面初始化？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../18%20-%20%E5%88%92%E5%88%86%E5%9C%9F%E5%9C%B0%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%86%85%E5%AD%98%E9%A1%B5%E7%9A%84%E5%88%86%E9%85%8D%E4%B8%8E%E9%87%8A%E6%94%BE%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    18   划分土地（下）：如何实现内存页的分配与释放？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../19%20-%20%E5%9C%9F%E5%9C%B0%E4%B8%8D%E8%83%BD%E6%B5%AA%E8%B4%B9%EF%BC%9A%E5%A6%82%E4%BD%95%E7%AE%A1%E7%90%86%E5%86%85%E5%AD%98%E5%AF%B9%E8%B1%A1%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    19   土地不能浪费：如何管理内存对象？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../20%20-%20%E5%9C%9F%E5%9C%B0%E9%9C%80%E6%B1%82%E6%89%A9%E5%A4%A7%E4%B8%8E%E4%BF%9D%E9%9A%9C%EF%BC%9A%E5%A6%82%E4%BD%95%E8%A1%A8%E7%A4%BA%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    20   土地需求扩大与保障：如何表示虚拟内存？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../21%20-%20%E5%9C%9F%E5%9C%B0%E9%9C%80%E6%B1%82%E6%89%A9%E5%A4%A7%E4%B8%8E%E4%BF%9D%E9%9A%9C%EF%BC%9A%E5%A6%82%E4%BD%95%E5%88%86%E9%85%8D%E5%92%8C%E9%87%8A%E6%94%BE%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    21   土地需求扩大与保障：如何分配和释放虚拟内存？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../22%20-%20%E7%9E%A7%E4%B8%80%E7%9E%A7Linux%EF%BC%9A%E4%BC%99%E4%BC%B4%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    22   瞧一瞧Linux：伙伴系统如何分配内存？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../23%20-%20%E7%9E%A7%E4%B8%80%E7%9E%A7Linux%EF%BC%9ASLAB%E5%A6%82%E4%BD%95%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    23   瞧一瞧Linux：SLAB如何分配内存？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../39%20-%20%E7%9E%A7%E4%B8%80%E7%9E%A7Linux%EF%BC%9A%E8%AF%A6%E8%A7%A3socket%E5%AE%9E%E7%8E%B0%E4%B8%8E%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    39   瞧一瞧Linux：详解socket实现与网络编程接口
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../40%20-%20%E7%9E%A7%E4%B8%80%E7%9E%A7Linux%EF%BC%9A%E8%AF%A6%E8%A7%A3socket%E7%9A%84%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    40   瞧一瞧Linux：详解socket的接口实现
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%94%A8%E6%88%B7%E6%95%85%E4%BA%8B%20-%20%E6%88%90%E4%B8%BA%E9%9D%A2%E5%90%91%E2%80%9C%E7%9F%A5%E8%AF%86%E5%BA%93%E2%80%9D%E7%9A%84%E5%B7%A5%E7%A8%8B%E5%B8%88/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    用户故事   成为面向“知识库”的工程师
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%94%A8%E6%88%B7%E6%95%85%E4%BA%8B%20-%20%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8F%91%E7%83%A7%E5%8F%8B%EF%BC%9A%E7%9C%8B%E4%B8%8D%E6%87%82%EF%BC%9F%E5%9B%A0%E4%B8%BA%E4%BD%A0%E6%B2%A1%E5%8A%A8%E6%89%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    用户故事   操作系统发烧友：看不懂？因为你没动手
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%94%A8%E6%88%B7%E6%95%85%E4%BA%8B%20-%20%E6%8A%80%E6%9C%AF%E4%BA%BA%E5%A6%82%E4%BD%95%E5%81%9A%E9%80%89%E6%8B%A9%EF%BC%8C%E8%B7%AF%E6%89%8D%E8%B6%8A%E8%B5%B0%E8%B6%8A%E5%AE%BD%EF%BC%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    用户故事   技术人如何做选择，路才越走越宽？
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%94%A8%E6%88%B7%E6%95%85%E4%BA%8B%20-%20%E7%94%A8%E5%A5%BD%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%EF%BC%8C%E5%8A%A9%E5%8A%9B%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    用户故事   用好动态调试，助力课程学习
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%94%A8%E6%88%B7%E6%95%85%E4%BA%8B%20-%20yiyang%EF%BC%9A%E6%88%91%E7%9A%84%E4%B8%8A%E6%9C%BA%E5%AE%9E%E9%AA%8C%E2%80%9C%E7%88%AC%E5%9D%91%E6%8C%87%E5%8D%97%E2%80%9D/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    用户故事   yiyang：我的上机实验“爬坑指南”
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%94%A8%E6%88%B7%E6%95%85%E4%BA%8B-%E8%89%BE%E5%90%8C%E5%AD%A6%EF%BC%9A%E8%B7%AF%E8%99%BD%E8%BF%9C%EF%BC%8C%E8%A1%8C%E5%88%99%E5%B0%86%E8%87%B3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    用户故事 艾同学：路虽远，行则将至
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%94%A8%E6%88%B7%E6%95%85%E4%BA%8B-%E9%A9%B0%E5%BE%80%EF%BC%9A%E5%80%9F%E9%95%9C%E8%A7%82%E5%BD%A2%EF%BC%8C%E5%AD%A6%E4%BB%A5%E8%87%B4%E7%94%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    用户故事 驰往：借镜观形，学以致用
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%8F%82%E8%80%83%E7%AD%94%E6%A1%88%20-%20%E5%AF%B9%E7%AD%94%E6%A1%88%EF%BC%8C%E6%98%AF%E5%86%8D%E6%AC%A1%E5%AD%A6%E4%B9%A0%E7%9A%84%E4%B8%80%E4%B8%AA%E6%9C%BA%E4%BC%9A/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    参考答案   对答案，是再次学习的一个机会
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95%E4%B9%8B%E7%BE%8E/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95%E4%B9%8B%E7%BE%8E/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    数据结构与算法之美
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%85%A5%E9%97%A8%E8%AF%BE/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%85%A5%E9%97%A8%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    正则表达式入门课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    深入浅出计算机组成原理
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E6%95%B0%E5%AD%A6%E5%9F%BA%E7%A1%80%E8%AF%BE/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E6%95%B0%E5%AD%A6%E5%9F%BA%E7%A1%80%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    程序员的数学基础课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E4%B9%8B%E7%BE%8E/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E4%B9%8B%E7%BE%8E/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    编译原理之美
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AE%9E%E6%88%98%E8%AF%BE/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AE%9E%E6%88%98%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    编译原理实战课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    计算机基础实战课
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E8%B6%A3%E8%B0%88Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%B6%A3%E8%B0%88Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    趣谈Linux操作系统
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    趣谈网络协议
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%E4%B9%8B%E7%BE%8E/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%E4%B9%8B%E7%BE%8E/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    软件工程之美
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E4%B9%8B%E7%BE%8E/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E4%B9%8B%E7%BE%8E/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    软件设计之美
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E9%80%8F%E8%A7%86HTTP%E5%8D%8F%E8%AE%AE/%E9%80%8F%E8%A7%86HTTP%E5%8D%8F%E8%AE%AE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    透视HTTP协议
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E9%87%8D%E5%AD%A6%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0/%E9%87%8D%E5%AD%A6%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    重学线性代数
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../%E8%BF%90%E7%BB%B4-%E6%B5%8B%E8%AF%95/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    运维-测试
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      Linux的原子变量
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux_1" class="md-nav__link">
    <span class="md-ellipsis">
      Linux控制中断
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux_2" class="md-nav__link">
    <span class="md-ellipsis">
      Linux自旋锁
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Linux自旋锁">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#linux_3" class="md-nav__link">
    <span class="md-ellipsis">
      Linux原始自旋锁
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linux_4" class="md-nav__link">
    <span class="md-ellipsis">
      Linux排队自旋锁
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux_5" class="md-nav__link">
    <span class="md-ellipsis">
      Linux信号量
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux_6" class="md-nav__link">
    <span class="md-ellipsis">
      Linux读写锁
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      重点回顾
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      思考题
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>09   瞧一瞧Linux：Linux的自旋锁和信号量如何实现？</h1>

<p>你好，我是LMOS。</p>
<p>上节课，我们学习了解决数据同步问题的思路与方法。Linux作为成熟的操作系统内核，当然也有很多数据同步的机制，它也有原子变量、开启和关闭中断、自旋锁、信号量。</p>
<p>那今天我们就来探讨一下这些机制在Linux中的实现。看看Linux的实现和前面我们自己的实现有什么区别，以及Linux为什么要这么实现，这么实现背后的机理是什么。</p>
<h2 id="linux">Linux的原子变量</h2>
<p>首先，我们一起来看看Linux下的原子变量的实现，在Linux中，有许多共享的资源可能只是一个简单的整型数值。</p>
<p>例如在文件描述符中，需要包含一个简单的计数器。这个计数器表示有多少个应用程序打开了文件。在文件系统的open函数中，将这个计数器变量加1；在close函数中，将这个计数器变量减1。</p>
<p>如果单个进程执行打开和关闭操作，那么这个计数器变量不会出现问题，但是Linux是支持多进程的系统，如果有多个进程同时打开或者关闭文件，那么就可能导致这个计数器变量多加或者少加，出现错误。</p>
<p>为了避免这个问题，Linux提供了<strong>一个原子类型变量atomic_t</strong>。该变量的定义如下。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>typedef struct {
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    int counter;
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>} atomic_t;//常用的32位的原子变量类型
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>#ifdef CONFIG_64BIT
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>typedef struct {
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    s64 counter;
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>} atomic64_t;//64位的原子变量类型
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>#endif
</code></pre></div>
<p>上述代码自然不能用普通的代码去读写加减，而是要用Linux专门提供的接口函数去操作，否则就不能保证原子性了，代码如下。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>//原子读取变量中的值
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>static __always_inline int arch_atomic_read(const atomic_t *v)
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>{
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    return __READ_ONCE((v)-&gt;counter);
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>}
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>//原子写入一个具体的值
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>static __always_inline void arch_atomic_set(atomic_t *v, int i)
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>{
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>    __WRITE_ONCE(v-&gt;counter, i);
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>}
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>//原子加上一个具体的值
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>static __always_inline void arch_atomic_add(int i, atomic_t *v)
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>{
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>    asm volatile(LOCK_PREFIX &quot;addl %1,%0&quot;
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>             : &quot;+m&quot; (v-&gt;counter)
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>             : &quot;ir&quot; (i) : &quot;memory&quot;);
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>}
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>//原子减去一个具体的值
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>static __always_inline void arch_atomic_sub(int i, atomic_t *v)
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>{
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>    asm volatile(LOCK_PREFIX &quot;subl %1,%0&quot;
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>             : &quot;+m&quot; (v-&gt;counter)
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>             : &quot;ir&quot; (i) : &quot;memory&quot;);
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>}
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>//原子加1
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>static __always_inline void arch_atomic_inc(atomic_t *v)
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>{
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>    asm volatile(LOCK_PREFIX &quot;incl %0&quot;
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>             : &quot;+m&quot; (v-&gt;counter) :: &quot;memory&quot;);
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>}
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>//原子减1
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>static __always_inline void arch_atomic_dec(atomic_t *v)
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>{
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>    asm volatile(LOCK_PREFIX &quot;decl %0&quot;
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>             : &quot;+m&quot; (v-&gt;counter) :: &quot;memory&quot;);
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>}
</code></pre></div>
<p>Linux原子类型变量的操作函数有很多，这里我只是介绍了最基础的几个函数，<a href="https://elixir.bootlin.com/linux/v5.10.13/source/arch/x86/include/asm/atomic.h#L23">其它的原子类型变量操作</a>也依赖于上述几个基础的函数。</p>
<p>你会发现，Linux的实现也同样采用了x86 CPU的原子指令，LOCK_PREFIX是一个宏，根据需要展开成“lock;”或者空串。<strong>单核心CPU是不需要lock前缀的，只要在多核心CPU下才需要加上lock前缀。</strong></p>
<p>剩下__READ_ONCE，__WRITE_ONCE两个宏，我们来看看它们分别做了什么，如下所示。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>#define __READ_ONCE(x)  \
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>(*(const volatile __unqual_scalar_typeof(x) *)&amp;(x))
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>#define __WRITE_ONCE(x, val) \
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>do {*(volatile typeof(x) *)&amp;(x) = (val);} while (0)
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>//__unqual_scalar_typeof表示声明一个非限定的标量类型，非标量类型保持不变。说人话就是返回x变量的类型，这是GCC的功能，typeof只是纯粹返回x的类型。
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>//如果 x 是int类型则返回“int” 
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>#define __READ_ONCE(x)  \
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>(*(const volatile int *)&amp;(x))
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>#define __WRITE_ONCE(x, val) \
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>do {*(volatile int *)&amp;(x) = (val);} while (0) 
</code></pre></div>
<p>结合刚才的代码，我给你做个解读。Linux定义了__READ_ONCE，__WRITE_ONCE这两个宏，是对代码封装并利用GCC的特性对代码进行检查，把让错误显现在编译阶段。其中的“volatile int *”是为了提醒编译器：<strong>这是对内存地址读写，不要有优化动作，每次都必须强制写入内存或从内存读取。</strong></p>
<h2 id="linux_1">Linux控制中断</h2>
<p>Linux中有很多场景，需要在关中断下才可以安全执行一些操作。</p>
<p>比如，多个中断处理程序需要访问一些共享数据，一个中断程序在访问数据时必须保证自身（中断嵌套）和其它中断处理程序互斥，否则就会出错。再比如，设备驱动程序在设置设备寄存器时，也必须让CPU停止响应中断。</p>
<p>Linux控制CPU响应中断的函数如下。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>//实际保存eflags寄存器
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>extern __always_inline unsigned long native_save_fl(void){
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    unsigned long flags;
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    asm volatile(&quot;# __raw_save_flags\n\t&quot;
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>                 &quot;pushf ; pop %0&quot;:&quot;=rm&quot;(flags)::&quot;memory&quot;);
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    return flags;
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>}
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>//实际恢复eflags寄存器
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>extern inline void native_restore_fl(unsigned long flags){
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    asm volatile(&quot;push %0 ; popf&quot;::&quot;g&quot;(flags):&quot;memory&quot;,&quot;cc&quot;);
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>}
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>//实际关中断
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>static __always_inline void native_irq_disable(void){
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>    asm volatile(&quot;cli&quot;:::&quot;memory&quot;);
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>}
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>//实际开启中断
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>static __always_inline void native_irq_enable(void){
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>    asm volatile(&quot;sti&quot;:::&quot;memory&quot;);
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>}
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>//arch层关中断
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>static __always_inline void arch_local_irq_disable(void){
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>    native_irq_disable();
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>}
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>//arch层开启中断
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>static __always_inline void arch_local_irq_enable(void){ 
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>    native_irq_enable();
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>}
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>//arch层保存eflags寄存器
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>static __always_inline unsigned long           arch_local_save_flags(void){
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>    return native_save_fl();
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>}
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>//arch层恢复eflags寄存器
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>static  __always_inline void arch_local_irq_restore(unsigned long flags){
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>    native_restore_fl(flags);
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>}
<a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>//实际保存eflags寄存器并关中断
<a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a>static __always_inline unsigned long arch_local_irq_save(void){
<a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>    unsigned long flags = arch_local_save_flags();
<a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>    arch_local_irq_disable();
<a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a>    return flags;
<a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a>}
<a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a>//raw层关闭开启中断宏
<a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a>#define raw_local_irq_disable()     arch_local_irq_disable()
<a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a>#define raw_local_irq_enable()      arch_local_irq_enable()
<a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>//raw层保存恢复eflags寄存器宏
<a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a>#define raw_local_irq_save(flags)           \
<a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a>    do {                        \
<a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a>        typecheck(unsigned long, flags);    \
<a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a>        flags = arch_local_irq_save();      \
<a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a>    } while (0)
<a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a>
<a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a>#define raw_local_irq_restore(flags)            \
<a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a>    do {                        \
<a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a>        typecheck(unsigned long, flags);    \
<a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a>        arch_local_irq_restore(flags);      \
<a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a>    } while (0)
<a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a>
<a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a>#define raw_local_save_flags(flags)         \
<a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a>    do {                        \
<a id="__codelineno-3-60" name="__codelineno-3-60" href="#__codelineno-3-60"></a>        typecheck(unsigned long, flags);    \
<a id="__codelineno-3-61" name="__codelineno-3-61" href="#__codelineno-3-61"></a>        flags = arch_local_save_flags();    \
<a id="__codelineno-3-62" name="__codelineno-3-62" href="#__codelineno-3-62"></a>    } while (0)
<a id="__codelineno-3-63" name="__codelineno-3-63" href="#__codelineno-3-63"></a>//通用层接口宏 
<a id="__codelineno-3-64" name="__codelineno-3-64" href="#__codelineno-3-64"></a>#define local_irq_enable()              \
<a id="__codelineno-3-65" name="__codelineno-3-65" href="#__codelineno-3-65"></a>    do { \
<a id="__codelineno-3-66" name="__codelineno-3-66" href="#__codelineno-3-66"></a>        raw_local_irq_enable();         \
<a id="__codelineno-3-67" name="__codelineno-3-67" href="#__codelineno-3-67"></a>    } while (0)
<a id="__codelineno-3-68" name="__codelineno-3-68" href="#__codelineno-3-68"></a>
<a id="__codelineno-3-69" name="__codelineno-3-69" href="#__codelineno-3-69"></a>#define local_irq_disable()             \
<a id="__codelineno-3-70" name="__codelineno-3-70" href="#__codelineno-3-70"></a>    do {                        \
<a id="__codelineno-3-71" name="__codelineno-3-71" href="#__codelineno-3-71"></a>        raw_local_irq_disable();        \
<a id="__codelineno-3-72" name="__codelineno-3-72" href="#__codelineno-3-72"></a>    } while (0)
<a id="__codelineno-3-73" name="__codelineno-3-73" href="#__codelineno-3-73"></a>
<a id="__codelineno-3-74" name="__codelineno-3-74" href="#__codelineno-3-74"></a>#define local_irq_save(flags)               \
<a id="__codelineno-3-75" name="__codelineno-3-75" href="#__codelineno-3-75"></a>    do {                        \
<a id="__codelineno-3-76" name="__codelineno-3-76" href="#__codelineno-3-76"></a>        raw_local_irq_save(flags);      \
<a id="__codelineno-3-77" name="__codelineno-3-77" href="#__codelineno-3-77"></a>    } while (0)
<a id="__codelineno-3-78" name="__codelineno-3-78" href="#__codelineno-3-78"></a>
<a id="__codelineno-3-79" name="__codelineno-3-79" href="#__codelineno-3-79"></a>#define local_irq_restore(flags)            \
<a id="__codelineno-3-80" name="__codelineno-3-80" href="#__codelineno-3-80"></a>    do {                        \
<a id="__codelineno-3-81" name="__codelineno-3-81" href="#__codelineno-3-81"></a>        raw_local_irq_restore(flags);       \
<a id="__codelineno-3-82" name="__codelineno-3-82" href="#__codelineno-3-82"></a>    } while (0)
</code></pre></div>
<p>可以发现，Linux中通过定义的方式对一些底层函数进行了一些包装，为了让你抓住重点，前面这些宏我去掉了和中断控制无关的额外操作，详细信息你可以参阅<a href="https://elixir.bootlin.com/linux/v5.10.13/source/include/linux/irqflags.h#L186">相关代码</a>。</p>
<p>编译Linux代码时，编译器自动对宏进行展开。其中，do{}while(0)是Linux代码中一种常用的技巧，do{}while(0)表达式会保证{}中的代码片段执行一次，保证宏展开时这个代码片段是一个整体。</p>
<p>带native_前缀之类的函数则跟我们之前实现的hal_前缀对应，而Linux为了支持不同的硬件平台，做了多层封装。</p>
<h2 id="linux_2">Linux自旋锁</h2>
<p>Linux也是支持多核心CPU的操作系统内核，因此Linux也需要自旋锁来对系统中的共享资源进行保护。同一时刻，只有获取了锁的进程才能使用共享资源。</p>
<p>根据上节课对自旋锁算法的理解，自旋锁不会引起加锁进程睡眠，如果自旋锁已经被别的进程持有，加锁进程就需要一直循环在那里，查看是否该自旋锁的持有者已经释放了锁，"自旋"一词就是因此而得名。</p>
<p>Linux有多种自旋锁，我们这里只介绍两种，<strong>原始自旋锁和排队自旋锁</strong>，它们底层原理和我们之前实现的没什么不同，但多了一些优化和改进，下面我们一起去看看。</p>
<h3 id="linux_3">Linux原始自旋锁</h3>
<p>我们先看看Linux原始的自旋锁，Linux的原始自旋锁本质上用一个整数来表示，值为1代表锁未被占用，为0或者负数则表示被占用。</p>
<p>你可以结合上节课的这张图，理解后面的内容。当某个CPU核心执行进程请求加锁时，如果锁是未加锁状态，则加锁，然后操作共享资源，最后释放锁；如果锁已被加锁，则进程并不会转入睡眠状态，而是循环等待该锁，一旦锁被释放，则第一个感知此信息的进程将获得锁。</p>
<p><img alt="" src="https://static001.geekbang.org/resource/image/a2/24/a2968832f3f1055cc7ba68628a25d924.jpg?wh=2195%2A2405" title="自旋锁原理示意图" /></p>
<p>我们先来看看Linux原始自旋锁的数据结构，为方便你阅读，我删除了用于调试的数据字段，代码如下。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>//最底层的自旋锁数据结构
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>typedef struct{
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>volatile unsigned long lock;//真正的锁值变量，用volatile标识
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>}spinlock_t;
</code></pre></div>
<p>Linux原始自旋锁数据结构封装了一个unsigned long类型的变量。有了数据结构，我们再来看看操作这个数据结构的函数，即自旋锁接口，代码如下。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>#define spin_unlock_string \    
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>    &quot;movb $1,%0&quot; \ //写入1表示解锁
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    :&quot;=m&quot; (lock-&gt;lock) : : &quot;memory&quot;
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>#define spin_lock_string \
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    &quot;\n1:\t&quot; \  
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    &quot;lock ; decb %0\n\t&quot; \ //原子减1
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    &quot;js 2f\n&quot; \   //当结果小于0则跳转到标号2处，表示加锁失败
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    &quot;.section .text.lock,\&quot;ax\&quot;\n&quot; \ //重新定义一个代码段，这是优化技术，避免后面的代码填充cache，因为大部分情况会加锁成功，链接器会处理好这个代码段的
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    &quot;2:\t&quot; \    
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>    &quot;cmpb $0,%0\n\t&quot; \  //和0比较
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>    &quot;rep;nop\n\t&quot; \ //空指令
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>    &quot;jle 2b\n\t&quot; \   //小于或等于0跳转到标号2
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>    &quot;jmp 1b\n&quot; \   //跳转到标号1 
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>    &quot;.previous&quot;
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>//获取自旋锁
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>static inline void spin_lock(spinlock_t*lock){
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>    __asm__ __volatile__(
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>    spin_lock_string
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>    :&quot;=m&quot;(lock-&gt;lock)::&quot;memory&quot;
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>    );
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>}
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>//释放自旋锁
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>static inline void spin_unlock(spinlock_t*lock){
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>__asm__ __volatile__(
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>    spin_unlock_string
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>    );
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>}
</code></pre></div>
<p>上述代码中用spin_lock_string、spin_unlock_string两个宏，定义了获取、释放自旋锁的汇编指令。spin_unlock_string只是简单将锁值变量设置成1，表示释放自旋锁，spin_lock_string中并没有像我们Cosmos一样使用xchg指令，而是使用了decb指令，这条指令也能原子地执行减1操作。</p>
<p>开始锁值变量为1时，执行decb指令就变成了0，0就表示加锁成功。如果小于0，则表示有其它进程已经加锁了，就会导致循环比较。</p>
<h3 id="linux_4">Linux排队自旋锁</h3>
<p>现在我们再来看看100个进程获取同一个自旋锁的情况，开始1个进程获取了自旋锁L，后面继续来了99个进程，它们都要获取自旋锁L，但是它们必须等待，这时第1进程释放了自旋锁L。请问，这99个进程中谁能先获取自旋锁L呢？</p>
<p>答案是不确定，因为这个次序依赖于哪个CPU核心能最先访问内存，而哪个CPU核心可以访问内存是由<strong>总线仲裁协议</strong>决定的。</p>
<p>很有可能最后来的进程最先获取自旋锁L，这对其它等待的进程极其不公平，为了解决获取自旋锁的<strong>公平性</strong>，Linux开发出了排队自旋锁。</p>
<p>你可以这样理解，想要给进程排好队，就需要确定顺序，也就是进程申请获取锁的先后次序，Linux的排队自旋锁通过保存这个信息，就能更公平地调度进程了。</p>
<p>为了保存顺序信息，排队自旋锁重新定义了数据结构。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>//RAW层的自旋锁数据结构
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>typedef struct raw_spinlock{
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    unsigned int slock;//真正的锁值变量
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>}raw_spinlock_t;
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>//最上层的自旋锁数据结构
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>typedef struct spinlock{
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>    struct raw_spinlock rlock;
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>}spinlock_t;
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>//Linux没有这样的结构，这只是为了描述方便
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>typedef struct raw_spinlock{
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>    union {
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>        unsigned int slock;//真正的锁值变量
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>        struct {
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>        u16 owner;
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>        u16 next;
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>        }
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>    }
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>}raw_spinlock_t;
</code></pre></div>
<p>slock域被分成两部分，分别保存<strong>锁持有者</strong>和<strong>未来锁申请者</strong>的序号，如上述代码10～16行所示。</p>
<p>只有next域与owner域相等时，才表示自旋锁处于未使用的状态（此时也没有进程申请该锁）。在排队自旋锁初始化时，slock被置为0，即next和owner被置为0，Linux进程执行申请自旋锁时，原子地将next域加1，并将原值返回作为自己的序号。</p>
<p>如果返回的序号等于申请时的owner值，说明自旋锁处于未使用的状态，则进程直接获得锁；否则，该进程循环检查owner域是否等于自己持有的序号，一旦相等，则表明锁轮到自己获取。</p>
<p>进程释放自旋锁时，原子地将owner域加1即可，下一个进程将会发现这一变化，从循环状态中退出。进程将严格地按照申请顺序依次获取排队自旋锁。这样一来，原先进程无序竞争的乱象就迎刃而解了。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>static inline void __raw_spin_lock(raw_spinlock_t*lock){
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>int inc = 0x00010000;
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>int tmp;
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>__asm__ __volatile__(
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>&quot;lock ; xaddl %0, %1\n&quot; //将inc和slock交换，然后 inc=inc+slock
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>                        //相当于原子读取next和owner并对next+1
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>&quot;movzwl %w0, %2\n\t&quot;//将inc的低16位做0扩展后送tmp tmp=(u16)inc
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>&quot;shrl $16, %0\n\t&quot; //将inc右移16位 inc=inc&gt;&gt;16
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>&quot;1:\t&quot;
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>&quot;cmpl %0, %2\n\t&quot; //比较inc和tmp，即比较next和owner 
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>&quot;je 2f\n\t&quot; //相等则跳转到标号2处返回
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>&quot;rep ; nop\n\t&quot; //空指令
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>&quot;movzwl %1, %2\n\t&quot; //将slock的低16位做0扩展后送tmp 即tmp=owner
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>&quot;jmp 1b\n&quot; //跳转到标号1处继续比较
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>&quot;2:&quot;
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>:&quot;+Q&quot;(inc),&quot;+m&quot;(lock-&gt;slock),&quot;=r&quot;(tmp)
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>::&quot;memory&quot;,&quot;cc&quot;
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>);
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>}
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>#define UNLOCK_LOCK_PREFIX LOCK_PREFIX
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>static inline void __raw_spin_unlock(raw_spinlock_t*lock){
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>__asm__ __volatile__(
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>UNLOCK_LOCK_PREFIX&quot;incw %0&quot;//将slock的低16位加1 即owner+1
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>:&quot;+m&quot;(lock-&gt;slock)
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>::&quot;memory&quot;,&quot;cc&quot;);
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>}
</code></pre></div>
<p>上述代码中的注释已经描述得很清楚了，每条指令都有注解，供你参考。这里需要注意的是Linux为了避免差异性，在spinlock_t结构体中包含了raw_spinlock_t，而在raw_spinlock_t结构体中并没使用next和owner字段，而是在代码中直接操作slock的高16位和低16位来实现的。</p>
<p>不知道你有没有过这样的经历？当你去银行办事，又发现人很多时，你很可能会选择先去处理一些别的事情，等过一会人比较少了，再来办理我们自己的业务。</p>
<p>其实，在使用自旋锁时也有同样的情况，当一个进程发现另一个进程已经拥有自己所请求的自旋锁时，就自愿放弃，转而做其它别的工作，并不想在这里循环等待，浪费自己的时间。</p>
<p>对于这种情况，Linux同样提供了相应的自旋锁接口，如下所示。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>static inline int __raw_spin_trylock(raw_spinlock_t*lock){
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    int tmp;
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    int new;
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    asm volatile(
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    &quot;movl %2,%0\n\t&quot;//tmp=slock
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    &quot;movl %0,%1\n\t&quot;//new=tmp
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    &quot;roll $16, %0\n\t&quot;//tmp循环左移16位，即next和owner交换了
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>    &quot;cmpl %0,%1\n\t&quot;//比较tmp和new即（owner、next）？=（next、owner）
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>    &quot;jne 1f\n\t&quot; //不等则跳转到标号1处 
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    &quot;addl $0x00010000, %1\n\t&quot;//相当于next+1
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>    &quot;lock ; cmpxchgl %1,%2\n\t&quot;//new和slock交换比较    
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>    &quot;1:&quot;
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>    &quot;sete %b1\n\t&quot; //new = eflags.ZF位，ZF取决于前面的判断是否相等
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>    &quot;movzbl %b1,%0\n\t&quot; //tmp = new
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>    :&quot;=&amp;a&quot;(tmp),&quot;=Q&quot;(new),&quot;+m&quot;(lock-&gt;slock)
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>    ::&quot;memory&quot;,&quot;cc&quot;);
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>    return tmp;
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>}
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>int __lockfunc _spin_trylock(spinlock_t*lock){ 
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>    preempt_disable();
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>    if(_raw_spin_trylock(lock)){
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>        spin_acquire(&amp;lock-&gt;dep_map,0,1,_RET_IP_);
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>        return 1;
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>    }
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>    preempt_enable();
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>    return 0;
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>}
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>#define spin_trylock(lock) __cond_lock(lock, _spin_trylock(lock))
</code></pre></div>
<p>_cond_lock只用代码静态检查工作，一定要明白_spin_trylock返回1表示尝试加锁成功，可以安全的地问共享资源了；返回值为0则表示尝试加锁失败，不能操作共享资源，应该等一段时间，再次尝试加锁。</p>
<h2 id="linux_5">Linux信号量</h2>
<p>Linux中的信号量同样是用来保护共享资源，能保证资源在一个时刻只有一个进程使用，这是单值信号量。也可以作为资源计数器，比如一种资源有五份，同时最多可以有五个进程，这是多值信号量。</p>
<p>单值信号量，类比于私人空间一次只进去一个人，其信号量的值初始值为1，而多值信号量，相当于是客厅，可同时容纳多个人。其信号量的值初始值为5，就可容纳5个人。</p>
<p>信号量的值为正的时候。所申请的进程可以锁定使用它。若为0，说明它被其它进程占用，申请的进程要进入睡眠队列中，等待被唤醒。所以信号量最大的优势是既<strong>可以使申请失败的进程睡眠，还可以作为资源计数器使用。</strong></p>
<p>我们先来看看Linux实现信号量所使用的数据结构，如下所示：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>struct semaphore{
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    raw_spinlock_t lock;//保护信号量自身的自旋锁
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    unsigned int count;//信号量值
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    struct list_head wait_list;//挂载睡眠等待进程的链表
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>};
</code></pre></div>
<p>下面我们就跟着Linux信号量接口函数，一步步探索Linux信号量工作原理，和它对进程状态的影响，先来看看Linux信号量的使用案例，如下所示。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>#define down_console_sem() do { \
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    down(&amp;console_sem);\
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>} while (0)
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>static void __up_console_sem(unsigned long ip) {
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    up(&amp;console_sem);
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>}
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>#define up_console_sem() __up_console_sem(_RET_IP_)
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>//加锁console
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>void console_lock(void)
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>{
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    might_sleep();
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>    down_console_sem();//获取信号量console_sem
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>    if (console_suspended)
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>        return;
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>    console_locked = 1;
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>    console_may_schedule = 1;
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>}
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>//解锁console
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>void console_unlock(void)
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>{
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>    static char ext_text[CONSOLE_EXT_LOG_MAX];
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>    static char text[LOG_LINE_MAX + PREFIX_MAX];
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>    //……删除了很多代码
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>    up_console_sem();//释放信号量console_sem
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>    raw_spin_lock(&amp;logbuf_lock);
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>    //……删除了很多代码   
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>}
</code></pre></div>
<p>为了简单说明问题，我删除了很多代码，上面代码中以console驱动为例说明了信号量的使用。</p>
<p>在Linux源代码的kernel/printk.c中，使用宏DEFINE_SEMAPHORE声明了一个单值信号量console_sem，也可以说是<strong>互斥锁</strong>，它用于保护console驱动列表console_drivers以及同步对整个console驱动的访问。</p>
<p>其中定义了宏down_console_sem()来获得信号量console_sem，定义了宏up_console_sem()来释放信号量console_sem，console_lock和console_unlock函数是用于互斥访问console驱动的，核心操作就是调用前面定义两个宏。</p>
<p>上面的情景中，down_console_sem()和up_console_sem()宏的核心主要是调用了信号量的接口函数down、up函数，完成获取、释放信号量的核心操作，代码如下。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>static inline int __sched __down_common(struct semaphore *sem, long state,long timeout)
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>{
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    struct semaphore_waiter waiter;
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    //把waiter加入sem-&gt;wait_list的头部
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    list_add_tail(&amp;waiter.list, &amp;sem-&gt;wait_list);
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    waiter.task = current;//current表示当前进程，即调用该函数的进程
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>    waiter.up = false;
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    for (;;) {
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>        if (signal_pending_state(state, current))
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>            goto interrupted;
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>        if (unlikely(timeout &lt;= 0))
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>            goto timed_out;
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>        __set_current_state(state);//设置当前进程的状态，进程睡眠，即先前__down函数中传入的TASK_UNINTERRUPTIBLE：该状态是等待资源有效时唤醒（比如等待键盘输入、socket连接、信号（signal）等等），但不可以被中断唤醒
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>        raw_spin_unlock_irq(&amp;sem-&gt;lock);//释放在down函数中加的锁
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>        timeout = schedule_timeout(timeout);//真正进入睡眠
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>        raw_spin_lock_irq(&amp;sem-&gt;lock);//进程下次运行会回到这里，所以要加锁
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>        if (waiter.up)
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>            return 0;
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>    }
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a> timed_out:
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>    list_del(&amp;waiter.list);
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>    return -ETIME;
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a> interrupted:
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>    list_del(&amp;waiter.list);
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>    return -EINTR;
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>    //为了简单起见处理进程信号（signal）和超时的逻辑代码我已经删除
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>}
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>//进入睡眠等待
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>static noinline void __sched __down(struct semaphore *sem)
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>{
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>    __down_common(sem, TASK_UNINTERRUPTIBLE, MAX_SCHEDULE_TIMEOUT);
<a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>}
<a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>//获取信号量
<a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>void down(struct semaphore *sem)
<a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>{
<a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>    unsigned long flags;
<a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a>    //对信号量本身加锁并关中断，也许另一段代码也在操作该信号量
<a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>    raw_spin_lock_irqsave(&amp;sem-&gt;lock, flags);
<a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a>    if (likely(sem-&gt;count &gt; 0))
<a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>        sem-&gt;count--;//如果信号量值大于0,则对其减1
<a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a>    else
<a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a>        __down(sem);//否则让当前进程进入睡眠
<a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a>    raw_spin_unlock_irqrestore(&amp;sem-&gt;lock, flags);
<a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a>}
<a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a>//实际唤醒进程 
<a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a>static noinline void __sched __up(struct semaphore *sem)
<a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a>{
<a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a>    struct semaphore_waiter *waiter = list_first_entry(&amp;sem-&gt;wait_list, struct semaphore_waiter, list);
<a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a>    //获取信号量等待链表中的第一个数据结构semaphore_waiter，它里面保存着睡眠进程的指针
<a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a>    list_del(&amp;waiter-&gt;list);
<a id="__codelineno-11-52" name="__codelineno-11-52" href="#__codelineno-11-52"></a>    waiter-&gt;up = true;
<a id="__codelineno-11-53" name="__codelineno-11-53" href="#__codelineno-11-53"></a>    wake_up_process(waiter-&gt;task);//唤醒进程重新加入调度队列
<a id="__codelineno-11-54" name="__codelineno-11-54" href="#__codelineno-11-54"></a>}
<a id="__codelineno-11-55" name="__codelineno-11-55" href="#__codelineno-11-55"></a>//释放信号量
<a id="__codelineno-11-56" name="__codelineno-11-56" href="#__codelineno-11-56"></a>void up(struct semaphore *sem)
<a id="__codelineno-11-57" name="__codelineno-11-57" href="#__codelineno-11-57"></a>{
<a id="__codelineno-11-58" name="__codelineno-11-58" href="#__codelineno-11-58"></a>    unsigned long flags;
<a id="__codelineno-11-59" name="__codelineno-11-59" href="#__codelineno-11-59"></a>    //对信号量本身加锁并关中断，必须另一段代码也在操作该信号量
<a id="__codelineno-11-60" name="__codelineno-11-60" href="#__codelineno-11-60"></a>    raw_spin_lock_irqsave(&amp;sem-&gt;lock, flags);
<a id="__codelineno-11-61" name="__codelineno-11-61" href="#__codelineno-11-61"></a>    if (likely(list_empty(&amp;sem-&gt;wait_list)))
<a id="__codelineno-11-62" name="__codelineno-11-62" href="#__codelineno-11-62"></a>        sem-&gt;count++;//如果信号量等待链表中为空，则对信号量值加1
<a id="__codelineno-11-63" name="__codelineno-11-63" href="#__codelineno-11-63"></a>    else
<a id="__codelineno-11-64" name="__codelineno-11-64" href="#__codelineno-11-64"></a>        __up(sem);//否则执行唤醒进程相关的操作
<a id="__codelineno-11-65" name="__codelineno-11-65" href="#__codelineno-11-65"></a>    raw_spin_unlock_irqrestore(&amp;sem-&gt;lock, flags);
<a id="__codelineno-11-66" name="__codelineno-11-66" href="#__codelineno-11-66"></a>}
</code></pre></div>
<p>上述代码中的逻辑，已经描述了信号量的工作原理。需要注意的是，一个进程进入了__down函数中，设置了一个不可中断的等待状态，然后执行了schedule_timeout函数。这个执行了进程的调度器，就直接调度到别的进程运行了。</p>
<p>这时，这个进程就不会返回了，直到下一次它被up函数唤醒。执行了wake_up_process函数以后，重新调度它就会回到schedule_timeout函数下一行代码，沿着调用路经返回，最后从__down函数中出来，即进程睡醒了。</p>
<h2 id="linux_6">Linux读写锁</h2>
<p>在操作系统中，有很多共享数据，进程对这些共享数据要进行修改的情况很少，而读取的情况却是非常多的，这些共享数据的操作基本都是在读取。</p>
<p>如果每次读取这些共享数据都加锁的话，那就太浪费时间了，会降低进程的运行效率。因为读操作不会导致修改数据，所以在读取数据的时候不用加锁了，而是可以共享的访问，只有涉及到对共享数据修改的时候，才需要加锁互斥访问。</p>
<p>想像一下100个进程同时读取一个共享数据，而每个进程都要加锁解锁，剩下的进程只能等待，这会大大降低整个系统性能，这时候就需要使用一种新的锁了——读写锁。</p>
<p>读写锁也称为共享-独占（shared-exclusive）锁，当读写锁用读取模式加锁时，它是以共享模式上锁的，当以写入修改模式加锁时，它是以独占模式上锁的（互斥）。</p>
<p>读写锁非常适合<strong>读取数据的频率远大于修改数据的频率</strong>的场景中。这样可以在任何时刻，保证多个进程的读取操作并发地执行，给系统带来了更高的并发度。</p>
<p>那读写锁是怎么工作的呢？读写之间是互斥的，读取的时候不能写入，写入的时候不能读取，而且读取和写入操作在竞争锁的时候，写会优先得到锁，步骤如下。</p>
<p>1.当共享数据没有锁的时候，读取的加锁操作和写入的加锁操作都可以满足。<br />
2.当共享数据有读锁的时候，所有的读取加锁操作都可以满足，写入的加锁操作不能满足，读写是互斥的。<br />
3.当共享数据有写锁的时候，所有的读取的加锁操作都不能满足，所有的写入的加锁操作也不能满足，读与写之间是互斥的，写与写之间也是互斥的。</p>
<p>如果你感觉刚才说的步骤还是太复杂，那我再给你画一个表，你就清楚了，如下所示。</p>
<p><img alt="" src="https://static001.geekbang.org/resource/image/70/08/70c2d2580e8ec4b138db2f2807ba9f08.jpg?wh=1625%2A848" /></p>
<p>好了，我们明白了读写锁的加锁规则，现在就去看看Linux中的读写锁的实现，<strong>Linux中的读写锁本质上是自旋锁的变种。</strong></p>
<p>后面这段代码是Linux中读写锁的核心代码，请你注意，<strong>实际操作的时候，我们不是直接使用上面的函数和数据结构，而是应该使用Linux提供的标准接口，如read_lock、write_lock等。</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>//读写锁初始化锁值
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>#define RW_LOCK_BIAS         0x01000000
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>//读写锁的底层数据结构
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>typedef struct{
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>    unsigned int lock;
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>}arch_rwlock_t;
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>//释放读锁 
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>static inline void arch_read_unlock(arch_rwlock_t*rw){ 
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    asm volatile(
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>        LOCK_PREFIX&quot;incl %0&quot; //原子对lock加1
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>        :&quot;+m&quot;(rw-&gt;lock)::&quot;memory&quot;);
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>}
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>//释放写锁
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>static inline void arch_write_unlock(arch_rwlock_t*rw){
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>    asm volatile(
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>        LOCK_PREFIX&quot;addl %1, %0&quot;//原子对lock加上RW_LOCK_BIAS
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>        :&quot;+m&quot;(rw-&gt;lock):&quot;i&quot;(RW_LOCK_BIAS):&quot;memory&quot;);
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>}
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>//获取写锁失败时调用
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>ENTRY(__write_lock_failed)
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>    //(%eax)表示由eax指向的内存空间是调用者传进来的 
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>    2:LOCK_PREFIX addl  $ RW_LOCK_BIAS,(%eax)
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>    1:rep;nop//空指令
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>    cmpl $RW_LOCK_BIAS,(%eax)
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>    //不等于初始值则循环比较，相等则表示有进程释放了写锁
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>    jne  1b
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>    //执行加写锁
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>    LOCK_PREFIX subl    $ RW_LOCK_BIAS,(%eax)
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>    jnz 2b //不为0则继续测试，为0则表示加写锁成功
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>    ret //返回
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>ENDPROC(__write_lock_failed)
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>//获取读锁失败时调用
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>ENTRY(__read_lock_failed)
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>    //(%eax)表示由eax指向的内存空间是调用者传进来的 
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>    2:LOCK_PREFIX incl(%eax)//原子加1
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a>    1:  rep; nop//空指令
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>    cmpl    $1,(%eax) //和1比较 小于0则
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a>    js 1b //为负则继续循环比较
<a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a>    LOCK_PREFIX decl(%eax) //加读锁
<a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a>    js  2b  //为负则继续加1并比较，否则返回
<a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a>    ret //返回
<a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a>ENDPROC(__read_lock_failed)
<a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a>//获取读锁
<a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a>static inline void arch_read_lock(arch_rwlock_t*rw){
<a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a>    asm volatile(
<a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a>        LOCK_PREFIX&quot; subl $1,(%0)\n\t&quot;//原子对lock减1
<a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a>        &quot;jns 1f\n&quot;//不为小于0则跳转标号1处，表示获取读锁成功
<a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a>        &quot;call __read_lock_failed\n\t&quot;//调用__read_lock_failed
<a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a>        &quot;1:\n&quot;
<a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a>        ::LOCK_PTR_REG(rw):&quot;memory&quot;);
<a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a>}
<a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a>//获取写锁
<a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a>static inline void arch_write_lock(arch_rwlock_t*rw){
<a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a>    asm volatile(
<a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a>        LOCK_PREFIX&quot;subl %1,(%0)\n\t&quot;//原子对lock减去RW_LOCK_BIAS
<a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a>        &quot;jz 1f\n&quot;//为0则跳转标号1处
<a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a>        &quot;call __write_lock_failed\n\t&quot;//调用__write_lock_failed
<a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a>        &quot;1:\n&quot;
<a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a>        ::LOCK_PTR_REG(rw),&quot;i&quot;(RW_LOCK_BIAS):&quot;memory&quot;);
<a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a>}
</code></pre></div>
<p>Linux读写锁的原理本质是基于计数器，初始值为0x01000000，获取读锁时对其减1，结果不小于0则表示获取读锁成功，获取写锁时直接减去0x01000000。</p>
<p>说到这里你可能要问了，为何要减去初始值呢？这是因为只有当锁值为初始值时，减去初始值结果才可以是0，这是唯一没有进程持有任何锁的情况，这样才能保证获取写锁时是互斥的。</p>
<p>__read_lock_failed、__write_lock_failed是两个汇编函数，注释写得很详细了，和前面自旋锁的套路是一样的。我们可以看出，读写锁其实是带计数的特殊自旋锁，能同时被多个读取数据的进程占有或一个修改数据的进程占有，但不能同时被读取数据的进程和修改数据的进程占有。</p>
<p>我们再次梳理一下获取、释放读写锁的流程，如下所示。</p>
<p>1.获取读锁时，锁值变量lock计数减去1，判断结果的符号位是否为1。若结果符号位为0时，获取读锁成功，即表示lock大于0。<br />
2.获取读锁时，锁值变量lock计数减去1，判断结果的符号位是否为1。若结果符号位为1时，获取读锁失败，表示此时读写锁被修改数据的进程占有，此时调用__read_lock_failed失败处理函数，循环测试lock+1的值，直到结果的值大于等于1。<br />
3.获取写锁时，锁值变量lock计数减去RW_LOCK_BIAS_STR，即lock-0x01000000，判断结果是否为0。若结果为0时，表示获取写锁成功。<br />
4.获取写锁时，锁值变量lock计数减去RW_LOCK_BIAS_STR，即lock-0x01000000，判断结果是否为0。若结果不为0时，获取写锁失败，表示此时有读取数据的进程占有读锁或有修改数据的进程占有写锁，此时调用__write_lock_failed失败处理函数，循环测试lock+0x01000000，直到结果的值等于0x01000000。</p>
<h2 id="_1">重点回顾</h2>
<p>好了，这节课的内容讲完了。我们一起学习了Linux上实现数据同步的五大利器，分别是Linux原子变量、Linux中断控制、Linux自旋锁、Linux信号量、Linux读写锁。我把重点给你梳理一下。</p>
<p><img alt="" src="https://static001.geekbang.org/resource/image/7f/a9/7fd3abc144bb40331ca2aeb05ab5b7a9.jpg?wh=3145%2A2137" /></p>
<p>锁，保证了数据的安全访问，但是它给程序的并行性能造成了巨大损害，所以在设计一个算法时应尽量避免使用锁。若无法避免，则应根据实际情况使用相应类型的锁，以降低锁的不当使用带来的性能损失。</p>
<h2 id="_2">思考题</h2>
<p>请试着回答：上述Linux的读写锁，支持多少个进程并发读取共享数据？这样的读写锁有什么不足？</p>
<p>欢迎你在留言区和我交流，相信通过积极参与，你将更好地理解这节课的内容。</p>
<p>我是 LMOS，我们下节课见！</p>
<div><strong>精选留言（15）</strong></div>
<ul>
<li><span>Qfeng</span> 👍（10） 💬（2）<p>回答思考题：Linux 的读写锁，因为每次读锁加锁计数-1，所以最多支持0x01000000个进程并发读取共享数据。
这样的读写锁的不足：读或者写锁拿不到时忙等，可以优化成trylock，拿不到可以先干其他的，等一段时间再尝试拿锁。（不知道回答的对不对）

感悟：不论是单值信号量还是多值信号量，亦或是原始自旋锁、trylock版本自旋锁还是读写锁，各种机制的设计和优化都是为了资源（CPU等）的更合理更高效的使用而优化。互斥机制有很多，理解每种锁机制重要，但是理解我们的业务更重要，这样才能因地制宜选择合适的锁。

老师简明扼要，点到即止的文风太赞了，谢谢。</p>2022-03-29</li><br/><li><span>springXu</span> 👍（20） 💬（4）<p>同步与锁
操作系统是让应用程序认为当前有超大的内存空间和强大的cpu来工作的硬件环境，但其实硬件没有这么强大。那如何解决呢？比如在单核cpu上可以用分时技术，让进程交替执行。对于一个进程来说，我们可以把一个进程变成了多个线程来执行。但这样就产生了同一个资源可以是内存的某一具体地址，可以是鼠标可以是磁盘上的某一文件被多个线程访问和修改的问题。这两节课提供了解决思路，一个是cosmos操作系统的方案，一个是linux的方案。
1.原子性。就是硬件执行指令时不被打断。对于x86是复杂指令集。一条指令可以做读修改内存值的操作，指令集中直接支持锁定操作。对于精简指令集，就相对麻烦些，硬件会提供bitband的操作。
2.中断控制是在执行时，防止中断信号突然来了把当前执行的过程打断了。 解决方法就是关闭中断。让中断信号等到可以通知时，才发起通知。
3.自旋锁。在多核的cpu环境下，当前核心的cpu要访问的资源是有可能被其他核的cpu来访问的。如果产生这种情况，那就让其他核的cpu自己执行空转。一直到当前核心的cpu把访问资源让出后，其他核的cpu通过检测到了可以访问资源，不在空转执行相关操作恢复正常运行。而这个过程就是自旋锁。这里会有一点浪费cpu的运行效率。毕竟有个cpu在空转。当空转时间过长时，浪费的效能更大。我们需要更好的利用cpu核的方式来解决这个问题。那就是互斥。
4.信号量
对于单一资源的信号量也可以说是互斥锁。  互斥锁和自旋锁的区别就是原来那个空转的核不再空转，而是把当前运行的线程或者进程睡眠去执行其他的线程或者进程了。  当资源被适当后，去通知睡眠线程或者进程。这就是信号量。linux下新版本的信号量在被移除。</p>2021-05-30</li><br/><li><span>老男孩</span> 👍（34） 💬（4）<p>这个排队自旋锁的实现方式感觉很风骚啊。关于读锁最大支持进程数是0x01000000（学友们都已经解答了）关于写饥饿的问题，既然写锁和读锁在同时获取锁状态时候写锁优先，那么就应该对读锁做一个限制，不能让读锁朝着最大数奔去。比如，系统检测到有写锁在等待，那么就限制新的读锁加入，等已经存在的读锁都释放了，写锁马上加锁更新资源。然后等待的读锁再开始加锁读取。这个等待的队列要分为读锁队列和写锁队列。优先处理写锁队列，在没有写锁的时候才能继续加读锁，如果有写锁等待，那么新的读锁不管超没超出那个最大数，都要进入读锁队列等待写锁完成后再开始自己的表演。</p>2021-05-28</li><br/><li><span>pedro</span> 👍（29） 💬（2）<p>以后我就是第一东吹了😁！
像这样的清晰明了，言简意赅的Linux内核源码解读实在是太少了，这样的文章读起来实在是太爽了，强烈小编安排一下东哥的下一个专栏叫做 《纵览Linux源码，小白也能学透》。

对于思考题答案，读并发进程的最大个数就是0x01000000，只要lock大于0都是可以共享数据的。
至于读写锁的不足，我个人觉得最不友好的点在于读写互斥上，由于读锁对写锁是互斥的，如果一直有人读，那么计数器一直小于0x01000000，加写锁时也一直小于0，写锁一直也不会成功，会陷入长时间的写饥饿状态，并且一直自旋，浪费CPU资源。
所以改进点就在于，给写进程配上一个休眠队列，待加锁失败进入队列休眠等待，待解读锁时判断计数器，决定是否唤醒队列中的写进程。
当然还有很多其它的优化点，欢迎大家集思广益~</p>2021-05-28</li><br/><li><span>blentle</span> 👍（15） 💬（1）<p>回答一下思考题
1.理论上可以支持x01000000这么多进程，但实际上受限于文件句炳也就是文件描述符的限制，还有考虑多个线程的问题等等，注定最终远远小于这个值
2.读写锁造成写饥饿的情况是不是可以参考jdk的读写锁的实现，在条件等待队列中判断队列第一个元素是不是一个写进程，如果是写进程，让其直接优先获取锁.</p>2021-05-28</li><br/><li><span>GeekYanger</span> 👍（6） 💬（3）<p>文中：
“&#47;&#47;Linux没有这样的结构，这只是为了描述方便
typedef struct raw_spinlock
{ 
        union 
                { 
                        unsigned int slock;&#47;&#47;真正的锁值变量 
                        u16 owner; 
                        u16 next; 
                }
}raw_spinlock_t;”
这里老师为了帮助我们理解汇编代码构造了一个这样的结构体，我觉得，这个owner和next要被包在一个struct中才是老师想要表述的意思，不然owner和next的取值是一样的，都是低16位。</p>2021-12-13</li><br/><li><span>子青</span> 👍（4） 💬（2）<p>老师，我有两个问题想请教
1 。Linux自旋锁，如果一个进程在获取锁之后挂了怎么办，没人给owner +1了，后面排队的进程岂不是永远等不到锁释放？
2。信号量那里，down是在链表的头部插入，up是唤醒链表的头部，这样不会有饥饿问题吗，链表后面的可能永远拿不到资源？</p>2021-09-23</li><br/><li><span>3k</span> 👍（4） 💬（1）<p>为什么这节里实现自旋锁的时候都没有关中断了呢？</p>2021-06-09</li><br/><li><span>doos</span> 👍（3） 💬（1）<p>感觉不学习汇编和c很多都看不懂</p>2022-04-21</li><br/><li><span>疯码</span> 👍（3） 💬（1）<p>请问下为什么保存和恢复eflags那段代码用push pop而不是mov呢</p>2022-01-18</li><br/><li><span>kocgockohgoh王裒</span> 👍（3） 💬（1）<p>关于小弟问的那个关于排队自旋锁的问题，好像是因为gcc汇编的源 目的和intel手册上的顺序是反的。关于 xaddl，intel手册上说源是寄存器，目的是寄存器或内存。而slock是内存，不可能是源。所以小弟觉得源是%0  inc，目的是%1 slock, 所以xaddl相当于 temp = inc + slock,  inc = slock,  slock = slock + inc。 否则的话，每次调用slock都会被设成inc的初值0001000，不合理。不知道彭东大神觉得如何</p>2021-11-28</li><br/><li><span>Geek_4b6813</span> 👍（3） 💬（1）<p>最多支持同时有2^24个进程共享读锁(计算机常驻的进程基本上是不可能达到这个数的)
存在的问题，写饥饿，只要有读进程存在，写进程就永远没机会获得锁。</p>2021-07-06</li><br/><li><span>K菌无惨</span> 👍（3） 💬（1）<p>请问“_cond_lock 只用代码静态检查工作”这句话时什么意思？</p>2021-06-13</li><br/><li><span>Feen</span> 👍（2） 💬（1）<p>到第9课的时候，发现留言的数量少了很多，感觉操作系统（或者计算机原理）的淘汰率真的很高，能出师的太少了。关于最后的问题，应该说读锁最大支持的进程数是0x01000000，写锁最大的进程数人为的设置为1。写锁也可以设置为0x01000000，因为对于计算机来说，到底有多少进程写对它来说无关，数据对计算机没有意义，数据只对于人能不能正确使用有关。所以才有上写锁的时候直接减去0x01000000这个初始值，目的是控制只有一个进程可以写，而不是为了1而设置1。不管是中断，信号量，各种锁，最后都要靠CPU硬件的集成指令支持才能完成，就是原子操作，计算机上的各种软件，应用，服务都是靠原子操作完成自己的事务，手段就是在操作的时候不受打断，目的是完成一件事。怎么样能玩好原子操作，就能出师了。哈哈</p>2021-06-17</li><br/><li><span>fhs</span> 👍（2） 💬（2）<p>读写锁部分中。假设t1时候1号写线程获取到了锁且不释放：lock=0，t2时刻2号写线程尝试获取：lock=-(0x0100 0000)，t3时刻1号读尝试获取：lock=-(0x0100 0001)。
之后1号写即便释放了锁，此时lock = -1。但是2号写的比较成功的条件是：&quot;lock+0x01000000，直到结果的值等于 0x01000000&quot;。1号读的比较条件是&quot;循环测试 lock+1 的值，直到结果的值大于等于 1&quot;。
即在1号写释放之后，2号写和1号读因为lock是-1永远达不到各自退出循环的条件，一直在自旋？</p>2021-05-30</li><br/>
</ul>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../08%20-%20%E9%94%81%EF%BC%9A%E5%B9%B6%E5%8F%91%E6%93%8D%E4%BD%9C%E4%B8%AD%EF%BC%8C%E8%A7%A3%E5%86%B3%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E6%B3%95/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 08   锁：并发操作中，解决数据同步的四种方法">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                08   锁：并发操作中，解决数据同步的四种方法
              </div>
            </div>
          </a>
        
        
          
          <a href="../10%20-%20%E8%AE%BE%E7%BD%AE%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E4%B8%8E%E7%8E%AF%E5%A2%83%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E5%BB%BA%E7%AB%8B%E8%AE%A1%E7%AE%97%E6%9C%BA/" class="md-footer__link md-footer__link--next" aria-label="下一页: 10   设置工作模式与环境（上）：建立计算机">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                10   设置工作模式与环境（上）：建立计算机
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2025-Present zkep
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.annotate", "content.code.copy", "content.tooltips", "toc.follow", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.prune", "navigation.footer", "navigation.tracking", "navigation.instant", "navigation.instant.progress", "navigation.indexes", "content.tabs.link"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
        <script src="../../../javascript/extra.js"></script>
      
        <script src="../../../javascript/giscus.js"></script>
      
    
  </body>
</html>