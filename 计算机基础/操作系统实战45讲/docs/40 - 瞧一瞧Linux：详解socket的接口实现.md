ä½ å¥½ï¼Œæˆ‘æ˜¯LMOSã€‚

ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬ä¸€èµ·äº†è§£äº†å¥—æ¥å­—çš„å·¥ä½œæœºåˆ¶å’Œæ•°æ®ç»“æ„ï¼Œä½†å¥—æ¥å­—æœ‰å“ªäº›åŸºæœ¬æ¥å£å®ç°å‘¢ï¼Ÿç›¸ä¿¡å­¦å®Œè¿™èŠ‚è¯¾ï¼Œä½ å°±èƒ½å¤Ÿè§£å†³è¿™ä¸ªé—®é¢˜äº†ã€‚

ä»Šå¤©æˆ‘ä¼šå’Œä½ æ¢è®¨å¥—æ¥å­—ä»åˆ›å»ºã€åè®®æ¥å£æ³¨å†Œä¸åˆå§‹åŒ–è¿‡ç¨‹ï¼Œè¿˜ä¼šä¸ºä½ æ·±å…¥åˆ†æå¥—æ¥å­—ç³»ç»Ÿï¼Œæ˜¯æ€æ ·è°ƒç”¨å„ä¸ªåŠŸèƒ½å‡½æ•°çš„ã€‚é€šè¿‡è¿™èŠ‚è¯¾ï¼Œç›¸ä¿¡ä½ å¯ä»¥å­¦ä¼šåŸºäºå¥—æ¥å­—æ¥ç¼–å†™ç½‘ç»œåº”ç”¨ç¨‹åºã€‚æœ‰äº†ä¹‹å‰çš„åŸºç¡€ï¼Œæƒ³ç†è§£è¿™èŠ‚è¯¾å¹¶ä¸éš¾ï¼Œè®©æˆ‘ä»¬æ­£å¼å¼€å§‹å§ã€‚

## å¥—æ¥å­—æ¥å£

å¥—æ¥å­—æ¥å£æœ€åˆæ˜¯BSDæ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œåœ¨åº”ç”¨å±‚ä¸TCP/IPåè®®æ ˆä¹‹é—´æ¥ä¾›äº†ä¸€å¥—æ ‡å‡†çš„ç‹¬ç«‹äºåè®®çš„æ¥å£ã€‚

Linuxå†…æ ¸å®ç°çš„å¥—æ¥å­—æ¥å£ï¼Œå°†UNIXçš„â€œä¸€åˆ‡éƒ½æ˜¯æ–‡ä»¶æ“ä½œâ€çš„æ¦‚å¿µåº”ç”¨åœ¨äº†ç½‘ç»œè¿æ¥è®¿é—®ä¸Šï¼Œè®©åº”ç”¨ç¨‹åºå¯ä»¥ç”¨å¸¸è§„æ–‡ä»¶æ“ä½œAPIè®¿é—®ç½‘ç»œè¿æ¥ã€‚

ä»TCP/IPåè®®æ ˆçš„è§’åº¦æ¥çœ‹ï¼Œä¼ è¾“å±‚ä»¥ä¸Šçš„éƒ½æ˜¯åº”ç”¨ç¨‹åºçš„ä¸€éƒ¨åˆ†ï¼ŒLinuxä¸ä¼ ç»Ÿçš„UNIXç±»ä¼¼ï¼ŒTCP/IPåè®®æ ˆé©»ç•™åœ¨å†…æ ¸ä¸­ï¼Œä¸å†…æ ¸çš„å…¶ä»–ç»„ä»¶å…±äº«å†…å­˜ã€‚ä¼ è¾“å±‚ä»¥ä¸Šæ‰§è¡Œçš„ç½‘ç»œåŠŸèƒ½ï¼Œéƒ½æ˜¯åœ¨ç”¨æˆ·åœ°å€ç©ºé—´å®Œæˆçš„ã€‚

Linuxä½¿ç”¨å†…æ ¸å¥—æ¥å­—æ¦‚å¿µä¸ç”¨æˆ·ç©ºé—´å¥—æ¥å­—é€šä¿¡ï¼Œè¿™æ ·å¯ä»¥è®©å®ç°å’Œæ“ä½œå˜å¾—æ›´ç®€å•ã€‚Linuxæä¾›äº†ä¸€å¥—APIå’Œå¥—æ¥å­—æ•°æ®ç»“æ„ï¼Œè¿™äº›æœåŠ¡å‘ä¸‹ä¸å†…æ ¸æ¥å£å¯¹æ¥ï¼Œå‘ä¸Šä¸ç”¨æˆ·ç©ºé—´æ¥å£å¯¹æ¥ï¼Œåº”ç”¨ç¨‹åºæ­£æ˜¯ä½¿ç”¨è¿™ä¸€å¥—APIè®¿é—®å†…æ ¸ä¸­çš„ç½‘ç»œåŠŸèƒ½ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ9ï¼‰</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg" width="30px"><span>neohope</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹åˆ†æä¸‹ã€V5.8ï¼Œæ­£å¸¸æµç¨‹ã€‘
5ã€å®¢æˆ·ç«¯æ”¶åˆ°FINåŒ…ï¼Œå­çŠ¶æ€ä»TCP_FIN_WAIT2å˜ä¸ºTCP_TIME_WAITï¼Œè¿”å›ACKåŒ…
Aã€çŠ¶æ€å’Œå­çŠ¶æ€éƒ½ä¸ºTCP_TIME_WAIT
ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;
-&gt;if (sk-&gt;sk_state == TCP_TIME_WAIT) goto do_time_wait;
-&gt;do_time_wait:
-&gt;tcp_timewait_state_process
-&gt;-&gt;if (tw-&gt;tw_substate == TCP_FIN_WAIT2)
-&gt;-&gt;tw-&gt;tw_substate = TCP_TIME_WAIT;
-&gt;-&gt;inet_twsk_rescheduleï¼Œé‡æ–°è®¾ç½®å›è°ƒæ—¶é—´
-&gt;-&gt;return TCP_TW_ACK;

Bã€è¿”å›ACK
-&gt;case TCP_TW_ACK:
-&gt;tcp_v4_timewait_ack(sk, skb);

6ã€æœåŠ¡ç«¯æ”¶åˆ°ACKåŒ…ï¼ŒçŠ¶æ€ä»TCP_LAST_ACKå˜ä¸ºTCP_CLOSE
ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_state_process
-&gt;case TCP_LAST_ACK:
-&gt;tcp_done
-&gt;-&gt;tcp_set_state(sk, TCP_CLOSE);

7ã€å®¢æˆ·ç«¯è¶…æ—¶å›è°ƒ
Aã€è¶…æ—¶æ—¶é—´å®šä¹‰
#define TCP_TIMEWAIT_LEN (60*HZ)
#define TCP_FIN_TIMEOUT TCP_TIMEWAIT_LEN

Bã€è¶…æ—¶åï¼Œå›è°ƒtw_timer_handler-&gt;inet_twsk_killï¼Œè¿›è¡Œinet_timewait_sockæ¸…ç†å·¥ä½œ

Cã€æ²¡æœ‰æ‰¾åˆ°çŠ¶æ€å˜ä»TCP_TIME_WAITå˜ä¸ºTCP_CLOSEçš„ä»£ç 

Dã€åªçœ‹æ²¡è°ƒï¼Œæœ‰é—®é¢˜çš„ï¼Œæ¬¢è¿å°ä¼™ä¼´å‘Šè¯‰ä¸€ä¸‹</div>2021-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg" width="30px"><span>neohope</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹åˆ†æä¸Šã€V5.8ï¼Œæ­£å¸¸æµç¨‹ã€‘
1ã€å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥ï¼ŒçŠ¶æ€ä»TCP_ESTABLISHEDå˜ä¸ºTCP_FIN_WAIT1ï¼Œå‘é€FINåŒ…ç»™æœåŠ¡ç«¯
Aã€çŠ¶æ€å˜ä¸ºTCP_FIN_WAIT1
tcp_close-&gt;tcp_close_state
-&gt;tcp_set_state(sk, new_state[TCP_ESTABLISHED])ï¼Œä¹Ÿå°±æ˜¯TCP_FIN_WAIT1

Bã€å‘é€FINåŒ…
tcp_close-&gt;tcp_close_state
-&gt;tcp_send_fin

2ã€æœåŠ¡ç«¯æ”¶åˆ°FINåŒ…ï¼ŒçŠ¶æ€ä»TCP_ESTABLISHEDå˜ä¸ºTCP_CLOSE_WAITï¼Œå¹¶è¿”å›ACKåŒ…
Aã€çŠ¶æ€å˜ä¸ºTCP_CLOSE_WAIT
ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_established
-&gt;tcp_data_queue
-&gt;-&gt;tcp_fin
-&gt;-&gt;-&gt;inet_csk_schedule_ack; å®‰æ’ack
-&gt;-&gt;-&gt;sk-&gt;sk_shutdown |= RCV_SHUTDOWN; æ¨¡æ‹Ÿäº†close
-&gt;-&gt;-&gt;sock_set_flag(sk, SOCK_DONE);
-&gt;-&gt;-&gt;case TCP_ESTABLISHED:
-&gt;-&gt;-&gt;tcp_set_state(sk, TCP_CLOSE_WAIT); ä¿®æ”¹çŠ¶æ€
-&gt;-&gt;inet_csk(sk)-&gt;icsk_ack.pending |= ICSK_ACK_NOW;  ACSæ˜¯å¦ç«‹å³å‘é€

Bã€å‘é€ACKåŒ…
ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_establishedã€æ¥ä¸Šé¢ã€‘
-&gt;tcp_ack_snd_check-&gt;__tcp_ack_snd_check-&gt;tcp_send_ack

3ã€å®¢æˆ·ç«¯æ”¶åˆ°ACKåŒ…ï¼ŒçŠ¶æ€ä»TCP_FIN_WAIT1å˜ä¸ºTCP_FIN_WAIT2ï¼Œç„¶åè¢«æ›¿æ¢ä¸ºçŠ¶æ€TCP_TIME_WAITï¼Œå­çŠ¶æ€TCP_FIN_WAIT2
ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_state_process
-&gt;case TCP_FIN_WAIT1:
-&gt;tcp_set_state(sk, TCP_FIN_WAIT2);
-&gt;tcp_time_wait(sk, TCP_FIN_WAIT2, tmo);
-&gt;-&gt;tw = inet_twsk_alloc(sk, tcp_death_row, state);
-&gt;-&gt;-&gt;tw-&gt;tw_state = TCP_TIME_WAIT;   
-&gt;-&gt;-&gt;tw-&gt;tw_substate = TCP_FIN_WAIT2;
-&gt;-&gt;-&gt;timer_setup(&amp;tw-&gt;tw_timer, tw_timer_handler, TIMER_PINNED);

4ã€æœåŠ¡ç«¯çŠ¶æ€ä»TCP_CLOSE_WAITå˜ä¸ºTCP_LAST_ACKï¼Œå‘é€FINåŒ…
Aã€çŠ¶æ€å˜ä¸ºTCP_LAST_ACK
tcp_close-&gt;tcp_close_state
-&gt;tcp_set_state(sk, new_state[TCP_CLOSE_WAIT])ï¼Œä¹Ÿå°±æ˜¯TCP_LAST_ACK

Bã€å‘é€FINåŒ…
tcp_close-&gt;tcp_close_state
-&gt;tcp_send_fin</div>2021-08-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg" width="30px"><span>neohope</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹åˆ†æã€V5.8ï¼Œæ­£å¸¸æµç¨‹ã€‘
1ã€å®¢æˆ·ç«¯å‘èµ·ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼ŒçŠ¶æ€è°ƒå˜ä¸ºTCP_SYN_SENTï¼Œå‘é€SYNåŒ…
connect-&gt;__sys_connect-&gt;__sys_connect_file-&gt;ã€sock-&gt;ops-&gt;connectã€‘tcp_v4_connect
Aã€çŠ¶æ€å˜åŒ–
-&gt;tcp_set_state(sk, TCP_SYN_SENT);
Bã€å‘é€SYN
-&gt;tcp_connect-&gt;tcp_send_syn_data

2ã€æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯çš„SYNåŒ…ï¼Œåˆå§‹åŒ–socketï¼ŒçŠ¶æ€ä»TCP_LISTENå˜ä¸ºTCP_NEW_SYN_RECVï¼Œå‘é€ç¬¬äºŒæ¬¡æ¡æ‰‹SYN_ACKåŒ…
Aã€æ”¶åˆ°è¿æ¥ï¼Œåˆå§‹åŒ–socket
accept-&gt;__sys_accept4-&gt;__sys_accept4_file-&gt;ã€sock-&gt;ops-&gt;acceptã€‘inet_csk_accept

Bã€æ”¶åˆ°SYNï¼Œæ”¹å˜çŠ¶æ€
ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_state_process-&gt;
-&gt;case TCP_LISTEN:
-&gt;[sock-&gt;ops-&gt;conn_request]tcp_v4_conn_request-&gt;tcp_conn_request
-&gt;-&gt;inet_reqsk_alloc
-&gt;-&gt;-&gt;ireq-&gt;ireq_state = TCP_NEW_SYN_RECV;

Cã€å‘é€SYN_ACKåŒ…
-&gt;[sock-&gt;ops-&gt;conn_request]tcp_v4_conn_request-&gt;tcp_conn_requestã€å’ŒBè·¯å¾„ä¸€æ ·ã€‘
-&gt;-&gt;ã€af_ops-&gt;send_synackã€‘tcp_v4_send_synack
-&gt;-&gt;-&gt;tcp_make_synack
-&gt;-&gt;-&gt;__tcp_v4_send_check

3ã€å®¢æˆ·ç«¯æ”¶åˆ°SYN_ACKåŒ…ï¼ŒçŠ¶æ€ä»TCP_SYN_SENTå˜ä¸ºTCP_ESTABLISHEDï¼Œå¹¶å‘é€ACKåŒ…
Aã€æ”¶åˆ°SYN_ACKåŒ…
ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_state_process
-&gt;case TCP_SYN_SENT:
-&gt;tcp_rcv_synsent_state_process-&gt;tcp_finish_connect
-&gt;-&gt;tcp_set_state(sk, TCP_ESTABLISHED);

Bã€å‘é€ACKåŒ…
-&gt;tcp_rcv_synsent_state_process-&gt;tcp_send_ack-&gt;__tcp_send_ack

4ã€æœåŠ¡ç«¯æ”¶åˆ°ACKåŒ…ï¼ŒçŠ¶æ€ä»TCP_NEW_SYN_RECVå˜ä¸ºTCP_SYN_RECVã€å®é™…ä¸Šæ˜¯æ–°å»ºäº†ä¸€ä¸ªsockã€‘
ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;
-&gt;if (sk-&gt;sk_state == TCP_NEW_SYN_RECV)
-&gt;tcp_check_req
-&gt;-&gt;ã€inet_csk(sk)-&gt;icsk_af_ops-&gt;syn_recv_sockã€‘tcp_v4_syn_recv_sock-&gt;tcp_create_openreq_child-&gt;inet_csk_clone_lock
-&gt;-&gt;-&gt;inet_sk_set_state(newsk, TCP_SYN_RECV);

5ã€æœåŠ¡ç«¯çŠ¶æ€ä»TCP_SYN_RECVå˜ä¸ºTCP_ESTABLISHED
ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_state_process
-&gt;case TCP_SYN_RECV:
-&gt;tcp_set_state(sk, TCP_ESTABLISHED);

åªçœ‹æ²¡è°ƒï¼Œæœ‰é—®é¢˜çš„æ¬¢è¿å„ä½å°ä¼™ä¼´æŒ‡å‡ºã€‚</div>2021-08-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg" width="30px"><span>pedro</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>ä»Šå¤©çš„é—®é¢˜ä¸å¥½å›ç­”ï¼Œå› ä¸ºæ–‡ä¸­æ— æ˜æ˜¾ä¸‰æ¬¡æ¡æ‰‹çš„ä»£ç ï¼Œè€Œä¸”ä¸‰æ¬¡æ¡æ‰‹çš„æœºåˆ¶å…¶å®æ¯”è¾ƒå¤æ‚ï¼Œæ¶‰åŠåˆ°å‡ ä¸ªçŠ¶æ€å’Œå‡ ä¸ªé˜Ÿåˆ—ä¹‹é—´çš„åˆ‡æ¢ï¼Œç¬¼ç»Ÿçš„ connect å’Œ accept å‡½æ•°æ˜¯è¯´ä¸æ¸…æ¥šçš„ï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹çœ‹è¿™é‡Œï¼š
https:&#47;&#47;blog.csdn.net&#47;tennysonsky&#47;article&#47;details&#47;45621341

å½“ç„¶è¿™äº›ä¸èƒ½å…¨ä¿¡ï¼Œæ‰€ä»¥è¿˜æ˜¯å¾—è‡ªå·±çœ‹linuxå†…æ ¸ä»£ç ï¼Œå¾…æˆ‘çœ‹äº†å†æ¥è¡¥å……ğŸ˜‚</div>2021-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/b4/7c/59e24b60.jpg" width="30px"><span>ç‹å­è™¾</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œtcpåœ¨è°ƒç”¨listençš„æ—¶å€™ï¼Œæœ‰å…¨è¿æ¥é˜Ÿåˆ—çš„æ¦‚å¿µï¼Œä¸€èˆ¬ä¸Šé™æ˜¯128ã€‚ä½†æ˜¯é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬æ¯”å¦‚å®ç°å•æœºç™¾ä¸‡é“¾æ¥çš„æ—¶å€™ï¼Œä¸€ä¸ªserverç«¯çš„æºç»„ï¼ˆserver_ip+portï¼‰ï¼Œæ¯”å¦‚æœ‰65535ä¸ªclientï¼Œé‚£ä¼šä¸ä¼šå—é™äºè¿™ä¸ªå…¨è¿æ¥é˜Ÿåˆ—ï¼Ÿ</div>2022-04-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg" width="30px"><span>ifelse</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>nice</div>2022-02-25</li><br/><li><img src="" width="30px"><span>GeekCoder</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>èƒ½è®²è®²epollå—ï¼Ÿ</div>2021-10-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg" width="30px"><span>pedro</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è¿™é‡Œæœ‰ä¸€ç¯‡ä¸‰æ¬¡æ¡æ‰‹çš„æºç å›¾è§£ï¼šhttps:&#47;&#47;mp.weixin.qq.com&#47;s&#47;vlrzGc5bFrPIr9a7HIr2eA</div>2021-08-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/85/87/727142bc.jpg" width="30px"><span>MacBao</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>æœåŠ¡å™¨ç«¯å¤„äºlistençŠ¶æ€ï¼Œå®¢æˆ·ç«¯connectå‘èµ·TCPä¸‰æ¬¡æ¡æ‰‹ï¼Ÿ</div>2021-08-09</li><br/>
</ul>