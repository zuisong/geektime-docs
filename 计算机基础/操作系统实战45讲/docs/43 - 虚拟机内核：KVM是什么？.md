ä½ å¥½ï¼Œæˆ‘æ˜¯LMOSã€‚

ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬ç†è§£äº†Linuxé‡Œè¦å¦‚ä½•å®ç°ç³»ç»ŸAPIã€‚å¯æ˜¯éšç€äº‘è®¡ç®—ã€å¤§æ•°æ®å’Œåˆ†å¸ƒå¼æŠ€æœ¯çš„æ¼”è¿›ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šè™šæ‹ŸåŒ–å‡ºæ›´å¤šè™šæ‹Ÿæœºï¼Œè¿˜è¦è®©è¿™äº›è™šæ‹Ÿæœºèƒ½å¤Ÿå¼¹æ€§ä¼¸ç¼©ï¼Œå®ç°è·¨ä¸»æœºçš„è¿ç§»ã€‚

è€Œè™šæ‹ŸåŒ–æŠ€æœ¯æ­£æ˜¯è¿™äº›èƒ½åŠ›çš„åŸºçŸ³ã€‚è¿™ä¸€èŠ‚è¯¾ï¼Œå°±è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢ä¸€ä¸‹ï¼Œäºšé©¬é€Šã€é˜¿é‡Œã€è…¾è®¯ç­‰çŸ¥åå…¬å¸ç”¨åˆ°çš„äº‘è™šæ‹Ÿä¸»æœºï¼Œçœ‹çœ‹å…¶ä¸­çš„æ ¸å¿ƒæŠ€æœ¯â€”â€”KVMè™šæ‹ŸåŒ–æŠ€æœ¯ã€‚

## ç†è§£è™šæ‹ŸåŒ–çš„å®šä¹‰

ä»€ä¹ˆæ˜¯è™šæ‹ŸåŒ–ï¼Ÿåœ¨æˆ‘çœ‹æ¥ï¼Œè™šæ‹ŸåŒ–çš„æœ¬è´¨æ˜¯ä¸€ç§èµ„æºç®¡ç†çš„æŠ€æœ¯ï¼Œå®ƒå¯ä»¥é€šè¿‡å„ç§æŠ€æœ¯æ‰‹æ®µæŠŠè®¡ç®—æœºçš„å®ä½“èµ„æºï¼ˆå¦‚ï¼šCPUã€RAMã€å­˜å‚¨ã€ç½‘ç»œã€I/Oç­‰ç­‰ï¼‰è¿›è¡Œ**è½¬æ¢å’ŒæŠ½è±¡**ï¼Œè®©è¿™äº›èµ„æºå¯ä»¥é‡æ–°åˆ†å‰²ã€æ’åˆ—ä¸ç»„åˆï¼Œå®ç°**æœ€å¤§åŒ–ä½¿ç”¨ç‰©ç†èµ„æºçš„ç›®çš„**ã€‚

## è™šæ‹ŸåŒ–çš„æ ¸å¿ƒæ€æƒ³

å­¦ä¹ äº†å‰é¢çš„è¯¾ç¨‹æˆ‘ä»¬å‘ç°ï¼Œæ“ä½œç³»ç»Ÿçš„è®¾è®¡å¾ˆé«˜æ˜ï¼Œå·²ç»å¸®æˆ‘ä»¬å®ç°äº†å•æœºçš„èµ„æºé…ç½®éœ€æ±‚ï¼Œå…·ä½“å°±æ˜¯åœ¨ä¸€å°ç‰©ç†æœºä¸ŠæŠŠCPUã€å†…å­˜èµ„æºæŠ½è±¡æˆè¿›ç¨‹ï¼ŒæŠŠç£ç›˜ç­‰èµ„æºæŠ½è±¡å‡ºå­˜å‚¨ã€æ–‡ä»¶ã€I/Oç­‰ç‰¹æ€§ï¼Œæ–¹ä¾¿ä¹‹åçš„èµ„æºè°ƒåº¦å’Œç®¡ç†å·¥ä½œã€‚

ä½†éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæˆ‘ä»¬åšä¸ªç»Ÿè®¡å°±ä¼šå‘ç°ï¼Œå…¶å®ç°åœ¨çš„PCæœºå¹³å¸¸å¯èƒ½åªæœ‰50%çš„æ—¶é—´å¤„äºå·¥ä½œçŠ¶æ€ï¼Œå‰©ä¸‹çš„ä¸€åŠæ—¶é—´éƒ½æ˜¯åœ¨é—²ç½®èµ„æºï¼Œç”šè‡³è¦è¢«è¿«åˆ‡æ¢å›ä½åŠŸè€—çŠ¶æ€ã€‚è¿™æ˜¾ç„¶æ˜¯å¯¹èµ„æºçš„ä¸¥é‡æµªè´¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è§£å†³èµ„æºå¤ç”¨çš„é—®é¢˜å‘¢ï¼Ÿ

è¿™ä¸ªé—®é¢˜ç¡®å®å¾ˆå¤æ‚ï¼Œä½†æ ¹æ®æˆ‘ä»¬çš„å·¥ç¨‹ç»éªŒï¼Œä½†å‡¡é‡åˆ°ä¸å¤ªå¥½è§£å†³çš„é—®é¢˜ï¼Œæˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘æŠ½è±¡å‡ºä¸€ä¸ªæ–°çš„å±‚æ¬¡æ¥è§£å†³ã€‚äºæ˜¯æˆ‘ä»¬åœ¨å·²æœ‰çš„OSç»éªŒä¹‹ä¸Šï¼Œè¿›è¡Œäº†åé¢è¿™æ ·çš„è®¾è®¡ã€‚

![](https://static001.geekbang.org/resource/image/fc/09/fcbfd4f9eda7193a0b5254ddc74a0d09.jpg?wh=3405x1953 "è™šæ‹ŸåŒ–æ¶æ„ç®€å›¾")

ç»“åˆå›¾è§£ï¼Œå¯ä»¥çœ‹å‡ºæœ€å¤§çš„åŒºåˆ«å°±æ˜¯åè€…é¢å¤–å¼•å…¥äº†ä¸€ä¸ªå«Hypervisor/Virtual Machine Monitorï¼ˆVMMï¼‰çš„å±‚ã€‚åœ¨è¿™ä¸ªå±‚é‡Œé¢æˆ‘ä»¬å°±å¯ä»¥åšä¸€äº›â€œæ— ä¸­ç”Ÿæœ‰â€çš„äº‹æƒ…ï¼Œå‘ä¸‹ç»Ÿä¸€ç®¡ç†å’Œè°ƒåº¦çœŸå®çš„ç‰©ç†èµ„æºï¼Œå‘ä¸Šâ€œéª—â€è™šæ‹Ÿæœºï¼Œè®©æ¯ä¸ªè™šæ‹Ÿæœºéƒ½ä»¥ä¸ºè‡ªå·±éƒ½ç‹¬äº«äº†ç‹¬ç«‹çš„èµ„æºã€‚

è€Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ—¢ç„¶ä½œä¸ºä¸€ä¸ªâ€œä¸¤å¤´éª—çš„ä¸­é—´å•†â€ï¼Œæ˜¾ç„¶è¦åšä¸€äº›ç’å¤©è¿‡æµ·çš„äº‹æƒ…ï¼ˆè®¿é—®èµ„æºçš„æˆªè·ä¸é‡å®šå‘ï¼‰ã€‚é‚£ä¹ˆè®©æˆ‘ä»¬å…ˆæš‚åœä¸¤åˆ†é’Ÿï¼Œæ€è€ƒä¸€ä¸‹å…·ä½“å¦‚ä½•è®¾è®¡ï¼Œæ‰èƒ½å®ç°è¿™ä¸ªâ€œä¸¤å¤´éª—â€çš„ç›®æ ‡å‘¢ï¼Ÿ

## ç”¨èµµé«˜çŸ«è¯è°ˆç†è§£è™šæ‹ŸåŒ–

è¯´èµ·æ¬ºä¸Šç’ä¸‹ï¼Œæœ‰ä¸ªå†å²äººç‰©å¾ˆæœ‰ä»£è¡¨æ€§ï¼Œä»–å°±æ˜¯èµµé«˜ã€‚å§‹çš‡ä¸‰åä¸ƒå¹´ï¼ˆå‰210å¹´ï¼‰ï¼Œç»Ÿä¸€äº†å¤©ä¸‹çš„ç§¦å§‹çš‡ï¼ˆOSï¼‰åœ¨ç”Ÿå¹³æœ€åä¸€æ¬¡å‡ºå·¡è·¯ä¸Šå»ä¸–äº†ï¼Œç®¡ç†è¯ä¹¦çš„èµµé«˜ï¼ˆHypervisor/VMMï¼‰å´è¶æœºå‘åŠ¨äº†é˜´è°‹ï¼Œå¨èƒä¸ç›¸ææ–¯ï¼ŒçŸ«è¯å¤„æ­»æ‰¶è‹ä¸è’™æ¬ã€‚

![](https://static001.geekbang.org/resource/image/65/f3/65be2a810204bba7ce73c723ff839df3.jpg?wh=2457x1729 "èµµé«˜æ¬ºä¸Šç’ä¸‹")

èµµé«˜éšç’ç§¦å§‹çš‡æ­»è®¯ï¼Œè¿˜ä¼ªé€ äº†è¯ä¹¦ï¼Œå›åˆ°äº†å’¸é˜³æœ€ç»ˆä¸€é¡¿å¿½æ‚ ç«‹äº†èƒ¡äº¥ä¸ºä¸ºå¸ã€‚è¿™æ®µæ•…äº‹åä¸–ç§°ä¸ºæ²™ä¸˜ä¹‹å˜ã€‚

ä½œä¸ºä¸€ä¸ªæˆåŠŸç’å¤©è¿‡æµ·ï¼Œå®ç°äº†å·æ¢æ¢æŸ±çš„ä¸­é—´äººèµµé«˜ï¼Œä»–æˆäº‹çš„å…³é”®è¦ç‚¹åŒ…æ‹¬è¿™äº›ï¼Œé¦–å…ˆè¦åƒå’¸é˜³æ–¹å‘ä¼ªé€ ä¸€åˆ‡æ­£å¸¸çš„å‡è±¡ï¼ˆè®©è¢«è™šæ‹ŸåŒ–çš„æœºå™¨çœ‹èµ·æ¥å’Œå¹³å¸¸ä¸€æ ·ï¼‰ï¼Œå…¶æ¬¡è¿˜è¦æŠŠçœŸæ­£æ ¸å¿ƒçš„æƒé™è·å–åˆ°æ‰‹ï¼ˆHypervisor/VMMè¦æƒ³åŠæ³•è°ƒåº¦çœŸæ­£çš„ç‰©ç†èµ„æºï¼‰ã€‚

æ‰€ä»¥ä»¥å²ä¸ºé‰´ã€‚åœ¨å…·ä½“å®ç°çš„å±‚é¢ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œè¿™ä¸ªç’å¤©è¿‡æµ·çš„ç›®æ ‡å…¶å®æœ‰å‡ ç§å®ç°æ–¹å¼ã€‚

ä¸€ç§æ€è·¯æ˜¯èµµé«˜ä¸€ä¸ªäººå…¨æƒä»£ç†ï¼Œå…¨éƒ¨æ¨¡æ‹Ÿå’Œä»£ç†å‡ºæ‰€æœ‰çš„èµ„æºï¼ˆ**è½¯ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯**ï¼‰ï¼Œå¦ä¸€ç§æ€è·¯æ˜¯æœä¸­æœ‰äººï¼ˆèƒ¡äº¥ï¼‰é…åˆèµµé«˜æ§åˆ¶ã€è°ƒåº¦å„ç§èµ„æºçš„ä½¿ç”¨ï¼ŒçœŸæ­£æ‰§è¡Œçš„æ—¶å€™ï¼Œå†è½¬å‘ç»™èƒ¡äº¥å»å¤„ç†ï¼ˆ**ç¡¬ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯**ï¼‰ã€‚

æˆ‘ä»¬å‘ç°å¦‚æœå¦‚æœæ˜¯å‰è€…ï¼Œæ˜¾ç„¶èµµé«˜ä¼šæ¶ˆè€—å¤§é‡èµ„æºï¼Œå¹¶ä¸”è¿˜å¯èƒ½ä¼šé‡åˆ°ä¸€äº›å®‰å…¨é—®é¢˜ï¼Œæ‰€ä»¥ä»–é€‰æ‹©äº†åè€…ã€‚

å†å²æ€»æ˜¯æƒŠäººåœ°ç›¸ä¼¼ï¼Œåœ¨è½¯ä»¶è™šæ‹ŸåŒ–é‡åˆ°äº†æ— æ³•æ ¹æ²»çš„æ€§èƒ½ç“¶é¢ˆå’Œå®‰å…¨ç­‰é—®é¢˜çš„æ—¶å€™ï¼Œè½¯ä»¶å·¥ç¨‹å¸ˆå°±å¼€å§‹ç»™ç¡¬ä»¶å·¥ç¨‹å¸ˆæéœ€æ±‚äº†ï¼Œéœ€æ±‚èƒŒåçš„æ ¸å¿ƒæƒ³æ³•æ˜¯è¿™æ ·çš„ï¼šèƒ½ä¸èƒ½è®©æœä¸­æœ‰äººï¼Œæœ‰é—®é¢˜äº¤ç»™ä»–ï¼Œè½¯ä»¶ä¸­é—´å±‚åªç®¡è°ƒåº¦èµ„æºä¹‹ç±»çš„è½»é‡çº§å·¥ä½œå‘¢ï¼Ÿ

## KVMæ¶æ„æ¢³ç†

ç­”æ¡ˆæ˜¾ç„¶æ˜¯å¯ä»¥çš„ï¼Œæ ¹æ®æˆ‘ä»¬å¯¹è®¡ç®—æœºçš„äº†è§£å°±ä¼šå‘ç°ï¼Œè®¡ç®—æœºæœ€é‡è¦å‡ ç§èµ„æºåˆ†åˆ«æ˜¯ï¼šè®¡ç®—ï¼ˆCPUï¼‰ã€å­˜å‚¨ï¼ˆRAMã€ROMï¼‰ï¼Œä»¥åŠä¸ºäº†è¿æ¥å„ç§è®¾å¤‡æŠ½è±¡å‡ºçš„I/Oèµ„æºã€‚

æ‰€ä»¥Intelåˆ†åˆ«è®¾è®¡å‡ºäº†VT-xæŒ‡ä»¤é›†ã€VT-dæŒ‡ä»¤é›†ã€VT-cæŒ‡ä»¤é›†ç­‰æŠ€æœ¯æ¥å®ç°ç¡¬ä»¶è™šæ‹ŸåŒ–ï¼Œè®©CPUé…åˆæˆ‘ä»¬æ¥å®ç°è¿™ä¸ªç›®æ ‡ï¼Œäº†è§£äº†æ ¸å¿ƒæ€æƒ³ä¹‹åï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹KVMçš„æ¶æ„å›¾ã€‚ï¼ˆå›¾ç‰‡å‡ºè‡ª[è®ºæ–‡](https://www.cc.gatech.edu/~lingliu/papers/2013/YiRen-Cloud.pdf)ã€ŠResidency-Aware Virtual Machine Communication Optimization: Design Choices and Techniquesã€‹ï¼‰

![](https://static001.geekbang.org/resource/image/4f/81/4fa89e9e4c81f31fc1603059644ab081.png?wh=640x425)

æ˜¯ä¸æ˜¯çœ‹èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Ÿåˆ«æ‹…å¿ƒï¼Œæˆ‘ç”¨å¤§ç™½è¯å¸®ä½ æ¢³ç†ä¸€ä¸‹ã€‚

é¦–å…ˆï¼Œå®¢æˆ·æœºï¼ˆå’¸é˜³ï¼‰çœ‹åˆ°çš„ç¡¬ä»¶èµ„æºåŸºæœ¬éƒ½æ˜¯ç”±Hypervisorï¼ˆèµµé«˜ï¼‰æ¨¡æ‹Ÿå‡ºæ¥çš„ã€‚å½“å®¢æˆ·æœºå¯¹æ¨¡æ‹Ÿè®¾å¤‡è¿›è¡Œæ“ä½œæ—¶ï¼Œå‘½ä»¤å°±ä¼šè¢«æˆªè·å¹¶è½¬å‘ç»™å®é™…è®¾å¤‡/å†…æ ¸æ¨¡å—ï¼ˆèƒ¡äº¥ï¼‰å»å¤„ç†ã€‚

é€šè¿‡è¿™ç§æ¶æ„è®¾è®¡Hypervisorå±‚ï¼Œæœ€ç»ˆå®ç°äº†æŠŠä¸€ä¸ªå®¢æˆ·æœºæ˜ å°„åˆ°å®¿ä¸»æœºOSç³»ç»Ÿçš„ä¸€ä¸ªè¿›ç¨‹ï¼Œè€Œä¸€ä¸ªå®¢æˆ·æœºçš„vCPUåˆ™æ˜ å°„åˆ°è¿™ä¸ªè¿›ç¨‹ä¸‹çš„ç‹¬ç«‹çš„çº¿ç¨‹ä¸­ã€‚åŒç†ï¼ŒI/Oä¹Ÿå¯ä»¥æ˜ å°„åˆ°åŒä¸€ä¸ªçº¿ç¨‹ç»„å†…çš„ç‹¬ç«‹çº¿ç¨‹ä¸­ã€‚

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åŸºäºç‰©ç†æœºOSçš„è¿›ç¨‹ç­‰èµ„æºè°ƒåº¦èƒ½åŠ›ï¼Œå®ç°ä¸åŒè™šæ‹Ÿæœºçš„æƒé™é™å®šã€ä¼˜å…ˆçº§ç®¡ç†ç­‰åŠŸèƒ½äº†ã€‚

## KVMæ ¸å¿ƒåŸç†

é€šè¿‡å‰é¢çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬å‘ç°ï¼Œè¦å®ç°æˆåŠŸçš„è™šæ‹ŸåŒ–ï¼Œæ ¸å¿ƒæ˜¯è¦å¯¹èµ„æºè¿›è¡Œâ€œæ¬ºä¸Šç’ä¸‹â€ã€‚è€Œå¯¹åº”åˆ°æˆ‘ä»¬è®¡ç®—æœºå†…çš„æœ€é‡è¦çš„èµ„æºï¼Œå¯ä»¥ç®€å•æŠ½è±¡æˆä¸ºä¸‰å¤§ç±»ï¼Œåˆ†åˆ«æ˜¯ï¼šCPUã€å†…å­˜ã€I/Oã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹å¦‚ä½•è®©è¿™ä¸‰å¤§ç±»èµ„æºåšå¥½è™šæ‹ŸåŒ–ã€‚

### CPUè™šæ‹ŸåŒ–åŸç†

ä¼—æ‰€å‘¨çŸ¥ï¼ŒCPUæ˜¯æˆ‘ä»¬è®¡ç®—æœºæœ€é‡è¦çš„æ¨¡å—ï¼Œè®©æˆ‘ä»¬å…ˆçœ‹çœ‹Intel CPUæ˜¯å¦‚ä½•è·ŸHypervisor/VMMâ€œé‡Œåº”å¤–åˆâ€çš„ã€‚

Intelå®šä¹‰äº†Virtual Machine Extensionï¼ˆVMXï¼‰è¿™ä¸ªå¤„ç†å™¨ç‰¹æ€§ï¼Œä¹Ÿå°±æ˜¯ä¼ è¯´ä¸­çš„VT-xæŒ‡ä»¤é›†ï¼Œå¼€å¯äº†è¿™ä¸ªç‰¹æ€§ä¹‹åï¼Œå°±ä¼šå­˜åœ¨ä¸¤ç§æ“ä½œæ¨¡å¼ã€‚å®ƒä»¬åˆ†åˆ«æ˜¯ï¼šæ ¹æ“ä½œï¼ˆVMX root operationï¼‰å’Œéæ ¹æ“ä½œï¼ˆVMX non-root operationï¼‰ã€‚

æˆ‘ä»¬ä¹‹å‰è¯´çš„Hypervisor/VMMï¼Œå…¶å®å°±è¿è¡Œåœ¨æ ¹æ“ä½œæ¨¡å¼ä¸‹ï¼Œè¿™ç§æ¨¡å¼ä¸‹çš„ç³»ç»Ÿå¯¹å¤„ç†å™¨å’Œå¹³å°ç¡¬ä»¶å…·æœ‰å®Œå…¨çš„æ§åˆ¶æƒé™ã€‚

è€Œå®¢æˆ·è½¯ä»¶ï¼ˆGuest softwareï¼‰åŒ…æ‹¬è™šæ‹Ÿæœºå†…çš„æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºï¼Œåˆ™è¿è¡Œåœ¨éæ ¹æ“ä½œæ¨¡å¼ä¸‹ã€‚å½“å®¢æˆ·è½¯ä»¶æ‰§è¡Œä¸€äº›ç‰¹æ®Šçš„æ•æ„ŸæŒ‡ä»¤æˆ–è€…ä¸€äº›å¼‚å¸¸ï¼ˆå¦‚CPUIDã€INVDã€INVEPTæŒ‡ä»¤ï¼Œä¸­æ–­ã€æ•…éšœã€æˆ–è€…ä¸€äº›å¯„å­˜å™¨æ“ä½œç­‰ï¼‰æ—¶ï¼Œåˆ™ä¼šè§¦å‘VM-ExitæŒ‡ä»¤åˆ‡æ¢å›æ ¹æ“ä½œæ¨¡å¼ï¼Œä»è€Œè®©Hypervisor/VMMå®Œå…¨æ¥ç®¡æ§åˆ¶æƒé™ã€‚

ä¸‹é¢è¿™å¼ å›¾ç”»å‡ºäº†æ¨¡å¼åˆ‡æ¢çš„è¿‡ç¨‹ï¼Œæƒ³åœ¨è¿™ä¸¤ç§æ¨¡å¼ä¹‹é—´åˆ‡æ¢ï¼Œå°±è¦é€šè¿‡VM-Entryå’ŒVM-Exitå®ç°è¿›å…¥å’Œé€€å‡ºã€‚è€Œåœ¨è¿™ä¸ªåˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œä½ è¦ç•™æ„ä¸€ä¸ªéå¸¸å…³é”®çš„æ•°æ®ç»“æ„ï¼Œå®ƒå°±æ˜¯VMCSï¼ˆVirtual Machine Control Structureï¼‰æ•°æ®ç»“æ„æ§åˆ¶ï¼ˆä¸‹æ–‡ä¹Ÿä¼šè®²åˆ°ï¼‰ã€‚

![](https://static001.geekbang.org/resource/image/4d/1e/4d939a7422a37dfe2ce0d4d3887d051e.jpg?wh=2580x1240 "VMMå’ŒGueståˆ‡æ¢è¿‡ç¨‹")

### å†…å­˜è™šæ‹ŸåŒ–åŸç†

å†…å­˜è™šæ‹ŸåŒ–çš„æ ¸å¿ƒç›®çš„æ˜¯â€œéª—â€å®¢æˆ·æœºï¼Œç»™æ¯ä¸ªè™šæ‹Ÿå®¢æˆ·æœºéƒ½æä¾›ä¸€ä¸ªä»0å¼€å§‹çš„è¿ç»­çš„ç‰©ç†å†…å­˜ç©ºé—´çš„å‡è±¡ï¼ŒåŒæ—¶åˆè¦ä¿éšœå„ä¸ªè™šæ‹Ÿæœºä¹‹é—´å†…å­˜çš„éš”ç¦»å’Œè°ƒåº¦èƒ½åŠ›ã€‚

å¯èƒ½æœ‰åŒå­¦å·²ç»è”æƒ³åˆ°ï¼Œæˆ‘ä»¬ä¹‹å‰å®ç°å®ç°è™šæ‹Ÿå†…å­˜çš„æ—¶å€™ï¼Œä¸ä¹Ÿæ˜¯åœ¨â€œéª—â€åº”ç”¨ç¨‹åºæ¯ä¸ªç¨‹åºéƒ½æœ‰è¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œä¸ºæ­¤è¿˜è®¾è®¡äº†ä¸€å¤§å †â€œè½¬æ¢è¡¨â€çš„æ•°æ®ç»“æ„å’Œè½¬æ¢ã€è°ƒåº¦æœºåˆ¶ä¹ˆï¼Ÿ

æ²¡é”™ï¼Œå…¶å®å†…å­˜è™šæ‹ŸåŒ–ä¹Ÿå€Ÿé‰´äº†ç›¸åŒçš„æ€æƒ³ï¼Œåªä¸è¿‡é—®é¢˜æ›´å¤æ‚äº›ï¼Œå› ä¸ºæˆ‘ä»¬å‘ç°æˆ‘ä»¬çš„å†…å­˜ä»åŸå…ˆçš„è™šæ‹Ÿåœ°å€ã€ç‰©ç†åœ°å€çªç„¶å˜æˆäº†åé¢è¿™å››ç§å†…å­˜åœ°å€ã€‚

1.å®¢æˆ·æœºè™šæ‹Ÿåœ°å€GVAï¼ˆGuest Virtual Addressï¼‰  
2.å®¢æˆ·æœºç‰©ç†åœ°å€GPAï¼ˆGuest Physical Addressï¼‰  
3.å®¿ä¸»æœºè™šæ‹Ÿåœ°å€HVAï¼ˆHost Virtual Addressï¼‰  
4.å®¿ä¸»æœºç‰©ç†åœ°å€HPAï¼ˆHost Physical Addressï¼‰

ä¸€çœ‹åˆ°æœ‰è¿™ä¹ˆå¤šç§åœ°å€ï¼Œåˆéœ€è¦è¿›è¡Œåœ°å€è½¬æ¢ï¼Œæƒ³å¿…è½¬æ¢æ—¶çš„**æ˜ å°„å…³ç³»è¡¨**æ˜¯å°‘ä¸æ‰çš„ã€‚

ç¡®å®ï¼Œæ—©æœŸæˆ‘ä»¬ä¸»è¦æ˜¯åŸºäºå½±å­é¡µè¡¨ï¼ˆShadow Page Tableï¼‰æ¥è¿›è¡Œè½¬æ¢çš„ï¼Œç¼ºç‚¹å°±æ˜¯æ€§èƒ½æœ‰ä¸å°çš„æŸè€—ã€‚æ‰€ä»¥ï¼Œåæ¥Intelåœ¨ç¡¬ä»¶ä¸Šå°±è®¾è®¡äº†EPTï¼ˆExtended Page Tablesï¼‰æœºåˆ¶ï¼Œç”¨æ¥æå‡å†…å­˜åœ°å€è½¬æ¢æ•ˆç‡ã€‚

### I/Oè™šæ‹ŸåŒ–åŸç†

I/Oè™šæ‹ŸåŒ–æ˜¯åŸºäºIntelçš„VT-dæŒ‡ä»¤é›†æ¥å®ç°çš„ï¼Œè¿™æ˜¯ä¸€ç§åŸºäºNorth BridgeåŒ—æ¡¥èŠ¯ç‰‡ï¼ˆæˆ–MCHï¼‰çš„ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–æŠ€æœ¯ã€‚

è¿ç”¨VT-dæŠ€æœ¯ï¼Œè™šæ‹Ÿæœºå¾—ä»¥ä½¿ç”¨åŸºäºç›´æ¥I/Oè®¾å¤‡åˆ†é…æ–¹å¼ï¼Œæˆ–è€…ç”¨I/Oè®¾å¤‡å…±äº«æ–¹å¼æ¥ä»£æ›¿ä¼ ç»Ÿçš„è®¾å¤‡æ¨¡æ‹Ÿ/é¢å¤–è®¾å¤‡æ¥å£æ–¹å¼ï¼Œä¸éœ€è¦ç¡¬ä»¶æ”¹åŠ¨ï¼Œè¿˜çœå»äº†ä¸­é—´é€šé“å’ŒVMMçš„å¼€é”€ï¼Œä»è€Œå¤§å¤§æå‡äº†è™šæ‹ŸåŒ–çš„I/Oæ€§èƒ½ï¼Œè®©è™šæ‹Ÿæœºæ€§èƒ½æ›´æ¥è¿‘äºçœŸå®ä¸»æœºã€‚

## KVMå…³é”®ä»£ç èµ°è¯»

å‰é¢æˆ‘ä»¬å·²ç»æ˜ç™½äº†CPUã€å†…å­˜ã€I/Oè¿™ä¸‰ç±»é‡è¦çš„èµ„æºæ˜¯å¦‚ä½•åšåˆ°è™šæ‹ŸåŒ–çš„ã€‚ä¸è¿‡çŸ¥å…¶ç„¶,ä¹Ÿè¦çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œå¯¹çŸ¥è¯†åªæµäºåŸç†æ˜¯ä¸å¤Ÿçš„ã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œå…·ä½“åˆ°ä»£ç å±‚é¢ï¼Œè™šæ‹ŸåŒ–æŠ€æœ¯æ˜¯å¦‚ä½•å®ç°çš„ã€‚

### åˆ›å»ºè™šæ‹Ÿæœº

è¿™é‡Œæˆ‘æƒ³æé†’ä½ çš„æ˜¯ï¼Œåç»­ä»£ç ä¸ºäº†æ–¹ä¾¿é˜…è¯»å’Œç†è§£ï¼Œåªä¿ç•™äº†ä¸æ ¸å¿ƒé€»è¾‘ç›¸å…³çš„ä»£ç ï¼Œçœç•¥äº†éƒ¨åˆ†ä»£ç ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è™šæ‹Ÿæœºåˆå§‹åŒ–çš„å…¥å£éƒ¨åˆ†ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

```
virt/kvm/kvm_main.c: 
static int kvm_dev_ioctl_create_vm(void)
{
	int fd;
	struct kvm *kvm;

	 kvm = kvm_create_vm(type);
	 if (IS_ERR(kvm))
	         return PTR_ERR(kvm);

	 r = kvm_coalesced_mmio_init(kvm);

	 r = get_unused_fd_flags(O_CLOEXEC);

         /*ç”Ÿæˆkvm-vmæ§åˆ¶æ–‡ä»¶*/
	 file = anon_inode_getfile("kvm-vm", &kvm_vm_fops, kvm, O_RDWR);

	return fd;
}
```

æ¥ä¸‹æ¥ã€‚æˆ‘ä»¬è¦åˆ›å»ºKVMä¸­å†…å­˜ã€I/Oç­‰èµ„æºç›¸å…³çš„æ•°æ®ç»“æ„å¹¶è¿›è¡Œåˆå§‹åŒ–ã€‚

```
virt/kvm/kvm_main.c:
static struct kvm *kvm_create_vm(void)
{
	int r, i;
    struct kvm *kvm = kvm_arch_create_vm();

    /*è®¾ç½®kvmçš„mmç»“æ„ä¸ºå½“å‰è¿›ç¨‹çš„mm,ç„¶åå¼•ç”¨è®¡æ•°ä¸º1*/
    kvm->mm = current->mm;
    kvm_eventfd_init(kvm);
	mutex_init(&kvm->lock);
	mutex_init(&kvm->irq_lock);
	mutex_init(&kvm->slots_lock);
	refcount_set(&kvm->users_count, 1);
	INIT_LIST_HEAD(&kvm->devices);
	INIT_HLIST_HEAD(&kvm->irq_ack_notifier_list);

	r = kvm_arch_init_vm(kvm, type);

	r = hardware_enable_all()

	for (i = 0; i < KVM_NR_BUSES; i++) {
		rcu_assign_pointer(kvm->buses[i],
	kzalloc(sizeof(struct kvm_io_bus), GFP_KERNEL));
	}
	kvm_init_mmu_notifier(kvm); 

    /*æŠŠkvmé“¾è¡¨åŠ å…¥æ€»é“¾è¡¨*/
	list_add(&kvm->vm_list, &vm_list);

	return kvm;
}
```

ç»“åˆä»£ç æˆ‘ä»¬çœ‹å¾—å‡ºï¼Œåˆå§‹åŒ–å®Œæ¯•åä¼šå°†KVMåŠ å…¥åˆ°ä¸€ä¸ªå…¨å±€é“¾è¡¨å¤´ã€‚è¿™æ ·,æˆ‘ä»¬åé¢å°±å¯ä»¥é€šè¿‡è¿™ä¸ªé“¾è¡¨å¤´ï¼Œéå†æ‰€æœ‰çš„VMè™šæ‹Ÿæœºäº†ã€‚

### åˆ›å»ºvCPU

åˆ›å»ºVMä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯åˆ›å»ºæˆ‘ä»¬è™šæ‹Ÿæœºèµ–ä»¥ç”Ÿå­˜çš„vCPUäº†ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

```
virt/kvm/kvm_main.c:
static int kvm_vm_ioctl_create_vcpu(struct kvm *kvm, u32 id)
{
	int r;
	struct kvm_vcpu *vcpu, *v;
    /*è°ƒç”¨ç›¸å…³cpuçš„vcpu_create é€šè¿‡arch/x86/x86.c è¿›å…¥vmx.c*/
    vcpu = kvm_arch_vcpu_create(kvm, id);

    /*è°ƒç”¨ç›¸å…³cpuçš„vcpu_setup*/
	r = kvm_arch_vcpu_setup(vcpu);

    /*åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æœ€å¤§cpuä¸ªæ•°*/
	mutex_lock(&kvm->lock);
	if (atomic_read(&kvm->online_vcpus) == KVM_MAX_VCPUS) {
		r = -EINVAL;
		goto vcpu_destroy;
	}
    kvm->created_vcpus++;    
	mutex_unlock(&kvm->lock);

    /*ç”Ÿæˆkvm-vcpuæ§åˆ¶æ–‡ä»¶*/
	/* Now it's all set up, let userspace reach it */
    kvm_get_kvm(kvm);
	r = create_vcpu_fd(vcpu);

        kvm_get_kvm(kvm);
        r = create_vcpu_fd(vcpu);
        if (r < 0) {
                kvm_put_kvm(kvm);
                goto unlock_vcpu_destroy;
        }

        kvm->vcpus[atomic_read(&kvm->online_vcpus)] = vcpu;

        /*
         * Pairs with smp_rmb() in kvm_get_vcpu.  Write kvm->vcpus
         * before kvm->online_vcpu's incremented value.
         */
        smp_wmb();
        atomic_inc(&kvm->online_vcpus);

        mutex_unlock(&kvm->lock);
        kvm_arch_vcpu_postcreate(vcpu);

}
```

æ¥ç€ï¼Œä»è¿™éƒ¨åˆ†ä»£ç é¡ºè—¤æ‘¸ç“œã€‚

æˆ‘ä»¬é¦–å…ˆåœ¨ç¬¬7è¡Œçš„kvm\_arch\_vcpu\_create()å‡½æ•°å†…è¿›è¡Œvcpu\_vmxç»“æ„çš„ç”³è¯·æ“ä½œï¼Œç„¶åè¿˜å¯¹vcpu\_vmxè¿›è¡Œäº†åˆå§‹åŒ–ã€‚åœ¨è¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒåŒæ—¶è¿˜ä¼šè®¾ç½®CPUæ¨¡å¼å¯„å­˜å™¨ï¼ˆMSRå¯„å­˜å™¨ï¼‰ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¼šåˆ†åˆ«ä¸ºguestå’Œhostç”³è¯·é¡µé¢ï¼Œå¹¶åœ¨é¡µé¢é‡Œä¿å­˜MSRå¯„å­˜å™¨çš„ä¿¡æ¯ã€‚æœ€åï¼Œæˆ‘ä»¬è¿˜ä¼šç”³è¯·ä¸€ä¸ªvmcsç»“æ„ï¼Œå¹¶è°ƒç”¨vmx\_vcpu\_setupè®¾ç½®vCPUçš„å·¥ä½œæ¨¡å¼ï¼Œè¿™é‡Œå°±æ˜¯**å®æ¨¡å¼**ã€‚ï¼ˆä¸€çœ‹åˆ°æŠŠvCPUåˆ‡æ¢å›å®æ¨¡å¼ï¼Œæœ‰æ²¡æœ‰ä¸€ç§è½®å›åˆ°æˆ‘ä»¬[ç¬¬äº”èŠ‚è¯¾](https://time.geekbang.org/column/article/375278)çš„æ„Ÿè§‰ï¼Ÿï¼‰

### vCPUè¿è¡Œ

ä¸è¿‡åªæŠŠvCPUåˆ›å»ºå‡ºæ¥æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜è¦è®©å®ƒè¿è¡Œèµ·æ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹vcpu\_runå‡½æ•°ã€‚

```
arch/x86/kvm/x86.c:
static int vcpu_run(struct kvm_vcpu *vcpu)
{
        int r;
        struct kvm *kvm = vcpu->kvm;
        for (;;) {
		/*vcpuè¿›å…¥guestæ¨¡å¼*/ 
                if (kvm_vcpu_running(vcpu)) {
                   r = vcpu_enter_guest(vcpu);
                } else {
                        r = vcpu_block(kvm, vcpu);
                }
                kvm_clear_request(KVM_REQ_PENDING_TIMER, vcpu);

		/*æ£€æŸ¥æ˜¯å¦æœ‰é˜»å¡çš„æ—¶é’Ÿtimer*/
                if (kvm_cpu_has_pending_timer(vcpu))
                        kvm_inject_pending_timer_irqs(vcpu);

		/*æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·ç©ºé—´çš„ä¸­æ–­æ³¨å…¥*/ 
                if (dm_request_for_irq_injection(vcpu) &&
                        kvm_vcpu_ready_for_interrupt_injection(vcpu)) {
                        r = 0;
                        vcpu->run->exit_reason = KVM_EXIT_IRQ_WINDOW_OPEN;
                        ++vcpu->stat.request_irq_exits;
                        break;
                }
                kvm_check_async_pf_completion(vcpu);

		/*æ˜¯å¦æœ‰é˜»å¡çš„signal*/
                if (signal_pending(current)) {
                        r = -EINTR;
                        vcpu->run->exit_reason = KVM_EXIT_INTR;
                        ++vcpu->stat.signal_exits;
                        break;
                }
		/*æ‰§è¡Œä¸€ä¸ªè°ƒåº¦*/
                 if (need_resched()) {
                         cond_resched();
                 }
         }
```

çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ç»ˆäºç†è§£äº†ä¸Šæ–‡è¯´çš„VM-Exitã€VM-EntryæŒ‡ä»¤è¿›å…¥ã€é€€å‡ºçš„æœ¬è´¨äº†ã€‚è¿™å…¶å®æ˜¯å°±æ˜¯é€šè¿‡vcpu\_enter\_guestè¿›å…¥/é€€å‡ºvCPUï¼Œåœ¨æ ¹æ¨¡å¼ä¹‹é—´æ¥å›åˆ‡æ¢ã€åå¤æ¨ªè·³çš„è¿‡ç¨‹ã€‚

### å†…å­˜è™šæ‹ŸåŒ–

åœ¨vcpuåˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨kvm\_init\_mmuæ¥è®¾ç½®è™šæ‹Ÿå†…å­˜åˆå§‹åŒ–ã€‚åœ¨è¿™é‡Œä¼šæœ‰ä¸¤ç§ä¸åŒçš„æ¨¡å¼ï¼Œä¸€ç§æ˜¯åŸºäºEPTçš„æ–¹å¼ï¼Œå¦ä¸€ç§æ˜¯åŸºäºå½±å­é¡µè¡¨å®ç°çš„soft mmuæ–¹å¼ã€‚

```
arch/x86/kvm/mmu/mmu.c
void kvm_init_mmu(struct kvm_vcpu *vcpu, bool reset_roots)
{
	......
	/*åµŒå¥—è™šæ‹ŸåŒ–ï¼Œæˆ‘ä»¬æš‚ä¸è€ƒè™‘äº† */
        if (mmu_is_nested(vcpu))
                init_kvm_nested_mmu(vcpu);
        else if (tdp_enabled)
                init_kvm_tdp_mmu(vcpu);
        else
                init_kvm_softmmu(vcpu);
}
```

### I/Oè™šæ‹ŸåŒ–

I/Oè™šæ‹ŸåŒ–å…¶å®ä¹Ÿæœ‰ä¸¤ç§æ–¹æ¡ˆï¼Œä¸€ç§æ˜¯å…¨è™šæ‹ŸåŒ–æ–¹æ¡ˆï¼Œä¸€ç§æ˜¯åŠè™šæ‹ŸåŒ–æ–¹æ¡ˆã€‚åŒºåˆ«åœ¨äºå…¨è™šæ‹ŸåŒ–ä¼šåœ¨VM-exité€€å‡ºä¹‹åæŠŠIOäº¤ç»™QEMUå¤„ç†ï¼Œè€ŒåŠè™šæ‹ŸåŒ–åˆ™æ˜¯æŠŠI/Oå˜æˆäº†æ¶ˆæ¯å¤„ç†ï¼Œä»å®¢æˆ·æœºï¼ˆguestï¼‰æœºå™¨å‘æ¶ˆæ¯å‡ºæ¥ï¼Œå®¿ä¸»æœºï¼ˆç”±hostï¼‰æœºå™¨æ¥å¤„ç†ã€‚

```
arch/x86/kvm/vmx.c:
static int handle_io(struct kvm_vcpu *vcpu)
{
        unsigned long exit_qualification;
        int size, in, string;
        unsigned port;

        exit_qualification = vmcs_readl(EXIT_QUALIFICATION);
        string = (exit_qualification & 16) != 0;

        ++vcpu->stat.io_exits;

        if (string)
                return kvm_emulate_instruction(vcpu, 0) == EMULATE_DONE;

        port = exit_qualification >> 16;
        size = (exit_qualification & 7) + 1;
        in = (exit_qualification & 8) != 0;

        return kvm_fast_pio(vcpu, size, port, in);
}
```

## é‡ç‚¹å›é¡¾

å¥½ï¼Œè¿™èŠ‚è¯¾çš„å†…å®¹å‘Šä¸€æ®µè½äº†ï¼Œæˆ‘æ¥ç»™ä½ åšä¸ªæ€»ç»“ã€‚å†å²æ€»æ˜¯æƒŠäººç›¸ä¼¼ï¼Œä»Šå¤©æˆ‘ç”¨ä¸€ä¸ªå†å²æ•…äº‹å¸¦ä½ ç†è§£äº†è™šæ‹ŸåŒ–çš„æ ¸å¿ƒæ€æƒ³ï¼Œå¼•å…¥ä¸€ä¸ªä¸“é—¨çš„å±‚ï¼Œåƒèµµé«˜ä¸€æ ·ç’å¤©è¿‡æµ·ï¼Œå‘ä¸‹ç»Ÿä¸€ç®¡ç†å’Œè°ƒåº¦çœŸå®çš„ç‰©ç†èµ„æºï¼Œå‘ä¸Šâ€œéª—â€è™šæ‹Ÿæœºã€‚

è€Œè¦æƒ³æˆåŠŸå®ç°è™šæ‹ŸåŒ–ï¼Œæ ¸å¿ƒå°±æ˜¯å¯¹èµ„æºè¿›è¡Œâ€œæ¬ºä¸Šç’ä¸‹â€ã€‚æˆ‘å¸¦ä½ æ¢³ç†åˆ†æäº†KVMçš„åŸºæœ¬æ¶æ„ä»¥åŠCPUã€RAMã€I/Oä¸‰å¤§ä»¶çš„è™šæ‹ŸåŒ–åŸç†ã€‚å…¶ä¸­ï¼Œå†…å­˜è™šæ‹ŸåŒ–è™½ç„¶è¡ç”Ÿå‡ºäº†å››ç§å†…å­˜ï¼Œä½†ä½ ä¸å¦¨ä»¥ç”¨å½“åˆç‰©ç†å†…å­˜ä¸è™šæ‹Ÿå†…å­˜çš„æ€è·¯åšç±»æ¯”å­¦ä¹ ã€‚

ä¹‹åï¼Œæˆ‘åˆå¸¦ä½ è¿›è¡Œäº†KVMæ ¸å¿ƒé€»è¾‘ç›¸å…³çš„ä»£ç èµ°è¯»ï¼Œå¦‚æœä½ æœ‰å…´è¶£é˜…è¯»å®Œæ•´çš„KVMä»£ç ï¼Œå¯ä»¥åˆ°[å®˜æ–¹ä»“åº“](https://github.com/torvalds/linux)æœç´¢ã€‚

æœ€åï¼Œä¸ºäº†å¸®ä½ å·©å›ºä»Šå¤©çš„å­¦ä¹ å†…å®¹ï¼Œæˆ‘ç‰¹æ„æ•´ç†äº†å¯¼å›¾ã€‚

![](https://static001.geekbang.org/resource/image/0b/97/0b768c2f3b8cd80539347f546f6b2397.jpg?wh=3219x2193)

## æ€è€ƒé¢˜

æœ‰äº†KVMä½œä¸ºè™šæ‹ŸåŒ–çš„åŸºçŸ³ä¹‹åï¼Œå¦‚æœè®©ä½ ä»é›¶å¼€å§‹ï¼Œè®¾è®¡ä¸€æ¬¾åƒå„å¤§äº‘å‚å•†IAASå¹³å°ä¸€æ ·çš„è™šæ‹ŸåŒ–å¹³å°ï¼Œè¿˜éœ€è¦è€ƒè™‘å“ªäº›é—®é¢˜å‘¢ï¼Ÿ

æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè·Ÿæˆ‘äº’åŠ¨ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾è½¬å‘ç»™è‡ªå·±çš„æœ‹å‹ï¼Œè·Ÿä»–ä¸€èµ·æ¢è®¨KVMçš„ç›¸å…³é—®é¢˜ã€‚

æˆ‘æ˜¯LMOSï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ10ï¼‰</strong></div><ul>
<li><span>pedro</span> ğŸ‘ï¼ˆ12ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<p>ä»¥æˆ‘æ‰€åœ¨çš„è…¾è®¯äº‘ä¸ºä¾‹ã€‚
è…¾è®¯äº‘æœåŠ¡å™¨ CVM æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰ä¸€åˆ‡èµ„æºï¼šCPUã€å†…å­˜ã€ç¡¬ç›˜ã€ç½‘ç»œã€å®‰å…¨ç­‰ï¼Œå¹¶å¯ä»¥åœ¨éœ€æ±‚å‘ç”Ÿå˜åŒ–æ—¶è½»æ¾åœ°è°ƒæ•´å®ƒä»¬ï¼Œè¿˜æ”¯æŒéšæ—¶æ‰©å®¹ï¼Œè¿ç§»ï¼Œè¿ç»´ç­‰ç®¡ç†åŠŸèƒ½ã€‚
ä¸€ä¸ªæˆç†Ÿçš„IAASå¹³å°æ­å»ºèµ·æ¥ä¸å®¹æ˜“å•Šï¼Œè¦è€ƒè™‘çš„äº‹æƒ…å¤ªå¤šäº†ã€‚</p>2021-08-16</li><br/><li><span>è‹æµéƒå®“</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è£…è™šæ‹Ÿæœºå‡ºç°è¿‡ghostç³»ç»Ÿï¼ˆå¦‚winç³»ç»Ÿghostç‰ˆï¼‰ï¼Œåœ¨VMè™šæ‹Ÿæœºä¸Šé¢è¯†åˆ«ä¸äº†ï¼Œéœ€è¦è£…åŸç‰ˆå®˜ç½‘ä¸‹è½½çš„éghostç‰ˆæœ¬æ‰å®‰è£…æˆåŠŸï¼Œä»¥åŠAMDçš„cpuè£…è‹¹æœç³»ç»Ÿä¹Ÿæ²¡æˆåŠŸï¼Œæ•…è®¤ä¸ºå¼€å‘è™šæ‹Ÿæœºç³»ç»Ÿï¼ˆå¦‚VMï¼‰ï¼Œéœ€è¦å¯¹å‚å®¶çš„cpuæŒ‡ä»¤ä»¥åŠå„ç³»ç»Ÿçš„å¯åŠ¨æµç¨‹æœ‰ä¸€å®šçš„äº†è§£ã€‚å¦‚æ­¤æ‰å¥½â€œæ¬ºéª—â€ï¼Œè™šæ‹Ÿæœºå®‰è£…ç³»ç»Ÿå¤±è´¥çš„å¾ˆå¤§éƒ¨åˆ†åŸå› æ˜¯æ²¡æ‰¾å¯¹åŸç‰ˆç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹è¿‡çš„ç³»ç»Ÿå¯åŠ¨æµç¨‹å’Œè™šæ‹Ÿæœºè¡¨ä¸­çš„æµç¨‹ä¸å®Œå…¨ä¸€è‡´ï¼Œè¯†åˆ«ä¸äº†ã€‚
æ•…ï¼Œè®¤ä¸ºå¼€å‘è™šæ‹Ÿæœºå¯ä»¥å•ç‹¬åšä¸€ä¸ªå¯åŠ¨è¡¨ï¼ˆå…è®¸ä¿®æ”¹ï¼‰ï¼Œè¿˜æœ‰å°±æ˜¯æ‰«æè¡¨ï¼Œå°±æ˜¯åœ¨å®‰è£…ç³»ç»Ÿå‰å¯¹è¦è£…çš„ç³»ç»Ÿè¿›è¡Œæ‰«æï¼Œè¯†åˆ«ä¸äº†çš„ä¸œè¥¿ä¹Ÿæ˜¾ç¤ºå‡ºæ¥ï¼Œæ–¹ä¾¿ç”¨æˆ·ç½‘ä¸ŠæŸ¥è¯¢å’Œä¿®æ”¹å‚æ•°ï¼Œè€Œä¸æ˜¯çŒœã€‚è¿˜æœ‰å°±æ˜¯æ–‡ä»¶æ ¼å¼çš„è¯†åˆ«éœ€è¦æ”¹è¿›ï¼Œisoæˆ–è€…dmgéƒ½èƒ½è¯†åˆ«æœ€å¥½ï¼Œè¿™æ ·è¦†ç›–çš„å‚å®¶æ›´å¤šï¼
è¿˜å¯ä»¥è®¾è®¡ä¸€ç§ç½‘ç»œè™šæ‹Ÿæœºï¼Œå°±æ˜¯è™šæ‹Ÿæœºè£…åœ¨Aç”µè„‘ä¸Šï¼Œä½†æ˜¯ç”¨æˆ·åœ¨Bç”µè„‘ä¸Šï¼Œç”¨æˆ·çš„æ“ä½œé€šè¿‡å¹³å°ç¿»è¯‘æˆæ ‡å‡†ä¿¡æ¯è¾“å‡ºï¼Œç„¶åä¼ é€åˆ°Aç”µè„‘ä¸Šï¼Œè¿™æ ·å°±ä¸ç”¨è€ƒè™‘ç”¨æˆ·åœ¨Bç”µè„‘ï¼ˆæ‰‹æœºï¼‰ç”¨çš„æ˜¯ä»€ä¹ˆç³»ç»Ÿï¼Œç¡¬ä»¶æ€§èƒ½å¦‚ä½•ã€‚åªè¦ä»–èƒ½è”ç½‘å°±è¡Œï¼Œè¿™æ ·å¯ä»¥åœ¨Aç”µè„‘ä¸Šå…è®¸å¤šä¸ªç”¨æˆ·åˆ†æ—¶é—´æ“ä½œï¼Œæ›´èƒ½åˆ©ç”¨å¥½èµ„æºã€‚</p>2021-08-16</li><br/><li><span>neohope</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>äºŒã€ä¸‹åŠéƒ¨åˆ†
5ã€åœ¨è°ƒç”¨ioctlæ—¶
SYSCALL_DEFINE3(ioctl, unsigned int, fd, unsigned int, cmd, unsigned long, arg)
-&gt;vfs_ioctlï¼Œä¼šç”¨åˆ°vfs_ioctl.unlocked_ioctlä¹Ÿå°±æ˜¯kvm_vm_ioctl

kvm_vm_ioctl-&gt;kvm_vm_ioctl_create_vcpu
-&gt;kvm_arch_vcpu_precreate
-&gt;kvm_vcpu_init
-&gt;kvm_arch_vcpu_create
-&gt;kvm_get_kvm
-&gt;create_vcpu_fdï¼Œç”Ÿæˆè®¾å¤‡æ–‡ä»¶inode
-&gt;kvm_arch_vcpu_postcreate

å…¶ä¸­ï¼Œkvm_arch_vcpu_create
-&gt;kvm_mmu_create
-&gt;vcpu-&gt;arch.user_fpu = kmem_cache_zalloc(x86_fpu_cache, GFP_KERNEL_ACCOUNT);
-&gt;kvm_pmu_init(vcpu);
-&gt;kvm_hv_vcpu_init(vcpu);
-&gt;kvm_x86_ops.vcpu_create(vcpu);
-&gt;kvm_vcpu_mtrr_init(vcpu);
-&gt;vcpu_load(vcpu);
-&gt;kvm_vcpu_reset(vcpu, false);
-&gt;kvm_init_mmu(vcpu, false);  &#47;&#47;åŒ…æ‹¬init_kvm_tdp_mmuå’Œinit_kvm_softmmuä¸¤ç§è™šæ‹ŸåŒ–æ–¹å¼

6ã€å¯åŠ¨è™šæ‹Ÿæœºï¼Œè¿˜æ˜¯æ–‡ä»¶æ“ä½œ
static struct file_operations kvm_vcpu_fops = {
    .release        = kvm_vcpu_release,
    .unlocked_ioctl = kvm_vcpu_ioctl,
    .mmap           = kvm_vcpu_mmap,
    .llseek     = noop_llseek,
    KVM_COMPAT(kvm_vcpu_compat_ioctl),
};

7ã€åœ¨è°ƒç”¨ioctlæ—¶KVM_RUN
SYSCALL_DEFINE3(ioctl, unsigned int, fd, unsigned int, cmd, unsigned long, arg)
-&gt;vfs_ioctlï¼Œä¼šç”¨åˆ°vfs_ioctl.unlocked_ioctlä¹Ÿå°±æ˜¯kvm_vcpu_ioctl

kvm_vcpu_ioctl-&gt;
case KVM_RUN: 
  kvm_arch_vcpu_ioctl_run

å…¶ä¸­ï¼Œkvm_arch_vcpu_ioctl_run-&gt;vcpu_run-&gt;vcpu_enter_guest

8ã€IOåŒæ ·æœ‰è™šæ‹ŸåŒ–å’ŒåŠè™šæ‹ŸåŒ–ä¸¤ç§ï¼Œä¸€ä¸ªå¤„ç†å‡½æ•°ä¸ºkvm_fast_pioï¼Œå¦ä¸€ä¸ªä¸ºkvm_emulate_instruction</p>2021-08-24</li><br/><li><span>neohope</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä¸€ã€ä¸ŠåŠéƒ¨åˆ†
1ã€å†…æ ¸æ¨¡å—åˆå§‹åŒ–
module_init(vmx_init)-&gt;kvm_init
module_init(svm_init)-&gt;kvm_init

å…¶ä¸­ï¼Œkvm_init
-&gt;kvm_arch_init
-&gt;kvm_irqfd_init
-&gt;kvm_arch_hardware_setup
-&gt;misc_register(&amp;kvm_dev)

2ã€ä»æ•°æ®ç»“æ„è§’åº¦ï¼Œåˆå¯ä»¥çœ‹åˆ°äº†è®¾å¤‡çš†ä¸ºæ–‡ä»¶çš„æ€æƒ³
static struct miscdevice kvm_dev = {
    KVM_MINOR,
    &quot;kvm&quot;,
    &amp;kvm_chardev_ops,
};

static struct file_operations kvm_chardev_ops = {
    .unlocked_ioctl = kvm_dev_ioctl,
    .llseek     = noop_llseek,
    KVM_COMPAT(kvm_dev_ioctl),
};

é€šè¿‡misc_registerï¼Œå®ç°äº†æ“ä½œçš„ç»‘å®šã€‚

3ã€é€šè¿‡ä¸Šé¢çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰¾åˆ°åˆ›å»ºè™šæ‹Ÿæœºçš„æ–¹æ³•ï¼Œå¹¶ç”Ÿæˆæ§åˆ¶æ–‡ä»¶
kvm_dev.kvm_chardev_ops.kvm_dev_ioctl

ioctlç³»ç»Ÿè°ƒç”¨KVM_CREATE_VMï¼Œæ•ˆæœä¹Ÿæ˜¯ä¸€æ ·çš„ï¼š
SYSCALL_DEFINE3(ioctl, unsigned int, fd, unsigned int, cmd, unsigned long, arg)
-&gt;vfs_ioctlï¼Œä¼šç”¨åˆ°vfs_ioctl.unlocked_ioctlä¹Ÿå°±æ˜¯kvm_dev_ioctl

-&gt;case KVM_CREATE_VM:
-&gt;        r = kvm_dev_ioctl_create_vm(arg);
-&gt;file = anon_inode_getfile(&quot;kvm-vm&quot;, &amp;kvm_vm_fops, kvm, O_RDWR);

å…¶ä¸­ï¼Œkvm_dev_ioctl_create_vm
-&gt;kvm_create_vm
-&gt;-&gt;kvm_arch_init_vm
-&gt;-&gt;hardware_enable_all
-&gt;-&gt;kvm_arch_post_init_vm
-&gt;-&gt;list_add(&amp;kvm-&gt;vm_list, &amp;vm_list);

4ã€ç”Ÿæˆè™šæ‹ŸCPUå¥—è·¯å¾ˆç›¸ä¼¼ï¼Œä»æ˜¯æ–‡ä»¶æ“ä½œ
static struct file_operations kvm_vm_fops = {
    .release        = kvm_vm_release,
    .unlocked_ioctl = kvm_vm_ioctl,
    .llseek     = noop_llseek,
    KVM_COMPAT(kvm_vm_compat_ioctl),
};
åˆ›å»ºè™šæ‹Ÿæœºæ—¶ï¼Œanon_inode_getfile(&quot;kvm-vm&quot;, &amp;kvm_vm_fops, kvm, O_RDWR)ï¼Œå®é™…ä¸Šå°±æŠŠæ–‡ä»¶å’Œkvm_vm_fopsç»‘å®šäº†èµ·æ¥ã€‚</p>2021-08-24</li><br/><li><span>å´å»ºå¹³</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ–‡ä¸­ç”¨åˆ°çš„kvmçš„æºç ï¼Œæ˜¯linuxçš„ä¹ˆï¼Œå“ªä¸ªç‰ˆæœ¬çš„ï¼Œæˆ–è€…å»å“ªé‡Œå¯ä»¥ä¸‹è½½åˆ°å¯¹åº”æºç 
</p>2022-08-29</li><br/><li><span>è¥¿é—¨å¹ç‰›</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼ŒJVM å±äºè½¯è™šæ‹Ÿè¿˜æ˜¯ç¡¬è™šæ‹Ÿï¼Ÿ</p>2022-07-08</li><br/><li><span>ifelse</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç§€å•Š</p>2022-02-27</li><br/><li><span>äº‘å¸ˆå…„</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è½¯ç¡¬ç»“åˆæ‰æ˜¯è™šæ‹ŸåŒ–çš„å…³é”®å•Šï¼</p>2021-09-08</li><br/><li><span>springXu</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¿™è¯¾çš„ä¾‹å­å’Œå†…å®¹ç›¸å½“ç²¾å½©ï¼Œè¿˜æ˜¯æ„çŠ¹æœªå°½å‘€ã€‚ç”±äºè™šæ‹ŸåŒ–çŸ¥è¯†æ¬ ç¼ºäº†ï¼Œæƒ³é—®è¿˜æœ‰åç»­ä¸ï¼Ÿ</p>2021-08-16</li><br/><li><span>æäº®äº®</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å“¥ï¼Œä½ å¤ªå¼ºäº†ã€‚ä»€ä¹ˆéƒ½æ‡‚ã€‚</p>2024-08-29</li><br/>
</ul>