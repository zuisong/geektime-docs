å‰é¢è®²ç”¨æˆ·æ€å†…å­˜æ˜ å°„æœºåˆ¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬å·²ç»å¤šæ¬¡å¼•ç”³å‡ºäº†å†…æ ¸çš„æ˜ å°„æœºåˆ¶ï¼Œä½†æ˜¯å’±ä»¬éƒ½æš‚æ—¶æ”¾äº†æ”¾ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬å°±æ¥è¯¦ç»†è§£æä¸€ä¸‹ï¼Œè®©ä½ å½»åº•ææ‡‚å®ƒã€‚

é¦–å…ˆï¼Œä½ è¦çŸ¥é“ï¼Œå†…æ ¸æ€çš„å†…å­˜æ˜ å°„æœºåˆ¶ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

- å†…æ ¸æ€å†…å­˜æ˜ å°„å‡½æ•°vmallocã€kmap\_atomicæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼›
- å†…æ ¸æ€é¡µè¡¨æ˜¯æ”¾åœ¨å“ªé‡Œçš„ï¼Œå¦‚ä½•å·¥ä½œçš„ï¼Ÿswapper\_pg\_diræ˜¯æ€ä¹ˆå›äº‹ï¼›
- å‡ºç°äº†å†…æ ¸æ€ç¼ºé¡µå¼‚å¸¸åº”è¯¥æ€ä¹ˆåŠï¼Ÿ

## å†…æ ¸é¡µè¡¨

å’Œç”¨æˆ·æ€é¡µè¡¨ä¸åŒï¼Œåœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±è¦åˆ›å»ºå†…æ ¸é¡µè¡¨äº†ã€‚

æˆ‘ä»¬ä»å†…æ ¸é¡µè¡¨çš„æ ¹swapper\_pg\_dirå¼€å§‹æ‰¾çº¿ç´¢ï¼Œåœ¨arch/x86/include/asm/pgtable\_64.hä¸­å°±èƒ½æ‰¾åˆ°å®ƒçš„å®šä¹‰ã€‚

```
extern pud_t level3_kernel_pgt[512];
extern pud_t level3_ident_pgt[512];
extern pmd_t level2_kernel_pgt[512];
extern pmd_t level2_fixmap_pgt[512];
extern pmd_t level2_ident_pgt[512];
extern pte_t level1_fixmap_pgt[512];
extern pgd_t init_top_pgt[];


#define swapper_pg_dir init_top_pgt
```

swapper\_pg\_diræŒ‡å‘å†…æ ¸æœ€é¡¶çº§çš„ç›®å½•pgdï¼ŒåŒæ—¶å‡ºç°çš„è¿˜æœ‰å‡ ä¸ªé¡µè¡¨ç›®å½•ã€‚æˆ‘ä»¬å¯ä»¥å›å¿†ä¸€ä¸‹ï¼Œ64ä½ç³»ç»Ÿçš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„å¸ƒå±€ï¼Œå…¶ä¸­XXX\_ident\_pgtå¯¹åº”çš„æ˜¯ç›´æ¥æ˜ å°„åŒºï¼ŒXXX\_kernel\_pgtå¯¹åº”çš„æ˜¯å†…æ ¸ä»£ç åŒºï¼ŒXXX\_fixmap\_pgtå¯¹åº”çš„æ˜¯å›ºå®šæ˜ å°„åŒºã€‚

å®ƒä»¬æ˜¯åœ¨å“ªé‡Œåˆå§‹åŒ–çš„å‘¢ï¼Ÿåœ¨æ±‡ç¼–è¯­è¨€çš„æ–‡ä»¶é‡Œé¢çš„arch\\x86\\kernel\\head\_64.Sã€‚è¿™æ®µä»£ç æ¯”è¾ƒéš¾çœ‹æ‡‚ï¼Œä½ åªè¦æ˜ç™½å®ƒæ˜¯å¹²ä»€ä¹ˆçš„å°±è¡Œäº†ã€‚

```
__INITDATA


NEXT_PAGE(init_top_pgt)
	.quad   level3_ident_pgt - __START_KERNEL_map + _KERNPG_TABLE
	.org    init_top_pgt + PGD_PAGE_OFFSET*8, 0
	.quad   level3_ident_pgt - __START_KERNEL_map + _KERNPG_TABLE
	.org    init_top_pgt + PGD_START_KERNEL*8, 0
	/* (2^48-(2*1024*1024*1024))/(2^39) = 511 */
	.quad   level3_kernel_pgt - __START_KERNEL_map + _PAGE_TABLE


NEXT_PAGE(level3_ident_pgt)
	.quad	level2_ident_pgt - __START_KERNEL_map + _KERNPG_TABLE
	.fill	511, 8, 0
NEXT_PAGE(level2_ident_pgt)
	/* Since I easily can, map the first 1G.
	 * Don't set NX because code runs from these pages.
	 */
	PMDS(0, __PAGE_KERNEL_IDENT_LARGE_EXEC, PTRS_PER_PMD)


NEXT_PAGE(level3_kernel_pgt)
	.fill	L3_START_KERNEL,8,0
	/* (2^48-(2*1024*1024*1024)-((2^39)*511))/(2^30) = 510 */
	.quad	level2_kernel_pgt - __START_KERNEL_map + _KERNPG_TABLE
	.quad	level2_fixmap_pgt - __START_KERNEL_map + _PAGE_TABLE


NEXT_PAGE(level2_kernel_pgt)
	/*
	 * 512 MB kernel mapping. We spend a full page on this pagetable
	 * anyway.
	 *
	 * The kernel code+data+bss must not be bigger than that.
	 *
	 * (NOTE: at +512MB starts the module area, see MODULES_VADDR.
	 *  If you want to increase this then increase MODULES_VADDR
	 *  too.)
	 */
	PMDS(0, __PAGE_KERNEL_LARGE_EXEC,
		KERNEL_IMAGE_SIZE/PMD_SIZE)


NEXT_PAGE(level2_fixmap_pgt)
	.fill	506,8,0
	.quad	level1_fixmap_pgt - __START_KERNEL_map + _PAGE_TABLE
	/* 8MB reserved for vsyscalls + a 2MB hole = 4 + 1 entries */
	.fill	5,8,0


NEXT_PAGE(level1_fixmap_pgt)
	.fill	51
```

å†…æ ¸é¡µè¡¨çš„é¡¶çº§ç›®å½•init\_top\_pgtï¼Œå®šä¹‰åœ¨\_\_INITDATAé‡Œé¢ã€‚å’±ä»¬è®²è¿‡ELFçš„æ ¼å¼ï¼Œä¹Ÿè®²è¿‡è™šæ‹Ÿå†…å­˜ç©ºé—´çš„å¸ƒå±€ã€‚å®ƒä»¬éƒ½æœ‰ä»£ç æ®µï¼Œè¿˜æœ‰ä¸€äº›åˆå§‹åŒ–äº†çš„å…¨å±€å˜é‡ï¼Œæ”¾åœ¨.initåŒºåŸŸã€‚è¿™äº›è¯´çš„å°±æ˜¯è¿™ä¸ªåŒºåŸŸã€‚å¯ä»¥çœ‹åˆ°ï¼Œé¡µè¡¨çš„æ ¹å…¶å®æ˜¯å…¨å±€å˜é‡ï¼Œè¿™å°±ä½¿å¾—æˆ‘ä»¬åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç”šè‡³å†…å­˜ç®¡ç†è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå¾ˆå®¹æ˜“å°±å¯ä»¥å®šä½åˆ°ã€‚

æ¥ä¸‹æ¥ï¼Œå®šä¹‰init\_top\_pgtåŒ…å«å“ªäº›é¡¹ï¼Œè¿™ä¸ªæ±‡ç¼–ä»£ç æ¯”è¾ƒéš¾æ‡‚äº†ã€‚ä½ å¯ä»¥ç®€å•åœ°è®¤ä¸ºï¼Œquadæ˜¯å£°æ˜äº†ä¸€é¡¹çš„å†…å®¹ï¼Œorgæ˜¯è·³åˆ°äº†æŸä¸ªä½ç½®ã€‚

æ‰€ä»¥ï¼Œinit\_top\_pgtæœ‰ä¸‰é¡¹ï¼Œä¸Šæ¥å…ˆæœ‰ä¸€é¡¹ï¼ŒæŒ‡å‘çš„æ˜¯level3\_ident\_pgtï¼Œä¹Ÿå³ç›´æ¥æ˜ å°„åŒºé¡µè¡¨çš„ä¸‰çº§ç›®å½•ã€‚ä¸ºä»€ä¹ˆè¦å‡å»\_\_START\_KERNEL\_mapå‘¢ï¼Ÿå› ä¸ºlevel3\_ident\_pgtæ˜¯å®šä¹‰åœ¨å†…æ ¸ä»£ç é‡Œçš„ï¼Œå†™ä»£ç çš„æ—¶å€™ï¼Œå†™çš„éƒ½æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè°å†™ä»£ç çš„æ—¶å€™ä¹Ÿä¸çŸ¥é“å°†æ¥åŠ è½½çš„ç‰©ç†åœ°å€æ˜¯å¤šå°‘å‘€ï¼Œå¯¹ä¸å¯¹ï¼Ÿ

å› ä¸ºlevel3\_ident\_pgtæ˜¯åœ¨è™šæ‹Ÿåœ°å€çš„å†…æ ¸ä»£ç æ®µé‡Œçš„ï¼Œè€Œ\_\_START\_KERNEL\_mapæ­£æ˜¯è™šæ‹Ÿåœ°å€ç©ºé—´çš„å†…æ ¸ä»£ç æ®µçš„èµ·å§‹åœ°å€ï¼Œè¿™åœ¨è®²64ä½è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ—¶å€™éƒ½è®²è¿‡äº†ï¼Œè¦æ˜¯æƒ³ä¸èµ·æ¥å°±èµ¶ç´§å»å›é¡¾ä¸€ä¸‹ã€‚è¿™æ ·ï¼Œlevel3\_ident\_pgtå‡å»\_\_START\_KERNEL\_mapæ‰æ˜¯ç‰©ç†åœ°å€ã€‚

ç¬¬ä¸€é¡¹å®šä¹‰å®Œäº†ä»¥åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è·³åˆ°PGD\_PAGE\_OFFSETçš„ä½ç½®ï¼Œå†å®šä¹‰ä¸€é¡¹ã€‚ä»å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸€é¡¹å°±åº”è¯¥æ˜¯\_\_PAGE\_OFFSET\_BASEå¯¹åº”çš„ã€‚\_\_PAGE\_OFFSET\_BASEæ˜¯è™šæ‹Ÿåœ°å€ç©ºé—´é‡Œé¢å†…æ ¸çš„èµ·å§‹åœ°å€ã€‚ç¬¬äºŒé¡¹ä¹ŸæŒ‡å‘level3\_ident\_pgtï¼Œç›´æ¥æ˜ å°„åŒºã€‚

```
PGD_PAGE_OFFSET = pgd_index(__PAGE_OFFSET_BASE)
PGD_START_KERNEL = pgd_index(__START_KERNEL_map)
L3_START_KERNEL = pud_index(__START_KERNEL_map)
```

ç¬¬äºŒé¡¹å®šä¹‰å®Œäº†ä»¥åï¼Œæ¥ä¸‹æ¥è·³åˆ°PGD\_START\_KERNELçš„ä½ç½®ï¼Œå†å®šä¹‰ä¸€é¡¹ã€‚ä»å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸€é¡¹åº”è¯¥æ˜¯\_\_START\_KERNEL\_mapå¯¹åº”çš„é¡¹ï¼Œ\_\_START\_KERNEL\_mapæ˜¯è™šæ‹Ÿåœ°å€ç©ºé—´é‡Œé¢å†…æ ¸ä»£ç æ®µçš„èµ·å§‹åœ°å€ã€‚ç¬¬ä¸‰é¡¹æŒ‡å‘level3\_kernel\_pgtï¼Œå†…æ ¸ä»£ç åŒºã€‚

æ¥ä¸‹æ¥çš„ä»£ç å°±å¾ˆç±»ä¼¼äº†ï¼Œå°±æ˜¯åˆå§‹åŒ–ä¸ªè¡¨é¡¹ï¼Œç„¶åæŒ‡å‘ä¸‹ä¸€çº§ç›®å½•ï¼Œæœ€ç»ˆå½¢æˆä¸‹é¢è¿™å¼ å›¾ã€‚

![](https://static001.geekbang.org/resource/image/78/6d/78c8d44d7d8c08c03eee6f7a94652d6d.png?wh=2188%2A2623)

å†…æ ¸é¡µè¡¨å®šä¹‰å®Œäº†ï¼Œä¸€å¼€å§‹è¿™é‡Œé¢çš„é¡µè¡¨èƒ½å¤Ÿè¦†ç›–çš„å†…å­˜èŒƒå›´æ¯”è¾ƒå°ã€‚ä¾‹å¦‚ï¼Œå†…æ ¸ä»£ç åŒº512Mï¼Œç›´æ¥æ˜ å°„åŒº1Gã€‚è¿™ä¸ªæ—¶å€™ï¼Œå…¶å®åªè¦èƒ½å¤Ÿæ˜ å°„åŸºæœ¬çš„å†…æ ¸ä»£ç å’Œæ•°æ®ç»“æ„å°±å¯ä»¥äº†ã€‚å¯ä»¥çœ‹å‡ºï¼Œé‡Œé¢è¿˜ç©ºç€å¾ˆå¤šé¡¹ï¼Œå¯ä»¥ç”¨äºå°†æ¥æ˜ å°„å·¨å¤§çš„å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç­‰ç”¨åˆ°çš„æ—¶å€™å†è¿›è¡Œæ˜ å°„ã€‚

å¦‚æœæ˜¯ç”¨æˆ·æ€è¿›ç¨‹é¡µè¡¨ï¼Œä¼šæœ‰mm\_structæŒ‡å‘è¿›ç¨‹é¡¶çº§ç›®å½•pgdï¼Œå¯¹äºå†…æ ¸æ¥è®²ï¼Œä¹Ÿå®šä¹‰äº†ä¸€ä¸ªmm\_structï¼ŒæŒ‡å‘swapper\_pg\_dirã€‚

```
struct mm_struct init_mm = {
	.mm_rb		= RB_ROOT,
	.pgd		= swapper_pg_dir,
	.mm_users	= ATOMIC_INIT(2),
	.mm_count	= ATOMIC_INIT(1),
	.mmap_sem	= __RWSEM_INITIALIZER(init_mm.mmap_sem),
	.page_table_lock =  __SPIN_LOCK_UNLOCKED(init_mm.page_table_lock),
	.mmlist		= LIST_HEAD_INIT(init_mm.mmlist),
	.user_ns	= &init_user_ns,
	INIT_MM_CONTEXT(init_mm)
};
```

å®šä¹‰å®Œäº†å†…æ ¸é¡µè¡¨ï¼Œæ¥ä¸‹æ¥æ˜¯åˆå§‹åŒ–å†…æ ¸é¡µè¡¨ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™start\_kernelä¼šè°ƒç”¨setup\_archã€‚

```
void __init setup_arch(char **cmdline_p)
{
	/*
	 * copy kernel address range established so far and switch
	 * to the proper swapper page table
	 */
	clone_pgd_range(swapper_pg_dir     + KERNEL_PGD_BOUNDARY,
			initial_page_table + KERNEL_PGD_BOUNDARY,
			KERNEL_PGD_PTRS);


	load_cr3(swapper_pg_dir);
	__flush_tlb_all();
......
	init_mm.start_code = (unsigned long) _text;
	init_mm.end_code = (unsigned long) _etext;
	init_mm.end_data = (unsigned long) _edata;
	init_mm.brk = _brk_end;
......
	init_mem_mapping();
......
}
```

åœ¨setup\_archä¸­ï¼Œload\_cr3(swapper\_pg\_dir)è¯´æ˜å†…æ ¸é¡µè¡¨è¦å¼€å§‹èµ·ä½œç”¨äº†ï¼Œå¹¶ä¸”åˆ·æ–°äº†TLBï¼Œåˆå§‹åŒ–init\_mmçš„æˆå‘˜å˜é‡ï¼Œæœ€é‡è¦çš„å°±æ˜¯init\_mem\_mappingã€‚æœ€ç»ˆå®ƒä¼šè°ƒç”¨kernel\_physical\_mapping\_initã€‚

```
/*
 * Create page table mapping for the physical memory for specific physical
 * addresses. The virtual and physical addresses have to be aligned on PMD level
 * down. It returns the last physical address mapped.
 */
unsigned long __meminit
kernel_physical_mapping_init(unsigned long paddr_start,
			     unsigned long paddr_end,
			     unsigned long page_size_mask)
{
	unsigned long vaddr, vaddr_start, vaddr_end, vaddr_next, paddr_last;


	paddr_last = paddr_end;
	vaddr = (unsigned long)__va(paddr_start);
	vaddr_end = (unsigned long)__va(paddr_end);
	vaddr_start = vaddr;


	for (; vaddr < vaddr_end; vaddr = vaddr_next) {
		pgd_t *pgd = pgd_offset_k(vaddr);
		p4d_t *p4d;


		vaddr_next = (vaddr & PGDIR_MASK) + PGDIR_SIZE;


		if (pgd_val(*pgd)) {
			p4d = (p4d_t *)pgd_page_vaddr(*pgd);
			paddr_last = phys_p4d_init(p4d, __pa(vaddr),
						   __pa(vaddr_end),
						   page_size_mask);
			continue;
		}


		p4d = alloc_low_page();
		paddr_last = phys_p4d_init(p4d, __pa(vaddr), __pa(vaddr_end),
					   page_size_mask);


		p4d_populate(&init_mm, p4d_offset(pgd, vaddr), (pud_t *) p4d);
	}
	__flush_tlb_all();


	return paddr_l
```

åœ¨kernel\_physical\_mapping\_inité‡Œï¼Œæˆ‘ä»¬å…ˆé€šè¿‡\_\_vaå°†ç‰©ç†åœ°å€è½¬æ¢ä¸ºè™šæ‹Ÿåœ°å€ï¼Œç„¶åå†åˆ›å»ºè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€çš„æ˜ å°„é¡µè¡¨ã€‚

ä½ å¯èƒ½ä¼šé—®ï¼Œæ€ä¹ˆè¿™ä¹ˆéº»çƒ¦å•Šï¼Ÿæ—¢ç„¶å¯¹äºå†…æ ¸æ¥è®²ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨\_\_vaå’Œ\_\_paç›´æ¥åœ¨è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€ä¹‹é—´ç›´æ¥è½¬æ¥è½¬å»ï¼Œä¸ºå•¥è¿˜è¦è¾›è¾›è‹¦è‹¦å»ºç«‹é¡µè¡¨å‘¢ï¼Ÿå› ä¸ºè¿™æ˜¯CPUå’Œå†…å­˜çš„ç¡¬ä»¶çš„éœ€æ±‚ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒCPUåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹è®¿é—®è™šæ‹Ÿåœ°å€çš„æ—¶å€™ï¼Œå°±ä¼šç”¨CR3è¿™ä¸ªå¯„å­˜å™¨ï¼Œè¿™ä¸ªå¯„å­˜å™¨æ˜¯CPUå®šä¹‰çš„ï¼Œä½œä¸ºæ“ä½œç³»ç»Ÿï¼Œæˆ‘ä»¬æ˜¯è½¯ä»¶ï¼Œåªèƒ½æŒ‰ç…§ç¡¬ä»¶çš„è¦æ±‚æ¥ã€‚

ä½ å¯èƒ½åˆä¼šé—®äº†ï¼ŒæŒ‰ç…§å’±ä»¬è®²åˆå§‹åŒ–çš„æ—¶å€™çš„è¿‡ç¨‹ï¼Œç³»ç»Ÿæ—©æ—©å°±è¿›å…¥äº†ä¿æŠ¤æ¨¡å¼ï¼Œåˆ°äº†setup\_arché‡Œé¢æ‰load\_cr3ï¼Œå¦‚æœä½¿ç”¨cr3æ˜¯ç¡¬ä»¶çš„è¦æ±‚ï¼Œé‚£ä¹‹å‰æ˜¯æ€ä¹ˆåŠçš„å‘¢ï¼Ÿå¦‚æœä½ ä»”ç»†å»çœ‹arch\\x86\\kernel\\head\_64.Sï¼Œè¿™é‡Œé¢é™¤äº†åˆå§‹åŒ–å†…æ ¸é¡µè¡¨ä¹‹å¤–ï¼Œåœ¨è¿™ä¹‹å‰ï¼Œè¿˜æœ‰å¦ä¸€ä¸ªé¡µè¡¨early\_top\_pgtã€‚çœ‹åˆ°å…³é”®å­—earlyäº†å˜›ï¼Ÿè¿™ä¸ªé¡µè¡¨å°±æ˜¯ä¸“é—¨ç”¨åœ¨çœŸæ­£çš„å†…æ ¸é¡µè¡¨åˆå§‹åŒ–ä¹‹å‰ï¼Œä¸ºäº†éµå¾ªç¡¬ä»¶çš„è¦æ±‚è€Œè®¾ç½®çš„ã€‚æ—©æœŸé¡µè¡¨ä¸æ˜¯æˆ‘ä»¬è¿™èŠ‚çš„é‡ç‚¹ï¼Œè¿™é‡Œæˆ‘å°±ä¸å±•å¼€å¤šè¯´äº†ã€‚

## vmallocå’Œkmap\_atomicåŸç†

åœ¨ç”¨æˆ·æ€å¯ä»¥é€šè¿‡mallocå‡½æ•°åˆ†é…å†…å­˜ï¼Œå½“ç„¶mallocåœ¨åˆ†é…æ¯”è¾ƒå¤§çš„å†…å­˜çš„æ—¶å€™ï¼Œåº•å±‚è°ƒç”¨çš„æ˜¯mmapï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡mmapåšå†…å­˜æ˜ å°„ï¼Œåœ¨å†…æ ¸é‡Œé¢ä¹Ÿæœ‰ç›¸åº”çš„å‡½æ•°ã€‚

åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´é‡Œé¢ï¼Œæœ‰ä¸ªvmallocåŒºåŸŸï¼Œä»VMALLOC\_STARTå¼€å§‹åˆ°VMALLOC\_ENDï¼Œå¯ä»¥ç”¨äºæ˜ å°„ä¸€æ®µç‰©ç†å†…å­˜ã€‚

```
/**
 *	vmalloc  -  allocate virtually contiguous memory
 *	@size:		allocation size
 *	Allocate enough pages to cover @size from the page level
 *	allocator and map them into contiguous kernel virtual space.
 *
 *	For tight control over page level allocator and protection flags
 *	use __vmalloc() instead.
 */
void *vmalloc(unsigned long size)
{
	return __vmalloc_node_flags(size, NUMA_NO_NODE,
				    GFP_KERNEL);
}


static void *__vmalloc_node(unsigned long size, unsigned long align,
			    gfp_t gfp_mask, pgprot_t prot,
			    int node, const void *caller)
{
	return __vmalloc_node_range(size, align, VMALLOC_START, VMALLOC_END,
				gfp_mask, prot, 0, node, caller);
}
```

æˆ‘ä»¬å†æ¥çœ‹å†…æ ¸çš„ä¸´æ—¶æ˜ å°„å‡½æ•°kmap\_atomicçš„å®ç°ã€‚ä»ä¸‹é¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæ˜¯32ä½æœ‰é«˜ç«¯åœ°å€çš„ï¼Œå°±éœ€è¦è°ƒç”¨set\_pteé€šè¿‡å†…æ ¸é¡µè¡¨è¿›è¡Œä¸´æ—¶æ˜ å°„ï¼›å¦‚æœæ˜¯64ä½æ²¡æœ‰é«˜ç«¯åœ°å€çš„ï¼Œå°±è°ƒç”¨page\_addressï¼Œé‡Œé¢ä¼šè°ƒç”¨lowmem\_page\_addressã€‚å…¶å®ä½ç«¯å†…å­˜çš„æ˜ å°„ï¼Œä¼šç›´æ¥ä½¿ç”¨\_\_vaè¿›è¡Œä¸´æ—¶æ˜ å°„ã€‚

```
void *kmap_atomic_prot(struct page *page, pgprot_t prot)
{
......
	if (!PageHighMem(page))
		return page_address(page);
......
	vaddr = __fix_to_virt(FIX_KMAP_BEGIN + idx);
	set_pte(kmap_pte-idx, mk_pte(page, prot));
......
	return (void *)vaddr;
}


void *kmap_atomic(struct page *page)
{
	return kmap_atomic_prot(page, kmap_prot);
}


static __always_inline void *lowmem_page_address(const struct page *page)
{
	return page_to_virt(page);
}


#define page_to_virt(x)	__va(PFN_PHYS(page_to_pfn(x)
```

## å†…æ ¸æ€ç¼ºé¡µå¼‚å¸¸

å¯ä»¥çœ‹å‡ºï¼Œkmap\_atomicå’Œvmallocä¸åŒã€‚kmap\_atomicå‘ç°ï¼Œæ²¡æœ‰é¡µè¡¨çš„æ—¶å€™ï¼Œå°±ç›´æ¥åˆ›å»ºé¡µè¡¨è¿›è¡Œæ˜ å°„äº†ã€‚è€Œvmallocæ²¡æœ‰ï¼Œå®ƒåªåˆ†é…äº†å†…æ ¸çš„è™šæ‹Ÿåœ°å€ã€‚æ‰€ä»¥ï¼Œè®¿é—®å®ƒçš„æ—¶å€™ï¼Œä¼šäº§ç”Ÿç¼ºé¡µå¼‚å¸¸ã€‚

å†…æ ¸æ€çš„ç¼ºé¡µå¼‚å¸¸è¿˜æ˜¯ä¼šè°ƒç”¨do\_page\_faultï¼Œä½†æ˜¯ä¼šèµ°åˆ°å’±ä»¬ä¸Šé¢ç”¨æˆ·æ€ç¼ºé¡µå¼‚å¸¸ä¸­æ²¡æœ‰è§£æçš„é‚£éƒ¨åˆ†vmalloc\_faultã€‚è¿™ä¸ªå‡½æ•°å¹¶ä¸å¤æ‚ï¼Œä¸»è¦ç”¨äºå…³è”å†…æ ¸é¡µè¡¨é¡¹ã€‚

```
/*
 * 32-bit:
 *
 *   Handle a fault on the vmalloc or module mapping area
 */
static noinline int vmalloc_fault(unsigned long address)
{
	unsigned long pgd_paddr;
	pmd_t *pmd_k;
	pte_t *pte_k;


	/* Make sure we are in vmalloc area: */
	if (!(address >= VMALLOC_START && address < VMALLOC_END))
		return -1;


	/*
	 * Synchronize this task's top level page-table
	 * with the 'reference' page table.
	 *
	 * Do _not_ use "current" here. We might be inside
	 * an interrupt in the middle of a task switch..
	 */
	pgd_paddr = read_cr3_pa();
	pmd_k = vmalloc_sync_one(__va(pgd_paddr), address);
	if (!pmd_k)
		return -1;


	pte_k = pte_offset_kernel(pmd_k, address);
	if (!pte_present(*pte_k))
		return -1;


	return 0
```

## æ€»ç»“æ—¶åˆ»

è‡³æ­¤ï¼Œå†…æ ¸æ€çš„å†…å­˜æ˜ å°„ä¹Ÿè®²å®Œäº†ã€‚è¿™ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•´ä¸ªå†…å­˜ç®¡ç†çš„ä½“ç³»ä¸²èµ·æ¥äº†ã€‚

ç‰©ç†å†…å­˜æ ¹æ®NUMAæ¶æ„åˆ†èŠ‚ç‚¹ã€‚æ¯ä¸ªèŠ‚ç‚¹é‡Œé¢å†åˆ†åŒºåŸŸã€‚æ¯ä¸ªåŒºåŸŸé‡Œé¢å†åˆ†é¡µã€‚

ç‰©ç†é¡µé¢é€šè¿‡ä¼™ä¼´ç³»ç»Ÿè¿›è¡Œåˆ†é…ã€‚åˆ†é…çš„ç‰©ç†é¡µé¢è¦å˜æˆè™šæ‹Ÿåœ°å€è®©ä¸Šå±‚å¯ä»¥è®¿é—®ï¼Œkswapdå¯ä»¥æ ¹æ®ç‰©ç†é¡µé¢çš„ä½¿ç”¨æƒ…å†µå¯¹é¡µé¢è¿›è¡Œæ¢å…¥æ¢å‡ºã€‚

å¯¹äºå†…å­˜çš„åˆ†é…éœ€æ±‚ï¼Œå¯èƒ½æ¥è‡ªå†…æ ¸æ€ï¼Œä¹Ÿå¯èƒ½æ¥è‡ªç”¨æˆ·æ€ã€‚

å¯¹äºå†…æ ¸æ€ï¼Œkmallocåœ¨åˆ†é…å¤§å†…å­˜çš„æ—¶å€™ï¼Œä»¥åŠvmallocåˆ†é…ä¸è¿ç»­ç‰©ç†é¡µçš„æ—¶å€™ï¼Œç›´æ¥ä½¿ç”¨ä¼™ä¼´ç³»ç»Ÿï¼Œåˆ†é…åè½¬æ¢ä¸ºè™šæ‹Ÿåœ°å€ï¼Œè®¿é—®çš„æ—¶å€™éœ€è¦é€šè¿‡å†…æ ¸é¡µè¡¨è¿›è¡Œæ˜ å°„ã€‚

å¯¹äºkmem\_cacheä»¥åŠkmallocåˆ†é…å°å†…å­˜ï¼Œåˆ™ä½¿ç”¨slubåˆ†é…å™¨ï¼Œå°†ä¼™ä¼´ç³»ç»Ÿåˆ†é…å‡ºæ¥çš„å¤§å—å†…å­˜åˆ‡æˆä¸€å°å—ä¸€å°å—è¿›è¡Œåˆ†é…ã€‚

kmem\_cacheå’Œkmallocçš„éƒ¨åˆ†ä¸ä¼šè¢«æ¢å‡ºï¼Œå› ä¸ºç”¨è¿™ä¸¤ä¸ªå‡½æ•°åˆ†é…çš„å†…å­˜å¤šç”¨äºä¿æŒå†…æ ¸å…³é”®çš„æ•°æ®ç»“æ„ã€‚å†…æ ¸æ€ä¸­vmallocåˆ†é…çš„éƒ¨åˆ†ä¼šè¢«æ¢å‡ºï¼Œå› è€Œå½“è®¿é—®çš„æ—¶å€™ï¼Œå‘ç°ä¸åœ¨ï¼Œå°±ä¼šè°ƒç”¨do\_page\_faultã€‚

å¯¹äºç”¨æˆ·æ€çš„å†…å­˜åˆ†é…ï¼Œæˆ–è€…ç›´æ¥è°ƒç”¨mmapç³»ç»Ÿè°ƒç”¨åˆ†é…ï¼Œæˆ–è€…è°ƒç”¨mallocã€‚è°ƒç”¨mallocçš„æ—¶å€™ï¼Œå¦‚æœåˆ†é…å°çš„å†…å­˜ï¼Œå°±ç”¨sys\_brkç³»ç»Ÿè°ƒç”¨ï¼›å¦‚æœåˆ†é…å¤§çš„å†…å­˜ï¼Œè¿˜æ˜¯ç”¨sys\_mmapç³»ç»Ÿè°ƒç”¨ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·æ€çš„å†…å­˜éƒ½æ˜¯å¯ä»¥æ¢å‡ºçš„ï¼Œå› è€Œä¸€æ—¦å‘ç°å†…å­˜ä¸­ä¸å­˜åœ¨ï¼Œå°±ä¼šè°ƒç”¨do\_page\_faultã€‚

![](https://static001.geekbang.org/resource/image/27/9a/274e22b3f5196a4c68bb6813fb643f9a.png?wh=2368%2A2248)

## è¯¾å ‚ç»ƒä¹ 

ä¼™ä¼´ç³»ç»Ÿåˆ†é…å¥½äº†ç‰©ç†é¡µé¢ä¹‹åï¼Œå¦‚ä½•è½¬æ¢æˆä¸ºè™šæ‹Ÿåœ°å€å‘¢ï¼Ÿè¯·ç ”ç©¶ä¸€ä¸‹page\_addresså‡½æ•°çš„å®ç°ã€‚

æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ï¼Œä¹Ÿæ¬¢è¿ä½ æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ ã€è¿›æ­¥ã€‚

![](https://static001.geekbang.org/resource/image/8c/37/8c0a95fa07a8b9a1abfd394479bdd637.jpg?wh=1110%2A659)
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>æ²¡å¿ƒæ²¡è‚º</span> ğŸ‘ï¼ˆ18ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>å¥½ææ€–ï¼Œçœ‹åˆ°è¿™é‡Œï¼Œæ˜¯ç¡¬çœ‹äº†</p>2019-07-05</li><br/><li><span>ezra.xu</span> ğŸ‘ï¼ˆ16ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>å†…æ ¸èƒ½ç”¨cè¯­è¨€ç¼–å†™ï¼Œæ˜¯ä¸æ˜¯æ„å‘³ç€ç”¨cå¯ä»¥ç›´æ¥æ“ä½œç‰©ç†å†…å­˜ï¼Œå¦å¤–linuxä¸Šçš„cè¯­è¨€ç¼–è¯‘å™¨æ˜¯ç”¨ä»€ä¹ˆè¯­è¨€å¼€å‘çš„ï¼Œcè¯­è¨€å®ç°äº†è‡ªä¸¾å—ï¼Œcè¯­è¨€è·¨å¹³å°åº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Œè¯·è€å¸ˆç­”ç–‘è§£æƒ‘ã€‚</p>2019-05-27</li><br/><li><span>è«å</span> ğŸ‘ï¼ˆ7ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ğŸ‘çœ‹èµ·æ¥å¾ˆæœ‰æ„Ÿè§‰ï¼Œå…ˆè®²ç”¨æˆ·æ€ã€å†…æ ¸æ€è™šæ‹Ÿå†…å­˜çš„ç®¡ç†ï¼Œç„¶åè®²ç‰©ç†å†…å­˜çš„ç®¡ç†ï¼Œæœ€åè®²ç”¨æˆ·æ€ã€å†…æ ¸æ€è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜å¦‚ä½•å»ºç«‹å…³è”ã€‚</p>2019-07-18</li><br/><li><span>LDxy</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ“ä½œç³»ç»Ÿæ˜¯å¦‚ä½•çŸ¥é“è®¡ç®—æœºä¸Šæœ‰å¤šå°‘ç‰©ç†å†…å­˜çš„å‘¢ï¼Ÿ</p>2019-06-02</li><br/><li><span>æ´»çš„æ½‡æ´’</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>åšæŒå®Œæ•´çš„å­¦åˆ°åº•ï¼ŒåšæŒå®Œæ•´çš„ç¬”è®°åˆ°åº•
day26 å­¦ä¹ ç¬”è®°ï¼šhttps:&#47;&#47;www.cnblogs.com&#47;luoahong&#47;p&#47;10931320.html</p>2019-05-27</li><br/><li><span>Mhy</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œçœ‹åˆ°è¿™é‡Œæˆ‘æ˜¯ä¸æ˜¯å¯ä»¥è®¤ä¸ºåœ¨ç”¨æˆ·æ€ä½¿ç”¨mmapå’Œå†…æ ¸æ€ä½¿ç”¨mmapæ˜¯ä¸¤ç äº‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬åº”ç”¨åœºæ™¯æ¯”å¦‚å°†å›¾ç‰‡å†…å­˜ç›´æ¥æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ä¸Šè®¿é—®é¿å…å¤šæ¬¡æ‹·è´ä»è€Œæé«˜å›¾ç‰‡åŠ è½½é€Ÿåº¦ï¼Œé‚£ä¹ˆè¿™ä¸ªåœºæ™¯æ˜¯å‘ç”Ÿåœ¨ç”¨æˆ·æ€ä¸Šé¢ï¼ŒæœŸé—´ä¸éœ€è¦é€šè¿‡å†…æ ¸æ€å—ï¼Ÿè°ƒç”¨ç³»ç»Ÿå‡½æ•°è§¦å‘çš„mmapæ˜¯å‘ç”Ÿåœ¨å†…æ ¸æ€å—ï¼Œæ¯”å¦‚strace ls -l</p>2020-05-08</li><br/><li><span>Bing</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç”¨mallocç”³è¯·çš„å†…å­˜ï¼Œè¿›ç¨‹é€€å‡ºæ—¶ï¼Œæ“ä½œç³»ç»Ÿæ˜¯å¦ä¼šé‡Šæ”¾</p>2019-08-15</li><br/><li><span>æ ‹èƒ½</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ²¡å¤ªçœ‹æ‡‚kmallocåˆæ˜¯ä»å“ªé‡Œæ¥çš„ï¼Œæ˜¯å†™é”™äº†ä¹ˆï¼Ÿï¼ˆè¿™ä¸ªæˆ‘è¿˜ç‰¹æ„å¾€å‰æ‰¾äº†ä¸‹ï¼Œä»¥ä¸ºæ˜¯kmmapï¼Œç”¨äºå†…å­˜æ˜ å°„åŒºçš„å‘¢ï¼‰</p>2019-07-25</li><br/><li><span>why</span> ğŸ‘ï¼ˆ23ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>- æ¶‰åŠä¸‰å—å†…å®¹:
    - å†…å­˜æ˜ å°„å‡½æ•° vmalloc, kmap_atomic
    - å†…æ ¸æ€é¡µè¡¨å­˜æ”¾ä½ç½®å’Œå·¥ä½œæµç¨‹
    - å†…æ ¸æ€ç¼ºé¡µå¼‚å¸¸å¤„ç†
- å†…æ ¸æ€é¡µè¡¨, ç³»ç»Ÿåˆå§‹åŒ–æ—¶å°±åˆ›å»º
    - swapper_pg_dir æŒ‡å‘å†…æ ¸é¡¶çº§é¡µç›®å½• pgd
        - xxx_ident&#47;kernel&#47;fixmap_pgt åˆ†åˆ«æ˜¯ç›´æ¥æ˜ å°„&#47;å†…æ ¸ä»£ç &#47;å›ºå®šæ˜ å°„çš„ xxx çº§é¡µè¡¨ç›®å½•
    - åˆ›å»ºå†…æ ¸æ€é¡µè¡¨
        - swapper_pg_dir æŒ‡å‘ init_top_pgt, æ˜¯ ELF æ–‡ä»¶çš„å…¨å±€å˜é‡, å› æ­¤å†å†…å­˜ç®¡ç†åˆå§‹åŒ–ä¹‹é—´å°±å­˜åœ¨
        - init_top_pgt å…ˆåˆå§‹åŒ–äº†ä¸‰é¡¹
            - ç¬¬ä¸€é¡¹æŒ‡å‘ level3_ident_pgt (å†…æ ¸ä»£ç æ®µçš„æŸä¸ªè™šæ‹Ÿåœ°å€) å‡å» __START_KERNEL_MAP (å†…æ ¸ä»£ç èµ·å§‹è™šæ‹Ÿåœ°å€) å¾—åˆ°å®é™…ç‰©ç†åœ°å€
            - ç¬¬äºŒé¡¹ä¹Ÿæ˜¯æŒ‡å‘ level3_ident_pgt
            - ç¬¬ä¸‰é¡¹æŒ‡å‘ level3_kernel_pgt å†…æ ¸ä»£ç åŒº
    - åˆå§‹åŒ–å„é¡µè¡¨é¡¹, æŒ‡å‘ä¸‹ä¸€é›†ç›®å½•
        - é¡µè¡¨è¦†ç›–èŒƒå›´è¾ƒå°, å†…æ ¸ä»£ç  512MB, ç›´æ¥æ˜ å°„åŒº 1GB
        - å†…æ ¸æ€ä¹Ÿå®šä¹‰ mm_struct æŒ‡å‘ swapper_pg_dir
        - åˆå§‹åŒ–å†…æ ¸æ€é¡µè¡¨,  start_kernelâ†’ setup_arch
            - load_cr3(swapper_pg_dir) å¹¶åˆ·æ–° TLB
            - è°ƒç”¨ init_mem_mappingâ†’kernel_physical_mapping_init, ç”¨ __va å°†ç‰©ç†åœ°å€æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€, å†åˆ›å»ºæ˜ å°„é¡µè¡¨é¡¹
            - CPU åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹è®¿é—®è™šæ‹Ÿåœ°å€éƒ½å¿…é¡»é€šè¿‡ cr3, ç³»ç»Ÿåªèƒ½ç…§åš
            - åœ¨ load_cr3 ä¹‹å‰, é€šè¿‡ early_top_pgt å®Œæˆæ˜ å°„
- vmalloc å’Œ kmap_atomic
    - å†…æ ¸çš„è™šæ‹Ÿåœ°å€ç©ºé—´ vmalloc åŒºåŸŸç”¨äºæ˜ å°„
    - kmap_atomic ä¸´æ—¶æ˜ å°„
        - 32 ä½, è°ƒç”¨ set_pte é€šè¿‡å†…æ ¸é¡µè¡¨ä¸´æ—¶æ˜ å°„
        - 64 ä½, è°ƒç”¨ page_addressâ†’lowmem_page_address è¿›è¡Œæ˜ å°„
- å†…æ ¸æ€ç¼ºé¡µå¼‚å¸¸
    - kmap_atomic ç›´æ¥åˆ›å»ºé¡µè¡¨è¿›è¡Œæ˜ å°„
    - vmalloc åªåˆ†é…å†…æ ¸è™šæ‹Ÿåœ°å€, è®¿é—®æ—¶è§¦å‘ç¼ºé¡µä¸­æ–­, è°ƒç”¨ do_page_faultâ†’vmalloc_fault ç”¨äºå…³è”å†…æ ¸é¡µè¡¨é¡¹
- kmem_cache å’Œ kmalloc ç”¨äºä¿å­˜å†…æ ¸æ•°æ®ç»“æ„, ä¸ä¼šè¢«æ¢å‡º; è€Œå†…æ ¸ vmalloc ä¼šè¢«æ¢å‡º</p>2019-05-27</li><br/><li><span>æ´»çš„æ½‡æ´’</span> ğŸ‘ï¼ˆ20ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>å†³å¿ƒä»å¤´æŠŠè®¡ç®—æœºæ‰€æœ‰çš„åŸºç¡€è¯¾ç¨‹å…¨éƒ¨è¡¥ä¸Šï¼Œå¤¯å®åŸºç¡€ï¼Œä¸€å®šè¦åšæŒåˆ°æœ€å
day26ç¬”è®°ï¼šhttps:&#47;&#47;www.cnblogs.com&#47;luoahong&#47;p&#47;10931320.html</p>2019-05-29</li><br/><li><span>czh</span> ğŸ‘ï¼ˆ10ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ•´ä¸ªå†…å­˜çš„è®²è§£ï¼ˆè¿™ä¸ªä¸“æ å†…å®¹å¦‚æœä¸€ä¸‹çœ‹ä¸æ‡‚ç›´æ¥è·³æ€»ç»“éƒ¨åˆ†ï¼Œç”šè‡³æ¯ç« çš„æœ€åï¼Œç°æœ‰ä¸ªæ•´ä½“è®¤è¯†ï¼Œå†è¿”å›å»çœ‹ç»†èŠ‚ï¼Œä¼šå®¹æ˜“å¾ˆå¤šï¼‰</p>2019-11-25</li><br/><li><span>garlic</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ä¼™ä¼´ç³»ç»Ÿåˆ†é…å¥½äº†ç‰©ç†é¡µé¢åˆ°è™šæ‹Ÿåœ°å€:æœ‰ä¸¤ç§æƒ…å†µ
1. ç”³è¯·æ—¶è½¬æ¢ï¼Œ 
ç›´æ¥ä½¿ç”¨ä¼™ä¼´ç³»ç»Ÿç”³è¯·é¡µ,é€šè¿‡page_addressè¿›è¡Œåœ°å€è½¬æ¢ï¼Œå¦‚kmallocç”³è¯·å¤§äº2ä¸ªé¡µé¢æ—¶
é€šè¿‡SLABä»ä¼™ä¼´ç³»ç»Ÿç”³è¯·é¡µ,åˆ›å»ºnew slabæ—¶é€šè¿‡page_addressè¿›è¡Œåœ°å€è½¬æ¢, å¦‚vmalloc, VMAç»“æ„ä½“ç”³è¯·æ—¶
2. æœ‰è™šæ‹Ÿåœ°å€æŒ‚è½½é¡µé¢
æœ‰æŒ‡å®šè™šæ‹Ÿåœ°å€èŒƒå›´ï¼Œå†é€šè¿‡ä¼™ä¼´ç³»ç»Ÿç”³è¯·ç©ºé—´ï¼Œç”³è¯·é‡Šæ”¾æ—¶ç»Ÿä¸€è¿›è¡Œæ›´æ–°é¡µè¡¨é¡¹, å¦‚vmalloc
è¯¾å ‚å­¦ä¹ ç¬”è®°ï¼š https:&#47;&#47;garlicspace.com&#47;2020&#47;08&#47;12&#47;%e4%bc%99%e4%bc%b4%e7%b3%bb%e7%bb%9f%e5%88%86%e9%85%8d%e7%89%a9%e7%90%86%e9%a1%b5%e5%90%8e%e5%a6%82%e4%bd%95%e8%bd%ac%e6%8d%a2%e6%88%90%e4%b8%ba%e8%99%9a%e6%8b%9f%e5%9c%b0%e5%9d%80&#47;</p>2020-08-12</li><br/><li><span>dll</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>çœŸçš„åå¤çœ‹äº†å‡ éï¼Œæ²¡ç†è§£init_top_pgté‡Œçš„ä¸‰é¡¹æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Œæˆ‘è§‰å¾—æœ‰æ—¶å€™æ–‡ç« è¿˜æ˜¯æœ‰ç‚¹å†™çš„è¯ä¸è¾¾æ„ï¼Œä»£ç æœ‰ç‚¹ç¼ºå¤±ï¼ŒçœŸçš„çœ‹èµ·æ¥å¥½å¹¸è‹¦</p>2022-03-25</li><br/><li><span>å¥”è·‘çš„ç ä»”</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>page_addressçš„å®ç°å¦‚ä¸‹ï¼š

```
&#47;**
 * page_address - get the mapped virtual address of a page
 * @page: &amp;struct page to get the virtual address of
 *
 * Returns the page&#39;s virtual address.
 *&#47;
void *page_address(const struct page *page)
{
	unsigned long flags;
	void *ret;
	struct page_address_slot *pas;

	if (!PageHighMem(page))
		return lowmem_page_address(page);

	pas = page_slot(page);
	ret = NULL;
	spin_lock_irqsave(&amp;pas-&gt;lock, flags);
	if (!list_empty(&amp;pas-&gt;lh)) {
		struct page_address_map *pam;

		list_for_each_entry(pam, &amp;pas-&gt;lh, list) {
			if (pam-&gt;page == page) {
				ret = pam-&gt;virtual;
				goto done;
			}
		}
	}
done:
	spin_unlock_irqrestore(&amp;pas-&gt;lock, flags);
	return ret;
}
```

- å¦‚æœä¸æ˜¯é«˜ç«¯å†…å­˜ï¼Œç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€ä¹‹é—´çš„è½¬æ¢ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œç›´æ¥ä½¿ç”¨lowmme_page_addressè¿›è¡Œè½¬æ¢ï¼Œå‰é¢æåˆ°è¿‡è¿™ä¸ªå‡½æ•°ï¼›
- å¯¹äºéé«˜ç«¯å†…å­˜é¡µï¼Œé€šè¿‡page_slotè®¡ç®—å‡ºpasï¼Œpasä¿å­˜åœ¨ç”±pagezä½œä¸ºkeyçš„hashè¡¨page_address_htableä¸­ï¼›
- éå†pas-&gt;lhåŒå‘é“¾è¡¨ï¼Œé“¾è¡¨çš„èŠ‚ç‚¹ä¿å­˜æœ‰pageçš„åœ°å€å’Œpageæ‰€å¯¹åº”çš„è™šæ‹Ÿåœ°å€ï¼Œé€šè¿‡pageï¼Œå¯ä»¥ç¡®å®špageå¯¹åº”çš„è™šæ‹Ÿåœ°å€ã€‚</p>2019-09-03</li><br/><li><span>geek</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>page_address_mapç»“æ„ä½“ä¸­ä¿å­˜äº†pageå’Œå¯¹åº”è™šæ‹Ÿåœ°å€çš„æ˜ å°„å…³ç³»ã€‚
æ¯ä¸ªpageå¯¹è±¡ä¿å­˜åœ¨page_address_htableä¸­ï¼Œæ˜ å°„åˆ°ç›¸åŒslotçš„pagesä¼šå½¢æˆä¸€ä¸ªé“¾è¡¨ã€‚page_addressæ–¹æ³•å°±æ˜¯æ ¹æ®pageæ‰¾åˆ°slotï¼Œéå†å¯¹åº”slotçš„é“¾è¡¨ï¼Œæ‰¾åˆ°pageç›¸åŒçš„é‚£é¡¹ï¼Œè¿”å›å…¶å¯¹åº”çš„è™šæ‹Ÿåœ°å€ã€‚</p>2021-04-04</li><br/>
</ul>