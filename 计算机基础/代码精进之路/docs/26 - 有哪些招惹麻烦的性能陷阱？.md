å‰é¢ï¼Œæˆ‘ä»¬è®¨è®ºäº†æ”¹å–„ä»£ç æ€§èƒ½çš„æœ€åŸºæœ¬çš„åŠæ³•ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è®¨è®ºä¸€äº›æœ€ä½³å®è·µï¼Œè®©æˆ‘ä»¬å…ˆä»ä¸€äº›å®¹æ˜“è¢«å¿½ç•¥çš„æ€§èƒ½é™·é˜±å¼€å§‹ã€‚

## ä½¿ç”¨æ€§èƒ½æµ‹è¯•å·¥å…·

ä»Šå¤©æˆ‘ä»¬çš„è®²è§£éœ€è¦ç”¨åˆ°ä¸€ä¸ªå·¥å…·ï¼Œå®ƒå°±æ˜¯JMHã€‚JMHæ˜¯ä¸ºJavaè¯­è¨€æˆ–è€…å…¶ä»–åŸºäºJVMçš„ç¼–ç¨‹è¯­è¨€è®¾è®¡çš„ä¸€ä¸ªåŸºå‡†æµ‹è¯•å·¥å…·ã€‚è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨è¿™ä¸ªå·¥å…·æ¥åˆ†æä¸€äº›æ€§èƒ½çš„é™·é˜±ã€‚è¿™é‡Œæˆ‘ä»¬ç®€å•åœ°ä»‹ç»ä¸‹ï¼Œè¿™ä¸ªå·¥å…·è¯¥æ€ä¹ˆä½¿ç”¨ã€‚

ç¬¬ä¸€æ­¥ï¼Œä½¿ç”¨Mavenå·¥å…·å»ºç«‹ä¸€ä¸ªåŸºå‡†æµ‹è¯•é¡¹ç›®ï¼ˆéœ€è¦ä½¿ç”¨Mavenå·¥å…·ï¼‰ï¼š

```
$ mvn archetype:generate \
          -DinteractiveMode=false \
          -DarchetypeGroupId=org.openjdk.jmh \
          -DarchetypeArtifactId=jmh-java-benchmark-archetype \
          -DgroupId=com.example \
          -DartifactId=myJmh \
          -Dversion=1.0
```

è¿™ä¸ªå‘½ä»¤è¡Œï¼Œä¼šç”Ÿæˆä¸€ä¸ªmyJmhçš„å·¥ç¨‹ç›®å½•ï¼Œå’Œä¸€ä¸ªåŸºå‡†æµ‹è¯•æ¨¡æ¿æ–‡ä»¶ï¼ˆmyJmh/src/main/java/com/example/MyBenchmark.javaï¼‰ã€‚é€šè¿‡æ›´æ”¹è¿™ä¸ªæµ‹è¯•æ¨¡æ¿ï¼Œå°±å¯ä»¥å¾—åˆ°ä½ æƒ³è¦çš„åŸºå‡†æµ‹è¯•äº†ã€‚

æ¯”å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨åé¢æˆ‘ä»¬ç”¨åˆ°çš„åŸºå‡†æµ‹è¯•ä»£ç ï¼Œæ›¿æ¢æ‰æ¨¡æ¿ä¸­çš„åŸºå‡†æµ‹è¯•æ–¹æ³•ï¼ˆmeasureStringApendï¼‰ã€‚

```
package com.example;

import org.openjdk.jmh.annotations.Benchmark;

public class MyBenchmark {
    @Benchmark
    public String measureStringApend() {
        String targetString = "";
        for (int i = 0; i < 10000; i++) {
            targetString += "hello";
        }

        return targetString;
    }
}
```

ç¬¬äºŒæ­¥ï¼Œç¼–è¯‘åŸºå‡†æµ‹è¯•ï¼š

```
$ cd myJmh
$ mvn clean install
```

ç¬¬ä¸‰æ­¥ï¼Œè¿è¡Œä½ çš„åŸºå‡†æµ‹è¯•ï¼š

```
$ cd myJmh
$ Java -jar target/benchmarks.jar
```

ç¨å¾®ç­‰å¾…ï¼ŒåŸºå‡†æµ‹è¯•ç»“æœå°±å‡ºæ¥äº†ã€‚æˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ˜¯"Score"è¿™ä¸€æ ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯æ¯ç§’é’Ÿå¯ä»¥æ‰§è¡Œçš„åŸºå‡†æµ‹è¯•æ–¹æ³•çš„æ¬¡æ•°ã€‚

```
Benchmark                Mode  Cnt        Score          Error  Units
MyBenchmark.testMethod  thrpt   25        35.945 â–’       0.694  ops/s
```

è¿™æ˜¯JMHå·¥å…·åŸºæœ¬çš„ä½¿ç”¨æµç¨‹ï¼Œæœ‰å…³è¿™ä¸ªå·¥å…·æ›´å¤šçš„é€‰é¡¹å’Œæ›´è¯¦ç»†çš„ä½¿ç”¨ï¼Œéœ€è¦ä½ å‚è€ƒJMHçš„ç›¸å…³æ–‡æ¡£ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡å­—ç¬¦ä¸²è¿æ¥æ“ä½œå’Œå“ˆå¸Œå€¼çš„ä¾‹å­ï¼Œæ¥è°ˆè®ºä¸€ä¸‹è¿™ä¸ªå·¥å…·è¦æ€ä¹ˆä½¿ç”¨ï¼Œä»¥åŠå¯¹åº”çš„æ€§èƒ½é—®é¢˜ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å†çœ‹çœ‹å…¶ä»–å½±å“æ€§èƒ½çš„ä¸€äº›å°é™·é˜±ï¼Œæ¯”å¦‚å†…å­˜çš„æ³„éœ²ã€æœªå…³é—­çš„èµ„æºå’Œé—æ¼çš„hashCodeã€‚

## å­—ç¬¦ä¸²çš„æ“ä½œ

åœ¨Javaçš„æ ¸å¿ƒç±»åº“é‡Œï¼Œæœ‰ä¸‰ä¸ªå­—ç¬¦ä¸²æ“ä½œçš„ç±»ï¼Œåˆ†åˆ«é—®Stringã€StringBuilderå’ŒStringBufferã€‚é€šè¿‡ä¸‹é¢çš„åŸºå‡†æµ‹è¯•ï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸‹è¿™ä¸‰ç§ä¸åŒçš„å­—ç¬¦ä¸²æ“ä½œçš„æ€§èƒ½å·®å¼‚ã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘æŠŠJMHæµ‹è¯•çš„æ•°æ®ï¼Œæ ‡æ³¨åœ¨æ¯ä¸ªåŸºå‡†æµ‹è¯•çš„æ–¹æ³•æ³¨é‡Šé‡Œäº†ã€‚

```
    // JMH throughput benchmark: about 32 operations per second
    @Benchmark
    public String measureStringApend() {
        String targetString = "";
        for (int i = 0; i < 10000; i++) {
            targetString += "hello";
        }

        return targetString;
    }
```

```
    // JMH throughput benchmark: about 5,600 operations per second
    @Benchmark
    public String measureStringBufferApend() {
        StringBuffer buffer = new StringBuffer();
        for (int i = 0; i < 10000; i++) {
            buffer.append("hello");
        }

        return buffer.toString();
    }
```

```
    // JMH throughput benchmark: about 21,000 operations per second
    @Benchmark
    public String measureStringBuilderApend() {
        StringBuilder builder = new StringBuilder();
        for (int i = 0; i < 10000; i++) {
            builder.append("hello");
        }

        return builder.toString();
    }
```

å¯¹äºå­—ç¬¦ä¸²è¿æ¥çš„æ“ä½œï¼Œè¿™ä¸ªåŸºå‡†æµ‹è¯•ç»“æœæ˜¾ç¤ºï¼Œä½¿ç”¨StringBufferçš„å­—ç¬¦ä¸²è¿æ¥æ“ä½œï¼Œæ¯”ä½¿ç”¨Stringçš„æ“ä½œå¿«äº†è¿‘200å€ï¼›ä½¿ç”¨StringBuilder çš„å­—ç¬¦ä¸²è¿æ¥æ“ä½œï¼Œæ¯”ä½¿ç”¨Stringçš„æ“ä½œå¿«äº†è¿‘700å€ã€‚

Stringçš„å­—ç¬¦ä¸²è¿æ¥æ“ä½œä¸ºä»€ä¹ˆæ…¢å‘¢ï¼Ÿ è¿™æ˜¯å› ä¸ºæ¯ä¸€ä¸ªå­—ç¬¦ä¸²è¿æ¥çš„æ“ä½œï¼ˆtargetString += â€œhelloâ€ï¼‰ï¼Œéƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„Stringå¯¹è±¡ï¼Œç„¶åå†é”€æ¯ï¼Œå†åˆ›å»ºã€‚è¿™ç§æ¨¡å¼å¯¹CPUå’Œå†…å­˜æ¶ˆè€—éƒ½æ¯”è¾ƒå¤§ã€‚

StringBuilderå’ŒStringBufferä¸ºä»€ä¹ˆå¿«å‘¢ï¼Ÿå› ä¸ºStringBuilderå’ŒStringBufferçš„å†…éƒ¨å®ç°ï¼Œé¢„å…ˆåˆ†é…äº†ä¸€å®šçš„å†…å­˜ã€‚å­—ç¬¦ä¸²æ“ä½œæ—¶ï¼Œåªæœ‰é¢„åˆ†é…å†…å­˜ä¸è¶³ï¼Œæ‰ä¼šæ‰©å±•å†…å­˜ï¼Œè¿™å°±å¤§å¹…åº¦å‡å°‘äº†å†…å­˜åˆ†é…ã€æ‹·è´å’Œé‡Šæ”¾çš„é¢‘ç‡ã€‚

StringBuilderä¸ºä»€ä¹ˆæ¯”StringBufferè¿˜è¦å¿«å‘¢ï¼ŸStringBufferçš„å­—ç¬¦ä¸²æ“ä½œæ˜¯å¤šçº¿ç¨‹å®‰å…¨çš„ï¼Œè€ŒStringBuilderçš„æ“ä½œå°±ä¸æ˜¯ã€‚å¦‚æœæˆ‘ä»¬çœ‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„å®ç°ä»£ç ï¼Œé™¤äº†çº¿ç¨‹å®‰å…¨çš„åŒæ­¥ä»¥å¤–ï¼Œå‡ ä¹æ²¡æœ‰å·®åˆ«ã€‚

```
public final class StringBuffer
    extends AbstractStringBuilder
    implements java.io.Serializable, Comparable<StringBuffer>, CharSequence {
    // snipped

    @Override
    @HotSpotIntrinsicCandidate
    public synchronized StringBuffer append(String str) {
        toStringCache = null;
        super.append(str);
        return this;
    }

    //  snipped
}
```

```
public final class StringBuilder
    extends AbstractStringBuilder
    implements java.io.Serializable, Comparable<StringBuilder>, CharSequence {
    // snipped

    @Override
    @HotSpotIntrinsicCandidate
    public StringBuilder append(String str) {
        super.append(str);
        return this;
    }

    // snipped
}
```

JMHçš„åŸºå‡†æµ‹è¯•ï¼Œå¹¶æ²¡æœ‰æ¶‰åŠåˆ°çº¿ç¨‹åŒæ­¥é—®é¢˜ï¼Œéš¾é“ä½¿ç”¨synchronizedå…³é”®å­—ä¹Ÿä¼šæœ‰æ€§èƒ½æŸè€—å—ï¼Ÿ

æˆ‘ä»¬å†æ¥çœ‹çœ‹å¦å¤–ä¸€ä¸ªåŸºå‡†æµ‹è¯•ã€‚è¿™ä¸ªåŸºå‡†æµ‹è¯•ï¼Œä½¿ç”¨çº¿ç¨‹ä¸å®‰å…¨çš„StringBuilderä»¥åŠåŒæ­¥çš„å­—ç¬¦ä¸²è¿æ¥ï¼Œéƒ¨åˆ†æ¨¡æ‹Ÿäº†çº¿ç¨‹å®‰å…¨çš„StringBuffer.append()æ–¹æ³•çš„å®ç°ã€‚ä¸ºäº†æ–¹ä¾¿ä½ å¯¹æ¯”ï¼Œæˆ‘æŠŠæ²¡æœ‰ä½¿ç”¨åŒæ­¥çš„ä»£ç ä¹Ÿæ‹·è´åœ¨ä¸‹é¢ã€‚

```
    // JMH throughput benchmark: about 21,000 operations per second
    @Benchmark
    public String measureStringBuilderApend() {
        StringBuilder builder = new StringBuilder();
        for (int i = 0; i < 10000; i++) {
            builder.append("hello");
        }

        return builder.toString();
    }
```

```
    // JMH throughput benchmark: about 16,000 operations per second
    @Benchmark
    public String measureStringBuilderSynchronizedApend() {
        StringBuilder builder = new StringBuilder();
        for (int i = 0; i < 10000; i++) {
            synchronized (this) {
                builder.append("hello");
            }
        }

        return builder.toString();
    }
```

è¿™ä¸ªåŸºå‡†æµ‹è¯•ç»“æœæ˜¾ç¤ºï¼Œè™½ç„¶åŸºå‡†æµ‹è¯•å¹¶æ²¡æœ‰ä½¿ç”¨å¤šä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯ä½¿ç”¨äº†çº¿ç¨‹åŒæ­¥çš„ä»£ç æ¯”ä¸ä½¿ç”¨çº¿ç¨‹åŒæ­¥çš„ä»£ç æ…¢ã€‚çº¿ç¨‹åŒæ­¥ï¼Œå°±æ˜¯StringBufferæ¯”StringBuilderæ…¢çš„åŸå› ä¹‹ä¸€ã€‚

é€šè¿‡ä¸Šé¢çš„åŸºå‡†æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºè¿™æ ·çš„ç»“è®ºï¼š

1. é¢‘ç¹çš„å¯¹è±¡åˆ›å»ºã€é”€æ¯ï¼Œæœ‰æŸä»£ç çš„æ•ˆç‡ï¼›
2. å‡å°‘å†…å­˜åˆ†é…ã€æ‹·è´ã€é‡Šæ”¾çš„é¢‘ç‡ï¼Œå¯ä»¥æé«˜ä»£ç çš„æ•ˆç‡ï¼›
3. å³ä½¿æ˜¯å•çº¿ç¨‹ç¯å¢ƒï¼Œä½¿ç”¨çº¿ç¨‹åŒæ­¥ä¾ç„¶æœ‰æŸä»£ç çš„æ•ˆç‡ã€‚

ä»ä¸Šé¢çš„åŸºå‡†æµ‹è¯•ç»“æœï¼Œæ˜¯ä¸æ˜¯å¯ä»¥å¾—å‡ºç»“è®ºï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨StringBuilderæ¥è¿›è¡Œå­—ç¬¦ä¸²æ“ä½œå‘¢ï¼Ÿæˆ‘ä»¬å†æ¥çœ‹å‡ ä¸ªåŸºå‡†æµ‹è¯•çš„ä¾‹å­ã€‚

ä¸‹é¢çš„ä¾‹å­ï¼Œæµ‹è¯•çš„æ˜¯å¸¸é‡å­—ç¬¦ä¸²çš„è¿æ¥æ“ä½œã€‚ä»æµ‹è¯•ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨Stringçš„è¿æ¥æ“ä½œï¼Œè¦æ¯”ä½¿ç”¨StringBuilderçš„å­—ç¬¦ä¸²è¿æ¥å¿«5ä¸‡å€ï¼Œè¿™æ˜¯ä¸€ä¸ªè®©äººæƒŠè®¶çš„æ€§èƒ½å·®å¼‚ã€‚

```
    // JMH throughput benchmark: about 1,440,000,000 operations per second
    @Benchmark
    public void measureSimpleStringApend() {
        for (int i = 0; i < 10000; i++) {
            String targetString = "Hello, " + "world!";
        }
    }
```

```
    // JMH throughput benchmark: about 26,000 operations per second
    @Benchmark
    public void measureSimpleStringBuilderApend() {
        for (int i = 0; i < 10000; i++) {
            StringBuilder builder = new StringBuilder();
            builder.append("hello, ");
            builder.append("world!");
        }
    }
```

è¿™ä¸ªå·¨å¤§çš„å·®å¼‚ï¼Œä¸»è¦æ¥è‡ªäºJavaç¼–è¯‘å™¨å’ŒJVMå¯¹å­—ç¬¦ä¸²å¤„ç†çš„ä¼˜åŒ–ã€‚" Hello, " + " world! " è¿™æ ·çš„è¡¨è¾¾å¼ï¼Œå¹¶æ²¡æœ‰çœŸæ­£æ‰§è¡Œå­—ç¬¦ä¸²è¿æ¥ã€‚ç¼–è¯‘å™¨ä¼šæŠŠå®ƒå¤„ç†æˆä¸€ä¸ªè¿æ¥å¥½çš„å¸¸é‡å­—ç¬¦ä¸²"Hello, world!"ã€‚è¿™æ ·ï¼Œä¹Ÿå°±ä¸å­˜åœ¨åå¤çš„å¯¹è±¡åˆ›å»ºå’Œé”€æ¯äº†ï¼Œå¸¸é‡å­—ç¬¦ä¸²çš„è¿æ¥æ˜¾ç¤ºäº†è¶…é«˜çš„æ•ˆç‡ã€‚

å¦‚æœå­—ç¬¦ä¸²çš„è¿æ¥é‡Œï¼Œå‡ºç°äº†å˜é‡ï¼Œç¼–è¯‘å™¨å’ŒJVMå°±æ²¡æœ‰åŠæ³•è¿›è¡Œä¼˜åŒ–äº†ã€‚è¿™æ—¶å€™ï¼ŒStringBuilderçš„æ•ˆç‡ä¼˜åŠ¿æ‰èƒ½ä½“ç°å‡ºæ¥ã€‚ä¸‹é¢çš„ä¸¤ä¸ªåŸºå‡†æµ‹è¯•ç»“æœï¼Œå°±æ˜¾ç¤ºäº†å˜é‡å¯¹äºå­—ç¬¦é•¿è¿æ¥æ“ä½œæ•ˆç‡çš„å½±å“ã€‚

```
    // JMH throughput benchmark: about 9,000 operations per second
    @Benchmark
    public void measureVariableStringApend() {
        for (int i = 0; i < 10000; i++) {
            String targetString = "Hello, " + getAppendix();
        }
    }
```

```
    // JMH throughput benchmark: about 26,000 operations per second
    @Benchmark
    public void measureVariableStringBuilderApend() {
        for (int i = 0; i < 10000; i++) {
            StringBuilder builder = new StringBuilder();
            builder.append("hello, ");
            builder.append(getAppendix());
        }
    }

```

```
    private String getAppendix() {
       return "World!";
    }
```

é€šè¿‡ä¸Šé¢çš„åŸºå‡†æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºä¸‹é¢çš„å‡ æ¡æœ€ä½³å®è·µï¼š

1. Javaçš„ç¼–è¯‘å™¨ä¼šä¼˜åŒ–å¸¸é‡å­—ç¬¦ä¸²çš„è¿æ¥ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾å¿ƒåœ°æŠŠé•¿çš„å­—ç¬¦ä¸²æ¢æˆå¤šè¡Œï¼›
2. å¸¦æœ‰å˜é‡çš„å­—ç¬¦ä¸²è¿æ¥ï¼ŒStringBuilderæ•ˆç‡æ›´é«˜ã€‚å¦‚æœæ•ˆç‡æ•æ„Ÿçš„ä»£ç ï¼Œå»ºè®®ä½¿ç”¨StringBuilderã€‚Stringçš„è¿æ¥æ“ä½œå¯è¯»æ€§æ›´é«˜ï¼Œæ•ˆç‡ä¸æ•æ„Ÿçš„ä»£ç å¯ä»¥ä½¿ç”¨ï¼Œæ¯”å¦‚å¼‚å¸¸ä¿¡æ¯ã€è°ƒè¯•æ—¥å¿—ã€ä½¿ç”¨ä¸é¢‘ç¹çš„ä»£ç ï¼›
3. å¦‚æœæ¶‰åŠå¤§é‡çš„å­—ç¬¦ä¸²æ“ä½œï¼Œä½¿ç”¨StringBuilderæ•ˆç‡æ›´é«˜ï¼›
4. é™¤éæœ‰çº¿ç¨‹å®‰å…¨çš„éœ€æ±‚ï¼Œä¸æ¨èä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„StringBufferã€‚

## å†…å­˜çš„æ³„éœ²

å†…å­˜æ³„æ¼æ˜¯Cè¯­è¨€çš„ä¸€ä¸ªå¤§é—®é¢˜ã€‚ä¸ºäº†æ›´å¥½åœ°ç®¡ç†å†…å­˜ï¼ŒJavaæä¾›äº†è‡ªåŠ¨çš„å†…å­˜ç®¡ç†å’Œåƒåœ¾å›æ”¶æœºåˆ¶ã€‚ä½†æ˜¯ï¼ŒJavaä¾ç„¶ä¼šæ³„éœ²å†…å­˜ã€‚è¿™ç§å†…å­˜æ³„æ¼çš„ä¸»è¦è¡¨ç°æ˜¯ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡ä¸å†æœ‰ç”¨å¤„ï¼Œè€Œä¸”å®ƒçš„å¼•ç”¨è¿˜æ²¡æœ‰æ¸…é›¶ï¼Œåƒåœ¾å›æ”¶å™¨å°±æ„è¯†ä¸åˆ°è¿™ä¸ªå¯¹è±¡éœ€è¦åŠæ—¶å›æ”¶ï¼Œè¿™æ—¶å€™å°±å¼•å‘äº†å†…å­˜æ³„éœ²ã€‚

ç”Ÿå‘½å‘¨æœŸé•¿çš„é›†åˆï¼Œæ˜¯Javaå®¹æ˜“å‘ç”Ÿå†…å­˜æ³„æ¼çš„åœ°æ–¹ã€‚æ¯”å¦‚ï¼Œå¯ä»¥æ‰©å¼ çš„é™æ€çš„é›†åˆï¼Œæˆ–è€…å­˜æ´»æ—¶é—´é•¿çš„ç¼“å­˜ç­‰ã€‚å¦‚æœä¸èƒ½åŠæ—¶æ¸…ç†æ‰é›†åˆé‡Œæ²¡æœ‰ç”¨å¤„çš„å¯¹è±¡ï¼Œå°±ä¼šé€ æˆå†…å­˜çš„æŒç»­å¢åŠ ï¼Œå¼•å‘å†…å­˜æ³„æ¼é—®é¢˜ã€‚

æ¯”å¦‚ä¸‹é¢è¿™ä¸¤ä¸ªä¾‹å­ï¼Œå°±å®¹æ˜“å‘ç”Ÿå†…å­˜æ³„éœ²ã€‚

é™æ€çš„é›†åˆï¼š

```
static final List<Object>
         staticCachedObjects = new LinkedList<>();

// snipped
staticCachedObjects.add(...);
```

é•¿å¯¿çš„ç¼“å­˜ï¼š

```
final List<Object>
        longLastingCache = new LinkedList<>();

// snipped
longLastingCache.add(...);
```

è§£å†³è¿™ä¸ªé—®é¢˜çš„åŠæ³•é€šå¸¸æ˜¯ä½¿ç”¨SoftReferenceå’ŒWeakReferenceæ¥å­˜å‚¨å¯¹è±¡çš„å¼•ç”¨ï¼Œæˆ–è€…ä¸»åŠ¨åœ°å®šæœŸæ¸…ç†ã€‚

é™æ€çš„é›†åˆï¼š

```
static final List<WeakReference<Object>>
        staticCachedObjects = new LinkedList<>();

// snipped
staticCachedObjects.add(...);
```

é•¿å¯¿çš„ç¼“å­˜ï¼š

```
final List<WeakReference<Object>>
        longLastingCache = new LinkedList<>();

// snipped
longLastingCache.add(...);
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¼“å­˜çš„å¤„ç†æ˜¯ä¸€ä¸ªå¤æ‚çš„é—®é¢˜ï¼Œä½¿ç”¨SoftReferenceå’ŒWeakReferenceæœªå¿…èƒ½å¤Ÿæ»¡è¶³ä½ çš„ä¸šåŠ¡éœ€æ±‚ã€‚æ›´æœ‰æ•ˆçš„ç¼“å­˜è§£å†³æ–¹æ¡ˆï¼Œä¾èµ–äºå…·ä½“çš„ä½¿ç”¨åœºæ™¯ã€‚

## æœªå…³é—­çš„èµ„æº

æœ‰å¾ˆå¤šç³»ç»Ÿèµ„æºï¼Œéœ€è¦æ˜ç¡®åœ°å…³é—­ï¼Œè¦ä¸ç„¶ï¼Œå ç”¨çš„ç³»ç»Ÿèµ„æºå°±ä¸èƒ½æœ‰æ•ˆåœ°é‡Šæ”¾ã€‚æ¯”å¦‚è¯´ï¼Œæ•°æ®åº“è¿æ¥ã€å¥—æ¥å­—è¿æ¥å’Œ I/O æ“ä½œç­‰ã€‚åŸåˆ™ä¸Šï¼Œæ‰€æœ‰å®ç°äº†Closableæ¥å£çš„å¯¹è±¡ï¼Œéƒ½åº”è¯¥è°ƒç”¨close()æ“ä½œï¼›æ‰€æœ‰éœ€è¦æ˜ç¡®å…³é—­çš„ç±»ï¼Œéƒ½åº”è¯¥å®ç°Closableæ¥å£ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œclose()æ“ä½œï¼Œä¸€å®šè¦ä½¿ç”¨try-finallyæˆ–è€…try-with-resourceè¯­å¥ã€‚è¦ä¸ç„¶ï¼Œå…³é—­èµ„æºçš„ä»£ç å¯èƒ½å¾ˆå¤æ‚ã€‚

![](https://static001.geekbang.org/resource/image/c8/53/c8f705647492b0faccbfff026eb88d53.png?wh=627%2A420)  
å¦‚æœä¸€ä¸ªç±»éœ€è¦å…³é—­ï¼Œä½†æ˜¯åˆæ²¡æœ‰å®ç°Closableæ¥å£ï¼Œå°±æ¯”è¾ƒéº»çƒ¦ï¼Œæ¯”å¦‚URLConnection. URLConnection.connect()èƒ½å¤Ÿå»ºç«‹è¿æ¥ï¼Œè¯¥è¿æ¥éœ€è¦å…³é—­ï¼Œä½†æ˜¯URLConnectionæ²¡æœ‰å®ç°Closableæ¥å£ï¼Œå…³é—­çš„åŠæ³•åªèƒ½æ˜¯å…³é—­å¯¹åº”çš„I/Oæ¥å£ï¼Œå¯æ˜¯å…³é—­I/Oè¾“å…¥å’Œè¾“å‡ºæ¥å£ä¸­çš„ä¸€ä¸ªï¼Œè¿˜ä¸èƒ½ä¿è¯æ•´ä¸ªè¿æ¥ä¼šå®Œå…¨å…³é—­ã€‚è°¨æ…çš„ä»£ç ï¼Œéœ€è¦æŠŠI/Oè¾“å…¥å’Œè¾“å‡ºéƒ½å…³é—­æ‰ï¼Œå“ªæ€•ä¸éœ€è¦è¾“å…¥æˆ–è€…è¾“å‡ºã€‚ä½†æ˜¯è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬çš„ç¼–ç è´Ÿæ‹…å°±ä¼šåŠ é‡ã€‚æ‰€ä»¥æœ€å¥½çš„æ–¹æ³•å°±æ˜¯å®ç°Closableæ¥å£ã€‚

åŒå‘å…³é—­I/Oï¼š

```
URL url = new URL("http://www.google.com/");
URLConnection conn = url.openConnection();
conn.connect();

try (InputStream is = conn.getInputStream()) {
    // sinnped
}

try (OutputStream os = conn.getOutputStream()) {
    // sinnped
}
```

å•å‘å…³é—­I/Oï¼š

```
URL url = new URL("http://www.google.com/");
URLConnection conn = url.openConnection();
conn.connect();

try (InputStream is = conn.getInputStream()) {
    // sinnped
}

// The output strean is not close, the connection may be still alive.
```

## é—æ¼çš„hashCode

åœ¨ä½¿ç”¨Hashtbaleã€HashMapã€HashSetè¿™æ ·çš„ä¾èµ–å“ˆå¸Œï¼ˆhashï¼‰å€¼çš„é›†åˆæ—¶ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ä¼šå¿˜è®°è¦æ£€æŸ¥äº§ç”Ÿå“ˆå¸Œå€¼çš„å¯¹è±¡ï¼Œä¸€å®šè¦å®ç°hashCode()å’Œequals()è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚ç¼ºçœçš„hashCode()å®ç°ï¼Œè¿”å›å€¼æ˜¯æ¯ä¸€ä¸ªå¯¹è±¡éƒ½ä¸åŒçš„æ•°å€¼ã€‚å³ä½¿æ˜¯ç›¸ç­‰çš„å¯¹è±¡ï¼Œä¸åŒçš„å“ˆå¸Œå€¼ï¼Œä½¿ç”¨åŸºäºå“ˆå¸Œå€¼çš„é›†åˆæ—¶ï¼Œä¹Ÿä¼šè¢«çœ‹ä½œä¸åŒçš„å¯¹è±¡ã€‚è¿™æ ·çš„è¡Œä¸ºï¼Œå¯èƒ½ä¸ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚è€Œä¸”ï¼Œä½¿ç”¨æ²¡æœ‰å®ç°hashCode()å’Œequals()è¿™ä¸¤ä¸ªæ–¹æ³•çš„å¯¹è±¡ï¼Œå¯èƒ½ä¼šé€ æˆé›†åˆçš„å°ºå¯¸æŒç»­å¢åŠ ï¼Œæ— ç«¯åœ°å ç”¨å†…å­˜ï¼Œç”šè‡³ä¼šé€ æˆå†…å­˜çš„æ³„æ¼ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬ä½¿ç”¨åŸºäºhashçš„é›†åˆæ—¶ï¼Œä¸€å®šè¦ç¡®ä¿é›†åˆé‡Œçš„å¯¹è±¡ï¼Œéƒ½æ­£ç¡®åœ°å®ç°äº†hashCode()å’Œequals()è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚

![](https://static001.geekbang.org/resource/image/bf/82/bf4fd2108a994b6bbfa7845dc65b1d82.jpg?wh=625%2A1235)

## æ’è½¦çš„å“ˆå¸Œå€¼

å®ç°hashCode()è¿™ä¸ªæ–¹æ³•çš„ï¼Œå¹¶æ²¡æœ‰è¦æ±‚ä¸ç›¸ç­‰å¯¹è±¡çš„è¿”å›å€¼ä¹Ÿå¿…é¡»æ˜¯ä¸ç›¸ç­‰çš„ã€‚ä½†æ˜¯å¦‚æœè¿”å›çš„å“ˆå¸Œå€¼ä¸åŒï¼Œå¯¹é›†åˆçš„æ€§èƒ½å°±ä¼šæœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚

ä¸‹é¢çš„ä¸¤ä¸ªåŸºå‡†æµ‹è¯•ç»“æœæ˜¾ç¤ºï¼Œå¦‚æœ10,000ä¸ªå¯¹è±¡ï¼Œåªæœ‰10ä¸ªä¸åŒçš„å“ˆå¸Œå€¼ï¼Œå®ƒçš„é›†åˆè¿ç®—çš„æ€§èƒ½æ˜¯ä»¤äººæ‹…å¿§çš„ã€‚å’Œä½¿ç”¨äº†ä¸ç”¨å“ˆå¸Œå€¼çš„å®ç°ç›¸æ¯”ï¼Œæ€§èƒ½æœ‰å‡ ç™¾å€çš„å·®å¼‚ã€‚

è¿™ç§æ€§èƒ½å·®å¼‚ï¼Œä¸»è¦æ˜¯ç”±åŸºäºå“ˆå¸Œå€¼çš„é›†åˆçš„å®ç°æ–¹å¼å†³å®šçš„ã€‚å“ˆå¸Œå€¼å¦‚æœç›¸åŒï¼Œå°±è¦è°ƒç”¨å…¶ä»–çš„æ–¹æ³•æ¥è¯†åˆ«ä¸€ä¸ªå¯¹è±¡ã€‚å“ˆå¸Œå€¼å¦‚æœä¸åŒï¼Œå“ˆå¸Œå€¼æœ¬èº«å°±å¯ä»¥ç¡®å®šä¸€ä¸ªå¯¹è±¡çš„ç´¢å¼•ã€‚å¦‚æœå“ˆå¸Œå€¼æ’è½¦æ¯”ä¾‹å¤§ï¼Œè¿™ç§æ£€ç´¢å’Œè®¡ç®—çš„å·®è·å°±ä¼šå¾ˆå¤§ã€‚

```
    // JMH throughput benchmark: about 5,000 operations per second
    @Benchmark
    public void measureHashMap() throws IOException {
        Map<HashedKey, String> map = new HashMap<>();
        for (int i = 0; i < 10000; i++) {
            map.put(new HashedKey(i), "value");
        }
    }

    private static class HashedKey {
        final int key;

        HashedKey(int key) {
            this.key = key;
        }

        @Override
        public boolean equals(Object obj) {
            if (obj == this) {
                return true;
            }

            if (obj instanceof HashedKey) {
                return key == ((HashedKey)obj).key;
            }

            return false;
        }

        @Override
        public int hashCode() {
            return key;
        }
    }
```

```
    // JMH throughput benchmark: about 9.5 operations per second
    @Benchmark
    public void measureCollidedHashMap() throws IOException {
        Map<CollidedKey, String> map = new HashMap<>();
        for (int i = 0; i < 10000; i++) {
            map.put(new CollidedKey(i), "value");
        }
    }

    private static class CollidedKey {
        final int key;

        CollidedKey(int key) {
            this.key = key;
        }

        @Override
        public boolean equals(Object obj) {
            if (obj == this) {
                return true;
            }

            if (obj instanceof CollidedKey) {
                return key == ((CollidedKey)obj).key;
            }

            return false;
        }

        @Override
        public int hashCode() {
            return key % 10;
        }
    }
```

## å°ç»“

ä»Šå¤©ï¼Œæˆ‘ä»¬ä¸»è¦è®¨è®ºäº†ä¸€äº›å®¹æ˜“è¢«å¿½ç•¥çš„æ€§èƒ½é™·é˜±ã€‚æ¯”å¦‚ï¼Œå­—ç¬¦ä¸²æ€ä¹ˆæ“ä½œæ‰æ˜¯é«˜æ•ˆçš„ï¼›Javaå¸¸è§çš„å†…å­˜æ³„æ¼ï¼›èµ„æºå…³é—­çš„æ­£ç¡®æ–¹æ³•ä»¥åŠé›†åˆçš„ç›¸å…³æ€§èƒ½é—®é¢˜ã€‚

æˆ‘ä»¬è™½ç„¶ä½¿ç”¨äº†Javaä½œä¸ºç¤ºä¾‹ï¼Œä½†æ˜¯åƒé›†åˆå’Œå­—ç¬¦ä¸²æ“ä½œè¿™æ ·çš„æ€§èƒ½é—®é¢˜ï¼Œå¹¶ä¸å±€é™äºç‰¹å®šçš„ç¼–ç¨‹è¯­è¨€ï¼Œä½ ä¹Ÿå¯ä»¥çœ‹çœ‹ä½ ç†Ÿæ‚‰çš„ç¼–ç¨‹è¯­è¨€æœ‰æ²¡æœ‰ç±»ä¼¼çš„é—®é¢˜ã€‚

## ä¸€èµ·æ¥åŠ¨æ‰‹

è¿™ä¸€æ¬¡çš„ç»ƒæ‰‹é¢˜ï¼Œæˆ‘ä»¬æ¥ç»ƒä¹ ä½¿ç”¨JMHå·¥å…·ï¼Œåˆ†ææ›´å¤šçš„æ€§èƒ½é—®é¢˜ã€‚åœ¨â€œæ’è½¦çš„å“ˆå¸Œå€¼â€è¿™ä¸€å°èŠ‚ï¼Œæˆ‘ä»¬æµ‹è¯•äº†HashMapçš„putæ–¹æ³•ï¼Œä½ èƒ½ä¸èƒ½æµ‹è¯•ä¸‹å…¶ä»–æ–¹æ³•ä»¥åŠå…¶ä»–åŸºäºå“ˆå¸Œå€¼çš„é›†åˆï¼ˆHashSetï¼ŒHashtableï¼‰ï¼Ÿæˆ‘ä»¬æµ‹è¯•çš„æ˜¯10,000ä¸ªå¯¹è±¡ï¼Œåªæœ‰10ä¸ªå“ˆå¸Œå€¼ã€‚å¦‚æœ10,000ä¸ªå¯¹è±¡ï¼Œæœ‰5,000ä¸ªå“ˆå¸Œå€¼ï¼Œæ€§èƒ½å½±å“æœ‰å¤šå¤§ï¼Ÿ

ä¸‹é¢çš„è¿™æ®µä»£ç ï¼Œä½ èƒ½å¤Ÿæ‰¾åˆ°å®ƒçš„æ€§èƒ½é—®é¢˜å—ï¼Ÿ

```
package com.example;

import java.util.Arrays;
import java.util.Random;

public class UserId {
    private static final Random random = new Random();

    private final byte[] userId = new byte[32];

    public UserId() {
        random.nextBytes(userId);
    }

    @Override
    public boolean equals(Object obj) {
        if (obj == this) {
            return true;
        }

        if (obj instanceof UserId) {
            return Arrays.equals(this.userId, ((UserId)obj).userId);
        }

        return false;
    }

    @Override
    public int hashCode() {
        int retVal = 0;

        for (int i = 0; i < userId.length; i++) {
            retVal += userId[i];
        }

        return retVal;
    }
}
```

æˆ‘ä»¬å‰é¢è®¨è®ºäº†ä¸‹é¢è¿™æ®µä»£ç çš„æ€§èƒ½é—®é¢˜ï¼Œä½ èƒ½å¤Ÿä½¿ç”¨JMHæµ‹è¯•ä¸€ä¸ªä½ çš„æ”¹è¿›æ–¹æ¡ˆå¸¦æ¥çš„æ•ˆç‡æå‡å—ï¼Ÿ

```
import java.util.HashMap;
import java.util.Map;

class Solution {
    /**
     * Given an array of integers, return indices of the two numbers
     * such that they add up to a specific target.
     */
    public int[] twoSum(int[] nums, int target) {
        Map<Integer, Integer> map = new HashMap<>();
        for (int i = 0; i < nums.length; i++) {
            int complement = target - nums[i];
            if (map.containsKey(complement)) {
                return new int[] { map.get(complement), i };
            }
            map.put(nums[i], i);
        }
        throw new IllegalArgumentException("No two sum solution");
    }
}

```

å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥æ£€æŸ¥ä¸€ä¸‹ä½ æ‰‹å¤´çš„ä»£ç ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰è¸©åˆ°ç±»ä¼¼çš„å‘ã€‚å¦‚æœé‡åˆ°ç±»ä¼¼çš„é™·é˜±ï¼Œçœ‹ä¸€çœ‹èƒ½ä¸èƒ½æ”¹è¿›ã€‚

å®¹æ˜“è¢«å¿½ç•¥çš„æ€§èƒ½é™·é˜±ï¼Œæœ‰å¾ˆå¤šç§ã€‚è¿™äº›å¤§å¤§å°å°çš„ç»éªŒï¼Œéœ€è¦æˆ‘ä»¬æ—¥å¤ä¸€æ—¥çš„ç§¯ç´¯ã€‚å¦‚æœä½ æœ‰è¿™æ–¹é¢çš„ç»éªŒï¼Œæˆ–è€…çœ‹åˆ°è¿™æ–¹é¢çš„æŠ€æœ¯ï¼Œè¯·ä½ åˆ†äº«åœ¨ç•™è¨€åŒºï¼Œæˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ ã€ç§¯ç´¯è¿™äº›ç»éªŒã€‚

ä¹Ÿæ¬¢è¿ç‚¹å‡»â€œè¯·æœ‹å‹è¯»â€ï¼ŒæŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–è€…åŒäº‹ï¼Œä¸€èµ·äº¤æµä¸€ä¸‹ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ5ï¼‰</strong></div><ul>
<li><span>ç†ŠçŒ«</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œèƒ½æ¨èJMHå¿«é€Ÿå…¥é—¨çš„åšå®¢å—ï¼Ÿå‡å°‘å¤§å®¶æŸ¥æ‰¾ä¿¡æ¯æˆæœ¬ã€‚</p>2019-05-22</li><br/><li><span>å¤•å¤æ´›å…‹</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆè¿™æ˜¯æˆ‘ç”¨jmh è·‘å‡ºçš„æ€§èƒ½æ•°æ® ä¸ºä»€ä¹ˆ stringçš„æ€§èƒ½æ˜¯æœ€å¥½çš„å‘¢
MyBenchmark.stringMethod  thrpt   25  15.036 Â± 1.045  ops&#47;s
MyBenchmark.stringBufferMethod  thrpt   25  7689.300 Â± 367.812  ops&#47;s
MyBenchmark.stringBuilderMethod  thrpt   25  7690.659 Â± 251.793  ops&#47;s</p>2019-03-06</li><br/><li><span>ç©ºçŸ¥</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>@å¤•å¤æ´›å…‹ æŸ¥äº†ä¸‹ JMHæœ‰å››ç§æ¨¡å¼,Throughputæ˜¯ååé‡,å•ä½æ—¶é—´å†…å¤„ç†è¯·æ±‚æ•°,è¶Šå¤§è¶Šå¥½, æ³¨è§£@BenchmarkMode(Mode.Throughput)å¯ä»¥ä¿®æ”¹æ¨¡å¼ </p>2019-03-07</li><br/><li><span>ifelse</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ç”Ÿå‘½å‘¨æœŸé•¿çš„é›†åˆï¼Œæ˜¯ Java å®¹æ˜“å‘ç”Ÿå†…å­˜æ³„æ¼çš„åœ°æ–¹ã€‚--è®°ä¸‹æ¥</p>2022-07-26</li><br/><li><span>å¾€äº‹éšé£ï¼Œé¡ºå…¶è‡ªç„¶</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å­˜åœ¨æ‹†ç®±å’Œè£…ç®±çš„è½¬æ¢é—®é¢˜ï¼Œæ¯”è¾ƒè€—è´¹èµ„æº</p>2019-03-05</li><br/>
</ul>