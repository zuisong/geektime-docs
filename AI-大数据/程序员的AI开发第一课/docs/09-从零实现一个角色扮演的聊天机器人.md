ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ‘æ™”ï¼

å‰é¢æˆ‘ä»¬ä»‹ç»äº† LangChain æœ€æ ¸å¿ƒçš„æŠ½è±¡ï¼Œç›¸ä¿¡ä½ ç°åœ¨å·²ç»èƒ½å¤Ÿç”¨ LangChain å®Œæˆä¸€äº›ä¸€æ¬¡æ€§çš„ç®€å•ä»»åŠ¡äº†ã€‚ä»è¿™ä¸€è®²å¼€å§‹ï¼Œæˆ‘ä»¬ä¼šå°è¯•å¼€å‘ä¸€äº›å¤§æ¨¡å‹åº”ç”¨ã€‚é€šè¿‡è¿™äº›åº”ç”¨ï¼Œä½ ä¼šé€æ¸äº†è§£åˆ°å¸¸è§çš„åº”ç”¨ç±»å‹æœ‰å“ªäº›ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ LangChain å¼€å‘è¿™äº›åº”ç”¨ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜ä¼šé‡åˆ°å¾ˆå¤šä¹‹å‰æ²¡æœ‰è®²åˆ°è¿‡çš„ LangChain æŠ½è±¡ï¼Œæˆ‘ä¼šç»“åˆå¼€å‘çš„å†…å®¹ç»™ä½ åšä¸€äº›ä»‹ç»ã€‚

è¿™ä¸€è®²ï¼Œæˆ‘ä»¬å°±ä»æœ€ç®€å•çš„èŠå¤©æœºå™¨äººå¼€å§‹è®²èµ·ã€‚

## ç®€å•çš„èŠå¤©æœºå™¨äºº

å‰é¢è¯´è¿‡ï¼ŒChatGPT ä¹‹æ‰€ä»¥ç«çˆ†ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯æ‹œèŠå¤©æ¨¡å¼æ‰€èµï¼Œäººä»¬å¯¹äºèŠå¤©æ¨¡å¼çš„ç†Ÿæ‚‰ï¼Œé™ä½äº† ChatGPT çš„ç†è§£é—¨æ§›ã€‚å¼€å‘ä¸€ä¸ªå¥½çš„èŠå¤©æœºå™¨äººå¹¶ä¸å®¹æ˜“ï¼Œä½†å¼€å‘ä¸€ä¸ªèŠå¤©æœºå™¨äººï¼Œå°¤å…¶æ˜¯æœ‰äº† LangChain ä¹‹åï¼Œè¿˜æ˜¯å¾ˆå®¹æ˜“çš„ã€‚æˆ‘ä»¬è¿™ä¸€è®²çš„ç›®æ ‡å°±æ˜¯å¼€å‘ä¸€ä¸ªç®€å•çš„èŠå¤©æœºå™¨äººï¼Œå®ƒä¹Ÿä¼šæˆä¸ºæˆ‘ä»¬åé¢å‡ è®²çš„åŸºç¡€ï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªèŠå¤©æœºå™¨äººæ˜¯æ€æ ·é€æ¸å˜å¾—å¼ºå¤§èµ·æ¥ã€‚

å‡ºäºç®€åŒ–çš„ç›®çš„ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ‰“é€ ä¸€ä¸ªå‘½ä»¤è¡Œçš„èŠå¤©æœºå™¨äººã€‚ä¸‹é¢å°±æ˜¯è¿™ä¸ªæœ€ç®€ç‰ˆèŠå¤©æœºå™¨äººçš„å®ç°ï¼š

```python
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage

chat_model = ChatOpenAI(model="gpt-4o-mini")

while True:
    user_input = input("You:> ")
    if user_input.lower() == 'exit':
        break
    stream = chat_model.stream([HumanMessage(content=user_input)])
    for chunk in stream:
        print(chunk.content, end='', flush=True)
    print()
```

åœ¨è¿™æ®µä»£ç é‡Œï¼Œæˆ‘ä»¬å¾ªç¯åœ°ç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼Œå¦‚æœé‡åˆ°äº† exit å°±é€€å‡ºã€‚å…¶ä¸­é‡‡ç”¨å¤§æ¨¡å‹çš„å¤„ç†éƒ¨åˆ†æˆ‘ä»¬ä¹‹å‰éƒ½è®²è¿‡ï¼Œç†è§£èµ·æ¥åº”è¯¥ä¸å›°éš¾ã€‚

ä½ å¯ä»¥æŠŠè¿™æ®µä»£ç è¿è¡Œèµ·æ¥ï¼Œå’Œå®ƒèŠèŠã€‚ä¸è¿‡ï¼ŒèŠä¸Šå‡ å¥ä½ å°±ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼šå®ƒå®Œå…¨è®°ä¸ä½ä½ ä»¬èŠå¤©çš„ä¸Šä¸‹æ–‡ã€‚

```bash
You:> æˆ‘æ˜¯ dreamhead
ä½ å¥½ï¼ŒDreamheadï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼Ÿ
You:> æˆ‘æ˜¯è°ï¼Ÿ
ä½ æ˜¯æé—®è€…ï¼Œä½†æˆ‘æ— æ³•çŸ¥é“ä½ çš„å…·ä½“èº«ä»½ã€‚å¦‚æœä½ æ„¿æ„ï¼Œå¯ä»¥å‘Šè¯‰æˆ‘æ›´å¤šå…³äºä½ çš„ä¿¡æ¯ï¼
```

ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿå›å¿†ä¸€ä¸‹ OpenAI APIï¼Œå®ƒæ˜¯ä¸€ä¸ª HTTP è¯·æ±‚ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒHTTP è¯·æ±‚æœ€å¤§çš„ç‰¹ç‚¹æ˜¯æ— çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒæœåŠ¡ç«¯ä¸ä¼šä¿ç•™ä»»ä½•ä¼šè¯ä¿¡æ¯ã€‚å¯¹äºæ¯æ¬¡éƒ½å®Œæˆä¸€ä¸ªç‹¬ç«‹çš„ä»»åŠ¡ï¼Œæ— çŠ¶æ€æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ã€‚ä½†å¯¹èŠå¤©æœºå™¨äººæ¥è¯´ï¼Œå°±ä¼šå‡ºç°å¯¹ä¹‹å‰ä¼šè¯ä¸€æ— æ‰€çŸ¥çš„æƒ…å†µã€‚è¿™æ˜¾ç„¶æ— æ³•æ»¡è¶³æˆ‘ä»¬å¯¹ä¸€ä¸ªèŠå¤©æœºå™¨äººçš„åŸºæœ¬é¢„æœŸï¼Œæˆ‘ä»¬éœ€è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

## èƒ½è®°äº‹çš„èŠå¤©æœºå™¨äºº

æ—¢ç„¶ API æœ¬èº«æ— æ³•ä¿ç•™ä¼šè¯ä¿¡æ¯ï¼Œä¸€ç§å¸¸è§çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯æŠŠèŠå¤©å†å²å‘Šè¯‰å¤§æ¨¡å‹ï¼Œå¸®åŠ©å¤§æ¨¡å‹äº†è§£ä¹‹å‰çš„ä¼šè¯å†…å®¹ï¼Œä¹Ÿå°±æ˜¯ç»™å¤§æ¨¡å‹æä¾›ä¹‹å‰èŠå¤©çš„ä¸Šä¸‹æ–‡ã€‚è¿™æ ·ä»ç”¨æˆ·çš„è§‚æ„Ÿä¸Šçœ‹ï¼Œè¿™ä¸ªèŠå¤©æœºå™¨äººå°±èƒ½æŒ‰ç…§æˆ‘ä»¬ä¹‹å‰èŠå¤©çš„å†…å®¹æŒç»­å¯¹è¯ã€‚

æˆ‘ä»¬å½“ç„¶å¯ä»¥è‡ªå·±ç»´æŠ¤èŠå¤©å†å²ï¼Œåœ¨éœ€è¦çš„æ—¶å€™ï¼Œä¼ é€’ç»™å¤§æ¨¡å‹ï¼Œä½†è¿™ä¹ˆé€šç”¨çš„éœ€æ±‚ï¼ŒLangChain å·²ç»ä¸ºæˆ‘ä»¬å®ç°å¥½äº†ï¼Œä¸‹é¢å°±æ˜¯ä¸€ä¸ªä¾‹å­ï¼š

```python
from langchain_core.chat_history import BaseChatMessageHistory, InMemoryChatMessageHistory
from langchain_core.runnables import RunnableWithMessageHistory
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage

chat_model = ChatOpenAI(model="gpt-4o-mini")

store = {}

def get_session_history(session_id: str) -> BaseChatMessageHistory:
    if session_id not in store:
        store[session_id] = InMemoryChatMessageHistory()
    return store[session_id]

with_message_history = RunnableWithMessageHistory(chat_model, get_session_history)

config = {"configurable": {"session_id": "dreamhead"}}

while True:
    user_input = input("You:> ")
    if user_input.lower() == 'exit':
        break
    stream = with_message_history.stream(
        [HumanMessage(content=user_input)],
        config=config
    )
    for chunk in stream:
        print(chunk.content, end='', flush=True)
    print()
```

ä¸ºäº†æ”¯æŒèŠå¤©å†å²ï¼ŒLangChain å¼•å…¥äº†ä¸€ä¸ªæŠ½è±¡å« ChatMessageHistoryã€‚ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨äº† InMemoryChatMessageHistoryï¼Œä¹Ÿå°±æ˜¯åœ¨å†…å­˜å­˜æ”¾çš„èŠå¤©å†å²ã€‚æœ‰äº†èŠå¤©å†å²ï¼Œå°±éœ€è¦æŠŠèŠå¤©å†å²å’Œæ¨¡å‹ç»“åˆèµ·æ¥ï¼Œè¿™å°±æ˜¯ RunnableWithMessageHistory æ‰€èµ·çš„ä½œç”¨ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæŠŠèŠå¤©å†å²å’Œé“¾å°è£…åˆ°ä¸€èµ·çš„ä¸€ä¸ªç±»ã€‚

è¿™é‡Œçš„ Runnable æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªå·¥ä½œå•å…ƒã€‚æˆ‘ä»¬å‰é¢è¯´è¿‡ï¼Œç»„æˆé“¾æ˜¯ç”±ä¸€ä¸ªä¸€ä¸ªçš„ç»„ä»¶ç»„æˆçš„ã€‚ä¸¥æ ¼åœ°è¯´ï¼Œè¿™äº›ç»„ä»¶éƒ½å®ç°äº† Runnable æ¥å£ï¼Œç”šè‡³é“¾æœ¬èº«ä¹Ÿå®ç°äº† Runnable æ¥å£ï¼Œæˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„ invokeã€stream ç­‰æ¥å£éƒ½æ˜¯å®šä¹‰åœ¨ Runnable é‡Œï¼Œå¯ä»¥è¯´ï¼ŒRunnable æ˜¯çœŸæ­£çš„åŸºç¡€ç±»å‹ï¼Œ**LCEL ä¹‹æ‰€ä»¥èƒ½å¤Ÿä»¥å£°æ˜å¼çš„æ–¹å¼èµ·ä½œç”¨ï¼ŒRunnable æ¥å£æ˜¯å…³é”®ã€‚**

ä¸è¿‡ï¼Œåœ¨çœŸå®çš„ç¼–ç è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¾ˆå°‘ä¼šç›´æ¥é¢å¯¹ Runnableï¼Œå¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬çœ‹è§çš„éƒ½æ˜¯å„ç§å…·ä½“ç±»å‹ã€‚åªæ˜¯ä½ ä¼šåœ¨å¾ˆå¤šå…·ä½“ç±»çš„åå­—ä¸­è§åˆ° Runnableï¼Œè¿™é‡Œçš„ RunnableWithMessageHistory å°±æ˜¯å…¶ä¸­ä¸€ä¸ªã€‚

ä½ ä¼šå‘ç°æˆ‘ä»¬ä¼ ç»™ RunnableWithMessageHistory çš„å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„ `get_session_history`ï¼Œæ­£å¦‚å®ƒçš„åå­—æ‰€ç¤ºï¼Œå®ƒä¼šè·å–ä¼šè¯çš„å†å²ã€‚å¦‚æœæˆ‘ä»¬åœ¨å¼€å‘çš„æ˜¯ä¸€ä¸ªå¤šäººèŠå¤©çš„åº”ç”¨ï¼Œæ¯ä¸ªäººå°±æ˜¯ä¸€ä¸ªä¸åŒçš„ä¼šè¯ï¼Œåœ¨èŠå¤©æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è·å–åˆ°è‡ªå·±çš„èŠå¤©å†å²ã€‚åœ¨æˆ‘ä»¬è¿™ä¸ªå®ç°é‡Œï¼Œè·å–èŠå¤©å†å²çš„ä¾æ®æ˜¯ `session_id`ã€‚`get_session_history` çš„å®ç°å¾ˆç®€å•ï¼Œå¦‚æœä¸å­˜åœ¨è¿™ä¸ª session\_id å¯¹åº”çš„èŠå¤©å†å²ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„ï¼Œå¦‚æœå­˜åœ¨ï¼Œå°±è¿”å›å·²æœ‰çš„ã€‚

å…¶å®ƒçš„ä»£ç å¤§å¤šæ•°ä¸ä¹‹å‰ä¸€æ ·ï¼Œåªæ˜¯ç”¨å°è£…äº†èŠå¤©å†å²çš„å¯¹è±¡ï¼ˆ `with_message_history`ï¼‰ä»£æ›¿äº†ç›´æ¥çš„æ¨¡å‹ï¼Œå¦å¤–ï¼Œåœ¨è°ƒç”¨ `stream` æ—¶ï¼Œæˆ‘è¿˜ä¼ å…¥äº†ä¸€ä¸ªé…ç½®ï¼Œè¿™ä¸ªé…ç½®é‡Œå­˜æ”¾äº†ä¸€ä¸ª `session_id`ï¼Œå®ƒå°±ä¼šåœ¨è°ƒç”¨ `get_session_history` æ—¶ä½œä¸ºå‚æ•°ä¼ è¿‡å»ã€‚

æœ‰äº†èŠå¤©å†å²ï¼Œæˆ‘ä»¬å†å’Œè¿™ä¸ªèŠå¤©æœºå™¨äººèŠå¤©ï¼Œå®ƒçœ‹ä¸Šå»å°±æ­£å¸¸å¤šäº†ï¼š

```bash
You:> æˆ‘æ˜¯ dreamhead
ä½ å¥½ï¼Œdreamheadï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
You:> æˆ‘æ˜¯è°?
ä½ æ˜¯â€œdreamheadâ€ï¼Œè¿™æ˜¯ä½ åˆšåˆšå‘Šè¯‰æˆ‘çš„åå­—ã€‚å¦‚æœä½ æƒ³åˆ†äº«æ›´å¤šå…³äºè‡ªå·±æˆ–è€…ä½ çš„å…´è¶£çˆ±å¥½ï¼Œæˆ‘å¾ˆä¹æ„å¬ï¼
```

## è§’è‰²æ‰®æ¼”çš„èŠå¤©æœºå™¨äºº

ç°åœ¨æˆ‘ä»¬æ‹¥æœ‰äº†ä¸€ä¸ªèƒ½å’Œæˆ‘ä»¬æ­£å¸¸æ²Ÿé€šçš„èŠå¤©æœºå™¨äººï¼Œä½†è¿™ä¸ªèŠå¤©æœºå™¨äººæœ¬èº«å¹¶ä¸å…·å¤‡ä»»ä½•èƒ½åŠ›ã€‚ä½ åº”è¯¥çœ‹è¿‡è®© AI æ‰®æ¼”æŸä¸ªäººç‰©è§’è‰²ï¼Œåœ¨å¯¹è¯çš„å…¨è¿‡ç¨‹ä¸­ï¼Œå®ƒéƒ½ä¼šä»¥è¿™ä¸ªè§’è‰²çš„å£å»æ¥è¿›è¡Œå›å¤ï¼Œè€Œæ— éœ€æˆ‘ä»¬åšä»»ä½•é¢å¤–çš„è®¾ç½®ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥å®ç°è¿™æ ·ä¸€ä¸ªèŠå¤©æœºå™¨äººï¼Œåœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬å®ç°çš„æ˜¯ä¸€ä¸ª AI å­”å­ï¼š

```python
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage

chat_model = ChatOpenAI(model="gpt-4o-mini")

store = {}

def get_session_history(session_id: str) -> BaseChatMessageHistory:
    if session_id not in store:
        store[session_id] = InMemoryChatMessageHistory()
    return store[session_id]

prompt = ChatPromptTemplate.from_messages(
    [
        (
            "system",
            "ä½ ç°åœ¨æ‰®æ¼”å­”å­çš„è§’è‰²ï¼Œå°½é‡æŒ‰ç…§å­”å­çš„é£æ ¼å›å¤ï¼Œä¸è¦å‡ºç°â€˜å­æ›°â€™",
        ),
        MessagesPlaceholder(variable_name="messages"),
    ]
)

with_message_history = RunnableWithMessageHistory(
    prompt | chat_model,
    get_session_history
)

config = {"configurable": {"session_id": "dreamhead"}}


while True:
    user_input = input("You:> ")
    if user_input.lower() == 'exit':
        break
    stream = with_message_history.stream(
        {"messages": [HumanMessage(content=user_input)]},
        config=config
    )
    for chunk in stream:
        print(chunk.content, end='', flush=True)
    print()
```

å¦‚æœè®©èŠå¤©æœºå™¨äººå¯ä»¥æ‰®æ¼”ä¸€ä¸ªè§’è‰²ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯æˆ‘ä»¬æŠŠè®¾å®šå¥½çš„æç¤ºè¯æ¯æ¬¡éƒ½å‘é€ç»™å¤§æ¨¡å‹ï¼Œæ ¹æ®æˆ‘ä»¬ä¸Šä¸€è®²çš„å†…å®¹ï¼ŒæŠŠå›ºå®šçš„æç¤ºè¯å’Œç”¨æˆ·æ¯æ¬¡çš„è¾“å…¥åˆ†å¼€ï¼Œè¿™å°±æ˜¯æç¤ºè¯æ¨¡æ¿ï¼ˆPromptTemplateï¼‰å‘æŒ¥çš„ä½œç”¨ã€‚åœ¨è¿™ä¸ªä¾‹å­é‡Œé¢ï¼Œæˆ‘ä»¬å°±è®¾å®šäº†ä¸€ä¸ªæç¤ºè¯ï¼Œè®©èŠå¤©æœºå™¨äººèƒ½å¤Ÿæ‰®æ¼”å­”å­çš„è§’è‰²ï¼š

```python
prompt = ChatPromptTemplate.from_messages(
    [
        (
            "system",
            "ä½ ç°åœ¨æ‰®æ¼”å­”å­çš„è§’è‰²ï¼Œå°½é‡æŒ‰ç…§å­”å­çš„é£æ ¼å›å¤ï¼Œä¸è¦å‡ºç°â€˜å­æ›°â€™",
        ),
        MessagesPlaceholder(variable_name="messages"),
    ]
)
```

æˆ‘ä»¬åœ¨å‰é¢å·²ç»ä»‹ç»è¿‡æç¤ºè¯æ¨¡æ¿çš„ç”¨æ³•ï¼Œè¿™é‡Œæ–°å¢çš„å°±æ˜¯ MessagesPlaceholderï¼Œå®ƒæ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œå˜é‡åæ˜¯ `messages`ï¼Œå¯ä»¥æ›¿æ¢æˆä¸€ä¸ªæ¶ˆæ¯åˆ—è¡¨ã€‚ç›¸æ¯”äºå•ä¸ªå˜é‡ï¼Œæ¶ˆæ¯åˆ—è¡¨ç»™äº†ç”¨æˆ·æ›´å¤šçµæ´»å¤„ç†çš„ç©ºé—´ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ç»™æ¨¡å‹ä¼ é€’å‚æ•°çš„æ—¶å€™ï¼Œä¹Ÿä½¿ç”¨äº†æ¶ˆæ¯åˆ—è¡¨ï¼š

```python
 {"messages": [HumanMessage(content=user_input)]}
```

å¦å¤–ï¼Œç»„è£…é“¾çš„è¿‡ç¨‹æ˜¯æˆ‘ä»¬å…ˆæŠŠæç¤ºè¯æ¨¡æ¿å’Œæ¨¡å‹ç»„è£…æˆä¸€ä¸ªé“¾ï¼Œç„¶åï¼Œå†ç”¨ RunnableWithMessageHistory å»å°è£…å®ƒã€‚æ­£å¦‚æˆ‘å‰é¢æ‰€è¯´ï¼Œé“¾ä¹Ÿæ˜¯ä¸€ä¸ª Runnableã€‚

```python
with_message_history = RunnableWithMessageHistory(
    prompt | chat_model,
    get_session_history
)
```

ä¸‹é¢æ˜¯æˆ‘å’Œè¿™ä¸ªèŠå¤©æœºå™¨äººçš„ä¸€æ®µå¯¹è¯ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå®ƒå·²ç»èƒ½æŒ‰ç…§æˆ‘ä»¬çš„è®¾å®šå›ç­”ç›¸åº”çš„é—®é¢˜äº†ï¼š

```bash
You:> æˆ‘æ˜¯ dreamheadï¼Œæˆ‘ç°åœ¨æœ‰äº›è¿·èŒ«


è¿·èŒ«è€…ï¼Œå¿ƒä¸­è‹¥æœ‰ç–‘æƒ‘ï¼Œå®œé™å¿ƒæ€ä¹‹ã€‚äººç”Ÿå¦‚è¡Œè·¯ï¼Œå‰æ–¹è™½æœ‰æ›²æŠ˜ï¼Œç„¶è‹¥èƒ½æ˜ç¡®æ‰€æ±‚ï¼Œå¿…èƒ½æ‰¾åˆ°æ–¹å‘ã€‚å¯ä¸å‹äººäº¤æµï¼Œæˆ–äºä¹¦ä¸­å¯»æ™ºæ…§ï¼Œçš†å¯åŠ©äºæ˜ç†ã€‚åˆ‡è®°ï¼Œè¿·èŒ«ä¹ƒå¸¸æ€ï¼Œç„¶å‹¤æ€ä¸è¡Œä¹‹ï¼Œæ–¹å¯æ¸å…¥ä½³å¢ƒã€‚


You:> ä½ èƒ½å°±æˆ‘çš„æƒ…å†µï¼Œç»™æˆ‘å†™å‡ å¥è¯ä¹ˆï¼Œç§°å‘¼å°±å†™æˆ‘çš„åå­—


Dreamheadï¼Œäººç”Ÿä¹‹è·¯ï¼Œæœ‰æ—¶è¿·é›¾é‡é‡ï¼Œç„¶å¿ƒä¸­è‹¥æœ‰æ˜ç¯ï¼Œä¾¿æ— æƒ§å‰è¡Œã€‚å¯é™å¿ƒæ€è€ƒï¼Œé—®å·±æ‰€æ±‚ï¼Œäº¦å¯å€¾å¬ä»–äººä¹‹è§ï¼Œæ–¹èƒ½æ‹¨äº‘è§æ—¥ã€‚æ„¿ä½ åœ¨æ¢ç´¢ä¸­ï¼Œæ¸æ‚Ÿè‡ªæˆ‘ï¼Œæ˜äº®æœªæ¥ã€‚
```

åœ¨å®ç°èŠå¤©æœºå™¨äººçš„è¿‡ç¨‹ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªå¾ˆç°å®çš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†ä¸€ä¸‹ã€‚å¦‚æœä¸åŠ ä»»ä½•é™åˆ¶ï¼Œæ‰€æœ‰çš„èŠå¤©å†å²éƒ½ä¼šé™„åŠ åˆ°æ–°çš„ä¼šè¯ä¸­ï¼Œéšç€èŠå¤©çš„è¿›è¡Œï¼ŒèŠå¤©å†å²å¾ˆå¿«å°±ä¼šè¶…è¿‡å¤§æ¨¡å‹çš„ä¸Šä¸‹æ–‡çª—å£å¤§å°ã€‚ä¸€ç§å…¸å‹å¤„ç†åŠæ³•æ˜¯ï¼Œå¯¹èŠå¤©å†å²è¿›è¡Œé™åˆ¶ã€‚

LangChain æä¾›äº†ä¸€ä¸ª `trim_messages` ç”¨æ¥æ§åˆ¶æ¶ˆæ¯çš„è§„æ¨¡ï¼Œå®ƒæä¾›äº†å¾ˆå¤šæ§åˆ¶æ¶ˆæ¯è§„æ¨¡çš„å‚æ•°ï¼š

- max\_tokensï¼Œé™åˆ¶æœ€å¤§çš„ Token æ•°é‡ã€‚
- strategyï¼Œé™åˆ¶çš„ç­–ç•¥ï¼Œä»å‰é¢ä¿ç•™ï¼ˆfirstï¼‰ï¼Œè¿˜æ˜¯ä»åé¢ä¿ç•™ï¼ˆlastï¼‰ã€‚
- allow\_partialï¼Œæ˜¯å¦å…è®¸æŠŠæ‹†åˆ†æ¶ˆæ¯ã€‚
- include\_systemï¼Œæ˜¯å¦è¦ä¿ç•™æœ€å¼€å§‹çš„ç³»ç»Ÿæç¤ºè¯ã€‚

è¿™å…¶ä¸­æœ€å…³é”®çš„æ˜¯å°±æ˜¯**max\_tokens**ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é™åˆ¶æ¶ˆæ¯è§„æ¨¡çš„ä¸»è¦åŸå› ã€‚ä¸è¿‡ï¼Œè¿™é‡Œæ˜¯æŒ‰ç…§ Token è¿›è¡Œè®¡ç®—ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆè®¡ç®— Token å‘¢ï¼Ÿå¯¹ OpenAI API æ¥è¯´ï¼Œä¸€ç§å¸¸è§çš„è§£å†³æ–¹æ¡ˆæ˜¯é‡‡ç”¨ tiktokenï¼Œè¿™æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨æ¥å¤„ç†çš„ Token çš„ç¨‹åºåº“ã€‚ä¸‹é¢æ˜¯é‡‡ç”¨äº† tiktoken çš„è®¡ç®— Token çš„å®ç°ï¼š

```python
from typing import List
import tiktoken
from langchain_core.messages import SystemMessage, trim_messages, BaseMessage, HumanMessage, AIMessage, ToolMessage

def str_token_counter(text: str) -> int:
    enc = tiktoken.get_encoding("o200k_base")
    return len(enc.encode(text))

def tiktoken_counter(messages: List[BaseMessage]) -> int:
    num_tokens = 3
    tokens_per_message = 3
    tokens_per_name = 1
    for msg in messages:
        if isinstance(msg, HumanMessage):
            role = "user"
        elif isinstance(msg, AIMessage):
            role = "assistant"
        elif isinstance(msg, ToolMessage):
            role = "tool"
        elif isinstance(msg, SystemMessage):
            role = "system"
        else:
            raise ValueError(f"Unsupported messages type {msg.__class__}")
        num_tokens += (
                tokens_per_message
                + str_token_counter(role)
                + str_token_counter(msg.content)
        )
        if msg.name:
            num_tokens += tokens_per_name + str_token_counter(msg.name)
    return num_tokens
```

æœ‰äº†è¿™äº›åŸºç¡€ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ”¹é€ ä¸€ä¸‹è§’è‰²æ‰®æ¼”æœºå™¨äººï¼š

```python
from langchain_core.messages import trim_messages

trimmer = trim_messages(
    max_tokens=4096,
    strategy="last",
    token_counter=tiktoken_counter,
    include_system=True,
)

with_message_history = RunnableWithMessageHistory(
    trimmer | prompt | chat_model,
    get_session_history
)
```

åœ¨è¿™é‡Œï¼Œ`trim_messages` è®¾ç½®äº†æœ€å¤§ Token æ•°ï¼ˆmax\_tokens=4096ï¼‰ï¼Œä»åé¢ä¿ç•™æ¶ˆæ¯ï¼ˆstrategy=â€œlastâ€ï¼‰ï¼ŒToken è®¡æ•°æ–¹å¼è®¾ç½®æˆæˆ‘ä»¬å‰é¢ç¼–å†™çš„ `tiktoken_counter`ã€‚å¦å¤–ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯è§’è‰²æ‰®æ¼”çš„èŠå¤©æœºå™¨äººï¼Œç¬¬ä¸€å¥çš„ç³»ç»Ÿæ¶ˆæ¯å°±æ˜¯è§’è‰²è®¾ç½®ï¼Œæˆ‘ä»¬é€‰æ‹©ä¿ç•™å®ƒï¼ˆinclude\_system=Trueï¼‰ã€‚

`trim_messages` çš„å‚æ•°å¦‚æœæœ‰æ¶ˆæ¯ï¼Œå®ƒä¼šç›´æ¥æŒ‰ç…§è§„åˆ™å¤„ç†æ¶ˆæ¯ï¼Œå¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œå®ƒå°±ä¼šç”Ÿæˆä¸€ä¸ªç”¨æ¥å¤„ç†æ¶ˆæ¯çš„ç»„ä»¶ã€‚åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬åªè®¾ç½®äº†å¤„ç†è§„åˆ™ï¼Œæ‰€ä»¥ï¼Œå®ƒå°±ç”Ÿæˆäº†ä¸€ä¸ªå¤„ç†æ¶ˆæ¯çš„ç»„ä»¶ï¼Œæˆ‘ä»¬æŠŠå®ƒä¸²åˆ°æˆ‘ä»¬çš„é“¾é‡Œï¼š

```python
trimmer | prompt | chat_model
```

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»æ‹¥æœ‰äº†ä¸€ä¸ªå¯ä»¥æ­£å¸¸è¿è¡Œçš„èŠå¤©æœºå™¨äººäº†ï¼Œä½ å¯ä»¥å’Œå®ƒå¥½å¥½èŠèŠäº†ï¼

## æ€»ç»“æ—¶åˆ»

è¿™ä¸€è®²ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªå‘½ä»¤è¡Œç‰ˆçš„èŠå¤©æœºå™¨äººã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ ChatMessageHistory ç®¡ç†èŠå¤©å†å²ï¼Œç„¶åç”¨ RunnableWithMessageHistory æŠŠå®ƒå’Œæˆ‘ä»¬ç¼–å†™çš„é“¾ç»“åˆèµ·æ¥ã€‚

æˆ‘ä»¬è¿˜å®ç°äº†ä¸€ä¸ªè§’è‰²æ‰®æ¼”ç±»çš„èŠå¤©æœºå™¨äººï¼Œå…³é”®ç‚¹å°±æ˜¯å°†æç¤ºè¯æ¨¡æ¿ï¼ˆPromptTemplateï¼‰ç»“åˆè¿›æ¥ã€‚åœ¨å®é™…çš„ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é™åˆ¶ä¼ ç»™å¤§æ¨¡å‹çš„æ¶ˆæ¯è§„æ¨¡ï¼Œé€šè¿‡ `trim_messages` å°±å¯ä»¥å®Œæˆé™åˆ¶æ¶ˆæ¯è§„æ¨¡çš„ä»»åŠ¡ã€‚

å¦‚æœä»Šå¤©çš„å†…å®¹ä½ åªèƒ½è®°ä½ä¸€ä»¶äº‹ï¼Œé‚£è¯·è®°ä½ï¼Œ**å®ç°ä¸€ä¸ªèŠå¤©æœºå™¨äººçš„å…³é”®ç‚¹å°±æ˜¯ç®¡ç†å¥½èŠå¤©å†å²**ã€‚

## ç»ƒä¹ é¢˜

è¿™ä¸€è®²æˆ‘ä»¬çš„èŠå¤©æœºå™¨äººç”¨äº† InMemoryChatMessageHistoryï¼ŒæŠŠèŠå¤©å†å²å­˜æ”¾åˆ°å†…å­˜ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡é‡å¯å°±ç›¸å½“äºå…¨æ–°çš„èŠå¤©æœºå™¨äººã€‚æˆ‘å¸Œæœ›ä½ èƒ½æŠŠå®ƒæ”¹é€ æˆä¸€ä¸ªå¯ä»¥æŒä¹…åŒ–çš„èŠå¤©å†å²ï¼Œè®©å®ƒå˜å¾—æ›´åŠ å®ç”¨ï¼Œæ¬¢è¿ä½ æŠŠæ”¹é€ çš„å¿ƒå¾—åˆ†äº«åœ¨ç•™è¨€åŒºã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ13ï¼‰</strong></div><ul>
<li><span>æ™´å¤©äº†</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä¸ªäººç†è§£çš„ç»“æ„

å¤§æ¨¡å‹è¿”å›çš„æ¶ˆæ¯ =  å†å²è¿è¡Œå™¨(å¤§æ¨¡å‹,  å†å²å­˜å‚¨é€»è¾‘).è°ƒç”¨( [äººç±»æ¶ˆæ¯], äººç±»ä¼šè¯æ ‡è¯†).</p>2024-11-21</li><br/><li><span>Geek_682837</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è¿™é‡Œlangchainçš„ç‰ˆæœ¬æ˜¯å¤šå°‘ï¼Ÿç”¨kimiçš„Moonshoté‡åˆ°è¿™ä¸ªé”™äº†ï¼ŒError in RootListenersTracer.on_llm_end callback: KeyError(&#39;message&#39;)ï¼Œæ€ä¹ˆè§£å†³ï¼Ÿ</p>2024-11-26</li><br/><li><span>Williamleelol</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>trimmer | prompt | chat_model è¿™ä¸ªé¡ºåºæ˜¯å›ºå®šçš„ä¹ˆï¼Œè¯•äº†ä¸‹è°ƒæ•´é¡ºåºä¼šæŠ¥é”™ï¼Œæœ‰ä»€ä¹ˆè§„åˆ™ä¹ˆï¼Ÿ</p>2025-01-24</li><br/><li><span>swift</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯·é—®æ‰®æ¼”å­”å­çš„é‚£ä¸ªä¾‹å­ä¸­çš„æç¤ºè¯æ¨¡æ¿çš„ç”¨æ³•ï¼Œsystem è¿™ä¸ªè§’è‰²çš„æç¤ºè¯ä¹Ÿä¼šåœ¨æ¯ä¸€è½®ç”¨æˆ·è¾“å…¥çš„æ—¶å€™é‡å¤ï¼Œè¿˜æ˜¯åªæœ‰ç¬¬ä¸€è½®æ—¶å€™ä¼šå‘é€ç»™å¤§æ¨¡å‹ï¼Ÿ</p>2025-01-16</li><br/><li><span>poettian</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ¯”è¾ƒå¥½å¥‡langchainæä¾›çš„è¿™ä¹ˆå¤šapiï¼Œæ€ä¹ˆå»è®°ä½å‘¢ï¼Ÿåˆšå¼€å§‹ä½¿ç”¨ï¼Œæœ‰ç‚¹çœ¼èŠ±ç¼­ä¹±çš„æ„Ÿè§‰</p>2025-01-16</li><br/><li><span>mgs2002</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é—®ä¸‹è€å¸ˆï¼Œè¯¾ç¨‹é‡Œé¢çš„ä»£ç æ˜¯æ€æ ·è¿è¡Œèµ·æ¥çœ‹æ•ˆæœçš„ï¼Œç”¨LangGraph Studioè¿™ä¸ªIDEå—</p>2025-01-09</li><br/><li><span>æ™´å¤©äº†</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>langchain ç”¨golangç‰ˆæœ¬ä¹Ÿæ²¡å…³ç³»å§ å’Œæ•™ç¨‹ä¸å†²çªå§

https:&#47;&#47;github.com&#47;tmc&#47;langchaingo</p>2024-11-20</li><br/><li><span>willmyc</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è€å¸ˆï¼Œä½ å¥½ï¼ç¬¬ä¸‰æ®µä»£ç ä¸­å¥½åƒè¿˜éœ€è¦å¯¼å…¥å¦‚ä¸‹çš„åŒ…æ‰èƒ½æ­£å¸¸è¿è¡Œï¼šfrom langchain.prompts import ChatPromptTemplate, MessagesPlaceholder</p>2024-11-21</li><br/><li><span>å¼ ç”³å‚²</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ç¬¬9è®²æ‰“å¡~
ä½¿ç”¨æŒä¹…åŒ–çš„æ–¹å¼ä¿å­˜å†å²æ¶ˆæ¯ï¼Œå…³é”®å°±æ˜¯å°†Historyç»„ä»¶æ›¿æ¢æˆ`FileChatMessageHistory`ã€‚
å…·ä½“ä»£ç ï¼šhttps:&#47;&#47;gitee.com&#47;zhangshenao&#47;happy-llm&#47;blob&#47;master&#47;%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84AI%E5%BC%80%E5%8F%91%E7%AC%AC%E4%B8%80%E8%AF%BE&#47;4.%E8%A7%92%E8%89%B2%E6%89%AE%E6%BC%94%E8%81%8A%E5%A4%A9%E6%9C%BA%E5%99%A8%E4%BA%BA.py</p>2025-01-17</li><br/><li><span>R</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æˆ‘æœ‰ä¸ªç–‘é—®ï¼Œæ—¢ç„¶èƒ½è®°ä½ä¸Šä¸‹æ–‡ï¼Œä¸ºä»€ä¹ˆæ¯æ¬¡æé—®è¿˜è¦æ’å…¥è§’è‰²ï¼Œ å¸¦ç€è¿™ä¸ªç–‘é—®ï¼Œç»§ç»­å¾€ä¸‹å­¦ä¹ </p>2025-02-21</li><br/><li><span>Geek_8cf9dd</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>èŠå¤©æœºå™¨äººçš„å†å²ä¼šè¯å­˜å†…å­˜å®¹æ˜“ä¸¢å¤±ï¼Œæ”¾dbä¸­å­˜æ”¾ä¼šæ›´å¥½äº›å§</p>2025-02-16</li><br/><li><span>MClink</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>openai.NotFoundError: Error code: 404 - {&#39;error&#39;: {&#39;type&#39;: &#39;invalid_request_error&#39;, &#39;code&#39;: &#39;unknown_url&#39;, &#39;message&#39;: &#39;Unknown request URL: POST &#47;chat&#47;completions. Please check the URL for typos, or see the docs at https:&#47;&#47;platform.openai.com&#47;docs&#47;api-reference&#47;.&#39;, &#39;param&#39;: None}}. åŸŸåæ˜¯ä¸æ˜¯è¦é…ç½®ã€‚</p>2025-01-09</li><br/><li><span>Demon.Lee</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>1ã€èŠå¤©æœºå™¨äººï¼šä¸Šä¸‹æ–‡å†…å®¹ï¼ˆå†å²èŠå¤©è®°å½•ï¼‰ï¼Œè§’è‰²ï¼Œä¸Šä¸‹æ–‡å¤§å°ï¼ˆæˆæœ¬ï¼‰ï¼›
2ã€äº†è§£åˆ°å¦ä¸€ç§æ§åˆ¶ä¸Šä¸‹æ–‡çª—å£å¤§å°çš„æ–¹å¼æ˜¯å¯¹å†å²è®°å½•è¿›è¡Œæ‘˜è¦ï¼›
3ã€LCEL çœŸæ˜¯å¤ªæ£’äº†ï¼ŒæŠ½è±¡å‡ºä¸€ä¸ªä¸ªæ¥å£ï¼Œå†ä½¿ç”¨å£°æ˜å¼ç¼–ç¨‹ï¼ŒçœŸæ˜¯ç¼–ç¨‹çš„è‰ºæœ¯ï¼›
4ã€ç¬¬4ç‚¹æ˜¯å•¥æ¥ç€ï¼Œæˆ‘ç»™å¿˜äº†â€¦â€¦</p>2025-01-06</li><br/>
</ul>