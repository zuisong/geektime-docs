ä½ å¥½ï¼Œæˆ‘æ˜¯å¾æ–‡æµ©ã€‚

ä¸çŸ¥é“è¯¾ç¨‹ä¸Šåˆ°è¿™é‡Œï¼Œä½ è´¦æˆ·é‡Œå…è´¹çš„5ç¾å…ƒçš„é¢åº¦è¿˜å‰©ä¸‹å¤šå°‘äº†ï¼Ÿå¦‚æœä½ å°è¯•ç€å®Œæˆæˆ‘ç»™çš„å‡ ä¸ªæ•°æ®é›†é‡Œçš„æ€è€ƒé¢˜ï¼Œç›¸ä¿¡è¿™ä¸ªé¢åº¦åº”è¯¥æ˜¯ä¸å¤ªå¤Ÿç”¨çš„ã€‚è€ŒChatCompletionçš„æ¥å£ï¼Œåˆéœ€è¦ä¼ å…¥å¤§é‡çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå®é™…æ¶ˆè€—çš„Tokenæ•°é‡å…¶å®æ¯”æˆ‘ä»¬æ„Ÿè§‰çš„è¦å¤šã€‚

è€Œä¸”ï¼Œé™¤äº†è´¹ç”¨ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯æ•°æ®å®‰å…¨ã€‚å› ä¸ºæ¯ä¸ªå›½å®¶çš„æ•°æ®ç›‘ç®¡è¦æ±‚ä¸åŒï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„æ•°æ®ï¼Œéƒ½é€‚åˆé€šè¿‡OpenAIçš„APIæ¥å¤„ç†çš„ã€‚æ‰€ä»¥ï¼Œä»è¿™ä¸¤ä¸ªè§’åº¦å‡ºå‘ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªOpenAIä»¥å¤–çš„è§£å†³æ–¹æ¡ˆã€‚é‚£å¯¹äºæ²¡æœ‰è¶³å¤ŸæŠ€æœ¯å‚¨å¤‡çš„ä¸­å°å‹å…¬å¸æ¥è¯´ï¼Œæœ€å¯è¡Œçš„ä¸€ä¸ªæ€è·¯å°±æ˜¯åˆ©ç”¨å¥½å¼€æºçš„å¤§è¯­è¨€æ¨¡å‹ã€‚

## åœ¨Colabé‡Œä½¿ç”¨GPU

å› ä¸ºè¿™ä¸€è®²æˆ‘ä»¬è¦ä½¿ç”¨ä¸€äº›å¼€æºæ¨¡å‹ï¼Œä½†ä¸æ˜¯æ‰€æœ‰äººçš„ç”µè„‘é‡Œéƒ½æœ‰ä¸€ä¸ªå¼ºåŠ²çš„NVidia GPUçš„ã€‚æ‰€ä»¥ï¼Œæˆ‘å»ºè®®ä½ é€šè¿‡Colabæ¥è¿è¡Œå¯¹åº”çš„Notebookï¼Œå¹¶ä¸”æ³¨æ„ï¼Œè¦æŠŠå¯¹åº”çš„è¿è¡Œç¯å¢ƒè®¾ç½®æˆGPUã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/1c/21/1c0791bd5c1e088eeb527f2acb81a021.png?wh=1255x584)

1. ä½ å…ˆé€‰æ‹©èœå•æ é‡Œçš„Runtimeï¼Œç„¶åç‚¹å‡»Change runtime typeã€‚

<!--THE END-->

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/50/23/502a4baceab267e949957c6477bc5823.png?wh=1257x489)

2. ç„¶ååœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†é‡Œï¼ŒæŠŠHardware acceleratoræ¢æˆGPUï¼Œç„¶åç‚¹å‡»Saveå°±å¯ä»¥äº†ã€‚

åªè¦ç”¨å¾—ä¸æ˜¯å¤ªå¤šï¼ŒColabçš„GPUæ˜¯å¯ä»¥å…è´¹ä½¿ç”¨çš„ã€‚

## HuggingfaceEmbeddingï¼Œä½ çš„å¼€æºä¼™ä¼´
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ30ï¼‰</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/30/ef/2d/757bb0d3.jpg" width="30px"><span>Toni</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>åœ¨ç¬¬äºŒè®²ä¸­ï¼Œç”¨äºšé©¬é€Šæä¾›çš„ç”¨æˆ·å¯¹ä¸€äº›é£Ÿç‰©è¯„ä»·çš„çœŸå®æ•°æ®é›†è¿›è¡Œäº†æƒ…æ„Ÿåˆ†æã€‚å½“æ—¶ä¸ºäº†é¿å…é‡æ–°è°ƒç”¨ OpenAI çš„ API æµªè´¹é’±ï¼Œè€å¸ˆæ¨èä½¿ç”¨å·²ç»è®¡ç®—å¥½çš„å«æœ‰ Embedding çš„æ•°æ®ã€‚ç”¨openai.embeddings_utils ä¸­çš„ get_embedding (EMBEDDING_MODEL = &quot;text-embedding-ada-002&quot;)ä¸ä»…è´¹é’±è¿˜è€—æ—¶ã€‚æˆ‘è¯•ç€è·‘è¿‡100ä¸ªæ•°æ®ï¼Œå¥½åƒç”¨äº†20åˆ†é’Ÿï¼ŒèŠ±è´¹ä¹Ÿä¸å°‘ã€‚

æœ¬èŠ‚è¯¾ä¸­è€å¸ˆä»‹ç»äº†å…è´¹çš„ sentence_transformers æ­£å¥½å¯ä»¥æ‹¿æ¥ç”¨åœ¨æƒ…æ„Ÿæ•°æ®åˆ†æä¸Šï¼Œ
é€‰ç”¨ model = SentenceTransformer(&#39;paraphrase-multilingual-mpnet-base-v2&#39;)ã€‚åŒæ ·è®¡ç®—1000ä¸ªæ•°æ®çš„ embeddingï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œä¸”æ— è´¹ç”¨ï¼Œé€‚åˆç»ƒæ‰‹ã€‚

æµ‹è¯•ç»“æœå¦‚ä¸‹:
                     precision    recall  f1-score   support
        negative      0.77      0.78      0.77       148
         positive      0.96      0.95      0.96       773
       accuracy                               0.93       921
    macro avg       0.86      0.87      0.86       921
weighted avg       0.93      0.93      0.93       921

ä¸ºäº†å¯¹æ¯”ï¼Œå°†ç¬¬äºŒè®²ä¸­è€å¸ˆç”¨ OpenAI çš„æ–¹æ³•å¾—åˆ°çš„ç»“æœæ”¾åœ¨äº†è¿™é‡Œ:

                    precision    recall  f1-score   support
        negative      0.98      0.73      0.84       136
         positive      0.96      1.00      0.98       789
       accuracy                               0.96       925
    macro avg       0.97      0.86      0.91       925
weighted avg       0.96      0.96      0.96       925

ä½¿ç”¨çš„æ–¹æ³•ä¸ç”¨ï¼Œç»“æœä¹Ÿä¸åŒã€‚OpenAI çš„å‡†ç¡®ç‡æ›´é«˜ã€‚</div>2023-04-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f5/80/baddf03b.jpg" width="30px"><span>zhihai.tu</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œæƒ³è¯·æ•™ä¸€ä¸‹ï¼Œæˆ‘å‘ç°æˆ‘ç”¨colabè·‘äº†ç¨‹åºï¼Œå¦‚æœç¬¬äºŒå¤©å†æ‰“å¼€è¿™ä¸ªç¨‹åºï¼Œç›¸åº”çš„å·²ç»è·‘è¿‡å¾—è„šæœ¬ï¼Œæ•ˆæœéƒ½å¤±æ•ˆäº†ï¼Œæ¯”å¦‚pipå®‰è£…è¿‡çš„éƒ½è¿˜åŸäº†ï¼Œå¦å¤–ç£ç›˜ç›®å½•ä¸Šç”Ÿæˆçš„æ–‡ä»¶å¤¹å’Œæ–‡ä»¶ä¹Ÿæ²¡äº†ã€‚æƒ³è¯·é—®ä¸‹å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿä¸ç„¶ç›¸å½“çš„éº»çƒ¦ã€‚è°¢è°¢ã€‚</div>2023-04-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/ac/62/37912d51.jpg" width="30px"><span>ä¸œæ–¹å¥‡éª¥</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>è€å¸ˆï¼Œæ˜¯ä¸æ˜¯è¦4080æ˜¾å¡æ‰è·‘å¾—åŠ¨ï¼Ÿå•æœºèƒ½è·‘å¾—åŠ¨å—</div>2023-04-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/24/c1/32/778f18b9.jpg" width="30px"><span>èƒ–å­</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ5ï¼‰<div>AttributeError                            Traceback (most recent call last)
&lt;ipython-input-54-086bfff09511&gt; in &lt;cell line: 8&gt;()
      6 Q: ä½ ä»¬çš„é€€è´§æ”¿ç­–æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ
      7 &quot;&quot;&quot;
----&gt; 8 response, history = model.chat(tokenizer, question, history=[])
      9 print(response)

21 frames
&#47;usr&#47;local&#47;lib&#47;python3.9&#47;dist-packages&#47;google&#47;protobuf&#47;unknown_fields.py in &lt;module&gt;
     42 from google.protobuf.internal import api_implementation
     43 
---&gt; 44 if api_implementation._c_module is not None:  # pylint: disable=protected-access
     45   UnknownFieldSet = api_implementation._c_module.UnknownFieldSet  # pylint: disable=protected-access
     46 else:

AttributeError: module &#39;google.protobuf.internal.api_implementation&#39; has no attribute &#39;_c_module&#39;


æä¸å®š</div>2023-04-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/36/9e/2e/e46ab171.jpg" width="30px"><span>å·æœˆ</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>ä½¿ç”¨è¿™ä¸ªå¼€æºæ¨¡å‹è·å–çš„indexæ€ä¹ˆä¿å­˜å•Šï¼Œä½¿ç”¨ä¹‹å‰çš„æ–¹æ³•å¹¶ä¸è¡Œï¼Œè¿˜æœ‰ç”Ÿæˆçš„indexå¯ä»¥è¿½åŠ å—ï¼Œä¸ç„¶æ¯æ¬¡æœ‰æ–°æ•°æ®çš„æ—¶å€™éƒ½è¦é‡æ–°è·‘ä¸€è¾¹ï¼Œæˆ–è€…å¯ä»¥ä½¿ç”¨æ•°æ®åº“å­˜å‚¨å—ï¼Œå¸Œæœ›è€å¸ˆè®²è§£ä¸€ä¸‹</div>2023-04-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2d/ec/19/38511eaf.jpg" width="30px"><span>à¼ºáƒ¦å¤©å£Â²ÂºÂ²Â²áƒ¦à¼»</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼ŒFAQæ•°æ®åœ¨å“ªé‡Œï¼Ÿ</div>2023-05-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/f5/99/5bf198e3.jpg" width="30px"><span>å­Ÿå¥</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>Metaæœ€è¿‘ä¹Ÿå¼€æºäº†å¤§è¯­è¨€æ¨¡å‹ï¼Œå¥½åƒæ›´å¥½ä¸€äº›ï¼Ÿ</div>2023-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/9d/2a/3e57b54a.jpg" width="30px"><span>åœ°å¹³çº¿</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>ç”±äºllama-index å‡çº§ï¼Œæˆ‘ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯0.6.8ï¼Œä¿®æ”¹äº†llama-indexä»£ç ï¼Œç¨‹åºè¿è¡Œæ²¡æœ‰æŠ¥é”™ï¼Œä½†æ˜¯æ²¡æœ‰è¾“å‡ºå†…å®¹

from langchain.text_splitter import SpacyTextSplitter

llm_predictor = LLMPredictor(llm=CustomLLM())

text_splitter = CharacterTextSplitter(separator=&quot;\n\n&quot;, chunk_size=100, chunk_overlap=20)
parser = SimpleNodeParser(text_splitter=text_splitter)
documents = SimpleDirectoryReader(&#39;.&#47;drive&#47;MyDrive&#47;colab_data&#47;faq&#47;&#39;).load_data()
nodes = parser.get_nodes_from_documents(documents)

embed_model = LangchainEmbedding(HuggingFaceEmbeddings(
    model_name=&quot;sentence-transformers&#47;paraphrase-multilingual-mpnet-base-v2&quot;
))
service_context = ServiceContext.from_defaults(embed_model=embed_model, llm_predictor=llm_predictor)

dimension = 768
faiss_index = faiss.IndexFlatIP(dimension)

# index = GPTListIndex(nodes=nodes, faiss_index=faiss_index, service_context=service_context)
index = GPTListIndex(nodes=nodes, service_context=service_context)

from llama_index import QuestionAnswerPrompt

QA_PROMPT_TMPL = (
    &quot;{context_str}&quot;
    &quot;\n\n&quot;
    &quot;æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œè¯·å›ç­”ä¸‹é¢çš„é—®é¢˜ï¼š\n&quot;
    &quot;Q: {query_str}\n&quot;
    )
QA_PROMPT = QuestionAnswerPrompt(QA_PROMPT_TMPL)

query_engine = index.as_query_engine(
    retriever_mode=&quot;embedding&quot;, 
    verbose=True, 
    text_qa_template=QA_PROMPT,
)
response = query_engine.query(&quot;è¯·é—®ä½ ä»¬æµ·å—èƒ½å‘è´§å—ï¼Ÿ&quot;)
print(response)</div>2023-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/22/65/a2/88aca8f7.jpg" width="30px"><span>èŒ¶æ¡</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œâ€œGPTFaissIndexâ€è¿™ä¸ªæ–¹æ³•ä¼¼ä¹æ²¡æœ‰äº†ï¼Œæ›¿æ¢çš„å…¶ä»–æ–¹æ³•ä¸çŸ¥é“æ˜¯ä»€ä¹ˆï¼Œæ€ä¹ˆç”¨ã€‚</div>2023-05-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/37/42/33/13b19797.jpg" width="30px"><span>horn</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ColabæŠ¥é”™æ€ä¹ˆå›äº‹å‘¢
ImportError: cannot import name &#39;GPTFaissIndex&#39; from &#39;llama_index&#39; (&#47;usr&#47;local&#47;lib&#47;python3.10&#47;dist-packages&#47;llama_index&#47;__init__.py)</div>2023-05-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/e4/8b/8a0a6c86.jpg" width="30px"><span>haha</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>PaLM2å‘¢ï¼Œä»Šå¤©è¢«å…¬ä¼—å·åˆ·å±äº†</div>2023-05-11</li><br/><li><img src="" width="30px"><span>Geek_9znsx3</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>åœ¨colabè¿è¡Œ11_colab_chatglm_opensource.ipynbï¼Œå®‰è£…pythonåŒ…æ—¶æŠ¥é”™ï¼ŒprotobufåŒ…ç‰ˆæœ¬å†²çªï¼Œè¯·é—®è¿™ä¸ªæ€ä¹ˆè§£å†³ï¼Ÿä»æŠ¥é”™ä¿¡æ¯çœ‹æ˜¯ç”±äºtensorflow-2.12.0ä¾èµ–protobuf3.20.3ï¼Œä½†æ˜¯icetk-0.0.7ä¾èµ– protobuf-3.18.3
Installing collected packages: protobuf, icetk
  Attempting uninstall: protobuf
    Found existing installation: protobuf 3.20.3
    Uninstalling protobuf-3.20.3:
      Successfully uninstalled protobuf-3.20.3
ERROR: pip&#39;s dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.
........
tensorflow 2.12.0 requires protobuf!=4.21.0,!=4.21.1,!=4.21.2,!=4.21.3,!=4.21.4,!=4.21.5,&lt;5.0.0dev,&gt;=3.20.3, but you have protobuf 3.18.3 which is incompatible.
tensorflow-datasets 4.9.2 requires protobuf&gt;=3.20, but you have protobuf 3.18.3 which is incompatible.
tensorflow-hub 0.13.0 requires protobuf&gt;=3.19.6, but you have protobuf 3.18.3 which is incompatible.
tensorflow-metadata 1.13.1 requires protobuf&lt;5,&gt;=3.20.3, but you have protobuf 3.18.3 which is incompatible.
Successfully installed icetk-0.0.7 protobuf-3.18.3</div>2023-05-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5a/82/4d55f0b7.jpg" width="30px"><span>ææ–‡é¾™</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>è¯·é—®ä½¿ç”¨ llama_index 0.6.1 ç‰ˆæœ¬ï¼Œä½¿ç”¨ Faissï¼Œä»£ç å¦‚ä¸‹ï¼Œæœ‰æŠ¥é”™ã€‚
import faiss
from llama_index.vector_stores import FaissVectorStore
from llama_index import GPTVectorStoreIndex, StorageContext

dimension = 768
faiss_index = faiss.IndexFlatIP(dimension)
storage_context = StorageContext.from_defaults(
    vector_store=FaissVectorStore(faiss_index)
)
print(len(nodes))
index = GPTVectorStoreIndex(nodes, storage_context=storage_context)

query_engine = index.as_query_engine(
    retriever_mode=&quot;embedding&quot;,
    verbose=True,
    service_context = service_context,
)

æŠ¥é”™ï¼š
&#47;usr&#47;local&#47;lib&#47;python3.10&#47;dist-packages&#47;faiss&#47;__init__.py in replacement_add(self, x)
    212 
    213         n, d = x.shape
--&gt; 214         assert d == self.d
    215         self.add_c(n, swig_ptr(x))
    216 </div>2023-05-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/36/82/5b/df97e03c.jpg" width="30px"><span>Santiago</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<div>è€å¸ˆæˆ‘æƒ³é—®ä¸€ä¸‹ æˆ‘ç”¨colabæŠ¥é”™ 
KeyError: &#39;-1&#39;
è¿™æ˜¯å’‹å›äº‹å‘€ï¼Œè¿˜æœ‰å°±æ˜¯æˆ‘ç”¨3060çš„æ˜¾å¡6Gï¼Œç›´æ¥çˆ†æ˜¾å­˜äº†</div>2023-04-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/36/82/5b/df97e03c.jpg" width="30px"><span>Santiago</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>RuntimeError: Failed to import transformers.models.t5.configuration_t5 because of the following error (look up to see its traceback):
Failed to import transformers.onnx.config because of the following error (look up to see its traceback):
DLL load failed while importing _imaging: æ‰¾ä¸åˆ°æŒ‡å®šçš„æ¨¡å—ã€‚</div>2023-04-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/66/73/fd1e37a2.jpg" width="30px"><span>è‰¯è¾°ç¾æ™¯</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œ é—®ä¸€ä¸ªå·¥ç¨‹ä¸Šçš„é—®é¢˜ï¼Œ åƒè¿™ç§è¦æ±‚å¤§é‡è®¡ç®—èµ„æºAIç³»ç»Ÿï¼Œ åœ¨å·¥ç¨‹ä¸Šå¦‚ä½•èƒ½åšåˆ°å¯ç”¨å‘¢ï¼Œ éœ€è¦è´­ä¹°å¤§é‡çš„GPUè¿™ä¸ªå¯ä»¥æƒ³åˆ°ã€‚ è´­ä¹°çš„è¿™äº›èŠ¯ç‰‡å¦‚ä½•èƒ½å¤Ÿä¸²è”å½¢æˆç±»ä¼¼â€œäº‘â€çš„èƒ½åŠ›ï¼Ÿ è¿™ä¸ªæ˜¯å„ä¸ªå…¬å¸éœ€è¦æœ‰è‡ªå·±çš„è§£å†³æ–¹æ¡ˆè¿˜æ˜¯ä¸šç•Œå·²ç»æœ‰æˆç†Ÿçš„è§£å†³æ–¹æ¡ˆäº†ï¼Ÿ </div>2023-04-18</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTISHN4HwTsOicDUzB1jyzlxzriaI3S7tAfoPzicSfuTbxLxRjkCic2eBwRWxJTrwTpiaYP8Hg8vqWgNE2w/132" width="30px"><span>Geek_3d7708</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>dimension = 768faiss_index = faiss.IndexFlatIP(dimension)index = index=GPTFaissIndex(nodes=nodes,faiss_index=faiss_index, service_context=service_context)

è¿™ä¸ª index  ç»“æœæ€ä¹ˆä¿å­˜ï¼Ÿ æˆ‘æŠ˜è…¾2å¤©äº†éƒ½ä¸è¡Œï¼Œæ²¡æœ‰saveï¼Œæ²¡index , è€å¸ˆèƒ½å‘Šè¯‰æˆ‘æ€ä¹ˆä¿å­˜å—ï¼Ÿ</div>2023-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/88/df/e7bf1bdb.jpg" width="30px"><span>é“¶æ²³ç³»</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>openai.api_key = os.environ.get(&quot;OPENAI_API_KEY&quot;)

logging.basicConfig(stream=sys.stdout, level=logging.INFO)
logging.getLogger().addHandler(logging.StreamHandler(stream=sys.stdout))

# dimensions of text-ada-embedding-002
d = 768
faiss_index = faiss.IndexFlatL2(d)
text_splitter = CharacterTextSplitter(separator=&quot;\n\n&quot;, chunk_size=100, chunk_overlap=20)
parser = SimpleNodeParser(text_splitter=text_splitter)
documents = SimpleDirectoryReader(&#39;.&#47;data&#47;test&#39;).load_data()
nodes = parser.get_nodes_from_documents(documents)
llm_predictor = LLMPredictor(llm=ChatOpenAI(temperature=0, model_name=&quot;gpt-3.5-turbo&quot;, max_tokens=1024))
embed_model = LangchainEmbedding(HuggingFaceEmbeddings(
        model_name=&quot;sentence-transformers&#47;paraphrase-multilingual-mpnet-base-v2&quot;
    ))
service_context = ServiceContext.from_defaults(llm_predictor=llm_predictor, embed_model=embed_model)
index = GPTFaissIndex(nodes=nodes, faiss_index=faiss_index, service_context=service_context)
# save index to diskIM5æœ€æœ‰ç‰¹è‰²çš„ä½¿ç”¨åœºæ™¯
index.save_to_disk(
    &#39;index_faiss.json&#39;,
    faiss_index_save_path=&quot;index_faiss_core.index&quot;
)

# load index from disk
index = GPTFaissIndex.load_from_disk(&#39;index_faiss.json&#39;,faiss_index_save_path=&quot;index_faiss_core.index&quot;)
response = index.query(&quot;xxxxx&quot;,mode=QueryMode.EMBEDDING,verbose=True)
print(response)
è¿™ä¸ªä»£ç æŠ¥é”™å‘¢</div>2023-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/88/df/e7bf1bdb.jpg" width="30px"><span>é“¶æ²³ç³»</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>faissä¿å­˜åœ¨æœ¬åœ°è€Œä¸”ä½¿ç”¨è‡ªå·±çš„embeddingçš„å¯å¦ç»™ä¸ªdemoï¼Ÿ</div>2023-04-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/60/ad/03351e6e.jpg" width="30px"><span>xbc</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<div>```

import openai, os
import faiss
from llama_index import SimpleDirectoryReader, LangchainEmbedding, GPTFaissIndex, ServiceContext
from langchain.embeddings.huggingface import HuggingFaceEmbeddings
from langchain.text_splitter import CharacterTextSplitter
from llama_index.node_parser import SimpleNodeParser

openai.api_key = &quot;&quot;

text_splitter = CharacterTextSplitter(separator=&quot;\n\n&quot;, chunk_size=100, chunk_overlap=20)
parser = SimpleNodeParser(text_splitter=text_splitter)
documents = SimpleDirectoryReader(&#39;.&#47;data&#47;faq&#47;&#39;).load_data()
nodes = parser.get_nodes_from_documents(documents)

embed_model = LangchainEmbedding(HuggingFaceEmbeddings(
    model_name=&quot;sentence-transformers&#47;paraphrase-multilingual-mpnet-base-v2&quot;
))
service_context = ServiceContext.from_defaults(embed_model=embed_model)

dimension = 768
faiss_index = faiss.IndexFlatIP(dimension)
index = GPTFaissIndex(nodes=nodes,faiss_index=faiss_index, service_context=service_context)
```

è¿™æ®µä»£ç ä¼šæŠ¥é”™ï¼Œè€å¸ˆçš„ç¯å¢ƒé‡Œé¢å¯èƒ½æœ‰äº† env OPENAI_API_KEY.

æˆ‘è¿™é‡Œæ”¾çš„pyæ–‡ä»¶æ‰§è¡Œï¼š
  Did not find openai_api_key, please add an environment variable `OPENAI_API_KEY` which contains it, or pass  `openai_api_key` as a named parameter. (type=value_error)

</div>2023-04-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/30/ef/2d/757bb0d3.jpg" width="30px"><span>Toni</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>å°†ç¬¬äºŒè®²æƒ…æ„Ÿåˆ†æä¸­çš„è¿™æ®µä»£ç 

good_restraurant = get_embedding(&quot;è¿™å®¶é¤é¦†å¤ªå¥½åƒäº†ï¼Œä¸€ç‚¹éƒ½ä¸ç³Ÿç³•&quot;)
bad_restraurant = get_embedding(&quot;è¿™å®¶é¤é¦†å¤ªç³Ÿç³•äº†ï¼Œä¸€ç‚¹éƒ½ä¸å¥½åƒ&quot;)
good_score = get_score(good_restraurant)
bad_score = get_score(bad_restraurant)
print(&quot;å¥½è¯„é¤é¦†çš„è¯„åˆ† : %f&quot; % (good_score))
print(&quot;å·®è¯„é¤é¦†çš„è¯„åˆ† : %f&quot; % (bad_score))

ç”¨sentence_transformers æ›¿ä»£openai.embeddings_utils åˆè·‘äº†ä¸€ä¸‹
åœ¨é€‰ç”¨ model = SentenceTransformer(&#39;paraphrase-multilingual-mpnet-base-v2&#39;) çš„æƒ…å†µä¸‹
å¾—åˆ°çš„å¦‚ä¸‹ç»“æœ
å¥½è¯„ä¾‹å­çš„è¯„åˆ† : 0.215761
å·®è¯„ä¾‹å­çš„è¯„åˆ† : -0.361450
æ¯” openai.embeddings_utils import cosine_similarity, get_embedding
EMBEDDING_MODEL = &quot;text-embedding-ada-002&quot; çš„ç»“æœæ›´å¥½äº›
å¥½è¯„ä¾‹å­çš„è¯„åˆ† : 0.062719
å·®è¯„ä¾‹å­çš„è¯„åˆ† : -0.074591</div>2023-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/60/ad/03351e6e.jpg" width="30px"><span>xbc</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>WARNING:root:Created a chunk of size 130, which is longer than the specified 100

ä¸€å¤§å †è¿™äº›ï¼Œä¸è¿‡å¯ä»¥å¿½ç•¥ã€‚

æœ€å¥½æ”¹ç”¨ï¼š text_splitter = SpacyTextSplitter(pipeline=&quot;zh_core_web_sm&quot;, chunk_size = 2048)</div>2023-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/02/1c/a0aba121.jpg" width="30px"><span>mao</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ChatGLM æ˜¯ä¸æ˜¯å¯ä»¥é€šè¿‡å¯¹QAæ•°æ®é›†è¿›è¡Œå¾®è°ƒï¼Œå¾—åˆ°ä¸€ä¸ªä¸“ç”¨çš„é—®ç­”æ¨¡å‹ã€‚</div>2023-04-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/c2/72/fb00cd31.jpg" width="30px"><span>BashBIGBANG</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>llama ä¸¤ä¸ª l åªè¯»ä¸€ä¸ªl çš„éŸ³</div>2023-04-06</li><br/><li><img src="" width="30px"><span>Geek_78a551</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>æ›´æ–°åˆ°llma-index 0.11äº†, ä»£ç å…¨ä¸èƒ½è¿è¡Œ</div>2024-09-20</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoWZh2ibhHevq5ndQFMK0Z28fO0bFVd3WxslfkHUlX5YPMPhSq0dqyn4F1ozeLcf8wHGfwG6EiaV5Qw/132" width="30px"><span>Geek_6bdac7</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>ã€è§£å†³ã€‘colabè¿è¡Œæ¨¡å¼æ”¹ä¸ºgpuï¼Œå¯ä»¥pipå®‰è£… pip install faiss-gpu  


è€å¸ˆè¯·é—®ä¸‹colabä¸Šfaissæ€ä¹ˆå®‰è£…ï¼Œè¯•äº†ä¸åŒæ–¹æ³•è¿˜æ˜¯åœ¨import faissæ—¶å¯¼å…¥æŠ¥é”™ï¼Œæ— faissæ¨¡å— 
!wget  https:&#47;&#47;anaconda.org&#47;pytorch&#47;faiss-gpu&#47;1.2.1&#47;download&#47;linux-64&#47;faiss-gpu-1.2.1-py36_cuda9.0.176_1.tar.bz2
!tar xvjf faiss-gpu-1.2.1-py36_cuda9.0.176_1.tar.bz2
!cp -r lib&#47;python3.6&#47;site-packages&#47;* &#47;usr&#47;local&#47;lib&#47;python3.6&#47;dist-packages&#47;
!pip install mkl</div>2023-06-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg" width="30px"><span>aoe</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>çœ‹å®Œåæˆ‘è¿˜æ˜¯ç”¨æ˜¾å¡ç©æ¸¸æˆå§</div>2023-04-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/69/ad/608188c2.jpg" width="30px"><span>4thirteen2one</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>GPTListIndex æ‰¾ä¸åˆ°é¢</div>2025-01-22</li><br/><li><img src="" width="30px"><span>Geek_78a551</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>æˆ‘æŠŠä½ githubä¸Šçš„ä»£ç ä¸‹è½½ä¸‹æ¥æ‰§è¡Œå, ä¼šè¯·æ±‚gpt, è·Ÿä½ è¯´çš„ä¸ç¬¦åˆ, æŠ¥é”™ä¿¡æ¯æ˜¯api_keyé”™è¯¯</div>2024-09-21</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/4EspenNOwzy5VI6PiaT5nDbibhGa3utic5UTTv42ib8MCj0lFv83WHtcCfxxiadbp95XpdiafazhmHfYVstmUGKvVBgQ/132" width="30px"><span>å­¦ä¹ ä¸­çš„å®‰è€å¸ˆ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å†™çš„ä»£ç ä¸€ç‚¹æ³¨é‡Šéƒ½ä¸å†™ï¼Œè®©äººæ€ä¹ˆçœ‹</div>2024-05-19</li><br/>
</ul>