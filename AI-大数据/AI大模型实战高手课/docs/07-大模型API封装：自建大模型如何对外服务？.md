ä½ å¥½ï¼Œæˆ‘æ˜¯ç‹¬è¡Œã€‚

ä¸Šä¸€èŠ‚è¯¾æˆ‘ä»¬è¯¦ç»†è®²è§£äº†åŸºäºChatGLM3-6B + LangChain + å‘é‡æ•°æ®åº“çš„ä¼ä¸šå†…éƒ¨çŸ¥è¯†ç³»ç»Ÿï¼Œåœ¨è¿™ä¸ªæ¼”ç¤ºé¡¹ç›®ä¸­ï¼Œå…¶å®å·²ç»ç”¨åˆ°äº†APIçš„å°è£…ï¼Œæˆ‘ä»¬ä»WebUIç•Œé¢æé—®ï¼Œé€šè¿‡æ¥å£å°†æ•°æ®ä¼ åˆ°åç«¯æœåŠ¡ï¼Œä»è€Œè·å¾—å“åº”ã€‚å¤§æ¨¡å‹æ˜¯æ²¡æœ‰Web APIçš„ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è¿›è¡Œä¸€æ¬¡å°è£…ï¼Œå°†å¤§æ¨¡å‹çš„æ ¸å¿ƒæ¥å£å°è£…æˆWeb APIæ¥ä¸ºç”¨æˆ·æä¾›æœåŠ¡ï¼Œè¿™æ˜¯ä¼ä¸šè‡ªå»ºå¤§æ¨¡å‹çš„å¿…ç»ä¹‹è·¯ã€‚

åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ªç±»ä¼¼äºSpringBootçš„æ¡†æ¶ï¼Œç”¨æ¥åšæ¥å£æœåŠ¡åŒ–ï¼Œåœ¨PythonæŠ€æœ¯ä½“ç³»é‡Œï¼Œæœ‰ä¸€ä¸ªæ¡†æ¶å« **FastAPI**ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®ç°æ¥å£æ³¨å†Œï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™èŠ‚è¯¾ä¼šåŸºäºFastAPIå¯¹å¤§æ¨¡å‹çš„æ¥å£è¿›è¡Œå°è£…ã€‚å®é™…ä¸Šå…‰å†™ä¸€ä¸ªDemoä¸ç®—éš¾ï¼Œä½†æ˜¯å¦‚æœè¦å®Œæ•´åœ°ç”¨äºå·¥ç¨‹åŒ–é¡¹ç›®ï¼Œè¿˜æ˜¯æœ‰ä¸å°‘äº‹æƒ…è¦æ³¨æ„ï¼Œæ‰€ä»¥è¿™èŠ‚è¯¾æˆ‘ä¼šæŠŠå„ç§å„æ ·å’ŒAPIç›¸å…³çš„ç»†èŠ‚æ¢³ç†å‡ºæ¥ï¼Œå­¦å®Œè¿™èŠ‚è¯¾çš„å†…å®¹ï¼Œå†ç»“åˆå‰é¢å­¦ä¹ çš„å¤§æ¨¡å‹éƒ¨ç½²ï¼Œä½ æœ¬åœ°æ­å»ºçš„å¤§æ¨¡å‹åŸºæœ¬å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡äº†ã€‚

## æ¥å£å°è£…

æä¾›Web APIæœåŠ¡éœ€è¦ä¸¤ä¸ªæŠ€æœ¯ç»„ä»¶ï¼šUvicornå’ŒFastAPIã€‚

Uvicornä½œä¸ºWebæœåŠ¡å™¨ï¼Œç±»ä¼¼Tomcatï¼Œä½†æ˜¯æ¯”Tomcatè½»å¾ˆå¤šã€‚å…è®¸å¼‚æ­¥å¤„ç† HTTP è¯·æ±‚ï¼Œæ‰€ä»¥éå¸¸é€‚åˆå¤„ç†å¹¶å‘è¯·æ±‚ã€‚åŸºäºuvloopå’Œhttptoolsï¼Œæ‰€ä»¥å…·å¤‡éå¸¸é«˜çš„æ€§èƒ½ï¼Œé€‚åˆé«˜å¹¶å‘è¯·æ±‚çš„ç°ä»£Webåº”ç”¨ã€‚

FastAPIä½œä¸ºAPIæ¡†æ¶ï¼Œå’ŒSpringBootå·®ä¸å¤šï¼ŒåŒæ ·æ¯”SpringBootè½»å¾ˆå¤šï¼Œåªæ˜¯å½¢å¼ä¸Šç±»ä¼¼äºSpringBootçš„è§’è‰²ã€‚ç»“åˆä½¿ç”¨Uvicornå’ŒFastAPIï¼Œä½ å¯ä»¥æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€æ˜“äºæ‰©å±•çš„å¼‚æ­¥Webåº”ç”¨ç¨‹åºæˆ–APIã€‚Uvicornä½œä¸ºæœåŠ¡å™¨è¿è¡Œä½ çš„FastAPIåº”ç”¨ï¼Œå¯ä»¥æä¾›ä¼˜å¼‚çš„å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œè€ŒFastAPIåˆ™è®©ä½ çš„åº”ç”¨å¼€å‘å¾—æ›´å¿«ã€æ›´ç®€å•ã€æ›´å®‰å…¨ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥è®²è§£ã€‚é¦–å…ˆï¼Œå®‰è£…æ‰€éœ€è¦çš„ä¾èµ–åŒ…ã€‚

#### å®‰è£…ä¾èµ–

```plain
pip install fastapi
pip install uvicorn

```

#### ä»£ç åˆ†å±‚

ç®€å•æ¥çœ‹ï¼Œåˆ›å»ºapi.pyï¼Œå†™å…¥ä»¥ä¸‹ä»£ç ï¼Œå°±å¯ä»¥å®šä¹‰ä¸€ä¸ªæ¥å£ã€‚

```python
import uvicorn
from fastapi import FastAPI

# åˆ›å»ºAPIåº”ç”¨
app = FastAPI()

@app.get("/")
async def root():
  return {"message": "Hello World"}

if __name__ == '__main__':
  uvicorn.run(app, host='0.0.0.0', port=6006, log_level="info", workers=1)

```

```python
python api.py

```

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/0e/bb/0e2ee439501432e968dc8fe827747ebb.png?wh=1042x370)

å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæ¥å£è¾“å…¥å¯èƒ½æ˜¯å¤šä¸ªå­—æ®µï¼Œå’ŒJavaæ¥å£ä¸€æ ·ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªRequestå®ä½“ç±»æ¥æ‰¿æ¥HTTPè¯·æ±‚å‚æ•°ï¼ŒPythoné‡Œä½¿ç”¨Pydanticæ¨¡å‹æ¥å®šä¹‰æ•°æ®ç»“æ„ï¼ŒPydanticæ˜¯ä¸€ä¸ªæ•°æ®éªŒè¯å’Œè®¾ç½®ç®¡ç†çš„åº“ï¼Œå®ƒåˆ©ç”¨Pythonç±»å‹æç¤ºæ¥è¿›è¡Œæ•°æ®éªŒè¯ã€‚ç±»ä¼¼Javaé‡Œçš„Validationï¼Œä¸‹é¢è¿™æ®µä»£ç ä½ åº”è¯¥å¹¶ä¸é™Œç”Ÿã€‚

```java
import javax.validation.constraints.Min;
import javax.validation.constraints.NotNull;
import javax.validation.constraints.Size;

public class Product {

Â  Â  @NotNull
Â  Â  @Size(min = 2, max = 30)
Â  Â  private String name;

Â  Â  @NotNull
Â  Â  @Min(0)
Â  Â  private Float price;

Â  Â  // æ„é€ å™¨ã€getter å’Œ setter çœç•¥
}

```

å¯¹åº”çš„Pythonå®ç°å°±æ˜¯è¿™æ ·çš„ï¼š

```python
from fastapi import FastAPI
from pydantic import BaseModel, Field
from typing import Optional, List

app = FastAPI()

class Message(BaseModel):
    role: str
    content: str

class ChatMessage(BaseModel):
    history: List[Message]
    prompt: str
    max_tokens: int
    temperature: float
    top_p: float = Field(default=1.0)

@app.post("/v1/chat/completions")
async def create_chat_response(message: ChatMessage):
    return {"message": "Hello World"}

if __name__ == '__main__':
  uvicorn.run(app, host='0.0.0.0', port=6006, log_level="info", workers=1)

```

è¿™é‡Œå¼•å…¥äº†ä¸€ä¸ªBaseModelç±»ï¼Œç±»ä¼¼äºJavaé‡Œçš„Objectç±»ï¼Œä½†æ˜¯åˆä¸å®Œå…¨æ˜¯Objectï¼ŒObjectæ˜¯æ‰€æœ‰Javaç±»çš„åŸºç±»ï¼ŒJavaä¸­æ‰€æœ‰ç±»ä¼šé»˜è®¤é›†æˆObjectç±»çš„å…¬å…±æ–¹æ³•ï¼Œæ¯”å¦‚toString()ã€equals()ã€hashcode()ç­‰ï¼Œè€ŒBaseModel æ˜¯ä¸ºäº†æ•°æ®éªŒè¯å’Œç®¡ç†è€Œè®¾è®¡çš„ã€‚å½“ä½ åˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡ªBaseModelçš„ç±»æ—¶ï¼Œæ¯”å¦‚ä¸Šé¢çš„ChatSessionå’ŒMessageç±»ï¼Œå°†è‡ªåŠ¨è·å¾—æ•°æ®éªŒè¯ã€åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„åŠŸèƒ½ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¸å¯èƒ½æŠŠæ‰€æœ‰APIçš„å®šä¹‰å’ŒPydanticç±»æ”¾åœ¨æœ€å¤–å±‚ï¼ŒæŒ‰ç…§Javaå·¥ç¨‹åŒ–çš„æœ€ä½³å®è·µï¼ŒWebåº”ç”¨æˆ‘ä»¬ä¸€èˆ¬ä¼šè¿›è¡Œåˆ†å±‚ï¼Œæ¯”å¦‚controllerã€serviceã€modelã€toolç­‰ï¼ŒPythonå·¥ç¨‹åŒ–çš„æ—¶å€™ï¼Œä¸ºäº†æ–¹ä¾¿ç®¡ç†ä»£ç ï¼Œä¹Ÿä¼šè¿›è¡Œåˆ†å±‚ï¼Œä¸€ä¸ªå…¸å‹çš„ä»£ç ç»“æ„å¦‚ä¸‹ï¼š

```python
project_name/
â”‚
â”œâ”€â”€ app/Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â # ä¸»åº”ç”¨ç›®å½•
â”‚Â  Â â”œâ”€â”€ main.pyÂ  Â  Â  Â  Â  Â  Â  Â  Â  # FastAPI åº”ç”¨å…¥å£
â”‚Â  Â â””â”€â”€ controller/Â  Â  Â  Â  Â  Â  Â  # API ç‰¹å®šé€»è¾‘
â”‚Â  Â  Â   â””â”€â”€ chat.py
â”‚Â   â””â”€â”€ common/Â  Â  Â  Â  Â  Â  Â      # é€šç”¨APIç»„ä»¶
â”‚Â  Â  Â  Â â””â”€â”€ errors.pyÂ  Â  Â  Â      # é”™è¯¯å¤„ç†å’Œè‡ªå®šä¹‰å¼‚å¸¸
â”‚
â”œâ”€â”€ services/Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  # æœåŠ¡å±‚ç›®å½•
â”‚Â  Â â”œâ”€â”€ chat_service.pyÂ  Â  Â  Â  Â  # èŠå¤©æœåŠ¡ç›¸å…³é€»è¾‘
â”‚
â”œâ”€â”€ schemas/Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â # Pydantic æ¨¡å‹ï¼ˆè¯·æ±‚å’Œå“åº”æ¨¡å¼ï¼‰
â”‚Â  Â â”œâ”€â”€ chat_schema.pyÂ  Â  Â  Â  Â  Â # èŠå¤©æ•°æ®æ¨¡å¼
â”‚
â”œâ”€â”€ database/Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  # æ•°æ®åº“è¿æ¥å’Œä¼šè¯ç®¡ç†
â”‚Â  Â â”œâ”€â”€ session.pyÂ  Â  Â  Â  Â  Â  Â  Â # æ•°æ®åº“ä¼šè¯é…ç½®
â”‚Â  Â â””â”€â”€ engine.pyÂ  Â  Â  Â  Â  Â  Â  Â  # æ•°æ®åº“å¼•æ“é…ç½®
â”‚
â”œâ”€â”€ tools/Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â # å·¥å…·å’Œå®ç”¨ç¨‹åºç›®å½•
â”‚Â  Â â”œâ”€â”€ data_migration.pyÂ  Â  Â  Â  # æ•°æ®è¿ç§»å·¥å…·
â”‚
â”œâ”€â”€ tests/Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â # æµ‹è¯•ç›®å½•
â”‚Â  Â â”œâ”€â”€ conftest.pyÂ  Â  Â  Â  Â  Â  Â  # æµ‹è¯•é…ç½®å’Œå¤¹å…·
â”‚Â  Â â”œâ”€â”€ test_services/Â  Â  Â  Â  Â  Â # æœåŠ¡å±‚æµ‹è¯•
â”‚Â  Â â”‚Â  Â â”œâ”€â”€ test_chat_service.py
â”‚Â  Â â””â”€â”€ test_controller/
â”‚Â  Â  Â  Â â”œâ”€â”€ test_chat_controller.py
â”‚
â”œâ”€â”€ requirements.txtÂ  Â  Â  Â  Â  Â  Â # é¡¹ç›®ä¾èµ–æ–‡ä»¶
â””â”€â”€ setup.pyÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â # å®‰è£…ã€æ‰“åŒ…ã€åˆ†å‘é…ç½®æ–‡ä»¶

```

FastAPIçš„include\_routeræ–¹æ³•å°±æ˜¯ç”¨æ¥å°†ä¸åŒçš„è·¯ç”±é›†æˆåˆ°ä¸»åº”ç”¨ä¸­çš„ï¼Œæœ‰åŠ©äºç»„ç»‡å’Œåˆ†ç¦»ä»£ç ï¼Œç‰¹åˆ«æ˜¯åœ¨æ„å»ºå¤§å‹å·¥ç¨‹åŒ–åº”ç”¨æ—¶ï¼Œéå¸¸å¥½ç”¨ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹ä¿®æ”¹åçš„ä»£ç ã€‚

åº”ç”¨å…¥å£main.py

```python
import uvicorn as uvicorn
from fastapi import FastAPI
from controller.chat_controller import chat_router as chat_router
app = FastAPI()
app.include_router(chat_router, prefix="/chat", tags=["chat"])
if __name__ == '__main__':
    uvicorn.run(app, host='0.0.0.0', port=6006, log_level="info", workers=1)

```

chat\_controller.py

```python
from fastapi import APIRouter
from service.chat_service import ChatService
from schema.chat_schema import ChatMessage, MessageDisplay
chat_router = APIRouter()
chat_service = ChatService()

@chat_router.post("/new/message/")
def post_message(message: ChatMessage):
    return chat_service.post_message(message)

@chat_router.get("/get/messages/")
def get_messages():
    return chat_service.get_messages()

```

chat\_service.py

```python
from schema.chat_schema import ChatMessage

class ChatService:
    def post_message(self, message: ChatMessage) :
        print(message.prompt)
        return {"message": "post message"}
    def get_messages(self):
        return {"message": "get message"}

```

å‚æ•°ç±»å®šä¹‰å¦‚ä¸‹ï¼š

```python
from pydantic import BaseModel, Field

class Message(BaseModel):
    role: str
    content: str

class ChatMessage(BaseModel):
    prompt: str
    max_tokens: int
    temperature: float = Field(default=1.0)
    top_p: float = Field(default=1.0)


```

æˆ‘ä»¬å¯ä»¥åœ¨chat\_serviceé‡Œè¿›è¡Œè¯¦ç»†åœ°ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œåˆ°è¿™é‡ŒåŸºæœ¬å°±å’ŒJavaé‡Œä¸€æ ·äº†ã€‚ä¸‹é¢æ˜¯ä¸€æ®µç®€å•çš„æµ‹è¯•ä»£ç ï¼š

```python
import json
import requests

url = 'http://localhost:6006/chat/new/message/'
data = {
    'prompt': 'hello',
    'max_tokens': 1000
}

response = requests.post(url, data=json.dumps(data))
print(response.text)

url2 = 'http://localhost:6006/chat/get/messages/'
response = requests.get(url2)
print(response.text)

```

```python
{"message":"post message"}
{"message":"get message"}

```

å…³äºFastAPIçš„ä½¿ç”¨ï¼Œä½ å¯ä»¥å‚è€ƒè¿™ä¸ª [æ•™ç¨‹](https://fastapi.tiangolo.com/zh/tutorial/)ã€‚å·¥ç¨‹åŒ–ä»£ç ç»“æ„æå®šï¼Œæˆ‘ä»¬å°±å¯ä»¥å°è£…å¤§æ¨¡å‹çš„æ¥å£äº†ã€‚

#### å¤§æ¨¡å‹æ¥å£å°è£…

ä¸åŒçš„å¤§æ¨¡å‹å¯¹åº”çš„å¯¹è¯æ¥å£ä¸ä¸€æ ·ï¼Œä¸‹é¢çš„ç¤ºä¾‹ä»£ç åŸºäºChatGLM3-6Bã€‚æˆ‘ä»¬åœ¨serviceå±‚è¿›è¡Œæ¨¡å‹å¯¹è¯çš„å°è£…ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹ç¤ºä¾‹ä»£ç ã€‚

```python
from datetime import datetime
import model_manager
from schema.chat_schema import ChatMessage

class ChatService:
    def post_message(self, message: ChatMessage):
        print(message.prompt)
        model = model_manager.ModelManager.get_model()
        tokenizer = model_manager.ModelManager.get_tokenizer()
        response, history = model.chat(
            tokenizer,
            message.prompt,
            history=message.histroy,
            max_length=message.max_tokens,
            top_p=message.top_p,
            temperature=message.temperature
        )
        now = datetime.datetime.now()  # è·å–å½“å‰æ—¶é—´
        time = now.strftime("%Y-%m-%d %H:%M:%S")  # æ ¼å¼åŒ–æ—¶é—´ä¸ºå­—ç¬¦ä¸²
        answer = {
            "response": response,
            "history": history,
            "status": 200,
            "time": time
        }
        log = "[" + time + "] " + '", prompt:"' + message.prompt + '", response:"' + repr(response) + '"'
        print(log)
        return answer
    def get_messages(self):
        return {"message": "get message"}

```

å®šä¹‰ä¸€ä¸ªModelManagerç±»è¿›è¡Œå¤§æ¨¡å‹çš„æ‡’åŠ è½½ã€‚

```python
from transformers import AutoTokenizer, AutoModelForCausalLM

class ModelManager:
    _model = None
    _tokenizer = None

    @classmethod
    def get_model(cls):
        if cls._model is None:
            _model = AutoModelForCausalLM.from_pretrained("chatglm3-6b", trust_remote_code=True).half().cuda().eval()
        return _model

        @classmethod
    def get_tokenizer(cls):
        if cls._tokenizer is None:
            _tokenizer = AutoTokenizer.from_pretrained("chatglm3-6b", trust_remote_code=True)
        return _tokenizer

```

model.chat()æ˜¯6Bæš´éœ²çš„å¯¹è¯æ¥å£ï¼Œé€šè¿‡å¯¹model.chat()çš„å°è£…å°±å¯ä»¥å®ç°åŸºæœ¬çš„å¯¹è¯æ¥å£äº†ï¼Œè¿™ä¸ªæ¥å£ä¸€æ¬¡æ€§è¾“å‡ºå¤§æ¨¡å‹è¿”å›çš„å†…å®¹ï¼Œè€Œæˆ‘ä»¬åœ¨ä½¿ç”¨å¤§æ¨¡å‹äº§å“çš„æ—¶å€™ï¼Œæ¯”å¦‚ChatGPTæˆ–è€…æ–‡å¿ƒä¸€è¨€ï¼Œä¼šå‘ç°å¤§æ¨¡å‹æ˜¯ä¸€ä¸ªå­—ä¸€ä¸ªå­—è¿”å›çš„ï¼Œé‚£æ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿé‚£ç§æ¨¡å¼å« **æµå¼è¾“å‡º**ã€‚

## æµå¼è¾“å‡º

æµå¼è¾“å‡ºä½¿ç”¨å¦ä¸€ä¸ªæ¥å£ï¼šmodel.stream\_chatï¼Œæœ‰å‡ ç§æ¨¡å¼ï¼Œåƒä¸€ä¸ªå­—ä¸€ä¸ªå­—è¾“å‡ºï¼Œæ¯”å¦‚ï¼š

```plain
æˆ‘
æ˜¯
ä¸­
å›½
äºº

```

æˆ–è€…æ¯æ¬¡è¾“å‡ºå½“å‰å·²ç»è¾“å‡ºçš„å…¨éƒ¨ï¼Œæ¯”å¦‚ï¼š

```plain
æˆ‘
æˆ‘æ˜¯
æˆ‘æ˜¯ä¸­
æˆ‘æ˜¯ä¸­å›½
æˆ‘æ˜¯ä¸­å›½äºº

```

å½“ç„¶ä¹Ÿæœ‰æ¯æ¬¡åå‡º2ä¸ªå­—çš„ï¼Œå®é™…ç”Ÿäº§è¿‡ç¨‹ä¸­å¯ä»¥æ ¹æ®äº§å“äº¤äº’è®¾è®¡è‡ªè¡Œä¿®æ”¹é€»è¾‘ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸ªç®€å•çš„ä»£ç ç‰‡æ®µï¼Œé€šè¿‡streamå˜é‡æ¥æ§åˆ¶æ˜¯å¦æ˜¯æµå¼è¾“å‡ºã€‚

```python
if stream:
    async for token in callback.aiter():
        # Use server-sent-events to stream the response
        yield json.dumps(
            {"text": token, "message_id": message_id},
            ensure_ascii=False)
else:
    answer = ""
    async for token in callback.aiter():
        answer += token
    yield json.dumps(
        {"text": answer, "message_id": message_id},
        ensure_ascii=False)
await task

```

æˆ‘ä»¬è¾“å…¥â€œä½ å¥½â€ï¼Œå½“stream=trueæ—¶ï¼Œæ¥å£è¾“å‡ºæ˜¯è¿™æ ·çš„ï¼š

```python
data: {"text": "ä½ ", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "å¥½", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "ğŸ‘‹", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "ï¼", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "æˆ‘æ˜¯", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "äººå·¥æ™ºèƒ½", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "åŠ©æ‰‹", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": " Chat", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "GL", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "M", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "3", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "-", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "6", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "B", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "ï¼Œ", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "å¾ˆé«˜å…´", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "è§åˆ°", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "ä½ ", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "ï¼Œ", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "æ¬¢è¿", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "é—®æˆ‘", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "ä»»ä½•", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "é—®é¢˜", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}
data: {"text": "ã€‚", "message_id": "80b2af55c5b7440eaca6b9d510677a75"}

```

å½“stream=falseæ—¶ï¼Œæ¥å£è¿”å›å¦‚ä¸‹ï¼š

```python
data: {"text": "ä½ å¥½ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚è¯·é—®æœ‰ä»€ä¹ˆé—®é¢˜æˆ‘å¯ä»¥å¸®æ‚¨è§£ç­”å—ï¼Ÿ", "message_id": "741a630ac3d64fd5b1832cc0bae6bb68"}

```

åˆ°è¿™é‡Œï¼Œå¤§æ¨¡å‹çš„APIåŸºæœ¬å°±å°è£…å¥½äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹å¦‚ä½•è°ƒç”¨ã€‚

## æ¥å£è°ƒç”¨

åœ¨å®é™…å·¥ç¨‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šæŠŠAIç›¸å…³çš„é€»è¾‘ï¼ŒåŒ…æ‹¬å¤§æ¨¡å‹APIçš„å°è£…æ”¾åœ¨Pythonåº”ç”¨ä¸­ï¼Œä¸Šå±‚åº”ç”¨ä¸€èˆ¬é€šè¿‡å…¶ä»–è¯­è¨€å®ç°ï¼Œæ¯”å¦‚Javaã€C#ã€Goç­‰ï¼Œè¿™é‡Œæˆ‘ç®€å•ä¸¾ä¸€ä¸ªJavaç‰ˆæœ¬çš„è°ƒç”¨ä¾‹å­ã€‚éæµå¼è¾“å‡ºå°±æ˜¯æ™®é€šçš„HTTPè¯·æ±‚ï¼Œæˆ‘ä»¬å°±ä¸å±•ç¤ºäº†ï¼Œé‡ç‚¹çœ‹ä¸‹æµå¼è¾“å‡ºæ€ä¹ˆè¿›è¡Œè°ƒç”¨ï¼Œä¸»è¦åˆ†ä¸¤æ­¥ï¼Œéƒ½æ˜¯æµå¼çš„ã€‚

1. **Javaè°ƒç”¨Pythonæ¥å£ï¼š** ä¸»è¦ç”¨åˆ°äº†okhttp3æ¡†æ¶ï¼Œéœ€è¦ç»„è£…å‚æ•°ã€å‘èµ·æµå¼è¯·æ±‚ï¼Œäº‹ä»¶ç›‘å¬å¤„ç†ä¸‰æ­¥ã€‚

```java

@ApiOperation(value = "æµå¼å‘é€å¯¹è¯æ¶ˆæ¯")
@PostMapping(value = "sendMessage")
public void sendMessage(@RequestBody ChatRequest request, HttpServletResponse response) {
	try {
		JSONObject body = new JSONObject();
		body.put("model", request.getModel());
		body.put("stream", true);
		JSONArray messages = new JSONArray();
		JSONObject query = new JSONObject();
		query.put("role", "user");
		query.put("content", request.getQuery());
		messages.add(query);
		body.put("messages", messages);
		EsListener eventSourceListener = new EsListener(request, response);

		RequestBody formBody = RequestBody.create(body, MediaType.parse("application/json"));
		Request.Builder requestBuilder = new Request.Builder();

		Request request2 = requestBuilder.url(URL).post(formBody).build();
		EventSource.Factory factory = EventSources.createFactory(OkHttpUtil.getInstance());

		factory.newEventSource(request2, eventSourceListener);
		eventSourceListener.getCountDownLatch().await();
	} catch (Exception e) {
		log.error("æµå¼è°ƒç”¨å¼‚å¸¸", e);
	}
}

```

EsListenerç»§æ‰¿è‡ªEventSourceListenerï¼Œåœ¨Requestè¯·æ±‚çš„è¿‡ç¨‹ä¸­ä¸æ–­è§¦å‘EsListenerçš„onEventæ–¹æ³•ï¼Œç„¶åå°†æ•°æ®å†™å›å‰ç«¯ã€‚

```java
@Override
public void onEvent(EventSource eventSource, String id, String type, String data) {
	try {
		output.append(data);
		if ("finish".equals(type)) {
		}
		if ("error".equals(type)) {
		}

		// å¼€å§‹å¤„ç†dataï¼Œæ­¤å¤„åªå±•ç¤ºåŸºæœ¬æ“ä½œ
		// å¼€å‘è¿‡ç¨‹ä¸­å…·ä½“é€»è¾‘å¯è‡ªè¡Œæ‰©å±•
		if (response != null) {
			response.getWriter().write(data);
			response.getWriter().flush();
		}
	} catch (Exception e) {
		log.error("äº‹ä»¶å¤„ç†å¼‚å¸¸", e);
	}
}

```

2. **å‰ç«¯è°ƒç”¨Javaæ¥å£ï¼š** ä½¿ç”¨JSåŸç”ŸEventSourceçš„APIå°±å¯ä»¥ã€‚

```java
<script>
Â  Â  let eventData = '';
Â  Â  const eventSource = new EventSource('http://localhost:8888/sendMessage');
Â  Â  eventSource.onmessage = function(event) {
Â  Â  Â  Â  // ç´¯åŠ æ¥æ”¶åˆ°çš„äº‹ä»¶æ•°æ®
Â  Â  Â  Â  eventData += event.data;
Â  Â  };
</script>

```

åˆ°è¿™ä¸€æ­¥ï¼Œå¤§æ¨¡å‹APIä»å°è£…åˆ°è°ƒç”¨å°±åŸºæœ¬å®Œæˆäº†ï¼Œä½ å¯ä»¥æŠŠæ•´ä¸ªé“¾è·¯éƒ½ä¸²èµ·æ¥è·‘ä¸€è·‘ï¼Œä½“éªŒä¸‹æ•ˆæœã€‚å®é™…å·¥ç¨‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜ä¼šé‡åˆ°å…¶ä»–é—®é¢˜ï¼Œæ¯”å¦‚APIçš„é‰´æƒï¼ˆæŒ‡Java->Pythonï¼‰ã€è·¨åŸŸé—®é¢˜ã€APIé™æµé—®é¢˜ï¼ˆå¤§æ¨¡å‹çš„ååé‡æœ‰é™ï¼‰ï¼Œæˆ‘ä»¬ä¼šåœ¨åé¢çš„è¯¾ç¨‹ä¸­è®²è§£ã€‚

## å°ç»“

æˆ‘ä»¬è¿™èŠ‚è¯¾å­¦çš„å†…å®¹æ˜¯è‡ªå»ºå¤§æ¨¡å‹æœåŠ¡ä¸å¯ç¼ºå°‘çš„ä¸€æ­¥ï¼Œæ•´ä½“æ¥è¯´ä¸ç®—éš¾ï¼Œå”¯ä¸€å¯èƒ½éš¾ä¸€ç‚¹çš„å°±æ˜¯è¦ä½¿ç”¨Pythonè¯­è¨€ï¼Œå› ä¸ºåœ¨ä½¿ç”¨FastAPIçš„è¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰å¤§é‡çš„å¼‚æ­¥æ“ä½œï¼Œå’ŒJavaçš„å¤„ç†æ–¹å¼æœ‰ç‚¹å·®å¼‚ï¼Œéœ€è¦æ³¨æ„ä¸‹ã€‚

è¿™èŠ‚è¯¾å­¦å®Œï¼Œæˆ‘ä»¬åŸºæœ¬ä¸ŠæŠŠä¼ä¸šå†…éƒ¨æ„å»ºå¤§æ¨¡å‹çš„è¿‡ç¨‹å…¨éƒ¨è®²å®Œäº†ï¼Œä½ è‡ªå·±æ„å»ºçš„å¤§æ¨¡å‹åŸºæœ¬å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡äº†ã€‚å¦‚æœåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Œä¸€å®šè¦æ³¨æ„åšå¥½é™çº§å‡†å¤‡ï¼Œå› ä¸ºæœ‰å¾ˆå¤šä¸ç¡®å®šæ€§ï¼Œæ¯”å¦‚æ¨¡å‹çš„ååé‡ï¼ˆTPSï¼‰è¯„ä¼°æ˜¯å¦å‡†ç¡®ï¼Œæ¨¡å‹ä¼šä¸ä¼šå‡ºç°æ„æƒ³ä¸åˆ°çš„è¾“å‡ºç­‰ç­‰ï¼Œä¸€æ—¦å‡ºç°é—®é¢˜éšæ—¶é™çº§ã€‚

## æ€è€ƒé¢˜

å‰é¢æˆ‘ä»¬æåˆ°ï¼Œå¤§æ¨¡å‹ç›¸å…³çš„APIå°è£…åœ¨Pythonåº”ç”¨ä¸­ï¼Œå¯¹ç”¨æˆ·æä¾›æœåŠ¡çš„æ—¶å€™ï¼Œä¼šå†å¥—ä¸€å±‚Javaåº”ç”¨ï¼Œä½ å¯ä»¥æƒ³ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡ï¼Œæ¬¢è¿ä½ æŠŠä½ çš„æƒ³æ³•åˆ†äº«åˆ°è¯„è®ºåŒºï¼Œæˆ‘ä»¬ä¸€èµ·è®¨è®ºï¼Œå¦‚æœä½ è§‰å¾—è¿™èŠ‚è¯¾çš„å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼