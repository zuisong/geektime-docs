ä½ å¥½ï¼Œæˆ‘æ˜¯é‚¢äº‘é˜³ã€‚

åœ¨ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬ç”¨ä¹‹å‰è®²è¿‡çš„ Agentic RAG çš„ä¾‹å­ï¼Œäº†è§£äº† LangGraph å‡ºç°çš„å¿…è¦æ€§ã€‚ä¹‹åé€šè¿‡ç±»æ¯” Dify å·¥ä½œæµçš„å­¦ä¹ æ–¹å¼ï¼Œå¿«é€Ÿå…¥é—¨äº† LangGraph çš„èŠ‚ç‚¹ã€è¾¹ã€State ç­‰æœ€æ ¸å¿ƒçš„æ¦‚å¿µä»¥åŠä»£ç çš„ç¼–å†™æ–¹æ³•ã€‚å¦‚æœå¯¹äºä¸ŠèŠ‚è¯¾çš„ä»£ç æ„Ÿè§‰å¾ˆéš¾ç†è§£çš„åŒå­¦ï¼Œå»ºè®®å¯ä»¥å¤šå»å®æ“ä¸€ä¸‹ Dify å·¥ä½œæµï¼Œç„¶åæŒ‰æˆ‘ä»¬çš„æ€è·¯åšç±»æ¯”å­¦ä¹ ï¼Œå°±å¥½ç†è§£äº†ã€‚

ä¸ºäº†è®©ä½ å¯¹ LangGraph çš„ä½¿ç”¨ç†è§£å¾—æ›´åŠ é€å½»ï¼ŒæŒæ¡å¾—æ›´åŠ ç†Ÿç»ƒï¼Œè¿™ä¸€ç« æˆ‘ç²¾å¿ƒè®¾è®¡äº†ä¸€ä¸ªæ™ºèƒ½ç¼–ç¨‹åŠ©æ‰‹çš„é¡¹ç›®ã€‚

æˆ‘ä»¬çŸ¥é“å¦‚æœæƒ³è¦è®© AI å¸®æˆ‘ä»¬ç”Ÿæˆä»£ç ï¼Œä¸€èˆ¬æœ‰å‡ ç§åšæ³•ã€‚

ç¬¬ä¸€ç§æ˜¯ç›´æ¥åœ¨ DeepSeek ç­‰é—®ç­”ç½‘é¡µå‰ç«¯è¾“å…¥æç¤ºè¯ç”Ÿæˆä»£ç ï¼Œè¿™ç§æœ€ç®€å•ï¼Œå±äºä½“éªŒçº§çš„ä»£ç ç”Ÿæˆï¼›ç¬¬äºŒç§åˆ™æ˜¯ä½¿ç”¨ Cursor ç­‰ä»£ç ç”Ÿæˆå·¥å…·ï¼›ç¬¬ä¸‰ç§åˆ™æ˜¯åˆ©ç”¨ LangGraph + Prompt å»å®Œæˆä»£ç çš„ç”Ÿæˆï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•çš„å¥½å¤„åœ¨äºæˆ‘ä»¬å¯ä»¥è‡ªå·±å®šåˆ¶ä»£ç çš„ç»“æ„ï¼Œè¾“å‡ºä¼šæ¯”è¾ƒç¨³å®šã€‚

## ä½¿ç”¨ LangGraph ç”Ÿæˆæœ€ç®€å• Web åç«¯ä»£ç 

ç”±äº Python è‡ªèº«æ¯”è¾ƒç®€å•çµæ´»ï¼Œå› æ­¤ç”¨ AI ç”Ÿæˆ Python ç›¸å¯¹æ¥è¯´ä¹Ÿä¸æ˜¯ä»€ä¹ˆå›°éš¾çš„äº‹æƒ…ã€‚å› æ­¤è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±ä»¥ç”Ÿæˆ Golang è¯­è¨€çš„ Web åç«¯ä»£ç ä¸ºä¾‹ï¼Œä½¿ç”¨ LangGraph + Prompt è¿›è¡Œå®ç°ã€‚

### æœ€ç®€å• Golang Web åç«¯ä»£ç ç¤ºä¾‹

å…ˆæ¥çœ‹ä¸€ä¸‹ä¸€ä¸ªæœ€ç®€å•çš„ Golang Web åç«¯ä»£ç çš„ç¤ºä¾‹ã€‚é€šè¿‡å‰é¢ç« èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ Python ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ FastAPI æ¥å®Œæˆå Web åç«¯çš„ä»£ç ç¼–å†™ã€‚é‚£åœ¨ Golang è¯­è¨€ä¸­å‘¢ï¼ŒåŒæ ·ä¹Ÿæœ‰æ¡†æ¶è¾…åŠ©æˆ‘ä»¬å†™ä»£ç ï¼Œè¿™å°±æ˜¯ ginã€‚ä¸‹é¢å±•ç¤ºä¸€ä¸ªç”¨ gin ç¼–å†™çš„æœ€ç®€å•çš„åç«¯ï¼š

```plain
package main

import (
Â  Â  Â  Â  "github.com/gin-gonic/gin"
)

func main() {
Â  Â  Â  Â  r := gin.Default()
Â  Â  Â  Â  r.GET("/hello", helloHandler)
Â  Â  Â  Â  r.Run(":8080")
}

func helloHandler(c *gin.Context) {
Â  Â  Â  Â  c.String(200, "hello")
}
```

åœ¨è¿™ä¸ªä»£ç ä¸­ï¼ŒåŒ…å«ä¸€æ¡è·¯ç”±ï¼Œä¹Ÿå°±æ˜¯ç¬¬ 9 è¡Œçš„ /helloï¼Œè¯¥è·¯ç”±æ”¯æŒçš„ HTTP Method æ˜¯ GETã€‚æˆ‘ä»¬çŸ¥é“æ¯æ¡è·¯ç”±éƒ½ä¼šå¯¹åº”ä¸€ä¸ªè·¯ç”±å¤„ç†å‡½æ•° handlerï¼Œå› æ­¤ä»£ç ä¸­ç¼–å†™äº† helloHandleræ–¹æ³•ç”¨äºæ‰§è¡Œè·¯ç”±è¢«è®¿é—®åçš„ä¸šåŠ¡é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯ç¬¬ 13 ~ 15 è¡Œï¼Œä¸šåŠ¡é€»è¾‘éå¸¸ç®€å•ï¼Œç›´æ¥è¿”å› â€œhelloâ€ è¿™ä¸ªå­—ç¬¦ä¸²ã€‚

é‚£ç†è§£äº†ä»£ç å†…å®¹åï¼Œä»£ç çš„ç»“æ„ä¹Ÿå°±æ¯”è¾ƒæ¸…æ™°äº†ã€‚å…¶ä¸»è¦åˆ†æˆäº†ä¸‰å—ï¼Œç¬¬ä¸€å—æ˜¯ main å‡½æ•°ï¼Œç¬¬äºŒå—æ˜¯è·¯ç”±ï¼Œç¬¬ä¸‰å—æ˜¯è·¯ç”±å¤„ç†å‡½æ•°ã€‚æ­¤æ—¶ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ç”¨ LangGraph æŒ‰ç…§ä¸Šè¿°ç»“æ„ç¨³å®šåœ°ç”Ÿæˆä»£ç ï¼Œåˆ™å¯ä»¥è®¾è®¡ä¸ºå¦‚ä¸‹çš„æµç¨‹ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/47/ed/47a7f11e550d01e9a3f99bcf305ef7ed.png?wh=1920x217)

ä¹Ÿå°±æ˜¯å…ˆè¦ç”Ÿæˆè·¯ç”±ä¸è·¯ç”±å¤„ç†å‡½æ•°ï¼Œä¹‹åå†ç”Ÿæˆ main å‡½æ•°ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ç”¨è¿™ä¸ªæ€è·¯æ¥å®ç°ä»£ç ã€‚

### LLM æ¨¡å—

é¦–å…ˆæ˜¯ LLM æ¨¡å—ã€‚æˆ‘ä»¬çŸ¥é“ä¸ç®¡æ˜¯ä½¿ä¸ä½¿ç”¨ LangGraph æ¡†æ¶ï¼Œgin ä»£ç çš„ç”Ÿæˆæœ€ç»ˆè¿˜æ˜¯è¦ç”±å¤§æ¨¡å‹æ¥å®Œæˆçš„ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å…ˆåˆå§‹åŒ–å¥½å¤§æ¨¡å‹å®¢æˆ·ç«¯ï¼Œä¾›åç»­è°ƒç”¨ã€‚è¿™é‡Œæˆ‘æ˜¯å€ŸåŠ©çš„ LangChain å°è£…çš„ OpenAI å®¢æˆ·ç«¯ï¼Œç„¶åå°†å…¶é…ç½®æˆäº† DeepSeek çš„å®¢æˆ·ç«¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

```plain
import os

from langchain_openai import ChatOpenAI

def DeepSeek():
Â  Â  return ChatOpenAI(
Â  Â  Â  Â  model= "deepseek-chat",
Â  Â  Â  Â  api_key= os.environ.get("deepseek"),
Â  Â  Â  Â  base_url="https://api.deepseek.com",
Â  Â  )
```

æˆ‘ä½¿ç”¨çš„å¤§æ¨¡å‹æ˜¯ DeepSeek å®˜æ–¹çš„ chat æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯ V3ã€‚å¤§å®¶åœ¨è¿è¡Œè¿™æ®µä»£ç å‰ï¼Œéœ€è¦æ‰§è¡Œ pip install langchain\_openai æ¥å®‰è£…ä¸€ä¸‹ Langchain ç›¸å…³ä¾èµ–ã€‚

### State, è·¯ç”±ä¸è·¯ç”±å¤„ç†å‡½æ•°

LLM æ¨¡å—å‡†å¤‡å¥½åï¼Œæˆ‘ä»¬å¼€å§‹ä¸šåŠ¡ä»£ç çš„ç¼–å†™ã€‚é¦–å…ˆæ˜¯ä¸­å¤®çŠ¶æ€å­˜å‚¨å™¨ State çš„æ•°æ®ç»“æ„çš„å»ºç«‹ã€‚åœ¨è¿™æ®µä»£ç ä¸­ï¼Œç»“æ„æ˜¯éå¸¸ç®€å•çš„ï¼Œåªæœ‰ mainã€è·¯ç”±å’Œè·¯ç”±å¤„ç†å‡½æ•°ä¸‰å—ã€‚å…¶ä¸­ main å‡½æ•°åªæœ‰ä¸€ä¸ªï¼Œå› æ­¤å¯ä»¥ç”¨ä¸€ä¸ª string è¡¨ç¤ºï¼Œè€Œè·¯ç”±ä¸è·¯ç”±å¤„ç†å‡½æ•°æœªæ¥å¯èƒ½å†™å¤šä¸ªï¼Œå› æ­¤å¯ä»¥ç”¨ä¸€ä¸ª list è¡¨ç¤ºã€‚æœ€ç»ˆ State çš„ä»£ç ä¸ºï¼š

```python
class State(TypedDict):
Â  Â  main: str
Â  Â  routes: list[str]
Â  Â  handlers: list[str]
```

æœ‰äº† State åï¼Œæˆ‘ä»¬æ¥å®ç°è·¯ç”±ä¸è·¯ç”±å¤„ç†å‡½æ•°å¤„ç†èŠ‚ç‚¹ã€‚å…ˆä¸Šä»£ç ã€‚

````python
systemMessage = """
ä½ æ˜¯ä¸€ä¸ªgolangå¼€å‘è€…, æ“…é•¿ä½¿ç”¨ginæ¡†æ¶, ä½ å°†ç¼–å†™åŸºäºginæ¡†æ¶çš„webåç«¯ç¨‹åº
ä½ åªéœ€ç›´æ¥è¾“å‡ºä»£ç , ä¸è¦åšä»»ä½•è§£é‡Šå’Œè¯´æ˜ï¼Œä¸è¦å°†ä»£ç æ”¾åˆ° ```go ``` ä¸­
"""

def split_route_handler(message:str)->List[str]:
Â  Â  codes = message.split('###')
Â  Â  if len(codes) != 2:
Â  Â  Â  Â  raise Exception("Invalid message format")
Â  Â  return codes

def route_node(state):
Â  Â  prompt = """
ç”Ÿæˆginçš„è·¯ç”±ä»£ç å’Œhandlerå¤„ç†å‡½æ•°ï¼Œå®ƒä»¬ä¹‹é—´ä½¿ç”¨å­—ç¬¦ä¸²'###'éš”å¼€
route_hello:
Â  Â  GET /hello
handler_hello:
Â  Â  è¾“å‡ºå­—ç¬¦ä¸²"hello"
"""
Â  Â  message=llm.invoke([SystemMessage(content=systemMessage),HumanMessage(content=prompt)])
Â  Â  codes = split_route_handler(message.content)

Â  Â  state["routes"]+=[codes[0]]
Â  Â  state["handlers"]+=[codes[1]]
Â  Â  return state
````

ä»£ç çš„ç¬¬ 14 è¡Œï¼Œæˆ‘å®šä¹‰äº† route\_node æ–¹æ³•ï¼Œç”¨äºæ‰§è¡Œç”Ÿæˆä»£ç çš„ä»»åŠ¡ã€‚è¯¥æ–¹æ³•çš„å®ç°ä¸»è¦åœ¨äº Prompt çš„ç¼–å†™ã€‚ä¸ºäº†æ¼”ç¤ºç®€å•ï¼Œæˆ‘æš‚æ—¶å°†è·¯ç”±ä¸è·¯ç”±å‡ºæ¥å‡½æ•°æ”¾åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä»»åŠ¡ä¸­ç”Ÿæˆï¼Œç„¶åç”¨ ### éš”å¼€ã€‚ç”¨ ### éš”å¼€çš„ç›®çš„æ˜¯æ–¹ä¾¿å°†ç”Ÿæˆçš„ä»£ç æ‹†åˆ†å‡ºæ¥åï¼Œæ”¾ç½®åˆ° State çš„ routes å’Œ handlers åˆ—è¡¨ä¸­ã€‚

ä¹‹åå°±æ˜¯ç¬¬ 21 è¡Œçš„è¯·æ±‚å¤§æ¨¡å‹çš„ä»£ç äº†ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ LangChain æ¡†æ¶çš„å†™æ³•ã€‚è¯·æ±‚å¤§æ¨¡å‹æ—¶åŒ…å«äº†ä¸¤ä¸ª Pomptï¼Œä¸€ä¸ªæ˜¯ç³»ç»Ÿ Promptï¼Œä¸»è¦æ˜¯ä¸ºå¤§æ¨¡å‹è®¾ç½®äº†äººè®¾ä¸é™å®šã€‚å¦ä¸€ä¸ªä¾¿æ˜¯ User Promptï¼Œä¹Ÿå°±æ˜¯ä¸Šæ–‡çš„ç”Ÿæˆä»£ç çš„ Promptã€‚

å®Œæˆå¤§æ¨¡å‹çš„è¯·æ±‚åï¼Œå¤§æ¨¡å‹ä¼šå°†è¿”å›çš„ç­”æ¡ˆæ”¾ç½®åˆ° content å­—æ®µä¸­ï¼Œä¹‹åå°±å¯ä»¥è°ƒç”¨æ‹†åˆ†å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ç¬¬ 6 è¡Œçš„ split\_route\_handler è¿›è¡Œæ‹†åˆ†äº†ã€‚æ‹†åˆ†ä»£ç å¾ˆç®€å•ï¼Œå°±æ˜¯è°ƒç”¨äº† python å†…ç½®çš„å­—ç¬¦ä¸²çš„ split æ–¹æ³•ã€‚æˆ‘ä»¬é¢„æœŸçš„ä»£ç è¾“å‡ºä¸ºï¼š

```python
r.GET("/hello", helloHandler)
###
func helloHandler(c *gin.Context) {
Â  Â  Â  Â  c.String(200, "hello")
}
```

### main å‡½æ•°èŠ‚ç‚¹

è·¯ç”±ä»£ç ç”Ÿæˆå®Œæ¯•åï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç”Ÿæˆ main å‡½æ•°äº†ã€‚å¥—è·¯ä¸ä¸Šé¢ä¸€æ¨¡ä¸€æ ·ï¼ŒåŒºåˆ«ä¸»è¦æ˜¯æç¤ºè¯çš„å˜åŒ–ã€‚è¿˜æ˜¯å…ˆä¸Šä»£ç ï¼š

```python
def main_node(state):
Â  Â  prompt = """
1.åˆ›å»ºginå¯¹è±¡
2.æ‹¥æœ‰è·¯ç”±ä»£ç 
{routes}
handlerä»£ç å·²ç»ç”Ÿæˆï¼Œæ— éœ€å†è¿›è¡Œå¤„ç†
3.å¯åŠ¨ç«¯å£ä¸º8080
Â  Â  """

Â  Â  prompt=prompt.format(routes=state["routes"][-1])
Â  Â  message=llm.invoke([SystemMessage(content=systemMessage),HumanMessage(content=prompt)])
Â  Â  state["main"]+=message.content
Â  Â  return state
```

ç”±äºæˆ‘ä»¬é¢„æœŸç”Ÿæˆçš„ main å‡½æ•°çš„ä»£ç ä¸ºï¼š

```python
func main() {
Â  Â  Â  Â  r := gin.Default()
Â  Â  Â  Â  r.GET("/hello", helloHandler)
Â  Â  Â  Â  r.Run(":8080")
}
```

å› æ­¤æç¤ºè¯çš„ç¬¬ä¸€æ¡åˆ›å»º gin å¯¹è±¡å¯¹åº”çš„å°±æ˜¯ r := gin.Default()ï¼Œè€Œæç¤ºè¯çš„ç¬¬äºŒæ¡æ‹¥æœ‰è·¯ç”±ä»£ç ï¼Œå¹¶å°† {routes} ä»£ç è´´ä¸Šï¼Œæ˜¯ä¸ºäº†è®©å¤§æ¨¡å‹ç”Ÿæˆç»Ÿä¸€æ ¼å¼çš„ main å‡½æ•°ã€‚

ä»€ä¹ˆå«ç»Ÿä¸€æ ¼å¼å‘¢ï¼Ÿæ¯”å¦‚è·¯ç”±ä»£ç æ˜¯ r.GETï¼Œæ­¤æ—¶å¤§æ¨¡å‹çœ‹åˆ°è·¯ç”±ä»£ç ç”¨çš„æ˜¯ rï¼Œè€Œä¸æ˜¯ abc åï¼Œåœ¨ç”Ÿæˆ r := gin.Default() ä»£ç æ—¶ï¼Œå°±ä¸ä¼šå†™æˆ abc := gin.Default()ï¼Œè€Œæ˜¯ä¼šç»Ÿä¸€å˜é‡åç§°ã€‚è¿™ä¹Ÿæ˜¯å†™æç¤ºè¯çš„ä¸€ä¸ªæŠ€å·§ã€‚

ä¸ºäº†é˜²æ­¢å¤§æ¨¡å‹è‡ªä½œèªæ˜åœ°æ ¹æ®è·¯ç”±å°† handler å†ç”Ÿæˆä¸€éï¼Œè¿˜è¦åŠ ä¸Šä¸€å¥ â€œhandlerä»£ç å·²ç»ç”Ÿæˆï¼Œæ— éœ€å†è¿›è¡Œå¤„ç†â€ã€‚æœ€åæ˜¯å¯åŠ¨ç«¯å£ä¸º 8080ï¼Œå¯¹åº”ä»£ç  r.Run(â€œ:8080â€)ã€‚

å…¶ä»–ä»£ç çš„å¥—è·¯ä¸è·¯ç”±èŠ‚ç‚¹ä¸€æ¨¡ä¸€æ ·ï¼Œæˆ‘å°±ä¸å†é‡å¤äº†ã€‚

### ç»„æˆ Graph

æœ€åæ˜¯å°†èŠ‚ç‚¹ç»„æˆ Graphï¼Œç„¶åè¿è¡Œçš„ä»£ç ã€‚ä»£ç å¦‚ä¸‹ï¼š

```python
if __name__ == "__main__":
Â  Â  sg = StateGraph(State)

Â  Â  sg.add_node("route_node", route_node)
Â  Â  sg.add_node("main_node", main_node)

Â  Â  sg.add_edge(START, "route_node")
Â  Â  sg.add_edge("route_node", "main_node")
Â  Â  sg.add_edge("main_node", END)

Â  Â  graph = sg.compile()
Â  Â  code = graph.invoke({"main":"", "routes":[], "handlers":[]})

Â  Â  print(code["main"])
Â  Â  for handler in code["handlers"]:
Â  Â  Â  Â  print(handler)
```

çœ‹è¿‡ä¸ŠèŠ‚è¯¾ä»£ç çš„åŒå­¦ï¼Œå†çœ‹è¿™æ®µä»£ç å°±ä¼šæ„Ÿè§‰å¾ˆç®€å•äº†ï¼Œéœ€è¦ç•™æ„çš„åªæœ‰ä¸¤ç‚¹ã€‚

ç¬¬ä¸€æ˜¯ç¬¬ 12 è¡Œä¸º Graph çš„è¿è¡Œèµ‹åˆå§‹å€¼ã€‚ä¸ŠèŠ‚è¯¾çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬èµ‹çš„å€¼æ˜¯â€œç¾Šæ’â€ï¼Œä½†è¿™èŠ‚è¯¾ï¼Œç”±äºæ˜¯è®©å¤§æ¨¡å‹ä»é›¶ç”Ÿæˆä»£ç ï¼Œå› æ­¤åˆå€¼æ˜¯ç©ºçš„ã€‚

ç¬¬äºŒæ˜¯ç¬¬ 14 è¡Œåˆ° 16 è¡Œï¼Œå°†ç”Ÿæˆçš„ä»£ç æ‰“å°å‡ºæ¥ã€‚è¿™é‡Œä½ å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆæ²¡æ‰“å° code\[â€œroutesâ€] çš„ä»£ç ï¼Ÿ

åŸå› å¾ˆç®€å•ï¼Œå› ä¸º routes çš„ä»£ç å·²ç»åœ¨ main å‡½æ•°ä¸­äº†ã€‚

æœ€åçš„æ‰§è¡Œæ•ˆæœæ˜¯åé¢è¿™æ ·ï¼Œä¸é¢„æœŸä¸€æ¨¡ä¸€æ ·ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/ac/2e/ac317ebbe1234b0cebf9fb0cyy7cec2e.png?wh=1920x321)

## ç”Ÿæˆ Web åç«¯ä»£ç è¿›é˜¶

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­è¿›é˜¶ã€‚ä¸ç®¡æ˜¯ç”¨ä»€ä¹ˆè¯­è¨€ï¼Œç†Ÿæ‚‰è¿™ç§ Web åç«¯ä»£ç çš„åŒå­¦éƒ½çŸ¥é“ï¼Œåœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå®šä¹‰ä¸€äº› modelsï¼Œä¹Ÿå°±æ˜¯å®ä½“ç±»ï¼Œç”¨äºè¡¨ç¤ºåƒæ˜¯æ•°æ®åº“è¡¨å¯¹è±¡ç­‰ç­‰çš„ç»“æ„ã€‚

æ‰€ä»¥åœ¨æ¥ä¸‹æ¥çš„ä»£ç ï¼Œæˆ‘å°±å¢åŠ å¯¹äºå®ä½“ç±»çš„åˆ›å»ºï¼Œå¹¶ä¸”åˆ†æˆä¸¤ä¸ªèŠ‚ç‚¹ä»»åŠ¡ï¼Œåˆ†åˆ«ç”Ÿæˆè·¯ç”±å’Œè·¯ç”±å¤„ç†å‡½æ•°ã€‚æ­¤æ—¶ Graph å°±å˜æˆäº†è¿™æ ·ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/eb/a1/ebfebb7163172fd6343d6bb8818be1a1.png?wh=1920x156)

### å®ä½“ç±»èŠ‚ç‚¹

æ€è·¯æ¢³ç†æ¸…æ¥šäº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å†™ä»£ç ã€‚é¦–å…ˆæ˜¯å®ä½“ç±»èŠ‚ç‚¹ï¼Œä»£ç å¦‚ä¸‹ï¼š

```python
models_prompt = """
#æ¨¡å‹
1.ç”¨æˆ·æ¨¡å‹ï¼ŒåŒ…å«å­—æ®µï¼šUserID(int), UserName(string), UserEmail(string)
ç”Ÿæˆä¸Šè¿°æ¨¡å‹å¯¹äºçš„ structã€‚structåç§°ç¤ºä¾‹ï¼šUserModel
"""

def models_node(state):
Â   message=llm.invoke([SystemMessage(content=systemMessage),HumanMessage(content=models_prompt)])
Â  Â  state["models"]+=[message.content]
Â  Â  return state
```

å’Œä¹‹å‰ä¸€æ ·ï¼Œä¸»è¦è¿˜æ˜¯ Prompt çš„ç¼–å†™ï¼Œè¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯å†™æ˜ç™½éœ€è¦ä»€ä¹ˆå­—æ®µï¼Œæ¯ä¸ªå­—æ®µçš„ç±»å‹æ˜¯ä»€ä¹ˆå°±å¯ä»¥ã€‚

### è·¯ç”±èŠ‚ç‚¹

æ¥ä¸‹æ¥çœ‹è·¯ç”±èŠ‚ç‚¹çš„ä»£ç ï¼š

```python
route_prompt = """
#ä»»åŠ¡
ç”Ÿæˆginçš„è·¯ç”±ä»£ç 

#è·¯ç”±
1.Get /version è·å–åº”ç”¨çš„ç‰ˆæœ¬
2.Get /users è·å–ç”¨æˆ·åˆ—è¡¨

#è§„åˆ™
å­—ç¬¦ä¸²åˆ†ä¸‰æ®µï¼Œç¬¬ä¸€æ®µï¼šMethodï¼Œç¬¬äºŒæ®µï¼šè¯·æ±‚ PATHï¼Œç¬¬ä¸‰æ®µï¼šä»£ç æ³¨é‡Š

#ç¤ºä¾‹
r.Get("/version", version_handler) // ç”¨äºè·å–åº”ç”¨çš„ç‰ˆæœ¬çš„è·¯ç”±ï¼Œhandlerå‡½æ•°åç¤ºä¾‹ï¼šversion_handler
"""

def route_node(state):
Â  Â  message=llm.invoke([SystemMessage(content=systemMessage),HumanMessage(content=route_prompt)])
Â  Â  state["routes"]+=[message.content]
Â  Â  return state
```

è¿™ä¸€ç‰ˆæœ¬çš„è·¯ç”±å‡½æ•°ï¼Œæˆ‘æ¢äº†ä¸¤æ¡è·¯ç”±ï¼Œä¸€æ¡æ˜¯è·å–åº”ç”¨ç‰ˆæœ¬çš„ï¼Œå¦ä¸€æ¡åˆ™æ˜¯è·å–ç”¨æˆ·åˆ—è¡¨çš„ã€‚è¯·æ³¨æ„ç”Ÿæˆçš„ä»£ç æ¯ä¸€æ®µéƒ½æ˜¯ä»€ä¹ˆæ„æ€ï¼Œæˆ‘éƒ½å†™å¾—å¾ˆæ¸…æ¥šï¼Œè¿˜ç»™å‡ºäº†ç¤ºä¾‹ã€‚è¿™æ ·æœ‰åŠ©äºå¤§æ¨¡å‹ç†è§£ä»£ç åº”è¯¥æ€ä¹ˆå†™ï¼Œç»™å‡ºç¨³å®šçš„ä»£ç è¾“å‡ºã€‚

### è·¯ç”±å¤„ç†å‡½æ•°èŠ‚ç‚¹

å†æ¥çœ‹ä¸€ä¸‹è·¯ç”±å¤„ç†å‡½æ•°çš„ä»£ç ï¼š

```python
handler_prompt = """
#ä»»åŠ¡
ç”Ÿæˆginçš„è·¯ç”±æ‰€å¯¹åº”çš„handlerå¤„ç†å‡½æ•°ä»£ç 

#è§„åˆ™
ä½ åªéœ€è¦ç”Ÿæˆæä¾›çš„è·¯ç”±ä»£ç å¯¹åº”çš„ handler å‡½æ•°ï¼Œä¸éœ€è¦ç”Ÿæˆé¢å¤–ä»£ç 
handlerå‡½æ•°æ˜¯å’Œè·¯ç”±ä»£ç ä¸€ä¸€å¯¹åº”çš„ï¼Œhandlerå‡½æ•°çš„åç§°åœ¨è·¯ç”±ä»£ç çš„æ³¨é‡Šä¸­å·²ç»ç»™å‡º
å¦‚æœhandlerå‡½æ•°éœ€è¦ç”¨åˆ°æ¨¡å‹ï¼Œåˆ™åœ¨æ¨¡å‹ä»£ç ä¸­é€‰æ‹©

#è·¯ç”±ä»£ç 
{routes}

#æ¨¡å‹ä»£ç 
{models}

#è·¯ç”±å¤„ç†å‡½æ•°åŠŸèƒ½
1.è¾“å‡ºåº”ç”¨çš„ç‰ˆæœ¬ä¸º1.0
2.è¾“å‡ºç”¨æˆ·åˆ—è¡¨
"""

def handler_node(state):
Â  Â  prompt=handler_prompt.format(routes=state["routes"], models=state["models"])
Â  Â  message=llm.invoke([SystemMessage(content=systemMessage),HumanMessage(content=prompt)])
Â  Â  state["handlers"]+=[message.content]
Â  Â  return state
```

è·¯ç”±å¤„ç†å‡½æ•°éœ€è¦æ ¹æ®å®šä¹‰çš„è·¯ç”±æ¥å†™ï¼Œå› æ­¤éœ€è¦å°†ä¸Šä¸€èŠ‚ç‚¹ç”Ÿæˆçš„è·¯ç”±ä»£ç ä¼ å…¥åˆ° Prompt ä¸­ã€‚æ­¤å¤–ï¼Œè·¯ç”±å¤„ç†å‡½æ•°ä¸­å¾€å¾€ä¼šç”¨åˆ°å®ä½“ç±»ï¼Œæ¯”å¦‚å»æ•°æ®åº“ä¸­è¯»å–æ•°æ®å­˜å…¥åˆ°å®ä½“å¯¹è±¡ï¼Œç„¶åè¿”å›ç»™å‰ç«¯ã€‚å› æ­¤å®ä½“ç±»èŠ‚ç‚¹ç”Ÿæˆçš„å®ä½“ç±»ä¹Ÿéœ€è¦ä¼ å…¥ã€‚

å…¶ä»–çš„å°±æ˜¯åŠŸèƒ½æè¿°äº†ï¼Œæè¿°æ¸…æ¥šæƒ³è®©å‡½æ•°å¤„ç†ä»€ä¹ˆä¸šåŠ¡ã€‚è¿™å‡ ç‚¹å¤„ç†æ¸…æ¥šåï¼Œå…¶ä»–å°±æ²¡ä»€ä¹ˆéš¾åº¦äº†ã€‚

### ç»„æˆGraph

èŠ‚ç‚¹ä»»åŠ¡å‡½æ•°å†™å®Œåï¼Œå°±å¯ä»¥ç»„æˆ Graph äº†ã€‚ä»£ç å¦‚ä¸‹ï¼š

```python
if __name__ == "__main__":
Â  Â  sg = StateGraph(State)

Â  Â  sg.add_node("models_node", models_node)
Â  Â  sg.add_node("route_node", route_node)
Â  Â  sg.add_node("handler_node", handler_node)
Â  Â  sg.add_node("main_node", main_node)

Â  Â  sg.add_edge(START, "models_node")
Â  Â  sg.add_edge("models_node", "route_node")
Â  Â  sg.add_edge("route_node", "handler_node")
Â  Â  sg.add_edge("handler_node", "main_node")
Â  Â  sg.add_edge("main_node", END)

Â  Â  graph = sg.compile()
Â  Â  code = graph.invoke({"main":"", "routes":[], "handlers":[], "models":[]})

Â  Â  print(code["models"][0])
Â  Â  print(code["main"])
Â  Â  for handler in code["handlers"]:
Â  Â  Â  Â  print(handler)
```

å¥—è·¯å’Œä¹‹å‰æ˜¯ä¸€æ ·çš„ï¼Œä¸å†é‡å¤ã€‚æ¥ä¸‹æ¥ç›´æ¥è¿›è¡Œæµ‹è¯•å³å¯ã€‚

é¦–å…ˆç”Ÿæˆäº†å®ä½“ç±»ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/04/a7/04a64e3yy94428dca435084781d066a7.png?wh=1284x176)

ä¹‹åç”Ÿæˆäº†åç«¯ä»£ç ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/85/0b/854c54ce625f784c4888488bc1abd70b.png?wh=932x713)

ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ã€‚

## æ€»ç»“

è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä½¿ç”¨ LangGraph + Prompt çš„æ‰‹æ³•å®Œæˆäº† Golang çš„ Web åç«¯ä»£ç çš„ç”Ÿæˆã€‚Golang Web åç«¯ä»£ç ï¼Œæœ¬èº«éå¸¸ç®€å•ï¼Œæ— è®ºä½ æ˜¯å¦æœ‰ Golang å¼€å‘ç»éªŒï¼Œéƒ½æ— éœ€ç‰¹åˆ«å…³æ³¨ä»£ç çš„å®ç°ç»†èŠ‚ï¼Œåªéœ€è¦ç†è§£ä»£ç çš„ç»“æ„å³å¯ã€‚

è¿™æ˜¯å› ä¸ºç†è§£äº†ä»£ç çš„ç»“æ„ï¼Œæˆ‘ä»¬æ‰èƒ½æ›´å¥½çš„ç†è§£ LangGraph åœ¨è¿™ä¸ªé¡¹ç›®ä¸­çš„ä½œç”¨ã€‚é‚£ LangGraph èµ·åˆ°äº†ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿå…¶å®å°±æ˜¯å·¥ä½œæµçš„ä½œç”¨ã€‚æˆ‘ä»¬å°†ä»£ç çš„æ¯ä¸€ä¸ªç»“æ„éƒ½å®šä¹‰æˆä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹åˆ©ç”¨ Prompt å·¥ç¨‹å•ç‹¬ç”Ÿæˆä»£ç ï¼Œå¹¶ä¸”èŠ‚ç‚¹é—´è¿˜èƒ½è¿›è¡Œæ•°æ®çš„æµè½¬ï¼Œä½¿å¾—åƒæ˜¯è·¯ç”±å¤„ç†å‡½æ•°è¿™æ ·çš„éœ€è¦ä¾èµ–å…¶ä»–ç»“æ„ä»£ç çš„èŠ‚ç‚¹ï¼Œæ–¹ä¾¿å®ƒä»¬æ‹¿åˆ°å…¶ä»–èŠ‚ç‚¹çš„æ•°æ®ï¼Œæ¥ç”Ÿæˆæœ¬èŠ‚ç‚¹çš„ä»£ç ã€‚

æœ‰äº†ç»“æ„æ‹†åˆ†å’Œæµç¨‹æ§åˆ¶åï¼Œå¤§æ¨¡å‹å°±å¯ä»¥æŒ‰ç…§æˆ‘ä»¬çš„æ€è·¯ç¨³å®šçš„è¾“å‡ºä»£ç ã€‚è¿™èŠ‚è¯¾ä»£ç å·²ç»ä¸Šä¼ åˆ°äº† [GitHub](https://github.com/xingyunyang01/Geek02/tree/main/class25)ï¼Œä½ å¯ä»¥è¯¾åä¸‹è½½ä¸‹æ¥ï¼Œè‡ªå·±åŠ¨æ‰‹æµ‹è¯•ä¸€ä¸‹ï¼ŒåŠ æ·±ç†è§£ã€‚

## æ€è€ƒé¢˜

é€šå¸¸æˆ‘ä»¬åœ¨å†™ä»£ç å‰ï¼Œä¼šå…ˆè¿›è¡Œå®ä½“ç±»çš„è®¾è®¡ï¼Œå½¢æˆæ•°æ®æ–‡æ¡£ã€‚å¦‚ä½•å¯¹æˆ‘ä»¬çš„ä»£ç è¿›è¡Œæ”¹é€ ï¼Œåˆ©ç”¨å·²ç»å†™å¥½çš„æ•°æ®æ–‡æ¡£ç”Ÿæˆå®ä½“ç±»ä»£ç å‘¢ï¼Ÿ

æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºå±•ç¤ºä½ çš„æ€è€ƒç»“æœï¼Œæˆ‘ä»¬ä¸€èµ·æ¢è®¨ã€‚å¦‚æœä½ è§‰å¾—è¿™èŠ‚è¯¾çš„å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ4ï¼‰</strong></div><ul>
<li><span>ä¸œæ–¹å¥‡éª¥</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç¬¬ä¸€ä¸ªç¤ºä¾‹æˆ‘ç”¨çš„é˜¿é‡Œçš„deepseek-v3ï¼Œç„¶åæŠŠgolangæ”¹æˆäº†fasitfy, route_nodeçš„prompt &quot;å®ƒä»¬ä¹‹é—´ä½¿ç”¨å­—ç¬¦ä¸²&#39;###&#39;éš”å¼€&quot;, æœ‰æ—¶å€™å¤§æ¨¡å‹è¿˜æ˜¯ä¸ä¼šä½¿ç”¨&quot;###&quot;éš”å¼€ï¼Œæ”¹ä¸ºäº†&quot;å®ƒä»¬ä¹‹é—´ä¸€å®šè¦ä½¿ç”¨å­—ç¬¦ä¸²&#39;###&#39;éš”å¼€&quot;ï¼Œå°±æ¯æ¬¡éƒ½æ­£å¸¸äº†ã€‚åœ¨main_nodeçš„promptä¸­åŠ å…¥äº†â€œ4.æœ€åæ³¨æ„æ£€æŸ¥ä»£ç ï¼Œæ¯”å¦‚ä¸è¦å‡ºç°æœ‰å¤šä¸ªapp.listençš„æƒ…å†µâ€ï¼Œå¦åˆ™ä¼šå‡ºç°ä¸¤ä¸ªapp.listenã€‚</p>2025-04-25</li><br/><li><span>spiderman</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ€è€ƒé¢˜ï¼šæŠŠæ•°æ®æ–‡æ¡£åŠ è½½è¿›æ¥ï¼Œæ”¾åœ¨models_promptä¸­ï¼Œç”±å¤§æ¨¡å‹æ ¹æ®æ•°æ®ç¤ºä¾‹æ¥è®¾è®¡ç”Ÿæˆå®ä½“ç±»ä»£ç ï¼Ÿ</p>2025-04-27</li><br/><li><span>å®Œç¾åšæŒ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é‚¢è€å¸ˆæ€ä¹ˆçœ‹ä»Šå¤©ç™¾åº¦å®£å¸ƒå…¨é¢æ‹¥æŠ±MCPçš„äº‹æƒ…å‘€</p>2025-04-25</li><br/><li><span>ifelse</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å­¦ä¹ æ‰“å¡</p>2025-04-26</li><br/>
</ul>