ä½ å¥½ï¼Œæˆ‘æ˜¯é»„ä½³ã€‚

æ¬¢è¿æ¥åˆ°é›¶åŸºç¡€å®æˆ˜æœºå™¨å­¦ä¹ ã€‚åœ¨å‰é¢å‡ èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ äº†ä¸¤ç§ä¼˜åŒ–æœºå™¨å­¦ä¹ æ¨¡å‹çš„æ–¹æ³•ï¼Œä¸€ç§æ˜¯åšå„ç§ç‰¹å¾å·¥ç¨‹ï¼Œè®©ç‰¹å¾é›†æ›´é€‚åˆæ¨¡å‹ï¼›å¦ä¸€ç§æ˜¯é˜²æ­¢è¿‡æ‹Ÿåˆï¼Œè®©æ¨¡å‹ä¸ç”¨â€œé‚£ä¹ˆâ€ç²¾ç¡®ã€‚

è¿™ä¸¤ç§æ–¹å¼çš„ä¼˜åŒ–è§’åº¦ä¸åŒï¼Œç‰¹å¾å·¥ç¨‹æ˜¯ä»æ•°æ®é¢„å¤„ç†çš„è§’åº¦ï¼Œç»™å‡ºæ›´é«˜è´¨é‡çš„æ•°æ®ï¼Œè€Œé˜²æ­¢è¿‡æ‹Ÿåˆåˆ™æ˜¯åœ¨æ¨¡å‹è®­ç»ƒçš„è¿‡ç¨‹ä¸­ï¼Œæ§åˆ¶æ¨¡å‹çš„å¤æ‚åº¦ã€‚å…¶å®ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä»æ¨¡å‹çš„éªŒè¯å’Œè¯„ä¼°ç¯èŠ‚å…¥æ‰‹ï¼Œæ¥ä¼˜åŒ–æ¨¡å‹æ€§èƒ½ã€‚

## äº¤å‰éªŒè¯ï¼šå°æ•°æ®é›†çš„èµ„æºå¤ç”¨

ä½ çŸ¥é“ï¼Œåœ¨æ ·æœ¬å……è¶³çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šéšæœºå°†æ•°æ®åˆ†ä¸º3ä¸ªéƒ¨åˆ†ï¼šè®­ç»ƒé›†ã€éªŒè¯é›†å’Œæµ‹è¯•é›†ã€‚å…¶ä¸­ï¼Œè®­ç»ƒé›†ç”¨æ¥è®­ç»ƒæ¨¡å‹ï¼ŒéªŒè¯é›†ç”¨æ¥æ¨¡å‹è°ƒä¼˜ï¼Œæµ‹è¯•é›†ç”¨æ¥è¯„ä¼°æ¨¡å‹æ€§èƒ½ã€‚

ä¸è¿‡ï¼Œä½ è¿˜è®°ä¸è®°å¾—æˆ‘ä»¬åœ¨[ç¬¬1è®²](https://time.geekbang.org/column/article/413057)ä¸­ä»‹ç»ç›‘ç£å­¦ä¹ çš„æ—¶å€™ï¼Œæˆ‘è¯´è¿‡æœ‰æ ‡ç­¾çš„æ•°æ®æ˜¯éå¸¸éš¾ä»¥è·å¾—çš„ã€‚æœ¬æ¥å°±å¾ˆæœ‰é™çš„æ•°æ®é›†è¿˜è¦è¢«æ‹†æˆè®­ç»ƒé›†ã€æµ‹è¯•é›†å’ŒéªŒè¯é›†ï¼ŒçœŸæ˜¯è®©äººç‰¹åˆ«èˆä¸å¾—ã€‚

è€Œä¸”ï¼Œæˆ‘ä»¬çŸ¥é“æ•°æ®é›†è¶Šå¤§ï¼Œå°±è¶Šä¸å®¹æ˜“å‡ºç°è¿‡æ‹Ÿåˆçš„ç°è±¡ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•åˆ©ç”¨è¾ƒå°çš„æ•°æ®é›†ï¼Œä»è€Œè¾¾åˆ°è¾ƒå¤§æ•°æ®é›†çš„æ•ˆæœå‘¢ï¼Ÿè¿™å°±éœ€è¦äº¤å‰éªŒè¯ã€‚

äº¤å‰éªŒè¯çš„åŸºæœ¬æ€æƒ³æ˜¯è¿™æ ·çš„ï¼šå°†è®­ç»ƒæ•°æ®é›†åˆ†ä¸ºkç­‰ä»½ï¼Œå…¶ä¸­k-1ä»½ç”¨ä½œè®­ç»ƒé›†ï¼Œå•ç‹¬çš„é‚£ä¸€ä»½ç”¨ä½œéªŒè¯é›†ï¼Œæ•´ä¸ªè¿‡ç¨‹é‡å¤kæ¬¡ï¼Œè¿™ä¹Ÿé€šå¸¸ç§°ä½œkæŠ˜ã€‚è¿™æ ·å°±æœ€å¤§ç¨‹åº¦é‡å¤åœ°ä½¿ç”¨äº†è®­ç»ƒé›†ä¸­çš„æ•°æ®ï¼Œæ¯ä¸€ä¸ªæ•°æ®éƒ½æ—¢åšäº†è®­ç»ƒï¼Œåˆåšäº†æµ‹è¯•ï¼Œä»è€Œåœ¨æœ€å¤§ç¨‹åº¦ä¸Šæé«˜æ¨¡å‹æ€§èƒ½çš„å¯ä¿¡åº¦ã€‚

è¿™ç§äº¤å‰éªŒè¯å…·ä½“å®ç°èµ·æ¥æœ‰4ä¸ªæ­¥éª¤ï¼š

1. éšæœºæ¸…æ´—æ•°æ®é›†ï¼Œå°†æ•°æ®é›†åˆ†ä¸ºè®­ç»ƒé›†å’Œæµ‹è¯•é›†ï¼Œå°†æµ‹è¯•é›†é¢„ç•™å‡ºæ¥ï¼Œæ”¾åœ¨ä¸€è¾¹ã€‚
2. å°†è®­ç»ƒæ•°æ®é›†åˆ†æˆkç»„ï¼ˆè¿™ä¸ªkå€¼ä¸€èˆ¬æ˜¯éšæœºè®¾å®šï¼Œæ¯”å¦‚3ï¼Œ5ï¼Œ10ï¼Œå®æ“ä¸­ä»¥10æŠ˜å±…å¤šï¼‰ã€‚åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬æŒ‘å…¶ä¸­1ç»„ä½œä¸ºéªŒè¯é›†ï¼Œå‰©ä¸‹çš„k-1ç»„åšè®­ç»ƒé›†ï¼ˆè¿™ä¸ªè¿‡ç¨‹è¦é‡å¤kæ¬¡ï¼‰ã€‚æˆ‘ä»¬åœ¨è¿™äº›è®­ç»ƒé›†ä¸Šæ‹Ÿåˆæ¨¡å‹ï¼Œå¯ä»¥å¾—åˆ°kä¸ªä¸åŒçš„æ¨¡å‹ã€‚ç„¶åå†åœ¨å¯¹åº”çš„éªŒè¯é›†ä¸Šå¯¹è¿™äº›æ¨¡å‹è¿›è¡Œè¯„ä¼°ï¼Œå°±èƒ½å¾—åˆ°ä¸€ç³»åˆ—æ¨¡å‹çš„è¯„ä¼°åˆ†æ•°ã€‚æœ€åï¼Œæˆ‘ä»¬æŠŠè¿™äº›è¯„ä¼°åˆ†æ•°è¿›è¡Œå¹³å‡ï¼Œè¿™ä¸ªå¹³å‡åˆ†æ•°å°±æ˜¯äº¤å‰éªŒè¯çš„æœ€ç»ˆç»“æœäº†ã€‚
3. æŒ‰ç…§æ­¥éª¤1ã€2ï¼Œå¯¹å¤šä¸ªç®—æ³•è¿›è¡Œäº¤å‰éªŒè¯ï¼Œæ¯”å¦‚å¯ä»¥é’ˆå¯¹çº¿æ€§å›å½’ã€å†³ç­–æ ‘ã€éšæœºæ£®æ—ç­‰ç®—æ³•ã€‚æ ¹æ®æ¯ä¸ªç®—æ³•äº¤å‰éªŒè¯çš„è¯„ä¼°ç»“æœï¼Œä»ä¸­æŒ‘é€‰æ•ˆæœæœ€å¥½çš„ç®—æ³•æ¨¡å‹ã€‚
4. ä½¿ç”¨æµ‹è¯•é›†è¯„ä¼°æœ€ç»ˆæ¨¡å‹çš„åˆ†æ•°ã€‚

ç°åœ¨ï¼Œä½ åº”è¯¥å¾ˆæ¸…æ¥šäº†ï¼šæ¯ä¸ªæ•°æ®æ ·æœ¬éƒ½æœ‰1æ¬¡æœºä¼šè¿›å…¥éªŒè¯é›†ä¸­ï¼Œå¹¶ç”¨äºè®­ç»ƒæ¨¡å‹k-1æ¬¡ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±æ‹¥æœ‰äº†æ›´å¤šçš„æ•°æ®é‡ã€‚æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://static001.geekbang.org/resource/image/1f/27/1f97a858d3b5f4976a481b0e44210127.png?wh=341x225 "KæŠ˜äº¤å‰éªŒè¯ç¤ºæ„å›¾ ")

åœ¨äº¤å‰éªŒè¯ä¸­ï¼Œè®­ç»ƒé›†å’ŒéªŒè¯é›†çš„æ‹†åˆ†å¯ä»¥é€šè¿‡sklearn.model\_selectionä¸­çš„KFoldå‡½æ•°å®ç°ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæœ‰ä¸‰ä¸ªä¸»è¦å‚æ•°éœ€è¦æˆ‘ä»¬äº†è§£ä¸€ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/06/24/06cc789267e472b55125e52143b26f24.jpg?wh=2000x827)

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹äº¤å‰éªŒè¯çš„å®é™…ç”¨æ³•ã€‚è¿™é‡Œæˆ‘ä»¬ä»ç„¶å€Ÿç”¨[ç¬¬7è®²](https://time.geekbang.org/column/article/417479)ä¸­é¢„æµ‹ç”¨æˆ·LTVçš„çº¿æ€§å›å½’æ¨¡å‹model\_lrï¼Œæˆ‘ä»¬å…ˆç”¨KFold.splitå¯¹æ•°æ®é›†è¿›è¡Œæ‹†åˆ†ï¼Œç„¶åå¯¹æ¯ä¸€æŠ˜å¾ªç¯ï¼Œè®­ç»ƒå‡ºä¸åŒçš„æ¨¡å‹ï¼Œæœ€åç»™å‡ºä¸€ä¸ªéªŒè¯åˆ†æ•°ã€‚å®Œæ•´çš„ä»£ç ä½ å¯ä»¥ä»[è¿™é‡Œ](https://github.com/huangjia2019/geektime/tree/main/%E5%8F%98%E7%8E%B0%E5%85%B310)ä¸‹è½½ã€‚

```
from sklearn.model_selection import KFold #å¯¼å…¥KæŠ˜å·¥å…·
from sklearn.metrics import r2_score #å¯¼å…¥R2åˆ†æ•°è¯„ä¼°å·¥å…·
kf5 = KFold(n_splits=5, shuffle=False) #5æŠ˜éªŒè¯
i = 1 
for train_index, test_index in kf5.split(df_LTV): 
    X_train = df_LTV.iloc[train_index].drop(['å¹´åº¦LTV'],axis=1) #è®­ç»ƒé›†X
    X_test = df_LTV.iloc[test_index].drop(['å¹´åº¦LTV'],axis=1) #éªŒè¯é›†X
    y_train = df_LTV.iloc[train_index]['å¹´åº¦LTV'] #è®­ç»ƒé›†y
    y_test = df_LTV.loc[test_index]['å¹´åº¦LTV'] #éªŒè¯é›†y 
    model_lr.fit(X_train, y_train) #è®­ç»ƒæ¨¡å‹
    print(f"ç¬¬{i}æŠ˜éªŒè¯é›†R2åˆ†æ•°ï¼š{r2_score(y_test, model_lr.predict(X_test))}") 
    i += 1
```

è¾“å‡ºå¦‚ä¸‹ï¼š

```
ç¬¬1æŠ˜éªŒè¯é›†R2åˆ†æ•°ï¼š0.5143622747243847
ç¬¬2æŠ˜éªŒè¯é›†R2åˆ†æ•°ï¼š-0.16778272779470416
ç¬¬3æŠ˜éªŒè¯é›†R2åˆ†æ•°ï¼š0.23879516275929713
ç¬¬4æŠ˜éªŒè¯é›†R2åˆ†æ•°ï¼š0.2482389409435588
ç¬¬5æŠ˜éªŒè¯é›†R2åˆ†æ•°ï¼š0.03088299924007265
```

åœ¨å®é™…å®æˆ˜ä¸­ï¼Œsklearnè¿˜æä¾›äº†æ›´ç®€å•çš„æ–¹å¼ï¼Œæˆ‘ä»¬ä¸ç”¨è¿›è¡Œä¸Šé¢çš„KFoldæ‹†åˆ†è¿‡ç¨‹ï¼Œåªç”¨ä¸€ä¸ªcross\_val\_scoreå‡½æ•°å°±èƒ½ç›´æ¥å®Œæˆæ¨¡å‹çš„KæŠ˜æ‹†åˆ†ã€è®­ç»ƒå’ŒéªŒè¯ï¼Œä¸€æ¬¡æ€§å¾—åˆ°äº¤å‰éªŒè¯ç»“æœã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†ç”¨è¿™ç§æ–¹å¼æ¥è¯„ä¼°ä¸€ä¸‹åˆšæ‰çš„çº¿æ€§å›å½’æ¨¡å‹model\_lrï¼š

```
from sklearn.model_selection import cross_val_score # å¯¼å…¥äº¤å‰éªŒè¯å·¥å…·
# from sklearn.metrics import mean_squared_error #å¹³å‡ç»å¯¹è¯¯å·®
model_lr = LinearRegression() #çº¿æ€§å›å½’æ¨¡å‹
scores = cross_val_score(model_lr, #çº¿æ€§å›å½’
                  X_train, #ç‰¹å¾é›†
                  y_train, #æ ‡ç­¾é›†
                  cv=5, # äº”æŠ˜éªŒè¯
                  scoring = 'neg_mean_absolute_error') #å¹³å‡ç»å¯¹è¯¯å·®
for i, score in enumerate(scores):
    print(f"ç¬¬{i+1}æŠ˜éªŒè¯é›†å¹³å‡ç»å¯¹è¯¯å·®ï¼š {-score}")
```

è¿™é‡Œæˆ‘ä»¬æŠŠçº¿æ€§å›å½’æ¨¡å‹ä½œä¸ºå‚æ•°ä¼ å…¥cross\_val\_scoreå‡½æ•°ä¸­ï¼ŒåŒæ—¶é‡‡ç”¨5æŠ˜éªŒè¯ï¼Œè®¡ç®—å‡ºæ¯ä¸€æ¬¡éªŒè¯çš„å¹³å‡ç»å¯¹è¯¯å·®ï¼Œä¹Ÿå°±æ˜¯é¢„æµ‹å€¼å’ŒçœŸå€¼ä¹‹é—´çš„å¹³å‡å·®å¼‚ï¼Œè¯¯å·®ç»å¯¹å€¼è¶Šå¤§ï¼Œæ•ˆæœè¶Šä¸å¥½ã€‚

è¾“å‡ºçš„æ¯ä¸€æŠ˜å¹³å‡ç»å¯¹è¯¯å·®å€¼å¦‚ä¸‹ï¼š

```
ç¬¬1æŠ˜éªŒè¯é›†å¹³å‡ç»å¯¹è¯¯å·®ï¼š3191.99882739
ç¬¬2æŠ˜éªŒè¯é›†å¹³å‡ç»å¯¹è¯¯å·®ï¼š1402.45679102
ç¬¬3æŠ˜éªŒè¯é›†å¹³å‡ç»å¯¹è¯¯å·®ï¼š1168.49187113
ç¬¬4æŠ˜éªŒè¯é›†å¹³å‡ç»å¯¹è¯¯å·®ï¼š1546.15537555
ç¬¬5æŠ˜éªŒè¯é›†å¹³å‡ç»å¯¹è¯¯å·®ï¼š1138.41271054
```

çœ‹çš„å‡ºæ¥ï¼Œé‡‡ç”¨ä¸åŒçš„è®­ç»ƒé›†å’ŒéªŒè¯é›†ç»„åˆï¼Œå¾—åˆ°çš„æ¨¡å‹åˆ†æ•°ä¸åŒã€‚æœ€åï¼Œæˆ‘ä»¬å†æŠŠè¿™5æŠ˜çš„éªŒè¯ç»“æœè¿›è¡Œå¹³å‡ï¼Œå¾—åˆ°5æŠ˜äº¤å‰éªŒè¯çš„å¹³å‡åˆ†æ•°ã€‚è¿™ä¸ªåˆ†æ•°ï¼Œå°†æ¯”ä»…æ‹†åˆ†ä¸€æ¬¡è®­ç»ƒé›†/éªŒè¯é›†å¾—åˆ°çš„è¯„ä¼°ç»“æœæ›´ä¸ºç¨³å®šã€‚

æˆ‘è¿™é‡Œè¦å¼ºè°ƒçš„æ˜¯ï¼Œäº¤å‰éªŒè¯è™½ç„¶ä¸€ç›´åœ¨ç”¨ä¸åŒçš„æ•°æ®æ‹†åˆ†è¿›è¡Œæ¨¡å‹çš„æ‹Ÿåˆï¼Œä½†å®ƒå®é™…ä¸Šå¹¶ä¸æ˜¯åœ¨è¯•å›¾è®­ç»ƒå‡ºæ–°çš„æ¨¡å‹ï¼Œå®ƒåªæ˜¯æˆ‘ä»¬å¯¹æ¨¡å‹çš„ä¸€ç§è¯„ä¼°æ–¹å¼è€Œå·²ã€‚

å¥½äº†ï¼Œå…³äºäº¤å‰éªŒè¯ï¼Œæˆ‘ä»¬å°±è¯´åˆ°è¿™é‡Œï¼Œä¸‹é¢æˆ‘è®²ä¸€ä¸ªå¯¹ä½ æ¥è¯´éå¸¸å®ç”¨çš„é—®é¢˜ï¼šå¦‚ä½•è°ƒå‚ã€‚

## ç½‘æ ¼æœç´¢ï¼šç›´åˆ°æ‰¾åˆ°æœ€ä¼˜çš„å‚æ•°

ä¸€ä¸ªå¤æ‚çš„æœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œæœ‰å¯èƒ½æœ‰ä¸€å¤§å †è¶…å‚æ•°ï¼Œæ¨¡å‹çš„æ€§èƒ½å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºè¶…å‚æ•°çš„å€¼ã€‚ä»€ä¹ˆè¶…å‚æ•°æ˜¯æœ€å¥½çš„ï¼Ÿé‚£å¯ä¸ä¸€å®šï¼Œå› ä¸ºé’ˆå¯¹ä¸åŒçš„é—®é¢˜è€Œè¨€ï¼Œæœ€ä½³çš„å‚æ•°ä¸€ç›´åœ¨å˜åŒ–ï¼Œè€Œä¸”åŸºæœ¬ä¸Šæ²¡æœ‰å¤ªå¤šè§„å¾‹å¯å¾ªã€‚é‚£äº›æœºå™¨å­¦ä¹ è€æ‰‹å¾ˆå¯èƒ½ä¼šå‘Šè¯‰ä½ ï¼šè°ƒå‚å¯æ˜¯è¦é æ„Ÿè§‰ã€é ç›´è§‰çš„ï¼Œä½ è°ƒçš„å¤šäº†ï¼Œæ„Ÿè§‰ä¹Ÿå°±å‡ºæ¥äº†ã€‚

è¿™æ ·çš„ç­”æ¡ˆä¼šè®©å’±ä»¬è¿™ç§æ–°æ‰‹ååˆ†å¤´ç–¼ï¼Œæ²¡æœ‰ä»€ä¹ˆç»éªŒæ€ä¹ˆé’ˆå¯¹å½“å‰æœºå™¨å­¦ä¹ ä»»åŠ¡å’Œå½“å‰æ•°æ®é›†æ‰¾åˆ°æœ€å¥½çš„å‚æ•°ï¼Ÿéš¾é“è¦æ‰‹å·¥çš„ä¸€ä¸ªä¸€ä¸ªå°è¯•å—ï¼Ÿæˆ‘ä»¬ä¹‹å‰å­¦è¿‡çš„çº¿æ€§å›å½’æ¨¡å‹ï¼Œåªæœ‰ä¸¤ä¸ªä¸»è¦è¶…å‚æ•°ï¼Œè€Œä¸”æ˜¯å¸ƒå°”å‹å˜é‡ï¼Œç»„åˆèµ·æ¥æ˜¯4ç§æƒ…å†µï¼Œè¿™è¿˜å¯ä»¥è°ƒä¸€è°ƒã€‚ä½†æ˜¯åƒéšæœºæ£®æ—è¿™ç§æ¯”è¾ƒå¤æ‚çš„æ¨¡å‹ï¼Œå‚æ•°éå¸¸å¤šï¼Œæ€ä¹ˆå¯èƒ½ä¸€ä¸ªä¸ªå»è¯•å‘¢ï¼Ÿ

ä½ ä¸ç”¨æ‹…å¿ƒï¼Œ **scikit-learnä¸­æœ‰ä¸€ä¸ªGridSearchCVå·¥å…·ï¼Œä¸­æ–‡å«åšç½‘æ ¼æœç´¢ï¼Œå ªç§°æ˜¯è¾…åŠ©æˆ‘ä»¬è‡ªåŠ¨è°ƒå‚çš„ç¥å™¨**ï¼Œå®ƒå¯ä»¥å¸®æˆ‘ä»¬è‡ªåŠ¨è°ƒå‚ï¼Œè½»æ¾æ‰¾åˆ°æ¨¡å‹çš„æœ€ä¼˜å‚æ•°ã€‚

é‚£ä¹ˆï¼Œæ€ä¹ˆç”¨è¿™ä¸ªç½‘æ ¼æœç´¢å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦åšçš„æœ‰è¿™å‡ æ­¥ï¼š

- ç¬¬ä¸€æ­¥ï¼Œæ˜ç¡®ä½ é€‰æ‹©çš„æ¨¡å‹æœ‰å“ªäº›å¯è°ƒçš„å‚æ•°ï¼Œè¿™ä¸ªä½ å¯ä»¥é€šè¿‡æŸ¥çœ‹ç®—æ³•çš„è¯´æ˜æ–‡æ¡£æ¥ç¡®å®šï¼›
- ç¬¬äºŒæ­¥ï¼ŒæŠŠæ¨¡å‹ä¸­å„è¶…å‚æ•°ä¸åŒå–å€¼çš„æ’åˆ—ç»„åˆå°½å¯èƒ½å¤šåœ°åˆ—å‡ºæ¥ï¼›
- ç¬¬ä¸‰æ­¥ï¼Œè°ƒç”¨GridSearchCVå·¥å…·ï¼ŒæŠŠå¯èƒ½çš„æ’åˆ—ç»„åˆéƒ½ä¼ è¿›å»ã€‚

å®Œæˆè¿™ä¸‰æ­¥åï¼ŒGridSearchCVä¼šåœ¨åå°åˆ›å»ºå‡ºä¸€å¤§å †çš„å¹¶è¡Œè¿›ç¨‹ï¼ŒæŒ¨ä¸ªæ‰§è¡Œå„ç§è¶…å‚æ•°çš„ç»„åˆï¼ŒåŒæ—¶è¿˜ä¼šä½¿ç”¨äº¤å‰éªŒè¯çš„æ–¹æ³•ï¼ˆåç§°ä¸­çš„CVï¼Œæ„æ€å°±æ˜¯cross validationï¼‰ï¼Œæ¥è¯„ä¼°æ¯ä¸ªè¶…å‚æ•°ç»„åˆçš„æ¨¡å‹ã€‚æœ€åï¼ŒGridSearchCVä¼šå¸®ä½ é€‰å®šå“ªä¸ªç»„åˆæ˜¯ç»™å®šæ¨¡å‹çš„æœ€ä½³è¶…å‚æ•°å€¼ã€‚

å¥½ï¼Œä¸‹é¢æˆ‘ä»¬å°±åŸºäº[ç¬¬7è®²](https://time.geekbang.org/column/article/417479)ä¸­çš„LTVé¢„æµ‹é¡¹ç›®ï¼Œçœ‹çœ‹æ€ä¹ˆç”¨GridSearchCVé€‰å‡ºéšæœºæ£®æ—æ¨¡å‹æ¯”è¾ƒå¥½çš„å‚æ•°ç»„åˆï¼ˆåœ¨ä¹‹å‰çš„å®æˆ˜ä¸­ï¼Œæ¨¡å‹çš„å‚æ•°éƒ½é€‰æ‹©çš„æ˜¯é»˜è®¤å€¼ï¼‰ã€‚

åœ¨è°ƒç”¨GridSearchCVè°ƒå‚ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆæ‰¾å‡ºéšæœºæ£®æ—å›å½’æ¨¡å‹ä¸­æœ‰å“ªäº›å‚æ•°ï¼Œæœ€å¥½çš„æ–¹æ³•è¿˜æ˜¯å»[sklearnå®˜ç½‘](https://scikit-learn.org/stable/)æŸ¥çœ‹ã€‚æˆ‘ä»¬åœ¨è¿™å„¿æ‹¿å‡ºä¸€äº›é‡è¦çš„è¶…å‚æ•°æ¥è°ƒä¸€ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/68/fa/687c464e312272c66397ea795fa91efa.jpg?wh=2000x1016)

æˆ‘ä»¬çŸ¥é“ï¼Œéšæœºæ£®æ—æ˜¯ç”±å¤šæ£µå†³ç­–æ ‘é›†åˆè€Œæˆçš„ç®—æ³•ï¼Œæ‰€ä»¥ï¼Œè¿™äº›å‚æ•°éƒ½å’Œå„å†³ç­–æ ‘çš„ç”Ÿæˆå’Œå‰ªæè¿‡ç¨‹ç›¸å…³ã€‚ä¸Šé¢è¿™äº›å‚æ•°ï¼Œæˆ‘ä»¬å¹¶ä¸ä¸€å®šè¦å®Œå…¨ç†è§£å®ƒä»¬çš„ä½œç”¨ï¼Œå› ä¸ºæˆ‘ä»¬çš„é‡ç‚¹ä¸æ˜¯å»è¯¦ç»†äº†è§£æ¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œè€Œæ˜¯è®©GridSearchCVè‡ªåŠ¨æ‰¾åˆ°å¯¹äºæˆ‘ä»¬å½“å‰ä»»åŠ¡åˆé€‚çš„è¶…å‚æ•°ç»„åˆã€‚

æ‰¾å‡ºéšæœºæ£®æ—æ¨¡å‹çš„å‚æ•°åï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç¨‹åºä¸­å®šä¹‰ä¸€ä¸ªå­—å…¸å¯¹è±¡ï¼Œåˆ—å‡ºå„ä¸ªè¶…å‚æ•°ï¼Œä»¥åŠæˆ‘ä»¬å¸Œæœ›å»å°è¯•çš„å€¼ç»„åˆï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„ä»£ç ã€‚åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘å®šä¹‰äº†rfr\_param\_gridå­—å…¸å¯¹è±¡ï¼Œå¹¶åœ¨å­—å…¸ä¸­æŒ‡å®šäº†ä¸€ç³»åˆ—å‚æ•°å€¼çš„ç»„åˆï¼Œä¸¾ä¾‹æ¥è¯´ï¼Œå¯¹äºn\_estimatorsè¿™ä¸ªå‚æ•°æˆ‘å°±é€‰æ‹©äº†100å’Œ300ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥å°è¯•ä»»æ„å…¶å®ƒçš„å€¼ã€‚

```
model_rfr = RandomForestClassifier() # éšæœºæ£®æ—æ¨¡å‹
# å¯¹éšæœºæ£®æ—ç®—æ³•è¿›è¡Œå‚æ•°ä¼˜åŒ–
rf_param_grid = {"max_depth": [None],
                  "max_features": [3, 5, 12],
                  "min_samples_split": [2, 5, 10],
                  "min_samples_leaf": [3, 5, 10],
                  "bootstrap": [False],
                  "n_estimators" :[100,300],
                  "criterion": ["gini"]}
```

ç„¶åï¼Œåœ¨è¦è°ƒç”¨GridSearchCV æ¥è¿›è¡Œè¶…å‚æ•°æœç´¢ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹GridSearchCVè¿™ä¸ªå‡½æ•°æœ¬èº«æœ‰ä»€ä¹ˆéœ€è¦è®¾å®šçš„å‚æ•°ã€‚

![](https://static001.geekbang.org/resource/image/e1/53/e1c2dc9127e70f050e3e2014d3b41853.jpg?wh=2000x1147)

ä¸‹é¢æˆ‘ä»¬æ¥è°ƒç”¨GridSearchCVè¿™ä¸ªå‡½æ•°ï¼š

```
from sklearn.model_selection import GridSearchCV # å¯¼å…¥ç½‘æ ¼æœç´¢å·¥å…·
model_rfr_gs = GridSearchCV(model_rfr,
                            param_grid = rfr_param_grid, cv=3,
                            scoring="r2", n_jobs= 10, verbose = 1)
model_rfr_gs.fit(X_train, y_train) # ç”¨ä¼˜åŒ–åçš„å‚æ•°æ‹Ÿåˆè®­ç»ƒæ•°æ®é›†
```

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘å°†GridSearchCVè¿”å›çš„æœ€ä½³å‚æ•°ç»„åˆå­˜å‚¨åœ¨äº†rfr\_gsè¿™ä¸ªæ–°çš„éšæœºæ£®æ—æ¨¡å‹ã€‚

ç„¶åï¼Œç³»ç»Ÿå°±ä¼šè‡ªåŠ¨è®¡ç®—æ¯ç§è¶…å‚æ•°ç»„åˆæ‹Ÿåˆå‡ºçš„æ¨¡å‹çš„å‡†ç¡®ç‡/æŸå¤±ï¼š

```
Fitting 3 folds for each of 432 candidates, totalling 1296 fits
[Parallel(n_jobs=10)]: Using backend LokyBackend with 10 concurrent workers.
[Parallel(n_jobs=10)]: Done  30 tasks      | elapsed:   22.0s
[Parallel(n_jobs=10)]: Done 180 tasks      | elapsed:  2.0min
[Parallel(n_jobs=10)]: Done 430 tasks      | elapsed:  4.8min
[Parallel(n_jobs=10)]: Done 780 tasks      | elapsed:  8.7min
[Parallel(n_jobs=10)]: Done 1230 tasks      | elapsed: 12.6min
[Parallel(n_jobs=10)]: Done 1296 out of 1296 | elapsed: 13.2min finished
```

ä½ è¦æ³¨æ„çš„æ˜¯ï¼Œéšæœºæ£®æ—æ¨¡å‹å¯èƒ½çš„è¶…å‚æ•°ç»„åˆéå¸¸å¤šï¼Œå› æ­¤è¿™ä¸ªè®­ç»ƒè¿‡ç¨‹åœ¨æˆ‘ä»¬çš„ç”µè„‘ä¸Šå¯èƒ½ä¼šæŒç»­å¾ˆä¹…å¾ˆä¹…ï¼Œæ‰€ä»¥æˆ‘ç‰¹æ„æ²¡æœ‰è®¾å®šå¤ªå¤šçš„å‚æ•°ç»„åˆï¼Œè€Œæ˜¯é€‰å–äº†å…¶ä¸­ä¸€éƒ¨åˆ†ã€‚ä¸è¿‡ï¼Œè¿™ä¸ªè®­ç»ƒè¿‡ç¨‹ä¹Ÿæ˜¯èŠ±äº†åå‡ åˆ†é’Ÿæ‰æœç´¢å®Œã€‚

ç»è¿‡GridSearchCVè‡ªåŠ¨åœ°æ¢å‚ã€æ‹Ÿåˆå¹¶è‡ªåŠ¨äº¤å‰éªŒè¯è¯„ä¼°åï¼Œæœ€ä½³å‚æ•°ç»„åˆå®é™…ä¸Šå·²ç»è¢«é€‰å‡ºäº†ï¼Œå®ƒå°±è¢«å­˜å‚¨åœ¨model\_rfr\_gsè¿™ä¸ªæ–°çš„éšæœºæ£®æ—ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨å®ƒæ¥åšé¢„æµ‹ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬è°ƒç”¨model\_rfr\_gsçš„best\_params\_å±æ€§ï¼Œæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæœ€ä¼˜æ¨¡å‹æ˜¯ç”±å“ªäº›è¶…å‚æ•°ç»„åˆè€Œæˆçš„ï¼š

```
print(" æœ€ä½³å‚æ•°ç»„åˆ:", model_rfr_gs.best_params_)
```

è¾“å‡ºå¦‚ä¸‹ï¼š

```
æœ€ä½³å‚æ•°ç»„åˆ: {'bootstrap': True, 'max_depth': 10, 'max_features': 'sqrt', 'min_samples_leaf': 2, 'min_samples_split': 2, 'n_estimators': 50}
```

ç„¶åï¼Œæˆ‘ä»¬çœ‹çœ‹ GridSearchCV æ¨¡å‹çš„å‡†ç¡®æ€§ã€‚

```
from sklearn.metrics import r2_score,   median_absolute_error #å¯¼å…¥Sklearnè¯„ä¼°æ¨¡å—
print('è®­ç»ƒé›†ä¸Šçš„Rå¹³æ–¹åˆ†æ•°-è°ƒå‚åçš„éšæœºæ£®æ—: %0.4f' % r2_score(y_train, model_rfr_gs.predict(X_train)))
print('æµ‹è¯•é›†ä¸Šçš„Rå¹³æ–¹åˆ†æ•°-è°ƒå‚åçš„éšæœºæ£®æ—: %0.4f' % r2_score(y_valid, model_rfr_gs.predict(X_valid)))
```

è¾“å‡ºå¦‚ä¸‹ï¼š

```
è®­ç»ƒé›†ä¸Šçš„Rå¹³æ–¹åˆ†æ•°-éšæœºæ£®æ—: 0.7729
æµ‹è¯•é›†ä¸Šçš„Rå¹³æ–¹åˆ†æ•°-éšæœºæ£®æ—: 0.6523
```

è¿™ä¸ªåˆ†æ•°éœ€è¦å’Œä»¥å‰åªè°ƒç”¨éšæœºæ£®æ—æ¨¡å‹é»˜è®¤å‚æ•°çš„ç»“æœè¿›è¡Œæ¯”è¾ƒï¼Œæ‰€ä»¥ï¼Œåœ¨è¿™é‡Œæˆ‘å¯¹è¿™ä¸ªæ¨¡å‹è®­ç»ƒäº†ä¸¤æ¬¡ï¼šä¸€æ¬¡ä¸ä½¿ç”¨ GridsearchCVï¼ˆä½¿ç”¨é»˜è®¤è¶…å‚æ•°ï¼‰ï¼›å¦ä¸€æ¬¡æˆ‘ä»¬ä½¿ç”¨ GridSearchCV æ‰¾åˆ°è¶…å‚æ•°æœ€ä½³å€¼ã€‚ä¸‹é¢æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹è¿™ä¸¤æ¬¡çš„åˆ†æ•°ï¼š

![](https://static001.geekbang.org/resource/image/7f/fe/7faff6e1e1ee9fb72d05ce817f467efe.png?wh=384x262)

ç»“æœæ˜¾ç¤ºï¼Œç»è¿‡ç½‘æ ¼æœç´¢å‚æ•°è°ƒä¼˜ä¹‹åï¼Œè™½ç„¶è®­ç»ƒé›†ä¸Šçš„åˆ†æ•°é™ä½äº†ï¼Œä½†æ˜¯åœ¨éªŒè¯é›†ä¸Šé¢çš„åˆ†æ•°æå‡äº†ï¼ŒçœŸæ£’ï¼

å­¦åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šè®¤ä¸ºä¸Šé¢è¿™ä¸€ç»„å‚æ•°æ˜¯éšæœºæ£®æ—å›å½’æ¨¡å‹è¶…å‚æ•°çš„æœ€ä½³å€¼ã€‚ä½†äº‹å®å¹¶éå¦‚æ­¤ï¼Œä¸Šè¿°è¶…å‚æ•°å¯¹äºæˆ‘ä»¬æ­£åœ¨å¤„ç†çš„æ•°æ®é›†å¯èƒ½æ˜¯æœ€ä½³é€‰æ‹©ï¼Œä½†æ˜¯å¯¹å…¶ä»–æ•°æ®é›†æœªå¿…é€‚ç”¨ã€‚

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å­¦å®Œäº†ä¸¤ä¸ªä¼˜åŒ–æŠ€å·§ï¼Œå†åŠ ä¸Šæˆ‘ä»¬åœ¨å‰é¢ä¸¤è®²ä¸­å­¦çš„ç‰¹å¾å·¥ç¨‹å’Œæ­£åˆ™åŒ–æŠ€æœ¯ï¼Œä½ åœ¨æœºå™¨å­¦ä¹ æ€§èƒ½è°ƒä¼˜è¿™å—ï¼Œå°±æœ‰äº†åŸºæœ¬çš„ç†è®ºå’Œå®è·µçŸ¥è¯†ã€‚æ­å–œä½ æ­£å¼é—¯è¿‡â€œå˜ç°å…³â€ï¼

## æ€»ç»“ä¸€ä¸‹

è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬å­¦äº†ä¸¤ä¸ªå’Œæ¨¡å‹ä¼˜åŒ–ç›¸å…³çš„æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯äº¤å‰éªŒè¯å’Œç½‘æ ¼æœç´¢ã€‚

äº¤å‰éªŒè¯æ˜¯æœºå™¨å­¦ä¹ è®­ç»ƒå’ŒéªŒè¯æ¨¡å‹æ—¶æœ‰æ•ˆåˆ©ç”¨æ•°æ®çš„æ–¹æ³•ï¼Œå®ƒçš„åŸºæœ¬æ€è·¯å°±æ˜¯é‡å¤çš„ä½¿ç”¨æ•°æ®ï¼ŒæŠŠæ ·æœ¬æ•°æ®è¿›è¡Œåˆ‡åˆ†ï¼Œç„¶åé‡ç»„ä¸ºä¸åŒçš„è®­ç»ƒé›†å’ŒéªŒè¯é›†ã€‚ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒæŸæ¬¡è®­ç»ƒé›†ä¸­çš„æŸä¸ªæ ·æœ¬åœ¨ä¸‹æ¬¡å°±å¯èƒ½æˆä¸ºéªŒè¯é›†ä¸­çš„æ ·æœ¬ï¼Œæ‰€ä»¥è¢«ç§°ä½œâ€œäº¤å‰â€ã€‚

ç½‘æ ¼æœç´¢æ˜¯å¸®æˆ‘ä»¬ä¼˜åŒ–æ¨¡å‹è¶…å‚æ•°çš„æŠ€æœ¯ï¼Œå®ƒåœ¨æœ¬è´¨ä¸Šæ˜¯ä¸€ç§ç©·ä¸¾æ³•ã€‚å¯¹äºæ¯ä¸ªè¶…å‚æ•°ï¼Œæˆ‘ä»¬éƒ½ä¼šæŒ‡å®šä¸€äº›å¯èƒ½çš„å€¼ã€‚ç„¶åï¼ŒGridSearchCVä¼šç»„åˆè¿™äº›å‚æ•°å€¼å¾—åˆ°è‹¥å¹²ç»„è¶…å‚æ•°ï¼Œå¹¶ä½¿ç”¨æ¯ç»„è¶…å‚æ•°æ¥è®­ç»ƒæ¨¡å‹ï¼Œæœ€åæŒ‘é€‰å‡ºéªŒè¯é›†ä¸Šè¯¯å·®æœ€å°çš„è¶…å‚æ•°ï¼Œæ¥ä½œä¸ºè¯¥æ¨¡å‹çš„æœ€ä¼˜è¶…å‚æ•°ã€‚

è¿™ä¸¤ä¸ªå·¥å…·ä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ï¼Œä½ å¯ä»¥é€šè¿‡ä»£ç åå¤æ¼”ç»ƒå®ƒä»¬ï¼Œå°è¯•å„ç§ä¸åŒçš„éªŒè¯æŠ˜æ•°å’Œæ¨¡å‹è¶…å‚æ•°ã€‚

é‚£æˆªæ­¢åˆ°è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å®é™…ä¸Šå·²ç»å­¦ä¹ äº†å››ä¸ªæå‡æœºå™¨å­¦ä¹ æ¨¡å‹æ•ˆç‡çš„æ³•å®ï¼Œå®ƒä»¬éƒ½ç‰¹åˆ«é‡è¦ã€‚åœ¨è¿™é‡Œæˆ‘ä¹Ÿå¸®ä½ å¤ä¹ ä¸€ä¸‹ï¼š

1. **ç‰¹å¾å·¥ç¨‹**ï¼šç›®æ ‡æ˜¯æé«˜æ•°æ®ç‰¹å¾ä¸æ¨¡å‹çš„åŒ¹é…åº¦ï¼Œæˆ‘ä»¬æ€»ç»“äº†ç‰¹å¾é€‰æ‹©ã€ç‰¹å¾å˜æ¢å’Œç‰¹å¾æ„å»ºä¸‰ä¸ªæ€è·¯æ¥å¸®åŠ©ä½ è§£å†³å…·ä½“é—®é¢˜ã€‚
2. **é˜²è¿‡æ‹Ÿåˆ**ï¼šè¿‡æ‹Ÿåˆå°±æ˜¯æ¨¡å‹é’ˆå¯¹è®­ç»ƒé›†ï¼Œæ‹Ÿåˆç¨‹åº¦è¿‡é«˜ï¼Œå¤±å»äº†åœ¨æ–°æ•°æ®é›†ä¸Šæ³›åŒ–çš„èƒ½åŠ›ã€‚æˆ‘ä»¬çš„æ¨¡å‹è¦åœ¨æ‹Ÿåˆå’Œæ³›åŒ–ä¹‹é—´ä¿æŒä¸€ä¸ªå¹³è¡¡ã€‚
3. **äº¤å‰éªŒè¯**ï¼šäº¤å‰éªŒè¯å¯ä»¥å¸®æˆ‘ä»¬åˆ©ç”¨å¥½æœ‰é™çš„æ•°æ®é›†ã€‚ä½ è¦æ³¨æ„ï¼Œæˆ‘ä»¬è¯´çš„è¿‡æ‹Ÿåˆä¹Ÿæœ‰å¯èƒ½ä¸æ˜¯æ¨¡å‹å¯¼è‡´çš„ï¼Œè€Œå¯èƒ½æ˜¯å› ä¸ºæ•°æ®é›†åˆ’åˆ†ä¸åˆç†é€ æˆçš„ï¼Œè¿™åœ¨æ¯”è¾ƒå°çš„æ•°æ®é›†ä¸Šå°¤ä¸ºæ˜æ˜¾ã€‚æ‰€ä»¥ï¼Œäº¤å‰éªŒè¯æ‰€å¾—åˆ°çš„å¤šæ¬¡è¯„ä¼°ç»“æœï¼Œèƒ½å¤Ÿé¿å…æŸä¸€æ¬¡æ•°æ®é›†åˆ’åˆ†ä¸åˆç†æ‰€å¸¦æ¥çš„åå·®ã€‚
4. **å‚æ•°è°ƒä¼˜**ï¼šæ¯ä¸€ç§ç®—æ³•éƒ½æœ‰å±äºè‡ªå·±çš„ä¸€ç³»åˆ—å¯è°ƒè¶…å‚æ•°ï¼ˆå¤–éƒ¨å‚æ•°ï¼‰ï¼Œä½ è¦å°½åŠ›æ‰¾åˆ°å¯¹äºå½“å‰æ•°æ®é›†è€Œè¨€æœ€å¥½çš„ä¸€å¥—å‚æ•°ã€‚

åœ¨ä¸‹ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬å°†å¼€å¯æ¿€æ´»å…³ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æœŸå¾…å§ï¼

## æ€è€ƒé¢˜

è¿™èŠ‚è¯¾å°±åˆ°è¿™é‡Œäº†ï¼Œæœ€åï¼Œæˆ‘æƒ³ç»™ä½ ç•™ä¸‰ä¸ªæ€è€ƒé¢˜ï¼š

1. é™¤äº†æœ€ç®€å•çš„äº¤å‰éªŒè¯å‡½æ•°cross\_val\_scoreä¹‹å¤–ï¼Œsklearnè¿˜æä¾›å¦å¤–ä¸€ä¸ªå‡½æ•°cross\_validateï¼Œè¿™ä¸ªå‡½æ•°å’Œcross\_val\_scoreçš„åŒºåˆ«æœ‰ä¸¤ç‚¹ï¼šä¸€æ˜¯å®ƒå…è®¸æŒ‡å®šå¤šä¸ªè¯„ä¼°æŒ‡æ ‡ï¼›äºŒæ˜¯å®ƒè¿”å›çš„ä¿¡æ¯æ›´ä¸°å¯Œï¼Œé™¤è¯„ä¼°åˆ†æ•°ä¹‹å¤–ï¼Œå®ƒè¿˜è¿”å›ä¸€ä¸ªåŒ…å«æ‹Ÿåˆæ—¶é—´ã€åˆ†æ•°æ—¶é—´ã€ä»¥åŠå¯é€‰çš„è®­ç»ƒé›†åˆ†æ•°å’Œæ‹Ÿåˆæ¨¡å‹çš„å­—å…¸ã€‚è¯·ä½ å°è¯•ä½¿ç”¨è¿™ä¸ªå‡½æ•°ï¼Œå¹¶åˆ†æå®ƒè¿”å›çš„ä¿¡æ¯ã€‚

æç¤ºï¼š

```
   scores = cross_validate(lasso, X, y, cv=3,
                             scoring=('r2', 'neg_mean_squared_error'),
                            return_train_score=True)
```

2. é™¤äº†æ™®é€šçš„KFoldæ–¹æ³•ä¹‹å¤–ï¼Œè¿˜æœ‰é‡å¤KæŠ˜RepeatedKFoldã€ç•™ä¸€æ³•åˆ†æŠ˜LeaveOneOutã€ç•™å¤šæ³•åˆ†æŠ˜LeavePOutç­‰å˜ä½“ï¼Œä¹Ÿå¯ä»¥ä¸ºæ•°æ®åˆ†æŠ˜ï¼Œé‚£ä¹ˆã€‚è¯·ä½ å°è¯•ç”¨è¿™äº›æ–¹æ³•æ¥æ‹†åˆ†æ•°æ®ï¼Œåšäº¤å‰éªŒè¯ã€‚

æç¤ºï¼š

```
from sklearn.model_selection import RepeatedKFold
from sklearn.model_selection import LeaveOneOut
from sklearn.model_selection import LeavePOut
... 
>>> loo = LeaveOneOut()
>>> for train, test in loo.split(X):
...     print("%s %s" % (train, test))
```

3. é™¤GridSearchCVä¹‹å¤–ï¼Œsklearnè¿˜æä¾›äº†å¦ä¸€ä¸ªç½‘æ ¼æœç´¢APIï¼Œå«RandomizedSearchCVï¼Œä¸­æ–‡åæ˜¯éšæœºæœç´¢ã€‚å¯¹äºå®Œå…¨ç›¸åŒçš„å‚æ•°ç©ºé—´ï¼Œéšæœºæœç´¢è¿è¡Œæ—¶é—´æ¯”èµ·ç½‘æ ¼æœç´¢ä¼šå¤§å¤§é™ä½ï¼Œè¿™æ˜¯å› ä¸ºå®ƒé‡‡ç”¨çš„æ˜¯éšæœºå‚æ•°ç»„åˆã€‚ä¸è¿‡ï¼Œéšæœºæœç´¢è¿”å›çš„æ¨¡å‹æ€§èƒ½å¯èƒ½ä¼šç¨å·®ï¼Œè¿™å°±æ˜¯æ—¶é—´å’Œæœ€ä¼˜æ€§èƒ½çš„ä¸€ç§æƒè¡¡ã€‚è¯·ä½ å°è¯•ä½¿ç”¨RandomizedSearchCVè¿›è¡Œæœç´¢ï¼Œæ‰¾åˆ°æ¯”è¾ƒå¥½çš„è¶…å‚æ•°ã€‚

æç¤ºï¼š

```
from sklearn.model_selection import RandomizedSearchCV
random_search = RandomizedSearchCV(clf, param_distributions=param_dist,
                                   n_iter=n_iter_search)
```

æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æƒ³æ³•å’Œæ”¶è·ï¼Œæˆ‘åœ¨ç•™è¨€åŒºç­‰ä½ ã€‚å¦‚æœè¿™èŠ‚è¯¾å¸®åˆ°äº†ä½ ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™è‡ªå·±çš„æœ‹å‹ã€‚æˆ‘ä»¬ä¸‹ä¸€è®²å†è§ï¼

![](https://static001.geekbang.org/resource/image/f1/23/f16f468d8e15018923564b9e7a784a23.jpg?wh=2284x1280)
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ10ï¼‰</strong></div><ul>
<li><span>åœ¨è·¯ä¸Š</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä½³å“¥å¥½ï¼Œäº¤å‰éªŒè¯ä¼šå¾—åˆ°å¤šä¸ªæ¨¡å‹ï¼Œåœ¨é¢„æµ‹æ•°æ®æ—¶ï¼Œæ˜¯æŠŠå¤šä¸ªæ¨¡å‹çš„é¢„æµ‹å€¼åŠ æ€»æ±‚å¹³å‡å€¼å—ï¼Ÿ</p>2021-09-22</li><br/><li><span>Siyige2727</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è€å¸ˆå¥½ï¼Œæˆ‘æŒ‰ç…§ä¸‹é¢çš„è®¾ç½®ï¼Œè·‘å‡ºçš„ç»“æœï¼Œä¸ºä»€ä¹ˆéªŒè¯é›†ä¸Šçš„åˆ†æ•°å¾ˆä½å‘¢ï¼Ÿ
GridSearchCV(cv=3, estimator=RandomForestRegressor(), n_jobs=10,
             param_grid={&#39;bootstrap&#39;: [True, False],
                         &#39;criterion&#39;: [&#39;mse&#39;, &#39;mae&#39;],
                         &#39;max_depth&#39;: [3, 5, 6, 10, 12, None],
                         &#39;max_features&#39;: [&#39;auto&#39;, &#39;sqrt&#39;],
                         &#39;min_samples_leaf&#39;: [2, 3, 5, 7, 10],
                         &#39;min_samples_split&#39;: [2, 5, 8, 10],
                         &#39;n_estimators&#39;: [50]},
             scoring=&#39;r2&#39;, verbose=1)

è®­ç»ƒé›†ä¸Šçš„Rå¹³æ–¹åˆ†æ•°-è°ƒå‚åçš„éšæœºæ£®æ—: 0.8541
æµ‹è¯•é›†ä¸Šçš„Rå¹³æ–¹åˆ†æ•°-è°ƒå‚åçš„éšæœºæ£®æ—: 0.0481</p>2021-09-22</li><br/><li><span>é™é™å‘€</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆæˆ‘çš„ç½‘æ ¼æœç´¢æŠ¥é”™äº†ï¼ŒValueError: Unknown label type: &#39;continuous&#39;ï¼Œèƒ½å¸®æˆ‘çœ‹çœ‹æ˜¯ä»€ä¹ˆåŸå› å—
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import GridSearchCV
from sklearn.model_selection import train_test_split
X = df_LTV.drop([&#39;ç”¨æˆ·ç &#39;,&#39;å¹´åº¦LTV&#39;],axis=1) #ç‰¹å¾é›†
y = df_LTV[&#39;å¹´åº¦LTV&#39;] #æ ‡ç­¾é›†
# æ‹†åˆ†æˆè®­ç»ƒé›†å’Œæµ‹è¯•é›† 
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state = 0)
model_rfr = RandomForestClassifier() # éšæœºæ£®æ—æ¨¡å‹
# å¯¹éšæœºæ£®æ—ç®—æ³•è¿›è¡Œå‚æ•°ä¼˜åŒ–
rf_param_grid = {&quot;max_depth&quot;: [None],
                  &quot;max_features&quot;: [3, 5, 12],
                  &quot;min_samples_split&quot;: [2, 5, 10],
                  &quot;min_samples_leaf&quot;: [3, 5, 10],
                  &quot;bootstrap&quot;: [False],
                  &quot;n_estimators&quot; :[100,300],
                  &quot;criterion&quot;: [&quot;gini&quot;]}
model_rfr_gs = GridSearchCV(model_rfr,
                            param_grid = rf_param_grid, cv=3,
                            scoring=&quot;r2&quot;, n_jobs= 10, verbose = 1)
model_rfr_gs.fit(X_train, y_train) </p>2023-11-08</li><br/><li><span>åˆ˜æˆ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å®Œæˆä¸€ä¸ªé˜¶æ®µäº†ï¼ŒåšæŒå­¦å®Œ</p>2024-04-06</li><br/><li><span>è´è´</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç•™è„šå°</p>2024-03-30</li><br/><li><span>Vincent</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆä½ å¥½ï¼Œå…³äº CV æœ‰ä¸ªç–‘é—®ï¼ŒCV æ˜¯ç”¨æ¥è¯„ä¼°æ¨¡å‹çš„ï¼Œè€Œä¸æ˜¯ç”¨æ¥è®­ç»ƒçš„ã€‚å¦‚æœæˆ‘ä»¬è¯„ä¼°å‡ºæœ€ä¼˜çš„ç®—æ³•ï¼Œåç»­ç”¨ä»€ä¹ˆæ–¹å¼è®­ç»ƒæ¨¡å‹å‘¢ï¼ŸæŠŠè®­ç»ƒé›†å’ŒéªŒè¯é›†åˆå¹¶æ¥è®­ç»ƒï¼Ÿ</p>2024-01-05</li><br/><li><span>Matthew</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä½œä¸š3çš„ä»£ç ï¼š

# åˆ›å»ºæ¨¡å‹
from sklearn.ensemble import RandomForestRegressor
model_rfr = RandomForestRegressor()

# å¯¹éšæœºæ£®æ—ç®—æ³•è¿›è¡Œå‚æ•°ä¼˜åŒ–
rfr_param_grid = {&#39;bootstrap&#39;: [True, False],
                 &#39;max_depth&#39;: [10, 50, 100, None],
                 &#39;max_features&#39;: [&#39;auto&#39;, &#39;sqrt&#39;],
                 &#39;min_samples_leaf&#39;: [1, 2, 4],
                 &#39;min_samples_split&#39;: [2, 5, 10],
                 &#39;n_estimators&#39;: [50, 500, 2000]}

# å¯¼å…¥ ç½‘æ ¼æœç´¢ å·¥å…·
from sklearn.model_selection import GridSearchCV 
model_rfr_gs = GridSearchCV(model_rfr,
                            param_grid = rfr_param_grid, cv = 3,
                            scoring=&quot;r2&quot;, n_jobs= 10, verbose = 1)
model_rfr_gs.fit(X_train, y_train) # ç”¨ä¼˜åŒ–åçš„å‚æ•°æ‹Ÿåˆè®­ç»ƒæ•°æ®é›†
print(&quot; GridSearchCV æœ€ä½³å‚æ•°ç»„åˆ:&quot;, model_rfr_gs.best_params_)

# å¯¼å…¥ éšæœºæœç´¢ å·¥å…·
from sklearn.model_selection import RandomizedSearchCV
model_rfr_rs = RandomizedSearchCV(model_rfr, 
                                  param_distributions = rfr_param_grid, cv = 3, 
                                  n_iter = 10, 
                                  scoring=&quot;r2&quot;, n_jobs= 10, verbose = 1)
model_rfr_rs.fit(X_train, y_train) # ç”¨ä¼˜åŒ–åçš„å‚æ•°æ‹Ÿåˆè®­ç»ƒæ•°æ®é›†
print(&quot; RandomizedSearchCV æœ€ä½³å‚æ•°ç»„åˆ:&quot;, model_rfr_rs.best_params_)

from sklearn.metrics import r2_score,   median_absolute_error #å¯¼å…¥Sklearnè¯„ä¼°æ¨¡å—
print(&quot;GridSearchCVï¼š&quot;)
print(&#39;è®­ç»ƒé›†ä¸Šçš„Rå¹³æ–¹åˆ†æ•°-è°ƒå‚åçš„éšæœºæ£®æ—: %0.4f&#39; % r2_score(y_train, model_rfr_gs.predict(X_train)))
print(&#39;æµ‹è¯•é›†ä¸Šçš„Rå¹³æ–¹åˆ†æ•°-è°ƒå‚åçš„éšæœºæ£®æ—: %0.4f&#39; % r2_score(y_test, model_rfr_gs.predict(X_test)))

print(&quot;RandomizedSearchCVï¼š&quot;)
print(&#39;è®­ç»ƒé›†ä¸Šçš„Rå¹³æ–¹åˆ†æ•°-è°ƒå‚åçš„éšæœºæ£®æ—: %0.4f&#39; % r2_score(y_train, model_rfr_rs.predict(X_train)))
print(&#39;æµ‹è¯•é›†ä¸Šçš„Rå¹³æ–¹åˆ†æ•°-è°ƒå‚åçš„éšæœºæ£®æ—: %0.4f&#39; % r2_score(y_test, model_rfr_rs.predict(X_test)))</p>2023-06-04</li><br/><li><span>Matthew</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p># ç•™ä¸€æ³•åˆ†æŠ˜ LeaveOneOut
loo = LeaveOneOut()
for fold_, (train_index, test_index) in enumerate(loo.split(df_LTV)):
    X_train = df_LTV.iloc[train_index].drop([&#39;å¹´åº¦LTV&#39;],axis=1) #è®­ç»ƒé›†X
    X_test = df_LTV.iloc[test_index].drop([&#39;å¹´åº¦LTV&#39;],axis=1) #éªŒè¯é›†X
    y_train = df_LTV.iloc[train_index][&#39;å¹´åº¦LTV&#39;] #è®­ç»ƒé›†y
    y_test = df_LTV.loc[test_index][&#39;å¹´åº¦LTV&#39;] #éªŒè¯é›†y 
    model_lr.fit(X_train, y_train) #è®­ç»ƒæ¨¡å‹
    # print(f&quot;ç¬¬{fold_}æŠ˜éªŒè¯é›†R2åˆ†æ•°ï¼š{r2_score(y_test, model_lr.predict(X_test))}&quot;) 
    print(f&quot;ç¬¬{fold_}æŠ˜éªŒè¯é›†çš„çœŸå€¼ï¼š{y_test.values[0]} ,é¢„æµ‹å€¼ï¼š{model_lr.predict(X_test)[0]}&quot;) 

# ç•™å¤šæ³•åˆ†æŠ˜ LeavePOut
lpo = LeavePOut(p=10)   
for fold_, (train_index, test_index) in enumerate(lpo.split(df_LTV)):
    X_train = df_LTV.iloc[train_index].drop([&#39;å¹´åº¦LTV&#39;],axis=1) #è®­ç»ƒé›†X
    X_test = df_LTV.iloc[test_index].drop([&#39;å¹´åº¦LTV&#39;],axis=1) #éªŒè¯é›†X
    y_train = df_LTV.iloc[train_index][&#39;å¹´åº¦LTV&#39;] #è®­ç»ƒé›†y
    y_test = df_LTV.loc[test_index][&#39;å¹´åº¦LTV&#39;] #éªŒè¯é›†y 
    model_lr.fit(X_train, y_train) #è®­ç»ƒæ¨¡å‹
    print(f&quot;ç¬¬{fold_}æŠ˜éªŒè¯é›†R2åˆ†æ•°ï¼š{r2_score(y_test, model_lr.predict(X_test))}&quot;) </p>2023-06-03</li><br/><li><span>Matthew</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä½œä¸š2çš„ä»£ç ï¼š

# åˆ›å»ºæ¨¡å‹
from sklearn.linear_model import LinearRegression
model_lr = LinearRegression()

# å¯¼å…¥KæŠ˜å·¥å…·
from sklearn.model_selection import KFold 
from sklearn.model_selection import RepeatedKFold
from sklearn.model_selection import LeaveOneOut 
from sklearn.model_selection import LeavePOut

# å¯¼å…¥R2åˆ†æ•°è¯„ä¼°å·¥å…·
from sklearn.metrics import r2_score 

# æ™®é€šçš„ KFold æ–¹æ³•
kf5 = KFold(n_splits=5, shuffle=False) #5æŠ˜
for fold_, (train_index, test_index) in enumerate(kf5.split(df_LTV)): 
    # print(train_index, test_index)
    X_train = df_LTV.iloc[train_index].drop([&#39;å¹´åº¦LTV&#39;],axis=1) #è®­ç»ƒé›†X
    X_test = df_LTV.iloc[test_index].drop([&#39;å¹´åº¦LTV&#39;],axis=1) #éªŒè¯é›†X
    y_train = df_LTV.iloc[train_index][&#39;å¹´åº¦LTV&#39;] #è®­ç»ƒé›†y
    y_test = df_LTV.loc[test_index][&#39;å¹´åº¦LTV&#39;] #éªŒè¯é›†y 
    model_lr.fit(X_train, y_train) #è®­ç»ƒæ¨¡å‹
    print(f&quot;ç¬¬{fold_}æŠ˜éªŒè¯é›†R2åˆ†æ•°ï¼š{r2_score(y_test, model_lr.predict(X_test))}&quot;) 

# é‡å¤ K æŠ˜ RepeatedKFold
rkf5 = RepeatedKFold(n_splits=5, n_repeats=10) # 5æŠ˜ï¼Œé‡å¤10æ¬¡
for fold_, (train_index, test_index) in enumerate(rkf5.split(df_LTV)):
    X_train = df_LTV.iloc[train_index].drop([&#39;å¹´åº¦LTV&#39;],axis=1) #è®­ç»ƒé›†X
    X_test = df_LTV.iloc[test_index].drop([&#39;å¹´åº¦LTV&#39;],axis=1) #éªŒè¯é›†X
    y_train = df_LTV.iloc[train_index][&#39;å¹´åº¦LTV&#39;] #è®­ç»ƒé›†y
    y_test = df_LTV.loc[test_index][&#39;å¹´åº¦LTV&#39;] #éªŒè¯é›†y 
    model_lr.fit(X_train, y_train) #è®­ç»ƒæ¨¡å‹
    print(f&quot;ç¬¬{fold_}æŠ˜éªŒè¯é›†R2åˆ†æ•°ï¼š{r2_score(y_test, model_lr.predict(X_test))}&quot;) </p>2023-06-03</li><br/><li><span>Matthew</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä½œä¸š1çš„ä»£ç å’Œç»“æœï¼š

# åˆ›å»ºæ¨¡å‹
from sklearn.linear_model import Lasso
model_lasso = Lasso() #åˆ›å»ºLassoå›å½’æ¨¡å‹

# äº¤å‰éªŒè¯
from sklearn.model_selection import cross_validate # å¯¼å…¥äº¤å‰éªŒè¯å·¥å…·
cv = 3
scores = cross_validate(model_lasso, X, y, cv=cv, scoring=(&#39;r2&#39;, &#39;neg_mean_squared_error&#39;), return_train_score=True)

for i in range(cv):
    print(f&quot;ç¬¬{i+1}æŠ˜éªŒè¯é›†çš„fit_timeï¼š{scores[&#39;fit_time&#39;][i]} &quot;)
    print(f&quot;ç¬¬{i+1}æŠ˜éªŒè¯é›†çš„score_timeï¼š{scores[&#39;score_time&#39;][i]} &quot;)
    print(f&quot;ç¬¬{i+1}æŠ˜éªŒè¯é›†çš„test_r2ï¼š{scores[&#39;test_r2&#39;][i]} &quot;)
    print(f&quot;ç¬¬{i+1}æŠ˜éªŒè¯é›†çš„train_r2ï¼š{scores[&#39;train_r2&#39;][i]} &quot;)
    print(f&quot;ç¬¬{i+1}æŠ˜éªŒè¯é›†çš„test_neg_mean_squared_errorï¼š{-scores[&#39;test_neg_mean_squared_error&#39;][i]} &quot;)
    print(f&quot;ç¬¬{i+1}æŠ˜éªŒè¯é›†çš„train_neg_mean_squared_errorï¼š{-scores[&#39;train_neg_mean_squared_error&#39;][i]} &quot;)
    print(&quot;\n&quot;)
--------------------------------------------------------------------
ç¬¬1æŠ˜éªŒè¯é›†çš„fit_timeï¼š0.000865936279296875 
ç¬¬1æŠ˜éªŒè¯é›†çš„score_timeï¼š0.0006310939788818359 
ç¬¬1æŠ˜éªŒè¯é›†çš„test_r2ï¼š0.5509442176019284 
ç¬¬1æŠ˜éªŒè¯é›†çš„train_r2ï¼š0.49295429721273365 
ç¬¬1æŠ˜éªŒè¯é›†çš„test_neg_mean_squared_errorï¼š36374278.87442617 
ç¬¬1æŠ˜éªŒè¯é›†çš„train_neg_mean_squared_errorï¼š3931052.5016323677 


ç¬¬2æŠ˜éªŒè¯é›†çš„fit_timeï¼š0.0009672641754150391 
ç¬¬2æŠ˜éªŒè¯é›†çš„score_timeï¼š0.0004417896270751953 
ç¬¬2æŠ˜éªŒè¯é›†çš„test_r2ï¼š-0.547095575701684 
ç¬¬2æŠ˜éªŒè¯é›†çš„train_r2ï¼š0.756077640106148 
ç¬¬2æŠ˜éªŒè¯é›†çš„test_neg_mean_squared_errorï¼š19259422.630117264 
ç¬¬2æŠ˜éªŒè¯é›†çš„train_neg_mean_squared_errorï¼š10686185.198631434 


ç¬¬3æŠ˜éªŒè¯é›†çš„fit_timeï¼š0.000530242919921875 
ç¬¬3æŠ˜éªŒè¯é›†çš„score_timeï¼š0.0004150867462158203 
ç¬¬3æŠ˜éªŒè¯é›†çš„test_r2ï¼š0.0975132893938776 
ç¬¬3æŠ˜éªŒè¯é›†çš„train_r2ï¼š0.6571299228574952 
ç¬¬3æŠ˜éªŒè¯é›†çš„test_neg_mean_squared_errorï¼š2236906.201517424 
ç¬¬3æŠ˜éªŒè¯é›†çš„train_neg_mean_squared_errorï¼š16312807.147477873 </p>2023-06-02</li><br/>
</ul>