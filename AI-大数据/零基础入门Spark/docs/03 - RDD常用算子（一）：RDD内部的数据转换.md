ä½ å¥½ï¼Œæˆ‘æ˜¯å´ç£Šã€‚

åœ¨ä¸Šä¸€è®²çš„æœ€åï¼Œæˆ‘ä»¬ç”¨ä¸€å¼ è¡¨æ ¼æ•´ç†äº†Spark[å®˜ç½‘](https://spark.apache.org/docs/latest/rdd-programming-guide.html)ç»™å‡ºçš„RDDç®—å­ã€‚æƒ³è¦åœ¨Sparkä¹‹ä¸Šå¿«é€Ÿå®ç°ä¸šåŠ¡é€»è¾‘ï¼Œç†è§£å¹¶æŒæ¡è¿™äº›ç®—å­æ— ç–‘æ˜¯è‡³å…³é‡è¦çš„ã€‚

å› æ­¤ï¼Œåœ¨æ¥ä¸‹æ¥çš„å‡ è®²ï¼Œæˆ‘å°†å¸¦ä½ ä¸€èµ·æ¢³ç†è¿™äº›å¸¸è§ç®—å­çš„ç”¨æ³•ä¸ç”¨é€”ã€‚ä¸åŒçš„ç®—å­ï¼Œå°±åƒæ˜¯å¨æˆ¿é‡Œçš„ç‚’å‹ºã€é“²å­ã€åˆ€å…·å’Œå„å¼å„æ ·çš„é”…ç¢—ç“¢ç›†ï¼Œåªæœ‰ç†Ÿæ‚‰äº†è¿™äº›â€œå¨å…·â€çš„æ“ä½œæ–¹æ³•ï¼Œæ‰èƒ½åœ¨å®¢äººç‚¹é¤çš„æ—¶å€™è¿…é€Ÿåœ°åšå‡ºä¸€æ¡Œå¥½èœã€‚

ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬å…ˆæ¥å­¦ä¹ åŒä¸€ä¸ªRDDå†…éƒ¨çš„æ•°æ®è½¬æ¢ã€‚æŒæ¡RDDå¸¸ç”¨ç®—å­æ˜¯åšå¥½Sparkåº”ç”¨å¼€å‘çš„åŸºç¡€ï¼Œè€Œæ•°æ®è½¬æ¢ç±»ç®—å­åˆ™æ˜¯åŸºç¡€ä¸­çš„åŸºç¡€ï¼Œå› æ­¤æˆ‘ä»¬ä¼˜å…ˆæ¥å­¦ä¹ è¿™ç±»RDDç®—å­ã€‚

åœ¨è¿™äº›ç®—å­ä¸­ï¼Œæˆ‘ä»¬é‡ç‚¹è®²è§£çš„å°±æ˜¯mapã€mapPartitionsã€flatMapã€filterã€‚è¿™4ä¸ªç®—å­å‡ ä¹å›Šæ‹¬äº†æ—¥å¸¸å¼€å‘ä¸­99%çš„æ•°æ®è½¬æ¢åœºæ™¯ï¼Œå‰©ä¸‹çš„mapPartitionsWithIndexï¼Œæˆ‘æŠŠå®ƒç•™ç»™ä½ ä½œä¸ºè¯¾åä½œä¸šå»æ¢ç´¢ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/a3/88/a3ec138b50456604bae8ce22cdf56788.jpg?wh=1599x1885 "RDDç®—å­åˆ†ç±»è¡¨")

ä¿—è¯è¯´ï¼Œå·§å¦‡éš¾ä¸ºæ— ç±³ä¹‹ç‚Šï¼Œè¦æƒ³ç©è½¬å¨æˆ¿é‡Œçš„å¨å…·ï¼Œæˆ‘ä»¬å¾—å…ˆå‡†å¤‡å¥½ç±³ã€é¢ã€æ²¹è¿™äº›é£Ÿæã€‚å­¦ä¹ RDDç®—å­ä¹Ÿæ˜¯ä¸€æ ·ï¼Œè¦æƒ³åŠ¨æ‰‹æ“ä½œè¿™äº›ç®—å­ï¼Œå’±ä»¬å¾—å…ˆæœ‰RDDæ‰è¡Œã€‚

æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¸€èµ·æ¥çœ‹çœ‹RDDæ˜¯æ€ä¹ˆåˆ›å»ºçš„ã€‚

## åˆ›å»ºRDD

åœ¨Sparkä¸­ï¼Œåˆ›å»ºRDDçš„å…¸å‹æ–¹å¼æœ‰ä¸¤ç§ï¼š

- é€šè¿‡SparkContext.parallelizeåœ¨**å†…éƒ¨æ•°æ®**ä¹‹ä¸Šåˆ›å»ºRDDï¼›
- é€šè¿‡SparkContext.textFileç­‰APIä»**å¤–éƒ¨æ•°æ®**åˆ›å»ºRDDã€‚

è¿™é‡Œçš„å†…éƒ¨ã€å¤–éƒ¨æ˜¯ç›¸å¯¹åº”ç”¨ç¨‹åºæ¥è¯´çš„ã€‚å¼€å‘è€…åœ¨Sparkåº”ç”¨ä¸­è‡ªå®šä¹‰çš„å„ç±»æ•°æ®ç»“æ„ï¼Œå¦‚æ•°ç»„ã€åˆ—è¡¨ã€æ˜ å°„ç­‰ï¼Œéƒ½å±äºâ€œå†…éƒ¨æ•°æ®â€ï¼›è€Œâ€œå¤–éƒ¨æ•°æ®â€æŒ‡ä»£çš„ï¼Œæ˜¯Sparkç³»ç»Ÿä¹‹å¤–çš„æ‰€æœ‰æ•°æ®å½¢å¼ï¼Œå¦‚æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿæˆ–æ˜¯åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ•°æ®ï¼Œå†æ¯”å¦‚æ¥è‡ªå…¶ä»–å¤§æ•°æ®ç»„ä»¶ï¼ˆHiveã€Hbaseã€RDBMSç­‰ï¼‰çš„æ•°æ®ã€‚

ç¬¬ä¸€ç§åˆ›å»ºæ–¹å¼çš„ç”¨æ³•éå¸¸ç®€å•ï¼Œåªéœ€è¦ç”¨parallelizeå‡½æ•°æ¥å°è£…å†…éƒ¨æ•°æ®å³å¯ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š

```scala
import org.apache.spark.rdd.RDD
val words: Array[String] = Array("Spark", "is", "cool")
val rdd: RDD[String] = sc.parallelize(words)
```

ä½ å¯ä»¥åœ¨spark-shellä¸­æ•²å…¥ä¸Šè¿°ä»£ç ï¼Œæ¥ç›´è§‚åœ°æ„Ÿå—parallelizeåˆ›å»ºRDDçš„è¿‡ç¨‹ã€‚é€šå¸¸æ¥è¯´ï¼Œåœ¨Sparkåº”ç”¨å†…å®šä¹‰ä½“é‡è¶…å¤§çš„æ•°æ®é›†ï¼Œå…¶å®éƒ½æ˜¯ä¸å¤ªåˆé€‚çš„ï¼Œå› ä¸ºæ•°æ®é›†å®Œå…¨ç”±Driverç«¯åˆ›å»ºï¼Œä¸”åˆ›å»ºå®Œæˆåï¼Œè¿˜è¦åœ¨å…¨ç½‘èŒƒå›´å†…è·¨èŠ‚ç‚¹ã€è·¨è¿›ç¨‹åœ°åˆ†å‘åˆ°å…¶ä»–Executorsï¼Œæ‰€ä»¥å¾€å¾€ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ã€‚å› æ­¤ï¼Œparallelize APIçš„å…¸å‹ç”¨æ³•ï¼Œæ˜¯åœ¨â€œå°æ•°æ®â€ä¹‹ä¸Šåˆ›å»ºRDDã€‚

è¦æƒ³åœ¨çœŸæ­£çš„â€œå¤§æ•°æ®â€ä¹‹ä¸Šåˆ›å»ºRDDï¼Œæˆ‘ä»¬è¿˜å¾—ä¾èµ–ç¬¬äºŒç§åˆ›å»ºæ–¹å¼ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡SparkContext.textFileç­‰APIä»**å¤–éƒ¨æ•°æ®**åˆ›å»ºRDDã€‚ç”±äºtextFile APIæ¯”è¾ƒç®€å•ï¼Œè€Œä¸”å®ƒåœ¨æ—¥å¸¸çš„å¼€å‘ä¸­å‡ºç°é¢‘ç‡æ¯”è¾ƒé«˜ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨textFile APIæ¥åˆ›å»ºRDDã€‚åœ¨åç»­å¯¹å„ç±»RDDç®—å­è®²è§£çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éƒ½ä¼šä½¿ç”¨textFile APIä»æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºRDDã€‚

ä¸ºäº†ä¿æŒè®²è§£çš„è¿è´¯æ€§ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ç¬¬ä¸€è®²ä¸­çš„æºæ–‡ä»¶wikiOfSpark.txtæ¥åˆ›å»ºRDDï¼Œä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š

```scala
import org.apache.spark.rdd.RDD
val rootPath: String = _
val file: String = s"${rootPath}/wikiOfSpark.txt"
// è¯»å–æ–‡ä»¶å†…å®¹
val lineRDD: RDD[String] = spark.sparkContext.textFile(file)
```

å¥½å•¦ï¼Œåˆ›å»ºå¥½äº†RDDï¼Œæˆ‘ä»¬å°±æœ‰äº†å¯ä»¥ä¸‹é”…çš„é£Ÿæã€‚æ¥ä¸‹æ¥ï¼Œå’±ä»¬å°±è¦æ­£å¼åœ°èµ°è¿›å¨æˆ¿ï¼ŒæŠŠé“²å­å’Œç‚’å‹ºæŒ¥èµ·æ¥å•¦ã€‚

## RDDå†…çš„æ•°æ®è½¬æ¢

é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥è®¤è¯†ä¸€ä¸‹mapç®—å­ã€‚æ¯«ä¸å¤¸å¼ åœ°è¯´ï¼Œåœ¨æ‰€æœ‰çš„RDDç®—å­ä¸­ï¼Œmapâ€œå‡ºåœºâ€çš„æ¦‚ç‡æ˜¯æœ€é«˜çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»è¦æŒæ¡mapçš„ç”¨æ³•ä¸æ³¨æ„äº‹é¡¹ã€‚

### mapï¼šä»¥å…ƒç´ ä¸ºç²’åº¦çš„æ•°æ®è½¬æ¢

æˆ‘ä»¬å…ˆæ¥è¯´è¯´mapç®—å­çš„ç”¨æ³•ï¼š**ç»™å®šæ˜ å°„å‡½æ•°fï¼Œmap(f)ä»¥å…ƒç´ ä¸ºç²’åº¦å¯¹RDDåšæ•°æ®è½¬æ¢ã€‚**å…¶ä¸­få¯ä»¥æ˜¯å¸¦æœ‰æ˜ç¡®ç­¾åçš„å¸¦åå‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯åŒ¿åå‡½æ•°ï¼Œå®ƒçš„å½¢å‚ç±»å‹å¿…é¡»ä¸RDDçš„å…ƒç´ ç±»å‹ä¿æŒä¸€è‡´ï¼Œè€Œè¾“å‡ºç±»å‹åˆ™ä»»ç”±å¼€å‘è€…è‡ªè¡Œå†³å®šã€‚

è¿™ç§ç…§æœ¬å®£ç§‘çš„ä»‹ç»å¬ä¸Šå»éš¾å…ä¼šè®©ä½ æœ‰ç‚¹æ‡µï¼Œåˆ«ç€æ€¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç”¨äº›å°ä¾‹å­æ¥æ›´åŠ ç›´è§‚åœ°å±•ç¤ºmapçš„ç”¨æ³•ã€‚

åœ¨[ç¬¬ä¸€è®²](https://time.geekbang.org/column/article/415209)çš„Word Countç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼ŒæŠŠåŒ…å«å•è¯çš„RDDè½¬æ¢æˆå…ƒç´ ä¸ºï¼ˆKeyï¼ŒValueï¼‰å¯¹çš„RDDï¼Œåè€…ç»Ÿç§°ä¸ºPaired RDDã€‚

```scala
// æŠŠæ™®é€šRDDè½¬æ¢ä¸ºPaired RDD
val cleanWordRDD: RDD[String] = _ // è¯·å‚è€ƒç¬¬ä¸€è®²è·å–å®Œæ•´ä»£ç 
val kvRDD: RDD[(String, Int)] = cleanWordRDD.map(word => (word, 1))
```

åœ¨ä¸Šé¢çš„ä»£ç å®ç°ä¸­ï¼Œä¼ é€’ç»™mapç®—å­çš„å½¢å‚ï¼Œå³ï¼šword =&gt; ï¼ˆwordï¼Œ1ï¼‰ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´çš„æ˜ å°„å‡½æ•°fã€‚åªä¸è¿‡ï¼Œè¿™é‡Œfæ˜¯ä»¥åŒ¿åå‡½æ•°çš„æ–¹å¼è¿›è¡Œå®šä¹‰çš„ï¼Œå…¶ä¸­å·¦ä¾§çš„wordè¡¨ç¤ºåŒ¿åå‡½æ•°fçš„è¾“å…¥å½¢å‚ï¼Œè€Œå³ä¾§çš„ï¼ˆwordï¼Œ1ï¼‰åˆ™ä»£è¡¨å‡½æ•°fçš„è¾“å‡ºç»“æœã€‚

å¦‚æœæˆ‘ä»¬æŠŠåŒ¿åå‡½æ•°å˜æˆå¸¦åå‡½æ•°çš„è¯ï¼Œå¯èƒ½ä½ ä¼šçœ‹çš„æ›´æ¸…æ¥šä¸€äº›ã€‚è¿™é‡Œæˆ‘ç”¨ä¸€æ®µä»£ç é‡æ–°å®šä¹‰äº†å¸¦åå‡½æ•°fã€‚

```scala
// æŠŠRDDå…ƒç´ è½¬æ¢ä¸ºï¼ˆKeyï¼ŒValueï¼‰çš„å½¢å¼
Â 
// å®šä¹‰æ˜ å°„å‡½æ•°f
def f(word: String): (String, Int) = {
return (word, 1)
}
Â 
val cleanWordRDD: RDD[String] = _ // è¯·å‚è€ƒç¬¬ä¸€è®²è·å–å®Œæ•´ä»£ç 
val kvRDD: RDD[(String, Int)] = cleanWordRDD.map(f)
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä½¿ç”¨Scalaçš„defè¯­æ³•ï¼Œæ˜ç¡®å®šä¹‰äº†å¸¦åæ˜ å°„å‡½æ•°fï¼Œå®ƒçš„è®¡ç®—é€»è¾‘ä¸åˆšåˆšçš„åŒ¿åå‡½æ•°æ˜¯ä¸€è‡´çš„ã€‚åœ¨åšRDDæ•°æ®è½¬æ¢çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€æŠŠå‡½æ•°fä¼ é€’ç»™mapç®—å­å³å¯ã€‚ä¸ç®¡fæ˜¯åŒ¿åå‡½æ•°ï¼Œè¿˜æ˜¯å¸¦åå‡½æ•°ï¼Œmapç®—å­çš„è½¬æ¢é€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½ ä¸å¦¨æŠŠä»¥ä¸Šä¸¤ç§å®ç°æ–¹å¼åˆ†åˆ«æ•²å…¥åˆ°spark-shellï¼Œå»éªŒè¯æ‰§è¡Œç»“æœçš„ä¸€è‡´æ€§ã€‚

åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œæˆ‘ä»¬å°±æŒæ¡äº†mapç®—å­çš„åŸºæœ¬ç”¨æ³•ã€‚ç°åœ¨ä½ å°±å¯ä»¥å®šä¹‰ä»»æ„å¤æ‚çš„æ˜ å°„å‡½æ•°fï¼Œç„¶ååœ¨RDDä¹‹ä¸Šé€šè¿‡è°ƒç”¨map(f)å»ç¿»ç€èŠ±æ ·åœ°åšå„ç§å„æ ·çš„æ•°æ®è½¬æ¢ã€‚

æ¯”å¦‚ï¼Œé€šè¿‡å®šä¹‰å¦‚ä¸‹çš„æ˜ å°„å‡½æ•°fï¼Œæˆ‘ä»¬å°±å¯ä»¥æ”¹å†™Word Countçš„è®¡æ•°é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯æŠŠâ€œSparkâ€è¿™ä¸ªå•è¯çš„ç»Ÿè®¡è®¡æ•°æƒé‡æé«˜ä¸€å€ï¼š

```scala
// æŠŠRDDå…ƒç´ è½¬æ¢ä¸ºï¼ˆKeyï¼ŒValueï¼‰çš„å½¢å¼
Â 
// å®šä¹‰æ˜ å°„å‡½æ•°f
def f(word: String): (String, Int) = {
if (word.equals("Spark")) { return (word, 2) }
return (word, 1)
}
Â 
val cleanWordRDD: RDD[String] = _ // è¯·å‚è€ƒç¬¬ä¸€è®²è·å–å®Œæ•´ä»£ç 
val kvRDD: RDD[(String, Int)] = cleanWordRDD.map(f)
```

å°½ç®¡mapç®—å­è¶³å¤Ÿçµæ´»ï¼Œå…è®¸å¼€å‘è€…è‡ªç”±å®šä¹‰è½¬æ¢é€»è¾‘ã€‚ä¸è¿‡ï¼Œå°±åƒæˆ‘ä»¬åˆšåˆšè¯´çš„ï¼Œmap(f)æ˜¯ä»¥å…ƒç´ ä¸ºç²’åº¦å¯¹RDDåšæ•°æ®è½¬æ¢çš„ï¼Œåœ¨æŸäº›è®¡ç®—åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªç‰¹ç‚¹ä¼šä¸¥é‡å½±å“æ‰§è¡Œæ•ˆç‡ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ã€‚

æ¯”æ–¹è¯´ï¼Œæˆ‘ä»¬æŠŠWord Countçš„è®¡æ•°éœ€æ±‚ï¼Œä»åŸæ¥çš„å¯¹å•è¯è®¡æ•°ï¼Œæ”¹ä¸ºå¯¹å•è¯çš„å“ˆå¸Œå€¼è®¡æ•°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ä»£ç å®ç°éœ€è¦åšå“ªäº›æ”¹åŠ¨å‘¢ï¼Ÿæˆ‘æ¥ç¤ºèŒƒä¸€ä¸‹ï¼š

```scala
// æŠŠæ™®é€šRDDè½¬æ¢ä¸ºPaired RDD
Â 
import java.security.MessageDigest
Â 
val cleanWordRDD: RDD[String] = _ // è¯·å‚è€ƒç¬¬ä¸€è®²è·å–å®Œæ•´ä»£ç 
Â 
val kvRDD: RDD[(String, Int)] = cleanWordRDD.map{ word =>
  // è·å–MD5å¯¹è±¡å®ä¾‹
  val md5 = MessageDigest.getInstance("MD5")
  // ä½¿ç”¨MD5è®¡ç®—å“ˆå¸Œå€¼
  val hash = md5.digest(word.getBytes).mkString
  // è¿”å›å“ˆå¸Œå€¼ä¸æ•°å­—1çš„Pair
  (hash, 1)
}
```

ç”±äºmap(f)æ˜¯ä»¥å…ƒç´ ä¸ºå•å…ƒåšè½¬æ¢çš„ï¼Œé‚£ä¹ˆå¯¹äºRDDä¸­çš„æ¯ä¸€æ¡æ•°æ®è®°å½•ï¼Œæˆ‘ä»¬éƒ½éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªMessageDigestå¯¹è±¡æ¥è®¡ç®—è¿™ä¸ªå…ƒç´ çš„å“ˆå¸Œå€¼ã€‚

åœ¨å·¥ä¸šçº§ç”Ÿäº§ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªRDDåŠ¨è¾„åŒ…å«ä¸Šç™¾ä¸‡ç”šè‡³æ˜¯ä¸Šäº¿çº§åˆ«çš„æ•°æ®è®°å½•ï¼Œå¦‚æœå¤„ç†æ¯æ¡è®°å½•éƒ½éœ€è¦äº‹å…ˆåˆ›å»ºMessageDigestï¼Œé‚£ä¹ˆå®ä¾‹åŒ–å¯¹è±¡çš„å¼€é”€å°±ä¼šèšæ²™æˆå¡”ï¼Œä¸çŸ¥ä¸è§‰åœ°æˆä¸ºå½±å“æ‰§è¡Œæ•ˆç‡çš„ç½ªé­ç¥¸é¦–ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•ï¼Œèƒ½å¤Ÿè®©Sparkåœ¨æ›´ç²—çš„æ•°æ®ç²’åº¦ä¸Šå»å¤„ç†æ•°æ®å‘¢ï¼Ÿè¿˜çœŸæœ‰ï¼ŒmapPartitionså’ŒmapPartitionsWithIndexè¿™å¯¹â€œå­ªç”Ÿå…„å¼Ÿâ€å°±æ˜¯ç”¨æ¥è§£å†³ç±»ä¼¼çš„é—®é¢˜ã€‚ç›¸æ¯”mapPartitionsï¼ŒmapPartitionsWithIndexä»…ä»…å¤šå‡ºäº†ä¸€ä¸ªæ•°æ®åˆ†åŒºç´¢å¼•ï¼Œå› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬æŠŠé‡ç‚¹æ”¾åœ¨mapPartitionsä¸Šé¢ã€‚

### mapPartitionsï¼šä»¥æ•°æ®åˆ†åŒºä¸ºç²’åº¦çš„æ•°æ®è½¬æ¢

æŒ‰ç…§ä»‹ç»ç®—å­çš„æƒ¯ä¾‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆæ¥è¯´è¯´mapPartitionsçš„ç”¨æ³•ã€‚mapPartitionsï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯**ä»¥æ•°æ®åˆ†åŒºä¸ºç²’åº¦ï¼Œä½¿ç”¨æ˜ å°„å‡½æ•°få¯¹RDDè¿›è¡Œæ•°æ®è½¬æ¢**ã€‚å¯¹äºä¸Šè¿°å•è¯å“ˆå¸Œå€¼è®¡æ•°çš„ä¾‹å­ï¼Œæˆ‘ä»¬ç»“åˆåé¢çš„ä»£ç ï¼Œæ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨mapPartitionsæ¥æ”¹å–„æ‰§è¡Œæ€§èƒ½ï¼š

```scala
// æŠŠæ™®é€šRDDè½¬æ¢ä¸ºPaired RDD
Â 
import java.security.MessageDigest
Â 
val cleanWordRDD: RDD[String] = _ // è¯·å‚è€ƒç¬¬ä¸€è®²è·å–å®Œæ•´ä»£ç 
Â 
val kvRDD: RDD[(String, Int)] = cleanWordRDD.mapPartitions( partition => {
  // æ³¨æ„ï¼è¿™é‡Œæ˜¯ä»¥æ•°æ®åˆ†åŒºä¸ºç²’åº¦ï¼Œè·å–MD5å¯¹è±¡å®ä¾‹
  val md5 = MessageDigest.getInstance("MD5")
  val newPartition = partition.map( word => {
  // åœ¨å¤„ç†æ¯ä¸€æ¡æ•°æ®è®°å½•çš„æ—¶å€™ï¼Œå¯ä»¥å¤ç”¨åŒä¸€ä¸ªPartitionå†…çš„MD5å¯¹è±¡
    (md5.digest(word.getBytes()).mkString,1)
  })
  newPartition
})
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¸Šé¢çš„æ”¹è¿›ä»£ç ä¸­ï¼ŒmapPartitionsä»¥æ•°æ®åˆ†åŒºï¼ˆåŒ¿åå‡½æ•°çš„å½¢å‚partitionï¼‰ä¸ºç²’åº¦ï¼Œå¯¹RDDè¿›è¡Œæ•°æ®è½¬æ¢ã€‚å…·ä½“çš„æ•°æ®å¤„ç†é€»è¾‘ï¼Œåˆ™ç”±ä»£è¡¨æ•°æ®åˆ†åŒºçš„å½¢å‚partitionè¿›ä¸€æ­¥è°ƒç”¨map(f)æ¥å®Œæˆã€‚ä½ å¯èƒ½ä¼šè¯´ï¼šâ€œpartition. map(f)ä»ç„¶æ˜¯ä»¥å…ƒç´ ä¸ºç²’åº¦åšæ˜ å°„å‘€ï¼è¿™å’Œå‰ä¸€ä¸ªç‰ˆæœ¬çš„å®ç°ï¼Œæœ‰ä»€ä¹ˆæœ¬è´¨ä¸Šçš„åŒºåˆ«å‘¢ï¼Ÿâ€

ä»”ç»†è§‚å¯Ÿï¼Œä½ å°±ä¼šå‘ç°ï¼Œç›¸æ¯”å‰ä¸€ä¸ªç‰ˆæœ¬ï¼Œæˆ‘ä»¬æŠŠå®ä¾‹åŒ–MD5å¯¹è±¡çš„è¯­å¥æŒªåˆ°äº†mapç®—å­ä¹‹å¤–ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œä»¥æ•°æ®åˆ†åŒºä¸ºå•ä½ï¼Œå®ä¾‹åŒ–å¯¹è±¡çš„æ“ä½œåªéœ€è¦æ‰§è¡Œä¸€æ¬¡ï¼Œè€ŒåŒä¸€ä¸ªæ•°æ®åˆ†åŒºä¸­æ‰€æœ‰çš„æ•°æ®è®°å½•ï¼Œéƒ½å¯ä»¥å…±äº«è¯¥MD5å¯¹è±¡ï¼Œä»è€Œå®Œæˆå•è¯åˆ°å“ˆå¸Œå€¼çš„è½¬æ¢ã€‚

é€šè¿‡ä¸‹å›¾çš„ç›´è§‚å¯¹æ¯”ï¼Œä½ ä¼šå‘ç°ï¼Œä»¥æ•°æ®åˆ†åŒºä¸ºå•ä½ï¼ŒmapPartitionsåªéœ€å®ä¾‹åŒ–ä¸€æ¬¡MD5å¯¹è±¡ï¼Œè€Œmapç®—å­å´éœ€è¦å®ä¾‹åŒ–å¤šæ¬¡ï¼Œå…·ä½“çš„æ¬¡æ•°åˆ™ç”±åˆ†åŒºå†…æ•°æ®è®°å½•çš„æ•°é‡æ¥å†³å®šã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/c7/8d/c76be8ff89f1c37e52e9f17b66bf398d.jpg?wh=1920x779 "mapä¸mapPartitionsçš„åŒºåˆ«")

å¯¹äºä¸€ä¸ªæœ‰ç€ä¸Šç™¾ä¸‡æ¡è®°å½•çš„RDDæ¥è¯´ï¼Œå…¶æ•°æ®åˆ†åŒºçš„åˆ’åˆ†å¾€å¾€æ˜¯åœ¨ç™¾è¿™ä¸ªé‡çº§ï¼Œå› æ­¤ï¼Œç›¸æ¯”mapç®—å­ï¼ŒmapPartitionså¯ä»¥æ˜¾è‘—é™ä½å¯¹è±¡å®ä¾‹åŒ–çš„è®¡ç®—å¼€é”€ï¼Œè¿™å¯¹äºSparkä½œä¸šç«¯åˆ°ç«¯çš„æ‰§è¡Œæ€§èƒ½æ¥è¯´ï¼Œæ— ç–‘æ˜¯éå¸¸å‹å¥½çš„ã€‚

å®é™…ä¸Šã€‚é™¤äº†è®¡ç®—å“ˆå¸Œå€¼ä»¥å¤–ï¼Œå¯¹äºæ•°æ®è®°å½•æ¥è¯´ï¼Œå‡¡æ˜¯å¯ä»¥å…±äº«çš„æ“ä½œï¼Œéƒ½å¯ä»¥ç”¨mapPartitionsç®—å­è¿›è¡Œä¼˜åŒ–ã€‚è¿™æ ·çš„å…±äº«æ“ä½œè¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚åˆ›å»ºç”¨äºè¿æ¥è¿œç«¯æ•°æ®åº“çš„Connectionså¯¹è±¡ï¼Œæˆ–æ˜¯ç”¨äºè¿æ¥Amazon S3çš„æ–‡ä»¶ç³»ç»Ÿå¥æŸ„ï¼Œå†æ¯”å¦‚ç”¨äºåœ¨çº¿æ¨ç†çš„æœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œç­‰ç­‰ï¼Œä¸ä¸€è€Œè¶³ã€‚ä½ ä¸å¦¨ç»“åˆå®é™…å·¥ä½œåœºæ™¯ï¼ŒæŠŠä½ é‡åˆ°çš„å…±äº«æ“ä½œæ•´ç†åˆ°ç•™è¨€åŒºï¼ŒæœŸå¾…ä½ çš„åˆ†äº«ã€‚

ç›¸æ¯”mapPartitionsï¼ŒmapPartitionsWithIndexä»…ä»…å¤šå‡ºäº†ä¸€ä¸ªæ•°æ®åˆ†åŒºç´¢å¼•ï¼Œè¿™ä¸ªæ•°æ®åˆ†åŒºç´¢å¼•å¯ä»¥ä¸ºæˆ‘ä»¬è·å–åˆ†åŒºç¼–å·ï¼Œå½“ä½ çš„ä¸šåŠ¡é€»è¾‘ä¸­éœ€è¦ä½¿ç”¨åˆ°åˆ†åŒºç¼–å·çš„æ—¶å€™ï¼Œä¸å¦¨è€ƒè™‘ä½¿ç”¨è¿™ä¸ªç®—å­æ¥å®ç°ä»£ç ã€‚é™¤äº†è¿™ä¸ªé¢å¤–çš„åˆ†åŒºç´¢å¼•ä»¥å¤–ï¼ŒmapPartitionsWithIndexåœ¨å…¶ä»–æ–¹é¢ä¸mapPartitionsæ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚

ä»‹ç»å®Œmapä¸mapPartitionsç®—å­ä¹‹åï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¶çƒ­æ‰“é“ï¼Œå†æ¥çœ‹ä¸€ä¸ªä¸è¿™ä¸¤è€…åŠŸèƒ½ç±»ä¼¼çš„ç®—å­ï¼šflatMapã€‚

### **flatMapï¼šä»å…ƒç´ åˆ°é›†åˆã€å†ä»é›†åˆåˆ°å…ƒç´ **

flatMapå…¶å®å’Œmapä¸mapPartitionsç®—å­ç±»ä¼¼ï¼Œåœ¨åŠŸèƒ½ä¸Šï¼Œä¸mapå’ŒmapPartitionsä¸€æ ·ï¼ŒflatMapä¹Ÿæ˜¯ç”¨æ¥åšæ•°æ®æ˜ å°„çš„ï¼Œåœ¨å®ç°ä¸Šï¼Œå¯¹äºç»™å®šæ˜ å°„å‡½æ•°fï¼ŒflatMap(f)ä»¥å…ƒç´ ä¸ºç²’åº¦ï¼Œå¯¹RDDè¿›è¡Œæ•°æ®è½¬æ¢ã€‚

ä¸è¿‡ï¼Œä¸å‰ä¸¤è€…ç›¸æ¯”ï¼ŒflatMapçš„æ˜ å°„å‡½æ•°fæœ‰ç€æ˜¾è‘—çš„ä¸åŒã€‚å¯¹äºmapå’ŒmapPartitionsæ¥è¯´ï¼Œå…¶æ˜ å°„å‡½æ•°fçš„ç±»å‹ï¼Œéƒ½æ˜¯ï¼ˆå…ƒç´ ï¼‰ =&gt; ï¼ˆå…ƒç´ ï¼‰ï¼Œå³å…ƒç´ åˆ°å…ƒç´ ã€‚è€ŒflatMapæ˜ å°„å‡½æ•°fçš„ç±»å‹ï¼Œæ˜¯ï¼ˆå…ƒç´ ï¼‰ =&gt; ï¼ˆé›†åˆï¼‰ï¼Œå³å…ƒç´ åˆ°é›†åˆï¼ˆå¦‚æ•°ç»„ã€åˆ—è¡¨ç­‰ï¼‰ã€‚å› æ­¤ï¼ŒflatMapçš„æ˜ å°„è¿‡ç¨‹åœ¨é€»è¾‘ä¸Šåˆ†ä¸ºä¸¤æ­¥ï¼š

- ä»¥å…ƒç´ ä¸ºå•ä½ï¼Œåˆ›å»ºé›†åˆï¼›
- å»æ‰é›†åˆâ€œå¤–åŒ…è£…â€ï¼Œæå–é›†åˆå…ƒç´ ã€‚

è¿™ä¹ˆè¯´æ¯”è¾ƒæŠ½è±¡ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ¥ä¸¾ä¾‹è¯´æ˜ã€‚å‡è®¾ï¼Œæˆ‘ä»¬å†æ¬¡æ”¹å˜Word Countçš„è®¡ç®—é€»è¾‘ï¼Œç”±åŸæ¥ç»Ÿè®¡å•è¯çš„è®¡æ•°ï¼Œæ”¹ä¸ºç»Ÿè®¡ç›¸é‚»å•è¯å…±ç°çš„æ¬¡æ•°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/b9/6a/b9feyy652bb60d7d30a25e3e122a9f6a.jpg?wh=1920x764 "å˜æ›´Word Countè®¡ç®—é€»è¾‘")

å¯¹äºè¿™æ ·çš„è®¡ç®—é€»è¾‘ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ä½¿ç”¨flatMapè¿›è¡Œå®ç°å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬å…ˆç»™å‡ºä»£ç å®ç°ï¼Œç„¶åå†åˆ†é˜¶æ®µåœ°åˆ†æflatMapçš„æ˜ å°„è¿‡ç¨‹ï¼š

```scala
// è¯»å–æ–‡ä»¶å†…å®¹
val lineRDD: RDD[String] = _ // è¯·å‚è€ƒç¬¬ä¸€è®²è·å–å®Œæ•´ä»£ç 
// ä»¥è¡Œä¸ºå•ä½æå–ç›¸é‚»å•è¯
val wordPairRDD: RDD[String] = lineRDD.flatMap( line => {
  // å°†è¡Œè½¬æ¢ä¸ºå•è¯æ•°ç»„
  val words: Array[String] = line.split(" ")
  // å°†å•ä¸ªå•è¯æ•°ç»„ï¼Œè½¬æ¢ä¸ºç›¸é‚»å•è¯æ•°ç»„
  for (i <- 0 until words.length - 1) yield words(i) + "-" + words(i+1)
})
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨åŒ¿åå‡½æ•°çš„å½¢å¼ï¼Œæ¥æä¾›æ˜ å°„å‡½æ•°fã€‚è¿™é‡Œfçš„å½¢å‚æ˜¯Stringç±»å‹çš„lineï¼Œä¹Ÿå°±æ˜¯æºæ–‡ä»¶ä¸­çš„ä¸€è¡Œæ–‡æœ¬ï¼Œè€Œfçš„è¿”å›ç±»å‹æ˜¯Array\[String]ï¼Œä¹Ÿå°±æ˜¯Stringç±»å‹çš„æ•°ç»„ã€‚åœ¨æ˜ å°„å‡½æ•°fçš„å‡½æ•°ä½“ä¸­ï¼Œæˆ‘ä»¬å…ˆç”¨splitè¯­å¥æŠŠlineè½¬åŒ–ä¸ºå•è¯æ•°ç»„ï¼Œç„¶åå†ç”¨forå¾ªç¯ç»“åˆyieldè¯­å¥ï¼Œä¾æ¬¡æŠŠå•ä¸ªçš„å•è¯ï¼Œè½¬åŒ–ä¸ºç›¸é‚»å•è¯è¯å¯¹ã€‚

æ³¨æ„ï¼Œforå¾ªç¯è¿”å›çš„ä¾ç„¶æ˜¯æ•°ç»„ï¼Œä¹Ÿå³ç±»å‹ä¸ºArray\[String]çš„è¯å¯¹æ•°ç»„ã€‚ç”±æ­¤å¯è§ï¼Œå‡½æ•°fçš„ç±»å‹æ˜¯ï¼ˆStringï¼‰ =&gt; ï¼ˆArray\[String]ï¼‰ï¼Œä¹Ÿå°±æ˜¯åˆšåˆšè¯´çš„ç¬¬ä¸€æ­¥ï¼Œ**ä»å…ƒç´ åˆ°é›†åˆ**ã€‚ä½†å¦‚æœæˆ‘ä»¬å»è§‚å¯Ÿè½¬æ¢å‰åçš„ä¸¤ä¸ªRDDï¼Œä¹Ÿå°±æ˜¯lineRDDå’ŒwordPairRDDï¼Œä¼šå‘ç°å®ƒä»¬çš„ç±»å‹éƒ½æ˜¯RDD\[String]ï¼Œæ¢å¥è¯è¯´ï¼Œå®ƒä»¬çš„å…ƒç´ ç±»å‹éƒ½æ˜¯Stringã€‚

å›é¡¾mapä¸mapPartitionsè¿™ä¸¤ä¸ªç®—å­ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œè½¬æ¢å‰åRDDçš„å…ƒç´ ç±»å‹ï¼Œä¸æ˜ å°„å‡½æ•°fçš„ç±»å‹æ˜¯ä¸€è‡´çš„ã€‚ä½†åœ¨flatMapè¿™é‡Œï¼Œå´å‡ºç°äº†RDDå…ƒç´ ç±»å‹ä¸å‡½æ•°ç±»å‹ä¸ä¸€è‡´çš„æƒ…å†µã€‚è¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿå…¶å®å‘¢ï¼Œè¿™æ­£æ˜¯flatMapçš„â€œå¥¥å¦™â€æ‰€åœ¨ï¼Œä¸ºäº†è®©ä½ ç›´è§‚åœ°ç†è§£flatMapçš„æ˜ å°„è¿‡ç¨‹ï¼Œæˆ‘ç”»äº†ä¸€å¼ ç¤ºæ„å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/a6/bd/a6bcd12fbc377405557c1aaf63cd24bd.jpg?wh=1920x840)

ä¸éš¾å‘ç°ï¼Œæ˜ å°„å‡½æ•°fçš„è®¡ç®—è¿‡ç¨‹ï¼Œå¯¹åº”ç€å›¾ä¸­çš„æ­¥éª¤1ä¸æ­¥éª¤2ï¼Œæ¯è¡Œæ–‡æœ¬éƒ½è¢«è½¬åŒ–ä¸ºåŒ…å«ç›¸é‚»è¯å¯¹çš„æ•°ç»„ã€‚ç´§æ¥ç€ï¼ŒflatMapå»æ‰æ¯ä¸ªæ•°ç»„çš„â€œå¤–åŒ…è£…â€ï¼Œæå–å‡ºæ•°ç»„ä¸­ç±»å‹ä¸ºStringçš„è¯å¯¹å…ƒç´ ï¼Œç„¶åä»¥è¯å¯¹ä¸ºå•ä½ï¼Œæ„å»ºæ–°çš„æ•°æ®åˆ†åŒºï¼Œå¦‚å›¾ä¸­æ­¥éª¤3æ‰€ç¤ºã€‚è¿™å°±æ˜¯flatMapæ˜ å°„è¿‡ç¨‹çš„ç¬¬äºŒæ­¥ï¼š**å»æ‰é›†åˆâ€œå¤–åŒ…è£…â€ï¼Œæå–é›†åˆå…ƒç´ **ã€‚

å¾—åˆ°åŒ…å«è¯å¯¹å…ƒç´ çš„wordPairRDDä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ²¿ç”¨Word Countçš„åç»­é€»è¾‘ï¼Œå»è®¡ç®—ç›¸é‚»è¯æ±‡çš„å…±ç°æ¬¡æ•°ã€‚ä½ ä¸å¦¨ç»“åˆæ–‡ç¨¿ä¸­çš„ä»£ç ä¸ç¬¬ä¸€è®²ä¸­Word Countçš„ä»£ç ï¼Œå»å®ç°å®Œæ•´ç‰ˆçš„â€œç›¸é‚»è¯æ±‡è®¡æ•°ç»Ÿè®¡â€ã€‚

### filterï¼šè¿‡æ»¤RDD

åœ¨ä»Šå¤©çš„æœ€åï¼Œæˆ‘ä»¬å†æ¥å­¦ä¹ ä¸€ä¸‹ï¼Œä¸mapä¸€æ ·å¸¸ç”¨çš„ç®—å­ï¼šfilterã€‚filterï¼Œé¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªç®—å­çš„ä½œç”¨ï¼Œæ˜¯å¯¹RDDè¿›è¡Œè¿‡æ»¤ã€‚å°±åƒæ˜¯mapç®—å­ä¾èµ–å…¶æ˜ å°„å‡½æ•°ä¸€æ ·ï¼Œfilterç®—å­ä¹Ÿéœ€è¦å€ŸåŠ©ä¸€ä¸ªåˆ¤å®šå‡½æ•°fï¼Œæ‰èƒ½å®ç°å¯¹RDDçš„è¿‡æ»¤è½¬æ¢ã€‚

æ‰€è°“åˆ¤å®šå‡½æ•°ï¼Œå®ƒæŒ‡çš„æ˜¯ç±»å‹ä¸ºï¼ˆRDDå…ƒç´ ç±»å‹ï¼‰ =&gt; ï¼ˆBooleanï¼‰çš„å‡½æ•°ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåˆ¤å®šå‡½æ•°fçš„å½¢å‚ç±»å‹ï¼Œå¿…é¡»ä¸RDDçš„å…ƒç´ ç±»å‹ä¿æŒä¸€è‡´ï¼Œè€Œfçš„è¿”å›ç»“æœï¼Œåªèƒ½æ˜¯Trueæˆ–è€…Falseã€‚åœ¨ä»»ä½•ä¸€ä¸ªRDDä¹‹ä¸Šè°ƒç”¨filter(f)ï¼Œå…¶ä½œç”¨æ˜¯ä¿ç•™RDDä¸­æ»¡è¶³fï¼ˆä¹Ÿå°±æ˜¯fè¿”å›Trueï¼‰çš„æ•°æ®å…ƒç´ ï¼Œè€Œè¿‡æ»¤æ‰ä¸æ»¡è¶³fï¼ˆä¹Ÿå°±æ˜¯fè¿”å›Falseï¼‰çš„æ•°æ®å…ƒç´ ã€‚

è€è§„çŸ©ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç»“åˆç¤ºä¾‹æ¥è®²è§£filterç®—å­ä¸åˆ¤å®šå‡½æ•°fã€‚

åœ¨ä¸Šé¢flatMapä¾‹å­çš„æœ€åï¼Œæˆ‘ä»¬å¾—åˆ°äº†å…ƒç´ ä¸ºç›¸é‚»è¯æ±‡å¯¹çš„wordPairRDDï¼Œå®ƒåŒ…å«çš„æ˜¯åƒâ€œSpark-isâ€ã€â€œis-coolâ€è¿™æ ·çš„å­—ç¬¦ä¸²ã€‚ä¸ºäº†ä»…ä¿ç•™æœ‰æ„ä¹‰çš„è¯å¯¹å…ƒç´ ï¼Œæˆ‘ä»¬å¸Œæœ›ç»“åˆæ ‡ç‚¹ç¬¦å·åˆ—è¡¨ï¼Œå¯¹wordPairRDDè¿›è¡Œè¿‡æ»¤ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¸Œæœ›è¿‡æ»¤æ‰åƒâ€œSpark-&amp;â€ã€â€œ|-dataâ€è¿™æ ·çš„è¯å¯¹ã€‚

æŒæ¡äº†filterç®—å­çš„ç”¨æ³•ä¹‹åï¼Œè¦å®ç°è¿™æ ·çš„è¿‡æ»¤é€»è¾‘ï¼Œæˆ‘ç›¸ä¿¡ä½ å¾ˆå¿«å°±èƒ½å†™å‡ºå¦‚ä¸‹çš„ä»£ç å®ç°ï¼š

```scala
// å®šä¹‰ç‰¹æ®Šå­—ç¬¦åˆ—è¡¨
val list: List[String] = List("&", "|", "#", "^", "@")
Â 
// å®šä¹‰åˆ¤å®šå‡½æ•°f
def f(s: String): Boolean = {
val words: Array[String] = s.split("-")
val b1: Boolean = list.contains(words(0))
val b2: Boolean = list.contains(words(1))
return !b1 && !b2 // è¿”å›ä¸åœ¨ç‰¹æ®Šå­—ç¬¦åˆ—è¡¨ä¸­çš„è¯æ±‡å¯¹
}
Â 
// ä½¿ç”¨filter(f)å¯¹RDDè¿›è¡Œè¿‡æ»¤
val cleanedPairRDD: RDD[String] = wordPairRDD.filter(f)
```

æŒæ¡äº†filterç®—å­çš„ç”¨æ³•ä¹‹åï¼Œä½ å°±å¯ä»¥å®šä¹‰ä»»æ„å¤æ‚çš„åˆ¤å®šå‡½æ•°fï¼Œç„¶ååœ¨RDDä¹‹ä¸Šé€šè¿‡è°ƒç”¨filter(f)å»å˜ç€èŠ±æ ·åœ°åšæ•°æ®è¿‡æ»¤ï¼Œä»è€Œæ»¡è¶³ä¸åŒçš„ä¸šåŠ¡éœ€æ±‚ã€‚

## é‡ç‚¹å›é¡¾

å¥½å•¦ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼Œå…³äºRDDå†…æ•°æ®è½¬æ¢çš„å‡ ä¸ªç®—å­ï¼Œæˆ‘ä»¬å°±è®²å®Œäº†ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥åšä¸ªæ€»ç»“ã€‚ä»Šå¤©è¿™ä¸€è®²ï¼Œä½ éœ€è¦æŒæ¡mapã€mapPartitionsã€flatMapå’Œfilterè¿™4ä¸ªç®—å­çš„ä½œç”¨å’Œå…·ä½“ç”¨æ³•ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬è®²äº†mapç®—å­çš„ç”¨æ³•ï¼Œå®ƒå…è®¸å¼€å‘è€…è‡ªç”±åœ°å¯¹RDDåšå„å¼å„æ ·çš„æ•°æ®è½¬æ¢ï¼Œç»™å®šæ˜ å°„å‡½æ•°fï¼Œmap(f)ä»¥å…ƒç´ ä¸ºç²’åº¦å¯¹RDDåšæ•°æ®è½¬æ¢ã€‚å…¶ä¸­få¯ä»¥æ˜¯å¸¦åå‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯åŒ¿åå‡½æ•°ï¼Œå®ƒçš„å½¢å‚ç±»å‹å¿…é¡»ä¸RDDçš„å…ƒç´ ç±»å‹ä¿æŒä¸€è‡´ï¼Œè€Œè¾“å‡ºç±»å‹åˆ™ä»»ç”±å¼€å‘è€…è‡ªè¡Œå†³å®šã€‚

ä¸ºäº†æå‡æ•°æ®è½¬æ¢çš„æ•ˆç‡ï¼ŒSparkæä¾›äº†ä»¥æ•°æ®åˆ†åŒºä¸ºç²’åº¦çš„mapPartitionsç®—å­ã€‚mapPartitionsçš„å½¢å‚æ˜¯ä»£è¡¨æ•°æ®åˆ†åŒºçš„partitionï¼Œå®ƒé€šè¿‡åœ¨partitionä¹‹ä¸Šå†æ¬¡è°ƒç”¨map(f)æ¥å®Œæˆæ•°æ®çš„è½¬æ¢ã€‚ç›¸æ¯”mapï¼ŒmapPartitionsçš„ä¼˜åŠ¿æ˜¯ä»¥æ•°æ®åˆ†åŒºä¸ºç²’åº¦åˆå§‹åŒ–å…±äº«å¯¹è±¡ï¼Œè¿™äº›å…±äº«å¯¹è±¡åœ¨æˆ‘ä»¬æ—¥å¸¸çš„å¼€å‘ä¸­å¾ˆå¸¸è§ï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥å¯¹è±¡ã€S3æ–‡ä»¶å¥æŸ„ã€æœºå™¨å­¦ä¹ æ¨¡å‹ç­‰ç­‰ã€‚

ç´§æ¥ç€ï¼Œæˆ‘ä»¬ä»‹ç»äº†flatMapç®—å­ã€‚flatMapçš„æ˜ å°„å‡½æ•°fæ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒçš„å‡½æ•°ç±»å‹æ˜¯ï¼ˆå…ƒç´ ï¼‰ =&gt; ï¼ˆé›†åˆï¼‰ï¼Œè¿™é‡Œé›†åˆæŒ‡çš„æ˜¯åƒæ•°ç»„ã€åˆ—è¡¨è¿™æ ·çš„æ•°æ®ç»“æ„ã€‚å› æ­¤ï¼ŒflatMapçš„æ˜ å°„è¿‡ç¨‹åœ¨é€»è¾‘ä¸Šåˆ†ä¸ºä¸¤æ­¥ï¼Œè¿™ä¸€ç‚¹éœ€è¦ä½ ç‰¹åˆ«æ³¨æ„ï¼š

- **ä»¥å…ƒç´ ä¸ºå•ä½ï¼Œåˆ›å»ºé›†åˆï¼›**
- **å»æ‰é›†åˆâ€œå¤–åŒ…è£…â€ï¼Œæå–é›†åˆå…ƒç´ ã€‚**

æœ€åï¼Œæˆ‘ä»¬å­¦ä¹ äº†filterç®—å­ï¼Œfilterç®—å­çš„ç”¨æ³•ä¸mapå¾ˆåƒï¼Œå®ƒéœ€è¦å€ŸåŠ©åˆ¤å®šå‡½æ•°fæ¥å®Œæˆå¯¹RDDçš„æ•°æ®è¿‡æ»¤ã€‚åˆ¤å®šå‡½æ•°çš„ç±»å‹å¿…é¡»æ˜¯ï¼ˆRDDå…ƒç´ ç±»å‹ï¼‰ =&gt; ï¼ˆBooleanï¼‰ï¼Œä¹Ÿå°±æ˜¯å½¢å‚ç±»å‹å¿…é¡»ä¸RDDçš„å…ƒç´ ç±»å‹ä¿æŒä¸€è‡´ï¼Œè¿”å›ç»“æœç±»å‹åˆ™å¿…é¡»æ˜¯å¸ƒå°”å€¼ã€‚RDDä¸­çš„å…ƒç´ æ˜¯å¦èƒ½å¤Ÿå¾—ä»¥ä¿ç•™ï¼Œå–å†³äºåˆ¤å®šå‡½æ•°fçš„è¿”å›å€¼æ˜¯Trueè¿˜æ˜¯Falseã€‚

è™½ç„¶ä»Šå¤©æˆ‘ä»¬åªå­¦äº†4ä¸ªç®—å­ï¼Œä½†è¿™4ä¸ªç®—å­åœ¨æ—¥å¸¸å¼€å‘ä¸­çš„å‡ºç°é¢‘ç‡éå¸¸ä¹‹é«˜ã€‚æŒæ¡äº†è¿™å‡ ä¸ªç®€å•çš„RDDç®—å­ï¼Œä½ å‡ ä¹å¯ä»¥åº”å¯¹RDDä¸­90%çš„æ•°æ®è½¬æ¢åœºæ™¯ã€‚å¸Œæœ›ä½ å¯¹è¿™å‡ ä¸ªç®—å­å¤šå¤šåŠ ä»¥ç»ƒä¹ ï¼Œä»è€Œåœ¨æ—¥å¸¸çš„å¼€å‘å·¥ä½œä¸­å­¦ä»¥è‡´ç”¨ã€‚

## **æ¯è¯¾ä¸€ç»ƒ**

è®²å®Œäº†æ­£è¯¾ï¼Œæˆ‘æ¥ç»™ä½ ç•™3ä¸ªæ€è€ƒé¢˜ï¼š

1.è¯·ä½ ç»“åˆ[å®˜ç½‘](https://spark.apache.org/docs/latest/rdd-programming-guide.html)çš„ä»‹ç»ï¼Œè‡ªå­¦mapPartitionsWithIndexç®—å­ã€‚è¯·ä½ è¯´ä¸€è¯´ï¼Œåœ¨å“ªäº›åœºæ™¯ä¸‹å¯èƒ½ä¼šç”¨åˆ°è¿™ä¸ªç®—å­ï¼Ÿ

2.å¯¹äºæˆ‘ä»¬ä»Šå¤©å­¦è¿‡çš„4ä¸ªç®—å­ï¼Œå†åŠ ä¸Šæ²¡æœ‰è¯¦ç»†è§£é‡Šçš„mapPartitionsWithIndexï¼Œä½ èƒ½è¯´è¯´ï¼Œå®ƒä»¬ä¹‹é—´æœ‰å“ªäº›å…±æ€§æˆ–æ˜¯å…±åŒç‚¹å—ï¼Ÿ

3.ä½ èƒ½è¯´ä¸€è¯´ï¼Œåœ¨æ—¥å¸¸çš„å·¥ä½œä¸­ï¼Œè¿˜é‡åˆ°è¿‡å“ªäº›å¯ä»¥åœ¨mapPartitionsä¸­åˆå§‹åŒ–çš„å…±äº«å¯¹è±¡å‘¢ï¼Ÿ

æ¬¢è¿ä½ åœ¨è¯„è®ºåŒºå›ç­”è¿™äº›ç»ƒä¹ é¢˜ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠè¿™ä¸€è®²åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹æˆ–è€…åŒäº‹ï¼Œå’Œä»–ä»¬ä¸€èµ·è®¨è®ºè®¨è®ºï¼Œäº¤æµæ˜¯å­¦ä¹ çš„å‚¬åŒ–å‰‚ã€‚æˆ‘åœ¨è¯„è®ºåŒºç­‰ä½ ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>qinsi</span> ğŸ‘ï¼ˆ45ï¼‰ ğŸ’¬ï¼ˆ11ï¼‰<p>ä¸æ˜¯å¾ˆæ‡‚sparkã€‚mapPartitions()é‚£é‡Œï¼Œå…‰ä»ä»£ç ä¸Šæ¥çœ‹çš„è¯ï¼Œåœ¨map()çš„é—­åŒ…é‡Œå¯ä»¥è®¿é—®åˆ°å¤–é¢mapPartitions()é—­åŒ…é‡Œçš„åŒä¸€ä¸ªmd5å®ä¾‹ï¼Œä»è€Œè¾¾åˆ°å…±äº«å®ä¾‹çš„æ•ˆæœã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰å¯èƒ½åœ¨æœ€å¤–å±‚åˆ›å»ºä¸€ä¸ªå…¨å±€çš„md5å®ä¾‹ï¼Œè¿™æ ·å°±ç®—åªç”¨map()ï¼Œåœ¨é—­åŒ…é‡Œè®¿é—®çš„ä¹Ÿæ˜¯è¿™åŒä¸€ä¸ªå®ä¾‹ï¼Ÿè¿™æ ·ä¼šæœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿæˆ–è€…è¯´åœ¨è¿™ç§æƒ…å†µä¸‹mapPartitions()ç›¸æ¯”map()è¿˜æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ</p>2021-09-16</li><br/><li><span>Unknown element</span> ğŸ‘ï¼ˆ22ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆæ‚¨å›ç­”ä¸€æ¥¼çš„é—®é¢˜æ—¶æåˆ°çš„åºåˆ—åŒ–æ„æ€æ˜¯ä¸æ˜¯å¯¹è±¡åœ¨ä¸åŒèŠ‚ç‚¹é—´ä¼ è¾“çš„æ—¶å€™åªèƒ½åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ä¼ è¾“ï¼Ÿå¦‚æœæ˜¯çš„è¯é‚£æˆ‘è§‰å¾— åœ¨mapPartitionsé‡Œé¢åˆ›å»ºMD5å®ä¾‹ï¼Œmapå¼•ç”¨è¿™ä¸ªå¯¹è±¡ï¼ŒSparkå´æ²¡æœ‰æŠ¥â€œTask not Serializableâ€é”™è¯¯ æ˜¯å› ä¸ºdriveræŠŠè¿™æ®µä»£ç åˆ†å‘åˆ°äº†å„ä¸ªexecutorï¼Œè€Œåˆ›å»ºå¯¹è±¡è¿™ä¸ªå·¥ä½œæ˜¯ç”±executorå®Œæˆçš„ï¼Œæ‰€ä»¥ä¸ä¼šæŠ¥é”™ï¼Ÿ</p>2021-09-24</li><br/><li><span>Geek_eb2d3d</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œæˆ‘åœ¨ map é‡Œé¢ä½¿ç”¨ SparkContext æˆ– SparkSession åˆ›å»ºæ–°çš„ RDDï¼Œè¿™æ ·æ˜¯å¯ä»¥çš„ä¹ˆï¼Ÿ</p>2021-09-28</li><br/><li><span>Alvin-L</span> ğŸ‘ï¼ˆ7ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>Pythonç‰ˆ,è™½ç„¶èƒ½è·‘,ä½†æ˜¯ä¸çŸ¥é“å¯¹ä¸å¯¹:
#å“ˆå¸Œå€¼è®¡æ•°
``` 
from hashlib import md5
from pyspark import SparkContext


def f(partition):
    m = md5()
    for word in partition:
        m.update(word.encode(&quot;utf8&quot;))
        yield m.hexdigest()


lineRDD = SparkContext().textFile(&quot;.&#47;wikiOfSpark.txt&quot;)
kvRDD = (
    lineRDD.flatMap(lambda line: line.split(&quot; &quot;))
    .filter(lambda word: word != &quot;&quot;)
    .mapPartitions(f)
    .map(lambda word: (word, 1))
)

kvRDD.foreach(print)

``` 

#ç›¸é‚»+è¿‡æ»¤ç‰¹æ®Šå­—ç¬¦
``` 
from pyspark import SparkContext

# å®šä¹‰ç‰¹æ®Šå­—ç¬¦åˆ—è¡¨
special_char_list = [&quot;&amp;&quot;, &quot;|&quot;, &quot;#&quot;, &quot;^&quot;, &quot;@&quot;]
# å®šä¹‰åˆ¤å®šå‡½æ•°f
def f(s):
    words = s.split(&quot;-&quot;)
    b1 = words[0] in special_char_list
    b2 = words[1] in special_char_list
    return (not b1) and (not b2)


# å®šä¹‰æ‹¼æ¥å‡½æ•°word_pair
def word_pair(line):
    words = line.split(&quot; &quot;)
    for i in range(len(words) - 1):
        yield words[i] + &quot;-&quot; + words[i + 1]


lineRDD = SparkContext().textFile(&quot;.&#47;wikiOfSpark.txt&quot;)
cleanedPairRDD = lineRDD.flatMap(word_pair).filter(f)
cleanedPairRDD.foreach(print)

``` </p>2021-09-21</li><br/><li><span>Geek_a30533</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¯¹scalaçš„å‡½æ•°å®šä¹‰æ ¼å¼ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œé‚£è¾¹ç»•äº†å¥½å‡ æ¬¡ï¼Œæœ‰ä¸€ä¸ªå°ç–‘é—®ï¼Œåœ¨flatMapé‡Œçš„åŒ¿åå‡½æ•°f

line =&gt; {  
			val words: Array[String] = line.split(&quot; &quot;)  
			for (i &lt;- 0 until words.length - 1) yield words(i) + &quot;-&quot; + words(i+1)
		}

åªå®šä¹‰äº†å½¢å‚æ˜¯lineï¼Œé‚£å‡ºå‚æ˜¯æ•´ä¸ªèŠ±æ‹¬å·ä¹ˆï¼Ÿä¸»è¦æ˜¯æ²¡æœ‰returnï¼Œè®©æˆ‘ä¸€ä¸‹è¿·äº†ï¼Œéš¾é“æ˜¯æœ€åä¸€ä¸ªæ˜¯Array[String]æ‰€ä»¥è¿”å›å€¼å°±æ˜¯è¿™ä¸ªï¼Ÿä¸ç”¨å£°æ˜å—ï¼Ÿ</p>2021-10-14</li><br/><li><span>å­å…®</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œè¯·é—®ï¼Œä¸€ä¸ªå˜é‡mè¢«filter ç®—å­å†…éƒ¨è®¡ç®—æ—¶ä½¿ç”¨ï¼Œè‹¥må®šä¹‰åœ¨äº†filterç®—å­æ‰€åœ¨å‡½æ•°å†…ï¼Œä¹Ÿå°±æ˜¯å˜é‡å’Œç®—å­åœ¨åŒä¸€ä¸ªå‡½æ•°é‡Œï¼Œå°±ä¸ä¼šæŠ¥åºåˆ—åŒ–é—®é¢˜ï¼Œè‹¥å®šä¹‰åœ¨äº†å‡½æ•°ä¹‹å¤–å°±ä¼šæŠ¥åºåˆ—åŒ–é—®é¢˜ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿçœ‹äº†ä¸€äº›è§£é‡Šï¼Œè¯´æ˜¯å‡½æ•°é—­åŒ…ï¼Œä¹Ÿä¸æ˜¯å¾ˆç†è§£</p>2021-09-26</li><br/><li><span>æœ¨ä¹‹ä¸Š</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œåœ¨å­¦ä¹ è¿™äº›ç®—å­çš„æ—¶å€™ï¼Œåƒmapï¼Œflatmapæ˜¯å¦å¯ä»¥ç±»æ¯”JAVA8çš„lambdaè¡¨è¾¾å¼+streamæµå»å­¦ä¹ </p>2022-02-23</li><br/><li><span>DMY</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>æ•°æ®åšmapæ˜ å°„æ˜¯ä»¥å…ƒç´ ä¸ºç²’åº¦ï¼Œæ‰§è¡Œfå‡½æ•°ï¼›
è¿™é‡Œä¸šåŠ¡åœºæ™¯ä¸­ï¼Œfå‡½æ•°éœ€è¦è°ƒç”¨rpcï¼Œæ¯ä¸ªæ•°æ®è°ƒä¸€æ¬¡rpc+æ•°æ®é‡å¤§å°±ä¼šéå¸¸è€—æ—¶ã€‚
æ‰€ä»¥æƒ³æŠŠä¸€ç»„æ•°æ®æ‰“åŒ…æˆä¸€ä¸ªlistå‡å°‘rpcè°ƒç”¨ï¼Œæ¥æé«˜æ•ˆç‡ï¼Œè¿™é‡Œè¦æ€ä¹ˆå¤„ç†å‘¢</p>2021-10-20</li><br/><li><span>å¤§å®å½“</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<p>åŒé—®è€å¸ˆ,AIKé—®çš„é—®é¢˜ï¼Œä»€ä¹ˆæ—¶å€™ç”¨å°æ‹¬å·ä»€ä¹ˆæ—¶å€™ç”¨èŠ±æ‹¬å·å•Šï¼Œæ„Ÿè§‰scalaå®åœ¨æœ‰ç‚¹è¿‡äºçµæ´»</p>2021-09-16</li><br/><li><span>å­™æµ©</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æœ‰ç–‘é—®ï¼Œå´è€å¸ˆï¼ŒPariedRDDä¸­çš„ï¼ˆKï¼ŒVï¼‰ï¼Œ1.å¯¹åº”çš„æ•°æ®ç±»å‹åº”è¯¥æ˜¯scalaä¸­çš„å…ƒç»„å§ï¼Ÿ2.reduceByKeyä¸ºå•¥ä¸æ”¯æŒå…ƒç´ æ˜¯mapç±»å‹ï¼Ÿæˆ–è€…å¦‚æœæˆ‘å­˜åœ¨ä¸€ä¸ªRDD[Map[String,Int]]ï¼Œæˆ‘æƒ³åšreduceByKeyæ“ä½œï¼Œåº”è¯¥æ€ä¹ˆå®ç°ï¼Ÿ</p>2021-11-05</li><br/><li><span>Geek_390836</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å‚è€ƒmapå’ŒmapPartitionsï¼Œä¸ºä»€ä¹ˆmapPartitionsä¸­çš„mapï¼Œæ˜¯å¯¹recordè¿›è¡Œgetbytesè€Œä¸æ˜¯word.getbytesæ“ä½œï¼Œåˆšå­¦sparkï¼Œæ±‚è€å¸ˆè§£ç­”</p>2021-09-16</li><br/><li><span>é’±é¹ Allen</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>mapPartitionsWithIndex  éœ€è¦ç»“åˆåˆ†åŒºç´¢å¼•ä½¿ç”¨
map filter flatMap mapPartitions mapPartitionsWithIndex  é€šè¿‡å‡½æ•°ï¼Œä¼ é€’å‚æ•°ï¼Œè¿”å›æ–°çš„RDD
mapPartitions é‡‡é›†ç³»ç»Ÿä¸­ï¼Œåªéœ€å®ä¾‹åŒ–ä¸€æ¬¡ç”µè¡¨å·ï¼Œå¯è¯»å…¶ä»–å„ç±»è¯»æ•°</p>2021-09-18</li><br/><li><span>è‰¾åˆ©ç‰¹-G</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>&#47;&#47; ç›¸é‚»è¯æ±‡è®¡æ•°ç»Ÿè®¡
package com.shouneng

import org.apache.spark.rdd.RDD
import org.apache.spark.{SparkConf, SparkContext}

object NeighboringWordCount {
  def main(args: Array[String]) {
    try {
      val conf =
        new SparkConf().setAppName(&quot;NeighboringWordCount&quot;).setMaster(&quot;local[1]&quot;)
      val sparkContext = new SparkContext(conf)
      val rootPath: String = &quot;file:&#47;&#47;&quot;
      val file: String =
        s&quot;${rootPath}&#47;home&#47;shouneng&#47;geektime&#47;Getting_Started_with_Spark&#47;chapter01&#47;wikiOfSpark.txt&quot;

      &#47;&#47; è¯»å–æ–‡ä»¶å†…å®¹
      val lineRDD: RDD[String] = sparkContext.textFile(file)
      &#47;&#47;   val wordRDD: RDD[String] = lineRDD.flatMap(line =&gt; line.split(&quot; &quot;))
      &#47;&#47;   val cleanWordRDD: RDD[String] = wordRDD.filter(word =&gt; !word.equals(&quot;&quot;))

      val wordPairRDD: RDD[String] = lineRDD.flatMap(line =&gt; {
        val words: Array[String] =
          line.split(&quot; &quot;).filter(word =&gt; !word.equals(&quot;&quot;))
        for (i &lt;- 0 until words.length - 1) yield words(i) + &quot;-&quot; + words(i + 1)
      })
      val kvRDD: RDD[(String, Int)] = wordPairRDD.map(wordPair =&gt; (wordPair, 1))
      val wordCounts: RDD[(String, Int)] = kvRDD.reduceByKey((x, y) =&gt; x + y)

      wordCounts
        .map { case (k, v) =&gt; (v, k) }
        .sortByKey(false)
        .take(5)
        .foreach(println)
    } catch {
      case ex: Exception =&gt; {
        ex.printStackTrace() &#47;&#47; æ‰“å°åˆ°æ ‡å‡†err
        System.err.println(&quot;exception===&gt;: ...&quot;) &#47;&#47; æ‰“å°åˆ°æ ‡å‡†err
      }
    }
  }
}</p>2022-01-03</li><br/><li><span>å­™æµ©</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å´è€å¸ˆï¼ŒmapPartitionsçš„æ˜¯ä¸æ˜¯ä¹Ÿé¿å…äº†å¯¹è±¡é”çš„é—®é¢˜ï¼Œå› ä¸ºpartitionså¯¹åº”çš„ä¹Ÿæ˜¯ä»»åŠ¡æ•°ã€‚</p>2021-11-05</li><br/><li><span>å°å¼º</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>import org.apache.spark.rdd.RDD
 
&#47;&#47; è¿™é‡Œçš„ä¸‹åˆ’çº¿&quot;_&quot;æ˜¯å ä½ç¬¦ï¼Œä»£è¡¨æ•°æ®æ–‡ä»¶çš„æ ¹ç›®å½•
val rootPath: String = &quot;&#47;home&#47;gxchen&#47;Spark&#47;01-wordCount&quot;
val file: String = s&quot;${rootPath}&#47;wikiOfSpark.txt&quot;
 
&#47;&#47; è¯»å–æ–‡ä»¶å†…å®¹
val lineRDD: RDD[String] = spark.sparkContext.textFile(file)
 
&#47;&#47; ä»¥è¡Œä¸ºå•ä½åšåˆ†è¯
val wordPairRDD: RDD[String] = lineRDD.flatMap(line =&gt; {
	val words: Array[String] = line.split(&quot; &quot;)
	for (i &lt;- 0 until words.length - 1) yield words(i) + &quot;-&quot; + words(i+1)
})



&#47;&#47; å®šä¹‰ç‰¹æ®Šå­—ç¬¦åˆ—è¡¨
val list: List[String] = List(&quot;&amp;&quot;, &quot;|&quot;, &quot;#&quot;, &quot;^&quot;, &quot;@&quot;)
 
&#47;&#47; å®šä¹‰åˆ¤å®šå‡½æ•°f
def f(s: String): Boolean = {
	val words: Array[String] = s.split(&quot;-&quot;)
	val b1: Boolean = list.contains(words(0))
	val b2: Boolean = list.contains(words(1))
	return !b1 &amp;&amp; !b2 &#47;&#47; è¿”å›ä¸åœ¨ç‰¹æ®Šå­—ç¬¦åˆ—è¡¨ä¸­çš„è¯æ±‡å¯¹
}
 
&#47;&#47; ä½¿ç”¨filter(f)å¯¹RDDè¿›è¡Œè¿‡æ»¤
val cleanWordPairRDD: RDD[String] = wordPairRDD.filter(f)

&#47;&#47; æŠŠRDDå…ƒç´ è½¬æ¢ä¸ºï¼ˆKeyï¼ŒValueï¼‰çš„å½¢å¼
val kvRDD: RDD[(String, Int)] = cleanWordPairRDD.map(wordPair =&gt; (wordPair, 1))
&#47;&#47; æŒ‰ç…§å•è¯åšåˆ†ç»„è®¡æ•°
val wordPairCounts: RDD[(String, Int)] = kvRDD.reduceByKey((x, y) =&gt; x + y)
 
&#47;&#47; æ‰“å°è¯é¢‘æœ€é«˜çš„5ä¸ªè¯æ±‡
wordPairCounts.map{case (k, v) =&gt; (v, k)}.sortByKey(false).take(5)


è¿è¡Œäº†ä»¥ä¸Šä»£ç åï¼ŒæŠ¥é”™ã€‚æƒ³äº†åŠå¤©ä¹Ÿæ²¡å¼„æ˜ç™½ï¼Œæ±‚åŠ©ä¸€ä¸‹ï¼
21&#47;10&#47;24 04:58:42 ERROR Executor: Exception in task 1.0 in stage 2.0 (TID 3)
java.lang.ArrayIndexOutOfBoundsException: 1
        at $line33.$read$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw.f(&lt;console&gt;:29)
        at $line34.$read$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw.$anonfun$cleanWordPairRDD$1(&lt;console&gt;:27)

21&#47;10&#47;24 04:58:42 WARN TaskSetManager: Lost task 1.0 in stage 2.0 (TID 3) (localhost executor driver): java.lang.ArrayIndexOutOfBoundsException: 1

21&#47;10&#47;24 04:58:42 ERROR TaskSetManager: Task 1 in stage 2.0 failed 1 times; aborting job
21&#47;10&#47;24 04:58:42 ERROR Executor: Exception in task 0.0 in stage 2.0 (TID 2)

21&#47;10&#47;24 04:58:42 WARN TaskSetManager: Lost task 0.0 in stage 2.0 (TID 2) (localhost executor driver): java.lang.ArrayIndexOutOfBoundsException: 0</p>2021-10-24</li><br/>
</ul>