ä½ å¥½ï¼Œæˆ‘æ˜¯é»„ä½³ï¼Œæ¬¢è¿æ¥åˆ°LangChainå®æˆ˜è¯¾ï¼

ä¸ŠèŠ‚è¯¾ï¼Œå’±ä»¬çš„èŠå¤©æœºå™¨äººå·²ç»åŸºæœ¬å®Œæˆï¼Œè¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬è¦çœ‹ä¸€çœ‹å¦‚ä½•æŠŠå®ƒéƒ¨ç½²åˆ°ç½‘ç»œä¸Šã€‚

## â€œèŠå¤©æœºå™¨äººâ€é¡¹ç›®è¯´æ˜

ç®€å•å›é¡¾ä¸€ä¸‹è¿™ä¸ªé¡¹ç›®çš„è®¾è®¡ã€‚

**ç¬¬ä¸€æ­¥ï¼š**é€šè¿‡LangChainçš„ConversationChainï¼Œå®ç°ä¸€ä¸ªæœ€åŸºæœ¬çš„èŠå¤©å¯¹è¯å·¥å…·ã€‚

**ç¬¬äºŒæ­¥ï¼š**é€šè¿‡LangChainä¸­çš„è®°å¿†åŠŸèƒ½ï¼Œè®©è¿™ä¸ªèŠå¤©æœºå™¨äººèƒ½å¤Ÿè®°ä½ç”¨æˆ·ä¹‹å‰æ‰€è¯´çš„è¯ã€‚

**ç¬¬ä¸‰æ­¥ï¼š**é€šè¿‡LangChainä¸­çš„æ£€ç´¢åŠŸèƒ½ï¼Œæ•´åˆæ˜“é€Ÿé²œèŠ±çš„å†…éƒ¨æ–‡æ¡£èµ„æ–™ï¼Œè®©èŠå¤©æœºå™¨äººä¸ä»…èƒ½å¤ŸåŸºäºè‡ªå·±çš„çŸ¥è¯†ï¼Œè¿˜å¯ä»¥åŸºäºæ˜“é€Ÿé²œèŠ±çš„ä¸šåŠ¡æµç¨‹ï¼Œç»™å‡ºä¸“ä¸šçš„å›ç­”ã€‚

**ç¬¬å››æ­¥ï¼ˆå¯é€‰ï¼‰ï¼š**é€šè¿‡LangChainä¸­çš„æ•°æ®åº“æŸ¥è¯¢åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥è¾“å…¥è®¢å•å·æ¥æŸ¥è¯¢è®¢å•çŠ¶æ€ï¼Œæˆ–è€…çœ‹çœ‹æœ‰æ²¡æœ‰å­˜è´§ç­‰ç­‰ã€‚

**ç¬¬äº”æ­¥ï¼š**åœ¨ç½‘ç»œä¸Šéƒ¨ç½²åŠå‘å¸ƒè¿™ä¸ªèŠå¤©æœºå™¨äººï¼Œä¾›ä¼ä¸šå†…éƒ¨å‘˜å·¥å’Œæ˜“é€Ÿé²œèŠ±ç”¨æˆ·ä½¿ç”¨ã€‚

åœ¨ä¸Šä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ Flask éƒ¨ç½²çš„äººè„‰å·¥å…·ã€‚Flaskæ˜¯ä¸€ä¸ªé€šç”¨çš„ã€å¾®å‹çš„Webåº”ç”¨æ¡†æ¶ï¼Œéå¸¸é€‚åˆåˆ›å»ºå„ç§Webåº”ç”¨ç¨‹åºï¼Œä¸ä»…ä»…å±€é™äºæœºå™¨å­¦ä¹ æˆ–æ•°æ®ç§‘å­¦é¡¹ç›®ã€‚Flaskä¸ºå¼€å‘è€…æä¾›äº†å¾ˆé«˜çš„çµæ´»æ€§ï¼Œä½ å¯ä»¥è‡ªå®šä¹‰è·¯ç”±ã€æ¨¡æ¿ã€å‰ç«¯å’Œåç«¯çš„äº¤äº’ç­‰ç­‰ã€‚å¯¹äºåˆå­¦è€…ï¼ŒFlaskå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´æ¥å­¦ä¹ ï¼Œå°¤å…¶æ˜¯éœ€è¦ç»“åˆå…¶ä»–å‰ç«¯æŠ€æœ¯æˆ–æ•°æ®åº“æŠ€æœ¯æ—¶ã€‚

ä¸è¿‡ï¼Œå¯¹äºæœºå™¨å­¦ä¹ é¡¹ç›®æ¥è¯´ï¼Œæˆ‘ä»¬è¿˜æœ‰å…¶ä»–éƒ¨ç½²æ–¹æ¡ˆã€‚æ¯”å¦‚ Streamlit å’Œ Gradioï¼Œå°±ä¸ºæœºå™¨å­¦ä¹ å’Œæ•°æ®ç§‘å­¦åº”ç”¨æä¾›äº†å¿«é€Ÿã€ä¸“é—¨åŒ–çš„è§£å†³æ–¹æ¡ˆã€‚å¦‚æœä½ çš„é¡¹ç›®ç›®æ ‡æ˜¯å¿«é€Ÿå±•ç¤ºå’ŒéªŒè¯æ¨¡å‹æ•ˆæœï¼Œé‚£ä¹ˆ Streamlit å’Œ Gradio æ˜¯ä¼˜ç§€çš„é€‰æ‹©ã€‚è¿™äº›æ¡†æ¶æä¾›äº†ç®€å•æ˜“ç”¨çš„ API å’Œä¸°å¯Œçš„å¯è§†åŒ–ç»„ä»¶ï¼Œè®©ä½ å¯ä»¥ç”¨å°‘é‡ä»£ç å¿«é€Ÿæ„å»ºäº¤äº’å¼åº”ç”¨ç¨‹åºï¼Œæé«˜ä½ çš„å¼€å‘æ•ˆç‡ï¼Œä¹Ÿå¯ä»¥æ›´å¥½åœ°å±•ç¤ºå·¥ä½œæˆæœã€‚

ä¸‹é¢ï¼Œæˆ‘å°±å¸¦ç€ä½ ç”¨è¿™ä¸¤ç§æœºå™¨å­¦ä¹ éƒ¨ç½²æ¡†æ¶æ¥å±•ç¤ºæˆ‘ä»¬çš„èŠå¤©æœºå™¨äººã€‚

## æ–¹æ¡ˆ 1 ï¼šé€šè¿‡ Streamlit éƒ¨ç½²èŠå¤©æœºå™¨äºº

é¦–å…ˆæ¥çœ‹çœ‹Streamlitã€‚è¿™æ˜¯ä¸€ä¸ªæŒºæœ‰åçš„ä¸“é—¨ä¸ºæ•°æ®ç§‘å­¦å®¶å’Œæœºå™¨å­¦ä¹ å·¥ç¨‹å¸ˆè®¾è®¡çš„å¼€æºPythonåº“ï¼Œå®ƒå¯ä»¥è¿…é€Ÿåœ°å°†Pythonè„šæœ¬è½¬åŒ–ä¸ºäº¤äº’å¼Webåº”ç”¨ã€‚

**Streamlit** **çš„ä¸€äº›ä¸»è¦ç‰¹ç‚¹å’Œäº®ç‚¹åŒ…æ‹¬ï¼š**

- ç®€æ˜“æ€§ï¼šStreamlit çš„çœŸæ­£é­…åŠ›åœ¨äºå®ƒçš„ç®€å•æ€§ï¼Œåªéœ€å‡ è¡Œä»£ç ï¼Œä½ å°±å¯ä»¥ä¸ºå…¶æ•°æ®æˆ–æ¨¡å‹åˆ›å»ºäº¤äº’å¼åº”ç”¨ã€‚
- æ— éœ€å‰ç«¯ç»éªŒï¼šä¸ä¼ ç»Ÿçš„Webå¼€å‘æ¡†æ¶ç›¸æ¯”ï¼Œä½¿ç”¨ Streamlitï¼Œä½ ä¸éœ€è¦æ·±å…¥äº†è§£HTMLã€CSSæˆ–JavaScriptï¼Œæ‰€æœ‰äº¤äº’éƒ½æ˜¯é€šè¿‡Pythonä»£ç æ¥ç®¡ç†çš„ã€‚
- å®æ—¶äº¤äº’ï¼šå½“ä½ æ›´æ”¹ä»£ç æˆ–æ•°æ®æ—¶ï¼ŒStreamlit åº”ç”¨ä¼šå®æ—¶æ›´æ–°ï¼Œè¿™ä¸ºè¿­ä»£å’Œå®éªŒæä¾›äº†æå¤§çš„ä¾¿åˆ©ã€‚
- å†…ç½®ç»„ä»¶ï¼šStreamlit é™„å¸¦äº†è®¸å¤šå†…ç½®çš„å¯è§†åŒ–å’Œäº¤äº’ç»„ä»¶ï¼Œå¦‚æ»‘å—ã€æŒ‰é’®ã€è¡¨æ ¼ç­‰ï¼Œå¯ä»¥æ— ç¼é›†æˆåˆ°ä½ çš„åº”ç”¨ä¸­ã€‚
- æ•°æ®é›†å¯è§†åŒ–ï¼šé™¤äº†åŸºæœ¬çš„å›¾å½¢å’Œå›¾è¡¨ï¼ŒStreamlit è¿˜æ”¯æŒå…¶ä»–æ•°æ®å¯è§†åŒ–åº“ï¼Œå¦‚ Plotlyã€Matplotlib å’Œ Altairï¼Œä½¿ä½ èƒ½å¤Ÿè½»æ¾åœ°å±•ç¤ºæ•°æ®ã€‚
- è®¾è®¡ç®€æ´ï¼šStreamlit çš„ç•Œé¢è®¾è®¡ç®€æ´è€Œä¼˜é›…ï¼Œä½¿å¾—åº”ç”¨ç¨‹åºçœ‹èµ·æ¥æ—¢ä¸“ä¸šåˆæ—¶å°šã€‚
- éƒ¨ç½²å’Œå…±äº«ï¼šå°½ç®¡ Streamlit ä¸“æ³¨äºåˆ›å»ºåº”ç”¨ï¼Œä½†å®ƒä¹Ÿæœ‰ä¸éƒ¨ç½²å’Œåˆ†äº«ç›¸å…³çš„å·¥å…·å’Œæ•´åˆï¼Œå¦‚ Streamlit Sharingï¼Œå…è®¸ä½ å…è´¹æ‰˜ç®¡å…¶åº”ç”¨ã€‚
- ç¤¾åŒºä¸ç”Ÿæ€ç³»ç»Ÿï¼šStreamlit æ‹¥æœ‰ä¸€ä¸ªç§¯æçš„å¼€æºç¤¾åŒºï¼Œå®šæœŸæä¾›æ–°çš„åŠŸèƒ½æ›´æ–°ã€ç»„ä»¶å’Œæ‰©å±•ã€‚

![](https://static001.geekbang.org/resource/image/71/6a/718fbd049acdf8681185805384028f6a.jpg?wh=1448x679)

æˆ‘ä»¬ç”¨ä¸‹é¢çš„è¯­å¥ï¼Œå®‰è£…Streamlitã€‚

```plain
pip install streamlit
```

ç„¶åï¼Œç®€å•çš„å‡ è¡Œä»£ç ï¼Œå°±å¯ä»¥åšå‡ºä¸€ä¸ªç½‘é¡µç‰ˆçš„å°ç¨‹åºã€‚

```plain
import streamlit as st

# è®¾ç½®æ ‡é¢˜
st.title('å¹³æ–¹è®¡ç®—å™¨')

# åˆ›å»ºä¸€ä¸ªæ»‘å—
number = st.slider("Select a number:", min_value=0, max_value=100)

# æ˜¾ç¤ºé€‰ä¸­æ•°å­—çš„å¹³æ–¹
st.write(f"Square of {number} is {number ** 2}")
```

ç”¨ `streamlit run <your_script_name>.py`ï¼ˆæ³¨æ„ï¼Œå¿…é¡»æ˜¯streamlit runå‘½ä»¤ï¼Œè€Œä¸æ˜¯é€šè¿‡pythonå‘½ä»¤æ¥è·‘ç¨‹åºï¼‰æ¥è¿è¡Œç¨‹åºï¼Œå°±å¯ä»¥åœ¨æµè§ˆå™¨ä¸­çœ‹åˆ°å®ƒã€‚

```plain
streamlit run 01_SimpleStreamlit.py
```

![](https://static001.geekbang.org/resource/image/22/ee/22e0fcf90978160e1f50d75fe9a33dee.jpg?wh=661x458)

æ­¤æ—¶ï¼Œåœ¨ localhost çš„ 8501 ç«¯å£ï¼Œç¨‹åºå¼€å§‹å¯åŠ¨ã€‚

![](https://static001.geekbang.org/resource/image/ef/87/ef4e3a09a3df9776330b343e721fbe87.jpg?wh=1364x1189)

ä¸‹é¢å°±é€šè¿‡ Streamlit æ¥é‡æ„èŠå¤©æœºå™¨äººã€‚

```plain
# å¯¼å…¥æ‰€éœ€çš„åº“
import os
import streamlit as st
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain.embeddings import OpenAIEmbeddings
from langchain.vectorstores import Qdrant
from langchain.memory import ConversationSummaryMemory
from langchain.chat_models import ChatOpenAI
from langchain.chains import ConversationalRetrievalChain
from langchain.document_loaders import PyPDFLoader
from langchain.document_loaders import Docx2txtLoader
from langchain.document_loaders import TextLoader

# è®¾ç½®OpenAI APIå¯†é’¥
os.environ["OPENAI_API_KEY"] = 'Your OpenAI Key' Â 

# ChatBotç±»çš„å®ç°
class ChatbotWithRetrieval:

Â  Â  def __init__(self, dir):

Â  Â  Â  Â  # åŠ è½½Documents
Â  Â  Â  Â  base_dir = dir # æ–‡æ¡£çš„å­˜æ”¾ç›®å½•
Â  Â  Â  Â  documents = []
Â  Â  Â  Â  for file in os.listdir(base_dir): 
Â  Â  Â  Â  Â  Â  file_path = os.path.join(base_dir, file)
Â  Â  Â  Â  Â  Â  if file.endswith('.pdf'):
Â  Â  Â  Â  Â  Â  Â  Â  loader = PyPDFLoader(file_path)
Â  Â  Â  Â  Â  Â  Â  Â  documents.extend(loader.load())
Â  Â  Â  Â  Â  Â  elif file.endswith('.docx') or file.endswith('.doc'):
Â  Â  Â  Â  Â  Â  Â  Â  loader = Docx2txtLoader(file_path)
Â  Â  Â  Â  Â  Â  Â  Â  documents.extend(loader.load())
Â  Â  Â  Â  Â  Â  elif file.endswith('.txt'):
Â  Â  Â  Â  Â  Â  Â  Â  loader = TextLoader(file_path)
Â  Â  Â  Â  Â  Â  Â  Â  documents.extend(loader.load())
Â  Â  Â  Â  
Â  Â  Â  Â  # æ–‡æœ¬çš„åˆ†å‰²
Â  Â  Â  Â  text_splitter = RecursiveCharacterTextSplitter(chunk_size=200, chunk_overlap=0)
Â  Â  Â  Â  all_splits = text_splitter.split_documents(documents)
Â  Â  Â  Â  
Â  Â  Â  Â  # å‘é‡æ•°æ®åº“
Â  Â  Â  Â  self.vectorstore = Qdrant.from_documents(
Â  Â  Â  Â  Â  Â  documents=all_splits, # ä»¥åˆ†å—çš„æ–‡æ¡£
Â  Â  Â  Â  Â  Â  embedding=OpenAIEmbeddings(), # ç”¨OpenAIçš„Embedding ModelåšåµŒå…¥
Â  Â  Â  Â  Â  Â  location=":memory:", Â # in-memory å­˜å‚¨
Â  Â  Â  Â  Â  Â  collection_name="my_documents",) # æŒ‡å®šcollection_name
Â  Â  Â  Â  
Â  Â  Â  Â  # åˆå§‹åŒ–LLM
Â  Â  Â  Â  self.llm = ChatOpenAI()
Â  Â  Â  Â  
Â  Â  Â  Â  # åˆå§‹åŒ–Memory
Â  Â  Â  Â  self.memory = ConversationSummaryMemory(
Â  Â  Â  Â  Â  Â  llm=self.llm, 
Â  Â  Â  Â  Â  Â  memory_key="chat_history", 
Â  Â  Â  Â  Â  Â  return_messages=True
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  
Â  Â  Â  Â  # è®¾ç½®Retrieval Chain
Â  Â  Â  Â  retriever = self.vectorstore.as_retriever()
Â  Â  Â  Â  self.qa = ConversationalRetrievalChain.from_llm(
Â  Â  Â  Â  Â  Â  self.llm, 
Â  Â  Â  Â  Â  Â  retriever=retriever, 
Â  Â  Â  Â  Â  Â  memory=self.memory
Â  Â  Â  Â  Â  Â  )

Â  Â  def chat_loop(self):
Â  Â  Â  Â  print("Chatbot å·²å¯åŠ¨! è¾“å…¥'exit'æ¥é€€å‡ºç¨‹åºã€‚")
Â  Â  Â  Â  while True:
Â  Â  Â  Â  Â  Â  user_input = input("ä½ : ")
Â  Â  Â  Â  Â  Â  if user_input.lower() == 'exit':
Â  Â  Â  Â  Â  Â  Â  Â  print("å†è§!")
Â  Â  Â  Â  Â  Â  Â  Â  break
Â  Â  Â  Â  Â  Â  # è°ƒç”¨ Retrieval Chain Â 
Â  Â  Â  Â  Â  Â  response = self.qa(user_input)
Â  Â  Â  Â  Â  Â  print(f"Chatbot: {response['answer']}")

# Streamlitç•Œé¢çš„åˆ›å»º
def main():
Â  Â  st.title("æ˜“é€Ÿé²œèŠ±èŠå¤©å®¢æœ")

Â  Â  # Check if the 'bot' attribute exists in the session state
Â  Â  if "bot" not in st.session_state:
Â  Â  Â  Â  st.session_state.bot = ChatbotWithRetrieval("OneFlower")

Â  Â  user_input = st.text_input("è¯·è¾“å…¥ä½ çš„é—®é¢˜ï¼š")
Â  Â  
Â  Â  if user_input:
Â  Â  Â  Â  response = st.session_state.bot.qa(user_input)
Â  Â  Â  Â  st.write(f"Chatbot: {response['answer']}")

if __name__ == "__main__":
Â  Â  main()
```

ä»¥ä¸‹æ˜¯ä½¿ç”¨ Streamlit è¿›è¡Œçš„æ›´æ”¹å’Œæ·»åŠ åŠŸèƒ½çš„ç®€è¦è¯´æ˜ã€‚

1. ç•Œé¢åˆ›å»ºï¼š  
   a. `st.title("æ˜“é€Ÿé²œèŠ±èŠå¤©å®¢æœ")`ï¼šè®¾ç½® Web åº”ç”¨ç¨‹åºçš„æ ‡é¢˜ä¸ºâ€œæ˜“é€Ÿé²œèŠ±èŠå¤©å®¢æœâ€ã€‚
2. ä¼šè¯çŠ¶æ€ï¼š  
   a. ä½¿ç”¨ `st.session_state` æ¥å­˜å‚¨ç”¨æˆ·ä¼šè¯çŠ¶æ€ã€‚è¿™æ˜¯ Streamlit çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå…è®¸ä½ åœ¨ç”¨æˆ·ä¸åº”ç”¨ç¨‹åºäº¤äº’æ—¶ä¿å­˜å˜é‡ã€‚  
   b. `if "bot" not in st.session_state`ï¼šæ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ä¸€ä¸ª bot å®ä¾‹å­˜åœ¨äº session state ä¸­ã€‚å¦‚æœæ²¡æœ‰ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„ ChatbotWithRetrieval å®ä¾‹ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ° session stateã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥é¿å…åœ¨æ¯æ¬¡ç”¨æˆ·ä¸åº”ç”¨ç¨‹åºäº¤äº’æ—¶é‡æ–°åˆå§‹åŒ–æœºå™¨äººã€‚
3. ç”¨æˆ·äº¤äº’ï¼š  
   a. `user_input = st.text_input("è¯·è¾“å…¥ä½ çš„é—®é¢˜ï¼š")`ï¼šåˆ›å»ºä¸€ä¸ªæ–‡æœ¬è¾“å…¥æ¡†ä¾›ç”¨æˆ·è¾“å…¥é—®é¢˜ã€‚å½“ç”¨æˆ·è¾“å…¥å†…å®¹å¹¶æäº¤åï¼Œä»£ç ä¼šè·å–ç”¨æˆ·çš„è¾“å…¥ï¼Œå¹¶ä½¿ç”¨èŠå¤©æœºå™¨äººçš„ qa æ–¹æ³•æ¥è·å–å“åº”ã€‚  
   b. `st.write(f"Chatbot: {response['answer']}")`ï¼šåœ¨åº”ç”¨ç¨‹åºç•Œé¢ä¸Šæ˜¾ç¤ºæœºå™¨äººçš„å“åº”ã€‚
4. ä¸»å‡½æ•°ä¸­ï¼Œå½“è„šæœ¬è¢«æ‰§è¡Œæ—¶ï¼Œå®ƒå°†å¯åŠ¨ Streamlit æœåŠ¡å™¨ï¼Œå¹¶æ˜¾ç¤ºåˆ›å»ºçš„ Web åº”ç”¨ç¨‹åºã€‚

ç”¨ `streamlit run` è¿è¡Œç¨‹åºï¼Œå°±å¯ä»¥å¼€å§‹èŠå¤©äº†ï¼

![](https://static001.geekbang.org/resource/image/1f/49/1f380b60c8cdec362c9c8070c919d849.jpg?wh=3840x2076)

## æ–¹æ¡ˆ2 ï¼šé€šè¿‡ Gradio éƒ¨ç½²èŠå¤©æœºå™¨äºº

ä¸ Streamlit ä¸åŒï¼ŒGradio ç•Œé¢æ›´ä¾§é‡äºæ¨¡å‹çš„äº¤äº’ï¼Œæ®è¯´ä¸Šæ‰‹ä¹Ÿæ›´ç®€å•ã€‚è¿™ä½¿å¾— Gradio éå¸¸é€‚åˆå±•ç¤ºå’Œæµ‹è¯•æœºå™¨å­¦ä¹ æ¨¡å‹ã€‚æˆ‘åœ¨GitHubä¸Šçœ‹åˆ°å¾ˆå¤šæ–°çš„å¼€æºLLMéƒ½æ˜¯æä¾›ä¸€ä¸ªGradio UIç•Œé¢æ¥è¿›è¡Œæµ‹è¯•çš„ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œ Streamlit åˆ™æä¾›äº†æ›´ä¸°å¯Œçš„ Web åº”ç”¨å¼€å‘åŠŸèƒ½ã€‚

åˆ°åº•æœ‰å¤šç®€å•ï¼Œç­‰ä¼šä½ çœ‹åˆ° Gradio UIçš„ç•Œé¢ï¼Œä½ å°±æ˜ç™½æˆ‘çš„æ„æ€äº†ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å…ˆå®‰è£…è¿™ä¸ªåŒ…ã€‚

```plain
pip install gradio
```

é€šè¿‡ Gradio æ¡†æ¶é‡æ„èŠå¤©æœºå™¨äººçš„ç¨‹åºä»£ç å¦‚ä¸‹ï¼š

```plain
# å¯¼å…¥æ‰€éœ€çš„åº“
import os
import gradio as gr
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain.embeddings import OpenAIEmbeddings
from langchain.vectorstores import Qdrant
from langchain.memory import ConversationSummaryMemory
from langchain.chat_models import ChatOpenAI
from langchain.chains import ConversationalRetrievalChain
from langchain.document_loaders import PyPDFLoader
from langchain.document_loaders import Docx2txtLoader
from langchain.document_loaders import TextLoader

# è®¾ç½®OpenAI APIå¯†é’¥
os.environ["OPENAI_API_KEY"] = 'Your OpenAI Key' Â 

class ChatbotWithRetrieval:
Â  Â  def __init__(self, dir):

Â  Â  Â  Â  # åŠ è½½Documents
Â  Â  Â  Â  base_dir = dir # æ–‡æ¡£çš„å­˜æ”¾ç›®å½•
Â  Â  Â  Â  documents = []
Â  Â  Â  Â  for file in os.listdir(base_dir): 
Â  Â  Â  Â  Â  Â  file_path = os.path.join(base_dir, file)
Â  Â  Â  Â  Â  Â  if file.endswith('.pdf'):
Â  Â  Â  Â  Â  Â  Â  Â  loader = PyPDFLoader(file_path)
Â  Â  Â  Â  Â  Â  Â  Â  documents.extend(loader.load())
Â  Â  Â  Â  Â  Â  elif file.endswith('.docx') or file.endswith('.doc'):
Â  Â  Â  Â  Â  Â  Â  Â  loader = Docx2txtLoader(file_path)
Â  Â  Â  Â  Â  Â  Â  Â  documents.extend(loader.load())
Â  Â  Â  Â  Â  Â  elif file.endswith('.txt'):
Â  Â  Â  Â  Â  Â  Â  Â  loader = TextLoader(file_path)
Â  Â  Â  Â  Â  Â  Â  Â  documents.extend(loader.load())
Â  Â  Â  Â  
Â  Â  Â  Â  # æ–‡æœ¬çš„åˆ†å‰²
Â  Â  Â  Â  text_splitter = RecursiveCharacterTextSplitter(chunk_size=200, chunk_overlap=0)
Â  Â  Â  Â  all_splits = text_splitter.split_documents(documents)
Â  Â  Â  Â  
Â  Â  Â  Â  # å‘é‡æ•°æ®åº“
Â  Â  Â  Â  self.vectorstore = Qdrant.from_documents(
Â  Â  Â  Â  Â  Â  documents=all_splits, # ä»¥åˆ†å—çš„æ–‡æ¡£
Â  Â  Â  Â  Â  Â  embedding=OpenAIEmbeddings(), # ç”¨OpenAIçš„Embedding ModelåšåµŒå…¥
Â  Â  Â  Â  Â  Â  location=":memory:", Â # in-memory å­˜å‚¨
Â  Â  Â  Â  Â  Â  collection_name="my_documents",) # æŒ‡å®šcollection_name
Â  Â  Â  Â  
Â  Â  Â  Â  # åˆå§‹åŒ–LLM
Â  Â  Â  Â  self.llm = ChatOpenAI()
Â  Â  Â  Â  
Â  Â  Â  Â  # åˆå§‹åŒ–Memory
Â  Â  Â  Â  self.memory = ConversationSummaryMemory(
Â  Â  Â  Â  Â  Â  llm=self.llm, 
Â  Â  Â  Â  Â  Â  memory_key="chat_history", 
Â  Â  Â  Â  Â  Â  return_messages=True
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  # åˆå§‹åŒ–å¯¹è¯å†å²
Â  Â  Â  Â  self.conversation_history = ""

Â  Â  Â  Â  # è®¾ç½®Retrieval Chain
Â  Â  Â  Â  retriever = self.vectorstore.as_retriever()
Â  Â  Â  Â  self.qa = ConversationalRetrievalChain.from_llm(
Â  Â  Â  Â  Â  Â  self.llm, 
Â  Â  Â  Â  Â  Â  retriever=retriever, 
Â  Â  Â  Â  Â  Â  memory=self.memory
Â  Â  Â  Â  Â  Â  )

Â  Â  def get_response(self, user_input): Â # è¿™æ˜¯ä¸º Gradio åˆ›å»ºçš„æ–°å‡½æ•°
Â  Â  Â  Â  response = self.qa(user_input)
Â  Â  Â  Â  # æ›´æ–°å¯¹è¯å†å²
Â  Â  Â  Â  self.conversation_history += f"ä½ : {user_input}\nChatbot: {response['answer']}\n"
Â  Â  Â  Â  return self.conversation_history

if __name__ == "__main__":
Â  Â  folder = "OneFlower"
Â  Â  bot = ChatbotWithRetrieval(folder)

Â  Â  # å®šä¹‰ Gradio ç•Œé¢
Â  Â  interface = gr.Interface(
Â  Â  Â  Â  fn=bot.get_response, Â # ä½¿ç”¨æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„å‡½æ•°
Â  Â  Â  Â  inputs="text", Â # è¾“å…¥æ˜¯æ–‡æœ¬
Â  Â  Â  Â  outputs="text", Â # è¾“å‡ºä¹Ÿæ˜¯æ–‡æœ¬
Â  Â  Â  Â  live=False, Â # å®æ—¶æ›´æ–°ï¼Œè¿™æ ·ç”¨æˆ·å¯ä»¥è¿ç»­ä¸æ¨¡å‹äº¤äº’
Â  Â  Â  Â  title="æ˜“é€Ÿé²œèŠ±æ™ºèƒ½å®¢æœ", Â # ç•Œé¢æ ‡é¢˜
Â  Â  Â  Â  description="è¯·è¾“å…¥é—®é¢˜ï¼Œç„¶åç‚¹å‡»æäº¤ã€‚" Â # æè¿°
Â  Â  )
Â  Â  interface.launch() Â # å¯åŠ¨ Gradio ç•Œé¢
```

ä»¥ä¸‹æ˜¯ Gradio éƒ¨åˆ†ä»£ç çš„è¯¦ç»†è§£é‡Šã€‚

1. `get_response(self, user_input)`ï¼šè¿™ä¸ªæ–°å‡½æ•°æ˜¯ä¸º Gradio åˆ›å»ºçš„ï¼Œå®ƒæ¥æ”¶ç”¨æˆ·è¾“å…¥ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›æœºå™¨äººçš„å“åº”ã€‚ä¸ºäº†ä¿æŒèŠå¤©å†å²è¿ç»­æ€§ï¼Œæ­¤å‡½æ•°å°†æ¯æ¬¡çš„ç”¨æˆ·è¾“å…¥å’Œæœºå™¨äººçš„å“åº”æ·»åŠ åˆ° conversation\_historyï¼Œå¹¶è¿”å›æ•´ä¸ªèŠå¤©å†å²ã€‚
2. ä½¿ç”¨ `gr.Interface()` æ¥å®šä¹‰ Gradio ç•Œé¢ã€‚`fn=bot.get_response`ï¼šè®¾ç½®ç•Œé¢çš„ä¸»å‡½æ•°ä¸ºåˆšåˆšåˆ›å»ºçš„ get\_response å‡½æ•°ã€‚`live=False`ï¼šç¡®ä¿å®æ—¶æ›´æ–°æ˜¯å…³é—­çš„ï¼Œè¿™æ„å‘³ç€ç”¨æˆ·éœ€è¦ç‚¹å‡»æäº¤æŒ‰é’®æ¥å‘é€ä»–ä»¬çš„é—®é¢˜ï¼Œè€Œä¸æ˜¯ä¸€è¾¹æ‰“å­—ï¼Œä¸€è¾¹ç”Ÿæˆå›ç­”çš„æµæ¨¡å¼ï¼ˆæ¯”è¾ƒé€‚åˆå±•ç¤ºç”Ÿæˆå¼æ¨¡å‹ï¼‰ã€‚
3. å¯åŠ¨ Gradio ç•Œé¢ã€‚`interface.launch()`ï¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¼šå¯åŠ¨ Gradio çš„ Web æœåŠ¡å™¨ï¼Œå¹¶åœ¨é»˜è®¤çš„ Web æµè§ˆå™¨ä¸­æ‰“å¼€ä¸€ä¸ªæ–°çª—å£ï¼Œæ˜¾ç¤ºåˆšåˆšå®šä¹‰çš„ç•Œé¢ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è¿™ä¸ªç•Œé¢ä¸æœºå™¨äººäº¤äº’ã€‚

è¿è¡Œç¨‹åºï¼ŒèŠå¤©æœºå™¨äººåœ¨æœ¬åœ°ç«¯å£ 7860 ä¸Šå¯åŠ¨ã€‚

![](https://static001.geekbang.org/resource/image/28/26/28d3c772116bf4733ed55e937e476d26.jpg?wh=408x53)

![](https://static001.geekbang.org/resource/image/46/d8/460fa6854ffa68ef4bfa54056cb034d8.jpg?wh=2140x1499)

è¿™é‡Œï¼Œè¾“å…¥è¾“å‡ºçª—å£çš„é…ç½®æ›´åŠ æ¸…æ™°ï¼Œè€Œä¸”ç›¸å¯¹äºåŸæ¥çš„åªè®°å½•ä¸€è½®å¯¹è¯çš„æœºå™¨äººï¼Œè¿™é‡Œæˆ‘ä»¬å¢åŠ äº†å†å²å¯¹è¯ä¿¡æ¯è®°å½•åŠŸèƒ½ã€‚

## æ€»ç»“æ—¶åˆ»

Streamlit å’Œ Gradio éƒ½æ˜¯è®©æ•°æ®ç§‘å­¦å®¶å’Œå¼€å‘è€…èƒ½å¤Ÿå¿«é€Ÿä¸ºæœºå™¨å­¦ä¹ æ¨¡å‹åˆ›å»º Web UI çš„æ¡†æ¶ã€‚

- Streamlit æ˜¯ä¸ºæ•°æ®åº”ç”¨ã€ä»ªè¡¨æ¿å’Œå¯è§†åŒ–è®¾è®¡çš„ã€‚å®ƒæä¾›äº†å¤šç§å°éƒ¨ä»¶ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥ä¸æ•°æ®å’Œæ¨¡å‹è¿›è¡Œäº¤äº’ã€‚å®ƒéå¸¸ Pythonicï¼Œæ„å‘³ç€å®ƒçš„ä½¿ç”¨æ–¹å¼éå¸¸è‡ªç„¶ï¼Œå¯¹äºç†Ÿæ‚‰Pythonçš„äººæ¥è¯´éå¸¸ç›´è§‚ã€‚
- Gradio æ›´å¤šæ˜¯ä¸ºäº†å±•ç¤ºå’Œæ¼”ç¤ºæœºå™¨å­¦ä¹ æ¨¡å‹ã€‚å®ƒæä¾›äº†ä¸€ç§å¿«é€Ÿçš„æ–¹æ³•ï¼Œä½¿éæŠ€æœ¯ç”¨æˆ·ä¹Ÿèƒ½ä¸æœºå™¨å­¦ä¹ æ¨¡å‹è¿›è¡Œäº¤äº’ï¼Œæ— éœ€ç¼–å†™å¤æ‚çš„ä»£ç ã€‚

ä»¥ä¸‹æ˜¯å¯¹å®ƒä»¬ç‰¹ç‚¹è¿›è¡Œçš„å¯¹æ¯”æ€»ç»“ã€‚

![](https://static001.geekbang.org/resource/image/65/87/654d95bdb96e627c2464b4cedd964e87.jpg?wh=1110x752)

æ— è®ºé€‰æ‹©å“ªä¸ªæ¡†æ¶ï¼Œä½ éƒ½å¯ä»¥åœ¨éå¸¸çŸ­çš„æ—¶é—´å†…ä¸ºä½ çš„åº”ç”¨åˆ›å»ºä¸€ä¸ªWeb UIã€‚è‡³äºé€‰æ‹©å“ªä¸ªï¼Œæ›´å¤šå–å†³äºä½ çš„å…·ä½“éœ€æ±‚å’Œä¸ªäººå–œå¥½ã€‚

å¦‚æœä½ ç”¨è¿™äº›æ¡†æ¶ï¼Œåœ¨ä½ ç†Ÿæ‚‰çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œåˆ©ç”¨LangChainå’ŒLLMçš„èƒ½åŠ›å¼€å‘å‡ºäº†æ›´ä¸ºé…·ç‚«çš„LangChainåº”ç”¨ï¼Œä¸è¦å¿˜è®°åœ¨ç•™è¨€åŒºä¸­å’Œå¤§å®¶åˆ†äº«ï¼è¯´è¯´æ€è·¯å°±è¡Œï¼Œæœ‰å…·ä½“ä»£ç å®ç°æ›´å¥½ã€‚

## æ€è€ƒé¢˜

1. æˆ‘çš„æ˜“é€Ÿé²œèŠ±Chatbotæœ‰å¾ˆå¤šä¸å®Œç¾çš„åœ°æ–¹ï¼Œæ¯”å¦‚ï¼Œæ£€ç´¢åŠŸèƒ½çš„è®¾è®¡ä¸å¤Ÿç»†è‡´ï¼ŒUIä¸å¤Ÿç¾è§‚ï¼Œç­‰ç­‰ã€‚è¯·ä½ åœ¨è¿™ä¸ªRepoçš„åŸºç¡€ä¸Šï¼Œå¤§åˆ€é˜”æ–§åœ°è¿›è¡Œæ”¹è¿›ã€‚
2. è¯·ä½ ç”¨Flaskæ¡†æ¶è®¾è®¡è‡ªå·±çš„Chatbot UIï¼Œé‡æ„èŠå¤©æœºå™¨äººï¼Œå®ç°æ›´å¤šã€æ›´å®Œå–„çš„åŠŸèƒ½ã€‚
3. è¯·ä½ å›è¿‡å¤´å»çœ‹çœ‹[ç¬¬01è®²](https://time.geekbang.org/column/article/699400)æˆ‘ç»™ä½ ç•™çš„3é“æ€è€ƒé¢˜ã€‚é‚£æ—¶å€™ï¼Œä½ ä¸äº†è§£LangChainï¼Œç°åœ¨ä½ å·²ç»åŸºæœ¬æŒæ¡äº†å®ƒçš„ç²¾é«“ï¼Œèƒ½å¦æŠŠç¬¬01è®²çš„æ€è€ƒé¢˜é‡æ–°å›ç­”ä¸€éå‘¢ï¼Ÿåº”è¯¥å¾ˆæœ‰è¶£å§ï¼

æœŸå¾…åœ¨ç•™è¨€åŒºçœ‹åˆ°ä½ çš„æˆæœåˆ†äº«ï¼Œå¦‚æœè§‰å¾—å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™æœ‰éœ€è¦çš„æœ‹å‹ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ5ï¼‰</strong></div><ul>
<li><span>Yimmy</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆå¥½ï¼Œå®è·µç¯èŠ‚çš„ä»£ç ï¼Œåœ¨githubä¸Šæ²¡æœ‰çœ‹åˆ°ï¼ˆç¬¬20-23èŠ‚è¯¾ç¨‹çš„ï¼‰</p>2023-10-31</li><br/><li><span>peter</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯·é—®ï¼šStreamlitå’ŒGradioå¯ä»¥ç”¨æ¥å¼€å‘æ™®é€šç½‘ç«™å—ï¼Ÿ</p>2023-10-31</li><br/><li><span>æ‚Ÿå°˜</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è€å¸ˆï¼ŒUIæœ‰äº†ï¼Œé‚£LangChainå¦‚ä½•å¯¹å¤–éƒ¨æä¾›apiæ¥å£å‘¢ï¼Ÿå¦‚javaé¡¹ç›®ï¼ˆspringbootæ¡†æ¶å®ç°çš„ï¼‰ï¼Œjavaè¯­è¨€çš„é¡¹ç›®åˆå¯ä»¥é€šè¿‡ä»€ä¹ˆæ–¹å¼è°ƒç”¨LangChainæä¾›çš„apiæ¥å£ï¼Ÿ</p>2023-11-12</li><br/><li><span>Monin</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è€å¸ˆ  å’¨è¯¢ä¸‹  openAiæœ€è¿‘å‘å¸ƒçš„Assistant API   æ˜¯ä¸æ˜¯æ„å‘³ç€langchainçš„ä»·å€¼è¢«æ›¿ä»£äº†  Assistant APIçš„agentï¼Œretrievaléƒ½ä¸é”™
</p>2023-11-07</li><br/><li><span>2xshu</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p># å‘é‡æ•°æ®åº“ 
self.vectorstore = Qdrant.from_documents(
 documents=all_splits, # ä»¥åˆ†å—çš„æ–‡æ¡£ 
 embedding=OpenAIEmbeddings(), # ç”¨OpenAIçš„Embedding ModelåšåµŒå…¥
 location=&quot;:memory:&quot;, # in-memory å­˜å‚¨ 
collection_name=&quot;my_documents&quot;,) # æŒ‡å®šcollection_name

è¿™ä¸ªåœ°æ–¹æ˜¯ç”¨OpenAIEmbeddingsæ¥åšçš„å‘é‡åµŒå…¥ï¼Œè¿™æ ·ä¼šæ¶ˆè€—openaiçš„è°ƒç”¨æ¬¡æ•°å§ï¼Ÿæœ‰å¹³æ›¿çš„æ–¹æ³•å—ï¼Ÿ
</p>2024-07-24</li><br/>
</ul>