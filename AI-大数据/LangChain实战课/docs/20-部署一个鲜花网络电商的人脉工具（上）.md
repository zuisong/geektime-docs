ä½ å¥½ï¼Œæˆ‘æ˜¯é»„ä½³ï¼Œæ¬¢è¿æ¥åˆ°LangChainå®æˆ˜è¯¾ï¼

ä»ä»Šå¤©å¼€å§‹ï¼Œæˆ‘è¦ç”¨4èŠ‚è¯¾çš„ç¯‡å¹…ï¼Œå¸¦ç€ä½ è®¾è®¡ä¸¤ä¸ªæœ‰è¶£è€Œåˆå®ç”¨çš„åº”ç”¨ç¨‹åºã€‚è®¾è®¡è¿™ä¸¤ä¸ªåº”ç”¨ç¨‹åºçš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†è®©ä½ èƒ½å¤ŸæŠŠLangChainä¸­çš„å„ä¸ªç»„ä»¶çµæ´»åœ°ç»„åˆèµ·æ¥ï¼Œèä¼šè´¯é€šï¼Œå¹¶ä»¥æ­¤ä½œä¸ºå¯å‘ï¼Œåœ¨ä½ ç†Ÿæ‚‰çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œåˆ©ç”¨LangChainå’ŒLLMçš„èƒ½åŠ›ï¼Œå¼€å‘å‡ºæ›´å¤šã€æ›´å¼ºå¤§çš„æ•ˆç‡å·¥å…·ã€‚

ç¬¬ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œæ˜¯ç”¨LangChainåˆ›å»ºå‡ºä¸€ä¸ªä¸“å±äºâ€œæ˜“é€Ÿé²œèŠ±â€çš„ç½‘ç»œäººè„‰å·¥å…·ã€‚å…‰è¿™ä¹ˆè¯´ï¼Œæœ‰äº›æ¨¡ç³Šï¼Œè¿™ä¸ªäººè„‰å·¥å…·é•¿å•¥æ ·ï¼Ÿæœ‰äº›å•¥å…·ä½“åŠŸèƒ½ï¼Ÿ

åŠ¨æ‰‹ä¹‹å‰ï¼Œè®©æˆ‘å…ˆç»™ä½ æŠŠè¿™ä¸ªæ‰€è°“â€œäººè„‰â€å·¥å…·çš„èƒ½åŠ›å’Œç»†èŠ‚è¯´æ¸…æ¥šã€‚

## â€œäººè„‰å·¥å…·â€é¡¹ç›®è¯´æ˜

**é¡¹ç›®èƒŒæ™¯**ï¼šæ˜“é€Ÿé²œèŠ±ç”µå•†ç½‘ç»œè‡ªä»åˆ›å»ºä»¥æ¥ï¼Œé€šè¿‡å¾®ä¿¡ã€æŠ–éŸ³ã€å°çº¢ä¹¦ç­‰è‡ªåª’ä½“å®£ä¼ æ¨å¹¿ï¼ŒçŸ­æœŸå†…è·å¾—äº†å¹¿æ³›æµé‡å±•ç¤ºã€‚ç›®å‰ï¼Œè¥é”€éƒ¨é—¨å¸Œæœ›ä»¥æ­¤ä¸ºå¥‘æœºï¼Œå†æ¥å†å‰ï¼Œç»§ç»­æ‰©å¤§å“ç‰Œå½±å“åŠ›ã€‚ç»è¿‡è°ƒç ”ï¼Œå‘ç°å¾ˆå¤šç”¨æˆ·ä¼šé€šè¿‡å¾®åšçƒ­æœæ¨èçš„æ–°é—»æ¥è´­ä¹°é²œèŠ±èµ é€ç»™æ˜æ˜Ÿã€è¾¾äººç­‰ï¼Œå› æ­¤å„éƒ¨é—¨ä¸€è‡´è®¤ä¸ºåº”è¯¥è”ç»œç›¸å…³å¾®åšå¤§Vï¼Œå…±åŒæ¨å¹¿ï¼Œå¸¦åŠ¨å“ç‰Œæˆé•¿ã€‚

ç„¶è€Œï¼Œå‘æ˜å¹¶é€‰æ‹©é€‚åˆäºâ€œé²œèŠ±æ¨å¹¿â€çš„å¾®åšå¤§Væœ‰ä¸€å®šéš¾åº¦ã€‚è¥é”€éƒ¨é—¨å‘˜å·¥è¡¨ç¤ºï¼Œè¿™ä¸ªä»»åŠ¡æ¯”æ‰¾å¾®ä¿¡ã€æŠ–éŸ³å’Œå°çº¢ä¹¦è¾¾äººè¦éš¾å¾—å¤šã€‚ä»–ä»¬éƒ½å¸Œæœ›æŠ€æœ¯éƒ¨é—¨èƒ½å¤Ÿç»™å‡ºä¸€ä¸ªâ€œäººè„‰æœç´¢å·¥å…·â€æ¥ååŠ©å®Œæˆè¿™ä¸€ç›®æ ‡ã€‚

**é¡¹ç›®ç›®æ ‡ï¼š**å¸®åŠ©å¸‚åœºè¥é”€éƒ¨é—¨çš„å‘˜å·¥æ‰¾åˆ°å¾®åšä¸Šé€‚åˆåšé²œèŠ±æ¨å¹¿çš„å¤§Vï¼Œå¹¶ç»™å‡ºå…·ä½“çš„è”ç»œæ–¹æ¡ˆã€‚

## é¡¹ç›®çš„æŠ€æœ¯å®ç°ç»†èŠ‚

è¿™ä¸ªé¡¹ç›®çš„å…·ä½“æŠ€æœ¯å®ç°ç»†èŠ‚ï¼Œè¿™é‡Œç®€è¿°å¦‚ä¸‹ã€‚

**ç¬¬ä¸€æ­¥ï¼š**é€šè¿‡LangChainçš„æœç´¢å·¥å…·ï¼Œä»¥æ¨¡ç³Šæœç´¢çš„æ–¹å¼ï¼Œå¸®åŠ©è¿è¥äººå‘˜æ‰¾åˆ°å¾®åšä¸­æœ‰å¯èƒ½å¯¹ç›¸å…³é²œèŠ±æ¨å¹¿æ„Ÿå…´è¶£çš„å¤§Vï¼ˆæ¯”å¦‚å–œæ¬¢ç«ç‘°èŠ±çš„å¤§Vï¼‰ï¼Œå¹¶è¿”å›UIDã€‚

**ç¬¬äºŒæ­¥ï¼š**æ ¹æ®å¾®åšUIDï¼Œé€šè¿‡çˆ¬è™«å·¥å…·æ‹¿åˆ°ç›¸å…³å¤§Vçš„å¾®åšå…¬å¼€ä¿¡æ¯ï¼Œå¹¶ä»¥JSONæ ¼å¼è¿”å›å¤§Vçš„æ•°æ®ã€‚

![](https://static001.geekbang.org/resource/image/00/5f/0049810d3cfe1aee633d29722ded8e5f.png?wh=1860x1612 "æ‰¾åˆ°çƒ­çˆ±é²œèŠ±çš„å¾®åšå¤§ V è°‹æ±‚åˆä½œ")

**ç¬¬ä¸‰æ­¥ï¼š**é€šè¿‡LangChainè°ƒç”¨LLMï¼Œé€šè¿‡LLMçš„æ€»ç»“æ•´ç†ä»¥åŠç”ŸæˆåŠŸèƒ½ï¼Œæ ¹æ®å¤§Vçš„ä¸ªäººä¿¡æ¯ï¼Œå†™ä¸€ç¯‡çƒ­æƒ…æ´‹æº¢çš„ä»‹ç»å‹æ–‡ç« ï¼Œè°‹æ±‚ä¸è¯¥å¤§Vçš„åˆä½œã€‚

**ç¬¬å››æ­¥ï¼š**æŠŠLangChainè¾“å‡ºè§£æåŠŸèƒ½åŠ å…¥è¿›æ¥ï¼Œè®©LLMç”Ÿæˆå¯ä»¥åµŒå…¥æç¤ºæ¨¡æ¿çš„æ ¼å¼åŒ–æ•°æ®ç»“æ„ã€‚

**ç¬¬äº”æ­¥ï¼š**æ·»åŠ HTMLã€CSSï¼Œå¹¶ç”¨Flaskåˆ›å»ºä¸€ä¸ªAppï¼Œåœ¨ç½‘ç»œä¸Šéƒ¨ç½²åŠå‘å¸ƒè¿™ä¸ªé²œèŠ±ç”µå•†äººè„‰å·¥å…·ï¼Œä¾›å¸‚åœºè¥é”€éƒ¨é—¨çš„äººå‘˜ä½¿ç”¨ã€‚

åœ¨ä¸Šé¢çš„5ä¸ªæ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨åˆ°å¾ˆå¤šLangChainæŠ€æœ¯ï¼ŒåŒ…æ‹¬**æç¤ºå·¥ç¨‹ã€æ¨¡å‹ã€é“¾ã€ä»£ç†ã€è¾“å‡ºè§£æ**ç­‰ã€‚

è¿™èŠ‚è¯¾æˆ‘ä»¬å…ˆæ¥å®ç°é¡¹ç›®çš„å‰ä¸¤ä¸ªéƒ¨åˆ†ã€‚

## ç¬¬ä¸€æ­¥ï¼šæ‰¾åˆ°å¤§ V

å› ä¸ºå’±ä»¬çš„é¡¹ç›®éœ€è¦ç”¨åˆ°å¾ˆå¤šå·¥å…·ï¼Œæ‰€ä»¥æˆ‘åˆ›å»ºäº†ä¸€ä¸ªé¡¹ç›®ç›®å½•ï¼Œå«åšsocializer\_v0ï¼ˆé¡¹ç›®æ¯å®Œæˆä¸€æ­¥ï¼Œæˆ‘å°±åˆ›å»ºä¸€ä¸ªæ–°ç›®å½•ï¼Œå¹¶æŠŠç‰ˆæœ¬å·åŠ 1ï¼‰ã€‚å½“ç¬¬ä¸€ä¸ªæ­¥éª¤â€œæ‰¾åˆ°å¤§ Vâ€å®ç°ä¹‹åï¼Œé¡¹ç›®ä¸­çš„æ–‡æ¡£ç»“æ„å¦‚ä¸‹ã€‚

![](https://static001.geekbang.org/resource/image/5d/0c/5dab492f802d34086975616d06708e0c.jpg?wh=152x270)

è¿™é‡Œï¼Œä¸»ç¨‹åºæ˜¯findbigV.pyã€‚æ„æ€å°±æ˜¯æ´¾ç¨‹åºæ¥ä½œä¸ºæ™ºèƒ½ä»£ç†ï¼Œæ‰¾åˆ°å–œæ¬¢é²œèŠ±çš„å¾®åšå¤§Vã€‚

## ä¸»ç¨‹åº findbigV.py

ä¸»ç¨‹åºfindbigV.pyåœ¨ç¬¬ä¸€æ­¥å®Œæˆä¹‹åï¼Œæ˜¯è¿™æ ·çš„ã€‚

```plain
# è®¾ç½®OpenAI APIå¯†é’¥
import os
os.environ["OPENAI_API_KEY"] = ''
os.environ["SERPAPI_API_KEY"] = ''

# å¯¼å…¥æ‰€å–çš„åº“
import re
from agents.weibo_agent import lookup_V

if __name__ == "__main__":

Â  Â  # æ‹¿åˆ°UID
Â  Â  response_UID = lookup_V(flower_type = "ç‰¡ä¸¹" )
Â  Â  print(response_UID)

Â  Â  # æŠ½å–UIDé‡Œé¢çš„æ•°å­—
Â  Â  UID = re.findall(r'\d+', response_UID)[0]
Â  Â  print("è¿™ä½é²œèŠ±å¤§Vçš„å¾®åšIDæ˜¯", UID)
```

è¿™é‡Œï¼Œæˆ‘ä»¬è¦æœåˆ°çš„ï¼Œæ˜¯ä¸€ä¸ªçƒ­çˆ±é²œèŠ±çš„å¤§Vçš„å¾®åšUIDï¼Œè€Œä¸æ˜¯URLã€‚

![](https://static001.geekbang.org/resource/image/52/f1/520688ef98a70c3d3651420bcc26bef1.jpg?wh=1805x1292)

æ¯”å¦‚ï¼Œä¸Šé¢è¿™ä½å–œæ¬¢ç‰¡ä¸¹èŠ±çš„å¤§Vï¼Œä»–çš„UIDæ˜¯6053338099ã€‚è¿™äº›éƒ½æ˜¯å…¬å¼€çš„ä¿¡æ¯ã€‚

ä¸ºä»€ä¹ˆæˆ‘ä»¬å¸Œæœ›å¾—åˆ°UIDå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªIDï¼Œçˆ¬å–ä»–ä¸ªäººä¸»é¡µé‡Œçš„æ›´å¤šä»‹ç»ä¿¡æ¯ï¼Œæœ‰åˆ©äºè¿›ä¸€æ­¥äº†è§£ä»–ã€‚

### å¾®åš Agentï¼šæŸ¥æ‰¾å¤§ V çš„ ID

ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹ï¼Œæ–‡ä»¶agents\\weibo\_agent.pyä¸­çš„lookup\_Vå‡½æ•°æ˜¯å¦‚ä½•å®ç°è¿™ä¸ªæœå¯»UIDçš„åŠŸèƒ½çš„ã€‚

```plain
# å¯¼å…¥ä¸€ä¸ªæœç´¢UIDçš„å·¥å…·
from tools.search_tool import get_UID

# å¯¼å…¥æ‰€éœ€çš„åº“
from langchain.prompts import PromptTemplate
from langchain.chat_models import ChatOpenAI
from langchain.agents import initialize_agent, Tool
from langchain.agents import AgentType

# é€šè¿‡LangChainä»£ç†æ‰¾åˆ°UIDçš„å‡½æ•°
def lookup_V(flower_type: str) :
Â  Â  # åˆå§‹åŒ–å¤§æ¨¡å‹
Â  Â  llm = ChatOpenAI(temperature=0, model_name="gpt-3.5-turbo")

Â  Â  # å¯»æ‰¾UIDçš„æ¨¡æ¿
Â  Â  template = """given the {flower} I want you to get a related å¾®åš UID.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Your answer should contain only a UID.
Â  Â  Â  Â  Â  Â  Â  Â  Â  The URL always starts with https://weibo.com/u/
Â  Â  Â  Â  Â  Â  Â  Â  Â  for example, if https://weibo.com/u/1669879400 is her å¾®åš, then 1669879400 is her UID
Â  Â  Â  Â  Â  Â  Â  Â  Â  This is only the example don't give me this, but the actual UID"""
Â  Â  # å®Œæ•´çš„æç¤ºæ¨¡æ¿
Â  Â  prompt_template = PromptTemplate(
Â  Â  Â  Â  input_variables=["flower"], template=template
Â  Â  )

Â  Â  # ä»£ç†çš„å·¥å…·
Â  Â  tools = [
Â  Â  Â  Â  Tool(
Â  Â  Â  Â  Â  Â  name="Crawl Google for å¾®åš page",
Â  Â  Â  Â  Â  Â  func=get_UID,
Â  Â  Â  Â  Â  Â  description="useful for when you need get the å¾®åš UID",
Â  Â  Â  Â  )
Â  Â  ]

Â  Â  # åˆå§‹åŒ–ä»£ç†
Â  Â  agent = initialize_agent(
Â  Â  Â  Â  tools, 
Â  Â  Â  Â  llm, 
Â  Â  Â  Â  agent=AgentType.ZERO_SHOT_REACT_DESCRIPTION, 
Â  Â  Â  Â  verbose=True
Â  Â  )

Â  Â  # è¿”å›æ‰¾åˆ°çš„UID
Â  Â  ID = agent.run(prompt_template.format_prompt(flower=flower_type))

Â  Â  return ID
```

è¿™æ®µä»£ç çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†é€šè¿‡æä¾›çš„èŠ±çš„ç±»å‹ï¼ˆflower typeï¼‰æ¥æŸ¥æ‰¾ä¸ä¹‹ç›¸å…³çš„å¾®åšUIDã€‚å…¶ä¸­ä½¿ç”¨äº†LangChainä¸­çš„ä»£ç†å’Œå·¥å…·ã€‚

è¿™é‡Œæœ‰ä¸¤ç‚¹éœ€è¦ç‰¹åˆ«è¯´æ˜ï¼š

1. æœç´¢UIDçš„å·¥å…·é€šè¿‡from tools.search\_tool import get\_UIDå¯¼å…¥ï¼Œè¿™ä¸ªå†…å®¹åé¢è¿˜ä¼šä»‹ç»ã€‚
2. ä¸‹é¢çš„æç¤ºæ¨¡æ¿è¯´æ˜ï¼Œå¼ºè°ƒäº†éœ€è¦çš„æ˜¯UIDï¼Œè€Œä¸æ˜¯URLã€‚åˆšæ‰è¯´äº†ï¼Œè¿™æ˜¯å› ä¸ºåç»­çš„çˆ¬è™«å·¥å…·éœ€è¦ä¸€ä¸ªç‰¹å®šçš„UIDï¼Œæ¥è·å–è¯¥å¾®åšå¤§Vçš„ä¸ªäººä¿¡æ¯ï¼ˆå…¬å¼€ï¼‰ã€‚ç„¶åæˆ‘ä»¬ä¼šç»§ç»­åˆ©ç”¨è¿™äº›ä¿¡æ¯è®©LLMä¸ºæˆ‘ä»¬å†™â€œå‹¾æ­â€æ–‡æ¡ˆã€‚

```plain
Â  Â  # å¯»æ‰¾UIDçš„æ¨¡æ¿
Â  Â  template = """given the {flower} I want you to get a related å¾®åš UID.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Your answer should contain only a UID.
Â  Â  Â  Â  Â  Â  Â  Â  Â  The URL always starts with https://weibo.com/u/
Â  Â  Â  Â  Â  Â  Â  Â  Â  for example, if https://weibo.com/u/1669879400 is her å¾®åš, then 1669879400 is her UID
Â  Â  Â  Â  Â  Â  Â  Â  Â  This is only the example don't give me this, but the actual UID"""
```

### å®šåˆ¶çš„ SerpAPIï¼šgetUID

ä¸Šé¢çš„ç¨‹åºåªæ˜¯è°ƒç”¨äº†ä»£ç†ï¼Œä½†æ˜¯æ²¡æœ‰ç»™å‡ºå…·ä½“çš„å·¥å…·å®ç°ã€‚ç°åœ¨æˆ‘ä»¬æ¥ç»§ç»­å®ç°æœç´¢å¤§Vçš„UIDçš„åŠŸèƒ½ã€‚

```plain
# å¯¼å…¥ä¸€ä¸ªæœç´¢UIDçš„å·¥å…·
from tools.search_tool import get_UID
```

è¿™ä¸ªå…·ä½“çš„å®ç°ï¼Œåœ¨ä»£ç  \\tools\\search\_tool.py ä¸­ã€‚

è¯´åˆ°é€šè¿‡LangChainæ¥æœç´¢å¾®åšï¼Œç›¸ä¿¡ä½ ä¼šé©¬ä¸Šæƒ³åˆ°å·²ç»å¤šæ¬¡ä½¿ç”¨è¿‡çš„SerpAPIã€‚æˆ‘ä»¬å…ˆæ¥è¯•ä¸€è¯•æ ‡å‡†çš„SerpAPIï¼Œçœ‹çœ‹å®ƒèƒ½å¦æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚

```plain
from langchain.utilities import SerpAPIWrapper

def get_UID(flower: str):
Â  Â  """Searches for Linkedin or twitter Profile Page."""
Â  Â  search = SerpAPIWrapper()
Â  Â  res = search.run(f"{flower}")
Â  Â  return res
```

å†™å¥½äº†è¿™æ®µä»£ç ï¼Œç¬¬ä¸€æ­¥å°±å¯ä»¥è¯´æ˜¯å®Œæˆäº†ã€‚ä¸‹é¢æˆ‘ä»¬è·‘ä¸€éfindbigV.pyï¼Œçœ‹çœ‹ç¨‹åºä¼šç»™å‡ºæˆ‘ä»¬ä»€ä¹ˆæ ·çš„ç»“æœã€‚

![](https://static001.geekbang.org/resource/image/a2/d8/a22043515a4b9686c58ccedcda2075d8.jpg?wh=1336x670)

ç»“æœè¿˜å¥½ï¼Œä¸ç®—å¤ªå¤±æœ›ï¼ŒSerpAPIæ‰¾åˆ°äº†ä¸€ä¸ªè²Œä¼¼å–œæ¬¢ç‰¡ä¸¹èŠ±çš„å¤§Vï¼Œåå«æˆç²¾ç‰¡ä¸¹ï¼Œæœåˆ°çš„ä¿¡æ¯ä¹Ÿéƒ½æ˜¯çœŸå®çš„ã€‚çœ‹èµ·æ¥ä»–è›®é€‚åˆä¸ºæˆ‘ä»¬çš„ç‰¡ä¸¹èŠ±ä»£è¨€ã€‚ç„¶è€Œï¼Œè¿™ä¸ªå¤§Vçš„å¾®åšIDè‚¯å®šä¸æ˜¯6ã€‚

ä¸­é—´å“ªé‡Œæˆ–è®¸æ˜¯å‡ºäº†ç‚¹å°é—®é¢˜ã€‚

åƒè¿™æ ·çš„é”™è¯¯ï¼Œæ˜æ˜¾å‘ç”Ÿåœ¨LangChainå†…éƒ¨ï¼Œé‚£ä½ çš„ trouble\_shooting ä¹Ÿåªèƒ½é€šè¿‡Debugæ¥è§£å†³ã€‚è¿™é‡Œï¼Œæˆ‘å°±å¿½ç•¥æ‰ä¸€é•¿ä¸²çš„é”™è¯¯æ’æŸ¥è¿‡ç¨‹ï¼Œç›´æ¥æŒ‡å‡ºé—®é¢˜çš„æ ¹æœ¬åŸå› æ‰€åœ¨ã€‚

è®©æˆ‘ä»¬æŠŠæ–­ç‚¹è®¾ç½®åœ¨SerpAPIWrapperç±»çš„\_process\_responseä¸­ã€‚

![](https://static001.geekbang.org/resource/image/86/88/86238bae7452cde52f23e4d6ea3a1688.jpg?wh=1909x1398)

å½“ç¨‹åºè¿›å…¥ `if "organic_results" in res.keys()` è¿™æ®µé€»è¾‘ä¹‹åï¼Œæˆ‘å‘ç°ï¼Œå®ƒè¿”å›çš„æ€»æ˜¯ä¸€ä¸ªsnippetï¼ˆæ‘˜è¦æ–‡å­—ï¼‰ï¼Œè€Œä¸æ˜¯linkï¼ˆURLï¼‰ã€‚

![](https://static001.geekbang.org/resource/image/38/be/38643a041b2f24ed9e8405a485580cbe.jpg?wh=1275x1473)

æ— è®ºè¿™èƒŒåçš„é€»è¾‘ä½•åœ¨ï¼Œè¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€æƒ³è¦çš„ã€‚åœ¨Debugè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°ï¼Œæ–°æµªå¾®åšçš„UIDï¼Œå®é™…ä¸ŠåŒ…å«åœ¨URLä¸­ï¼Œä¹Ÿå°±æ˜¯ [https://weibo.com/u/6053338099](https://weibo.com/u/6053338099)ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬ä¸è¿”å›å¾®åšçš„ç®€çŸ­è¯´æ˜ï¼ˆæˆç²¾ç‰¡ä¸¹ï¼Œæç¬‘è§†é¢‘è‡ªåª’ä½“â€¦â€¦ï¼‰ï¼Œè€Œæ˜¯è¿”å›URLï¼Œä¼šæ›´æœ‰åˆ©äºå¤§æ¨¡å‹æç‚¼å‡ºUIDã€‚

![](https://static001.geekbang.org/resource/image/2a/c0/2a78e4b1cc0734f1c5ce171a05f153c0.jpg?wh=1275x465)

å¦‚ä½•åšå‘¢ï¼Ÿç›´æ¥ä¿®æ”¹LangChainçš„SerpAPIWrapperç±»çš„\_process\_responseæºä»£ç è‚¯å®šä¸æ˜¯ä¸€ä¸ªå¥½åŠæ³•ã€‚

å› æ­¤ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç»§æ‰¿SerpAPIWrapperç±»ï¼Œå¹¶æ„é€ ä¸€ä¸ªCustomSerpAPIWrapperç±»ï¼Œåœ¨è¿™ä¸ªç±»ä¸­ï¼Œæˆ‘ä»¬é‡æ„\_process\_responseè¿™ä¸ªé™æ€æ–¹æ³•ã€‚

æ–°çš„search\_tool.pyå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```plain
# å¯¼å…¥SerpAPIWrapper
from langchain.utilities import SerpAPIWrapper

# é‡æ–°å®šåˆ¶SerpAPIWrapperï¼Œé‡æ„_process_responseï¼Œè¿”å›URL
class CustomSerpAPIWrapper(SerpAPIWrapper):
Â  Â  def __init__(self):
Â  Â  Â  Â  super(CustomSerpAPIWrapper, self).__init__()

Â  Â  @staticmethod
Â  Â  def _process_response(res: dict) -> str:
Â  Â  Â  Â  """Process response from SerpAPI."""
Â  Â  Â  Â  if "error" in res.keys():
Â  Â  Â  Â  Â  Â  raise ValueError(f"Got error from SerpAPI: {res['error']}")
Â  Â  Â  Â  if "answer_box_list" in res.keys():
Â  Â  Â  Â  Â  Â  res["answer_box"] = res["answer_box_list"]
        '''åˆ å»å¾ˆå¤šæ— å…³ä»£ç '''
Â  Â  Â  Â  snippets = []
Â  Â  Â  Â  if "knowledge_graph" in res.keys():
Â  Â  Â  Â  Â  Â  knowledge_graph = res["knowledge_graph"]
Â  Â  Â  Â  Â  Â  title = knowledge_graph["title"] if "title" in knowledge_graph else ""
Â  Â  Â  Â  Â  Â  if "description" in knowledge_graph.keys():
Â  Â  Â  Â  Â  Â  Â  Â  snippets.append(knowledge_graph["description"])
Â  Â  Â  Â  Â  Â  for key, value in knowledge_graph.items():
Â  Â  Â  Â  Â  Â  Â  Â  if (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isinstance(key, str)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  and isinstance(value, str)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  and key not in ["title", "description"]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  and not key.endswith("_stick")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  and not key.endswith("_link")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  and not value.startswith("http")
Â  Â  Â  Â  Â  Â  Â  Â  ):
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  snippets.append(f"{title} {key}: {value}.")
Â  Â  Â  Â  if "organic_results" in res.keys():
Â  Â  Â  Â  Â  Â  first_organic_result = res["organic_results"][0]
Â  Â  Â  Â  Â  Â  if "snippet" in first_organic_result.keys():
                # æ­¤å¤„æ˜¯å…³é”®ä¿®æ”¹
Â  Â  Â  Â  Â  Â  Â  Â  # snippets.append(first_organic_result["snippet"])
Â  Â  Â  Â  Â  Â  Â  Â  snippets.append(first_organic_result["link"]) Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  elif "snippet_highlighted_words" in first_organic_result.keys():
Â  Â  Â  Â  Â  Â  Â  Â  snippets.append(first_organic_result["snippet_highlighted_words"])
Â  Â  Â  Â  Â  Â  elif "rich_snippet" in first_organic_result.keys():
Â  Â  Â  Â  Â  Â  Â  Â  snippets.append(first_organic_result["rich_snippet"])
Â  Â  Â  Â  Â  Â  elif "rich_snippet_table" in first_organic_result.keys():
Â  Â  Â  Â  Â  Â  Â  Â  snippets.append(first_organic_result["rich_snippet_table"])
Â  Â  Â  Â  Â  Â  elif "link" in first_organic_result.keys():
Â  Â  Â  Â  Â  Â  Â  Â  snippets.append(first_organic_result["link"])
Â  Â  Â  Â  if "buying_guide" in res.keys():
Â  Â  Â  Â  Â  Â  snippets.append(res["buying_guide"])
Â  Â  Â  Â  if "local_results" in res.keys() and "places" in res["local_results"].keys():
Â  Â  Â  Â  Â  Â  snippets.append(res["local_results"]["places"])

Â  Â  Â  Â  if len(snippets) > 0:
Â  Â  Â  Â  Â  Â  return str(snippets)
Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  return "No good search result found"

# è·å–ä¸æŸç§é²œèŠ±ç›¸å…³çš„å¾®åšUIDçš„å‡½æ•°
def get_UID(flower: str):
Â  Â  """Searches for Linkedin or twitter Profile Page."""
Â  Â  # search = SerpAPIWrapper()
Â  Â  search = CustomSerpAPIWrapper()
Â  Â  res = search.run(f"{flower}")
Â  Â  return res
```

å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ï¼Œæˆ‘ä»¬åœ¨ä¸‹é¢çš„é€»è¾‘ä¸­è¿”å›äº†linkï¼Œè€Œä¸æ˜¯snippetã€‚

```plain
Â  Â  Â  Â  if "organic_results" in res.keys():
Â  Â  Â  Â  Â  Â  first_organic_result = res["organic_results"][0]
Â  Â  Â  Â  Â  Â  if "snippet" in first_organic_result.keys():
Â  Â  Â  Â  Â  Â  Â  Â  # snippets.append(first_organic_result["snippet"])
Â  Â  Â  Â  Â  Â  Â  Â  snippets.append(first_organic_result["link"]) 
```

å†æ¬¡Debugï¼Œæˆ‘ä»¬å‘ç°è¿”å›çš„snippetsé‡Œé¢åŒ…å«äº†URLä¿¡æ¯ï¼Œå…¶ä¸­UIDä¿¡æ¯åŒ…å«åœ¨URLä¸­äº†ã€‚

![](https://static001.geekbang.org/resource/image/06/5e/06da407d1f6d93eeaefa6e9f450cdf5e.jpg?wh=1837x1631)

æ­¤æ—¶è¿è¡Œä¸»ç¨‹åºfindbigV.pyï¼Œä¼šå‘ç°ä»£ç†ä¸­è¿”å›äº†URLä¿¡æ¯ï¼Œå¹¶ä¸”ç»è¿‡è¿›ä¸€æ­¥æ€è€ƒï¼Œæç‚¼å‡ºäº†UIDã€‚

![](https://static001.geekbang.org/resource/image/ab/6f/ab67de9be2b4f26be53c0e8af713f16f.jpg?wh=819x326 "æˆåŠŸå¾—åˆ°äº†å¤§ V çš„ UID")

## ç¬¬äºŒæ­¥ï¼šçˆ¬å–å¤§ V èµ„æ–™

å¥½çš„ï¼Œç¬¬ä¸€æ­¥è™½ç„¶æ˜¯æœ‰ç£•æœ‰ç»Šï¼Œä½†æ˜¯ç»è¿‡äº†è°ƒæ•´çš„CustomSerpAPIWrapperå·¥å…·å’Œä»£ç†ï¼Œåœ¨LLMçš„å¸®åŠ©ä¹‹ä¸‹ï¼Œæ€»ç®—æ˜¯ä¸è¾±ä½¿å‘½ï¼Œå®Œæˆäº†æ‰¾åˆ°UIDçš„ä»»åŠ¡ã€‚

è¿™ä½å¤§Vï¼Œçœ‹èµ·æ¥åˆå–œæ¬¢ç‰¡ä¸¹ï¼Œåˆå–œæ¬¢æç¬‘ã€‚æˆ‘ä»¬å¾ˆæƒ³å’Œä»–è”ç»œä¸€ä¸‹ï¼Œä¹Ÿè®¸ä»–å¾ˆé€‚åˆä¸ºæˆ‘ä»¬çš„ç‰¡ä¸¹èŠ±å“ç‰Œä»£è¨€ã€‚ï¼ˆåˆ°åº•æ˜¯å¦é€‚åˆï¼Œä¸å¿…ç‰¹åˆ«è®¤çœŸå“ˆï¼Œæ€»ä¹‹æœç´¢â€œç‰¡ä¸¹â€ï¼ŒAgentç»™äº†è¿™ä¸ªIDï¼Œå°±å¯ä»¥äº†ã€‚å’±å­¦çš„æ˜¯LangChainï¼Œä¸æ˜¯çœŸçš„è¦æ‰¾ä»–ä»£è¨€ï¼‰

ä¸è¿‡ï¼ŒçŸ¥å·±çŸ¥å½¼ï¼Œç™¾æˆ˜ä¸æ®†ã€‚æƒ³è¦å’Œä»–æ²Ÿé€šï¼Œå°±å¾—äº†è§£ä»–æ›´å¤šã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨çˆ¬è™«ç¨‹åºï¼Œé€šè¿‡UIDæ¥çˆ¬å–ä»–çš„æ›´å¤šä¿¡æ¯ã€‚

### ä¸»ç¨‹åº findbigV.py

ç¬¬äºŒæ­¥å®Œæˆä¹‹åï¼Œä¸»ç¨‹åºä»£ç å¦‚ä¸‹ï¼š

```plain
# è®¾ç½®OpenAI APIå¯†é’¥
import os
os.environ["OPENAI_API_KEY"] = 'Your OpenAI API Key'
os.environ["SERPAPI_API_KEY"] = 'Your SerpAPI Key'

# å¯¼å…¥æ‰€å–çš„åº“
import re
from agents.weibo_agent import lookup_V
from tools.general_tool import remove_non_chinese_fields
from tools.scraping_tool import get_data

if __name__ == "__main__":

Â  Â  # æ‹¿åˆ°UID
Â  Â  response_UID = lookup_V(flower_type = "ç‰¡ä¸¹" )

Â  Â  # æŠ½å–UIDé‡Œé¢çš„æ•°å­—
Â  Â  UID = re.findall(r'\d+', response_UID)[0]
Â  Â  print("è¿™ä½é²œèŠ±å¤§Vçš„å¾®åšIDæ˜¯", UID)

Â  Â  # æ ¹æ®UIDçˆ¬å–å¤§Vä¿¡æ¯
Â  Â  person_info = get_data(UID)
Â  Â  print(person_info)
```

ä»ç¬¬ä¸€æ­¥åˆ°ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬ä¸»è¦æ˜¯å®Œæˆäº†ä¸€æ¬¡å¾®åšä¿¡æ¯çš„çˆ¬å–ã€‚

### scraping\_tool.py ä¸­çš„ scrape\_weibo æ–¹æ³•

ç¬¬äºŒæ­¥ä¸­çš„å…³é”®é€»è¾‘æ˜¯scraping\_tool.pyä¸­çš„scrape\_weiboæ–¹æ³•ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```plain
# å¯¼å…¥æ‰€éœ€çš„åº“
import json
import requests
import time

# å®šä¹‰çˆ¬å–å¾®åšç”¨æˆ·ä¿¡æ¯çš„å‡½æ•°
def scrape_weibo(url: str):
Â  Â  '''çˆ¬å–ç›¸å…³é²œèŠ±æœåŠ¡å•†çš„èµ„æ–™'''
Â  Â  headers = {
Â  Â  Â  Â  "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36",
Â  Â  Â  Â  "Referer": "https://weibo.com"
Â  Â  }
Â  Â  cookies = {
Â  Â  Â  Â  "cookie": '''SINAGLOBAL=3762226753815.13.1696496172299; ALF=1699182321; SCF=AiOo8xtPwGonZcAbYyHXZbz9ixm97mWi0vHt_VvuOKB-u4-rcvlGtWCrE6MfMucpxiOy5bYpkIFNWTj7nYGcyp4.; _sc_token=v2%3A2qyeqD3cTZFNTl0sn3KAYe4fNqzMUEP-C7nxNsd_Q1r-vpYMlF2K3xc4vWNuLNBbp3RsohghkJdlSVN09cymVo5AKAm0V92004V8cSRe9O5v9B65jd4yiG_sATDeB06GnjiJulXUrEF_6XsHh1ozK6jvbTKEUIkF7v0_BlbX6IcWrPkwh6xL_WM_0YUV2v7CtNPwyxfbAjaWnG32TsxG_ftN3s5m7qfaRftU6iTOSnE%3D; XSRF-TOKEN=4o0E6jaUQ0BlN77az0sURTg3; PC_TOKEN=dcf0e7607f; login_sid_t=36ebf31f1b3694fb71e77e35d30f052f; cross_origin_proto=SSL; WBStorage=4d96c54e|undefined; _s_tentry=passport.weibo.com; UOR=www.google.com,weibo.com,login.sina.com.cn; Apache=7563213131783.361.1696667509205; ULV=1696667509207:2:2:2:7563213131783.361.1696667509205:1696496172302; wb_view_log=3440*14401; WBtopGlobal_register_version=2023100716; crossidccode=CODE-gz-1QP2Jh-13l47h-79FGqrAQgQbR8ccb7b504; SSOLoginState=1696667553; SUB=_2A25IJWfwDeThGeFJ6lsQ-SbNzjuIHXVr5gm4rDV8PUJbkNAbLUWtkW1NfJd_XHamKIzj5RlT_-RGMma6z3YQZUK3; SUBP=0033WrSXqPxfM725Ws9jqgMF55529P9D9WFDKvBlvg14YuHk_4c6MEH_5NHD95QNS024eK.ReK-NWs4DqcjZCJ8oIN.pSKzceBtt; WBPSESS=gyY2mn77F4p5VxWF2IB_yFR0phHVTNfaJAHAMprnW7MeUr-NHPZNyeeyKae3tHELlc_RbcI1XPSz-TjSJqWrIXs-yh1fwhxL4mSDrnpPZEogFt8ScF5NEwSqPGn7x2KMAgTHtWde-3MBm6orQ98PDA=='''
Â  Â  }
Â  Â  response = requests.get(url, headers=headers, cookies=cookies)
Â  Â  time.sleep(3) Â  # åŠ ä¸Š3s çš„å»¶æ—¶é˜²æ­¢è¢«åçˆ¬
Â  Â  return response.text

# æ ¹æ®UIDæ„å»ºURLçˆ¬å–ä¿¡æ¯
def get_data(id):
Â  Â  url = "https://weibo.com/ajax/profile/detail?uid={}".format(id)
Â  Â  html = scrape_weibo(url)
Â  Â  response = json.loads(html)

Â  Â  return response
```

æˆ‘è¿™æ®µçˆ¬è™«ä»£ç ç‰¹åˆ«ç®€æ´ï¼Œä¸éœ€è¦è¿‡å¤šçš„è§£é‡Šï¼Œå”¯ä¸€éœ€è¦è¯´æ˜çš„éƒ¨åˆ†æ˜¯æ€ä¹ˆæ‰¾åˆ°ä½ è‡ªå·±çš„Cookiesã€‚

> Cookie æ˜¯ç”±æœåŠ¡å™¨å‘é€åˆ°ç”¨æˆ·æµè§ˆå™¨çš„ä¸€å°æ®µæ•°æ®ï¼Œå¹¶å¯èƒ½åœ¨éšåçš„è¯·æ±‚ä¸­è¢«å›ä¼ ã€‚å®ƒçš„ä¸»è¦ç›®çš„æ˜¯è®©æœåŠ¡å™¨çŸ¥é“ç”¨æˆ·çš„ä¸Šä¸‹æ–‡ä¿¡æ¯æˆ–çŠ¶æ€ã€‚åœ¨Webçˆ¬è™«ä¸­ï¼Œä½¿ç”¨æ­£ç¡®çš„Cookieå¯ä»¥æ¨¡æ‹Ÿç™»å½•çŠ¶æ€ï¼Œä»è€Œè·å–åˆ°éœ€è¦æƒé™çš„ç½‘é¡µå†…å®¹ã€‚

é¦–å…ˆï¼Œæˆ‘æ˜¯ç”¨QQ IDç™»å½•çš„å¾®åšï¼Œæˆ‘å‘ç°é€šè¿‡è¿™æ ·çš„æ–¹å¼æ‰¾åˆ°çš„Cookieèƒ½ç”¨å¾—æ¯”è¾ƒä¹…ã€‚

ç„¶åï¼Œä»æˆ‘çš„æµè§ˆå™¨ä¸­è·å– Cookieï¼Œä»¥ä¸‹æ˜¯ç®€å•æ­¥éª¤ï¼š

1. ä½¿ç”¨æµè§ˆå™¨ï¼ˆå¦‚ Chromeã€Firefoxï¼‰è®¿é—®å¾®åšå¹¶ç™»å½•ã€‚
2. ç™»å½•åï¼Œå³é”®å•å‡»é¡µé¢å¹¶é€‰æ‹©â€œæ£€æŸ¥â€ï¼ˆInspectï¼‰ã€‚
3. æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œç‚¹å‡» Network é€‰é¡¹å¡ã€‚
4. åœ¨é¡µé¢ä¸Šè¿›è¡Œä¸€äº›æ“ä½œï¼ˆå¦‚åˆ·æ–°é¡µé¢ï¼‰ï¼Œç„¶ååœ¨ Network é€‰é¡¹å¡ä¸‹æŸ¥çœ‹è¯·æ±‚åˆ—è¡¨ã€‚
5. é€‰æ‹©ä»»ä¸€è¯·æ±‚é¡¹ï¼Œç„¶ååœ¨å³ä¾§çš„ Headers é€‰é¡¹å¡ä¸­æŸ¥æ‰¾ Request Headers éƒ¨åˆ†ã€‚
6. åœ¨è¿™éƒ¨åˆ†ä¸­ï¼Œä½ åº”è¯¥å¯ä»¥çœ‹åˆ°ä¸€ä¸ªåä¸º Cookie çš„å­—æ®µï¼Œè¿™å°±æ˜¯ä½ éœ€è¦çš„ Cookie å€¼ã€‚

å°†è·å–åˆ°çš„å®Œæ•´Cookieå€¼å¤åˆ¶ï¼ˆæŒºé•¿çš„ï¼‰ï¼Œå¹¶æ›¿æ¢ä¸Šè¿°ä»£ç ä¸­çš„ `"ä½ çš„Cookie"` éƒ¨åˆ†ã€‚

![](https://static001.geekbang.org/resource/image/92/38/92ea6832ea69c8a1342a62180b7da538.jpg?wh=3842x1944)

> ä½†è¯·æ³¨æ„ï¼Œå¾®åšçš„Cookieå¯èƒ½æœ‰è¿‡æœŸæ—¶é—´ï¼Œæ‰€ä»¥å¦‚æœä½ å‘ç°ä¸€æ®µæ—¶é—´åä½ çš„çˆ¬è™«æ— æ³•æ­£å¸¸å·¥ä½œï¼Œä½ å¯èƒ½éœ€è¦å†æ¬¡è·å–æ–°çš„Cookieã€‚åŒæ—¶ï¼Œé¢‘ç¹åœ°çˆ¬å–æˆ–å¤§é‡è¯·æ±‚å¯èƒ½ä¼šå¯¼è‡´ä½ çš„è´¦å·è¢«å°ç¦ï¼Œæ‰€ä»¥è¯·è°¨æ…ä½¿ç”¨çˆ¬è™«ã€‚

æ­¤æ—¶ï¼Œè¿è¡Œ findbigV.pyï¼Œå°±å¾—åˆ°äº†ä¸‹é¢çš„è¾“å‡ºã€‚

![](https://static001.geekbang.org/resource/image/e6/94/e696b6dae6332a486763e29e9f310594.jpg?wh=1318x665)

### ç²¾ç®€çˆ¬å–è¾“å‡º

æœ€åä¸€ä¸ªæ­¥éª¤ï¼Œæ˜¯ç²¾ç®€ä¸Šé¢çš„è¾“å‡ºï¼Œå› ä¸ºç±»ä¼¼ `'word_color': '#FFEA8011', 'background_color': '#FF181818'` è¿™æ ·çš„å†…å®¹ä¼šå æ®å¾ˆå¤šTokenç©ºé—´ï¼Œè€Œä¸”å¯¹äºLLMæ€»ç»“æ•´ç†ä¿¡æ¯ï¼Œä¹Ÿæ²¡å•¥ä½œç”¨ã€‚

å› æ­¤ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªé¢å¤–çš„æ­¥éª¤ï¼Œå°±æ˜¯\\tools\\general\_tool.pyä¸­çš„remove\_non\_chinese\_fieldså‡½æ•°ã€‚

```plain
import re

def contains_chinese(s):
Â  Â  return bool(re.search('[\u4e00-\u9fa5]', s))

def remove_non_chinese_fields(d):
Â  Â  if isinstance(d, dict):
Â  Â  Â  Â  to_remove = [key for key, value in d.items() if isinstance(value, (str, int, float, bool)) and (not contains_chinese(str(value)))]
Â  Â  Â  Â  for key in to_remove:
Â  Â  Â  Â  Â  Â  del d[key]
Â  Â  Â  Â  
Â  Â  Â  Â  for key, value in d.items():
Â  Â  Â  Â  Â  Â  if isinstance(value, (dict, list)):
Â  Â  Â  Â  Â  Â  Â  Â  remove_non_chinese_fields(value)
Â  Â  elif isinstance(d, list):
Â  Â  Â  Â  to_remove_indices = []
Â  Â  Â  Â  for i, item in enumerate(d):
Â  Â  Â  Â  Â  Â  if isinstance(item, (str, int, float, bool)) and (not contains_chinese(str(item))):
Â  Â  Â  Â  Â  Â  Â  Â  to_remove_indices.append(i)
Â  Â  Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  Â  Â  remove_non_chinese_fields(item)
Â  Â  Â  Â  
Â  Â  Â  Â  for index in reversed(to_remove_indices):
Â  Â  Â  Â  Â  Â  d.pop(index)
```

åœ¨findbigV.pyä¸­ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå¯¹çˆ¬è™«çš„è¾“å‡ºç»“æœè¿›è¡Œäº†ç²¾ç®€ã€‚

```plain
Â  Â  # ç§»é™¤æ— ç”¨çš„ä¿¡æ¯
Â  Â  remove_non_chinese_fields(person_info)
Â  Â  print(person_info)
```

é‡æ–°è¿è¡ŒfindbigV.pyï¼Œç»“æœå¦‚ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/16/10/16aaa4d952428bb1960ecfee9df6df10.jpg?wh=1310x217)

æ­¤æ—¶ï¼Œçˆ¬å–çš„å†…å®¹å°±åªå‰©ä¸‹äº†å¹²è´§ã€‚

## æ€»ç»“æ—¶åˆ»

è¿™èŠ‚è¯¾æˆ‘ä»¬å®Œæˆäº†å‰ä¸¤æ­¥çš„å·¥ä½œã€‚åˆ†åˆ«æ˜¯ï¼Œæ‰¾åˆ°é€‚åˆæ¨å¹¿æŸç§é²œèŠ±çš„å¤§Vçš„å¾®åšUIDï¼Œå¹¶ä¸”çˆ¬å–äº†å¤§Vçš„èµ„æ–™ã€‚è¿™ä¸ºæˆ‘ä»¬åç»­ç”Ÿæˆæ–‡æœ¬ã€è¿›ä¸€æ­¥é“¾æ¥å¤§Væ‰“ä¸‹äº†è‰¯å¥½çš„åŸºç¡€ã€‚

å…¶ä¸­ï¼Œæˆ‘ä»¬ç”¨åˆ°äº†å¤§é‡ä¹‹å‰å­¦ä¹ è¿‡çš„LangChainç»„ä»¶ï¼Œå…·ä½“åŒ…æ‹¬ï¼š

1. ç”¨æç¤ºæ¨¡æ¿å‘Šè¯‰å¤§æ¨¡å‹æˆ‘ä»¬è¦æ‰¾åˆ°å†…å®¹ï¼ˆUIDï¼‰ã€‚
2. è°ƒç”¨LLMã€‚
3. ä½¿ç”¨Chainã€‚
4. ä½¿ç”¨Agentã€‚
5. åœ¨Agentä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªCustomized Toolï¼Œå› ä¸ºLangChainå†…ç½®çš„SerpAPI Toolä¸èƒ½å®Œå…¨æ»¡è¶³æˆ‘ä»¬çš„éœ€è¦ã€‚è¿™ç»™äº†æˆ‘ä»¬ä¸€ä¸ªå¥½æœºä¼šåˆ›å»ºè‡ªå·±çš„â€œç§äººå®šåˆ¶â€ Toolã€‚

åœ¨ä¸‹èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬è¿˜è¦ç»§ç»­åˆ©ç”¨å¤§æ¨¡å‹çš„æ€»ç»“æ–‡æœ¬ã€ç”Ÿæˆæ–‡æœ¬çš„åŠŸèƒ½ï¼Œæ¥ä¸ºæˆ‘ä»¬æ’°å†™èƒ½å¤Ÿæ‰“åŠ¨å¤§Vå’Œå’±æ˜“é€Ÿé²œèŠ±åˆä½œçš„æ–‡æ¡ˆï¼Œæˆ‘ä»¬è¿˜å°†åˆ©ç”¨Output ParseræŠŠæ–‡æ¡ˆè§£ææˆéœ€è¦çš„æ ¼å¼ï¼Œéƒ¨ç½²åˆ°ç½‘ç»œæœåŠ¡å™¨ç«¯ã€‚æ•¬è¯·æœŸå¾…ï¼

## æ€è€ƒé¢˜

1. å¦‚æœAgentä¸è¿”å›UIDï¼Œè€Œæ˜¯è¿”å›URLï¼Œæ˜¯ä¸æ˜¯ä¹Ÿèƒ½å¤Ÿå®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Ÿä½ å¯ä»¥å°è¯•é‡æ„æç¤ºæ¨¡æ¿ä»¥åŠåç»­é€»è¾‘ï¼Œè¿”å›URLï¼Œç„¶åæ‰‹åŠ¨ä»URLä¸­è§£æå‡ºUIDã€‚
2. ç ”ç©¶ä¸€ä¸‹SerpAPIWrapperç±»çš„\_process\_responseä¸­çš„ä»£ç ï¼Œçœ‹çœ‹è¿™ä¸ªæ–¹æ³•å…·ä½“æ˜¯æ€ä¹ˆè®¾è®¡çš„ï¼Œç”¨æ¥å®ç°äº†ä»€ä¹ˆåŠŸèƒ½ï¼Ÿ

æœŸå¾…åœ¨ç•™è¨€åŒºçœ‹åˆ°ä½ çš„åˆ†äº«ï¼Œå¦‚æœè§‰å¾—å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™æœ‰éœ€è¦çš„æœ‹å‹ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ6ï¼‰</strong></div><ul>
<li><span>é©¬é‡Œå¥¥çš„é©¬é‡Œå¥¥</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>2ä¸ªé—®é¢˜
1.è™½ç„¶ä¿®æ”¹äº†è·å–linkçš„æ–¹å¼ï¼Œä¾ç„¶æ˜¯ä¼šæœ‰é”™è¯¯ï¼Œåœ¨æˆ‘è¿™é‡Œè§£æåˆ°çš„æ˜¯ https:&#47;&#47;weibo.com&#47;p&#47;xxxåçš„è¿™ä¸ªxxæ•°å­—ï¼›
2.æˆ‘å°è¯•ä¿®æ”¹æç¤ºè¯ï¼Œåªæœç´¢ç²‰ä¸è¶…è¿‡ä¸€ç™¾ä¸‡çš„è´¦å·ï¼Œä¼¼ä¹ä¹Ÿä¸ç”Ÿæ•ˆã€‚</p>2023-12-31</li><br/><li><span>Liberalism</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>åœ¨çˆ¬å–å¾®åšç”¨æˆ·èµ„æ–™æ—¶æŠ¥ 400 é”™è¯¯ï¼Œè¯·é—®æ˜¯å“ªé‡Œå‡ºäº†é—®é¢˜ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ

def scrape_weibo(url: str):
    &quot;&quot;&quot;çˆ¬å–ç›¸å…³é²œèŠ±æœåŠ¡å•†çš„èµ„æ–™&quot;&quot;&quot;
    headers = {
        &quot;User-Agent&quot;: &quot;Mozilla&#47;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#47;537.36 (KHTML, like Gecko) &quot;
                      &quot;Chrome&#47;89.0.4389.82 Safari&#47;537.36&quot;,
        &quot;Referer&quot;: &quot;https:&#47;&#47;weibo.com&quot;}
    cookies = {
        &quot;cookie&quot;: &#39;&#39;&#39;SINAGLOBAL=6620500101466.929.1684124696145; 
        ULV=1701318517344:5:1:1:2994044278409.513.1701318517342:1695626334231; 
        SUB=_2A25IbH_LDeRhGedJ71EX9C3Kwz6IHXVrAP0DrDV8PUNbmtAGLWP8kW9NVhncgwwKDAJC-BEIEyWCj9aAZiYRqGGn; 
        SUBP=0033WrSXqPxfM725Ws9jqgMF55529P9D9WF1hJoCEpSf.bqAJzfD-UMO5JpX5KzhUgL.Fo2NShecShec1hz2dJLoI7peIgiLMJ8jIPS_qgRt; 
        ALF=1732854554; XSRF-TOKEN=Dr6hVUuVr5JfuRn3NHntHjk7; 
        WBPSESS=qWBqMfNAAnlnO3TmyuUMG1qvHg86Rz2Zv7YHVRzN1MJAsJSyBhxx0_AUvWsjCUhaTWJpEmAC3UJ6u4OKi_zznpkRnRQ8ciUPXXDldaaw58i1fvBUm_1oDKnjo6sGr9qeK-zdbnLVltKplYXJysV88A==&#39;&#39;&#39;
    }
    response = requests.get(url, headers=headers, cookies=cookies)

    time.sleep(3)  # åŠ ä¸Š3s çš„å»¶æ—¶é˜²æ­¢è¢«åçˆ¬
    return response.text</p>2023-12-02</li><br/><li><span>Liberalism</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>def scrape_weibo(url: str):
    &quot;&quot;&quot;çˆ¬å–ç›¸å…³é²œèŠ±æœåŠ¡å•†çš„èµ„æ–™&quot;&quot;&quot;
    headers = {
        &#39;Accept&#39;: &#39;text&#47;html,application&#47;xhtml+xml,application&#47;xml;q=0.9,image&#47;webp,*&#47;*;q=0.8&#39;,
        &#39;Cache-Control&#39;: &#39;max-age=0&#39;,
        &#39;Connection&#39;: &#39;keep-alive&#39;,
        &#39;Referer&#39;: &#39;http:&#47;&#47;www.baidu.com&#47;&#39;,
        &#39;User-Agent&#39;: &#39;Mozilla&#47;5.0 (Windows NT 6.1; WOW64) AppleWebKit&#47;537.36 (KHTML, like Gecko)&#39;
    }
    cookies = {
        &quot;cookie&quot;: &#39;&#39;&#39;SINAGLOBAL=6620500101466.929.1684124696145; 
        ULV=1701318517344:5:1:1:2994044278409.513.1701318517342:1695626334231; 
        SUB=_2A25IbH_LDeRhGedJ71EX9C3Kwz6IHXVrAP0DrDV8PUNbmtAGLWP8kW9NVhncgwwKDAJC-BEIEyWCj9aAZiYRqGGn; 
        SUBP=0033WrSXqPxfM725Ws9jqgMF55529P9D9WF1hJoCEpSf.bqAJzfD-UMO5JpX5KzhUgL.Fo2NShecShec1hz2dJLoI7peIgiLMJ8jIPS_qgRt; 
        ALF=1732854554; XSRF-TOKEN=Dr6hVUuVr5JfuRn3NHntHjk7; 
        WBPSESS=qWBqMfNAAnlnO3TmyuUMG1qvHg86Rz2Zv7YHVRzN1MJAsJSyBhxx0_AUvWsjCUhaTWJpEmAC3UJ6u4OKi_zznpkRnRQ8ciUPXXDldaaw58i1fvBUm_1oDKnjo6sGr9qeK-zdbnLVltKplYXJysV88A==&#39;&#39;&#39;
    }
    response = requests.get(url, headers=headers, cookies=cookies)

    time.sleep(3)  # åŠ ä¸Š3s çš„å»¶æ—¶é˜²æ­¢è¢«åçˆ¬
    return response.text


çˆ¬å–æ•°æ®è¿™é‡Œä¸€ç›´æŠ¥é”™  400 </p>2023-12-01</li><br/><li><span>fireshort</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>é»„è€å¸ˆï¼Œè¿™é‡Œçš„Agentæ„Ÿè§‰æ²¡æœ‰å‘æŒ¥ä½œç”¨ï¼Œæ²¡æœ‰å¤ªå¤šæ™ºèƒ½ï¼ŒLLMå°±åŠ äº†â€œå¾®åšâ€å»æœç´¢ã€‚
ID = agent.run(prompt_template.format_prompt(flower=flower_type))
æ”¹æˆ
ID = get_UID(flower_type+&quot; å¾®åš&quot;)
å¾—åˆ°ä¸€æ ·çš„ç»“æœã€‚


</p>2023-11-30</li><br/><li><span>starj</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>githubä¸Šæ²¡æœ‰ä»£ç ï¼Ÿ</p>2023-10-31</li><br/><li><span>å“ä¸îŒ®îŒ®</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æˆ‘é‡åˆ°ä¸€ä¸ªæŠ¥é”™ï¼š
    raise JSONDecodeError(&quot;Expecting value&quot;, s, err.value) from None
json.decoder.JSONDecodeError: Expecting value: line 2 column 3 (char 3)

çœ‹ç€å¥½åƒæ˜¯ json.loadsè§£æå¤±è´¥äº†ã€‚
è¿›ä¸€æ­¥çœ‹æŠ¥é”™æ ˆï¼Œæ˜¯æŠ¥ 400 çš„çŠ¶æ€ç ã€‚

äºæ˜¯æˆ‘å°è¯•å°†get_dataæ–¹æ³•æ‰€è¯·æ±‚çš„urlæ‰“å°å‡ºæ¥äº†ä¸€ä¸‹ã€‚

```
# æ ¹æ®UIDæ„å»ºURLçˆ¬å–ä¿¡æ¯
def get_data(id):
    url = &quot;https:&#47;&#47;weibo.com&#47;ajax&#47;profile&#47;detail?uid={}&quot;.format(id)
    print(&quot;url-&gt;&quot;,url)
    html = scrape_weibo(url)
    print(html)
    response = json.loads(html)

    return response
```

ç»“æœå¦‚ä¸‹ï¼š

&gt; Finished chain.
è¿™ä½é²œèŠ±å¤§Vçš„å¾®åšIDæ˜¯ 100808
url-&gt; https:&#47;&#47;weibo.com&#47;ajax&#47;profile&#47;detail?uid=100808
&lt;h2&gt;400 Bad Request&lt;&#47;h2&gt;
Traceback (most recent call last):
  File &quot;&#47;Users&#47;bawenmao&#47;PycharmProjects&#47;socializer_v0&#47;findbigV.py&quot;, line 23, in &lt;module&gt;
    person_info = get_data(UID)
                  ^^^^^^^^^^^^^
  File &quot;&#47;Users&#47;bawenmao&#47;PycharmProjects&#47;socializer_v0&#47;tools&#47;scraping_tool.py&quot;, line 26, in get_data
    response = json.loads(html)
               ^^^^^^^^^^^^^^^^
  File &quot;&#47;Library&#47;Frameworks&#47;Python.framework&#47;Versions&#47;3.11&#47;lib&#47;python3.11&#47;json&#47;__init__.py&quot;, line 346, in loads
    return _default_decoder.decode(s)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;&#47;Library&#47;Frameworks&#47;Python.framework&#47;Versions&#47;3.11&#47;lib&#47;python3.11&#47;json&#47;decoder.py&quot;, line 337, in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;&#47;Library&#47;Frameworks&#47;Python.framework&#47;Versions&#47;3.11&#47;lib&#47;python3.11&#47;json&#47;decoder.py&quot;, line 355, in raw_decode
    raise JSONDecodeError(&quot;Expecting value&quot;, s, err.value) from None
json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)



æ˜¯ä¸æ˜¯æ‰€è¯·æ±‚çš„é‚£ä¸ªurl æœ¬èº«ä¸å¯¹ï¼›
è¯·æ•™ä¸‹è€å¸ˆï¼Œè¿™æ˜¯å“ªé‡Œçš„é—®é¢˜ï¼›</p>2024-02-21</li><br/>
</ul>