ä½ å¥½ï¼Œæˆ‘æ˜¯é»„ä½³ï¼Œæ¬¢è¿æ¥åˆ°LangChainå®æˆ˜è¯¾ï¼

è¿™èŠ‚è¯¾æˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ ä¸€ä¸‹LangChainä¸­çš„å›è°ƒå‡½æ•°ã€‚

## å›è°ƒå‡½æ•°å’Œå¼‚æ­¥ç¼–ç¨‹

å›è°ƒå‡½æ•°ï¼Œä½ å¯èƒ½å¹¶ä¸é™Œç”Ÿã€‚å®ƒæ˜¯å‡½æ•°Aä½œä¸ºå‚æ•°ä¼ ç»™å¦ä¸€ä¸ªå‡½æ•°Bï¼Œç„¶ååœ¨å‡½æ•°Bå†…éƒ¨æ‰§è¡Œå‡½æ•°Aã€‚å½“å‡½æ•°Bå®ŒæˆæŸäº›æ“ä½œåï¼Œä¼šè°ƒç”¨ï¼ˆå³â€œå›è°ƒâ€ï¼‰å‡½æ•°Aã€‚è¿™ç§ç¼–ç¨‹æ¨¡å¼å¸¸è§äºå¤„ç†å¼‚æ­¥æ“ä½œï¼Œå¦‚äº‹ä»¶ç›‘å¬ã€å®šæ—¶ä»»åŠ¡æˆ–ç½‘ç»œè¯·æ±‚ã€‚

> åœ¨ç¼–ç¨‹ä¸­ï¼Œå¼‚æ­¥é€šå¸¸æ˜¯æŒ‡ä»£ç ä¸å¿…ç­‰å¾…æŸä¸ªæ“ä½œå®Œæˆï¼ˆå¦‚I/Oæ“ä½œã€ç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æŸ¥è¯¢ç­‰ï¼‰å°±å¯ä»¥ç»§ç»­æ‰§è¡Œçš„èƒ½åŠ›ã€‚å¼‚æ­¥æœºåˆ¶çš„å®ç°æ¶‰åŠäº‹ä»¶å¾ªç¯ã€ä»»åŠ¡é˜Ÿåˆ—å’Œå…¶ä»–å¤æ‚çš„åº•å±‚æœºåˆ¶ã€‚è¿™ä¸åŒæ­¥ç¼–ç¨‹å½¢æˆå¯¹æ¯”ï¼Œåœ¨åŒæ­¥ç¼–ç¨‹ä¸­ï¼Œæ“ä½œå¿…é¡»æŒ‰ç…§å®ƒä»¬å‡ºç°çš„é¡ºåºå®Œæˆã€‚

ä¸‹é¢æ˜¯å›è°ƒå‡½æ•°çš„ä¸€ä¸ªç®€å•ç¤ºä¾‹ã€‚

```plain
def compute(x, y, callback):
Â  Â  result = x + y
Â  Â  callback(result)

def print_result(value):
Â  Â  print(f"The result is: {value}")

def square_result(value):
Â  Â  print(f"The squared result is: {value**2}")

# ä½¿ç”¨print_resultä½œä¸ºå›è°ƒ
compute(3, 4, print_result) Â # è¾“å‡º: The result is: 7

# ä½¿ç”¨square_resultä½œä¸ºå›è°ƒ
compute(3, 4, square_result) Â # è¾“å‡º: The squared result is: 49
```
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ7ï¼‰</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/0f/a0/a4/b060c723.jpg" width="30px"><span>é˜¿æ–¯è’‚èŠ¬</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ç¬”è®°markï¼š


1.ç–‘ä¼¼çº é”™ï¼š
ç¬¬äºŒä¸ªä»£ç ç¤ºä¾‹åå†™é“ï¼šã€compute å‡½æ•°å¼€å§‹æ‰§è¡Œã€‚å½“å®ƒé‡åˆ° await asyncio.sleep(2) æ—¶ï¼Œå®ƒä¼šæš‚åœã€‘
ä½†æ˜¯ä»£ç ä¸­æ˜¯ await asyncio.sleep(0.5)ï¼Œä¼‘çœ æ—¶é•¿ä¼šå½±å“æœ€ç»ˆç¨‹åºçš„æ‰“å°è¾“å‡ºé¡ºåºï¼›
åé¢èŠ±å‰éƒ¨åˆ† ã€åœ¨ MyFlowerShopAsyncHandler ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† await asyncio.sleep(0.3) ã€‘ä¹Ÿä¸ä»£ç ä¸­çš„ await asyncio.sleep(0.5) ä¸ä¸€è‡´ï¼›
å¦‚æœå±å®ï¼Œè¿˜æ˜¯å»ºè®®ä¿®æ”¹ä¸‹ï¼Œå¦åˆ™å®¹æ˜“é€ æˆå›°æƒ‘


2. è‡ªå®šä¹‰å›è°ƒå‡½æ•° ä»£ç æŠ¥é”™é—®é¢˜
ä¸€å¼€å§‹ç›´æ¥ä½¿ç”¨è€å¸ˆçš„ä»£ç ï¼Œæœªèƒ½è·å¾—æµå¼å“åº”çš„æ‰“å°ï¼Œå‡ºç°æŠ¥é”™ï¼š
Retrying langchain.chat_models.openai.acompletion_with_retry.&lt;locals&gt;._completion_with_retry in 4.0 seconds as it raised APIConnectionError: Error communicating with OpenAI.
ä½†æ˜¯æ­¤æ—¶éæµå¼çš„å“åº”ï¼Œæ˜¯èƒ½å¤Ÿæ­£å¸¸å®Œæˆçš„ï¼›
æŠ˜è…¾è®¸ä¹…ï¼Œå®šä½åˆ°æ˜¯openaiä»£ç†çš„é—®é¢˜ï¼Œä½†æ˜¯æµå¼å“åº”æ˜¯é€šè¿‡SSEåè®®ï¼Œæ­¤æ—¶vpnä¼¼ä¹è¢«ç»•è¿‡äº†ï¼Œå°†vpnä»£ç†æ˜¾ç¤ºæ·»åŠ åˆ° OPENAI_PROXY ç¯å¢ƒå˜é‡åè§£å†³

3. æœ€åçš„ additional_interactions() ç¤ºä¾‹ä¸­ï¼Œå¯ä»¥å°† asynio.gather çš„è¿”å›ç»“æœæ‰“å°å‡ºæ¥ï¼Œèƒ½å¤Ÿçœ‹åˆ°æ¯ä¸ªä»»åŠ¡ä½¿ç”¨çš„tokenæ•°é‡ï¼Œä¸æœ€ç»ˆçš„æ€»æ•°æ˜¯ä¸€è‡´çš„</div>2023-10-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/a0/a4/b060c723.jpg" width="30px"><span>é˜¿æ–¯è’‚èŠ¬</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æ¥äº¤ä½œä¸šäº†ï¼š

æ€è€ƒé¢˜1ï¼š
åœ¨ç¡®ä¿æ•ˆæœç›¸åŒçš„ä¸‰è½®äº¤äº’ä¸­ï¼Œä½¿ç”¨äº†å…¶ä»–è®°å¿†æœºåˆ¶ï¼Œå¹¶è®°å½•ä»¤ç‰Œä½¿ç”¨æƒ…å†µï¼ˆåˆ†åˆ«æµ‹è¯•ä¸‰æ¬¡å–èŒƒå›´å€¼ï¼‰
ConversationBufferMemory: 1000 ~ 1500
ConversationBufferWindowMemory(k=2): 1200 ~ 1600
ConversationSummaryMemory: 2000 ~ 2500
ConversationSummaryBufferMemory(max_token_limt=300): 1000~1500

å¤§è‡´çœ‹ä¹Ÿç¬¦åˆä¼°ç®—ç¤ºæ„å›¾ç¬¬ä¸€é˜¶æ®µ 0-5 interacitions çš„èµ°åŠ¿ï¼ŒConversationSummaryMemory å¢é•¿è¾ƒå¿«ï¼Œå…¶ä»–å‡ ä¸ªå¢é•¿é€Ÿç‡è¾ƒä¸ºä¸€è‡´


æ€è€ƒé¢˜2ï¼š
ä½¿ç”¨LLMChainçš„ run æ–¹æ³•ä¹Ÿå¯ä»¥ä¼ é€’callback

class MyCallBackHandler(BaseCallbackHandler):
    def on_llm_new_token(self, token: str, **kwargs) -&gt; None:
        print(f&quot;recv token: {token}&quot;)


llm = ChatOpenAI(streaming=True)
prompt = PromptTemplate.from_template(&quot;1 + {number} = &quot;)


chain = LLMChain(llm=llm, prompt=prompt)
chain.run(number=2, callbacks=[MyCallBackHandler()])

å…¶å®è¿™ä¸ªç¤ºä¾‹å°±æ˜¯ä»è€å¸ˆçš„å»¶ä¼¸é˜…è¯»ä¸­â€œæ‹¿æ¥â€çš„ï¼Œä¸çŸ¥ç­”å¯¹æ²¡</div>2023-10-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/67/fe/5d17661a.jpg" width="30px"><span>æ‚Ÿå°˜</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œè¿™èŠ‚è¯¾å°‘äº†è¾“å‡ºç»“æœçš„æ¼”ç¤º~ç†è§£èµ·æ¥æœ‰ç‚¹è´¹åŠ²</div>2023-11-12</li><br/><li><img src="" width="30px"><span>yanyu-xin</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>###3 å°†è¯¾ç¨‹ä»£ç åˆ°å¤§æ¨¡å‹ä¿®è®¢ä¸ºå›½äº§é€šä¹‰åƒé—®æ¨¡å‹ï¼ˆ03_LangChainOpenAICallback.pyï¼‰
###â€œç”¨ get_openai_callback æ„é€ ä»¤ç‰Œè®¡æ•°å™¨â€ä»£ç ã€‚ç”¨ ChatOpenAIå’Œåƒé—®æ¨¡å‹å¹³æ›¿ OpenAI
# åŸä»£ç 3
llm = OpenAI()
# æ–°ä»£ç 3
from langchain_openai import ChatOpenAI
llm = ChatOpenAI(
        model_name=&quot;qwen-turbo&quot;,
        stream_usage=True,
        api_key= â€œAPI_KEYâ€, #å¡«å†™ä½ è‡ªå·±çš„DASHSCOPE_API_KEY
        base_url=&quot;https:&#47;&#47;dashscope.aliyuncs.com&#47;compatible-mode&#47;v1&quot;, 
    )

###4 ä¿®æ”¹â€œadditional_interactions å¼‚æ­¥å‡½æ•°â€ä»£ç ï¼ˆ03_LangChainOpenAICallback.pyï¼‰ï¼Œå°†llm.agenerateä¸­çš„å‚æ•°ç”¨ langchain_core.messages ä¿®è®¢ã€‚

# æ—§ä»£ç 4
import asyncio
async def additional_interactions():
    with get_openai_callback() as cb:
        await asyncio.gather(
            *[llm.agenerate([&quot;æˆ‘å§å§å–œæ¬¢ä»€ä¹ˆé¢œè‰²çš„èŠ±ï¼Ÿ&quot;]) for _ in range(3)]
        )
    print(&quot;\nå¦å¤–çš„äº¤äº’ä¸­ä½¿ç”¨çš„tokens:&quot;, cb.total_tokens)
asyncio.run(additional_interactions())

# æ–°ä»£ç 4
import asyncio
from langchain_core.messages import HumanMessage, SystemMessage
messages = [[
            SystemMessage(content=&quot;ä½ æ˜¯ä¸ªèŠ±åº—å°åŠ©æ‰‹ã€‚&quot;),
            HumanMessage(content=&quot;æˆ‘å§å§å–œæ¬¢ä»€ä¹ˆé¢œè‰²çš„èŠ±ï¼Ÿ&quot;),
        ]]

#è¿›è¡Œæ›´å¤šçš„å¼‚æ­¥äº¤äº’å’Œtokenè®¡æ•°
async def additional_interactions():
    print(&quot;\nå¼€å§‹è¿›è¡Œæ›´å¤šçš„äº¤äº’...&quot;)
    with get_openai_callback() as cb:
        await asyncio.gather(

            *[llm.agenerate(messages) for _ in range(3)]
        )
   print(f&quot;äº¤äº’{i+1}ä½¿ç”¨çš„tokens: {cb.total_tokens}&quot;)  
asyncio.run(additional_interactions())</div>2024-08-31</li><br/><li><img src="" width="30px"><span>yanyu-xin</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å°†è¯¾ç¨‹ä»£ç åˆ°å¤§æ¨¡å‹ä¿®è®¢ä¸ºå›½äº§é€šä¹‰åƒé—®æ¨¡å‹ï¼š
###1 ä¿®æ”¹â€œåœ¨ç»„ä»¶ä¸­ä½¿ç”¨å›è°ƒå¤„ç†å™¨â€ä»£ç ï¼Œç”¨ ChatOpenAIå’Œåƒé—®æ¨¡å‹å¹³æ›¿ OpenAI

# åŸä»£ç 1
llm = OpenAI()
# æ–°ä»£ç 1
from langchain_openai import ChatOpenAI
llm = ChatOpenAI(
        model_name=&quot;qwen-turbo&quot;, #ç”¨é€šä¹‰æ¨¡å‹
        api_key=â€œAPI_KEYâ€, #å¡«å†™ä½ è‡ªå·±çš„DASHSCOPE_API_KEY
        base_url=&quot;https:&#47;&#47;dashscope.aliyuncs.com&#47;compatible-mode&#47;v1&quot;
	ï¼‰
â€”â€”â€”â€”

###2 ä¿®æ”¹â€œè‡ªå®šä¹‰å›è°ƒå‡½æ•°â€ä»£ç ï¼Œå°†é€šä¹‰æ¨¡å‹å¹³æ›¿OpenAI
# åŸä»£ç 2
flower_shop_chat = ChatOpenAI(
        max_tokens=100,
        streaming=True,
        callbacks=[MyFlowerShopSyncHandler(), MyFlowerShopAsyncHandler()],
    )
# æ–°ä»£ç 2
    flower_shop_chat = ChatOpenAI(
        model_name=&quot;qwen-turbo&quot;,  #ç”¨åƒé—®æ¨¡å‹
        api_key=â€œAPI_KEYâ€, #å¡«å†™ä½ è‡ªå·±çš„DASHSCOPE_API_KEY
        base_url=&quot;https:&#47;&#47;dashscope.aliyuncs.com&#47;compatible-mode&#47;v1&quot;, 
        max_tokens=100,
        streaming=True,
        callbacks=[MyFlowerShopSyncHandler(), MyFlowerShopAsyncHandler()],
    )</div>2024-08-31</li><br/><li><img src="" width="30px"><span>å¼ å¸…</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>*[llm.agenerate([&quot;æˆ‘å§å§å–œæ¬¢ä»€ä¹ˆé¢œè‰²çš„èŠ±ï¼Ÿ&quot;]) for _ in range(3)]è¿™ä¸€è¡Œè¿è¡Œä¸äº†äº†ï¼Œä¼šæŠ›å‡ºé”™è¯¯ã€ValueError: Got unsupported message type: æˆ‘ã€‘ï¼Œæ”¹æˆ
*[llm.agenerate([[HumanMessage(&quot;æˆ‘å§å§å–œæ¬¢ä»€ä¹ˆé¢œè‰²çš„èŠ±ï¼Ÿ&quot;)]]) for _ in range(3)]
å¯ä»¥æˆåŠŸè¿è¡Œ</div>2024-12-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/0a/a4/828a431f.jpg" width="30px"><span>å¼ ç”³å‚²</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>ç¬¬17è®²æ‰“å¡~
å¯ä»¥é€šè¿‡å›è°ƒæœºåˆ¶ï¼Œå°†LLMè¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ—¥å¿—å¼‚æ­¥å†™å…¥æ–‡ä»¶æˆ–æ—¥å¿—æœåŠ¡ï¼Œåç»­é€šè¿‡ELKç­‰æœºåˆ¶è¿›è¡Œæ—¥å¿—é‡‡é›†å’Œé“¾è·¯è¿½è¸ª</div>2024-07-18</li><br/>
</ul>