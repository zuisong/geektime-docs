ä½ å¥½ï¼Œæˆ‘æ˜¯é»„é¸¿æ³¢ã€‚

ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬ä½¿ç”¨Scrapyæ¡†æ¶å·²ç»èƒ½å¤Ÿçˆ¬å–äº†æ–°æµªç½‘çš„æ–°é—»æ•°æ®ï¼Œå¹¶ä¸”ï¼Œæˆ‘ä»¬ä¹Ÿåšäº†ç›¸åº”çš„ç¿»é¡µçˆ¬å–åŠŸèƒ½ã€‚

è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±åœ¨ä¸Šä¸€èŠ‚è¯¾çš„ç¨‹åºä¸­åšä¸€ä¸ªè¡¥å……ï¼ŒåŠ å…¥å‚æ•°ä¼ é€’å’Œæ•°æ®åº“å­˜å‚¨ç›¸å…³åŠŸèƒ½ï¼ˆä½¿ç”¨MongoDBæ•°æ®åº“è¿›è¡Œå­˜å‚¨ï¼‰ã€‚

## Pythonä¸­çš„pymongoåº“

å¦‚æœè¦æƒ³åœ¨Pythonä¸­æ“ä½œMongoDBæ•°æ®åº“ï¼Œé¦–å…ˆæˆ‘ä»¬è¦äº†è§£ä¸€ä¸‹pymongoè¿™ä¸ªåº“ã€‚

pymongoå‡†ç¡®æ¥è®²æ˜¯ä¸€ä¸ªè¿æ¥Pythonå’ŒMongoDBæ•°æ®åº“çš„ä¸€ä¸ªä¸­é—´çš„é©±åŠ¨ç¨‹åºï¼Œè¿™ä¸ªç¨‹åºå¯ä»¥ä½¿Pythonèƒ½å¤Ÿéå¸¸æ–¹ä¾¿åœ°ä½¿ç”¨å’Œæ“ä½œMongoDBæ•°æ®åº“ã€‚åœ¨Pythonä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨pip install pymongoçš„æ–¹å¼æ¥å®‰è£…ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±åœ¨æˆ‘ä»¬çš„cmdç¯å¢ƒä¸­æ¥å®‰è£…æˆ‘ä»¬çš„pymongoåº“ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤åˆ‡æ¢åˆ°æˆ‘ä»¬çš„anacondaç¯å¢ƒä¸­ã€‚

```
activate scrapy_recommendation
```

å¦‚æœä½ æ˜¯Linuxæˆ–è€…Macç”¨æˆ·ï¼Œåˆ™éœ€è¦æŠŠå‘½ä»¤æ”¹æˆä¸‹é¢è¿™æ ·ã€‚

```
conda activate scrapy_recommendation
```

ç´§æ¥ç€ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥å®‰è£…pymongoã€‚

```
pip install pymongo
```

å®‰è£…å®Œæˆä¹‹åï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://static001.geekbang.org/resource/image/f7/30/f70dd8653c160486e21a8c0ab25d4430.png?wh=1443x417)

æ¥ç€ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°è¯•ç€åœ¨æˆ‘ä»¬çš„Pythonç¯å¢ƒä¸­ä½¿ç”¨å®ƒã€‚

æƒ³è¦åœ¨Pythonç¯å¢ƒä¸­ä½¿ç”¨pymongoåº“ï¼Œæˆ‘ä»¬éœ€è¦ç»è¿‡ä¸‹é¢å››ä¸ªæ­¥éª¤ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ9ï¼‰</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ç¬¬07è¯¾ï¼Œåˆ›å»ºçˆ¬è™«ç¨‹åºå‡ºé”™çš„é—®é¢˜è§£å†³äº†ï¼Œè§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š
E:\Javaweb\study\recommendsysï¼Œè¿™ä¸ªç›®å½•ä¸‹é¢æœ‰envå’Œprojectä¸¤ä¸ªå­ç›®å½•ï¼ŒAnacondaå®‰è£…åœ¨envä¸‹é¢ï¼Œè™šæ‹Ÿç¯å¢ƒåœ¨Anacondaçš„å®‰è£…ç›®å½•ä¸‹é¢ã€‚çˆ¬è™«é¡¹ç›®åœ¨projectç›®å½•ä¸‹é¢ã€‚ç„¶åæ‰§è¡Œâ€œscrapy genspider sina_spider sina.com.cnâ€æ—¶å€™æŠ¥é”™äº†å‡ æ¬¡ã€‚
åæ¥åœ¨Eç›˜ä¸‹åˆ›å»ºgeekbangï¼Œå’Œè€å¸ˆçš„ç›®å½•ä¸€æ ·ï¼Œåˆåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„è™šæ‹Ÿç¯å¢ƒï¼Œç…§ç€è€å¸ˆçš„æµç¨‹åšä¸‹æ¥ï¼Œå°±æˆåŠŸåˆ›å»ºäº†çˆ¬è™«ç¨‹åºã€‚
é—®é¢˜è§£å†³äº†ï¼Œä¸çŸ¥é“å…·ä½“åŸå› ï¼Œæ„Ÿè§‰æ˜¯ç›®å½•é—®é¢˜ã€‚å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œè€å¸ˆå¦‚æœæœ‰çœ‹æ³•å°±å‘Šè¯‰æˆ‘ä¸€ä¸‹ï¼Œæ¯”å¦‚ç›®å½•ä½ç½®æœ‰ä¸€äº›å‘ã€‚</div>2023-05-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ç¬¬07è¯¾ï¼Œåˆ›å»ºçˆ¬è™«ç¨‹åºå‡ºé”™çš„é—®é¢˜è§£å†³äº†ï¼Œè§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š
E:\Javaweb\study\recommendsysï¼Œè¿™ä¸ªç›®å½•ä¸‹é¢æœ‰envå’Œprojectä¸¤ä¸ªå­ç›®å½•ï¼ŒAnacondaå®‰è£…åœ¨envä¸‹é¢ï¼Œè™šæ‹Ÿç¯å¢ƒåœ¨Anacondaçš„å®‰è£…ç›®å½•ä¸‹é¢ã€‚çˆ¬è™«é¡¹ç›®åœ¨projectç›®å½•ä¸‹é¢ã€‚ç„¶åæ‰§è¡Œâ€œscrapy genspider sina_spider sina.com.cnâ€æ—¶å€™æŠ¥é”™äº†å‡ æ¬¡ã€‚
åæ¥åœ¨Eç›˜ä¸‹åˆ›å»ºgeekbangï¼Œå’Œè€å¸ˆçš„ç›®å½•ä¸€æ ·ï¼Œåˆåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„è™šæ‹Ÿç¯å¢ƒï¼Œç…§ç€è€å¸ˆçš„æµç¨‹åšä¸‹æ¥ï¼Œå°±æˆåŠŸåˆ›å»ºäº†çˆ¬è™«ç¨‹åºã€‚
é—®é¢˜è§£å†³äº†ï¼Œä¸çŸ¥é“å…·ä½“åŸå› ï¼Œæ„Ÿè§‰æ˜¯ç›®å½•é—®é¢˜ã€‚å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œè€å¸ˆå¦‚æœæœ‰çœ‹æ³•å°±å‘Šè¯‰æˆ‘ä¸€ä¸‹ï¼Œæ¯”å¦‚ç›®å½•ä½ç½®æœ‰ä¸€äº›å‘ã€‚
è¿è¡Œmain.pyåï¼Œé‡åˆ°ä¸¤ä¸ªé—®é¢˜ï¼š
Q1ï¼šROBOTSTXT_OBEY = Trueæ—¶çˆ¬å–å¤±è´¥
åˆ›å»ºmain.pyåï¼Œsettings.pyä¸­ï¼ŒROBOTSTXT_OBEY = Trueã€‚ è¿è¡ŒåæŠ¥å‘Šï¼š
.robotstxt] WARNING: Failure while parsing robots.txt. File either contains garbage or is in an encoding other than UTF-8, treating it as an empty fileã€‚
è¯¥é”™è¯¯å¯¼è‡´å¦å¤–ä¸€ä¸ªé”™è¯¯ï¼š
robotstxt.py&quot;, line 15, in decode_robotstxt
    robotstxt_body = robotstxt_body.decode(&quot;utf-8&quot;)
UnicodeDecodeError: &#39;utf-8&#39; codec can&#39;t decode byte 0xc3 in position 93: invalid continuation byte
ç½‘ä¸Šå»ºè®®ROBOTSTXT_OBEY æ”¹æˆ Falseï¼Œå¥½åƒæ˜¯æˆåŠŸäº†ã€‚
Q2ï¼šæˆåŠŸä¿¡æ¯å’Œè€å¸ˆçš„ä¸åŒï¼Œä¸ç¡®å®šæ˜¯å¦æˆåŠŸã€‚
A ä¸“æ ä¸Šçš„æˆåŠŸä¿¡æ¯å¾ˆå°‘ï¼Œæˆ‘è¿™é‡Œçš„ä¿¡æ¯éå¸¸å¤šï¼Œæ˜¯logè®¾ç½®ä¸åŒå—ï¼Ÿï¼ˆæˆ‘ç”¨PyCharm4.5ï¼‰ã€‚
B ä¸“æ ä¸Šçš„æˆåŠŸä¿¡æ¯ï¼Œæœ‰ä¸¤ä¸ªé“¾æ¥ï¼š
Get https:&#47;&#47;news.sina.com.cn&#47;robots.txt
Get https:&#47;&#47;news.sina.com.cn&#47;china
ä½†æˆ‘çš„è¾“å‡ºä¿¡æ¯ä¸­å¹¶æ²¡æœ‰è¿™ä¸¤ä¸ªé“¾æ¥ï¼Œè¿˜æ²¡æœ‰æˆåŠŸå—ï¼Ÿ
éƒ¨åˆ†ä¿¡æ¯å¦‚ä¸‹ï¼š
2023-05-02 12:56:00 [scrapy.core.engine] INFO: Spider opened
2023-05-02 12:56:00 [scrapy.extensions.logstats] INFO: Crawled 0 pages (at 0 pages&#47;min), scraped 0 items (at 0 items&#47;min)
2023-05-02 12:56:00 [scrapy.extensions.telnet] INFO: Telnet console listening on 127.0.0.1:6023
2023-05-02 12:56:00 [scrapy.downloadermiddlewares.redirect] DEBUG: Redirecting (301) to &lt;GET https:&#47;&#47;www.sina.com.cn&#47;&gt; from &lt;GET http:&#47;&#47;sina.com.cn&#47;&gt;
2023-05-02 [engine] DEBUG: Crawled (200) &lt;GET https:&#47;&#47;www.sina.com.cn&#47;&gt; (referer: None)
2023-05-02 [scrapy.core.engine] INFO: Closing spider (finished)
2023-05-02 [scrapy.statscollectors] INFO: Dumping Scrapy stats:</div>2023-05-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2b/d1/3b/a94459d2.jpg" width="30px"><span>GhostGuest</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ç¬¬ 23 è¡Œä¸­ CONCURRENT_REQUESTS å‚æ•°è§£é‡Šæœ‰è¯¯, è¿™ä¸ªå‚æ•°æ˜¯è®¾ç½®çº¿ç¨‹æ•°ï¼Œå¹¶ä¸æ˜¯å¤šçº¿ç¨‹çš„å¼€å…³ï¼Œæ–‡ä¸­æè¿°å¼€å¯å°±å¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹è¿›è¡Œçˆ¬å–æœ‰ç‚¹æ­§ä¹‰äº†ï¼Œé»˜è®¤å°±æ˜¯å¤šçº¿ç¨‹çˆ¬å–çš„ï¼Œè¿™ä¸ªå‚æ•°åªæ˜¯è®¾ç½®å¹¶å‘é‡</div>2023-04-30</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/mhSYbmpwSzVIEDu714dQuicXCf4ssKQ3LictIW6VoCFZ17EdanhRnhHEHmReiatJBrkUsfkXl4FsWU1JkoHqDiaxKA/132" width="30px"><span>19984598515</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆä½ å¥½ï¼Œä»€ä¹ˆæ—¶å€™èƒ½æœ‰å®Œæ•´æºç å‘¢</div>2023-04-29</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è°ƒç”¨æµç¨‹æ˜¯åœ¨å“ªé‡Œå®šä¹‰çš„ï¼Ÿæ¯”å¦‚ï¼Œå¯¹äºpipelines.pyæ–‡ä»¶ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨è°ƒç”¨å®ƒï¼Œå‡å¦‚æˆ‘æ”¹å˜æ–‡ä»¶åå­—ï¼Œåº”è¯¥å°±æ— æ³•æ­£å¸¸è¿è¡Œäº†ï¼›å¦‚æœçŸ¥é“æµç¨‹è°ƒç”¨å…³ç³»åœ¨å“ªé‡Œå®šä¹‰ï¼Œå°±å¯ä»¥åœ¨é‚£é‡Œä¿®æ”¹æ–‡ä»¶åå­—ã€‚ ï¼ˆæ˜¯settings.pyå—ï¼Ÿï¼‰</div>2023-04-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/23/bb/a1a61f7c.jpg" width="30px"><span>GACÂ·DU</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æŠŠå·²ç»çˆ¬è¿‡çš„æ–°é—»æ ‡é¢˜ï¼Œç”¨Redis seté›†åˆå­˜å‚¨ï¼Œä½œä¸ºå¢é‡è¿‡æ»¤å™¨ï¼Œå¦‚æœæ ‡é¢˜ä¸åœ¨é›†åˆä¸­åˆ™æŠ“å–æ•°æ®å¹¶ä¿å­˜æ•°æ®ï¼ŒåŒæ—¶å°†æ–°çš„æ ‡é¢˜æ”¾åˆ°é›†åˆä¸­ã€‚

æµ‹è¯•æˆåŠŸï¼Œéƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š
redisï¼š
class RedisDB:
    def __init__(self):
        self.host = &quot;ipåœ°å€&quot;
        self.port = 6379
        self.passwd = &quot;å¯†ç &quot;
        self.db = 2
        self.pool = redis.ConnectionPool(host=self.host, port=self.port, password=self.passwd, db=self.db, decode_responses=True)
        self.client = redis.Redis(connection_pool=self.pool)

    def add(self, key, value):
        return self.client.sadd(key, value)

    def exists(self, key, value):
        return self.client.sismember(key, value)

spideréƒ¨åˆ†:
if self.redis.exists(&quot;sina&quot;, items[&quot;news_title&quot;]):
    continue
self.redis.add(&quot;sina&quot;, items[&quot;news_title&quot;])

é‚£é‡Œæœ‰é—®é¢˜ï¼Œè¯·è€å¸ˆæŒ‡æ­£ï¼Œè°¢è°¢ã€‚</div>2023-04-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/3c/9d/cf/96713901.jpg" width="30px"><span>Baird</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å¢é‡çˆ¬å–ï¼š
pipelines.py
æ–°å¢ä¸€ä¸ªæ–¹æ³•è·å–MongoDBé›†åˆä¸­çš„æœ€æ–°æ—¶é—´
def get_last_crawl_time(self):
    latest_entry = self.collection.find_one(
        sort=[(&quot;times&quot;, -1)],  # æŒ‰ times å­—æ®µé™åºæ’åº
        projection={&quot;times&quot;: 1} 
    )
    if latest_entry:
        return latest_entry[&quot;times&quot;]
    return None
sina_spider.py
åˆå§‹åŒ–ä¸€ä¸ªsinaPipelineå®ä¾‹ï¼Œè°ƒç”¨get_last_crawl_timeè·å–ä¸Šæ¬¡çˆ¬å–æ–°é—»çš„æœ€åæ—¶é—´
def __init__(self):
    self.start_urls = [&#39;https:&#47;&#47;news.sina.com.cn&#47;china&#47;&#39;]
    self.option = Options()
    self.option.add_argument(&#39;--no-sandbox&#39;)
    self.option.add_argument(&#39;--blink-settings=imagesEnabled=false&#39;)
    self.pipeline = SinaPipeline()
    self.last_crawl_time = self.pipeline.get_last_crawl_time()
å¾ªç¯ä¸­åˆ¤æ–­æ—¶é—´æ˜¯å¦å°äºä¸Šæ¬¡çˆ¬å–çš„æ–°é—»æ—¥æœŸï¼Œæ˜¯çš„è¯è·³è¿‡è¿™æ¬¡å¾ªç¯
if &#39;åˆ†é’Ÿå‰&#39; in eachtime:
    minute = int(eachtime.split(&#39;åˆ†é’Ÿå‰&#39;)[0])
    t = datetime.datetime.now() - datetime.timedelta(minutes=minute)
    t2 = datetime.datetime(year=t.year, month=t.month, day=t.day, hour=t.hour, minute=t.minute)
else:
    if &#39;å¹´&#39; not in eachtime:
        eachtime = str(today.year) + &#39;å¹´&#39; + eachtime
    t1 = re.split(&#39;[å¹´æœˆæ—¥:]&#39;, eachtime)
    t2 = datetime.datetime(year=int(t1[0]), month=int(t1[1]), day=int(t1[2]), hour=int(t1[3]),
                           minute=int(t1[4]))

if  t2 &lt;= self.last_crawl_time:
    continue</div>2024-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/67/fe/5d17661a.jpg" width="30px"><span>æ‚Ÿå°˜</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>æœ‰å¾®ä¿¡ç¾¤äº†å—ï¼Ÿæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œpymongoè¿ä¸ä¸Šmongoæ•°æ®åº“</div>2023-12-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg" width="30px"><span>peter</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>è¿è¡Œmain.pyåï¼Œé‡åˆ°ä¸¤ä¸ªé—®é¢˜ï¼š
Q1ï¼šROBOTSTXT_OBEY = Trueæ—¶çˆ¬å–å¤±è´¥
åˆ›å»ºmain.pyåï¼Œsettings.pyä¸­ï¼ŒROBOTSTXT_OBEY = Trueã€‚ è¿è¡ŒåæŠ¥å‘Šï¼š
.robotstxt] WARNING: Failure while parsing robots.txt. File either contains garbage or is in an encoding other than UTF-8, treating it as an empty fileã€‚
è¯¥é”™è¯¯å¯¼è‡´å¦å¤–ä¸€ä¸ªé”™è¯¯ï¼š
robotstxt.py&quot;, line 15, in decode_robotstxt
    robotstxt_body = robotstxt_body.decode(&quot;utf-8&quot;)
UnicodeDecodeError: &#39;utf-8&#39; codec can&#39;t decode byte 0xc3 in position 93: invalid continuation byte
ç½‘ä¸Šå»ºè®®ROBOTSTXT_OBEY æ”¹æˆ Falseï¼Œå¥½åƒæ˜¯æˆåŠŸäº†ã€‚
Q2ï¼šæˆåŠŸä¿¡æ¯å’Œè€å¸ˆçš„ä¸åŒï¼Œä¸ç¡®å®šæ˜¯å¦æˆåŠŸã€‚
A ä¸“æ ä¸Šçš„æˆåŠŸä¿¡æ¯å¾ˆå°‘ï¼Œæˆ‘è¿™é‡Œçš„ä¿¡æ¯éå¸¸å¤šï¼Œæ˜¯logè®¾ç½®ä¸åŒå—ï¼Ÿï¼ˆæˆ‘ç”¨PyCharm4.5ï¼‰ã€‚
B ä¸“æ ä¸Šçš„æˆåŠŸä¿¡æ¯ï¼Œæœ‰ä¸¤ä¸ªé“¾æ¥ï¼š
Get https:&#47;&#47;news.sina.com.cn&#47;robots.txt
Get https:&#47;&#47;news.sina.com.cn&#47;china
ä½†æˆ‘çš„è¾“å‡ºä¿¡æ¯ä¸­å¹¶æ²¡æœ‰è¿™ä¸¤ä¸ªé“¾æ¥ï¼Œè¿˜æ²¡æœ‰æˆåŠŸå—ï¼Ÿ
éƒ¨åˆ†ä¿¡æ¯å¦‚ä¸‹ï¼š
2023-05-02 12:56:00 [scrapy.core.engine] INFO: Spider opened</div>2023-05-03</li><br/>
</ul>