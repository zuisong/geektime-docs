ä½ å¥½ï¼Œæˆ‘æ˜¯é»„é¸¿æ³¢ã€‚

åœ¨å‰é¢çš„è¯¾ç¨‹ä¸­è®²äº†å¾ˆå¤šå¬å›ç®—æ³•ï¼Œä¹Ÿè®²äº†å…³äºFlaskå’Œç”¨æˆ·ç•Œé¢ç›¸å…³çš„å†…å®¹ï¼Œä»Šå¤©æˆ‘ä»¬æŠŠæ‰€æœ‰çš„ä¸œè¥¿åšä¸€ä¸ªæµç¨‹ä¸²è”ã€‚

ä»Šå¤©ä¸»è¦ä¼šåšä¸‹é¢äº”ä»¶äº‹ã€‚

1. å°†æ•°æ®é‡‡é›†åˆ°ååŒè¿‡æ»¤ç®—æ³•çš„å¬å›ä¸­è®­ç»ƒååŒè¿‡æ»¤ç®—æ³•ã€‚
2. ä½¿ç”¨ååŒè¿‡æ»¤ç®—æ³•è®­ç»ƒå‡ºåŸºäºItemçš„ååŒè¿‡æ»¤çŸ©é˜µã€‚
3. åˆ©ç”¨åè°ƒè¿‡æ»¤çŸ©é˜µï¼Œå°†ç”¨æˆ·IDä¼ å…¥è¿›å»é¢„æµ‹å‡ºæ¯ä¸€ä¸ªç”¨æˆ·çš„Item listã€‚
4. å°†é¢„æµ‹å‡ºæ¥çš„ç»“æœå­˜å…¥åˆ°Redisæ•°æ®åº“ã€‚
5. é€šè¿‡WebServiceåšæˆæ¥å£ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é’ˆå¯¹ä¸Šé¢çš„å†…å®¹ï¼Œçœ‹çœ‹æ€ä¹ˆä¸€æ­¥æ­¥å®ç°ã€‚

## è®­ç»ƒååŒè¿‡æ»¤ç®—æ³•

è¦æƒ³æŠŠä¹‹å‰çš„é‚£ä¸€å¥—ååŒè¿‡æ»¤ç®—æ³•è·‘èµ·æ¥ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯åšå¥½æ•°æ®ï¼Œå¹¶å–‚ç»™ååŒè¿‡æ»¤ç®—æ³•ã€‚

å…ˆæ¥å›é¡¾ä¸€ä¸‹åœ¨[ååŒè¿‡æ»¤](https://time.geekbang.org/column/article/662725)é‚£ä¸€èŠ‚å†™çš„è®­ç»ƒä»£ç ã€‚

```plain
def cf_Item_train(self):
	"""
Â 
	:return:ç›¸ä¼¼åº¦çŸ©é˜µï¼š{content_id:{content_id:score}}
	"""
	print("start train")
	self.Item_to_Item, self.Item_count = dict(), dict()
Â 
	for user, Items in self.train.Items():
		for i in Items.keys():
			self.Item_count.setdefault(i, 0)
			self.Item_count[i] += 1 Â # Item i å‡ºç°ä¸€æ¬¡å°±åŠ 1åˆ†
Â 
	for user, Items in self.train.Items():
		for i in Items.keys():
			self.Item_to_Item.setdefault(i, {})
			for j in Items.keys():
				if i == j:
					continue
				self.Item_to_Item[i].setdefault(j, 0)
				self.Item_to_Item[i][j] += 1 / (
					math.sqrt(self.Item_count[i] + self.Item_count[j])) # Item i å’Œ j å…±ç°ä¸€æ¬¡å°±åŠ 1
Â 
	# è®¡ç®—ç›¸ä¼¼åº¦çŸ©é˜µ
	for _Item in self.Item_to_Item:
		self.Item_to_Item[_Item] = dict(sorted(self.Item_to_Item[_Item].Items(),
											Â Â Â key=lambda x: x[1], reverse=True)[0:30])
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è®­ç»ƒæ•°æ®é›†å¯ä»¥å–å‡ºUserå’Œæ‰€å¯¹åº”çš„Itemï¼Œç„¶åæœ€åç”Ÿæˆä¸€ä¸ªç›¸ä¼¼åº¦çŸ©é˜µã€‚çŸ©é˜µçš„æ ¼å¼å¦‚ä¸‹ï¼Œè¿™é‡Œé¢å®é™…ä¸Šæ˜¯ç®—å‡ºæ¯ä¸€ä¸ªå†…å®¹ä¸å…¶ä»–å†…å®¹ä¹‹é—´çš„ç›¸ä¼¼åº¦å…³ç³»ã€‚

```plain
{content_id:{content_id:score}}
```

æˆ‘ä»¬ç»§ç»­åˆ†æè¿™æ®µä»£ç ï¼Œè¿™æ®µä»£ç ä¸­éœ€è¦çš„æ•°æ®é›†å°±æ˜¯ä»£ç ä¸­çš„self.trainï¼Œç„¶åå–é‡Œé¢çš„æ¯ä¸€æ¡å†…å®¹ï¼ˆUserå’ŒItemsï¼‰ï¼Œç„¶åå†åšå…±ç°çŸ©é˜µã€‚

çŸ¥é“è¿™äº›å†…å®¹èƒ½å¤Ÿè®©æˆ‘ä»¬æ›´å¥½åœ°å»åˆ¶ä½œæ•°æ®é›†ã€‚åœ¨æ•°æ®é›†ä¸­ï¼Œåº”è¯¥è‡³å°‘åŒ…å«ä¸‹é¢ä¸‰ä¸ªéƒ¨åˆ†ã€‚

1. ç”¨æˆ·IDã€‚
2. å†…å®¹IDã€‚
3. ç”¨æˆ·å¯¹å†…å®¹çš„è¯„åˆ†ã€‚

æˆ‘å…ˆç»™ä½ ä¸€ä¸ªç®€å•çš„æ•°æ®é›†å‚è€ƒæ ¼å¼ã€‚

```plain
1,2,6117caee32002fb435aab0e4
1,2,6117caef32002fb435aab22e
1,2,6117caef32002fb435aab231
1,3,6117caef32002fb435aab242
4,2,6117caef32002fb435aab23d
4,17,6117caef32002fb435aab232
4,15,6117caef32002fb435aab231
4,13,6117caef32002fb435aab22e
4,16,6117caef32002fb435aab23c
3,4,6117caef32002fb435aab231
```

æˆ‘ä»¬è¦åšçš„æ•°æ®é›†å°±æ˜¯ä¸Šé¢çš„è¿™ç§å½¢å¼ã€‚è¿™é‡Œé¢ä¸€å…±åˆ†æˆä¸‰åˆ—ï¼šç¬¬ä¸€åˆ—æ˜¯ç”¨æˆ·çš„IDã€ç¬¬ä¸‰åˆ—æ˜¯å†…å®¹IDï¼Œè€Œç¬¬äºŒåˆ—å°±æ˜¯ç”¨æˆ·å¯¹å†…å®¹çš„è¯„åˆ†ã€‚  
è¿™é‡Œé¢è¿˜æœ‰ä¸€ä¸ªå°å°çš„ç–‘é—®ï¼Œé‚£å°±æ˜¯ä¸­é—´çš„è¯„åˆ†æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ

è¿˜è®°å¾—[åŠ æƒçƒ­åº¦](https://time.geekbang.org/column/article/656948)å—ï¼Ÿæ¯”å¦‚é˜…è¯»åŠ 1åˆ†ã€ç‚¹èµåŠ 2åˆ†ã€æ”¶è—åŠ 2åˆ†ã€è¯„è®ºåŠ 3åˆ†ï¼Œä»Šå¤©æˆ‘ä»¬å°±åœ¨è¿™ä¸ªåŸºç¡€ä¸Šæ¥å†åšä¸€ä¸ªåŠ æƒï¼Œå½¢æˆæ•°æ®é›†çš„åˆ†æ•°ã€‚

æˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸‹é¢è¿™ä¹ˆä¸€ä¸ªè§„åˆ™ã€‚

- é˜…è¯»åŠ 1åˆ†ã€‚
- ç‚¹èµåŠ 2åˆ†ã€‚
- æ”¶è—åŠ 3åˆ†ã€‚
- å¦‚æœåŒæ—¶å­˜åœ¨2é¡¹å¤šåŠ 1åˆ†ã€‚
- å¦‚æœåŒæ—¶å­˜åœ¨3é¡¹å¤šåŠ 2åˆ†ã€‚

æ¥ä¸‹æ¥ä»MongoDBæ•°æ®åº“ä¸­è¯»å–éœ€è¦çš„æ•°æ®ï¼Œå†é€šè¿‡è§„åˆ™æ¥è¿›è¡ŒåŠ æƒã€‚æœ€åå†æŠŠå¾—åˆ†å­˜å…¥åˆ°ä¸€ä¸ªCSVè¡¨ä¸­ï¼Œä¾›è®­ç»ƒä½¿ç”¨ã€‚

æˆ‘ä»¬åœ¨recommendation-classé¡¹ç›®é‡Œæ–°å»ºä¸€ä¸ªå«read\_dataçš„ç›®å½•ï¼Œä»¥åè¯»å–æ•°æ®éƒ½ç”¨è¿™ä¸ªç›®å½•ï¼Œç„¶åå†åœ¨é‡Œé¢æ–°å»ºä¸€ä¸ªå«read\_news\_data.pyçš„æ–‡ä»¶ï¼Œæ–°å»ºä¹‹åç›®å½•æ ¼å¼å¦‚ä¸‹ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/85/05/857235f5ac30d7d31c2e76fc5e64ec05.png?wh=369x801)

å…ˆæ¥çœ‹ä»£ç ã€‚

```plain
from dao.mongo_db import MongoDB
import os
Â 
Â 
class NewsData(object):
Â Â Â Â def __init__(self):
Â Â Â Â Â Â Â Â self.mongo = MongoDB(db='recommendation')
Â Â Â Â Â Â Â Â self.db_client = self.mongo.db_client
Â Â Â Â Â Â Â Â self.read_collection = self.db_client['read']
Â Â Â Â Â Â Â Â self.likes_collection = self.db_client['likes']
Â Â Â Â Â Â Â Â self.collection = self.db_client['collection']
Â Â Â Â Â Â Â Â self.content = self.db_client['content_labels']
Â 
Â Â Â Â """
Â Â Â Â é˜…è¯» 1
Â Â Â Â ç‚¹èµ 2
Â Â Â Â æ”¶è— 3
Â Â Â Â 
Â Â Â Â å¦‚æœåŒæ—¶å­˜åœ¨2é¡¹ åŠ  1åˆ†
Â Â Â Â å¦‚æœåŒæ—¶å­˜åœ¨3é¡¹ åŠ  2åˆ†
Â Â Â Â """
Â Â Â Â def cal_score(self):
Â Â Â Â Â Â Â Â result = list()
Â Â Â Â Â Â Â Â score_dict = dict()
Â Â Â Â Â Â Â Â data = self.likes_collection.find()
Â Â Â Â Â Â Â Â for info in data:
Â Â Â Â Â Â Â Â Â Â Â Â #è¿™é‡Œé¢åšåˆ†æ•°çš„è®¡ç®—
Â Â Â Â Â Â Â Â Â Â Â Â score_dict.setdefault(info['user_id'], {})
Â Â Â Â Â Â Â Â Â Â Â Â score_dict[info['user_id']].setdefault(info['content_id'], 0)
Â 
Â Â Â Â Â Â Â Â Â Â Â Â query = {"user_id": info['user_id'], "content_id": info['content_id']}
Â 
Â Â Â Â Â Â Â Â Â Â Â Â exist_count = 0
Â Â Â Â Â Â Â Â Â Â Â Â # å»æ¯ä¸€ä¸ªè¡¨é‡Œé¢è¿›è¡ŒæŸ¥è¯¢ï¼Œå¦‚æœå­˜åœ¨æ•°æ®ï¼Œå°±åŠ ä¸Šç›¸åº”çš„å¾—åˆ†
Â Â Â Â Â Â Â Â Â Â Â Â read_count = self.read_collection.find(query).count()
Â Â Â Â Â Â Â Â Â Â Â Â if read_count > 0:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â score_dict[info['user_id']][info['content_id']] += 1
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â exist_count += 1
Â 
Â Â Â Â Â Â Â Â Â Â Â Â like_count = self.likes_collection.find(query).count()
Â Â Â Â Â Â Â Â Â Â Â Â if like_count > 0:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â score_dict[info['user_id']][info['content_id']] += 2
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â exist_count += 1
Â 
Â Â Â Â Â Â Â Â Â Â Â Â collection_count = self.collection.find(query).count()
Â Â Â Â Â Â Â Â Â Â Â Â if collection_count > 0:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â score_dict[info['user_id']][info['content_id']] += 2
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â exist_count += 1
Â 
Â Â Â Â Â Â Â Â Â Â Â Â if exist_count == 2:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â score_dict[info['user_id']][info['content_id']] += 1
Â Â Â Â Â Â Â Â Â Â Â Â elif exist_count == 3:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â score_dict[info['user_id']][info['content_id']] += 2
Â Â Â Â Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â pass
Â 
Â Â Â Â Â Â Â Â Â Â Â Â result.append(str(info['user_id']) + ',' + str(score_dict[info['user_id']][info['content_id']]) + ',' + str(info['content_id']))
Â 
Â Â Â Â Â Â Â Â self.to_csv(result, '../data/news_score/news_log.csv')
Â 
Â Â Â Â def rec_user(self):
Â Â Â Â Â Â Â Â data = self.read_collection.distinct('user_id')
Â Â Â Â Â Â Â Â return data
Â 
Â Â Â Â def to_csv(self, user_score_content, res_file):
Â Â Â Â Â Â Â Â if not os.path.exists('../data/news_score'):
Â Â Â Â Â Â Â Â Â Â Â Â os.mkdir('../data/news_score')
Â Â Â Â Â Â Â Â with open(res_file, mode='w', encoding='utf-8') as wf:
Â Â Â Â Â Â Â Â Â Â Â Â # info = "1,8,6145ec828451a2b8577df7b3"
Â Â Â Â Â Â Â Â Â Â Â Â for info in user_score_content:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â wf.write(info + '\n')
```

è§£é‡Šä¸‹è¿™æ®µä»£ç ï¼Œåœ¨é¡¹ç›®çš„æœ€å¼€å§‹ï¼Œæˆ‘ä»¬åˆå§‹åŒ–äº†MongoDBæ•°æ®åº“ï¼Œå¹¶å°†æ•°æ®åº“çš„å„ä¸ªé›†åˆå­˜å‚¨åˆ°äº†ç›¸åº”çš„å˜é‡ä¸­ã€‚

æ¥ç€æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªcal\_score()å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä¸»è¦ä½œç”¨å°±æ˜¯è®¡ç®—æ¯ä¸ªç”¨æˆ·å¯¹äºæ¯ç¯‡æ–°é—»çš„å¾—åˆ†ï¼Œè¯¥å‡½æ•°éå†ç‚¹èµæ•°æ®é›†ï¼ˆlikes\_collectionï¼‰ï¼Œå¯¹æ¯ä¸ªç”¨æˆ·å’Œæ–°é—»è®¡ç®—å…¶å¾—åˆ†ã€‚è®¡ç®—è¯¥ç”¨æˆ·ç‚¹èµè¯¥æ–°é—»çš„æ¬¡æ•°ï¼ˆlike\_countï¼‰ã€é˜…è¯»è¯¥æ–°é—»çš„æ¬¡æ•°ï¼ˆread\_countï¼‰å’Œæ”¶è—è¯¥æ–°é—»çš„æ¬¡æ•°ï¼ˆcollection\_countï¼‰ï¼Œå¯¹äºæ¯ä¸ªå­˜åœ¨çš„æ“ä½œï¼Œå¯ä»¥ç»™ç›¸åº”çš„æ–°é—»åŠ åˆ†ï¼ˆç‚¹èµ+2ï¼Œé˜…è¯»+1ï¼Œæ”¶è—+2ï¼‰ã€‚å¦‚æœåŒæ—¶å­˜åœ¨2é¡¹æ“ä½œï¼Œåˆ™é¢å¤–åŠ 1åˆ†ï¼Œå¦‚æœåŒæ—¶å­˜åœ¨3é¡¹æ“ä½œï¼Œåˆ™é¢å¤–åŠ 2åˆ†ã€‚ç„¶åå°†æ¯ä¸ªç”¨æˆ·çš„å¾—åˆ†å’Œå¯¹åº”çš„æ–°é—»IDå†™å…¥CSVæ–‡ä»¶ä¸­ã€‚

æœ€åæˆ‘ä»¬è¿˜å®ç°äº†ä¸¤ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªæ˜¯rec\_user()å‡½æ•°ï¼Œç”¨æ¥è®¡ç®—ç”¨æˆ·ï¼›å¦ä¸€ä¸ªæ˜¯to\_csvå‡½æ•°ï¼Œç”¨æ¥å°†è®¡ç®—å¥½çš„çŸ©é˜µä¸CSVæ ¼å¼å­˜å‚¨ã€‚

## è®­ç»ƒå‡ºåŸºäºItemçš„ååŒè¿‡æ»¤çŸ©é˜µ

æœ‰äº†æ•°æ®ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨ååŒè¿‡æ»¤ç®—æ³•æ¥è¿›è¡Œè®¡ç®—äº†ã€‚

æˆ‘ä»¬åœ¨è®²[ååŒè¿‡æ»¤](https://time.geekbang.org/column/article/662725)æ—¶è®²äº†æ€ä¹ˆè®­ç»ƒå’Œæ¨ç†ï¼Œç°åœ¨è¡¥å…¨è¯»å–æ•°æ®è¿™ä¸€éƒ¨åˆ†ã€‚

æˆ‘ä»¬è¿›åˆ°recommendation-classè¿™ä¸ªé¡¹ç›®ï¼Œæ¥åˆ°modelsç›®å½•ä¸‹çš„recallç›®å½•ï¼Œåœ¨è¿™é‡Œæ‰¾åˆ°ä¹‹å‰å†™çš„Item\_base\_cf.pyæ–‡ä»¶ã€‚

é¦–å…ˆï¼Œè¿™ä¸ªæ–‡ä»¶åº”è¯¥æ˜¯åœ¨ä¸€ä¸ªå¤§ç±»é‡Œï¼Œæ‰€ä»¥è¦å»ºç«‹ä¸€ä¸ªç±»ä¸ºItemBaseCFï¼Œå¹¶åœ¨é‡Œé¢å»å†™initå‡½æ•°ï¼Œä»£ç å¦‚ä¸‹ã€‚

```plain
class ItemBaseCF(object):
Â Â Â Â def __init__(self, train_file):
Â Â Â Â Â Â Â Â """
Â Â Â Â Â Â Â Â è¯»å–æ–‡ä»¶
Â Â Â Â Â Â Â Â ç”¨æˆ·å’ŒItemå†å²
Â Â Â Â Â Â Â Â Itemç›¸ä¼¼åº¦è®¡ç®—
Â Â Â Â Â Â Â Â è®­ç»ƒ
Â Â Â Â Â Â Â Â """
Â Â Â Â Â Â Â Â self.train = dict()
Â Â Â Â Â Â Â Â self.user_Item_history = dict()
Â Â Â Â Â Â Â Â self.Item_to_Item = dict()
Â Â Â Â Â Â Â Â self.read_data(train_file)
```

è¿™æ®µä»£ç çš„initå‡½æ•°ä¸‹é¢æœ‰å‡ ä¸ªå˜é‡ï¼Œæˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ä¸€ä¸‹ã€‚

é¦–å…ˆåœ¨initå‡½æ•°ä¸­ä¼ å…¥ä¸€ä¸ªtrain\_fileæ–‡ä»¶ï¼ˆä¹Ÿå°±æ˜¯è®­ç»ƒæ–‡ä»¶ï¼‰ï¼Œè¿™ä¸ªè®­ç»ƒæ–‡ä»¶å°±æ˜¯åœ¨å‰é¢ä¿å­˜åˆ°CSVä¸­çš„æ–‡ä»¶ã€‚

ç„¶åæˆ‘ä»¬å®šä¹‰äº†ä»¥ä¸‹ä¸‰ä¸ªå˜é‡ã€‚

- self.trainæ˜¯ä¸€ä¸ªå­—å…¸ï¼Œä¸»è¦ç”¨æ¥ä¿å­˜è®­ç»ƒæ•°æ®ã€‚è¯»å–å‡ºæ¥çš„æ•°æ®æœ€ç»ˆè¦ä¿å­˜æˆä¸€ä¸ªå­—å…¸ï¼Œç„¶åä»å­—å…¸ä¸­è·å–ç›¸åº”çš„æ•°æ®å†è¿›è¡Œè®­ç»ƒã€‚
- self.user\_Item\_historyå˜é‡æ˜¯ç”¨æ¥ä¿å­˜ç”¨æˆ·è¯»å–å†…å®¹çš„ä¸€ä¸ªå­—å…¸ï¼Œè¿™ä¸ªå­—å…¸çš„æ ¼å¼æ˜¯self.user\_Item\_history\[â€œuser\_idâ€] ä¸­ç”¨æˆ·æ‰€é˜…è¯»è¿‡çš„æ‰€æœ‰å†…å®¹åˆ—è¡¨ã€‚
- self.Item\_to\_Itemå˜é‡å®é™…ä¸Šæ˜¯ä¸€ä¸ªå†…å®¹çš„ç›¸ä¼¼åº¦çŸ©é˜µï¼Œè¿™ä¸ªçŸ©é˜µæ˜¯æ•´ä¸ªååŒè¿‡æ»¤çš„æ ¸å¿ƒæ‰€åœ¨ã€‚åœ¨self.Item\_to\_Itemä¸­ä¼šå­˜æ”¾æ¯ä¸€ä¸ªå†…å®¹ä¸å…¶ä»–å†…å®¹çš„ç›¸ä¼¼åº¦ï¼Œè¿™ä¸ªç›¸ä¼¼åº¦ä¸€èˆ¬æ˜¯å¯¹ç§°çš„ã€‚

å…ˆæ¥çœ‹ä¸‹é¢è¿™å¼ å›¾ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/d7/09/d741abafcdce31b88f222902b5967b09.png?wh=1161x935)

è¿™å¼ å›¾æ˜¯ä¸€å¼ å…¸å‹çš„åŸºäºItemçš„[ååŒè¿‡æ»¤å›¾](https://www.cnblogs.com/chaojunwang-ml/p/11567088.html)ï¼Œå·¦ä¾§æ˜¯ç”¨æˆ·ï¼Œå³ä¾§æ˜¯ç‰©å“ï¼ˆç‰©å“å¯ä»¥ç†è§£ä¸ºæ¨èç³»ç»Ÿä¸­çš„å†…å®¹ï¼‰ã€‚

ç”¨æˆ·Aä¹°äº†ç‰©å“Aå’ŒCï¼Œç”¨æˆ·Bä¹°äº†ç‰©å“Aå’ŒBï¼Œæˆ‘ä»¬å‡è®¾ç‰©å“Aå’Œç‰©å“Cçš„ç›¸ä¼¼åº¦å¾ˆé«˜ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œå°±ä¼šæŠŠç‰©å“Cæ¨èç»™ç”¨æˆ·Bã€‚è¿™ä¸ªæ¨èå®é™…ä¸Šå°±æ˜¯åˆ©ç”¨äº†åŸºäºItemçš„ååŒè¿‡æ»¤ï¼Œå†æŠŠè¿™å››ä¸ªç‰©å“è½¬æ¢æˆä¸€ä¸ªè¡¨æ ¼æ¥è¡¨ç¤ºç›¸ä¼¼åº¦ï¼Œå°±ä¼šçœ‹åˆ°ä¸‹é¢è¿™æ ·ä¸€ä¸ªè¡¨æ ¼ã€‚

![](https://static001.geekbang.org/resource/image/47/44/4757a4fdea1692442d9390eb8cf96e44.jpg?wh=3000x1274)

è¿™ä¸ªè¡¨åªæ˜¯ä¸€ä¸ªä¾‹å­ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸¤ä¸ªç›¸åŒçš„ç‰©å“ç›¸ä¼¼åº¦ä¸€å®šä¸º1ï¼Œé‚£ä¹ˆå¯ä»¥çœ‹åˆ°Aå¯¹Bå’ŒBå¯¹Açš„ç›¸ä¼¼åº¦ä¸€å®šæ˜¯ä¸€æ ·çš„ï¼ŒåŒç†Aå¯¹Cå’ŒCå¯¹Açš„ç›¸ä¼¼åº¦ä¹Ÿä¸€å®šæ˜¯ä¸€æ ·çš„ï¼Œä»¥æ­¤ç±»æ¨å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªè¡¨æœ‰ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„ç‰¹æ€§ï¼Œå°±æ˜¯å¯¹ç§°æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨å®é™…çš„ååŒè¿‡æ»¤ç®—æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šåªè®¡ç®—å…¶ä¸­çš„ä¸€åŠæ•°æ®ï¼Œè¿™æ ·å¯ä»¥å‡å°‘è®¡ç®—é‡ã€‚åœ¨å­˜å‚¨åˆ°å­—å…¸ä¸­æ—¶ï¼Œå°±ä¼šå‡å°‘ä¸€åŠæ•°æ®çš„å¤§å°ï¼Œä½¿å¾—æ¨ç†é€Ÿåº¦åŠ å¿«ã€‚

æœ€åä¸€ä¸ªå˜é‡å®é™…ä¸Šæ˜¯ä¸€ä¸ªè¯»å–æ•°æ®çš„å‡½æ•°ï¼Œæ¥çœ‹ä¸‹è¿™éƒ¨åˆ†ä»£ç åº”è¯¥æ€ä¹ˆæ¥å†™ã€‚

```plain
def read_data(self, train_file):
	"""
	è¯»æ–‡ä»¶ï¼Œå¹¶ç”Ÿæˆæ•°æ®é›†ï¼ˆç”¨æˆ·ã€åˆ†æ•°ã€æ–°é—»ï¼Œuser,score,Itemï¼‰
	:param train_file: è®­ç»ƒæ–‡ä»¶
	:return: {"user_id":{"content_id":predict_score}}
	"""
	with open(train_file, mode='r', encoding='utf-8') as rf:
		for line in tqdm(rf.readlines()):
			user, score, Item = line.strip().split(",")
			self.train.setdefault(user, {})
			self.user_Item_history.setdefault(user, [])
			self.train[user][Item] = int(score)
			self.user_Item_history[user].append(Item)
```

è¿™æ®µä»£ç å°†å‰é¢ç”Ÿæˆçš„CSVæ•°æ®é›†ä¼ å…¥è¿›æ¥ï¼Œç„¶åä½¿ç”¨with openæ–¹æ³•æ‰“å¼€ã€‚æ‰“å¼€ä¹‹åï¼Œé€è¡Œè¯»å–æ–‡ä»¶ä¸­çš„æ¯ä¸€è¡Œæ•°æ®ï¼Œå¹¶ä½¿ç”¨splitè¿›è¡Œåˆ†éš”ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠç”¨æˆ·IDã€åˆ†æ•°ã€æ–‡ç« IDåˆ†å¼€å¹¶åˆ†åˆ«èµ‹å€¼ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨setdefaultæ–¹æ³•å°†ç”¨æˆ·IDã€è¯„åˆ†å’Œæ–°é—»IDæ·»åŠ åˆ°å­—å…¸self.trainä¸­ã€‚å¦‚æœç”¨æˆ·IDä¸å­˜åœ¨ï¼Œæ–°å»ºä¸€ä¸ªç©ºå­—å…¸ï¼›å¦‚æœç”¨æˆ·å·²å­˜åœ¨ï¼Œåˆ™ç›´æ¥æ·»åŠ ã€‚ç”¨æˆ·è¯»å–å†…å®¹çš„å†å²æ“ä½œä¹Ÿæ˜¯åŒç†ã€‚

æ¥ç€ï¼Œå°†è¯„åˆ†è½¬æ¢ä¸ºæ•´æ•°ç±»å‹ï¼Œå¹¶å°†ç”¨æˆ·IDå’Œæ–°é—»IDæ·»åŠ åˆ°self.trainå­—å…¸ä¸­ã€‚ç„¶åæŠŠæ–°é—»IDæ·»åŠ åˆ°self.user\_Item\_historyå­—å…¸ä¸­ï¼Œè¡¨ç¤ºè¯¥ç”¨æˆ·å·²ç»æµè§ˆè¿‡è¯¥æ–°é—»ã€‚

æœ€ç»ˆï¼Œè¿™æ®µä»£ç è¿”å›ä¸€ä¸ªå­—å…¸ï¼Œå…¶ä¸­é”®ä¸ºç”¨æˆ·IDï¼Œå€¼ä¸ºå­—å…¸ï¼Œè¡¨ç¤ºè¯¥ç”¨æˆ·æµè§ˆè¿‡çš„æ–°é—»åŠè¯„åˆ†ã€‚å¦å¤–ï¼Œè¿™æ®µä»£ç è¿˜æŠŠæ¯ä¸ªç”¨æˆ·æµè§ˆè¿‡çš„æ–°é—»IDæ·»åŠ åˆ°self.user\_Item\_historyå­—å…¸ä¸­ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨ã€‚

## æ­å»ºæ•´ä¸ªè¿è¡Œæµç¨‹

å‰é¢çš„æ­¥éª¤ç›¸å½“äºå·²ç»æŠŠç›¸å…³çš„æ•°æ®è·‘é€šäº†ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯æ­å»ºæ•´ä¸ªæµç¨‹ï¼ŒæŠŠå®ƒä»¬ä¸²èµ·æ¥ã€‚

æˆ‘ä»¬åœ¨schedulerç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªsched\_rec\_news.pyæ–‡ä»¶ï¼Œä¸»è¦ç”¨æ¥è·‘é€šæ•´ä¸ªååŒè¿‡æ»¤ä»æ•°æ®è¿›å…¥åˆ°å°†ç»“æœå­˜å…¥åˆ°æ•°æ®åº“çš„æµç¨‹ï¼Œéœ€è¦åšä¸‹é¢è¿™å››ä¸ªæ­¥éª¤ã€‚

1. çŸ¥é“è¦æ¨èç»™è°ï¼Œä¹Ÿå°±æ˜¯è¦å…ˆè®¡ç®—ä¸€ä¸‹æ¨èç”¨æˆ·çš„åˆ—è¡¨ï¼Œåˆ†æˆå†·å¯åŠ¨å’Œæœ‰æ¨èè®°å½•ä¸¤ç§ï¼Œåªéœ€è¦è®¡ç®—æœ‰é˜…è¯»è®°å½•çš„äººã€‚
2. é€šè¿‡è®­ç»ƒï¼Œå¾—åˆ°ååŒè¿‡æ»¤çŸ©é˜µã€‚
3. åšæ¨èã€‚
4. æŠŠæ¨èçš„ç»“æœå†™åˆ°æ•°æ®åº“é‡Œé¢ï¼Œä»¥å¤‡åé¢åº”ç”¨ã€‚

æˆ‘ä»¬ç›´æ¥æ¥çœ‹ä»£ç ã€‚

```plain
from read_data import read_news_data
from models.recall.Item_base_cf import ItemBaseCF
import pickle
from dao import redis_db
Â 
Â 
class SchedRecNews(object):
Â Â Â Â def __init__(self):
Â Â Â Â Â Â Â Â self.news_data = read_news_data.NewsData()
Â Â Â Â Â Â Â Â self.Redis = redis_db.Redis()
Â 
Â Â Â Â def schedule_job(self):
Â Â Â Â Â Â Â Â """
Â Â Â Â Â Â Â Â 1ã€é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“è¦æ¨èç»™è°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¦å…ˆè®¡ç®—ä¸€ä¸‹æ¨èç”¨æˆ·çš„åˆ—è¡¨ï¼Œåˆ†æˆå†·å¯åŠ¨ã€æœ‰æ¨èè®°å½•çš„ä¸¤ç§ï¼Œæˆ‘ä»¬åªéœ€è¦ç»™æœ‰é˜…è¯»è®°å½•çš„äººè®¡ç®—
Â Â Â Â Â Â Â Â 2ã€æˆ‘ä»¬é€šè¿‡è®­ç»ƒï¼Œå¾—åˆ°ååŒè¿‡æ»¤çŸ©é˜µ
Â Â Â Â Â Â Â Â 3ã€åšæ¨è
Â Â Â Â Â Â Â Â 4ã€æŠŠæ¨èçš„ç»“æœå†™åˆ°æ•°æ®åº“é‡Œé¢ï¼Œä»¥å¤‡åé¢åº”ç”¨
Â Â Â Â Â Â Â Â :return:
Â Â Â Â Â Â Â Â """
Â Â Â Â Â Â Â Â user_list = self.news_data.rec_user()
Â Â Â Â Â Â Â Â # self.news_data.cal_score()
Â Â Â Â Â Â Â Â self.news_model_train = ItemBaseCF("../data/news_score/news_log.csv")
Â Â Â Â Â Â Â Â self.news_model_train.cf_Item_train()
Â Â Â Â Â Â Â Â # æ¨¡å‹å›ºåŒ–
Â Â Â Â Â Â Â Â with open("../data/recall_model/CF_model/cf_news_recommend.m", mode='wb') as article_f:
Â Â Â Â Â Â Â Â Â Â Â Â pickle.dump(self.news_model_train, article_f)
Â Â Â Â Â Â Â Â for user_id in user_list:
Â Â Â Â Â Â Â Â Â Â Â Â self.rec_list(user_id)
Â 
Â Â Â Â def rec_list(self, user_id):
Â Â Â Â Â Â Â Â recall_result = self.news_model_train.cal_rec_Item(str(user_id))
Â Â Â Â Â Â Â Â recall = []
Â Â Â Â Â Â Â Â scores = []
Â Â Â Â Â Â Â Â for Item, score in recall_result.Items():
Â Â Â Â Â Â Â Â Â Â Â Â recall.append(Item)
Â Â Â Â Â Â Â Â Â Â Â Â scores.append(score)
Â Â Â Â Â Â Â Â data = dict(zip(recall_result, scores))
Â Â Â Â Â Â Â Â self.to_redis(user_id, data)
Â Â Â Â Â Â Â Â print("Item_cf to redis finish...")
Â 
Â Â Â Â def to_redis(self, user_id, rec_conent_score):
Â Â Â Â Â Â Â Â rec_Item_id = "rec_Item:" + str(user_id)
Â Â Â Â Â Â Â Â res = dict()
Â Â Â Â Â Â Â Â for content, score in rec_conent_score.Items():
Â Â Â Â Â Â Â Â Â Â Â Â res[content] = score
Â 
Â Â Â Â Â Â Â Â if len(res) > 0:
Â Â Â Â Â Â Â Â Â Â Â Â data = dict({rec_Item_id: res})
Â Â Â Â Â Â Â Â Â Â Â Â for Item, value in data.Items():
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â self.Redis.redis.zadd(Item, value)
Â 
Â 
if __name__ == '__main__':
Â Â Â Â sched = SchedRecNews()
	sched.schedule_job()
	Â 
```

è§£é‡Šä¸‹è¿™æ®µä»£ç ã€‚

1. åˆ›å»ºä¸€ä¸ªSchedRecNewsç±»å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«æ–°é—»æ•°æ®ç±»å¯¹è±¡å’ŒRedisæ•°æ®åº“ç±»å¯¹è±¡ã€‚
2. è°ƒç”¨NewsDataç±»ä¸­çš„rec\_userå‡½æ•°ï¼Œè·å–éœ€è¦è¿›è¡Œæ¨èçš„ç”¨æˆ·åˆ—è¡¨ã€‚
3. åˆ›å»ºä¸€ä¸ªItemBaseCFç±»å¯¹è±¡å¹¶ä¼ å…¥æ–°é—»è¯„åˆ†æ•°æ®çš„æ–‡ä»¶è·¯å¾„ï¼Œç„¶åè°ƒç”¨ItemBaseCFç±»ä¸­çš„cf\_Item\_trainå‡½æ•°ï¼Œè®­ç»ƒåŸºäºç‰©å“çš„ååŒè¿‡æ»¤æ¨¡å‹ã€‚
4. å°†è®­ç»ƒå¥½çš„æ¨¡å‹å›ºåŒ–ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ä¸­ã€‚
5. å¯¹äºæ¯ä¸ªç”¨æˆ·è°ƒç”¨rec\_listå‡½æ•°è¿›è¡Œæ¨èã€‚
6. åœ¨rec\_listå‡½æ•°ä¸­ï¼Œè°ƒç”¨ItemBaseCFç±»ä¸­çš„cal\_rec\_Itemå‡½æ•°è·å–æ¯ä¸ªç”¨æˆ·çš„æ¨èåˆ—è¡¨ï¼ˆåŒ…æ‹¬æ¨èå†…å®¹å’Œæ¨èå¾—åˆ†ï¼‰ï¼Œç„¶åå°†æ¨èåˆ—è¡¨å’Œç›¸åº”çš„æ¨èå¾—åˆ†ä¿å­˜åˆ°Redisæ•°æ®åº“ä¸­ã€‚
7. å®Œæˆä»»åŠ¡ï¼Œç¨‹åºç»“æŸã€‚

## åšæˆWebServiceæœåŠ¡

æ¥ä¸‹æ¥å°±æ˜¯æŠŠååŒè¿‡æ»¤ç®—æ³•çš„è¾“å‡ºå’Œæ¨èæ¥å£è¿›è¡Œå¯¹æ¥ï¼Œä»è€Œå®Œæˆæ•´ä¸ªæµç¨‹ã€‚

åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬è¦ç”¨çš„æ˜¯recommendation-serviceè¿™ä¸ªé¡¹ç›®ï¼Œè¦åšçš„æœ‰ä»¥ä¸‹ä¸¤ä»¶äº‹ã€‚

1. åœ¨Redisæ•°æ®åº“ä¸­è¿›è¡ŒæŸ¥è¯¢ï¼Œç„¶åæŠŠæ•°æ®è¿”å›ç»™å‰ç«¯è¿›è¡Œå±•ç¤ºã€‚
2. å¦‚æœæŸ¥è¯¢ç»“æœæ˜¯ç©ºï¼Œè¿˜æ˜¯èµ°ä¹‹å‰çš„æ¥å£ï¼Œå¯ä»¥å°†å®ƒç†è§£æˆä¸ºä¸€ä¸ªå†·å¯åŠ¨ã€‚

é¦–å…ˆå›å¿†ä¸€ä¸‹ä¹‹å‰çš„æ¨èæ¥å£ä»£ç ã€‚

```plain
@app.route("/recommendation/get_rec_list", methods=['POST'])
def get_rec_list():
Â Â Â Â if request.method == 'POST':
Â Â Â Â Â Â Â Â req_json = request.get_data()
Â Â Â Â Â Â Â Â rec_obj = json.loads(req_json)
Â Â Â Â Â Â Â Â page_num = rec_obj['page_num']
Â Â Â Â Â Â Â Â page_size = rec_obj['page_size']
Â 
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â data = page_query.get_data_with_page(page_num, page_size)
Â Â Â Â Â Â Â Â Â Â Â Â print(data)
Â Â Â Â Â Â Â Â Â Â Â Â return jsonify({"code": 0, "msg": "è¯·æ±‚æˆåŠŸ", "data": data})
Â Â Â Â Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â Â Â Â Â print(str(e))
Â Â Â Â Â Â Â Â Â Â Â Â return jsonify({"code": 2000, "msg": "error"})
```

è¿™æ®µä»£ç å®é™…ä¸Šæ˜¯è¯·æ±‚ä¸€ä¸ªå†·å¯åŠ¨çš„ç¿»é¡µä»£ç ã€‚ä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·è¿›æ¥ä¹‹åä¸ç®¡æ˜¯è°ï¼Œéƒ½ä¼šæŒ‰ç…§æ—¶é—´å€’åºè¿›è¡Œæ¨èã€‚ä½†ç°åœ¨æœ‰äº†ååŒè¿‡æ»¤ï¼Œæˆ‘ä»¬åº”è¯¥å°†ååŒè¿‡æ»¤çš„ç»“æœå¼•å…¥è¿›æ¥ï¼Œéœ€è¦åšä¸‹é¢è¿™ä¹ˆä¸¤ä¸ªæ›´æ”¹ã€‚

1. æ¥æ”¶çš„å‚æ•°å¢åŠ user\_idè¿™ä¸ªå­—æ®µã€‚
2. æ‹¿åˆ°user\_idå»Redisæ•°æ®åº“ä¸­è¿›è¡ŒæŸ¥è¯¢ï¼Œå¦‚æœæŸ¥åˆ°äº†å°±æŠŠé‡Œé¢çš„æ¨èåˆ—è¡¨ç»™åˆ°å‰ç«¯ï¼›å¦‚æœæŸ¥ä¸åˆ°ï¼Œç»§ç»­èµ°å†·å¯åŠ¨ï¼ˆä¹Ÿå°±æ˜¯æŒ‰ç…§æ—¶é—´æ’åºè¿›è¡Œæ¨èï¼‰ã€‚

å…ˆæŠŠä»Redisä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨å¯æ¨èæ•°æ®çš„æ–¹æ³•å†™å‡ºæ¥ã€‚æˆ‘ä»¬åœ¨utilsä¸‹é¢å»ºç«‹ä¸€ä¸ªå«redis\_query.pyçš„æ–‡ä»¶ï¼Œç„¶ååœ¨é‡Œé¢å†™å…¥ä¸‹é¢çš„å†…å®¹ã€‚

```plain
from dao import redis_db
Â 
Â 
class RedisQuery:
Â Â Â Â def __init__(self):
Â Â Â Â Â Â Â Â self.redis_client = redis_db.Redis()
Â 
Â Â Â Â def check_key_exist(self, key):
Â Â Â Â Â Â Â Â return self.redis_client.redis.exists(key)
è¿™æ®µä»£ç å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠrediså¯¼å…¥è¿›å»ä¹‹åï¼Œä½¿ç”¨redis.exists()å‘½ä»¤æŸ¥çœ‹keyæ˜¯ä¸æ˜¯å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±è¿”å›trueã€‚
ç´§æ¥ç€ï¼Œæˆ‘ä»¬åœ¨è¿™æ®µä»£ç ä¸­å¢åŠ ä¸€ä¸ªå‡½æ•°ï¼š
Â Â Â Â def get_data_with_redis(self, user_id, page_num, page_size):
Â Â Â Â Â Â Â Â redis_key = "rec_Item:" + str(user_id)
Â Â Â Â Â Â Â Â if self.check_key_exist(redis_key):
Â Â Â Â Â Â Â Â Â Â Â Â start_index = (page_num - 1) * page_size
Â Â Â Â Â Â Â Â Â Â Â Â end_index = start_index + page_size - 1
Â Â Â Â Â Â Â Â Â Â Â Â result = self.redis_client.redis.zrange(redis_key, start_index, end_index)
Â 
Â Â Â Â Â Â Â Â Â Â Â Â lst = list()
Â Â Â Â Â Â Â Â Â Â Â Â for x in result:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â info = self._redis.redis.get("news_detail:" + x)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â lst.append(info)
Â Â Â Â Â Â Â Â Â Â Â Â return lst
```

è¿™ä¸ªå‡½æ•°å°±æ˜¯ä»Redisä¸­å–æ•°æ®ï¼Œç„¶åè·å¾—å†…å®¹çš„IDåˆ—è¡¨ï¼Œå†ä»Redisçš„ â€œnews\_detail:â€ ä¸­è·å–ç›¸åº”çš„æ•°æ®ï¼Œè¿”å›ç»™å‰ç«¯ã€‚

æœ€åæŠŠæ¨èæ¥å£çš„ä»£ç å†åˆå…¥è¿›æ¥ï¼Œå˜æˆå¦‚ä¸‹ä»£ç å³å¯ã€‚

```plain
@app.route("/recommendation/get_rec_list", methods=['POST'])
def get_rec_list():
Â Â Â Â if request.method == 'POST':
Â Â Â Â Â Â Â Â req_json = request.get_data()
Â Â Â Â Â Â Â Â rec_obj = json.loads(req_json)
Â Â Â Â Â Â Â Â user_id = rec_obj['user_id']
Â Â Â Â Â Â Â Â page_num = rec_obj['page_num']
Â Â Â Â Â Â Â Â page_size = rec_obj['page_size']
Â 
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â redis_key = "rec_Item:" + str(user_id)
Â Â Â Â Â Â Â Â Â Â Â Â if redis_query.check_key_exist(redis_key):
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â data = redis_query.get_data_with_redis(user_id, page_num, page_size)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â print(data)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return jsonify({"code": 0, "msg": "è¯·æ±‚æˆåŠŸ", "data": data})
Â Â Â Â Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â data = page_query.get_data_with_page(page_num, page_size)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â print(data)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return jsonify({"code": 0, "msg": "è¯·æ±‚æˆåŠŸ", "data": data})
Â Â Â Â Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â Â Â Â Â print(str(e))
Â Â Â Â Â Â Â Â Â Â Â Â return jsonify({"code": 2000, "msg": "error"})
```

## æ€»ç»“

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ•´ä¸ªæµç¨‹å°±å·²ç»ä¸²èµ·æ¥äº†ï¼Œæ¥ä¸‹æ¥æˆ‘å¯¹è¿™èŠ‚è¯¾åšä¸€ä¸ªæ€»ç»“ã€‚

é¦–å…ˆï¼Œè®­ç»ƒåŸºäº Item çš„ååŒè¿‡æ»¤çŸ©é˜µçš„ä¸€èˆ¬æ­¥éª¤ï¼šç¡®å®šæ¨èå¯¹è±¡ã€è®¡ç®—æ¨èçŸ©é˜µã€è¿›è¡Œæ¨èã€è®°å½•æ¨èç»“æœã€‚

å…¶æ¬¡ï¼Œä½ åº”è¯¥ç†Ÿæ‚‰å¦‚ä½•å°†æ•°æ®å’ŒååŒè¿‡æ»¤ç®—æ³•ä¸²è”èµ·æ¥ï¼Œå¹¶å­˜å…¥åˆ°Redisæ•°æ®åº“ã€‚

æœ€åï¼Œç†Ÿæ‚‰æ¨èç³»ç»Ÿçš„æµç¨‹ï¼Œä¸€å…±å¯ä»¥åˆ†ä¸ºå››æ­¥ã€‚

1. ç¡®å®šæ¨èå¯¹è±¡ï¼šéœ€è¦ç¡®å®šæ¨èç³»ç»Ÿçš„ç”¨æˆ·ç¾¤ä½“ï¼Œå¹¶å¯¹ä»–ä»¬çš„é˜…è¯»è®°å½•è¿›è¡Œæ”¶é›†å’Œåˆ†æã€‚åŒæ—¶ï¼Œé’ˆå¯¹ä¸åŒçš„ç”¨æˆ·ç¾¤ä½“ï¼Œè¿˜éœ€è¦é€‰æ‹©ä¸åŒçš„æ¨èç®—æ³•å’Œæ¨¡å‹ã€‚
2. è®¡ç®—æ¨èçŸ©é˜µï¼šå¾—åˆ°ç”¨æˆ·çš„é˜…è¯»è®°å½•ä¹‹åï¼Œé€šè¿‡è®­ç»ƒç”ŸæˆååŒè¿‡æ»¤çŸ©é˜µï¼ˆå®ƒåæ˜ äº†ç”¨æˆ·ä¸æ–‡ç« ä¹‹é—´çš„å…³è”åº¦ï¼‰ï¼Œèƒ½å¤Ÿå‘Šè¯‰æˆ‘ä»¬å“ªäº›æ–‡ç« ä¸ç”¨æˆ·æ›´ç›¸å…³ã€‚
3. è¿›è¡Œæ¨èï¼šåŸºäºå¾—åˆ°çš„ååŒè¿‡æ»¤çŸ©é˜µå°±å¯ä»¥å¯¹ç”¨æˆ·è¿›è¡Œæ¨èäº†ã€‚æ ¹æ®ä¸åŒçš„ç®—æ³•å’Œæ¨¡å‹ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸åŒçš„æ¨èæ–¹å¼ï¼Œå¦‚åŸºäºç”¨æˆ·çš„ååŒè¿‡æ»¤ã€åŸºäºç‰©å“çš„ååŒè¿‡æ»¤ã€åŸºäºå†…å®¹çš„æ¨èç­‰ã€‚
4. è®°å½•æ¨èç»“æœï¼šæŠŠæ¨èçš„ç»“æœå†™åˆ°æ•°æ®åº“é‡Œå¹¶å®æ—¶æ›´æ–°ï¼Œè¿™æ ·å¯ä»¥ä¸ºåç»­åº”ç”¨æä¾›æ”¯æŒå’Œå±•ç¤ºã€‚åŒæ—¶ï¼Œè®°å½•æ¨èç»“æœä¹Ÿå¯ä»¥åå“ºæ¨èç®—æ³•çš„è¿­ä»£ï¼Œæå‡æ¨èæ•ˆæœã€‚

## è¯¾åç»ƒä¹ 

è¿™èŠ‚è¯¾å­¦å®Œäº†ï¼Œç»™ä½ ç•™ä¸¤é“è¯¾åé¢˜ã€‚

1. å®ç°ä¸Šé¢çš„ä»£ç ã€‚
2. æŠŠå‰ç«¯å’Œè¿™ä¸ªæ¨èçš„ç»“æœä¸²è”èµ·æ¥ã€‚

æœŸå¾…ä½ çš„åˆ†äº«ï¼Œå¦‚æœä»Šå¤©çš„å†…å®¹è®©ä½ æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æ¨èç»™æœ‰éœ€è¦çš„æœ‹å‹ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ5ï¼‰</strong></div><ul>
<li><span>panda_dou</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è¯·é—®ä¸€ä¸‹ï¼Œæ–‡ç« ä¸­ä»£ç çš„GitHubçš„é“¾æ¥å¯ä»¥æä¾›ä¸€ä¸‹å—ï¼Ÿ</p>2023-08-07</li><br/><li><span>peter</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯·é—®ï¼šâ€œå…±ç°çŸ©é˜µâ€å°±æ˜¯â€œååŒè¿‡æ»¤çŸ©é˜µâ€å—ï¼Ÿ</p>2023-06-08</li><br/><li><span>å¶åœ£æ«</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¿™äº›è¡¨é‡Œçš„æ•°æ®ä»å“ªé‡Œæ¥ï¼Ÿ
self.mongo = MongoDB(db=&#39;recommendation&#39;)        
self.db_client = self.mongo.db_client        
self.read_collection = self.db_client[&#39;read&#39;]        
self.likes_collection = self.db_client[&#39;likes&#39;]        
self.collection = self.db_client[&#39;collection&#39;]        
self.content = self.db_client[&#39;content_labels&#39;]</p>2024-02-15</li><br/><li><span>æ‚Ÿå°˜</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>read_count = self.read_collection.find(query).count() æ‰§è¡ŒæŠ¥é”™ AttributeError: &#39;Cursor&#39; object has no attribute &#39;count&#39;:
è¿™ä¸ªé”™è¯¯æ˜¯å› ä¸ºåœ¨ MongoDB 3.6 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œ`Cursor` å¯¹è±¡ä¸å†å…·æœ‰ `count()` æ–¹æ³•ã€‚ä½ éœ€è¦ä½¿ç”¨å…¶ä»–æ–¹æ³•æ¥è·å–æŸ¥è¯¢ç»“æœçš„æ•°é‡ã€‚
ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ä¹‹ä¸€æ¥è®¡ç®—åŒ¹é…æŸ¥è¯¢çš„æ–‡æ¡£æ•°é‡ï¼š

1. **`count_documents()`**ï¼š
   - ä½¿ç”¨ `count_documents()` æ–¹æ³•ç›´æ¥åœ¨é›†åˆä¸Šè¿›è¡Œè®¡æ•°ã€‚
     ```python
     read_count = self.read_collection.count_documents(query)
     ```

2. **`estimated_document_count()`**ï¼š
   - å¦‚æœä½ ä¸éœ€è¦ç²¾ç¡®çš„è®¡æ•°ï¼Œå¯ä»¥ä½¿ç”¨ `estimated_document_count()` æ–¹æ³•ï¼Œå®ƒé€šå¸¸æ¯” `count_documents()` æ›´å¿«ã€‚
     ```python
     read_count = self.read_collection.estimated_document_count()
     ```

è¯·ç¡®ä¿ä½ çš„ MongoDB ç‰ˆæœ¬æ”¯æŒè¿™äº›æ–¹æ³•ã€‚å¦‚æœä½ æ­£åœ¨ä½¿ç”¨çš„ç‰ˆæœ¬ä½äº 3.6ï¼Œè¯·æ›´æ–°åˆ°è¾ƒæ–°çš„ç‰ˆæœ¬ä»¥é¿å…å‡ºç°è¿™ä¸ªé—®é¢˜ã€‚</p>2023-12-15</li><br/><li><span>æ‚Ÿå°˜</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>..&#47;data&#47;news_score&#47;news_log.csvï¼Œè¿™ä¸ªæ–‡ä»¶åœ¨å“ªï¼Ÿ</p>2023-12-15</li><br/>
</ul>