ä½ å¥½ï¼Œæˆ‘æ˜¯ä½•è¾‰ã€‚ä»Šå¤©æˆ‘ä»¬æ·±å…¥ç ”ç©¶Dubboæºç çš„ç¬¬åç¯‡ï¼Œè°ƒç”¨æµç¨‹ã€‚

åœ¨æ¶ˆè´¹æ–¹è¿™æ ·çš„ä»£ç ä½ ä¸€å®šè§è¿‡å¾ˆå¤šäº†ã€‚

```java
@DubboReference
private DemoFacade demoFacade;
```

åœ¨ Spring Bean ä¸­å®šä¹‰ Dubbo æ¥å£ä¸ºæˆå‘˜å˜é‡æ—¶ï¼Œç”¨ @DubboReference æ³¨è§£ä¿®é¥° DemoFacadeã€‚

ä½ æœ‰æ²¡æœ‰å¥½å¥‡è¿‡ï¼Œæˆ‘ä»¬ç°åœ¨çœ‹åˆ°çš„è¿™ä¸ª demoFacade å˜é‡ï¼Œåœ¨å†…å­˜è¿è¡Œæ—¶ï¼Œå€¼ç±»å‹è¿˜å±äº DemoFacade è¿™ä¸ªç±»å‹ä¹ˆï¼Ÿå¦‚æœä¸æ˜¯ï¼Œé‚£æ‹¿ç€ demoFacade å˜é‡å»è°ƒç”¨é‡Œé¢çš„æ–¹æ³•æ—¶ï¼Œåœ¨æ¶ˆè´¹æ–¹åˆ°åº•ä¼šç»å†æ€æ ·çš„è°ƒç”¨æµç¨‹å‘¢ï¼Ÿ

è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¥å‰ä¹Ÿæ¢ç´¢è¿‡ï¼Œä¸è¿‡å› ä¸ºæºç å¤ªå¤æ‚ï¼Œæœ€åéƒ½å¾’åŠ³æ— åŠŸã€‚ç›´åˆ°æœ‰ä¸€å¤©ï¼Œé‡åˆ°äº†ä¸€ä½èµ„æ·±å¤§ä½¬ï¼ŒæŒ‡ç‚¹äº†æˆ‘çœ‹æºç çš„ 12 å­—æ–¹é’ˆï¼š**ä¸é’»ç»†èŠ‚ï¼šåªçœ‹æµç¨‹ï¼›ä¸çœ‹è¿‡ç¨‹ï¼šåªçœ‹ç»“è®ºï¼›å†çœ‹ç»†èŠ‚ï¼šå†çœ‹è¿‡ç¨‹**ã€‚å‚è€ƒä»–çš„ç»éªŒï¼Œæˆ‘ç»è¿‡ä¸€ç•ªç®€å•çš„è°ƒè¯•åï¼Œå°±è½»æ¾æ¢³ç†å‡ºäº†è°ƒç”¨æµç¨‹çš„å¤§ä½“æ¡†æ¶ã€‚

ä»Šå¤©æˆ‘å°±å¸¦ä½ æŒ‰ç…§è¿™12å­—æ–¹é’ˆçš„æ€è·¯ï¼Œæ„Ÿå—ä¸€ä¸‹é«˜æ‰‹æ˜¯å¦‚ä½•ç ”ç©¶æºç æµç¨‹çš„ã€‚æ¯ä¸ªç¯èŠ‚ï¼Œæˆ‘ä¼šç”¨å›¾ç‰‡æ€»ç»“ï¼ŒåŠ å¼ºä½ å¯¹æµç¨‹çš„å½¢è±¡åŒ–ç†è§£ã€‚ä»Šå¤©çš„å†…å®¹ç¨å¾®å¤šä¸€äº›ï¼Œåšå¥½å‡†å¤‡ï¼Œæˆ‘ä»¬é©¬ä¸Šå¼€å§‹ã€‚

## sayHello è°ƒè¯•

å…ˆæ¥çœ‹ä¸‹æˆ‘ä»¬çš„æ¶ˆè´¹æ–¹è°ƒç”¨ä»£ç ã€‚

```java
///////////////////////////////////////////////////
// æ¶ˆè´¹æ–¹çš„ä¸€ä¸ª Spring Bean ç±»
// 1ã€é‡Œé¢å®šä¹‰äº†ä¸‹æ¸¸ Dubbo æ¥å£çš„æˆå‘˜å˜é‡ï¼Œå¹¶ä¸”è¿˜ç”¨ @DubboReference ä¿®é¥°äº†ä¸€ä¸‹ã€‚
// 2ã€è¿˜å®šä¹‰äº†ä¸€ä¸ª invokeDemo æ–¹æ³•è¢«å¤–éƒ¨è°ƒç”¨ï¼Œä½†å…¶é‡ç‚¹æ˜¯è¯¥æ–¹æ³•å¯ä»¥è°ƒç”¨ä¸‹æ¸¸çš„ Dubbo æ¥å£
///////////////////////////////////////////////////
@Component
public class InvokeDemoService {

    // å®šä¹‰è°ƒç”¨ä¸‹æ¸¸æ¥å£çš„æˆå‘˜å˜é‡ï¼Œ
    // å¹¶ä¸”ç”¨æ³¨è§£ä¿®é¥°
    @DubboReference
    private DemoFacade demoFacade;
    
    // invokeDemo æ˜¯è¢«å¤–éƒ¨è§¦å‘è°ƒç”¨çš„ï¼Œä¸è¿‡è¿™ä¸æ˜¯é‡ç‚¹ï¼Œ
    // é‡ç‚¹çš„æ˜¯è¯¥ invokeDemo é€»è¾‘ä¸­èƒ½è°ƒç”¨ä¸‹æ¸¸çš„æ¥å£ï¼Œ
    // è¿™é‡Œè°ƒç”¨çš„æ˜¯ä¸‹æ¸¸ DemoFacade æ¥å£çš„ sayHello æ–¹æ³•
    public String invokeDemo(){
        return demoFacade.sayHello("Geek");
    }
}
```

ä»£ç åœ¨è¿™ä¸ªç±»ä¸­å®šä¹‰äº†ä¸€ä¸ª invokeDemo çš„æ–¹æ³•ï¼Œç„¶åï¼Œåœ¨æ–¹æ³•ä½“ä¸­å¯¹ä¸‹æ¸¸ DemoFacade æ¥å£çš„ sayHello æ–¹æ³•å‘èµ·äº†è¿œç¨‹è°ƒç”¨ã€‚

æ˜¯ä¸æ˜¯å‘ç°æ¶ˆè´¹æ–¹çœŸçš„éå¸¸ç®€å•ä¸”æ™®é€šã€‚é‚£æ€ä¹ˆå±•å¼€æ¢ç´¢å‘¢ï¼Ÿæˆ‘ä»¬ä»¥ Debug çš„æ–¹å¼è°ƒè¯•æ¶ˆè´¹æ–¹ï¼Œåœ¨ sayHello æ–¹æ³•æ‰“ä¸ªæ–­ç‚¹ï¼Œé€šè¿‡æ–­ç‚¹è°ƒè¯•ï¼Œé’»è¿›è°ƒç”¨æµç¨‹çš„å„ä¸ªç¯èŠ‚ï¼ŒåŒæ—¶å‚è€ƒ12å­—æ–¹é’ˆï¼Œæ·±å…¥ç ”ç©¶è°ƒç”¨æµç¨‹çš„åº•å±‚é€»è¾‘ã€‚

### 1. JDKä»£ç†

æˆ‘ä»¬åœ¨è°ƒç”¨ sayHello æ–¹æ³•çš„è¿™è¡Œæ‰“ä¸Šä¸€ä¸ªæ–­ç‚¹ï¼Œå…ˆè¿è¡Œæä¾›æ–¹ï¼Œå† Debug è¿è¡Œæ¶ˆè´¹æ–¹ï¼Œå¾ˆå¿«æ–­ç‚¹å°±åˆ°æ¥äº†ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/14/4f/14301447ee765c43ecc527061e60d44f.jpg?wh=4161x1791)

è¿˜è®°å¾—å‰é¢æå‡ºçš„ä¸€ä¸ªç–‘é—®ä¹ˆï¼ŒdemoFacade åœ¨å†…å­˜è¿è¡Œæ—¶ï¼Œå€¼ç±»å‹æ˜¯ä»€ä¹ˆï¼Ÿ

ä»å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼ŒdemoFacade çš„ç±»å‹ï¼Œæ˜¯ä¸€ä¸ªéšæœºç”Ÿæˆçš„ä»£ç†ç±»åï¼Œä¸å†å±äº DemoFacade è¿™ä¸ªç±»å‹äº†ï¼Œè€Œä¸”ç»“åˆ $Proxy ç±»åã€ä»£ç†ç±»ä¸­çš„ h æˆå‘˜å˜é‡å±äº JdkDynamicAopProxy ç±»å‹ï¼Œç»¼åˆåˆ¤æ–­ï¼Œè¿™æ˜¯é‡‡ç”¨ JDK ä»£ç†åŠ¨æ€ï¼Œç”Ÿæˆäº†ä¸€ä¸ªç»§æ‰¿ Proxy çš„ä»£ç†ç±»ã€‚

å¦‚æœä½ å†å±•å¼€ h å±æ€§çœ‹çœ‹å®ƒé‡Œé¢çš„æˆå‘˜å˜é‡ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/89/f4/8948b4228103f59fb5aa20ebfc9d4cf4.jpg?wh=4158x2607)

æœ‰ 2 ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µï¼ŒtargetSource å’Œ interfacesï¼Œæˆ‘ä»¬æŒ¨ä¸ªçœ‹ä¸‹ã€‚

å…ˆæ¥çœ‹çœ‹ targetSource å˜é‡ï¼ˆReferenceBean$DubboReferenceLazyInitTargetSourceï¼‰ã€‚

çœ‹åˆ°å®ƒçš„ç±»åï¼Œæœ‰æ²¡æœ‰ä¼¼æ›¾ç›¸è¯†çš„æ„Ÿè§‰ï¼Œç±»åä¸ŠåŒ…å«äº† DubboReference å…³é”®å­—ï¼Œæƒ³å¿…è·Ÿè®¢é˜…æµç¨‹ä¸­çš„å¼•ç”¨æœ‰å…³ã€‚è€Œä¸”ç±»åçš„æ„æˆï¼Œç”± $ ç¬¦å·éš”å¼€äº†ï¼Œå¯ä»¥è¯´æ˜ DubboReferenceLazyInitTargetSource æ˜¯ ReferenceBean çš„ä¸€ä¸ªå†…éƒ¨ç±»ã€‚

è¿›å»ç„ä¸€çœ¼ï¼Œçœ‹çœ‹çŒœæƒ³å¯¹ä¸å¯¹ã€‚

```java
///////////////////////////////////////////////////                  
// org.apache.dubbo.config.spring.ReferenceBean.DubboReferenceLazyInitTargetSource
// æ‡’åŠ è½½åˆå§‹åŒ–çš„ä¸€ç§æ“ä½œ
///////////////////////////////////////////////////
private class DubboReferenceLazyInitTargetSource extends AbstractLazyCreationTargetSource {
    @Override
    protected Object createObject() throws Exception {
        // åˆ›å»ºå¯¹è±¡ï¼Œå…¶å®å°±æ˜¯åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œæ‹¿åˆ°è¿œç¨‹å¼•ç”¨
        return getCallProxy();
    }
    @Override
    public synchronized Class<?> getTargetClass() {
        return getInterfaceClass();
    }
}
                  â†“
///////////////////////////////////////////////////                  
// org.apache.dubbo.config.spring.ReferenceBean#getCallProxy
// ç›´æ¥é€šè¿‡ referenceConfig çš„ get æ–¹æ³•è·å–æ¥å£å¼•ç”¨çš„ä»£ç†å¯¹è±¡
///////////////////////////////////////////////////                  
private Object getCallProxy() throws Exception {
    if (referenceConfig == null) {
        throw new IllegalStateException("ReferenceBean is not ready yet, please make sure to call reference interface method after dubbo is started.");
    }
    //get reference proxy
    return referenceConfig.get();
}
```

è¿›å»ä¹‹åæ‰å‘ç°ï¼ŒåŸæ¥å†…éƒ¨ç±»æ˜¯ä¸€å±‚å£³ï¼Œ**æ ¸å¿ƒåˆ›å»ºå¯¹è±¡çš„é€»è¾‘è¿˜æ˜¯ ReferenceConfig çš„ get æ–¹æ³•ã€‚**

æˆ‘ä»¬å†æ¥çœ‹ interfacaces å˜é‡ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/7e/e6/7e6fcedfbb5be17e8776869d4b2466e6.jpg?wh=4671x2757)

è¿™é‡Œé™¤äº†æœ‰æˆ‘ä»¬è°ƒç”¨ä¸‹æ¸¸çš„æ¥å£ DemoFacadeï¼Œè¿˜æœ‰ä¸€ä¸ªå›å£°æµ‹è¯•æ¥å£ï¼ˆEchoServiceï¼‰å’Œä¸€ä¸ªé”€æ¯å¼•ç”¨çš„æ¥å£ï¼ˆDestroyableï¼‰ã€‚

è¿™ä¿©æ¥å£æˆ‘ä»¬æ²¡è§è¿‡ï¼Œå´è¢« Dubbo åœ¨åˆ›å»ºä»£ç†çš„è¿‡ç¨‹ä¸­è¿½åŠ è¿›æ¥äº†ï¼Œå¯ä»¥è¯´æ˜ä¸€ç‚¹ï¼Œ**æˆ‘ä»¬å¯ä»¥æ‹¿ç€ demoFacade å˜é‡å¼ºè½¬ä¸º EchoServiceï¼Œæˆ–è€…å¼ºè½¬ä¸º Destroyableï¼Œå¼ºè½¬åå°±å¯ä»¥è°ƒç”¨å¯¹åº”æ¥å£çš„æ–¹æ³•ï¼Œå®ç°äº†ä¸€ä¸ªä»£ç†ç±»æ‹¥æœ‰å¤šæ€åŠŸèƒ½çš„æ•ˆæœã€‚**

è¿™ä¸ªå¤šæ€åŠŸèƒ½çš„æ”¯æŒï¼Œå¾—å½’åŠŸäº JDK çš„ Proxy ç±»ï¼Œå®ƒåœ¨åˆ›å»ºä»£ç†å¯¹è±¡çš„ newProxyInstance æ–¹æ³•ä¸­ï¼Œæ”¯æŒå…¥å‚ä¼ å…¥ä¸€ä¸ªæ¥å£æ•°ç»„ï¼ŒDubbo æ¡†æ¶åœ¨åˆ›å»ºä»£ç†æ—¶ï¼Œä¸ä½†ä¼ å…¥äº† DemoFacade æ¥å£ï¼Œè¿˜ä¼ å…¥äº† EchoService å’Œ Destroyable æ¥å£ï¼Œç”Ÿæˆçš„ä»£ç†å¯¹è±¡å°±æœ‰äº†å¦å¤–ä¸¤ç§æ¥å£çš„è¡Œä¸ºèƒ½åŠ›ã€‚

```java
///////////////////////////////////////////////////                  
// java.lang.reflect.Proxy#newProxyInstance
// JDK çš„ Proxy ç±»ä¸­ï¼Œåˆ›å»ºä»£ç†å¯¹è±¡çš„æ–¹æ³•
///////////////////////////////////////////////////

@CallerSensitive
public static Object newProxyInstance(ClassLoader loader,
                                      Class<?>[] interfaces,
                                      InvocationHandler h)
    throws IllegalArgumentException
{ çœç•¥éƒ¨åˆ†å®ç°ä»£ç ... }
```

å¥½ï¼Œç®€å•æ•´ç†ä¸€ä¸‹ï¼Œåˆšå¼€å§‹æ–­ç‚¹æ¢ç´¢ï¼Œæˆ‘ä»¬å°±æ¥è§¦åˆ°äº†â€œé«˜æ·±â€çš„ JDK ä»£ç†å¯¹è±¡ï¼Œè§£å¼€äº†å¼€å¤´çš„ä¸€ä¸ªç–‘æƒ‘ï¼Œ demoFacade åœ¨è¿è¡Œæ—¶å¹¶éæˆ‘ä»¬æ‰€è§çš„ DemoFacade ç±»å‹ï¼Œè€Œæ˜¯ç”± JDK åŠ¨æ€ä»£ç†ç”Ÿæˆçš„ä¸€ä¸ªä»£ç†å¯¹è±¡ç±»å‹ã€‚

ç¢°å·§å‘ç°ï¼Œåœ¨ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ä¸­ï¼ŒtargetSource æˆå‘˜å˜é‡åˆ›å»ºçš„åº•å±‚æ ¸å¿ƒé€»è¾‘è¿˜æ˜¯ ReferenceConfig çš„ get æ–¹æ³•ï¼Œä¸å¾—ä¸è¯´ ReferenceConfig æ˜¯æ¶ˆè´¹æ–¹å¼•ç”¨ä¸‹æ¸¸æ¥å£é€»è¾‘ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªç±»ã€‚

åŒæ—¶è¿˜è®¤è¯†äº† EchoService å’Œ Destroyable ä¸¤ä¸ªæ¥å£ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨ demoFacade æ—¶ä¸ä»…å¯ä»¥è°ƒç”¨ sayHello æ–¹æ³•ï¼Œè¿˜å¯ä»¥å¼ºè½¬ä¸ºè¿™ä¸¤ä¸ªæ¥å£è°ƒç”¨ä¸åŒçš„æ–¹æ³•ï¼Œä½¿å¾—ä¸€ä¸ª demoFacade å˜é‡æ‹¥æœ‰ä¸‰èƒ½èƒ½åŠ›ï¼Œè¿™å°±æ˜¯ä»£ç†å¢å¼ºçš„é­…åŠ›æ‰€åœ¨ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/d8/d0/d87a5cc1fe85460b815dd250a84c4ed0.jpg?wh=4683x1170)

### 2. InvokerInvocationHandler

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­ Debug è¿›å…¥ sayHello æ–¹æ³•ä¸­ï¼Œå‘ç°äº†ä¸€ä¸ªåå­—æœ‰ç‚¹çœ¼ç†Ÿçš„ InvokerInvocationHandler ç±»ï¼Œè™½ç„¶ä¸çŸ¥é“å…·ä½“èƒ½åšå•¥ï¼Œä½†æ˜¯å‘ç°å®ƒå®ç°äº† JDK ä»£ç†ä¸­çš„ InvocationHandler æ¥å£ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºï¼Œè¿™ä¸ª InvokerInvocationHandler ç±»æ˜¯ Dubbo æ¡†æ¶æ¥æ”¶ JDK ä»£ç†è§¦å‘è°ƒç”¨çš„å…¥å£ã€‚

æ¥çœ‹çœ‹ InvokerInvocationHandler çš„ invoke æ–¹æ³•ï¼ŒéªŒè¯ä¸€ä¸‹ã€‚

```java
///////////////////////////////////////////////////                  
// org.apache.dubbo.rpc.proxy.InvokerInvocationHandler#invoke
// JDK ä»£ç†è¢«è§¦å‘è°ƒç”¨åç´§æ¥ç€å°±å¼€å§‹è¿›å…¥ Dubbo æ¡†æ¶çš„è°ƒç”¨ï¼Œ
// å› æ­¤è·Ÿè¸ªæ¶ˆè´¹æ–¹è°ƒç”¨çš„å…¥å£ï¼Œä¸€èˆ¬ç›´æ¥æœç´¢è¿™ä¸ª InvokerInvocationHandler å³å¯ï¼Œ
// å†è¯´ä¸€ç‚¹ï¼Œè¿™ä¸ª InvokerInvocationHandler ç»§æ‰¿äº† InvocationHandler æ¥å£ã€‚
///////////////////////////////////////////////////
@Override
public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
    // å¦‚æœæ–¹æ³•æ‰€åœ¨çš„ç±»æ˜¯ Object ç±»å‹çš„è¯ï¼Œåˆ™ä¸åšä»»ä½•å¤„ç†
    // æ¯•ç«Ÿ Object ç±»å‹æ˜¯ JDK æºç ä¸­çš„ç±»ï¼Œä¹Ÿä¸æ˜¯ Dubbo æ¡†æ¶å¤„ç†çš„é‡ç‚¹
    if (method.getDeclaringClass() == Object.class) {
        return method.invoke(invoker, args);
    }
    
    // è·å–æ–¹æ³•åï¼Œæ–¹æ³•å‚æ•°ç±»å‹
    String methodName = method.getName();
    Class<?>[] parameterTypes = method.getParameterTypes();
    // å¦‚æœå‚æ•°ç±»å‹ä¸ªæ•°æ˜¯ 0 ä¸ªçš„è¯ï¼Œåˆ™è¡¨ç¤ºæ˜¯æ— å‚æ•°æ–¹æ³•
    // æ—¢ç„¶æ˜¯æ— å‚æ•°æ–¹æ³•çš„è¯ï¼Œå¯¹äºä¸€äº›ç‰¹æ®Šçš„æ–¹æ³•éœ€è¦å°½å¯èƒ½çš„åœ¨å…¥å£å¤„è§£å†³
    // å› æ­¤å¯¹äº Object ä¸­çš„ toStringã€hashCode æ–¹æ³•ï¼ŒDestroyable æ¥å£å®ç°ç±»çš„ $destroy æ–¹æ³•
    if (parameterTypes.length == 0) {
        if ("toString".equals(methodName)) {
            return invoker.toString();
        } else if ("$destroy".equals(methodName)) {
            invoker.destroy();
            return null;
        } else if ("hashCode".equals(methodName)) {
            return invoker.hashCode();
        }
    } 
    // å¦‚æœæ–¹æ³•å‚æ•°ä¸ªæ•°ä¸º 1 ä¸ªï¼Œå¹¶ä¸”è¿˜æ˜¯ equals æ–¹æ³•ï¼Œåˆ™ä¹Ÿä¸æ˜¯ Dubbo æ¡†æ¶å¤„ç†çš„é‡ç‚¹
    else if (parameterTypes.length == 1 && "equals".equals(methodName)) {
        return invoker.equals(args[0]);
    }
    
    // è¿˜èƒ½æ¥åˆ°è¿™é‡Œï¼Œè¯´æ˜è¿™æ‰æ˜¯ Dubbo æ¡†æ¶éœ€è¦ä»‹å…¥å¤„ç†çš„æ–¹æ³•
    // å‰é¢é‚£ä¹ˆå¤šæå‰è¿”å›çš„é€»è¾‘ï¼Œåœ¨å‰å‡ æ¬¡é˜…è¯»æ—¶ï¼Œæ ¹æœ¬ä¸éœ€è¦ç»†çœ‹ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡ä¸çœ‹
    RpcInvocation rpcInvocation = new RpcInvocation(serviceModel, method, invoker.getInterface().getName(), protocolServiceKey, args);
    if (serviceModel instanceof ConsumerModel) {
        rpcInvocation.put(Constants.CONSUMER_MODEL, serviceModel);
        rpcInvocation.put(Constants.METHOD_MODEL, ((ConsumerModel) serviceModel).getMethodModel(method));
    }
    // ç„¶åè½¬æ‰‹å°±æŠŠé€»è¾‘å…¨éƒ¨æ”¶å£åˆ°ä¸€ä¸ª InvocationUtil ç±»ä¸­ï¼Œ
    // ä»å‘½åä¹Ÿçœ‹å¾—å‡ºï¼Œå°±æ˜¯ä¸€ä¸ªè°ƒç”¨çš„å·¥å…·ç±»
    return InvocationUtil.invoke(invoker, rpcInvocation);
}
```

æŒ‰12å­—æ–¹é’ˆï¼Œä»ä¸Šå¾€ä¸‹å¤§è‡´æµè§ˆä¸€éã€‚

- ä»ä»£ç è¡¨é¢çš„æµç¨‹çœ‹ï¼Œä¸€äº› toStringã€$destroyã€hashCode ç­‰æ–¹æ³•åšäº†ç‰¹æ®Šçš„é€»è¾‘æå‰è¿”å›äº†ï¼Œæœ€ç»ˆè°ƒç”¨ InvocationUtil çš„ invoke æ–¹æ³•è¿›è¡Œäº†æ”¶å£å¤„ç†ã€‚
- ä»æ–¹æ³•çš„å…¥å‚å’Œè¿”å›å€¼çœ‹ï¼Œæœ‰æ–¹æ³•å¯¹è±¡ã€å…¥å‚æ•°æ®ã€ä»£ç†å¯¹è±¡ï¼Œæ»¡è¶³äº†åå°„è°ƒç”¨çš„åŸºæœ¬è¦ç´ ï¼Œè°ƒç”¨åè¿”å›çš„æ•°æ®ï¼Œè‡ªç„¶å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ç»“æœã€‚
- å†çœ‹æ–¹æ³•å®ç°ä½“çš„ä¸€äº›ç»†èŠ‚ï¼Œå‘ç°æœ€ç»ˆå¹¶æ²¡æœ‰ä½¿ç”¨ proxy ä»£ç†å¯¹è±¡ï¼Œè€Œæ˜¯ä½¿ç”¨äº† invoker + rpcInvocation ä¼ å…¥ InvocationUtil å·¥å…·ç±»ï¼Œå®Œæˆäº†é€»è¾‘æ”¶å£ã€‚

å†è¿›å…¥ InvocationUtilï¼Œå¿½ç•¥ä¸å…¥å‚æ— å…³çš„é€»è¾‘ï¼Œæœ€ç»ˆå‘ç°æŠŠ rpcInvocation å¯¹è±¡ä¼ å…¥äº† invoker çš„ invoke æ–¹æ³•ä¸­ï¼Œç»§ç»­èµ°åç»­è°ƒç”¨é€»è¾‘ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/ay/15/ayyd03a438fc2721b88e19cd721a9f15.jpg?wh=4683x1272)

### 3. MigrationInvoker

Debug ä¸€ç›´å¾€åèµ°ï¼Œæ¥åˆ°äº†ä¸€ä¸ª MigrationInvoker çš„è°ƒç”¨ç±»ï¼Œä»ç±»çš„åå­—ä¸Šçœ‹æ˜¯â€œè¿ç§»â€çš„æ„æ€ï¼Œæœ‰ç‚¹ Dubbo2 ä¸ Dubbo3 æ–°è€å…¼å®¹è¿ç§»çš„å‘³é“ã€‚

é‚£æ¥çœ‹çœ‹ MigrationInvoker çš„ invoke æ–¹æ³•ä»£ç é€»è¾‘ã€‚

```java
///////////////////////////////////////////////////                  
// org.apache.dubbo.registry.client.migration.MigrationInvoker#invoke
// è¿ç§»å…¼å®¹è°ƒç”¨å™¨
///////////////////////////////////////////////////
@Override
public Result invoke(Invocation invocation) throws RpcException {
    if (currentAvailableInvoker != null) {
        if (step == APPLICATION_FIRST) {
            // call ratio calculation based on random value
            if (promotion < 100 && ThreadLocalRandom.current().nextDouble(100) > promotion) {
                return invoker.invoke(invocation);
            }
        }
        return currentAvailableInvoker.invoke(invocation);
    }

    switch (step) {
        case APPLICATION_FIRST:
            if (checkInvokerAvailable(serviceDiscoveryInvoker)) {
                currentAvailableInvoker = serviceDiscoveryInvoker;
            } else if (checkInvokerAvailable(invoker)) {
                currentAvailableInvoker = invoker;
            } else {
                currentAvailableInvoker = serviceDiscoveryInvoker;
            }
            break;
        case FORCE_APPLICATION:
            currentAvailableInvoker = serviceDiscoveryInvoker;
            break;
        case FORCE_INTERFACE:
        default:
            currentAvailableInvoker = invoker;
    }

    return currentAvailableInvoker.invoke(invocation);
}
```

ç»§ç»­æŒ‰ 12 å­—æ–¹é’ˆåˆ†æã€‚

- ä»ä»£ç æµç¨‹çœ‹ï¼Œä»ä¸Šåˆ°ä¸‹éƒ½åœ¨é’ˆå¯¹ step å˜é‡å€¼ï¼Œè¿›è¡Œ ifâ€¦else åˆ¤æ–­èµ°ä¸èµ°åˆ†æ”¯å¤„ç†ï¼Œè¯´æ˜è¿™é‡Œé’ˆå¯¹ step è¿›è¡Œäº†é€»è¾‘åˆ†å‘å¤„ç†ã€‚
- ä»æ–¹æ³•çš„å…¥å‚å’Œè¿”å›å€¼æ¥çœ‹ï¼Œå…¥å‚ invocation æ˜¯ä¸€ä¸ªå¯Œå«æ‰€æœ‰è¯·æ±‚ä¿¡æ¯çš„æ¥å£ï¼Œè¿”å‚ä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡çš„ Result æ¥å£ï¼Œæ„æ€å¾ˆç›´ç™½ï¼Œæ ¹æ®å‚æ•°æ‹¿åˆ°ç»“æœï¼Œåªæ˜¯å…¥å‚å’Œè¿”å‚æ˜¯æ¥å£ï¼Œä½“ç°äº†æŠ½è±¡çš„æ¦‚å¿µã€‚
- å†çœ‹çœ‹æ–¹æ³•å®ç°ä½“çš„ä¸€äº›ç»†èŠ‚ï¼Œé€šè¿‡é’ˆå¯¹ APPLICATION\_FIRSTã€FORCE\_APPLICATIONã€FORCE\_INTERFACE æ¥è¿›è¡Œåˆ†å‘å¤„ç†ï¼Œè¿™ä¸å°±æ˜¯æ¶ˆè´¹æ–¹è®¾ç½® dubbo.application.service-discovery.migration å±æ€§ï¼Œè¿›è¡Œæ–°è€è®¢é˜…æ–¹æ¡ˆå…¼å®¹çš„å€¼ä¹ˆï¼Ÿæ ¹æ®ä¸åŒçš„å±æ€§å€¼ï¼Œé€‰æ‹©å¯¹åº”å¯ç”¨çš„ invoker è¿›è¡Œç»§ç»­åç»­è°ƒç”¨ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/7a/29/7a2fb581db370895cac43d3257d16f29.jpg?wh=4668x1416)

### 4. MockClusterInvoker

ç„¶åèµ°è¿›â€step == APPLICATION\_FIRSTâ€œçš„åˆ†æ”¯é€»è¾‘ï¼Œè¿›å…¥ currentAvailableInvoker çš„ invoke æ–¹æ³•ï¼Œæ¥åˆ°äº† MockClusterInvoker è¿™ä¸ªç±»ï¼Œçœ‹åå­—æ˜¯â€œæ¨¡æ‹Ÿé›†ç¾¤è°ƒç”¨â€çš„æ„æ€ã€‚

æœ¬æ„æ˜¯å¹²å•¥çš„å‘¢ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹å®ƒçš„ invoke æ–¹æ³•é€»è¾‘ã€‚

```java
///////////////////////////////////////////////////                  
// org.apache.dubbo.rpc.cluster.support.wrapper.MockClusterInvoker#invoke
// è°ƒç”¨å¼‚å¸¸æ—¶è¿›è¡Œä½¿ç”¨mocké€»è¾‘æ¥å¤„ç†æ•°æ®çš„è¿”å›
///////////////////////////////////////////////////
@Override
public Result invoke(Invocation invocation) throws RpcException {
    Result result;
    // ä»è¿œç¨‹å¼•ç”¨çš„urlä¸­çœ‹çœ‹æœ‰æ²¡æœ‰ mock å±æ€§
    String value = getUrl().getMethodParameter(invocation.getMethodName(), "mock", Boolean.FALSE.toString()).trim();
    // mock å±æ€§å€¼ä¸ºç©ºçš„è¯ï¼Œç›¸å½“äºæ²¡æœ‰ mock é€»è¾‘ï¼Œåˆ™ç›´æ¥ç»§ç»­åç»­é€»è¾‘è°ƒç”¨
    if (ConfigUtils.isEmpty(value)) {
        //no mock
        result = this.invoker.invoke(invocation);
    } 
    // å¦‚æœ mock å±æ€§å€¼æ˜¯ä»¥ force å¼€å¤´çš„è¯
    else if (value.startsWith("force")) {
        // é‚£ä¹ˆå°±ç›´æ¥æ‰§è¡Œ mock è°ƒç”¨é€»è¾‘ï¼Œ
        // ç”¨äº‹å…ˆå‡†å¤‡å¥½çš„æ¨¡æ‹Ÿé€»è¾‘æˆ–è€…æ¨¡æ‹Ÿæ•°æ®è¿”å›
        //force:direct mock
        result = doMockInvoke(invocation, null);
    } 
    // è¿˜èƒ½æ¥åˆ°è¿™è¯´æ˜åªæ˜¯æƒ³åœ¨è°ƒç”¨å¤±è´¥çš„æ—¶å€™å°è¯•ä¸€ä¸‹ mock é€»è¾‘
    else {
        //fail-mock
        try {
            // å…ˆæ­£å¸¸æ‰§è¡Œä¸šåŠ¡é€»è¾‘è°ƒç”¨
            result = this.invoker.invoke(invocation);
            //fix:#4585
            // å½“ä¸šåŠ¡é€»è¾‘æ‰§è¡Œæœ‰å¼‚å¸¸æ—¶ï¼Œå¹¶ä¸”è¿™ä¸ªå¼‚å¸¸ç±»å±äºRpcExceptionæˆ–RpcExceptionå­ç±»æ—¶ï¼Œ
            // è¿˜æœ‰å¼‚å¸¸çš„åŸå› å¦‚æœæ˜¯ Dubbo æ¡†æ¶å±‚é¢çš„ä¸šåŠ¡å¼‚å¸¸æ—¶ï¼Œåˆ™ä¸åšä»»ä½•å¤„ç†ã€‚
            // å¦‚æœä¸æ˜¯ä¸šåŠ¡å¼‚å¸¸çš„è¯ï¼Œåˆ™ä¼šç»§ç»­å°è¯•æ‰§è¡Œ mock ä¸šåŠ¡é€»è¾‘
            if(result.getException() != null && result.getException() instanceof RpcException){
                RpcException rpcException= (RpcException)result.getException();
                // å¦‚æœå¼‚å¸¸æ˜¯ Dubbo ç³»ç»Ÿå±‚é¢æ‰€è®¤ä¸ºçš„ä¸šåŠ¡å¼‚å¸¸æ—¶ï¼Œå°±ä¸é”™ä»»ä½•å¤„ç†
                if(rpcException.isBiz()){
                    throw  rpcException;
                }else {
                    // èƒ½æ¥åˆ°è¿™é‡Œè¯´æ˜æ˜¯ä¸æ˜¯ä¸šåŠ¡å¼‚å¸¸çš„è¯ï¼Œé‚£å°±æ‰§è¡Œæ¨¡æ‹Ÿé€»è¾‘
                    result = doMockInvoke(invocation, rpcException);
                }
            }
        } catch (RpcException e) {
            // ä¸šåŠ¡å¼‚å¸¸ç›´æ¥å¾€ä¸Šæ‹‹
            if (e.isBiz()) {
                throw e;
            }
            // ä¸æ˜¯ Dubbo å±‚é¢æ‰€å’Œè®¤ä¸ºçš„å¼‚å¸¸ä¿¡æ¯æ—¶ä»£ï¼Œ
            // ç›´æ¥
            result = doMockInvoke(invocation, e);
        }
    }
    return result;
}
```

ç…§ä¾‹æŒ‰12å­—æ–¹é’ˆåˆ†æã€‚

- ä»ä»£ç æµç¨‹çœ‹ï¼Œæ•´ä½“ä¸Šå°±ä¸‰ä¸ª if é€»è¾‘åˆ†æ”¯ï¼Œno mockã€force mock å’Œ fail mockï¼Œåˆ†åˆ«è¿›è¡Œäº†ä¸åŒé€»è¾‘çš„è°ƒç”¨ã€‚
- ä»æ–¹æ³•çš„å…¥å‚å’Œè¿”å›å€¼çœ‹ï¼Œå…¥å‚å’Œè¿”å‚å’Œ MigrationInvoker ä¸€æ ·ï¼Œéƒ½æ˜¯é‡å†™äº† invoke æ–¹æ³•ï¼Œåªæ˜¯å†…éƒ¨é€»è¾‘ä¸ä¸€æ ·ï¼Œä¸åŒå®ç°ç±»åšå„è‡ªçš„äº‹æƒ…ã€‚
- å†çœ‹çœ‹æ–¹æ³•å®ç°ä½“çš„ä¸€äº›ç»†èŠ‚ï¼Œmock å±æ€§å€¼ï¼ˆé™¤äº†ç©ºå€¼ï¼‰ï¼Œå½“ä»¥ force å¼€å¤´æ—¶ï¼Œä¼šç›´æ¥æ‰§è¡Œ Mock ä¸šåŠ¡é€»è¾‘ï¼Œå…¶ä»–æƒ…å†µè¿˜æ˜¯å…ˆå°è¯•æ­£å¸¸åç»­è°ƒç”¨ï¼Œå¦‚æœå‡ºç°äº†éä¸šåŠ¡å¼‚å¸¸æ—¶ï¼Œå°±å°è¯•æ‰§è¡Œ Mock ä¸šåŠ¡é€»è¾‘ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/83/54/830368b86f33c6853349099a8fe48254.jpg?wh=4665x1671)

### 5. è¿‡æ»¤å™¨é“¾

è¿™é‡Œï¼Œçœ‹åˆ° Cluster è¿™ä¸ªå…³é”®å­—ï¼Œæƒ³å¿…ä½ ä¹Ÿæƒ³åˆ°äº†å®ƒæ˜¯ä¸€ä¸ª SPI æ¥å£ï¼Œé‚£åœ¨â€œå‘å¸ƒæµç¨‹â€ä¸­æˆ‘ä»¬ä¹Ÿå­¦è¿‡ï¼Œè¿œç¨‹å¯¼å‡ºå’Œè¿œç¨‹å¼•ç”¨çš„æ—¶å€™ï¼Œä¼šç”¨è¿‡æ»¤å™¨é“¾æŠŠ invoker å±‚å±‚åŒ…è£…èµ·æ¥ã€‚

é‚£ä¹ˆæˆ‘ä»¬å°±æ¥ç€æ–­ç‚¹ä¸‹å»ï¼Œå‘ç°ç¡®å®è¿›å…¥ FutureFilterã€MonitorFilter ç­‰è¿‡æ»¤å™¨ï¼Œè¿™ä¹Ÿè¯æ˜äº†è¿‡æ»¤å™¨é“¾åŒ…è£¹æ¶ˆè´¹æ–¹ invoker çš„å­˜åœ¨ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/ed/41/edc45b36f7b017011306eb2e13e47241.jpg?wh=4668x2001)

### 6. FailoverClusterInvoker

æ–­ç‚¹ä¸€å±‚å±‚èµ°å®Œäº†æ‰€æœ‰çš„è¿‡æ»¤å™¨ï¼Œæ¥ç€åˆæ¥åˆ°äº† FailoverClusterInvoker è¿™ä¸ªç±»ï¼Œä»åå­—ä¸Šä¸€çœ‹å°±æ˜¯åœ¨â€œ[æ¸©æ•…çŸ¥æ–°](https://time.geekbang.org/column/article/611355)â€ä¸­æ¥è§¦çš„æ•…éšœè½¬ç§»ç­–ç•¥ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹å¥½å¥‡æ•…éšœåˆ°åº•æ˜¯æ€ä¹ˆè½¬ç§»çš„ï¼Ÿ

æˆ‘ä»¬ä¸å¦¨ç»§ç»­æ–­ç‚¹ï¼Œè¿›å…¥å®ƒçš„ doInvoke æ–¹æ³•çœ‹çœ‹ã€‚

```java
///////////////////////////////////////////////////                  
// org.apache.dubbo.rpc.cluster.support.FailoverClusterInvoker#doInvoke
// æ•…éšœè½¬ç§»ç­–ç•¥çš„æ ¸å¿ƒé€»è¾‘å®ç°ç±»
///////////////////////////////////////////////////
@Override
@SuppressWarnings({"unchecked", "rawtypes"})
public Result doInvoke(Invocation invocation, final List<Invoker<T>> invokers, LoadBalance loadbalance) throws RpcException {
    List<Invoker<T>> copyInvokers = invokers;
    checkInvokers(copyInvokers, invocation);
    // è·å–æ­¤æ¬¡è°ƒç”¨çš„æ–¹æ³•å
    String methodName = RpcUtils.getMethodName(invocation);
    // é€šè¿‡æ–¹æ³•åè®¡ç®—è·å–é‡è¯•æ¬¡æ•°
    int len = calculateInvokeTimes(methodName);
    // retry loop.
    // å¾ªç¯è®¡ç®—å¾—åˆ°çš„ len æ¬¡æ•°
    RpcException le = null; // last exception.
    List<Invoker<T>> invoked = new ArrayList<Invoker<T>>(copyInvokers.size()); // invoked invokers.
    Set<String> providers = new HashSet<String>(len);
    for (int i = 0; i < len; i++) {
        //Reselect before retry to avoid a change of candidate `invokers`.
        //NOTE: if `invokers` changed, then `invoked` also lose accuracy.
        // ä»ç¬¬2æ¬¡å¾ªç¯å¼€å§‹ï¼Œä¼šæœ‰ä¸€æ®µç‰¹æ®Šçš„é€»è¾‘å¤„ç†
        if (i > 0) {
            // æ£€æµ‹ invoker æ˜¯å¦è¢«é”€æ¯äº†
            checkWhetherDestroyed();
            // é‡æ–°æ‹¿åˆ°è°ƒç”¨æ¥å£çš„æ‰€æœ‰æä¾›è€…åˆ—è¡¨é›†åˆï¼Œ
            // ç²—ä¿—ç†è§£ï¼Œå°±æ˜¯æä¾›è¯¥æ¥å£æœåŠ¡çš„æ¯ä¸ªæä¾›æ–¹èŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ª invoker å¯¹è±¡
            copyInvokers = list(invocation);
            // check again
            // å†æ¬¡æ£€æŸ¥æ‰€æœ‰æ‹¿åˆ°çš„ invokes çš„ä¸€äº›å¯ç”¨çŠ¶æ€
            checkInvokers(copyInvokers, invocation);
        }
        // é€‰æ‹©å…¶ä¸­ä¸€ä¸ªï¼Œå³é‡‡ç”¨äº†è´Ÿè½½å‡è¡¡ç­–ç•¥ä»ä¼—å¤š invokers é›†åˆä¸­æŒ‘é€‰å‡ºä¸€ä¸ªåˆé€‚å¯ç”¨çš„
        Invoker<T> invoker = select(loadbalance, invocation, copyInvokers, invoked);
        invoked.add(invoker);
        // è®¾ç½® RpcContext ä¸Šä¸‹æ–‡
        RpcContext.getServiceContext().setInvokers((List) invoked);
        boolean success = false;
        try {
            // å¾—åˆ°æœ€ç»ˆçš„ invoker åä¹Ÿå°±æ˜ç¡®äº†éœ€è¦è°ƒç”¨å“ªä¸ªæä¾›æ–¹èŠ‚ç‚¹äº†
            // åæ­£ç»§ç»­èµ°åç»­è°ƒç”¨æµç¨‹å°±æ˜¯äº†
            Result result = invokeWithContext(invoker, invocation);
            // å¦‚æœæ²¡æœ‰æŠ›å‡ºå¼‚å¸¸çš„è¯ï¼Œåˆ™è®¤ä¸ºæ­£å¸¸æ‹¿åˆ°çš„è¿”å›æ•°æ®
            // é‚£ä¹ˆè®¾ç½®è°ƒç”¨æˆåŠŸæ ‡è¯†ï¼Œç„¶åç›´æ¥è¿”å› result ç»“æœ
            success = true;
            return result;
        } catch (RpcException e) {
            // å¦‚æœæ˜¯ Dubbo æ¡†æ¶å±‚é¢è®¤ä¸ºçš„ä¸šåŠ¡å¼‚å¸¸ï¼Œé‚£ä¹ˆå°±ç›´æ¥æŠ›å‡ºå¼‚å¸¸
            if (e.isBiz()) { // biz exception.
                throw e;
            }
            // å…¶ä»–å¼‚å¸¸çš„è¯ï¼Œåˆ™ä¸ç»§ç»­æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€è¿˜å¯ä»¥æœ‰æœºä¼šå†æ¬¡å¾ªç¯è°ƒç”¨
            le = e;
        } catch (Throwable e) {
            le = new RpcException(e.getMessage(), e);
        } finally {
            // å¦‚æœæ²¡æœ‰æ­£å¸¸è¿”å›æ‹¿åˆ°ç»“æœçš„è¯ï¼Œé‚£ä¹ˆæŠŠè°ƒç”¨å¼‚å¸¸çš„æä¾›æ–¹åœ°å€ä¿¡æ¯è®°å½•èµ·æ¥
            if (!success) {
                providers.add(invoker.getUrl().getAddress());
            }
        }
    }
    
    // å¦‚æœ len æ¬¡å¾ªç¯ä»ç„¶è¿˜æ²¡æœ‰æ­£å¸¸æ‹¿åˆ°è°ƒç”¨ç»“æœçš„è¯ï¼Œ
    // é‚£ä¹ˆä¹Ÿä¸å†ç»§ç»­å°è¯•è°ƒç”¨äº†ï¼Œç›´æ¥ç´¢æ€§æŠŠä¸€äº›éœ€è¦å¼€å‘äººå‘˜å…³æ³¨çš„ä¸€äº›ä¿¡æ¯å†™åˆ°å¼‚å¸¸æè¿°ä¿¡æ¯ä¸­ï¼Œé€šè¿‡å¼‚å¸¸æ–¹å¼æ‹‹å‡ºå»
    throw new RpcException(le.getCode(), "Failed to invoke the method "
            + methodName + " in the service " + getInterface().getName()
            + ". Tried " + len + " times of the providers " + providers
            + " (" + providers.size() + "/" + copyInvokers.size()
            + ") from the registry " + directory.getUrl().getAddress()
            + " on the consumer " + NetUtils.getLocalHost() + " using the dubbo version "
            + Version.getVersion() + ". Last error is: "
            + le.getMessage(), le.getCause() != null ? le.getCause() : le);
}
```

ä»£ç æµç¨‹åˆ†æä¹Ÿæ¯”è¾ƒç®€å•ã€‚

- ä»ä»£ç æµç¨‹çœ‹ï¼Œä¸»è¦å°±æ˜¯ä¸€ä¸ªå¤§çš„ for å¾ªç¯ï¼Œå¾ªç¯ä½“ä¸­è¿›è¡Œäº† select æ“ä½œï¼Œæ‹¿åˆ°äº†ä¸€ä¸ªåˆé€‚çš„ invokerï¼Œå‘èµ·åç»­é€»è¾‘è°ƒç”¨ã€‚
- ä»æ–¹æ³•çš„å…¥å‚å’Œè¿”å›å€¼çœ‹ï¼Œå…¥å‚æ˜¯ invocationã€invokersã€loadbalance ä¸‰ä¸ªå‚æ•°ï¼ŒçŒœæµ‹åº”è¯¥å°±æ˜¯åˆ©ç”¨ loadbalance è´Ÿè½½å‡è¡¡å™¨ï¼Œä» invokers é›†åˆä¸­ï¼Œé€‰æ‹©ä¸€ä¸ª invokeræ¥å‘é€ invocation æ•°æ®ï¼Œå‘é€å®Œæˆåå¾—åˆ°äº†è¿”å‚çš„ Result ç»“æœã€‚
- å†çœ‹çœ‹æ–¹æ³•å®ç°ä½“çš„ä¸€äº›ç»†èŠ‚ï¼Œé€šè¿‡è®¡ç®— retries å±æ€§å€¼å¾—åˆ°é‡è¯•æ¬¡æ•°å¹¶å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯éƒ½æ˜¯åˆ©ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©ä¸€ä¸ªè¿›è¡Œè°ƒç”¨ï¼Œå¦‚æœå‡ºç°éä¸šåŠ¡å¼‚å¸¸ï¼Œç»§ç»­å¾ªç¯è°ƒç”¨ï¼Œç›´åˆ°æ‰€æœ‰æ¬¡æ•°å¾ªç¯å®Œï¼Œè¿˜æ˜¯æ²¡èƒ½æ‹¿åˆ°ç»“æœçš„è¯å°±ä¼šæŠ›å‡º RpcException å¼‚å¸¸äº†ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/ac/4b/acf6e7c2cd711b04fc391a1a678d264b.jpg?wh=4668x2265)

### 7. DubboInvoker

ç°åœ¨ä½ åº”è¯¥çŸ¥é“â€œæ•…éšœè½¬ç§»ç­–ç•¥â€çš„æ·±å±‚å«ä¹‰äº†å§ï¼Œå°±æ˜¯æ ¹æ®é¢„å…ˆè®¾ç½®å¥½çš„é‡è¯•æ¬¡æ•°ï¼Œå½“è°ƒç”¨å‘ç”Ÿéä¸šåŠ¡å¼‚å¸¸æ—¶ï¼ŒæŒ‰ç…§è´Ÿè½½å‡è¡¡ç­–ç•¥ç»§ç»­é€‰æ‹©ä¸€ä¸ª invokerï¼Œå†æ¬¡å‘èµ·è°ƒç”¨ã€‚

äº†è§£å®Œæ•…éšœè½¬ç§»ç­–ç•¥ï¼Œæˆ‘ä»¬ç»§ç»­ Debugï¼Œç»“æœæ¥åˆ°äº† DubboInvoker è¿™ä¸ªç±»ã€‚

```java
///////////////////////////////////////////////////                  
// org.apache.dubbo.rpc.protocol.dubbo.DubboInvoker#doInvoke
// æŒ‰ç…§dubboåè®®å‘èµ·è°ƒç”¨å®ç°ç±»
///////////////////////////////////////////////////
@Override
protected Result doInvoke(final Invocation invocation) throws Throwable {
    // è·å–æ­¤æ¬¡è°ƒç”¨çš„æ–¹æ³•å
    RpcInvocation inv = (RpcInvocation) invocation;
    final String methodName = RpcUtils.getMethodName(invocation);
    inv.setAttachment(PATH_KEY, getUrl().getPath());
    inv.setAttachment(VERSION_KEY, version);
    // è·å–å‘é€æ•°æ®çš„å®¢æˆ·ç«¯
    ExchangeClient currentClient;
    if (clients.length == 1) {
        currentClient = clients[0];
    } else {
        currentClient = clients[index.getAndIncrement() % clients.length];
    }
    try {
        // çœ‹çœ‹æ˜¯å•ç¨‹å‘é€ä¸éœ€è¦ç­‰å¾…å“åº”ï¼Œè¿˜æ˜¯å‘é€å®Œäº†åéœ€è¦ç­‰å¾…å“åº”
        boolean isOneway = RpcUtils.isOneway(getUrl(), invocation);
        // è·å–è¶…æ—¶æ—¶é—´ï¼Œè¿™ä¸ªä¹‹å‰åœ¨â€œé…ç½®åŠ è½½é¡ºåºâ€æ¥è§¦è¿‡è¿™ä¸ªæ–¹æ³•
        int timeout = calculateTimeout(invocation, methodName);
        invocation.setAttachment(TIMEOUT_KEY, timeout);
        // å•ç¨‹å‘é€ä¸éœ€è¦ç­‰å¾…å“åº”
        if (isOneway) {
            boolean isSent = getUrl().getMethodParameter(methodName, Constants.SENT_KEY, false);
            currentClient.send(inv, isSent);
            return AsyncRpcResult.newDefaultAsyncResult(invocation);
        } else {
            // å‘é€å®Œäº†ä¹‹åéœ€è¦ç­‰å¾…å“åº”
            ExecutorService executor = getCallbackExecutor(getUrl(), inv);
            // æ“ä½œ currentClient å‘é€äº†ä¸€ä¸ª request è¯·æ±‚ï¼Œ
            // ç„¶åæ¥æ”¶äº†ä¸€ä¸ª CompletableFuture å¯¹è±¡ï¼Œè¯´æ˜è¿™é‡Œå­˜åœ¨å¼‚æ­¥æ“ä½œ
            CompletableFuture<AppResponse> appResponseFuture =
                    currentClient.request(inv, timeout, executor).thenApply(obj -> (AppResponse) obj);
            // save for 2.6.x compatibility, for example, TraceFilter in Zipkin uses com.alibaba.xxx.FutureAdapter
            FutureContext.getContext().setCompatibleFuture(appResponseFuture);
            AsyncRpcResult result = new AsyncRpcResult(appResponseFuture, inv);
            result.setExecutor(executor);
            return result;
        }
    } catch (TimeoutException e) {
        throw new RpcException(RpcException.TIMEOUT_EXCEPTION, "Invoke remote method timeout. method: " + invocation.getMethodName() + ", provider: " + getUrl() + ", cause: " + e.getMessage(), e);
    } catch (RemotingException e) {
        throw new RpcException(RpcException.NETWORK_EXCEPTION, "Failed to invoke remote method: " + invocation.getMethodName() + ", provider: " + getUrl() + ", cause: " + e.getMessage(), e);
    }
}
```

- ä»ä»£ç æµç¨‹çœ‹ï¼Œæ‹¿åˆ°äº†ä¸€ä¸ªäº¤æ¢æ•°æ®çš„å®¢æˆ·ç«¯ç±»ï¼Œç„¶åèµ°ä¸¤ä¸ªå‘é€æ•°æ®çš„åˆ†æ”¯ï¼Œä¸€æ¡åˆ†æ”¯é€»è¾‘å•ç¨‹è°ƒç”¨ä¸éœ€è¦å“åº”ï¼Œä¸€æ¡æœ‰å“åº”ã€‚
- ä»æ–¹æ³•çš„å…¥å‚å’Œè¿”å›å€¼æ¥çœ‹ï¼Œæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ï¼Œæ ¹æ®è¯·æ±‚æ•°æ®æƒ³åŠæ³•å‘èµ·è°ƒç”¨ï¼Œæ‹¿åˆ° Result ç»“æœã€‚

ä½†æ˜¯å½“å‰çš„ç±»åæ˜¯å¤„ç† Dubbo åè®®çš„è°ƒç”¨ï¼Ÿæœ‰ç‚¹å¥½å¥‡ï¼Œæˆ‘ä»¬çœ‹çœ‹è¿™ä¸ª doInvoke æœ‰å“ªäº›å®ç°ç±»ï¼Œå‘ç°äº†æœ‰ InjvmInvokerã€GrpcInvoker ç­‰å®ç°ç±»ï¼Œä¹Ÿè¯å®äº†å½“å‰çš„ DubboInvoker æ˜¯ä¸“é—¨å¤„ç† Dubbo åè®®è°ƒç”¨çš„ç±»ã€‚

- å†çœ‹çœ‹æ–¹æ³•å®ç°ä½“çš„ä¸€äº›ç»†èŠ‚ï¼Œè®¡ç®—äº†è¶…æ—¶æ—¶é—´å€¼ï¼Œå•ç¨‹å‘é€ï¼Œä¸éœ€è¦å“åº”å¥½è¯´ï¼Œç›´æ¥è°ƒç”¨äº¤äº’æ•°æ®å®¢æˆ·ç«¯ç±»çš„ send æ–¹æ³•å°±è¡Œï¼Œéœ€è¦æœ‰å“åº”çš„åˆ†æ”¯é€»è¾‘è¿˜å®šä¹‰äº†çº¿ç¨‹æ± ï¼Œè°ƒç”¨çš„æ˜¯ request æ–¹æ³•è¿›è¡Œå‘é€ã€‚

ä¸è¿‡ï¼Œä¸¤æ¡åˆ†æ”¯æœ€ç»ˆéƒ½è¿”å›äº†ä¸€ä¸ªå¼‚æ­¥ç»“æœå¯¹è±¡ï¼Œå¯ä»¥çœ‹å‡ºå½“å‰çš„ DubboInvoker æ—¨åœ¨å±è”½åè®®ä¹‹é—´çš„å·®å¼‚ï¼Œè®©ä¸Šå±‚è°ƒç”¨æ–¹ä¸æ„ŸçŸ¥åè®®é—´çš„ä¸åŒã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/69/23/69f4a169eyy19bb3be65db9a029a3123.jpg?wh=4665x2520)

### 8. ReferenceCountExchangeClient

å› ä¸ºæˆ‘ä»¬æ²¡æœ‰å•ç‹¬è®¾ç½®è°ƒç”¨ä¸éœ€è¦å“åº”ï¼Œå°±ç»§ç»­æ–­ç‚¹è¿›å…¥ currentClient çš„ request æ–¹æ³•ï¼Œçœ‹çœ‹åˆ°åº•æ˜¯æ€ä¹ˆå‘é€çš„ï¼Œæ¥åˆ°äº† ReferenceCountExchangeClient ç±»ã€‚

```java
///////////////////////////////////////////////////                  
// org.apache.dubbo.rpc.protocol.dubbo.ReferenceCountExchangeClient#request(java.lang.Object, int, java.util.concurrent.ExecutorService)
// è¿™é‡Œå°†æ„å»ºå¥½çš„ request å¯¹è±¡å‘é€å‡ºå»ï¼Œç„¶åæ‹¿åˆ°äº†ä¸€ä¸ª CompletableFuture å¼‚æ­¥åŒ–çš„å¯¹è±¡
///////////////////////////////////////////////////
@Override
public CompletableFuture<Object> request(Object request, int timeout, ExecutorService executor) throws RemotingException {
    // clientä¸ºï¼šHeaderExchangeClient
    return client.request(request, timeout, executor);
}
```

- ä»ä»£ç æµç¨‹æ¥çœ‹ï¼Œè¿™ä¸ªç±»ä¸­çš„ request æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼ŒæŠŠå…¥å‚æ•°æ®ç›´æ¥å…¨éƒ¨äº¤ç»™äº†å½“å‰ç±»çš„æˆå‘˜å˜é‡ client å¤„ç†ã€‚
- ä»æ–¹æ³•çš„å…¥å‚å’Œè¿”å›å€¼çœ‹ï¼Œå…¥å‚æ˜¯è¯·æ±‚å¯¹è±¡ã€è¶…æ—¶æ—¶é—´ã€çº¿ç¨‹æ± å¯¹è±¡ï¼Œè¿”å‚æ˜¯ CompletableFuture å¯¹è±¡ã€‚ä»çº¿ç¨‹æ± å’Œ Future å¯¹è±¡ï¼Œå……åˆ†è¯´æ˜äº†è¿™ä¸ª request æ–¹æ³•è¿›è¡Œäº†åŒæ­¥è½¬å¼‚æ­¥çš„æ“ä½œã€‚
- å†çœ‹çœ‹æ–¹æ³•å®ç°ä½“çš„ä¸€äº›ç»†èŠ‚ï¼Œä»æ–­ç‚¹å±•ç¤ºçš„å˜é‡å€¼ç»†èŠ‚çœ‹ï¼Œåªæ˜¯å‘ç°äº† client çš„ç±»å‹å±äº HeaderExchangeClientï¼Œä¹Ÿå°±æ„å‘³ç€ HeaderExchangeClient å®Œæˆäº†åŒæ­¥è½¬å¼‚æ­¥çš„é€»è¾‘æ“ä½œã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/09/2c/09f6334b9d3798fb1404d216e6e7072c.jpg?wh=4665x2751)

### 9. NettyClient

ä»ç„¶æ²¡æœ‰çœ‹åˆ°æ•°æ®æ˜¯æ€ä¹ˆå‘é€çš„ï¼Œæˆ‘ä»¬ç»§ç»­æ·±å…¥ HeaderExchangeClient çš„ request æ–¹æ³•ä¸­ï¼ŒDebug å‡ æ­¥åå‘ç°ï¼Œè¿›å…¥äº†æŠ½è±¡ç±» AbstractPeer çš„ send æ–¹æ³•ã€‚

```java
///////////////////////////////////////////////////                  
// org.apache.dubbo.remoting.transport.AbstractPeer#send
// thisï¼šNettyClient
// NettyClient è´Ÿè´£å’Œæä¾›æ–¹æœåŠ¡å»ºç«‹è¿æ¥ã€å‘é€æ•°æ®ç­‰æ“ä½œ
///////////////////////////////////////////////////
@Override
public void send(Object message) throws RemotingException {
    send(message, url.getParameter(Constants.SENT_KEY, false));
}
```

é€»è¾‘ä¹ŸæŒºç®€å•ã€‚

- ä»ä»£ç æµç¨‹æ¥çœ‹ï¼Œæ²¡æœ‰è¿‡å¤šçš„é€»è¾‘åŒ…è£…ï¼Œç›´æ¥æŠŠå…¥å‚äº¤ç»™äº†å¦å¤–ä¸€ä¸ªé‡è½½çš„ send æ–¹æ³•ã€‚
- ä»æ–¹æ³•çš„å…¥å‚å’Œè¿”å›å€¼æ¥çœ‹ï¼Œå…¥å‚æ˜¯è¯·æ±‚å¯¹è±¡ï¼Œæ²¡æœ‰è¿”å‚ï¼Œå¹¶ä¸”æ–¹æ³•ä¸Šå£°æ˜äº† RemotingException å¼‚å¸¸ï¼Œè¯´æ˜è¿™é‡Œç¦»æ•°æ®çš„å‘é€åº”è¯¥å¾ˆè¿‘äº†ã€‚è‡³äºæ²¡æœ‰è¿”å›å€¼ï¼Œä¸»è¦æ˜¯å‰é¢ç”±åŒæ­¥è½¬äº†å¼‚æ­¥ï¼Œæ²¡æœ‰è¿”å›å€¼ä¹Ÿæ­£å¸¸ã€‚
- å†çœ‹çœ‹æ–¹æ³•å®ç°ä½“çš„ä¸€äº›ç»†èŠ‚ï¼ŒæŠ½è±¡ç±»çœ‹ä¸å‡ºä»€ä¹ˆï¼Œä½†æ˜¯ä»å †æ ˆå˜é‡çš„å¼•ç”¨å€¼å¯ä»¥å‘ç°ï¼Œå½“å‰çš„æŠ½è±¡ç±»æ˜¯ NettyClient çš„çˆ¶ç±»ã€‚

é‚£æˆ‘ä»¬ä» NettyClient çš„ send æ–¹æ³•ç»†çœ‹ï¼Œç»“æœå‘ç°äº†æœ€ç»ˆè°ƒç”¨äº† NioSocketChannel çš„ writeAndFlush æ–¹æ³•ï¼Œè¿™ä¸ªä¸å°±æ˜¯ Netty ç½‘ç»œé€šä¿¡æ¡†æ¶çš„ API ä¹ˆï¼Ÿ

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬åœ¨ä»£ç å±‚é¢è§£é‡Šäº†æ•°æ®åŸæ¥æ˜¯é€šè¿‡ Netty æ¡†æ¶çš„ NioSocketChannel å‘é€å‡ºå»çš„ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/01/39/0187c8492bd188b1a2c29be081753339.jpg?wh=4665x2832)

### 10. NettyCodecAdapter

ä¸€æ—¦è¿›å…¥åˆ° Netty æ¡†æ¶ï¼Œå†é€šè¿‡æ–­ç‚¹ä¸€æ­¥æ­¥è·Ÿè¸ªæ•°æ®å°±æœ‰ç‚¹éš¾äº†ï¼Œå› ä¸º Netty æ¡†æ¶å†…éƒ¨å¤„å¤„éƒ½æ˜¯â€œçº¿ç¨‹+é˜Ÿåˆ—â€çš„å¼‚æ­¥æ“ä½œæ–¹å¼ï¼Œè¿™é‡Œæˆ‘ä»¬èµ°ä¸ªæ·å¾„ï¼Œè¿›å…¥ NettyClient ç±»ï¼Œæ‰¾æ‰¾åˆå§‹åŒ– NettyClient çš„ç›¸å…³ Netty å±‚é¢çš„é…ç½®ã€‚

ä½ ä¼šæ‰¾åˆ°ä¸€ä¸ª NettyCodecAdapter ç±»ï¼Œå¯¹æ•°æ®è¿›è¡Œç¼–è§£ç ï¼Œç›´æ¥åœ¨ç±»ä¸­çš„ encode æ–¹æ³•æ‰“ä¸ªæ–­ç‚¹ï¼Œç­‰æ–­ç‚¹è¿‡æ¥ã€‚

```java
///////////////////////////////////////////////////                  
// org.apache.dubbo.remoting.transport.netty4.NettyCodecAdapter.InternalEncoder#encode
// å°†å¯¹è±¡æŒ‰ç…§ä¸€å®šçš„åºåˆ—åŒ–æ–¹å¼å‘é€å‡ºå»
///////////////////////////////////////////////////
private class InternalEncoder extends MessageToByteEncoder {

    @Override
    protected void encode(ChannelHandlerContext ctx, Object msg, ByteBuf out) throws Exception {
        ChannelBuffer buffer = new NettyBackedChannelBuffer(out);
        Channel ch = ctx.channel();
        NettyChannel channel = NettyChannel.getOrAddChannel(ch, url, handler);
        codec.encode(channel, buffer, msg);
    }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œç¼–ç çš„æ–¹æ³•ç®€å•å¹²è„†ã€‚

- ä»ä»£ç æµç¨‹çœ‹ï¼Œè°ƒç”¨äº†ä¸€ä¸ª codec ç¼–ç å™¨çš„å˜é‡ï¼Œå¯¹å…¥å‚ç¼–ç å¤„ç†ã€‚
- ä»æ–¹æ³•çš„å…¥å‚å’Œè¿”å›å€¼çœ‹ï¼Œmsg æ˜¯è¯·æ±‚æ•°æ®å¯¹è±¡ï¼Œout å˜é‡æ˜¯ ByteBuf ç¼“å†²åŒºï¼Œåº”è¯¥æ˜¯å°† msg ç¼–ç ä¹‹åçš„æ•°æ®æµã€‚
- å†çœ‹çœ‹æ–¹æ³•å®ç°ä½“çš„ä¸€äº›ç»†èŠ‚ï¼Œæ²¡ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„ï¼Œæ— éå°±æ˜¯èµ°åç»­ç¼–è§£ç å™¨çš„ç¼–ç æ–¹æ³•ï¼Œç¼–ç å®Œæˆåï¼Œå†é€šè¿‡ Netty æ¡†æ¶æŠŠæ•°æ®æµå‘é€å‡ºå»ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/1f/1c/1ffc5804fb4eed68cbd594c35b296d1c.jpg?wh=4668x2895)

## è°ƒç”¨æµç¨‹çš„å…¶ä»–æ¡ˆä¾‹

ç»è¿‡æ¼«é•¿çš„åæ­¥æ–­ç‚¹ï¼Œæˆ‘ä»¬æŠŠæ¶ˆè´¹æ–¹çš„è°ƒç”¨æµç¨‹å¤§è‡´ä¸²äº†èµ·æ¥ï¼Œè™½è¯´è¿‡ç¨‹æœ‰ç‚¹æ›²æŠ˜ï¼Œä½†æœ€ç»ˆçš„è‰°è¾›æ˜¯å€¼å¾—çš„ï¼Œå¯¹äºä½ ç†è§£æ¡†æ¶è°ƒç”¨çš„æ¥é¾™å»è„‰å¾ˆé‡è¦ï¼Œè€Œä¸”æœªæ¥ä½ ä¼šä½“ä¼šåˆ°ï¼Œå½“è°ƒç”¨ç¯èŠ‚å‘ç”Ÿäº†å¼‚å¸¸ï¼Œä½ åªè¦è®¤çœŸå›å¿†ä¸€ä¸‹å¼‚å¸¸åœ¨å“ªä¸ªç¯èŠ‚ï¼Œç„¶åç»“åˆä»£ç ç®€å•åˆ†æä¸€ä¸‹ï¼Œå¾ˆå¿«å°±èƒ½åˆ†æå‡ºåŸå› æ¥ã€‚

æ¶ˆè´¹æ–¹çš„è°ƒç”¨æµç¨‹å°±æ˜¯è¿™ä¹ˆä¸€æ­¥æ­¥è°ƒè¯•åˆ†æå‡ºæ¥çš„ï¼Œé‚£è¿˜æœ‰å“ªäº›å…¸å‹çš„æµç¨‹ï¼Œå¯ä»¥æŒ‰è¿™ä¸ªæ€è·¯ä¸€æ­¥æ­¥è°ƒè¯•åˆ†æå‡ºè°ƒç”¨æµç¨‹å‘¢ï¼Ÿæˆ‘å°±åˆ—ä¸¾ä¸‰ä¸ªæ¯”è¾ƒå…¸å‹çš„ï¼Œä½ è¯¾åå¯ä»¥ç»ƒç»ƒæ‰‹ã€‚

ç¬¬ä¸€ï¼ŒTomcat å®¹å™¨æ¥æ”¶è¯·æ±‚æµç¨‹ï¼Œé€šè¿‡åœ¨ HttpServlet çš„ service æ–¹æ³•æ‰“ä¸ªæ–­ç‚¹ï¼Œä»è°ƒç”¨å †æ ˆçš„æœ€ä¸‹é¢å¼€å§‹ï¼Œå¯ä»¥åˆ†æå‡º Tomcat çš„æ•´ä½“æ¶æ„ã€‚

ç¬¬äºŒï¼ŒSpringMvc å¤„ç†è¯·æ±‚çš„æµç¨‹ï¼Œé€šè¿‡åœ¨ Controller çš„ä»»æ„æ–¹æ³•æ‰“ä¸ªæ–­ç‚¹ï¼Œå°±å¯ä»¥é€æ­¥åˆ†æå‡ºä¸€ä¸ª SpringMvc å¤„ç†è¯·æ±‚çš„å¤§è‡´æµç¨‹æ¡†æ¶ã€‚

ç¬¬ä¸‰ï¼ŒSpring çš„ getBean æ–¹æ³•ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•çš„å±‚å±‚æ·±å…¥ï¼Œå¯ä»¥åˆ†æå‡ºä¸€ä¸ªåºå¤§çš„ Spring å¯¹è±¡ç”Ÿæˆä½“ç³»ï¼Œä¹Ÿèƒ½æŒ–æ˜å‡ºéå¸¸å¤š Spring å„ç§æ“æ§å¯¹è±¡çš„æ‰©å±•æœºåˆ¶ã€‚

## æ€»ç»“

ä»Šå¤©ï¼Œä»ä¸€ä¸ªè¢« @DubboReference æ ‡è¯†çš„å¸¸è§„æˆå‘˜å˜é‡å¼€å§‹ï¼Œæˆ‘ä»¬æŠ›å‡ºäº†ä¸¤ä¸ªé—®é¢˜ï¼Œå˜é‡çš„å€¼ç±»å‹åœ¨è¿è¡Œæ—¶æ˜¯å¦æ˜¯è§åˆ°çš„ç±»å‹ï¼Œåœ¨æ¶ˆè´¹æ–¹å‘èµ·è°ƒç”¨æ—¶ä¼šç»è¿‡æ€æ ·çš„è°ƒç”¨æµç¨‹ä½“ç³»ã€‚

å¸¦ç€è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ç”¨æœ€æ™®é€šçš„ Debug è°ƒè¯•æ–¹å¼ï¼Œå€Ÿé‰´ 12 å­—æ–¹é’ˆæ·±å…¥è·Ÿè¸ªè°ƒç”¨æµç¨‹çš„æºç ï¼Œè¾¹åˆ†æã€è¾¹ç»˜å›¾ï¼Œæ­¥æ­¥ä¸ºè¥ï¼Œæœ€ç»ˆæ¢³ç†å‡ºäº†æ¶ˆè´¹æ–¹è°ƒç”¨æµç¨‹çš„å¤§ä½“æ¡†æ¶ã€‚**ä½ è¿˜å¯ä»¥å’Œâ€œæºç æ¡†æ¶â€ä¸­å­¦è¿‡çš„åˆ†å±‚æ¨¡å—è”ç³»åˆ°ä¸€èµ·å¤ä¹ ã€‚**

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/77/ba/77d06f89cf3731bf52488f109a26c6ba.jpg?wh=5412x2895)

æ€»ç»“ä¸€ä¸‹è·Ÿè¸ªæºç çš„ 12 å­—æ–¹é’ˆã€‚

- â€œä¸é’»ç»†èŠ‚ï¼šåªçœ‹æµç¨‹ã€‚â€ä»£ç è™½ç„¶å¤šï¼Œä½†æˆ‘ä»¬ä¸å¿…ç ”ç©¶æ¯ä¸ªç»†èŠ‚ï¼Œè¦å…ˆæ¡æ–¹æ³•ä¸­çš„é‡è¦åˆ†æ”¯æµç¨‹ï¼Œä¸€äº›æå‰è¿”å›çš„è¾¹è¾¹è§’è§’çš„æµç¨‹ä¸€æ¦‚å¿½ç•¥ä¸çœ‹ã€‚
- â€œä¸çœ‹è¿‡ç¨‹ï¼šåªçœ‹ç»“è®ºã€‚â€æ¯ä¸ªæ–¹æ³•çš„ä»£ç é€»è¾‘å¯é•¿å¯çŸ­ï¼Œæˆ‘ä»¬å¯ä»¥é‡ç‚¹ç ”ç©¶è¿™ä¸ªæ–¹æ³•éœ€è¦ä»€ä¹ˆå…¥å‚ï¼Œåˆèƒ½ç»™å‡ºä»€ä¹ˆè¿”å‚ï¼Œä»¥æ­¤æ¨æµ‹æ–¹æ³•åœ¨å¹²ä»€ä¹ˆï¼Œåˆ°åº•è¦å®Œæˆä¸€ä»¶ä»€ä¹ˆæ ·çš„äº‹æƒ…ï¼Œææ¸…æ¥šå¹¶å¾—å‡ºç»“è®ºã€‚
- â€œå†çœ‹ç»†èŠ‚ï¼šå†çœ‹è¿‡ç¨‹ã€‚â€å½“ä½ æŒ‰ç…§å‰ä¸¤ç‚¹è®¤çœŸè°ƒè¯•åï¼Œå¤§æ¦‚çš„è°ƒç”¨æµç¨‹ä½“ç³»å°±æ¸…æ¥šäº†ã€‚åœ¨æ­¤åŸºç¡€ä¹‹ä¸Šï¼Œå†æ¥ç»†çœ‹è¢«é—å¿˜çš„è¾¹è§’æ–™ä»£ç ï¼Œæœ‰åŠ©äºä½ è¿›ä¸€æ­¥ä¸°å¯Œè°ƒç”¨æµç¨‹å›¾ï¼Œä½“ä¼šæºç ç»†èŠ‚ä¸­é‚£äº›ç¼œå¯†çš„æ€ç»´é€»è¾‘ã€‚

### æ€è€ƒé¢˜

ç•™ä¸ªä½œä¸šï¼Œæ¶ˆè´¹æ–¹çš„æ™®é€šè°ƒç”¨ä¼šç»å†å“ªäº›æµç¨‹ä½ å·²ç»ååˆ†ç†Ÿæ‚‰äº†ï¼Œå¯ä»¥ç ”ç©¶æ¶ˆè´¹æ–¹è¿›è¡Œæ³›åŒ–è°ƒç”¨æ—¶ä¼šç»å†å“ªäº›æµç¨‹ï¼Œä»¥åŠæ³›åŒ–è°ƒç”¨çš„åº•å±‚æ˜¯æ€ä¹ˆå®ç°çš„ï¼ŸåŠ¨æ‰‹ç»ƒä¹ ä¸€ä¸‹ã€‚

æœŸå¾…çœ‹åˆ°ä½ çš„å›ç­”ï¼Œå¦‚æœè§‰å¾—ä»Šå¤©çš„å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ä¸€èµ·è®¨è®ºã€‚æˆ‘ä»¬ä¸‹ä¸€è®²è§ã€‚

### 20 æ€è€ƒé¢˜å‚è€ƒ

ä¸Šä¸€æœŸç•™äº†ä¸ªä½œä¸šï¼Œç ”ç©¶ä¸‹æ¶ˆè´¹æ–¹æ¥æ”¶ zookeeper æœåŠ¡ç«¯äº‹ä»¶å˜æ›´çš„åœ°æ–¹åœ¨å“ªé‡Œã€‚

æƒ³è¦è§£ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¾—ä»æ·»åŠ ç›‘å¬çš„èµ·æºçœ‹èµ·ï¼Œåªæœ‰çŸ¥é“æ·»åŠ ç›‘å¬å¹²äº†äº›ä»€ä¹ˆäº‹æƒ…ï¼Œé¢„ç•™äº†ä»€ä¹ˆå›è°ƒï¼Œæˆ‘ä»¬æ‰èƒ½è¿›ä¸€æ­¥æ‰¾åˆ°æ¥æ”¶çš„åœ°æ–¹ã€‚

æˆ‘ä»¬ç›´æ¥è¿›å…¥ doSubscribe æ–¹æ³•ä¸­çœ‹çœ‹ï¼Œåˆ°åº•æ·»åŠ äº†ä»€ä¹ˆç›‘å¬ï¼Ÿç›‘å¬å¯¹åº”çš„å®ç°ç±»æ˜¯å“ªä¸ªï¼Ÿ

```java
///////////////////////////////////////////////////                  
// org.apache.dubbo.registry.zookeeper.ZookeeperRegistry#doSubscribe
// è®¢é˜…çš„æ ¸å¿ƒé€»è¾‘ï¼Œè¯»å– zk ç›®å½•ä¸‹çš„æ•°æ®ï¼Œç„¶åé€šçŸ¥åˆ·æ–°å†…å­˜ä¸­çš„æ•°æ®
///////////////////////////////////////////////////
@Override
public void doSubscribe(final URL url, final NotifyListener listener) {
    try {
        checkDestroyed();
        // å› ä¸ºè¿™é‡Œç”¨ * å·åŒ¹é…ï¼Œæˆ‘ä»¬åœ¨çœŸå®çš„çº¿ä¸Šç¯å¢ƒä¹Ÿä¸å¯èƒ½å°†æœåŠ¡æ¥å£é…ç½®ä¸º * å·
        // å› æ­¤è¿™é‡Œçš„ * å·é€»è¾‘æš‚ä¸”è·³è¿‡ï¼Œç›´æ¥çœ‹åé¢çš„å…·ä½“æ¥å£çš„é€»è¾‘
        if ("*".equals(url.getServiceInterface())) {
            // çœç•¥å…¶ä»–éƒ¨åˆ†ä»£ç ...
        } 
        // èƒ½æ¥åˆ°è¿™é‡Œï¼Œè¯´æ˜ ServiceInterface ä¸æ˜¯ * å·
        // url.getServiceInterface() = com.hmilyylimh.cloud.facade.demo.DemoFacade
        else {
            CountDownLatch latch = new CountDownLatch(1);
            try {
                List<URL> urls = new ArrayList<>();
                // toCategoriesPath(url) å¾—å‡ºæ¥çš„é›†åˆæœ‰ä»¥ä¸‹å‡ ç§ï¼š
                // 1ã€/dubbo/com.hmilyylimh.cloud.facade.demo.DemoFacade/providers
                // 2ã€/dubbo/com.hmilyylimh.cloud.facade.demo.DemoFacade/configurators
                // 3ã€/dubbo/com.hmilyylimh.cloud.facade.demo.DemoFacade/routers
                for (String path : toCategoriesPath(url)) {
                    ConcurrentMap<NotifyListener, ChildListener> listeners = zkListeners.computeIfAbsent(url, k -> new ConcurrentHashMap<>());
                    ChildListener zkListener = listeners.computeIfAbsent(listener, k -> new RegistryChildListenerImpl(url, path, k, latch));
                    if (zkListener instanceof RegistryChildListenerImpl) {
                        ((RegistryChildListenerImpl) zkListener).setLatch(latch);
                    }
                    // å‘ zk åˆ›å»ºæŒä¹…åŒ–ç›®å½•ï¼Œä¸€ç§å®¹é”™æ–¹å¼ï¼Œæ‹…å¿ƒç›®å½•è¢«è°æ„å¤–çš„å¹²æ‰äº†
                    zkClient.create(path, false);
                    
                    // !!!!!!!!!!!!!!!!
                    // è¿™æ®µé€»è¾‘å¾ˆé‡è¦äº†ï¼Œæ·»åŠ å¯¹ path ç›®å½•çš„ç›‘å¬ï¼Œ
                    // æ·»åŠ ç›‘å¬å®Œæˆåï¼Œè¿˜èƒ½æ‹¿åˆ° path è·¯å¾„ä¸‹æ‰€æœ‰çš„ä¿¡æ¯
                    // é‚£å°±æ„å‘³ç€ç›‘å¬ä¸€æ—¦æ·»åŠ å®Œæˆï¼Œé‚£ä¹ˆå°±èƒ½ç«‹é©¬è·å–åˆ°è¯¥ DemoFacade æ¥å£åˆ°åº•æœ‰å¤šå°‘ä¸ªæä¾›æ–¹èŠ‚ç‚¹
                    List<String> children = zkClient.addChildListener(path, zkListener);
                    // å°†è¿”å›çš„ä¿¡æ¯å…¨éƒ¨æ·»åŠ åˆ° urls é›†åˆä¸­
                    if (children != null) {
                        urls.addAll(toUrlsWithEmpty(url, path, children));
                    }
                }
                
                // ä» zk æ‹¿åˆ°äº†æ‰€æœ‰çš„ä¿¡æ¯åï¼Œç„¶åè°ƒç”¨ notify æ–¹æ³•
                // url.get(0) = dubbo://192.168.100.183:28200/com.hmilyylimh.cloud.facade.demo.DemoFacade?anyhost=true&application=dubbo-20-subscribe-consumer&background=false&check=false&deprecated=false&dubbo=2.0.2&dynamic=true&generic=false&interface=com.hmilyylimh.cloud.facade.demo.DemoFacade&methods=sayHello,say&register-mode=interface&release=3.0.7&side=provider
                // url.get(1) = empty://192.168.100.183/com.hmilyylimh.cloud.facade.demo.DemoFacade?application=dubbo-20-subscribe-consumer&background=false&category=configurators&dubbo=2.0.2&interface=com.hmilyylimh.cloud.facade.demo.DemoFacade&methods=sayHello,say&pid=11560&qos.enable=false&release=3.0.7&side=consumer&sticky=false&timestamp=1670846788876
                // url.get(2) = empty://192.168.100.183/com.hmilyylimh.cloud.facade.demo.DemoFacade?application=dubbo-20-subscribe-consumer&background=false&category=routers&dubbo=2.0.2&interface=com.hmilyylimh.cloud.facade.demo.DemoFacade&methods=sayHello,say&pid=11560&qos.enable=false&release=3.0.7&side=consumer&sticky=false&timestamp=1670846788876
                notify(url, listener, urls);
            } finally {
                // tells the listener to run only after the sync notification of main thread finishes.
                latch.countDown();
            }
        }
    } catch (Throwable e) {
        throw new RpcException("Failed to subscribe " + url + " to zookeeper " + getUrl() + ", cause: " + e.getMessage(), e);
    }
}
```

å†æ¬¡å›åˆ°äº†è¿™æ®µä»£ç ä¸­ï¼Œè¿™æ¬¡æˆ‘ä»¬æ˜¯æœ‰é’ˆå¯¹æ€§åœ°å¯»æ‰¾ç›‘å¬å™¨ç±»äº†ï¼Œçœ¼å°–çš„ä½ ï¼Œç›¸ä¿¡å¾ˆå¿«å°±çœ‹åˆ°äº† RegistryChildListenerImpl è¿™ä¸ªç±»ï¼Œä»åå­—ä¸Šçœ‹ï¼Œæ˜¯å­èŠ‚ç‚¹çš„ç›‘å¬å®ç°ç±»ï¼Œæ—¢ç„¶èƒ½åœ¨è¿™æ®µå®ç°å…¨æµç¨‹é€»è¾‘ï¼Œé‚£æ¯«æ— ç–‘é—®å¾—è¿›å…¥ RegistryChildListenerImpl è¿™ä¸ªç±»å»çœ‹çœ‹ã€‚

```java
///////////////////////////////////////////////////                  
// org.apache.dubbo.registry.zookeeper.ZookeeperRegistry.RegistryChildListenerImpl
// å­èŠ‚ç‚¹ç›®å½•ç›‘å¬å˜æ›´ç±»
///////////////////////////////////////////////////
private class RegistryChildListenerImpl implements ChildListener {
    private RegistryNotifier notifier;
    private long lastExecuteTime;
    private volatile CountDownLatch latch;

    public RegistryChildListenerImpl(URL consumerUrl, String path, NotifyListener listener, CountDownLatch latch) {
        this.latch = latch;
        notifier = new RegistryNotifier(getUrl(), ZookeeperRegistry.this.getDelay()) {
            @Override
            public void notify(Object rawAddresses) {
                // è·å–å»¶æ—¶æ—¶é—´
                long delayTime = getDelayTime();
                // è‹¥å»¶æ—¶æ—¶é—´å°äºæˆ–ç­‰äº 0 çš„è¯ï¼Œå°±ç›´æ¥æ‰§è¡Œ RegistryNotifier å†…éƒ¨ç±»çš„ doNotify æ–¹æ³•
                if (delayTime <= 0) {
                    this.doNotify(rawAddresses);
                } else {
                    // å¦åˆ™å°±è®¡ç®—ã€å½“å‰æ—¶é—´ã€‘å‡å»ã€ä¸Šä¸€æ¬¡æ‰§è¡Œæ—¶é—´ã€‘å¾—åˆ°ä¸€ä¸ªå·®å€¼
                    // è‹¥ delayTime å¤§äºè¿™ä¸ªå·®å€¼çš„è¯ï¼Œé‚£å°±ç»§ç»­ç¡çœ ä¸‹
                    // å¦åˆ™åˆç«‹é©¬æ‰§è¡Œ RegistryNotifier å†…éƒ¨ç±»çš„ doNotify æ–¹æ³•
                    long interval = delayTime - (System.currentTimeMillis() - lastExecuteTime);
                    if (interval > 0) {
                        try {
                            Thread.sleep(interval);
                        } catch (InterruptedException e) {
                            // ignore
                        }
                    }
                    lastExecuteTime = System.currentTimeMillis();
                    this.doNotify(rawAddresses);
                }
            }

            @Override
            protected void doNotify(Object rawAddresses) {
                ZookeeperRegistry.this.notify(consumerUrl, listener, ZookeeperRegistry.this.toUrlsWithEmpty(consumerUrl, path, (List<String>) rawAddresses));
            }
        };
    }
    // è®¾ç½®è®¡æ•°å™¨æ¦‚å¿µçš„åŒæ­¥å·¥å…·ç±»
    public void setLatch(CountDownLatch latch) {
        this.latch = latch;
    }
    // æ„ŸçŸ¥åˆ°èŠ‚ç‚¹æœ‰å˜æ›´ï¼Œè¯¥æ–¹æ³•æ˜¯åˆ«å…¶ä»–åœ°æ–¹å›è°ƒçš„
    @Override
    public void childChanged(String path, List<String> children) {
        // path = /dubbo/com.hmilyylimh.cloud.facade.demo.DemoFacade/providers
        // children.get(0) = dubbo://192.168.100.183:28200/com.hmilyylimh.cloud.facade.demo.DemoFacade?anyhost=true&application=dubbo-20-subscribe-consumer&background=false&deprecated=false&dubbo=2.0.2&dynamic=true&generic=false&interface=com.hmilyylimh.cloud.facade.demo.DemoFacade&methods=sayHello,say&pid=8552&register-mode=interface&release=3.0.7&side=provider&timestamp=1670859852464
        // children.get(1) = dubbo://192.168.100.183:28200/com.hmilyylimh.cloud.facade.demo.DemoFacade?anyhost=true&application=dubbo-20-subscribe-consumer&background=false&deprecated=false&dubbo=2.0.2&dynamic=true&generic=false&interface=com.hmilyylimh.cloud.facade.demo.DemoFacade&methods=sayHello,say&pid=10568&register-mode=interface&release=3.0.7&side=provider&timestamp=1670859874187
        // children.get(2) = dubbo://192.168.100.183:28200/com.hmilyylimh.cloud.facade.demo.DemoFacade?anyhost=true&application=dubbo-20-subscribe-consumer&background=false&deprecated=false&dubbo=2.0.2&dynamic=true&generic=false&interface=com.hmilyylimh.cloud.facade.demo.DemoFacade&methods=sayHello,say&pid=12988&register-mode=interface&release=3.0.7&side=provider&timestamp=1670859893317
        try {
            latch.await();
        } catch (InterruptedException e) {
            logger.warn("Zookeeper children listener thread was interrupted unexpectedly, may cause race condition with the main thread.");
        }
        // èŠ‚ç‚¹å˜æ›´é€šçŸ¥ï¼Œç›´æ¥è°ƒç”¨çš„æ˜¯ä¸Šé¢ RegistryNotifier å†…éƒ¨ç±»ä¸­çš„ notify æ–¹æ³•
        notifier.notify(children);
    }
}
```

é€šè¿‡è¿™æ®µä»£ç æˆ‘ä»¬çœ‹åˆ°äº†è‹¥ childChanged æ–¹æ³•å‘ç”Ÿäº†å›è°ƒï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šè°ƒç”¨åˆ° ZookeeperRegistry çš„ notify æ–¹æ³•ã€‚è™½ç„¶æˆ‘ä»¬æ‰¾åˆ°äº† Dubbo é’ˆå¯¹ zookeeper ç›®å½•ç›‘å¬å›è°ƒçš„åœ°æ–¹ï¼Œä½†æ˜¯åˆ°åº•æ˜¯è°è°ƒç”¨äº†è¿™ä¸ª childChanged æ–¹æ³•å‘¢ï¼Ÿ

è¿™ä¸ªæ—¶å€™ï¼Œåˆå¾—ä½¿å‡ºæˆ‘ä»¬çš„ Debug ç»æ‹›äº†ï¼Œä½ å¯ä»¥æŒ‰æ­¥éª¤æ“ä½œã€‚

- æ­¥éª¤ä¸€ï¼Œå¯åŠ¨æä¾›æ–¹ã€‚
- æ­¥éª¤äºŒï¼Œå¯åŠ¨æ¶ˆè´¹æ–¹ã€‚
- æ­¥éª¤ä¸‰ï¼Œåœ¨ RegistryChildListenerImpl ç±»ä¸­çš„ childChanged æ–¹æ³•æ‰“ä¸ªæ–­ç‚¹ã€‚
- æ­¥éª¤å››ï¼Œå…³é—­æä¾›æ–¹ã€‚
- æ­¥éª¤äº”ï¼Œå¯åŠ¨æä¾›æ–¹ã€‚

å°±èƒ½çœ‹åˆ°æ–­ç‚¹çš„åˆ°æ¥äº†ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/38/3a/3805f9a2e330d32a74e313ac5d3af23a.jpg?wh=4857x1770)

é€šè¿‡å¯¹æ–­ç‚¹è°ƒç”¨æ ˆçš„åˆ†æï¼ŒçœŸç›¸ä¹Ÿå°±æ¸…æ™°äº†ï¼ŒåŸæ¥ dubbo æ¡†æ¶å¼•ç”¨äº† curator æ’ä»¶æ¥ä¸ zookeeper è¿›è¡Œäº¤äº’ï¼Œcurator æ’ä»¶ä¼šå®æ—¶æ„ŸçŸ¥ zookeeper æœåŠ¡ç«¯å‘é€çš„äº‹ä»¶å˜æ›´ï¼Œç„¶å curator å†é€šè¿‡ä¸€å®šçš„å›è°ƒå¤„ç†ï¼Œå°±è°ƒç”¨åˆ°äº† RegistryChildListenerImpl ç±»ä¸­çš„ childChanged æ–¹æ³•ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ4ï¼‰</strong></div><ul>
<li><span>Lum</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è¯»å®Œåæ„Ÿè§‰å¿ƒæ€æœ‰ç‚¹ç‚¸ï¼Œæœ‰ç‚¹çº ç»“è¿™ä¸€æ­¥æ­¥çš„invokeræ˜¯æ€ä¹ˆç»„è£…èµ·æ¥çš„ï¼Œdubboå¤ªå¤æ‚äº†ã€‚</p>2023-03-02</li><br/><li><span>Nights</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>InvokerInvocationHandlerã€‹MigrationInvokerã€‹MockClusterInvokerã€‹FailoverClusterInvokerã€‹DubboInvoker
è¿™ä¸ª invoker è°ƒç”¨é“¾è·¯æ˜¯æ€ä¹ˆçœ‹å‡ºæ¥çš„ï¼Ÿ</p>2023-02-06</li><br/><li><span>å¼ å°å‡¡</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>dubbo invokerå¦‚ä½•ç†è§£ï¼Ÿ</p>2023-03-07</li><br/><li><span>Wallace Pang</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>&quot;ä¸é’»ç»†èŠ‚ï¼Œåªçœ‹æµç¨‹ï¼›ä¸çœ‹è¿‡ç¨‹ï¼Œåªçœ‹ç»“è®ºï¼›å†çœ‹ç»†èŠ‚ï¼Œå†çœ‹è¿‡ç¨‹&quot; 16å­—æ–¹é’ˆ</p>2023-02-23</li><br/>
</ul>