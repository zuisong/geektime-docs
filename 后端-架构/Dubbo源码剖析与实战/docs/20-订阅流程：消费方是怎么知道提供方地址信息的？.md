ä½ å¥½ï¼Œæˆ‘æ˜¯ä½•è¾‰ã€‚ä»Šå¤©æˆ‘ä»¬æ·±å…¥ç ”ç©¶Dubboæºç çš„ç¬¬ä¹ç¯‡ï¼Œè®¢é˜…æµç¨‹ã€‚

ä¸Šä¸€è®²ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ @DubboService æ³¨è§£ï¼ŒæŒ–å‡ºäº†æœåŠ¡å‘å¸ƒçš„å†…å¹•ï¼Œæ‰¾åˆ°äº† ServiceBean çš„ Bean å®šä¹‰ã€ServiceConfig çš„å¯¼å‡ºå…³é”®èŠ‚ç‚¹ï¼Œå‘ç°äº†æœ¬åœ°å¯¼å‡ºå’Œè¿œç¨‹å¯¼å‡ºï¼Œåœ¨è¿œç¨‹å¯¼å‡ºçš„è¿‡ç¨‹ä¸­è¿˜é¡ºä¾¿è¿›è¡Œäº†æœåŠ¡æ³¨å†Œã€‚å¯ä»¥è¯´ï¼Œå‘å¸ƒæµç¨‹ä¸ºæä¾›æ–¹åšè¶³äº†æä¾›æœåŠ¡çš„å‡†å¤‡ã€‚

ä½†æ˜¯ï¼Œæ¶ˆè´¹æ–¹ï¼Œå‘æä¾›æ–¹å‘èµ·è°ƒç”¨æ—¶ï¼Œå¹¶æ²¡æœ‰è®¾ç½®éœ€è¦è°ƒç”¨æä¾›æ–¹çš„å“ªä¸ªåœ°å€ï¼Œå´èƒ½ç¥ä¸çŸ¥é¬¼ä¸è§‰åœ°è°ƒé€šæä¾›æ–¹ï¼Œå¹¶æ‹¿åˆ°ç»“æœã€‚æ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ã€‚**é‚£æ¶ˆè´¹æ–¹åˆ°åº•æ˜¯æ€ä¹ˆçŸ¥é“æä¾›æ–¹çš„åœ°å€å‘¢ï¼Ÿ**

åœ¨â€œ[æ¸©æ•…çŸ¥æ–°](https://time.geekbang.org/column/article/611355)â€ä¸­ï¼Œæˆ‘ä»¬å­¦è¿‡æ¶ˆè´¹æ–¹å¦‚ä½•å‘èµ·è°ƒç”¨ï¼Œå¯ä»¥ç”¨ &lt;dubbo:reference/&gt; æ ‡ç­¾å¼•ç”¨æä¾›æ–¹æœåŠ¡æ¥å‘èµ·è°ƒç”¨ï¼Œæˆ–è€…æ¢æˆ @DubboReference æ³¨è§£ä¹Ÿå¯ä»¥ã€‚ä¸ç®¡ä½¿ç”¨æ ‡ç­¾ï¼Œè¿˜æ˜¯æ³¨è§£ï¼Œæˆ‘ä»¬éƒ½æ˜¯åœ¨æƒ³åŠæ³•æ‹¿åˆ°è°ƒç”¨æä¾›æ–¹çš„ä¸€ä¸ªå¼•ç”¨å¥æŸ„è€Œå·²ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€†å‘æ’æŸ¥ @DubboReference æ³¨è§£ï¼Œæ¥è¿›ä¸€æ­¥æ¢ç´¢ä»Šå¤©çš„é—®é¢˜ã€‚

## å¯¹æ¯”å¤ä¹ 

æåˆ°é€šè¿‡ @DubboReferenceï¼Œæ—©åœ¨ä¹‹å‰çš„â€œæ³›åŒ–è°ƒç”¨â€ä¸­ï¼Œæˆ‘ä»¬å°±é€†å‘æŸ¥æ‰¾ @DubboReference æ³¨è§£ï¼Œæ‰¾åˆ°äº† ReferenceConfig è¿™ä¸ªæ ¸å¿ƒç±»ï¼Œé€šè¿‡è°ƒç”¨ ReferenceConfig çš„ get æ–¹æ³•ï¼Œæ‹¿åˆ°å¯ä»¥å‘ä¸‹æ¸¸å‘èµ·è°ƒç”¨çš„æ³›åŒ–å¯¹è±¡ã€‚

å‚è€ƒä¸Šä¸€è®²ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ç€å°† @DubboReferenceã€@DubboService ä¸¤ä¸ªæ³¨è§£å»¶ä¼¸å‡ºæ¥çš„çŸ¥è¯†ç‚¹æ¯”å¯¹æ€»ç»“ä¸€ä¸‹ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/82/9e/829d4d0609afd161013b2d0b53bdfb9e.jpg?wh=6054x2163)

å¤§ä½“å½¢å¼å·²ç»å¾ˆæ¸…æ™°äº†ï¼Œé‡ç‚¹çœ‹ä¸‰æ–¹é¢çš„å¯¹æ¯”ã€‚

- ä½œç”¨åŸŸï¼Œ@DubboService æ˜¯ä½œç”¨äºæä¾›æ–¹çš„ï¼Œè€Œ @DubboReference æ˜¯ä½œç”¨äºæ¶ˆè´¹æ–¹çš„ï¼›
- ç±»çš„åç§°ï¼Œ@DubboService ä¼šè½åˆ° ServiceConfig ä¸­è¿›è¡Œå¯¼å‡ºï¼Œè€Œ @DubboReference ä¼šè½åˆ° ReferenceConfig ä¸­è¿›è¡Œå¼•ç”¨ï¼›
- è¾å°„åŠŸèƒ½ï¼ŒServiceConfig ä¸­æ¶µç›–äº†æœ¬åœ°å¯¼å‡ºå’Œè¿œç¨‹å¯¼å‡ºä¸¤ä¸ªé‡è¦çš„åˆ†æ”¯é€»è¾‘ï¼Œä½†æ˜¯ ReferenceConfig è¿˜æš‚æ—¶ä¸æ¸…æ¥šã€‚

æœ‰æ²¡æœ‰å‘ç°ï¼Œè¿™äº›å°çŸ¥è¯†ç‚¹ä½ éƒ½å­¦è¿‡ã€‚å­¦çŸ¥è¯†ï¼Œè¶Šæ¯”è¾ƒï¼Œè¶Šèƒ½å‘ç°é—®é¢˜ï¼Œç„¶ååœ¨é€æ­¥è§£ç­”é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œä½ ä¼šå‘ç°å„ä¸ªçŸ¥è¯†ç‚¹å·²ç»èå…¥äº†ä½ çš„çŸ¥è¯†ä½“ç³»ä¸­ã€‚

è¯´å›æ¥ï¼Œè¿™é‡Œé€šè¿‡ç®€å•çš„å¯¹æ¯”ï¼Œæƒ³å¿…ä½ å¿ƒä¸­æœ‰äº†ç»§ç»­æ·±æŒ–çš„æ–¹å‘äº†ã€‚æ²¡é”™ï¼Œå°±æ˜¯ ReferenceConfig çš„ get æ–¹æ³•ï¼Œæˆ‘ä»¬æ·±å…¥çœ‹çœ‹ä¼šä¸ä¼šåƒ ServiceConfig ä¸€æ ·å‘ç°æ–°å¤§é™†ã€‚

```java
///////////////////////////////////////////////////
// org.apache.dubbo.config.ReferenceConfig#get
// å¼•ç”¨æä¾›æ–¹çš„æ ¸å¿ƒæ–¹æ³•
///////////////////////////////////////////////////
@Override
public T get() {
    // çœç•¥å…¶ä»–éƒ¨åˆ†ä»£ç ...
    if (ref == null) {
        // ensure start module, compatible with old api usage
        getScopeModel().getDeployer().start();
        synchronized (this) {
            // !!!!!!!!!!!!!!!!!!!!!!!!!!!!
            // é‡ç‚¹å…³æ³¨è¿™é‡Œ
            // å¦‚æœ ref å¯¹è±¡ä¸ºç©ºï¼Œè¿™å°±åˆå§‹åŒ–ä¸€ä¸ª
            // è¯´æ˜å¼•ç”¨æä¾›æ–¹çš„æ¯ä¸ªæ¥å£éƒ½æœ‰ç€ä¸ä¹‹å¯¹åº”çš„ä¸€ä¸ª ref å¯¹è±¡
            if (ref == null) {
                // åˆå§‹åŒ– ref å¯¹è±¡
                init();
            }
        }
    }
    return ref;
}
                  â†“
///////////////////////////////////////////////////                  
// org.apache.dubbo.config.ReferenceConfig#init
// åˆå§‹åŒ–çš„é€»è¾‘å¾ˆå¤šï¼Œè¿™é‡Œå°±ç›´æ¥æŒ‘é€‰æœ€é‡è¦çš„æ ¸å¿ƒé€»è¾‘ï¼Œåˆ›å»ºä»£ç†å¯¹è±¡æ–¹æ³•æ¥è·Ÿè¸ª
///////////////////////////////////////////////////
protected synchronized void init() {
    // çœç•¥å…¶ä»–éƒ¨åˆ†ä»£ç ...
    // è¿™é‡Œçœç•¥äº†ä¸€å¤§å †çš„å¼•ç”¨æä¾›æ–¹æ‰€è®¾ç½®çš„ä¸€äº›å‚æ•°
    // å°±æ˜¯é‚£äº›è®¾ç½®åœ¨ @DubboReference æ³¨è§£ä¸­çš„é…ç½®ï¼Œæœ€ç»ˆä¼šåœ¨ç»¼åˆä¸ºä¸€ä¸ª Map å¯¹è±¡
    // è€Œè¿™ä¸ªæ‰€è°“çš„ Map å¯¹è±¡å…¶å®å°±æ˜¯ referenceParameters è¿™ä¸ªå¼•ç”¨å‚æ•°å¯¹è±¡
    
    // æ ¹æ®å¼•ç”¨å‚æ•°åˆ›å»ºä»£ç†å¯¹è±¡
    ref = createProxy(referenceParameters);
    
    // çœç•¥å…¶ä»–éƒ¨åˆ†ä»£ç ...
}
                  â†“
///////////////////////////////////////////////////                  
// org.apache.dubbo.config.ReferenceConfig#createProxy
// åˆ›å»ºä»£ç†å¯¹è±¡çš„æ ¸å¿ƒé€»è¾‘ï¼šinjvmå¼•ç”¨ + è¿œç¨‹å¼•ç”¨ + ç”Ÿæˆä»£ç†å¯¹è±¡
///////////////////////////////////////////////////
private T createProxy(Map<String, String> referenceParameters) {
    // åˆ¤æ–­æ˜¯ä¸æ˜¯æŒ‰ç…§ injvm åè®®è¿›è¡Œå¼•ç”¨
    if (shouldJvmRefer(referenceParameters)) {
        createInvokerForLocal(referenceParameters);
    } 
    // èƒ½æ¥åˆ°è¿™é‡Œï¼Œè¯´æ˜ä¸æ˜¯ injvm åè®®ï¼Œé‚£å°±æŒ‰ç…§æ­£å¸¸çš„åè®®è¿›è¡Œå¼•ç”¨
    else {
        urls.clear();
        // url ä¸ä¸ºç©ºï¼Œè¯´æ˜æœ‰å•ç‹¬è¿›è¡Œç‚¹ç‚¹ç›´è¿çš„è¯‰æ±‚
        if (StringUtils.isNotEmpty(url)) {
            // user specified URL, could be peer-to-peer address, or register center's address.
            // å°†å¡«å†™çš„ url å­—ç¬¦ä¸²å†…å®¹è§£æä¸º URL å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ° urls é›†åˆä¸­å»
            // è¿™é‡Œæœ‰ä¸ªå°ç»†èŠ‚å°±æ˜¯ï¼Œè‹¥è§£æçš„è¿‡ç¨‹ä¸­å‘ç°æ˜¯æ³¨å†Œä¸­å¿ƒåœ°å€çš„è¯
            // é‚£ä¹ˆå°±ä¼šå°†æœåŠ¡å¼•ç”¨çš„ referenceParameters æ•´ä½“ä¿¡æ¯å½’åˆ°æ³¨å†Œä¸­å¿ƒåœ°å€çš„ "refer" å±æ€§ä¸Š
            // å°±åƒæœåŠ¡å¯¼å‡ºæ—¶ä¸€æ ·ï¼Œå°†æœåŠ¡æ¥å£çš„æ•´ä½“ä¿¡æ¯å½’åˆ°æ³¨å†Œä¸­å¿ƒåœ°å€çš„ "export" å±æ€§ä¸Š
            parseUrl(referenceParameters);
        } else {
            // if protocols not in jvm checkRegistry
            // å¦‚æœåè®®ä¸æ˜¯ injvm çš„è¯ï¼Œé‚£ä¹ˆè¿™é‡Œè¿˜ä¼šå†æ¬¡è·å–æœ€æ–°çš„æ³¨å†Œä¸­å¿ƒåœ°å€
            // å¦‚æœæœ€åå‘ç° urls ä¸­çš„é›†åˆä¸ºç©ºçš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šæŠ›å‡ºå¼‚å¸¸
            // ç›®çš„å°±æ˜¯æ£€æŸ¥ä¸€å®šå¾—æœ‰ urls å†…å®¹ï¼Œå¦åˆ™æ ¹æœ¬ä¸ç”¨èµ°åç»­çš„å¼•ç”¨é€»è¾‘äº†
            if (!"injvm".equalsIgnoreCase(getProtocol())) {
                aggregateUrlFromRegistry(referenceParameters);
            }
        }
        // ä¸ºè¿œç¨‹å¼•ç”¨åˆ›å»º invoker å¯¹è±¡
        createInvokerForRemote();
    }
    
    // çœç•¥å…¶ä»–éƒ¨åˆ†ä»£ç ...
    
    // åˆ›å»ºåˆšåˆšåˆ›å»ºå‡ºæ¥çš„ invoker å¯¹è±¡é€šè¿‡è°ƒç”¨ proxyFactory.getProxy æ–¹æ³•åŒ…è£…æˆä»£ç†å¯¹è±¡
    return (T) proxyFactory.getProxy(invoker, ProtocolUtils.isGeneric(generic));
}
```

æœç„¶ä» ReferenceConfig çš„ get æ–¹æ³•ä¸­ï¼Œå‘ç°äº†ä¸€äº›éå¸¸é‡è¦çš„é€»è¾‘ã€‚

ReferenceConfig çš„ get æ–¹æ³•ä¸­ï¼Œä»¥çº¿ç¨‹å®‰å…¨çš„æ–¹å¼æ¥åˆ›å»º ref å¼•ç”¨å¯¹è±¡ï¼›ReferenceConfig çš„ init æ–¹æ³•ä¸­ï¼Œé™¤äº†æ„å»ºå¼•ç”¨æœåŠ¡æ‰€éœ€çš„å‚æ•°ï¼Œè¿˜æœ‰ä¸ªåˆ›å»ºä»£ç†ï¼ˆcreateProxyï¼‰çš„æ–¹æ³•ï¼Œå¹¶ä¸”å°†åˆ›å»ºä»£ç†æ–¹æ³•çš„è¿”å›å€¼èµ‹å€¼ç»™äº† ref å¯¹è±¡ã€‚

åˆ›å»ºä»£ç†çš„å†…éƒ¨é€»è¾‘ä¸­ï¼Œæœ‰æ¡ä»¶åœ°è¿›è¡Œäº†æœ¬åœ°å¼•ç”¨ï¼ˆcreateInvokerForLocalï¼‰å’Œè¿œç¨‹å¼•ç”¨ï¼ˆcreateInvokerForRemoteï¼‰ï¼Œå¹¶å°†å¼•ç”¨ä¹‹åçš„ç»“æœ invoker å¯¹è±¡å†æ¬¡åŒ…è£…ä¸ºä»£ç†å¯¹è±¡ï¼Œä»¥ä¾›æ¶ˆè´¹æ–¹è°ƒç”¨è¿œç¨‹ä½¿ç”¨ã€‚

é€šè¿‡å¯¹æ¯”ç¿»é˜…ä»£ç ï¼Œç¡®å®æ˜¯ä¸€ç§ä¸é”™çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥ç¨å¾®å®Œå–„ä¸€ä¸‹å¯¹æ¯”å›¾äº†ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/c3/fd/c30a1c03e7319b4d9899751f951a4cfd.jpg?wh=6051x2325)

æ—¢ç„¶æœ‰äº†æœ¬åœ°å¼•ç”¨å’Œè¿œç¨‹å¼•ç”¨è¿™ä¸¤ä¸ªé‡å¤§å‘ç°ï¼Œæƒ³å¿…ä½ å·²ç»è¿«ä¸åŠå¾…äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±æŒ¨ä¸ªåˆ†æã€‚

### 1. createInvokerForLocal æœ¬åœ°å¼•ç”¨

å…ˆçœ‹æœ¬åœ°å¼•ç”¨çš„æ–¹æ³•ï¼š

```java
///////////////////////////////////////////////////                  
// org.apache.dubbo.config.ReferenceConfig#createInvokerForLocal
// ä¸ºæœ¬åœ°å¼•ç”¨åˆ›å»º invoker å¯¹è±¡
///////////////////////////////////////////////////
private void createInvokerForLocal(Map<String, String> referenceParameters) {
    // å°†å¼•ç”¨æœåŠ¡çš„å‚æ•°å¯¹è±¡ referenceParametersã€injvm é‡æ–°å†æ¬¡å°è£…ä¸ºä¸€ä¸ªæ–°å¯¹è±¡
    URL url = new ServiceConfigURL("injvm", "127.0.0.1", 0, interfaceClass.getName(), referenceParameters);
    url = url.setScopeModel(getScopeModel());
    url = url.setServiceModel(consumerModel);
    // urlï¼šinjvm://127.0.0.1/com.hmilyylimh.cloud.facade.demo.DemoFacade?application=dubbo-20-subscribe-consumer&background=false&dubbo=2.0.2&interface=com.hmilyylimh.cloud.facade.demo.DemoFacade&methods=sayHello,say&pid=8632&qos.enable=false&register.ip=192.168.100.183&release=3.0.7&side=consumer&sticky=false&timestamp=1670774005173
    
    // æœåŠ¡å¼•ç”¨ï¼Œè¿”å›çš„ invoker å¯¹è±¡è¿™é‡Œä¹Ÿåšäº†æ¯”è¾ƒå‹å¥½çš„å‘½åè¯´æ˜
    // withFilter å…¶å®å°±æ˜¯æƒ³è¡¨è¾¾ï¼Œå³ä½¿æ˜¯æœ¬åœ°å¼•ç”¨ä¹Ÿæœ‰è¿‡æ»¤å™¨æ‹¦æˆªé‚£ä¸€å †çš„ç‰¹æ€§
    Invoker<?> withFilter = protocolSPI.refer(interfaceClass, url);
    // Local Invoke ( Support Cluster Filter / Filter )
    
    // å°† invoker å¯¹è±¡æœ€ç»ˆèšåˆä¸ºä¸€ä¸ªé›†ç¾¤ invoker å¯¹è±¡
    // ä»å¦å¤–ä¸€ä¸ªè§’åº¦çœ‹çš„è¯ï¼Œä¹Ÿå°±æ„å‘³ç€ Cluster é‡Œé¢æ˜¯æœ‰å¤šä¸ª invoker å¯¹è±¡çš„
    List<Invoker<?>> invokers = new ArrayList<>();
    invokers.add(withFilter);
    invoker = Cluster.getCluster(url.getScopeModel(), "failover").join(new StaticDirectory(url, invokers), true);
}
```

æ•´ä½“æµç¨‹éå¸¸ç®€å•ï¼Œä¸€ä¸Šæ¥åˆ›å»ºä¸€ä¸ª injvm åè®®çš„ url å¯¹è±¡ï¼Œç´§æ¥ç€è°ƒç”¨äº† protocolSPI çš„ refer æ–¹æ³•ï¼Œè¿”å›äº†ä¸€ä¸ªå«æœ‰è¿‡æ»¤å™¨æ‹¦æˆªç‰¹æ€§çš„ invoker å¯¹è±¡ï¼Œæœ€åè¢«é›†ç¾¤æ‰©å±•å™¨å†æ¬¡èšåˆæˆäº†å•ä¸ª invoker å¯¹è±¡ã€‚

ç„¶è€Œç»†å¿ƒçš„ä½ å¯èƒ½å·²ç»å‘ç°äº†ï¼ŒprotocolSPI è¿™ä¸ªå˜é‡åœ¨ä¸Šä¸€è®²â€œ[å‘å¸ƒæµç¨‹](https://time.geekbang.org/column/article/620988)â€çš„å¯¼å‡ºä¸­ä¹Ÿè§è¿‡ï¼Œéš¾é“ refer å’Œ export æ–¹æ³•æœ‰å†…åœ¨è”ç³»ï¼Ÿ

ä¸ºäº†éªŒè¯è¿™ä¸ªé—®é¢˜ï¼Œä½ å†æ¬¡è¿›å…¥ Protocol æ¥å£ã€‚

```java
///////////////////////////////////////////////////                  
// Protocol æ¥å£ï¼Œexport ä¸ refer æ˜¯æˆå¯¹å­˜åœ¨çš„
///////////////////////////////////////////////////
@SPI(value = "dubbo", scope = ExtensionScope.FRAMEWORK)
public interface Protocol {
    // çœç•¥å…¶ä»–éƒ¨åˆ†ä»£ç ...
    /**
     * Export service for remote invocation: <br>
     * 1. Protocol should record request source address after receive a request:
     * RpcContext.getServerAttachment().setRemoteAddress();<br>
     * 2. export() must be idempotent, that is, there's no difference between invoking once and invoking twice when
     * export the same URL<br>
     * 3. Invoker instance is passed in by the framework, protocol needs not to care <br>
     *
     * @param <T>     Service type
     * @param invoker Service invoker
     * @return exporter reference for exported service, useful for unexport the service later
     * @throws RpcException thrown when error occurs during export the service, for example: port is occupied
     */
    @Adaptive
    <T> Exporter<T> export(Invoker<T> invoker) throws RpcException;
    /**
     * Refer a remote service: <br>
     * 1. When user calls `invoke()` method of `Invoker` object which's returned from `refer()` call, the protocol
     * needs to correspondingly execute `invoke()` method of `Invoker` object <br>
     * 2. It's protocol's responsibility to implement `Invoker` which's returned from `refer()`. Generally speaking,
     * protocol sends remote request in the `Invoker` implementation. <br>
     * 3. When there's check=false set in URL, the implementation must not throw exception but try to recover when
     * connection fails.
     *
     * @param <T>  Service type
     * @param type Service class
     * @param url  URL address for the remote service
     * @return invoker service's local proxy
     * @throws RpcException when there's any error while connecting to the service provider
     */
    @Adaptive
    <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException;
    // çœç•¥å…¶ä»–éƒ¨åˆ†ä»£ç ...
}
```

å¯ä»¥çœ‹åˆ°ï¼ŒåŸæ¥ export å’Œ refer æ˜¯æˆå¯¹å­˜åœ¨çš„ã€‚

æœ‰äº† export çš„åˆ†æç»éªŒï¼Œå†åˆ†æ refer å°±æ˜¯å°èœä¸€ç¢Ÿäº†ã€‚refer æ–¹æ³•ä¸Šä¹Ÿæ˜¯æœ‰ @Adaptive æ³¨è§£çš„ï¼Œé‚£å¯ä»¥å€Ÿé‰´ä¸Šä¸€è®²åˆ†æå¯¹è±¡ä¼šç»å†å“ªäº›è°ƒç”¨æµç¨‹çš„ç»éªŒï¼Œç”»å‡ºè¿™æ ·çš„è°ƒç”¨é“¾ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/71/7a/713c90931938b612e491ba8ce50d317a.jpg?wh=1920x1198)

å…ˆç»è¿‡äº†ä¸€ç³»åˆ—çš„åŒ…è£…ç±»ï¼Œç„¶åè¿›å…¥åˆ° InjvmProtocol å®ç°ç±»ä¸­ã€‚å’Œå¯¼å‡ºæ—¶é€šè¿‡ injvm èµ°çš„æµç¨‹ï¼Œå…¶å®æ˜¯ä¸€æ ·çš„ï¼Œå†æ¬¡è¯æ˜äº† export å’Œ refer æ˜¯æˆå¯¹å­˜åœ¨çš„ã€‚

æ—¢ç„¶æ˜¯æˆå¯¹å­˜åœ¨çš„ï¼Œinjvm çš„å¯¼å‡ºï¼Œæ˜¯å°†åˆ›å»ºå‡ºæ¥çš„ invoker å¯¹è±¡æ”¾è¿› InjvmProtocol ä¸­çš„ï¼Œéš¾é“ refer ä¼šè¿”å›ä¸€ä¸ª invoker ä¹ˆï¼Ÿè¿™ä¹Ÿåªæ˜¯æ¨æµ‹ï¼Œæˆ‘ä»¬ä¸å¦¨è¿›å…¥ InjvmProtocol ä¸­éªŒè¯çœ‹çœ‹ã€‚

```java
///////////////////////////////////////////////////                  
// org.apache.dubbo.rpc.protocol.AbstractProtocol#refer
// æŠ½è±¡ç±»ä¸­æœ‰ refer æ–¹æ³•ï¼Œä½†æ˜¯ refer ä¸­åˆè°ƒç”¨äº† protocolBindingRefer æŠ½è±¡æ–¹æ³•
///////////////////////////////////////////////////
@Override
public <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException {
    return protocolBindingRefer(type, url);
}
                  â†“
///////////////////////////////////////////////////                  
// org.apache.dubbo.rpc.protocol.injvm.InjvmProtocol#protocolBindingRefer
// é‡å†™çˆ¶ç±»ä¸­çš„ protocolBindingRefer æ–¹æ³•ï¼Œå…¶å®é—´æ¥æ‰§è¡Œäº† refer çš„é€»è¾‘
// å‘ç°æ²¡ï¼Œè¿™é‡Œå°±ç›´æ¥åˆ›å»ºäº†ä¸€ä¸ª InjvmInvoker ç±»çš„çš„å¯¹è±¡
///////////////////////////////////////////////////
@Override
public <T> Invoker<T> protocolBindingRefer(Class<T> serviceType, URL url) throws RpcException {
    return new InjvmInvoker<T>(serviceType, url, url.getServiceKey(), exporterMap);
}
```

é€šè¿‡æ·±å…¥ InjvmProtocol çš„æºç å¯ä»¥å¾—çŸ¥ï¼Œæ¨æµ‹æ˜¯æ­£ç¡®çš„ï¼Œæ‰€è°“çš„æœ¬åœ°å¼•ç”¨ï¼Œå°±æ˜¯ç›´æ¥åœ¨æœ¬åœ°åˆ›å»ºäº†ä¸€ä¸ª InjvmInvoker å¯¹è±¡è€Œå·²ï¼Œå¹¶ä¸”æºç å†æ¬¡å‘æˆ‘ä»¬è¯æ˜äº† export å’Œ refer æ˜¯æˆå¯¹å­˜åœ¨çš„ã€‚

### 2. createInvokerForRemote è¿œç¨‹å¼•ç”¨

åˆ†æäº†æœ¬åœ°å¼•ç”¨ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹è¿œç¨‹å¼•ç”¨ã€‚**ä¸€å®šè¦æ³¨æ„ï¼Œæˆå¯¹å­˜åœ¨çš„æ¦‚å¿µï¼Œå¯¹æ¯”å¾ˆé‡è¦ï¼Œå¤§æ¦‚ç‡å°±èƒ½æ¨æµ‹å‡ºåº•å±‚çš„æ ¸å¿ƒé€»è¾‘**ã€‚æ‰€ä»¥æˆ‘ä»¬å…ˆç»“åˆæä¾›æ–¹çš„æ“ä½œï¼Œå¯¹æ¯”çŒœæµ‹ä¸€ä¸‹æ¶ˆè´¹æ–¹ä¼šåšå“ªäº›å¤„ç†ã€‚

æä¾›æ–¹åœ¨è¿œç¨‹å¯¼å‡ºæ—¶ï¼Œåˆ©ç”¨ Netty ç»‘å®šäº†åè®®ç«¯å£æ¥æä¾›æœåŠ¡ï¼Œå¯¹åº”ç»‘å®šç«¯å£çš„æ ¸å¿ƒç±»æ˜¯ NettyServerï¼Œé‚£æ¶ˆè´¹æ–¹å¼•ç”¨æ—¶ï¼Œä¼šä¸ä¼šå°è¯•è¿æ¥ Netty æœåŠ¡å‘¢ï¼Ÿè¿æ¥ Netty æœåŠ¡çš„ç±»ä¼šä¸ä¼šæ˜¯ NettyClient å‘¢ï¼Ÿ

æä¾›æ–¹æœ€ååœ¨è¿œç¨‹å¯¼å‡ºæ—¶ï¼Œé¡ºä¾¿å°†æœåŠ¡æ¥å£ä¿¡æ¯å†™åˆ°äº†æ³¨å†Œä¸­å¿ƒï¼Œé‚£ä¹ˆåœ¨æ¶ˆè´¹æ–¹çš„è¿œç¨‹å¼•ç”¨æ—¶ï¼Œä¼šä¸ä¼šä¹Ÿå¾€æ³¨å†Œä¸­å¿ƒå†™æ•°æ®å‘¢ï¼Ÿåˆæˆ–è€…ä¼šä¸ä¼šä»æ³¨å†Œä¸­å¿ƒè·å–æ•°æ®å‘¢ï¼Ÿ

å¸¦ç€æ¨æµ‹ï¼Œæˆ‘ä»¬ç»§ç»­æ·±å…¥è¿œç¨‹å¼•ç”¨çš„ä»£ç ä¸­å»çœ‹çœ‹ã€‚

```java
///////////////////////////////////////////////////                  
// org.apache.dubbo.config.ReferenceConfig#createInvokerForRemote
// ä¸ºè¿œç¨‹å¼•ç”¨åˆ›å»º invoker å¯¹è±¡
///////////////////////////////////////////////////
private void createInvokerForRemote() {
    // è‹¥ urls é›†åˆåªæœ‰ 1 ä¸ªå…ƒç´ çš„è¯ï¼Œåˆ™ç›´æ¥è°ƒç”¨ refer è¿›è¡Œè¿œç¨‹å¼•ç”¨
    if (urls.size() == 1) {
        URL curUrl = urls.get(0);
        // è¿œç¨‹å¼•ç”¨çš„æ ¸å¿ƒä»£ç 
        invoker = protocolSPI.refer(interfaceClass, curUrl);
        if (!UrlUtils.isRegistry(curUrl)) {
            // å¦‚æœè¿™ä¸ª curUrl ä¸æ˜¯æ³¨å†Œåè®®çš„è¯ï¼Œ
            // é‚£ä¹ˆå°±ç”¨é›†ç¾¤æ‰©å±•å™¨åŒ…è£…èµ·æ¥
            List<Invoker<?>> invokers = new ArrayList<>();
            invokers.add(invoker);
            invoker = Cluster.getCluster(scopeModel, Cluster.DEFAULT).join(new StaticDirectory(curUrl, invokers), true);
        }
    } 
    // èƒ½æ¥åˆ°è¿™é‡Œï¼Œè¯´æ˜ urls æœ‰å¤šä¸ªåœ°å€ï¼Œ
    // å¯èƒ½æœ‰æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œä¹Ÿå¯èƒ½æœ‰æœåŠ¡æ¥å£å¼•ç”¨åœ°å€
    // åæ­£æœ‰æ··åˆçš„å¯èƒ½æ€§
    else {
        List<Invoker<?>> invokers = new ArrayList<>();
        URL registryUrl = null;
        // æ—¢ç„¶ urls æœ‰å¤šä¸ªå…ƒç´ çš„è¯ï¼Œé‚£å°±å¹²è„†ç›´æ¥å¾ªç¯è¿›è¡ŒæŒ¨ä¸ªæŒ¨ä¸ªè¿œç¨‹å¼•ç”¨
        for (URL url : urls) {
            // For multi-registry scenarios, it is not checked whether each referInvoker is available.
            // Because this invoker may become available later.
            // å¾ªç¯ä½“ä¸­å•ç‹¬é’ˆå¯¹é’ˆå¯¹ä¸€ä¸ª url è¿›è¡Œè¿œç¨‹å¼•ç”¨
            invokers.add(protocolSPI.refer(interfaceClass, url));
            if (UrlUtils.isRegistry(url)) {
                // use last registry url
                registryUrl = url;
            }
        }
        // å¦‚æœå¾ªç¯å®Œäº†ä¹‹åï¼Œå‘ç°å«æœ‰æ³¨å†Œä¸­å¿ƒåœ°å€çš„è¯ï¼Œ
        // é‚£å°±ç»§ç»­ç”¨é›†ç¾¤æ‰©å±•å™¨åŒ…è£…èµ·æ¥
        if (registryUrl != null) {
            // registry url is available
            // for multi-subscription scenario, use 'zone-aware' policy by default
            String cluster = registryUrl.getParameter(CLUSTER_KEY, ZoneAwareCluster.NAME);
            // The invoker wrap sequence would be: ZoneAwareClusterInvoker(StaticDirectory) -> FailoverClusterInvoker
            // (RegistryDirectory, routing happens here) -> Invoker
            // é›†ç¾¤æ‰©å±•å™¨åŒ…è£… invokers åˆ—è¡¨
            invoker = Cluster.getCluster(registryUrl.getScopeModel(), cluster, false).join(new StaticDirectory(registryUrl, invokers), false);
        } 
        // å¾ªç¯å®Œäº†åè‹¥å‘ç°æ²¡æœ‰æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œ
        // é‚£å¾ˆæœ‰å¯èƒ½å°±æ˜¯ç‚¹ç‚¹ç›´è¿æ–¹å¼è¿›è¡Œç‚¹å¯¹ç‚¹è¿æ¥
        // äºæ˜¯ï¼Œè¿˜æ˜¯ä¸€æ ·é‡‡ç”¨é›†ç¾¤æ‰©å±•å™¨åŒ…è£…èµ·æ¥
        else {
            // not a registry url, must be direct invoke.
            if (CollectionUtils.isEmpty(invokers)) {
                throw new IllegalArgumentException("invokers == null");
            }
            URL curUrl = invokers.get(0).getUrl();
            String cluster = curUrl.getParameter(CLUSTER_KEY, Cluster.DEFAULT);
            // é›†ç¾¤æ‰©å±•å™¨åŒ…è£… invokers åˆ—è¡¨
            invoker = Cluster.getCluster(scopeModel, cluster).join(new StaticDirectory(curUrl, invokers), true);
        }
    }
}
                  â†“
///////////////////////////////////////////////////                  
// org.apache.dubbo.registry.integration.RegistryProtocol#refer
// æ³¨å†Œåè®®çš„å¼•ç”¨æ–¹æ³•ï¼Œè¯¥ç±»ä¸­è¿˜æœ‰ä¸€ä¸ª export å¯¼å‡ºçš„æ–¹æ³•ï¼Œä»–ä»¬ä¿©æ˜¯æˆå¯¹å­˜åœ¨çš„
///////////////////////////////////////////////////
public <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException {
    // é¦–å…ˆä¸€è¿›å…¥æ–¹æ³•ï¼Œä½ å¯ä»¥å…ˆçœ‹ä¸‹å…¥å‚urlæ˜¯ä¸ªå¤§æ¦‚çš„ä»€ä¹ˆå†…å®¹
    // å…¥å‚urlï¼šregistry://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService?REGISTRY_CLUSTER=registryConfig&application=dubbo-20-subscribe-consumer&dubbo=2.0.2&pid=7032&qos.enable=false&registry=ZooKeeper&release=3.0.7&timestamp=1670774973194
    url = getRegistryUrl(url);
    
    // ç„¶åç»è¿‡ getRegistryUrl æ–¹æ³•åï¼Œåˆå˜æˆäº†ä»€ä¹ˆæ ·å­
    // ç»“æœå‘ç°åè®®è¢«æ›¿æ¢äº†ï¼Œç”± registry åè®®æ›¿æ¢æˆäº† zookeeper åè®®
    // getRegistryUrl åçš„ urlï¼šzookeeper://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService?REGISTRY_CLUSTER=registryConfig&application=dubbo-20-subscribe-consumer&dubbo=2.0.2&pid=7032&qos.enable=false&release=3.0.7&timestamp=1670774973194
    Registry registry = getRegistry(url);
    if (RegistryService.class.equals(type)) {
        return proxyFactory.getInvoker((T) registry, type, url);
    }
    
    // group="a,b" or group="*"
    // è¿™é‡Œæ¶‰åŠä¸€ä¸ªä¸€ä¸ªåˆ†ç»„çš„æ¦‚å¿µï¼Œä¸è¿‡å¸¸å¸¸ä¼šå’Œ merger èšåˆå‚æ•°ä¸€èµ·ä½¿ç”¨
    Map<String, String> qs = (Map<String, String>) url.getAttribute(REFER_KEY);
    String group = qs.get(GROUP_KEY);
    if (StringUtils.isNotEmpty(group)) {
        if ((COMMA_SPLIT_PATTERN.split(group)).length > 1 || "*".equals(group)) {
            // æ‰§è¡Œæ ¸å¿ƒçš„ doRefer æ–¹æ³•
            return doRefer(Cluster.getCluster(url.getScopeModel(), MergeableCluster.NAME), registry, type, url, qs);
        }
    }
    
    // èƒ½æ¥åˆ°è¿™ä¸ªè¿˜æ˜¯ï¼Œå‘ç°æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨æ ¸å¿ƒçš„ doRefer æ–¹æ³•
    // å› æ­¤ä¸ç®¡æ˜¯åˆ†ç»„èšåˆæƒ…å†µï¼Œè¿˜æ˜¯æ™®é€šçš„æƒ…å†µï¼Œæœ€ç»ˆé‡å¿ƒéƒ½è½åˆ°äº† doRefer æ–¹æ³•
    Cluster cluster = Cluster.getCluster(url.getScopeModel(), qs.get(CLUSTER_KEY));
    return doRefer(cluster, registry, type, url, qs);
}
```

å¯ä»¥æ€»ç»“å‡º 3 ç‚¹ã€‚

- è¿œç¨‹å¼•ç”¨çš„ urls é›†åˆï¼Œæ—¢å¯ä»¥æ˜¯æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œä¹Ÿå¯ä»¥å¤šä¸ªæä¾›æ–¹çš„ç‚¹å¯¹ç‚¹åœ°å€ã€‚
- ä¸ç®¡ urls é›†åˆçš„æ•°é‡æ˜¯ä¸€ä¸ªè¿˜æ˜¯å¤šä¸ªï¼Œæœ€ç»ˆéƒ½æ˜¯å¾ªç¯è°ƒç”¨ refer æ–¹æ³•ï¼Œç„¶åç´¯åŠ  refer çš„æ‰€æœ‰ç»“æœï¼Œæœ€ç»ˆè¢«é›†ç¾¤æ‰©å±•å™¨åŒ…è£…æˆäº†ä¸€ä¸ª invokerã€‚
- refer çš„æ–¹æ³•ä½“ä¸­å°†æ³¨å†Œå™¨ã€é›†ç¾¤æ‰©å±•å™¨ã€æ¥å£ç­‰ä¿¡æ¯å…¨éƒ¨å°è£…åˆ°äº†ä¸€ä¸ª doRefer æ–¹æ³•ä¸­ã€‚

ç¬¬ä¸‰ç‚¹ï¼Œæ‰€æœ‰æŠ½è±¡çš„å¯¹è±¡éƒ½ä¼ å…¥äº† doRefer æ–¹æ³•ä¸­ï¼Œç”±æ­¤å¯è§ï¼Œè¿™ä¸ªæ–¹æ³•åº”è¯¥å°±æ˜¯æˆ‘ä»¬ç ”ç©¶çš„é‡ä¸­ä¹‹é‡ã€‚æˆ‘ä¹Ÿç»™ä½ æ€»ç»“äº†ä»£ç çš„è°ƒç”¨æµç¨‹å›¾ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/86/30/868c4690861e8f392f73c903d0b9cb30.jpg?wh=1920x1519)

æˆ‘ä»¬å¾—å‡ºäº†ä¸€ä¸ªéå¸¸é‡è¦çš„ç»“è®ºï¼Œä» RegistryProtocol çš„ doRefer ä¸€è·¯è·Ÿè¸ªï¼Œæœ€ç»ˆåˆå›åˆ°äº† RegistryProtocol çš„ doCreateInvoker æ–¹æ³•ï¼Œè€Œä¸”ä»æ–¹æ³•åä¹Ÿèƒ½çœ‹å‡ºæ˜¯åˆ›å»º invoker å¯¹è±¡çš„æ ¸å¿ƒé€»è¾‘ï¼Œå› æ­¤è¿œç¨‹å¼•ç”¨çš„æ ¸å¿ƒé€»è¾‘å°±è½åˆ°äº† doCreateInvoker æ–¹æ³•ä¸­ã€‚

å¿«è¦è§åˆ°æ›™å…‰äº†ï¼Œæˆ‘ä»¬çœ‹ doCreateInvoker æ–¹æ³•ã€‚

```java
///////////////////////////////////////////////////                  
// RegistryProtocol#doCreateInvoker
// å…œå…œè½¬è½¬åˆå›åˆ°äº†æ³¨å†Œåè®®å®ç°ç±»çš„åˆ›å»º invoker æ–¹æ³•æ¥äº†
///////////////////////////////////////////////////
protected <T> ClusterInvoker<T> doCreateInvoker(DynamicDirectory<T> directory, Cluster cluster, Registry registry, Class<T> type) {
    directory.setRegistry(registry);
    directory.setProtocol(protocol);
    
    // all attributes of REFER_KEY
    // è¿™é‡Œæ„å»ºäº†ä¸€ä¸ªéœ€è¦å†™åˆ°æ³¨å†Œä¸­å¿ƒçš„åœ°å€ä¿¡æ¯
    // ä¹‹å‰åœ¨å¯¼å‡ºçš„æ–¹æ³•ä¸­æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†æä¾›è€…ä¼šæŠŠæœåŠ¡æ¥å£çš„åœ°å€ä¿¡æ¯å†™åˆ°æ³¨å†Œä¸­å¿ƒä¸Š
    // ç»“æœè¿™é‡ŒåŒæ ·å†™åˆ°æ³¨å†Œä¸­å¿ƒä¸Šï¼Œè¯´æ˜åªè¦æ˜¯ dubbo æœåŠ¡ï¼Œä¸ç®¡æ˜¯æä¾›è€…è¿˜æ˜¯æ¶ˆè´¹è€…ï¼Œ
    // æœ€ç»ˆéƒ½ä¼šæŠŠè‡ªå·±çš„æä¾›çš„æœåŠ¡æ¥å£ä¿¡æ¯ï¼Œæˆ–éœ€è¦è®¢é˜…çš„æœåŠ¡æ¥å£ä¿¡æ¯ï¼Œéƒ½ä¼šå†™åˆ°æ³¨å†Œä¸­å¿ƒå»
    Map<String, String> parameters = new HashMap<>(directory.getConsumerUrl().getParameters());
    URL urlToRegistry = new ServiceConfigURL(
        parameters.get(PROTOCOL_KEY) == null ? CONSUMER : parameters.get(PROTOCOL_KEY),
        parameters.remove(REGISTER_IP_KEY),
        0,
        getPath(parameters, type),
        parameters
    );
    urlToRegistry = urlToRegistry.setScopeModel(directory.getConsumerUrl().getScopeModel());
    urlToRegistry = urlToRegistry.setServiceModel(directory.getConsumerUrl().getServiceModel());
    if (directory.isShouldRegister()) {
        // å°†æ„å»ºå¥½çš„çš„ urlToRegistry å­—ç¬¦ä¸²å†…å®¹å†™åˆ°æ³¨å†Œä¸­å¿ƒå»
        directory.setRegisteredConsumerUrl(urlToRegistry);
        registry.register(directory.getRegisteredConsumerUrl());
    }
    // è®¾ç½®è·¯ç”±è§„åˆ™
    directory.buildRouterChain(urlToRegistry);
    // æ„å»ºè®¢é˜…çš„åœ°å€ subscribeUrl ç„¶åå‘èµ·è®¢é˜…ï¼Œç„¶åä¼šç›‘å¬æ³¨å†Œä¸­å¿ƒçš„ç›®å½•
    directory.subscribe(toSubscribeUrl(urlToRegistry));
    return (ClusterInvoker<T>) cluster.join(directory, true);
}
```

æœç„¶è¿˜æ˜¯ç†Ÿæ‚‰çš„å¥—è·¯ï¼Œåœ¨ doCreateInvoker æ–¹æ³•ä¸­ä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ…ï¼šå‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œäº†æ¶ˆè´¹æ¥å£çš„ä¿¡æ¯ã€å‘æ³¨å†Œä¸­å¿ƒå‘èµ·äº†è®¢é˜…åŠç›‘å¬ã€‚

æˆ‘ä»¬åˆå¯ä»¥å®Œå–„è¿™å¼ å¯¹æ¯”å›¾ï¼Œæ‰¾åˆ°äº†è¿œç¨‹å¼•ç”¨åšçš„ä¸¤ä»¶é‡è¦äº‹æƒ…ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/45/b5/45f6c0b365efc1f587f36336e95467b5.jpg?wh=6048x2565)

åˆ°æ­¤ï¼Œæˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹çœ‹ä¹‹å‰çš„æ¨æµ‹ã€‚

> æ¨æµ‹ä¸€ï¼š  
> æä¾›æ–¹åœ¨è¿œç¨‹å¯¼å‡ºæ—¶ï¼Œåˆ©ç”¨ Netty ç»‘å®šäº†åè®®ç«¯å£æ¥æä¾›æœåŠ¡ï¼Œå¯¹åº”ç»‘å®šç«¯å£çš„æ ¸å¿ƒç±»æ˜¯ NettyServerï¼Œé‚£æ¶ˆè´¹æ–¹å¼•ç”¨æ—¶ï¼Œä¼šä¸ä¼šå°è¯•è¿æ¥ Netty æœåŠ¡å‘¢ï¼Ÿè¿æ¥ Netty æœåŠ¡çš„ç±»ä¼šä¸ä¼šæ˜¯ NettyClient å‘¢ï¼Ÿ  
> æ¨æµ‹äºŒï¼š  
> æä¾›æ–¹æœ€ååœ¨è¿œç¨‹å¯¼å‡ºæ—¶ï¼Œé¡ºä¾¿å°†æœåŠ¡æ¥å£ä¿¡æ¯å†™åˆ°äº†æ³¨å†Œä¸­å¿ƒï¼Œé‚£ä¹ˆåœ¨æ¶ˆè´¹æ–¹çš„è¿œç¨‹å¼•ç”¨æ—¶ï¼Œä¼šä¸ä¼šä¹Ÿå¾€æ³¨å†Œä¸­å¿ƒå†™æ•°æ®å‘¢ï¼Ÿåˆæˆ–è€…ä¼šä¸ä¼šä»æ³¨å†Œä¸­å¿ƒè·å–æ•°æ®å‘¢ï¼Ÿ

æˆ‘ä»¬å‘ç°åªæœ‰æ¨æµ‹äºŒè¢«è¯æ˜äº†ï¼Œæ¶ˆè´¹è€…åœ¨è¿œç¨‹å¼•ç”¨æ—¶ï¼Œç¡®å®ä¼šæŠŠè‡ªå·±éœ€è¦æ¶ˆè´¹å“ªä¸ªæ¥å£ä¹Ÿå†™åˆ°æ³¨å†Œä¸­å¿ƒï¼Œè¿™æ ·ä¸€æ¥å¯ä»¥åå‘è¯´æ˜ï¼Œ**é€šè¿‡æä¾›æ–¹çš„ä¸€ä¸ªæ¥å£ï¼Œå¯ä»¥ä»æ³¨å†Œä¸­å¿ƒæ‰¾åˆ°æœ‰å“ªäº›æä¾›æ–¹æœåŠ¡èŠ‚ç‚¹ï¼Œè¿˜èƒ½æ‰¾åˆ°æœ‰å“ªäº›æ¶ˆè´¹æ–¹æ¥ä½¿ç”¨è¿™ä¸ªæ¥å£ã€‚**

æ¨æµ‹ä¸€å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ª subscribe æ²¡çœ‹ï¼Œè¿™ä¸ªè®¢é˜…æ–¹æ³•çœ‹èµ·æ¥åªæœ‰ä¸€è¡Œç®€çŸ­çš„ä»£ç ï¼Œé‡Œé¢çš„é€»è¾‘æ·±åº¦å´ä¸äºšäº doRefer æ–¹æ³•ã€‚

ä½†æ˜¯ä¹Ÿåˆ«æ‹…å¿ƒï¼Œè¿™é‡Œæˆ‘æ•™ä½ ä¸€ä¸ªä»¥ç»ˆä¸ºå§‹çš„åå‘éªŒè¯å°æŠ€å·§ï¼Œæ—¢ç„¶æˆ‘ä»¬æ¨æµ‹ NettyClient ä¼šæ˜¯æœ€ç»ˆç»“æœï¼Œä¸å¦‚å°†è®¡å°±è®¡ï¼Œæ‰¾æ‰¾æœ‰æ²¡æœ‰ç±»åä¸­å«æœ‰ Netty å…³é”®å­—ä¸”æ˜¯æ“ä½œ Netty çš„å®¢æˆ·ç«¯ç±»ã€‚

- å¦‚æœæ‰¾åˆ°äº†ï¼Œçœ‹æœ‰æ²¡æœ‰å°è¯•è¿æ¥æœåŠ¡ç«¯çš„æ–¹æ³•ï¼Œæ‰“ä¸ªæ–­ç‚¹ã€‚
- å¦‚æœæ²¡æœ‰ï¼Œå°±çœ‹çˆ¶ç±»æœ‰æ²¡æœ‰è¿æ¥æœåŠ¡ç«¯çš„æ–¹æ³•ã€‚
- å¦‚æœéƒ½æ²¡æœ‰ï¼Œå°±ç›´æ¥è¿›å…¥ Netty çš„ Bootstrap ç±»ç»§ç»­æ‰¾è¿æ¥æœåŠ¡ç«¯çš„æ–¹æ³•ã€‚

æ€»ä¹‹ï¼Œæˆ‘ä»¬çš„ç›®çš„å°±æ˜¯è¦æ‰¾åˆ°é€šä¿¡çš„å‡ºå£ï¼Œ**è½å®åˆ°ä»£ç ä¸­ï¼Œå°±æ˜¯è¦æ‰¾åˆ°å…³äº Netty å‘å‡ºè¿æ¥æœåŠ¡ç«¯è¯·æ±‚çš„ç›¸å…³ APIã€‚**

æŒ‰ç…§å°æŠ€å·§ï¼Œæˆ‘ä»¬è¾“å…¥äº† Netty å…³é”®å­—ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰æ“ä½œ Netty çš„å®¢æˆ·ç«¯ç±»ï¼Œåˆæˆ–è€…å» Netty çš„ Bootstrap ç±»ä¸­çœ‹çœ‹æœ‰æ²¡æœ‰ connect è¿æ¥ä¹‹ç±»çš„æ–¹æ³•ï¼Œæ£€ç´¢çš„ç»“æœå±•ç¤ºå¦‚ä¸‹ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/a1/b9/a1ceda5ef52b0d625cd123d6fe7b6bb9.jpg?wh=4140x2589)

ä¸¤ç§æ£€ç´¢æ–¹å¼éƒ½æ‰¾åˆ°äº†å¯¹åº”çš„ç»“æœï¼Œå› ä¸ºä¸ç®¡æ˜¯å“ªç§æ–¹å¼æœ€åéƒ½ä¼šè¯æ˜æ¨æµ‹ä¸€æ˜¯æ­£ç¡®çš„ï¼Œå› æ­¤ï¼Œæˆ‘è¿™é‡Œå°±ä½¿ç”¨ NettyClient è¿™ä¸ªç±»ï¼Œæ‰¾ä¸ªè¿æ¥çš„æ–¹æ³•ã€‚

ç»“æœå‘ç° NettyClient ä¸­æœ‰ä¸ª doConnect æ–¹æ³•ï¼Œè§åçŸ¥æ„ï¼Œè¿™å¤§æ¦‚ç‡å°±æ˜¯è¿æ¥æœåŠ¡ç«¯çš„æ ¸å¿ƒæ–¹æ³•ï¼Œäºæ˜¯æˆ‘ä»¬å°±åœ¨æ¶ˆè´¹æ–¹ NettyClient è¿™é‡Œæ‰“ä¸ªæ–­ç‚¹ï¼Œå…ˆå¯åŠ¨æä¾›æ–¹ï¼Œå† Debug å¯åŠ¨æ¶ˆè´¹æ–¹ï¼Œé™é™ç­‰å€™æ–­ç‚¹çš„åˆ°æ¥ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/04/cf/042235f4459e9c54e79679bbf51970cf.jpg?wh=1920x3725)

è¿™å°±æ˜¯æˆ‘ä»¬å½“å‰æ–­ç‚¹åˆ°æ¥æ—¶å‘ˆç°çš„è°ƒç”¨å †æ ˆï¼Œä»ä¸‹å¾€ä¸Šçœ‹ã€‚

- é¦–å…ˆæ˜¯ç†Ÿæ‚‰çš„æ–¹æ³•åï¼Œä¸ºè¿œç¨‹å¼•ç”¨åˆ›å»º invoker çš„æ–¹æ³•å…¥å£ createInvokerForRemoteã€‚
- RegistryProtocol ä¸­åˆ›å»º invoker çš„æ ¸å¿ƒæ–¹æ³• doCreateInvokerã€‚
- è¿˜æœªæ¥å¾—åŠè¿›å…¥æºç ä¸€æ¢ç©¶ç«Ÿçš„ subscribe æ¥å£è®¢é˜…æ–¹æ³•ã€‚
- æ¥å£è®¢é˜…ä¹‹åæ¥äº†ä¸€å †çš„ notify çš„é€šçŸ¥æ–¹æ³•ï¼Œå¹¶ä¸”åˆå†æ¬¡èµ°äº†ä¸€é refer æ–¹æ³•ï¼Œå¾ˆæ˜¯å¥‡æ€ªã€‚
- æœ€åæ˜¯NettyClient çš„ doConnect æ–¹æ³•ã€‚

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡ NettyServer æ¨æµ‹å‡ºäº† NettyClient æ˜¯æˆç«‹çš„ï¼Œæ¨æµ‹ä¸€å®Œå…¨æ­£ç¡®ã€‚

## è®¢é˜…

ä½ å¯èƒ½ä¼šè¯´ï¼Œè¿˜æ²¡å®Œï¼Œæˆ‘ä»¬åˆšåˆšçš„è°ƒç”¨å †æ ˆå›¾ä¸­ä¸æ˜¯è¿˜æœ‰ä¸¤ä¸ªé—®å·ä¹ˆï¼Ÿ

è¿™ä¸ªå¥½è¯´ï¼Œæ¯•ç«Ÿæ–­ç‚¹åœåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ‰¾åˆ°ç¬¬ä¸€ä¸ª notify æ–¹æ³•è¢«è°ƒç”¨çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯ doSubscribe æ–¹æ³•ä¸­è°ƒç”¨äº† notify æ–¹æ³•ï¼Œè¿›å…¥æºç çœ‹çœ‹ã€‚

```java
///////////////////////////////////////////////////                  
// org.apache.dubbo.registry.zookeeper.ZookeeperRegistry#doSubscribe
// è®¢é˜…çš„æ ¸å¿ƒé€»è¾‘ï¼Œè¯»å– zk ç›®å½•ä¸‹çš„æ•°æ®ï¼Œç„¶åé€šçŸ¥åˆ·æ–°å†…å­˜ä¸­çš„æ•°æ®
///////////////////////////////////////////////////
@Override
public void doSubscribe(final URL url, final NotifyListener listener) {
    try {
        checkDestroyed();
        // å› ä¸ºè¿™é‡Œç”¨ * å·åŒ¹é…ï¼Œæˆ‘ä»¬åœ¨çœŸå®çš„çº¿ä¸Šç¯å¢ƒä¹Ÿä¸å¯èƒ½å°†æœåŠ¡æ¥å£é…ç½®ä¸º * å·
        // å› æ­¤è¿™é‡Œçš„ * å·é€»è¾‘æš‚ä¸”è·³è¿‡ï¼Œç›´æ¥çœ‹åé¢çš„å…·ä½“æ¥å£çš„é€»è¾‘
        if ("*".equals(url.getServiceInterface())) {
            // çœç•¥å…¶ä»–éƒ¨åˆ†ä»£ç ...
        } 
        // èƒ½æ¥åˆ°è¿™é‡Œï¼Œè¯´æ˜ ServiceInterface ä¸æ˜¯ * å·
        // url.getServiceInterface() = com.hmilyylimh.cloud.facade.demo.DemoFacade
        else {
            CountDownLatch latch = new CountDownLatch(1);
            try {
                List<URL> urls = new ArrayList<>();
                // toCategoriesPath(url) å¾—å‡ºæ¥çš„é›†åˆæœ‰ä»¥ä¸‹å‡ ç§ï¼š
                // 1ã€/dubbo/com.hmilyylimh.cloud.facade.demo.DemoFacade/providers
                // 2ã€/dubbo/com.hmilyylimh.cloud.facade.demo.DemoFacade/configurators
                // 3ã€/dubbo/com.hmilyylimh.cloud.facade.demo.DemoFacade/routers
                for (String path : toCategoriesPath(url)) {
                    ConcurrentMap<NotifyListener, ChildListener> listeners = zkListeners.computeIfAbsent(url, k -> new ConcurrentHashMap<>());
                    ChildListener zkListener = listeners.computeIfAbsent(listener, k -> new RegistryChildListenerImpl(url, path, k, latch));
                    if (zkListener instanceof RegistryChildListenerImpl) {
                        ((RegistryChildListenerImpl) zkListener).setLatch(latch);
                    }
                    // å‘ zk åˆ›å»ºæŒä¹…åŒ–ç›®å½•ï¼Œä¸€ç§å®¹é”™æ–¹å¼ï¼Œæ‹…å¿ƒç›®å½•è¢«è°æ„å¤–çš„å¹²æ‰äº†
                    zkClient.create(path, false);
                    
                    // !!!!!!!!!!!!!!!!
                    // è¿™æ®µé€»è¾‘å¾ˆé‡è¦äº†ï¼Œæ·»åŠ å¯¹ path ç›®å½•çš„ç›‘å¬ï¼Œ
                    // æ·»åŠ ç›‘å¬å®Œæˆåï¼Œè¿˜èƒ½æ‹¿åˆ° path è·¯å¾„ä¸‹æ‰€æœ‰çš„ä¿¡æ¯
                    // é‚£å°±æ„å‘³ç€ç›‘å¬ä¸€æ—¦æ·»åŠ å®Œæˆï¼Œé‚£ä¹ˆå°±èƒ½ç«‹é©¬è·å–åˆ°è¯¥ DemoFacade æ¥å£åˆ°åº•æœ‰å¤šå°‘ä¸ªæä¾›æ–¹èŠ‚ç‚¹
                    List<String> children = zkClient.addChildListener(path, zkListener);
                    // å°†è¿”å›çš„ä¿¡æ¯å…¨éƒ¨æ·»åŠ åˆ° urls é›†åˆä¸­
                    if (children != null) {
                        urls.addAll(toUrlsWithEmpty(url, path, children));
                    }
                }
                
                // ä» zk æ‹¿åˆ°äº†æ‰€æœ‰çš„ä¿¡æ¯åï¼Œç„¶åè°ƒç”¨ notify æ–¹æ³•
                // url.get(0) = dubbo://192.168.100.183:28200/com.hmilyylimh.cloud.facade.demo.DemoFacade?anyhost=true&application=dubbo-20-subscribe-consumer&background=false&check=false&deprecated=false&dubbo=2.0.2&dynamic=true&generic=false&interface=com.hmilyylimh.cloud.facade.demo.DemoFacade&methods=sayHello,say&register-mode=interface&release=3.0.7&side=provider
                // url.get(1) = empty://192.168.100.183/com.hmilyylimh.cloud.facade.demo.DemoFacade?application=dubbo-20-subscribe-consumer&background=false&category=configurators&dubbo=2.0.2&interface=com.hmilyylimh.cloud.facade.demo.DemoFacade&methods=sayHello,say&pid=11560&qos.enable=false&release=3.0.7&side=consumer&sticky=false&timestamp=1670846788876
                // url.get(2) = empty://192.168.100.183/com.hmilyylimh.cloud.facade.demo.DemoFacade?application=dubbo-20-subscribe-consumer&background=false&category=routers&dubbo=2.0.2&interface=com.hmilyylimh.cloud.facade.demo.DemoFacade&methods=sayHello,say&pid=11560&qos.enable=false&release=3.0.7&side=consumer&sticky=false&timestamp=1670846788876
                notify(url, listener, urls);
            } finally {
                // tells the listener to run only after the sync notification of main thread finishes.
                latch.countDown();
            }
        }
    } catch (Throwable e) {
        throw new RpcException("Failed to subscribe " + url + " to zookeeper " + getUrl() + ", cause: " + e.getMessage(), e);
    }
}
```

è®¢é˜…çš„æ ¸å¿ƒé€»è¾‘ï¼Œæ€»ç»“ä¸‹æ¥å°±æ˜¯ 3 ç‚¹ã€‚

- ç¬¬ä¸€ç‚¹ï¼Œæ ¹æ®è®¢é˜…çš„ url ä¿¡æ¯ï¼Œè§£æå‡º category ç±»åˆ«é›†åˆï¼Œç±»åˆ«é™¤äº†æœ‰çœ‹åˆ°çš„ providersã€configuratorsã€routersï¼Œè¿˜æœ‰ä¸€ä¸ª consumersï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬ç›®å‰æ˜¯æ¶ˆè´¹æ–¹è¿›è¡Œè®¢é˜…ï¼Œè§£æå‡ºæ¥çš„ç±»åˆ«é›†åˆæ²¡æœ‰ consumers ä¹Ÿæ˜¯åˆä¹æƒ…ç†çš„ã€‚
- ç¬¬äºŒç‚¹ï¼Œå¾ªç¯ä¸ºåˆšåˆšè§£æå‡ºæ¥çš„ category ç±»åˆ«è·¯å¾„æ·»åŠ ç›‘å¬ï¼Œå¹¶åŒæ—¶è·å–åˆ°ç±»åˆ«ç›®å½•ä¸‹æ‰€æœ‰çš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œä¸æ³¨å†Œä¸­å¿ƒæœ‰äº†é€šä¿¡å±‚é¢çš„äº¤äº’ï¼Œæ‹¿åˆ°äº†æ³¨å†Œä¸­å¿ƒå…³äºè®¢é˜…æ¥å£çš„æ‰€æœ‰ä¿¡æ¯ã€‚
- ç¬¬ä¸‰ç‚¹ï¼Œå°†è·å–åˆ°çš„æ‰€æœ‰ä¿¡æ¯ç»„è£…æˆä¸º urls é›†åˆï¼Œç»Ÿä¸€è°ƒç”¨ notify æ–¹æ³•åˆ·æ–°ã€‚

æ ¹æ®è¿™ 3 ç‚¹ç»“è®ºï¼Œä¼¼ä¹è§£ç­”äº†æˆ‘ä»¬å¼€ç¯‡çš„é—®é¢˜ï¼Œä¸ºä»€ä¹ˆæ¶ˆè´¹æ–¹èƒ½æ„ŸçŸ¥åˆ°æä¾›æ–¹çš„åœ°å€å‘¢ï¼Ÿå…¶å®å°±æ˜¯åœ¨è¿™ä¸ªç¯èŠ‚ï¼Œ**å½“æ¶ˆè´¹æ–¹å‘æ³¨å†Œä¸­å¿ƒå‘èµ·æ¥å£è®¢é˜…çš„æ—¶å€™ï¼Œå°±å·²ç»æ‹¿åˆ°äº†è¯¥æ¥å£åœ¨æ³¨å†Œä¸­å¿ƒçš„æä¾›æ–¹ä¿¡æ¯ã€é…ç½®ä¿¡æ¯ã€è·¯ç”±ä¿¡æ¯ã€‚**

æ‹¿åˆ°è¯¥æ¥å£çš„æ‰€æœ‰ä¿¡æ¯åï¼Œæˆ‘ä»¬å†ç»†çœ‹ notify åé¢è°ƒç”¨çš„æ–¹æ³•åã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/91/32/91fae9a85e37aa62c633bb5136b9dc32.jpg?wh=1920x1048)

ç»“æœçœ‹åˆ°äº†ä¸€ä¸ª toInvokers çš„æ–¹æ³•ï¼Œå°†åˆšåˆšæ‰€æœ‰çš„ urls è½¬æˆå¯¹åº” invoker å¯¹è±¡ã€‚

æ—¢ç„¶è½¬æˆ invoker å¯¹è±¡åï¼Œå°±è‡ªç„¶å˜æˆäº†å½“åˆè¿›å…¥ refer çš„é€»è¾‘äº†ï¼Œå› ä¸º refer çš„ç›®çš„å°±æ˜¯æ ¹æ® url å¾—åˆ° invoker å¯¹è±¡ï¼Œç°åœ¨æ•´ä¸ªé€»è¾‘å°±ç†é¡ºäº†ï¼Œæˆ‘ä»¬å†è¡¥å……ä¸€ä¸‹å›¾ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/b4/0b/b42ce313e7474f93903d7151376b1c0b.jpg?wh=5949x2589)

## è®¢é˜…æµç¨‹çš„æ¨æ‹‰æ¡ˆä¾‹

åœ¨ä»Šå¤©çš„è®¢é˜…æµç¨‹ä¸­ï¼Œæ¶ˆè´¹æ–¹ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œä¼šä¸»åŠ¨å»æ³¨å†Œä¸­å¿ƒæ‹‰å–æœ€æ–°çš„ä¿¡æ¯ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬å¸¸è§çš„æ¨æ‹‰æ¨¡å‹ä¸­çš„ pull æ¨¡å‹ï¼Œå…¶å®è¿˜æœ‰å¦å¤–ä¸€ç§ push æ¨¡å‹ï¼Œæ¨æ‹‰æ¨¡å‹åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­è¿˜æ˜¯æŒºå¸¸è§çš„ï¼Œé‚£æ—¥å¸¸æœ‰å“ªäº›å¸¸ç”¨çš„æ¡†æ¶æœ‰ç€è¿™æ ·çš„å‘å¸ƒè®¢é˜…æˆ–æ¨æ‹‰æ¨¡å¼å‘¢ï¼Ÿ

- Redis çš„å‘å¸ƒè®¢é˜…ï¼Œç”Ÿäº§è€…å°†æ¶ˆæ¯å‘å¸ƒåˆ°æŸä¸ªé¢‘é“ï¼Œè®¢é˜…è¿™ä¸ªé¢‘é“çš„æ¶ˆè´¹æ–¹éƒ½ä¼šæ”¶åˆ°æ¶ˆæ¯ã€‚
- Kafka çš„æ¶ˆè´¹è½®è¯¢ï¼Œç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ° Broker ä¸­åï¼Œæ¶ˆè´¹æ–¹ä¼šé‡‡å–é•¿è½®è¯¢çš„ pull æ‹‰å–æ¨¡å¼æ¥è‡ªä¸»æ§åˆ¶æ¶ˆè´¹é€Ÿç‡ã€‚
- ZooKeeper çš„äº‹ä»¶é€šçŸ¥ï¼Œæ¶ˆè´¹æ–¹ä¼šè®¢é˜…ç›‘å¬ ZooKeeper æœåŠ¡çš„æ–‡ä»¶ç›®å½•ï¼Œä¸€æ—¦æœ‰å˜æ›´ï¼ŒZooKeeper æœåŠ¡ä¼šåŸºäºé•¿è¿æ¥çš„æ–¹å¼ï¼Œé€šçŸ¥ç›‘å¬è¯¥ç›®å½•çš„æ¶ˆè´¹æ–¹ï¼Œè€Œé€šçŸ¥çš„å†…å®¹ç”šå°‘ï¼Œè‹¥æ¶ˆè´¹æ–¹éœ€è¦çŸ¥é“æ›´å¤šä¿¡æ¯çš„è¯ï¼Œé‚£ç”±æ¶ˆè´¹æ–¹è‡ªä¸»æ§åˆ¶å» ZooKeeper æœåŠ¡ç«¯æ‹‰å–æœ€æ–°ä¿¡æ¯ã€‚

ä¸åŒçš„æ¡†æ¶é‡‡ç”¨ä¸åŒçš„æ–¹å¼ï¼Œä¹Ÿæœ‰è‡ªå·±çš„åˆ©å¼Šæƒè¡¡ã€‚

push æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯å®æ—¶æ€§å¼ºï¼Œå®¢æˆ·ç«¯åªè¦ç®€å•çš„è¢«åŠ¨æ¥æ”¶å³å¯ã€‚ä½†æ˜¯ä¹Ÿå®¹æ˜“å¯¼è‡´æ¶ˆæ¯ç§¯å‹ï¼ŒåŒæ—¶ä¹ŸåŠ å¤§äº†æœåŠ¡ç«¯çš„é€»è¾‘å¤æ‚åº¦ã€‚

pull æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯ä¸»åŠ¨æƒæŒæ¡åœ¨å®¢æˆ·ç«¯è‡ªå·±æ‰‹ä¸­ï¼Œæ¶ˆè´¹å¤šå°‘å°±å–å¤šå°‘ï¼Œé•¿è½®è¯¢çš„æ“ä½œä¹Ÿé¡¶å¤šå°±æ˜¯è€—è´¹æ¶ˆè´¹æ–¹ä¸€äº›çº¿ç¨‹èµ„æºå’Œç½‘ç»œå¸¦å®½ï¼Œä½†æ˜¯ï¼Œè½®è¯¢é—´éš”ä¹Ÿå¾—åœ¨å®æ—¶æ€§èƒ½å®¹å¿çš„æƒ…å†µä¸‹ï¼Œä¸”ä¸ä¼šå¯¹æœåŠ¡ç«¯é€ æˆå¤ªå¤§è¯·æ±‚å‹åŠ›å†²å‡»ã€‚è¿™æ ·ï¼Œå®¢æˆ·ç«¯çš„é€»è¾‘å°±ä¼šæ›´åŠ å¤æ‚ï¼Œåè€Œä¼šä½¿å¾—æœåŠ¡ç«¯ç®€å•å¹²è„†ã€‚

## æ€»ç»“

ä»Šå¤©ï¼Œæˆ‘ä»¬æŠ›å‡ºæ¶ˆè´¹æ–¹æ˜¯æ€ä¹ˆçŸ¥é“æä¾›æ–¹åœ°å€çš„é—®é¢˜ï¼Œå¯¹æ¯”è®¢é˜…æµç¨‹ä¸å‘å¸ƒæµç¨‹ã€ @DubboService ä¸ @DubboReferenceã€ServiceConfig ä¸ ReferenceConfigã€æœ¬åœ°å¯¼å‡ºä¸æœ¬åœ°å¼•ç”¨ã€è¿œç¨‹å¯¼å‡ºä¸è¿œç¨‹å¼•ç”¨ã€‚é€šè¿‡æ¯”å¯¹ï¼Œåˆ†ææœªçŸ¥çš„æµç¨‹ï¼Œæ˜¯ä¸€ä»¶å¾ˆå€¼å¾—æ¨æ•²å’ŒéªŒè¯çš„äº‹æƒ…ã€‚

è¿™é‡Œæˆ‘ç”¨ 4 ä¸ªæ­¥éª¤æ€»ç»“ä¸‹ä»Šå¤©å­¦çš„è®¢é˜…æµç¨‹ã€‚

- é¦–å…ˆï¼Œé€šè¿‡ @DubboReference æ³¨è§£è·Ÿè¸ªæºç çš„ä½¿ç”¨åœ°æ–¹ï¼Œæ‰¾åˆ°äº†å¹³å¸¸è¿›è¡Œè¿œç¨‹è°ƒç”¨çš„æ ¸å¿ƒç±» ReferenceConfigã€‚
- ç´§æ¥ç€ï¼Œåœ¨ReferenceConfig çš„ get æ–¹æ³•ä¸­è§è¯†åˆ°äº†æœ¬åœ°å¼•ç”¨ä¸è¿œç¨‹å¼•ç”¨çš„ä¸»å¹²æµç¨‹ã€‚
- ç„¶åï¼Œæ·±å…¥è¿œç¨‹å¼•ç”¨çš„åˆ†æ”¯é€»è¾‘ï¼Œæ‰¾åˆ°äº†æœ€æ ¸å¿ƒçš„åˆ›å»ºè¿œç¨‹ invoker çš„æ ¸å¿ƒé€»è¾‘ doCreateInvokerã€‚
- æœ€åï¼Œåœ¨è¿™æ®µ doCreateInvoker é€»è¾‘ä¸­ï¼Œå‘ç°äº†æ¶ˆè´¹è€…æ³¨å†Œå’Œæ¥å£è®¢é˜…é€»è¾‘ï¼Œåœ¨æ¥å£è®¢é˜…ä¸­è§è¯†åˆ°äº†æ„ŸçŸ¥æä¾›æ–¹çš„åœ°å€åŸæ¥å¦‚æ­¤ç®€å•ã€‚

è®¢é˜…æµç¨‹çš„æ¨æ‹‰æ¡ˆä¾‹ï¼Œæœ‰Redis çš„å‘å¸ƒè®¢é˜…ã€Kafka çš„æ¶ˆè´¹è½®è¯¢ã€ZooKeeper çš„äº‹ä»¶é€šçŸ¥ã€‚

### æ€è€ƒé¢˜

ç•™ä¸ªä½œä¸šç»™ä½ ï¼Œåœ¨æ¥å£è®¢é˜…çš„é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬æŒ–å‡ºæ¶ˆè´¹æ–¹æ˜¯å¦‚ä½•ä¸€æ¬¡æ€§è·å–æä¾›æ–¹çš„æ‰€æœ‰åœ°å€åˆ—è¡¨çš„ï¼Œä½†æ¶ˆè´¹æ–¹åœ¨æ¥å£è®¢é˜…æ–¹æ³•ä¸­åªæ˜¯æ·»åŠ äº†å¯¹ ZooKeeper ç›®å½•çš„ç›‘å¬ï¼Œé‚£å¯¹åº”æ¥æ”¶ ZooKeeper æœåŠ¡ç«¯äº‹ä»¶å˜æ›´ï¼Œåœ¨ä»£ç å“ªä¸ªä½ç½®å‘¢ï¼Ÿ

æœŸå¾…çœ‹åˆ°ä½ çš„å›ç­”ï¼Œå¦‚æœè§‰å¾—ä»Šå¤©çš„å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ä¸€èµ·è®¨è®ºã€‚æˆ‘ä»¬ä¸‹ä¸€è®²è§ã€‚

### 19 æ€è€ƒé¢˜å‚è€ƒ

ä¸Šä¸€æœŸç•™äº†ä¸ªä½œä¸šï¼Œç ”ç©¶ä¸‹ ProtocolFilterWrapper åè®®è¿‡æ»¤å™¨åŒ…è£…ç±»ï¼Œå¯¹ export æ–¹æ³•çš„æ‹¦æˆªåšäº†å“ªäº›äº‹æƒ…ã€‚

æƒ³è¦è§£ç­”è¿™ä¸ªé—®é¢˜ï¼Œå…¶å®ä¹Ÿä¸æ˜¯å¾ˆéš¾ï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥åˆ°è¯¥ç±»å»çœ‹çœ‹ã€‚

```java
///////////////////////////////////////////////////
// åè®®è¿‡æ»¤å™¨åŒ…è£…ç±»
///////////////////////////////////////////////////
@Activate(order = 100)
public class ProtocolFilterWrapper implements Protocol {
    private final Protocol protocol;
    // æ„é€ æ–¹æ³•çš„å…¥å‚æ˜¯ SPI æ¥å£ï¼Œå…¸å‹çš„åŒ…è£…ç±»å†™æ³•
    public ProtocolFilterWrapper(Protocol protocol) {
        if (protocol == null) {
            throw new IllegalArgumentException("protocol == null");
        }
        this.protocol = protocol;
    }
    @Override
    public int getDefaultPort() {
        return protocol.getDefaultPort();
    }
    @Override
    public <T> Exporter<T> export(Invoker<T> invoker) throws RpcException {
        // å¦‚æœ url.getProtocol() çš„å€¼ä¸ºï¼š
        // registry 
        // æˆ– service-discovery-registry 
        // æˆ–æ˜¯ -registry-protocol ç»“å°¾çš„è¯ï¼Œ
        // éƒ½ä¼šè®¤ä¸ºæ˜¯æ³¨å†Œåè®®ï¼Œåˆ™èµ°æ³¨å†Œåè®®çš„é“è·¯åˆ†æ”¯
        if (UrlUtils.isRegistry(invoker.getUrl())) {
            return protocol.export(invoker);
        }
        // å¦‚æœä¸æ˜¯æ³¨å†Œåè®®çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šèµ°ç»„è£…è¿‡æ»¤å™¨çš„åˆ†æ”¯é€»è¾‘
        FilterChainBuilder builder = getFilterChainBuilder(invoker.getUrl());
        
        // å°† invoker ç»è¿‡è¿‡æ»¤å™¨å±‚å±‚åŒ…è£…ä¹‹åçš„å¯¹è±¡ä¼ å…¥åˆ° protocol.export æ–¹æ³•ä¸­
        return protocol.export(builder.buildInvokerChain(invoker, SERVICE_FILTER_KEY, CommonConstants.PROVIDER));
    }
    private <T> FilterChainBuilder getFilterChainBuilder(URL url) {
        return ScopeModelUtil.getExtensionLoader(FilterChainBuilder.class, url.getScopeModel()).getDefaultExtension();
    }
    // çœç•¥å…¶ä»–éƒ¨åˆ†é€»è¾‘...
}
                  â†“
///////////////////////////////////////////////////
// æ„å»ºè¿‡æ»¤å™¨çš„æ ¸å¿ƒé€»è¾‘
///////////////////////////////////////////////////
@Override
public <T> Invoker<T> buildInvokerChain(final Invoker<T> originalInvoker, String key, String group) {
    Invoker<T> last = originalInvoker;
    URL url = originalInvoker.getUrl();
    List<ModuleModel> moduleModels = getModuleModelsFromUrl(url);
    List<Filter> filters;
    // è¿™é‡Œçœç•¥äº† filters æ˜¯å¦‚ä½•è·å–çš„é€»è¾‘ï¼Œåæ­£æœ€ç»ˆè¦è·å–åˆ° filters è¿‡æ»¤å™¨é›†åˆ...

    if (!CollectionUtils.isEmpty(filters)) {
        // ä»æœ€åä¸€ä¸ªè¿‡æ»¤å¼€å§‹å¾ªç¯ï¼Œå¹¶ä¸”å°†å…¥å‚çš„ originalInvoker èµ‹å€¼ç»™åˆ° last å˜é‡
        // ç¬¬ä¸€æ¬¡å¾ªç¯æ—¶ï¼Œå°† last èµ‹å€¼ç»™ nextï¼Œç„¶åå°† next ç»™åˆ°æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œæœ€åæŠŠæ–°åˆ›å»ºçš„å¯¹è±¡å†èµ‹å€¼ç»™ last å˜é‡
        // å°±è¿™æ ·ï¼Œç¬¬ä¸€æ¬¡å¾ªç¯è¿‡åï¼Œlast å˜é‡å…¶å®æ˜¯ä¸€ä¸ªæ–°çš„å¼•ç”¨å¯¹è±¡ï¼Œå¹¶ä¸”å¼•ç”¨é‡Œé¢æŒæœ‰ originalInvoker å¯¹è±¡
        // ...
        // ä»¥æ­¤ç±»æ¨ï¼Œä½ æ„Ÿå—ä¸€ä¸‹è¿™ä¸ªå¾ªç¯è¿‡ç¨‹ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹åƒå±‚å±‚å¥—å¨ƒçš„æ¦‚å¿µ
        for (int i = filters.size() - 1; i >= 0; i--) {
            final Filter filter = filters.get(i);
            final Invoker<T> next = last;
            last = new CopyOfFilterChainNode<>(originalInvoker, next, filter);
        }
        return new CallbackRegistrationInvoker<>(last, filters);
    }
    return last;
}
```

è¿›å…¥ export æ–¹æ³•ä¸­ï¼Œå‘ç°ä¸»è¦æœ‰ä¸¤ä¸ªåˆ†æ”¯é€»è¾‘ã€‚

- åˆ†æ”¯ä¸€ï¼šå¦‚æœæ˜¯æ³¨å†Œåè®®çš„è¯ï¼Œé‚£ä¹ˆå°±ä¸­è§„ä¸­çŸ©èµ°æ³¨å†Œåè®®çš„é€»è¾‘ã€‚
- åˆ†æ”¯äºŒï¼šå¦‚æœä¸æ˜¯æ³¨å†Œåè®®çš„è¯ï¼Œé‚£ä¹ˆå°±å°† invoker ç”¨è¿‡æ»¤å™¨å±‚å±‚åŒ…è£…èµ·æ¥ï¼Œå°†åŒ…è£…åçš„å¯¹è±¡å†æ¬¡ä¼ å…¥ protocol.export æ–¹æ³•ä¸­ã€‚

åˆ†ä¹‹ä¸€çš„é€»è¾‘ï¼Œæƒ³å¿…ä½ å·²ç»éå¸¸æ¸…æ¥šäº†ï¼Œå°±æ˜¯ä¸Šä¸€è®²è¯¦ç»†å­¦ä¹ çš„ã€‚

åˆ†æ”¯äºŒçš„é€»è¾‘ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆå¤šçš„è¿‡æ»¤å™¨ï¼Œæ˜¯å¹²ä»€ä¹ˆç”¨çš„å‘¢ï¼Ÿè¿˜è®°å¾—åœ¨â€œ[ç¼“å­˜æ“ä½œ](https://time.geekbang.org/column/article/613346)â€â€œ[å‚æ•°éªŒè¯](https://time.geekbang.org/column/article/613339)â€â€œ[æµé‡æ§åˆ¶](https://time.geekbang.org/column/article/614130)â€å‡ è®²ä¸­æè¿‡çš„ Filter è¿‡æ»¤å™¨ä¹ˆï¼Œå…¶å®å°±æ˜¯åœ¨åˆ†æ”¯äºŒè¿™ä¸ªç¯èŠ‚åŠ è½½è¿›å»çš„ï¼Œä¸ä¿¡çš„è¯ï¼Œæˆ‘ä»¬å°±æŒ‘â€œ[æµé‡æ§åˆ¶](https://time.geekbang.org/column/article/614130)â€çš„ä»£ç ï¼Œæ–­ç‚¹æŸ¥çœ‹ä¸€ä¸‹ buildInvokerChain çš„è¿”å‚æ•°æ®å°±çŸ¥é“äº†ã€‚

å¯åŠ¨â€œæµé‡æ§åˆ¶â€æä¾›æ–¹ä»£ç ï¼Œæ–­ç‚¹æŸ¥çœ‹ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/ca/a2/ca416b252587801d80a8cb2c62ddb8a2.png?wh=4629x3144)

çœ‹å®Œå›¾ä¸­çš„æ„å»ºè¿‡æ»¤å™¨çš„ç»“æœï¼Œæç„¶å¤§æ‚Ÿï¼ŒåŸæ¥è¿‡æ»¤å™¨çš„ç»„è£…æ—©å°±åœ¨å¯¼å‡ºçš„ç¯èŠ‚å°±å·²ç»å‡†å¤‡å°±ç»ªäº†ï¼Œåç»­è§¦å‘è¿‡æ»¤å™¨çš„è°ƒç”¨ï¼Œä¹Ÿåªä¸è¿‡æ˜¯æŒ‰éƒ¨å°±ç­åœ°ä»å¯¹è±¡çš„æœ€å¤–å±‚ä¸€ç›´æ‰§è¡Œåˆ°æœ€å†…å±‚è€Œå·²ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ4ï¼‰</strong></div><ul>
<li><span>Lum</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¿™ä¹ˆå¤šInvoker æ„Ÿè§‰å¥½ä¹±ï¼Œé£ä¸­å‡Œä¹±äº†ï¼Œå¸Œæœ›è€å¸ˆå¯ä»¥æ€»ç»“ä¸€ä¸‹è¿™äº›Invokerçš„å„ä¸ªåŠŸèƒ½</p>2023-03-02</li><br/><li><span>æ‰‹å†¢æ²»ç†Š</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è·Ÿç€æºç è¿‡æ¥ï¼Œæ²¡2å°æ—¶å¼„ä¸å®Œè¿™äº›æµç¨‹</p>2023-02-08</li><br/><li><span>Nights</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼ŒNettyä¸ç†Ÿæ‚‰ï¼Œéœ€è¦è¡¥è¯¾å˜›ï¼Ÿ</p>2023-02-01</li><br/><li><span>Jack</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œæœ‰æ²¡æœ‰è¯¾ç¨‹ç¾¤ï¼Ÿæˆ‘è®¢é˜…çš„å…¶ä»–è¯¾ç¨‹æœ‰å»ºå¾®ä¿¡ç¾¤ï¼Œè€å¸ˆå¯å¦ä¹Ÿå»ºä¸€ä¸ªç¾¤ï¼Ÿ</p>2023-02-01</li><br/>
</ul>