ä½ å¥½ï¼Œæˆ‘æ˜¯ä½•è¾‰ã€‚ä»Šå¤©æˆ‘ä»¬æ·±å…¥ç ”ç©¶Dubboæºç çš„ç¬¬ä¸ƒç¯‡ï¼Œå®ä¾‹æ³¨å…¥ã€‚

å®ä¾‹æ³¨å…¥æ˜¯ä»€ä¹ˆï¼Ÿä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå½“ç±»Aä¸­æœ‰ä¸€ä¸ªç±»å‹çš„æˆå‘˜å˜é‡Bï¼Œå¦‚æœä¸åšä»»ä½•å¤„ç†ï¼Œæˆ‘ä»¬åœ¨ç±»Aä¸­ä½¿ç”¨æˆå‘˜å˜é‡Bä¼šå‡ºç°ç©ºæŒ‡é’ˆé—®é¢˜ï¼Œä½†æŒ‰ç…§ä¸€å®šçš„è§„èŒƒçº¦æŸå®šä¹‰æˆå‘˜å˜é‡Båï¼Œæˆ‘ä»¬å†æ¬¡åœ¨ç±»Aä¸­ä½¿ç”¨æˆå‘˜å˜é‡Bæ—¶ï¼Œå°±ä¸ä¼šå‡ºç°ç©ºæŒ‡é’ˆäº†ã€‚

è¿™ç§ä½¿ç”¨èµ·æ¥çš„æ„Ÿè§‰ï¼Œå°±åƒåªè¦æŒ‰ç…§è§„èŒƒå®šä¹‰å˜é‡ï¼Œæˆ‘ä»¬å†ä½¿ç”¨è¿™ä¸ªå˜é‡çš„æ—¶å€™å°±æ˜¯ä¸€ä¸ªå¯¹è±¡äº†ï¼Œç±»Aä¸­çš„æˆå‘˜å˜é‡Bï¼Œå°±åƒåœ¨ä½¿ç”¨å‰è¢«å·å·æ³¨å…¥äº†ä¸€ä¸ªå®ä¾‹å¯¹è±¡ä¸€æ ·ï¼Œä½¿å¾—æˆ‘ä»¬æ— éœ€å…³æ³¨å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ï¼ŒæŒ‰ç…§è§„èŒƒå®šä¹‰å˜é‡å°±èƒ½è½»æ¾ä½¿ç”¨ã€‚

å¦‚æœä½ ç”¨è¿‡ Spring æ¡†æ¶çš„å®ä¾‹æ³¨å…¥åŠŸèƒ½ï¼Œæœ‰ä¸¤ä¸ªæŠ€æœ¯çŸ¥è¯†ç‚¹ç›¸ä¿¡ä½ ä¸€å®šå°è±¡æ·±åˆ»ï¼Œé‚£å°±æ˜¯ä¾èµ–æ³¨å…¥å’Œåˆ‡é¢ç¼–ç¨‹ã€‚ä¾èµ–æ³¨å…¥è®©æˆ‘ä»¬åœ¨ä½¿ç”¨ @Autowired å’Œ @Resource æ³¨è§£æ—¶ï¼Œå¾ˆå®¹æ˜“æ‹¿åˆ°è¢«åº•å±‚åˆ›å»ºå¥½çš„å®ä¾‹å¯¹è±¡ï¼Œåˆ‡é¢ç¼–ç¨‹åœ¨ä½¿ç”¨ @Aspect æ³¨è§£æ—¶ï¼Œå¾ˆå®¹æ˜“å®ç°åˆ‡é¢æ€æƒ³ï¼ˆAOPï¼‰å¯¹å…¬å…±é€»è¾‘è¿›è¡Œæ¨ªåˆ‡å¤„ç†ï¼Œç»™æ—¥å¸¸å¼€å‘å¸¦æ¥äº†éå¸¸å¤§çš„ä¾¿åˆ©ã€‚

ä¸è¿‡ Spring æ¡†æ¶å†ä¼˜ç§€ï¼Œä¹Ÿä¸æ˜¯ä¸‡èƒ½çš„ï¼Œä¸ºäº†è§£å†³å„ç§ç‰¹å®šåœºæ™¯é—®é¢˜ï¼Œä¸€äº›ä¼˜ç§€æ¡†æ¶åº”è¿è€Œç”Ÿï¼ŒDubbo æ­£æ˜¯å…¶ä¸­ä¸€æ¬¾è§£å†³ RPC è°ƒç”¨çš„é«˜æ€§èƒ½æ¡†æ¶ã€‚è€ŒDubboçš„å®ä¾‹æ³¨å…¥æºç ä¹Ÿå€¼å¾—ç ”ç©¶ï¼Œå¾ˆå¥½åœ°æ§åˆ¶äº†å®ä¾‹å¯¹è±¡çš„ç»Ÿä¸€åˆ›å»ºä¸è§„èŒƒåŒ–çš„æ³¨å…¥ã€‚

é‚£ Dubbo çš„å®ä¾‹æ³¨å…¥æœºåˆ¶æ˜¯æ€æ ·çš„ï¼Ÿä¸Springæœ‰å“ªäº›å¼‚åŒï¼Ÿæˆ‘ä»¬å¼€å§‹ä»Šå¤©çš„å­¦ä¹ ã€‚

## **å®ç°ç±»æ˜¯æ€ä¹ˆå®ä¾‹åŒ–å¯¹è±¡çš„ï¼Ÿ**

è¦ç ”ç©¶ Dubbo çš„å®ä¾‹æ³¨å…¥æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä½¿ç”¨å¯¹è±¡å…¥æ‰‹ï¼Œçœ‹çœ‹åœ¨æºç å±‚é¢ï¼Œå¯¹è±¡éƒ½ä»å“ªé‡Œåˆ›å»ºå‡ºæ¥çš„ã€‚

ä¸è¿‡æåˆ°å®ä¾‹å¯¹è±¡çš„åˆ›å»ºï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰å›æƒ³èµ·ä¸Šä¸€è®²â€œ[Adaptive é€‚é…](https://time.geekbang.org/column/article/620941)â€ä¸­ï¼Œæˆ‘ä»¬åˆ†æåˆ›å»ºè‡ªé€‚åº”æ‰©å±•ç‚¹æ–¹æ³•ï¼ˆcreateAdaptiveExtensionï¼‰ï¼Œçœ‹åˆ°è‡ªé€‚åº”æ‰©å±•ç‚¹å®ä¾‹å¯¹è±¡è¢«åˆ›å»ºå‡ºæ¥ä¹‹åï¼Œè¿˜æœ‰ä¸€å †å‰ç½®ã€æ³¨å…¥ã€åç½®ç­‰é€»è¾‘å¤„ç†ï¼Œéš¾é“å®ä¾‹å¯¹è±¡çš„åˆ›å»ºè·Ÿè¿™ä¸ªæœ‰å…³ä¹ˆï¼Ÿ

è¿™é‡Œä¹Ÿå†çœ‹ä¸€ä¸‹æˆ‘ä»¬è·Ÿè¸ªè¿‡çš„ createAdaptiveExtension æ–¹æ³•çš„æºç ã€‚

> // ExtensionLoader#createAdaptiveExtension  
> // åˆ›å»ºè‡ªé€‚åº”æ‰©å±•ç‚¹æ–¹æ³•  
> private T createAdaptiveExtension() {  
> Â  Â  try {  
> Â  Â  Â  Â  // è¿™ä¸€è¡Œä» newInstance è¿™ä¸ªå…³é”®å­—ä¾¿çŸ¥é“è¿™è¡Œä»£ç å°±æ˜¯åˆ›å»ºæ‰©å±•ç‚¹çš„æ ¸å¿ƒä»£ç   
> Â  Â  Â  Â  T instance = (T) getAdaptiveExtensionClass().newInstance();  
> Â  Â  Â  Â Â   
> Â  Â  Â  Â  // è¿™é‡Œé’ˆå¯¹åˆ›å»ºå‡ºæ¥çš„å®ä¾‹å¯¹è±¡åšçš„ä¸€äº›ç±»ä¼¼ Spring çš„å‰ç½®åç½®çš„æ–¹å¼å¤„ç†  
> Â  Â  Â  Â  instance = postProcessBeforeInitialization(instance, null);  
> Â  Â  Â  Â  instance = injectExtension(instance);  
> Â  Â  Â  Â  instance = postProcessAfterInitialization(instance, null);  
> Â  Â  Â  Â  initExtension(instance);  
> Â  Â  Â  Â  return instance;  
> Â  Â  } catch (Exception e) {  
> Â  Â  Â  Â  throw new IllegalStateException("Canâ€™t create adaptive extension " + type + ", cause: " + e.getMessage(), e);  
> Â  Â  }  
> }

å¦‚æœä½ èƒ½æƒ³åˆ°è¿™æ®µä»£ç ï¼Œè¯´æ˜å¯¹æ¯è¡Œä»£ç çš„ç ”ç©¶å¾ˆç»†è‡´ï¼Œè¿™æ˜¯ä¸ªå¾ˆå¥½çš„å­¦ä¹ ä¹ æƒ¯ã€‚ä¸è¿‡ï¼Œè‡ªé€‚åº”æ‰©å±•ç‚¹å¯¹è±¡çš„åˆ›å»ºï¼Œç®—æ˜¯ SPI æ¥å£å¯¹è±¡åˆ›å»ºçš„ä¸€æ¡ç‰¹æ®Šåˆ†æ”¯é€»è¾‘ã€‚å› ä¸ºï¼ŒSPI æ¥å£æœ‰å¾ˆå¤šå®ç°ç±»ï¼Œå°†æ¥è¢«å®ä¾‹åŒ–åå°±æœ‰å¾ˆå¤šä¸ªå®ä¾‹å¯¹è±¡ï¼Œè€Œè‡ªé€‚åº”æ‰©å±•ç‚¹æ˜¯ä¼—å¤šå®ä¾‹åŒ–å¯¹è±¡ä¸­çš„ç¨å¾®ç‰¹æ®Šä¸€ç‚¹çš„å¯¹è±¡ã€‚

**é‚£å…¶ä»–æ™®é€šçš„å®ç°ç±»æ˜¯æ€ä¹ˆå®ä¾‹åŒ–å¯¹è±¡çš„å‘¢ï¼Ÿ**åˆ«æ€¥ï¼Œå…ˆä¸çœ‹æºç ï¼Œæˆ‘ä»¬è¯•ç€æ¥åˆ†æä¸€ä¸‹ã€‚

ä½ çœ‹ï¼Œè‡ªé€‚åº”æ‰©å±•ç‚¹å¯¹è±¡è™½ç„¶æœ‰ç‚¹ç‰¹æ®Šï¼Œä½†ä»ç„¶æ˜¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œå®ä¾‹å¯¹è±¡åˆ›å»ºå‡ºæ¥è¿˜è¢«å‰ç½®ã€æ³¨å…¥ã€åç½®ç­‰é€»è¾‘å†æ¬¡å¤„ç†äº†ä¸€éï¼Œç‰¹æ®Šä¸æ™®é€šæœ‰ä¸€å®šçš„ç›¸ä¼¼æ€§ï¼Œè¿ç‰¹æ®Šå¯¹è±¡éƒ½æœ‰è¿™å¾…é‡ï¼Œéš¾é“æ™®é€šçš„å®ç°ç±»è¢«å®ä¾‹åŒ–çš„æ—¶å€™å°±æ²¡è¿™å¾…é‡ä¹ˆï¼Ÿ

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ¨æµ‹ï¼Œæ™®é€šå®ç°ç±»çš„å®ä¾‹åŒ–è¿‡ç¨‹ï¼Œåº”è¯¥å’Œè‡ªé€‚åº”æ‰©å±•ç‚¹å¯¹è±¡å·®ä¸å¤šï¼Œå¯æ˜¯æ€ä¹ˆéªŒè¯è¿™ä¸ªçŒœæƒ³å‘¢ï¼Ÿæˆ‘ä»¬ä¸å¦¨ä»ä»£ç å±‚é¢å»ä»”ç»†æŒ–æ˜ä¸€ä¸‹ï¼Œçœ‹çœ‹æºç å±‚é¢æœ‰æ²¡æœ‰ç›¸ä¼¼æ€§çš„é€»è¾‘ã€‚

å…ˆé¡ºç€å·²çŸ¥çš„ä»£ç çœ‹ï¼Œå‘ç°åˆ›å»ºè‡ªé€‚åº”æ‰©å±•ç‚¹æ–¹æ³•ï¼ˆcreateAdaptiveExtensionï¼‰ä¸­æœ‰å‰ç½®å¤„ç†ç­‰é€»è¾‘ï¼Œæˆ‘ä»¬ä¸å¦‚åå‘å¯»æ‰¾ä¸‹ï¼Œçœ‹çœ‹è¿™ä¸ªå‰ç½®çš„æ–¹æ³•æœ‰æ²¡æœ‰è¢«å…¶ä»–åœ°æ–¹è°ƒç”¨ï¼Ÿ**ä¸€èˆ¬ï¼Œç›¸ä¼¼çš„åŠŸèƒ½ç‚¹ï¼Œæºç å±‚é¢å¤§æ¦‚ç‡ä¼šè¿›è¡ŒæŠ½è±¡å°è£…æ¥å…±ç”¨ä»£ç ï¼Œé¿å…é‡å¤å†—ä½™ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬åå‘å¯»æ‰¾ï¼Œä¹Ÿæ˜¯ä¸ºäº†æ‰¾åˆ°è°ƒç”¨è¯¥æ–¹æ³•çš„ç›¸ä¼¼åŠŸèƒ½ç‚¹ã€‚**

æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬è®¤çœŸåå‘æ’æŸ¥ä¸€ä¸‹ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/3b/5f/3b0b58f407970e623881fc686ec77c5f.jpg?wh=4203x2049)

è¿˜çœŸå‘ç°æœ‰ä¸¤ä¸ªåœ°æ–¹è°ƒç”¨äº†ï¼Œçœ‹å¯¹åº”çš„ä»£ç ä½ç½®è¡Œæ•°ï¼Œ1232 è¡Œè½åœ¨åˆ›å»ºè‡ªé€‚åº”æ‰©å±•ç‚¹æ–¹æ³•ä¸­ï¼Œé‚£å¦å¤–çš„ 761 è¡Œï¼Œæƒ³å¿…å°±æ˜¯æ™®é€šå®ç°ç±»è¢«å®ä¾‹åŒ–çš„åœ°æ–¹äº†å§ã€‚æˆ‘ä»¬è¿›åˆ° 761 è¡Œçœ‹çœ‹ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/60/88/60eb0d35yy22407a560eeec0ca6ee788.jpg?wh=1920x696)

å‘ç°äº†ä¸€äº›æ„æƒ³ä¸åˆ°çš„æƒ…å†µï¼Œ761 è¡Œä½äºä¸€ä¸ª createExtension æ–¹æ³•ä¸­ï¼Œç¿»è¯‘ä¸€ä¸‹æ–¹æ³•åå°±æ˜¯åˆ›å»ºæ‰©å±•ç‚¹çš„æ„æ€ï¼Œæˆ‘ä»¬ç»“åˆæ–¹æ³•å…¥å‚çœ‹ï¼Œçœ‹èµ·æ¥åº”è¯¥æ˜¯ç»™å®šä¸€ä¸ªæ‰©å±•ç‚¹åç§°ï¼Œç„¶ååˆ›å»ºå‡ºå¯¹åº”çš„å®ç°ç±»å¯¹è±¡ã€‚

ä»è¿™é‡Œçš„ä»£ç çœ‹æ˜¯è¿™ä¹ˆå›äº‹ï¼Œè‡³äºçœŸå®æƒ…å†µæ˜¯ä¸æ˜¯ï¼Œæˆ‘ä»¬è¦éªŒè¯ä¸€ä¸‹ï¼Œç»§ç»­åå‘æŸ¥æ‰¾ï¼Œçœ‹çœ‹åˆæ˜¯è°è°ƒç”¨äº† createExtension åˆ›å»ºæ‰©å±•ç‚¹çš„æ–¹æ³•ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/10/39/109267a1f35b3a61182eebc4cc016e39.jpg?wh=4356x1689)

ä»ä¼—å¤šçš„è°ƒç”¨æ¥æºä¸­ï¼Œç«™åœ¨ä½¿ç”¨è€…çš„è§’åº¦æ¥çœ‹ï¼Œè°ƒç”¨æ–¹æ˜¯æ‹¿ç€ getExtension æ–¹æ³•ï¼Œä¼ å…¥æŒ‡å®šçš„æ‰©å±•åï¼Œæ¥æ‹¿å¯¹åº”çš„å®ç°ç±»ï¼Œè¿™ä¸å°±æ˜¯â€œSPI æœºåˆ¶â€ä¸­ Dubbo SPI è·å–æŒ‡å®šå®ç°ç±»çš„å†™æ³•ä¹ˆï¼Ÿæ‹¿åˆ°å®ç°ç±»å°±å¯ä»¥ä½¿ç”¨äº†ã€‚

> å›¾ä¸­è¿˜å¯ä»¥çœ‹åˆ° synchronized å…³é”®å­—åŒ…è£¹ä½äº†æ‰©å±•ç‚¹çš„åˆ›å»ºï¼Œsynchronized æ˜¯ JVM ä¸ºè§£å†³å¤šçº¿ç¨‹å¹¶å‘ç«äº‰é—®é¢˜è€Œè®¾è®¡çš„ä¸€ä¸ªå…³é”®å­—ï¼Œè¿™è¯´æ˜ Dubbo åœ¨åˆ›å»ºæŒ‡å®šæ‰©å±•ç‚¹çš„å®ç°ç±»æ—¶ï¼Œå……åˆ†è€ƒè™‘äº†çº¿ç¨‹å®‰å…¨çš„é—®é¢˜å› ç´ ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬åˆšæ‰æ¨æµ‹â€œcreateExtension æ˜¯æ™®é€šå®ç°ç±»çš„å®ä¾‹åŒ–å…¥å£â€æ˜¯æ­£ç¡®çš„ï¼Œé‚£å°±å¥½åŠäº†ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åªéœ€è¦è®¤çœŸç ”ç©¶ï¼Œä¼ å…¥ä¸€ä¸ªæŒ‡å®šçš„æ‰©å±•ç‚¹åç§°ç©¶ç«Ÿæ˜¯æ€ä¹ˆå®ä¾‹åŒ–çš„ï¼Œå°±å¤§æ¦‚æ¸…æ¥šå®ä¾‹çš„æ³¨å…¥æ˜¯æ€ä¹ˆç®¡ç†çš„äº†ã€‚

### åˆ›å»ºå®ä¾‹createExtension

è¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥æ ¹æ®æŒ‡å®šæ‰©å±•ç‚¹åç§°å»åˆ›å»ºæ‰©å±•ç‚¹å®ä¾‹å¯¹è±¡çš„æ–¹æ³•ä¸­ï¼ˆcreateExtensionï¼‰ï¼Œçœ‹çœ‹æºç æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæˆ‘å†™äº†éå¸¸è¯¦ç»†çš„æ³¨é‡Šï¼š

```java
///////////////////////////////////////////////////
// æ ¹æ®æŒ‡å®šæ‰©å±•ç‚¹åç§°å»åˆ›å»ºæ‰©å±•ç‚¹å®ä¾‹å¯¹è±¡
///////////////////////////////////////////////////
// org.apache.dubbo.common.extension.ExtensionLoader#createExtension
@SuppressWarnings("unchecked")
private T createExtension(String name, boolean wrap) {
    // getExtensionClasses ä¸ºå½“å‰ SPI æ¥å£çš„æ‰€æœ‰å®ç°ç±»çš„ç±»ä¿¡æ¯é›†åˆ
    // é€šè¿‡æŒ‡å®šçš„æ‰©å±•ç‚¹åç§° name æ¥è·å–ä¸ä¹‹å¯¹åº”çš„å®ç°ç±»ç±»ä¿¡æ¯
    Class<?> clazz = getExtensionClasses().get(name);
    // è‹¥æ‰¾ä¸åˆ°å¯¹åº”çš„æ‰©å±•ç‚¹ï¼Œæˆ–è€…å½“åˆåŠ è½½æ—¶æ‰©å±•ç‚¹æœ‰é‡å¤åç§°çš„è¯
    // è¿™é‡Œéƒ½ä¼šæŠ›å‡ºæŸ¥æ‰¾å¼‚å¸¸
    if (clazz == null || unacceptableExceptions.contains(name)) {
        throw findException(name);
    }
    
    try {
        // extensionInstances ä¸ºå½“å‰ SPI æ¥å£å·²ç»ç»è¿‡å®ä¾‹åŒ–çš„å®ä¾‹å¯¹è±¡é›†åˆ
        // ç„¶åé€šè¿‡æŒ‡å®šçš„æ‰©å±•ç‚¹åç§°çœ‹çœ‹æœ‰æ²¡æœ‰ä¸ä¹‹å¯¹åº”çš„å·²ç»æ›¾ç»åˆ›å»ºå¥½çš„å®ä¾‹å¯¹è±¡
        T instance = (T) extensionInstances.get(clazz);
        // è‹¥æ‰¾ä¸åˆ°ï¼Œè¯´æ˜æ²¡æœ‰ç¼“å­˜ï¼Œä»è€Œåˆ™è¯´æ˜è¯¥æ‰©å±•ç‚¹åç§°ä¹Ÿæ˜¯é¦–æ¬¡ä½¿ç”¨
        if (instance == null) {
            // é€šè¿‡å¹¶å‘ Map çš„ putIfAbsent æ–¹æ³•ä»¥çº¿ç¨‹å®‰å…¨çš„å½¢å¼ï¼Œ
            // æ¥ä¿è¯è¯¥å®ç°ç±»åªä¼šåˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œå®ä¾‹å¯¹è±¡æ˜¯åå°„æ–¹å¼åˆ›å»ºå‡ºæ¥çš„
            extensionInstances.putIfAbsent(clazz, createExtensionInstance(clazz));
            
            // putIfAbsent æ‰§è¡Œå®Œï¼Œåªè¦ä¸æŠ¥é”™ï¼Œé‚£å°±è¯´æ˜æŒ‡å®šæ‰©å±•ç‚¹åç§°çš„å®ç°ç±»åˆ›å»ºæˆåŠŸäº†
            // é‚£ä¹ˆå°±ç»§ç»­æŠŠåˆšåˆšåˆ›å»ºå‡ºæ¥çš„å®ä¾‹å¯¹è±¡å†æ¬¡ get å‡ºæ¥
            // æ­¤æ—¶çš„ instance åº”è¯¥ç§°ä¹‹ä¸ºåŸå§‹æœªç»è¿‡åˆå§‹åŒ–çš„è£¸ä½“å¯¹è±¡
            instance = (T) extensionInstances.get(clazz);
            
            // åˆå§‹åŒ–å‰ç½®å¤„ç†ï¼Œå³å°†åŸå§‹çš„å¯¹è±¡è¿›è¡Œå‰ç½®åŒ…è£…ç­‰å¤„ç†
            instance = postProcessBeforeInitialization(instance, name);
            
            // æ‰©å±•ç‚¹æ³¨å…¥
            injectExtension(instance);
            
            // åˆå§‹åŒ–åç½®å¤„ç†ï¼Œå³å°†å·²åˆå§‹åŒ–å®ä¾‹åŒ–æ³¨å…¥çš„å¯¹è±¡è¿›è¡Œåç½®åŒ…è£…ç­‰å¤„ç†
            instance = postProcessAfterInitialization(instance, name);
        }
        
        // wrap æ˜¯å¦éœ€è¦è¿›è¡Œè£…é¥°å™¨åŒ…è£…
        if (wrap) {
            List<Class<?>> wrapperClassesList = new ArrayList<>();
            // çœ‹çœ‹æ˜¯å¦æœ‰è£…é¥°å™¨åŒ…è£…ç±»ï¼Œå³å®ç°ç±»ä¸­å•ä¸€å‚æ•°çš„æ„é€ æ–¹æ³•æ˜¯ä¸æ˜¯ SPI æ¥å£
            if (cachedWrapperClasses != null) {
                // å¦‚æœæœ‰è£…é¥°å™¨åŒ…è£…ç±»ï¼Œé‚£ä¹ˆå°±å°†è¯¥ SPI æ¥å£ä¸­æ‰€æœ‰åŒ…è£…å®ç°ç±»è¿›è¡Œæ’åº
                wrapperClassesList.addAll(cachedWrapperClasses);
                wrapperClassesList.sort(WrapperComparator.COMPARATOR);
                Collections.reverse(wrapperClassesList);
            }
            if (CollectionUtils.isNotEmpty(wrapperClassesList)) {
                // å¾ªç¯è£…é¥°å™¨åŒ…è£…ç±»ï¼Œè¿›è¡Œå±‚å±‚å¥—å¨ƒåŒ…è£…
                for (Class<?> wrapperClass : wrapperClassesList) {
                    // è£…é¥°å™¨ç±»ä¸Šæ˜¯å¦ Wrapper æ³¨è§£
                    Wrapper wrapper = wrapperClass.getAnnotation(Wrapper.class);
                    
                    // 1. æ²¡æœ‰ wrapper æ³¨è§£ï¼Œéœ€è¦è¿›è¡ŒåŒ…è£…
                    // 2. wrapper ä¸­çš„ matches å­—æ®µå€¼ä¸ºç©ºæ²¡æœ‰å†…å®¹ï¼Œéœ€è¦è¿›è¡ŒåŒ…è£…
                    // 3. wrapper ä¸­çš„ matches å­—æ®µå€¼ä¸ä¸ºç©ºå¹¶åŒ…å«å…¥å‚ name å€¼ï¼Œå¹¶ä¸” mismatches å­—æ®µå€¼ä¸åŒ…å« name å€¼ï¼Œéœ€è¦è¿›è¡ŒåŒ…è£…
                    // 4. å…¶ä»–æƒ…å†µï¼Œå¯èƒ½å°±æ˜¯çå†™ä¹±é…ï¼Œå¯¼è‡´æ— æ³•è¿›è¡ŒåŒ…è£…ä¹‹ç±»çš„
                    boolean match = (wrapper == null) ||
                        ((ArrayUtils.isEmpty(wrapper.matches()) || ArrayUtils.contains(wrapper.matches(), name)) &&
                            !ArrayUtils.contains(wrapper.mismatches(), name));
                    
                    // å¦‚æœåŒ¹é…æˆåŠŸï¼Œåˆ™è¿›è¡ŒåŒ…è£…
                    if (match) {
                        // é’ˆå¯¹åŒ…è£…çš„ç±»å†æ¬¡è¿›è¡Œå®ä¾‹æ³¨å…¥
                        instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));
                        // é’ˆå¯¹åŒ…è£…ç±»ï¼ŒåŒæ ·è¿›è¡Œåç½®å¤„ç†
                        instance = postProcessAfterInitialization(instance, name);
                    }
                }
            }
        }
        
        // Warning: After an instance of Lifecycle is wrapped by cachedWrapperClasses, it may not still be Lifecycle instance, this application may not invoke the lifecycle.initialize hook.
        initExtension(instance);
        return instance;
    } catch (Throwable t) {
        throw new IllegalStateException("Extension instance (name: " + name + ", class: " +
            type + ") couldn't be instantiated: " + t.getMessage(), t);
    }
}
```

é¦–å…ˆï¼Œæ¯ä¸ªæ‰©å±•ç‚¹åç§°éƒ½ä¼šå¯¹åº”ä¸€ä¸ª class ç±»ä¿¡æ¯ï¼Œæ¯ä¸ªç±»ä¿¡æ¯éƒ½ä¼šå¯¹åº”ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œè€Œä¸”å®ä¾‹å¯¹è±¡éƒ½ä¼šä»¥çº¿ç¨‹å®‰å…¨çš„å½¢å¼ä¿å­˜åˆ°ç¼“å­˜ä¸­ã€‚

åˆšåå°„åˆ›å»ºå‡ºæ¥çš„æ‰©å±•ç‚¹å¯¹è±¡ï¼Œéƒ½ä¼šç»å†å‰ç½®åˆå§‹åŒ–å‰ç½®å¤„ç†ï¼ˆpostProcessBeforeInitializationï¼‰ã€æ³¨å…¥æ‰©å±•ç‚¹ï¼ˆinjectExtensionï¼‰ã€åˆå§‹åŒ–åç½®å¤„ç†ï¼ˆpostProcessAfterInitializationï¼‰ä¸‰ä¸ªé˜¶æ®µï¼Œç»è¿‡ä¸‰æ®µå¤„ç†çš„å¯¹è±¡ï¼Œæˆ‘ä»¬æš‚ä¸”ç§°ä¸ºâ€œåŸå§‹å¯¹è±¡â€ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/a7/c4/a7edfe0d35fd834d4e14b1ed086dd7c4.jpg?wh=1920x596)

ç„¶åï¼Œæ ¹æ®ä¼ å…¥çš„ wrap å˜é‡ï¼Œå†³å®šæ˜¯å¦éœ€è¦å°†åŸå§‹å¯¹è±¡å†æ¬¡è¿›è¡ŒåŒ…è£¹å¤„ç†ï¼Œè‹¥éœ€è¦åŒ…è£¹ï¼Œä¼šå°†è¯¥ SPI æ¥å£çš„æ‰€æœ‰åŒ…è£…ç±»æ’åºå¥½ï¼Œä»¥å¥—å¨ƒçš„å½¢å¼ï¼Œå°†åŸå§‹å¯¹è±¡å±‚å±‚åŒ…è£¹ã€‚è€ŒåŒ…è£…ç±»ä¸Šå¯ä»¥è®¾ç½® @Wrapper æ³¨è§£ï¼Œç»“åˆæ³¨è§£æœ‰ 3 ç§æƒ…å†µæ¥å†³å®šæ˜¯å¦éœ€è¦åŒ…è£…ï¼š

- æ—  @Wrapper æ³¨è§£ï¼Œåˆ™éœ€è¦åŒ…è£…ã€‚
- æœ‰ @Wrapper æ³¨è§£ï¼Œä½†æ˜¯æ³¨è§£ä¸­çš„ matches å­—æ®µå€¼ä¸ºç©ºï¼Œåˆ™éœ€è¦åŒ…è£…ã€‚
- æœ‰ @Wrapper æ³¨è§£ï¼Œä½†æ˜¯æ³¨è§£ä¸­çš„ matches å­—æ®µå€¼åŒ…å«å…¥å‚çš„æ‰©å±•ç‚¹åç§°ï¼Œå¹¶ä¸” mismatches å­—æ®µå€¼ä¸åŒ…å«å…¥å‚çš„æ‰©å±•ç‚¹åç§°ï¼Œåˆ™éœ€è¦åŒ…è£…ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/0a/e8/0a756a8682344f10b7b17cb1583380e8.jpg?wh=5415x1545)

### æ‹“å±•ç‚¹å¯¹è±¡çš„ä¸‰ä¸ªå¤„ç†é˜¶æ®µ

å¤§è‡´é€šè¯»äº†åˆ›å»ºæ‰©å±•ç‚¹çš„ä»£ç ï¼Œä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°äº†ï¼Œåˆšåå°„åˆ›å»ºå‡ºæ¥çš„æ‰©å±•ç‚¹å¯¹è±¡è¦ç»å†çš„ä¸‰ä¸ªé˜¶æ®µåº”è¯¥æŒºé‡è¦çš„ï¼Œæ¯•ç«Ÿä¸€ä¸ªåˆšåå°„å‡ºæ¥çš„å¯¹è±¡å°±åƒä¸€ä¸ªå©´å„¿ï¼Œä¸ªå¤´æ²¡é•¿å…¨ï¼Œæ²¡å¤šå¤§èƒ½åŠ›ï¼Œå…³é”®å¾—é åç»­åŠ å·¥å˜æˆæœ‰èƒ½åŠ›çš„æˆå¹´äººã€‚æˆ‘ä»¬é‡ç‚¹è¿›å…¥è¿™ 3 ä¸ªæ–¹æ³•ã€‚

å…ˆçœ‹ç¬¬ä¸€ä¸ªåˆå§‹åŒ–å‰ç½®å¤„ç†çš„æ–¹æ³•ã€‚

```java
///////////////////////////////////////////////////
// åˆå§‹åŒ–å‰ç½®å¤„ç†æ–¹æ³•
///////////////////////////////////////////////////
// org.apache.dubbo.common.extension.ExtensionLoader#postProcessBeforeInitialization
private T postProcessBeforeInitialization(T instance, String name) throws Exception {
    // å…ˆçœ‹çœ‹å½“å‰æ¡†æ¶ä¸­æœ‰æ²¡æœ‰è®¾ç½®è¿‡åç½®å¤„ç†å™¨ï¼Œæœ‰å°±å¾ªç¯å¤„ç†ä¸€æŠŠ
    if (extensionPostProcessors != null) {
        // å¾ªç¯æ‰€æœ‰çš„åç½®å¤„ç†å™¨ï¼Œä¾æ¬¡è°ƒç”¨åˆå§‹åŒ–å‰ç½®æ–¹æ³•
        // å¾ªç¯ä½“ä¸­éƒ½ä¼šä½¿ç”¨ç»è¿‡æ–¹æ³•å¤„ç†åçš„å¯¹è±¡ç»§ç»­ä¸‹ä¸€ä¸ªå¾ªç¯å¤„ç†ï¼Œæœ‰ç‚¹å¥—å¨ƒçš„æ€§è´¨
        for (ExtensionPostProcessor processor : extensionPostProcessors) {
            instance = (T) processor.postProcessBeforeInitialization(instance, name);
        }
    }
    // æœ€ç»ˆè¿”å›å±‚å±‚å¥—å¨ƒä¹‹åçš„å¯¹è±¡
    return instance;
}
                  â†“
///////////////////////////////////////////////////
// æ‰©å±•ç‚¹åç½®å¤„ç†å™¨ï¼ŒåŒ…å«ä¸¤ä¸ªæ–¹æ³•ï¼Œ
// postProcessBeforeInitializationï¼šåˆå§‹åŒ–å‰ç½®å¤„ç†
// postProcessAfterInitializationï¼šåˆå§‹åŒ–åç½®å¤„ç†
///////////////////////////////////////////////////
// org.apache.dubbo.common.extension.ExtensionPostProcessor
public interface ExtensionPostProcessor {
    // åˆå§‹åŒ–å‰ç½®å¤„ç†
    default Object postProcessBeforeInitialization(Object instance, String name) throws Exception {
        return instance;
    }
    // åˆå§‹åŒ–åç½®å¤„ç†
    default Object postProcessAfterInitialization(Object instance, String name) throws Exception {
        return instance;
    }
}
```

é¦–å…ˆæ˜ å…¥çœ¼å¸˜çš„å°±æ˜¯ä¸€å±‚ for å¾ªç¯ï¼Œå¾ªç¯ä¹‹å‰å…ˆçœ‹çœ‹æœ‰æ²¡æœ‰åç½®å¤„ç†å™¨åˆ—è¡¨ï¼Œæœ‰çš„è¯å°±ç›´æ¥è¿›å…¥å¾ªç¯ä½“ã€‚å¾ªç¯ä½“çš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œ**å¾ªç¯è°ƒç”¨æ¯ä¸ªåç½®å¤„ç†å™¨çš„ postProcessBeforeInitialization æ–¹æ³•ï¼ŒæŠŠæ¯ä¸€æ¬¡å¾ªç¯çš„è¿”å‚ç»“æœæ”¾åˆ°ä¸‹ä¸€æ¬¡å¾ªç¯çš„å…¥å‚ä¸­å»**ï¼Œå±‚å±‚å¥—å¨ƒï¼Œæœ€ç»ˆè¿”å›å¥—å¨ƒä¹‹åçš„å¯¹è±¡ã€‚

ä½ æœ‰æ²¡æœ‰æ„Ÿè§‰è¿™æ®µä»£ç çš„å½¢å¼æœ‰ç‚¹çœ¼ç†Ÿã€‚æ²¡é”™ï¼Œå…¶å® Spring æ¡†æ¶ä¸­ï¼Œé’ˆå¯¹ Bean å®šä¹‰ä¼šä½¿ç”¨ BeanFactoryPostProcessor è¿›è¡Œå‰åä¿®æ”¹å±æ€§å¤„ç†ï¼Œé’ˆå¯¹ Bean å¯¹è±¡ä¼šä½¿ç”¨ BeanPostProcessor è¿›è¡Œå‰åä»£ç†åŒ…è£…å¤„ç†ï¼Œå’ŒDubboè¿™é‡Œçš„æ‰‹æ³•å¦‚å‡ºä¸€è¾™ï¼Œä¸å¾—ä¸æ„Ÿæ…¨æºç è®¾è®¡è€…åœ¨è®¾è®¡æ¡†æ¶æ—¶èŠ±çš„å¿ƒæ€ï¼Œä¸ºæ¡†æ¶çš„çµæ´»æ‰©å±•å¥ å®šäº†åŸºç¡€ã€‚

å¥½ï¼Œè¯´å›æ¥ï¼Œäº†è§£äº†åˆå§‹åŒ–å‰ç½®å¤„ç†çš„é€»è¾‘ï¼Œå¦‚ä½•å¯¹åŸå§‹å¯¹è±¡è¿›è¡Œåç½®å¤„ç†çš„é€»è¾‘ï¼Œå¯¹ä½ æ¥è¯´åº”è¯¥å¾ˆç®€å•äº†ï¼Œè¿™é‡Œä¸å†å±•å¼€è®²ã€‚

æˆ‘ä»¬ç›´æ¥è¿›å…¥ç¬¬ä¸‰ä¸ªå¤„ç†â€”â€”æ³¨å…¥æ‰©å±•ç‚¹ï¼ˆinjectExtensionï¼‰ï¼Œç ”ç©¶ä¸‹åˆ°åº•æ˜¯æ€ä¹ˆæ³¨å…¥æ‰©å±•ç‚¹çš„ã€‚

```java
///////////////////////////////////////////////////
// æ³¨å…¥æ‰©å±•ç‚¹çš„æ–¹æ³•
///////////////////////////////////////////////////
// org.apache.dubbo.common.extension.ExtensionLoader#injectExtension
private T injectExtension(T instance) {
    if (injector == null) {
        return instance;
    }
    try {
        // æ‹¿åˆ°å®ä¾‹å¯¹è±¡çš„æ‰€æœ‰æ–¹æ³•é›†åˆï¼Œç„¶åè¿›è¡Œå¾ªç¯å¤„ç†
        for (Method method : instance.getClass().getMethods()) {
            // åˆ¤æ–­æ–¹æ³•æ˜¯å¦æ˜¯ set æ–¹æ³•ï¼Œæœ‰ 3 ä¸ªæ¡ä»¶ï¼š
            // 1. æ–¹æ³•å¿…é¡»æ˜¯ public å…¬æœ‰ä¿®é¥°å±æ€§
            // 2. æ–¹æ³•åç§°å¿…é¡»ä»¥ set ä¸‰ä¸ªå­—æ¯å¼€å¤´
            // 3. æ–¹æ³•çš„å…¥å‚ä¸ªæ•°å¿…é¡»æ˜¯ 1 ä¸ª
            // å¦‚æœè¿™ 3 ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³çš„è¯ï¼Œé‚£å°±ç›´æ¥ continue ä¸åšä»»ä½•å¤„ç†
            if (!isSetter(method)) {
                continue;
            }
            // å¦‚æœå‘ç°æ–¹æ³•ä¸Šæœ‰ @DisableInject æ³¨è§£çš„è¯ï¼Œåˆ™ä¹Ÿä¸åšä»»ä½•å¤„ç†
            if (method.isAnnotationPresent(DisableInject.class)) {
                continue;
            }
            // è·å–æ–¹æ³•å‚æ•°ä¸­ç¬¬ 0 ä¸ªå‚æ•°çš„ç±»å‹
            // ï¼ˆæ³¨æ„ï¼šå‰é¢é€šè¿‡ isSetter å·²ç»æ˜ç¡®æ–¹æ³•çš„å…¥å‚åªèƒ½æœ‰ 1 ä¸ªï¼‰
            Class<?> pt = method.getParameterTypes()[0];
            // å¦‚æœå‚æ•°ç±»å‹æ˜¯åŸºæœ¬ç±»å‹çš„è¯ï¼Œé‚£ä¹ˆä¹Ÿä¸åšä»»ä½•å¤„ç†äº†
            if (ReflectUtils.isPrimitives(pt)) {
                continue;
            }
            // æ¥ä¸‹æ¥ï¼Œèƒ½èµ°åˆ°è¿™é‡Œæ¥ï¼Œåˆ™è¯´æ˜éƒ½æ˜¯éœ€è¦å¤„ç†çš„æ–¹æ³•
            try {
                // è·å–æ–¹æ³•çš„å±æ€§ï¼Œä»€ä¹ˆå«å±æ€§å‘¢ï¼Ÿ
                // æ¯”å¦‚æ–¹æ³•åç§°ä¸º setVersion çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å› version å†…å®¹
                // æ¯”å¦‚æ–¹æ³•åç§°å°äº 3 ä¸ªå­—ç¬¦çš„è¯ï¼Œé‚£ä¹ˆå°±è¿”å›ç©ºå­—ç¬¦ä¸²
                String property = getSetterProperty(method);
                // ç„¶åæ ¹æ®ã€å‚æ•°ç±»å‹ã€‘+ã€æ‰©å±•ç‚¹åç§°ã€‘ç›´æ¥ä»å®¹å™¨ä¸­æ‰¾åˆ°å¯¹åº”çš„å®ä¾‹å¯¹è±¡
                // æ‰€ä»¥å¯ä»¥åæ˜ å‡ºï¼Œé€šè¿‡ set æ–¹æ³•å°±èƒ½ç›´æ¥ä»å®¹å™¨ä¸­æ‰¾åˆ°å¯¹åº”çš„å®ä¾‹å¹¶èµ‹å€¼ä¸Š
                Object object = injector.getInstance(pt, property);
                // å°†æ‹¿åˆ°çš„å®ä¾‹å¯¹è±¡é€šè¿‡åå°„æ–¹å¼èµ‹å€¼åˆ°è¯¥ method æ–¹æ³•ä¸­çš„æˆå‘˜å˜é‡
                if (object != null) {
                    method.invoke(instance, object);
                }
            } catch (Exception e) {
                logger.error("Failed to inject via method " + method.getName()
                    + " of interface " + type.getName() + ": " + e.getMessage(), e);
            }
        }
    } catch (Exception e) {
        logger.error(e.getMessage(), e);
    }
    return instance;
}
                  â†“
///////////////////////////////////////////////////
// Object object = injector.getInstance(pt, property); æ–¹æ³•çš„å®ç°é€»è¾‘
///////////////////////////////////////////////////
// org.apache.dubbo.common.extension.inject.AdaptiveExtensionInjector#getInstance
@Override
public <T> T getInstance(Class<T> type, String name) {
    // å¾ªç¯æ‰€æœ‰çš„æ‰©å±•ç‚¹æ³¨å…¥å™¨ï¼Œæ¯ä¸ªæ³¨å…¥å™¨å¯ä»¥ç²—æµ…çš„ç†è§£ä¸ºä¸€ä¸ªå®¹å™¨
    // é‚£ä¹Ÿå°±æ˜¯è¯´ï¼Œå¾ªç¯æ¯ç§å®¹å™¨ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ ¹æ®ç±»å‹åŠ åå­—ï¼Œæ‰¾åˆ°å¯¹åº”çš„å®ä¾‹å¯¹è±¡
    for (ExtensionInjector injector : injectors) {
        // å¾ªç¯æ¯ç§å®¹å™¨ï¼Œä»å®¹å™¨ä¸­æ ¹æ®ç±»å‹åŠ åå­—è·å–å®ä¾‹å¯¹è±¡
        T extension = injector.getInstance(type, name);
        // ä¸€æ—¦è·å–åˆ°äº†çš„è¯ï¼Œé‚£å°±ç›´æ¥è¿”å›å³å¯ï¼Œä¸ç”¨å†å¾ªç¯å…¶ä»–å®¹å™¨äº†
        if (extension != null) {
            return extension;
        }
    }
    return null;
}
                  â†“
///////////////////////////////////////////////////
// å¯»æ‰¾ injectors å˜é‡è¢«èµ‹å€¼çš„æ–¹æ³•ï¼Œ
// çœ‹åˆ°åˆå§‹åŒ– initialize çš„è¯ï¼Œæƒ³éƒ½ä¸ç”¨æƒ³äº†ï¼Œè‚¯å®šåœ¨æŸä¸ªåˆå§‹åŒ–ç¯å¢ƒè¢«è°ƒç”¨çš„
///////////////////////////////////////////////////
// org.apache.dubbo.common.extension.inject.AdaptiveExtensionInjector#initialize
@Override
public void initialize() throws IllegalStateException {
    // è·å–ã€æ‰©å±•ç‚¹æ³¨å…¥å™¨ã€‘çš„åŠ è½½å™¨
    ExtensionLoader<ExtensionInjector> loader = extensionAccessor.getExtensionLoader(ExtensionInjector.class);
    List<ExtensionInjector> list = new ArrayList<ExtensionInjector>();
    // ä»åŠ è½½å™¨ä¸­æ‹¿å‡ºæ‰€æœ‰çš„å¯è¢«ä½¿ç”¨çš„æ³¨å†Œå™¨å®ç°ç±»
    for (String name : loader.getSupportedExtensions()) {
        list.add(loader.getExtension(name));
    }
    // ç„¶åé€šè¿‡ä¸å¯å˜é›†åˆåŒ…è£…èµ·æ¥ï¼Œæ„å‘³ç€ä¸å…è®¸åˆ«äººå¯¹æ³¨å†Œå™¨å®ç°ç±»è¿›è¡Œä»»ä½•ä¿®æ”¹
    injectors = Collections.unmodifiableList(list);
}
```

- é¦–å…ˆï¼Œä¸€ä¸Šæ¥å°±æ˜¯ä¸ªå¤§çš„ for å¾ªç¯ï¼Œå¾ªç¯çš„ç›®æ ‡æ˜¯å®ä¾‹å¯¹è±¡çš„æ‰€æœ‰æ–¹æ³•åˆ—è¡¨ã€‚

å¾ªç¯ä½“çš„é€»è¾‘å¤§ä½“æ˜¯è¿™æ ·çš„ï¼Œå…ˆåˆ¤æ–­æ–¹æ³•ï¼Œå¦‚æœä¸æ˜¯ setter æ–¹æ³•ï¼Œä¸åšå¤„ç†ï¼Œå¦‚æœè¢« @DisableInject æ³¨è§£æ ‡è®°ï¼Œä¹Ÿä¸åšå¤„ç†ï¼Œæ–¹æ³•çš„å‚æ•°å¦‚æœæ˜¯åŸºæœ¬ç±»å‹ï¼Œè¿˜æ˜¯ä¸åšä»»ä½•å¤„ç†ã€‚å…¶ä¸­ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ setter æ–¹æ³•çš„è§„åˆ™ï¼Œæ˜¯è¿™æ ·çš„ï¼š

```java
# ç¬¦åˆ setter æ–¹æ³•çš„æ¡ä»¶
1. æ–¹æ³•å¿…é¡»æ˜¯ public å…¬æœ‰ä¿®é¥°å±æ€§
2. æ–¹æ³•åç§°å¿…é¡»ä»¥ set ä¸‰ä¸ªå­—æ¯å¼€å¤´
3. æ–¹æ³•çš„å…¥å‚ä¸ªæ•°å¿…é¡»æ˜¯ 1 ä¸ª
```

- ç´§æ¥ç€ï¼Œé€šè¿‡ getSetterProperty è¿™æ®µä»£ç ï¼Œè·å–æ–¹æ³•å¯¹åº”çš„æ‰©å±•ç‚¹åç§°ã€‚è·å–è§„åˆ™æ˜¯å…ˆå»æ‰æ–¹æ³•åå‰é¢çš„ set ä¸‰ä¸ªå­—ç¬¦ï¼ŒæŠŠå‰©ä¸‹çš„é¦–å†™å­—æ¯æ”¹ä¸ºå°å†™åå°±æ˜¯æ–¹æ³•çš„å±æ€§åã€‚
- ç„¶åï¼Œæ‹¿ç€â€œå‚æ•°ç±»å‹+æ‰©å±•ç‚¹åç§°â€ï¼Œä»æ‰€æœ‰çš„æ‰©å±•ç‚¹æ³¨å…¥å™¨ä¸­å¯»æ‰¾å¯¹åº”çš„å®ä¾‹å¯¹è±¡ï¼Œé€šè¿‡åå°„èµ‹å€¼åˆ°è¯¥æ–¹æ³•ä¸Šã€‚

å°±è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†å¾ªç¯ä½“ä¸­çš„å…¶ä¸­ä¸€ä¸ªæ–¹æ³•çš„å®ä¾‹æ³¨å…¥ã€‚

é€šè¿‡ç ”è¯»æ³¨å…¥æ‰©å±•ç‚¹æ–¹æ³•ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªé‡å¤§æƒŠå–œâ€”â€”**æ³¨å…¥çš„å…³é”®ç‚¹ï¼Œä½¿ç”¨ setter æ–¹æ³•å°±èƒ½ç›´æ¥ä»å®¹å™¨ä¸­æ‰¾åˆ°å¯¹åº”çš„å®ä¾‹ï¼Œå®Œæˆå®ä¾‹æ³¨å…¥ã€‚**

å¥½ï¼ŒcreateExtension ä¸­çš„ä¸‰ä¸ªå¤„ç†æ–¹æ³•æˆ‘ä»¬ææ¸…æ¥šäº†ï¼Œç»§ç»­çœ‹åé¢çš„é€»è¾‘ï¼Œæ ¹æ®ä¼ å…¥çš„ wrap å˜é‡ï¼Œå†³å®šæ˜¯å¦éœ€è¦å°†åŸå§‹å¯¹è±¡å†æ¬¡è¿›è¡ŒåŒ…è£¹å¤„ç†ã€‚

å…³é”®å°±æ˜¯è¿™ä¸ª cachedWrapperClasses æˆå‘˜å˜é‡ï¼Œå®ƒæ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Œåˆæ˜¯åœ¨å“ªé‡Œè¢«èµ‹å€¼çš„å‘¢ï¼Ÿ

å¯¹ç°åœ¨çš„ä½ æ¥è¯´ç›¸ä¿¡è¿™ä¸æ˜¯ä»€ä¹ˆéš¾é¢˜ï¼Œè¿˜æ˜¯é€†å‘è¿½è¸ªï¼Œçœ‹è¿™ä¸ªå˜é‡åœ¨å“ªä¸ªå°æ–¹æ³•é‡Œé¢èµ‹å€¼çš„ï¼Œå¦‚æœå°æ–¹æ³•çœ‹ä¸å‡ºï¼Œå°±ç»§ç»­é€†å‘å¯»æ‰¾å°æ–¹æ³•çš„è°ƒç”¨æ–¹ï¼Œæ€»èƒ½ç†æ¸…æ€è·¯ï¼Œæœ€ç»ˆææ¸…æ¥š cachedWrapperClasses å˜é‡æ€ä¹ˆè¢«èµ‹å€¼çš„ã€‚

æˆ‘ä»¬ç»§ç»­å¼€å¯æºç é€†å‘æŸ¥æ‰¾ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/3d/06/3db61a5bfde17682b1d0088d61183f06.jpg?wh=4182x2079)  
![å›¾ç‰‡](https://static001.geekbang.org/resource/image/fc/90/fc4aa0a1fa567c30d7ee8eed522a6390.jpg?wh=4176x2394)

ä¸€ç›´æ‰¾åˆ°äº†è¢«èµ‹å€¼çš„åœ°æ–¹ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å®ç°ç±»æ„é€ æ–¹æ³•çš„å…¥å‚æ˜¯å¯¹åº”çš„ SPI æ¥å£ï¼Œé‚£ä¹ˆè¿™æ ·çš„å®ç°ç±»å°±æ˜¯ä¸€ä¸ªåŒ…è£…ç±»ã€‚ç­”æ¡ˆæ°´è½çŸ³å‡ºï¼Œæœ‰æ²¡æœ‰è§‰å¾—å…¶å®çœ‹æºç ä¹Ÿä¸æ˜¯å¾ˆéš¾ã€‚

æˆ‘ä»¬ç®€å•å°ç»“ä¸€ä¸‹ï¼Œåˆ›å»ºæ‰©å±•ç‚¹å¯¹è±¡çš„æ—¶å€™ï¼Œ**ä¸ä½†ä¼šé€šè¿‡ setter æ–¹æ³•è¿›è¡Œå®ä¾‹æ³¨å…¥ï¼Œè€Œä¸”è¿˜ä¼šé€šè¿‡åŒ…è£…ç±»å±‚å±‚åŒ…è£¹**ï¼Œå°±åƒè¿™æ ·ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/2e/89/2ec0ab7c8967e4493f6d798345820689.jpg?wh=5706x1503)

## Dubbo å®ä¾‹æ³¨å…¥éªŒè¯

äº†è§£äº†å®ä¾‹æ³¨å…¥çš„æ ¸å¿ƒåŸç†ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¾—ç°å­¦ç°ç”¨ï¼ŒéªŒè¯ä¸‹é€šè¿‡æºç æ¨æ–­çš„ç»“è®ºåˆ°åº•æ˜¯ä¸æ˜¯å¯¹çš„ã€‚è€è§„çŸ©ï¼Œå…ˆè®¾è®¡ä¸€ä¸‹éªŒè¯çš„å¤§ä½“ä»£ç ç»“æ„ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/d6/9a/d694e49b90b8d0b693c3868a97f45e9a.jpg?wh=5118x1884)

å…ˆå®šä¹‰ä¸€ä¸ª Geek æ¥å£ï¼Œæœ‰ 4 ä¸ªå®ç°ç±»ï¼Œåˆ†åˆ«æ˜¯ Dubboã€SpringCloud ã€AppleWrapper å’Œ GeekWrapperï¼Œä½†æ˜¯ AppleWrapperã€GeekWrapper åŒ…è£…ç±»ä¸Šæœ‰ @Wrapper æ³¨è§£ã€‚ç„¶åå®šä¹‰äº†ä¸€ä¸ª Animal æ¥å£ï¼Œåªæœ‰ 1 ä¸ªå®ç°ç±» Monkeyã€‚

æˆ‘ä»¬éœ€è¦éªŒè¯3ä¸ªåŠŸèƒ½ç‚¹ï¼š

- åŠŸèƒ½ç‚¹ä¸€ï¼šé€šè¿‡ setter å¯ä»¥å®ç°æŒ‡å®šå®ç°ç±»çš„æ³¨å…¥ã€‚
- åŠŸèƒ½ç‚¹äºŒï¼šé€šè¿‡è®¾è®¡ä¸€ä¸ªæ„é€ æ–¹æ³•åªæœ‰ä¸€ä¸ªå…¥å‚ï¼Œä¸”å…¥å‚å¯¹åº”çš„ SPI æ¥å£ï¼Œå¯ä»¥æŠŠå®ç°ç±»å˜æˆåŒ…è£…ç±»ã€‚æ¯”å¦‚è¿™æ ·ï¼š

```java
public class GeekWrapper implements Geek {
    private Geek geek;
    // GeekWrapper çš„å¸¦å‚æ„é€ æ–¹æ³•ï¼Œåªä¸è¿‡å‚æ•°æ˜¯å½“å‰å®ç°ç±»å¯¹åº”çš„ SPI æ¥å£ï¼ˆGeekï¼‰
    public GeekWrapper(Geek geek) {
        this.geek = geek;
    }
    // çœç•¥å…¶ä»–éƒ¨åˆ†ä»£ç ...
}    
```

- åŠŸèƒ½ç‚¹ä¸‰ï¼š@Wrapper æ³¨è§£ä¸­çš„ mismatches æ˜¯å¯ä»¥å‰”é™¤ä¸€äº›æ‰©å±•ç‚¹åç§°çš„ï¼Œæ¯”å¦‚è¿™æ ·ï¼š

```java
@Wrapper(order = 10, mismatches = {"springcloud"})
```

è®¾è®¡å®Œæˆï¼Œæˆ‘ä»¬ç¼–å†™ä»£ç ã€‚

```java
///////////////////////////////////////////////////
// SPI æ¥å£ï¼šGeekï¼Œé»˜è®¤çš„æ‰©å±•ç‚¹å®ç°ç±»æ˜¯ Dubbo å®ç°ç±»
// å¹¶ä¸”è¯¥æ¥å£çš„ getCourse æ–¹æ³•ä¸Šæœ‰ä¸€ä¸ª @Adaptive æ³¨è§£
///////////////////////////////////////////////////
@SPI("dubbo")
public interface Geek {
    @Adaptive
    String getCourse(URL url);
}
///////////////////////////////////////////////////
// Dubbo å®ç°ç±»
///////////////////////////////////////////////////
public class Dubbo implements Geek {
    @Override
    public String getCourse(URL url) {
        return "Dubboå®æˆ˜è¿›é˜¶è¯¾ç¨‹";
    }
}
///////////////////////////////////////////////////
// SpringCloud å®ç°ç±»
///////////////////////////////////////////////////
public class SpringCloud implements Geek {
    @Override
    public String getCourse(URL url) {
        return "SpringCloudå…¥é—¨è¯¾ç¨‹100é›†";
    }
}
///////////////////////////////////////////////////
// AppleWrapper å®ç°ç±»ï¼Œå¹¶ä¸”è¯¥å®ç°ç±»ä¸Šæœ‰ä¸€ä¸ª @Wrapper æ³¨è§£, order è¶Šå°è¶Šé™æ‰§è¡Œ
///////////////////////////////////////////////////
@Wrapper(order = 1)
public class AppleWrapper implements Geek {
    private Geek geek;
    public AppleWrapper(Geek geek) {
        this.geek = geek;
    }
    @Override
    public String getCourse(URL url) {
        return "ã€è¯¾ç¨‹AppleWrapperå‰...ã€‘" + geek.getCourse(url) + "ã€è¯¾ç¨‹AppleWrapperå...ã€‘";
    }
}
///////////////////////////////////////////////////
// GeekWrapper å®ç°ç±»ï¼Œå¹¶ä¸”è¯¥å®ç°ç±»ä¸Šæœ‰ä¸€ä¸ª @Wrapper æ³¨è§£, 
// order è¶Šå°è¶Šé™æ‰§è¡Œï¼Œæ‰€ä»¥ GeekWrapper ä¼šæ¯” AppleWrapper åæ‰§è¡Œ
// ç„¶åè¿˜æœ‰ä¸€ä¸ª mismatches å±æ€§ä¸º springcloud
///////////////////////////////////////////////////
@Wrapper(order = 10, mismatches = {"springcloud"})
public class GeekWrapper implements Geek {
    private Geek geek;
    private Animal monkey;
    public void setMonkey(Animal monkey){
        this.monkey = monkey;
    }
    public GeekWrapper(Geek geek) {
        this.geek = geek;
    }
    @Override
    public String getCourse(URL url) {
        return "ã€è¯¾ç¨‹GeekWrapperå‰...ã€‘" + geek.getCourse(url) + "ã€è¯¾ç¨‹GeekWrapperå...ã€‘||ã€"+monkey.eat(url)+"ã€‘";
    }
}

///////////////////////////////////////////////////
// SPI æ¥å£ï¼šAnimal ï¼Œé»˜è®¤çš„æ‰©å±•ç‚¹å®ç°ç±»æ˜¯ Monkey å®ç°ç±»
// å¹¶ä¸”è¯¥æ¥å£çš„ eat æ–¹æ³•ä¸Šæœ‰ä¸€ä¸ª @Adaptive æ³¨è§£
///////////////////////////////////////////////////
@SPI("monkey")
public interface Animal {
    @Adaptive
    String eat(URL url);
}
///////////////////////////////////////////////////
// Dubbo å®ç°ç±»
///////////////////////////////////////////////////
public class Monkey implements Animal {
    @Override
    public String eat(URL url) {
        return "çŒ´å­åƒé¦™è•‰";
    }
}
///////////////////////////////////////////////////
// èµ„æºç›®å½•æ–‡ä»¶
// è·¯å¾„ä¸ºï¼š/META-INF/dubbo/com.hmilyylimh.cloud.inject.spi.Geek
// æ³¨æ„ï¼šGeekWrapperã€AppleWrapper ä¸¤ä¸ªåŒ…è£…ç±»æ˜¯å¯ä»¥ä¸ç”¨å†™åˆ«åçš„
///////////////////////////////////////////////////
dubbo=com.hmilyylimh.cloud.inject.spi.Dubbo
springcloud=com.hmilyylimh.cloud.inject.spi.SpringCloud
com.hmilyylimh.cloud.inject.spi.GeekWrapper
com.hmilyylimh.cloud.inject.spi.AppleWrapper

///////////////////////////////////////////////////
// èµ„æºç›®å½•æ–‡ä»¶
// è·¯å¾„ä¸ºï¼š/META-INF/dubbo/com.hmilyylimh.cloud.inject.spi.Animal
///////////////////////////////////////////////////
monkey=com.hmilyylimh.cloud.inject.spi.Monkey

///////////////////////////////////////////////////
// å¯åŠ¨ç±»ï¼ŒéªŒè¯ä»£ç ç”¨çš„
///////////////////////////////////////////////////
public static void main(String[] args) {
    ApplicationModel applicationModel = ApplicationModel.defaultModel();
    // é€šè¿‡ Geek æ¥å£è·å–æŒ‡å®šåƒ æ‰©å±•ç‚¹åŠ è½½å™¨
    ExtensionLoader<Geek> extensionLoader = applicationModel.getExtensionLoader(Geek.class);
    Geek geek = extensionLoader.getAdaptiveExtension();
    System.out.println("æ—¥å¿—1ï¼šã€æŒ‡å®šçš„ geek=springcloud çš„æƒ…å†µã€‘åŠ¨æ€è·å–ç»“æœä¸º: "
            + geek.getCourse(URL.valueOf("xyz://127.0.0.1/?geek=springcloud")));
    System.out.println("æ—¥å¿—2ï¼šã€æŒ‡å®šçš„ geek=dubbo çš„æƒ…å†µã€‘åŠ¨æ€è·å–ç»“æœä¸º: "
            + geek.getCourse(URL.valueOf("xyz://127.0.0.1/?geek=dubbo")));
    System.out.println("æ—¥å¿—3ï¼šã€ä¸æŒ‡å®šçš„ geek èµ°é»˜è®¤æƒ…å†µã€‘åŠ¨æ€è·å–ç»“æœä¸º: "
            + geek.getCourse(URL.valueOf("xyz://127.0.0.1/")));
}
```

è¿è¡Œä¸€ä¸‹ï¼Œçœ‹æ‰“å°ç»“æœã€‚

```java
æ—¥å¿—1ï¼šã€æŒ‡å®šçš„ geek=springcloud çš„æƒ…å†µã€‘åŠ¨æ€è·å–ç»“æœä¸º: ã€è¯¾ç¨‹AppleWrapperå‰...ã€‘SpringCloudå…¥é—¨è¯¾ç¨‹100é›†ã€è¯¾ç¨‹AppleWrapperå...ã€‘
æ—¥å¿—2ï¼šã€æŒ‡å®šçš„ geek=dubbo çš„æƒ…å†µã€‘åŠ¨æ€è·å–ç»“æœä¸º: ã€è¯¾ç¨‹AppleWrapperå‰...ã€‘ã€è¯¾ç¨‹GeekWrapperå‰...ã€‘Dubboå®æˆ˜è¿›é˜¶è¯¾ç¨‹ã€è¯¾ç¨‹GeekWrapperå...ã€‘||ã€çŒ´å­åƒé¦™è•‰ã€‘ã€è¯¾ç¨‹AppleWrapperå...ã€‘
æ—¥å¿—3ï¼šã€ä¸æŒ‡å®šçš„ geek èµ°é»˜è®¤æƒ…å†µã€‘åŠ¨æ€è·å–ç»“æœä¸º: ã€è¯¾ç¨‹AppleWrapperå‰...ã€‘ã€è¯¾ç¨‹GeekWrapperå‰...ã€‘Dubboå®æˆ˜è¿›é˜¶è¯¾ç¨‹ã€è¯¾ç¨‹GeekWrapperå...ã€‘||ã€çŒ´å­åƒé¦™è•‰ã€‘ã€è¯¾ç¨‹AppleWrapperå...ã€‘
```

æ—¥å¿—1ï¼ŒæŒ‡å®š geek=springcloud çš„æ—¶å€™ï¼Œæˆ‘ä»¬å‘ç° GeekWrapper å¹¶æ²¡æœ‰æ‰§è¡Œï¼Œè¯´æ˜å½“@Wrapper ä¸­çš„ mismatches å±æ€§å€¼ï¼ŒåŒ…å«å…¥å‚ç»™å®šçš„æ‰©å±•åç§°ï¼Œé‚£ä¹ˆè¿™ä¸ª GeekWrapper å°±ä¸ä¼šè§¦å‘æ‰§è¡Œã€‚

æ—¥å¿—2ï¼ŒæŒ‡å®š geek=dubbo çš„æ—¶å€™ï¼Œä¸¤ä¸ªåŒ…è£…å™¨éƒ½æ‰§è¡Œäº†ï¼Œè¯´æ˜æ„é€ æ–¹æ³•ç¡®å®æ³¨å…¥æˆåŠŸäº†ï¼Œæ„é€ æ–¹æ³•çš„æ³¨å…¥è®©å®ç°ç±»å˜æˆäº†ä¸€ä¸ªåŒ…è£…ç±»ã€‚

æ—¥å¿—2å’Œ3ï¼Œå‘ç°äº†â€œçŒ´å­åƒé¦™è•‰â€çš„æ–‡æ¡ˆï¼Œè¯´æ˜åœ¨ GeekWrapper ä¸­ setter æ³¨å…¥ä¹ŸæˆåŠŸäº†ã€‚å¦å¤–ï¼Œè¿˜å¯ä»¥çœ‹åˆ° AppleWrapper æ€»æ˜¯åœ¨ GeekWrapper ä¹‹å‰æ‰“å°æ‰§è¡Œï¼Œè¯´æ˜ @Wrapper æ³¨è§£ä¸­çš„ order å±æ€§å€¼è¶Šå°å°±è¶Šå…ˆæ‰§è¡Œï¼Œå¹¶ä¸”åŒ…è£…ç±»è¿˜æœ‰ä¸€ç§ç±»ä¼¼åˆ‡é¢æ€æƒ³çš„åŠŸèƒ½ï¼Œåœ¨æ–¹æ³•è°ƒç”¨ä¹‹å‰ã€ä¹‹åè¿›è¡Œé¢å¤–çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚

æœ€åï¼Œä»èµ„æºç›®å½• SPI æ–‡ä»¶å†…å®¹ä¸­å¯ä»¥å‘ç°ï¼ŒåŒ…è£…ç±»ä¸éœ€è¦è®¾ç½®åˆ«åï¼Œä¹Ÿå¯ä»¥è¢«æ­£ç¡®æ— è¯¯åœ°è¯†åˆ«å‡ºæ¥ã€‚

## å®ä¾‹æ³¨å…¥æ€æƒ³çš„åæ€

é€šè¿‡å®ä¾‹æ³¨å…¥çš„æºç åˆ†æä¸å®è·µéªŒè¯ï¼Œç›¸ä¿¡ä½ åº”è¯¥å¯¹å®ä¾‹æ³¨å…¥å·²ç»éå¸¸ç†Ÿæ‚‰äº†ã€‚

Spring å­˜åœ¨å®ä¾‹æ³¨å…¥ï¼ŒDubbo ä¹Ÿå­˜åœ¨å®ä¾‹æ³¨å…¥ï¼Œå®ƒä»¬é’ˆå¯¹å®ä¾‹è¿›è¡Œæ³¨å…¥çš„æ€æƒ³æ˜¯ç›¸é€šçš„ã€‚éƒ½æ˜¯æ¡†æ¶æ‹¿åˆ°å¯¹è±¡æ—¶ï¼Œå‘ç°é‡Œé¢æœ‰å¾ˆå¤šå­—æ®µå€¼æ˜¯ç©ºçš„ï¼Œæˆ–è€…æœ‰å¾ˆå¤šè®¾ç½®å±æ€§çš„æ–¹æ³•æ²¡æœ‰è¢«è°ƒç”¨ï¼Œæ¡†æ¶å°±éœ€è¦å°†å¯¹è±¡é‡Œé¢çš„å­—æ®µå€¼èµ‹å€¼ã€‚

ä½†æ˜¯ï¼Œè¦ç»™å“ªäº›å­—æ®µèµ‹å€¼ï¼ˆæˆ–è€…è¦è°ƒç”¨å“ªäº›è®¾ç½®å±æ€§çš„æ–¹æ³•ï¼‰å‘¢ï¼Ÿè¿™æ˜¯ä¸€ä¸ªé‡è¦è€ƒé‡çš„å…³é”®ç‚¹äº†ï¼Œä¹Ÿå› æ­¤è¡ç”Ÿå‡ºæ¡†æ¶éœ€è¦å€ŸåŠ©ä¸€ä¸ªæ ‡è¯†ï¼Œä¸€æ—¦å®ä¾‹å¯¹è±¡é’ˆå¯¹æŸä¸ªå­—æ®µæ‰“äº†æ ‡è¯†ï¼Œæ¡†æ¶å°±çŸ¥é“è¿™ä¸ªå­—æ®µè¦è‡ªåŠ¨æ³¨å…¥ï¼ˆæˆ–è€…å®ä¾‹å¯¹è±¡ä¸­çš„æŸäº›æ–¹æ³•æŒ‰ç…§ä¸€å®šçš„è§„èŒƒçº¦æŸç¼–å†™å¥½åï¼Œæ¡†æ¶å°±çŸ¥é“è¿™äº›ç¬¦åˆè§„èŒƒçš„å­—æ®µæˆ–æ–¹æ³•è¦è¢«å¤„ç†ï¼‰ã€‚å°±è¿™æ ·ï¼Œé€šè¿‡ç®€ç®€å•å•çš„çº¦æŸè§„èŒƒæ‰“ä¸ªæ ‡è¯†ï¼Œæ¡†æ¶å°±å®Œæˆäº†å®ä¾‹æ³¨å…¥çš„å¤§å·¥ç¨‹ã€‚

è¿™æ ·çš„æ€æƒ³è½åœ°åˆ°æ¡†æ¶åï¼Œä¸€æ¥æ˜¯èƒ½å¾ˆå¥½åœ°ç®¡ç†å½“å‰æ¡†æ¶ä¸­äº§ç”Ÿçš„å¯¹è±¡ï¼ŒäºŒæ¥å¯ä»¥è®©å¼€å‘è€…åœ¨ç¼–å†™ä»£ç å±‚é¢éå¸¸ç®€å•åœ°æ‹¿åˆ°å¯¹è±¡å»ä½¿ç”¨ï¼Œä½ åœ¨ Spring å’Œ Dubbo æ¡†æ¶ä¸­ä½¿ç”¨å¯¹è±¡æ—¶ï¼Œæ‰ä¼šè§‰å¾—éå¸¸ç®€å•ã€‚

Spring å’Œ Dubbo åœ¨å®ä¾‹æ³¨å…¥å±‚é¢çš„åŒºåˆ«ï¼Œæ¯”è¾ƒç»†å¾®ï¼Œæˆ‘ç®€å•è¯´ä¸‹ã€‚

Spring æ”¯æŒä¸‰ç§æ–¹å¼æ³¨å…¥ï¼Œå­—æ®µå±æ€§æ³¨å…¥ã€setter æ–¹æ³•æ³¨å…¥ã€æ„é€ æ–¹æ³•æ³¨å…¥ã€‚Dubbo çš„æ³¨å…¥æ–¹å¼åªæœ‰ setter æ–¹æ³•æ³¨å…¥å’Œæ„é€ æ–¹æ³•æ³¨å…¥è¿™2ç§ï¼Œå¹¶ä¸” Dubbo çš„æ„é€ æ–¹æ³•æ³¨å…¥è¿˜æœ‰å±€é™æ€§ï¼Œæ„é€ æ–¹æ³•çš„å…¥å‚ä¸ªæ•°åªèƒ½æ˜¯ä¸€ä¸ªï¼Œä¸”å…¥å‚ç±»å‹å¿…é¡»ä¸ºå½“å‰å®ç°ç±»å¯¹åº”çš„ SPI æ¥å£ç±»å‹ã€‚

## æ€»ç»“

ä»Šå¤©ï¼Œæˆ‘ä»¬ä»å­¦è¿‡çš„è·å–è‡ªé€‚åº”æ‰©å±•ç‚¹å®ä¾‹å¼€å§‹ï¼Œåæ€æ—¢ç„¶æœ‰ç‰¹æ®Šçš„å®ä¾‹åŒ–æ“ä½œï¼Œæƒ³å¿…ä¹Ÿæœ‰æ™®é€šçš„å®ä¾‹åŒ–æ“ä½œï¼Œä¸ºåç»­çš„æºç åå‘è·Ÿè¸ªæ’•å¼€äº†ä¸€é“å£å­ï¼Œæ‰¾åˆ°äº† createExtension åˆ›å»ºæ™®é€šæ‰©å±•ç‚¹çš„æ ¸å¿ƒæºç ã€‚

æ€»ç»“ä¸‹å®ä¾‹æ³¨å…¥çš„ 5 ä¸ªå…³é”®ç»“è®ºã€‚

- æ¯ä¸ªåˆæ³•çš„æ‰©å±•ç‚¹åç§°éƒ½ä¼šå¯¹åº”ä¸€ä¸ª Class ç±»ä¿¡æ¯ï¼Œå¹¶ä¸”éƒ½æ˜¯ä»¥çº¿ç¨‹å®‰å…¨çš„å½¢å¼åˆ›å»ºäº†ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„å®ä¾‹å¯¹è±¡ã€‚
- é€šè¿‡åå°„åˆ›å»ºå‡ºæ¥çš„åŸå§‹å®ç°ç±»å¯¹è±¡ï¼Œæœ€ç»ˆéƒ½ä¼šç»è¿‡åˆå§‹åŒ–å‰ç½®å¤„ç†ã€å®ä¾‹æ³¨å…¥ã€åˆå§‹åŒ–åç½®å¤„ç†ï¼Œå†å åŠ å±‚å±‚åŒ…è£…ç±»å¥—å¨ƒå¼å¤„ç†åï¼Œå˜æˆäº†ä¸€ä¸ªæœ‰è¡€æœ‰è‚‰çš„å¤æ‚å¯¹è±¡ã€‚
- å®ç°ç±»å¯ä»¥è®¾ç½® @Wrapper æ³¨è§£ï¼Œæ³¨è§£ä¸­çš„ order å±æ€§å€¼è¶Šå°åˆ™è¶Šå…ˆæ‰§è¡Œï¼Œmismatches å±æ€§å€¼åŒ…å«å…¥å‚ç»™å®šçš„æ‰©å±•ç‚¹åç§°æ—¶ï¼Œé‚£ä¹ˆè¯¥æ‰©å±•ç‚¹çš„æ–¹æ³•ä¸ä¼šè§¦å‘æ‰§è¡Œã€‚
- é€šè¿‡ setter æ–¹å¼å¯ä»¥è¿›è¡Œå®ä¾‹æ³¨å…¥ï¼Œé€šè¿‡æ„é€ æ–¹æ³•ä¸”æ„é€ æ–¹æ³•çš„å…¥å‚æ˜¯SPIæ¥å£ï¼Œå¯ä»¥å°†å®ç°ç±»å˜æˆåŒ…è£…ç±»ï¼Œè€Œä¸”åŒ…è£…ç±»èƒ½æä¾›è½»é‡çº§çš„åˆ‡é¢ç¼–ç¨‹çš„èƒ½åŠ›ã€‚
- èµ„æºç›®å½•ä¸­çš„ SPI æ–‡ä»¶å†…å®¹ï¼ŒåŒ…è£…ç±»ä¸éœ€è¦è®¾ç½®åˆ«åï¼Œå°±å¯ä»¥è¢« Dubbo æ¡†æ¶æ™ºèƒ½è¯†åˆ«ä¸ºåŒ…è£…ç±»ã€‚

### æ€è€ƒé¢˜

ç•™ä¸ªä½œä¸šç»™ä½ ï¼Œä»Šå¤©çš„ä»£ç æ¡ˆä¾‹ä¸­æœ‰ä¸ª AppleWrapper å®ç°ç±»ï¼Œå¦‚æœåˆ©ç”¨ setter æ–¹å¼åœ¨é‡Œé¢æ³¨å…¥ä¸€ä¸ª SpringCloud å®ç°ç±»ï¼Œç„¶ååœ¨ AppleWrapper.getCourse æ–¹æ³•ä¸­è°ƒç”¨åˆšåˆšæ³¨å…¥çš„ SpringCloud å®ç°ç±»çš„ getCourse æ–¹æ³•ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

æœŸå¾…çœ‹åˆ°ä½ çš„æ€è€ƒï¼Œå¦‚æœè§‰å¾—ä»Šå¤©çš„å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ä¸€èµ·è®¨è®ºã€‚æˆ‘ä»¬ä¸‹ä¸€è®²è§ã€‚

### 17 æ€è€ƒé¢˜å‚è€ƒ

ä¸Šä¸€æœŸç•™äº†ä¸ªä½œä¸šï¼Œç ”ç©¶ä¸‹ @Adaptive æ³¨è§£ä¸­çš„ value å­—æ®µæ˜¯å¹²ä»€ä¹ˆç”¨çš„ï¼Œç„¶åæ€ä¹ˆä½¿ç”¨ã€‚

æƒ³è§£ç­”è¯¥é—®é¢˜ï¼Œå…¶å®ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œè™½ç„¶æˆ‘ä»¬ä¸çŸ¥é“è¿™ä¸ª value å­—æ®µåˆ°åº•æœ‰ä»€ä¹ˆï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ value å­—æ®µåœ¨æºç ä¸­æ˜¯å¦‚ä½•è§£é‡Šçš„ï¼Œè¿›å…¥ Adaptive ä¸­ã€‚

```java
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE, ElementType.METHOD})
public @interface Adaptive {
    /**
     * Decide which target extension to be injected. The name of the target extension is decided by the parameter passed
     * in the URL, and the parameter names are given by this method.
     * <p>
     * If the specified parameters are not found from {@link URL}, then the default extension will be used for
     * dependency injection (specified in its interface's {@link SPI}).
     * <p>
     * For example, given <code>String[] {"key1", "key2"}</code>:
     * <ol>
     * <li>find parameter 'key1' in URL, use its value as the extension's name</li>
     * <li>try 'key2' for extension's name if 'key1' is not found (or its value is empty) in URL</li>
     * <li>use default extension if 'key2' doesn't exist either</li>
     * <li>otherwise, throw {@link IllegalStateException}</li>
     * </ol>
     * If the parameter names are empty, then a default parameter name is generated from interface's
     * class name with the rule: divide classname from capital char into several parts, and separate the parts with
     * dot '.', for example, for {@code org.apache.dubbo.xxx.YyyInvokerWrapper}, the generated name is
     * <code>String[] {"yyy.invoker.wrapper"}</code>.
     *
     * @return parameter names in URL
     */
    String[] value() default {};
}
```

ä»æºç ä¸­ value() æ–¹æ³•çš„æ³¨é‡Šä¸Šå¯ä»¥å¾—å‡º 3 ç‚¹ã€‚

- ç¬¬ä¸€ï¼Œvalue å­—æ®µåœ¨ @Adaptive æ³¨è§£ä¸­ï¼Œå¯ä»¥è¿™ä¹ˆå†™ï¼Œæ¯”å¦‚ï¼š@Adaptive({â€œcustomâ€, â€œgeekâ€})ã€‚
- ç¬¬äºŒï¼Œvalue ä¸­çš„ key1 å¦‚æœåœ¨ URL æ‰¾åˆ°ï¼Œå°±ä½¿ç”¨ key1 å¯¹åº”çš„å€¼åšä¸ºæ‰©å±•ç‚¹çš„åç§°ï¼Œä¹Ÿå°±æ˜¯ä¼ å…¥ ExtensionLoader.getExtension æ–¹æ³•ä¸­çš„å…¥å‚å€¼ã€‚
- ç¬¬ä¸‰ï¼Œvalue ä¸­å‡è®¾æ˜¯ {â€œkey1â€, â€œkey2â€} è¿™æ ·çš„æ ¼å¼ï¼Œè‹¥ key1 åœ¨ URL ä¸­ä¸å­˜åœ¨ï¼Œåˆ™ç»§ç»­ä½¿ç”¨ key2 ç»§ç»­ä» URL æ‰¾ï¼Œè‹¥ key2 åœ¨ URL ä¸­ä¹Ÿä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨ SPI æ¥å£ä¸­é»˜è®¤çš„æ‰©å±•ç‚¹ã€‚

ä» 3 ä¸ªç»“è®ºä¸­ï¼Œå¾—çŸ¥ value å‚æ•°å¯ä»¥è¿™ä¹ˆä½¿ç”¨å°±éå¸¸å¥½åŠäº†ï¼Œæ¥ç€æˆ‘ä»¬ä¿®æ”¹ä¸‹ä»£ç ã€‚

```java
///////////////////////////////////////////////////
// SPI æ¥å£ï¼šGeekï¼Œé»˜è®¤çš„æ‰©å±•ç‚¹å®ç°ç±»æ˜¯ Dubbo å®ç°ç±»
// å¹¶ä¸”è¯¥æ¥å£çš„ getCourse æ–¹æ³•ä¸Šæœ‰ä¸€ä¸ª @Adaptive æ³¨è§£
// ç„¶åæ·»åŠ äº†ä¸€ä¸ª getCourse2 æ–¹æ³•å¹¶å¡«å……äº†æ³¨è§£ä¸­çš„å€¼
///////////////////////////////////////////////////
@SPI("dubbo")
public interface Geek {
    @Adaptive
    String getCourse(URL url);
    
    @Adaptive({"custom", "geek"})
    String getCourse2(URL url);
}

///////////////////////////////////////////////////
// å¯åŠ¨ç±»ï¼ŒéªŒè¯ä»£ç ç”¨çš„
///////////////////////////////////////////////////
public static void main(String[] args) {
    ApplicationModel applicationModel = ApplicationModel.defaultModel();
    // é€šè¿‡ Geek æ¥å£è·å–æŒ‡å®šåƒ æ‰©å±•ç‚¹åŠ è½½å™¨
    ExtensionLoader<Geek> extensionLoader = applicationModel.getExtensionLoader(Geek.class);
    
    Geek geek = extensionLoader.getAdaptiveExtension();
    System.out.println("ã€custom æŒ‡å®šçš„ dubbo çš„æƒ…å†µã€‘åŠ¨æ€è·å–ç»“æœä¸º: "
            + geek.getCourse2(URL.valueOf("xyz://127.0.0.1/?geek=springcloud&custom=dubbo")));
    System.out.println("ã€custom æŒ‡å®šçš„ springcloud çš„æƒ…å†µï¼Œä½†æ²¡æœ‰ custom å‚æ•°ï¼Œç„¶åç›´æ¥ä½¿ç”¨ geek=dubbo å‚æ•°ã€‘åŠ¨æ€è·å–ç»“æœä¸º: "
            + geek.getCourse2(URL.valueOf("xyz://127.0.0.1/?geek=dubbo")));
    System.out.println("ã€customã€geek å‚æ•°éƒ½æ²¡æœ‰æŒ‡å®šçš„è¯ã€‘åŠ¨æ€è·å–ç»“æœä¸º: "
            + geek.getCourse2(URL.valueOf("xyz://127.0.0.1/")));
}
```

æŒ‰ç…§ value = {â€œcustomâ€, â€œgeekâ€} è¿™æ ·çš„é£æ ¼ï¼Œè®¾ç½®äº†ä¸‰ç§æƒ…å†µã€‚

- æƒ…å†µä¸€ï¼Œcustom å‚æ•°æœ‰å€¼ã€‚
- æƒ…å†µäºŒï¼Œcustom å‚æ•°ä¸å­˜åœ¨ï¼Œgeek å‚æ•°æœ‰å€¼ã€‚
- æƒ…å†µä¸‰ï¼Œcustom å‚æ•°ä¸å­˜åœ¨ï¼Œgeek å‚æ•°ä¹Ÿä¸å­˜åœ¨ã€‚

è¿è¡Œ main æ–¹æ³•å¾—å‡ºã€‚

```java
ã€custom æŒ‡å®šçš„ dubbo çš„æƒ…å†µã€‘åŠ¨æ€è·å–ç»“æœä¸º: Dubboå®æˆ˜è¿›é˜¶è¯¾ç¨‹(2)
ã€custom æŒ‡å®šçš„ springcloud çš„æƒ…å†µï¼Œä½†æ²¡æœ‰ custom å‚æ•°ï¼Œç„¶åç›´æ¥ä½¿ç”¨ geek=dubbo å‚æ•°ã€‘åŠ¨æ€è·å–ç»“æœä¸º: Dubboå®æˆ˜è¿›é˜¶è¯¾ç¨‹(2)
ã€customã€geek å‚æ•°éƒ½æ²¡æœ‰æŒ‡å®šçš„è¯ã€‘åŠ¨æ€è·å–ç»“æœä¸º: Dubboå®æˆ˜è¿›é˜¶è¯¾ç¨‹(2)
```

ä»è¿è¡Œçš„ç»“æœæ¥çœ‹ï¼Œä¹Ÿå®Œå…¨ç¬¦åˆåˆšåˆšçš„ä»è‹±æ–‡æ³¨é‡Šä¿¡æ¯ä¸­å¾—åˆ°çš„ç»“è®ºã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ2ï¼‰</strong></div><ul>
<li><span>Lum</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆè§£æƒ‘çš„å¥½å‘€ï¼ï¼ï¼ä¹‹å‰çœ‹dubboè‡ªå·±çš„spiå„ç§wrapperä»€ä¹ˆçš„ï¼Œè¿™æ¬¡ç»ˆäºç†è§£äº†ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªè£…é¥°å™¨é“¾ï¼Œåœ¨æ¯ä¸ªåœ°æ–¹å¢å¼ºä¸€ä¸‹ç›¸åº”çš„spiåŠŸèƒ½ï¼Œçªç„¶æ„Ÿè§‰dubboå¾—æºç ä¹Ÿä¸æ˜¯éš¾ä¹ˆéš¾äº†ï¼Œè‡ªå·±çœ‹æºç è·Ÿè€å¸ˆå¸¦ç€æ•™æºç  æœç„¶æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸€ç‚¹æ‹¨åæœ‰ç§èŒ…å¡é¡¿å¼€çš„æ„Ÿè§‰</p>2023-03-02</li><br/><li><span>å°ç™½ç†ŠğŸ»</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è€å¸ˆï¼Œæ ¡éªŒSPIå®ç°ç±»æ˜¯å¦éœ€è¦åŒ…è£…çš„ match é€»è¾‘æ³¨é‡Šçš„ç¬¬2ç‚¹æ˜¯ä¸æ˜¯æœ‰é—®é¢˜ï¼Ÿ
åº”è¯¥æ˜¯ï¼š
1. æ²¡æœ‰ wrapper æ³¨è§£ï¼Œéœ€è¦è¿›è¡ŒåŒ…è£…
2. wrapper ä¸­çš„ matches å­—æ®µå€¼ä¸ºç©ºæ²¡æœ‰å†…å®¹ï¼Œå¹¶ä¸” mismatches å­—æ®µå€¼ä¸åŒ…å« name å€¼ï¼Œéœ€è¦è¿›è¡ŒåŒ…è£…
3. wrapper ä¸­çš„ matches å­—æ®µå€¼ä¸ä¸ºç©ºå¹¶åŒ…å«å…¥å‚ name å€¼ï¼Œå¹¶ä¸” mismatches å­—æ®µå€¼ä¸åŒ…å« name å€¼ï¼Œéœ€è¦è¿›è¡ŒåŒ…è£…
4. å…¶ä»–æƒ…å†µï¼Œå¯èƒ½å°±æ˜¯çå†™ä¹±é…ï¼Œå¯¼è‡´æ— æ³•è¿›è¡ŒåŒ…è£…ä¹‹ç±»çš„</p>2023-12-19</li><br/>
</ul>