ä½ å¥½ï¼Œæˆ‘æ˜¯ä½•è¾‰ã€‚

é€šè¿‡ç‰¹è‰²ç¯‡çš„å­¦ä¹ ï¼Œä½ å¯ä»¥åœ¨æ—¥å¸¸å¼€å‘ä¸­æ¨ªç€èµ°äº†ï¼Œå¦‚æœä½ ç»§ç»­æ·±å…¥æŒæ¡äº†æºç ç¯‡ï¼ŒåŸºæœ¬å¯ä»¥æŠŠ Dubbo æ¡†æ¶æ¸¸åˆƒæœ‰ä½™åœ°ç©å¼„äºé¼“æŒä¹‹ä¸­ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿›å…¥æ‹“å±•ç¯‡ï¼Œå€ŸåŠ©ä¸€äº›äº§çº¿çš„çœŸå®æ¡ˆä¾‹ï¼ŒçœŸæªå®å¼¹åœ°æ•™ä½ å¦‚ä½•å……åˆ†æŒ–æ˜Dubboæ¡†æ¶çš„æ‰©å±•èƒ½åŠ›ï¼Œæ¥è§£å†³å®é™…é—®é¢˜ã€‚

ä»Šå¤©æˆ‘ä»¬æ¥å®æ“ç¬¬ä¸€ä¸ªæ‰©å±•ï¼Œé›†ç¾¤æ‰©å±•ã€‚

ä½ æœ‰æ²¡æœ‰é‡åˆ°è¿‡è¿™æ ·çš„æƒ…å†µï¼Œå¯¹äºå¤šæœºæˆ¿éƒ¨ç½²çš„ç³»ç»Ÿåº”ç”¨ï¼Œçº¿ä¸Šè¿è¡Œä¸€ç›´æ¯”è¾ƒç¨³å®šï¼Œå¯æ˜¯çªç„¶åœ¨æŸä¸€æ®µæ—¶é—´å†…ï¼Œéƒ¨åˆ†æµé‡è¯·æ±‚å…ˆå‡ºç°ä¸€äº›è¶…æ—¶å¼‚å¸¸ï¼Œç´§æ¥ç€åˆå‡ºç°ä¸€äº›æ— æä¾›è€…çš„å¼‚å¸¸ï¼Œæœ€åéƒ¨åˆ†åŠŸèƒ½å°±ä¸å¯ç”¨äº†ã€‚

æˆ‘ä»¬ç»“åˆå…·ä½“çš„è°ƒç”¨é“¾è·¯å›¾æ¥çœ‹ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/36/92/367a5e6205289515739d237c41a8bf92.png?wh=1920x1089)

è¿™æ˜¯ä¸€å¼ æ¶ˆè´¹æ–¹è°ƒç”¨æä¾›æ–¹çš„ç®€å•è°ƒç”¨é“¾è·¯å›¾ï¼Œæ¶ˆè´¹æ–¹ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶å‘ç”Ÿäº†è¶…æ—¶å¼‚å¸¸ï¼Œç„¶åç¬¬äºŒæ¬¡è°ƒç”¨æ—¶å´å‘ç”Ÿäº†æ— æä¾›è€…å¼‚å¸¸ï¼Œæ— æä¾›è€…å¼‚å¸¸ä»å­—é¢æ„æ€ä¸Šç†è§£ï¼Œå°±æ˜¯æ²¡æœ‰æœåŠ¡æä¾›è€…ï¼Œç»“æœå’ŒæœåŠ¡ä¸å¯ç”¨æ˜¯ä¸€æ ·çš„ã€‚

å¯¹äºè¿™æ ·ä¸€ä¸ªçœ‹ä¼¼éå¸¸ç®€å•çš„å¼‚å¸¸ç°è±¡ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ

## å¼‚å¸¸å¦‚ä½•è§£å†³

è¦æƒ³çŸ¥é“æ€ä¹ˆè§£å†³ï¼Œé¦–å…ˆå°±å¾—å¼„æ¸…æ¥šå¼‚å¸¸å‘ç”Ÿçš„åŸå› ã€‚

è°ƒç”¨é“¾è·¯å›¾ä¸­å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªå¼‚å¸¸ï¼Œä¸€ä¸ªæ˜¯è¶…æ—¶å¼‚å¸¸ï¼Œä¸€ä¸ªæ˜¯æ— æä¾›è€…å¼‚å¸¸ã€‚æˆ‘ä»¬å…ˆä»è¶…æ—¶å¼‚å¸¸å¼€å§‹åˆ†æã€‚

### 1. è¶…æ—¶å¼‚å¸¸å’ŒåŸå› 

é‡åˆ°å¼‚å¸¸ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€ååº”å°±æ˜¯å»è®¤çœŸé˜…è¯»å¼‚å¸¸å †æ ˆçš„è¯¦ç»†ä¿¡æ¯ã€‚

ä½ å›å¿†äº†ä¸‹è¶…æ—¶å¼‚å¸¸å †æ ˆä¿¡æ¯ã€‚

```markdown
Caused by: org.apache.dubbo.remoting.TimeoutException: Waiting server-side response timeout by scan timer. start time: 2022-10-25 20:14:16.718, end time: 2022-10-25 20:14:16.747, client elapsed: 1 ms, server elapsed: 28 ms, timeout: 5 ms, request: Request [id=2, version=2.0.2, twoway=true, event=false, broken=false, data=RpcInvocation [methodName=sayHello, parameterTypes=[class java.lang.String], arguments=[Geek], attachments={path=com.hmilyylimh.cloud.facade.demo.DemoFacade, remote.application=dubbo-04-api-boot-consumer, interface=com.hmilyylimh.cloud.facade.demo.DemoFacade, version=0.0.0, timeout=5}]], channel: /192.168.100.183:62231 -> /192.168.100.183:28043
	at org.apache.dubbo.remoting.exchange.support.DefaultFuture.doReceived(DefaultFuture.java:212)
	at org.apache.dubbo.remoting.exchange.support.DefaultFuture.received(DefaultFuture.java:176)
	at org.apache.dubbo.remoting.exchange.support.DefaultFuture$TimeoutCheckTask.notifyTimeout(DefaultFuture.java:295)
	at org.apache.dubbo.remoting.exchange.support.DefaultFuture$TimeoutCheckTask.lambda$run$0(DefaultFuture.java:282)
	at org.apache.dubbo.common.threadpool.ThreadlessExecutor$RunnableWrapper.run(ThreadlessExecutor.java:184)
	at org.apache.dubbo.common.threadpool.ThreadlessExecutor.waitAndDrain(ThreadlessExecutor.java:103)
	at org.apache.dubbo.rpc.AsyncRpcResult.get(AsyncRpcResult.java:193)
	... 29 more
```

è¯´æ˜ä¸€ä¸‹ï¼Œè¿™æ®µæŠ¥é”™ä¿¡æ¯æ˜¯æ–¹ä¾¿æˆ‘ä»¬å…·ä½“åˆ†æé—®é¢˜æ¨¡æ‹Ÿå‡ºæ¥çš„ï¼Œä½†æ—¥å¸¸ä½ çœ‹åˆ°æ¶ˆè´¹æ–¹è°ƒç”¨çš„è¶…æ—¶å¼‚å¸¸ä¿¡æ¯ä¹Ÿå¤§åŒå°å¼‚ï¼Œæ€è·¯éƒ½æ˜¯å¾ˆç±»ä¼¼çš„ã€‚

ä»å¼‚å¸¸ä¿¡æ¯ä¸­æˆ‘ä»¬çœ‹åˆ°æœ‰ä¸€ä¸ª Caused by å¼•å‘çš„ TimeoutException å¼‚å¸¸ç±»ï¼Œè€Œä¸”å¼‚å¸¸å †æ ˆéƒ½è¿™ä¹ˆæ˜æ˜¾äº†ï¼Œå¾ˆå¤šäººå°±ç†æ‰€å½“ç„¶åœ°è®¤ä¸ºæ˜¯è¶…æ—¶å¼‚å¸¸ã€‚

ä½†æˆ‘ä»¬ä¸å¦¨è®¤çœŸæƒ³æƒ³ï¼Œ**è¿™ä¸ªå¼‚å¸¸ï¼Œå•æ–¹é¢ä»æ¶ˆè´¹æ–¹å°±èƒ½æ‰¾åˆ°è¶…æ—¶çš„çœŸæ­£åŸå› ä¹ˆï¼Ÿ**

ä½ æç„¶å¤§æ‚Ÿï¼Œå¥½åƒæ˜¯å“¦ï¼Œå•çº¯ä»æ¶ˆè´¹æ–¹åˆ¤æ–­è¶…æ—¶å¼‚å¸¸å¹¶ä¸èƒ½å®šä½åˆ°çœŸå®åŸå› ï¼Œå¾—æ˜ç¡®ä¸‹æä¾›æ–¹æ˜¯ä¸æ˜¯ä¹ŸçœŸçš„å‘ç”Ÿäº†è¶…æ—¶å¼‚å¸¸æƒ…å†µã€‚å¦‚æœæä¾›æ–¹æœ‰å¼‚å¸¸ï¼Œé‚£å¥½è¯´ï¼Œé¡ºè—¤æ‘¸ç“œæ‰¾åˆ°çœŸæ­£å¼‚å¸¸çš„å †æ ˆæ—¥å¿—å°±èƒ½ç»§ç»­åˆ†æå¼‚å¸¸åŸå› ã€‚

**ä½†å¦‚æœæä¾›æ–¹æ ¹æœ¬æ²¡æœ‰æ”¶åˆ°æ¶ˆè´¹æ–¹çš„ä»»ä½•è¯·æ±‚ï¼Œåˆè¯¥å¦‚ä½•ç»§ç»­æ’æŸ¥å‘¢ï¼Ÿ**

æ¶ˆè´¹æ–¹æœ‰è¯·æ±‚ï¼Œä½†æä¾›æ–¹æœªæ”¶åˆ°ï¼Œéš¾é“è¯·æ±‚å‘é”™äº†ï¼Ÿå¥½ç«¯ç«¯çš„çº¿ä¸Šåº”ç”¨ï¼Œä¼šå‡ºç°Dubboè´Ÿè½½å‡è¡¡åˆ°é”™è¯¯çš„ç›®æ ‡IPä¸Šï¼Œå¥½åƒæœ‰ç‚¹åŒªå¤·æ‰€æ€ã€‚è™½ç„¶ä¸å¤ªç›¸ä¿¡ï¼Œä½†æˆ‘ä»¬æœ¬ç€ä¸¥è°¨çš„æ€åº¦ï¼Œè¿˜æ˜¯æ¥æ±‚è¯ä¸‹ç›®æ ‡IPæ˜¯å¦çœŸçš„æœ‰é—®é¢˜ã€‚**æœ‰å“ªäº›ç‰¹å¾å¯ä»¥è¯æ˜ç›®æ ‡IPæœ‰é—®é¢˜ï¼Ÿæˆ–è€…æœ‰å“ªä¸ªåœ°æ–¹å¯ä»¥çœ‹ä¸€çœ‹ç›®æ ‡IPçš„å¥åº·çŠ¶æ€å‘¢ï¼Ÿ**

å¿«é€Ÿè”æƒ³æ—¥å¸¸å¼€å‘ä¸­å¯ä»¥ç›‘æµ‹IPå¥åº·æƒ…å†µçš„å·¥å…·ï¼Œä½ ä¸€å®šèƒ½èƒ¸æœ‰æˆç«¹åœ°è¯´å‡º3ä¸ªæ–¹æ¡ˆï¼šå¯ä»¥ä»CATç›‘æ§å¹³å°ä¸Šè§‚å¯Ÿä¸€ä¸‹ç›®æ ‡IPæ˜¯å¦å¯ä»¥ç»§ç»­æ¥æ”¶æµé‡ï¼Œä¹Ÿå¯ä»¥ä»Prometheusä¸Šè§‚å¯Ÿæ¶ˆè´¹æ–¹åˆ°ç›®æ ‡IPçš„TCPè¿æ¥çŠ¶å†µï¼Œè¿˜å¯ä»¥ä»ç½‘ç»œå±‚é¢é€šè¿‡tcpdumpæŠ“åŒ…æ£€æµ‹æ¶ˆè´¹æ–¹åˆ°ç›®æ ‡IPçš„è¿é€šæ€§ç­‰ç­‰ã€‚

å¥½ï¼Œä¸ºæ±‚è¯ç›®æ ‡IPçš„å¥åº·çŠ¶å†µï¼Œæˆ‘ä»¬æŠŠåˆšåˆšæåˆ°çš„æ£€ç›‘æµ‹å·¥å…·æŒ¨ä¸ªè¯•ä¸€ä¸‹ï¼š

- åœ¨CATä¸Šå‘ç°äº†ç›®æ ‡IPåœ¨å‡ºé—®é¢˜æœŸé—´å‡ ä¹æ²¡æœ‰ä»»ä½•æµé‡è¿›æ¥ã€‚
- åœ¨Prometheusä¸Šå‘ç°åœ¨æœ€è¿‘ä¸€æ®µæ—¶é—´å†…TCPçš„è¿æ¥è€—æ—¶ç‰¹åˆ«å¤§ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯æœ‰SYNè¯·æ±‚æ¡æ‰‹åŒ…ï¼Œä½†æ˜¯æ²¡æœ‰SYN ACKå“åº”åŒ…ã€‚
- æ‰¾ç½‘ç»œäººå‘˜å¸®å¿™å®æ—¶tcpdumpæŠ“åŒ…æµ‹è¯•ï¼Œç»“æœä»ç„¶å‘ç°æ²¡æœ‰SYN ACKå“åº”åŒ…ã€‚

äºæ˜¯é€šè¿‡ç›‘æµ‹ç»“è®ºï¼Œæˆ‘ä»¬åŸºæœ¬ç¡®è®¤äº†ç›®æ ‡IPå¤„äºä¸å¯è¿é€šçš„çŠ¶æ€ï¼Œæ¥ç€åªéœ€è¦å»ç¡®è®¤ç›®æ ‡IPæœåŠ¡æ˜¯å®•æœºäº†è¿˜æ˜¯æµé‡è¢«æ‹¦æˆªäº†ï¼Œå°±å¤§æ¦‚çŸ¥é“çœŸç›¸äº†ã€‚

ç»è¿‡æˆ‘ä»¬ä¸€è¿ä¸²æé—®å’Œæ€è€ƒï¼Œæœºæ™ºçš„ä½ ä¹Ÿè®¸ä¼šè¯´ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥å»çœ‹çœ‹ç›®æ ‡IPæœåŠ¡æ˜¯å¦å­˜æ´»å‘¢ï¼Ÿå…¶å®ä¹Ÿå¯ä»¥ï¼Œ**æ¯•ç«Ÿé—®é¢˜æœ‰åƒä¸‡ç§ï¼Œåªè¦æŒæ¡æ’æŸ¥é—®é¢˜çš„æ€è·¯ï¼Œå°è¯•è·³è·ƒæ€§åœ°æ’æŸ¥ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚**

ä½†æ˜¯åˆ°è¿™é‡Œè¿˜æ²¡å®Œï¼Œæˆ‘ä»¬åªæ˜¯è§£å†³äº†ç¬¬ä¸€ä¸ªè¶…æ—¶å¼‚å¸¸ï¼Œæœ‰äº›èŠ‚ç‚¹èƒ½æ­£å¸¸æä¾›æœåŠ¡ï¼Œæœ‰äº›èŠ‚ç‚¹æ— æ³•æä¾›æœåŠ¡ï¼Œæ›´å·§çš„æ˜¯ç´§æ¥ç€è¿˜å†’å‡ºæ— æä¾›è€…çš„å¼‚å¸¸ï¼Œè¿™åˆæ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ

### 2. æ— æä¾›è€…å¼‚å¸¸å’ŒåŸå› 

æ— æä¾›è€…å¼‚å¸¸ï¼Œç›¸ä¿¡ä½ çœ‹åˆ°è¿™æ ·çš„å¼‚å¸¸åº”è¯¥ä¹Ÿä¸é™Œç”Ÿï¼Œå¼‚å¸¸å †æ ˆä¿¡æ¯é•¿è¿™æ ·ã€‚

```markdown
org.apache.dubbo.rpc.RpcException: Failed to invoke the method sayHello in the service com.hmilyylimh.cloud.facade.demo.DemoFacade. No provider available for the service com.hmilyylimh.cloud.facade.demo.DemoFacade from registry 127.0.0.1:2181 on the consumer 192.168.100.183 using the dubbo version 3.0.7. Please check if the providers have been started and registered.
	at org.apache.dubbo.rpc.cluster.support.AbstractClusterInvoker.checkInvokers(AbstractClusterInvoker.java:366)
	at org.apache.dubbo.rpc.cluster.support.FailoverClusterInvoker.doInvoke(FailoverClusterInvoker.java:73)
	at org.apache.dubbo.rpc.cluster.support.AbstractClusterInvoker.invoke(AbstractClusterInvoker.java:340)
	at org.apache.dubbo.rpc.cluster.router.RouterSnapshotFilter.invoke(RouterSnapshotFilter.java:46)
	at org.apache.dubbo.rpc.cluster.filter.FilterChainBuilder$CopyOfFilterChainNode.invoke(FilterChainBuilder.java:321)
	at org.apache.dubbo.monitor.support.MonitorFilter.invoke(MonitorFilter.java:99)
	... 48 more
```

æˆ‘ä»¬ç²¾å‡†æ‰¾å‡ºäº†â€œNo provider availableâ€è¿™æ ·çš„å…³é”®å­—ï¼Œè¯´æ˜çš„ç¡®å°±æ˜¯æ‰¾ä¸åˆ°æœåŠ¡æä¾›è€…ã€‚å¯æ˜¯çœ‹ç€è¿™æ®µå†å¹³å¸¸ä¸è¿‡çš„å¼‚å¸¸ä¿¡æ¯ï¼Œæœ‰ç‚¹æ— è§£äº†ï¼Œä¸ºä»€ä¹ˆä¼šæŠ¥æ— æä¾›è€…å¼‚å¸¸å‘¢ï¼Ÿåˆ°åº•æ˜¯å“ªä¸ªç¯èŠ‚èµ°ä¸è¿‡å»äº†ï¼Ÿåˆæˆ–è€…æ˜¯å“ªæ®µä»£ç å¯¼è‡´é€»è¾‘èµ°ä¸é€šäº†ï¼Ÿ

æƒ³åˆ°å“ªæ®µä»£ç ï¼Œä½ å¥½åƒæ‰¾åˆ°äº†ç ´å±€ä¹‹é“ï¼Œæˆ‘ä»¬å†ä¸‰è§‚å¯Ÿå †æ ˆå¼‚å¸¸ä¿¡æ¯ã€‚

```markdown
at org.apache.dubbo.rpc.cluster.support.AbstractClusterInvoker.checkInvokers(AbstractClusterInvoker.java:366)
at org.apache.dubbo.rpc.cluster.support.FailoverClusterInvoker.doInvoke(FailoverClusterInvoker.java:73)
```

å‘ç°æŠ¥é”™çš„å…³é”®ç‚¹æ—¥å¿—ï¼Œæ˜¯åœ¨ AbstractClusterInvoker ç±»ä¸­çš„ç¬¬ 366 è¡ŒæŠ¥é”™ã€‚  
äºæ˜¯æ‰“å¼€ AbstractClusterInvoker æºç å¯¹åº”çš„æŠ¥é”™åœ°æ–¹ã€‚

```java
protected void checkInvokers(List<Invoker<T>> invokers, Invocation invocation) {
    // æ£€æŸ¥ä¼ å…¥çš„ invokers æœåŠ¡æä¾›è€…åˆ—è¡¨ï¼Œè‹¥é›†åˆä¸ºç©ºï¼Œåˆ™ä¼šæŠ›å‡ºæ— æä¾›è€…å¼‚å¸¸
    if (CollectionUtils.isEmpty(invokers)) {
        // æŠ›å‡ºçš„ RpcException å¼‚å¸¸ä¿¡æ¯ä¸­ï¼Œä¼šæœ‰ No provider available æ˜æ˜¾çš„å…³é”®å­—
        throw new RpcException(RpcException.NO_INVOKER_AVAILABLE_AFTER_FILTER, "Failed to invoke the method "
            + invocation.getMethodName() + " in the service " + getInterface().getName()
            + ". No provider available for the service " + getDirectory().getConsumerUrl().getServiceKey()
            + " from registry " + getDirectory().getUrl().getAddress()
            + " on the consumer " + NetUtils.getLocalHost()
            + " using the dubbo version " + Version.getVersion()
            + ". Please check if the providers have been started and registered.");
    }
}
```

é€šè¿‡è¿™æ®µä»£ç ä¸­çš„ checkInvokers æ–¹æ³•å®ç°é€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œ**æ¶ˆè´¹æ–¹åœ¨å†…å­˜ä¸­æ‰¾ä¸åˆ°å¯¹åº”çš„æä¾›è€…ï¼Œæ‰ä¼šæç¤ºæ— æä¾›è€…å¼‚å¸¸**ã€‚è€Œ checkInvokers æ–¹æ³•åˆè¢« FailoverClusterInvoker ç±»è°ƒç”¨ï¼Œè€Œè¿™ä¸ª FailoverClusterInvoker ç±»ï¼Œæƒ³å¿…ä½ å·²ç»è”æƒ³åˆ°äº† FailoverCluster ç±»ï¼Œäºæ˜¯è¿›ä¸€æ­¥æ¨å¯¼æ˜¯è®¾ç½®äº† cluster = â€œfailoverâ€ å±æ€§æ‰èƒ½èµ°åˆ° FailoverCluster ç±»çš„é€»è¾‘ä¸­æ¥ã€‚

è€Œ FailoverCluster å¯¹è±¡çš„ç”Ÿæˆæ˜¯åœ¨æ¶ˆè´¹æ–¹è®¢é˜…ç¯èŠ‚ä¸­ï¼Œå¦å¤–æä¾›æ–¹ç»“ç‚¹å‘ç”Ÿå˜æ›´æ—¶ï¼Œæ¶ˆè´¹æ–¹æ„ŸçŸ¥åˆ°æ³¨å†Œä¸­å¿ƒèŠ‚ç‚¹çš„å˜åŒ–ä¹Ÿä¼šé‡æ–°ç”Ÿæˆ FailoverCluster å¯¹è±¡ã€‚

è¿™ä¸€é€šæ¢³ç†åï¼ŒcheckInvokers æ–¹æ³•ä¸­ invokers åˆ—è¡¨å¯¹åº”çš„æºæ•°æ®ï¼Œæƒ³å¿…ä½ å·²ç»æ˜ç™½ä»å“ªé‡Œæ¥äº†ï¼Œæ¶ˆè´¹æ–¹å¯åŠ¨æˆ–æ³¨å†Œä¸­å¿ƒèŠ‚ç‚¹å˜æ›´éƒ½ä¼šæ›´æ–°è¿™ä»½æºæ•°æ®ã€‚

çŸ¥é“è¿™ä»½æºæ•°æ®çš„æ¥æºï¼Œæˆ‘ä»¬å†ç»“åˆæŠ¥é”™ç»†æƒ³ï¼Œæ—¢ç„¶æ¶ˆè´¹æ–¹å·²ç»å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œåªæ˜¯åœ¨è°ƒç”¨çš„æ—¶å€™å‘ç”Ÿäº†æ— æä¾›è€…å¼‚å¸¸ï¼Œè¯´æ˜ä»€ä¹ˆï¼Ÿ

ä½ æ€ç´¢äº†å‡ ç§’ï¼Œéš¾é“æ˜¯å› ä¸ºæ³¨å†Œä¸­å¿ƒçš„èŠ‚ç‚¹å˜æ›´äº†ï¼Œå¯¼è‡´æºæ•°æ®è¢«æ›´æ–°æ²¡äº†ï¼Ÿ

æ²¡é”™ï¼Œå°±æ˜¯è¿™ä¹ˆç†è§£ã€‚è‡³äºä¸ºä»€ä¹ˆæ³¨å†Œä¸­å¿ƒçš„èŠ‚ç‚¹ä¼šå˜æ›´ï¼ŒåŸå› å°±å¾ˆå¤šäº†ï¼Œæ¯”å¦‚ï¼š

- æœåŠ¡æ–¹åŠ¨æ€æ³¨é”€äº†æŸä¸ªæ¥å£æœåŠ¡ã€‚
- æœåŠ¡æ–¹èŠ‚ç‚¹å®•æœºäº†ã€‚
- æœåŠ¡æ–¹åœ¨ä»£ç ä¸­åˆ æ‰äº†è¿™ä¸ªæ¥å£å†å¯åŠ¨ï¼Œå³æ°¸è¿œä¸ä¼šå†æä¾›æœåŠ¡äº†ã€‚
- æœåŠ¡æ–¹ä¿®æ”¹äº†æ¥å£çš„ç±»åã€æ–¹æ³•åã€‚
- æœåŠ¡æ–¹æœªè€ƒè™‘ç‰ˆæœ¬å…¼å®¹æ€§ï¼Œä¸»åŠ¨æ·»åŠ äº† groupã€version ç­‰å‚æ•°ã€‚
- â€¦â€¦

æœ‰æ²¡æœ‰å‘ç°ï¼Œæºç å±‚é¢æŠ›å‡ºçš„ä¸€ä¸ªâ€œNo provider availableâ€æ— æä¾›è€…å¼‚å¸¸ï¼Œå±…ç„¶æœ‰è¿™ä¹ˆå¤šçš„å¯èƒ½åœºæ™¯å­˜åœ¨ã€‚

é€šè¿‡ä¸€ç³»åˆ—å¯èƒ½åŸå› çš„æ’æŸ¥ï¼Œæœ€ç»ˆæˆ‘ä»¬æ’æŸ¥åˆ°å› ä¸ºèŠ‚ç‚¹å®•æœºï¼Œé€ æˆæä¾›æ–¹èŠ‚ç‚¹ä¸æ³¨å†Œä¸­å¿ƒæ–­å¼€å¿ƒè·³è¿æ¥äº†ï¼Œè¿™æ„å‘³ç€æ³¨å†Œä¸­å¿ƒä¼šåˆ æ‰æä¾›æ–¹çš„IPèŠ‚ç‚¹ï¼›ç„¶åæ¶ˆè´¹æ–¹æ„ŸçŸ¥åˆ°æ³¨å†Œä¸­å¿ƒçš„èŠ‚ç‚¹å‘ç”Ÿå˜æ›´ï¼Œä¼šæ›´æ–°æ¶ˆè´¹æ–¹æœ¬åœ°çš„æºæ•°æ®ä¿¡æ¯ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæ¶ˆè´¹æ–¹åœ¨ checkInvokers ä¸­å‘ç° invokers ä¸ºç©ºäº†ã€‚

### 3.é—®é¢˜æ€»ç»“

åˆ†æäº†è¶…æ—¶å¼‚å¸¸ã€æ— æä¾›è€…å¼‚å¸¸ï¼Œæˆ‘ä»¬æœ€ç»ˆå‘ç°æ˜¯å› ä¸ºæŸäº›æä¾›æ–¹çš„ IP èŠ‚ç‚¹å®•æœºï¼Œä½†æ˜¯è¿˜æœ‰äº›æä¾›æ–¹çš„èŠ‚ç‚¹ IP æ˜¯æ­£å¸¸æä¾›æœåŠ¡çš„ï¼Œè¿™åˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

IPä¸€äº›æ­£å¸¸ä¸€äº›ä¸æ­£å¸¸ï¼Œéš¾é“IPè¿˜æœ‰äººå“å› ç´ ä¹ˆï¼Œè¿™æ˜æ˜¾ä¸ç°å®ï¼Œä½ ç›¯ç€æœ‰é—®é¢˜çš„é‚£ä¸€å †IPæ€ç´¢äº†è‰¯ä¹…ï¼Œæ— è§£ã€‚æ˜¯æ—¶å€™æ‰¾å¤–æ´äº†ï¼Œåœ¨ä¸€ä¸ªå…¬å¸ä¸­è°å¯¹IPéå¸¸ç†Ÿæ‚‰ï¼Ÿç½‘ç»œå·¥ç¨‹å¸ˆã€‚

äºæ˜¯æˆ‘ä»¬æ‹¿ç€è¿™ä¸€å †æœ‰é—®é¢˜çš„IPå»æ‰¾ç½‘å·¥ï¼Œå¾—çŸ¥å®ƒä»¬å…¨éƒ½æ˜¯åŒä¸€ä¸ªæœºæˆ¿çš„ï¼Œå†ç»“åˆåˆšæ‰çš„æ•´ä¸ªè°ƒç”¨æµç¨‹æ­¥éª¤æ€è€ƒï¼š

1. æŸæœºæˆ¿çš„æŸæä¾›æ–¹Â IPÂ èŠ‚ç‚¹å®•æœº
2. æ¶ˆè´¹æ–¹æœ‰ç¼“å­˜ï¼Œå¼•å‘æ¶ˆè´¹æ–¹è°ƒç”¨è¶…æ—¶
3. æ¶ˆè´¹æ–¹æ„ŸçŸ¥åˆ°æ³¨å†Œä¸­å¿ƒèŠ‚ç‚¹å˜æ›´
4. æ¶ˆè´¹æ–¹æ›´æ–°æ¥å£å¯¹åº”æä¾›æ–¹æºæ•°æ®åˆ—è¡¨
5. æ¶ˆè´¹æ–¹åˆæœ‰æµé‡å‘èµ·è°ƒç”¨å‘ç”Ÿæ— æä¾›è€…å¼‚å¸¸

å¯ä»¥æ¢³ç†å‡ºä¸€å¼ ä¸åŒæœºæˆ¿ä¹‹é—´æ¶ˆè´¹è€…è°ƒç”¨æä¾›è€…çš„é“¾è·¯å›¾ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/41/76/4107f2feea860bf5969187898a8a3576.jpg?wh=1920x1022)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœºæˆ¿Aä¸æœºæˆ¿Bæ˜¯ä¸èƒ½ç›¸äº’è®¿é—®çš„ï¼Œè¿™ä¹Ÿæ­£ç¬¦åˆæœºæˆ¿çš„éš”ç¦»æ€§ã€‚

é‚£ä¹ˆå‡è®¾æœºæˆ¿Açš„æŸäº›æä¾›è€…å®•æœºäº†ï¼Œä¸”æœºæˆ¿Açš„æ¶ˆè´¹è€…çŠ¶æ€æ­£å¸¸ï¼Œéš¾é“å°±é¢„ç¤ºç€æœºæˆ¿Açš„æ¶ˆè´¹æ–¹å‘èµ·çš„è¯·æ±‚å°±æ— æ³•æ­£å¸¸è°ƒç”¨äº†ä¹ˆï¼Ÿè¿™æ ·æ˜æ˜¾ä¸åˆç†ï¼Œä¸ºä»€ä¹ˆæœºæˆ¿Açš„æä¾›è€…æœ‰é—®é¢˜ï¼Œéå¾—æŠŠæœºæˆ¿Açš„æ¶ˆè´¹è€…æ‹‰ä¸‹æ°´å¯¼è‡´å„ç§åŠŸèƒ½æ— æ³•æ­£å¸¸è¿è½¬ã€‚

é‡åˆ°è¿™ç§çŠ¶å†µï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•æ”¹å–„å‘¢ï¼Ÿ

## å®šåˆ¶Clusteræ‰©å±•

æ•´ç†ç°åœ¨çš„é—®é¢˜ï¼Œåœ¨æœºæˆ¿Açš„æ¶ˆè´¹è€…æ— æ³•è°ƒç”¨æä¾›è€…çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦æƒ³åŠæ³•è®©æ¶ˆè´¹è€…èƒ½æ­£å¸¸è°ƒç”¨æä¾›è€…æ‹¿åˆ°ç»“æœã€‚

é—®é¢˜ä¹ä¸€çœ‹ï¼Œä½ æ˜¯ä¸æ˜¯æ„Ÿè§‰è‡ªç›¸çŸ›ç›¾ã€‚æ˜æ˜åŒæœºæˆ¿å·²ç»è°ƒç”¨ä¸é€šï¼Œå†åŠ ä¸Šæœºæˆ¿ä¹‹é—´åˆæ˜¯é˜²ç«å¢™å½»åº•éš”ç¦»ï¼Œè¿˜è¦ç¡¬ç€å¤´çš®ä»å®•æœºçš„æœåŠ¡æ‹¿åˆ°å“åº”å†…å®¹ï¼Ÿé™¤éæä¾›æ–¹å®•æœºä¹‹ååˆä»¥ç¥ä¸€æ ·çš„æ¯«ç§’çº§åˆ«æ¢å¤èµ·æ¥äº†ï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨çš„å„ç§åº”ç”¨ï¼Œè¿˜æ²¡æœ‰èƒ½åœ¨æ¯«ç§’çº§åˆ«å¯åŠ¨æˆåŠŸçš„ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ç§’çº§ï¼Œå¤§å¤šæ•°éƒ½æ˜¯æ•°åç§’æ‰å¯åŠ¨æˆåŠŸã€‚

é¡ºç€åŒæœºæˆ¿çš„æ€è·¯æƒ³å¿…æ˜¯èµ°è¿›æ­»èƒ¡åŒäº†ï¼Œé‚£æ¶ˆè´¹è€…çš„è¯·æ±‚å‘ç»™è°æ‰èƒ½é€šå‘¢ï¼Ÿ

å‘ç»™è°ï¼Ÿçªç„¶ä½ çœ¼å‰ä¸€äº®ï¼Œæ¶ˆè´¹è€…å¯ä»¥å°†è¯·æ±‚å‘ç»™**ä¸­é—´å•†**å•Šï¼Œç„¶åä¸­é—´å•†æƒ³åŠæ³•æ‰¾å¯ç”¨æä¾›è€…ï¼Œè²Œä¼¼è¿™æ¡è·¯å¯è¡Œã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/a2/c3/a27e20b0468db996d8d7c72f465835c3.jpg?wh=1920x1022)

æ¶ˆè´¹æ–¹é‡åˆ°æ— æä¾›è€…å¼‚å¸¸åï¼Œæ‰å¤´å»è°ƒç”¨è½¬å‘æœåŠ¡ï¼Œç”±è½¬å‘æœåŠ¡æ‰¾å¯ç”¨æœºæˆ¿çš„å¯ç”¨æä¾›è€…å¹¶å‘èµ·è°ƒç”¨å¹¶æ‹¿åˆ°ç»“æœï¼Œå°±å¯ä»¥è®©æ¶ˆè´¹è€…æ‹¿åˆ°æ­£å¸¸è°ƒç”¨çš„ç»“æœã€‚

ä½†é—®é¢˜åˆæ¥äº†ï¼Œ**è°å†™è¿™æ®µè°ƒç”¨è½¬å‘æœåŠ¡çš„ä»£ç å‘¢ï¼Ÿ**æ˜¯æ¶ˆè´¹è€…å»å†™ä¹ˆï¼Ÿè¿˜æ˜¯è°å‘¢ï¼Ÿ

æ¶ˆè´¹è€…å†™ä¹Ÿä¸æ˜¯ä¸å¯ä»¥ï¼Œä½†æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹åœºæ™¯ï¼Œä»Šå¤©è¿™ä¸ªåº”ç”¨çš„æ¶ˆè´¹è€…é‡åˆ°æ— æä¾›è€…å¼‚å¸¸éœ€è¦è½¬å‘ï¼Œæ˜å¤©é‚£ä¸ªåº”ç”¨çš„æ¶ˆè´¹è€…é‡åˆ°æ— æä¾›è€…å¼‚å¸¸éœ€è¦è½¬å‘ï¼Œé‚£ä¹ˆå¤šçš„ç³»ç»Ÿå„ç§æ¶ˆè´¹æ–¹éƒ½éœ€è¦æ”¹ï¼Œè‚¯å®šæ˜¯æ”¹ä¸è¿‡æ¥çš„ã€‚

æ—¢ç„¶å†™ä¸è¿‡æ¥ï¼Œé‚£æŠŠè¿™æ®µä»£ç å°è£…æˆæ’ä»¶æ€»å¯ä»¥äº†ï¼Œé€šè¿‡æç‚¼å…¬å…±æ’ä»¶ï¼Œè§£å†³å¤§æ‰¹é‡åº”ç”¨çš„å…±æ€§é—®é¢˜ï¼Œè¿™æ ·æ—¢åšåˆ°äº†ä»£ç å…¬ç”¨åªç»´æŠ¤ä¸€ä»½ä»£ç ï¼Œåˆåšåˆ°äº†å¯¹åº”ç”¨çš„éä¾µå…¥ç‰¹æ€§ï¼Œå²‚ä¸æ˜¯ä¸€ä¸¾ä¸¤å¾—ã€‚

ä½†æ˜¯é—®é¢˜åˆæ¥äº†ï¼Œ**è¯¥åœ¨è°ƒç”¨çš„å“ªä¸ªç¯èŠ‚è¿›è¡Œè½¬å‘æœåŠ¡çš„å¤„ç†å‘¢ï¼Ÿ**

æˆ‘ä»¬å†ç¢ç£¨ä¸‹ï¼Œè¦è°ƒç”¨è½¬å‘æœåŠ¡ï¼Œå°±å¾—æ„ŸçŸ¥æ— æä¾›è€…å¼‚å¸¸ï¼›è¦æƒ³æ„ŸçŸ¥æ— æä¾›è€…å¼‚å¸¸ï¼Œå°±å¾—åœ¨æŠ›å¼‚å¸¸çš„å¤–å±‚è¿›è¡Œå¼‚å¸¸æ•è·å¤„ç†ã€‚

é¡ºç€è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬å»ä»£ç ç¿»äº†ç¿»æŠ›å¼‚å¸¸çš„åœ°æ–¹ï¼Œå‘ç°åœ¨ FailoverClusterInvoker#doInvoke æ–¹æ³•ä¸­ checkInvokers æ–¹æ³•ï¼Œç»†å¿ƒçš„ä½ è¿˜å‘ç°äº† checkInvokers æ–¹æ³•æ˜¯è¢« protected ä¿®é¥°çš„ï¼Œè€Œ protected ä¿®é¥°å°±æ„å‘³ç€å¯ä»¥è¢«å­ç±»é‡å†™ï¼Œè¯´æ˜æºç ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ£€æµ‹ invokers æ˜¯å¦å¯ç”¨çš„æœºåˆ¶ã€‚

**æ‰€ä»¥æ ¹æ®æºç ï¼Œä½ å‡†å¤‡å®šä¹‰ä¸€ä¸ª TransferClusterInvoker ç±»æ¥ç»§æ‰¿ FailoverClusterInvokerï¼Œç„¶åé‡å†™ checkInvokers å°±å¯ä»¥äº†**ã€‚ä½†æ˜¯ checkInvokers åªæ˜¯æ„åœ¨è®©ä½ æ£€æµ‹ï¼Œä¸æ˜¯è®©ä½ å‘ç° invokers ä¸ºç©ºå°±è°ƒç”¨è½¬å‘æœåŠ¡ï¼Œè™½è¯´é‡å†™ checkInvokers æ–¹æ³•å¯ä»¥è¾¾åˆ°ç›®çš„ï¼Œä½†å’Œè®¾è®¡è€…çš„å‘½åå§‹ç»ˆæœ‰ç‚¹ä¸ç¬¦ã€‚

æ—¢ç„¶ä¸è®¾è®¡æ„å›¾ä¸ç¬¦ï¼Œæˆ‘ä»¬åˆçœ‹åˆ° FailoverClusterInvoker çš„ doInvoke æ–¹æ³•æ˜¯è¢« public ä¿®é¥°åï¼Œ**æ˜¯ä¸æ˜¯å¯ä»¥åœ¨å­ç±» TransferClusterInvoker ä¸­è°ƒç”¨çˆ¶ç±» FailoverClusterInvoker çš„ doInvoke æ–¹æ³•ï¼Œå¹¶è¿›è¡Œ tryâ€¦catchâ€¦ æ•è·ç²¾å‡†å¼‚å¸¸å‘¢ï¼Ÿ**è¿™æ ·æ—¢ä¸ä¼šç ´åè®¾è®¡è€…çš„æ„å›¾ï¼Œè¿˜èƒ½ç²¾å‡†å¤„ç†æ— æä¾›è€…å¼‚å¸¸åè½¬å‘è°ƒç”¨ï¼Œä¹Ÿæ˜¯æŒºå®Œç¾çš„ã€‚

æˆ‘ä»¬æ¥ç¼–å†™ä»£ç ã€‚

```java
public class TransferClusterInvoker<T> extends FailoverClusterInvoker<T> {
    // æŒ‰ç…§çˆ¶ç±» FailoverClusterInvoker è¦æ±‚åˆ›å»ºçš„æ„é€ æ–¹æ³•
    public TransferClusterInvoker(Directory<T> directory) {
        super(directory);
    }
    // é‡å†™çˆ¶ç±» doInvoke å‘èµ·è¿œç¨‹è°ƒç”¨çš„æ¥å£
    @Override
    public Result doInvoke(Invocation invocation, List<Invoker<T>> invokers, LoadBalance loadbalance) throws RpcException {
        try {
            // å…ˆå®Œå…¨æŒ‰ç…§çˆ¶ç±»çš„ä¸šåŠ¡é€»è¾‘è°ƒç”¨å¤„ç†ï¼Œæ— å¼‚å¸¸åˆ™ç›´æ¥å°†ç»“æœè¿”å›
            return super.doInvoke(invocation, invokers, loadbalance);
        } catch (RpcException e) {
            // è¿™é‡Œå°±è¿›å…¥äº† RpcException å¤„ç†é€»è¾‘
            
            // å½“è°ƒç”¨å‘ç°æ— æä¾›è€…å¼‚å¸¸æè¿°ä¿¡æ¯æ—¶åˆ™å‘è½¬å‘æœåŠ¡å‘èµ·è°ƒç”¨
            if (e.getMessage().toLowerCase().contains("no provider available")){
                // TODO ä» invocation ä¸­æ‹¿åˆ°æ‰€æœ‰çš„å‚æ•°ï¼Œç„¶åå†å¤„ç†è°ƒç”¨è½¬å‘æœåŠ¡çš„é€»è¾‘
                return doTransferInvoke(invocation);
            }
            // å¦‚æœä¸æ˜¯æ— æä¾›è€…å¼‚å¸¸ï¼Œåˆ™ä¸åšä»»ä½•å¤„ç†ï¼Œå¼‚å¸¸è¯¥æ€ä¹ˆæŠ›å°±æ€ä¹ˆæŠ›
            throw e;
        }
    }
}
```

åœ¨è¿™æ®µä»£ç ä¸­ TransferClusterInvoker ä¸»è¦ç»§æ‰¿äº† FailoverClusterInvoker ç±»ï¼Œç„¶åé‡å†™äº†çˆ¶ç±»ä¸­æœ€é‡è¦çš„ doInvoke æ–¹æ³•ï¼Œé‡å†™çš„å®ç°ä½“é€»è¾‘ä¸­åŸå°ä¸åŠ¨åœ°é€šè¿‡ super.doInvoke æ–¹æ³•è°ƒç”¨çˆ¶ç±»é€»è¾‘ï¼Œåœ¨çˆ¶ç±»é€»è¾‘å‡ºç°â€œNo provider availableâ€æ— æä¾›è€…å¼‚å¸¸æ—¶ï¼Œæ‰æ•æ‰å¤„ç†è°ƒç”¨è½¬å‘æœåŠ¡ã€‚

æœ€æ ¸å¿ƒçš„é€»è¾‘æˆ‘ä»¬å·²ç»å®ç°äº†ï¼Œé‚£åœ¨ä»£ç ä¸­è¯¥æ€ä¹ˆè§¦å‘è¿™ä¸ª TransferClusterInvoker è¿ä½œå‘¢ï¼Ÿ

æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥å€Ÿé‰´å·²æœ‰æºç ç¼–å†™è°ƒç”¨çš„æ€è·¯ï¼Œç»è¿‡ä¸€ç•ªæŸ¥æ‰¾ FailoverClusterInvoker ä»£ç ç¼–å†™è°ƒç”¨å…³ç³»åï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª TransferCluster ç±»ã€‚

```java
public class TransferCluster implements Cluster {
    // è¿”å›è‡ªå®šä¹‰çš„ Invoker è°ƒç”¨å™¨
    @Override
    public <T> Invoker<T> join(Directory<T> directory, boolean buildFilterChain) throws RpcException {
        return new TransferClusterInvoker<T>(directory);
    }
}
```

è¿™æ®µä»£ç ä¸­ TransferCluster ä¸»è¦ä»¿ç…§äº† FailoverCluster çš„ç¼–ç å½¢å¼ï¼Œé€šè¿‡åœ¨ TransferCluster ç±»ä¸­åˆ›å»º TransferClusterInvoker æ¥å¤„ç†è°ƒç”¨è‡³è½¬å‘æœåŠ¡å™¨ã€‚  
å½“ TransferClusterInvokerã€TransferCluster éƒ½å®ç°å¥½åï¼ŒæŒ‰ç…§ Dubbo SPI çš„è§„èŒƒå°† TransferCluster ç±»è·¯å¾„é…ç½®åˆ° META-INF/dubbo/org.apache.dubbo.rpc.cluster.Cluster æ–‡ä»¶ä¸­ï¼Œçœ‹é…ç½®ã€‚

```plain
transferï¼com.hmilyylimh.cloud.TransferCluster
```

è¿™æ®µé…ç½®ä¸º TransferCluster å–äº†ä¸ª transfer åå­—ï¼Œå°†æ¥ç¨‹åºè°ƒç”¨çš„æ—¶å€™èƒ½å¤Ÿè¢«ç”¨ä¸Šã€‚

æœ€åæˆ‘ä»¬åªéœ€è¦åœ¨ dubbo.properties æŒ‡å®šå…¨å±€ä½¿ç”¨ï¼Œçœ‹é…ç½®ã€‚

```java
dubbo.consumer.cluster=transfer
```

å…¨å±€æŒ‡å®šåå­—å« transfer çš„é›†ç¾¤æ‰©å±•å™¨ï¼Œç„¶ååœ¨è°ƒç”¨æ—¶ä¼šè§¦å‘ TransferCluster æ¥æ‰§è¡Œé‡åˆ°æ— æä¾›è€…å¼‚å¸¸æ—¶ï¼Œæ‰å¤´è½¬å‘è°ƒç”¨è½¬å‘æœåŠ¡å™¨ã€‚

## é›†ç¾¤æ‹“å±•çš„åº”ç”¨

Dubboçš„é›†ç¾¤æ‰©å±•ï¼Œç›¸ä¿¡ä½ ç°åœ¨å·²ç»éå¸¸æ¸…æ¥šäº†ã€‚Clusterä½œä¸ºè·¯ç”±å±‚ï¼Œå°è£…å¤šä¸ªæä¾›æ–¹çš„è·¯ç”±åŠè´Ÿè½½å‡è¡¡ï¼Œå¹¶æ¡¥æ¥æ³¨å†Œä¸­å¿ƒä»¥ Invoker ä¸ºä¸­å¿ƒå‘èµ·è°ƒç”¨ï¼Œé‚£å“ªäº›åº”ç”¨åœºæ™¯å¯ä»¥è€ƒè™‘é›†ç¾¤æ‰©å±•å‘¢ï¼Ÿ

ç¬¬ä¸€ï¼ŒåŒæœºæˆ¿è¯·æ±‚æ— æ³•è¿é€šæ—¶ï¼Œå¯ä»¥è€ƒè™‘è½¬å‘HTTPè¯·æ±‚è‡³å¯ç”¨æä¾›è€…ã€‚

ç¬¬äºŒï¼Œå†…ç½‘æœ¬æœºè®¿é—®æµ‹è¯•ç¯å¢ƒæ— æ³•è¿é€šæ—¶ï¼Œå¯ä»¥è½¬å‘è¯·æ±‚è‡³HTTPåè®®çš„æ¥å£ï¼Œç„¶ååœ¨æ¥å£ä¸­æ³›åŒ–è°ƒç”¨å„ç§DubboæœåŠ¡ã€‚

ç¬¬ä¸‰ï¼Œå¦‚æœé’ˆå¯¹æ¥å£çš„å¤šä¸ªæä¾›è€…éœ€è¦åšé€‚åº”å½“å‰å…¬å¸ä¸šåŠ¡çš„ç­›é€‰ã€å‰”é™¤ã€è´Ÿè½½å‡è¡¡ä¹‹ç±»çš„è¯‰æ±‚æ—¶ï¼Œä¹Ÿæ˜¯å¯ä»¥è€ƒè™‘é›†ç¾¤æ‰©å±•çš„ã€‚

æ€»ä¹‹ï¼Œä¸ç®¡æ˜¯æ— æä¾›è€…é—®é¢˜ï¼Œè¿˜æ˜¯å…¬å¸ç‰¹æ®Šå®šåˆ¶åŒ–ç­›é€‰è´Ÿè½½é—®é¢˜ï¼Œæ ¸å¿ƒéƒ½æ˜¯åœ¨é’ˆå¯¹æ¥å£çš„æ‰€æœ‰æä¾›è€…åšé€»è¾‘å¤„ç†ï¼Œæä¾›è€…ä¸ºç©ºåšè½¬å‘å…¼å®¹å¤„ç†ï¼Œæä¾›è€…ä¸ä¸ºç©ºåšç‰¹æ®Šç­›é€‰è´Ÿè½½å¤„ç†ï¼Œç›®çš„éƒ½æ˜¯åœ¨è°ƒç”¨æ—¶åšä¸€ç§å®¹é”™å…¼å®¹å¤„ç†ï¼Œè®©åº”ç”¨ç¨‹åºæ›´åŠ å¥å£®ç¨³å®šã€‚

## æ€»ç»“

ä»Šå¤©ï¼Œæˆ‘ä»¬ä»ä¸€ä¸ªæ¶ˆè´¹æ–¹åœ¨åŒæœºæˆ¿è°ƒç”¨è¿ç»­å‘ç”Ÿä¸¤ç§å¼‚å¸¸å¼€å§‹ï¼Œåˆ†æäº†è¶…æ—¶å¼‚å¸¸å’Œæ— æä¾›è€…å¼‚å¸¸å¤§è‡´æ–¹å‘çš„å®šä½æ’æŸ¥ã€‚

é€šè¿‡CATã€Prometheusã€tcpdumpå¯ä»¥å‘ç°å¼•å‘è¶…æ—¶çš„æ·±å±‚æ¬¡åŸå› ã€‚é€šè¿‡â€œNo provider availableâ€å…³é”®å­—ï¼Œä»ä»£ç å±‚é¢åæ¨å¼•èµ·æ³¨å†ŒèŠ‚ç‚¹å˜æ›´çš„å¯èƒ½å› ç´ ï¼Œæ¥è¿›ä¸€æ­¥æ‰¾åˆ°å¼•å‘æ— æä¾›è€…å¼‚å¸¸çš„åº•å±‚åŸå› ï¼›ç„¶åæ·±å…¥æŒ–æ˜é”™è¯¯å…³é”®å­—åœ¨ä»£ç ä¸­çš„æŠ¥é”™ç‚¹ï¼Œä¸ºé—®é¢˜çš„è§£å†³æ’•å¼€äº†ä¸€é“å£å­ï¼Œæœ€ç»ˆé€šè¿‡è‡ªå®šä¹‰é›†ç¾¤æ‰©å±•ä»ä»£ç å±‚é¢è½å®æ–¹æ¡ˆã€‚

è¿™é‡Œä¹Ÿæ€»ç»“ä¸€ä¸‹è‡ªå®šä¹‰é›†ç¾¤æ‰©å±•å››éƒ¨æ›²ã€‚

- é¦–å…ˆå®šä¹‰ä¸€ä¸ª TransferClusterInvoker é›†ç¾¤æ‰©å±•å¤„ç†å™¨æ¥å¤„ç†æ ¸å¿ƒçš„è°ƒç”¨è½¬å‘é€»è¾‘ã€‚
- å…¶æ¬¡å®šä¹‰ä¸€ä¸ª TransferCluster é›†ç¾¤æ‰©å±•å™¨æ¥å°è£…é›†ç¾¤æ‰©å±•å¤„ç†å™¨ã€‚
- ç„¶ååœ¨ META-INF/dubbo/org.apache.dubbo.rpc.cluster.Cluster æ–‡ä»¶ä¸­å®šä¹‰ TransferCluster çš„ç±»è·¯å¾„å¹¶å–ä¸ªåˆ«åã€‚
- æœ€ååœ¨ dubbo.properties é…ç½®æ–‡ä»¶é€šè¿‡ä¸€ä¸ªåˆ«åæ¥æŒ‡å®šæ¶ˆè´¹è€…éœ€è¦ä½¿ç”¨çš„é›†ç¾¤æ‰©å±•å™¨ã€‚

é›†ç¾¤æ‰©å±•çš„åº”ç”¨åœºæ™¯ä¸»è¦æœ‰3ç±»ï¼ŒåŒæœºæˆ¿è¯·æ±‚æ— æ³•è¿é€šï¼Œå†…ç½‘æœ¬æœºè¯·æ±‚æµ‹è¯•ç¯å¢ƒæ— æ³•è¿é€šï¼Œç‰¹æ®Šä¸šåŠ¡éœ€è¦å¯¹æ¥å£çš„å¤šä¸ªæä¾›è€…è¿›è¡Œç­›é€‰ã€å‰”é™¤ã€è´Ÿè½½å‡è¡¡ç­‰è¯‰æ±‚ã€‚

### æ€è€ƒé¢˜

ä½ å·²ç»å­¦ä¼šäº†å¦‚ä½•ä½¿ç”¨é›†ç¾¤æ‰©å±•ç‰¹æ€§æ¥å¤„ç†æ— æ³•è¿é€šçš„é—®é¢˜äº†ï¼Œé‚£ä½ èƒ½å¦å°è¯•ç ”ç©¶å¹¶ç¼–å†™ä»£ç æ¥æ¨¡æ‹Ÿå®ç°åº”ç”¨åœºæ™¯ä¸­å†…ç½‘ç”µè„‘è¯·æ±‚æµ‹è¯•ç¯å¢ƒçš„è¿é€šé—®é¢˜å‘¢ï¼Ÿ

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/1d/f8/1dd9f9cca4894ce096be74c213b361f8.png?wh=1920x955)

å›¾ä¸­æç»˜äº†å†…ç½‘ç¯å¢ƒè°ƒç”¨æµ‹è¯•ç¯å¢ƒçš„è°ƒç”¨é“¾è·¯å›¾ï¼Œè™šæ‹Ÿå‡ºä¸€ä¸ªæ¡¥æ¥æœåŠ¡èŠ‚ç‚¹ï¼Œæ¥ä¸‹æ¥éœ€è¦æƒ³åŠæ³•è®©æ¶ˆè´¹è€…åº”ç”¨çš„æ‰€æœ‰æ¥å£ï¼Œéƒ½èƒ½é€šè¿‡æ¡¥æ¥æœåŠ¡ï¼Œè°ƒç”¨åˆ°å¯¹åº”çš„æä¾›è€…ã€‚

è¿™ä¸ªé—®é¢˜æ¶‰åŠçš„çŸ¥è¯†ä½“ç³»æ¯”è¾ƒåºå¤§ï¼Œæ‰€ä»¥è¿™é‡Œï¼Œæˆ‘ä»¬åªå®ç°â€œ**é›†ç¾¤æ‰©å±•**â€â€œ**æ¡¥æ¥æœåŠ¡é€šç”¨HTTPæ¥å£çš„å®šä¹‰**â€è¿™ä¸¤éƒ¨åˆ†åŠŸèƒ½å°±å¯ä»¥äº†ã€‚å°æç¤ºï¼Œé›†ç¾¤æ‰©å±•çš„å®ç°å¯ä»¥å‚è€ƒä»Šå¤©æ€»ç»“çš„è‡ªå®šä¹‰é›†ç¾¤æ‰©å±•å››éƒ¨æ›²ï¼Œè€ŒHTTPæ¥å£è¦å…³æ³¨å…¥å‚çš„é€šç”¨æ€§ã€‚

æœŸå¾…åœ¨ç•™è¨€åŒºçœ‹åˆ°ä½ çš„æ€è€ƒï¼Œå‚ä¸è®¨è®ºã€‚å¦‚æœè§‰å¾—ä»Šå¤©çš„å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ä¸€èµ·è®¨è®ºï¼Œå¯èƒ½å°±å¸®TAè§£å†³äº†ä¸€ä¸ªå›°æƒ‘ã€‚æˆ‘ä»¬ä¸‹ä¸€è®²è§ã€‚

### 22 æ€è€ƒé¢˜å‚è€ƒ

ä¸Šä¸€æœŸç•™äº†ä¸ªä½œä¸šï¼Œç ”ç©¶ä¸‹ encodeResponse æ–¹æ³•çš„é€»è¾‘ï¼Œæ€»ç»“ä¸ encodeRequest çš„å¼‚åŒç‚¹ã€‚

è¿™ä¸ªé—®é¢˜å…¶å®ä¸éš¾ï¼Œæˆ‘ä»¬åªè¦è®¤çœŸåˆ†æä¸€é encodeResponse æ–¹æ³•ï¼Œç­”æ¡ˆä¹Ÿå°±å‘¼ä¹‹æ¬²å‡ºäº†ã€‚ç›´æ¥è¿›å…¥ encodeResponse çš„æ–¹æ³•ä»”ç»†çœ‹çœ‹ã€‚

```java
///////////////////////////////////////////////////                  
// 1ã€org.apache.dubbo.remoting.exchange.codec.ExchangeCodec#encodeResponse
// 2ã€å°† Response å¯¹è±¡æŒ‰ç…§ Dubbo åè®®æ ¼å¼ç¼–ç ä¸ºå­—èŠ‚æµ
// 3ã€é‡ç‚¹å…³æ³¨æˆ‘åœ¨ä»£ç ä¸­æè¿°çš„ â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦ å‡ ä¸ªå…³é”®ä½ç½®
///////////////////////////////////////////////////
// header length.
protected static final int HEADER_LENGTH = 16;
// magic header.
protected static final short MAGIC = (short) 0xdabb;
protected static final byte MAGIC_HIGH = Bytes.short2bytes(MAGIC)[0];
protected static final byte MAGIC_LOW = Bytes.short2bytes(MAGIC)[1];
// message flag.
protected static final byte FLAG_REQUEST = (byte) 0x80;
protected static final byte FLAG_TWOWAY = (byte) 0x40;
protected static final byte FLAG_EVENT = (byte) 0x20;
protected static final int SERIALIZATION_MASK = 0x1f;

// å°† Response å¯¹è±¡æŒ‰ç…§ Dubbo åè®®æ ¼å¼ç¼–ç ä¸ºå­—èŠ‚æµ
protected void encodeResponse(Channel channel, ChannelBuffer buffer, Response res) throws IOException {
    int savedWriteIndex = buffer.writerIndex();
    try {
        Serialization serialization = getSerialization(channel, res);
        // header.
        // â‘  é’ˆå¯¹ header å­—èŠ‚æ•°ç»„èµ‹å€¼ä¸€ä¸ª 0xdabb é­”æœ¯å€¼
        byte[] header = new byte[HEADER_LENGTH];
        // set magic number.
        Bytes.short2bytes(MAGIC, header);
        
        // set request and serialization flag.
        // â‘¡ è®¾ç½®åºåˆ—åŒ–æ–¹å¼ï¼Œåºåˆ—åŒ–æ–¹å¼ä» channel çš„ url å–å‡º serialization å¯¹åº”çš„å‚æ•°å€¼ï¼Œ
        header[2] = serialization.getContentTypeId();
        if (res.isHeartbeat()) {
            // â‘¢ è®¾ç½®è¯·æ±‚ç±»å‹ï¼Œæ ¹æ® mTwoWayã€mEvent æ¥å†³å®šæ˜¯æ€æ ·çš„è¯·æ±‚ç±»å‹
            header[2] |= FLAG_EVENT;
        }
        
        // set response status.
        // â‘£ è®¾ç½®å“åº”ç ï¼Œè¿™é‡Œå› ä¸ºæ˜¯å“åº”æˆåŠŸï¼Œå› æ­¤ status = 20
        //
        // status çš„å€¼ï¼Œåœ¨æºç ä¸­æœ‰å¦‚ä¸‹è¿™äº›å€¼ï¼š
        // /** ok. å“åº”æˆåŠŸ */
        // public static final byte OK = 20;
        // /** client side timeout. æ¶ˆè´¹æ–¹è¶…æ—¶ */
        // public static final byte CLIENT_TIMEOUT = 30;
        // /** server side timeout. æä¾›æ–¹è¶…æ—¶ */
        // public static final byte SERVER_TIMEOUT = 31;
        // /** channel inactive, directly return the unfinished requests. é€šé“channelè¢«å…³é—­ä¸å¯ç”¨äº† */
        // public static final byte CHANNEL_INACTIVE = 35;
        // /** request format error. è¯·æ±‚æ•°æ®æ ¼å¼é”™è¯¯ */
        // public static final byte BAD_REQUEST = 40;
        // /** response format error. å“åº”æ•°æ®æ ¼å¼é”™è¯¯ */
        // public static final byte BAD_RESPONSE = 50;
        // /** service not found. æä¾›æ–¹æœåŠ¡æ‰¾ä¸åˆ° */
        // public static final byte SERVICE_NOT_FOUND = 60;
        // /** service error. æä¾›æ–¹é”™è¯¯ */
        // public static final byte SERVICE_ERROR = 70;
        // /** internal server error. æä¾›æ–¹å†…éƒ¨é”™è¯¯ */
        // public static final byte SERVER_ERROR = 80;
        // /** internal server error. æ¶ˆè´¹æ–¹å†…éƒ¨é”™è¯¯ */
        // public static final byte CLIENT_ERROR = 90;
        // /** server side threadpool exhausted and quick return. çº¿ç¨‹æ± æ»¡æ‹’ç»è¯·æ±‚ */
        // public static final byte SERVER_THREADPOOL_EXHAUSTED_ERROR = 100;        
        byte status = res.getStatus();
        header[3] = status;
        
        // â‘¤ è®¾ç½®å“åº”IDï¼Œè¯¥IDæ˜¯è¯·æ±‚å‘é€è¿‡æ¥çš„ID
        // set request id.
        Bytes.long2bytes(res.getId(), header, 4);
        buffer.writerIndex(savedWriteIndex + HEADER_LENGTH);
        ChannelBufferOutputStream bos = new ChannelBufferOutputStream(buffer);
        
        // â‘¥ æ„å»ºä¸€ä¸ªè¾“å‡ºæµï¼Œæ ¹æ® mEvent çš„å€¼æ¥å°† mData è¿›è¡Œåºåˆ—åŒ–è½¬ä¸ºå­—èŠ‚æ•°ç»„
        // encode response data or error message.
        if (status == Response.OK) {
            if(res.isHeartbeat()){
                // heartbeat response data is always null
                bos.write(CodecSupport.getNullBytesOf(serialization));
            }else {
                ObjectOutput out = serialization.serialize(channel.getUrl(), bos);
                if (res.isEvent()) {
                    encodeEventData(channel, out, res.getResult());
                } else {
                    encodeResponseData(channel, out, res.getResult(), res.getVersion());
                }
                out.flushBuffer();
                if (out instanceof Cleanable) {
                    ((Cleanable) out).cleanup();
                }
            }
        } else {
            ObjectOutput out = serialization.serialize(channel.getUrl(), bos);
            out.writeUTF(res.getErrorMessage());
            out.flushBuffer();
            if (out instanceof Cleanable) {
                ((Cleanable) out).cleanup();
            }
        }
        bos.flush();
        bos.close();
        int len = bos.writtenBytes();
        checkPayload(channel, len);
        Bytes.int2bytes(len, header, 12);
        // write
        buffer.writerIndex(savedWriteIndex);
        buffer.writeBytes(header); // write header.
        
        // â‘¦ æœ€ç»ˆå°†åºåˆ—åŒ–å‡ºæ¥çš„å­—èŠ‚æ•°ç»„çš„é•¿åº¦å¡«å……è‡³æŠ¥æ–‡ä½“é•¿åº¦ä½ç½®
        buffer.writerIndex(savedWriteIndex + HEADER_LENGTH + len);
    } catch (Throwable t) {
        // ä¸‹é¢çš„é€»è¾‘éƒ½æ˜¯å¼‚å¸¸å¤„ç†ï¼Œä¸»è¦æƒ³åŠæ³•èµ‹å€¼ statusã€errorMessage å­—æ®µ
        // å°†é”™è¯¯ä¿¡æ¯ä½“ç°å‡ºæ¥ï¼Œå‘Šè¯‰æ¶ˆè´¹æ–¹
        // clear buffer
        buffer.writerIndex(savedWriteIndex);
        // send error message to Consumer, otherwise, Consumer will wait till timeout.
        if (!res.isEvent() && res.getStatus() != Response.BAD_RESPONSE) {
            Response r = new Response(res.getId(), res.getVersion());
            r.setStatus(Response.BAD_RESPONSE);
            if (t instanceof ExceedPayloadLimitException) {
                logger.warn(t.getMessage(), t);
                try {
                    r.setErrorMessage(t.getMessage());
                    channel.send(r);
                    return;
                } catch (RemotingException e) {
                    logger.warn("Failed to send bad_response info back: " + t.getMessage() + ", cause: " + e.getMessage(), e);
                }
            } else {
                // FIXME log error message in Codec and handle in caught() of IoHanndler?
                logger.warn("Fail to encode response: " + res + ", send bad_response info instead, cause: " + t.getMessage(), t);
                try {
                    r.setErrorMessage("Failed to send response: " + res + ", cause: " + StringUtils.toString(t));
                    channel.send(r);
                    return;
                } catch (RemotingException e) {
                    logger.warn("Failed to send bad_response info back: " + res + ", cause: " + e.getMessage(), e);
                }
            }
        }
        
        // Rethrow exception
        if (t instanceof IOException) {
            throw (IOException) t;
        } else if (t instanceof RuntimeException) {
            throw (RuntimeException) t;
        } else if (t instanceof Error) {
            throw (Error) t;
        } else {
            throw new RuntimeException(t.getMessage(), t);
        }
    }
}
```

åˆ†æåï¼Œæˆ‘ä»¬å‘ç°ä¹Ÿæ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œæ€»ç»“ä¸‹æ¥æœ‰ 4 ä¸ªåŒºåˆ«ã€‚

- å¤šäº†ä¸€ä¸ªå“åº”ç çš„è®¾ç½®ï¼Œå³å¸§æ ¼å¼ä¸­çš„ç¬¬ 4 ä¸ªå­—èŠ‚å†…å®¹çš„è®¾ç½®ã€‚
- è¯·æ±‚å”¯ä¸€ ID çš„è®¾ç½®ï¼Œç”¨çš„æ˜¯æ¥æ”¶è¯·æ±‚æ—¶ ID å€¼ã€‚
- è‹¥å“åº”ç ä¸æ˜¯ OKï¼Œå°±ç›´æ¥å°† errorMessage åˆ·åˆ°äº†å“åº”ä½“æ•°æ®ä¸­ã€‚
- å¤šäº†æ¯”è¾ƒä¸°å¯Œçš„å¼‚å¸¸å¤„ç†ï¼Œå¹¶ä¸”é’ˆå¯¹ä¸€äº›ç‰¹æ®Šçš„å¼‚å¸¸ï¼Œä¼šå°†å¼‚å¸¸ä¿¡æ¯å‘é€å›æ¶ˆè´¹æ–¹ï¼Œä»¥ä¾¿æ¶ˆè´¹æ–¹æ„ŸçŸ¥åˆ°æä¾›æ–¹åˆ°åº•æ˜¯å‡ºç°äº†ä»€ä¹ˆå¼‚å¸¸ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ1ï¼‰</strong></div><ul>
<li><span>æ¨è€å¸ˆ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>doTransferInvoke(invocation);

è€å¸ˆï¼Œè¿™å—è°ƒç”¨è½¬å‘æœåŠ¡çš„é€»è¾‘ï¼Œå¤§è‡´æ€è·¯æ˜¯å•¥æ ·çš„ï¼Ÿ
å¯ä»¥è¿ç”¨ä¹‹å‰å­¦åˆ°çš„ç‚¹ç‚¹ç›´è¿å—ï¼Ÿ</p>2023-03-09</li><br/>
</ul>