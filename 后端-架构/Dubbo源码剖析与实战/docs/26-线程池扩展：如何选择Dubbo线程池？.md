ä½ å¥½ï¼Œæˆ‘æ˜¯ä½•è¾‰ã€‚ä»Šå¤©æˆ‘ä»¬ç»§ç»­å­¦ä¹ Dubboæ‹“å±•çš„ç¬¬å››ç¯‡ï¼Œçº¿ç¨‹æ± æ‰©å±•ã€‚

æåˆ°çº¿ç¨‹æ± ï¼Œæˆ‘ä»¬åœ¨å‰é¢â€œ[å¼‚æ­¥åŒ–å®è·µ](https://time.geekbang.org/column/article/611392)â€ä¸­é€šè¿‡â€œçº¿ç¨‹æ± è€—å°½â€è¿™ä¸ªç°è±¡å·²ç»æ¥è§¦åˆ°äº†ï¼ŒDubbo é‡‡ç”¨é»˜è®¤çš„çº¿ç¨‹æ± ï¼Œä¹Ÿå°±æ˜¯ 200 ä¸ªæ ¸å¿ƒçº¿ç¨‹ï¼Œæ¥æä¾›æœåŠ¡ï¼Œå…¶å®æˆ‘ä»¬å·²ç»ç”¨å¾—éå¸¸èˆ’æœäº†ï¼Œä¸šåŠ¡æ­£å¸¸è¿è½¬æ²¡ä»€ä¹ˆé˜»ç¢ã€‚

ä¸è¿‡ä½ çŸ¥é“å—ï¼ŒDubbo æ¡†æ¶é‡Œé¢å…¶å®æœ‰ 4 ç§çº¿ç¨‹æ± ï¼Œé‚£å…¶ä»–çš„çº¿ç¨‹æ± å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨æ—¶è¯¥æ€ä¹ˆé€‰æ‹©å‘¢ï¼Ÿ

å¸¦ç€è¿™ä¸ªé—®é¢˜ï¼Œä»Šå¤©æˆ‘ä»¬æ¥ç‚¹è½»æ¾çš„ï¼Œå¸¦ä½ æŒæ¡ Dubbo 4 ç§çº¿ç¨‹æ± çš„ç”¨æ³•ã€‚

## çº¿ç¨‹æ± åŸç†

åœ¨å…·ä½“åˆ†ææ¯ä¸€ç§çº¿ç¨‹æ± ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯å›å¿†ä¸€ä¸‹åˆ›å»ºçº¿ç¨‹æ± çš„æ ¸å¿ƒä»£ç å‚æ•°ï¼Œçœ‹ä¸€çœ‹æ·»åŠ ä»»åŠ¡åˆ°çº¿ç¨‹æ± çš„å¤§è‡´å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆæ ·çš„ã€‚

```java
///////////////////////////////////////////////////
// java.util.concurrent.ThreadPoolExecutor#ThreadPoolExecutor(int, int, long, java.util.concurrent.TimeUnit, java.util.concurrent.BlockingQueue<java.lang.Runnable>, java.util.concurrent.ThreadFactory, java.util.concurrent.RejectedExecutionHandler)
// çº¿ç¨‹æ± æœ€æ ¸å¿ƒçš„æ„é€ æ–¹æ³•
///////////////////////////////////////////////////
public ThreadPoolExecutor(int corePoolSize,
                          int maximumPoolSize,
                          long keepAliveTime,
                          TimeUnit unit,
                          BlockingQueue<Runnable> workQueue,
                          ThreadFactory threadFactory,
                          RejectedExecutionHandler handler) {
    // æ ¸å¿ƒçº¿ç¨‹æ•°é‡å°äº 0ï¼Œåˆ™æŠ›å‡ºå‚æ•°éæ³•å¼‚å¸¸
    if (corePoolSize < 0 ||
        // æœ€å¤§çº¿ç¨‹æ•°é‡å°äºç­‰äº 0ï¼Œåˆ™æŠ›å‡ºå‚æ•°éæ³•å¼‚å¸¸
        maximumPoolSize <= 0 ||
        // æœ€å¤§çº¿ç¨‹æ•°é‡å°äºæ ¸å¿ƒçº¿ç¨‹æ•°é‡ï¼Œåˆ™æŠ›å‡ºå‚æ•°éæ³•å¼‚å¸¸
        maximumPoolSize < corePoolSize ||
        // éæ ¸å¿ƒçº¿ç¨‹ç©ºé—²æ—¶çš„å­˜æ´»æ—¶é—´å°äº0ï¼Œåˆ™æŠ›å‡ºå‚æ•°éæ³•å¼‚å¸¸
        keepAliveTime < 0)
        throw new IllegalArgumentException();
    // æ²¡æœ‰é…ç½®ä»»åŠ¡é˜Ÿåˆ—ã€æ²¡æœ‰é…ç½®åˆ›å»ºçº¿ç¨‹çš„å·¥å‚ã€æ²¡æœ‰é…ç½®æ‹’ç»ç­–ç•¥ï¼Œä¸€å¾‹æŠ›å‡ºå‚æ•°éæ³•å¼‚å¸¸
    if (workQueue == null || threadFactory == null || handler == null)
        throw new NullPointerException();
    // å‰©ä¸‹çš„å°±æ˜¯ä¸€äº›å…¥å‚çš„èµ‹å€¼é€»è¾‘äº†
    this.corePoolSize = corePoolSize;
    this.maximumPoolSize = maximumPoolSize;
    this.workQueue = workQueue;
    this.keepAliveTime = unit.toNanos(keepAliveTime);
    this.threadFactory = threadFactory;
    this.handler = handler;
}
```

è¿™ä¹ˆä¸€ä¸ªåŒå¤§çš„æ„é€ æ–¹æ³•ï¼Œå«æœ‰ 7 ä¸ªå‚æ•°ï¼Œæœ‰ç‚¹å¤šã€‚ä¸è¿‡æ²¡å…³ç³»ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç”¨å›¾æ¥è¾…åŠ©æ¢³ç†é€»è¾‘ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/96/8c/960141f1798f3bf1a166fdb26603238c.jpg?wh=1920x1283)

å‡è®¾ä¸»çº¿ç¨‹ä¸€ç›´åœ¨ä¸åœåœ°è°ƒç”¨çº¿ç¨‹æ± çš„ execute æ–¹æ³•æ·»åŠ ä»»åŠ¡ã€‚

â‘  å½“å¤„ç†ä»»åŠ¡çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡å°äº corePoolSizeï¼Œé‚£å°±ä¼˜å…ˆæŠŠä»»åŠ¡åˆ†æ´¾ç»™æ ¸å¿ƒçº¿ç¨‹å¹²æ´»ã€‚

â‘¡ å½“å¤„ç†ä»»åŠ¡çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡æ°å¥½ç­‰äº corePoolSizeï¼Œé‚£å°±ç»§ç»­æŠŠä»»åŠ¡æ·»åŠ è‡³ BlockingQueue é˜»å¡é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚

â‘¢ è‹¥ä»»åŠ¡ä¹ŸæŠŠé˜»å¡é˜Ÿåˆ—å †æ»¡äº†ï¼Œå°±ç»§ç»­å°è¯•æŠŠä»»åŠ¡åˆ†é…ç»™éæ ¸å¿ƒçº¿ç¨‹å»å¤„ç†ã€‚

â‘£ è‹¥æ ¸å¿ƒçº¿ç¨‹æ•°é‡ + éæ ¸å¿ƒçº¿ç¨‹æ•°é‡æ°å¥½ä¸ºæœ€å¤§çº¿ç¨‹æ•°é‡ï¼ˆmaximumPoolSizeï¼‰ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœå†æ·»åŠ ä»»åŠ¡ï¼Œçº¿ç¨‹æ± å°±åƒä¸æ¶ˆäº†ï¼Œæ‰€ä»¥ä¼šé‡‡å–ä¸€å®šçš„æ‹’ç»ç­–ç•¥æ¥åº”å¯¹ã€‚

æ‹’ç»ç­–ç•¥ä¸»è¦æœ‰ 4 ç§ã€‚

- ç­–ç•¥ä¸€ï¼šæ‹’ç»æ·»åŠ æ–°ä»»åŠ¡å¹¶æŠ›å‡ºå¼‚å¸¸ï¼ˆAbortPolicyï¼‰ï¼Œ**åŒæ—¶ä¹Ÿæ˜¯é»˜è®¤çš„æ‹’ç»ç­–ç•¥**ã€‚
- ç­–ç•¥äºŒï¼šè®©è°ƒç”¨æ–¹çº¿ç¨‹æ‰§è¡Œæ–°ä»»åŠ¡ï¼ˆCallerRunsPolicyï¼‰ã€‚
- ç­–ç•¥ä¸‰ï¼šæŠ›å¼ƒæ–°ä»»åŠ¡ï¼ˆDiscardPolicyï¼‰ã€‚
- ç­–ç•¥å››ï¼šä¸¢å¼ƒæœ€æ—©å…¥é˜Ÿçš„ä»»åŠ¡ç„¶åæ·»åŠ æ–°ä»»åŠ¡ï¼ˆDiscardOldestPolicyï¼‰ã€‚

## Dubbo çº¿ç¨‹æ± 

äº†è§£äº†çº¿ç¨‹æ± çš„åŸç†ï¼Œæˆ‘ä»¬åˆ†æ Dubbo çš„å››ç§çº¿ç¨‹æ± å°±æ¯”è¾ƒè½»æ¾äº†ï¼Œå› ä¸º Dubbo çº¿ç¨‹æ± çš„åˆ›å»ºæ–¹å¼ï¼Œå°±æ˜¯åŸºäºæˆ‘ä»¬åˆšåˆšæ¢³ç†çš„æ‹¥æœ‰ 7 ä¸ªå‚æ•°çš„çº¿ç¨‹æ± æ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªçœ‹ï¼Œåˆ†åˆ«æ˜¯ï¼šFixedThreadPoolã€LimitedThreadPoolã€CachedThreadPoolã€EagerThreadPoolã€‚

### 1. FixedThreadPool

ç¬¬ä¸€ä¸ªï¼Œå›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ï¼Œè€è§„çŸ©ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹è¿™ä¸ªçº¿ç¨‹æ± åœ¨æºç å±‚é¢æ˜¯æ€ä¹ˆä½“ç°çš„ã€‚

```java
///////////////////////////////////////////////////
// org.apache.dubbo.common.threadpool.support.fixed.FixedThreadPool
// å›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± 
///////////////////////////////////////////////////
public class FixedThreadPool implements ThreadPool {

    @Override
    public Executor getExecutor(URL url) {
        // è·å–ä¸€äº›å‚æ•°å˜é‡
        String name = url.getParameter("threadname", (String) url.getAttribute("threadname", "Dubbo"));
        int threads = url.getParameter("threads", 200);
        int queues = url.getParameter("queues", 0);
        
        // è°ƒç”¨åˆ›å»ºçº¿ç¨‹æ± çš„æ„é€ æ–¹æ³•
        return new ThreadPoolExecutor(
              // æ ¸å¿ƒçº¿ç¨‹æ•°é‡ï¼šthreads
              threads, 
              // æœ€å¤§çº¿ç¨‹æ•°é‡ï¼šthreads
              threads, 
              // éæ ¸å¿ƒçº¿ç¨‹ç©ºé—²æ—¶çš„å­˜æ´»æ—¶é—´ç­‰äº0
              0, 
              // éæ ¸å¿ƒçº¿ç¨‹ç©ºé—²æ—¶çš„å­˜æ´»æ—¶é—´ç­‰äº0ï¼Œå•ä½ï¼šæ¯«ç§’
              TimeUnit.MILLISECONDS,
              // å­˜æ”¾ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—
                      queues == 0 ? new SynchronousQueue<Runnable>() :
                              (queues < 0 ? new LinkedBlockingQueue<Runnable>()
                                      : new LinkedBlockingQueue<Runnable>(queues)),
              // åˆ›å»ºçº¿ç¨‹çš„å·¥å‚
              new NamedInternalThreadFactory(name, true), 
              // å¸¦æœ‰å¯¼å‡ºçº¿ç¨‹å †æ ˆçš„æ‹’ç»ç­–ç•¥ï¼Œå†…éƒ¨ç»§æ‰¿äº† AbortPolicy æŠ›å¼‚å¸¸ç­–ç•¥
              new AbortPolicyWithReport(name, url)
        );
    }
}
```

ä»è¿™æ®µç®€çŸ­çš„åˆ›å»ºçº¿ç¨‹æ± çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬èƒ½å¾—å‡º 3 ç‚¹ç»“è®ºã€‚

- ç¬¬ä¸€ï¼Œ**æ ¸å¿ƒçº¿ç¨‹æ•°é‡ä¸æœ€å¤§çº¿ç¨‹æ•°é‡æ˜¯ä¸€è‡´çš„**ã€‚è¿™è¯´æ˜åªæœ‰æ ¸å¿ƒçº¿ç¨‹çš„å­˜åœ¨ï¼Œæ²¡æœ‰éæ ¸å¿ƒçº¿ç¨‹çš„å­˜åœ¨ï¼Œè€Œä¸”åœ¨æ²¡æœ‰äººä¸ºå¹²é¢„è®¾ç½® threads å±æ€§çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯ 200ï¼Œè¿™ä¹Ÿæ˜¯ Dubbo é»˜è®¤çº¿ç¨‹æ± æ•°é‡æ˜¯ 200 ä¸ªçš„ç”±æ¥ã€‚
- ç¬¬äºŒï¼Œé‡‡ç”¨çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ˜¯æ ¹æ®é˜Ÿåˆ—é•¿åº¦ queues å±æ€§å€¼æ¥ç¡®å®šã€‚é•¿åº¦ç­‰äº 0 ä½¿ç”¨åŒæ­¥é˜Ÿåˆ—ï¼ˆSynchronousQueueï¼‰ï¼Œé•¿åº¦å°äº 0 ä½¿ç”¨æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œé•¿åº¦å¤§äº 0 ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ã€‚
- ç¬¬ä¸‰ï¼Œæ‹’ç»ç­–ç•¥ä½¿ç”¨çš„æ˜¯é»˜è®¤çš„æŠ›å¼‚å¸¸ç­–ç•¥ã€‚ä¸è¿‡ï¼Œè¿™ä¸ªæ‹’ç»ç­–ç•¥æ˜¯ç»è¿‡æ¡†æ¶ç‰¹æ®ŠåŒ…è£…å¤„ç†çš„ï¼Œå‘ç°æ‹’ç»æ·»åŠ ä»»åŠ¡æ—¶ï¼Œè¿™ä¸ªç­–ç•¥æœ‰å¯¼å‡ºçº¿ç¨‹å †æ ˆçš„èƒ½åŠ›ï¼Œç‰¹åˆ«é€‚åˆå¼€å‘äººå‘˜åˆ†æçº¿ç¨‹æ± æ»¡æ—¶çš„ä¸€äº›å®æ—¶çŠ¶å†µã€‚

ä»ç¬¬ä¸€ç‚¹ç»“è®ºæˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œæ ¸å¿ƒçº¿ç¨‹ä¸æœ€å¤§çº¿ç¨‹æ•°é‡ç­‰ä»·ï¼Œä¹Ÿè¯´æ˜äº†çº¿ç¨‹æ•°é‡æ˜¯å›ºå®šä¸å˜çš„ï¼Œæ‰€ä»¥è¿™ä¸ªçº¿ç¨‹æ± ï¼Œæˆ‘ä»¬å°±å«åš**å›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ï¼ˆFixedThreadPoolï¼‰**ã€‚

å›ºå®šæ•°é‡çš„é»˜è®¤å€¼æ˜¯ 200ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æŸæ—¶åˆ»æœ€å¤§èƒ½å¹¶è¡Œå¤„ç† 200 ä¸ªä»»åŠ¡ï¼Œå‡è®¾æ¯ä¸ªä»»åŠ¡è€—æ—¶ 1 ç§’ï¼Œç›¸å½“äºè¿™å°æœºå™¨çš„å•æœº QPS = 200ï¼Œå‡è®¾æ¯ä¸ªä»»åŠ¡è€—æ—¶ 5 ç§’ï¼Œé‚£è¿™å°æœºå™¨çš„å•æœº QPS = 40ã€‚

è¿™æ ·è®¡ç®—å‡ºæ¥çš„ QPS ä½ å¯èƒ½æ„Ÿè§¦ä¸å¤ªå¼ºçƒˆï¼Œä¸è¿‡ä½ å¯ä»¥è®¤çœŸè§‚å¯Ÿä¸‹ï¼Œè‡ªå·±è´Ÿè´£çš„åº”ç”¨æœåŠ¡å™¨å•æœº QPS æƒ…å†µï¼Œå¯¹æ¯”ä¸€ä¸‹æ•°å€¼ã€‚ä½ ä¼šå‘ç°ï¼ŒåŸæ¥ Dubbo è®¾ç½®é»˜è®¤ 200 ä¸ªçº¿ç¨‹ä¹Ÿä¸æ˜¯æ²¡æœ‰é“ç†çš„ï¼Œè¿™æ˜¯ç»è¿‡å¤§é‡éªŒè¯åçš„æŠ˜ä¸­å–å€¼ï¼Œèƒ½æ»¡è¶³å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯çš„è¯‰æ±‚ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰ç‰¹åˆ«çš„è¯‰æ±‚ï¼Œä¹Ÿåˆ«å»çæŠ˜è…¾è®¾ç½®ä»€ä¹ˆçº¿ç¨‹æ± æ•°é‡ï¼Œç›´æ¥ä½¿ç”¨ Dubbo é»˜è®¤çš„çº¿ç¨‹æ± æ•°é‡å°±å¥½äº†ã€‚

### 2. LimitedThreadPool

ä¸è¿‡ä½ ä¹Ÿè®¸ä¼šè¯´ï¼šæˆ‘è¿™ç³»ç»Ÿåˆæ²¡å¤šå¤§çš„é‡ï¼Œ200 ä¸ªçº¿ç¨‹æœ‰ç‚¹æµªè´¹ï¼Œé‡å¤§çš„æ—¶å€™ QPS ä¹Ÿä¸è¿‡åå‡ ï¼Œé‡ä½çš„æ—¶å€™ QPS å‡ ä¹ä¸ºé›¶ï¼Œè€Œä¸”ä¹Ÿä¸å¥½é¢„ä¼°é‡ä½çš„æ—¶å€™è®¾ç½®å¤šå°‘åˆé€‚ã€‚

å¯¹äºè¿™æ ·çš„ç–‘æƒ‘ï¼Œéœ€è¦ Dubbo çš„ç¬¬äºŒä¸ªçº¿ç¨‹æ± å‡ºé©¬ã€‚çœ‹ä»£ç ã€‚

```java
///////////////////////////////////////////////////
// org.apache.dubbo.common.threadpool.support.limited.LimitedThreadPool
// æœ‰é™åˆ¶æ•°é‡çš„çº¿ç¨‹æ± 
///////////////////////////////////////////////////
public class LimitedThreadPool implements ThreadPool {

    @Override
    public Executor getExecutor(URL url) {
        // è·å–ä¸€äº›å‚æ•°å˜é‡
        String name = url.getParameter("threadname", (String) url.getAttribute("threadname", "Dubbo"));
        int cores = url.getParameter("corethreads", 0);
        int threads = url.getParameter("threads", 200);
        int queues = url.getParameter("queues", 0);
        
        // è°ƒç”¨åˆ›å»ºçº¿ç¨‹æ± çš„æ„é€ æ–¹æ³•
        return new ThreadPoolExecutor(
              // æ ¸å¿ƒçº¿ç¨‹æ•°é‡ï¼šcores
              cores, 
              // æœ€å¤§çº¿ç¨‹æ•°é‡ï¼šthreads
              threads, 
              // éæ ¸å¿ƒçº¿ç¨‹ç©ºé—²æ—¶çš„æ°¸ä¹…å­˜æ´»
              Long.MAX_VALUE, 
              // éæ ¸å¿ƒçº¿ç¨‹ç©ºé—²æ—¶çš„å­˜æ´»æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’
              TimeUnit.MILLISECONDS,
              // å­˜æ”¾ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—
                      queues == 0 ? new SynchronousQueue<Runnable>() :
                              (queues < 0 ? new LinkedBlockingQueue<Runnable>()
                                      : new LinkedBlockingQueue<Runnable>(queues)),
              // åˆ›å»ºçº¿ç¨‹çš„å·¥å‚
              new NamedInternalThreadFactory(name, true), 
              // å¸¦æœ‰å¯¼å‡ºçº¿ç¨‹å †æ ˆçš„æ‹’ç»ç­–ç•¥ï¼Œå†…éƒ¨ç»§æ‰¿äº† AbortPolicy æŠ›å¼‚å¸¸ç­–ç•¥
              new AbortPolicyWithReport(name, url)
        );
    }
}
```

çœ‹è¿‡å›ºå®šæ•°é‡çš„çº¿ç¨‹æ± åï¼Œæˆ‘ä»¬å†çœ‹è¿™ä¸ªæœ‰é™åˆ¶æ•°é‡çš„çº¿ç¨‹æ± æºç ï¼Œå°±éå¸¸å¾—å¿ƒåº”æ‰‹ï¼Œå¯ä»¥å¾—å‡º 2 ç‚¹ç»“è®ºã€‚

- ç¬¬ä¸€ï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯ç”±ä¸€ä¸ªå•ç‹¬çš„ corethreads å±æ€§æ¥èµ‹å€¼çš„ï¼Œé»˜è®¤å€¼ä¸º 0ã€‚æœ€å¤§çº¿ç¨‹æ•°æ˜¯ç”± threads å±æ€§æ¥èµ‹å€¼çš„ï¼Œé»˜è®¤å€¼ä¸º 200ã€‚**è¿™è¯´æ˜é»˜è®¤æƒ…å†µä¸‹æ²¡æœ‰æ ¸å¿ƒçº¿ç¨‹ï¼Œéæ ¸å¿ƒçº¿ç¨‹æ•°é‡æœ€å¤§ä¹Ÿä¸èƒ½è¶…è¿‡ 200ã€‚**
- ç¬¬äºŒï¼Œéæ ¸å¿ƒçº¿ç¨‹çš„ keepAliveTime å­˜æ´»æ—¶é—´ä¸º Long ç±»å‹çš„æœ€å¤§å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´æ°¸ä¸è¿‡æœŸï¼Œä¸€æ—¦éæ ¸å¿ƒçº¿ç¨‹åˆ›å»ºå‡ºæ¥äº†ï¼Œåªè¦ä¸å‡ºç°ä»€ä¹ˆæ„å¤–ï¼Œå°±ä¼šä¸€ç›´å­˜æ´»ï¼Œæœ‰ä»»åŠ¡å°±å¤„ç†ä»»åŠ¡ï¼Œæ²¡ä»»åŠ¡å°±èººåœ¨é‚£é‡Œä¼‘æ¯ã€‚

ä»æ ¸å¿ƒçº¿ç¨‹ä¸æœ€å¤§çº¿ç¨‹æ•°é‡åˆ†å¼€è®¾ç½®çš„æƒ…å†µæ¥çœ‹ï¼Œ**è¿™ä¸ªçº¿ç¨‹æ± çš„æ•°é‡åˆ†é…ï¼Œç®—æ˜¯é…åˆä¸šåŠ¡æœ‰å¼¹æ€§çš„åˆ†é…**ï¼Œå¦‚æœä¸šåŠ¡é‡å¹¶ä¸å¤§ï¼Œåˆ†é…äº†å¤šå°‘å°±ä½¿ç”¨å¤šå°‘ï¼Œå¦‚æœä¸šåŠ¡é‡ç¨å¾®å†å¢é•¿ä¸€ç‚¹ï¼Œé‚£å°±ç»§ç»­åˆ†é…éæ ¸å¿ƒçº¿ç¨‹ç»§ç»­å¹²æ´»ï¼ŒæŒ‰ç…§é»˜è®¤æƒ…å†µåˆ†é… 200 ä¸ªå°±å°é¡¶äº†ã€‚

æ‰€ä»¥å¯¹äºé‚£äº›é‡å°ï¼Œä¸çŸ¥é“æœ€åˆè®¾ç½®å¤šå°‘æ ¸å¿ƒçº¿ç¨‹åˆé€‚çš„ï¼Œåˆä¸æƒ³æµªè´¹åˆ›å»ºè¿‡å¤šçš„çº¿ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨è¿™æ¬¾æœ‰é™åˆ¶æ•°é‡çš„çº¿ç¨‹æ± ï¼ˆLimitedThreadPoolï¼‰ã€‚

### 3. CachedThreadPool

ä¸è¿‡LimitedThreadPoolç”¨ç€ç”¨ç€ï¼Œä½ å¯èƒ½ä¼šè§‰å¾—éæ ¸å¿ƒçº¿ç¨‹ä¸€ç›´é—²ç€ä¸å›æ”¶ï¼Œä¼šå ç”¨å†…å­˜ï¼Œåˆç¢ç£¨ç€æ€ä¹ˆè®©çº¿ç¨‹åœ¨æœ‰å¤§é‡ä»»åŠ¡æ¥æ—¶å¤§é‡åˆ›å»ºçº¿ç¨‹åº”å¯¹ï¼Œå½“ä»»åŠ¡å¤„ç†å®Œåï¼Œéæ ¸å¿ƒçº¿ç¨‹éƒ½é—²ç½®æ—¶é»˜é»˜åœ°é”€æ¯æ‰ã€‚

è¿™é‡Œ Dubbo ä¹Ÿæœ‰ä¸€æ¬¾ç¼“å­˜çº¿ç¨‹æ± ï¼Œæˆ‘ä»¬æ¥çœ‹å®ƒçš„æºç å®ç°ã€‚

```java
///////////////////////////////////////////////////
// org.apache.dubbo.common.threadpool.support.cached.CachedThreadPool
// ç¼“å­˜ä¸€å®šæ•°é‡çš„çº¿ç¨‹æ± 
///////////////////////////////////////////////////
public class CachedThreadPool implements ThreadPool {

    @Override
    public Executor getExecutor(URL url) {
        // è·å–ä¸€äº›å‚æ•°å˜é‡
        String name = url.getParameter("threadname", (String) url.getAttribute("threadname", "Dubbo"));
        int cores = url.getParameter("corethreads", 0);
        int threads = url.getParameter("threads", Integer.MAX_VALUE);
        int queues = url.getParameter("queues", 0);
        int alive = url.getParameter("alive", 60 * 1000);
        
        // è°ƒç”¨åˆ›å»ºçº¿ç¨‹æ± çš„æ„é€ æ–¹æ³•
        return new ThreadPoolExecutor(
              // æ ¸å¿ƒçº¿ç¨‹æ•°é‡ï¼šcores
              cores, 
              // æœ€å¤§çº¿ç¨‹æ•°é‡ï¼šthreads
              threads, 
              // éæ ¸å¿ƒçº¿ç¨‹ç©ºé—²æ—¶çš„å­˜æ´»æ—¶é—´
              alive, 
              // éæ ¸å¿ƒçº¿ç¨‹ç©ºé—²æ—¶çš„å­˜æ´»æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’
              TimeUnit.MILLISECONDS,
              // å­˜æ”¾ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—
                      queues == 0 ? new SynchronousQueue<Runnable>() :
                              (queues < 0 ? new LinkedBlockingQueue<Runnable>()
                                      : new LinkedBlockingQueue<Runnable>(queues)),
              // åˆ›å»ºçº¿ç¨‹çš„å·¥å‚
              new NamedInternalThreadFactory(name, true), 
              // å¸¦æœ‰å¯¼å‡ºçº¿ç¨‹å †æ ˆçš„æ‹’ç»ç­–ç•¥ï¼Œå†…éƒ¨ç»§æ‰¿äº† AbortPolicy æŠ›å¼‚å¸¸ç­–ç•¥
              new AbortPolicyWithReport(name, url)
        );
    }
}
```

å¯¹æ¯”æœ‰æ•°é‡é™åˆ¶çš„çº¿ç¨‹æ± ï¼ˆLimitedThreadPoolï¼‰ï¼ŒCachedThreadPool æœ€å¤§çš„å˜åŒ–å°±åœ¨äºåˆ›å»ºçº¿ç¨‹æ± å¯¹è±¡çš„æ—¶å€™ï¼Œæ”¯æŒ alive å±æ€§æ¥èµ‹å€¼éæ ¸å¿ƒçº¿ç¨‹çš„ç©ºé—²æ—¶çš„å­˜æ´»æ—¶é—´ï¼Œé»˜è®¤å­˜æ´»æ—¶é—´æ˜¯ 1 åˆ†é’Ÿï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ**ä¸€æ—¦éæ ¸å¿ƒçº¿ç¨‹è‡ªå¸¦äº†é”€æ¯åŠŸèƒ½ï¼Œä¹Ÿå°±å˜æˆäº†ç¼“å­˜çº¿ç¨‹æ± äº†**ã€‚

æ‰€ä»¥ï¼Œå½“ä»»åŠ¡çªå¢ï¼Œä½ æœŸæœ›å¯ä»¥å¼€è¾Ÿéæ ¸å¿ƒçº¿ç¨‹æ¥æ‰§è¡Œï¼Œç­‰åˆ°ä»»åŠ¡é‡é™ä¸‹å»ï¼Œä½ åˆä¸å¸Œæœ›éæ ¸å¿ƒçº¿ç¨‹å ç”¨ç©ºé—´ï¼ŒæœŸæœ›éæ ¸å¿ƒçº¿ç¨‹è‡ªåŠ¨é”€æ¯çš„è¯ï¼Œå¯ä»¥è€ƒè™‘è¿™ä¸ªç¼“å­˜çº¿ç¨‹æ± ã€‚

### 4. EagerThreadPool

ä¸è¿‡ç³»ç»Ÿæ€»æ˜¯åƒå¥‡ç™¾æ€ªï¼Œæ¯ä¸ªç³»ç»Ÿé‡åˆ°çš„æƒ…å†µéƒ½ä¸ä¸€æ ·ï¼Œä½ å¯èƒ½ä¼šå¯¹ç›®å‰çš„çº¿ç¨‹æ± æŒ‘å‡ºä¸€äº›æ¯›ç—…ï¼Œæ¯”å¦‚åœ¨çº¿ç¨‹æ± å·¥ä½œåŸç†å›¾ä¸­ï¼Œåˆ†æ”¯â‘ å‘ç°æ ¸å¿ƒçº¿ç¨‹éƒ½åœ¨å¤„ç†ä»»åŠ¡çš„æ—¶å€™ï¼Œå¯¹äºæ–°æ·»åŠ çš„ä»»åŠ¡ä½ ä¸æœŸæœ›èµ°åˆ†æ”¯â‘¡é€»è¾‘ï¼Œè€Œæ˜¯æœŸæœ›èµ°åˆ†æ”¯â‘¢é€»è¾‘ã€‚è¿™è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/96/8c/960141f1798f3bf1a166fdb26603238c.jpg?wh=1920x1283)

åˆ«ç€æ€¥ï¼Œä½ çš„éœ€æ±‚Dubbo æ¡†æ¶ä¹Ÿè€ƒè™‘è¿‡ï¼Œæˆ‘ä»¬çœ‹ Dubbo çš„ç¬¬å››ä¸ªçº¿ç¨‹æ± ã€‚

```java
///////////////////////////////////////////////////
// org.apache.dubbo.common.threadpool.support.eager.EagerThreadPool
// æ¸´æœ›æ•°é‡çš„çº¿ç¨‹æ± 
///////////////////////////////////////////////////
public class EagerThreadPool implements ThreadPool {

    @Override
    public Executor getExecutor(URL url) {
        // è·å–ä¸€äº›å‚æ•°å˜é‡
        String name = url.getParameter("threadname", (String) url.getAttribute("threadname", "Dubbo"));
        int cores = url.getParameter("corethreads", 0);
        int threads = url.getParameter("threads", Integer.MAX_VALUE);
        int queues = url.getParameter("queues", 0);
        int alive = url.getParameter("alive", 60 * 1000);

        // åˆå§‹åŒ–é˜Ÿåˆ—å’Œçº¿ç¨‹æ± 
        TaskQueue<Runnable> taskQueue = new TaskQueue<Runnable>(queues <= 0 ? 1 : queues);
        EagerThreadPoolExecutor executor = new EagerThreadPoolExecutor(
                // æ ¸å¿ƒçº¿ç¨‹æ•°é‡ï¼šcores
                cores,
                // æœ€å¤§çº¿ç¨‹æ•°é‡ï¼šthreads
                threads,
                // éæ ¸å¿ƒçº¿ç¨‹ç©ºé—²æ—¶çš„å­˜æ´»æ—¶é—´
                alive,
                // éæ ¸å¿ƒçº¿ç¨‹ç©ºé—²æ—¶çš„å­˜æ´»æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’
                TimeUnit.MILLISECONDS,
                // å­˜æ”¾ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—
                taskQueue,
                // åˆ›å»ºçº¿ç¨‹çš„å·¥å‚
                new NamedInternalThreadFactory(name, true),
                // å¸¦æœ‰å¯¼å‡ºçº¿ç¨‹å †æ ˆçš„æ‹’ç»ç­–ç•¥ï¼Œå†…éƒ¨ç»§æ‰¿äº† AbortPolicy æŠ›å¼‚å¸¸ç­–ç•¥
                new AbortPolicyWithReport(name, url));
        // å°†é˜Ÿåˆ—å’Œçº¿ç¨‹æ± å»ºç«‹è”ç³»
        taskQueue.setExecutor(executor);
        return executor;
    }
}
                  â†“
///////////////////////////////////////////////////
// org.apache.dubbo.common.threadpool.support.eager.TaskQueue#offer
// å°è¯•æ·»åŠ ä»»åŠ¡è‡³é˜Ÿåˆ—
///////////////////////////////////////////////////                  
@Override
public boolean offer(Runnable runnable) {
    // å‚æ•°å¿…è¦æ€§æ£€æŸ¥ï¼Œè‹¥çº¿ç¨‹æ± å¯¹è±¡ä¸º null åˆ™æŠ›å‡ºå¼‚å¸¸
    if (executor == null) {
        throw new RejectedExecutionException("The task queue does not have executor!");
    }
    
    // è·å–çº¿ç¨‹æ± ä¸­å·¥ä½œçº¿ç¨‹ worker çš„æ•°é‡
    int currentPoolThreadSize = executor.getPoolSize();
    // have free worker. put task into queue to let the worker deal with task.
    // è‹¥çº¿ç¨‹æ± ä¸­æ´»è·ƒçš„æ•°é‡å°äº worker çš„æ•°é‡ï¼Œ
    // è¯´æ˜æœ‰äº› worker æ˜¯é—²ç½®çŠ¶æ€ï¼Œæ²¡æœ‰æ´»å¹²
    // å› æ­¤æŠŠä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—åï¼Œçº¿ç¨‹å°±æœ‰æœºä¼šè¢«åˆ†æ´¾åˆ°ä»»åŠ¡ç»§ç»­å¹²æ´»äº†
    if (executor.getActiveCount() < currentPoolThreadSize) {
        return super.offer(runnable);
    }
    
    // return false to let executor create new worker.
    // è¿˜èƒ½æ¥åˆ°è¿™é‡Œï¼Œè¯´æ˜ç›®å‰æ‰€æœ‰çš„ worker éƒ½åœ¨å¤„äºå·¥ä½œçŠ¶æ€
    // é‚£ä¹ˆç»§ç»­çœ‹ worker çš„æ•°é‡å’Œæœ€å¤§çº¿ç¨‹æ•°é‡æƒ³æ¯”ï¼Œè‹¥åå°çš„è¯
    // é‚£ä¹ˆå°±è¿”å› false è¡¨ç¤ºéœ€è¦ç»§ç»­åˆ›å»º worker æ¥å¹²æ´»
    // è‡³äºä¸ºä»€ä¹ˆè¿”å› false å°±èƒ½åˆ›å»º worker æ¥ç»§ç»­å¹²æ´»ï¼Œè¯·çœ‹ä¸‹é¢çš„ execute æ–¹æ³•
    if (currentPoolThreadSize < executor.getMaximumPoolSize()) {
        return false;
    }
    
    // currentPoolThreadSize >= max
    // è¿˜èƒ½æ¥åˆ°è¿™é‡Œï¼Œè¯´æ˜å·²ç»è¾¾åˆ°äº†æœ€å¤§çº¿ç¨‹æ•°é‡äº†ï¼Œ
    // é‚£è¯¥æ”¾é˜Ÿåˆ—å°±æ”¾é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—æ”¾ä¸ä¸‹çš„çš„è¯ï¼Œåˆæ²¡æœ‰éæ ¸å¿ƒçº¿ç¨‹äº†ï¼Œé‚£å°±èµ°æ‹’ç»ç­–ç•¥äº†
    return super.offer(runnable);
}
                  â†“
///////////////////////////////////////////////////
// java.util.concurrent.ThreadPoolExecutor#execute
// çº¿ç¨‹æ± æ·»åŠ ä»»åŠ¡çš„æ–¹æ³•
// è§£é‡Šï¼šcurrentPoolThreadSize < executor.getMaximumPoolSize() è¿™è¡Œä»£ç 
//      ä¸ºä»€ä¹ˆè¿”å› false å°±èƒ½åˆ›å»º worker æ¥ç»§ç»­å¹²æ´»
// åŸç†ï¼šåœ¨ workQueue.offer(command) è¿”å› false åç»§ç»­èµ°ä¸‹é¢çš„
//      else if (!addWorker(command, false)) å°è¯•æ·»åŠ  worker å·¥ä½œçº¿ç¨‹ï¼Œ
//      æ·»åŠ æˆåŠŸäº†ï¼Œé‚£å°±æ‰§è¡Œä»»åŠ¡ï¼Œæ·»åŠ ä¸æˆåŠŸäº†ï¼Œè¯´æ˜å·²è¾¾åˆ°äº†æœ€å¤§çº¿ç¨‹æ•°é‡ï¼Œèµ°æ‹’ç»ç­–ç•¥
///////////////////////////////////////////////////  
public void execute(Runnable command) {
    // è‹¥ä»»åŠ¡ command å¯¹è±¡ä¸º null çš„è¯ï¼Œæ˜¯ä¸åˆæ³•çš„ï¼Œç›´æ¥æŠ›å‡º NPE å¼‚å¸¸
    if (command == null)
        throw new NullPointerException();
    int c = ctl.get();
    
    // è‹¥å·¥ä½œçº¿ç¨‹çš„æ•°é‡å°äºæ ¸å¿ƒçº¿ç¨‹çš„æ•°é‡çš„è¯
    if (workerCountOf(c) < corePoolSize) {
        // åˆ™æ·»åŠ æ ¸å¿ƒçº¿ç¨‹ï¼ŒaddWorker(command, true) ä¸­çš„ true è¡¨ç¤ºåˆ›å»ºæ ¸å¿ƒçº¿ç¨‹
        // æ·»åŠ æˆåŠŸå°±ç»“æŸè¯¥ execute æ–¹æ³•æµç¨‹äº†
        if (addWorker(command, true))
            return;
        c = ctl.get();
    }
    
    // è‹¥è¿˜èƒ½æ¥åˆ°è¿™é‡Œï¼Œè¯´æ˜å·¥ä½œçº¿ç¨‹æ•°é‡å·²ç»è¾¾åˆ°äº†æ ¸å¿ƒçº¿ç¨‹çš„æ•°é‡äº†
    // å†æ¥çš„ä»»åŠ¡å°±åªèƒ½å°è¯•æ·»åŠ è‡³ä»»åŠ¡é˜»å¡é˜Ÿåˆ—äº†
    // è°ƒç”¨é˜Ÿåˆ—çš„ offer æ–¹æ³•å°è¯•çœ‹çœ‹èƒ½å¦æ·»åŠ è‡³ä»»åŠ¡é˜Ÿåˆ—
    if (isRunning(c) && workQueue.offer(command)) {
        int recheck = ctl.get();
        // è‹¥æ·»åŠ æˆåŠŸäº†ï¼Œä½†æ˜¯å‘¢ï¼Œçº¿ç¨‹æ± ä¸å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œè¿˜å¾—å°†ä»»åŠ¡ç§»é™¤ï¼Œ
        // ç„¶åæ‰§è¡Œæ‹’ç»ç­–ç•¥
        if (! isRunning(recheck) && remove(command))
            reject(command);
        else if (workerCountOf(recheck) == 0)
            addWorker(null, false);
    }
    
    // è¿˜èƒ½æ¥åˆ°è¿™é‡Œï¼Œè¯´æ˜çº¿ç¨‹æ± å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œä½†æ˜¯å°è¯•æ·»åŠ è‡³é˜Ÿåˆ— offer å¤±è´¥äº†
    // é‚£ä¹ˆå°±å†æ¬¡å°è¯•è°ƒç”¨ addWorker(command, false) æ¥åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡
    // å°è¯•æ·»åŠ å¤±è´¥çš„è¯ï¼Œå†èµ°æ‹’ç»ç­–ç•¥
    else if (!addWorker(command, false))
        reject(command);
}
```

æ¸´æœ›æ•°é‡çš„çº¿ç¨‹æ± ï¼ˆEagerThreadPoolï¼‰æºç ï¼Œéå¸¸æœ‰äº®ç‚¹ï¼Œå¯ä»¥è¯´ä¸€å®šç¨‹åº¦ä¸Šæ‰“ç ´äº†çº¿ç¨‹æ± å›ºæœ‰çš„æµç¨‹æœºåˆ¶ã€‚

ç¬¬ä¸€ï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯ç”±ä¸€ä¸ªå•ç‹¬çš„ corethreads å±æ€§æ¥èµ‹å€¼çš„ï¼Œé»˜è®¤å€¼ä¸º 0ã€‚æœ€å¤§çº¿ç¨‹æ•°æ˜¯ç”± threads å±æ€§æ¥èµ‹å€¼çš„ï¼Œé»˜è®¤å€¼ä¸º 200ï¼Œéæ ¸å¿ƒçº¿ç¨‹çš„å­˜æ´»æ—¶é—´æ˜¯ç”± alive å±æ€§æ¥èµ‹å€¼çš„ï¼ŒåŸºæœ¬ä¸Šéƒ½äº¤ç»™äº†ç”¨æˆ·è‡ªç”±è®¾ç½®æŒ‡å®šã€‚

ç¬¬äºŒï¼Œä»»åŠ¡é˜»å¡é˜Ÿåˆ—ï¼Œæ—¢ä¸æ˜¯ SynchronousQueueï¼Œä¹Ÿä¸æ˜¯ LinkedBlockingQueueï¼Œè€Œæ˜¯é‡æ–°è®¾è®¡äº†ä¸€æ¬¾æ–°çš„é˜»å¡é˜Ÿåˆ— TaskQueue æ”¾åˆ°äº†çº¿ç¨‹æ± ä¸­ã€‚

æ–°çš„é˜»å¡é˜Ÿåˆ— TaskQueueï¼Œäº®ç‚¹åœ¨äº**é‡å†™äº† LinkedBlockingQueue çš„ offer æ–¹æ³•ï¼Œåªè¦æ´»è·ƒçš„å·¥ä½œçº¿ç¨‹æ•°é‡å°äºæœ€å¤§çº¿ç¨‹æ•°é‡ï¼Œå°±ä¼˜å…ˆåˆ›å»ºå·¥ä½œçº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡**ã€‚è¿™ä¸ª offer æ–¹æ³•çš„ä¼˜ç§€è®¾è®¡ï¼Œä¸»è¦æºäºå¯¹çº¿ç¨‹æ±  execute æ–¹æ³•çš„æ·±åº¦ç ”ç©¶ï¼Œåˆ©ç”¨ä»»åŠ¡å…¥é˜Ÿå¤±è´¥çš„æ–¹å¼ï¼Œæ¥ä¿ƒä½¿çº¿ç¨‹æ± å°è¯•åˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œæ¥å¿«é€Ÿå¤„ç†æ–°å¢çš„ä»»åŠ¡ã€‚

æˆ‘ä¹Ÿç”¨ä¸€å¼ å›¾æ€»ç»“äº†EagerThreadPoolçš„è®¾è®¡ç²¾é«“ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/42/b9/427e89fc40cea22fd73a9979162e64b9.jpg?wh=1920x1134)

åœ¨åˆ†æ”¯â‘ ä¸­ï¼Œæ ¸å¿ƒçº¿ç¨‹éƒ½åœ¨å·¥ä½œæ—¶ï¼Œæ–°å¢çš„ä»»åŠ¡ï¼Œä¼šç›´æ¥å¼€è¾Ÿéæ ¸å¿ƒçº¿ç¨‹ç»§ç»­å·¥ä½œï¼Œå¦‚æœéæ ¸å¿ƒçº¿ç¨‹ä¹Ÿå®¹çº³ä¸ä¸‹äº†ï¼Œåé¢çš„æµç¨‹å°±å’Œæ­£å¸¸çš„çº¿ç¨‹æ± å·¥ä½œåŸç†ä¸€æ ·äº†ã€‚

æ‰€ä»¥å½“ä½ åŸæœ¬è®¾å®šäº†ä¸€äº›æ ¸å¿ƒçº¿ç¨‹æä¾›æœåŠ¡ï¼Œä½†æ˜¯çªå¦‚å…¶æ¥çš„ä»»åŠ¡ï¼Œéœ€è¦ä¼˜å…ˆç´§æ€¥å¤„ç†ï¼Œè€Œä¸æƒ³æ”¾åˆ°é˜Ÿåˆ—é‡Œé¢ç­‰å¾…ï¼Œå°±å¯ä»¥è€ƒè™‘ç”¨è¿™æ¬¾æ¸´æœ›çº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ï¼ˆEagerThreadPoolï¼‰ã€‚

## çº¿ç¨‹æ± ç›‘æ§

åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å¯¹ Dubbo çš„å››ç§çº¿ç¨‹æ± æä¾›çš„èƒ½åŠ›æœ‰ä¸€å®šäº†è§£äº†ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ç”¨ä¸€ä¸ªç›‘æ§æ¡ˆä¾‹æ¥å®è·µä¸€ä¸‹ã€‚

Dubbo çº¿ç¨‹æ± ä»€ä¹ˆæ—¶å€™è€—å°½ï¼Œå¯èƒ½æ˜¯æ— æ³•é¢„æµ‹çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç›‘æ§ï¼Œæå‰é¢„é˜²ï¼Œæ¯”å¦‚å½“æ´»è·ƒçº¿ç¨‹æ•°é‡ä¸æœ€å¤§çº¿ç¨‹æ»¡è¶³å¤šå°‘ç™¾åˆ†æ¯”æ—¶ï¼Œè®°å½•ä¸€ä¸ªæ‰“ç‚¹ï¼ˆè‡³äºåœ¨æ‰“ç‚¹å¹³å°å¦‚ä½•è®¾ç½®å‘Šè­¦ç­–ç•¥ï¼Œæˆ–è€…å¦‚ä½•åšåç»­åº”å¯¹ï¼Œå°±æ˜¯åè¯äº†ï¼‰ã€‚

é‚£å¦‚ä½•æä¾›ä¸€ä¸ªæ‰“ç‚¹çš„å…¥å£å‘¢ï¼Ÿ

ä½ ä¹Ÿè®¸ä¼šè¯´ï¼Œè¿™ä¸ªç›‘æ§è¯‰æ±‚è¿˜ä¸ç®€å•ï¼Œåœ¨â€œ[SPI æœºåˆ¶](https://time.geekbang.org/column/article/620900)â€ä¸­å°±å­¦è¿‡ï¼Œé€šè¿‡ ExtensionLoader ä¸­çš„ getExtension æ–¹æ³•ï¼Œæ‹¿åˆ°æŒ‡å®šæ‰©å±•ç‚¹åç§°çš„å®ç°ç±»ï¼Œç„¶åå°±å¯ä»¥æ‹¿åˆ°çº¿ç¨‹æ± å¯¹è±¡äº†ï¼Œæœ‰äº†çº¿ç¨‹æ± å¯¹è±¡ï¼Œå†æ¥åšä»»ä½•è¯»å–æ“ä½œéƒ½æ˜¯ç®€å•çš„ã€‚

ç”¨ Dubbo æ¡†æ¶ä¸­å››ç§çº¿ç¨‹æ± ä»»æ„ä¸€ç§è¡Œä¸ºæ–¹å¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä»¥é»˜è®¤çš„çº¿ç¨‹æ± ä¸ºä¾‹ã€‚ä»£ç å¾ˆç®€å•ã€‚

```java
// å°† ThreadPool.class ä¼ å…¥åˆ° ExtensionLoader å¯¹è±¡ä¸­
ThreadPool threadPool = ExtensionLoader
          .getExtensionLoader(ThreadPool.class)
          // ç„¶åè·å–æŒ‡å®šæ‰©å±•ç‚¹åç§°çš„å®ç°ç±»ï¼Œè¿™é‡ŒæŒ‡å®šäº†æ‹¿é»˜è®¤çš„å›ºå®šæ•°é‡çš„çº¿ç¨‹æ± 
          .getExtension("fixed");
          
// ç„¶åè°ƒç”¨å®ç°ç±»çš„ getExecutor æ–¹æ³•æ‹¿åˆ°å¯¹åº”çš„çº¿ç¨‹æ± å¯¹è±¡
Executor fixedExecutor = threadPool.getExecutor(...)
```

å¯æ˜¯å†™ç€å†™ç€ï¼Œæœ‰ç‚¹ä¸å¯¹åŠ²äº†ï¼Œæˆ‘ä»¬æ‹¿åˆ° fixed å¯¹åº”çš„å®ç°ç±»åï¼Œå†è°ƒç”¨ getExecutor æ–¹æ³•ï¼Œä¸æ˜¯åˆåˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹æ± å¯¹è±¡ï¼Ÿè¿™å¯ä¸å¤ªè¡Œï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯è¦é’ˆå¯¹ Dubbo è¿è¡Œæ­£åœ¨ä½¿ç”¨çš„çº¿ç¨‹æ± è¿›è¡Œç›‘æ§ï¼Œç°åœ¨ä¸ä½†æ²¡å¸®ä¸Šå¿™ï¼Œè¿˜åˆåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ± ï¼Œå¾—å¦æ‰¾åŠæ³•ã€‚

ä¸èƒ½è‡ªå·±æ‰‹åŠ¨è°ƒç”¨ getExecutor æ–¹æ³•ï¼Œæºç æˆ‘ä»¬ä¹Ÿä¸èƒ½éšä¾¿æ›´æ”¹ï¼Œé‚£æœ‰ä»€ä¹ˆæ–¹å¼ï¼Œå¯ä»¥åœ¨æºç è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œé¡ºä¾¿è®°å½•ä¸€ä¸‹è¿™ä¸ªè¢«åˆ›å»ºçš„çº¿ç¨‹æ± å‘¢ï¼Ÿ

è¿˜è®°å¾—å—ï¼Œåœ¨ä¸Šä¸€è®²â€œ[æ³¨å†Œæ‰©å±•](https://time.geekbang.org/column/article/625388)â€ä¸­ï¼Œæˆ‘ä»¬ä»¿ç…§ ZookeeperRegistryFactory çš„ç¼–å†™æ€è·¯ï¼Œèƒ½ç»§æ‰¿ä½¿ç”¨çš„ï¼Œå°±ç»§æ‰¿ä½¿ç”¨ï¼Œä¸èƒ½ç»§æ‰¿ï¼Œå¯ä»¥ç®€å•ç²—æš´åœ° copy ä¸€ä»½ã€‚

æƒ³åˆ°è¿™é‡Œï¼Œæ€è·¯å°±æ‰“å¼€äº†ï¼Œæ—¢ç„¶ä¸èƒ½ä¿®æ”¹ FixedThreadPool çš„é€»è¾‘ï¼Œé‚£æˆ‘ä»¬**ç›´æ¥æ–°å»ºä¸€ä¸ª MonitorFixedThreadPool æ¥ç»§æ‰¿ FixedThreadPool åº”è¯¥ä¸æ˜¯ä»€ä¹ˆéš¾äº‹ã€‚å†æ‹¿åˆ°çº¿ç¨‹æ± å¯¹è±¡å°±æ¯”è¾ƒç®€å•äº†ï¼Œåœ¨æ–°åˆ›å»ºçš„ç±»ä¸­é‡å†™ getExecutor æ–¹æ³•ï¼ŒæŠŠçˆ¶ç±»åˆ›å»ºçš„çº¿ç¨‹æ± ç¼“å­˜èµ·æ¥**ã€‚æœ‰äº†çº¿ç¨‹æ± å¯¹è±¡ï¼Œå°±å†å–å‡ºçº¿ç¨‹æ± çš„æ´»è·ƒçº¿ç¨‹ä¸æœ€å¤§çº¿ç¨‹æ•°é‡ã€‚

å¯æ˜¯ï¼Œè¿™é‡Œæ³¨æ„ç»†èŠ‚ï¼Œè°ƒç”¨æ–¹ä¸ä¼šæ—¶æ—¶åˆ»åˆ»éƒ½è°ƒç”¨ getExecutor æ–¹æ³•ï¼Œè€Œæˆ‘ä»¬è¦æ£€æµ‹çº¿ç¨‹æ± çš„æ•°é‡å˜åŒ–ï¼Œå°±å¾—ä¸“é—¨æœ‰ä¸ªåå°çº¿ç¨‹å®šæ—¶æ£€æµ‹ä¸€ä¸‹ï¼Œå¯æ˜¯ä»å“ªé‡Œæ‰¾è¿™æ ·å…·æœ‰å®šæ—¶æ•ˆæœçš„çº¿ç¨‹æ± å‘¢ï¼Ÿ

æˆ‘æ•™ä½ ä¸€ä¸ªå°æŠ€å·§ï¼Œæˆ‘ä»¬ä½¿ç”¨ Collection æ¥å£æ—¶ï¼ŒCollections è¿™ä¸ªç±»ä¸­å¯Œå«æ“ä½œ Collection çš„å„ç§å·¥å…·ç±»ï¼›ä½¿ç”¨ List æ¥å£æ—¶ï¼ŒLists ç±»ä¸­ä¹Ÿå¯Œå«å„ç§æ“ä½œ List çš„ä¸€äº›å·¥å…·ç±»ï¼›ä½¿ç”¨ Map æ¥å£ä¹Ÿæ˜¯ï¼ŒMaps è¿™ä¸ªç±»ä¸­ä¹Ÿå¯Œå«å„ç§æ“ä½œ Map çš„ä¸€äº›å·¥å…·ç±»ã€‚æ‰€ä»¥ï¼Œ**å½“ä½ ä½¿ç”¨ Executor æ¥å£æ—¶ï¼Œå¯ä»¥å°è¯•åœ¨ç±»çš„å°¾å·´ä¸Šæ·»åŠ ä¸€ä¸ªå­—æ¯â€œsâ€ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰å¯¹åº”çš„å·¥å…·ç±»ã€‚**

æŒ‰ç…§å°æŠ€å·§çš„æ–¹å¼ï¼Œæˆ‘ä»¬é€šè¿‡ Executors å¯»æ‰¾ä¸€ä¸‹ï¼Œæœç„¶ Executors è¿™ä¸ªç±»å­˜åœ¨äº JDK ä¸­ï¼Œé‡Œé¢ä¹Ÿèƒ½æ‰¾åˆ°å…³äºå®šæ—¶è½®è¯¢çš„ APIã€‚

ç°åœ¨ï¼Œæ€ä¹ˆæ‰©å±•çº¿ç¨‹æ± è§£å†³äº†ï¼Œæ€ä¹ˆæ‹¿åˆ°çº¿ç¨‹æ± å¯¹è±¡ä¹Ÿè§£å†³äº†ï¼Œå®šæ—¶è½®è¯¢çš„ API ä¹Ÿæ‰¾åˆ°äº†ï¼Œä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ æœ€åçš„è½®è¯¢æ£€æµ‹ä»£ç äº†ã€‚

```java
///////////////////////////////////////////////////
// è‡ªå®šä¹‰ç›‘æ§å›ºå®šæ•°é‡çš„çº¿ç¨‹æ± 
///////////////////////////////////////////////////
@Slf4j
public class MonitorFixedThreadPool extends FixedThreadPool implements Runnable {

    private static final Set<ThreadPoolExecutor> EXECUTOR_SET = new HashSet<>();
    
    /** <h2>é«˜æ°´ä½çº¿é˜ˆå€¼</h2> **/
    private static final double HIGH_WATER_MARK = 0.85;
    
    // é»˜è®¤çš„æ„é€ æ–¹æ³•ï¼Œå€Ÿç”¨è¯¥æ„é€ æ–¹æ³•åˆ›å»ºä¸€ä¸ªå¸¦æœ‰è½®è¯¢æœºåˆ¶çš„å•çº¿ç¨‹æ± 
    public MonitorFixedThreadPool() {
        Executors.newSingleThreadScheduledExecutor()
                .scheduleWithFixedDelay(
                        // å½“å‰çš„ MonitorFixedThreadPool å¯¹è±¡è‡ªå·±
                        this,
                        // å¯åŠ¨å 0 ç§’æ‰§è¡Œä¸€æ¬¡
                        0,
                        // æ¯é—´éš” 30 ç§’è½®è¯¢æ£€æµ‹ä¸€æ¬¡
                        30,
                        // å•ä½ï¼šç§’
                        TimeUnit.SECONDS
                );
    }
    
    // é‡å†™äº†çˆ¶ç±»çš„ FixedThreadPool çš„ getExecutor æ–¹æ³•
    // ç„¶åæ‹©æœºå°†è¿”å›å€¼ executor å­˜å‚¨èµ·æ¥äº†
    @Override
    public Executor getExecutor(URL url) {
        // é€šè¿‡ super ç›´æ¥è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ï¼Œæ‹¿åˆ°ç»“æœ
        Executor executor = super.getExecutor(url);
        
        // é’ˆå¯¹ç»“æœè¿›è¡Œç¼“å­˜å¤„ç†
        if (executor instanceof ThreadPoolExecutor) {
            EXECUTOR_SET.add((ThreadPoolExecutor) executor);
        }
        return executor;
    }
    
    @Override
    public void run() {
        // æ¯éš” 30 ç§’ï¼Œè¿™ä¸ª run æ–¹æ³•è¢«è§¦å‘æ‰§è¡Œä¸€æ¬¡    
        for (ThreadPoolExecutor executor : EXECUTOR_SET) {
            // å¾ªç¯æ£€æµ‹æ¯éš”çº¿ç¨‹æ± æ˜¯å¦è¶…è¶Šé«˜æ°´ä½çº¿        
            doCheck(executor);
        }
    }    
    
    // æ£€æµ‹æ–¹æ³•
    private void doCheck(ThreadPoolExecutor executor) {
        final int activeCount = executor.getActiveCount();
        int maximumPoolSize = executor.getMaximumPoolSize();
        double percent = activeCount / (maximumPoolSize * 1.0);
        
        // åˆ¤æ–­è®¡ç®—å‡ºæ¥çš„å€¼ï¼Œæ˜¯å¦å¤§äºé«˜æ°´ä½çº¿
        if (percent > HIGH_WATER_MARK) {
            log.info("æº¢å‡ºé«˜æ°´ä½çº¿ï¼šactiveCount={}, maximumPoolSize={}, percent={}",
                    activeCount, maximumPoolSize, percent);
                    
            // è®°å½•æ‰“ç‚¹ï¼Œå°†è¯¥ä¿¡æ¯åŒæ­¥å€¼ Cat ç›‘æ§å¹³å°
            CatUtils.logEvent("çº¿ç¨‹æ± æº¢å‡ºé«˜æ°´ä½çº¿",
                    executor.getClass().getName(),
                    "1", buildCatLogDetails(executor));
        }
    }    
}

///////////////////////////////////////////////////
// èµ„æºç›®å½•æ–‡ä»¶
// è·¯å¾„ä¸ºï¼š/META-INF/dubbo/org.apache.dubbo.common.threadpool.ThreadPool
///////////////////////////////////////////////////
monitorfixed=com.hmilyylimh.cloud.threadpool.config.MonitorFixedThreadPool

///////////////////////////////////////////////////
// ä¿®æ”¹ Java ä»£ç é…ç½®ç±»æŒ‡å®šä½¿ç”¨è¯¥ç›‘æ§çº¿ç¨‹æ± 
// æˆ–
// dubbo.provider.threadpool=monitorfixed
///////////////////////////////////////////////////
@Bean
public ProtocolConfig protocolConfig(){
    ProtocolConfig protocolConfig = new ProtocolConfig("dubbo", 28260);
    protocolConfig.setThreadpool("monitorfixed");
    return protocolConfig;
}
```

æ€è·¯æ¸…æ™°åï¼Œå†™ä»£ç å¹¶ä¸æ˜¯å¾ˆéš¾ï¼Œå…³æ³¨ 4 ä¸ªé‡è¦çš„ç‚¹ã€‚

- åœ¨é‡å†™ getExecutor çš„æ–¹æ³•é€»è¾‘ä¸­ï¼Œé€šè¿‡è°ƒç”¨çˆ¶ç±»çš„ getExecutor æ–¹æ³•æ‹¿åˆ°çº¿ç¨‹æ± å¯¹è±¡ï¼Œå¹¶æŠŠçº¿ç¨‹æ± å¯¹è±¡ç¼“å­˜èµ·æ¥ã€‚
- å·§å¦™åˆ©ç”¨æ„é€ æ–¹æ³•ï¼Œä¸€æ¬¡æ€§ç”Ÿæˆå¸¦æœ‰è½®è¯¢æœºåˆ¶çš„å•çº¿ç¨‹æ± å¯¹è±¡ã€‚
- åœ¨è½®è¯¢æ£€æµ‹ä¸­ï¼Œè®¡ç®—å‡ºæ¥çš„ç™¾åˆ†æ¯”ï¼Œå¦‚æœå¤§äºé¢„è®¾çš„é«˜æ°´ä½çº¿ï¼Œå°±è®°å½•æ‰“ç‚¹é€šçŸ¥ Cat ç›‘æ§å¹³å°ã€‚
- ä»£ç ç¼–å†™å®Œåï¼Œè®°å¾— SPI æ–‡ä»¶çš„é…ç½®ï¼Œä»¥åŠæŒ‡å®šä½¿ç”¨æ–°çš„ç›‘æ§çº¿ç¨‹æ± ã€‚

## æ€»ç»“

ä»Šå¤©æˆ‘ä»¬å›å¿†äº†çº¿ç¨‹æ± æ·»åŠ ä»»åŠ¡çš„åº•å±‚åŸç†ï¼Œå¯ä»¥æ€»ç»“æˆå››éƒ¨æ›²ã€‚

- ç¬¬ä¸€æ­¥ï¼Œæ–°æ·»åŠ çš„ä»»åŠ¡ï¼Œä¼˜å…ˆåˆ†é…ç»™æ ¸å¿ƒçº¿ç¨‹å¤„ç†ã€‚
- ç¬¬äºŒæ­¥ï¼Œè‹¥æ ¸å¿ƒçº¿ç¨‹æ•°é‡æ»¡ï¼ŒæŠŠä»»åŠ¡æ·»åŠ è‡³é˜»å¡é˜Ÿåˆ—ä¸­ã€‚
- ç¬¬ä¸‰æ­¥ï¼Œè‹¥é˜»å¡é˜Ÿåˆ—ä¹Ÿæº¢å‡ºï¼ŒæŠŠä»»åŠ¡åˆ†é…ç»™éæ ¸å¿ƒçº¿ç¨‹å¤„ç†ã€‚
- ç¬¬å››æ­¥ï¼Œè‹¥éæ ¸å¿ƒçº¿ç¨‹æ•°é‡ä¹Ÿæ»¡ï¼Œèµ°é¢„å…ˆè®¾ç½®å¥½çš„æ‹’ç»ç­–ç•¥ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/96/8c/960141f1798f3bf1a166fdb26603238c.jpg?wh=1920x1283)

åŸºäºçº¿ç¨‹æ± åˆ›å»ºçš„æ ¸å¿ƒåŸç†ï¼Œæˆ‘ä»¬åˆ†æäº† Dubbo å››ç§çº¿ç¨‹æ± çš„ç‰¹ç‚¹å’Œä½¿ç”¨åœºæ™¯ï¼ŒFixedThreadPoolã€LimitedThreadPoolã€CachedThreadPoolã€EagerThreadPoolã€‚ä¸è¿‡çº¿ç¨‹æ± å„æœ‰å„çš„å¥½å¤„ï¼Œä¹Ÿå„æœ‰å¼Šç«¯ã€‚

- FixedThreadPoolï¼Œåˆ›å»ºå›ºå®šå¤§å°çš„çº¿ç¨‹æ± ã€‚é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨çš„æ˜¯åŒæ­¥é˜Ÿåˆ—ï¼Œä½ å¯ä»¥ç†è§£æˆæ²¡æœ‰ç¼“å†²ç­‰å¾…é˜Ÿåˆ—ï¼Œæ‰€ä»¥æç«¯æƒ…å†µä¸‹é‡åˆ°å¤§é‡ä»»åŠ¡æ—¶ï¼Œå¯èƒ½å­˜åœ¨é˜»å¡çš„æƒ…å†µã€‚
- LimitedThreadPoolï¼Œæœ‰é™å®šæ•°é‡çš„çº¿ç¨‹æ± ï¼Œä½ ä¹Ÿå¯ä»¥ç†è§£ä¸ºå¯ä¼¸ç¼©çº¿ç¨‹æ± ï¼Œä½†æ˜¯éšç€ä»»åŠ¡çš„å¢åŠ ï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°åªå¢ä¸å‡ï¼Œåœ¨æµé‡ä½å³°æœŸå°±é€ æˆäº†ä¸€å®šçš„å†…å­˜æµªè´¹ï¼Œçº¿ç¨‹æ± æ— æ³•å¾—åˆ°å……åˆ†çš„åˆ©ç”¨ã€‚
- CachedThreadPoolï¼Œå…·æœ‰ä¸€å®šç¼“å­˜èƒ½åŠ›çš„çº¿ç¨‹æ± ã€‚å› ä¸ºæœ€å¤§çº¿ç¨‹æ•°é‡çš„é»˜è®¤å€¼æ˜¯ Integer çš„æœ€å¤§å€¼ï¼Œå¦‚æœé‡åˆ°å¤§é‡ä»»åŠ¡ï¼Œä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œå¯¹ç³»ç»Ÿçš„ CPU ä¼šé€ æˆä¸€å®šçš„å†²å‡»å‹åŠ›ï¼Œçº¿ç¨‹è¶Šå¤šï¼Œåè€Œè®©ç³»ç»Ÿçš„æ•ˆç‡ä½ä¸‹ã€‚
- EagerThreadPoolï¼Œæ¸´æœ›æ›´å¤šçº¿ç¨‹æ¥å¹²æ´»çš„çº¿ç¨‹æ± ã€‚åº”å¯¹æµé‡é«˜å³°æœŸéå¸¸å¥½ï¼Œå¯ä»¥è¿…é€Ÿå¢åŠ çº¿ç¨‹æä¾›æœåŠ¡ï¼Œä½†åŒæ—¶ä¹Ÿæ‰“ç ´äº†çº¿ç¨‹æ± åŸæœ¬çš„æœºåˆ¶æµç¨‹ï¼Œæœ‰ä¸€ç§æ¬ºéª—çº¿ç¨‹æ± çš„æ„Ÿè§‰ï¼Œä¸è¿‡è¿™ç§è®¾è®¡éå¸¸å·§å¦™ï¼Œä¹Ÿç®—æ˜¯ä¸€ç§å–„æ„çš„æ¬ºéª—å§ã€‚

### æ€è€ƒé¢˜

ç•™ä¸ªä½œä¸šç»™ä½ ï¼Œé’ˆå¯¹ Dubbo çš„çº¿ç¨‹æ± è¿›è¡Œæ‰©å±•ä½ å·²ç»ä¼šäº†ï¼Œé‚£é’ˆå¯¹çº¿ç¨‹æ± æœ¬èº«ï¼Œä»»åŠ¡æ‰”åˆ°çº¿ç¨‹æ± åï¼Œåœ¨çœŸæ­£æ‰§è¡Œä¹‹å‰å’Œä¹‹åï¼Œå¯ä»¥è¿›è¡Œæ‰©å±•ä¹ˆï¼Ÿ

æœŸå¾…åœ¨ç•™è¨€åŒºçœ‹åˆ°ä½ çš„æ€è€ƒï¼Œå‚ä¸è®¨è®ºã€‚å¦‚æœè§‰å¾—ä»Šå¤©çš„å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ä¸€èµ·è®¨è®ºï¼Œå¯èƒ½å°±å¸®TAè§£å†³äº†ä¸€ä¸ªå›°æƒ‘ã€‚æˆ‘ä»¬ä¸‹ä¸€è®²è§ã€‚

### 25 æ€è€ƒé¢˜å‚è€ƒ

ä¸Šä¸€æœŸç•™äº†ä¸ªä½œä¸šï¼Œåœ¨æ¶ˆè´¹æ–¹è‡ªå®šä¹‰ä¸€ä¸ªé›†ç¾¤æ‰©å±•å™¨ï¼Œé€šè¿‡ä»æ¥æ”¶è¯·æ±‚çš„ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­æ‹¿åˆ° routeNo å±æ€§å€¼ï¼Œè¿›è¡Œåˆ†ç»„è¿‡æ»¤ï¼Œç„¶åä½¿ç”¨è¿‡æ»¤åçš„ invoker è¿›è¡Œåç»­çš„è°ƒç”¨æµç¨‹ã€‚

åœ¨ä¹‹å‰çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† FailoverClusterInvoker æŒæœ‰äº†å¤šä¸ª invoker å¯¹è±¡ï¼Œè€Œä¸”è¿™ä¸ª FailoverClusterInvoker é€»è¾‘å¾ˆå¤šï¼Œæˆ‘ä»¬å°±è‡ªå®šä¹‰ä¸€ä¸ªç±» RouteNoClusterInvoker æ¥ç»§æ‰¿ FailoverClusterInvoker ç±»ï¼Œç„¶åé‡å†™ list æ–¹æ³•ï¼Œé€šè¿‡å­ç±»çš„è‡ªå®šä¹‰é€»è¾‘ï¼Œæ¥æ”¹å˜è´Ÿè½½å‡è¡¡çš„é›†åˆèŒƒå›´ã€‚

å¤§ä½“ä¸Šé€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œçœ‹å®ç°åçš„ä»£ç ã€‚

```java
///////////////////////////////////////////////////                  
// åç§°ï¼šè·¯ç”±ç¼–ç é›†ç¾¤æ‰©å±•å®ç°ç±»
// åŠŸèƒ½ï¼šç±»æ¯”äº FailoverCluster æ•…éšœè‡ªåŠ¨è½¬ç§»é›†ç¾¤æ‰©å±•å™¨
///////////////////////////////////////////////////
public class RouteNoCluster extends AbstractCluster {
    public final static String NAME = "routeNo";
    @Override
    public <T> AbstractClusterInvoker<T> doJoin(Directory<T> directory) throws RpcException {
        return new RouteNoClusterInvoker<>(directory);
    }
}

///////////////////////////////////////////////////                  
// åç§°ï¼šè·¯ç”±ç¼–ç é›†ç¾¤æ‰©å±•å®ç°ç±»çš„ invoker æ ¸å¿ƒå¤„ç†å¯¹è±¡
// åŠŸèƒ½ï¼šå°† invokers æŒ‰ç…§ routeNo è¿›è¡Œåˆ†ç»„å¾—åˆ°ä¸€ä¸ª mapï¼Œå†ä» map ä¸­å–å‡ºå¯¹åº”é›†åˆå³å¯
///////////////////////////////////////////////////
public class RouteNoClusterInvoker<T> extends FailoverClusterInvoker<T> {
    public RouteNoClusterInvoker(Directory<T> directory) {
        super(directory);
    }
    @Override
    protected List<Invoker<T>> list(Invocation invocation) throws RpcException {
        List<Invoker<T>> invokers = super.list(invocation);
        // TODO æŠŠ invokers æŒ‰ç…§ routeNo è¿›è¡Œåˆ†ç»„ï¼Œå¾—åˆ° Map<String, List<Invoker<T>>> æ•°æ®ç»“æ„
        // String routeNo = invoker.getUrl().getParameter("routeNo") è¿™æ ·è·å–åˆ†å‘IDå€¼
        Map<String, List<Invoker<T>>> map = groupByRouteNo(invokers);
        // æ ¹æ®æœ¬åœ°çº¿ç¨‹è·å–çš„ routeNo çš„å€¼ï¼Œä» map é‡Œé¢è·å–åˆ°å¯¹åº”é€‰æ‹©çš„ invokers åˆ—è¡¨
        String routeNo = RouteNoThreadLocalUtils.get();
        List<Invoker<T>> selectedInvokers = map.get(routeNo);
        // å°†é€‰æ‹©å‡ºæ¥çš„ selectedInvokers è¿”å›ï¼Œäº¤ç»™åç»­ä»£ç æµç¨‹è¿›è¡Œè´Ÿè½½å‡è¡¡å¤„ç†ç­‰ç­‰
        return Collections.unmodifiableList(selectedInvokers);
    }
}

///////////////////////////////////////////////////
// æ¶ˆè´¹æ–¹èµ„æºç›®å½•æ–‡ä»¶
// è·¯å¾„ä¸ºï¼š/META-INF/dubbo/org.apache.dubbo.rpc.cluster.Cluster
///////////////////////////////////////////////////
routeNo=com.hmilyylimh.cloud.registry.cluster.RouteNoCluster 

///////////////////////////////////////////////////                  
// dubbo.propertiesï¼Œç›´æ¥æŒ‡å®š dubbo.provider.cluster çš„å€¼
///////////////////////////////////////////////////
dubbo.provider.cluster=routeNo

///////////////////////////////////////////////////                  
// åç§°ï¼šè·¯ç”±ç¼–ç å®¹å™¨è¿‡æ»¤å™¨
// åŠŸèƒ½ï¼šæ¥æ”¶åˆ°å‰ç«¯è¯·æ±‚åï¼Œå°†å‰ç«¯æŒ‡å®šçš„è·¯ç”±ç¼–ç è®¾ç½®åˆ°æœ¬åœ°çº¿ç¨‹ä¸­ï¼Œä»¥æ–¹ä¾¿åç»­é€»è¾‘ä½¿ç”¨
///////////////////////////////////////////////////
public class RouteNoContainerFilter implements Filter {
    @Override
    public void init(FilterConfig var1) throws ServletException {
    }
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException,
            ServletException {
        String routeNo = ((HttpServletRequest) request).getHeader("routeNo");
        // TODO æƒ³åŠæ³•æŠŠ routeNo çš„å€¼å­˜å‚¨åˆ° ThreadLocal ä¸­ï¼Œä»¥ä¾¿è¯¥çº¿ç¨‹çš„å…¶ä»–åœ°æ–¹ä¹Ÿå¯ä»¥è·å–åˆ°
        RouteNoThreadLocalUtils.set(routeNo);
        filterChain.doFilter(request, response);
    }
}

///////////////////////////////////////////////////                  
// åç§°ï¼šè·¯ç”±ç¼–ç æ¶ˆè´¹æ–¹è¿‡æ»¤å™¨
// åŠŸèƒ½ï¼šå°†æœ¬åœ°çº¿ç¨‹çš„è·¯ç”±ç¼–ç å€¼å–å‡ºæ¥ï¼Œç„¶åå‘ç»™æä¾›æ–¹ï¼Œè¿™æ ·æä¾›æ–¹å°†æ¥æ”¶åˆ°è¯·æ±‚åç»§ç»­è·¯ç”±é€‰æ‹©å…·ä½“çš„ invoker å¯¹è±¡è¿›è¡Œè°ƒç”¨
///////////////////////////////////////////////////
@Activate(group = CONSUMER, order = Integer.MIN_VALUE + 2000)
public class RouteNoConsumerFilter implements Filter, Filter.Listener {
    public static final String TRACE_ID = "TRACE-ID";
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
        // ä»æœ¬åœ°çº¿ç¨‹å¯¹è±¡ä¸­å–å‡ºè·Ÿè·¯ç”±ç¼–ç å€¼
        String routeNo = RouteNoThreadLocalUtils.get();
        
        // ç„¶åå°†è·¯ç”±ç¼–ç å€¼è®¾ç½®åˆ°è¯·æ±‚å¯¹è±¡ä¸­
        invocation.getObjectAttachments().put("routeNo", routeNo);
        RpcContext.getClientAttachment().setObjectAttachment("routeNo", routeNo);
        
        // ç»§ç»­åé¢è¿‡æ»¤å™¨çš„è°ƒç”¨
        return invoker.invoke(invocation);    
    }
}
```

å®ç°åçš„ä»£ç ä¸»è¦å…³æ³¨ 3 ç‚¹ã€‚

ç¬¬ä¸€ï¼Œç ”ç©¶ FailoverCluster çš„å®ç°é€»è¾‘ï¼Œä»¿ç…§å®ƒè‡ªå®šä¹‰äº†ä¸€ä¸ª RouteNoCluster è€Œå·²ã€‚

ç¬¬äºŒï¼Œç”±äº FailoverCluster ä¸ FailoverClusterInvoker æ˜¯é…å¥—ä½¿ç”¨çš„ï¼Œæ°å¥½ FailoverClusterInvoker é‡Œé¢çš„é€»è¾‘ä¸€å †ï¼Œæ‰€ä»¥ï¼Œå¯ä»¥é‡‡ç”¨ç»§æ‰¿çš„æ–¹å¼ï¼Œè‡ªå®šä¹‰ä¸€ä¸ª RouteNoClusterInvoker ç±»å»ç»§æ‰¿ FailoverClusterInvoker ç±»ï¼Œå¹¶é‡å†™äº† list æ–¹æ³•æ”¹å˜è´Ÿè½½å‡è¡¡çš„èŒƒå›´ã€‚

ç¬¬ä¸‰ï¼Œå½“å‰ç³»ç»Ÿä¸€å®šå¾—æƒ³åŠæ³•æŠŠå‰ç«¯å‘æ¥çš„ routeNo å­˜å‚¨èµ·æ¥ï¼Œä»¥ä¾¿åœ¨å‘èµ·è°ƒç”¨æ—¶ï¼Œé€‰æ‹©å…·ä½“çš„invoker å¯¹è±¡ï¼Œå¹¶ä¸”æŠŠ routeNo ä¼ ç»™æä¾›æ–¹ï¼Œè®©å°†æ¥æä¾›æ–¹è°ƒç”¨åˆ«çš„ç³»ç»Ÿæ—¶èƒ½æ´¾ä¸Šç”¨åœºã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ3ï¼‰</strong></div><ul>
<li><span>Geek_b2ac95</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ‚¨å¥½ï¼Œå¯ä»¥æ­£å¸¸ç•™è¨€å—</p>2024-12-31</li><br/><li><span>å‡†æ—¶ä¸æ—©é€€çš„å˜‰ç„¶</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆæ‚¨å¥½ï¼Œå¦‚æœæƒ³åšçº¿ç¨‹æ± éš”ç¦»è¦æ€ä¹ˆå®ç°å‘¢ï¼Ÿç°åœ¨æœ‰ä¸ªéœ€æ±‚ï¼Œè¦ä¸ºä¸åŒæœåŠ¡æ¥å£åˆ†é…ä¸åŒçš„çº¿ç¨‹æ•°é‡</p>2023-03-11</li><br/><li><span>Geek_b2ac95</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ‚¨å¥½ï¼Œæˆ‘æ‰§è¡Œå·¥ç¨‹ä¸­çš„æ¡ˆä¾‹ï¼Œä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œå‘ç°providerå¯ä»¥æ­£å¸¸å¯åŠ¨ï¼Œå¹¶ä¸”è‡ªå®šä¹‰çº¿ç¨‹æ± ç”Ÿæ•ˆäº†ï¼Œzkä¸Šçš„æœåŠ¡æ³¨å†Œä¿¡æ¯ä¹Ÿæœ‰è‡ªå®šä¹‰çº¿ç¨‹æ± ä¿¡æ¯ï¼Œä½†æ˜¯consumeræ— æ³•æ­£å¸¸æ¶ˆè´¹ï¼Œdebugè¿›å»å‘ç°æ‰¾ä¸åˆ°å¯ç”¨çš„invokerï¼Œåº”è¯¥æ˜¯è¿‡æ»¤æ‰äº†ï¼Œè¿™ä¸ªæ€ä¹ˆè§£å†³ï¼Ÿ</p>2024-12-31</li><br/>
</ul>