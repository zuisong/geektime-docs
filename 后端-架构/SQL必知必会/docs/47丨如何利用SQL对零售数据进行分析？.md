æˆ‘ä»¬é€šè¿‡OLTPç³»ç»Ÿå®æ—¶æ•æ‰åˆ°äº†ç”¨æˆ·çš„æ•°æ®ï¼Œè¿˜éœ€è¦åœ¨OLAPç³»ç»Ÿä¸­å¯¹å®ƒä»¬è¿›è¡Œåˆ†æã€‚ä¹‹å‰æˆ‘ä»¬è®²è§£äº†å¦‚ä½•å¯¹æ•°æ®è¿›è¡Œæ¸…æ´—ï¼Œä»¥åŠå¦‚ä½•å¯¹åˆ†æ•£åœ¨ä¸åŒåœ°æ–¹çš„æ•°æ®è¿›è¡Œé›†æˆï¼Œä»Šå¤©æˆ‘ä»¬æ¥çœ‹ä¸‹å¦‚ä½•ä½¿ç”¨SQLåˆ†æè¿™äº›æ•°æ®ã€‚

å…³äºè¿™éƒ¨åˆ†å†…å®¹ï¼Œä»Šå¤©æˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ ä¸‹ï¼š

1. ä½¿ç”¨SQLè¿›è¡Œæ•°æ®åˆ†æéƒ½æœ‰å“ªå‡ ç§å§¿åŠ¿ï¼Ÿ
2. å¦‚ä½•é€šè¿‡å…³è”è§„åˆ™æŒ–æ˜é›¶å”®æ•°æ®ä¸­çš„é¢‘ç¹é¡¹é›†ï¼Ÿ
3. å¦‚ä½•ä½¿ç”¨SQL+Pythonå®Œæˆé›¶å”®æ•°æ®çš„å…³è”åˆ†æï¼Ÿ

## ä½¿ç”¨SQLè¿›è¡Œæ•°æ®åˆ†æçš„5ç§å§¿åŠ¿

åœ¨DBMSä¸­ï¼Œæœ‰äº›æ•°æ®åº“ç®¡ç†ç³»ç»Ÿå¾ˆå¥½åœ°é›†æˆäº†BIå·¥å…·ï¼Œå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬å¯¹æ”¶é›†çš„æ•°æ®è¿›è¡Œå•†ä¸šåˆ†æã€‚

SQL Serveræä¾›äº†BIåˆ†æå·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨SQL Serverä¸­çš„Analysis Serviceså®Œæˆæ•°æ®æŒ–æ˜ä»»åŠ¡ã€‚SQL Serverå†…ç½®äº†å¤šç§æ•°æ®æŒ–æ˜ç®—æ³•ï¼Œæ¯”å¦‚å¸¸ç”¨çš„EMã€K-Meansèšç±»ç®—æ³•ã€å†³ç­–æ ‘ã€æœ´ç´ è´å¶æ–¯å’Œé€»è¾‘å›å½’ç­‰åˆ†ç±»ç®—æ³•ï¼Œä»¥åŠç¥ç»ç½‘ç»œç­‰æ¨¡å‹ã€‚æˆ‘ä»¬è¿˜å¯ä»¥å¯¹è¿™äº›ç®—æ³•æ¨¡å‹è¿›è¡Œå¯è§†åŒ–æ•ˆæœå‘ˆç°ï¼Œå¸®æˆ‘ä»¬ä¼˜åŒ–å’Œè¯„ä¼°ç®—æ³•æ¨¡å‹çš„å¥½åã€‚

PostgreSQLæ˜¯å…è´¹å¼€æºçš„å¯¹è±¡-å…³ç³»æ•°æ®åº“ï¼ˆORDBMSï¼‰ï¼Œå®ƒçš„ç¨³å®šæ€§éå¸¸å¼ºï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œåœ¨OLTPå’ŒOLAPç³»ç»Ÿä¸Šè¡¨ç°éƒ½éå¸¸å‡ºè‰²ã€‚åŒæ—¶åœ¨æœºå™¨å­¦ä¹ ä¸Šï¼Œé…åˆMadlibé¡¹ç›®å¯ä»¥è®©PostgreSQLå¦‚è™æ·»ç¿¼ã€‚MadlibåŒ…æ‹¬äº†å¤šç§æœºå™¨å­¦ä¹ ç®—æ³•ï¼Œæ¯”å¦‚åˆ†ç±»ã€èšç±»ã€æ–‡æœ¬åˆ†æã€å›å½’åˆ†æã€å…³è”è§„åˆ™æŒ–æ˜å’ŒéªŒè¯åˆ†æç­‰åŠŸèƒ½ã€‚è¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨SQLï¼Œåœ¨PostgreSQLä¸­ä½¿ç”¨å„ç§æœºå™¨å­¦ä¹ ç®—æ³•æ¨¡å‹ï¼Œå¸®æˆ‘ä»¬è¿›è¡Œæ•°æ®æŒ–æ˜å’Œåˆ†æã€‚

2018å¹´Googleå°†æœºå™¨å­¦ä¹ ï¼ˆMachine Learningï¼‰å·¥å…·é›†æˆåˆ°äº†BigQueryä¸­ï¼Œå‘å¸ƒäº†BigQuery MLï¼Œè¿™æ ·å¼€å‘è€…å°±å¯ä»¥åœ¨å¤§å‹çš„ç»“æ„åŒ–æˆ–åŠç»“æ„åŒ–çš„æ•°æ®é›†ä¸Šæ„å»ºå’Œä½¿ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹ã€‚é€šè¿‡BigQueryæ§åˆ¶å°ï¼Œå¼€å‘è€…å¯ä»¥åƒä½¿ç”¨SQLè¯­å¥ä¸€æ ·æ¥å®Œæˆæœºå™¨å­¦ä¹ æ¨¡å‹çš„è®­ç»ƒå’Œé¢„æµ‹ã€‚

SQLFlowæ˜¯èš‚èšé‡‘æœäº2019å¹´å¼€æºçš„æœºå™¨å­¦ä¹ å·¥å…·ï¼Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨SQLå°±å¯ä»¥å®Œæˆæœºå™¨å­¦ä¹ ç®—æ³•çš„è°ƒç”¨ï¼Œä½ å¯ä»¥å°†SQLFlowç†è§£ä¸ºæœºå™¨å­¦ä¹ çš„ç¿»è¯‘å™¨ã€‚æˆ‘ä»¬åœ¨SELECTä¹‹ååŠ ä¸ŠTRAINä»å¥å°±å¯ä»¥å®Œæˆæœºå™¨å­¦ä¹ æ¨¡å‹çš„è®­ç»ƒï¼Œåœ¨SELECTè¯­å¥ä¹‹ååŠ ä¸ŠPREDICTå°±å¯ä»¥ä½¿ç”¨æ¨¡å‹æ¥è¿›è¡Œé¢„æµ‹ã€‚è¿™äº›ç®—æ³•æ¨¡å‹æ—¢åŒ…æ‹¬äº†ä¼ ç»Ÿçš„æœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œä¹ŸåŒ…æ‹¬äº†åŸºäºTensorflowã€PyTorchç­‰æ¡†æ¶çš„æ·±åº¦å­¦ä¹ æ¨¡å‹ã€‚

ä»ä¸‹å›¾ä¸­ä½ ä¹Ÿèƒ½çœ‹å‡ºSQLFlowçš„ä½¿ç”¨è¿‡ç¨‹ï¼Œé¦–å…ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡Jupyter notebookæ¥å®ŒæˆSQLè¯­å¥çš„äº¤äº’ã€‚SQLFlowæ”¯æŒäº†å¤šç§SQLå¼•æ“ï¼ŒåŒ…æ‹¬MySQLã€Oracleã€Hiveã€SparkSQLå’ŒFlinkç­‰ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡SQLè¯­å¥ä»è¿™äº›DBMSä¸­æŠ½å–æ•°æ®ï¼Œç„¶åé€‰æ‹©æƒ³è¦è¿›è¡Œçš„æœºå™¨å­¦ä¹ ç®—æ³•ï¼ˆåŒ…æ‹¬ä¼ ç»Ÿæœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼‰è¿›è¡Œè®­ç»ƒå’Œé¢„æµ‹ã€‚ä¸è¿‡è¿™ä¸ªå·¥å…·åˆšåˆšä¸Šçº¿ï¼Œå·¥å…·ã€æ–‡æ¡£ã€ç¤¾åŒºè¿˜æœ‰å¾ˆå¤šéœ€è¦å®Œå–„çš„åœ°æ–¹ã€‚  
![](https://static001.geekbang.org/resource/image/e5/fd/e50038152a1b4e7a9940919be9634dfd.jpg?wh=478%2A742)  
æœ€åä¸€ä¸ªæ–¹æ³•æ˜¯SQL+Pythonï¼Œä¹Ÿæ˜¯æˆ‘ä»¬ä»Šå¤©è¦è®²è§£çš„å†…å®¹ã€‚åˆšæ‰ä»‹ç»çš„å·¥å…·å¯ä»¥è¯´æ—¢æ˜¯SQLæŸ¥è¯¢æ•°æ®çš„å…¥å£ï¼Œä¹Ÿæ˜¯æ•°æ®åˆ†æã€æœºå™¨å­¦ä¹ çš„å…¥å£ã€‚ä¸è¿‡è¿™äº›æ¨¡å—è€¦åˆåº¦é«˜ï¼Œä¹Ÿå¯èƒ½å­˜åœ¨ä½¿ç”¨çš„é—®é¢˜ã€‚ä¸€æ–¹é¢å·¥å…·ä¼šå¾ˆå¤§ï¼Œæ¯”å¦‚åœ¨å®‰è£…SQLFlowçš„æ—¶å€™ï¼Œé‡‡ç”¨Dockeræ–¹å¼ï¼ˆä¸‹å›¾ä¸ºä½¿ç”¨Dockerå®‰è£…sqlflowçš„è¿‡ç¨‹ï¼‰è¿›è¡Œå®‰è£…ï¼Œæ•´ä½“éœ€è¦ä¸‹è½½çš„æ–‡ä»¶ä¼šè¶…è¿‡2Gã€‚åŒæ—¶ï¼Œåœ¨è¿›è¡Œæœºå™¨å­¦ä¹ ç®—æ³•è°ƒå‚ã€ä¼˜åŒ–çš„æ—¶å€™ä¹Ÿå­˜åœ¨çµæ´»åº¦å·®çš„æƒ…å†µã€‚å› æ­¤æœ€ç›´æ¥çš„æ–¹å¼ï¼Œè¿˜æ˜¯å°†SQLä¸æœºå™¨å­¦ä¹ æ¨¡å—åˆ†å¼€ï¼Œé‡‡ç”¨SQLè¯»å–æ•°æ®ï¼Œç„¶åé€šè¿‡Pythonæ¥è¿›è¡Œæœºå™¨å­¦ä¹ çš„å¤„ç†ã€‚

![](https://static001.geekbang.org/resource/image/38/c8/38864b57d8d65728439b730d57d841c8.png?wh=1338%2A663)

## æ¡ˆä¾‹ï¼šæŒ–æ˜é›¶å”®æ•°æ®ä¸­çš„é¢‘ç¹é¡¹é›†ä¸å…³è”è§„åˆ™

åˆšæ‰æˆ‘ä»¬è®²è§£äº†å¦‚ä½•é€šè¿‡SQLæ¥å®Œæˆæ•°æ®åˆ†æï¼ˆæœºå™¨å­¦ä¹ ï¼‰çš„5ç§å§¿åŠ¿ï¼Œä¸‹é¢æˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹æ¥è¿›è¡Œå…·ä½“çš„è®²è§£ã€‚

æˆ‘ä»¬è¦åˆ†æçš„æ˜¯è´­ç‰©ç¯®é—®é¢˜ï¼Œé‡‡ç”¨çš„æŠ€æœ¯ä¸ºå…³è”åˆ†æã€‚å®ƒå¯ä»¥å¸®æˆ‘ä»¬åœ¨å¤§é‡çš„æ•°æ®é›†ä¸­æ‰¾åˆ°å•†å“ä¹‹é—´çš„å…³è”å…³ç³»ï¼Œä»è€ŒæŒ–æ˜å‡ºç»å¸¸è¢«äººä»¬è´­ä¹°çš„å•†å“ç»„åˆï¼Œä¸€ä¸ªç»å…¸çš„ä¾‹å­å°±æ˜¯â€œå•¤é…’å’Œå°¿å¸ƒâ€çš„ä¾‹å­ã€‚

ä»Šå¤©æˆ‘ä»¬çš„æ•°æ®é›†æ¥è‡ªäºä¸€ä¸ªé¢åŒ…åº—çš„21293ç¬”è®¢å•ï¼Œå­—æ®µåŒ…æ‹¬äº†Dateï¼ˆæ—¥æœŸï¼‰ã€Timeï¼ˆæ—¶é—´ï¼‰ã€Transactionï¼ˆäº¤æ˜“IDï¼‰ä»¥åŠItem(å•†å“åç§°)ã€‚å…¶ä¸­äº¤æ˜“IDçš„èŒƒå›´æ˜¯\[1,9684]ï¼Œåœ¨è¿™ä¸­é—´ä¹Ÿæœ‰ä¸€äº›äº¤æ˜“IDæ˜¯ç©ºç¼ºçš„ï¼ŒåŒä¸€ç¬”äº¤æ˜“ä¸­å­˜åœ¨å•†å“é‡å¤çš„æƒ…å†µã€‚é™¤æ­¤ä»¥å¤–ï¼Œæœ‰äº›äº¤æ˜“æ˜¯æ²¡æœ‰å•†å“çš„ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”çš„Itemä¸ºNONEã€‚å…·ä½“çš„æ•°æ®é›†ä½ å¯ä»¥ä»[GitHub](https://github.com/cystanford/SQLApriori)ä¸Šä¸‹è½½ã€‚

æˆ‘ä»¬é‡‡ç”¨çš„å…³è”åˆ†æç®—æ³•æ˜¯Aprioriç®—æ³•ï¼Œå®ƒå¸®æˆ‘ä»¬æŸ¥æ‰¾é¢‘ç¹é¡¹é›†ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å…ˆæ˜ç™½ä»€ä¹ˆæ˜¯é¢‘ç¹é¡¹é›†ã€‚

é¢‘ç¹é¡¹é›†å°±æ˜¯æ”¯æŒåº¦å¤§äºç­‰äºæœ€å°æ”¯æŒåº¦é˜ˆå€¼çš„é¡¹é›†ï¼Œå°äºè¿™ä¸ªæœ€å°å€¼æ”¯æŒåº¦çš„é¡¹ç›®å°±æ˜¯éé¢‘ç¹é¡¹é›†ï¼Œè€Œå¤§äºç­‰äºæœ€å°æ”¯æŒåº¦çš„é¡¹é›†å°±æ˜¯é¢‘ç¹é¡¹é›†ã€‚æ”¯æŒåº¦æ˜¯ä¸ªç™¾åˆ†æ¯”ï¼ŒæŒ‡çš„æ˜¯æŸä¸ªå•†å“ç»„åˆå‡ºç°çš„æ¬¡æ•°ä¸æ€»æ¬¡æ•°ä¹‹é—´çš„æ¯”ä¾‹ã€‚æ”¯æŒåº¦è¶Šé«˜ï¼Œä»£è¡¨è¿™ä¸ªç»„åˆå‡ºç°çš„é¢‘ç‡è¶Šå¤§ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ç†è§£ä¸€ä¸‹ï¼Œä¸‹é¢æ˜¯5ç¬”ç”¨æˆ·çš„è®¢å•ï¼Œä»¥åŠæ¯ç¬”è®¢å•è´­ä¹°çš„å•†å“ï¼š

![](https://static001.geekbang.org/resource/image/58/38/58d7791f7b1fe08f810e9e630b03bf38.png?wh=852%2A355)  
åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œâ€œç‰›å¥¶â€å‡ºç°äº†4æ¬¡ï¼Œé‚£ä¹ˆè¿™5ç¬”è®¢å•ä¸­â€œç‰›å¥¶â€çš„æ”¯æŒåº¦å°±æ˜¯4/5=0.8ã€‚åŒæ ·â€œç‰›å¥¶+é¢åŒ…â€å‡ºç°äº†3æ¬¡ï¼Œé‚£ä¹ˆè¿™5ç¬”è®¢å•ä¸­â€œç‰›å¥¶+é¢åŒ…â€çš„æ”¯æŒåº¦å°±æ˜¯3/5=0.6ã€‚

åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç†è§£ä¸€ä¸ªæ¦‚å¿µå«åšâ€œç½®ä¿¡åº¦â€ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯å½“ä½ è´­ä¹°äº†å•†å“Aï¼Œä¼šæœ‰å¤šå¤§çš„æ¦‚ç‡è´­ä¹°å•†å“Bï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç½®ä¿¡åº¦ï¼ˆç‰›å¥¶â†’å•¤é…’ï¼‰=2/4=0.5ï¼Œä»£è¡¨å¦‚æœä½ è´­ä¹°äº†ç‰›å¥¶ï¼Œä¼šæœ‰50%çš„æ¦‚ç‡ä¼šè´­ä¹°å•¤é…’ï¼›ç½®ä¿¡åº¦ï¼ˆå•¤é…’â†’ç‰›å¥¶ï¼‰=2/3=0.67ï¼Œä»£è¡¨å¦‚æœä½ è´­ä¹°äº†å•¤é…’ï¼Œæœ‰67%çš„æ¦‚ç‡ä¼šè´­ä¹°ç‰›å¥¶ã€‚

æ‰€ä»¥è¯´ç½®ä¿¡åº¦æ˜¯ä¸ªæ¡ä»¶æ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯åœ¨Aå‘ç”Ÿçš„æƒ…å†µä¸‹ï¼ŒBå‘ç”Ÿçš„æ¦‚ç‡æ˜¯å¤šå°‘ã€‚

æˆ‘ä»¬åœ¨è®¡ç®—å…³è”å…³ç³»çš„æ—¶å€™ï¼Œå¾€å¾€éœ€è¦è§„å®šæœ€å°æ”¯æŒåº¦å’Œæœ€å°ç½®ä¿¡åº¦ï¼Œè¿™æ ·æ‰å¯ä»¥å¯»æ‰¾å¤§äºç­‰äºæœ€å°æ”¯æŒåº¦çš„é¢‘ç¹é¡¹é›†ï¼Œä»¥åŠåœ¨é¢‘ç¹é¡¹é›†çš„åŸºç¡€ä¸Šï¼Œå¤§äºç­‰äºæœ€å°ç½®ä¿¡åº¦çš„å…³è”è§„åˆ™ã€‚

## ä½¿ç”¨SQL+Pythonå®Œæˆé›¶å”®æ•°æ®çš„å…³è”åˆ†æ

é’ˆå¯¹ä¸Šé¢çš„é›¶å”®æ•°æ®å…³è”åˆ†æçš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å·¥å…·è‡ªå¸¦çš„å…³è”è§„åˆ™è¿›è¡Œåˆ†æï¼Œæ¯”å¦‚ä½¿ç”¨SQL Server Analysis Servicesçš„å¤šç»´æ•°æ®åˆ†æï¼Œæˆ–è€…æ˜¯åœ¨Madlibã€BigQuery MLã€SQLFlowå·¥å…·ä¸­éƒ½å¯ä»¥æ‰¾åˆ°ç›¸åº”çš„å…³è”è§„åˆ™ï¼Œé€šè¿‡å†™SQLçš„æ–¹å¼å°±å¯ä»¥å®Œæˆå…³è”è§„åˆ™çš„è°ƒç”¨ã€‚

é™¤æ­¤ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨SQLå®Œæˆæ•°æ®çš„æŸ¥è¯¢ï¼Œç„¶åé€šè¿‡Pythonçš„æœºå™¨å­¦ä¹ å·¥å…·åŒ…å®Œæˆå…³è”åˆ†æã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¹‹å‰è®²è§£çš„SQLAlchemyæ¥å®ŒæˆSQLæŸ¥è¯¢ï¼Œä½¿ç”¨efficient\_aprioriå·¥å…·åŒ…çš„Aprioriç®—æ³•ã€‚æ•´ä¸ªå·¥ç¨‹ä¸€å…±åŒ…æ‹¬3ä¸ªéƒ¨åˆ†ã€‚

ç¬¬ä¸€ä¸ªéƒ¨åˆ†ä¸ºæ•°æ®åŠ è½½ï¼Œé¦–å…ˆæˆ‘ä»¬é€šè¿‡sql.create\_engineåˆ›å»ºSQLè¿æ¥ï¼Œç„¶åä»bread\_basketæ•°æ®è¡¨ä¸­è¯»å–å…¨éƒ¨çš„æ•°æ®åŠ è½½åˆ°dataä¸­ã€‚è¿™é‡Œéœ€è¦é…ç½®ä½ çš„MySQLè´¦æˆ·åå’Œå¯†ç 

ç¬¬äºŒæ­¥ä¸ºæ•°æ®é¢„å¤„ç†ï¼Œå› ä¸ºæ•°æ®ä¸­å­˜åœ¨æ— æ•ˆçš„æ•°æ®ï¼Œæ¯”å¦‚itemä¸ºNONEçš„æƒ…å†µï¼ŒåŒæ—¶Itemçš„å¤§å°å†™æ ¼å¼ä¸ç»Ÿä¸€ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å…ˆå°†Itemå­—æ®µéƒ½è½¬æ¢ä¸ºå°å†™çš„å½¢å¼ï¼Œç„¶åå»æ‰Itemå­—æ®µä¸­æ•°å€¼ä¸ºnoneçš„é¡¹ã€‚åœ¨æ•°æ®é¢„å¤„ç†ä¸­ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¾—åˆ°ä¸€ä¸ªtransactionsæ•°ç»„ï¼Œé‡Œé¢åŒ…æ‹¬äº†æ¯ç¬”è®¢å•çš„ä¿¡æ¯ï¼Œå…¶ä¸­æ¯ç¬”è®¢å•æ˜¯ä»¥é›†åˆçš„å½¢å¼è¿›è¡Œå­˜å‚¨çš„ï¼Œè¿™æ ·ç›¸åŒçš„è®¢å•ä¸­itemå°±ä¸å­˜åœ¨é‡å¤çš„æƒ…å†µï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨Aprioriå·¥å…·åŒ…ç›´æ¥è¿›è¡Œè®¡ç®—ã€‚

æœ€åä¸€æ­¥ï¼Œä½¿ç”¨Aprioriå·¥å…·åŒ…è¿›è¡Œå…³è”åˆ†æï¼Œè¿™é‡Œæˆ‘ä»¬è®¾å®šäº†å‚æ•°min\_support=0.02ï¼Œmin\_confidence=0.5ï¼Œä¹Ÿå°±æ˜¯æœ€å°æ”¯æŒåº¦ä¸º0.02ï¼Œæœ€å°ç½®ä¿¡åº¦ä¸º0.5ã€‚æ ¹æ®æ¡ä»¶æ‰¾å‡ºtransactionsä¸­çš„é¢‘ç¹é¡¹é›†itemsetså’Œå…³è”è§„åˆ™rulesã€‚

å…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š

```
from efficient_apriori import apriori
import sqlalchemy as sql
import pandas as pd
# æ•°æ®åŠ è½½
engine = sql.create_engine('mysql+mysqlconnector://root:passwd@localhost/wucai')
query = 'SELECT * FROM bread_basket'
data = pd.read_sql_query(query, engine)
# ç»Ÿä¸€å°å†™
data['Item'] = data['Item'].str.lower()
# å»æ‰noneé¡¹
data = data.drop(data[data.Item == 'none'].index)
 
# å¾—åˆ°ä¸€ç»´æ•°ç»„orders_seriesï¼Œå¹¶ä¸”å°†Transactionä½œä¸ºindex, valueä¸ºItemå–å€¼
orders_series = data.set_index('Transaction')['Item']
# å°†æ•°æ®é›†è¿›è¡Œæ ¼å¼è½¬æ¢
transactions = []
temp_index = 0
for i, v in orders_series.items():
    if i != temp_index:
       temp_set = set()
       temp_index = i
       temp_set.add(v)
       transactions.append(temp_set)
    else:
       temp_set.add(v)
# æŒ–æ˜é¢‘ç¹é¡¹é›†å’Œé¢‘ç¹è§„åˆ™
itemsets, rules = apriori(transactions, min_support=0.02,  min_confidence=0.5)
print('é¢‘ç¹é¡¹é›†ï¼š', itemsets)
print('å…³è”è§„åˆ™ï¼š', rules)
```

è¿è¡Œç»“æœï¼š

```
é¢‘ç¹é¡¹é›†ï¼š {1: {('alfajores',): 344, ('bread',): 3096, ('brownie',): 379, ('cake',): 983, ('coffee',): 4528, ('cookies',): 515, ('farm house',): 371, ('hot chocolate',): 552, ('juice',): 365, ('medialuna',): 585, ('muffin',): 364, ('pastry',): 815, ('sandwich',): 680, ('scandinavian',): 275, ('scone',): 327, ('soup',): 326, ('tea',): 1350, ('toast',): 318, ('truffles',): 192}, 2: {('bread', 'cake'): 221, ('bread', 'coffee'): 852, ('bread', 'pastry'): 276, ('bread', 'tea'): 266, ('cake', 'coffee'): 518, ('cake', 'tea'): 225, ('coffee', 'cookies'): 267, ('coffee', 'hot chocolate'): 280, ('coffee', 'juice'): 195, ('coffee', 'medialuna'): 333, ('coffee', 'pastry'): 450, ('coffee', 'sandwich'): 362, ('coffee', 'tea'): 472, ('coffee', 'toast'): 224}}
å…³è”è§„åˆ™ï¼š [{cake} -> {coffee}, {cookies} -> {coffee}, {hot chocolate} -> {coffee}, {juice} -> {coffee}, {medialuna} -> {coffee}, {pastry} -> {coffee}, {sandwich} -> {coffee}, {toast} -> {coffee}]
```

ä»ç»“æœä¸­ä½ èƒ½çœ‹åˆ°è´­ç‰©ç¯®ç»„åˆä¸­ï¼Œå•†å“ä¸ªæ•°ä¸º1çš„é¢‘ç¹é¡¹é›†æœ‰19ç§ï¼Œåˆ†åˆ«ä¸ºé¢åŒ…ã€è›‹ç³•ã€å’–å•¡ç­‰ã€‚å•†å“ä¸ªæ•°ä¸º2çš„é¢‘ç¹é¡¹é›†æœ‰14ç§ï¼ŒåŒ…æ‹¬ï¼ˆé¢åŒ…ï¼Œè›‹ç³•ï¼‰ï¼Œï¼ˆé¢åŒ…ï¼Œå’–å•¡ï¼‰ç­‰ã€‚å…¶ä¸­å…³è”è§„åˆ™æœ‰8ç§ï¼ŒåŒ…æ‹¬äº†è´­ä¹°è›‹ç³•çš„äººä¹Ÿä¼šè´­ä¹°å’–å•¡ï¼Œè´­ä¹°æ›²å¥‡çš„åŒæ—¶ä¹Ÿä¼šè´­ä¹°å’–å•¡ç­‰ã€‚

## æ€»ç»“

é€šè¿‡SQLå®Œæˆæœºå™¨å­¦ä¹ å¾€å¾€è¿˜æ˜¯éœ€è¦ä½¿ç”¨åˆ°Pythonï¼Œå› ä¸ºæ•°æ®åˆ†ææ˜¯Pythonçš„æ“…é•¿ã€‚é€šè¿‡ä»Šå¤©çš„å­¦ä¹ ä½ åº”è¯¥èƒ½ä½“ä¼šåˆ°é‡‡ç”¨SQLå·¥å…·ä½œä¸ºæ•°æ®æŸ¥è¯¢å’Œåˆ†æçš„å…¥å£æ˜¯ä¸€ç§æ•°æ®å…¨æ ˆçš„æ€è·¯ï¼Œå¯¹äºå¼€å‘äººå‘˜æ¥è¯´é™ä½äº†æ•°æ®åˆ†æçš„æŠ€æœ¯é—¨æ§›ã€‚

å¦‚æœä½ æƒ³è¦å¯¹æœºå™¨å­¦ä¹ æˆ–è€…æ•°æ®åˆ†æç®—æ³•æœ‰æ›´æ·±å…¥çš„ç†è§£ï¼Œä¹Ÿå¯ä»¥å‚è€ƒæˆ‘çš„ã€Šæ•°æ®åˆ†æå®æˆ˜45è®²ã€‹ä¸“æ ï¼Œç›¸ä¿¡åœ¨å½“ä»Šçš„æ•°æ®æ—¶ä»£ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡å¢é•¿ä¼šè¶Šæ¥è¶Šä¾é äºSQLå¼•æ“+AIå¼•æ“ã€‚

æˆ‘åœ¨æ–‡ç« ä¸­ä¸¾äº†ä¸€ä¸ªè´­ç‰©ç¯®åˆ†æçš„ä¾‹å­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶ä¸­ï¼ˆç‰›å¥¶ã€é¢åŒ…ã€å°¿å¸ƒï¼‰çš„æ”¯æŒåº¦æ˜¯å¤šå°‘å‘¢ï¼Ÿ

![](https://static001.geekbang.org/resource/image/a1/e6/a1767ae691f2c18d02f8009a687ba1e6.png?wh=850%2A361)  
æ¬¢è¿ä½ åœ¨è¯„è®ºåŒºå†™ä¸‹ä½ çš„æ€è€ƒï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–è€…åŒäº‹ï¼Œä¸€èµ·äº¤æµä¸€ä¸‹ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ10ï¼‰</strong></div><ul>
<li><span>mickey</span> ğŸ‘ï¼ˆ19ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>import numpy as np
import pandas as pd
title = [&#39;ç‰›å¥¶&#39;, &#39;é¢åŒ…&#39;, &#39;å°¿å¸ƒ&#39;, &#39;å¯ä¹&#39;, &#39;å•¤é…’&#39;, &#39;é¸¡è›‹&#39;];
x = [[1, 1, 1, 0, 0, 0],
     [0, 1, 1, 1, 1, 0],
     [1, 0, 1, 0, 1, 1],
     [1, 1, 1, 0, 1, 0],
     [1, 1, 1, 1, 0, 0]]
df = pd.DataFrame(x, columns=title)


# åˆ›å»ºä¸¤ä¸ªè¡¨ åˆ†åˆ«ä½œä¸ºæ”¯æŒåº¦å’Œç½®ä¿¡åº¦çš„å‡†å¤‡è¡¨
df1 = pd.DataFrame(np.zeros([1, 6]), index=[&#39;æ”¯æŒåº¦&#39;], columns=title)
df2 = pd.DataFrame(np.zeros([6, 6]), index=title, columns=title)
df3 = pd.DataFrame(np.zeros([6, 6]), index=title, columns=title)


# è®¡ç®—æ”¯æŒåº¦
for i in x:
    for j in range(1):
        for k in range(j, 6):
           if not i[k] : continue
           df1.iloc[j,k] += 1

support = df1.apply(lambda x: x &#47;5)
# è¿”å›æ”¯æŒåº¦çš„ç»“æœ
print(support)

# è®¡ç®—ç½®ä¿¡åº¦
for i in x:
    for j in range(5):
        # å¦‚æœä¸º0 å°±è·³è¿‡
        if not i[j] : continue
        # å¦‚æœä¸0ï¼Œç»§ç»­éå†ï¼Œå¦‚æœæœ‰è´­ä¹°ï¼Œä¾¿+1
        for k in range(j+1,5):
            if not i[k] : continue
            df2.iloc[j,k] += 1
            df2.iloc[k,j] += 1
for j in range(6):
    df3.iloc[j] = df2.iloc[j] &#47; df.sum()[j]
confidence = df3.round(2) # ä»¥3ä½å°æ•°è¿”å›ç½®ä¿¡åº¦è¡¨
# è¿”å›ç½®ä¿¡åº¦çš„ç»“æœ
print(confidence)

      ç‰›å¥¶   é¢åŒ…   å°¿å¸ƒ   å¯ä¹   å•¤é…’   é¸¡è›‹
æ”¯æŒåº¦  0.8  0.8  1.0  0.4  0.6  0.2
      ç‰›å¥¶    é¢åŒ…   å°¿å¸ƒ    å¯ä¹   å•¤é…’   é¸¡è›‹
ç‰›å¥¶  0.00  0.75  1.0  0.25  0.5  0.0
é¢åŒ…  0.75  0.00  1.0  0.50  0.5  0.0
å°¿å¸ƒ  0.80  0.80  0.0  0.40  0.6  0.0
å¯ä¹  0.50  1.00  1.0  0.00  0.5  0.0
å•¤é…’  0.67  0.67  1.0  0.33  0.0  0.0
é¸¡è›‹  0.00  0.00  0.0  0.00  0.0  0.0
</p>2019-09-27</li><br/><li><span>å­¦ä¹ </span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç‰›å¥¶ï¼Œé¢åŒ…ï¼Œå°¿å¸ƒåŒæ—¶å‡ºç°æ˜¯3ï¼Œæ”¯æŒåº¦æ˜¯3&#47;5=0.6</p>2019-09-27</li><br/><li><span>mickey</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>	æ”¯æŒåº¦
ç‰›å¥¶	0.8
é¢åŒ…	0.8
å°¿å¸ƒ	1
å¯ä¹	0.4
å•¤é…’	0.6
é¸¡è›‹	0.2
</p>2019-09-27</li><br/><li><span>JustDoDT</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>efficient-aprioriå®˜æ–¹æ–‡æ¡£
https:&#47;&#47;efficient-apriori.readthedocs.io&#47;en&#47;stable&#47;</p>2019-09-27</li><br/><li><span>éª‘è¡Œçš„æŒæŸœJ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯„è®ºé‡Œæœ‹å‹tttttè¯´â€ 
é‡åˆ°é”™è¯¯ï¼šmysql.connector.errors.NotSupportedError) Authentication plugin &#39;caching_sha2_password&#39; is not supported â€œ
æ¢pymysqlå°±å¯ä»¥ï¼Œä¸è¿‡æˆ‘è¿™é‡Œæœ‰å¦ä¸€ç§è§£æ³•ï¼Œå¯ä»¥åˆ°æˆ‘çš„åšå®¢çœ‹çœ‹ï¼Œå¸Œæœ›å¯¹ä½ æœ‰å¸®åŠ©ï¼è°¢è°¢
https:&#47;&#47;blog.csdn.net&#47;weixin_41013322&#47;article&#47;details&#47;103427293 </p>2019-12-06</li><br/><li><span>TKbook</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>transactions = []
temp_index = 0
for i, v in orders_series.items():
    if i != temp_index:
        temp_set = set()
        temp_index = i
        temp_set.add(v)
        transactions.append(temp_set)
        print(transactions)
    else:
        temp_set.add(v)
è€å¸ˆï¼Œè¿™é‡Œçš„transactions = [] é‡Œé¢çš„å…ƒç´ ï¼Œä¸åº”è¯¥æ˜¯æ¯ä¸ªè®¢å•æ‰€æœ‰çš„å•†å“é›†åˆå—ï¼Ÿ  ä½†æ˜¯ä¸Šè¿°ä»£ç ä¸æ˜¯å®ç°è¿™ä¸ªéœ€æ±‚</p>2019-09-27</li><br/><li><span>JustDoDT</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>
# ä¸€è¡Œä»£ç æ•°æ®é›†æ ¼å¼è½¬æ¢
# transactions = list(data.groupby(&#39;Transaction&#39;).agg(lambda x: set(x.Item.values))[&#39;Item&#39;])
# å®Œæ•´ä»£ç 
from efficient_apriori import apriori
import sqlalchemy as sql
import pandas as pd

# æ•°æ®åŠ è½½
engine = sql.create_engine(&#39;mysql+pymysql:&#47;&#47;root:passwd@localhost&#47;wucai&#39;)
query = &#39;SELECT * FROM bread_basket&#39;
data = pd.read_sql_query(query, engine)

# ç»Ÿä¸€å°å†™
data[&#39;Item&#39;] = data[&#39;Item&#39;].str.lower()
# å»æ‰noneé¡¹
data = data.drop(data[data.Item == &#39;none&#39;].index)

# å¾—åˆ°ä¸€ç»´æ•°ç»„orders_seriesï¼Œå¹¶ä¸”å°†Transactionä½œä¸ºindex, valueä¸ºItemå–å€¼
orders_series = data.set_index(&#39;Transaction&#39;)[&#39;Item&#39;]
# å°†æ•°æ®é›†è¿›è¡Œæ ¼å¼è½¬æ¢
transactions = transactions = list(data.groupby(&#39;Transaction&#39;).agg(lambda x: set(x.Item.values))[&#39;Item&#39;])

# æŒ–æ˜é¢‘ç¹é¡¹é›†å’Œé¢‘ç¹è§„åˆ™
itemsets, rules = apriori(transactions, min_support=0.02, min_confidence=0.5)
print(&#39;é¢‘ç¹é¡¹é›†ï¼š&#39;, itemsets)
print(&#39;å…³è”è§„åˆ™ï¼š&#39;, rules)

# ----------è¾“å‡ºç»“æœ------------------ #
é¢‘ç¹é¡¹é›†ï¼š {1: {(&#39;alfajores&#39;,): 344, (&#39;bread&#39;,): 3096, (&#39;brownie&#39;,): 379, (&#39;cake&#39;,): 983, (&#39;coffee&#39;,): 4528, (&#39;cookies&#39;,): 515, (&#39;farm house&#39;,): 371, (&#39;hot chocolate&#39;,): 552, (&#39;juice&#39;,): 365, (&#39;medialuna&#39;,): 585, (&#39;muffin&#39;,): 364, (&#39;pastry&#39;,): 815, (&#39;sandwich&#39;,): 680, (&#39;scandinavian&#39;,): 275, (&#39;scone&#39;,): 327, (&#39;soup&#39;,): 326, (&#39;tea&#39;,): 1350, (&#39;toast&#39;,): 318, (&#39;truffles&#39;,): 192}, 2: {(&#39;bread&#39;, &#39;cake&#39;): 221, (&#39;bread&#39;, &#39;coffee&#39;): 852, (&#39;bread&#39;, &#39;pastry&#39;): 276, (&#39;bread&#39;, &#39;tea&#39;): 266, (&#39;cake&#39;, &#39;coffee&#39;): 518, (&#39;cake&#39;, &#39;tea&#39;): 225, (&#39;coffee&#39;, &#39;cookies&#39;): 267, (&#39;coffee&#39;, &#39;hot chocolate&#39;): 280, (&#39;coffee&#39;, &#39;juice&#39;): 195, (&#39;coffee&#39;, &#39;medialuna&#39;): 333, (&#39;coffee&#39;, &#39;pastry&#39;): 450, (&#39;coffee&#39;, &#39;sandwich&#39;): 362, (&#39;coffee&#39;, &#39;tea&#39;): 472, (&#39;coffee&#39;, &#39;toast&#39;): 224}}
å…³è”è§„åˆ™ï¼š [{cake} -&gt; {coffee}, {cookies} -&gt; {coffee}, {hot chocolate} -&gt; {coffee}, {juice} -&gt; {coffee}, {medialuna} -&gt; {coffee}, {pastry} -&gt; {coffee}, {sandwich} -&gt; {coffee}, {toast} -&gt; {coffee}]</p>2019-09-27</li><br/><li><span>JustDoDT</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>é‡åˆ°é”™è¯¯ï¼šNotSupportedError: (mysql.connector.errors.NotSupportedError) Authentication plugin &#39;caching_sha2_password&#39; is not supported (Background on this error at: http:&#47;&#47;sqlalche.me&#47;e&#47;tw8g)
è§£å†³æ–¹æ³•
engine = sql.create_engine( &#39;mysql+pymysql:&#47;&#47;{}:{}@{}&#47;{}&#39;.format(user, passwd, host, database))
mysql+mysqlconnector æ”¹æˆ mysql+pymysql å°±è¡Œäº†</p>2019-09-27</li><br/><li><span>é‚µå®¶ä¼Ÿ</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>C#
string[] item = { &quot;ç‰›å¥¶&quot;, &quot;é¢åŒ…&quot;, &quot;å°¿å¸ƒ&quot;, &quot;é¸¡è›‹&quot;, &quot;å•¤é…’&quot;, &quot;å¯ä¹&quot; };
            int[,] Record = { { 1, 1, 1, 0, 0, 0 }, { 0, 1, 1, 0, 1, 0 }, { 1, 0, 1, 1, 1, 0 }, { 1, 1, 1, 0, 1, 0 }, { 1, 1, 1, 0, 0, 1 } };
            double SupportRate;
            for (int a = 0; a &lt; 6; a++)&#47;&#47;åˆ—éå†
            {	int Count = 0;int total = 0;
                for (int b = 0; b &lt; 5; b++)&#47;&#47;è¡Œéå†
                {	total += 1;
                    if (Record[b, a] == 1)  Count += 1;
                }
                SupportRate = Convert.ToDouble(Count) &#47; Convert.ToDouble(total);
                Context.Response.Write(item[a] + &quot;æ”¯æŒåº¦ä¸º&quot; + SupportRate+&quot;&lt;&#47;br&gt;&quot;);
            }
            double[,] BelieveRate = new double[6, 6];
            for (int a = 0; a &lt; 6; a++)&#47;&#47;è¡Œ
            {	for (int b = 0; b &lt; 6; b++) &#47;&#47;åˆ—
                {	if (a == b)  BelieveRate[a, b] = 0;
                    else
                    {	int total = 0;
                        int count = 0;
                        for (int c = 0; c &lt; 5; c++)
                        {	if(Record[c,a]==1)
                            {	total += 1;
                                if (Record[c, b] == 1)	count += 1;
                            }
                        }
             BelieveRate[a,b]=Convert.ToDouble(count)&#47;Convert.ToDouble(total);
                    }    
                }
            }
            for (int a = 0; a &lt; 7; a++)
            {	for (int b = 0; b &lt; 7; b++)
                {	if (a == 0 &amp;&amp; b == 0)	Context.Response.Write(&quot;ç½®ä¿¡åº¦&quot;);
                    if(a==0&amp;&amp;b&gt;0)	Context.Response.Write(&quot;&amp;nbsp; &amp;nbsp; &quot; + item[b-1]+ &quot;&amp;nbsp; &amp;nbsp;&amp;nbsp; &quot;);
                    if (a &gt; 0 &amp;&amp; b == 0)	 Context.Response.Write(&quot;&amp;nbsp; &amp;nbsp;&quot; + item[a-1]+ &quot;&amp;nbsp; &amp;nbsp; &amp;nbsp;&quot;);
                    if (a &gt; 0 &amp;&amp; b &gt; 0)	Context.Response.Write(BelieveRate[a - 1, b - 1].ToString(&quot;0.00&quot;) + &quot; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;  &quot;);
                }
                Context.Response.Write(&quot;&lt;&#47;br&gt;&quot;);
            } 
</p>2021-07-07</li><br/><li><span>é‚µå®¶ä¼Ÿ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ç»“æœï¼š
ç‰›å¥¶æ”¯æŒåº¦ä¸º0.8
é¢åŒ…æ”¯æŒåº¦ä¸º0.8
å°¿å¸ƒæ”¯æŒåº¦ä¸º1
é¸¡è›‹æ”¯æŒåº¦ä¸º0.2
å•¤é…’æ”¯æŒåº¦ä¸º0.6
å¯ä¹æ”¯æŒåº¦ä¸º0.2
ç½®ä¿¡åº¦    ç‰›å¥¶         é¢åŒ…         å°¿å¸ƒ         é¸¡è›‹         å•¤é…’         å¯ä¹    
   ç‰›å¥¶     0.00         0.75         1.00         0.25         0.50         0.25        
   é¢åŒ…     0.75         0.00         1.00         0.00         0.50         0.25        
   å°¿å¸ƒ     0.80         0.80         0.00         0.20         0.60         0.20        
   é¸¡è›‹     1.00         0.00         1.00         0.00         1.00         0.00        
   å•¤é…’     0.67         0.67         1.00         0.33         0.00         0.00        
   å¯ä¹     1.00         1.00         1.00         0.00         0.00         0.00        </p>2021-07-07</li><br/>
</ul>