ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»‹ç»äº†Python DB APIè§„èŒƒçš„ä½œç”¨ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨MySQLå®˜æ–¹çš„mysql-connectoré©±åŠ¨æ¥å®Œæˆæ•°æ®åº“çš„è¿æ¥å’Œä½¿ç”¨ã€‚åœ¨é¡¹ç›®æ¯”è¾ƒå°çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨SQLè¯­å¥ï¼Œé€šè¿‡mysql-connectorå®Œæˆä¸MySQLçš„äº¤äº’ï¼Œä½†æ˜¯ä»»ä½•äº‹ç‰©éƒ½æœ‰ä¸¤é¢æ€§ï¼Œéšç€é¡¹ç›®è§„æ¨¡çš„å¢åŠ ï¼Œä»£ç ä¼šè¶Šæ¥è¶Šå¤æ‚ï¼Œç»´æŠ¤çš„æˆæœ¬ä¹Ÿè¶Šæ¥è¶Šé«˜ï¼Œè¿™æ—¶mysql-connectorå°±ä¸å¤Ÿç”¨äº†ï¼Œæˆ‘ä»¬éœ€è¦æ›´å¥½çš„è®¾è®¡æ¨¡å¼ã€‚

Pythonè¿˜æœ‰å¦ä¸€ç§æ–¹å¼å¯ä»¥ä¸MySQLè¿›è¡Œäº¤äº’ï¼Œè¿™ç§æ–¹å¼é‡‡ç”¨çš„æ˜¯ORMæ¡†æ¶ã€‚æˆ‘ä»¬ä»Šå¤©å°±æ¥è®²è§£å¦‚ä½•ä½¿ç”¨ORMæ¡†æ¶æ“ä½œMySQLï¼Œé‚£ä¹ˆä»Šå¤©çš„è¯¾ç¨‹ä½ éœ€è¦æŒæ¡ä»¥ä¸‹å‡ ä¸ªæ–¹é¢çš„å†…å®¹ï¼š

1. ä»€ä¹ˆæ˜¯ORMæ¡†æ¶ï¼Œä»¥åŠä¸ºä»€ä¹ˆè¦ä½¿ç”¨ORMæ¡†æ¶ï¼Ÿ
2. Pythonä¸­çš„ORMæ¡†æ¶éƒ½æœ‰å“ªäº›ï¼Ÿ
3. å¦‚ä½•ä½¿ç”¨SQLAlchemyæ¥å®Œæˆä¸MySQLçš„äº¤äº’ï¼Ÿ

## æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ORMæ¡†æ¶ï¼Ÿ

åœ¨è®²è§£ORMæ¡†æ¶ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä»€ä¹ˆæ˜¯æŒä¹…åŒ–ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒæŒä¹…åŒ–å±‚åœ¨ä¸šåŠ¡é€»è¾‘å±‚å’Œæ•°æ®åº“å±‚èµ·åˆ°äº†è¡”æ¥çš„ä½œç”¨ï¼Œå®ƒå¯ä»¥å°†å†…å­˜ä¸­çš„æ•°æ®æ¨¡å‹è½¬åŒ–ä¸ºå­˜å‚¨æ¨¡å‹ï¼Œæˆ–è€…å°†å­˜å‚¨æ¨¡å‹è½¬åŒ–ä¸ºå†…å­˜ä¸­çš„æ•°æ®æ¨¡å‹ã€‚

![](https://static001.geekbang.org/resource/image/b9/5b/b9dafd636ec586704bb8488d9b2faa5b.jpg?wh=655%2A506)

ä½ å¯èƒ½ä¼šæƒ³åˆ°ï¼Œæˆ‘ä»¬åœ¨è®²äº‹åŠ¡çš„4å¤§ç‰¹æ€§ACIDæ—¶ï¼Œæåˆ°è¿‡æŒä¹…æ€§ã€‚ä½ å¯ä»¥ç®€å•åœ°ç†è§£ä¸ºï¼ŒæŒä¹…æ€§å°±æ˜¯å°†å¯¹è±¡æ•°æ®æ°¸ä¹…å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚é€šå¸¸æˆ‘ä»¬å°†æ•°æ®åº“çš„ä½œç”¨ç†è§£ä¸ºæ°¸ä¹…å­˜å‚¨ï¼Œå°†å†…å­˜ç†è§£ä¸ºæš‚æ—¶å­˜å‚¨ã€‚æˆ‘ä»¬åœ¨ç¨‹åºçš„å±‚é¢æ“ä½œæ•°æ®ï¼Œå…¶å®éƒ½æ˜¯æŠŠæ•°æ®æ”¾åˆ°å†…å­˜ä¸­è¿›è¡Œå¤„ç†ï¼Œå¦‚æœéœ€è¦æ•°æ®å°±ä¼šé€šè¿‡æŒä¹…åŒ–å±‚ï¼Œä»æ•°æ®åº“ä¸­å–æ•°æ®ï¼›å¦‚æœéœ€è¦ä¿å­˜æ•°æ®ï¼Œå°±æ˜¯å°†å¯¹è±¡æ•°æ®é€šè¿‡æŒä¹…åŒ–å±‚å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ã€‚

é‚£ä¹ˆORMè§£å†³çš„æ˜¯ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå®ƒæä¾›äº†ä¸€ç§æŒä¹…åŒ–æ¨¡å¼ï¼Œå¯ä»¥é«˜æ•ˆåœ°å¯¹æ•°æ®åº“è¿›è¡Œè®¿é—®ã€‚ORMçš„è‹±æ–‡æ˜¯Object Relation Mappingï¼Œä¸­æ–‡å«å¯¹è±¡å…³ç³»æ˜ å°„ã€‚å®ƒæ˜¯RDBMSå’Œä¸šåŠ¡å®ä½“å¯¹è±¡ä¹‹é—´çš„ä¸€ä¸ªæ˜ å°„ï¼Œä»å›¾ä¸­ä½ ä¹Ÿèƒ½çœ‹åˆ°ï¼Œå®ƒå¯ä»¥æŠŠåº•å±‚çš„RDBMSå°è£…æˆä¸šåŠ¡å®ä½“å¯¹è±¡ï¼Œæä¾›ç»™ä¸šåŠ¡é€»è¾‘å±‚ä½¿ç”¨ã€‚ç¨‹åºå‘˜å¾€å¾€å…³æ³¨ä¸šåŠ¡é€»è¾‘å±‚é¢ï¼Œè€Œä¸æ˜¯åº•å±‚æ•°æ®åº“è¯¥å¦‚ä½•è®¿é—®ï¼Œä»¥åŠå¦‚ä½•ç¼–å†™SQLè¯­å¥è·å–æ•°æ®ç­‰ç­‰ã€‚é‡‡ç”¨ORMï¼Œå°±å¯ä»¥ä»æ•°æ®åº“çš„è®¾è®¡å±‚é¢è½¬åŒ–æˆé¢å‘å¯¹è±¡çš„æ€ç»´ã€‚

æˆ‘åœ¨å¼€ç¯‡çš„æ—¶å€™æåˆ°è¿‡ï¼Œéšç€é¡¹ç›®è§„æ¨¡çš„å¢å¤§ï¼Œåœ¨ä»£ç å±‚ç¼–å†™SQLè¯­å¥è®¿é—®æ•°æ®åº“ä¼šé™ä½å¼€å‘æ•ˆç‡ï¼Œä¹Ÿä¼šæå‡ç»´æŠ¤æˆæœ¬ï¼Œå› æ­¤è¶Šæ¥è¶Šå¤šçš„å¼€å‘äººå‘˜ä¼šé‡‡ç”¨åŸºäºORMçš„æ–¹å¼æ¥æ“ä½œæ•°æ®åº“ã€‚è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯ä¸€æ—¦å®šä¹‰å¥½äº†å¯¹è±¡æ¨¡å‹ï¼Œå°±å¯ä»¥è®©å®ƒä»¬ç®€å•å¯å¤ç”¨ï¼Œä»è€Œä¸å¿…å…³æ³¨åº•å±‚çš„æ•°æ®åº“è®¿é—®ç»†èŠ‚ï¼Œæˆ‘ä»¬åªè¦å°†æ³¨æ„åŠ›é›†ä¸­åˆ°ä¸šåŠ¡é€»è¾‘å±‚é¢å°±å¯ä»¥äº†ã€‚ç”±æ­¤è¿˜å¯ä»¥å¸¦æ¥å¦ä¸€ç‚¹å¥½å¤„ï¼Œé‚£å°±æ˜¯å³ä¾¿æ•°æ®åº“æœ¬èº«è¿›è¡Œäº†æ›´æ¢ï¼Œåœ¨ä¸šåŠ¡é€»è¾‘ä»£ç ä¸Šä¹Ÿä¸ä¼šæœ‰å¤§çš„è°ƒæ•´ã€‚è¿™æ˜¯å› ä¸ºORMæŠ½è±¡äº†æ•°æ®çš„å­˜å–ï¼ŒåŒæ—¶ä¹Ÿå…¼å®¹å¤šç§DBMSï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒåº•å±‚é‡‡ç”¨çš„åˆ°åº•æ˜¯å“ªç§DBMSï¼Œæ˜¯MySQLï¼ŒSQL Serverï¼ŒPostgreSQLè¿˜æ˜¯SQLiteã€‚

ä½†æ²¡æœ‰ä¸€ç§æ¨¡å¼æ˜¯å®Œç¾çš„ï¼Œé‡‡ç”¨ORMå½“ç„¶ä¹Ÿä¼šä»˜å‡ºä¸€äº›ä»£ä»·ï¼Œæ¯”å¦‚æ€§èƒ½ä¸Šçš„ä¸€äº›æŸå¤±ã€‚é¢å¯¹ä¸€äº›å¤æ‚çš„æ•°æ®æŸ¥è¯¢ï¼ŒORMä¼šæ˜¾å¾—åŠ›ä¸ä»å¿ƒã€‚è™½ç„¶å¯ä»¥å®ç°åŠŸèƒ½ï¼Œä½†ç›¸æ¯”äºç›´æ¥ç¼–å†™SQLæŸ¥è¯¢è¯­å¥æ¥è¯´ï¼ŒORMéœ€è¦ç¼–å†™çš„ä»£ç é‡å’ŒèŠ±è´¹çš„æ—¶é—´ä¼šæ¯”è¾ƒå¤šï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œç›´æ¥ç¼–å†™SQLåè€Œä¼šæ›´ç®€å•æœ‰æ•ˆã€‚

å…¶å®ä½ ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œæ²¡æœ‰ä¸€ç§æ–¹å¼æ˜¯ä¸€åŠ³æ°¸é€¸çš„ï¼Œåœ¨å®é™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®éœ€æ±‚é€‰æ‹©é€‚åˆçš„æ–¹å¼ã€‚

## Pythonä¸­çš„ORMæ¡†æ¶éƒ½æœ‰å“ªäº›

ORMæ¡†æ¶å¸®æˆ‘ä»¬é€‚é…äº†å„ç§DBMSï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©ä¸åŒçš„ORMæ¡†æ¶ã€‚å¦‚æœä½ ç”¨Pythonçš„è¯ï¼Œæœ‰ä¸‰ç§ä¸»æµçš„ORMæ¡†æ¶ã€‚

ç¬¬ä¸€ä¸ªæ˜¯Djangoï¼Œå®ƒæ˜¯Pythonçš„WEBåº”ç”¨å¼€å‘æ¡†æ¶ï¼Œæœ¬èº«èµ°å¤§è€Œå…¨çš„æ–¹å¼ã€‚Djangoé‡‡ç”¨äº†MTVçš„æ¡†æ¶æ¨¡å¼ï¼ŒåŒ…æ‹¬äº†Modelï¼ˆæ¨¡å‹ï¼‰ï¼ŒViewï¼ˆè§†å›¾ï¼‰å’ŒTemplateï¼ˆæ¨¡ç‰ˆï¼‰ã€‚Modelæ¨¡å‹åªæ˜¯Djangoçš„ä¸€éƒ¨åˆ†åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¥å®ç°æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥æ“ä½œã€‚

ä¸€ä¸ªModelæ˜ å°„åˆ°ä¸€ä¸ªæ•°æ®è¡¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://static001.geekbang.org/resource/image/d9/95/d9ea5e64198554061c729ffb97561795.jpg?wh=634%2A454)  
ä»è¿™å¼ å›¾ä¸Šä½ èƒ½ç›´è§‚åœ°çœ‹åˆ°ï¼ŒORMçš„ä½œç”¨å°±æ˜¯å»ºç«‹äº†å¯¹è±¡å…³ç³»æ˜ å°„ã€‚æ¨¡å‹çš„æ¯ä¸ªå±æ€§ä»£è¡¨æ•°æ®è¡¨ä¸­çš„ä¸€ä¸ªå­—æ®µï¼Œæˆ‘ä»¬é€šè¿‡æ“ä½œç±»å®ä¾‹å¯¹è±¡ï¼Œå¯¹æ•°æ®è¡¨ä¸­çš„æ•°æ®è¡Œè¿›è¡Œå¢åˆ æ”¹æŸ¥ç­‰æ“ä½œã€‚

ç¬¬äºŒä¸ªæ˜¯SQLALchemyï¼Œå®ƒä¹Ÿæ˜¯Pythonä¸­å¸¸ç”¨çš„ORMæ¡†æ¶ä¹‹ä¸€ã€‚å®ƒæä¾›äº†SQLå·¥å…·åŒ…åŠORMå·¥å…·ï¼Œå¦‚æœä½ æƒ³ç”¨æ”¯æŒORMå’Œæ”¯æŒåŸç”ŸSQLä¸¤ç§æ–¹å¼çš„å·¥å…·ï¼Œé‚£ä¹ˆSQLALchemyæ˜¯å¾ˆå¥½çš„é€‰æ‹©ã€‚å¦å¤–SQLALchemyçš„ç¤¾åŒºæ›´åŠ æ´»è·ƒï¼Œè¿™å¯¹é¡¹ç›®å®æ–½ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚

ç¬¬ä¸‰ä¸ªæ˜¯peeweeï¼Œè¿™æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ORMæ¡†æ¶ï¼Œç®€å•æ˜“ç”¨ã€‚peeweeé‡‡ç”¨äº†Modelç±»ã€Fieldå®ä¾‹å’ŒModelå®ä¾‹æ¥ä¸æ•°æ®åº“å»ºç«‹æ˜ å°„å…³ç³»ï¼Œä»è€Œå®Œæˆé¢å‘å¯¹è±¡çš„ç®¡ç†æ–¹å¼ã€‚ä½¿ç”¨èµ·æ¥æ–¹ä¾¿ï¼Œå­¦ä¹ æˆæœ¬ä¹Ÿä½ã€‚

## å¦‚ä½•ä½¿ç”¨SQLAlchemyæ¥æ“ä½œMySQL

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹å¦‚ä½•ä½¿ç”¨SQLAlchemyå·¥å…·å¯¹playeræ•°æ®è¡¨è¿›è¡Œå¢åˆ æ”¹æŸ¥ï¼Œåœ¨ä½¿ç”¨å‰ï¼Œä½ éœ€è¦å…ˆå®‰è£…ç›¸åº”çš„å·¥å…·åŒ…ï¼š

```
pip install sqlalchemy
åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
from sqlalchemy import create_engine
# åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ï¼Œä¿®æ”¹ä¸ºä½ çš„æ•°æ®åº“ç”¨æˆ·åå’Œå¯†ç 
engine = create_engine('mysql+mysqlconnector://root:password@localhost:3306/wucai')
```

create\_engineçš„ä½¿ç”¨æ–¹æ³•ç±»ä¼¼æˆ‘ä»¬åœ¨ä¸Šç¯‡æ–‡ç« ä¸­æåˆ°çš„mysql.connectorï¼Œéƒ½éœ€è¦æä¾›æ•°æ®åº“+æ•°æ®åº“è¿æ¥æ¡†æ¶ï¼Œå³å¯¹åº”çš„æ˜¯`mysql+mysqlconnector`ï¼Œåé¢çš„æ˜¯ç”¨æˆ·å:`å¯†ç @IPåœ°å€:ç«¯å£å·/æ•°æ®åº“åç§°`ã€‚

### åˆ›å»ºæ¨¡å‹

æˆ‘ä»¬å·²ç»åˆ›å»ºäº†playeræ•°æ®è¡¨ï¼Œè¿™é‡Œéœ€è¦åˆ›å»ºç›¸åº”çš„playeræ¨¡å‹ã€‚

```
# å®šä¹‰Playerå¯¹è±¡:
class Player(Base):
    # è¡¨çš„åå­—:
    __tablename__ = 'player'
 
    # è¡¨çš„ç»“æ„:
    player_id = Column(Integer, primary_key=True, autoincrement=True)
    team_id = Column(Integer)
    player_name = Column(String(255))
    height = Column(Float(3,2))
```

è¿™é‡Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œ`__tablename__` æŒ‡æ˜äº†æ¨¡å‹å¯¹åº”çš„æ•°æ®è¡¨åç§°ï¼Œå³playeræ•°æ®è¡¨ã€‚åŒæ—¶æˆ‘ä»¬åœ¨Playeræ¨¡å‹ä¸­å¯¹é‡‡ç”¨çš„å˜é‡åè¿›è¡Œå®šä¹‰ï¼Œå˜é‡åéœ€è¦å’Œæ•°æ®è¡¨ä¸­çš„å­—æ®µåç§°ä¿æŒä¸€è‡´ï¼Œå¦åˆ™ä¼šæ‰¾ä¸åˆ°æ•°æ®è¡¨ä¸­çš„å­—æ®µã€‚åœ¨SQLAlchemyä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨Columnå¯¹å­—æ®µè¿›è¡Œå®šä¹‰ï¼Œå¸¸ç”¨çš„æ•°æ®ç±»å‹å¦‚ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/d6/42/d6f02460647f34fba692e8a61b80a042.png?wh=970%2A394)  
é™¤äº†æŒ‡å®šColumnçš„æ•°æ®ç±»å‹ä»¥å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‡å®šColumnçš„å‚æ•°ï¼Œè¿™äº›å‚æ•°å¯ä»¥å¸®æˆ‘ä»¬å¯¹å¯¹è±¡åˆ›å»ºåˆ—çº¦æŸï¼š

![](https://static001.geekbang.org/resource/image/45/dd/458d77c980f2ac7b9e8e34dd75eac8dd.png?wh=975%2A208)  
è¿™é‡Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå¦‚æœä½ ä½¿ç”¨ç›¸åº”çš„æ•°æ®ç±»å‹ï¼Œé‚£ä¹ˆéœ€è¦æå‰åœ¨SQLAlchemyä¸­è¿›è¡Œå¼•ç”¨ï¼Œæ¯”å¦‚ï¼š

```
from sqlalchemy import Column, String, Integer, Float
```

### å¯¹æ•°æ®è¡¨è¿›è¡Œå¢åˆ æ”¹æŸ¥

å‡è®¾æˆ‘ä»¬æƒ³ç»™playerè¡¨å¢åŠ ä¸€åæ–°çƒå‘˜ï¼Œå§“åä¸ºâ€œçº¦ç¿°Â·ç§‘æ—æ–¯â€ï¼Œçƒé˜ŸIDä¸º1003ï¼ˆå³äºšç‰¹å…°å¤§è€é¹°ï¼‰ï¼Œèº«é«˜ä¸º2.08ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
# åˆ›å»ºDBSessionç±»å‹:
DBSession = sessionmaker(bind=engine)
# åˆ›å»ºsessionå¯¹è±¡:
session = DBSession()


# åˆ›å»ºPlayerå¯¹è±¡:
new_player = Player(team_id = 1003, player_name = "çº¦ç¿°-ç§‘æ—æ–¯", height = 2.08)
# æ·»åŠ åˆ°session:
session.add(new_player)
# æäº¤å³ä¿å­˜åˆ°æ•°æ®åº“:
session.commit()
# å…³é—­session:
session.close()
```

è¿™é‡Œï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦åˆå§‹åŒ–DBSessionï¼Œç›¸å½“äºåˆ›å»ºä¸€ä¸ªæ•°æ®åº“çš„ä¼šè¯å®ä¾‹sessionã€‚é€šè¿‡sessionæ¥å®Œæˆæ–°çƒå‘˜çš„æ·»åŠ ã€‚å¯¹äºæ–°çƒå‘˜çš„æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Playerç±»æ¥å®Œæˆåˆ›å»ºï¼Œåœ¨å‚æ•°ä¸­æŒ‡å®šç›¸åº”çš„`team_id, player_name, height`å³å¯ã€‚

ç„¶åæŠŠåˆ›å»ºå¥½çš„å¯¹è±¡new\_playeræ·»åŠ åˆ°sessionä¸­ï¼Œæäº¤åˆ°æ•°æ®åº“å³å¯å®Œæˆæ·»åŠ æ•°æ®çš„æ“ä½œã€‚

æ¥ç€ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•æŸ¥è¯¢æ•°æ®ã€‚

æ·»åŠ å®Œæ’å…¥çš„æ–°çƒå‘˜ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥è¯¢ä¸‹èº«é«˜ â‰¥ 2.08mçš„çƒå‘˜éƒ½æœ‰å“ªäº›ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
#å¢åŠ to_dict()æ–¹æ³•åˆ°Baseç±»ä¸­
def to_dict(self):
    return {c.name: getattr(self, c.name, None)
            for c in self.__table__.columns}
#å°†å¯¹è±¡å¯ä»¥è½¬åŒ–ä¸ºdictç±»å‹
Base.to_dict = to_dict
# æŸ¥è¯¢èº«é«˜>=2.08çš„çƒå‘˜æœ‰å“ªäº›
rows = session.query(Player).filter(Player.height >= 2.08).all()
print([row.to_dict() for row in rows])
```

è¿è¡Œç»“æœï¼š

```
[{'player_id': 10003, 'team_id': 1001, 'player_name': 'å®‰å¾·çƒˆ-å¾·æ‹‰è’™å¾·', 'height': Decimal('2.1100000000')}, {'player_id': 10004, 'team_id': 1001, 'player_name': 'ç´¢æ©-é©¬å…‹', 'height': Decimal('2.1600000000')}, {'player_id': 10009, 'team_id': 1001, 'player_name': 'æ‰æ‰-å¸•æ¥šé‡Œäºš', 'height': Decimal('2.1100000000')}, {'player_id': 10010, 'team_id': 1001, 'player_name': 'ä¹”æ©-æ´›ä¼Šå°”', 'height': Decimal('2.0800000000')}, {'player_id': 10011, 'team_id': 1001, 'player_name': 'å¸ƒé›·å…‹-æ ¼é‡ŒèŠ¬', 'height': Decimal('2.0800000000')}, {'player_id': 10015, 'team_id': 1001, 'player_name': 'äº¨åˆ©-åŸƒä¼¦æ£®', 'height': Decimal('2.1100000000')}, {'player_id': 10023, 'team_id': 1002, 'player_name': 'å¤šæ›¼å¡”æ–¯-è¨åšå°¼æ–¯', 'height': Decimal('2.1100000000')}, {'player_id': 10024, 'team_id': 1002, 'player_name': 'è¿ˆå°”æ–¯-ç‰¹çº³', 'height': Decimal('2.1100000000')}, {'player_id': 10032, 'team_id': 1002, 'player_name': 'TJ-åˆ©å¤«', 'height': Decimal('2.0800000000')}, {'player_id': 10033, 'team_id': 1002, 'player_name': 'å‡¯å°”-å¥¥å¥å› ', 'height': Decimal('2.0800000000')}, {'player_id': 10037, 'team_id': 1002, 'player_name': 'ä¼Šå‡¯Â·é˜¿å°¼åšå¤', 'height': Decimal('2.0800000000')}, {'player_id': 10038, 'team_id': 1003, 'player_name': 'çº¦ç¿°-ç§‘æ—æ–¯', 'height': Decimal('2.0800000000')}]
```

å¦‚æœæˆ‘ä»¬å¯¹æ•´ä¸ªæ•°æ®è¡Œè¿›è¡ŒæŸ¥è¯¢ï¼Œé‡‡ç”¨çš„æ˜¯`session.query(Player)`ï¼Œç›¸å½“äºä½¿ç”¨çš„æ˜¯SELECT \*ã€‚è¿™æ—¶å¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨Pythonä¸­å¯¹queryç»“æœè¿›è¡Œæ‰“å°ï¼Œå¯ä»¥å¯¹Baseç±»å¢åŠ `to_dict()`æ–¹æ³•ï¼Œç›¸å½“äºå°†å¯¹è±¡è½¬åŒ–æˆäº†Pythonçš„å­—å…¸ç±»å‹ã€‚

åœ¨è¿›è¡ŒæŸ¥è¯¢çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯filteræ–¹æ³•ï¼Œå¯¹åº”çš„æ˜¯SQLä¸­çš„WHEREæ¡ä»¶æŸ¥è¯¢ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œfilterä¹Ÿæ”¯æŒå¤šæ¡ä»¶æŸ¥è¯¢ã€‚

å¦‚æœæ˜¯ANDçš„å…³ç³»ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³è¦æŸ¥è¯¢èº«é«˜ â‰¥ 2.08ï¼ŒåŒæ—¶èº«é«˜ â‰¤ 2.10çš„çƒå‘˜ï¼Œå¯ä»¥å†™æˆä¸‹é¢è¿™æ ·ï¼š

```
rows = session.query(Player).filter(Player.height >=2.08, Player.height <=2.10).all()
```

å¦‚æœæ˜¯ORçš„å…³ç³»ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³è¦æŸ¥è¯¢èº«é«˜ â‰¥ 2.08ï¼Œæˆ–è€…èº«é«˜ â‰¤ 2.10çš„çƒå‘˜ï¼Œå¯ä»¥å†™æˆè¿™æ ·ï¼š

```
rows = session.query(Player).filter(or_(Player.height >=2.08, Player.height <=2.10)).all()
```

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†SQLAlchemyçš„or\_æ“ä½œç¬¦ï¼Œåœ¨ä½¿ç”¨å®ƒä¹‹å‰ä½ éœ€è¦è¿›è¡Œå¼•å…¥ï¼Œå³ï¼š`from sqlalchemy import or_`ã€‚

é™¤äº†å¤šæ¡ä»¶æŸ¥è¯¢ï¼ŒSQLAlchemyä¹ŸåŒæ ·æ”¯æŒåˆ†ç»„æ“ä½œã€æ’åºå’Œè¿”å›æŒ‡å®šæ•°é‡çš„ç»“æœã€‚

æ¯”å¦‚æˆ‘æƒ³è¦æŒ‰ç…§team\_idè¿›è¡Œåˆ†ç»„ï¼ŒåŒæ—¶ç­›é€‰åˆ†ç»„åæ•°æ®è¡Œæ•°å¤§äº5çš„åˆ†ç»„ï¼Œå¹¶ä¸”æŒ‰ç…§åˆ†ç»„åæ•°æ®è¡Œæ•°é€’å¢çš„é¡ºåºè¿›è¡Œæ’åºï¼Œæ˜¾ç¤ºteam\_idå­—æ®µï¼Œä»¥åŠæ¯ä¸ªåˆ†ç»„çš„æ•°æ®è¡Œæ•°ã€‚é‚£ä¹ˆä»£ç å¦‚ä¸‹ï¼š

```
from sqlalchemy import func
rows = session.query(Player.team_id, func.count(Player.player_id)).group_by(Player.team_id).having(func.count(Player.player_id)>5).order_by(func.count(Player.player_id).asc()).all()
print(rows)
```

è¿è¡Œç»“æœï¼š

```
[(1001, 20), (1002, 17)]
```

è¿™é‡Œæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š

1. æˆ‘ä»¬æŠŠéœ€è¦æ˜¾ç¤ºçš„å­—æ®µPlayer.team\_id, func.count(Player.player\_id)ä½œä¸ºqueryçš„å‚æ•°ï¼Œå…¶ä¸­æˆ‘ä»¬éœ€è¦ç”¨åˆ°sqlalchemyçš„funcç±»ï¼Œå®ƒæä¾›äº†å„ç§èšé›†å‡½æ•°ï¼Œæ¯”å¦‚func.countå‡½æ•°ã€‚
2. åœ¨query()åé¢ä½¿ç”¨äº†group\_by()è¿›è¡Œåˆ†ç»„ï¼Œå‚æ•°è®¾ç½®ä¸ºPlayer.team\_idå­—æ®µï¼Œå†ä½¿ç”¨havingå¯¹åˆ†ç»„æ¡ä»¶è¿›è¡Œç­›é€‰ï¼Œå‚æ•°ä¸º`func.count(Player.player_id)>5`ã€‚
3. ä½¿ç”¨order\_byè¿›è¡Œæ’åºï¼Œå‚æ•°ä¸º`func.count(Player.player_id).asc()`ï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§åˆ†ç»„åçš„æ•°æ®è¡Œæ•°é€’å¢çš„é¡ºåºè¿›è¡Œæ’åºï¼Œæœ€åä½¿ç”¨.all()æ–¹æ³•éœ€è¦è¿”å›å…¨éƒ¨çš„æ•°æ®ã€‚

ä½ èƒ½çœ‹åˆ°SQLAlchemyä½¿ç”¨çš„è§„åˆ™å’Œä½¿ç”¨SELECTè¯­å¥çš„è§„åˆ™å·®ä¸å¤šï¼Œåªæ˜¯å°è£…åˆ°äº†ç±»ä¸­ä½œä¸ºæ–¹æ³•è¿›è¡Œè°ƒç”¨ã€‚

æ¥ç€ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹å¦‚ä½•åˆ é™¤æ•°æ®ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦åˆ é™¤æŸäº›æ•°æ®ï¼Œéœ€è¦å…ˆè¿›è¡ŒæŸ¥è¯¢ï¼Œç„¶åå†ä»sessionä¸­æŠŠè¿™äº›æ•°æ®åˆ é™¤æ‰ã€‚

æ¯”å¦‚æˆ‘ä»¬æƒ³è¦åˆ é™¤å§“åä¸ºçº¦ç¿°Â·ç§‘æ—æ–¯çš„çƒå‘˜ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦è¿›è¡ŒæŸ¥è¯¢ï¼Œç„¶åä»sessionå¯¹è±¡ä¸­è¿›è¡Œåˆ é™¤ï¼Œæœ€åè¿›è¡Œcommitæäº¤ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
row = session.query(Player).filter(Player.player_name=='çº¦ç¿°-ç§‘æ—æ–¯').first()
session.delete(row)
session.commit()
session.close()
```

éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œåˆ¤æ–­çƒå‘˜å§“åæ˜¯å¦ä¸ºçº¦ç¿°Â·ç§‘æ—æ–¯ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨ï¼ˆ==ï¼‰ã€‚

åŒæ ·ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä¿®æ”¹æŸæ¡æ•°æ®ï¼Œä¹Ÿéœ€è¦è¿›è¡ŒæŸ¥è¯¢ï¼Œç„¶åå†è¿›è¡Œä¿®æ”¹ã€‚æ¯”å¦‚æˆ‘æƒ³æŠŠçƒå‘˜ç´¢æ©Â·é©¬å…‹çš„èº«é«˜æ”¹æˆ2.17ï¼Œé‚£ä¹ˆæ‰§è¡Œå®Œä¹‹åç›´æ¥å¯¹sessionå¯¹è±¡è¿›è¡Œcommitæ“ä½œï¼Œä»£ç å¦‚ä¸‹ï¼š

```
row = session.query(Player).filter(Player.player_name=='ç´¢æ©-é©¬å…‹').first()
row.height = 2.17
session.commit()
session.close()
```

## æ€»ç»“

ä»Šå¤©æˆ‘ä»¬ä½¿ç”¨SQLAlalchemyå¯¹MySQLè¿›è¡Œäº†æ“ä½œï¼Œä½ èƒ½çœ‹åˆ°è¿™äº›å®ç°å¹¶ä¸å¤æ‚ï¼Œåªæ˜¯éœ€è¦äº‹å…ˆæŒæ¡ä¸€äº›ä½¿ç”¨æ–¹æ³•ï¼Œå°¤å…¶æ˜¯å¦‚ä½•åˆ›å»ºseesionå¯¹è±¡ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡sessionå¯¹è±¡æ¥å®Œæˆå¯¹æ•°æ®çš„å¢åˆ æ”¹æŸ¥ç­‰æ“ä½œã€‚å»ºè®®ä½ æŠŠæ–‡ç« é‡Œçš„ä»£ç éƒ½è·‘ä¸€éï¼Œåœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ä¸€å®šä¼šæœ‰æ›´æ·±å…¥çš„ä½“ä¼šã€‚

å½“ç„¶é™¤äº†å­¦ä¹ æŒæ¡SQLAlalchemyè¿™ä¸ªPython ORMå·¥å…·ä»¥å¤–ï¼Œæˆ‘è¿˜å¸Œæœ›ä½ èƒ½äº†è§£åˆ°ORMçš„ä»·å€¼å’Œä¸è¶³ã€‚å¦‚æœé¡¹ç›®æœ¬èº«ä¸å¤§ï¼Œé‚£ä¹ˆè‡ªå·±åŠ¨æ‰‹å†™SQLè¯­å¥ä¼šæ¯”è¾ƒç®€å•ï¼Œä½ å¯ä»¥ä¸ä½¿ç”¨ORMå·¥å…·ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ä¸ŠèŠ‚è¯¾è®²åˆ°çš„mysql-connectorã€‚ä½†æ˜¯éšç€é¡¹ç›®ä»£ç é‡çš„å¢åŠ ï¼Œä¸ºäº†åœ¨ä¸šåŠ¡é€»è¾‘å±‚ä¸æ•°æ®åº“åº•å±‚è¿›è¡Œæ¾è€¦åˆï¼Œé‡‡ç”¨ORMæ¡†æ¶æ˜¯æ›´åŠ é€‚åˆçš„ã€‚

![](https://static001.geekbang.org/resource/image/6c/f3/6cffd2ac3be05210ace5cd753ee4aff3.jpg?wh=3341%2A2164)  
æˆ‘ä»Šå¤©è®²è§£äº†SQLAlalchemyå·¥å…·çš„ä½¿ç”¨ï¼Œä¸ºäº†æ›´å¥½åœ°è®©ä½ ç†è§£ï¼Œæˆ‘å‡ºä¸€é“ç»ƒä¹ é¢˜å§ã€‚è¿˜æ˜¯é’ˆå¯¹playeræ•°æ®è¡¨ï¼Œè¯·ä½ ä½¿ç”¨SQLAlalchemyå·¥å…·æŸ¥è¯¢èº«é«˜ä¸º2.08ç±³çš„çƒå‘˜ï¼Œå¹¶ä¸”å°†è¿™äº›çƒå‘˜çš„èº«é«˜ä¿®æ”¹ä¸º2.09ã€‚

æ¬¢è¿ä½ åœ¨è¯„è®ºåŒºå†™ä¸‹ä½ çš„ç­”æ¡ˆï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–è€…åŒäº‹ï¼Œä¸€èµ·äº¤æµã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>å¢¨ç¦¾</span> ğŸ‘ï¼ˆ34ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä»¥ä¸‹ä»ORMçš„ä½œç”¨ï¼Œæ˜¯ä»€ä¹ˆï¼Œä¼˜ç¼ºç‚¹ä»¥åŠä¸€äº›æ¯”è¾ƒæµè¡Œçš„ORMçš„å¯¹æ¯”çš„ä¸ªäººæ€»ç»“ï¼š

1.ORMçš„ä½œç”¨
å¯¹è±¡å…³ç³»æ˜ å°„ï¼Œèƒ½å¤Ÿç›´æ¥å°†æ•°æ®åº“å¯¹è±¡è¿›è¡ŒæŒä¹…åŒ–ã€‚

åœ¨æ²¡æœ‰ORMå‰ï¼Œæˆ‘ä»¬è¦è‡ªå·±å†™æ•°æ®åº“è¿æ¥æ–¹æ³•ï¼Œè‡ªå·±åœ¨æ–¹æ³•é‡Œé¢åµŒå…¥åŸç”Ÿçš„sqlè¯­å¥å»è®¿é—®æ•°æ®è¡¨â€¦â€¦

è¿™æ—¶é—®é¢˜å°±æ¥äº†ï¼š
æ•°æ®åº“åï¼Œæ•°æ®è¡¨åå®Œå…¨æš´éœ²åœ¨ä»£ç ä¸­ï¼Œæœ‰è„±åº“çš„é£é™©ï¼›
éœ€è¦æˆ‘ä»¬è‡ªå·±å¤„ç†æ•°æ®è¡¨å¯¹è±¡ï¼Œæ¯”å¦‚è¯´æŠŠæ•°æ®è¡¨ä¸­å–å‡ºçš„æ•°æ®è½¬åŒ–ä¸ºæ ‡å‡†jsonç­‰ï¼Œsqlè¯­å¥å®‰å…¨è¿‡æ»¤ï¼Œæ•°æ®è¡¨ã€å­—æ®µåˆ«åã€å…¼å®¹å¤šç§æ•°æ®åº“ç­‰ä¸€ç³»åˆ—çš„æ•°æ®å¤„ç†å·¥ä½œï¼›

ä¸‹é¢ä»‹ç»ä¸€ä¸‹ORMåˆ°åº•æ˜¯å•¥ï¼Ÿ

2ã€ORMæ˜¯ä»€ä¹ˆï¼Ÿ
ORMä½œä¸ºæ•°æ®åº“å±‚ä¸ä¸šåŠ¡é€»è¾‘å±‚ä¹‹é—´çš„ä¸€ä¸ªæŠ½è±¡ï¼Œèƒ½å¤Ÿå°†ä¸šåŠ¡é€»è¾‘çš„å¤„ç†æŒä¹…åŒ–ä¸ºå†…å­˜å¯¹è±¡ï¼Œäº¤ç”±æ•°æ®åº“å»å¤„ç†ã€‚å…¶å°è£…äº†æ•°æ®åº“çš„è¿æ¥ï¼Œæ•°æ®è¡¨çš„æ“ä½œç»†èŠ‚â€¦â€¦åœ¨æ–‡ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ORMå°†sqlè¯­å¥åšäº†å°è£…ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡filterå®ç°è¿‡æ»¤ï¼Œè€Œä¸æ˜¯å†™whereå­å¥ã€‚

ORMçœŸçš„é‚£ä¹ˆå¥½ï¼Ÿ

3ã€ä¼˜ç¼ºç‚¹
ä¼˜ç‚¹ï¼š
å®‰å…¨ï¼šå› ä¸ºå±è”½äº†æ•°æ®åº“çš„å…·ä½“æ“ä½œç»†èŠ‚ä»¥åŠå¯¹sqlåšäº†ä¸¥æ ¼çš„è¿‡æ»¤ï¼Œå› æ­¤èƒ½å¤Ÿä¿è¯æ•°æ®åº“ä¿¡æ¯çš„éšè”½æ€§ï¼ŒåŒæ—¶é˜²æ­¢sqlæ³¨å…¥ã€‚
ç®€å•ï¼šå±è”½äº†æ•°æ®å±‚çš„è®¿é—®ç»†èŠ‚ï¼Œæˆ‘ä»¬åªéœ€è¦é›†ä¸­æ³¨æ„åŠ›å¤„ç†ä¸šåŠ¡é€»è¾‘å°±å¯ä»¥äº†ã€‚

ç¼ºç‚¹ï¼š
æ€§èƒ½ä½ï¼šè‡ªåŠ¨åŒ–æ„å‘³ç€åŠ è½½å¾ˆå¤šå³ä½¿æ²¡æœ‰å¿…è¦çš„å…³è”å’Œæ˜ å°„ï¼Œç‰ºç‰²æ€§èƒ½ã€‚ä½†ORMä¹Ÿé‡‡å–äº†ä¸€äº›è¡¥æ•‘æªæ–½ï¼šå¯¹è±¡æ‡’åŠ è½½ï¼Œç¼“å­˜æŠ€æœ¯ç­‰ã€‚

å­¦ä¹ æˆæœ¬é«˜ï¼šé¢å‘å¯¹è±¡çš„å°è£…è®¾è®¡ï¼Œæ˜¯çš„æˆ‘ä»¬å¿…é¡»è¦å»äº†è§£å¯¹è±¡çš„å¤„ç†ç»†èŠ‚ã€‚

éš¾ä»¥å®ç°å¤æ‚æŸ¥è¯¢ï¼šORMå®ç°çš„æ˜¯ä¸€äº›é€šç”¨çš„æ•°æ®å¤„ç†æ–¹æ³•ï¼Œä¸€äº›è´Ÿè´£çš„ä¸šåŠ¡å¤„ç†è¿˜æ˜¯éœ€è¦è‡ªå·±ç»„è£…sqlã€‚

é‚£ä¹ˆè¿˜æœ‰å“ªäº›æ¯”è¾ƒæµè¡Œçš„ORMå‘¢ï¼Ÿ
hibernate:å¼ºè°ƒå¯¹å•æ¡æ•°æ®çš„å¤„ç†
mybits:åŸºäºè‡ªå®šä¹‰é…ç½®çš„sqlæ“ä½œ</p>2019-07-23</li><br/><li><span>JustDoDT</span> ğŸ‘ï¼ˆ21ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>ç¼ºå°‘ä¸€äº›ä»£ç ï¼Œå¯ä»¥å‚è€ƒå»–é›ªå³°çš„è¿™ä¸ªã€‚
https:&#47;&#47;www.liaoxuefeng.com&#47;wiki&#47;1016959663602400&#47;1017803857459008</p>2019-07-22</li><br/><li><span>ä¸€å¶çŸ¥ç§‹</span> ğŸ‘ï¼ˆ12ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ—¥å¸¸äº¤ä½œä¸š~~~

# -*- coding:utf-8 -*-
from sqlalchemy import and_
from sqlalchemy import Column, INT, FLOAT, VARCHAR
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()


class Test_db:
    def __init__(self):
        &quot;&quot;&quot;æ­¤å¤„å¡«ä¸Šè‡ªå·±çš„è¿æ¥é…ç½®&quot;&quot;&quot;
        self.engine = create_engine(
            &#39;mysql+pymysql:&#47;&#47;UserName:Password@host:port&#47;Db_Name?charset=utf8&#39;)
        db_session = sessionmaker(bind=self.engine)
        self.session = db_session()

    def update(self, target_class, query_filter, target_obj):
        &quot;&quot;&quot;
        æ›´æ–°æ“ä½œé€šç”¨æ–¹æ³•
        :param target_class: è¡¨å¯¹è±¡
        :param query_filter: æŸ¥è¯¢æ¡ä»¶
        :param target_obj: æ›´æ–°ç›®æ ‡å¯¹è±¡
        :return:
        &quot;&quot;&quot;
        try:
            self.session.query(target_class).filter(query_filter).update(target_obj)
            self.session.commit()
            self.session.close()
            return True
        except Exception as e:
            print(e)


class Player(Base):
    &quot;&quot;&quot;å®šä¹‰è¡¨ç»“æ„&quot;&quot;&quot;
    __tablename__ = &#39;player&#39;
    player_id = Column(INT(), primary_key=True)
    team_id = Column(INT())
    player_name = Column(VARCHAR(255))
    height = Column(FLOAT())

    def __init__(self, player_id, team_id, player_name, height):
        self.player_id = player_id
        self.team_id = team_id
        self.player_name = player_name
        self.height = height


if __name__ == &#39;__main__&#39;:
    db_obj = Test_db()
    query_filter = and_(Player.height == 2.08)
    target_obj = {&#39;height&#39;: 2.09}
    update_result = db_obj.update(Player, query_filter, target_obj)

åç»­æ›´æ–°æ•°é‡ã€æ›´æ–°ç»“æœç­‰ç­‰åˆ¤æ–­å°±ç•¥è¿‡äº†...
ï¼ˆå°å£°bbï¼šä»€ä¹ˆæ—¶å€™æå®¢æ—¶é—´è¯„è®ºä¹Ÿèƒ½æ”¯æŒmarkdownå•Šã€‚ã€‚ï¼‰</p>2019-07-22</li><br/><li><span>ABC</span> ğŸ‘ï¼ˆ9ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç¿»äº†ä¸€ä¸‹SQLAlchemyçš„å®˜æ–¹æ–‡æ¡£,çœ‹åˆ°ä¸€ä¸ªç®€å•çš„åŠæ³•,ä½œä¸šå¦‚ä¸‹:

&#39;&#39;&#39;

ä½œä¸š:

ä½¿ç”¨SQLAlchemyå·¥å…·æŸ¥è¯¢èº«é«˜ä¸º2.08ç±³çš„çƒå‘˜,å¹¶ä¸”å°†è¿™äº›çƒå‘˜çš„èº«é«˜ä¿®æ”¹ä¸º2.09;


å‚è€ƒ:
		
		https:&#47;&#47;docs.sqlalchemy.org&#47;en&#47;13&#47;core&#47;dml.html


&#39;&#39;&#39;

from sqlalchemy import Column, String, Integer, Float,create_engine,update
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
Base = declarative_base()
engine = create_engine(&#39;mysql+mysqlconnector:&#47;&#47;root:123456@localhost:3306&#47;geektime-sql&#39;)


class Player(Base):
    __tablename__ = &#39;player&#39;
 
    player_id = Column(Integer, primary_key=True, autoincrement=True)
    team_id = Column(Integer)
    player_name = Column(String(255))
    height = Column(Float(3,2))

def to_dict(self):
    return {c.name: getattr(self, c.name, None)
            for c in self.__table__.columns}

if __name__ == &#39;__main__&#39;:
	DBSession = sessionmaker(bind=engine)
	session = DBSession()
	Base.to_dict = to_dict
	print(&quot;æ›´æ–°å‰:&quot;)
	rows = session.query(Player).filter(Player.height == 2.08).all()
	print([row.to_dict() for row in rows])
	# å‚è€ƒ: https:&#47;&#47;docs.sqlalchemy.org&#47;en&#47;13&#47;core&#47;dml.html#sqlalchemy.sql.expression.update
	stmt = update(Player).where(Player.height == 2.08).values(height=2.09)
	engine.execute(stmt)
	session.commit()
	rows = session.query(Player).filter(Player.height == 2.09).all()
	print(&quot;æ›´æ–°å:&quot;)
	print([row.to_dict() for row in rows])
	session.close()
å¤ªé•¿,çœç•¥äº†éƒ¨åˆ†æ‰§è¡Œç»“æœ.è‡ªå·±æ‰§è¡Œä¸€ä¸‹,å°±å¯ä»¥çœ‹åˆ°å®Œæ•´ç»“æœäº†..

æ›´æ–°å‰:
[{&#39;player_id&#39;: 10010, &#39;team_id&#39;: 1001, &#39;player_name&#39;: &#39;ä¹”æ©-æ´›ä¼Šå°”&#39;, &#39;height&#39;: Decimal(&#39;2.0800000000&#39;)}......
æ›´æ–°å:
[{&#39;player_id&#39;: 10010, &#39;team_id&#39;: 1001, &#39;player_name&#39;: &#39;ä¹”æ©-æ´›ä¼Šå°”&#39;, &#39;height&#39;: Decimal(&#39;2.0900000000&#39;)}......
[Finished in 0.9s]</p>2019-07-22</li><br/><li><span>å¤œè·¯ç ´æ™“</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ¡†æ¶å¯¹å®ä½“çš„æ˜ å°„ä¸éš¾ç†è§£,æ•°æ®åº“æœ¬èº«å°±æ˜¯å¯¹ç°å®ä¸–ç•Œçš„æ˜ å°„,å€Ÿç”±æ˜ å°„å°†äº‹å®è½¬æ¢ä¸ºæ•°æ®.
ä»£ç éƒ¨åˆ†æœ‰äº›åŸºç¡€çš„ä¹Ÿä¸éš¾ç†è§£;åŸºç¡€è¾ƒå¼±ç¡¬é’¢çš„äº²ä»¬,è€å¿ƒä¸€æ¡æ¡æ¥ç¼•ä¹Ÿå¯ä»¥æ‹é¡º,éƒ½æ˜¯åŸºç¡€çš„ä¸œè¥¿,æ— éèŠ±è´¹æ—¶é—´é•¿çŸ­é—®é¢˜.æœ‰å‡ ä¸ªå‘è¿™é‡Œè®°å½•ä¸‹,ä¾›åæ¥äººå€Ÿé‰´:
1.å…³äºåˆå§‹åŒ–è¿æ¥æ•°æ®åº“é—®é¢˜.creat_engineçš„å‚æ•°è¿™å—å®¹æ˜“å¡å£³,å¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡å­—è¯´æ˜:
create_engine(&quot;æ•°æ®åº“ç±»å‹+æ•°æ®åº“é©±åŠ¨:&#47;&#47;æ•°æ®åº“ç”¨æˆ·å:æ•°æ®åº“å¯†ç @IPåœ°å€:ç«¯å£&#47;æ•°æ®åº“&quot;ï¼Œå…¶ä»–å‚æ•°)
2.æ•°æ®åº“é©±åŠ¨è¿™å—,è€å¸ˆçš„å‚è€ƒä»£ç æ˜¯ç”¨mysqlconnector,æ²¿æ‰¿å¾—æ˜¯ä¸Šç¯‡ä¸­å¯¼å…¥mysql-connectoråŒ…;ç½‘ä¸Šä¸€äº›èµ„æ–™ä»¥åŠå‚è€ƒå…¶ä»–åŒå­¦çš„ç­”æ¡ˆæœ‰ä½¿ç”¨pymysql,è¦ç”¨è¿™ä¸ªéœ€å®‰è£…pip install pymysql.è¿™ä¸¤è´§å¯¹äºæœ¬ç¯‡çš„å­¦ä¹ å†…å®¹åœ¨æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„,ä»»é€‰ä¸€ä¸ªå³å¯.
3.åœ¨ä»£ç å¤å†™è¿‡ç¨‹ä¸­,åˆ é™¤æ“ä½œä¸€ç›´æŠ¥é”™.ç½‘ä¸ŠæŸ¥äº†èµ„æ–™è¯´æ˜¯è·Ÿè¿”å›å€¼æœ‰å…³.ç»è¿‡æµ‹è¯•,å‘ç°é—®é¢˜æ‰€åœ¨,filterè¿”å›ç»“æœä¸ºNone.ä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰æŸ¥è¯¢åˆ°&quot;çº¦ç¿°-ç§‘æ—æ–¯&quot;.å¾€å›å€’è…¾,å‘ç°å¼€å§‹æ–°å¢æ•°æ®é‚£é‡Œ,å¢åŠ çš„&quot; çº¦ç¿°-ç§‘æ—æ–¯ &quot;,å‰åå¯¹æ¯”åè€…ä¸¤ä¾§å¤šäº†ä¸ªç©ºæ ¼.ç»Ÿä¸€å‰å,åˆ é™¤æ“ä½œé¡ºåˆ©å®Œæˆ.</p>2019-07-22</li><br/><li><span>JustDoDT</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é”™è¯¯è§£å†³ï¼š
å¦‚æœæŠ¥å¦‚ä¸‹é”™è¯¯ï¼šAuthentication plugin &#39;caching_sha2_password&#39; is not supported
sqlalchemy.exc.NotSupportedError: (mysql.connector.errors.NotSupportedError) Authentication plugin &#39;caching_sha2_password&#39; is not supported (Background on this error at: http:&#47;&#47;sqlalche.me&#47;e&#47;tw8g)
å¯ä»¥å‚è€ƒä¸‹é¢çš„é“¾æ¥å¤„ç†ï¼š
https:&#47;&#47;stackoverflow.com&#47;questions&#47;51783313&#47;how-do-i-get-sqlalchemy-create-engine-with-mysqlconnector-to-connect-using-mysql</p>2019-07-22</li><br/><li><span>jxs1211</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œæˆ‘çš„è¡¨ä¸­æœ‰ä¸ªæ—¶é—´å­—æ®µï¼Œæˆ‘æƒ³åœ¨æ’å…¥æ•°æ®æ—¶ï¼Œè‡ªåŠ¨ç”Ÿæˆæ—¶é—´åº”æ€ä¹ˆè®¾ç½®è¯¥å­—æ®µï¼Œæ˜¯è¿™æ ·å—ï¼š
`create_time` timestamp(0) NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;åˆ›å»ºæ—¶é—´&#39;,</p>2019-07-25</li><br/><li><span>taoist</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>from sqlalchemy import create_engine, Column, Integer, String, Float
from sqlalchemy.orm import sessionmaker
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

engine = create_engine(&quot;mysql+pymysql:&#47;&#47;root:toor@localhost:3306&#47;test&quot;)

Session = sessionmaker(bind=engine)


def to_dict(self):
    return {c.name: getattr(self, c.name, None) for c in self.__table__.columns}


Base.to_dict = to_dict


class Player(Base):
    __tablename__ = &quot;player&quot;

    player_id = Column(Integer, primary_key=True, autoincrement=True)
    team_id = Column(Integer)
    player_name = Column(String(255))
    height = Column(Float(3, 2))


session = Session()

rows = session.query(Player).filter(Player.height == 2.08).all()
for row in rows:
    print(row.to_dict())
    row.height = 2.09
session.commit()


# éªŒè¯
rows = session.query(Player).filter(Player.height == 2.09).all()
print([row.to_dict() for row in rows])

session.close()


</p>2019-12-23</li><br/><li><span>é˜¿é”‹</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä¸Šé¢é‚£ä¸ªåˆ†ç»„æŸ¥è¯¢ï¼ŒæŒ‰ç…§åˆ†ç»„åæ•°æ®è¡Œæ•°é€’å¢çš„é¡ºåºè¿›è¡Œæ’åºï¼Œæ€ä¹ˆç»“æœæ˜¯[(1001, 20), (1002, 17)]ï¼Œé‚£ä¸æ˜¯é€’å‡ï¼Ÿæ˜¯ä¸æ˜¯å†™é”™äº†ï¼Ÿ</p>2019-07-22</li><br/><li><span>Geek_5d805b</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>to_dictæ–¹æ³•è¿™å—çœ‹ä¸å¤ªæ‡‚ï¼Œbaseç±»æŒ‡çš„æ˜¯playerç±»å—ï¼Œè°ç»™è®²è®²</p>2019-07-25</li><br/><li><span>NIXUS</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ORMçš„ä½¿ç”¨ï¼Œæ›´å¤šçš„ä¸éƒ½æ˜¯é€šè¿‡æŸ¥æ–‡æ¡£çš„å—ï¼Ÿ</p>2019-07-24</li><br/><li><span>LJK</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆå¥½ï¼Œå¯¹äºä¿®æ”¹æ•°æ®çš„äº‹ä¾‹æœ‰ä¸€ç‚¹å›°æƒ‘è¿˜è¯·æ‚¨è§£ç­”ã€‚å¯¹äºä¸‹é¢è¿™æ®µä»£ç ä¸­

row = session.query(Player).filter(Player.player_name==&#39;ç´¢æ© - é©¬å…‹&#39;).first()
row.height = 2.17
session.commit()
session.close()

æˆ‘ç†è§£rowæ˜¯å­˜åœ¨äºå†…å­˜ä¸­çš„å¯¹è±¡ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ä¿®æ”¹åå¹¶æ²¡æœ‰ä¼ é€’åˆ°æ•°æ®åº“ä¸­ï¼Œå¦‚æœç›´æ¥commitå¯ä»¥è¿›è¡Œä¿®æ”¹çš„è¯ï¼Œè¿™ä¸ªrowæ˜¯åœ¨å“ªé‡Œå­˜æ”¾çš„å¯¹è±¡å‘¢ï¼Ÿ</p>2019-07-22</li><br/><li><span>æˆ‘åœ¨ä½ çš„è§†çº¿é‡Œ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>sessionå¯¹è±¡æ˜¯djangoè‡ªå¸¦çš„ã€‚è¿˜æ˜¯åœ¨é¡¹ç›®é‡Œåˆ›å»ºçš„ã€‚</p>2019-08-11</li><br/><li><span>å’•å’•å’•</span> ğŸ‘ï¼ˆ7ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ä»£ç èƒ½ä¸èƒ½ç»™å®Œæ•´å•Šï¼Ÿè¿˜è¯´å…¨éƒ¨è·‘ä¸€éï¼Ÿä¸ç»™å…¨ç»™ä¸ªæç¤ºæˆ–è€…æ–‡æ¡£é“¾æ¥ä¹Ÿè¡Œå§ï¼Ÿè¿˜æ˜¯å¾—çœ‹è¯„è®ºçš„åŒå­¦è¡¥å……æ‰çŸ¥é“ä»£ç æ²¡æœ‰ç»™å…¨ã€‚</p>2020-01-02</li><br/><li><span>Venom</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è€å¸ˆï¼Œå»ºè®®æœ€åèƒ½æŠŠå®Œæ•´ä»£ç ç»™å‡ºæ¥ã€‚å¯¹äºæˆ‘ä»¬æ²¡ç”¨è¿‡çš„äººæ¥è®²ï¼Œç¼ºå°‘ä¸€æ¡importè¯­å¥ä¹Ÿå¾ˆè‹¦æ¼å•Š</p>2019-09-03</li><br/>
</ul>