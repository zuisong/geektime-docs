ä½ å¥½ï¼Œæˆ‘æ˜¯è°¢å‹é¹ã€‚

ä¸Šä¸€èŠ‚è¯¾æˆ‘ä»¬åˆ†æäº†ç½‘ç»œæ¨ªå‘æ‰©å±•æ¶æ„ï¼Œå¹¶ä¸”å·²ç»çŸ¥é“å¯ä»¥é€šè¿‡DNSè¿›è¡Œæ¨ªå‘æ‰©å±•ã€ä¹Ÿå¯ä»¥é€šè¿‡LBæ‰©å±•ä¸‹æ¸¸æœåŠ¡ï¼Œä»Šå¤©è¿™èŠ‚è¯¾æˆ‘ä»¬é‡ç‚¹å…³æ³¨LBè‡ªèº«æ€æ ·æ¨ªå‘æ‰©å±•ã€‚

æˆ‘ä»¬å°†ä»¥ LVS ä½œä¸ºè´Ÿè½½å‡è¡¡å™¨æ¥è¿›è¡ŒåŸç†åˆ†æå’Œå®éªŒã€‚

## LB æ¨ªå‘æ‰©å±•åŸç†

æˆ‘ä»¬å¯ä»¥ä»è´Ÿè½½å‡è¡¡å™¨ï¼ˆLBï¼‰å¦‚ä½•æ¨ªå‘æ‰©å±•ä¸Šæ¸¸æœåŠ¡çš„åŸç†å…¥æ‰‹ï¼Œæ¥æ¢å¯»å…¶è‡ªèº«çš„æ‰©å±•æ–¹å¼ã€‚è´Ÿè½½å‡è¡¡å™¨èƒ½å¤Ÿå†³å®šè¯·æ±‚åº”å‘é€åˆ°å“ªä¸ªä¸‹æ¸¸æœºå™¨ï¼Œå› æ­¤å¯ä»¥æœ‰æ•ˆåˆ†æ‹…ä¸Šæ¸¸æµé‡ã€‚æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œæ¨ªå‘æ‰©å±•LBå®é™…ä¸Šæ˜¯éœ€è¦ä»å…¶ä¸‹æ¸¸çœ‹è¯·æ±‚çš„æµå‘ã€‚

å½“è¯·æ±‚åˆ°è¾¾æœºæˆ¿æ—¶ï¼ŒLBé€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªä»£ç†è®¾å¤‡ã€‚è¯·æ±‚ä¼šå…ˆç”±è·¯ç”±å™¨è½¬å‘ç»™LBã€‚ä¹‹å‰[ç¬¬ä¸‰èŠ‚è¯¾](https://time.geekbang.org/column/article/852092)æˆ‘ä»¬è¯´è¿‡ï¼Œåœ¨ä¸»å¤‡æœºæˆ¿æ¶æ„ä¸­ï¼Œè·¯ç”±å™¨ä¼šæ ¹æ®æœ€é•¿æ©ç åŒ¹é…çš„åŸåˆ™é€‰æ‹©è·¯ç”±ã€‚é‚£å¦‚æœå­˜åœ¨å¤šä¸ªç­‰é•¿æ©ç çš„è·¯ç”±ï¼Œè·¯ç”±å™¨ä¼šæ€æ ·é€‰æ‹©å‘¢ï¼Ÿ

### ECMP

è¿™æ—¶ï¼Œè·¯ç”±å™¨å°±ä¼šåœ¨è¿™äº›è·¯ç”±ä¹‹é—´è¿›è¡Œè´Ÿè½½åˆ†æ‹…ã€‚è¿™ä¸€ç‰¹æ€§ä¸ºè´Ÿè½½å‡è¡¡å™¨çš„æ¨ªå‘æ‰©å±•æä¾›äº†å¯èƒ½ã€‚é€šè¿‡ **ECMPï¼ˆç­‰ä»·å¤šè·¯å¾„è·¯ç”±ï¼‰**ï¼Œå¯ä»¥åœ¨å¤šä¸ªè·¯ç”±ä¹‹é—´åˆ†æ‹…æµé‡ ï¼Œä»è€Œå®ç°è´Ÿè½½å‡è¡¡å™¨çš„æ¨ªå‘æ‰©å±•ï¼Œæå‡ç³»ç»Ÿçš„ååé‡å’Œå®¹é”™èƒ½åŠ›ã€‚

![](https://static001.geekbang.org/resource/image/50/e4/5060a14094f344ac0f372cd37158b3e4.jpg?wh=3900x1714)

ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“æ€æ ·è®©è¯·æ±‚åŒ…è´Ÿè½½åˆ†æ‹…åœ°åˆ°è¾¾LBä¸Šäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä½¿ç”¨LVSä½œä¸ºLBï¼Œåˆ†æå…¶å·¥ä½œåŸç†ã€‚

### Netfilteræ¡†æ¶

LVSæ˜¯é›†æˆåˆ°Linuxå†…æ ¸çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒä¾èµ–äº [Netfilteræ¡†æ¶](https://docs.kernel.org/networking/nf_flowtable.html)ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆç†Ÿæ‚‰ä¸€ä¸‹è¿™ä¸ªæ¡†æ¶ã€‚

![](https://static001.geekbang.org/resource/image/2d/dd/2d215d6988a4c4d8c164b83fa81b18dd.jpg?wh=6088x3077)

å¦‚å›¾æ‰€ç¤ºï¼ŒLinux å†…æ ¸å¤„ç†è¿›å‡ºç½‘ç»œåè®®æ ˆçš„æ•°æ®åŒ…åˆ†ä¸º5ä¸ªä¸åŒçš„é˜¶æ®µï¼ŒNetfilterÂ é€šè¿‡è¿™5ä¸ªé˜¶æ®µæ³¨å…¥é’©å­å‡½æ•°æ¥å®ç°å¯¹æ•°æ®åŒ…çš„è¿‡æ»¤å’Œä¿®æ”¹ã€‚

è¿™5ä¸ªé˜¶æ®µåˆ†åˆ«æ˜¯ï¼š

- preroutingï¼šè·¯ç”±å‰é˜¶æ®µï¼Œå‘ç”Ÿåœ¨å†…æ ¸å¯¹æ•°æ®åŒ…è¿›è¡Œè·¯ç”±åˆ¤å†³å‰ã€‚
- inputï¼šæœ¬åœ°ä¸Šé€é˜¶æ®µï¼Œå‘ç”Ÿåœ¨å†…æ ¸é€šè¿‡è·¯ç”±åˆ¤å†³åã€‚å¦‚æœæ•°æ®åŒ…æ˜¯å‘é€ç»™æœ¬æœºçš„ï¼Œé‚£ä¹ˆå°±æŠŠæ•°æ®åŒ…ä¸Šé€åˆ°ä¸Šå±‚åè®®æ ˆã€‚
- forwardï¼šè½¬å‘é˜¶æ®µï¼Œå‘ç”Ÿåœ¨å†…æ ¸é€šè¿‡è·¯ç”±åˆ¤å†³åã€‚å¦‚æœæ•°æ®åŒ…ä¸æ˜¯å‘é€ç»™æœ¬æœºçš„ï¼Œé‚£ä¹ˆå°±æŠŠæ•°æ®åŒ…è½¬å‘å‡ºå»ã€‚
- outputï¼šæœ¬åœ°å‘é€é˜¶æ®µï¼Œå‘ç”Ÿåœ¨å¯¹å‘é€æ•°æ®åŒ…è¿›è¡Œè·¯ç”±åˆ¤å†³ä¹‹å‰ã€‚
- postingï¼šè·¯ç”±åé˜¶æ®µï¼Œå‘ç”Ÿåœ¨å¯¹å‘é€æ•°æ®åŒ…è¿›è¡Œè·¯ç”±åˆ¤å†³ä¹‹åã€‚

ä»ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªæ•°æ®åŒ…åˆ°è¾¾æœ¬æœºåæœ‰ä¸¤ä¸ªä¸»è¦è·¯å¾„ï¼Œä¸€ä¸ªæ˜¯è¦ä¸Šé€åˆ°ç”¨æˆ·æ€çš„è·¯å¾„ä¸ºprerouting-&gt;intput-&gt;ç”¨æˆ·æ€å¤„ç†-&gt;output-&gt;postroutingï¼Œå¦ä¸€ä¸ªæ˜¯prerouting-&gt;forwarding-&gt;postrouting ã€‚è¿™ä¸¤æ¡è·¯å¾„æ˜¯ä¾æ®è·¯ç”±åˆ¤åˆ«çš„ï¼Œæ‰€ä»¥**è¦æƒ³åœ¨åº”ç”¨ç¨‹åºæ”¶åˆ°ç½‘ç»œåŒ…ï¼Œæœ¬æœºä¸€å®šè¦æœ‰è¿™ä¸ªåŒ…çš„ç›®çš„ IP**ï¼Œè¿™ä¸ªæ˜¯ä»Šå¤©å®éªŒç¯å¢ƒä¸€ä¸ªé‡è¦ä¾æ®ã€‚

### LVS å·¥ä½œæ¨¡å¼

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹LVSæ˜¯æ€æ ·é€šè¿‡Netfilteræ¡†æ¶å®ç°è½¬å‘çš„ï¼Œå…¶å¯¹åº”çš„å†…æ ¸å®ç°IPVSåœ¨Netfilterçš„inputã€forwardå’Œpostingé˜¶æ®µéƒ½è¿›è¡Œhookæ¥å®ç°è‡ªå·±çš„é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯è¯´LVSå¯ä»¥å¯¹å‘ç»™å…¶æœ¬æœºå’Œç»è¿‡å…¶è½¬å‘çš„æŠ¥æ–‡è¿›è¡Œä¿®æ”¹ï¼Œæ¥è¾¾åˆ°è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ã€‚

LVSæœ‰4ç§å·¥ä½œæ¨¡å¼ï¼Œæˆ‘ä»¬é€ä¸€åˆ†æçœ‹çœ‹ ã€‚

ç¬¬ä¸€ç§æ˜¯ **DR æ¨¡å¼**ï¼ˆDirect Routeï¼‰ã€‚

![](https://static001.geekbang.org/resource/image/4e/88/4ecc1782db0f10668fba5a9823458588.jpg?wh=4213x1965)

å®¢æˆ·ç«¯å‘é€çš„æŠ¥æ–‡ç›®æ ‡ IP æ˜¯ VIPï¼ŒæŠ¥æ–‡é¦–å…ˆä¼šåˆ°è¾¾ LVSã€‚æ¥ç€ï¼ŒLVS ä¼šå°†æŠ¥æ–‡ä¸­çš„ç›®æ ‡ MAC åœ°å€æ›¿æ¢ä¸ºä¸€ä¸ªåç«¯æœåŠ¡å™¨çš„ MAC åœ°å€ï¼Œå¹¶å°†æŠ¥æ–‡è½¬å‘å‡ºå»ã€‚ç”±äºæŠ¥æ–‡çš„ç›®æ ‡ MAC åœ°å€æ˜¯æœåŠ¡å™¨çš„åœ°å€ï¼ŒæŠ¥æ–‡æœ€ç»ˆä¼šåˆ°è¾¾ç›®æ ‡æœåŠ¡å™¨ã€‚

ç”±äº LVS å¹¶æ²¡æœ‰ä¿®æ”¹æŠ¥æ–‡çš„ IP åœ°å€ï¼ŒæœåŠ¡å™¨æ”¶åˆ°çš„æŠ¥æ–‡å››å…ƒç»„ä¸ºï¼šå®¢æˆ·ç«¯ IP åœ°å€ã€å®¢æˆ·ç«¯ç«¯å£ã€VIP åœ°å€å’Œç›®æ ‡ç«¯å£ã€‚æœåŠ¡å™¨ä¼šæ ¹æ®è¿™ä¸ªå››å…ƒç»„è¿›è¡Œå“åº”ï¼Œå¹¶å°†å“åº”å‘é€åˆ°å®¢æˆ·ç«¯çš„ IP åœ°å€ã€‚æ­¤æ—¶ï¼Œå“åº”æŠ¥æ–‡ä¼šç›´æ¥è¿”å›å®¢æˆ·ç«¯ï¼Œè€Œæ— éœ€ç»è¿‡ LVSï¼Œå› ä¸ºå“åº”æ˜¯ç›´æ¥ä»æœåŠ¡å™¨å‘å‡ºçš„ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶æœåŠ¡å™¨æ¥æ”¶åˆ°çš„æŠ¥æ–‡ç›®çš„åœ°å€æ˜¯ VIPï¼Œä½†æ ¹æ® Netfilter çš„å¤„ç†æµç¨‹ï¼ŒæœåŠ¡å™¨å¿…é¡»è·¯ç”±åˆ° INPUT é“¾ï¼Œæ‰èƒ½è¿›å…¥æœ¬æœºå¤„ç†æµç¨‹ã€‚å› æ­¤ï¼Œ**æœåŠ¡å™¨çš„ç½‘ç»œæ¥å£ä¸Šä¹Ÿéœ€è¦é…ç½® VIPï¼Œä½†ä¸èƒ½é€šè¿‡ ARP å¹¿æ’­å°† VIP å…¬å¼€ï¼Œä»¥é¿å…è¯·æ±‚ç›´æ¥åˆ°è¾¾æœåŠ¡å™¨è€Œç»•è¿‡ LVS**ã€‚

è¿™ç§è½¬å‘æ–¹å¼çš„ä¼˜åŠ¿æ˜¯ï¼Œ**åªä¿®æ”¹MACåœ°å€ï¼Œä¸æ¶‰åŠIPå±‚çš„æ”¹åŠ¨ï¼Œä¸”å“åº”ä¸ç»è¿‡ LVSï¼Œç›´æ¥è¿”å›å®¢æˆ·ç«¯ï¼Œè¿™æ ·å°±æé«˜äº†æ•ˆç‡ã€‚**ä½†æ˜¯å› ä¸ºLVSå¿…é¡»çŸ¥é“Serverçš„MACåœ°å€ï¼Œæ‰€ä»¥å®ƒä»¬å¿…é¡»éƒ¨ç½²åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ **DNAT æ¨¡å¼**ã€‚

![](https://static001.geekbang.org/resource/image/de/d4/ded4cc573984e5bb9dd27531788095d4.jpg?wh=4134x1808)

åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒLVS ä¼šå°†æ”¶åˆ°çš„æŠ¥æ–‡ç›®æ ‡ IP ä¿®æ”¹ä¸ºæœåŠ¡å™¨çš„ IP åœ°å€ã€‚å½“æœåŠ¡å™¨æ”¶åˆ°æŠ¥æ–‡åï¼Œä¼šæ ¹æ®æº IP è¿›è¡Œåº”ç­”ã€‚ä»å››å±‚åè®®çš„è§’åº¦æ¥çœ‹ï¼Œè¿™ä¸ªåº”ç­”æŠ¥æ–‡æ˜¯ç›´æ¥å‘é€åˆ°å®¢æˆ·ç«¯çš„ã€‚ç„¶è€Œï¼Œç”±äºå®¢æˆ·ç«¯å‘é€æŠ¥æ–‡æ—¶ç›®æ ‡ IP æ˜¯ VIPï¼Œå¦‚æœåº”ç­”æŠ¥æ–‡çš„æº IP æ˜¯æœåŠ¡å™¨çš„ IPï¼Œåˆ™ TCP å››å…ƒç»„å°†ä¸åŒ¹é…ï¼Œå¯¼è‡´å®¢æˆ·ç«¯æ— æ³•æ­£ç¡®è¯†åˆ«åº”ç­”æŠ¥æ–‡ï¼Œæœ€ç»ˆä¸¢å¼ƒè¿™ä¸ªåŒ…ã€‚

ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œåº”ç­”æŠ¥æ–‡å¿…é¡»å†æ¬¡ç»è¿‡ LVS è¿›è¡Œå¤„ç†ã€‚å…·ä½“æ¥è¯´ï¼Œå°½ç®¡ä»å››å±‚çš„è§’åº¦åº”ç­”æŠ¥æ–‡ä¸ç»è¿‡ LVSï¼Œä½†ä»ä¸‰å±‚çš„è§’åº¦ï¼Œåº”ç­”æŠ¥æ–‡å¿…é¡»ç»è¿‡ LVSã€‚

é‚£åº”è¯¥å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ

ä¸€ä¸ªæœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆæ˜¯é€šè¿‡è·¯ç”±é…ç½®ï¼Œ**å°† LVS è®¾ç½®ä¸ºæœåŠ¡å™¨å‘é€åˆ°å®¢æˆ·ç«¯çš„é»˜è®¤ç½‘å…³**ã€‚è¿™æ ·ï¼Œç»è¿‡ LVS çš„æŠ¥æ–‡ä¼šè§¦å‘ LVS å†…æ ¸ä¸­çš„ Netfilter forward é’©å­è¿›è¡Œå¤„ç†ï¼ŒLVS ä¼šåœ¨æ­¤è¿‡ç¨‹ä¸­å°†æŠ¥æ–‡çš„æº IP åœ°å€æ›¿æ¢å› VIPã€‚è¿™æ ·å°±ç¡®ä¿äº†æŠ¥æ–‡èƒ½å¤Ÿæ­£ç¡®åœ°ä¼ é€’å›å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”ä¿æŒå››å…ƒç»„çš„ä¸€è‡´æ€§ã€‚

çœ‹æ‡‚äº†DNATæ¨¡å¼ï¼Œæˆ‘ä»¬å†çœ‹ **FULLNATæ¨¡å¼**å°±ç®€å•å¤šäº†ã€‚

![](https://static001.geekbang.org/resource/image/cc/fc/cc1dc338c5yy4ca30831d3f9371572fc.jpg?wh=4213x1965)

å¯ä»¥çœ‹åˆ°FULLNATä¸DNATçš„åŒºåˆ«åœ¨äºï¼ŒLVSä¸ä»…æŠŠè¯·æ±‚çš„ç›®çš„ipæ¢æˆServerï¼ŒåŒæ—¶è¿˜æŠŠæºIPæ¢æˆè‡ªå·±çš„IPäº†ã€‚è¿™æ ·Serverçš„åº”ç­”æŠ¥æ–‡å°±é¡ºç†æˆç« åœ°åˆ°è¾¾LVSï¼ŒLVSå†åšä¸€æ¬¡è½¬åŒ–å°†ç›®çš„IPæ¢æˆå®¢æˆ·ç«¯IPï¼ŒæºIPæ¢æˆvipå°±å¯ä»¥äº†ã€‚

æœ€åï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ **Tunnel æ¨¡å¼**ã€‚

![](https://static001.geekbang.org/resource/image/9c/02/9c00d1b5b932be8d8f8f75afab15eb02.jpg?wh=4213x1965)

Tunnelï¼ˆéš§é“ï¼‰æ¨¡å¼æ˜¯æŒ‡LVSå°†å‘å¾€Serverçš„æŠ¥æ–‡å¤–é¢åˆå°è£…äº†ä¸€å±‚æŠ¥æ–‡ï¼ŒåŸæ¥çš„æŠ¥æ–‡å˜æˆäº†æ–°æŠ¥æ–‡çš„æ•°æ®éƒ¨åˆ†ï¼Œè¿™å°±è¦æ±‚Serverä¸Šå¿…é¡»æœ‰å¯¹åº”tunnelçš„è§£å°è£…è½¯ä»¶å°†tunnelå¤´å‰¥ç¦»ï¼Œç„¶åå‰©ä¸‹çš„åŒ…å°±å’ŒDRæ¨¡å¼ä¸€æ ·äº†ï¼Œåº”ç­”ä¹Ÿå’ŒDRæ¨¡å¼ä¸€æ ·ã€‚è¿™æ ·åŠ ä¸€å±‚tunnelçš„å¥½å¤„æ˜¯LVSæœºå™¨å’ŒServeræœºå™¨ä¸å¿…éè¦éƒ¨ç½²åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘é‡Œé¢äº†ã€‚

## LBæ¨ªå‘æ‰©å±•å®æˆ˜

ææ¸…æ¥šç†è®ºåï¼Œæˆ‘ä»¬å¼€å§‹ä»Šå¤©çš„å®æˆ˜ç¯èŠ‚ã€‚

### å®éªŒè®¾è®¡

![](https://static001.geekbang.org/resource/image/yy/11/yy2197f27a4bfb4be91819e368a01911.jpg?wh=3946x825)

æœ¬æ¬¡å®éªŒçš„ç›®çš„æ˜¯å®ç°LBçš„æ¨ªå‘æ‰©å±•ï¼Œæœ€ç»ˆæœŸæœ›çœ‹åˆ°çš„ç»“æœæ˜¯é€šè¿‡vipè®¿é—®LBé›†ç¾¤çš„æ—¶å€™ï¼Œä¸€éƒ¨åˆ†æµé‡ç»è¿‡LB1ã€ä¸€éƒ¨åˆ†æµé‡ç»è¿‡LB2ã€‚ä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿåˆ°è¿™ä¸ªç»“æœï¼Œæˆ‘ä»¬è®©LB1æ”¶åˆ°è¯·æ±‚ååªè½¬å‘ç»™server1ï¼ŒLB2æ”¶åˆ°è¯·æ±‚ååªè½¬å‘ç»™server2ï¼Œç„¶åserver1å’Œserver2æ”¶åˆ°è¯·æ±‚åè¿”å›headerä¸­X-Hostå¸¦æœ‰ä¸åŒçš„å€¼ã€‚

è·¯ç”±éƒ¨åˆ†ï¼Œrouterã€LB1å’ŒLB2ä¹‹é—´é€šè¿‡OSPFåŠ¨æ€è·¯ç”±åè®®ç›¸äº’å‘å¸ƒè·¯ç”±ï¼ŒOSPFåŠŸèƒ½é€šè¿‡Linuxçš„å¼€æºè½¯ä»¶ [frr](https://github.com/FRRouting/frr) æ¥å®ç°ã€‚è™šæ‹ŸLBéƒ¨åˆ†ï¼ŒLB1ã€LB2ä¹‹é—´è¿˜æ˜¯é€šè¿‡keepalivedæ¥ç»„æˆä¸€ä¸ªè™šæ‹Ÿçš„LBï¼Œæœ‰äº†ECMPæ¥æ¨ªå‘æ‰©å±•ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦å†ä½¿ç”¨VRRPåŠŸèƒ½äº†ï¼Œè€Œæ˜¯ä½¿ç”¨virtual serverç»„ç½‘ã€‚æœ¬æ¬¡å®éªŒæˆ‘ä»¬ä½¿ç”¨LVSçš„DRæ¨¡å¼è½¬å‘ã€‚server1ã€server2è¿˜æ˜¯ä½¿ç”¨Nginxæ¥å®ç°http serverï¼Œå½“ç„¶ï¼Œè¿™éƒ¨åˆ†ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–ä»»æ„æ–¹å¼å®ç°ã€‚

æ ¹æ®LVSçš„è½¬å‘åŸç†ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“LVSçš„DRæ¨¡å¼ä¸ä¼šä¿®æ”¹IPåœ°å€ï¼Œåªæ˜¯ä¿®æ”¹äº†MACï¼Œæ‰€ä»¥serverä¸Šæ”¶åˆ°è¯·æ±‚çš„ç›®çš„IPå°±æ˜¯vipã€‚ä¸ºäº†èƒ½è®©Serverå¤„ç†è¯¥æŠ¥æ–‡ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Serverçš„æ¥å£ä¸Šé…ç½®vipï¼Œä½†æ˜¯ä¸ºäº†é˜²æ­¢æŠ¥æ–‡ä¸ç»è¿‡LBç›´æ¥åˆ°è¾¾Serverï¼Œéœ€è¦å…³é—­å…¶ARPå¹¿æ’­åŠŸèƒ½ã€‚

å®éªŒå¼€å§‹å‰ï¼Œæˆ‘ä»¬å…ˆç†Ÿæ‚‰ä¸€ä¸‹è¦ç”¨åˆ°æ–°è½¯ä»¶frrï¼Œå®ƒæ˜¯ä¸€ä¸ªå®ç°äº†å„ç§è·¯ç”±åŠŸèƒ½çš„å¼€æºé¡¹ç›®ï¼Œå¯ä»¥è¿è¡Œåœ¨Linuxä¸Šã€‚ä½¿ç”¨çš„æ—¶å€™å…ˆç¼–è¾‘/etc/frr/daemonsæ–‡ä»¶å¼€å¯å¯¹åº”daemonè¿›ç¨‹ï¼Œç„¶åsystemctlÂ daemon-reloadè®©ä¿®æ”¹ç”Ÿæ•ˆï¼Œä¹‹åå°±å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ã€å‘½ä»¤è¡Œæˆ–ä¸€äº›æ¥å£æ¥é…ç½®è·¯ç”±äº†ï¼Œæ›´è¯¦ç»†çš„è¯´æ˜ä½ å¯ä»¥å‚è€ƒå…¶[å®˜æ–¹æ–‡æ¡£](https://docs.frrouting.org/en/latest/about.html)ã€‚

### å¼€å§‹å®éªŒ

**æˆ‘ä»¬å…ˆå…³é—­æ‰€æœ‰æœºå™¨ä¸Šé˜²ç«å¢™ç­–ç•¥ï¼Œå¹¶å¼€å¯è½¬å‘åŠŸèƒ½ï¼Œè¿™ä¸ªæ˜¯å®éªŒæˆåŠŸçš„å‰æ**ã€‚

å…³é—­é˜²ç«å¢™æ“ä½œå¦‚ä¸‹ï¼š

```plain
systemctl stop firewalld
systemctl disable firewalld
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡sudo systemctl status firewalld æ¥éªŒè¯é˜²ç«å¢™æ˜¯å¦å…³é—­äº†ã€‚

ä¹‹åæ˜¯å¼€å¯forwardè½¬å‘åŠŸèƒ½çš„æ“ä½œã€‚é¦–å…ˆï¼Œç¼–è¾‘ `/etc/sysctl.conf` æ–‡ä»¶ã€‚å¦‚æœæœ‰ä»¥ä¸‹é…ç½®ï¼Œå°†å€¼ä¿®æ”¹ä¸º1ï¼Œæ²¡æœ‰çš„è¯ï¼Œæ·»åŠ å³å¯ã€‚

```plain
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1
```

é€€å‡ºç¼–è¾‘åï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ã€‚

```plain
#è®©/etc/sysctl.confæ–‡ä»¶ä¿®æ”¹ç”Ÿæ•ˆ
$ sudo sysctl -p

#éªŒè¯è½¬å‘åŠŸèƒ½æ˜¯å¦å¼€å¯
$ sudo sysctl net.ipv4.ip_forward
net.ipv4.ip_forward = 1

#æˆ‘ä»¬å®éªŒç”¨ä¸åˆ°ipv6å¯ä»¥ä¸ç”¨ç®¡v6çš„æƒ…å†µ
```

ä¸‹é¢å¼€å§‹å®éªŒé…ç½®ï¼Œé¦–å…ˆè¦**é…ç½®Serverã€‚**

å’Œä¸Šä¸€èŠ‚éå¸¸ç›¸ä¼¼ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç”¨Nginxæä¾›httpæœåŠ¡ï¼Œåªæ˜¯å¢åŠ äº†ä¸€è¡Œæ·»åŠ X-Hostå¤´çš„é…ç½®ï¼Œserver1å’Œserver2çš„nginxé…ç½®ï¼Œä½ å¯ä»¥å‚è€ƒ [server1/nginx.conf](https://github.com/xyp-root/geektime-hands-on-network-architecture/blob/main/05/lb_scale_out_architecture/server1/nginx.conf) å’Œ [server2/nginx.conf](https://github.com/xyp-root/geektime-hands-on-network-architecture/blob/main/05/lb_scale_out_architecture/server2/nginx.conf)ã€‚ä¿®æ”¹å®Œé…ç½®ï¼Œæˆ‘ä»¬reload nginxè®©é…ç½®ç”Ÿæ•ˆã€‚

```plain
#ä¿®æ”¹/etc/nginx/nginx.conf

#reload nginxè®©é…ç½®ç”Ÿæ•ˆ
$ sudo nginx -s reload
2024/11/10 11:55:14 [notice] 4257#4257: signal process started

#æœ¬æœºè¿›è¡ŒåŠŸèƒ½éªŒè¯ï¼ŒX-Hostç¬¦åˆé¢„æœŸã€‚
$ curl http://127.0.0.1:8080 -v
*Â  Â Trying 127.0.0.1:8080...
* Connected to 127.0.0.1 (127.0.0.1) port 8080
> GET / HTTP/1.1
> Host: 127.0.0.1:8080
> User-Agent: curl/8.5.0
> Accept: */*
>
< HTTP/1.1 200 OK
< Server: nginx/1.24.0 (Ubuntu)
< Date: Sun, 10 Nov 2024 11:55:34 GMT
< Content-Type: text/plain
< Content-Length: 0
< Connection: keep-alive
< X-Remote-IP: 127.0.0.1
< X-Host: server1
<
* Connection #0 to host 127.0.0.1 left intact
```

ç„¶ååœ¨**serverçš„ç¯å›å£é…ç½®é…ç½®vipï¼Œå¹¶å…³é—­ARPåŠŸèƒ½**ã€‚

```plain
#è¿›å…¥rootç”¨æˆ·
$ sudo bash -c bash

#å¿½ç•¥loå£ipçš„arpè¯·æ±‚ï¼Œåªå“åº”ç›®çš„IPåœ°å€ä¸ºæ¥æ”¶ç½‘å¡ä¸Šçš„æœ¬åœ°åœ°å€çš„arpè¯·æ±‚ã€‚
$ sudoÂ  sysctl -w net.ipv4.conf.lo.arp_ignore=1
#å‘é€ARPé€šå‘Šæ—¶ï¼Œä¸ä½¿ç”¨loå£ä¸Šçš„ipåœ°å€
# sudo sysctl -w net.ipv4.conf.lo.arp_announce=2

#lo:0çš„è™šæ‹Ÿæ¥å£ï¼Œå¹¶ä¸ºå…¶åˆ†é…äº†IPåœ°å€
# /sbin/ifconfig lo:0 172.16.253.100 broadcast 172.16.253.100 netmask 255.255.255.255 up
# ä¸º172.16.253.100è®¾ç½®äº†é™æ€è·¯ç”±ï¼ŒæŒ‡æ˜æ‰€æœ‰è®¿é—®è¯¥IPçš„æµé‡åº”è¯¥é€šè¿‡è™šæ‹Ÿæ¥å£lo:0
#Â /sbin/route add -host 172.16.253.100 dev lo:0

#æŸ¥çœ‹é…ç½®ç»“æœ
$ ifconfig
ens33: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>Â  mtu 1500
Â  Â  Â  Â  inet 172.16.253.134Â  netmask 255.255.255.0Â  broadcast 172.16.253.255
Â  Â  Â  Â  inet6 fe80::20c:29ff:fead:6136Â  prefixlen 64Â  scopeid 0x20<link>
Â  Â  Â  Â  ether 00:0c:29:ad:61:36Â  txqueuelen 1000Â  (Ethernet)
Â  Â  Â  Â  RX packets 6606Â  bytes 2790029 (2.7 MB)
Â  Â  Â  Â  RX errors 0Â  dropped 0Â  overruns 0Â  frame 0
Â  Â  Â  Â  TX packets 4253Â  bytes 581633 (581.6 KB)
Â  Â  Â  Â  TX errors 0Â  dropped 0 overruns 0Â  carrier 0Â  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>Â  mtu 65536
Â  Â  Â  Â  inet 127.0.0.1Â  netmask 255.0.0.0
Â  Â  Â  Â  inet6 ::1Â  prefixlen 128Â  scopeid 0x10<host>
Â  Â  Â  Â  loopÂ  txqueuelen 1000Â  (Local Loopback)
Â  Â  Â  Â  RX packets 712Â  bytes 55712 (55.7 KB)
Â  Â  Â  Â  RX errors 0Â  dropped 0Â  overruns 0Â  frame 0
Â  Â  Â  Â  TX packets 712Â  bytes 55712 (55.7 KB)
Â  Â  Â  Â  TX errors 0Â  dropped 0 overruns 0Â  carrier 0Â  collisions 0

lo:0: flags=73<UP,LOOPBACK,RUNNING>Â  mtu 65536
Â  Â  Â  Â  inet 172.16.253.100Â  netmask 255.255.255.255
Â  Â  Â  Â  loopÂ  txqueuelen 1000Â  (Local Loopback)
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­**é…ç½®LB1ã€LB2ä¸Šçš„Keepalivedï¼Œå®ç°virtual LBåŠŸèƒ½ã€‚**

åˆ†åˆ«ä¿®æ”¹LB1ã€LB2çš„ Keepalivedé…ç½®/etc/keepalived/keepalived.confï¼Œå†…å®¹å‚è€ƒ [lb1/keepalived.conf](https://github.com/xyp-root/geektime-hands-on-network-architecture/blob/main/05/lb_scale_out_architecture/lb1/keepalived.conf) å’Œ [lb2/keepalived.conf](https://github.com/xyp-root/geektime-hands-on-network-architecture/blob/main/05/lb_scale_out_architecture/lb2/keepalived.conf)ï¼Œç„¶åé‡æ–°å¯åŠ¨Keepalivedä½¿é…ç½®ç”Ÿæ•ˆã€‚

```plain
#é‡æ–°å¯åŠ¨keepalived
$ sudo systemctl restart keepalived

#æ£€æŸ¥keepalivedçš„çŠ¶æ€
$ sudo systemctl status keepalived
  keepalived.service - Keepalive Daemon (LVS and VRRP)
Â  Â  Â Loaded: loaded (/usr/lib/systemd/system/keepalived.service; enabled; preset: enabled)
Â  Â  Â Active: active (running) since Sun 2024-11-10 15:49:22 UTC; 6s ago
Â  Â  Â  Â Docs: man:keepalived(8)
Â  Â  Â  Â  Â  Â  Â man:keepalived.conf(5)
Â  Â  Â  Â  Â  Â  Â man:genhash(1)
Â  Â  Â  Â  Â  Â  Â https://keepalived.org
Â  Â Main PID: 5388 (keepalived)
Â  Â  Â  Tasks: 2 (limit: 4556)
Â  Â  Â Memory: 1.8M (peak: 2.1M)
Â  Â  Â  Â  CPU: 10ms
Â  Â  Â CGroup: /system.slice/keepalived.service
Â  Â  Â  Â  Â  Â  Â â”œâ”€5388 /usr/sbin/keepalived --dont-fork
Â  Â  Â  Â  Â  Â  Â â””â”€5391 /usr/sbin/keepalived --dont-fork

Nov 10 15:49:22 server1 Keepalived[5388]: Command line: '/usr/sbin/keepalived' '--dont-fork'
Nov 10 15:49:22 server1 Keepalived[5388]: Configuration file /etc/keepalived/keepalived.conf
Nov 10 15:49:22 server1 Keepalived[5388]: NOTICE: setting config option max_auto_priority should result in better keepalived performance
Nov 10 15:49:22 server1 Keepalived[5388]: Starting Healthcheck child process, pid=5391
Nov 10 15:49:22 server1 Keepalived_healthcheckers[5391]: Initializing ipvs
Nov 10 15:49:22 server1 Keepalived_healthcheckers[5391]: Gained quorum 1+0=1 <= 10 for VS [172.16.253.100]:tcp:8080
Nov 10 15:49:22 server1 Keepalived_healthcheckers[5391]: Activating healthchecker for service [172.16.253.130]:tcp:8080 for VS [172.16.253.100]:tcp:8080
Nov 10 15:49:22 server1 systemd[1]: Started keepalived.service - Keepalive Daemon (LVS and VRRP).
Nov 10 15:49:22 server1 Keepalived_healthcheckers[5391]: Activating BFD healthchecker
Nov 10 15:49:22 server1 Keepalived[5388]: Startup complete
```

ç„¶å**åˆ†åˆ«åœ¨LB1ã€LB2çš„å›ç¯å£é…ç½®vip**ã€‚

```plain
$ sudo ifconfig lo:0 172.16.253.100 netmask 255.255.255.255 up
$ ifconfig
ens33: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>Â  mtu 1500
Â  Â  Â  Â  inet 172.16.253.129Â  netmask 255.255.255.0Â  broadcast 172.16.253.255
Â  Â  Â  Â  inet6 fe80::20c:29ff:fedf:3cccÂ  prefixlen 64Â  scopeid 0x20<link>
Â  Â  Â  Â  ether 00:0c:29:df:3c:ccÂ  txqueuelen 1000Â  (Ethernet)
Â  Â  Â  Â  RX packets 19693Â  bytes 15226238 (15.2 MB)
Â  Â  Â  Â  RX errors 0Â  dropped 0Â  overruns 0Â  frame 0
Â  Â  Â  Â  TX packets 5594Â  bytes 638002 (638.0 KB)
Â  Â  Â  Â  TX errors 0Â  dropped 0 overruns 0Â  carrier 0Â  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>Â  mtu 65536
Â  Â  Â  Â  inet 127.0.0.1Â  netmask 255.0.0.0
Â  Â  Â  Â  inet6 ::1Â  prefixlen 128Â  scopeid 0x10<host>
Â  Â  Â  Â  loopÂ  txqueuelen 1000Â  (Local Loopback)
Â  Â  Â  Â  RX packets 318Â  bytes 27547 (27.5 KB)
Â  Â  Â  Â  RX errors 0Â  dropped 0Â  overruns 0Â  frame 0
Â  Â  Â  Â  TX packets 318Â  bytes 27547 (27.5 KB)
Â  Â  Â  Â  TX errors 0Â  dropped 0 overruns 0Â  carrier 0Â  collisions 0

lo:0: flags=73<UP,LOOPBACK,RUNNING>Â  mtu 65536
Â  Â  Â  Â  inet 172.16.253.100Â  netmask 255.255.255.255
Â  Â  Â  Â  loopÂ  txqueuelen 1000Â  (Local Loopback)
```

**æœ€åï¼Œé…ç½®LB1ã€LB2å’Œrouterçš„frrï¼Œè®©routeré€šè¿‡ospfåŠ¨æ€è·¯ç”±åè®®å­¦åˆ°LB1ã€LB2çš„ECMPè·¯ç”±**ã€‚

ç¬¬ä¸€æ­¥éœ€è¦æˆ‘ä»¬å®‰è£…å¹¶æŸ¥çœ‹frrç‰ˆæœ¬ã€‚

```plain
#å®‰è£…frr
$ sudo apt install frr frr-pythontools frr-doc

#æŸ¥çœ‹frrç‰ˆæœ¬
$ sudo vtysh -c "show version"
FRRouting 8.4.4 (server5) on Linux(6.8.0-48-generic).
Copyright 1996-2005 Kunihiro Ishiguro, et al.
configured with:
Â  Â  '--build=x86_64-linux-gnu' '--prefix=/usr' '--includedir=${prefix}/include' '--mandir=${prefix}/share/man' '--infodir=${prefix}/share/info' '--sysconfdir=/etc' '--localstatedir=/var' '--disable-option-checking' '--disable-silent-rules' '--libdir=${prefix}/lib/x86_64-linux-gnu' '--libexecdir=${prefix}/lib/x86_64-linux-gnu' '--disable-maintainer-mode' '--localstatedir=/var/run/frr' '--sbindir=/usr/lib/frr' '--sysconfdir=/etc/frr' '--with-vtysh-pager=/usr/bin/pager' '--libdir=/usr/lib/x86_64-linux-gnu/frr' '--with-moduledir=/usr/lib/x86_64-linux-gnu/frr/modules' '--disable-dependency-tracking' '--enable-rpki' '--disable-scripting' '--disable-pim6d' '--with-libpam' '--enable-doc' '--enable-doc-html' '--enable-snmp' '--enable-fpm' '--disable-protobuf' '--disable-zeromq' '--enable-ospfapi' '--enable-bgp-vnc' '--enable-multipath=256' '--enable-user=frr' '--enable-group=frr' '--enable-vty-group=frrvty' '--enable-configfile-mask=0640' '--enable-logfile-mask=0640' 'build_alias=x86_64-linux-gnu' 'PYTHON=python3'
```

ç„¶åç¼–è¾‘frrçš„daemonsé…ç½®æ–‡ä»¶ï¼Œå¼€å¯ospfçš„daemonï¼Œä¿®æ”¹ç»“æœå‚è€ƒ[daemons](https://github.com/xyp-root/geektime-hands-on-network-architecture/blob/main/05/lb_scale_out_architecture/daemons)ï¼Œç„¶åreload daemonsä½¿é…ç½®ç”Ÿæ•ˆã€‚

```plain
#å¼€å¯å¯¹åº”è·¯ç”±çš„daemonï¼Œéœ€è¦ç¼–è¾‘/etc/frr/daemonsï¼Œå¹¶åœ¨å¯¹åº”åŠŸèƒ½åé€‰æ‹©yesæˆ–on
$ sudo vi /etc/frr/daemons
#æ–‡ä»¶ä¸­ä¿®æ”¹æ­¤å€¼ospfd=yes

#reload daemonè®©é…ç½®ç”Ÿæ•ˆ
$ sudo systemctl daemon-reload
```

ç„¶åä¿®æ”¹frrçš„é…ç½®æ–‡ä»¶ï¼Œrouterã€LB1ã€LB2çš„é…ç½®æ–‡ä»¶åˆ†åˆ«å‚è€ƒ [router/frr.conf](https://github.com/xyp-root/geektime-hands-on-network-architecture/blob/main/05/lb_scale_out_architecture/router/frr.conf)ã€[lb1/frr.conf](https://github.com/xyp-root/geektime-hands-on-network-architecture/blob/main/05/lb_scale_out_architecture/lb1/frr.conf) å’Œ [lb2/frr.conf](https://github.com/xyp-root/geektime-hands-on-network-architecture/blob/main/05/lb_scale_out_architecture/lb2/frr.conf)ï¼Œç„¶åå¯åŠ¨frråŠŸèƒ½ã€‚

```plain
#å¯åŠ¨frr
$ sudo systemctl enable frr
$ sudo systemctl start frr
# å¦‚æœå·²ç»å¯åŠ¨è¿‡frrï¼Œè¿™é‡Œæ‰§è¡Œsudo systemctl restart frr
# å¯ä»¥é€šè¿‡$ sudo systemctl status frr æŸ¥çœ‹frrçš„è¿è¡ŒçŠ¶æ€
# å¯ä»¥é€šè¿‡$ sudo vtysh -c "show running-config"æŸ¥çœ‹frræ­£åœ¨è¿è¡Œçš„é…ç½®
#å¯ä»¥æŸ¥çœ‹åˆ°ospfè¿›ç¨‹
$ ps -ef | grep ospf
rootÂ  Â  Â  Â  4870Â  Â  Â  Â 1Â  0 16:07 ?Â  Â  Â  Â  00:00:00 /usr/lib/frr/watchfrr -d -F traditional zebra ospfd staticd
frrÂ  Â  Â  Â  Â 4888Â  Â  Â  Â 1Â  0 16:07 ?Â  Â  Â  Â  00:00:02 /usr/lib/frr/ospfd -d -F traditional -A 127.0.0.1
```

ä»¥ä¸Šæ“ä½œå…¨éƒ¨å®Œæˆåï¼Œrouterä¸ŠæŸ¥è¯¢vipåº”è¯¥æ˜¯åˆ°LB1ã€LB2çš„ç­‰ä»·è·¯ç”±ã€‚

```plain
#routerä¸Šçœ‹åˆ°LB1ã€LB2ä¸¤ä¸ªospfé‚»å±…ã€‚
$ sudo vtysh -c "show ip ospf neighbor"

Neighbor IDÂ  Â  Â Pri StateÂ  Â  Â  Â  Â  Â Up TimeÂ  Â  Â  Â  Â Dead Time AddressÂ  Â  Â  Â  Â InterfaceÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  RXmtL RqstL DBsmL
172.16.253.129Â  Â  0 Full/DROtherÂ  Â  22m01sÂ  Â  Â  Â  Â  Â  Â 3.146s 172.16.253.129Â  ens33:172.16.253.135Â  Â  Â  Â  Â  Â  Â  Â  Â 0Â  Â  Â 0Â  Â  Â 0
172.16.253.131Â  Â  0 Full/DROtherÂ  Â  21m56sÂ  Â  Â  Â  Â  Â  Â 3.306s 172.16.253.131Â  ens33:172.16.253.135Â  Â  Â  Â  Â  Â  Â  Â  Â 0Â  Â  Â 0Â  Â  Â 0

#routerä¸Šé€šè¿‡ospfå­¦åˆ°äº†å»vipï¼š172.16.253.100/32æœ‰ä¸¤æ¡ç­‰ä»·çš„è·¯ç”±ã€‚
$ sudo vtysh -c "show ip route ospf"
Codes: K - kernel route, C - connected, S - static, R - RIP,
Â  Â  Â  Â O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
Â  Â  Â  Â T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
Â  Â  Â  Â f - OpenFabric,
Â  Â  Â  Â > - selected route, * - FIB route, q - queued, r - rejected, b - backup
Â  Â  Â  Â t - trapped, o - offload failure

OÂ  Â 172.16.253.0/24 [110/1] is directly connected, ens33, weight 1, 00:22:12
O>* 172.16.253.100/32 [110/1] via 172.16.253.129, ens33, weight 1, 00:21:58
Â  *Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â via 172.16.253.131, ens33, weight 1, 00:21:58
```

å¦‚æœä½ çš„æ“ä½œæ²¡æœ‰æˆåŠŸï¼Œå¯ä»¥è¶æœºå…ˆå­¦ä¹ OSPFçš„å·¥ä½œåŸç†ï¼Œç„¶åç»“åˆæ”¶é›†åˆ°çš„ä¿¡æ¯è¿›è¡Œåˆ†æï¼Œä»¥ä¸‹å‘½ä»¤æˆ–è®¸å¯ä»¥å¸®åŠ©åˆ°ä½ æ”¶é›†ä¸€äº›ä¿¡æ¯ã€‚

```plain
#æŸ¥çœ‹ OSPF é‚»å±…çŠ¶æ€
sudo vtysh -c "show ip ospf neighbor"
#æŸ¥çœ‹ OSPF è·¯ç”±ä¿¡æ¯
sudo vtysh -c "show ip route ospf"
#æŸ¥çœ‹ OSPF æ•°æ®åº“
sudo vtysh -c "show ip ospf database"
#æŸ¥çœ‹ OSPF æ¥å£çŠ¶æ€
sudo vtysh -c "show ip ospf interface"
#æŸ¥çœ‹ OSPF ç»Ÿè®¡ä¿¡æ¯
sudo vtysh -c "show ip ospf statistics"
#æŠ“åŒ…è§‚å¯Ÿï¼Œospfåè®®å·æ˜¯89
sudo tcpdump -i any -n ip proto 89 -vv
```

ä¸Šé¢çš„é…ç½®å®Œæˆåï¼Œæˆ‘ä»¬å°±å¯ä»¥éªŒè¯LBçš„æ¨ªå‘æ‰©å±•åŠŸèƒ½äº†ã€‚

```plain
#åœ¨routerä¸Šé€šè¿‡curlè®¿é—®è™šæ‹ŸLBçš„åœ°å€ï¼Œç„¶åé€šè¿‡X-Hostè§‚å¯Ÿè¯·æ±‚ç»è¿‡å“ªä¸ªLBè½¬å‘çš„ã€‚
$ curl http://172.16.253.100:8080 -v
*Â  Â Trying 172.16.253.100:8080...
* Connected to 172.16.253.100 (172.16.253.100) port 8080
> GET / HTTP/1.1
> Host: 172.16.253.100:8080
> User-Agent: curl/8.5.0
> Accept: */*
>
< HTTP/1.1 200 OK
< Server: nginx/1.24.0 (Ubuntu)
< Date: Sun, 10 Nov 2024 16:46:36 GMT
< Content-Type: text/plain
< Content-Length: 0
< Connection: keep-alive
< X-Remote-IP: 172.16.253.135
< X-Host: server2
<
* Connection #0 to host 172.16.253.100 left intact
```

å¦‚æœä½ å¤šæ‰§è¡Œå‡ æ¬¡ï¼Œå¯èƒ½ä¼šå‘ç°è¯·æ±‚æ€»æ˜¯ç»è¿‡åŒä¸€ä¸ªLBè½¬å‘åˆ°serverçš„ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æœŸå¾…çš„è´Ÿè½½åˆ†æ‹…ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

è¿™ä¸ECMPçš„å®ç°æœ‰å…³ï¼Œæˆ‘ä»¬åœ¨[redhatçš„æ–‡æ¡£](https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/7/html/7.6_release_notes/new_features_networking#new_features_networking)å¯ä»¥çœ‹åˆ°åé¢è¿™æ®µæè¿°ã€‚

![](https://static001.geekbang.org/resource/image/99/5c/99e1d653c9e10b5da1eyy84e4321505c.jpg?wh=3009x2453)

è¿™æ®µå†…å®¹å¤§è‡´å¯ä»¥è¿™æ ·ç†è§£ã€‚Linuxåœ¨å¤„ç†ECMPè·¯ç”±çš„æ—¶å€™ä¸æ˜¯é€åŒ…è´Ÿè½½åˆ†æ‹…è½¬å‘çš„ï¼Œè€Œæ˜¯æ ¹æ®ä¸€äº›è½¬å‘æ•°æ®è¿›è¡Œhashï¼Œç¢°æ’åˆ°å“ªä¸ªè·¯å¾„ï¼Œå°±èµ°å“ªä¸ªè·¯å¾„ã€‚hashå‚æ•°å’Œnet.ipv4.fib\_multipath\_hash\_policyçš„é…ç½®æœ‰å…³ã€‚å¦‚æœè¯¥å€¼ä¸º0ï¼ŒåªæŒ‰ç…§æºã€ç›®çš„IPè¿›è¡Œhashï¼›å¦‚æœè¯¥å€¼ä¸º1ï¼Œä¼šæŒ‰ç…§5å…ƒç»„ï¼ˆæºIPã€æºç«¯å£ã€ç›®çš„IPã€ç›®çš„ç«¯å£ã€åè®®ç±»å‹ï¼‰è¿›è¡Œhashã€‚

æˆ‘ä»¬å¯ä»¥ç”¨åé¢çš„å‘½ä»¤æŸ¥è¯¢ä¸€ä¸‹è¯¥å€¼ã€‚

```plain
$ sysctl net.ipv4.fib_multipath_hash_policy
net.ipv4.fib_multipath_hash_policy = 0
```

é»˜è®¤æ˜¯0ï¼Œæˆ‘ä»¬åœ¨åŒä¸€ä¸ªè®¾å¤‡ï¼Œå¤šæ¬¡å‘åŒä¸€ä¸ªvipè¯·æ±‚ï¼Œæºã€ç›®çš„IPæ€»æ˜¯ç›¸åŒçš„ï¼Œhashç»“æœä¸€å®šæ˜¯ç›¸åŒçš„ï¼Œè¿™é€ æˆäº†ï¼Œä¸€ç›´ä½¿ç”¨åŒä¸€ä¸ªLBè½¬å‘ã€‚æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹è¿™ä¸ªå‚æ•°ï¼Œå†å¤šæ¬¡è¯·æ±‚çœ‹çœ‹ã€‚

```plain
#ä¿®æ”¹å‚æ•°
~$ sudo sysctl -w net.ipv4.fib_multipath_hash_policy=1
net.ipv4.fib_multipath_hash_policy = 1

#å¤šæ¬¡æ‰§è¡Œcurlï¼Œè§‚å¯ŸX-Hostæ˜¯å¦ä¸ºåŒä¸€LB
#curl http://172.16.253.100:8080 -v
```

æœç„¶è¿™æ¬¡æœ‰çš„è¯·æ±‚åˆ°LB1ï¼Œæœ‰çš„è¯·æ±‚åˆ°LB2äº†ã€‚

å› ä¸ºä¿®æ”¹åä¼šæŒ‰ç…§äº”å…ƒç»„hashï¼Œè€Œæ¯æ¬¡curlæºç«¯å£éƒ½æ˜¯å˜åŒ–çš„ï¼Œæ‰€ä»¥äº”å…ƒç»„å°±å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿›è€Œå¯¼è‡´hashç»“æœä¼šå˜åŒ–ã€‚äº‹å®ä¸Šï¼Œä½ ä¹Ÿå¯ä»¥ä¸ä¿®æ”¹fib\_multipath\_hash\_policyå‚æ•°ï¼Œè€Œæ˜¯åœ¨routerä¸Šå¤šåˆ›å»ºä¸€äº›lOæ¥å£ï¼Œå¹¶é…ç½®ä¸åŒçš„IPåœ°å€ï¼Œç„¶åé€šè¿‡æŒ‡å®šæºIPçš„æ–¹å¼å‘é€è¯·æ±‚ï¼Œè¿™æ ·ä¹Ÿèƒ½è§‚å¯Ÿåˆ°ä¸€äº›è¯·æ±‚é€šè¿‡LB1è½¬å‘ï¼Œä¸€äº›è¯·æ±‚é€šè¿‡LB2è½¬å‘çš„æ•ˆæœã€‚

```plain
#æ”¹å›ä¸ºfib_multipath_hash_policyä¸º0
$ sudo sysctl -w net.ipv4.fib_multipath_hash_policy=0
net.ipv4.fib_multipath_hash_policy = 0

#æ–°å¢loå£å¹¶æ·»åŠ æ–°ipåœ°å€
$ sudo ifconfig lo:1 172.16.253.200 netmask 255.255.255.255 up
$ sudo ifconfig lo:2 172.16.253.201 netmask 255.255.255.255 up
$ sudo ifconfig lo:3 172.16.253.202 netmask 255.255.255.255 up

#æŒ‡å®šæºipå‘é€è¯·æ±‚Â 
curl -v http://172.16.253.100:8080 --interface 172.16.253.200
curl -v http://172.16.253.100:8080 --interface 172.16.253.201
curl -v http://172.16.253.100:8080 --interface 172.16.253.202
```

## å°ç»“

ä»Šå¤©çš„å†…å®¹å°±æ˜¯è¿™äº›ï¼Œæˆ‘ç»™ä½ å‡†å¤‡äº†ä¸€ä¸ªæ€ç»´å¯¼å›¾å›é¡¾è¦ç‚¹ã€‚  
![](https://static001.geekbang.org/resource/image/4d/f6/4d57ab5d86a15b64820980852b6204f6.jpg?wh=3917x3632)

ä»Šå¤©è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥æ¢è®¨äº†è´Ÿè½½å‡è¡¡ï¼ˆLBï¼‰å¦‚ä½•è¿›è¡Œæ¨ªå‘æ‰©å±•ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬è®¨è®ºäº†ECMPï¼ˆç­‰ä»·å¤šè·¯å¾„è·¯ç”±ï¼‰å¦‚ä½•æ”¯æŒæµé‡åˆ†æ‹…ã€‚å½“å¤šä¸ªç­‰é•¿æ©ç çš„è·¯ç”±å­˜åœ¨æ—¶ï¼Œè·¯ç”±å™¨ä¼šé€‰æ‹©è¿›è¡Œè´Ÿè½½åˆ†æ‹…ï¼Œè¿™æ ·å¯ä»¥åœ¨å¤šä¸ªè·¯å¾„ä¹‹é—´å‡åŒ€åˆ†é…æµé‡ï¼Œç¡®ä¿ç³»ç»Ÿçš„é«˜æ•ˆè¿è¡Œã€‚

ä¹‹åæˆ‘ä»¬åˆæ·±å…¥å­¦ä¹ LVSï¼ˆLinux Virtual Serverï¼‰ä½œä¸ºè´Ÿè½½å‡è¡¡å™¨çš„å·¥ä½œåŸç†ï¼Œé‡ç‚¹è®²è§£äº†å…¶ä¾èµ–çš„Netfilteræ¡†æ¶ã€‚é€šè¿‡Netfilteræ¡†æ¶çš„ä¸åŒé˜¶æ®µï¼ˆå¦‚preroutingã€inputã€forwardå’Œpostroutingï¼‰ï¼ŒLVSèƒ½å¤Ÿå¯¹æ•°æ®åŒ…è¿›è¡Œç²¾ç¡®åœ°è½¬å‘å’Œä¿®æ”¹ï¼Œå®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚

ç‰¹åˆ«è¦æ³¨æ„çš„æ˜¯ï¼ŒLVSé€šè¿‡å¤šç§æ¨¡å¼ï¼ˆå¦‚DRæ¨¡å¼ã€DNATæ¨¡å¼ã€FullNATæ¨¡å¼å’ŒTunnelæ¨¡å¼ï¼‰å®ç°ä¸åŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œæ¯ç§æ¨¡å¼æ ¹æ®ç‰¹å®šçš„éœ€æ±‚è¿›è¡Œæ•°æ®åŒ…çš„å¤„ç†å’Œè½¬å‘ï¼Œä¿è¯è¯·æ±‚èƒ½å¤Ÿå‡åŒ€åˆ†é…åˆ°å„ä¸ªåç«¯æœåŠ¡å™¨ã€‚

æœ€åæ˜¯LBæ¨ªå‘æ‰©å±•çš„å®æˆ˜ç¯èŠ‚ã€‚æˆ‘ä»¬æ­å»ºäº†åŸºäºLVSçš„è´Ÿè½½å‡è¡¡ç³»ç»Ÿï¼Œåœ¨å®éªŒä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨LVSçš„DRæ¨¡å¼ã€Keepalivedçš„è™šæ‹ŸLBé…ç½®ã€ä»¥åŠé€šè¿‡OSPFåè®®å®ç°çš„åŠ¨æ€è·¯ç”±ï¼ŒæˆåŠŸå®ç°äº†LBé›†ç¾¤çš„æ¨ªå‘æ‰©å±•ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä¸åŒçš„æµé‡å¯ä»¥è¢«æœ‰æ•ˆåœ°åˆ†é…åˆ°ä¸åŒçš„è´Ÿè½½å‡è¡¡å™¨ï¼Œä»è€Œæå‡äº†æ•´ä½“ç³»ç»Ÿçš„æ€§èƒ½å’Œå¯é æ€§ã€‚

å¼ºçƒˆå»ºè®®ä½ è·Ÿç€è¯¾ç¨‹è®²è§£åŠ¨æ‰‹ç»ƒä¹ ä¸€ä¸‹ï¼Œè¿™æ ·ä½ ä¸ä»…èƒ½å¯¹LBçš„æ¨ªå‘æ‰©å±•ç†è®ºæœ‰ä¸ªæ›´æ·±å…¥çš„ç†è§£ï¼Œä¹Ÿèƒ½æŒæ¡é€šè¿‡LVSå®ç°é«˜æ•ˆè´Ÿè½½å‡è¡¡çš„å®è·µèƒ½åŠ›ã€‚

## æ€è€ƒé¢˜

1. åœ¨LVSçš„DRæ¨¡å¼ä¸‹ï¼Œä¸ºä»€ä¹ˆéœ€è¦åœ¨æœåŠ¡å™¨çš„ç½‘ç»œæ¥å£ä¸Šé…ç½®VIPåœ°å€ï¼Œä½†åˆä¸è®©VIPé€šè¿‡ARPå¹¿æ’­å…¬å¼€ï¼Ÿå¦‚æœç›´æ¥å°†VIPå¹¿æ’­ç»™æ‰€æœ‰è®¾å¤‡ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Ÿ
2. æŒ‰é“ç†è¯´ï¼Œå®Œå…¨æŒ‰åŒ…è´Ÿè½½åˆ†æ‹…ä¼šè®©è¯·æ±‚æ›´å‡åŒ€åœ°åœ¨å¤šä¸ªç­‰ä»·çš„è·¯å¾„ä¸­è½¬å‘ï¼Œé‚£ä¸ºä»€ä¹ˆå®ç°ECMPçš„æ—¶å€™æ˜¯ï¼ŒæŒ‰ç…§äº”å…ƒç»„æˆ–æºç›®çš„IPæ¥hashé€‰æ‹©èµ°å“ªæ¡è·¯ç”±ï¼Œè€Œä¸æ˜¯å®Œå…¨æŒ‰åŒ…è´Ÿè½½åˆ†æ‹…å‘¢ï¼Ÿ

æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºå’Œæˆ‘äº¤æµäº’åŠ¨ï¼Œå¦‚æœè¿™èŠ‚è¯¾å¯¹ä½ æœ‰å¯å‘ï¼Œä¹Ÿæ¨èä½ åˆ†äº«ç»™èº«è¾¹æ›´å¤šæœ‹å‹ã€‚

## æ‰©å±•é˜…è¯»

iptableæ›´ä¸ºè¯¦ç»†çš„æ•°æ®è½¬å‘å›¾å¯å‚è€ƒ [Netfilter-packet-flow.svgNetfilter-packet-flow.svg](https://en.wikipedia.org/wiki/Netfilter#/media/File:Netfilter-packet-flow.svg)
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ2ï¼‰</strong></div><ul>
<li><span>æ ¼æ´›ç±³çˆ±å­¦ä¹ </span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é—®é¢˜ 1ï¼šæœåŠ¡å™¨èƒ½ç›´æ¥ä»¥ VIP ä½œä¸ºæºåœ°å€è®¿é—®æœåŠ¡å™¨ï¼Œç›´æ¥å“åº”è¯·æ±‚ã€‚ä¸é€šè¿‡ ARP å¹¿æ’­ VIP çš„åŸå› ï¼Œæ˜¯å› ä¸ºè®¾å¤‡ä¼šæ”¶åˆ°å¤šå°æœåŠ¡å™¨çš„åŒä¸€ä¸ª VIP çš„ MAC åœ°å€ä¿¡æ¯ï¼Œé€ æˆ ARP è¡¨çš„æ··ä¹±ï¼Œä¹Ÿæœ‰å¯èƒ½å‡ºç°å®¢æˆ·ç«¯ç›´æ¥ç»•è¿‡ LB ä¸æœåŠ¡å™¨è¿æ¥çš„æƒ…å†µã€‚
é—®é¢˜ 2ï¼šäº”å…ƒç»„ Hash ä¸€è‡´æ€§èƒ½ä¿è¯ä¾‹å¦‚ TCP ä¼šè¯çš„è¿ç»­æ€§ã€é¿å…ä¸åŒè·¯å¾„é€ æˆçš„ä¹±åºã€ä»¥åŠä¾¿äºæ•…éšœæ’æŸ¥ï¼Œä¾‹å¦‚å‘ç°ä¸¢åŒ…åå¯ä»¥åšç›¸åŒäº”å…ƒç»„çš„è·¯å¾„å›æ”¾ã€‚</p>2025-02-19</li><br/><li><span>Geek_706285</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>1.å› ä¸ºèµ°DRæ¨¡å¼çš„æƒ…å†µä¸‹ï¼Œlvsåªä¿®æ”¹æŠ¥æ–‡ä¸­çš„ç›®æ ‡macåœ°å€è€Œä¸ä¿®æ”¹ç›®çš„ipï¼Œæ‰€ä»¥æœåŠ¡å™¨ipå¿…é¡»ä¸æŠ¥æ–‡çš„ç›®çš„ipä¿æŒä¸€è‡´æ‰èƒ½è·¯ç”±åˆ°æœ¬æœºINPUTé“¾è¿›è¡Œå¤„ç†ã€‚å¦‚æœARP å¹¿æ’­å…¬å¼€çš„è¯ï¼ŒæŠ¥æ–‡å¯èƒ½ä¼šç»•è¿‡lvsè€Œç›´æ¥åˆ°è¾¾æœåŠ¡å™¨ï¼Œæˆ‘è‡ªå·±æŸ¥è¯¢èµ„æ–™ç»™çš„ç»“æœæ˜¯ä¼šå‘ç”Ÿarpå†²çªï¼Œç»“æœä¼šå¯¼è‡´ç½‘ç»œæ€§èƒ½ä¸‹é™å’Œæ•°æ®åŒ…ä¸¢å¤±ç­‰æƒ…å†µ 2.å„ä¸ªåŒ…çš„æµé‡å¤§å°ä¸ä¸€æ ·</p>2025-02-19</li><br/>
</ul>