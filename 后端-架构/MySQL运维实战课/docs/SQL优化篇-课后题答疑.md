ä½ å¥½ï¼Œæˆ‘æ˜¯ä¿Šè¾¾ã€‚

è¿™ä¸€è®²æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹SQLä¼˜åŒ–ç¯‡ä¸­çš„æ€è€ƒé¢˜çš„è§£ç­”ã€‚

## ç¬¬17è®²

é—®é¢˜ï¼š

```plain
create table t_n(a int not null, primary key(a));


insert into t_n values(1),(2),(3),(4),(5),(6),(7),(8),(9),(10),
  (11),(12),(13),(14),(15),(16),(17),(18),(19),(20);


create table t_abc(
    id int not null auto_increment,
    a int not null,
    b int not null,
    c int not null,
    d int not null,
    padding varchar(200),
    primary key(id),
    key idx_abc(a,b,c)
) engine=innodb;


insert into t_abc(a,b,c,d, padding)
select t1.a, t2.a, t3.a, t3.a, rpad('', 200, 'ABC DEF G XYZ')
from t_n t1, t_n t2, t_n t3;
```

æ ¹æ®æµ‹è¯•è¡¨t\_abcçš„ç»“æ„ï¼Œåˆ†æä¸‹é¢è¿™å‡ ä¸ªSQLè¯­å¥çš„æ‰§è¡Œè·¯å¾„ï¼Œæœ‰å“ªäº›åŒºåˆ«ï¼Ÿ

```plain
-- SQL 1
select * from t_abc where a = 10 and b = 10;
-- SQL 2
select * from t_abc where a = 10 and c = 10;
-- SQL 3
select * from t_abc where a = 10 and d = 10;

-- SQL 4
select * from t_abc where a = 10 order by a,c;
-- SQL 5
select * from t_abc where a = 10 order by b,c;

-- SQL 6
select id, a, b, c from t_abc where a = 10;
-- SQL 7
select id, a, b, c from t_abc where b = 10;
-- SQL 8
select id, a, b, c, d from t_abc where b = 10;
```

@123 åœ¨è¯„è®ºåŒºä¸­æä¾›äº†è¿™ä¸ªé—®é¢˜æ¯”è¾ƒå…¨é¢çš„å›ç­”ã€‚

è¿™ä¸ªé—®é¢˜ä¸»è¦æ˜¯å…³äºç»„åˆç´¢å¼•çš„ä½¿ç”¨æƒ…å†µã€‚å‰é¢çš„ä¸‰ä¸ªSQLï¼ŒSQL 1èƒ½ç”¨åˆ°ç´¢å¼•å‰ç¼€ï¼ˆa,b)ã€‚SQL 2å’ŒSQL 3åªèƒ½ç”¨åˆ°ç´¢å¼•å‰ç¼€ï¼ˆaï¼‰ã€‚ä½†æ˜¯SQL 2å’ŒSQL 3è¿˜æ˜¯æœ‰ä¸€äº›åŒºåˆ«çš„ã€‚SQL 2å¯ä»¥ç”¨åˆ°ç´¢å¼•æ¡ä»¶ä¸‹æ¨ã€‚

SQL 4å’ŒSQL 5çš„åŒºåˆ«ï¼Œä¸»è¦åœ¨äºæ˜¯å¦èƒ½ä½¿ç”¨ç´¢å¼•çš„æœ‰åºæ€§æ¥é¿å…æ’åºã€‚SQL 4éœ€è¦ä½¿ç”¨æ–‡ä»¶æ’åºï¼Œå› ä¸ºorder byçš„å­—æ®µé¡ºåºï¼ˆaï¼Œcï¼‰å’Œç´¢å¼•å­—æ®µé¡ºåºï¼ˆaï¼Œbï¼Œcï¼‰ä¸ä¸€æ ·ã€‚SQL 5å¯ä»¥é¿å…æ’åºï¼Œæ¡ä»¶aä½¿ç”¨äº†ç­‰å€¼æ¡ä»¶ï¼Œå†åŠ ä¸Šæ’åºå­—æ®µï¼Œå’Œç´¢å¼•å­—æ®µé¡ºåºä¸€è‡´ã€‚

SQL 6å¯ä»¥ç”¨åˆ°ç´¢å¼•å‰ç¼€ï¼ˆaï¼‰ï¼Œä½†æ˜¯SQL 7æ— æ³•ä½¿ç”¨ç´¢å¼•æ¥è¿‡æ»¤æ•°æ®ã€‚å½“ç„¶ï¼Œè¿™é‡ŒSQL 7ç”¨åˆ°äº†è¦†ç›–ç´¢å¼•ï¼Œè¿™ç§æƒ…å†µä¸‹æœ‰å¯èƒ½ç”¨åˆ° skip scanã€‚

```plain
mysql> explain select id, a, b, c from t_abc where b = 10;
+----+-------------+-------+-------+---------------+---------+---------+------+----------------------------------------+
| id | select_type | table | type  | possible_keys | key     | key_len | rows | Extra                                  |
+----+-------------+-------+-------+---------------+---------+---------+------+----------------------------------------+
|  1 | SIMPLE      | t_abc | range | idx_abc       | idx_abc | 8       |  793 | Using where; Using index for skip scan |
+----+-------------+-------+-------+---------------+---------+---------+------+----------------------------------------+
```

SQL 6å’ŒSQL 8çš„ä¸»è¦åŒºåˆ«ï¼Œæ˜¯SQL 6å¯ä»¥ç”¨åˆ°è¦†ç›–ç´¢å¼•ã€‚å½“ç„¶ï¼Œç”±äºInnoDB MVCCçš„å®ç°æœºåˆ¶ï¼Œå³ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œä¹Ÿæœ‰å¯èƒ½è¦è®¿é—®èšç°‡ç´¢å¼•æŸ¥è¯¢æ•°æ®ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ[ç¬¬32è®²](https://time.geekbang.org/column/article/819420)ã€‚

## ç¬¬18è®²

é—®é¢˜ï¼š

è¿™ä¸€è®²ä¸­æœ‰è¿™ä¹ˆä¸€ä¸ªSQLï¼š

```plain
select id, a, (select avg(b) from tab where a=t1.a) from tab t1;
```

åœ¨æˆ‘ä»¬çš„æµ‹è¯•è¡¨ä¸­ï¼Œå­—æ®µAçš„å”¯ä¸€å€¼æœ‰ä¸‰ä¸ªï¼Œæ‰€ä»¥ç†è®ºä¸Šï¼Œæœ€ä¼˜çš„æƒ…å†µä¸‹åªéœ€è¦å°†3ä¸ªä¸åŒçš„Açš„å€¼åˆ†åˆ«ä¼ å…¥å­æŸ¥è¯¢ä¸­ï¼ˆselect avg(b) from tab where a = t1.aï¼‰ï¼Œå¹¶å°†è®¡ç®—ç»“æœç¼“å­˜èµ·æ¥ï¼Œè¿™æ ·å­æŸ¥è¯¢åªéœ€è¦æ‰§è¡Œ3æ¬¡ã€‚

MariaDBå®é™…ä¸Šå°±æœ‰è¿™æ ·çš„å¤„ç†ï¼Œå› æ­¤åœ¨æ‰§è¡Œä¸Šé¢è¿™ä¸ªSQLæ—¶ï¼Œé€Ÿåº¦æ¯”è¾ƒå¿«ã€‚

```plain
mariadb> select id, a, (select avg(b) from tab where a=t1.a) from tab t1 order by id;
+------+---+---------------------------------------+
| id   | a | (select avg(b) from tab where a=t1.a) |
+------+---+---------------------------------------+
|    0 | 0 |                             4999.5000 |
|    1 | 1 |                             4999.0000 |
|    2 | 2 |                             5000.0000 |
......
| 9999 | 0 |                             4999.5000 |
+------+---+---------------------------------------+
10000 rows in set (0.01 sec)
```

ä½†æ˜¯MySQLä¸­ï¼ŒåŒæ ·çš„è¡¨ç»“æ„å’Œæ•°æ®ï¼Œé…ç½®ä¸€æ ·çš„æœåŠ¡å™¨ï¼Œæ‰§è¡Œè¿™ä¸ªSQLæ—¶ï¼Œæ‰§è¡Œæ—¶é—´æ˜¯å¥½å‡ ä¸ªæ•°é‡çº§ã€‚

```plain
mysql> select id, a, (select avg(b) from tab where a=t1.a) from tab t1 order by id;
+------+------+---------------------------------------+
| id   | a    | (select avg(b) from tab where a=t1.a) |
+------+------+---------------------------------------+
|    0 |    0 |                             4999.5000 |
|    1 |    1 |                             4999.0000 |
|    2 |    2 |                             5000.0000 |
......
| 9999 |    0 |                             4999.5000 |
+------+------+---------------------------------------+
10000 rows in set (4 min 17.90 sec)
```

å¯¹äºè¿™ç§æƒ…å†µï¼Œä½ ä¼šæ€ä¹ˆè§£å†³å‘¢ï¼Ÿ

@Shelly @å¶æ˜ åœ¨è¯„è®ºåŒºä¸­æä¾›äº†ä¸€ç§ä¼˜åŒ–æ–¹æ³•ï¼Œæ”¹å†™SQLï¼Œå­æŸ¥è¯¢ä¸­å…ˆè¿›è¡Œgroup byï¼Œç„¶åå†å’ŒåŸè¡¨joinã€‚

```plain
select
  t1.id,
  t1.a,
  t2.avg_b
from
  tab t1
  inner join (
    select
      a,
      avg(b) avg_b
    from
      tab
    group by
      a
  ) t2 on t1.a = t2.a
order by
  id;
```

## ç¬¬19è®²

é—®é¢˜ï¼šæœ‰æ—¶æˆ‘ä»¬éœ€è¦åˆ†æ®µå¤„ç†å…¨è¡¨çš„æ•°æ®ã€‚å¦‚æœè¡¨ä½¿ç”¨äº†å•åˆ—ä¸»é”®ï¼Œé‚£ä¹ˆå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æŒ‰ä¸»é”®èŒƒå›´æ¥è¿›è¡Œæ•°æ®åˆ†ç‰‡ã€‚ä½†æœ‰äº›æƒ…å†µä¸‹ï¼Œä¸šåŠ¡ä½¿ç”¨äº†è”åˆä¸»é”®ï¼Œé‚£ä¹ˆæ­¤æ—¶ä½ åº”è¯¥æ€ä¹ˆæŒ‰ä¸»é”®èŒƒå›´æ¥å¯¹æ•°æ®è¿›è¡Œåˆ†ç‰‡å‘¢ï¼Ÿ

```plain
create table t_business(
  id1 varchar(30) not null,
  id2 varchar(30) not null,
  id3 varchar(30) not null,
  col1 ...,
  col2 ...,
  primry key(id1, id2, id3)
) engine=innodb;
```

è€ƒè™‘ä¸Šé¢è¿™ä¸ªè¡¨ï¼Œä½¿ç”¨äº†è”åˆä¸»é”®(id1, id2, id3)ã€‚ä½ éœ€è¦åˆ†ç‰‡å¤„ç†è¿™ä¸ªè¡¨çš„æ•°æ®ï¼Œæ¯æ¬¡å¤„ç†1000è¡Œæ•°æ®ï¼Œè¦æ±‚ä¸è¦é‡å¤å¤„ç†æ•°æ®ï¼Œä½†ä¹Ÿä¸è¦æ¼æ‰ä»»ä½•ä¸€æ¡æ•°æ®ã€‚æ•´ä¸ªè¡¨çš„æ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œè¦å°½å¯èƒ½ä¿è¯æ€§èƒ½ã€‚ä½ ä¼šæ€ä¹ˆæ¥å†™è¿™ä¸ªåˆ†é¡µçš„SQLå‘¢ï¼Ÿ

@å¶æ˜ åœ¨è¯„è®ºåŒºä¸­æä¾›äº†è§£å†³è¿™ä¸ªé—®é¢˜çš„å‡ ç§æ€è·¯ã€‚

ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ä¸‹é¢è¿™ç§å†™æ³•ï¼Œâ€˜id1â€™, â€˜id2â€™,'id3â€™æ˜¯ä¸Šä¸€æ‰¹æ•°æ®ä¸­çš„æœ€åä¸€æ¡è®°å½•ã€‚ä¸è¿‡è¿™ä¹ˆå†™MySQLå¥½åƒä½¿ç”¨äº†å…¨è¡¨æ‰«æã€‚

```plain
select * 
from t_business 
where (id1, id2, id3) > ('id1', 'id2', 'id3')
order by id1, id2, id3
limit 1000
```

å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ä¸‹é¢è¿™ç§å†™æ³•ã€‚

```plain
select * 
from t_business
where (id1 > 'id1') 
or (id1 = 'id1' and id2 > 'id2') 
or (id1 = 'id1' and id2 = 'id2' and id3 > 'id3')
order by id1, id2, id3
limit 1000
```

é¦–å…ˆè¿™ç§å†™æ³•é€»è¾‘æ˜¯ä¸Šæ­£ç¡®çš„ï¼Œå’Œæ¡ä»¶(id1, id2, id3) &gt; (â€˜id1â€™, â€˜id2â€™, â€˜id3â€™)ç­‰ä»·ã€‚è€Œä¸”è¿™ä¹ˆå†™ä¹Ÿèƒ½ç”¨åˆ°ä¸»é”®ï¼Œæ•ˆç‡ä¸Šä¹Ÿæœ‰ä¿éšœã€‚

## ç¬¬20è®²

é—®é¢˜ï¼šå›åˆ°æˆ‘ä»¬å‰é¢é‚£ä¸ªè®¢å•åˆ—è¡¨çš„åœºæ™¯ï¼Œæœ‰ä¸€å¤©ï¼Œäº§å“å†³å®šè¦åšä¸€ä¸ªè®¢å•åˆ é™¤çš„åŠŸèƒ½ï¼Œæ–¹ä¾¿ç”¨æˆ·å°†ä¸€äº›ä¸æƒ³è®©äººçœ‹åˆ°è®¢å•éšè—èµ·æ¥ã€‚ç›¸åº”åœ°ï¼Œä¸šåŠ¡SQLéœ€è¦åšä¸€äº›ç›¸åº”çš„è°ƒæ•´ï¼Œwhereæ¡ä»¶ä¸­éœ€è¦å¢åŠ is\_deletedçš„æ¡ä»¶ã€‚

```plain
select count(*)
from t_order_detail
where seller_id = ? 
and order_status in (?) 
and refund_status in(?) 
and is_deleted=0;

select t2.* from (
  select id
  from t_order_detail
  where seller_id = ? 
  and order_status in (?) 
  and refund_status in(?) 
  and is_deleted=0
  order by create_time
limit M, N) t1 straight_join t_order_detail t2
where t1.id = t2.id;
```

ä½œä¸ºä¸€åç ”å‘äººå‘˜ï¼Œæˆ–è€…æ˜¯ä¸€åDBAï¼Œæ¥åˆ°è¿™ä¸ªéœ€æ±‚åï¼Œåœ¨æ•°æ®åº“è¿™ä¸€å±‚ï¼Œæœ‰å“ªäº›éœ€è¦è€ƒè™‘çš„åœ°æ–¹ï¼Ÿä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œä½ ä¼šæ€æ ·åšï¼Ÿ

@å¶æ˜ @123 åœ¨è¯„è®ºåŒºä¸­æä¾›äº†è¿™ä¸ªé—®é¢˜çš„è§£ç­”ã€‚

whereæ¡ä»¶ä¸­æ·»åŠ is\_deletedæ¡ä»¶åï¼Œç”±äºåŸå…ˆçš„ç´¢å¼•ä¸­ä¸åŒ…å«è¿™ä¸ªå­—æ®µï¼Œå› æ­¤ä¼šå¢åŠ å¤§é‡çš„å›è¡¨æ“ä½œã€‚åŸå…ˆçš„select count(\*)æŸ¥è¯¢å¯ä»¥ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œå¢åŠ is\_deletedæ¡ä»¶åå°±ä¸èƒ½ä½¿ç”¨è¦†ç›–ç´¢å¼•äº†ã€‚åŸå…ˆçš„åˆ†é¡µSQLï¼Œå¯ä»¥åœ¨ç´¢å¼•ä¸Šåˆ†é¡µï¼Œè·å–ä¸€æ‰¹ä¸»é”®IDï¼Œå¢åŠ is\_deletedæ¡ä»¶åï¼Œä¹Ÿä¼šå¢é‡å¾ˆå¤šå›è¡¨æ“ä½œï¼Œæ£€æŸ¥è®°å½•æ˜¯å¦æ»¡è¶³æ¡ä»¶ã€‚

å¯¹äºè¿™ä¸ªåœºæ™¯ï¼Œä¸€èˆ¬ä¼šåœ¨ç´¢å¼•ä¸­æ·»åŠ is\_deletedå­—æ®µã€‚is\_deletedå­—æ®µè¿‡æ»¤æ€§å¹¶ä¸é«˜ï¼Œå¯ä»¥æ”¾åœ¨ç´¢å¼•å­—æ®µçš„æœ€åé¢ã€‚

@binzhang æä¾›äº†å¦å¤–ä¸€ç§æ€è·¯ï¼Œå°±æ˜¯ä¸æ·»åŠ is\_deletedå­—æ®µï¼Œè€Œæ˜¯ä½¿ç”¨åŸå…ˆçš„order\_statuså­—æ®µæ¥æ»¡è¶³è¿™ä¸ªéœ€æ±‚ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§å¾ˆå¥½çš„æ–¹æ³•ï¼Œä¸ä¿®æ”¹è¡¨ç»“æ„ï¼Œä¸è°ƒæ•´ç´¢å¼•ï¼Œåªè°ƒæ•´åº”ç”¨ç¨‹åºçš„ä»£ç é€»è¾‘ã€‚

## ç¬¬21è®²

é—®é¢˜ï¼šæœ€åæ¥çœ‹ä¸€ä¸ªè¡¨è¿æ¥çš„ä¾‹å­ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªæµ‹è¯•è¡¨ï¼Œå†™å…¥10000è¡Œæ•°æ®ã€‚

```plain
create table t_jointab(
  id int not null auto_increment,
  a int not null,
  b int not null,
  c varchar(4000),
    primary key(id),
    key idx_a(a)
) engine=innodb charset utf8mb4;


insert into t_jointab(a,b,c)
select case when n < 9000 then n else 9000 end as a,
    n % 1000, rpad('x', 2000, 'ABCD')
from numbers where n < 10000;
```

æ”¶é›†å¹¶æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯ã€‚

```plain
mysql> analyze table t_jointab;
+---------------+---------+----------+----------+
| Table         | Op      | Msg_type | Msg_text |
+---------------+---------+----------+----------+
| rep.t_jointab | analyze | status   | OK       |
+---------------+---------+----------+----------+
1 row in set (0.62 sec)


mysql> show indexes from t_jointab;
+------------+----------+--------------+-------------+-------------+
| Non_unique | Key_name | Seq_in_index | Column_name | Cardinality |
+------------+----------+--------------+-------------+-------------+
|          0 | PRIMARY  |            1 | id          |        8580 |
|          1 | idx_a    |            1 | a           |        8580 |
+------------+----------+--------------+-------------+-------------+
```

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’ï¼Œä½¿ç”¨äº†åµŒå¥—å¾ªç¯ã€‚

```plain
mysql> explain format=tree 
    select count(*) 
    from t_jointab t1, t_jointab t2 
    where t1.a = t2.a and t1.b = t2.b\G
*************************** 1. row ***************************
EXPLAIN: 
-> Aggregate: count(0)  (cost=5079.75 rows=1)
    -> Nested loop inner join  (cost=4221.75 rows=8580)
        -> Table scan on t1  (cost=1218.75 rows=8580)
        -> Filter: (t2.b = t1.b)  (cost=0.25 rows=1)
            -> Index lookup on t2 using idx_a (a=t1.a)  (cost=0.25 rows=1)
```

ä¸Šé¢è¿™ä¸ªæ‰§è¡Œè®¡åˆ’çœ‹ä¸Šå»æ²¡ä»€ä¹ˆå¤§é—®é¢˜ï¼Œä½†æ˜¯åœ¨æˆ‘çš„ç¯å¢ƒä¸­ï¼Œæ‰§è¡Œæ¶ˆè€—äº†1åˆ†å¤šçš„æ—¶é—´ã€‚

```plain
mysql> select count(*)
   from t_jointab t1, t_jointab t2 
   where t1.a = t2.a and t1.b = t2.b;
+----------+
| count(*) |
+----------+
|    10000 |
+----------+
1 row in set (1 min 19.29 sec)
```

æŸ¥çœ‹æ…¢æ—¥å¿—å‘ç°ï¼Œè¿™ä¸ªè¯­å¥çš„Rows\_examinedæ¯”è¾ƒé«˜ï¼Œæœ‰100å¤šä¸‡ã€‚

```plain
# Query_time: 79.285872  Lock_time: 0.000036 Rows_sent: 1  Rows_examined: 1019000
SET timestamp=1724921875;
select count(*)ã€‚
   from t_jointab t1, t_jointab t2
   where t1.a = t2.a and t1.b = t2.b;
```

è¯·ä½ åˆ†æä¸€ä¸‹ï¼Œè¿™ä¸ªSQLæ‰§è¡Œæ¯”è¾ƒæ…¢çš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ æœ‰å“ªäº›å¯èƒ½çš„ä¼˜åŒ–æ–¹æ¡ˆï¼ˆå‰ææ˜¯ä¸èƒ½ä¿®æ”¹è¡¨é‡Œçš„æ•°æ®ï¼‰ï¼Ÿ

è¿™ä¸ªé—®é¢˜ @å¶æ˜ åœ¨è¯„è®ºåŒºåšäº†å¾ˆè¯¦ç»†çš„åˆ†æï¼Œå¹¶ä¸”æä¾›äº†ä¸¤ç§æœ‰æ•ˆçš„è§£å†³æ–¹æ³•ã€‚

ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨Hash Joinï¼Œé€šè¿‡ignore indexæç¤ºï¼Œè®©ä¼˜åŒ–å™¨å¿½ç•¥æ‰ç´¢å¼•idx\_aï¼Œä»è€Œä½¿ç”¨Hash Joinã€‚

```plain
select count(*) from t_jointab t1 ignore index(idx_a), t_jointab t2 ignore index(idx_a) where t1.a = t2.a and t1.b = t2.b;
```

è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯ä¿®æ”¹ç´¢å¼•ï¼Œåœ¨ç´¢å¼•ä¸­æ·»åŠ å­—æ®µbã€‚

```plain
alter table t_jointab drop index idx_a, add index idx_a(a,b);
```

å¦‚æœå¯¹æ¯”ä¸‹Hash joinå’ŒNested Loop Joinçš„æ‰§è¡Œè®¡åˆ’ï¼Œä½ ä¼šå‘ç°è¿™ä¸ªä¾‹å­ä¸­Nested loop Joinçš„costæ¯”Hash joinè¦ä½å¾ˆå¤šï¼Œä½†æ˜¯å®é™…æ‰§è¡Œæ—¶ï¼ŒHash Joinæ¯”Nested Loop Joinè¦å¿«å¾ˆå¤šã€‚æ‰€ä»¥ï¼Œå¯¹äºä¸€ä¸ªSQLï¼Œcostä½çš„æ‰§è¡Œè®¡åˆ’ï¼Œæ‰§è¡Œæ•ˆç‡ä¸ä¸€å®šæ›´é«˜ã€‚

```plain
mysql> explain format=tree  select count(*)
    from t_jointab t1 , t_jointab t2
    where t1.a = t2.a and t1.b = t2.b\G
*************************** 1. row ***************************
EXPLAIN: -> Aggregate: count(0)  (cost=4307.55 rows=1)
    -> Nested loop inner join  (cost=4221.75 rows=858)
        -> Table scan on t1  (cost=1218.75 rows=8580)
        -> Filter: (t2.b = t1.b)  (cost=0.25 rows=0.1)
            -> Index lookup on t2 using idx_a (a=t1.a)  (cost=0.25 rows=1)
```

```plain
mysql>explain format=tree  select count(*)     
  from t_jointab t1 ignore index(idx_a)  , t_jointab t2 ignore index(idx_a)  
  where t1.a = t2.a and t1.b = t2.b\G
*************************** 1. row ***************************
EXPLAIN: 
-> Aggregate: count(0)  (cost=7364171.96 rows=1)
    -> Inner hash join (t2.b = t1.b), (t2.a = t1.a)  (cost=7363313.96 rows=8580)
        -> Table scan on t2  (cost=0.05 rows=8580)
        -> Hash
            -> Table scan on t1  (cost=1218.75 rows=8580)
```

## ç¬¬22è®²

é—®é¢˜ï¼š

è¿™ä¸€è®²ä¸­ï¼Œæˆ‘æä¾›äº†ä¸¤ç§æ‰‹åŠ¨æ”¹å†™å­æŸ¥è¯¢çš„æ€è·¯ã€‚

æ€è·¯1ï¼š

```plain
mysql> select t1.item_id, sum(t1.sold) as sold
from stat_item_detail t1, (
  select distinct item_id 
  from stat_item_detail t2
  where t2.gmt_create >= '2026-04-26 10:30:00') t22
where t1.item_id = t22.item_id
group by t1.item_id;
```

æ€è·¯2ï¼š

```plain
select item_id, sum(sold) from (
    select distinct t1.id,  t1.item_id, t1.sold as sold
    from stat_item_detail t1, stat_item_detail t2
    where t1.item_id = t2.item_id
    and t2.gmt_create >= '2026-04-26 10:30:00'
) t group by item_id;
```

è¯·é—®è¿™ä¸¤ç§æ”¹å†™æ–¹å¼ï¼Œåˆ†åˆ«å¯¹åº”äº†MySQLåŠè¿æ¥è½¬æ¢ä¸­çš„å“ªä¸€ä¸ªç­–ç•¥ï¼Ÿ

æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹MySQLåŠè¿æ¥è½¬æ¢çš„å‡ ç§ç­–ç•¥ã€‚

- Pulloutï¼šç›´æ¥å°†å­æŸ¥è¯¢æåˆ°å¤–å±‚ï¼Œæ”¹å†™æˆè¡¨è¿æ¥ã€‚

èƒ½ä½¿ç”¨Pulloutçš„å‰ææ˜¯è‡ªæŸ¥è¯¢ä¸­æœ‰ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•èƒ½ä¿è¯æ•°æ®ä¸é‡å¤ã€‚

- Duplicate weedoutï¼šå¦‚æœå­æŸ¥è¯¢ä¸­çš„æ•°æ®å¯èƒ½å­˜åœ¨é‡å¤ï¼ŒMySQLä¼šå¯¹ç»“æœæ•°æ®è¿›è¡Œå»é‡ã€‚

Duplicate weedoutæ˜¯å…ˆæ‰§è¡ŒJoinï¼Œç„¶åå¯¹ç»“æœé›†è¿›è¡Œå»é‡å¤„ç†ã€‚

- First Matchï¼šæ‰§è¡Œè¡¨è¿æ¥æ—¶ï¼Œå¯¹äºé©±åŠ¨è¡¨ä¸­çš„æ¯ä¸€è¡Œè®°å½•ï¼Œåªéœ€è¦åŒ¹é…å­æŸ¥è¯¢çš„ç¬¬ä¸€æ¡è®°å½•å°±è¿”å›ã€‚

ä½¿ç”¨First Matchç­–ç•¥æ—¶ï¼Œä»¥ä¸»æŸ¥è¯¢ä½œä¸ºé©±åŠ¨è¡¨ï¼Œè¿æ¥å­æŸ¥è¯¢çš„è¡¨æ—¶ï¼Œåªè¦åŒ¹é…åˆ°ä¸€æ¡è®°å½•å°±è¿”å›ã€‚

- Loose Scanï¼šåˆ©ç”¨å­æŸ¥è¯¢ä¸­ç´¢å¼•çš„æœ‰åºæ€§ï¼Œè·å–å…³è”æ¡ä»¶çš„å”¯ä¸€å€¼ã€‚

Loose Scanæ˜¯åˆ©ç”¨å­æŸ¥è¯¢ä¸­çš„ç´¢å¼•ï¼Œæ¥è·å–ä¸€ç»„ä¸é‡å¤çš„æ•°æ®ï¼Œå’Œä¸»æŸ¥è¯¢è¿›è¡Œè¡¨è¿æ¥ã€‚

- Materializationï¼šå°†å­æŸ¥è¯¢çš„ç»“æœå­˜å‚¨åœ¨ä¸´æ—¶è¡¨ï¼Œä¸´æ—¶è¡¨å†å’Œçˆ¶è¡¨è¿›è¡Œå…³è”ã€‚

Materializationæ˜¯å…ˆå¯¹å­æŸ¥è¯¢çš„ç»“æœé›†è¿›è¡Œå»é‡ï¼Œç„¶åå†å’Œä¸»æŸ¥è¯¢è¿›è¡Œè¡¨è¿æ¥æ“ä½œã€‚

è¿™é‡Œçš„ç¬¬ä¸€ç§æ”¹å†™æ–¹å¼æ˜¯å…ˆå¯¹å­æŸ¥è¯¢ä¸­çš„æ•°æ®è¿›è¡Œå»é‡ï¼Œå¯¹åº”Materializationè¿™ç§è½¬æ¢æ–¹å¼ã€‚ç¬¬äºŒç§æ”¹å†™æ–¹å¼æ˜¯å…ˆJoinï¼Œç„¶åå†å»é‡ï¼Œå¯¹åº”Duplicate weedoutã€‚è¯„è®ºåŒºä¸­ @å¶æ˜ ä¹Ÿæä¾›äº†è¿™ä¸ªé—®é¢˜çš„è§£ç­”ã€‚

## ç¬¬23è®²

é—®é¢˜ï¼šæœ‰æ—¶å€™æˆ‘ä»¬ä¼šé‡åˆ°æ‰§è¡Œè®¡åˆ’é€‰æ‹©äº†é”™è¯¯çš„ç´¢å¼•ï¼Œå¯¼è‡´SQLæ€§èƒ½æ¯”è¾ƒå·®ã€‚ä¸€ä¸ªå¯èƒ½çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨force indexå¼ºåˆ¶ç´¢å¼•ã€‚ä½¿ç”¨force indexå¯èƒ½ä¼šå­˜åœ¨å“ªäº›æ½œåœ¨çš„é£é™©ï¼Ÿæœ‰æ²¡æœ‰å…¶ä»–åŠæ³•æ¥é¿å…æ‰§è¡Œè®¡åˆ’é€‰é”™ç´¢å¼•ï¼Ÿ

@å¶æ˜ @Geek\_c37964 @é™ˆæ˜Ÿå®‡(2.11) åœ¨è¯„è®ºåŒºä¸­æä¾›äº†ä¸€äº›è§£ç­”ã€‚

å…ˆæ¥çœ‹ä¸€ä¸‹force indexçš„ä¸€äº›ç‰¹ç‚¹ã€‚

- force indexå¯ä»¥æŒ‡å®šå¤šä¸ªç´¢å¼•ï¼Œæ¯”å¦‚force index(idx\_a, idx\_b, idx\_c)
- å¦‚æœforce indexä¸­æŒ‡å®šçš„æŸä¸ªç´¢å¼•åœ¨è¡¨ä¸­ä¸å­˜åœ¨ï¼Œæˆ–è€…æ˜¯invisibleç´¢å¼•ï¼ŒSQLä¼šæŠ¥é”™
- å¦‚æœä½¿ç”¨äº†force indexï¼Œé‚£ä¹ˆMySQLä¸ä¼šå†è€ƒè™‘ä½¿ç”¨ä¸åœ¨è¿™ä¸ªåˆ—è¡¨ä¸­çš„ç´¢å¼•ã€‚

æ¯”å¦‚idæ˜¯ä¸»é”®ï¼Œ ä¸‹é¢è¿™ä¸ªSQLä½¿ç”¨äº†force indexã€‚è™½ç„¶æœ‰ä¸»é”®çš„æ¡ä»¶ï¼Œä½†è¿˜æ˜¯ä¼šä½¿ç”¨å…¨è¡¨æ‰«æã€‚

```plain
select * from tab force index(idx_x) where id = 10
```

- å¦‚æœä½¿ç”¨äº†force indexï¼Œä¼˜åŒ–å™¨ä¼šè®¤ä¸ºå…¨è¡¨æ‰«æçš„æˆæœ¬æ˜¯æ— ç©·å¤§ã€‚å¦‚æœæŒ‡å®šçš„ç´¢å¼•å¯ä»¥ç”¨åˆ°ï¼Œä¼˜åŒ–å™¨å°±ä¸ä¼šä½¿ç”¨å…¨è¡¨æ‰«æã€‚

æ¯”å¦‚ä¸‹é¢è¿™ä¸ªæŸ¥è¯¢ï¼Œè¡¨tabä¸Šæœ‰ç´¢å¼•idx\_abc(a,b,c)ã€‚è™½ç„¶è¡¨ä¸­çš„æ‰€æœ‰è®°å½•éƒ½æ»¡è¶³a &gt;=0çš„æ¡ä»¶ï¼Œè¿™ç§æƒ…å†µä¸‹èµ°å…¨è¡¨æ‰«ææ•ˆç‡æ›´é«˜ï¼Œä½†æ˜¯ä¼˜åŒ–å™¨è¿˜æ˜¯ä¼šä½¿ç”¨idx\_abcçš„rangeè®¿é—®è·¯å¾„ã€‚

```plain
select * from tab force index(idx_abc) where a >=0 
```

å› æ­¤ä½¿ç”¨force indexæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ã€‚

1. å¦‚æœä½¿ç”¨äº†force indexï¼Œä¸èƒ½åˆ é™¤æˆ–ä¿®æ”¹åˆ—è¡¨ä¸­çš„ç´¢å¼•åï¼Œå¦åˆ™ä¼šå¯¼è‡´SQLæŠ¥é”™ã€‚
2. è¦ç¡®ä¿SQLä¸­ä¼ å…¥äº†æŒ‡å®šç´¢å¼•çš„å‰ç¼€å­—æ®µçš„æ¡ä»¶ã€‚
3. å¦‚æœæŸ¥è¯¢é€‰é”™äº†ç´¢å¼•ï¼Œè¦å…ˆåˆ†æä¸‹èµ°é”™ç´¢å¼•çš„åŸå› ã€‚æœ‰çš„æ—¶å€™æ˜¯å› ä¸ºè¡¨ä¸Šå­˜åœ¨ç›¸ä¼¼çš„ç´¢å¼•ï¼Œæ¯”å¦‚è¡¨ä¸Šå­˜åœ¨å¤šä¸ªå‰ç¼€ä¸€æ ·çš„ç´¢å¼•ã€‚æˆ–è€…ç°æœ‰çš„ç´¢å¼•ä¸å¤Ÿä¼˜åŒ–ã€‚å¦‚æœè°ƒæ•´ç´¢å¼•èƒ½è§£å†³ï¼Œå°±ä¼˜å…ˆè€ƒè™‘è°ƒæ•´ä¸‹ç´¢å¼•ã€‚

å¦‚æœæŸä¸ªç‰¹å®šçš„åœºæ™¯ä¸‹ä¼˜åŒ–å™¨çœŸçš„é€‰ä¸åˆ°æœ€ä¼˜çš„ç´¢å¼•å’Œæ‰§è¡Œè®¡åˆ’ï¼Œå¯ä»¥é€‚å½“ä½¿ç”¨force indexæç¤ºã€‚

## ç¬¬24è®²

é—®é¢˜ï¼šä¸‹é¢è¿™ç±»SQLæŒ‰å¤šä¸ªè¡¨çš„å­—æ®µæ¥æ’åºï¼Œè¯·åˆ†æä¸‹è¿™ä¹ˆæ’åºï¼Œå¯¹SQLæ€§èƒ½çš„å½±å“æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœåªä½¿ç”¨ä¸€ä¸ªè¡¨çš„å­—æ®µæ¥æ’åºï¼Œæ€§èƒ½ä¸Šä¼šæœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿ

```plain
select * 
from t1, t2, t3
where t1.c1 = t2.c1
and t2.c2 = t3.c3
order by t1.s1, t2.s2
limit 100;
```

è¿™ä¸ªé—®é¢˜ @å¶æ˜ åœ¨è¯„è®ºåŒºç»™å‡ºäº†è§£ç­”ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚

```plain
mysql> show indexes from tab;
+-------+------------+----------+--------------+-------------+-------------+
| Table | Non_unique | Key_name | Seq_in_index | Column_name | Cardinality |
+-------+------------+----------+--------------+-------------+-------------+
| tab   |          0 | PRIMARY  |            1 | id          |       10010 |
| tab   |          1 | idx_abc  |            1 | a           |           3 |
| tab   |          1 | idx_abc  |            2 | b           |       10000 |
| tab   |          1 | idx_abc  |            3 | c           |       10000 |
+-------+------------+----------+--------------+-------------+-------------+
```

å¦‚æœæ’åºå­—æ®µéƒ½æ¥è‡ªäºåŒä¸€ä¸ªè¡¨ï¼Œå¯ä»¥å…ˆå¯¹è¿™ä¸ªè¡¨è¿›è¡Œæ’åºï¼Œç„¶åå†è¿æ¥åˆ°å¦å¤–ä¸€ä¸ªè¡¨ã€‚

```plain
mysql> explain format=tree 
  select * 
  from tab t1, tab t2 
  where t1.id = t2.id 
  order by t1.b, t1.c 
  limit 10\G
*************************** 1. row ***************************
EXPLAIN: -> Limit: 10 row(s)  (cost=12089.17 rows=10)
    -> Nested loop inner join  (cost=12089.17 rows=10010)
        -> Sort: t1.b, t1.c  (cost=1160.67 rows=10010)
            -> Table scan on t1  (cost=1160.67 rows=10010)
        -> Single-row index lookup on t2 using PRIMARY (id=t1.id)  (cost=0.99 rows=1)
```

å¦‚æœæ’åºå­—æ®µæ¥è‡ªä¸åŒçš„è¡¨ï¼Œéœ€è¦å…ˆè¿›è¡Œè¡¨è¿æ¥ï¼Œæ•°æ®å†™åˆ°ä¸´æ—¶è¡¨ï¼Œç„¶åå†å¯¹ä¸´æ—¶è¡¨è¿›è¡Œæ’åºã€‚

```plain
mysql> explain format=tree 
  select * 
  from tab t1, tab t2 
  where t1.id = t2.id 
  order by t1.b, t2.c
  limit 10\G
*************************** 1. row ***************************
EXPLAIN: -> Limit: 10 row(s)
    -> Sort: t1.b, t2.c, limit input to 10 row(s) per chunk
        -> Stream results  (cost=12089.17 rows=10010)
            -> Nested loop inner join  (cost=12089.17 rows=10010)
                -> Table scan on t1  (cost=1160.67 rows=10010)
                -> Single-row index lookup on t2 using PRIMARY (id=t1.id)  (cost=0.99 rows=1)
```

å¯¹æ¯”è¿™ä¸¤ä¸ªSQLçš„optimizer\_traceï¼Œä½¿ç”¨å¤šä¸ªè¡¨çš„å­—æ®µæ’åºæ—¶ï¼Œresulting\_clause\_is\_simpleä¸ºFalseã€‚

```plain
{
  "optimizing_distinct_group_by_order_by": {
    "simplifying_order_by": {
      "original_clause": "`t1`.`b`,`t2`.`c`",
      "items": [
        {
          "item": "`t1`.`b`"
        },
        {
          "item": "`t2`.`c`"
        }
      ],
      "resulting_clause_is_simple": false,
      "resulting_clause": "`t1`.`b`,`t2`.`c`"
    }
  }
}
```
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ1ï¼‰</strong></div><ul>
<li><span>Geek_9ius3m</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯·é—®è€å¸ˆï¼Œæ˜¯ä»€ä¹ˆå¯¼è‡´äº†æ•°æ®åº“CPUå±…é«˜ä¸ä¸‹å‘¢ï¼Ÿå­¦äº†æ‚¨çš„è¯¾ç¨‹è¿˜æ˜¯æ²¡æœ‰ææ¸…æ¥šã€‚</p>2025-01-13</li><br/>
</ul>