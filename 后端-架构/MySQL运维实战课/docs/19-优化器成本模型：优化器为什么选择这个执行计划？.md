ä½ å¥½ï¼Œæˆ‘æ˜¯ä¿Šè¾¾ã€‚

ä¸Šä¸€è®²ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å››åå¤šä¸ªSQLï¼Œæ¼”ç¤ºäº†MySQLå„ç§ä¸åŒçš„æ‰§è¡Œè®¡åˆ’ã€‚å¯¹äºç»™å®šçš„ä¸€ä¸ªSQLè¯­å¥ï¼ŒMySQLä¸ºä»€ä¹ˆé€‰æ‹©äº†æŸä¸€ä¸ªæ‰§è¡Œè®¡åˆ’ï¼Œè€Œæ²¡æœ‰é‡‡ç”¨å…¶ä»–çš„æ‰§è¡Œè®¡åˆ’å‘¢ï¼Ÿä¼˜åŒ–å™¨ä¼šè¯„ä¼°æ¯ä¸€ä¸ªå¯èƒ½çš„æ‰§è¡Œè®¡åˆ’çš„æˆæœ¬ï¼Œä»ä¸­é€‰æ‹©ä¸€ä¸ªæˆæœ¬æœ€ä½çš„ä½œä¸ºæœ€ç»ˆçš„æ‰§è¡Œè®¡åˆ’ã€‚è¿™ä¸€è®²ä¸­æˆ‘ä»¬å°±æ¥èŠä¸€èŠæ‰§è¡Œè®¡åˆ’çš„æˆæœ¬æ˜¯æ€ä¹ˆè®¡ç®—çš„ã€‚

## SQLé¢„å¤„ç†

ä¸€ä¸ªSQLï¼Œåœ¨è¿›è¡Œå…·ä½“çš„æˆæœ¬è®¡ç®—ä¹‹å‰ï¼Œä¼šå…ˆè¿›è¡Œä¸€ç³»åˆ—çš„é¢„å¤„ç†ã€‚é¦–å…ˆéœ€è¦å¯¹SQLæ–‡æœ¬è¿›è¡Œè¯æ³•åˆ†æå’Œè¯­æ³•è§£æï¼Œç”Ÿæˆè¯­æ³•æ ‘ã€‚ç„¶ååŸºäºå…³ç³»ä»£æ•°çš„ä¸€äº›åŸºæœ¬è§„åˆ™ï¼Œå¯¹SQLè¯­å¥è¿›è¡Œè½¬æ¢å’Œæ”¹å†™ã€‚

å¸¸è§çš„æ”¹å†™æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ã€‚

- ç­‰å€¼æ¡ä»¶ä¼ æ’­

å¦‚æœA=Bï¼Œå¹¶ä¸”B=Cï¼Œåˆ™A=Cã€‚

ä¸‹é¢è¿™ä¸ªSQLä¸­ï¼ŒåŸå§‹æ¡ä»¶æ˜¯t1.a = t2.a and t2.a = t3.aï¼Œè½¬æ¢åï¼Œå¾—åˆ°t1.a = t2.a and t1.a = t3.aï¼Œè§‚å¯Ÿæ‰§è¡Œè®¡åˆ’ä¸­çš„refåˆ—å°±å¯ä»¥çœ‹åˆ°è¿™ä¸€ç‚¹ã€‚

```plain
mysql> explain select * from tab t1, tab t2, tab t3 
  where t1.a = t2.a 
  and t2.a = t3.a;

+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+-------+
| id | select_type | table | type | possible_keys | key     | key_len | ref      | rows | filtered | Extra |
+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+-------+
|  1 | SIMPLE      | t1    | ALL  | idx_abc       | NULL    | NULL    | NULL     | 9913 |   100.00 | NULL  |
|  1 | SIMPLE      | t2    | ref  | idx_abc       | idx_abc | 4       | rep.t1.a | 3304 |   100.00 | NULL  |
|  1 | SIMPLE      | t3    | ref  | idx_abc       | idx_abc | 4       | rep.t1.a | 3304 |   100.00 | NULL  |
+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+-------+
```

- å¸¸é‡ä¼ æ’­

å¦‚æœA=Bï¼Œå¹¶ä¸” B=1ï¼Œé‚£ä¹ˆå¯ä»¥å¾—åˆ°A=1ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œ é€šè¿‡show warningså¯ä»¥çœ‹åˆ°ï¼ŒWHEREæ¡ä»¶è¢«å†™æˆäº†t1.a = 1 and t2.b = 1ã€‚

```plain
mysql> explain select * from tab t1, tab t2    where t1.a = t2.b and t2.b = 1;
+----+-------------+-------+------+---------------+------+---------+------+------+----------+--------------------------------------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                      |
+----+-------------+-------+------+---------------+------+---------+------+------+----------+--------------------------------------------+
|  1 | SIMPLE      | t2    | ALL  | NULL          | NULL | NULL    | NULL | 9913 |    10.00 | Using where                                |
|  1 | SIMPLE      | t1    | ALL  | idx_abc       | NULL | NULL    | NULL | 9913 |    33.62 | Using where; Using join buffer (hash join) |
+----+-------------+-------+------+---------------+------+---------+------+------+----------+--------------------------------------------+

mysql> show warnings\G
*************************** 1. row ***************************
  Level: Note
   Code: 1003
Message: /* select#1 */ select `rep`.`t1`.`id` AS `id`,`rep`.`t1`.`a` AS `a`,
     `rep`.`t1`.`b` AS `b`,`rep`.`t1`.`c` AS `c`,`rep`.`t1`.`padding` AS `padding`,
     `rep`.`t2`.`id` AS `id`,`rep`.`t2`.`a` AS `a`,`rep`.`t2`.`b` AS `b`,
     `rep`.`t2`.`c` AS `c`,`rep`.`t2`.`padding` AS `padding` 
  from `rep`.`tab` `t1` join `rep`.`tab` `t2` 
   where ((`rep`.`t2`.`b` = 1) 
   and (`rep`.`t1`.`a` = 1))
```

- ç§»é™¤é‡å¤æˆ–å¤šä½™çš„æ¡ä»¶

```plain
mysql> explain select * from tab where a = 5 and a between 1 and 10;
+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-------+
| id | select_type | table | type | possible_keys | key     | key_len | ref   | rows | filtered | Extra |
+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | tab   | ref  | idx_abc       | idx_abc | 4       | const |    1 |   100.00 | NULL  |
+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-------+
```

- ç§»é™¤æ°¸è¿œä¸ºçœŸçš„æ¡ä»¶

æ¡ä»¶1=1æ°¸è¿œæˆç«‹ï¼Œä¼˜åŒ–å™¨ä¼šç›´æ¥ç§»é™¤ç±»ä¼¼è¿™æ ·çš„æ¡ä»¶ã€‚

```plain
mysql> explain select * from tab where 1=1;
+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra |
+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------+
|  1 | SIMPLE      | tab   | ALL  | NULL          | NULL | NULL    | NULL | 9913 |   100.00 | NULL  |
+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------+
```

- å¯¹äºæ°¸è¿œæ— æ³•æ»¡è¶³çš„æ¡ä»¶ï¼Œç›´æ¥è¿”å›æ— æ•°æ®

ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œt1.a &lt; 0 and t1.a &gt; 0é€»è¾‘ä¸Šå°±ä¸æˆç«‹ï¼Œå› æ­¤æŸ¥è¯¢å¯ä»¥ç›´æ¥è¿”å›æ— æ•°æ®ã€‚

```plain
mysql> explain select * from tab t1, tab t2 
  where t1.a = t2.a and t1.a < 0 and t1.a > 0;
+----+-------------+-------+------+---------------+------+---------+------+------+----------+--------------------------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                          |
+----+-------------+-------+------+---------------+------+---------+------+------+----------+--------------------------------+
|  1 | SIMPLE      | NULL  | NULL | NULL          | NULL | NULL    | NULL | NULL |     NULL | no matching row in const table |
+----+-------------+-------+------+---------------+------+---------+------+------+----------+--------------------------------+
```

- å¤–è¿æ¥æ”¹å†™ä¸ºå†…è¿æ¥

ä¸‹é¢è¿™ä¸ªSQLä¸­ï¼Œç”±äºt2.a &gt; 0è¿™ä¸ªæ¡ä»¶ï¼Œleft joinè¢«è½¬æ¢æˆäº†æ™®é€šçš„joinã€‚

```plain
mysql> explain select * from tab t1 left join t2 on t1.a = t2.a where t2.a > 0;
+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+-------------+
| id | select_type | table | type | possible_keys | key     | key_len | ref      | rows | filtered | Extra       |
+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+-------------+
|  1 | SIMPLE      | t1    | ALL  | idx_abc       | NULL    | NULL    | NULL     | 9913 |    67.25 | Using where |
|  1 | SIMPLE      | t2    | ref  | idx_abc       | idx_abc | 4       | rep.t1.a | 3304 |   100.00 | NULL        |
+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+-------------+
    
mysql> show warnings\G
*************************** 1. row ***************************
  Level: Note
   Code: 1003
Message: /* select#1 */ select `rep`.`t1`.`id` AS `id`,`rep`.`t1`.`a` AS `a`,
    `rep`.`t1`.`b` AS `b`,`rep`.`t1`.`c` AS `c`,`rep`.`t1`.`padding` AS `padding`,
    `rep`.`t2`.`id` AS `id`,`rep`.`t2`.`a` AS `a`,`rep`.`t2`.`b` AS `b`,
    `rep`.`t2`.`c` AS `c`,`rep`.`t2`.`padding` AS `padding` 
from `rep`.`tab` `t1` join `rep`.`tab` `t2`
where ((`rep`.`t2`.`a` = `rep`.`t1`.`a`) 
and (`rep`.`t1`.`a` > 0))
```

- å­æŸ¥è¯¢è½¬æ¢ä¸ºSEMIJOIN

ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œå­æŸ¥è¯¢è¢«è½¬æ¢æˆäº†æ™®é€šçš„è¡¨è¿æ¥ã€‚æ³¨æ„åˆ°IDä¸º1çš„ä¸¤ä¸ªæŸ¥è¯¢å•å…ƒï¼Œselect\_typeéƒ½æ˜¯SIMPLEã€‚

```plain
mysql> explain select * from tab where a in (select b from tab);
+----+--------------+-------------+--------+---------------------+---------------------+---------+-----------+------+----------+-------------+
| id | select_type  | table       | type   | possible_keys       | key                 | key_len | ref       | rows | filtered | Extra       |
+----+--------------+-------------+--------+---------------------+---------------------+---------+-----------+------+----------+-------------+
|  1 | SIMPLE       | tab         | ALL    | idx_abc             | NULL                | NULL    | NULL      | 9913 |   100.00 | NULL        |
|  1 | SIMPLE       | <subquery2> | eq_ref | <auto_distinct_key> | <auto_distinct_key> | 4       | rep.tab.a |    1 |   100.00 | NULL        |
|  2 | MATERIALIZED | tab         | index  | NULL                | idx_abc             | 12      | NULL      | 9913 |   100.00 | Using index |
+----+--------------+-------------+--------+---------------------+---------------------+---------+-----------+------+----------+-------------+
```

å½“ç„¶ï¼Œæ»¡è¶³ä¸€å®šæ¡ä»¶çš„å­æŸ¥è¯¢æ‰èƒ½è½¬æ¢ä¸ºæ™®é€šçš„è¡¨è¿æ¥ï¼Œè€Œä¸”ä¸ºäº†SQLèƒ½æŸ¥è¯¢å¾—åˆ°ä¸€æ ·çš„æ•°æ®ï¼Œè½¬æ¢ä¸ºæ™®é€šè¡¨è¿æ¥åï¼Œè¿˜éœ€è¦è¿›è¡Œä¸€äº›ç‰¹æ®Šçš„å¤„ç†ã€‚åç»­æˆ‘ä»¬ä¼šæœ‰ä¸€è®²ä¸“é—¨ä»‹ç»å­æŸ¥è¯¢çš„è½¬æ¢ã€‚

## åŸºäºæˆæœ¬çš„ä¼˜åŒ–

MySQLä½¿ç”¨äº†åŸºäºæˆæœ¬çš„ä¼˜åŒ–å™¨ã€‚æˆ‘ä»¬é€šè¿‡ä¸€äº›å…·ä½“çš„ä¾‹å­æ¥è¯´æ˜æˆæœ¬çš„ä¸€äº›è®¡ç®—æ–¹å¼ã€‚

å…ˆåˆ›å»ºä¸€ä¸ªæµ‹è¯•è¡¨ï¼Œåˆå§‹åŒ–ä¸€äº›æ•°æ®ï¼Œè¿™é‡Œçš„numberså°±æ˜¯ä¸Šä¸€è®²å¼€å¤´åˆ›å»ºçš„é‚£ä¸ªè§†å›¾ã€‚

```plain
mysql> create table t_cost (
  id int not null auto_increment,
  a int not null,
  b int not null,
  c int not null,
  d int not null,
  padding varchar(7000) DEFAULT NULL,
  primary key (id),
  key idx_ac(a,c),
  key idx_bc(b,c)
) engine=InnoDB;

mysql> insert into t_cost (a,b,c,d, padding)
select n%6, n%1000, n%100, n%100, rpad('', 2000, 'ABCDEFG XYZ') 
from 
numbers;

mysql> analyze table t_cost;
```

æˆ‘ä»¬å…ˆæ¥çœ‹è¿™ä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’ã€‚

```plain
mysql> explain 
select * 
from t_cost 
where a=3 
and b between 90 and 100 
and c in (1,2,3,4,5,6,7,8,9,10)\G

*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: t_cost
   partitions: NULL
         type: range
possible_keys: idx_ac,idx_bc
          key: idx_bc
      key_len: 8
          ref: NULL
         rows: 110
     filtered: 2.00
        Extra: Using index condition; Using where
```

å¯¹äºä¸Šé¢è¿™ä¸ªSQLï¼Œä¼˜åŒ–å™¨æœ€ç»ˆä»å…¨è¡¨æ‰«æã€ä½¿ç”¨ç´¢å¼•idx\_acã€ä½¿ç”¨ç´¢å¼•idx\_bcè¿™å‡ ç§å¯èƒ½çš„è·¯å¾„ä¸­é€‰æ‹©äº†idx\_bcã€‚ä¼˜åŒ–å™¨è®¤ä¸ºé€šè¿‡ç´¢å¼•idx\_bcéœ€è¦è®¿é—®110è¡Œæ•°æ®ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¼˜åŒ–å™¨è·Ÿè¸ªæ¥æŸ¥çœ‹ä¼˜åŒ–å™¨çš„æ€è€ƒè¿‡ç¨‹ã€‚å…ˆè®¾ç½®ä¼šè¯å˜é‡optimizer\_traceï¼Œå†æ‰§è¡ŒSQLæˆ–Explainå‘½ä»¤ï¼Œç„¶åå°±å¯ä»¥ä»information\_schema.optimizer\_traceæŸ¥çœ‹ä¼˜åŒ–å™¨çš„è·Ÿè¸ªä¿¡æ¯äº†ã€‚

```plain
mysql> set optimizer_trace='enabled=on';
Query OK, 0 rows affected (0.00 sec)


mysql> select *  from t_cost  
  where a=3  
  and b between 90 and 100  
  and c in (1,2,3,4,5,6,7,8,9,10) ;
Empty set (0.01 sec)

mysql> select * from information_schema.optimizer_trace\G
*************************** 1. row ***************************
QUERY: select *  from t_cost  where a=3  and b between 90 and 100  
    and c in (1,2,3,4,5,6,7,8,9,10)
TRACE: {
  "steps": [
    {
      "join_preparation": {
        "select#": 1,
        "steps": [
          {
            "IN_uses_bisection": true
          },
          {
......
```

optimizer\_traceçš„è¾“å‡ºå†…å®¹æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…¶ä¸­æ¯”è¾ƒå…³é”®çš„å‡ ä¸ªéƒ¨åˆ†ã€‚

- table\_scan

table\_scanéƒ¨åˆ†è®°å½•äº†å…¨è¡¨æ‰«æçš„æˆæœ¬ï¼Œè¿™é‡Œæ˜¯æ‰«æ8580è¡Œè®°å½•ï¼Œæˆæœ¬æ˜¯1220.85ã€‚

```plain
{
  "rows_estimation": [
    {
      "table": "`t_cost`",
      "range_analysis": {
        "table_scan": {
          "rows": 8580,
          "cost": 1220.85
        }
```

- range\_scan\_alternatives

range\_scan\_alternativesä¸­è®°å½•äº†ç´¢å¼•æ‰«æçš„æˆæœ¬ï¼Œä¼˜åŒ–å™¨åˆ†åˆ«è®¡ç®—äº†ä½¿ç”¨idx\_acå’Œidx\_bcè¿™ä¸¤ä¸ªç´¢å¼•çš„è®¿é—®æˆæœ¬ã€‚ä½¿ç”¨idx\_acæ—¶ï¼Œéœ€è¦æ‰«æ172è¡Œæ•°æ®ï¼Œæˆæœ¬æ˜¯62.71ã€‚ä½¿ç”¨idx\_bcæ—¶ï¼Œéœ€è¦æ‰«æ110è¡Œæ•°æ®ï¼Œæˆæœ¬æ˜¯38.76ã€‚

```plain
"analyzing_range_alternatives": {
 "range_scan_alternatives": [
   {
     "index": "idx_ac",
     "ranges": [
       "a = 3 AND c = 1",
       "a = 3 AND c = 2",
       "a = 3 AND c = 3",
       "a = 3 AND c = 4",
       "a = 3 AND c = 5",
       "a = 3 AND c = 6",
       "a = 3 AND c = 7",
       "a = 3 AND c = 8",
       "a = 3 AND c = 9",
       "a = 3 AND c = 10"
     ],
     "index_dives_for_eq_ranges": true,
     "rowid_ordered": false,
     "using_mrr": false,
     "index_only": false,
     "in_memory": 1,
     "rows": 172,
     "cost": 62.71,
     "chosen": true
   },
   {
     "index": "idx_bc",
     "ranges": [
       "90 <= b <= 100"
     ],
     "index_dives_for_eq_ranges": true,
     "rowid_ordered": false,
     "using_mrr": false,
     "index_only": false,
     "in_memory": 1,
     "rows": 110,
     "cost": 38.76,
     "chosen": true
   }
 ]
```

- best\_access\_path

best\_access\_pathè®°å½•äº†ä¼˜åŒ–å™¨æœ€ç»ˆé€‰æ‹©çš„æ‰§è¡Œè®¡åˆ’ï¼Œç”±äºä½¿ç”¨idx\_bcæˆæœ¬æœ€ä½ï¼Œä¼˜åŒ–å™¨æœ€ç»ˆé€‰æ‹©äº†è¿™ä¸ªæ‰§è¡Œè®¡åˆ’ã€‚

```plain
"best_access_path": {
  "considered_access_paths": [
    {
      "access_type": "ref",
      "index": "idx_ac",
      "chosen": false,
      "cause": "range_uses_more_keyparts"
    },
    {
      "rows_to_scan": 110,
      "access_type": "range",
      "range_details": {
        "used_index": "idx_bc"
      },
      "resulting_rows": 110,
      "cost": 49.76,
      "chosen": true
    }
  ]
}
```

ä¼˜åŒ–å™¨æ˜¯æ€ä¹ˆæ¥è¯„ä¼°è¿™å‡ ç§ä¸åŒçš„æ‰§è¡Œè·¯å¾„çš„æˆæœ¬çš„å‘¢ï¼Ÿæ‰§è¡Œè·¯å¾„çš„æˆæœ¬ä¸»è¦ç”±IOæˆæœ¬å’ŒCPUæˆæœ¬ç»„æˆã€‚

- IOæˆæœ¬

IOæˆæœ¬æ˜¯ä»å†…å­˜æˆ–ç£ç›˜ä¸­è¯»å†™æ•°æ®å—çš„æˆæœ¬ã€‚å¦‚æœæŸ¥è¯¢æ¶‰åŠåˆ°ç‰©åŒ–æ“ä½œï¼ŒIOæˆæœ¬è¿˜åŒ…æ‹¬åˆ›å»ºä¸´æ—¶è¡¨ã€è¯»å†™ä¸´æ—¶è¡¨çš„æˆæœ¬ã€‚IOæˆæœ¬å’Œéœ€è¦è®¿é—®çš„æ•°æ®å—çš„æ•°é‡ç›¸å…³ã€‚

- CPUæˆæœ¬

CPUæˆæœ¬åŒ…æ‹¬è¡Œè¯„ä¼°æˆæœ¬ï¼ˆè¡Œè¯„ä¼°æˆæœ¬å¯ä»¥ç†è§£ä¸ºåˆ¤æ–­ä¸€è¡Œè®°å½•æ˜¯å¦æ»¡è¶³SQLè¡¨è¾¾å¼ä¸­çš„æ¡ä»¶ï¼‰ï¼ŒKEYæ¯”è¾ƒçš„æˆæœ¬ï¼ˆæ¯”å¦‚åœ¨è¿›è¡Œæ’åºæ“ä½œæ—¶ï¼Œéœ€è¦æ¯”è¾ƒè®°å½•æ’åºå­—æ®µçš„å¤§å°ï¼‰ã€‚

å…·ä½“æ€ä¹ˆè®¡ç®—IOæˆæœ¬å’ŒCPUæˆæœ¬å‘¢ï¼Ÿ

### ä¼˜åŒ–å™¨æˆæœ¬æ¨¡å‹

é¦–å…ˆä¼˜åŒ–å™¨æœ‰ä¸€ä¸ªæˆæœ¬æ¨¡å‹ï¼Œè®¾ç½®äº†ä¸€äº›åŸºæœ¬æ“ä½œçš„æˆæœ¬ï¼Œæ¯”å¦‚è¯»å–1ä¸ªæ•°æ®å—çš„æˆæœ¬æ˜¯å¤šå°‘ã€è¯„ä¼°1è¡Œè®°å½•çš„æˆæœ¬æ˜¯å¤šå°‘ã€‚æˆ‘æŠŠä¼˜åŒ–å™¨ä¸­çš„æˆæœ¬æ¨¡å‹å¸¸é‡æ•´ç†æˆäº†ä¸‹é¢è¿™ä¸¤ä¸ªè¡¨æ ¼ï¼Œä½ å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚

- Serverå±‚å¸¸é‡

<!--THE END-->

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/36/34/3602c82ba75fef40a3f642f0fb90e634.png?wh=1920x905)

- å­˜å‚¨å¼•æ“å±‚å¸¸é‡

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/ab/d1/ab4fed7807460246539455f7432078d1.png?wh=1920x472)

ä¸Šé¢è¿™ä¸¤ä¸ªè¡¨æ ¼ä¸­å¸¸é‡çš„å–å€¼ä»MySQL 8.0.32çš„ä»£ç ä¸­è·å–ã€‚ä¸åŒçš„ç‰ˆæœ¬å¯èƒ½ä¼šè®¾ç½®ä¸åŒçš„é»˜è®¤å€¼ï¼Œå¦‚æœä½ å»çœ‹5.7ç‰ˆæœ¬çš„æºç ï¼Œä¼šå‘ç°æœ‰äº›å¸¸é‡çš„å€¼ä¸ä¸€æ ·ã€‚ä¸€èˆ¬æˆ‘ä»¬å¹¶ä¸éœ€è¦ä¿®æ”¹è¿™äº›å¸¸é‡ï¼Œä¹Ÿä¸éœ€è¦çŸ¥é“è¿™äº›å¸¸é‡çš„å…·ä½“å–å€¼ï¼Œåªæœ‰å½“æˆ‘ä»¬æƒ³çŸ¥é“æŸä¸ªæˆæœ¬å€¼å…·ä½“æ˜¯å¦‚ä½•è®¡ç®—å¾—åˆ°çš„æ—¶å€™ï¼Œæ‰ä¼šç”¨åˆ°è¿™äº›å¸¸é‡ã€‚

ä½ è¿˜å¯ä»¥é€šè¿‡ä¿®æ”¹mysqlåº“ä¸­çš„server\_costå’Œengine\_costè¿™2ä¸ªè¡¨æ¥æ”¹å˜æŸä¸ªæˆæœ¬å¸¸é‡çš„å€¼ï¼Œå½“ç„¶ä¸€èˆ¬ä¸ä¼šå»ä¿®æ”¹è¿™äº›å€¼ã€‚

```plain
mysql> select cost_name, cost_value, default_value from mysql.server_cost;
+------------------------------+------------+---------------+
| cost_name                    | cost_value | default_value |
+------------------------------+------------+---------------+
| disk_temptable_create_cost   |       NULL |            20 |
| disk_temptable_row_cost      |       NULL |           0.5 |
| key_compare_cost             |       NULL |          0.05 |
| memory_temptable_create_cost |       NULL |             1 |
| memory_temptable_row_cost    |       NULL |           0.1 |
| row_evaluate_cost            |       NULL |           0.1 |
+------------------------------+------------+---------------+
6 rows in set (0.00 sec)

mysql> select engine_name, device_type, cost_name, cost_value, default_value 
    from mysql.engine_cost;
+-------------+-------------+------------------------+------------+---------------+
| engine_name | device_type | cost_name              | cost_value | default_value |
+-------------+-------------+------------------------+------------+---------------+
| default     |           0 | io_block_read_cost     |       NULL |             1 |
| default     |           0 | memory_block_read_cost |       NULL |          0.25 |
+-------------+-------------+------------------------+------------+---------------+
```

å¦‚æœä½ æ›´æ–°äº†è¿™ä¸¤ä¸ªè¡¨ï¼Œè¦æ‰§è¡ŒFLUSH OPTIMIZER\_COSTSå‘½ä»¤åæ‰ä¼šçœŸæ­£ç”Ÿæ•ˆã€‚

### æˆæœ¬è®¡ç®—

MySQLæ€ä¹ˆè¯„ä¼°æŸä¸ªæ‰§è¡Œè®¿é—®è·¯å¾„éœ€è¦è¯»å–å¤šå°‘ä¸ªæ•°æ®å—ã€æ‰«æå¤šå°‘è¡Œæ•°æ®å‘¢ï¼Ÿè¿™é‡Œåˆ†ä¸ºå‡ ç§æƒ…å†µã€‚å¯¹äºå…¨è¡¨æ‰«æï¼ŒMySQLä¼šé€šè¿‡ç»Ÿè®¡ä¿¡æ¯æ¥ä¼°ç®—ã€‚å¯¹äºç´¢å¼•è®¿é—®ï¼ŒMySQLä¼šä½¿ç”¨Index Diveæœºåˆ¶æ¥è¯„ä¼°è¡Œæ•°ï¼Œæˆ–è€…ä½¿ç”¨ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯æ¥è¯„ä¼°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†åˆ«ä»‹ç»è¿™å‡ ç§æƒ…å†µã€‚

#### å…¨è¡¨æ‰«ææˆæœ¬è®¡ç®—

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/a6/8e/a66217358cd599b4ce9a8bfa814e9a8e.jpg?wh=1132x373)

å…¨è¡¨æ‰«æéœ€è¦è¯»å–è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®é¡µã€‚å…¨è¡¨æ‰«æçš„æˆæœ¬ä¼šæ ¹æ®è¡¨çš„ç»Ÿè®¡ä¿¡æ¯æ¥è¯„ä¼°ã€‚InnoDBè¡¨çš„ç»Ÿè®¡ä¿¡æ¯å­˜å‚¨åœ¨mysql.innodb\_table\_statsè¡¨ä¸­ã€‚åœ¨æˆ‘ä»¬çš„æµ‹è¯•è¡¨ä¸­ï¼Œç»Ÿè®¡ä¿¡æ¯æ˜¯è¿™æ ·çš„ã€‚

```plain
mysql> select * from mysql.innodb_table_stats where table_name = 't_cost'\G
*************************** 1. row ***************************
           database_name: rep
              table_name: t_cost
             last_update: 2024-08-22 16:14:21
                  n_rows: 8580
    clustered_index_size: 1443
sum_of_other_index_sizes: 46
```

è¿™å‡ ä¸ªå­—æ®µçš„å«ä¹‰æˆ‘æ•´ç†åˆ°è¡¨æ ¼ä¸­äº†ï¼Œä¾›ä½ å‚è€ƒã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/a3/60/a3343bdede38a11d3c9d8a992b6f2060.png?wh=1920x868)

æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹å‰é¢å…¨è¡¨æ‰«æçš„æˆæœ¬ã€‚

```plain
"table_scan": {
  "rows": 8580,
  "cost": 1220.85
}
```

è®¿é—®è¡Œæ•°rowså°±æ˜¯ä»ç»Ÿè®¡ä¿¡æ¯ä¸­ç›´æ¥è·å–çš„ã€‚è®¿é—®æˆæœ¬çš„è®¡ç®—å…¬å¼ï¼Œæˆ‘ä½¿ç”¨ä¸‹é¢è¿™æ®µpythonä»£ç æ¥è¡¨ç¤ºã€‚

```plain
ROW_EVALUATE_COST = 0.1
MEMORY_BLOCK_READ_COST = 0.25
IO_BLOCK_READ_COST = 1

def io_cost(pages, in_mem_pct):
    in_mem_pages = pages * in_mem_pct
    disk_pages = pages - in_mem_pages
    cost = in_mem_pages * MEMORY_BLOCK_READ_COST + disk_pages * IO_BLOCK_READ_COST
    return cost

def row_eval_cost(rows):
    cost = rows * ROW_EVALUATE_COST
    return cost
    
def scan_cost(pages, rows, in_mem_pct):
    cost = io_cost(pages, in_mem_pct)
    row_cost = row_eval_cost(rows)
    return cost + row_cost + 1.1 + 1
```

å‡½æ•°scan\_costçš„å‚æ•°ä¸­ï¼Œpagesæ˜¯è¡¨ç»Ÿè®¡ä¿¡æ¯ä¸­çš„clustered\_index\_sizeå­—æ®µï¼Œrowsæ˜¯ç»Ÿè®¡ä¿¡æ¯ä¸­çš„n\_rowså­—æ®µï¼Œin\_mem\_pctæ˜¯è¡¨ç¼“å­˜åœ¨å†…å­˜ä¸­çš„ä¸€ä¸ªé¢„ä¼°çš„æ¯”ä¾‹ï¼Œåœ¨æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­ï¼Œç¼“å­˜ç‡æ˜¯100ã€‚è®¡ç®—å…¨è¡¨æ‰«æçš„æˆæœ¬æ—¶ï¼Œä¼˜åŒ–å™¨è¿˜åŠ ä¸Šäº†ä¸€äº›å›ºå®šçš„æˆæœ¬ï¼Œå°±æ˜¯å…¬å¼ä¸­çš„ 1.1 + 1ã€‚  
å°†ç»Ÿè®¡ä¿¡æ¯ä¸­çš„æ•°æ®ä»£å…¥scan\_costå‡½æ•°ï¼Œå°±å¾—åˆ°äº†å…¨è¡¨æ‰«æçš„æˆæœ¬1220.85ã€‚

```plain
>>> scan_cost(pages=1443, rows=8580, in_mem_pct=1.0)
1220.85
```

#### ç´¢å¼•è®¿é—®æˆæœ¬è®¡ç®—

æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸‹ç´¢å¼•è®¿é—®çš„å¤§è‡´æ­¥éª¤ã€‚ä¸‹é¢è¿™å¼ å›¾æè¿°äº†æ™®é€šéè¦†ç›–ç´¢å¼•çš„è®¿é—®æ­¥éª¤ã€‚

1. æ ¹æ®ç´¢å¼•æ¡ä»¶ï¼Œåœ¨ç´¢å¼•ä¸­å®šä½åˆ°ç´¢å¼•æ¡ç›®ã€‚
2. æ ¹æ®ç´¢å¼•æ¡ç›®ä¸­çš„ä¸»é”®ä¿¡æ¯ï¼Œåˆ°èšç°‡ç´¢å¼•ä¸­æŸ¥æ‰¾æ•°æ®ã€‚

ä¸€ä¸ªSQLä¸­ï¼Œå¯èƒ½éœ€è¦è®¿é—®å¤šä¸ªç´¢å¼•èŒƒå›´ï¼Œæ¯”å¦‚åœ¨whereä¸­ä½¿ç”¨äº†oræˆ–è€…inæ¡ä»¶ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/c6/75/c62f9f5ab202a373eyy4d53be20aaa75.png?wh=1920x873)

ä»ä¸Šé¢çš„ç¤ºæ„å›¾ä¸­ï¼Œå¯ä»¥çœ‹å‡ºç´¢å¼•è®¿é—®çš„æˆæœ¬ä¸»è¦åŒ…æ‹¬ï¼š

1. éœ€è¦è®¿é—®çš„ç´¢å¼•æ¡ç›®æ•°é‡ï¼Œä»¥åŠè¿™äº›æ¡ç›®åˆ†å¸ƒåœ¨å¤šå°‘ä¸ªé¡µé¢ä¸­ã€‚
2. ç´¢å¼•çš„åŒºé—´æ•°é‡ã€‚
3. éœ€è¦è¯»å–çš„InnoDBèšç°‡ç´¢å¼•çš„é¡µé¢æ•°é‡ã€‚

æˆ‘ä»¬å›é¡¾ä¸‹æµ‹è¯•æ¡ˆä¾‹ä¸­ä¸¤ä¸ªç´¢å¼•çš„è®¿é—®æˆæœ¬ã€‚ä½¿ç”¨ç´¢å¼•idx\_acéœ€è¦è®¿é—®10ä¸ªåŒºé—´ï¼Œæ€»å…±172è¡Œè®°å½•ï¼Œæˆæœ¬æ˜¯62.71ã€‚

```plain
{
  "index": "idx_ac",
  "ranges": [
    "a = 3 AND c = 1",
    "a = 3 AND c = 2",
    "a = 3 AND c = 3",
    "a = 3 AND c = 4",
    "a = 3 AND c = 5",
    "a = 3 AND c = 6",
    "a = 3 AND c = 7",
    "a = 3 AND c = 8",
    "a = 3 AND c = 9",
    "a = 3 AND c = 10"
  ],
  "index_dives_for_eq_ranges": true,
  "rowid_ordered": false,
  "using_mrr": false,
  "index_only": false,
  "in_memory": 1,
  "rows": 172,
  "cost": 62.71,
  "chosen": true
}
```

ä½¿ç”¨ç´¢å¼•idx\_bcéœ€è¦è®¿é—®1ä¸ªåŒºé—´ï¼Œ110è¡Œè®°å½•ï¼Œæˆæœ¬æ˜¯38.76ã€‚

```plain
   
{
  "index": "idx_bc",
  "ranges": [
    "90 <= b <= 100"
  ],
  "index_dives_for_eq_ranges": true,
  "rowid_ordered": false,
  "using_mrr": false,
  "index_only": false,
  "in_memory": 1,
  "rows": 110,
  "cost": 38.76,
  "chosen": true
}
```

å¯ä»¥çœ‹åˆ°ï¼Œç´¢å¼•è®¿é—®æ—¶ï¼Œéœ€è¦æ‰«æçš„è®°å½•æ•°å†³å®šäº†è®¿é—®çš„æˆæœ¬ã€‚é‚£ä¹ˆä¼˜åŒ–å™¨æ€ä¹ˆçŸ¥é“ï¼Œè®¿é—®ç´¢å¼•çš„æŸä¸€ä¸ªåŒºé—´æ—¶ï¼Œéœ€è¦æ‰«æå¤šå°‘è¡Œè®°å½•å‘¢ï¼ŸInnoDBä½¿ç”¨äº†index diveæœºåˆ¶æ¥è¯„ä¼°è®°å½•æ•°ã€‚ç®€å•åœ°è¯´ï¼Œindex diveå°±æ˜¯æ ¹æ®åŒºé—´çš„è¾¹ç•Œå€¼ï¼Œåˆ°ç´¢å¼•ä¸­ç»Ÿè®¡åŒºé—´å†…çš„è®°å½•æ•°ï¼Œåç»­æˆ‘ä»¬å†å¯¹index diveçš„åŸç†åšè¿›ä¸€æ­¥ä»‹ç»ï¼Œè¿™é‡Œå…ˆè®°ä½ä¸€ä¸ªç»“è®ºï¼š**ä½¿ç”¨index diveæœºåˆ¶é€šå¸¸èƒ½å¾—åˆ°è®°å½•æ•°æ¯”è¾ƒå‡†ç¡®çš„ä¸€ä¸ªä¼°è®¡ã€‚**

å¾—åˆ°ç´¢å¼•åŒºé—´å†…çš„è®°å½•æ•°ä¹‹åï¼Œï¼ˆéè¦†ç›–ç´¢å¼•ï¼‰ç´¢å¼•è®¿é—®æˆæœ¬çš„è®¡ç®—å…¬å¼ï¼Œæˆ‘ä½¿ç”¨ä¸‹é¢è¿™æ®µpythonä»£ç æ¥è¡¨ç¤ºã€‚

```plain
MEMORY_BLOCK_READ_COST = 0.25
IO_BLOCK_READ_COST = 1
ROW_EVALUATE_COST = 0.1

def row_evaluate_cost(rows):
    return rows * ROW_EVALUATE_COST

def page_read_cost(in_mem_pct):
    return MEMORY_BLOCK_READ_COST * in_mem_pct + IO_BLOCK_READ_COST * (1-in_mem_pct)

def range_normal_io_cost(ranges, rows, in_mem_pct):
    pages = ranges + rows
    result = pages * page_read_cost(in_mem_pct)
    return result

def range_normal_cost(ranges, rows, in_mem_pct):
    io_cost = range_normal_io_cost(ranges, rows, in_mem_pct)
    result = io_cost + row_evaluate_cost(rows) + 0.01
    return result
```

ç´¢å¼•è®¿é—®æˆæœ¬ç”±IOæˆæœ¬å’Œè¡Œè¯„ä¼°æˆæœ¬ç»„æˆã€‚è€ŒIOçš„æ¬¡æ•°æ˜¯æ€ä¹ˆè¯„ä¼°çš„å‘¢ï¼Ÿ MySQLè®¤ä¸ºæ¯ä¸€è¡Œè®°å½•éœ€è¦è®¿é—®1æ¬¡IOï¼Œæ­¤å¤–ï¼Œæ¯ä¸€ä¸ªåŒºé—´éœ€è¦è®¿é—®1æ¬¡IOã€‚

æ ¹æ®ä¸Šé¢çš„å…¬å¼ï¼Œå¯ä»¥è®¡ç®—å‡ºæˆ‘ä»¬ä¾‹å­ä¸­ä¸¤ä¸ªç´¢å¼•çš„è®¿é—®æˆæœ¬ã€‚

ç´¢å¼•idx\_acçš„è®¿é—®æˆæœ¬ï¼š

```plain
>>> range_normal_cost(ranges=10, rows=172, in_mem_pct=1.0)
62.71
```

ç´¢å¼•index\_bcçš„è®¿é—®æˆæœ¬ï¼š

```plain
>>> range_normal_cost(ranges=1,  rows=110, in_mem_pct=1.0)
38.76
```

æˆ‘ä»¬è¿™é‡Œä»‹ç»äº†éè¦†ç›–ç´¢å¼•rangeæ‰§è¡Œè·¯å¾„ä¸‹çš„è®¿é—®æˆæœ¬ã€‚å®é™…ä¸Šç´¢å¼•è®¿é—®è¿˜å­˜åœ¨å…¶ä»–æƒ…å†µï¼Œæ¯”å¦‚ä¸Šä¸€è®²ä¸­è®²åˆ°ï¼Œæœ‰ä¸€ç§refçš„è®¿é—®è·¯å¾„ï¼Œæ­¤å¤–ï¼Œè¿˜å­˜åœ¨è¦†ç›–ç´¢å¼•çš„æƒ…å†µï¼Œè¿™äº›æƒ…å†µä¸‹ï¼Œç´¢å¼•è®¿é—®çš„æˆæœ¬è®¡ç®—æ–¹å¼ä¼šæœ‰ä¸€äº›å·®å¼‚ï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²å†å…·ä½“åˆ†æã€‚

#### ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯çš„ä½œç”¨

ä½¿ç”¨index diveé€šå¸¸èƒ½å¾—åˆ°ç´¢å¼•åŒºé—´å†…è®°å½•æ•°æ¯”è¾ƒå‡†ç¡®çš„ä¸€ä¸ªä¼°è®¡ã€‚ä½†æ˜¯æœ‰äº›æƒ…å†µä¸‹ï¼Œå¹¶ä¸èƒ½ä½¿ç”¨index diveæœºåˆ¶ã€‚æ¯”å¦‚åœ¨è¡¨è¿æ¥çš„æ—¶å€™ï¼Œè¿æ¥æ¡ä»¶æ¥è‡ªäºé©±åŠ¨è¡¨ï¼Œè€Œä¼˜åŒ–å™¨å¹¶ä¸çŸ¥é“è¿æ¥æ¡ä»¶çš„å…·ä½“å–å€¼ï¼Œå› æ­¤æ— æ³•ä½¿ç”¨index diveã€‚å¦å¤–ä¸€ç§æƒ…å†µæ˜¯ï¼Œå¦‚æœå¾…æŸ¥è¯¢çš„åŒºé—´æ•°é‡ç‰¹åˆ«å¤šï¼Œå¯¹æ¯ä¸€ä¸ªåŒºé—´éƒ½åšä¸€æ¬¡index diveçš„å¼€é”€å¤ªå¤§äº†ã€‚å½“åŒºé—´çš„æ•°é‡è¶…è¿‡å‚æ•°eq\_range\_index\_dive\_limitçš„è®¾ç½®æ—¶ï¼Œä¼˜åŒ–å™¨å°±ä¼šæ”¾å¼ƒindex diveã€‚

æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹è¿™ç§æƒ…å†µã€‚

```plain
mysql> explain select * from t_cost 
  where b in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15) 
  and c in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15);
+----+-------------+--------+-------+---------------+--------+---------+------+------+----------+-----------------------+
| id | select_type | table  | type  | possible_keys | key    | key_len | ref  | rows | filtered | Extra                 |
+----+-------------+--------+-------+---------------+--------+---------+------+------+----------+-----------------------+
|  1 | SIMPLE      | t_cost | range | idx_bc        | idx_bc | 8       | NULL | 1800 |   100.00 | Using index condition |
+----+-------------+--------+-------+---------------+--------+---------+------+------+----------+-----------------------+
```

eq\_range\_index\_dive\_limité»˜è®¤ä¸º200ï¼Œä¸Šé¢è¿™ä¸ªæµ‹è¯•SQLä¸­ï¼Œæ€»å…±æœ‰225ä¸ªåŒºé—´ï¼Œå› æ­¤ä¼˜åŒ–å™¨ä¼šæ”¾å¼ƒä½¿ç”¨index diveã€‚

ä»optimizer traceä¸­ï¼Œå¯ä»¥çœ‹åˆ°index\_dives\_for\_eq\_rangesä¸ºfalseï¼Œrowsä¸º1800ï¼Œæˆæœ¬ä¸º686.26ã€‚

```plain
{
  "index": "idx_bc",
  "ranges": [
    "b = 1 AND c = 1",
    "b = 1 AND c = 2",
    "b = 1 AND c = 3",
   ......
    "b = 15 AND c = 14",
    "b = 15 AND c = 15"
  ],
  "index_dives_for_eq_ranges": false,
  "rowid_ordered": false,
  "using_mrr": false,
  "index_only": false,
  "in_memory": 0,
  "rows": 1800,
  "cost": 686.26,
  "chosen": true
}
```

æ ¹æ®å‰é¢çš„è®¡ç®—å…¬å¼ï¼Œå¯ä»¥å¾—åˆ°æ‰§è¡Œè®¡åˆ’çš„æˆæœ¬ã€‚

```plain
>>> range_normal_cost(ranges=225,  rows=1800, in_mem_pct=1)
686.26
```

é‚£ä¹ˆè¿™é‡Œçš„è®°å½•æ•°æ˜¯æ€ä¹ˆè¯„ä¼°å‡ºæ¥çš„å‘¢ï¼Ÿè¿™éœ€è¦ç”¨åˆ°ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ã€‚ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯å¯ä»¥é€šè¿‡information\_schema.statisticsè¡¨æŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡show indexeså‘½ä»¤æŸ¥çœ‹ã€‚

```plain
mysql> show indexes from t_cost;
+------------+----------+--------------+-------------+-----------+-------------+
| Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality |
+------------+----------+--------------+-------------+-----------+-------------+
|          0 | PRIMARY  |            1 | id          | A         |        8580 |
|          1 | idx_ac   |            1 | a           | A         |           6 |
|          1 | idx_ac   |            2 | c           | A         |         300 |
|          1 | idx_bc   |            1 | b           | A         |        1000 |
|          1 | idx_bc   |            2 | c           | A         |        1000 |
+------------+----------+--------------+-------------+-----------+-------------+
```

ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯å­—æ®µå«ä¹‰æˆ‘æ•´ç†åœ¨äº†è¿™ä¸ªè¡¨æ ¼ä¸­ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/4a/d3/4a3b0cf663da0820c11c2c588166bbd3.png?wh=1920x889)

ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ä¸­æœ€é‡è¦å­—æ®µæ˜¯åŸºæ•°ã€‚å¯¹äºç»„åˆç´¢å¼•ï¼Œå­—æ®µçš„åŸºæ•°æ˜¯å½“å‰å­—æ®µä»¥åŠåºå·æ¯”å½“å‰å­—æ®µå°çš„é‚£äº›å­—æ®µçš„ç»„åˆå­—æ®µçš„å”¯ä¸€å€¼ã€‚åŸºæ•°å€¼è¶Šå¤§ï¼Œåˆ™é€šå¸¸è¯´æ˜ç´¢å¼•çš„é€‰æ‹©æ€§è¶Šé«˜ã€‚å½“ç„¶åœ¨å®é™…æƒ…å†µä¸­ï¼Œå¯èƒ½ä¼šå­˜åœ¨æ•°æ®åˆ†å¸ƒä¸å‡åŒ€çš„æƒ…å†µï¼ŒæŸäº›å€¼çš„è®°å½•æ•°ä¼šç‰¹åˆ«é«˜æˆ–ç‰¹åˆ«ä½ã€‚

æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œç´¢å¼•idx\_bcçš„åŸºæ•°ä¸º1000ï¼Œå› æ­¤å¯¹äºwhere b=xx and c=xx è¿™æ ·çš„æ¡ä»¶ï¼ŒåŒ¹é…åˆ°çš„è®°å½•æ•°æ˜¯8580/1000ï¼Œç„¶åå†å–æ•´ï¼Œå¾—åˆ°è¡Œæ•°æ˜¯8ã€‚æˆ‘ä»¬çš„ä¾‹å­ä¸­æœ‰225ä¸ªè¿™æ ·çš„åŒºé—´ï¼Œå› æ­¤æ€»è®°å½•æ•°æ˜¯225 * 8ï¼Œä¹Ÿå°±æ˜¯1800ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨mysql.innodb\_index\_statsè¡¨ä¸­æŸ¥çœ‹ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±å»è¯•ä¸€è¯•ã€‚

## ç»Ÿè®¡ä¿¡æ¯

é€šè¿‡å‰é¢è¿™å‡ ä¸ªç®€å•çš„ä¾‹å­ï¼Œä½ å¯ä»¥çœ‹åˆ°ç»Ÿè®¡ä¿¡æ¯çš„é‡è¦ä½œç”¨äº†ã€‚å‡†ç¡®çš„ç»Ÿè®¡ä¿¡æ¯å¯¹äºä¼˜åŒ–å™¨æ˜¯å¦èƒ½æ‰¾åˆ°æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’èµ·ç€å…³é”®çš„ä½œç”¨ã€‚å¦‚æœç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ï¼Œåˆ™ä¼˜åŒ–å™¨å¯èƒ½ä¼šé€‰æ‹©é”™è¯¯çš„æ‰§è¡Œè®¡åˆ’ã€‚é‚£ä¹ˆåº”è¯¥å¦‚ä½•ç»´æŠ¤ç»Ÿè®¡ä¿¡æ¯å‘¢ï¼Ÿ

æœ‰å‡ ä¸ªå‚æ•°æ§åˆ¶äº†InnoDBæ”¶é›†ç»Ÿè®¡ä¿¡æ¯çš„è¡Œä¸ºã€‚

- innodb\_stats\_auto\_recalc

è¯¥å‚æ•°æ§åˆ¶InnoDBæ˜¯å¦å¼€å¯ç»Ÿè®¡ä¿¡æ¯è‡ªåŠ¨æ”¶é›†ã€‚å¦‚æœå¼€å¯äº†ç»Ÿè®¡ä¿¡æ¯è‡ªåŠ¨æ”¶é›†ï¼Œåˆ™å½“è¡¨ä¸­çš„æ•°æ®å˜åŒ–è¶…è¿‡10%æ—¶ï¼ŒInnoDBåå°ä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—è¡¨çš„ç›¸å…³ç»Ÿè®¡ä¿¡æ¯ã€‚è¯¥å‚æ•°é»˜è®¤å¼€å¯ã€‚å¦‚æœå…³é—­ç»Ÿè®¡ä¿¡æ¯è‡ªåŠ¨æ”¶é›†ï¼Œåˆ™éœ€è¦æ‰§è¡Œanalyze tableæ¥æ›´æ–°è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ã€‚

- innodb\_stats\_persistent

è¯¥å‚æ•°æ§åˆ¶æ˜¯å¦æŒä¹…åŒ–å­˜å‚¨InnoDBç»Ÿè®¡ä¿¡æ¯ï¼Œé»˜è®¤å¼€å¯ã€‚å¦‚æœæ²¡æœ‰å¼€å¯ç»Ÿè®¡ä¿¡æ¯æŒä¹…åŒ–å­˜å‚¨ï¼Œåˆ™ç»Ÿè®¡ä¿¡æ¯åªå­˜åœ¨å†…å­˜ä¸­ï¼Œåˆ™å½“MySQLé‡å¯åï¼Œæ‰€æœ‰InnoDBè¡¨çš„ç»Ÿè®¡ä¿¡æ¯éƒ½ç¼ºå¤±ã€‚æŸ¥è¯¢è¯­å¥è®¿é—®åˆ°ç¼ºå¤±ç»Ÿè®¡ä¿¡æ¯çš„è¡¨æ—¶ï¼Œä¼šæ”¶é›†ç»Ÿè®¡ä¿¡æ¯ã€‚

- innodb\_stats\_persistent\_sample\_pages

è¯¥å‚æ•°æŒ‡å®šæ”¶é›†ç»Ÿè®¡ä¿¡æ¯æ—¶æ‰«æçš„é¡µé¢æ•°ã€‚è¯¥å‚æ•°è®¾ç½®å¾—è¶Šå¤§ï¼Œåˆ™analyze tableå¾—åˆ°çš„ç»Ÿè®¡ä¿¡æ¯è¶Šç²¾ç¡®ï¼Œä½†æ˜¯æ”¶é›†ç»Ÿè®¡ä¿¡æ¯çš„æ—¶é—´ä¼šå˜é•¿ï¼Œä¹Ÿä¼šæ¶ˆè€—æ›´å¤šçš„ç³»ç»ŸIOã€‚

- innodb\_stats\_transient\_sample\_pages

innodb\_stats\_persistentè®¾ç½®ä¸ºOFFæ—¶ï¼Œä½¿ç”¨è¯¥å‚æ•°æ¥æ§åˆ¶æ”¶é›†ç»Ÿè®¡ä¿¡æ¯æ—¶æ‰«æçš„é¡µé¢æ•°ã€‚

- innodb\_stats\_on\_metadata

è¯¥å‚æ•°ç”¨äºæ§åˆ¶åœ¨æŸ¥çœ‹è¡¨çš„å…ƒæ•°æ®æ—¶ï¼ˆå¦‚æ‰§è¡ŒSHOW TABLE STATUSå‘½ä»¤ã€æŸ¥çœ‹information\_schemaä¸­çš„TABLESã€STATISTICSè¡¨ï¼‰ï¼Œæ˜¯å¦æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ã€‚è¯¥å‚æ•°åªæœ‰å½“ç»Ÿè®¡ä¿¡æ¯æ²¡æœ‰æŒä¹…åŒ–æ—¶æ‰ç”Ÿæ•ˆï¼Œé»˜è®¤å…³é—­ã€‚

ä¸Šè¿°å‚æ•°åœ¨å…¨å±€æ§åˆ¶ç»Ÿè®¡ä¿¡æ¯æ”¶é›†è¡Œä¸ºã€‚InnoDBä¹Ÿæ”¯æŒåœ¨è¡¨çº§åˆ«æŒ‡å®šç»Ÿè®¡ä¿¡æ¯çš„æ”¶é›†ç­–ç•¥ã€‚å¯ä»¥åœ¨create tableæˆ–alter tableè¯­å¥ä¸­æŒ‡å®šSTATS\_AUTO\_RECALCã€STATS\_PERSISTENTã€STATS\_SAMPLE\_PAGESè¿™å‡ ä¸ªé€‰é¡¹ï¼š

```plain
alter table tab 
    STATS_AUTO_RECALC = {DEFAULT|0|1},
    STATS_PERSISTENT = {DEFAULT|0|1},
    STATS_SAMPLE_PAGES = n;
```

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ANALYZE TABLEå‘½ä»¤æ¥æ”¶é›†è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ã€‚

```plain
ANALYZE [NO_WRITE_TO_BINLOG] TABLE tbl_name;

ANALYZE [NO_WRITE_TO_BINLOG | LOCAL]
    TABLE tbl_name
    UPDATE HISTOGRAM ON col_name
    [WITH N BUCKETS];
```

ANALYZE TABLEå‘½ä»¤çš„æ‰§è¡Œæ—¶é—´è·Ÿå‚æ•°innodb\_stats\_persistent\_sample\_pagesè®¾ç½®çš„é‡‡æ ·é¡µé¢æ•°ã€ç´¢å¼•å­—æ®µçš„æ•°é‡ä»¥åŠè¡¨çš„åˆ†åŒºæ•°ç›¸å…³ã€‚

## è¡¨è¿æ¥çš„æˆæœ¬è¯„ä¼°

å¯¹äºå¤šè¡¨è¿æ¥ï¼Œä¼˜åŒ–å™¨éœ€è¦è¯„ä¼°ä¸åŒçš„è¿æ¥é¡ºåºä¸‹çš„æˆæœ¬ã€‚

```plain
select * 
from t1, t2, t3
where t1.c1 = t1.c1
and t2.c1 = t3.c1
and ...
```

æ¯”å¦‚å¯¹äºä¸Šé¢è¿™ä¸ªç®€å•çš„ä¸‰è¡¨è¿æ¥æŸ¥è¯¢ï¼Œå°±å­˜åœ¨6ç§å¯èƒ½çš„è¿æ¥é¡ºåºã€‚ä¼˜åŒ–å™¨éœ€è¦è¯„ä¼°æ¯ä¸€ä¸ªå¯èƒ½çš„æ‰§è¡Œè·¯å¾„çš„æˆæœ¬ï¼Œä»å…¶ä¸­é€‰æ‹©æˆæœ¬æœ€ä½çš„æ‰§è¡Œè·¯å¾„æ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/9e/7f/9e8216c2f71f64e739910905813e457f.jpg?wh=1382x764)

è¡¨è¿æ¥çš„æˆæœ¬è¯„ä¼°ï¼Œä»¥åŠè¡¨è¿æ¥çš„æ‰§è¡Œï¼Œæˆ‘ä»¬åç»­æœ‰ä¸“é—¨çš„ä¸€èŠ‚è¯¾æ¥ä»‹ç»ã€‚

## å½±å“æ‰§è¡Œè®¡åˆ’çš„å…¶ä»–å› ç´ 

ä¼˜åŒ–å™¨æœ€ç»ˆä¼šé€‰æ‹©å“ªä¸ªæ‰§è¡Œè®¡åˆ’ï¼Œè¿˜å—åˆ°å…¶ä»–ä¸€äº›å› ç´ çš„å½±å“ã€‚

1. ä¼˜åŒ–å™¨å‚æ•°

å‰é¢æˆ‘ä»¬ä»‹ç»äº†å‚æ•°eq\_range\_index\_dive\_limitçš„ä½œç”¨ã€‚è¿˜æœ‰å…¶ä»–å‡ ä¸ªå‚æ•°ä¹Ÿä¼šå½±å“ä¼˜åŒ–å™¨ã€‚

å‚æ•°range\_optimizer\_max\_mem\_sizeç”¨æ¥é™åˆ¶rangeä¼˜åŒ–èƒ½ä½¿ç”¨çš„å†…å­˜ã€‚å¯¹äºwhere a in (x,x,x) and b in (x,x,x) and c in (x,x,x)è¿™æ ·çš„æ¡ä»¶ï¼Œæ¯ä¸€ä¸ªç»„åˆéƒ½ä¼šæ¶ˆè€—ä¸€å®šçš„å†…å­˜ï¼Œå½“ç»„åˆçš„æ•°é‡ç‰¹åˆ«å¤šæ—¶ï¼Œå¦‚æœå†…å­˜æ¶ˆè€—é‡è¶…å‡ºäº†range\_optimizer\_max\_mem\_sizeçš„é™åˆ¶ï¼Œä¼˜åŒ–å™¨å°±ä¼šæ”¾å¼ƒè¿™ä¸ªrangeä¼˜åŒ–ï¼Œæ”¹ä¸ºä½¿ç”¨å…¨è¡¨æ‰«æã€‚

ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†range\_optimizer\_max\_mem\_sizeè®¾ç½®å¾—å°ä¸€äº›ï¼Œå°±èƒ½çœ‹åˆ°è¿™æ ·çš„waningä¿¡æ¯â€œMemory capacity of 16384 bytes for â€˜range\_optimizer\_max\_mem\_sizeâ€™ exceededâ€ã€‚ç°å®ä¸­ï¼Œæˆ‘ä¹Ÿé‡åˆ°è¿‡ç”±äºinçš„ç»„åˆæ•°å¤ªå¤šå¯¼è‡´çš„å…¨è¡¨æ‰«æã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå³ä½¿ä½¿ç”¨äº†FORCE INDEXæç¤ºï¼Œä¼˜åŒ–å™¨è¿˜æ˜¯ä¼šä½¿ç”¨å…¨è¡¨æ‰«æã€‚

```plain
mysql> set range_optimizer_max_mem_size=16384;
Query OK, 0 rows affected (0.01 sec)

mysql> explain   select * from tab
         where a in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20)
         and  b in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20)
         and c in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20) ;
+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | tab   | ALL  | idx_abc       | NULL | NULL    | NULL | 9913 |    12.50 | Using where |
+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+
1 row in set, 2 warnings (0.00 sec)


mysql> explain   select * from tab force index(idx_abc)
     where a in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20)
     and  b in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20)
     and c in (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20) ;
+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | tab   | ALL  | idx_abc       | NULL | NULL    | NULL | 9913 |    12.50 | Using where |
+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+
1 row in set, 2 warnings (0.00 sec)
```

```plain
mysql> show warnings\G
*************************** 1. row ***************************
  Level: Warning
   Code: 3170
Message: Memory capacity of 16384 bytes for 'range_optimizer_max_mem_size' exceeded. Range optimization was not done for this query.
```

å‚æ•°optimizer\_switchæä¾›äº†ä¼˜åŒ–å™¨å¾ˆå¤šåŠŸèƒ½çš„å¼€å…³ã€‚åç»­çš„å‡ è®²ä¸­ï¼Œæˆ‘ä¼šå¯¹è¿™é‡Œé¢çš„éƒ¨åˆ†é€‰é¡¹åšä¸€äº›ä»‹ç»ã€‚

```plain
mysql> show variables like 'optimizer_switch'\G
*************************** 1. row ***************************
Variable_name: optimizer_switch
        Value: index_merge=on,index_merge_union=on,index_merge_sort_union=on,index_merge_intersection=on,engine_condition_pushdown=on,index_condition_pushdown=on,mrr=on,mrr_cost_based=on,block_nested_loop=on,batched_key_access=off,materialization=on,semijoin=on,loosescan=on,firstmatch=on,duplicateweedout=on,subquery_materialization_cost_based=on,use_index_extensions=on,condition_fanout_filter=on,derived_merge=on,use_invisible_indexes=off,skip_scan=on,hash_join=on,subquery_to_derived=off,prefer_ordering_index=on,hypergraph_optimizer=off,derived_condition_pushdown=on
```

å‚æ•°optimizer\_search\_depthå’Œoptimizer\_prune\_levelå¯¹å¤šè¡¨æ¥è¿æŸ¥è¯¢æœ‰å½±å“ï¼Œæˆ‘ä»¬åœ¨è¡¨è¿æ¥é‚£ä¸€è®²ä¸­å†æ¥ä»‹ç»ã€‚

2. ä¼˜åŒ–å™¨æç¤ºï¼ˆhintï¼‰

ä¼˜åŒ–å™¨æç¤ºä¹Ÿèƒ½å½±å“æ‰§è¡Œè®¡åˆ’ï¼Œä¸Šä¸€è®²ä¸­æˆ‘ä»¬å°±ä½¿ç”¨äº†NO\_SEMIJOINã€QB\_NAMEã€BKAç­‰æç¤ºæ¥å›ºå®šæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ã€‚

å¹³æ—¶æ¯”è¾ƒå¸¸ç”¨çš„å¯èƒ½æ˜¯FORCE INDEXã€IGNORE INDEXã€USE INDEXè¿™äº›æç¤ºã€‚FORCE INDEXä¸­ï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ªç´¢å¼•ã€‚è¯­å¥ä¸­åŠ å…¥force indexæç¤ºåï¼Œä¼˜åŒ–å™¨åªä¼šè€ƒè™‘ä½¿ç”¨è¿™é‡Œé¢æŒ‡å®šçš„ç´¢å¼•ã€‚

ä¸‹é¢çš„è¿™ä¸ªæµ‹è¯•SQLä½¿ç”¨äº†force index(idx\_ac, idx\_bc)ï¼Œè™½ç„¶IDæ˜¯ä¸»é”®ï¼Œä½†æ˜¯å¯ä»¥çœ‹åˆ°ï¼Œä¼˜åŒ–å™¨æ²¡æœ‰è€ƒè™‘ä½¿ç”¨PRIMARYè¿™ä¸ªç´¢å¼•ï¼Œè€Œæ˜¯ä½¿ç”¨äº†å…¨è¡¨æ‰«æã€‚æ³¨æ„æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œpossible\_keysä¸ºNULLã€‚

```plain
mysql> explain select * from t_cost force index(idx_ac, idx_bc) where id = 1;
+----+-------------+--------+------+---------------+------+---------+------+------+----------+-------------+
| id | select_type | table  | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
+----+-------------+--------+------+---------------+------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | t_cost | ALL  | NULL          | NULL | NULL    | NULL | 8580 |     0.01 | Using where |
+----+-------------+--------+------+---------------+------+---------+------+------+----------+-------------+
```

FORCE INDEXè¿˜æœ‰å¦å¤–ä¸€ä¸ªæ•ˆæœï¼Œå¦‚æœè¯­å¥å¯ä»¥ä½¿ç”¨åˆ°æç¤ºä¸­çš„æŸä¸ªç´¢å¼•ï¼Œé‚£ä¹ˆå°±ä¸ä½¿ç”¨å…¨è¡¨æ‰«æã€‚

```plain
mysql> explain select * from t_merge where a>0;
+----+-------------+---------+------+---------------+------+---------+------+----------+-------------+
| id | select_type | table   | type | possible_keys | key  | key_len | rows | filtered | Extra       |
+----+-------------+---------+------+---------------+------+---------+------+----------+-------------+
|  1 | SIMPLE      | t_merge | ALL  | idx_ad        | NULL | NULL    | 9737 |    49.99 | Using where |
+----+-------------+---------+------+---------------+------+---------+------+----------+-------------+

mysql> explain select * from t_merge force index(idx_ad, idx_bd)  where a > 0;
+----+-------------+---------+-------+---------------+--------+---------+------+----------+-----------------------+
| id | select_type | table   | type  | possible_keys | key    | key_len | rows | filtered | Extra                 |
+----+-------------+---------+-------+---------------+--------+---------+------+----------+-----------------------+
|  1 | SIMPLE      | t_merge | range | idx_ad        | idx_ad | 4       | 4868 |   100.00 | Using index condition |
+----+-------------+---------+-------+---------------+--------+---------+------+----------+-----------------------+
```

## æ€»ç»“

è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†MySQLä¼˜åŒ–å™¨çš„ä¸€äº›å·¥ä½œåŸç†ã€‚ä¼˜åŒ–å™¨ä¼šé€‰æ‹©æˆæœ¬æœ€ä½çš„æ‰§è¡Œè®¡åˆ’ã€‚æˆ‘ä»¬ä»‹ç»äº†å…¨è¡¨æ‰«æå’Œç´¢å¼•èŒƒå›´æ‰«æè¿™ä¸¤ç§æœ€åŸºæœ¬ï¼Œä¹Ÿæ˜¯æœ€é‡è¦çš„è®¿é—®è·¯å¾„çš„æˆæœ¬è®¡ç®—æ–¹æ³•ã€‚

å®é™…å·¥ä½œä¸­ä¼˜åŒ–SQLæ—¶ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦çœŸçš„çŸ¥é“æŸä¸ªæ‰§è¡Œè®¡åˆ’çš„æˆæœ¬ï¼Œé‚£æ˜¯ä¼˜åŒ–å™¨è¦è®¡ç®—çš„ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦ç†è§£å…¨è¡¨æ‰«æå’Œç´¢å¼•è®¿é—®å¤§è‡´çš„åŸç†ï¼Œç†è§£è¿™ä¸¤ç§æ‰§è¡Œè®¡åˆ’çš„å¼€é”€æ¥è‡ªå“ªé‡Œã€‚

ç»Ÿè®¡ä¿¡æ¯å¯¹ä¼˜åŒ–å™¨å¾ˆé‡è¦ï¼Œå¦‚æœç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ï¼Œä¼˜åŒ–å™¨å¾ˆå¯èƒ½ä¼šé€‰æ‹©é”™è¯¯çš„æ‰§è¡Œè®¡åˆ’ã€‚æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä¼˜åŒ–å™¨å‚æ•°ã€SQLæç¤ºæ¥å½±å“ä¼˜åŒ–å™¨ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘å»ºè®®å°½é‡å°‘ç”¨SQLæç¤ºï¼Œè®©ä¼˜åŒ–å™¨è‡ªå·±é€‰æ‹©æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ã€‚åœ¨ä¸€äº›æ¯”è¾ƒå¤æ‚çš„åœºæ™¯ä¸‹ï¼Œå¦‚æœä¼˜åŒ–å™¨ç¡®å®é€‰ä¸åˆ°æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’æ—¶ï¼Œå†è€ƒè™‘ä½¿ç”¨SQLæç¤ºã€‚

## æ€è€ƒé¢˜

æœ‰æ—¶æˆ‘ä»¬éœ€è¦åˆ†æ®µå¤„ç†å…¨è¡¨çš„æ•°æ®ã€‚å¦‚æœè¡¨ä½¿ç”¨äº†å•åˆ—ä¸»é”®ï¼Œé‚£ä¹ˆå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æŒ‰ä¸»é”®èŒƒå›´æ¥è¿›è¡Œæ•°æ®åˆ†ç‰‡ã€‚ä½†æœ‰äº›æƒ…å†µä¸‹ï¼Œä¸šåŠ¡ä½¿ç”¨äº†è”åˆä¸»é”®ï¼Œé‚£ä¹ˆæ­¤æ—¶ä½ åº”è¯¥æ€ä¹ˆæŒ‰ä¸»é”®èŒƒå›´æ¥å¯¹æ•°æ®è¿›è¡Œåˆ†ç‰‡å‘¢ï¼Ÿ

```plain
create table t_business(
  id1 varchar(30) not null,
  id2 varchar(30) not null,
  id3 varchar(30) not null,
  col1 ...,
  col2 ...,
  primry key(id1, id2, id3)
) engine=innodb;
```

è€ƒè™‘ä¸Šé¢è¿™ä¸ªè¡¨ï¼Œä½¿ç”¨äº†è”åˆä¸»é”®(id1, id2, id3)ã€‚ä½ éœ€è¦åˆ†ç‰‡å¤„ç†è¿™ä¸ªè¡¨çš„æ•°æ®ï¼Œæ¯æ¬¡å¤„ç†1000è¡Œæ•°æ®ï¼Œè¦æ±‚ä¸è¦é‡å¤å¤„ç†æ•°æ®ï¼Œä½†ä¹Ÿä¸è¦æ¼æ‰ä»»ä½•ä¸€æ¡æ•°æ®ã€‚æ•´ä¸ªè¡¨çš„æ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œè¦å°½å¯èƒ½ä¿è¯æ€§èƒ½ã€‚ä½ ä¼šæ€ä¹ˆæ¥å†™è¿™ä¸ªåˆ†é¡µçš„SQLå‘¢ï¼Ÿ

æœŸå¾…ä½ çš„æ€è€ƒï¼Œæ¬¢è¿åœ¨ç•™è¨€åŒºä¸­ä¸æˆ‘äº¤æµã€‚å¦‚æœä»Šå¤©çš„è¯¾ç¨‹è®©ä½ æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿è½¬å‘ç»™æœ‰éœ€è¦çš„æœ‹å‹ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ3ï¼‰</strong></div><ul>
<li><span>å¶æ˜</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>  
å¦å¤–ï¼Œæˆ‘çœ‹ gh-ost çš„å®ç°æ–¹å¼æ˜¯å¦å¤–ä¸€ç§ï¼Œä»å·¦å³è¾¹ç•Œå’Œè”åˆä¸»é”®ä¸­å­—æ®µä¹‹é—´çš„åŒºé—´æ¥è€ƒè™‘
  1. æœ€å·¦è¾¹çš„è¾¹ç•Œ: id1=&#39;a&#39; and id2=&#39;a&#39; and id3=&#39;1&#39;ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæŸ¥è¯¢æ¡ä»¶æ¥æ‹¿åˆ°æœ€å·¦è¾¹ç•Œçš„è®°å½•
  2. è”åˆä¸»é”® (id1, id2, id3) ä¸­ id1 å¤„äºç´¢å¼•ä¸­ç¬¬ä¸€åˆ—ï¼Œå› æ­¤ id1 æ˜¯æœ‰åºçš„ï¼ŒæŸ¥è¯¢æ¡ä»¶ id1&gt;&#39;a&#39; æ‹¿åˆ°é™¤ id1=&#39;a&#39; ä¹‹å¤–çš„æ‰€æœ‰è®°å½•
  3. æ­¥éª¤2å®Œæˆåï¼Œåªéœ€è¦è€ƒè™‘ id1=&#39;a&#39; çš„æœ€åä¸€æ¡è®°å½•ä¸ç¬¬ä¸€æ¡è®°å½• (id1=&#39;a&#39;, id2=&#39;a&#39;, id3=&#39;1&#39;) è¿™æ®µèŒƒå›´çš„è®°å½•äº†
  4. å½“ id1=&#39;a&#39; and id2=&#39;a&#39; æ—¶ï¼Œè¦æƒ³è®¿é—® id3 çš„æ‰€æœ‰è®°å½•ï¼ŒæŸ¥è¯¢æ¡ä»¶å¾—ä¸º id3 &gt; &#39;1&#39;ï¼Œè¿™æ ·å°±èƒ½æ‹¿åˆ° id1, id2 ä¸ºå›ºå®šå€¼æ—¶ï¼Œid3 &gt; &#39;1&#39; çš„æ‰€æœ‰è®°å½•ï¼Œid3 = 1 çš„è¾¹ç•Œå€¼åœ¨æ­¥éª¤ 1 ä¸­å·²ç»æ‹¿åˆ°äº†
  5. æ­¥éª¤4å®Œæˆåï¼Œæ»¡è¶³ id1=&#39;a&#39; and id2=&#39;a&#39; æ¡ä»¶çš„æ‰€æœ‰è®°å½•å·²ç»èƒ½æ‹¿åˆ°äº†ï¼Œæ¥ä¸‹æ¥ï¼Œæ‹¿ id1 = &#39;a&#39; æ—¶ï¼Œid2 &gt; &#39;a&#39; çš„æ‰€æœ‰è®°å½•ï¼Œè¿™æ ·ï¼Œid1=&#39;a&#39; çš„æ‰€æœ‰è®°å½•å°±éƒ½èƒ½æ‹¿åˆ°äº†

select
  &#47;* gh-ost `test`.`t_business` iteration:0 *&#47; `id1`,
  `id2`,
  `id3`
from
  `test`.`t_business`
where
  (
    (`id1` &gt; _binary &#39;a&#39;)
    or (
      ((`id1` = _binary &#39;a&#39;))
      AND (`id2` &gt; _binary &#39;a&#39;)
    )
    or (
      (
        (`id1` = _binary &#39;a&#39;)
        and (`id2` = _binary &#39;a&#39;)
      )
      AND (`id3` &gt; _binary &#39;1&#39;)
    )
    or (
      (`id1` = _binary &#39;a&#39;)
      and (`id2` = _binary &#39;a&#39;)
      and (`id3` = _binary &#39;1&#39;)
    )
  )
  and (
    (`id1` &lt; _binary &#39;d&#39;)
    or (
      ((`id1` = _binary &#39;d&#39;))
      AND (`id2` &lt; _binary &#39;a&#39;)
    )
    or (
      (
        (`id1` = _binary &#39;d&#39;)
        and (`id2` = _binary &#39;a&#39;)
      )
      AND (`id3` &lt; _binary &#39;9990&#39;)
    )
    or (
      (`id1` = _binary &#39;d&#39;)
      and (`id2` = _binary &#39;a&#39;)
      and (`id3` = _binary &#39;9990&#39;)
    )
  )
order by
  `id1` asc,
  `id2` asc,
  `id3` asc
limit
  1
offset
  99</p>2024-10-09</li><br/><li><span>å¶æ˜</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è”åˆä¸»é”®çš„æœ€å°å’Œæœ€å¤§å€¼æ¯”è¾ƒå®¹æ˜“ç¡®å®šï¼Œæ¯”å¦‚æˆ‘è¿™é‡Œçš„æœ€å°å€¼ (&#39;a&#39;, &#39;a&#39;, &#39;1&#39;)ï¼Œæœ€å¤§å€¼ (&#39;d&#39;, &#39;a&#39;, &#39;9990&#39;)ï¼Œä¸èƒ½é€šè¿‡ id1&gt;=&#39;a&#39; and id2&gt;=&#39;a&#39; and id3&gt;=&#39;1&#39; ä»¥åŠ id1&lt;=&#39;d&#39; and id2&lt;=&#39;a&#39; and id3 &lt;= &#39;9990&#39; æ¥è¿›è¡Œæ•°æ®åˆ†ç‰‡ï¼Œ
è¿™æ˜¯å› ä¸ºè¿™ä¸‰ä¸ªå­—æ®µä½œä¸ºè”åˆä¸»é”®ï¼Œä¸‰ä¸ªå­—æ®µä½œä¸ºä¸€ä¸ªæ•´ä½“æ˜¯æœ‰åºçš„ï¼Œä½†ç»†åŒ–åˆ° id2, id3 å­—æ®µï¼Œåˆ™æ˜¯å½“å‰é¢å­—æ®µçš„å€¼å›ºå®šæ—¶ï¼Œåé¢çš„å­—æ®µæ‰æ˜¯æœ‰åºçš„ï¼Œå¦‚æœæŒ‰ç…§ id1&gt;=&#39;a&#39; and id2&gt;=&#39;a&#39; and id3&gt;=&#39;1&#39; å»åŒ¹é…ï¼Œé‚£ä¹ˆä¼šæ¼æ‰ä¸€äº›æ•°æ®ã€‚
æˆ‘æƒ³åˆ°çš„ä¸€ç§æ–¹å¼æ˜¯å°†è”åˆå­—æ®µä½œä¸ºä¸€ä¸ªæ•´ä½“å»åŒ¹é…ï¼Œä¾‹å¦‚ (id1, id2, id3) &gt;= (&#39;a&#39;, &#39;a&#39;, &#39;1&#39;)ã€‚</p>2024-10-09</li><br/><li><span>ls</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¾ªç¯ä¸»é”®ï¼Œæ ¹æ®ä¸»é”®å»æ‰¹é‡æ›´æ–°1000è¡Œï¼Œæ¯1000è¡Œæäº¤ä¸€æ¬¡ã€‚æ˜¯ä¸æ˜¯å°±å¯ä»¥äº†</p>2024-10-09</li><br/>
</ul>