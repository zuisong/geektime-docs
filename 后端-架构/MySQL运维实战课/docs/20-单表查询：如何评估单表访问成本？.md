ä½ å¥½ï¼Œæˆ‘æ˜¯ä¿Šè¾¾ã€‚

ä¸Šä¸€è®²ä¸­æˆ‘ä»¬ä»‹ç»äº†ä¼˜åŒ–å™¨çš„å·¥ä½œåŸç†ï¼Œå¹¶ä»‹ç»äº†å…¨è¡¨æ‰«æå’Œç´¢å¼•èŒƒå›´æ‰«æçš„æˆæœ¬è¯„ä¼°æ–¹æ³•ã€‚åœ¨è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬ç»§ç»­æ¥å­¦ä¹ å•è¡¨æŸ¥è¯¢çš„å…¶ä»–å‡ ç§è®¿é—®è·¯å¾„ï¼šREFã€è¦†ç›–ç´¢å¼•ã€MRRã€Index Mergeã€‚æœ€åï¼Œæˆ‘ä»¬è¿˜å°†é€šè¿‡ä¸€ä¸ªçœŸå®çš„ä¸šåŠ¡åœºæ™¯ï¼Œæ¥è®¨è®ºæ€ä¹ˆç»™ä¸šåŠ¡åˆ›å»ºä¸€ä¸ªåˆé€‚çš„ç´¢å¼•ã€‚

## æµ‹è¯•è¡¨

è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬ä¾ç„¶ä¼šä½¿ç”¨18è®²å¼€å¤´åˆ›å»ºçš„é‚£ä¸ªæµ‹è¯•è¡¨ï¼Œè¿™ä¸ªè¡¨çš„è¡¨ç»“æ„å’Œç»Ÿè®¡ä¿¡æ¯æƒ…å†µå¦‚ä¸‹ï¼š

```plain
mysql> show create table tab\G
*************************** 1. row ***************************
       Table: tab
Create Table: CREATE TABLE `tab` (
  `id` int NOT NULL,
  `a` int NOT NULL,
  `b` int NOT NULL,
  `c` int NOT NULL,
  `padding` varchar(7000) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_abc` (`a`,`b`,`c`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci


mysql> select * from mysql.innodb_table_stats where table_name = 'tab'\G
*************************** 1. row ***************************
           database_name: rep
              table_name: tab
             last_update: 2024-02-26 17:37:12
                  n_rows: 9913
    clustered_index_size: 161
sum_of_other_index_sizes: 17
```

## Index Diveæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ

ä¸Šä¸€è®²ä¸­æåˆ°äº†ï¼ŒInnoDBä½¿ç”¨äº†Index Diveæœºåˆ¶ï¼Œæ¥è¯„ä¼°ä¸€ä¸ªç´¢å¼•åŒºé—´å†…æœ‰å¤šå°‘è¡Œè®°å½•ã€‚é‚£ä¹ˆIndex Diveæ˜¯å¦‚ä½•ä¼°ç®—ä¸€ä¸ªç´¢å¼•åŒºé—´å†…çš„è®°å½•æ•°å‘¢ï¼Ÿå¤§è‡´çš„æ­¥éª¤æ˜¯è¿™æ ·çš„ã€‚

1. æ ¹æ®whereæ¡ä»¶ï¼Œç¡®å®šrangeè®¿é—®çš„ä¸Šä¸‹è¾¹ç•Œã€‚rangeçš„ä¸Šä¸‹è¾¹ç•Œï¼Œå†³å®šäº†éœ€è¦åœ¨ç´¢å¼•ä¸­æ‰«æå¤šå°‘è®°å½•ã€‚
2. æ ¹æ®ä¸Šä¸‹è¾¹ç•Œçš„å€¼ï¼Œåˆ°ç´¢å¼•ä¸­æŸ¥æ‰¾ï¼Œå¹¶è®°å½•æ¯ä¸€å±‚è¾¹ç•Œè®°å½•çš„æ‰€åœ¨ä½ç½®ã€‚
3. ä»ä¸‹è¾¹ç•Œè®°å½•å¼€å§‹æ‰«ææ•°æ®ï¼Œä¸€ç›´æ‰«æåˆ°ä¸Šè¾¹ç•Œè®°å½•ï¼Œæˆ–è€…ç›´åˆ°æ‰«æçš„é¡µé¢æ•°è¶…å‡ºé™åˆ¶ï¼ˆ8ä¸ªé¡µé¢ï¼‰ã€‚

å¦‚æœåŒºé—´å†…çš„è®°å½•æ•°ä¸å¤šï¼Œåˆ™å¯ä»¥ç²¾ç¡®åœ°ç»Ÿè®¡å‡ºè®°å½•æ•°ã€‚å¦‚æœåŒºé—´å†…è®°å½•æ•°å¾ˆå¤šï¼Œè¶…è¿‡äº†8ä¸ªé¡µé¢ï¼Œé‚£ä¹ˆInnoDBä¼šä¼°ç®—å‡ºè®°å½•æ•°ã€‚é¦–å…ˆï¼Œæ ¹æ®å·²ç»æ‰«æçš„ç´¢å¼•é¡µé¢ï¼Œå¯ä»¥ç®—å‡ºå¹³å‡æ¯ä¸ªé¡µé¢æœ‰å¤šå°‘è¡Œè®°å½•ã€‚ç„¶åï¼Œå†ä¼°ç®—å‡ºåŒºé—´å†…æœ‰å¤šå°‘ä¸ªé¡µé¢ï¼Œä¸¤ä¸ªæ•°å­—ç›¸ä¹˜ï¼Œå°±å¾—åˆ°äº†è®°å½•æ•°çš„ä¸€ä¸ªä¼°ç®—å€¼ã€‚

InnoDBæ€ä¹ˆä¼°ç®—ä¸€ä¸ªåŒºé—´å†…æœ‰å¤šå°‘é¡µé¢å‘¢ï¼Ÿä»ç´¢å¼•ç»“æ„å¯ä»¥çœ‹å‡ºï¼Œä¸Šä¸€å±‚é¡µé¢ä¸­ï¼Œæ¯ä¸€ä¸ªç´¢å¼•æ¡ç›®éƒ½æŒ‡å‘äº†ä¸‹ä¸€å±‚çš„ä¸€ä¸ªé¡µé¢ï¼Œé‚£ä¹ˆç»Ÿè®¡ä¸Šä¸€å±‚ä¸­ç´¢å¼•æ¡ç›®çš„æ•°é‡ï¼Œå°±çŸ¥é“äº†ä¸‹ä¸€å±‚ä¸­åŒºé—´å†…çš„é¡µé¢æ•°ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/ee/ae/ee39d06eee95c8d45d2a87e3c73c9aae.jpg?wh=1500x825)

Index Diveé€šå¸¸éƒ½èƒ½è·å¾—èŒƒå›´å†…è®°å½•æ•°æ®æ¯”è¾ƒå‡†ç¡®çš„ä¼°è®¡ã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªç‰¹æ®Šæƒ…å†µã€‚rangeå†…çš„é¡µé¢æ•°è¾ƒå¤šæ—¶ï¼Œå¾—åˆ°çš„ä¸æ˜¯ç²¾ç¡®çš„è®°å½•æ•°ï¼Œè¿™éœ€è¦å°†è¡Œæ•°ä¹˜ä»¥2ï¼Œå¦‚æœä¹˜ä»¥2ä¹‹åçš„è¡Œæ•°è¶…è¿‡äº†è¡¨ç»Ÿè®¡ä¿¡æ¯ä¸­è®°å½•æ•°çš„ä¸€åŠï¼Œåˆ™å°†è®°å½•æ•°è®¾ç½®ä¸ºæ€»è®°å½•æ•°çš„ä¸€åŠã€‚é€šè¿‡ä»¥ä¸‹å‡ ä¸ªä¾‹å­æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°è¿™ç§æƒ…å†µã€‚

```plain
-- rowsä¸ºç²¾ç¡®å€¼
mysql> explain select * from tab where id >=1 and id <= 790;
+----+-------------+-------+-------+---------------+---------+---------+------+
| id | select_type | table | type  | possible_keys | key     | key_len | rows |
+----+-------------+-------+-------+---------------+---------+---------+------+
|  1 | SIMPLE      | tab   | range | PRIMARY       | PRIMARY | 4       |  790 |
+----+-------------+-------+-------+---------------+---------+---------+------+

-- rowsä¸ç²¾ç¡®ï¼ŒæŒ‰é¢„ä¼°è¡Œæ•°çš„2å€è¿”å›
mysql> explain select * from tab where id >=1 and id <= 791;
+----+-------------+-------+-------+---------------+---------+---------+------+
| id | select_type | table | type  | possible_keys | key     | key_len | rows |
+----+-------------+-------+-------+---------------+---------+---------+------+
|  1 | SIMPLE      | tab   | range | PRIMARY       | PRIMARY | 4       | 1422 |
+----+-------------+-------+-------+---------------+---------+---------+------+

-- rowsä¸ç²¾ç¡®ï¼ŒæŒ‰é¢„ä¼°è¡Œæ•°çš„2å€è¿”å›
mysql> explain select * from tab where id >=1 and id <= 2396;
+----+-------------+-------+-------+---------------+---------+---------+------+
| id | select_type | table | type  | possible_keys | key     | key_len | rows |
+----+-------------+-------+-------+---------------+---------+---------+------+
|  1 | SIMPLE      | tab   | range | PRIMARY       | PRIMARY | 4       | 4952 |
+----+-------------+-------+-------+---------------+---------+---------+------+

-- rowsä¸ç²¾ç¡®ï¼Œé¢„ä¼°è¡Œæ•°çš„2å€è¶…è¿‡è¡¨è®°å½•æ•°çš„ä¸€åŠï¼ŒæŒ‰è¡¨è®°å½•æ•°çš„ä¸€åŠè¿”å›
mysql> explain select * from tab where id >=1 and id <= 6000;
+----+-------------+-------+-------+---------------+---------+---------+------+
| id | select_type | table | type  | possible_keys | key     | key_len | rows |
+----+-------------+-------+-------+---------------+---------+---------+------+
|  1 | SIMPLE      | tab   | range | PRIMARY       | PRIMARY | 4       | 4956 |
+----+-------------+-------+-------+---------------+---------+---------+------+
```

## REFè®¿é—®è·¯å¾„

REFæ˜¯MySQLä¸­æ¯”è¾ƒç‰¹åˆ«çš„ä¸€ç§è®¿é—®è·¯å¾„ã€‚å’ŒRANGEä¸€æ ·ï¼ŒREFè®¿é—®è·¯å¾„ä¹Ÿä½¿ç”¨ç´¢å¼•æ¥æŸ¥æ‰¾æ•°æ®ï¼Œä½†åªæœ‰å½“ç´¢å¼•å­—æ®µçš„åŒ¹é…æ¡ä»¶æ˜¯ç­‰å€¼åŒ¹é…ï¼Œå¹¶ä¸”ç´¢å¼•å­—æ®µä¸Šæ²¡æœ‰ä½¿ç”¨INå¤šä¸ªå€¼æˆ–ä½¿ç”¨ORæ¡ä»¶ï¼Œç±»å‹æ‰æ˜¯REFã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/86/bf/86bb45c86b5388e64a30b9c8cd2fe0bf.jpg?wh=916x523)

REFæ‰§è¡Œå¯ä»¥çœ‹ä½œæ˜¯ç´¢å¼•èŒƒå›´æ‰«æçš„ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œä½¿ç”¨REFè®¿é—®è·¯å¾„æŸ¥æ‰¾æ•°æ®çš„æ­¥éª¤å¤§è‡´å¦‚ä¸‹ï¼š

1. å…ˆåœ¨ç´¢å¼•ä¸­å®šä½åˆ°ç¬¬1æ¡æ»¡è¶³ç´¢å¼•æŸ¥æ‰¾æ¡ä»¶çš„è®°å½•ã€‚
2. å¦‚æœè¯­å¥æ²¡æœ‰ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œè¿˜éœ€è¦å›è¡¨è·å–æ•´æ¡è®°å½•ã€‚
3. åˆ¤æ–­è®°å½•æ˜¯å¦æ»¡è¶³æŸ¥è¯¢è¯­å¥ä¸­çš„å…¶å®ƒæ¡ä»¶ã€‚å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œåˆ™è¿”å›è®°å½•ã€‚
4. åœ¨ç´¢å¼•ä¸­è·å–ä¸‹ä¸€è¡Œè®°å½•ã€‚

ä¸‹é¢æ˜¯REFè®¿é—®è·¯å¾„çš„ä¸€ä¸ªä¾‹å­ï¼š

```plain
mysql> explain select * from tab where a=1;

+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-------+
| id | select_type | table | type | possible_keys | key     | key_len | ref   | rows | filtered | Extra |
+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | tab   | ref  | idx_abc       | idx_abc | 4       | const | 3333 |   100.00 | NULL  |
+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-------+
```

ä¸Šè¿°æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œtypeåˆ—æ˜¾ç¤ºrefï¼Œrowsåˆ—æ˜¾ç¤º3333ï¼Œè¡¨ç¤ºrefæ‰§è¡Œè®¡åˆ’éœ€è¦åœ¨ç´¢å¼•ä¸­æŸ¥æ‰¾çš„è®°å½•æ•°ã€‚

ä»optimizer\_traceä¸­ï¼ŒæŸ¥çœ‹refè®¿é—®çš„æˆæœ¬ä¸º454.05ã€‚

```plain
mysql> select * from information_schema.optimizer_trace\G
...

"best_access_path": {
  "considered_access_paths": [
    {
      "access_type": "ref",
      "index": "idx_abc",
      "rows": 3333,
      "cost": 454.05,
      "chosen": true
    },
    {
      "rows_to_scan": 9913,
      "filtering_effect": [
      ],
      "final_filtering_effect": 0.336225,
      "access_type": "scan",
      "resulting_rows": 3333,
      "cost": 1031.55,
      "chosen": false
    }
  ]
```

REFè®¿é—®è·¯å¾„çš„æˆæœ¬ç”±IOæˆæœ¬å’Œè¡Œè¯„ä¼°æˆæœ¬ç»„æˆã€‚

æˆ‘ä»¬ä¸Šé¢è¿™ä¸ªæµ‹è¯•ä¸­ï¼Œä½¿ç”¨äº†éè¦†ç›–ç´¢å¼•ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œä¼˜åŒ–å™¨è®¤ä¸ºæ¯è¯»å–1è¡Œè®°å½•éƒ½éœ€è¦è®¿é—®1æ¬¡IOã€‚åŒæ—¶MySQLå¯¹REFè®¿é—®çš„æˆæœ¬è®¾ç½®äº†ä¸€ä¸ªä¸Šé™worst\_seeksï¼Œworst\_seeksä»ä¸‹é¢ä¸¤ç§æƒ…å†µä¸­å–è¾ƒå°å€¼ï¼š

- è¡¨æ‰«æçš„IOæˆæœ¬çš„3å€ã€‚
- è¯»å–è¡¨ï¼ˆèšç°‡ç´¢å¼•ï¼‰ä¸­10%çš„è®°å½•æ•°çš„æˆæœ¬ã€‚ä¼˜åŒ–å™¨å°†è¯»å–1è¡Œè®°å½•çš„æˆæœ¬è®°ä¸º1æ¬¡IOè®¿é—®çš„æˆæœ¬ã€‚

åŒæ—¶ä¼˜åŒ–å™¨è¿˜è®¾ç½®äº†worst\_seeksçš„ä¸‹é™min\_worst\_seekï¼Œmin\_worst\_seekè®¾ç½®ä¸ºè¯»å–2æ¡ä¸»é”®è®°å½•çš„æˆæœ¬ï¼Œä¹Ÿå°±æ˜¯2æ¬¡IOçš„æˆæœ¬ã€‚

éè¦†ç›–ç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œrefè®¿é—®çš„æˆæœ¬ä½¿ç”¨pythonä»£ç è¡¨ç¤ºï¼š

```plain
def worst_seeks(rows, n_rows, clustered_index_size):
    worst_seek1 = 3 * clustered_index_size
    worst_seek2 = 0.1 * n_rows
    min_worst_seek = 2
    worst_seek = min(worst_seek1, worst_seek2)
    if worst_seek < min_worst_seek:
        worst_seek = min_worst_seek
    return worst_seek

def ref_cost_normal_index(rows, n_rows, clustered_index_size, in_mem_pct):
    worst_seek = worst_seeks(rows, n_rows, clustered_index_size)
    if rows > worst_seek:
        result = worst_seek
    else:
        result = rows
    return result * page_read_cost(in_mem_pct)

def ref_cost_normal(rows, n_rows, clustered_index_size, in_mem_pct=1.0):
    io_cost = ref_cost_normal_index(rows, n_rows, clustered_index_size, in_mem_pct)
    cpu_cost = row_evaluate_cost(rows)
    return io_cost + cpu_cost
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå‚æ•°total\_rowså’Œclustered\_index\_sizeçš„å€¼ä»è¡¨ç»Ÿè®¡ä¿¡æ¯ä¸­è·å–ï¼Œåˆ†åˆ«ä¸ºè¡¨çš„æ€»è¡Œæ•°å’Œèšç°‡ç´¢å¼•çš„å¤§å°ã€‚

åœ¨æˆ‘ä»¬çš„æµ‹è¯•æ¡ˆä¾‹ä¸­ï¼Œè¡¨ç»Ÿè®¡ä¿¡æ¯ä¸­å¯çŸ¥ï¼Œæ€»è¡Œæ•°ä¸º9913ï¼Œèšç°‡ç´¢å¼•çš„å¤§å°ä¸º161ã€‚

```plain
mysql> select * from mysql.innodb_table_stats where table_name = 'tab'\G
*************************** 1. row ***************************
           database_name: rep
              table_name: tab
             last_update: 2024-08-22 14:18:26
                  n_rows: 9913
    clustered_index_size: 161
sum_of_other_index_sizes: 17
```

æ‰«æçš„è¡Œæ•°ä¸º3333ï¼Œå› æ­¤å¾—åˆ°refè®¿é—®çš„æ€»æˆæœ¬ä¸º454.05ã€‚

```plain
>>> ref_cost_normal(rows=3333, n_rows=9913, clustered_index_size=161)
454.05
```

### ä¸€ä¸ªç‰¹æ®Šçš„ä¾‹å­

æˆ‘ä»¬ç»™å‰é¢çš„æµ‹è¯•SQLå¢åŠ ä¸€ä¸ªè¿‡æ»¤æ¡ä»¶ï¼Œå‘ç°è¿™ç§æƒ…å†µä¸‹ï¼ŒMySQLç›´æ¥ä½¿ç”¨äº†å…¨è¡¨æ‰«æã€‚

```plain
mysql> explain select * from tab where a=1 and b <= 9000;
+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | tab   | ALL  | idx_abc       | NULL | NULL    | NULL | 9913 |    30.26 | Using where |
+----+-------------+-------+------+---------------+------+---------+------+------+----------+-------------+
```

ä½†æ˜¯æ ¹æ®æµ‹è¯•è¡¨tabçš„ç´¢å¼•idx\_abc(a,b,c)çš„ç»“æ„çœ‹ï¼Œå¢æ·»ä¸€ä¸ªè¿‡æ»¤æ¡ä»¶ï¼Œç†è®ºä¸Šæ˜¯èƒ½æé«˜æ•ˆç‡çš„ï¼Œä¸ºä»€ä¹ˆä¼˜åŒ–å™¨åè€Œæ”¾å¼ƒäº†ä½¿ç”¨è¿™ä¸ªç´¢å¼•å‘¢ï¼Ÿ

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¼˜åŒ–å™¨è·Ÿè¸ªã€‚å…¨è¡¨æ‰«æçš„æˆæœ¬æ˜¯1033.65ã€‚

```plain
"table_scan": {
  "rows": 9913,
  "cost": 1033.65
}
```

ç´¢å¼•rangeè®¿é—®çš„æˆæœ¬æ˜¯1050.26ï¼Œè¶…è¿‡äº†å…¨è¡¨æ‰«æçš„æˆæœ¬ï¼Œå› æ­¤æ²¡æœ‰é‡‡ç”¨ã€‚

```plain
"range_scan_alternatives": [
  {
    "index": "idx_abc",
    "ranges": [
      "a = 1 AND b <= 9000"
    ],
    "index_dives_for_eq_ranges": true,
    "rowid_ordered": false,
    "using_mrr": false,
    "index_only": false,
    "in_memory": 0.357143,
    "rows": 3000,
    "cost": 1050.26,
    "chosen": false,
    "cause": "cost"
  }
]
```

ä¸ºä»€ä¹ˆè¿refè®¿é—®è·¯å¾„ä¹Ÿæ²¡æœ‰è¢«é‡‡ç”¨å‘¢ï¼Ÿè¿™é‡Œä¼˜åŒ–å™¨ä½¿ç”¨äº†ä¸€æ¡è§„åˆ™ï¼š**å› ä¸ºrangeè®¿é—®è·¯å¾„å’Œrefä½¿ç”¨äº†åŒä¸€ä¸ªç´¢å¼•ï¼Œä½†æ˜¯rangeä½¿ç”¨äº†æ›´å¤šçš„ç´¢å¼•å­—æ®µï¼Œå› æ­¤ä¼˜å…ˆé€‰æ‹©ä½¿ç”¨rangeã€‚**æ³¨æ„ä¼˜åŒ–å™¨è·Ÿè¸ªé‡Œæ˜¾ç¤ºçš„åŸå› â€œrange\_uses\_more\_keypartsâ€ã€‚

```plain
"best_access_path": {
  "considered_access_paths": [
    {
      "access_type": "ref",
      "index": "idx_abc",
      "chosen": false,
      "cause": "range_uses_more_keyparts"
    },
    {
      "rows_to_scan": 9913,
      "filtering_effect": [
      ],
      "final_filtering_effect": 0.302633,
      "access_type": "scan",
      "resulting_rows": 3000,
      "cost": 1031.55,
      "chosen": true
    }
  ]
}
```

å®é™…ä¸Šåœ¨5.7ç‰ˆæœ¬ä¸­ï¼Œè¿™ç§æƒ…å†µä¸‹ä¼˜åŒ–å™¨è¿˜æ˜¯ä½¿ç”¨äº†REFã€‚

```plain
-- 5.7.38-log
mysql> explain select * from tab where a=1 and b <= 9000;
+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-----------------------+
| id | select_type | table | type | possible_keys | key     | key_len | ref   | rows | filtered | Extra                 |
+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-----------------------+
|  1 | SIMPLE      | tab   | ref  | idx_abc       | idx_abc | 4       | const | 3336 |    33.33 | Using index condition |
+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-----------------------+
```

æˆ‘ä»¬å†æ¥å¯¹æ¯”ä¸‹ä¸‹é¢è¿™2ä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’ï¼Œè¿™2ä¸ªSQLåŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯limitç›¸å·®äº†1ï¼Œä½†æ˜¯ä¸€ä¸ªSQLä½¿ç”¨äº†ç´¢å¼•rangeè®¿é—®ï¼Œå¦ä¸€ä¸ªSQLä½¿ç”¨äº†å…¨è¡¨æ‰«æã€‚

```plain
mysql> explain select * from tab where a=1 and b <= 9000 order by b limit 885;
+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+-----------------------+
| id | select_type | table | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra                 |
+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+-----------------------+
|  1 | SIMPLE      | tab   | range | idx_abc       | idx_abc | 8       | NULL | 3000 |   100.00 | Using index condition |
+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+-----------------------+


mysql> explain select * from tab where a=1 and b <= 9000 order by b limit 886;
+----+-------------+-------+------+---------------+------+---------+------+------+----------+-----------------------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                       |
+----+-------------+-------+------+---------------+------+---------+------+------+----------+-----------------------------+
|  1 | SIMPLE      | tab   | ALL  | idx_abc       | NULL | NULL    | NULL | 9913 |    30.26 | Using where; Using filesort |
+----+-------------+-------+------+---------------+------+---------+------+------+----------+-----------------------------+
```

è¿™ä¸»è¦æ˜¯åœ¨8.0çš„ä¼˜åŒ–å™¨ä¸­ï¼Œå¯¹äºorder by limitçš„æƒ…å†µï¼Œåšäº†ä¸€äº›é¢å¤–çš„è€ƒè™‘ã€‚å½“å¯ä»¥ä½¿ç”¨æŸä¸ªç´¢å¼•çš„æœ‰åºæ€§æ¥é¿å…æ’åºï¼Œå¹¶ä¸”limitçš„æ•°é‡æ¯”è¾ƒå°‘ï¼Œå°‘åˆ°æ‰«æç´¢å¼•åŒºé—´çš„æˆæœ¬æ¯”è¡¨æ‰«ææ›´ä½æ—¶ï¼Œä¼˜åŒ–å™¨ä¼šé€‰æ‹©ä½¿ç”¨è¿™ä¸ªç´¢å¼•ã€‚

åœ¨5.7ä¸­æµ‹è¯•ï¼Œå¹¶æ²¡æœ‰å‡ºç°è¿™ç§æƒ…å†µã€‚è¿™ä¹Ÿæé†’æˆ‘ä»¬ï¼Œå¤§ç‰ˆæœ¬å‡çº§åï¼Œå¯èƒ½ä¼šç”±äºä¼˜åŒ–å™¨å†…éƒ¨å®ç°çš„å˜åŒ–ï¼Œå¯¼è‡´SQLçš„æ‰§è¡Œè®¡åˆ’å‘ç”Ÿå˜åŒ–ã€‚è¿™ä¹Ÿæ˜¯å‡çº§å‰éœ€è¦ä½¿ç”¨çœŸå®ä¸šåŠ¡åœºæ™¯åšå¥½æµ‹è¯•çš„ä¸€ä¸ªé‡è¦åŸå› ã€‚

## è¦†ç›–ç´¢å¼•

å¦‚æœæŸ¥è¯¢ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œé‚£ä¹ˆæ‰§è¡Œè¿‡ç¨‹ä¸­ä¸éœ€è¦å›è¡¨ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæˆæœ¬çš„è®¡ç®—æ–¹å¼æœ‰ä¸€äº›å˜åŒ–ã€‚REFå’ŒRangeè®¿é—®è·¯å¾„éƒ½æœ‰å¯èƒ½ä½¿ç”¨è¦†ç›–ç´¢å¼•ã€‚

### REFä½¿ç”¨è¦†ç›–ç´¢å¼•

ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼ŒREFè®¿é—®è·¯å¾„ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œæ³¨æ„åˆ°Extraä¸­çš„â€œusing indexâ€ã€‚

```plain
mysql> explain select a,b,c from tab where a = 1;
+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-------------+
| id | select_type | table | type | possible_keys | key     | key_len | ref   | rows | filtered | Extra       |
+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-------------+
|  1 | SIMPLE      | tab   | ref  | idx_abc       | idx_abc | 4       | const | 3333 |   100.00 | Using index |
+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-------------+
```

ä½¿ç”¨è¦†ç›–ç´¢å¼•åï¼Œæ‰§è¡Œè®¡åˆ’çš„æˆæœ¬æ›´ä½ã€‚

```plain
"analyzing_range_alternatives": {
  "range_scan_alternatives": [
    {
      "index": "idx_abc",
      "ranges": [
        "a = 1"
      ],
      "index_dives_for_eq_ranges": true,
      "rowid_ordered": false,
      "using_mrr": false,
      "index_only": true,
      "in_memory": 1,
      "rows": 3333,
      "cost": 335.184,
      "chosen": true
    }
  ]
```

ç”±äºä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œä¸éœ€è¦å›è¡¨ï¼Œå› æ­¤éœ€è¦è®¿é—®çš„æ•°æ®é¡µæ•°å°±æ˜¯ç´¢å¼•å ç”¨çš„é¡µé¢æ•°ã€‚

ç´¢å¼•é¡µé¢æ•°çš„è®¡ç®—æ–¹æ³•ï¼Œæˆ‘ä½¿ç”¨ä¸‹é¢è¿™æ®µPythonä»£ç æ¥è¡¨ç¤ºã€‚

```plain
BLOCK_SIZE = 16384
MEMORY_BLOCK_READ_COST = 0.25
IO_BLOCK_READ_COST = 1
ROW_EVALUATE_COST = 0.1
    
def index_scan_pages(rows, key_len, ref_len):
    keys_per_block = BLOCK_SIZE / 2 / (key_len + ref_len) + 1
    index_blocks = 1.0* (rows + keys_per_block - 1) / keys_per_block
    return index_blocks
    
def page_read_cost(in_mem_pct):
    result = MEMORY_BLOCK_READ_COST * in_mem_pct + IO_BLOCK_READ_COST * (1-in_mem_pct)
    return result

def index_scan_io_cost(rows, key_len, ref_len, in_mem_pct):
    pages = index_scan_pages(rows, key_len, ref_len)
    read_cost = page_read_cost(in_mem_pct)
    return pages * read_cost

def covering_index_cost(rows, key_len, ref_len, in_mem_pct):
    result = index_scan_io_cost(rows, key_len, ref_len, in_mem_pct) + row_eval_cost(rows)
    return result + 0.01
    
```

åœ¨æˆ‘ä»¬çš„æµ‹è¯•ä¾‹å­ä¸­ï¼Œkey\_lenä¸º12ï¼Œref\_lenä¸º4ï¼Œrefè®¿é—®çš„è®°å½•æ•°ä¸º3333ï¼Œå› æ­¤REFæ€»æˆæœ¬ä¸ºï¼š

```plain
>>> covering_index_cost(rows=3333, key_len=12, ref_len=4, in_mem_pct=1)
335.1837816764133
```

### Rangeä½¿ç”¨è¦†ç›–ç´¢å¼•

ä¸‹é¢æ˜¯RangeæŸ¥è¯¢ä½¿ç”¨è¦†ç›–ç´¢å¼•çš„ä¸€ä¸ªä¾‹å­ï¼Œæ³¨æ„åˆ°è¡Œæ•°ä¸º4944ï¼ŒExtraä¸­æœ‰â€œUsing indexâ€ã€‚

```plain
mysql> explain select a,b,c from tab where a >=0 and a <= 2;
+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+--------------------------+
| id | select_type | table | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra                    |
+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+--------------------------+
|  1 | SIMPLE      | tab   | range | idx_abc       | idx_abc | 4       | NULL | 4944 |   100.00 | Using where; Using index |
+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+--------------------------+
```

```plain
"range_scan_alternatives": [
  {
    "index": "idx_abc",
    "ranges": [
      "0 <= a <= 2"
    ],
    "index_dives_for_eq_ranges": true,
    "rowid_ordered": false,
    "using_mrr": false,
    "index_only": true,
    "in_memory": 1,
    "rows": 4944,
    "cost": 497.069,
    "chosen": true
  }
```

```plain
>>> covering_index_cost(rows=4944, key_len=12, ref_len=4, in_mem_pct=1)
497.06886939571154
```

### ä½¿ç”¨ä¸»é”®è®¿é—®

ç›´æ¥ä½¿ç”¨ä¸»é”®æ¥è¿›è¡ŒREFæˆ–Rangeè®¿é—®ï¼Œå¯ä»¥çœ‹ä½œæ˜¯è¦†ç›–ç´¢å¼•çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚ä¸‹é¢çš„æŸ¥è¯¢ä½¿ç”¨ä¸»é”®è¿›è¡Œrangeè®¿é—®ï¼ŒåŒºé—´å†…çš„è®°å½•æ•°ä¸º4944ã€‚

```plain
mysql>  explain select * from tab where id between 1000 and 4000;
+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+-------------+
| id | select_type | table | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra       |
+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | tab   | range | PRIMARY       | PRIMARY | 4       | NULL | 4944 |   100.00 | Using where |
+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+-------------+
```

ä»optimizer traceä¸­å¯ä»¥çœ‹åˆ°æ‰§è¡Œè®¡åˆ’çš„æˆæœ¬ä¸º496.415ã€‚

```plain
"range_scan_alternatives": [
  {
    "index": "PRIMARY",
    "ranges": [
      "1000 <= id <= 4000"
    ],
    "index_dives_for_eq_ranges": true,
    "rowid_ordered": true,
    "using_mrr": false,
    "index_only": false,
    "in_memory": 1,
    "rows": 4944,
    "cost": 496.415,
    "chosen": true
  }
```

ä½¿ç”¨ä¸»é”®è¿›è¡ŒrangeæŸ¥è¯¢æ—¶ï¼ŒæŸ¥è¯¢çš„æˆæœ¬å’Œéœ€è¦æ‰«æçš„èšç°‡ç´¢å¼•é¡µé¢æ•°ç›¸å…³ã€‚èšç°‡ç´¢å¼•é¡µé¢æ•°çš„è®¡ç®—æ–¹å¼å¤§è‡´æ˜¯è¿™æ ·çš„ã€‚

1. å…ˆè¯„ä¼°è¡¨ä¸­è®°å½•æ•°çš„ä¸€ä¸ªä¸Šé™upper\_bound\_rowsã€‚

è¿™é‡Œä¼˜åŒ–å™¨æ²¡æœ‰ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯ä¸­çš„è¡¨è®°å½•è¡Œæ•°ï¼Œè€Œæ˜¯ä½¿ç”¨äº†ä»¥ä¸‹å…¬å¼æ¥ä¼°ç®—è®°å½•æ•°ï¼šupper\_bound\_rows = 2 * stat\_n\_leaf\_pages * block\_size / min\_record\_length

ä¸Šé¢çš„å…¬å¼ä¸­ï¼Œblock\_sizeä¸ºInnoDBé¡µé¢å¤§å°ï¼Œé»˜è®¤16Kã€‚stat\_n\_leaf\_pagesä¸ºç´¢å¼•å¶å­èŠ‚ç‚¹é¡µé¢æ•°çš„ä¸€ä¸ªé¢„ä¼°å€¼ã€‚InnoDBå°†ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜æ”¾åˆ°ä¸€ä¸ªå•ç‹¬çš„æ®µï¼Œæ‰€ä»¥å¯ä»¥ä»æ®µçš„ç©ºé—´ç®¡ç†ä¿¡æ¯ä¸­è·å–åˆ°é¡µé¢æ•°ã€‚min\_record\_lengthä¸ºä¸€è¡Œè®°å½•è‡³å°‘éœ€è¦å ç”¨çš„ç©ºé—´ï¼Œæ ¹æ®è¡Œè®°å½•æ ¼å¼è®¡ç®—å¾—åˆ°ã€‚InnoDBä¸€è¡Œè®°å½•ç”±è®°å½•å¤´éƒ¨ä¿¡æ¯ã€ç”¨æˆ·å­—æ®µã€InnoDBéšè—å­—æ®µç­‰ä¿¡æ¯ç»„æˆï¼Œå…·ä½“è®°å½•æ ¼å¼åç»­ä¼šåœ¨InnoDBå­˜å‚¨å¼•æ“ç¯‡ä¸­ä»‹ç»ã€‚

2. æ ¹æ®éœ€è¦è®¿é—®çš„è®°å½•æ•°æ¥è®¡ç®—é¡µé¢æ•°ã€‚

é¡µé¢æ•°ç”±ä»¥ä¸‹å…¬å¼è®¡ç®—å¾—å‡ºï¼šé¡µé¢æ•° = 1 + rows / upper\_bound\_rows * stat\_clustered\_index\_size

ä¸Šé¢å…¬å¼ä¸­ï¼Œstat\_clustered\_index\_sizeä¸ºç»Ÿè®¡ä¿¡æ¯ä¸­ä¸»é”®çš„é¡µé¢æ•°ã€‚ä¼˜åŒ–å™¨æ ¹æ®å¾…è®¿é—®çš„è®°å½•æ•°å æ•´ä¸ªè¡¨è®°å½•æ•°çš„æ¯”ä¾‹æ¥ä¼°ç®—IOæˆæœ¬ã€‚

ä½¿ç”¨ä¸»é”®è¿›è¡Œrefè®¿é—®çš„æˆæœ¬è®¡ç®—ç”±ä»¥ä¸‹ä»£ç è¡¨ç¤ºï¼š

```plain
BLOCK_SIZE = 16384
def primary_key_scan_pages(rows, leaf_pages, min_record_len, clustered_index_size):
    upper_bound_rows = 2 * leaf_pages * BLOCK_SIZE / min_record_len
    if rows > upper_bound_rows:
        pages = clustered_index_size
    else:
        pages = 1 + 1.0 * rows / upper_bound_rows * clustered_index_size
    return pages
    
def primary_key_scan_cost(rows, leaf_pages, min_record_len, clustered_index_size, in_mem_pct):
    scan_pages = primary_key_scan_pages(rows, leaf_pages, min_record_len, clustered_index_size)
    return scan_pages * page_read_cost(in_mem_pct)

def range_clustered_cost(rows, leaf_pages, min_record_len,
    clustered_index_size, in_mem_pct):
    io_cost = primary_key_scan_cost(rows, leaf_pages, min_record_len,
        clustered_index_size, in_mem_pct)
    result = io_cost + row_eval_cost(rows) + 0.01
    return result

def range_clustered_cost_total(rows, leaf_pages, min_record_len,
    clustered_index_size, in_mem_pct):
    range_cost = range_clustered_cost(rows, leaf_pages, min_record_len,
    clustered_index_size, in_mem_pct)
    return range_cost + row_eval_cost(rows)
```

åœ¨æˆ‘ä»¬çš„æµ‹è¯•æ¡ˆä¾‹ä¸­ï¼Œrowsä¸º4944ï¼Œleaf\_pagesä¸º128ï¼Œmin\_record\_lenä¸º37ï¼Œclustered\_index\_sizeä¸º161ï¼Œè¡¨åœ¨å†…å­˜ä¸­ç¼“å­˜çš„æ¯”ä¾‹ä¸º100%ï¼Œå› æ­¤ä½¿ç”¨ä¸»é”®è¿›è¡ŒRANGEè®¿é—®çš„æˆæœ¬ä¸ºï¼š

```plain
>>> range_clustered_cost(rows=4944, leaf_pages=128, min_record_len=37, clustered_index_size=161, in_mem_pct=1.0)
496.4154495011424
```

ä¸Šé¢çš„leaf\_pagesã€min\_record\_lenå®é™…ä¸Šæ˜¯æˆ‘ä»GDBè°ƒè¯•å™¨ä¸­å–åˆ°çš„ã€‚min\_record\_lenå¤§æ¦‚æ˜¯è¿™ä¹ˆè®¡ç®—çš„ï¼šè¡¨é‡Œæœ‰4ä¸ªéç©ºå›ºå®šé•¿åº¦çš„intå­—æ®µï¼Œå ç”¨16å­—èŠ‚ï¼ŒInnoDBå†…éƒ¨å­—æ®µdb\_trx\_idå’Œdb\_roll\_ptrå…±å ç”¨13å­—èŠ‚ï¼Œè¡Œé¦–æœ‰5å­—èŠ‚çš„å›ºå®šé•¿åº¦ï¼Œvarcharå­—æ®µéœ€è¦2å­—èŠ‚è®°å½•é•¿åº¦ï¼Œä»¥åŠ1ä¸ªå­—èŠ‚æ¥è®°å½•å­—æ®µæ•°æ®æ˜¯å¦ä¸ºnullï¼Œå› æ­¤æ€»å…±éœ€è¦16 + 13 + 5 + 2 + 1 = 37å­—èŠ‚ã€‚

```plain
CREATE TABLE `tab` (
  `id` int NOT NULL,
  `a` int NOT NULL,
  `b` int NOT NULL,
  `c` int NOT NULL,
  `padding` varchar(7000) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_abc` (`a`,`b`,`c`)
) ENGINE=InnoDB
```

## å…³äºMRR

MRRæ˜¯DISK SWEEP Multi-Range Readçš„ç®€ç§°ã€‚åœ¨å¸¸è§„çš„rangeè®¿é—®è·¯å¾„ä¸‹ï¼Œé€šè¿‡ç´¢å¼•è·å–åˆ°çš„ROWIDæ˜¯æ— åºçš„ï¼Œæ ¹æ®è¿™äº›ROWIDå›è¡¨è·å–æ•°æ®æ—¶ï¼Œå¯¹è¡¨æ¥è¯´ï¼Œå°±æ˜¯éšæœºè®¿é—®ï¼Œè€Œéšæœºè®¿é—®å¯èƒ½å¸¦æ¥æ›´å¤šçš„IOæ“ä½œã€‚MRRè®¿é—®è·¯å¾„å¯¹è¿™ç§åœºæ™¯è¿›è¡Œäº†ä¼˜åŒ–ã€‚ä»ç´¢å¼•ä¸­è·å–åˆ°ä¸€æ‰¹ROWIDæ—¶ï¼Œå…ˆå¯¹ROWIDè¿›è¡Œæ’åºï¼Œç„¶åæŒ‰é¡ºåºå›è¡¨è·å–æ•°æ®ï¼Œä»¥æ­¤æ¥è¾¾åˆ°å‡å°‘éšæœºIOçš„ç›®çš„ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/02/87/022ba695a2d5c208d52b5fbe6939f587.jpg?wh=1648x437)

MRRè®¿é—®è·¯å¾„ä¼šå…ˆåœ¨MRR bufferä¸­å¯¹ROWIDè¿›è¡Œæ’åºã€‚MRR bufferçš„å¤§å°ç”±å‚æ•°read\_rnd\_buffer\_sizeæ§åˆ¶ã€‚MRRè®¿é—®è·¯å¾„çš„æˆæœ¬è®¡ç®—ä¸­ï¼ŒåŠ å…¥äº†å¯¹ROWIDè¿›è¡Œæ’åºçš„æˆæœ¬ã€‚æŒ‰ROWIDé¡ºåºå›è¡¨æ—¶ï¼ŒIOæˆæœ¬çš„è®¡ç®—æ–¹å¼ä¹Ÿæœ‰ä¸€äº›è°ƒæ•´ã€‚ä¸è¿‡è¿™é‡Œæˆ‘ä»¬å°±ä¸å±•å¼€è®¨è®ºMRRæˆæœ¬çš„è®¡ç®—ç»†èŠ‚äº†ã€‚

ä¼˜åŒ–å™¨ä½¿ç”¨MRRæœ‰ä¸€äº›é¢å¤–çš„æ¡ä»¶ã€‚

1. è¡¨çš„å¤§å°è¶…è¿‡InnoDB Buffer Poolçš„å¤§å°ã€‚
2. è®¿é—®çš„è¡Œæ•°è¶…è¿‡50ã€‚
3. optimizer\_switchä¸­å¼€å¯mrr\_cost\_basedé€‰é¡¹ï¼ŒMRRæˆæœ¬æ¯”æ™®é€šçš„Rangeæˆæœ¬ä½æ—¶ï¼Œæ‰ä¼šä½¿ç”¨MRRã€‚
4. optimizer\_switchä¸­å¼€å¯mrré€‰é¡¹ã€‚

å¦‚æœæŸ¥è¯¢ä½¿ç”¨äº†MRRæˆ–BKAæç¤ºï¼Œåˆ™ä¸éœ€è¦æ»¡è¶³ä»¥ä¸Šå‡ ç‚¹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨MRRè®¿é—®è·¯å¾„ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨MRRäº†æç¤ºï¼Œæ‰§è¡Œè®¡åˆ’Extraåˆ—ä¸­æœ‰Using MRRå­—æ ·ï¼Œè¯´æ˜ä½¿ç”¨äº†MRRè®¿é—®è·¯å¾„ã€‚

```plain
mysql> explain select /*+ MRR(tab) */ * from tab where a between 0.9 and 1.1;
+----+-------------+-------+-------+---------------+---------+---------+------+----------------------------------+
| id | select_type | table | type  | possible_keys | key     | key_len | rows | Extra                            |
+----+-------------+-------+-------+---------------+---------+---------+------+----------------------------------+
|  1 | SIMPLE      | tab   | range | idx_abc       | idx_abc | 4       | 3333 | Using index condition; Using MRR |
+----+-------------+-------+-------+---------------+---------+---------+------+----------------------------------+	
```

## ç´¢å¼•åˆå¹¶ï¼ˆindex\_mergeï¼‰

åœ¨ç¬¬18è®²ä¸­ï¼Œæˆ‘ä»¬æåˆ°äº†ç´¢å¼•åˆå¹¶çš„å‡ ç§æƒ…å†µã€‚ä¸€èˆ¬åœ¨çœŸå®ä¸šåŠ¡ä¸­ï¼Œå¦‚æœé‡åˆ°äº†ç´¢å¼•åˆå¹¶ï¼Œé€šå¸¸è¯´æ˜æŸ¥è¯¢çš„æ€§èƒ½ä¸æ˜¯å¾ˆå¥½ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè€ƒè™‘æ˜¯å¦èƒ½é€šè¿‡ä¸€äº›æ–¹æ³•æ¥é¿å…ç´¢å¼•åˆå¹¶ï¼Œæ¯”å¦‚æ ¹æ®æŸ¥è¯¢æ¡ä»¶åˆ›å»ºåˆé€‚çš„è”åˆç´¢å¼•ï¼Œæˆ–è€…å°†whereè¯­å¥çš„ORæ¡ä»¶æ‹†åˆ†æˆå¤šä¸ªSQLï¼Œæˆ–è€…ä½¿ç”¨union allã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨t\_mergeè¡¨ï¼Œå¯¹ç´¢å¼•åˆå¹¶è¿›è¡Œä¸€äº›åŸºæœ¬çš„ä»‹ç»ï¼Œç”Ÿæˆè¿™ä¸ªè¡¨å’Œæ•°æ®çš„SQLå¯ä»¥åœ¨ç¬¬18è®²å¼€å¤´æ‰¾åˆ°ï¼Œè¿™é‡Œæˆ‘å°±ä¸é‡å¤äº†ã€‚

è¿™ä¸ªè¡¨çš„ç»Ÿè®¡ä¿¡æ¯å¦‚ä¸‹ï¼š

```plain
mysql> select * from mysql.innodb_table_stats where table_name = 't_merge'\G
*************************** 1. row ***************************
           database_name: rep
              table_name: t_merge
             last_update: 2024-04-07 14:43:57
                  n_rows: 9737
    clustered_index_size: 97
sum_of_other_index_sizes: 51

mysql> show indexes from t_merge;
+---------+------------+----------+--------------+-------------+-------------+
| Table   | Non_unique | Key_name | Seq_in_index | Column_name | Cardinality |
+---------+------------+----------+--------------+-------------+-------------+
| t_merge |          0 | PRIMARY  |            1 | id          |        9737 |
| t_merge |          1 | idx_ad   |            1 | a           |           3 |
| t_merge |          1 | idx_ad   |            2 | d           |          30 |
| t_merge |          1 | idx_bd   |            1 | b           |          17 |
| t_merge |          1 | idx_bd   |            2 | d           |         170 |
| t_merge |          1 | idx_cd   |            1 | c           |          19 |
| t_merge |          1 | idx_cd   |            2 | d           |         190 |
+---------+------------+----------+--------------+-------------+-------------+
```

ç´¢å¼•åˆå¹¶è®¿é—®è·¯å¾„ä¼šä½¿ç”¨å¤šä¸ªç´¢å¼•æ¥è·å–ROWIDï¼Œå¯¹ROWIDå–äº¤é›†æˆ–å¹¶é›†æ“ä½œåï¼Œå†å›è¡¨è·å–æ•°æ®ã€‚index\_mergeåˆ†ä¸‰ç§æƒ…å†µï¼š

- intersectï¼šå¤šä¸ªç´¢å¼•çš„æ¡ä»¶ä½¿ç”¨ANDç›¸è¿
- unionï¼šå¤šä¸ªç´¢å¼•çš„æ¡ä»¶ä½¿ç”¨ORç›¸è¿
- sort\_unionï¼šå¤šä¸ªç´¢å¼•çš„æ¡ä»¶ä½¿ç”¨ORç›¸è¿

### Index intersect

Index intersectå¤§è‡´æŒ‰ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œï¼š

1. ä»index 1è¯»å–æ»¡è¶³ç´¢å¼•æ¡ä»¶çš„è®°å½•ã€‚
2. ä»index 2è¯»å–æ»¡è¶³ç´¢å¼•æ¡ä»¶çš„è®°å½•ã€‚
3. å°†æ­¥éª¤1ã€æ­¥éª¤2è·å–åˆ°çš„è®°å½•æ±‚äº¤é›†ã€‚
4. æ ¹æ®æ­¥éª¤3å¾—åˆ°çš„ROWIDå›è¡¨è·å–æ•°æ®ã€‚
5. åˆ¤æ–­è®°å½•æ˜¯å¦æ»¡è¶³å…¶å®ƒé¢å¤–çš„æ¡ä»¶ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/77/5e/774d965672fe63cbd27a483cb2500a5e.jpg?wh=1210x665)

ä½¿ç”¨Index Intersectionæœ‰ä¸€ä¸ªå‰ææ¡ä»¶ï¼Œå°±æ˜¯å‚ä¸åˆ°intersectionçš„ç´¢å¼•ï¼Œå…¶ç´¢å¼•å­—æ®µçš„æ¡ä»¶éƒ½è¦ä¼ å…¥ã€‚ä¸‹é¢çš„è¿™ä¸ªæµ‹è¯•SQLä¸­ï¼Œä½¿ç”¨äº†ç´¢å¼• idx\_bd, idx\_ad è¿›è¡Œintersectæ“ä½œï¼Œæ³¨æ„è¿™2ä¸ªç´¢å¼•çš„key\_lenéƒ½æ˜¯8ã€‚å¦‚æœæŸ¥è¯¢ä¸­å»æ‰d=1è¿™ä¸ªæ¡ä»¶ï¼Œå°±æ— æ³•ä½¿ç”¨index intersectionã€‚

```plain
mysql> explain select * from t_merge where a=1 and b=1  and d=1\G
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: t_merge
   partitions: NULL
         type: index_merge
possible_keys: idx_ad,idx_bd
          key: idx_bd,idx_ad
      key_len: 8,8
          ref: NULL
         rows: 18
     filtered: 95.20
        Extra: Using intersect(idx_bd,idx_ad); Using where
```

Index Intersectçš„æˆæœ¬ç”±ç´¢å¼•æ‰«ææˆæœ¬ã€å›è¡¨æˆæœ¬ã€è¡Œè¯„ä¼°æˆæœ¬ç»„æˆï¼Œå¯ä»¥ç”±ä»¥ä¸‹å…¬å¼è¡¨ç¤ºï¼š  
Index Intersectæˆæœ¬ = ç´¢å¼•æ‰«ææˆæœ¬ + å›è¡¨æˆæœ¬ + è¡Œè¯„ä¼°æˆæœ¬

å…·ä½“çš„è®¡ç®—æ–¹å¼è¿™é‡Œå°±ä¸å†å±•å¼€è®¨è®ºäº†ã€‚

### Index union

Index Unionå¤§è‡´æŒ‰å¦‚ä¸‹æ­¥éª¤æ‰§è¡Œï¼š

1. æŒ‰ç´¢å¼•æ¡ä»¶è¯»å–ç´¢å¼•è®°å½•
2. å¯¹å¤šä¸ªç´¢å¼•çš„è®°å½•åˆå¹¶ï¼Œå»é‡ã€‚
3. å›è¡¨æŸ¥è¯¢æ•°æ®

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/9c/93/9cb0844c611b80d207bc97d256600193.jpg?wh=1222x658)

å¦‚æœç¬¬ä¸€æ­¥ä»ç´¢å¼•ä¸­å–åˆ°è®°å½•å·²ç»æŒ‰ROWIDé¡ºåºæ’åˆ—ï¼Œåˆ™å¯ä»¥ç›´æ¥è¿›è¡Œåˆå¹¶å»é‡ï¼Œè¿™ç§æƒ…å†µä¸‹æ‰§è¡Œè®¡åˆ’Extraæ˜¾ç¤ºâ€œUsing unionâ€ã€‚å¦‚æœç¬¬ä¸€æ­¥å–åˆ°çš„è®°å½•æ²¡æœ‰æŒ‰ROWIDé¡ºåºæ’åˆ—ï¼Œåˆ™éœ€è¦å…ˆè¿›è¡Œæ’åºï¼Œç„¶åå†è¿›è¡Œåˆå¹¶å»é‡ï¼Œè¿™ç§æƒ…å†µä¸‹æ‰§è¡Œè®¡åˆ’Extraä¸­ä¼šæ˜¾ç¤ºâ€œUsing sort\_unionâ€ã€‚

ä½¿ç”¨Index Unionçš„ä¸€ä¸ªä¾‹å­ï¼š

```plain
mysql>  explain select * from t_merge where (c=1 and d=1) or (b=1 and d=1) \G
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: t_merge
   partitions: NULL
         type: index_merge
possible_keys: idx_bd,idx_cd
          key: idx_cd,idx_bd
      key_len: 8,8
          ref: NULL
         rows: 108
     filtered: 100.00
        Extra: Using union(idx_cd,idx_bd); Using where
```

å’ŒIndex Intersectæˆæœ¬è®¡ç®—æ–¹å¼ç±»ä¼¼ï¼ŒIndex Unionçš„æˆæœ¬å¯ä»¥ç”±ä»¥ä¸‹å…¬å¼æ¥è¡¨ç¤ºï¼š  
$$Index Unionæˆæœ¬ = ç´¢å¼•æ‰«ææˆæœ¬ + æ±‚å¹¶é›†æˆæœ¬ + å›è¡¨æˆæœ¬ + è¡Œè¯„ä¼°æˆæœ¬$$

è¿™ä¸ªå…¬å¼ä¸­å¤šäº†ä¸€é¡¹é›†åˆæ±‚å¹¶é›†çš„æˆæœ¬ï¼Œå…·ä½“çš„è®¡ç®—å…¬å¼è¿™é‡Œä¹Ÿä¸å±•å¼€è®¨è®ºäº†ã€‚

### Index sort\_union

Index sort\_unionçš„æ‰§è¡Œæ–¹å¼å’ŒIndex unionç±»ä¼¼ï¼Œä½†æ˜¯ä½¿ç”¨sort\_unionæ—¶ï¼Œä»å„ä¸ªç´¢å¼•è·å–åˆ°çš„ROWIDéœ€è¦å…ˆæ’åºï¼Œå¢åŠ äº†æ’åºçš„æˆæœ¬ã€‚ä¸‹é¢æ˜¯ä½¿ç”¨index sort\_unionçš„ä¸€ä¸ªä¾‹å­ï¼š

```plain
mysql> explain select * from t_merge where (c=1 and d between 1 and 5) or (b=1 and d=1)\G
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: t_merge
   partitions: NULL
         type: index_merge
possible_keys: idx_bd,idx_cd
          key: idx_cd,idx_bd
      key_len: 8,8
          ref: NULL
         rows: 312
     filtered: 100.00
        Extra: Using sort_union(idx_cd,idx_bd); Using where
1 row in set, 1 warning (2.88 sec)
```

æ³¨æ„ä¸Šè¿°æ‰§è¡Œè®¡åˆ’ä¸­Extraåˆ—æ˜¾ç¤ºçš„â€œUsing sort\_unionâ€ã€‚  
$$Index Sort Union æˆæœ¬ = ç´¢å¼•æ‰«ææˆæœ¬ + ROWIDæ’åºå»é‡æˆæœ¬ + å›è¡¨æˆæœ¬ + è¡Œè¯„ä¼°æˆæœ¬$$

å’ŒIndex Unionç›¸æ¯”ï¼Œè¿™é‡Œå¤šäº†ROWIDæ’åºå»é‡çš„æˆæœ¬ã€‚æ’åºçš„æˆæœ¬ï¼Œè¿˜å’Œå‚æ•°sort\_buffer\_sizeçš„è®¾ç½®æœ‰å…³ï¼Œå…·ä½“çš„è®¡ç®—æ–¹å¼ä¹Ÿä¸å±•å¼€è®¨è®ºäº†ã€‚

## å¦‚ä½•åˆ›å»ºé«˜æ•ˆçš„ç´¢å¼•ï¼Ÿ

å…³äºMySQLç´¢å¼•çš„å†…å®¹ï¼Œåˆ°è¿™é‡ŒåŸºæœ¬ä¸Šéƒ½ä»‹ç»å®Œäº†ã€‚é‚£ä¹ˆï¼Œåœ¨é¢å¯¹ä¸€ä¸ªå…·ä½“çš„ä¸šåŠ¡åœºæ™¯æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆæ¥åˆ›å»ºåˆé€‚ã€é«˜æ•ˆçš„ç´¢å¼•å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬ä»¥ç”µå•†ç³»ç»Ÿä¸­ä¸€ä¸ªå¾ˆå…¸å‹çš„ä¸šåŠ¡åœºæ™¯ï¼Œè®¢å•åˆ—è¡¨ä¸ºä¾‹ï¼Œæ¥è®¨è®ºåˆ›å»ºç´¢å¼•çš„ä¸€äº›å…³é”®ç‚¹ã€‚

ä¸‹é¢å°±æ˜¯ä¸€ä¸ªè®¢å•åˆ—è¡¨é¡µé¢çš„ä¸€ä¸ªå·¥å…·æ ï¼Œå•†å®¶å’Œä¹°å®¶éƒ½éœ€è¦æŸ¥çœ‹è®¢å•åˆ—è¡¨ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/10/03/101f3388d07488ee06baf31ed8bee003.jpg?wh=1120x305)

è®¢å•åˆ—è¡¨ä½¿ç”¨æœ€å¤šçš„å‡ ä¸ªåœºæ™¯åŒ…æ‹¬ï¼š

- æŸ¥çœ‹æ‰€æœ‰è®¢å•
- æŸ¥çœ‹æŸä¸ªçŠ¶æ€çš„è®¢å•ï¼ˆå¾…ä»˜æ¬¾ã€å¾…å‘è´§ã€å¾…æ”¶è´§ã€å¾…è¯„ä»·ã€é€€æ¬¾ï¼‰
- æœç´¢æŸä¸ªå•†å“ç›¸å…³çš„è®¢å•

ä¸€èˆ¬éƒ½ä¼šæŒ‰è®¢å•çš„åˆ›å»ºæ—¶é—´æ¥å±•ç¤ºè®¢å•ä¿¡æ¯ï¼Œæœ€æ–°åˆ›å»ºçš„è®¢å•æ’åœ¨æœ€å‰é¢ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå‡æƒ³çš„è®¢å•è¡¨ã€‚

```plain
create table t_order_detail(
  id bigint unsigned not null,
  seller_id bigint not null,
  buyer_id bigint not null,
  create_time datetime not null,
  modify_time datetime not null,
  order_status tinyint not null comment 'è®¢å•çŠ¶æ€: æœªä»˜æ¬¾ã€å·²ä»˜æ¬¾ã€å·²å‘è´§ã€å·²ç¡®è®¤æ”¶è´§ã€è®¢å•å…³é—­',
  refund_status tinyint not null comment 'é€€æ¬¾çŠ¶æ€ï¼šæœªé€€æ¬¾ã€é€€æ¬¾ä¸­ã€é€€æ¬¾å®Œæˆ',
  goods_id bigint comment 'å•†å“ID',
  goods_title varchar(255) comment 'å•†å“åç§°',
  buy_num int comment 'è´­ä¹°æ•°é‡',
  goods_price decimal(20,4) comment 'å•†å“å•ä»·',
  features varchar(256) comment 'å•†å“è§„æ ¼',
  discount decimal(20,4) comment 'ä¼˜æƒ é‡‘é¢',
  logis_id bigint comment 'ç‰©æµè®¢å•ç¼–å·',
  is_deleted tinyint not null comment 'æ˜¯å¦åˆ é™¤',
  descrition varchar(512) comment 'æè¿°ä¿¡æ¯',
  primary key(id),
  key idx_sellerid_createtime_sta(seller_id, create_time, order_status, refund_status),
  key idx_buyerid_createtime_sta(buyer_id, create_time, order_status, refund_status)
) engine=innodb;
```

è®¢å•åˆ—è¡¨æœ‰è¿™ä¹ˆå‡ ç±»SQLï¼š

```plain
select count(*) from t_order_detail where buyer_id = ? and create_time >= date_sub(now(), interval 90 day)  and order_status in (?) and refund_status in (?);
select * from t_order_detail where buyer_id = ? and create_time >= date_sub(now(), interval 90 day) and order_status in (?) and refund_status in (?) order by create_time desc limit M, N;
select count(*) from t_order_detail where seller_id = ? and create_time >= date_sub(now(), interval 90 day)  and order_status in (?) and refund_status in (?);
select * from t_order_detail where seller_id = ? and create_time >= date_sub(now(), interval 90 day) and order_status in (?) and refund_status in (?) order by create_time desc limit M, N;
```

ä¸Šé¢çš„SQLä¸­ï¼Œorder\_statuså’Œrefund\_statuså¯èƒ½ä¼ ï¼Œä¹Ÿå¯èƒ½ä¸ä¼ ï¼Œä¸»è¦çœ‹ç”¨æˆ·åœ¨å‰ç«¯é€‰æ‹©äº†å“ªäº›æ¡ä»¶ã€‚

æœ‰ä¸€äº›å¤§å•†å®¶ï¼Œè®¢å•çš„æ•°é‡å¯èƒ½éå¸¸å¤šï¼Œè¾¾åˆ°ç™¾ä¸‡ç”šè‡³åƒä¸‡çº§åˆ«ã€‚æœ‰ä¸€äº›å¤§ä¹°å®¶ä¹Ÿå¯èƒ½ä¼šæœ‰å¤§é‡çš„è®¢å•ï¼Œå¯èƒ½æœ‰ä¸Šä¸‡å•ã€‚

æˆ‘ä»¬éœ€è¦è€ƒè™‘å‡ ä¸ªé—®é¢˜ï¼š

- å¦‚ä½•é™ä½count(\*)çš„ä»£ä»·ï¼Ÿ
- å¦‚ä½•é™ä½order byçš„ä»£ä»·ï¼Ÿ
- ç¿»é¡µåˆ°å¾ˆåé¢æ—¶ï¼Œå¦‚ä½•é™ä½æŸ¥è¯¢çš„ä»£ä»·ï¼Ÿ

åŸºäºç´¢å¼•è®¿é—®çš„ç‰¹å¾ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆæ¥è®¾è®¡ï¼š

1. å¯¹äºcount(*)æŸ¥è¯¢ï¼Œæˆ‘ä»¬åˆ©ç”¨è¦†ç›–ç´¢å¼•ã€ç´¢å¼•æ¡ä»¶ä¸‹æ¨ç­‰ç‰¹æ€§ï¼Œå‡å°‘å¤§é‡çš„å›è¡¨æ“ä½œã€‚å‡è®¾æŸä¸ªç”¨æˆ·ä¸‹æœ‰ä¸€ä¸‡æ¡è®¢å•æ•°æ®ï¼Œç´¢å¼•æ¡ç›®é•¿åº¦æ§åˆ¶åœ¨äº”åå­—èŠ‚å†…ï¼Œé‚£ä¹ˆä¿å­˜è¿™äº›æ•°æ®å¤§çº¦éœ€è¦ä¸‰åå¤šä¸ªç´¢å¼•é¡µé¢ã€‚å¦‚æœè¦å›è¡¨ï¼Œé‚£ä¹ˆæ‰§è¡Œä¸€æ¬¡count(*)éœ€è¦è®¿é—®ä¸€ä¸‡å¤šä¸ªæ•°æ®é¡µï¼Œä¸å›è¡¨ï¼Œåˆ™åªéœ€è¦è®¿é—®ä¸‰åå¤šä¸ªæ•°æ®é¡µã€‚
2. å¯¹äºorder byï¼Œåˆ©ç”¨ç´¢å¼•çš„æœ‰åºæ€§æ¥é¿å…æ’åºã€‚è€ƒè™‘åˆ°order\_statusã€refund\_statuså¯èƒ½ä¸ä¼ ï¼Œä¹Ÿå¯èƒ½ä¼ å¤šä¸ªï¼Œéœ€è¦å°†create\_timeæ”¾åœ¨ç´¢å¼•çš„ç¬¬äºŒä¸ªå­—æ®µï¼Œå¦åˆ™å°±æ— æ³•é¿å…æ’åºäº†ã€‚è¿™é‡Œä¹Ÿè¯·ä½ æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœæ— æ³•é¿å…æ’åºï¼Œå¯¹æŸ¥è¯¢çš„æ€§èƒ½ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Ÿ
3. å¯¹äºç¿»é¡µæŸ¥è¯¢ï¼Œä¸€ä¸ªå¸¸ç”¨çš„æŠ€å·§æ˜¯å…ˆåœ¨ç´¢å¼•ä¸Šè·å–è®°å½•ä¸»é”®IDçš„åˆ†é¡µæ•°æ®ï¼Œç„¶åå†å…³è”åŸè¡¨è·å–æ•°æ®ã€‚

æŸ¥è¯¢æ”¹æˆä¸‹é¢è¿™ä¸ªå½¢å¼ã€‚ä½ å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼ŒæŸ¥è¯¢æ”¹å†™å‰åï¼Œåœ¨æ‰§è¡Œæ—¶ä¼šæœ‰ä»€ä¹ˆåŒºåˆ«ã€‚

```plain
select t2.* from (
    select id from t_order_detail 
	where  seller_id = ? 
	and create_time >= date_sub(now(), interval 90 day) 
	and order_status in (?) 
	and refund_status in (?) 
	order by create_time desc limit M, N)
) t1 straight_join t_order_detail t2
where t1.id = t2.id
```

ä¸‹é¢æ˜¯ä½¿ç”¨ç´¢å¼•è¿›è¡Œåˆ†é¡µæ“ä½œçš„ä¸€ä¸ªç¤ºæ„å›¾ï¼Œå¯ä»¥å‡å°‘å›è¡¨çš„æ¬¡æ•°ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/27/5c/27a1bb7529c127c5cbca8f08ce70635c.jpg?wh=1196x566)

æœ€åè¿˜éœ€è¦æä¸€ç‚¹ï¼Œè™½ç„¶ä½¿ç”¨è¦†ç›–ç´¢å¼•å¯ä»¥å‡å°‘å›è¡¨çš„æ¬¡æ•°ï¼Œä½†æ˜¯ç”±äºInnoDB MVCCå®ç°æœºåˆ¶çš„åŸå› ï¼Œå³ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œä¹Ÿæ˜¯æœ‰å¯èƒ½è¦å›è¡¨çš„ï¼Œå› ä¸ºæ„å»ºè®°å½•çš„ä¸€è‡´æ€§ç‰ˆæœ¬æ—¶ï¼Œéœ€è¦ç”¨åˆ°èšç°‡ç´¢å¼•ä¸­çš„éšè—å­—æ®µdb\_roll\_ptrã€db\_trx\_idï¼Œè¿™ä¸€éƒ¨åˆ†çš„å†…å®¹æˆ‘ä»¬ä¼šåœ¨InnoDBå­˜å‚¨å¼•æ“ç¯‡é‡Œå†åšè¯¦ç»†ä»‹ç»ã€‚

## æ€»ç»“

ç»“åˆä¸Šä¸€è®²çš„å†…å®¹ï¼Œæˆ‘ä»¬å·²ç»æŠŠå•ä¸ªè¡¨çš„è®¿é—®åšäº†æ¯”è¾ƒå…¨é¢åœ°ä»‹ç»ã€‚ç´¢å¼•åœ¨SQLä¼˜åŒ–ä¸­æœ‰éå¸¸é‡è¦çš„ä½œç”¨ã€‚å¹³æ—¶åœ¨å»ºç´¢å¼•æ—¶ï¼Œæœ‰å‡ ä¸ªé—®é¢˜éœ€è¦è€ƒè™‘ï¼Œä¸€æ˜¯åº”è¯¥æŠŠå“ªäº›å­—æ®µåŠ åˆ°ç´¢å¼•ä¸­ï¼ŒäºŒæ˜¯ç´¢å¼•ä¸­å­—æ®µçš„é¡ºåºå¦‚ä½•æ’åˆ—ã€‚

æˆ‘ä»¬éœ€è¦è€ƒè™‘ç´¢å¼•çš„è¿‡æ»¤æ€§ï¼Œè¿™é‡Œæ˜¯æŒ‡ç´¢å¼•å‰ç¼€å­—æ®µç»„åˆçš„è¿‡æ»¤æ€§ã€‚è¿˜è¦æ ¹æ®ä¸šåŠ¡çš„æ•°æ®åˆ†å¸ƒæƒ…å†µå’Œè®¿é—®éœ€æ±‚ï¼Œç»¼åˆè€ƒè™‘ã€‚æ¯æ–°å¢ä¸€ä¸ªç´¢å¼•éƒ½ä¼šå¸¦æ¥é¢å¤–çš„ç»´æŠ¤æˆæœ¬ï¼Œå› æ­¤æˆ‘ä»¬è¦é¿å…åˆ›å»ºé‡å¤çš„ç´¢å¼•ã€‚å°½é‡ä½¿ç”¨ä¸€äº›ç²¾ç‚¼çš„ç´¢å¼•æ¥æ»¡è¶³ä¸šåŠ¡çš„æŸ¥è¯¢éœ€æ±‚ã€‚

## æ€è€ƒé¢˜

å›åˆ°æˆ‘ä»¬å‰é¢é‚£ä¸ªè®¢å•åˆ—è¡¨çš„åœºæ™¯ï¼Œæœ‰ä¸€å¤©ï¼Œäº§å“å†³å®šè¦åšä¸€ä¸ªè®¢å•åˆ é™¤çš„åŠŸèƒ½ï¼Œæ–¹ä¾¿ç”¨æˆ·å°†ä¸€äº›ä¸æƒ³è®©äººçœ‹åˆ°è®¢å•éšè—èµ·æ¥ã€‚ç›¸åº”åœ°ï¼Œä¸šåŠ¡SQLéœ€è¦åšä¸€äº›ç›¸åº”çš„è°ƒæ•´ï¼Œwhereæ¡ä»¶ä¸­éœ€è¦å¢åŠ is\_deletedçš„æ¡ä»¶ã€‚

```plain
select count(*)
from t_order_detail
where seller_id = ? 
and order_status in (?) 
and refund_status in(?) 
and is_deleted=0;


select t2.* from (
  select id
  from t_order_detail
  where seller_id = ? 
  and order_status in (?) 
  and refund_status in(?) 
  and is_deleted=0
  order by create_time
limit M, N) t1 straight_join t_order_detail t2
where t1.id = t2.id;
```

ä½œä¸ºä¸€åç ”å‘äººå‘˜ï¼Œæˆ–è€…æ˜¯ä¸€åDBAï¼Œæ¥åˆ°è¿™ä¸ªéœ€æ±‚åï¼Œåœ¨æ•°æ®åº“è¿™ä¸€å±‚ï¼Œæœ‰å“ªäº›éœ€è¦è€ƒè™‘çš„åœ°æ–¹ï¼Ÿä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œä½ ä¼šæ€æ ·åšï¼Ÿ

æœŸå¾…ä½ çš„æ€è€ƒï¼Œæ¬¢è¿åœ¨ç•™è¨€åŒºä¸­ä¸æˆ‘äº¤æµã€‚å¦‚æœä»Šå¤©çš„è¯¾ç¨‹è®©ä½ æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿è½¬å‘ç»™æœ‰éœ€è¦çš„æœ‹å‹ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ7ï¼‰</strong></div><ul>
<li><span>ç¬™ é¸¢</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œindex intersectè¿™å—â€œä½¿ç”¨äº†ç´¢å¼• idx_b, idx_câ€ï¼Œå¥½åƒæœ‰ç‚¹é—®é¢˜å§</p>2024-12-02</li><br/><li><span>ç¬™ é¸¢</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>def range_clustered_cost(rows, leaf_pages, min_record_len, clustered_index_size, in_mem_pct): io_cost = primary_key_scan_cost(rows, leaf_pages, min_record_len, clustered_index_size, in_mem_pct) result = io_cost + row_eval_cost(rows) + 0.01 return result
def range_clustered_cost_total(rows, leaf_pages, min_record_len, clustered_index_size, in_mem_pct): range_cost = range_clustered_cost(rows, leaf_pages, min_record_len, clustered_index_size, in_mem_pct) return range_cost + row_eval_cost(rows)
è¿™ä¸ªç¬¬äºŒä¸ªå‡½æ•°æ˜¯ä¸æ˜¯æ²¡ç”¨å•Šï¼Œæˆ–è€…æœ‰å…¶ä»–ç®—æ³•è¿™é‡Œæ²¡å…·ä½“è®²ï¼Ÿï¼Ÿæˆ‘çœ‹è¿™ä¸ªåˆåŠ äº†ä¸€érow_eval(rows)ï¼Œæœ‰ç‚¹è¿·æƒ‘æ€§å•Šã€‚ã€‚ã€‚ã€‚ã€‚</p>2024-12-02</li><br/><li><span>mw</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è€å¸ˆ è¯·æ•™ä¸ªé—®é¢˜ æœ‰ä¸ªä¸‹é¢çš„æŸ¥è¯¢ï¼Œ
1ã€ä¸ºå•¥æ‰€æœ‰å‰ç¼€æ¡ä»¶éƒ½æ˜¯ç­‰äºï¼Œè¿™é‡Œçš„typeæ˜¯rangeï¼Œè¿™é‡Œåº•å±‚æŸ¥æ‰¾æ•°æ®æ˜¯æ€æ ·çš„å‘¢
2ã€ç¥å¥‡çš„ç°è±¡æ˜¯ignore indexï¼ˆposts_entle_root_parent_IDXï¼‰ä¹‹å type åˆå˜æˆäº†refï¼Œè¿˜æ˜¯ä½¿ç”¨idx_posts_entle_posts_id_like_countç´¢å¼•ã€‚
3ã€æµ‹è¯•èµ°çš„rangeï¼Œçº¿ä¸Šèµ°çš„refï¼Œçº¿ä¸Šç¯å¢ƒæŸ¥è¯¢æ…¢ï¼Œç›®å‰æƒ³åˆ°çš„åŠæ³•æ˜¯optimize tableï¼Œæ€€ç–‘æ˜¯ç´¢å¼•å’Œè¡¨ä¿¡æ¯çš„å½±å“ï¼Œè¿˜æœ‰å…¶ä»–æ–¹æ³•å—
æ‰§è¡Œè®¡åˆ’ï¼š
mysql&gt; desc select * from posts_entle where posts_id=16700 and root_parent=0 and status=1 order by like_count desc limit 0,10\G
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: posts_entle
   partitions: NULL
         type: range
possible_keys: posts_entle_root_parent_IDX,idx_posts_entle_posts_id_like_count,idx_posts_entle_posts_id_create_at
          key: idx_posts_entle_posts_id_like_count
      key_len: 20
          ref: NULL
         rows: 756733
     filtered: 100.00
        Extra: Using index condition
ç´¢å¼•æ˜¯ï¼š `idx_posts_entle_posts_id_like_count` (`posts_id`,`root_parent`,`status`,`like_count`)
              `posts_entle_root_parent_IDX` (`root_parent`)</p>2024-10-25</li><br/><li><span>å¶æ˜</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é¦–å…ˆï¼ŒæŸ¥è¯¢ä¸­å¤šäº† is_deleted=0 çš„æ¡ä»¶ï¼Œé‚£ä¹ˆåŸæ¥çš„ç´¢å¼• idx_sellerid_createtime_sta å’Œ idx_buyerid_createtime_sta åº”è¯¥åŠ ä¸Š is_deleted è¿™ä¸€åˆ—ï¼Œå› ä¸ºå¦‚æœä¸åŠ ä¸Šï¼Œé‚£ä¹ˆæ— è®ºæ˜¯
ç»Ÿè®¡æŸ¥è¯¢è¿˜æ˜¯æ˜ç»†æŸ¥è¯¢éƒ½å¿…é¡»è¦å›è¡¨ï¼Œè¿™ä¸ªä»£ä»·æœ‰ç‚¹é«˜ã€‚

æ—¢ç„¶è¦å°†å­—æ®µ is_deleted åŠ å…¥åˆ°ç´¢å¼•ä¸­ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±è¦è€ƒè™‘å°†è¯¥å­—æ®µæ”¾åˆ°ç´¢å¼•ä¸­å“ªä¸ªä½ç½®ä¸Šï¼Œis_deleted å­—æ®µå…·æœ‰ä¸¤ä¸ªç‰¹å¾ï¼Œä¸€æ˜¯ç­‰å€¼æŸ¥è¯¢ï¼ŒäºŒæ˜¯å…¶å€¼ç»å¤§å¤šæ•°ä¸º 0ï¼ŒåŒºåˆ†åº¦ä¸é«˜ï¼Œ
è€ƒè™‘åˆ° order_statusã€refund_status å¯èƒ½ä¸ä¼ ï¼Œä¹Ÿå¯èƒ½ä¼ å¤šä¸ªï¼Œè€Œ create_time æ˜¯èŒƒå›´æŸ¥è¯¢ï¼Œå¦‚æœæ”¾åœ¨ create_time åé¢ï¼Œindex push down æ˜¯èƒ½åˆ©ç”¨ä¸Š is_deleted å­—æ®µï¼Œä½†è¿™å°±å¾—é¢å¤–çš„æ’åºæ“ä½œäº†ã€‚
å› æ­¤åº”è¯¥æ”¾åœ¨ create_time å‰ï¼Œseller_id&#47;buyer_id åã€‚

key idx_sellerid_createtime_sta(seller_id, create_time, order_status, refund_status), 
key idx_buyerid_createtime_sta(buyer_id, create_time, order_status, refund_status)

è€å¸ˆæ€ä¹ˆä¸è§£ç­”ç•™è¨€äº†ï¼Ÿå¦å¤–æ€è€ƒé¢˜ä¹Ÿæ²¡è§£ç­”äº†ï¼Œå¸Œæœ›è€å¸ˆæœ‰ç©ºæ—¶å¯ä»¥è®²è§£ä¸‹ï¼Œæœ‰çš„æ–‡ç« å¤ªæ·±ï¼Œè¯»èµ·æ¥æŒºåƒåŠ›ã€‚</p>2024-10-09</li><br/><li><span>binzhang</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¯ä»¥è®©order statusæ”¯æŒè¿™ä¸ªéœ€æ±‚ã€‚é¿å…åŠ åˆ—å’Œé‡å»ºç´¢å¼•ç­‰å·¥ä½œã€‚æ¯”æ–¹è¯´order status &gt; 100 çš„å°± è¡¨ç¤ºè¢«é€»è¾‘åˆ é™¤ã€‚order status in ï¼ˆ1ï¼Œ101ï¼‰è¡¨ç¤ºæ–°order ç­‰ç­‰ã€‚é€šå¸¸ä½¿ç”¨ä½è¿ç®— bitand è¿™æ ·ä¸€ä¸ªåˆ—å¯ä»¥è¡¨è¾¾å¤šä¸ªé€»è¾‘ã€‚</p>2024-10-09</li><br/><li><span>123</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ€è€ƒé¢˜ï¼š
å¯¹äºé€»è¾‘åˆ é™¤ï¼Œå¯ä»¥åœ¨éœ€è¦ä½¿ç”¨åˆ°çš„è”åˆç´¢å¼•ä¸­åŠ å…¥å­—æ®µï¼Œæ³¨æ„æ·»åŠ çš„ä½ç½®ï¼Œéœ€è¦åœ¨æ’åºçš„å­—æ®µä¹‹åï¼Œç„¶åé€šè¿‡ç´¢å¼•æ¡ä»¶ä¸‹æ¨ï¼Œå¯ä»¥åœ¨å†…å­˜ä¸­è¿›è¡Œç­›é€‰ï¼Œå¯¹æ€§èƒ½çš„å½±å“ä¸å¤§ï¼›ä½†æ˜¯è¿˜æ˜¯æ³¨æ„åŠ å­—æ®µçš„æƒ…å†µï¼Œç”±äºMySQL8.0æ”¯æŒåœ¨çº¿DDLï¼Œæ‰€ä»¥åº”è¯¥ä¹Ÿå¯ä»¥å¿«é€Ÿå®Œæˆï¼›</p>2024-10-08</li><br/><li><span>ä¸€æœ¬ä¹¦</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>â€œIndex Dive æ˜¯æ€ä¹ˆå·¥ä½œçš„â€è¿™ä¸€èŠ‚ä¸­ï¼Œ&quot;Index Dive é€šå¸¸éƒ½èƒ½è·å¾—èŒƒå›´å†…è®°å½•æ•°æ®æ¯”è¾ƒå‡†ç¡®çš„ä¼°è®¡ã€‚&quot;è¿™å¥è¯æŒ‡çš„æ˜¯è®°å½•æ•°å°äºç­‰äº 8 ä¸ªé¡µé¢çš„åœºæ™¯ä¸‹å—ï¼Ÿå¦‚æœåŒºé—´å†…è®°å½•æ•°è¶…è¿‡ 8 ä¸ªé¡µé¢ï¼Œè®°å½•æ•°å°±æ˜¯ä¼°ç®—å€¼ï¼Œè¿”å›çš„ç»“æœå¤§æ¦‚æ˜¯å®é™…è¡Œæ•°çš„2å€ï¼Œè¿™å·²ç»ä¸èƒ½ç§°å¾—ä¸Šæ˜¯å‡†ç¡®äº†å§ï¼Ÿ</p>2024-10-08</li><br/>
</ul>