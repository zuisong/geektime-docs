ä½ å¥½ï¼Œæˆ‘æ˜¯ä¿Šè¾¾ã€‚

ä¸Šä¸€è®²ä¸­æˆ‘ä»¬ä»‹ç»äº†ä¼˜åŒ–å™¨çš„å·¥ä½œåŸç†ï¼Œå¹¶ä»‹ç»äº†å…¨è¡¨æ‰«æå’Œç´¢å¼•èŒƒå›´æ‰«æçš„æˆæœ¬è¯„ä¼°æ–¹æ³•ã€‚åœ¨è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬ç»§ç»­æ¥å­¦ä¹ å•è¡¨æŸ¥è¯¢çš„å…¶ä»–å‡ ç§è®¿é—®è·¯å¾„ï¼šREFã€è¦†ç›–ç´¢å¼•ã€MRRã€Index Mergeã€‚æœ€åï¼Œæˆ‘ä»¬è¿˜å°†é€šè¿‡ä¸€ä¸ªçœŸå®çš„ä¸šåŠ¡åœºæ™¯ï¼Œæ¥è®¨è®ºæ€ä¹ˆç»™ä¸šåŠ¡åˆ›å»ºä¸€ä¸ªåˆé€‚çš„ç´¢å¼•ã€‚

## æµ‹è¯•è¡¨

è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬ä¾ç„¶ä¼šä½¿ç”¨18è®²å¼€å¤´åˆ›å»ºçš„é‚£ä¸ªæµ‹è¯•è¡¨ï¼Œè¿™ä¸ªè¡¨çš„è¡¨ç»“æ„å’Œç»Ÿè®¡ä¿¡æ¯æƒ…å†µå¦‚ä¸‹ï¼š

```plain
mysql> show create table tab\G
*************************** 1. row ***************************
       Table: tab
Create Table: CREATE TABLE `tab` (
  `id` int NOT NULL,
  `a` int NOT NULL,
  `b` int NOT NULL,
  `c` int NOT NULL,
  `padding` varchar(7000) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_abc` (`a`,`b`,`c`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci


mysql> select * from mysql.innodb_table_stats where table_name = 'tab'\G
*************************** 1. row ***************************
           database_name: rep
              table_name: tab
             last_update: 2024-02-26 17:37:12
                  n_rows: 9913
    clustered_index_size: 161
sum_of_other_index_sizes: 17
```
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ7ï¼‰</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/3c/4a/fe/7b6bd101.jpg" width="30px"><span>ç¬™ é¸¢</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œindex intersectè¿™å—â€œä½¿ç”¨äº†ç´¢å¼• idx_b, idx_câ€ï¼Œå¥½åƒæœ‰ç‚¹é—®é¢˜å§</div>2024-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/3c/4a/fe/7b6bd101.jpg" width="30px"><span>ç¬™ é¸¢</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>def range_clustered_cost(rows, leaf_pages, min_record_len, clustered_index_size, in_mem_pct): io_cost = primary_key_scan_cost(rows, leaf_pages, min_record_len, clustered_index_size, in_mem_pct) result = io_cost + row_eval_cost(rows) + 0.01 return result
def range_clustered_cost_total(rows, leaf_pages, min_record_len, clustered_index_size, in_mem_pct): range_cost = range_clustered_cost(rows, leaf_pages, min_record_len, clustered_index_size, in_mem_pct) return range_cost + row_eval_cost(rows)
è¿™ä¸ªç¬¬äºŒä¸ªå‡½æ•°æ˜¯ä¸æ˜¯æ²¡ç”¨å•Šï¼Œæˆ–è€…æœ‰å…¶ä»–ç®—æ³•è¿™é‡Œæ²¡å…·ä½“è®²ï¼Ÿï¼Ÿæˆ‘çœ‹è¿™ä¸ªåˆåŠ äº†ä¸€érow_eval(rows)ï¼Œæœ‰ç‚¹è¿·æƒ‘æ€§å•Šã€‚ã€‚ã€‚ã€‚ã€‚</div>2024-12-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/83/6a/6f04edbd.jpg" width="30px"><span>mw</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>è€å¸ˆ è¯·æ•™ä¸ªé—®é¢˜ æœ‰ä¸ªä¸‹é¢çš„æŸ¥è¯¢ï¼Œ
1ã€ä¸ºå•¥æ‰€æœ‰å‰ç¼€æ¡ä»¶éƒ½æ˜¯ç­‰äºï¼Œè¿™é‡Œçš„typeæ˜¯rangeï¼Œè¿™é‡Œåº•å±‚æŸ¥æ‰¾æ•°æ®æ˜¯æ€æ ·çš„å‘¢
2ã€ç¥å¥‡çš„ç°è±¡æ˜¯ignore indexï¼ˆposts_entle_root_parent_IDXï¼‰ä¹‹å type åˆå˜æˆäº†refï¼Œè¿˜æ˜¯ä½¿ç”¨idx_posts_entle_posts_id_like_countç´¢å¼•ã€‚
3ã€æµ‹è¯•èµ°çš„rangeï¼Œçº¿ä¸Šèµ°çš„refï¼Œçº¿ä¸Šç¯å¢ƒæŸ¥è¯¢æ…¢ï¼Œç›®å‰æƒ³åˆ°çš„åŠæ³•æ˜¯optimize tableï¼Œæ€€ç–‘æ˜¯ç´¢å¼•å’Œè¡¨ä¿¡æ¯çš„å½±å“ï¼Œè¿˜æœ‰å…¶ä»–æ–¹æ³•å—
æ‰§è¡Œè®¡åˆ’ï¼š
mysql&gt; desc select * from posts_entle where posts_id=16700 and root_parent=0 and status=1 order by like_count desc limit 0,10\G
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: posts_entle
   partitions: NULL
         type: range
possible_keys: posts_entle_root_parent_IDX,idx_posts_entle_posts_id_like_count,idx_posts_entle_posts_id_create_at
          key: idx_posts_entle_posts_id_like_count
      key_len: 20
          ref: NULL
         rows: 756733
     filtered: 100.00
        Extra: Using index condition
ç´¢å¼•æ˜¯ï¼š `idx_posts_entle_posts_id_like_count` (`posts_id`,`root_parent`,`status`,`like_count`)
              `posts_entle_root_parent_IDX` (`root_parent`)</div>2024-10-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/8d/4d/992070e8.jpg" width="30px"><span>å¶æ˜</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>é¦–å…ˆï¼ŒæŸ¥è¯¢ä¸­å¤šäº† is_deleted=0 çš„æ¡ä»¶ï¼Œé‚£ä¹ˆåŸæ¥çš„ç´¢å¼• idx_sellerid_createtime_sta å’Œ idx_buyerid_createtime_sta åº”è¯¥åŠ ä¸Š is_deleted è¿™ä¸€åˆ—ï¼Œå› ä¸ºå¦‚æœä¸åŠ ä¸Šï¼Œé‚£ä¹ˆæ— è®ºæ˜¯
ç»Ÿè®¡æŸ¥è¯¢è¿˜æ˜¯æ˜ç»†æŸ¥è¯¢éƒ½å¿…é¡»è¦å›è¡¨ï¼Œè¿™ä¸ªä»£ä»·æœ‰ç‚¹é«˜ã€‚

æ—¢ç„¶è¦å°†å­—æ®µ is_deleted åŠ å…¥åˆ°ç´¢å¼•ä¸­ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±è¦è€ƒè™‘å°†è¯¥å­—æ®µæ”¾åˆ°ç´¢å¼•ä¸­å“ªä¸ªä½ç½®ä¸Šï¼Œis_deleted å­—æ®µå…·æœ‰ä¸¤ä¸ªç‰¹å¾ï¼Œä¸€æ˜¯ç­‰å€¼æŸ¥è¯¢ï¼ŒäºŒæ˜¯å…¶å€¼ç»å¤§å¤šæ•°ä¸º 0ï¼ŒåŒºåˆ†åº¦ä¸é«˜ï¼Œ
è€ƒè™‘åˆ° order_statusã€refund_status å¯èƒ½ä¸ä¼ ï¼Œä¹Ÿå¯èƒ½ä¼ å¤šä¸ªï¼Œè€Œ create_time æ˜¯èŒƒå›´æŸ¥è¯¢ï¼Œå¦‚æœæ”¾åœ¨ create_time åé¢ï¼Œindex push down æ˜¯èƒ½åˆ©ç”¨ä¸Š is_deleted å­—æ®µï¼Œä½†è¿™å°±å¾—é¢å¤–çš„æ’åºæ“ä½œäº†ã€‚
å› æ­¤åº”è¯¥æ”¾åœ¨ create_time å‰ï¼Œseller_id&#47;buyer_id åã€‚

key idx_sellerid_createtime_sta(seller_id, create_time, order_status, refund_status), 
key idx_buyerid_createtime_sta(buyer_id, create_time, order_status, refund_status)

è€å¸ˆæ€ä¹ˆä¸è§£ç­”ç•™è¨€äº†ï¼Ÿå¦å¤–æ€è€ƒé¢˜ä¹Ÿæ²¡è§£ç­”äº†ï¼Œå¸Œæœ›è€å¸ˆæœ‰ç©ºæ—¶å¯ä»¥è®²è§£ä¸‹ï¼Œæœ‰çš„æ–‡ç« å¤ªæ·±ï¼Œè¯»èµ·æ¥æŒºåƒåŠ›ã€‚</div>2024-10-09</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM59PTNiaDASVicbVaeWBU1WKmOgyHcqVtl85nDwAqDicib1EUKE2RRoU0x0vZctZO4kbPDUTTke8qKfAw/132" width="30px"><span>binzhang</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>å¯ä»¥è®©order statusæ”¯æŒè¿™ä¸ªéœ€æ±‚ã€‚é¿å…åŠ åˆ—å’Œé‡å»ºç´¢å¼•ç­‰å·¥ä½œã€‚æ¯”æ–¹è¯´order status &gt; 100 çš„å°± è¡¨ç¤ºè¢«é€»è¾‘åˆ é™¤ã€‚order status in ï¼ˆ1ï¼Œ101ï¼‰è¡¨ç¤ºæ–°order ç­‰ç­‰ã€‚é€šå¸¸ä½¿ç”¨ä½è¿ç®— bitand è¿™æ ·ä¸€ä¸ªåˆ—å¯ä»¥è¡¨è¾¾å¤šä¸ªé€»è¾‘ã€‚</div>2024-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/a1/d8/42252c48.jpg" width="30px"><span>123</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æ€è€ƒé¢˜ï¼š
å¯¹äºé€»è¾‘åˆ é™¤ï¼Œå¯ä»¥åœ¨éœ€è¦ä½¿ç”¨åˆ°çš„è”åˆç´¢å¼•ä¸­åŠ å…¥å­—æ®µï¼Œæ³¨æ„æ·»åŠ çš„ä½ç½®ï¼Œéœ€è¦åœ¨æ’åºçš„å­—æ®µä¹‹åï¼Œç„¶åé€šè¿‡ç´¢å¼•æ¡ä»¶ä¸‹æ¨ï¼Œå¯ä»¥åœ¨å†…å­˜ä¸­è¿›è¡Œç­›é€‰ï¼Œå¯¹æ€§èƒ½çš„å½±å“ä¸å¤§ï¼›ä½†æ˜¯è¿˜æ˜¯æ³¨æ„åŠ å­—æ®µçš„æƒ…å†µï¼Œç”±äºMySQL8.0æ”¯æŒåœ¨çº¿DDLï¼Œæ‰€ä»¥åº”è¯¥ä¹Ÿå¯ä»¥å¿«é€Ÿå®Œæˆï¼›</div>2024-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/39/93/f0247cf8.jpg" width="30px"><span>ä¸€æœ¬ä¹¦</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>â€œIndex Dive æ˜¯æ€ä¹ˆå·¥ä½œçš„â€è¿™ä¸€èŠ‚ä¸­ï¼Œ&quot;Index Dive é€šå¸¸éƒ½èƒ½è·å¾—èŒƒå›´å†…è®°å½•æ•°æ®æ¯”è¾ƒå‡†ç¡®çš„ä¼°è®¡ã€‚&quot;è¿™å¥è¯æŒ‡çš„æ˜¯è®°å½•æ•°å°äºç­‰äº 8 ä¸ªé¡µé¢çš„åœºæ™¯ä¸‹å—ï¼Ÿå¦‚æœåŒºé—´å†…è®°å½•æ•°è¶…è¿‡ 8 ä¸ªé¡µé¢ï¼Œè®°å½•æ•°å°±æ˜¯ä¼°ç®—å€¼ï¼Œè¿”å›çš„ç»“æœå¤§æ¦‚æ˜¯å®é™…è¡Œæ•°çš„2å€ï¼Œè¿™å·²ç»ä¸èƒ½ç§°å¾—ä¸Šæ˜¯å‡†ç¡®äº†å§ï¼Ÿ</div>2024-10-08</li><br/>
</ul>