ä½ å¥½ï¼Œæˆ‘æ˜¯å”èªã€‚

åœ¨ä½¿ç”¨etcdçš„è¿‡ç¨‹ä¸­ï¼Œä½ æ˜¯å¦è¢«æ—¥å¿—ä¸­çš„"apply request took too long"å’Œâ€œetcdserver: request timed out"ç­‰é«˜å»¶æ—¶ç°è±¡å›°æ‰°è¿‡ï¼Ÿå®ƒä»¬æ˜¯ç”±ä»€ä¹ˆåŸå› å¯¼è‡´çš„å‘¢ï¼Ÿæˆ‘ä»¬åº”è¯¥å¦‚ä½•æ¥åˆ†æè¿™äº›é—®é¢˜ï¼Ÿ

è¿™å°±æ˜¯æˆ‘ä»Šå¤©è¦å’Œä½ åˆ†äº«çš„ä¸»é¢˜ï¼šetcdå»¶æ—¶ã€‚å¸Œæœ›é€šè¿‡è¿™èŠ‚è¯¾ï¼Œå¸®åŠ©ä½ æŒæ¡etcdå»¶æ—¶æŠ–åŠ¨ã€è¶…æ—¶èƒŒåçš„å¸¸è§åŸå› å’Œåˆ†ææ–¹æ³•ï¼Œå½“ä½ é‡åˆ°ç±»ä¼¼é—®é¢˜æ—¶ï¼Œèƒ½ç‹¬ç«‹å®šä½ã€è§£å†³ã€‚åŒæ—¶ï¼Œå¸®åŠ©ä½ åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œåˆç†é…ç½®é›†ç¾¤ï¼Œéµå¾ªæœ€ä½³å®è·µï¼Œå°½é‡å‡å°‘expensive requestï¼Œé¿å…etcdè¯·æ±‚å‡ºç°è¶…æ—¶ã€‚

## åˆ†ææ€è·¯åŠå·¥å…·

é¦–å…ˆï¼Œå½“æˆ‘ä»¬é¢å¯¹ä¸€ä¸ªé«˜å»¶æ—¶çš„è¯·æ±‚æ¡ˆä¾‹åï¼Œå¦‚ä½•æ¢³ç†é—®é¢˜å®šä½æ€è·¯å‘¢ï¼Ÿ

çŸ¥å½¼çŸ¥å·±ï¼Œæ–¹èƒ½ç™¾æˆ˜ä¸æ®†ï¼Œå®šä½é—®é¢˜ä¹Ÿæ˜¯ç±»ä¼¼ã€‚é¦–å…ˆæˆ‘ä»¬å¾—å¼„æ¸…æ¥šäº§ç”Ÿé—®é¢˜çš„åŸç†ã€æµç¨‹ï¼Œåœ¨[02](https://time.geekbang.org/column/article/335932)ã€[03](https://time.geekbang.org/column/article/336766)ã€[04](https://time.geekbang.org/column/article/337604)ä¸­æˆ‘å·²ä¸ºä½ ä»‹ç»è¿‡è¯»å†™è¯·æ±‚çš„æ ¸å¿ƒé“¾è·¯ã€‚å…¶æ¬¡æ˜¯ç†Ÿç»ƒæŒæ¡ç›¸å…³å·¥å…·ï¼Œå€ŸåŠ©å®ƒä»¬ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿæ”»ç ´ç–‘éš¾æ‚ç—‡ã€‚

è¿™é‡Œæˆ‘ä»¬å†å›é¡¾ä¸‹03ä¸­ä»‹ç»çš„ï¼ŒLeaderæ”¶åˆ°ä¸€ä¸ªå†™è¯·æ±‚ï¼Œå°†ä¸€ä¸ªæ—¥å¿—æ¡ç›®å¤åˆ¶åˆ°é›†ç¾¤å¤šæ•°èŠ‚ç‚¹å¹¶åº”ç”¨åˆ°å­˜å‚¨çŠ¶æ€æœºçš„æµç¨‹ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼Œé€šè¿‡æ­¤å›¾æˆ‘ä»¬çœ‹çœ‹å†™æµç¨‹ä¸Šå“ªäº›åœ°æ–¹å¯èƒ½ä¼šå¯¼è‡´è¯·æ±‚è¶…æ—¶å‘¢ï¼Ÿ

![](https://static001.geekbang.org/resource/image/df/2c/df9yy18a1e28e18295cfc15a28cd342c.png?wh=1920%2A1328)

é¦–å…ˆæ˜¯æµç¨‹å››ï¼Œä¸€æ–¹é¢ï¼ŒLeaderéœ€è¦å¹¶è¡Œå°†æ¶ˆæ¯é€šè¿‡ç½‘ç»œå‘é€ç»™å„FollowerèŠ‚ç‚¹ï¼Œä¾èµ–ç½‘ç»œæ€§èƒ½ã€‚å¦ä¸€æ–¹é¢ï¼ŒLeaderéœ€æŒä¹…åŒ–æ—¥å¿—æ¡ç›®åˆ°WALï¼Œä¾èµ–ç£ç›˜I/Oé¡ºåºå†™å…¥æ€§èƒ½ã€‚

å…¶æ¬¡æ˜¯æµç¨‹å…«ï¼Œåº”ç”¨æ—¥å¿—æ¡ç›®åˆ°å­˜å‚¨çŠ¶æ€æœºæ—¶ï¼Œetcdåç«¯key-valueå­˜å‚¨å¼•æ“æ˜¯boltdbã€‚æ­£å¦‚æˆ‘ä»¬[10](https://time.geekbang.org/column/article/342527)æ‰€ä»‹ç»çš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŸºäºB+ treeå®ç°çš„å­˜å‚¨å¼•æ“ï¼Œå½“ä½ å†™å…¥æ•°æ®ï¼Œæäº¤äº‹åŠ¡æ—¶ï¼Œå®ƒä¼šå°†dirty pageæŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­boltdbä¼šäº§ç”Ÿç£ç›˜éšæœºI/Oå†™å…¥ï¼Œå› æ­¤äº‹åŠ¡æäº¤æ€§èƒ½ä¾èµ–ç£ç›˜I/Oéšæœºå†™å…¥æ€§èƒ½ã€‚

æœ€åï¼Œåœ¨æ•´ä¸ªå†™æµç¨‹å¤„ç†è¿‡ç¨‹ä¸­ï¼ŒetcdèŠ‚ç‚¹çš„CPUã€å†…å­˜ã€ç½‘ç»œå¸¦å®½èµ„æºåº”å……è¶³ï¼Œå¦åˆ™è‚¯å®šä¹Ÿä¼šå½±å“æ€§èƒ½ã€‚

åˆæ­¥äº†è§£å®Œå¯èƒ½å¯¼è‡´å»¶æ—¶æŠ–åŠ¨çš„ç“¶é¢ˆå¤„ä¹‹åï¼Œæˆ‘ç»™ä½ æ€»ç»“äº†etcdé—®é¢˜å®šä½è¿‡ç¨‹ä¸­å¸¸ç”¨çš„å·¥å…·ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢è¿™å¹…å›¾ã€‚

![](https://static001.geekbang.org/resource/image/b5/fc/b5bb69c8effda97f2ef78b067ab1aafc.png?wh=1920%2A1300)

å›¾çš„å·¦è¾¹æ˜¯è¯»å†™è¯·æ±‚é“¾è·¯ä¸­å¯èƒ½å‡ºç°ç“¶é¢ˆæˆ–å¼‚å¸¸çš„ç‚¹ï¼Œæ¯”å¦‚ä¸Šé¢æµç¨‹åˆ†æä¸­æåˆ°çš„ç£ç›˜ã€å†…å­˜ã€CPUã€ç½‘ç»œèµ„æºã€‚

å›¾çš„å³è¾¹æ˜¯å¸¸ç”¨çš„å·¥å…·ï¼Œåˆ†åˆ«æ˜¯metricsã€traceæ—¥å¿—ã€etcdå…¶ä»–æ—¥å¿—ã€WALåŠboltdbåˆ†æå·¥å…·ç­‰ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘åŸºäºè¯»å†™è¯·æ±‚çš„æ ¸å¿ƒé“¾è·¯å’Œå…¶å¯èƒ½å‡ºç°çš„ç“¶é¢ˆç‚¹ï¼Œç»“åˆç›¸å…³çš„å·¥å…·ï¼Œä¸ºä½ æ·±å…¥åˆ†æetcdå»¶æ—¶æŠ–åŠ¨çš„å®šä½æ–¹æ³•å’ŒåŸå› ã€‚

## ç½‘ç»œ

é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹æµç¨‹å›¾ä¸­ç¬¬ä¸€ä¸ªæåˆ°å¯èƒ½ç“¶é¢ˆç‚¹ï¼Œç½‘ç»œæ¨¡å—ã€‚

åœ¨etcdä¸­ï¼Œå„ä¸ªèŠ‚ç‚¹ä¹‹é—´éœ€è¦é€šè¿‡2380ç«¯å£ç›¸äº’é€šä¿¡ï¼Œä»¥å®ŒæˆLeaderé€‰ä¸¾ã€æ—¥å¿—åŒæ­¥ç­‰åŠŸèƒ½ï¼Œå› æ­¤åº•å±‚ç½‘ç»œè´¨é‡ï¼ˆååé‡ã€å»¶æ—¶ã€ç¨³å®šæ€§ï¼‰å¯¹ä¸Šå±‚etcdæœåŠ¡çš„æ€§èƒ½æœ‰æ˜¾è‘—å½±å“ã€‚

ç½‘ç»œèµ„æºå‡ºç°å¼‚å¸¸çš„å¸¸è§è¡¨ç°æ˜¯è¿æ¥é—ªæ–­ã€å»¶æ—¶æŠ–åŠ¨ã€ä¸¢åŒ…ç­‰ã€‚é‚£ä¹ˆæˆ‘ä»¬è¦å¦‚ä½•å®šä½ç½‘ç»œå¼‚å¸¸å¯¼è‡´çš„å»¶æ—¶æŠ–åŠ¨å‘¢ï¼Ÿ

ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¸¸è§„çš„ping/traceroute/mtrã€ethtoolã€ifconfig/ipã€netstatã€tcpdumpç½‘ç»œåˆ†æå·¥å…·ç­‰å‘½ä»¤ï¼Œæµ‹è¯•ç½‘ç»œçš„è¿é€šæ€§ã€å»¶æ—¶ï¼ŒæŸ¥çœ‹ç½‘å¡çš„é€Ÿç‡æ˜¯å¦å­˜åœ¨ä¸¢åŒ…ç­‰é”™è¯¯ï¼Œç¡®è®¤etcdè¿›ç¨‹çš„è¿æ¥çŠ¶æ€åŠæ•°é‡æ˜¯å¦åˆç†ï¼ŒæŠ“å–etcdæŠ¥æ–‡åˆ†æç­‰ã€‚

å¦ä¸€æ–¹é¢ï¼Œetcdåº”ç”¨å±‚æä¾›äº†èŠ‚ç‚¹ä¹‹é—´ç½‘ç»œç»Ÿè®¡çš„metricsæŒ‡æ ‡ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š

- etcd\_network\_active\_peerï¼Œè¡¨ç¤ºpeerä¹‹é—´æ´»è·ƒçš„è¿æ¥æ•°ï¼›
- etcd\_network\_peer\_round\_trip\_time\_secondsï¼Œè¡¨ç¤ºpeerä¹‹é—´RTTå»¶æ—¶ï¼›
- etcd\_network\_peer\_sent\_failures\_totalï¼Œè¡¨ç¤ºå‘é€ç»™peerçš„å¤±è´¥æ¶ˆæ¯æ•°ï¼›
- etcd\_network\_client\_grpc\_sent\_bytes\_totalï¼Œè¡¨ç¤ºserverå‘é€ç»™clientçš„æ€»å­—èŠ‚æ•°ï¼Œé€šè¿‡è¿™ä¸ªæŒ‡æ ‡æˆ‘ä»¬å¯ä»¥ç›‘æ§etcdå‡ºæµé‡ï¼›
- etcd\_network\_client\_grpc\_received\_bytes\_totalï¼Œè¡¨ç¤ºserveræ”¶åˆ°clientå‘é€çš„æ€»å­—èŠ‚æ•°ï¼Œé€šè¿‡è¿™ä¸ªæŒ‡æ ‡å¯ä»¥ç›‘æ§etcdå…¥æµé‡ã€‚

clientå…¥æµé‡ç›‘æ§å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://static001.geekbang.org/resource/image/26/ff/26617a4c08e7c1e155c4332058451cff.png?wh=866%2A356)

clientå‡ºæµé‡å¦‚ä¸‹å›¾ç›‘æ§æ‰€ç¤ºã€‚ ä»å›¾ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œå³°å€¼æ¥è¿‘140MB/s(1.12Gbps)ï¼Œè¿™æ˜¯éå¸¸ä¸åˆç†çš„ï¼Œè¯´æ˜ä¸šåŠ¡ä¸­è‚¯å®šæœ‰å¤§é‡expensive read requestæ“ä½œã€‚è‹¥etcdé›†ç¾¤è¯»å†™è¯·æ±‚å¼€å§‹å‡ºç°è¶…æ—¶ï¼Œä½ å¯ä»¥ç”¨ifconfigç­‰å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å‡ºç°ä¸¢åŒ…ç­‰é”™è¯¯ã€‚

![](https://static001.geekbang.org/resource/image/4c/0b/4c8659e621305200b8f761b1e319460b.png?wh=856%2A356)

etcd metricsæŒ‡æ ‡åç”±namespaceå’Œsubsystemã€nameç»„æˆã€‚namespaceä¸ºetcdï¼Œ subsystemæ˜¯æ¨¡å—åï¼ˆæ¯”å¦‚networkã€nameå…·ä½“çš„æŒ‡æ ‡åï¼‰ã€‚ä½ å¯ä»¥åœ¨Prometheusé‡Œæœç´¢etcd\_networkæ‰¾åˆ°æ‰€æœ‰networkç›¸å…³çš„metricsæŒ‡æ ‡åã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªé›†ç¾¤ä¸­æŸèŠ‚ç‚¹å¼‚å¸¸åçš„metricsæŒ‡æ ‡ï¼š

```
etcd_network_active_peers{Local="fd422379fda50e48"ï¼ŒRemote="8211f1d0f64f3269"} 1
etcd_network_active_peers{Local="fd422379fda50e48"ï¼ŒRemote="91bc3c398fb3c146"} 0
etcd_network_peer_sent_failures_total{To="91bc3c398fb3c146"} 47774
etcd_network_client_grpc_sent_bytes_total 513207
```

ä»ä»¥ä¸Šmetricsä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°91bc3c398fb3c146èŠ‚ç‚¹å‡ºç°äº†å¼‚å¸¸ã€‚åœ¨etcdåœºæ™¯ä¸­ï¼Œç½‘ç»œè´¨é‡å¯¼è‡´etcdæ€§èƒ½ä¸‹é™ä¸»è¦æºè‡ªä¸¤ä¸ªæ–¹é¢ï¼š

ä¸€æ–¹é¢ï¼Œexpensive requestä¸­çš„å¤§åŒ…æŸ¥è¯¢ä¼šä½¿ç½‘å¡å‡ºç°ç“¶é¢ˆï¼Œäº§ç”Ÿä¸¢åŒ…ç­‰é”™è¯¯ï¼Œä»è€Œå¯¼è‡´etcdååé‡ä¸‹é™ã€é«˜å»¶æ—¶ã€‚expensive requestå¯¼è‡´ç½‘å¡ä¸¢åŒ…ï¼Œå‡ºç°è¶…æ—¶ï¼Œè¿™åœ¨etcdä¸­æ˜¯éå¸¸å…¸å‹ä¸”æ˜“å‘ç”Ÿçš„é—®é¢˜ï¼Œå®ƒä¸»è¦æ˜¯å› ä¸ºä¸šåŠ¡æ²¡æœ‰éµå¾ªæœ€ä½³å®è·µï¼ŒæŸ¥è¯¢äº†å¤§é‡key-valueã€‚

å¦ä¸€æ–¹é¢ï¼Œåœ¨è·¨æ•…éšœåŸŸéƒ¨ç½²çš„æ—¶å€™ï¼Œæ•…éšœåŸŸå¯èƒ½æ˜¯å¯ç”¨åŒºã€åŸå¸‚ã€‚æ•…éšœåŸŸè¶Šå¤§ï¼Œå®¹ç¾çº§åˆ«è¶Šé«˜ï¼Œä½†å„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„RTTè¶Šé«˜ï¼Œè¯·æ±‚çš„å»¶æ—¶æ›´é«˜ã€‚

## ç£ç›˜I/O

äº†è§£å®Œç½‘ç»œé—®é¢˜çš„å®šä½æ–¹æ³•å’Œå¯¼è‡´ç½‘ç»œæ€§èƒ½ä¸‹é™çš„å› ç´ åï¼Œæˆ‘ä»¬å†çœ‹çœ‹æœ€æ ¸å¿ƒçš„ç£ç›˜I/Oã€‚

æ­£å¦‚æˆ‘åœ¨å¼€å¤´çš„Raftæ—¥å¿—å¤åˆ¶æ•´ä½“æµç¨‹å›¾ä¸­å’Œä½ ä»‹ç»çš„ï¼Œåœ¨etcdä¸­æ— è®ºæ˜¯Raftæ—¥å¿—æŒä¹…åŒ–è¿˜æ˜¯boltdbäº‹åŠ¡æäº¤ï¼Œéƒ½ä¾èµ–äºç£ç›˜I/Oçš„æ€§èƒ½ã€‚

**å½“etcdè¯·æ±‚å»¶æ—¶å‡ºç°æ³¢åŠ¨æ—¶ï¼Œæˆ‘ä»¬å¾€å¾€é¦–å…ˆå…³æ³¨diskç›¸å…³æŒ‡æ ‡æ˜¯å¦æ­£å¸¸ã€‚**æˆ‘ä»¬å¯ä»¥é€šè¿‡etcdç£ç›˜ç›¸å…³çš„metrics(etcd\_disk\_wal\_fsync\_duration\_secondså’Œetcd\_disk\_backend\_commit\_duration\_seconds)æ¥è§‚æµ‹åº”ç”¨å±‚æ•°æ®å†™å…¥ç£ç›˜çš„æ€§èƒ½ã€‚

etcd\_disk\_wal\_fsync\_duration\_secondsï¼ˆç®€ç§°disk\_wal\_fsyncï¼‰è¡¨ç¤ºWALæ—¥å¿—æŒä¹…åŒ–çš„fsyncç³»ç»Ÿè°ƒç”¨å»¶æ—¶æ•°æ®ã€‚ä¸€èˆ¬æœ¬åœ°SSDç›˜P99å»¶æ—¶åœ¨10mså†…ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://static001.geekbang.org/resource/image/9a/52/9a08490980abb23f90d8e59a83543e52.png?wh=1326%2A352)

etcd\_disk\_backend\_commit\_duration\_secondsï¼ˆç®€ç§°disk\_backend\_commitï¼‰è¡¨ç¤ºåç«¯boltdbäº‹åŠ¡æäº¤çš„å»¶æ—¶ï¼Œä¸€èˆ¬P99åœ¨120mså†…ã€‚

![](https://static001.geekbang.org/resource/image/29/db/294600a0a144be38e9d7b69d9403f3db.png?wh=1338%2A356)

è¿™é‡Œä½ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€èˆ¬ç›‘æ§æ˜¾ç¤ºçš„ç£ç›˜å»¶æ—¶éƒ½æ˜¯P99ï¼Œä½†å®é™…ä¸Šetcdå¯¹ç£ç›˜ç‰¹åˆ«æ•æ„Ÿï¼Œä¸€æ¬¡ç£ç›˜I/Oæ³¢åŠ¨å°±å¯èƒ½äº§ç”ŸLeaderåˆ‡æ¢ã€‚å¦‚æœä½ é‡åˆ°é›†ç¾¤Leaderå‡ºç°åˆ‡æ¢ã€è¯·æ±‚è¶…æ—¶ï¼Œä½†æ˜¯ç£ç›˜æŒ‡æ ‡ç›‘æ§æ˜¾ç¤ºæ­£å¸¸ï¼Œä½ å¯ä»¥æŸ¥çœ‹P100ç¡®è®¤ä¸‹æ˜¯ä¸æ˜¯ç”±äºç£ç›˜I/Oæ³¢åŠ¨å¯¼è‡´çš„ã€‚

åŒæ—¶etcdçš„WALæ¨¡å—åœ¨fdatasyncæ“ä½œè¶…è¿‡1ç§’æ—¶ï¼Œä¹Ÿä¼šåœ¨etcdä¸­æ‰“å°å¦‚ä¸‹çš„æ—¥å¿—ï¼Œä½ å¯ä»¥ç»“åˆæ—¥å¿—è¿›ä¸€æ­¥å®šä½ã€‚

```
if took > warnSyncDuration {
   if w.lg != nil {
      w.lg.Warn(
         "slow fdatasync",
         zap.Duration("took", took),
         zap.Duration("expected-duration", warnSyncDuration),
      )
   } else {
      plog.Warningf("sync duration of %v, expected less than %v", took, warnSyncDuration)
   }
}
```

å½“disk\_wal\_fsyncæŒ‡æ ‡å¼‚å¸¸çš„æ—¶å€™ï¼Œä¸€èˆ¬æ˜¯åº•å±‚ç¡¬ä»¶å‡ºç°ç“¶é¢ˆæˆ–å¼‚å¸¸å¯¼è‡´ã€‚å½“ç„¶ä¹Ÿæœ‰å¯èƒ½æ˜¯CPUé«˜è´Ÿè½½ã€cgroup blkioé™åˆ¶å¯¼è‡´çš„ï¼Œæˆ‘ä»¬å…·ä½“åº”è¯¥å¦‚ä½•åŒºåˆ†å‘¢ï¼Ÿ

ä½ å¯ä»¥é€šè¿‡iostatã€blktraceå·¥å…·åˆ†æç“¶é¢ˆæ˜¯åœ¨åº”ç”¨å±‚è¿˜æ˜¯å†…æ ¸å±‚ã€ç¡¬ä»¶å±‚ã€‚å…¶ä¸­blktraceæ˜¯blkioå±‚çš„ç£ç›˜I/Oåˆ†æåˆ©å™¨ï¼Œå®ƒå¯è®°å½•IOè¿›å…¥é€šç”¨å—å±‚ã€IOè¯·æ±‚ç”Ÿæˆæ’å…¥è¯·æ±‚é˜Ÿåˆ—ã€IOè¯·æ±‚åˆ†å‘åˆ°è®¾å¤‡é©±åŠ¨ã€è®¾å¤‡é©±åŠ¨å¤„ç†å®Œæˆè¿™ä¸€ç³»åˆ—æ“ä½œçš„æ—¶é—´ï¼Œå¸®åŠ©ä½ å‘ç°ç£ç›˜I/Oç“¶é¢ˆå‘ç”Ÿçš„é˜¶æ®µã€‚

å½“disk\_backend\_commitæŒ‡æ ‡çš„å¼‚å¸¸æ—¶å€™ï¼Œè¯´æ˜äº‹åŠ¡æäº¤è¿‡ç¨‹ä¸­çš„B+ treeæ ‘é‡å¹³è¡¡ã€åˆ†è£‚ã€æŒä¹…åŒ–dirty pageã€æŒä¹…åŒ–meta pageç­‰æ“ä½œè€—è´¹äº†å¤§é‡æ—¶é—´ã€‚

disk\_backend\_commitæŒ‡æ ‡å¼‚å¸¸ï¼Œèƒ½è¯´æ˜æ˜¯ç£ç›˜I/Oå‘ç”Ÿäº†å¼‚å¸¸å—ï¼Ÿ

è‹¥disk\_backend\_commitè¾ƒé«˜ã€disk\_wal\_fsyncå´æ­£å¸¸ï¼Œè¯´æ˜ç“¶é¢ˆå¯èƒ½å¹¶éæ¥è‡ªç£ç›˜I/Oæ€§èƒ½ï¼Œä¹Ÿè®¸æ˜¯B+ treeçš„é‡å¹³è¡¡ã€åˆ†è£‚è¿‡ç¨‹ä¸­çš„è¾ƒé«˜æ—¶é—´å¤æ‚åº¦é€»è¾‘æ“ä½œå¯¼è‡´ã€‚æ¯”å¦‚etcdç›®å‰æ‰€æœ‰stableç‰ˆæœ¬ï¼ˆetcd 3.2åˆ°3.4ï¼‰ï¼Œä»freelistä¸­ç”³è¯·å’Œå›æ”¶è‹¥å¹²è¿ç»­ç©ºé—²é¡µçš„æ—¶é—´å¤æ‚åº¦æ˜¯O(N)ï¼Œå½“dbæ–‡ä»¶è¾ƒå¤§ã€ç©ºé—²é¡µç¢ç‰‡åŒ–åˆ†å¸ƒçš„æ—¶å€™ï¼Œåˆ™å¯èƒ½å¯¼è‡´äº‹åŠ¡æäº¤é«˜å»¶æ—¶ã€‚

é‚£å¦‚ä½•åŒºåˆ†äº‹åŠ¡æäº¤è¿‡ç¨‹ä¸­å„ä¸ªé˜¶æ®µçš„è€—æ—¶å‘¢ï¼Ÿ

etcdè¿˜æä¾›äº†disk\_backend\_commit\_rebalance\_durationå’Œ

disk\_backend\_commit\_spill\_durationä¸¤ä¸ªmetricsï¼Œåˆ†åˆ«è¡¨ç¤ºäº‹åŠ¡æäº¤è¿‡ç¨‹ä¸­B+ treeçš„é‡å¹³è¡¡å’Œåˆ†è£‚æ“ä½œè€—æ—¶åˆ†å¸ƒåŒºé—´ã€‚

æœ€åï¼Œä½ éœ€è¦æ³¨æ„disk\_wal\_fsyncè®°å½•çš„æ˜¯WALæ–‡ä»¶é¡ºåºå†™å…¥çš„æŒä¹…åŒ–æ—¶é—´ï¼Œdisk\_backend\_commitè®°å½•çš„æ˜¯æ•´ä¸ªäº‹åŠ¡æäº¤çš„è€—æ—¶ã€‚åè€…æ¶‰åŠçš„ç£ç›˜I/Oæ˜¯éšæœºçš„ï¼Œä¸ºäº†ä¿è¯ä½ etcdé›†ç¾¤çš„ç¨³å®šæ€§ï¼Œå»ºè®®ä½¿ç”¨SSDç£ç›˜ä»¥ç¡®ä¿äº‹åŠ¡æäº¤çš„ç¨³å®šæ€§ã€‚

## expensive request

è‹¥ç£ç›˜å’Œç½‘ç»œæŒ‡æ ‡éƒ½å¾ˆæ­£å¸¸ï¼Œé‚£ä¹ˆå»¶æ—¶é«˜è¿˜æœ‰å¯èƒ½æ˜¯ä»€ä¹ˆåŸå› å¼•èµ·çš„å‘¢ï¼Ÿ

ä»[02](https://time.geekbang.org/column/article/335932)ä»‹ç»çš„è¯»è¯·æ±‚é“¾è·¯æˆ‘ä»¬å¯çŸ¥ï¼Œä¸€ä¸ªè¯»å†™è¯·æ±‚ç»è¿‡Raftæ¨¡å—å¤„ç†åï¼Œæœ€ç»ˆä¼šèµ°åˆ°MVCCæ¨¡å—ã€‚é‚£ä¹ˆåœ¨MVCCæ¨¡å—ä¼šæœ‰å“ªäº›åœºæ™¯å¯¼è‡´å»¶æ—¶æŠ–åŠ¨å‘¢ï¼Ÿæ—¶é—´è€—åœ¨å“ªä¸ªå¤„ç†æµç¨‹ä¸Šäº†ï¼Ÿ

etcd 3.4ç‰ˆæœ¬ä¹‹å‰ï¼Œåœ¨åº”ç”¨put/txnç­‰è¯·æ±‚åˆ°çŠ¶æ€æœºçš„applyå’Œå¤„ç†è¯»è¯·æ±‚rangeæµç¨‹æ—¶ï¼Œè‹¥ä¸€ä¸ªè¯·æ±‚æ‰§è¡Œè¶…è¿‡100msæ—¶ï¼Œé»˜è®¤ä¼šåœ¨etcd logä¸­æ‰“å°ä¸€æ¡"apply request took too long"çš„è­¦å‘Šæ—¥å¿—ã€‚é€šè¿‡æ­¤æ—¥å¿—æˆ‘ä»¬å¯ä»¥çŸ¥é“é›†ç¾¤ä¸­applyæµç¨‹äº§ç”Ÿäº†è¾ƒæ…¢çš„è¯·æ±‚ï¼Œä½†æ˜¯ä¸èƒ½ç¡®å®šå…·ä½“æ˜¯ä»€ä¹ˆå› ç´ å¯¼è‡´çš„ã€‚

æ¯”å¦‚åœ¨Kubernetesä¸­ï¼Œå½“é›†ç¾¤Podè¾ƒå¤šçš„æ—¶å€™ï¼Œè‹¥ä½ é¢‘ç¹æ‰§è¡ŒList Podï¼Œå¯èƒ½ä¼šå¯¼è‡´etcdå‡ºç°å¤§é‡çš„"apply request took too long"è­¦å‘Šæ—¥å¿—ã€‚

å› ä¸ºå¯¹etcdè€Œè¨€ï¼ŒList Podè¯·æ±‚æ¶‰åŠåˆ°å¤§é‡çš„keyæŸ¥è¯¢ï¼Œä¼šæ¶ˆè€—è¾ƒå¤šçš„CPUã€å†…å­˜ã€ç½‘ç»œèµ„æºï¼Œæ­¤ç±»expensive requestçš„QPSè‹¥è¾ƒå¤§ï¼Œåˆ™å¾ˆå¯èƒ½å¯¼è‡´OOMã€ä¸¢åŒ…ã€‚

å½“ç„¶ï¼Œé™¤äº†ä¸šåŠ¡å‘èµ·çš„expensive requestè¯·æ±‚å¯¼è‡´å»¶æ—¶æŠ–åŠ¨ä»¥å¤–ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯etcdæœ¬èº«çš„è®¾è®¡å®ç°å­˜åœ¨ç“¶é¢ˆã€‚

æ¯”å¦‚åœ¨etcd 3.2å’Œ3.3ç‰ˆæœ¬å†™è¯·æ±‚å®Œæˆä¹‹å‰ï¼Œéœ€è¦æ›´æ–°MVCCçš„bufferï¼Œè¿›è¡Œå‡çº§é”æ“ä½œã€‚ç„¶è€Œæ­¤æ—¶è‹¥é›†ç¾¤ä¸­å‡ºç°äº†ä¸€ä¸ªlong expensive read requestï¼Œåˆ™ä¼šå¯¼è‡´å†™è¯·æ±‚æ‰§è¡Œå»¶æ—¶æŠ–åŠ¨ã€‚å› ä¸ºexpensive read requestäº‹åŠ¡ä¼šä¸€ç›´æŒæœ‰MVCCçš„bufferè¯»é”ï¼Œå¯¼è‡´å†™è¯·æ±‚äº‹åŠ¡é˜»å¡åœ¨å‡çº§é”æ“ä½œä¸­ã€‚

åœ¨äº†è§£å®Œexpensive requestå¯¹è¯·æ±‚å»¶æ—¶çš„å½±å“åï¼Œæ¥ä¸‹æ¥è¦å¦‚ä½•è§£å†³è¯·æ±‚å»¶æ—¶è¾ƒé«˜é—®é¢˜çš„å®šä½æ•ˆç‡å‘¢ï¼Ÿ

ä¸ºäº†æé«˜è¯·æ±‚å»¶æ—¶åˆ†å¸ƒçš„å¯è§‚æµ‹æ€§ã€å»¶æ—¶é—®é¢˜çš„å®šä½æ•ˆç‡ï¼Œetcdç¤¾åŒºåœ¨3.4ç‰ˆæœ¬åä¸­å®ç°äº†traceç‰¹æ€§ï¼Œè¯¦ç»†è®°å½•äº†ä¸€ä¸ªè¯·æ±‚åœ¨å„ä¸ªé˜¶æ®µçš„è€—æ—¶ã€‚è‹¥æŸé˜¶æ®µè€—æ—¶æµç¨‹è¶…è¿‡é»˜è®¤çš„100msï¼Œåˆ™ä¼šæ‰“å°ä¸€æ¡traceæ—¥å¿—ã€‚

ä¸‹é¢æ˜¯æˆ‘å°†traceæ—¥å¿—æ‰“å°çš„é˜ˆå€¼æ”¹æˆ1çº³ç§’åè¯»è¯·æ±‚æ‰§è¡Œè¿‡ç¨‹ä¸­çš„traceæ—¥å¿—ã€‚ä»æ—¥å¿—ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œtraceæ—¥å¿—è®°å½•äº†ä»¥ä¸‹é˜¶æ®µè€—æ—¶ï¼š

- agreement among raft nodes before linearized readingï¼Œæ­¤é˜¶æ®µè¯»è¯·æ±‚å‘Leaderå‘èµ·readIndexæŸ¥è¯¢å¹¶ç­‰å¾…æœ¬åœ°applied index &gt;= Leaderçš„committed indexï¼Œ ä½†æ˜¯ä½ æ— æ³•åŒºåˆ†æ˜¯readIndexæ…¢è¿˜æ˜¯ç­‰å¾…æœ¬åœ°applied index &gt; Leaderçš„committed indexæ…¢ã€‚åœ¨etcd 3.5ä¸­æ–°å¢äº†traceï¼ŒåŒºåˆ†äº†ä»¥ä¸Šé˜¶æ®µï¼›
- get authentication metadataï¼Œè·å–é‰´æƒå…ƒæ•°æ®ï¼›
- range keys from in-memory index treeï¼Œä»å†…å­˜ç´¢å¼•B-treeä¸­æŸ¥æ‰¾keyåˆ—è¡¨å¯¹åº”çš„ç‰ˆæœ¬å·åˆ—è¡¨ï¼›
- range keys from bolt dbï¼Œæ ¹æ®ç‰ˆæœ¬å·åˆ—è¡¨ä»boltdbéå†ï¼Œè·å¾—ç”¨æˆ·çš„key-valueä¿¡æ¯ï¼›
- filter and sort the key-value pairsï¼Œè¿‡æ»¤ã€æ’åºkey-valueåˆ—è¡¨ï¼›
- assemble the responseï¼Œèšåˆç»“æœã€‚

```
{
    "level":"info"ï¼Œ
    "ts":"2020-12-16T08:11:43.720+0800"ï¼Œ
    "caller":"traceutil/trace.go:145"ï¼Œ
    "msg":"trace[789864563] range"ï¼Œ
    "detail":"{range_begin:a; range_end:; response_count:1; response_revision:32011; }"ï¼Œ
    "duration":"318.774Âµs"ï¼Œ
    "start":"2020-12-16T08:11:43.719+0800"ï¼Œ
    "end":"2020-12-16T08:11:43.720+0800"ï¼Œ
    "steps":[
        "trace[789864563] 'agreement among raft nodes before linearized reading'  (duration: 255.227Âµs)"ï¼Œ
        "trace[789864563] 'get authentication metadata'  (duration: 2.97Âµs)"ï¼Œ
        "trace[789864563] 'range keys from in-memory index tree'  (duration: 44.578Âµs)"ï¼Œ
        "trace[789864563] 'range keys from bolt db'  (duration: 8.688Âµs)"ï¼Œ
        "trace[789864563] 'filter and sort the key-value pairs'  (duration: 578ns)"ï¼Œ
        "trace[789864563] 'assemble the response'  (duration: 643ns)"
    ]
}
```

é‚£ä¹ˆå†™è¯·æ±‚æµç¨‹ä¼šè®°å½•å“ªäº›é˜¶æ®µè€—æ—¶å‘¢ï¼Ÿ

ä¸‹é¢æ˜¯putå†™è¯·æ±‚çš„æ‰§è¡Œtraceæ—¥å¿—ï¼Œè®°å½•äº†ä»¥ä¸‹é˜¶æ®µè€—æ—¶ï¼š

- process raft requestï¼Œå†™è¯·æ±‚æäº¤åˆ°Raftæ¨¡å—å¤„ç†å®Œæˆè€—æ—¶ï¼›
- get key's previous created\_revision and leaseIDï¼Œè·å–keyä¸Šä¸€ä¸ªåˆ›å»ºç‰ˆæœ¬å·åŠleaseIDçš„è€—æ—¶ï¼›
- marshal mvccpb.KeyValueï¼Œåºåˆ—åŒ–KeyValueç»“æ„ä½“è€—æ—¶ï¼›
- store kv pair into bolt dbï¼Œå­˜å‚¨kvæ•°æ®åˆ°boltdbçš„è€—æ—¶ï¼›
- attach lease to kv pairï¼Œå°†lease idå…³è”åˆ°kvä¸Šæ‰€ç”¨æ—¶é—´ã€‚

```
{
    "level":"info"ï¼Œ
    "ts":"2020-12-16T08:25:12.707+0800"ï¼Œ
    "caller":"traceutil/trace.go:145"ï¼Œ
    "msg":"trace[1402827146] put"ï¼Œ
    "detail":"{key:16; req_size:8; response_revision:32030; }"ï¼Œ
    "duration":"6.826438ms"ï¼Œ
    "start":"2020-12-16T08:25:12.700+0800"ï¼Œ
    "end":"2020-12-16T08:25:12.707+0800"ï¼Œ
    "steps":[
        "trace[1402827146] 'process raft request'  (duration: 6.659094ms)"ï¼Œ
        "trace[1402827146] 'get key's previous created_revision and leaseID'  (duration: 23.498Âµs)"ï¼Œ
        "trace[1402827146] 'marshal mvccpb.KeyValue'  (duration: 1.857Âµs)"ï¼Œ
        "trace[1402827146] 'store kv pair into bolt db'  (duration: 30.121Âµs)"ï¼Œ
        "trace[1402827146] 'attach lease to kv pair'  (duration: 661ns)"
    ]
}
```

é€šè¿‡ä»¥ä¸Šä»‹ç»çš„traceç‰¹æ€§ï¼Œä½ å°±å¯ä»¥å¿«é€Ÿå®šä½åˆ°é«˜å»¶æ—¶è¯»å†™è¯·æ±‚çš„åŸå› ã€‚æ¯”å¦‚å½“ä½ å‘etcdå‘èµ·äº†ä¸€ä¸ªæ¶‰åŠåˆ°å¤§é‡keyæˆ–valueè¾ƒå¤§çš„expensive requestè¯·æ±‚çš„æ—¶å€™ï¼Œå®ƒä¼šäº§ç”Ÿå¦‚ä¸‹çš„warnå’Œtraceæ—¥å¿—ã€‚

ä»ä»¥ä¸‹æ—¥å¿—ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ­¤è¯·æ±‚æŸ¥è¯¢çš„vipå‰ç¼€ä¸‹æ‰€æœ‰çš„kvæ•°æ®æ€»å…±æ˜¯250æ¡ï¼Œä½†æ˜¯æ¶‰åŠçš„æ•°æ®åŒ…å¤§å°æœ‰250MBï¼Œæ€»è€—æ—¶çº¦1.85ç§’ï¼Œå…¶ä¸­ä»boltdbéå†keyæ¶ˆè€—äº†1.63ç§’ã€‚

```
{
    "level":"warn"ï¼Œ
    "ts":"2020-12-16T23:02:53.324+0800"ï¼Œ
    "caller":"etcdserver/util.go:163"ï¼Œ
    "msg":"apply request took too long"ï¼Œ
    "took":"1.84796759s"ï¼Œ
    "expected-duration":"100ms"ï¼Œ
    "prefix":"read-only range "ï¼Œ
    "request":"key:"vip" range_end:"viq" "ï¼Œ
    "response":"range_response_count:250 size:262150651"
}
{
    "level":"info"ï¼Œ
    "ts":"2020-12-16T23:02:53.324+0800"ï¼Œ
    "caller":"traceutil/trace.go:145"ï¼Œ
    "msg":"trace[370341530] range"ï¼Œ
    "detail":"{range_begin:vip; range_end:viq; response_count:250; response_revision:32666; }"ï¼Œ
    "duration":"1.850335038s"ï¼Œ
    "start":"2020-12-16T23:02:51.473+0800"ï¼Œ
    "end":"2020-12-16T23:02:53.324+0800"ï¼Œ
    "steps":[
        "trace[370341530] 'range keys from bolt db'  (duration: 1.632336981s)"
    ]
}
```

æœ€åï¼Œæœ‰ä¸¤ä¸ªæ³¨æ„äº‹é¡¹ã€‚

ç¬¬ä¸€ï¼Œåœ¨etcd 3.4ä¸­ï¼Œloggeré»˜è®¤ä¸ºcapnslogï¼Œtraceç‰¹æ€§åªæœ‰åœ¨å½“loggerä¸ºzapæ—¶æ‰å¼€å¯ï¼Œå› æ­¤ä½ éœ€è¦è®¾ç½®--logger=zapã€‚

ç¬¬äºŒï¼Œtraceç‰¹æ€§å¹¶ä¸èƒ½è®°å½•æ‰€æœ‰ç±»å‹çš„è¯·æ±‚ï¼Œå®ƒç›®å‰åªè¦†ç›–äº†MVCCæ¨¡å—ä¸­çš„range/put/txnç­‰å¸¸ç”¨æ¥å£ã€‚åƒAuthenticateé‰´æƒè¯·æ±‚ï¼Œæ¶‰åŠåˆ°å¤§é‡CPUè®¡ç®—ï¼Œå»¶æ—¶æ˜¯éå¸¸é«˜çš„ï¼Œåœ¨traceæ—¥å¿—ä¸­ç›®å‰æ²¡æœ‰ç›¸å…³è®°å½•ã€‚

å¦‚æœä½ å¼€å¯äº†å¯†ç é‰´æƒï¼Œåœ¨è¿æ¥æ•°å¢å¤šã€QPSå¢å¤§åï¼Œè‹¥çªç„¶å‡ºç°è¯·æ±‚è¶…æ—¶ï¼Œå¦‚ä½•ç¡®å®šæ˜¯é‰´æƒè¿˜æ˜¯æŸ¥è¯¢ã€æ›´æ–°ç­‰æ¥å£å¯¼è‡´çš„å‘¢ï¼Ÿ

etcdé»˜è®¤å‚æ•°å¹¶ä¸ä¼šé‡‡é›†å„ä¸ªæ¥å£çš„å»¶æ—¶æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®etcdçš„å¯åŠ¨å‚æ•°--metricsä¸ºextensiveæ¥å¼€å¯ï¼Œè·å¾—æ¯ä¸ªgRPCæ¥å£çš„å»¶æ—¶æ•°æ®ã€‚åŒæ—¶å¯ç»“åˆå„ä¸ªgRPCæ¥å£çš„è¯·æ±‚æ•°ï¼Œè·å¾—QPSã€‚

å¦‚ä¸‹æ˜¯æŸèŠ‚ç‚¹çš„metricsæ•°æ®ï¼Œ251ä¸ªPutè¯·æ±‚ï¼Œè¿”å›ç OKï¼Œå…¶ä¸­æœ‰240ä¸ªè¯·æ±‚åœ¨100æ¯«ç§’å†…å®Œæˆã€‚

```
grpc_server_handled_total{grpc_code="OK"ï¼Œ
grpc_method="Put"ï¼Œgrpc_service="etcdserverpb.KV"ï¼Œ
grpc_type="unary"} 251

grpc_server_handling_seconds_bucket{grpc_method="Put"ï¼Œgrpc_service="etcdserverpb.KV"ï¼Œgrpc_type="unary"ï¼Œle="0.005"} 0
grpc_server_handling_seconds_bucket{grpc_method="Put"ï¼Œgrpc_service="etcdserverpb.KV"ï¼Œgrpc_type="unary"ï¼Œle="0.01"} 1
grpc_server_handling_seconds_bucket{grpc_method="Put"ï¼Œgrpc_service="etcdserverpb.KV"ï¼Œgrpc_type="unary"ï¼Œle="0.025"} 51
grpc_server_handling_seconds_bucket{grpc_method="Put"ï¼Œgrpc_service="etcdserverpb.KV"ï¼Œgrpc_type="unary"ï¼Œle="0.05"} 204
grpc_server_handling_seconds_bucket{grpc_method="Put"ï¼Œgrpc_service="etcdserverpb.KV"ï¼Œgrpc_type="unary"ï¼Œle="0.1"} 240
```

## é›†ç¾¤å®¹é‡ã€èŠ‚ç‚¹CPU/Memoryç“¶é¢ˆ

ä»‹ç»å®Œç½‘ç»œã€ç£ç›˜I/Oã€expensive requestå¯¼è‡´etcdè¯·æ±‚å»¶æ—¶è¾ƒé«˜çš„åŸå› å’Œåˆ†ææ–¹æ³•åï¼Œæˆ‘ä»¬å†çœ‹çœ‹å®¹é‡å’ŒèŠ‚ç‚¹èµ„æºç“¶é¢ˆæ˜¯å¦‚ä½•å¯¼è‡´é«˜å»¶æ—¶è¯·æ±‚äº§ç”Ÿçš„ã€‚

è‹¥ç½‘ç»œã€ç£ç›˜I/Oæ­£å¸¸ï¼Œä¹Ÿæ— expensive requestï¼Œé‚£æ­¤æ—¶é«˜å»¶æ—¶è¯·æ±‚æ˜¯æ€ä¹ˆäº§ç”Ÿçš„å‘¢ï¼Ÿå®ƒçš„traceæ—¥å¿—ä¼šè¾“å‡ºæ€æ ·çš„è€—æ—¶ç»“æœï¼Ÿ

ä¸‹é¢æ˜¯ä¸€ä¸ªç¤¾åŒºç”¨æˆ·åé¦ˆçš„ä¸€ä¸ªè¯»æ¥å£é«˜å»¶æ—¶æ¡ˆä¾‹çš„ä¸¤æ¡traceæ—¥å¿—ã€‚ä»ç¬¬ä¸€æ¡æ—¥å¿—ä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“ç“¶é¢ˆåœ¨äºçº¿æ€§è¯»çš„å‡†å¤‡æ­¥éª¤ï¼ŒreadIndexå’Œwait applied indexã€‚

é‚£ä¹ˆæ˜¯å…¶ä¸­å…·ä½“å“ªä¸ªæ­¥éª¤å¯¼è‡´çš„é«˜å»¶æ—¶å‘¢ï¼Ÿé€šè¿‡åœ¨etcd 3.5ç‰ˆæœ¬ä¸­ç»†åŒ–æ­¤æµç¨‹ï¼Œæˆ‘ä»¬è·å¾—äº†ç¬¬äºŒæ¡æ—¥å¿—ï¼Œå‘ç°ç“¶é¢ˆåœ¨äºç­‰å¾…applied index &gt;= Leaderçš„committed indexã€‚

```
{
"level": "info"ï¼Œ
"ts": "2020-08-12T08:24:56.181Z"ï¼Œ
"caller": "traceutil/trace.go:145"ï¼Œ
"msg": "trace[677217921] range"ï¼Œ
"detail": "{range_begin:/...redacted...; range_end:; response_count:1; response_revision:2725080604; }"ï¼Œ
"duration": "1.553047811s"ï¼Œ
"start": "2020-08-12T08:24:54.628Z"ï¼Œ
"end": "2020-08-12T08:24:56.181Z"ï¼Œ
"steps": [
"trace[677217921] 'agreement among raft nodes before linearized reading'  (duration: 1.534322015s)"
]
}

{
  "level": "info"ï¼Œ
  "ts": "2020-09-22T12:54:01.021Z"ï¼Œ
  "caller": "traceutil/trace.go:152"ï¼Œ
  "msg": "trace[2138445431] linearizableReadLoop"ï¼Œ
  "detail": ""ï¼Œ
  "duration": "855.447896ms"ï¼Œ
  "start": "2020-09-22T12:54:00.166Z"ï¼Œ
  "end": "2020-09-22T12:54:01.021Z"ï¼Œ
  "steps": [
    "trace[2138445431] read index received  (duration: 824.408Âµs)"ï¼Œ
    "trace[2138445431] applied index is now lower than readState.Index  (duration: 854.622058ms)"
  ]
}
```

ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™æ ·çš„ç°è±¡å‘¢?

é¦–å…ˆä½ å¯ä»¥é€šè¿‡etcd\_server\_slow\_apply\_totalæŒ‡æ ‡ï¼Œè§‚æŸ¥å…¶å€¼å¿«é€Ÿå¢é•¿çš„æ—¶é—´ç‚¹ä¸é«˜å»¶æ—¶è¯·æ±‚äº§ç”Ÿçš„æ—¥å¿—æ—¶é—´ç‚¹æ˜¯å¦å»åˆã€‚

å…¶æ¬¡æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¤§é‡å†™è¯·æ±‚ã€‚çº¿æ€§è¯»éœ€ç¡®ä¿æœ¬èŠ‚ç‚¹æ•°æ®ä¸Leaderæ•°æ®ä¸€æ ·æ–°ï¼Œ è‹¥æœ¬èŠ‚ç‚¹çš„æ•°æ®ä¸Leaderå·®å¼‚è¾ƒå¤§ï¼Œæœ¬èŠ‚ç‚¹è¿½èµ¶Leaderæ•°æ®è¿‡ç¨‹ä¼šèŠ±è´¹ä¸€å®šæ—¶é—´ï¼Œæœ€ç»ˆå¯¼è‡´é«˜å»¶æ—¶çš„çº¿æ€§è¯»è¯·æ±‚äº§ç”Ÿã€‚

**etcdé€‚åˆè¯»å¤šå†™å°‘çš„ä¸šåŠ¡åœºæ™¯ï¼Œè‹¥å†™è¯·æ±‚è¾ƒå¤§ï¼Œå¾ˆå®¹æ˜“å‡ºç°å®¹é‡ç“¶é¢ˆï¼Œå¯¼è‡´é«˜å»¶æ—¶çš„è¯»å†™è¯·æ±‚äº§ç”Ÿã€‚**

æœ€åé€šè¿‡ps/top/mpstat/perfç­‰CPUã€Memoryæ€§èƒ½åˆ†æå·¥å…·ï¼Œæ£€æŸ¥etcdèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨CPUã€Memoryç“¶é¢ˆã€‚goroutineé¥¥é¥¿ã€å†…å­˜ä¸è¶³éƒ½ä¼šå¯¼è‡´é«˜å»¶æ—¶è¯·æ±‚äº§ç”Ÿï¼Œè‹¥ç¡®å®šCPUå’ŒMemoryå­˜åœ¨å¼‚å¸¸ï¼Œä½ å¯ä»¥é€šè¿‡å¼€å¯debugæ¨¡å¼ï¼Œé€šè¿‡pprofåˆ†æCPUå’Œå†…å­˜ç“¶é¢ˆç‚¹ã€‚

## å°ç»“

æœ€åå°ç»“ä¸‹æˆ‘ä»¬ä»Šå¤©çš„å†…å®¹ï¼Œæˆ‘æŒ‰ç…§å‰é¢ä»‹ç»çš„è¯»å†™è¯·æ±‚åŸç†ã€ä»¥åŠä¸°å¯Œçš„å®æˆ˜ç»éªŒï¼Œç»™ä½ æ•´ç†äº†å¯èƒ½å¯¼è‡´å»¶æ—¶æŠ–åŠ¨çš„å¸¸è§åŸå› ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ç»™ä½ ä»‹ç»äº†ä¼šå¯¼è‡´è¯·æ±‚å»¶æ—¶ä¸Šå‡çš„åŸå› ï¼š

- ç½‘ç»œè´¨é‡ï¼Œå¦‚èŠ‚ç‚¹ä¹‹é—´RTTå»¶æ—¶ã€ç½‘å¡å¸¦å®½æ»¡ï¼Œå‡ºç°ä¸¢åŒ…ï¼›
- ç£ç›˜I/OæŠ–åŠ¨ï¼Œä¼šå¯¼è‡´WALæ—¥å¿—æŒä¹…åŒ–ã€boltdbäº‹åŠ¡æäº¤å‡ºç°æŠ–åŠ¨ï¼ŒLeaderå‡ºç°åˆ‡æ¢ç­‰ï¼›
- expensive requestï¼Œæ¯”å¦‚å¤§åŒ…è¯·æ±‚ã€æ¶‰åŠåˆ°å¤§é‡keyéå†ã€Authenticateå¯†ç é‰´æƒç­‰æ“ä½œï¼›
- å®¹é‡ç“¶é¢ˆï¼Œå¤ªå¤šå†™è¯·æ±‚å¯¼è‡´çº¿æ€§è¯»è¯·æ±‚æ€§èƒ½ä¸‹é™ç­‰ï¼›
- èŠ‚ç‚¹é…ç½®ï¼ŒCPUç¹å¿™å¯¼è‡´è¯·æ±‚å¤„ç†å»¶æ—¶ã€å†…å­˜ä¸å¤Ÿå¯¼è‡´swapç­‰ã€‚

![](https://static001.geekbang.org/resource/image/93/a3/9375f08cebd596b87b92623c10786fa3.png?wh=1920%2A1474)

å¹¶åœ¨åˆ†æè¿™äº›æ¡ˆä¾‹çš„è¿‡ç¨‹ä¸­ï¼Œç»™ä½ ä»‹ç»äº†etcdé—®é¢˜æ ¸å¿ƒå·¥å…·ï¼šmetricsã€etcd logã€traceæ—¥å¿—ã€blktraceã€pprofç­‰ã€‚

å¸Œæœ›é€šè¿‡ä»Šå¤©çš„å†…å®¹ï¼Œèƒ½å¸®åŠ©ä½ ä»å®¹åº”å¯¹etcdå»¶æ—¶æŠ–åŠ¨ã€‚

## æ€è€ƒé¢˜

åœ¨ä½¿ç”¨etcdè¿‡ç¨‹ä¸­ï¼Œä½ é‡åˆ°è¿‡å“ªäº›é«˜å»¶æ—¶çš„è¯·æ±‚æ¡ˆä¾‹å‘¢ï¼Ÿä½ æ˜¯å¦‚ä½•è§£å†³çš„å‘¢ï¼Ÿ

æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼Œå¦‚æœä½ è®¤ä¸ºè¿™èŠ‚è¯¾çš„å†…å®¹æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œè°¢è°¢ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ7ï¼‰</strong></div><ul>
<li><span>jeffery</span> ğŸ‘ï¼ˆ9ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>èƒ½è§„é¿
expensive requestï¼Œå¤§åŒ…è¯·æ±‚å¯¼è‡´çš„å»¶è¿Ÿå—</p>2021-02-23</li><br/><li><span>kingstone</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆæ‚¨å¥½ï¼Œè¯·é—®å…³äºetcd grafanaç›‘æ§ï¼Œgrafana.comä¸Šæœ‰æ²¡æœ‰æ¯”è¾ƒå¥½ç”¨çš„dashboardsï¼Ÿ</p>2021-03-19</li><br/><li><span>å…«å°ä¸Š</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>æƒ³é—®ä¸€ä¸‹å‡ºç°è¿™ä¸ªé”™  etcdserver: request timed out ï¼Œ å®¢æˆ·ç«¯è¿›è¡Œé‡æ‹¾å¤„ç†å—ï¼Ÿ  è°¢è°¢</p>2021-08-26</li><br/><li><span>çŸ³å°</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ„Ÿè°¢å”è€å¸ˆï¼Œå¹²è´§ï¼Œå®ç”¨ã€‚è€å¸ˆåæœŸä¼šè®²etcdå…¸å‹çš„åº”ç”¨åœºæ™¯ï¼ˆæ¯”å¦‚æœåŠ¡å‘ç°ï¼‰å’Œæ³¨æ„äº‹é¡¹å—ï¼Ÿ</p>2021-03-08</li><br/><li><span>å®ä»”</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è€å¸ˆé—®ä¸‹ï¼Œä¸ºä»€ä¹ˆç£ç›˜IOæ³¢åŠ¨ä¼šå¼•èµ·leaderåˆ‡æ¢</p>2022-04-13</li><br/><li><span>å“ˆç™»</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¯·é—®ä¸‹æ€ä¹ˆå°†trace æ—¥å¿—æ‰“å°çš„é˜ˆå€¼æ”¹æˆ 1 çº³ç§’
</p>2024-10-31</li><br/><li><span>æŸ’åŸ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆä½ å¥½ï¼Œæˆ‘åœ¨ä½¿ç”¨é›†ç¾¤æ—¶å‡ºç°ä¸€ç›´æ‰“å°etcdserver: request timed outã€‚ç„¶åçœ‹äº†ä¸€ä¸ªèŠ‚ç‚¹åäº†ï¼Œä½†æ˜¯ç£ç›˜å¹¶æ²¡æœ‰åï¼Œé™¤äº†ioå»¶æ—¶å¥—å¯èƒ½é€ æˆçš„åŸå› è¿˜æœ‰å“ªäº›ï¼Ÿ</p>2021-06-22</li><br/>
</ul>