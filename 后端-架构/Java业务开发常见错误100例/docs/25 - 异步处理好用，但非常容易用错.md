ä½ å¥½ï¼Œæˆ‘æ˜¯æœ±æ™”ã€‚ä»Šå¤©ï¼Œæˆ‘æ¥å’Œä½ èŠèŠå¥½ç”¨ä½†å®¹æ˜“å‡ºé”™çš„å¼‚æ­¥å¤„ç†ã€‚

å¼‚æ­¥å¤„ç†æ˜¯äº’è”ç½‘åº”ç”¨ä¸å¯æˆ–ç¼ºçš„ä¸€ç§æ¶æ„æ¨¡å¼ï¼Œå¤§å¤šæ•°ä¸šåŠ¡é¡¹ç›®éƒ½æ˜¯ç”±åŒæ­¥å¤„ç†ã€å¼‚æ­¥å¤„ç†å’Œå®šæ—¶ä»»åŠ¡å¤„ç†ä¸‰ç§æ¨¡å¼ç›¸è¾…ç›¸æˆå®ç°çš„ã€‚

åŒºåˆ«äºåŒæ­¥å¤„ç†ï¼Œå¼‚æ­¥å¤„ç†æ— éœ€åŒæ­¥ç­‰å¾…æµç¨‹å¤„ç†å®Œæ¯•ï¼Œå› æ­¤é€‚ç”¨åœºæ™¯ä¸»è¦åŒ…æ‹¬ï¼š

- æœåŠ¡äºä¸»æµç¨‹çš„åˆ†æ”¯æµç¨‹ã€‚æ¯”å¦‚ï¼Œåœ¨æ³¨å†Œæµç¨‹ä¸­ï¼ŒæŠŠæ•°æ®å†™å…¥æ•°æ®åº“çš„æ“ä½œæ˜¯ä¸»æµç¨‹ï¼Œä½†æ³¨å†Œåç»™ç”¨æˆ·å‘ä¼˜æƒ åˆ¸æˆ–æ¬¢è¿çŸ­ä¿¡çš„æ“ä½œæ˜¯åˆ†æ”¯æµç¨‹ï¼Œæ—¶æ•ˆæ€§ä¸é‚£ä¹ˆå¼ºï¼Œå¯ä»¥è¿›è¡Œå¼‚æ­¥å¤„ç†ã€‚
- ç”¨æˆ·ä¸éœ€è¦å®æ—¶çœ‹åˆ°ç»“æœçš„æµç¨‹ã€‚æ¯”å¦‚ï¼Œä¸‹å•åçš„é…è´§ã€é€è´§æµç¨‹å®Œå…¨å¯ä»¥è¿›è¡Œå¼‚æ­¥å¤„ç†ï¼Œæ¯ä¸ªé˜¶æ®µå¤„ç†å®Œæˆåï¼Œå†ç»™ç”¨æˆ·å‘æ¨é€æˆ–çŸ­ä¿¡è®©ç”¨æˆ·çŸ¥æ™“å³å¯ã€‚

åŒæ—¶ï¼Œå¼‚æ­¥å¤„ç†å› ä¸ºå¯ä»¥æœ‰MQä¸­é—´ä»¶çš„ä»‹å…¥ç”¨äºä»»åŠ¡çš„ç¼“å†²çš„åˆ†å‘ï¼Œæ‰€ä»¥ç›¸æ¯”äºåŒæ­¥å¤„ç†ï¼Œåœ¨åº”å¯¹æµé‡æ´ªå³°ã€å®ç°æ¨¡å—è§£è€¦å’Œæ¶ˆæ¯å¹¿æ’­æ–¹é¢æœ‰åŠŸèƒ½ä¼˜åŠ¿ã€‚

ä¸è¿‡ï¼Œå¼‚æ­¥å¤„ç†è™½ç„¶å¥½ç”¨ï¼Œä½†åœ¨å®ç°çš„æ—¶å€™å´æœ‰ä¸‰ä¸ªæœ€å®¹æ˜“çŠ¯çš„é”™ï¼Œåˆ†åˆ«æ˜¯å¼‚æ­¥å¤„ç†æµç¨‹çš„å¯é æ€§é—®é¢˜ã€æ¶ˆæ¯å‘é€æ¨¡å¼çš„åŒºåˆ†é—®é¢˜ï¼Œä»¥åŠå¤§é‡æ­»ä¿¡æ¶ˆæ¯å µå¡é˜Ÿåˆ—çš„é—®é¢˜ã€‚ä»Šå¤©ï¼Œæˆ‘å°±ç”¨ä¸‰ä¸ªä»£ç æ¡ˆä¾‹ç»“åˆç›®å‰å¸¸ç”¨çš„MQç³»ç»ŸRabbitMQï¼Œæ¥å’Œä½ å…·ä½“èŠèŠã€‚

ä»Šå¤©è¿™ä¸€è®²çš„æ¼”ç¤ºï¼Œæˆ‘éƒ½ä¼šä½¿ç”¨Spring AMQPæ¥æ“ä½œRabbitMQï¼Œæ‰€ä»¥ä½ éœ€è¦å…ˆå¼•å…¥amqpä¾èµ–ï¼š

```
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

## å¼‚æ­¥å¤„ç†éœ€è¦æ¶ˆæ¯è¡¥å¿é—­ç¯

ä½¿ç”¨ç±»ä¼¼RabbitMQã€RocketMQç­‰MQç³»ç»Ÿæ¥åšæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥å¤„ç†ï¼Œè™½ç„¶è¯´æ¶ˆæ¯å¯ä»¥è½åœ°åˆ°ç£ç›˜ä¿å­˜ï¼Œå³ä½¿MQå‡ºç°é—®é¢˜æ¶ˆæ¯æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ï¼Œä½†æ˜¯å¼‚æ­¥æµç¨‹åœ¨æ¶ˆæ¯å‘é€ã€ä¼ è¾“ã€å¤„ç†ç­‰ç¯èŠ‚ï¼Œéƒ½å¯èƒ½å‘ç”Ÿæ¶ˆæ¯ä¸¢å¤±ã€‚æ­¤å¤–ï¼Œä»»ä½•MQä¸­é—´ä»¶éƒ½æ— æ³•ç¡®ä¿100%å¯ç”¨ï¼Œéœ€è¦è€ƒè™‘ä¸å¯ç”¨æ—¶å¼‚æ­¥æµç¨‹å¦‚ä½•ç»§ç»­è¿›è¡Œã€‚

å› æ­¤ï¼Œ**å¯¹äºå¼‚æ­¥å¤„ç†æµç¨‹ï¼Œå¿…é¡»è€ƒè™‘è¡¥å¿æˆ–è€…è¯´å»ºç«‹ä¸»å¤‡åŒæ´»æµç¨‹**ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç”¨æˆ·æ³¨å†Œåå¼‚æ­¥å‘é€æ¬¢è¿æ¶ˆæ¯çš„åœºæ™¯ã€‚ç”¨æˆ·æ³¨å†Œè½æ•°æ®åº“çš„æµç¨‹ä¸ºåŒæ­¥æµç¨‹ï¼Œä¼šå‘˜æœåŠ¡æ”¶åˆ°æ¶ˆæ¯åå‘é€æ¬¢è¿æ¶ˆæ¯çš„æµç¨‹ä¸ºå¼‚æ­¥æµç¨‹ã€‚

![](https://static001.geekbang.org/resource/image/62/93/629d9f0557cd7f06ac9ee2e871524893.png?wh=1596%2A836)

æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼š

- è“è‰²çš„çº¿ï¼Œä½¿ç”¨MQè¿›è¡Œçš„å¼‚æ­¥å¤„ç†ï¼Œæˆ‘ä»¬ç§°ä½œä¸»çº¿ï¼Œå¯èƒ½å­˜åœ¨æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µï¼ˆè™šçº¿ä»£è¡¨å¼‚æ­¥è°ƒç”¨ï¼‰ï¼›
- ç»¿è‰²çš„çº¿ï¼Œä½¿ç”¨è¡¥å¿Jobå®šæœŸè¿›è¡Œæ¶ˆæ¯è¡¥å¿ï¼Œæˆ‘ä»¬ç§°ä½œå¤‡çº¿ï¼Œç”¨æ¥è¡¥å¿ä¸»çº¿ä¸¢å¤±çš„æ¶ˆæ¯ï¼›
- è€ƒè™‘åˆ°æç«¯çš„MQä¸­é—´ä»¶å¤±æ•ˆçš„æƒ…å†µï¼Œæˆ‘ä»¬è¦æ±‚å¤‡çº¿çš„å¤„ç†ååèƒ½åŠ›è¾¾åˆ°ä¸»çº¿çš„èƒ½åŠ›æ°´å¹³ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç›¸å…³çš„å®ç°ä»£ç ã€‚

é¦–å…ˆï¼Œå®šä¹‰UserControllerç”¨äºæ³¨å†Œ+å‘é€å¼‚æ­¥æ¶ˆæ¯ã€‚å¯¹äºæ³¨å†Œæ–¹æ³•ï¼Œæˆ‘ä»¬ä¸€æ¬¡æ€§æ³¨å†Œ10ä¸ªç”¨æˆ·ï¼Œç”¨æˆ·æ³¨å†Œæ¶ˆæ¯ä¸èƒ½å‘é€å‡ºå»çš„æ¦‚ç‡ä¸º50%ã€‚

```
@RestController
@Slf4j
@RequestMapping("user")
public class UserController {
    @Autowired
    private UserService userService;
    @Autowired
    private RabbitTemplate rabbitTemplate;

    @GetMapping("register")
    public void register() {
        //æ¨¡æ‹Ÿ10ä¸ªç”¨æˆ·æ³¨å†Œ
        IntStream.rangeClosed(1, 10).forEach(i -> {
            //è½åº“
            User user = userService.register();
            //æ¨¡æ‹Ÿ50%çš„æ¶ˆæ¯å¯èƒ½å‘é€å¤±è´¥
            if (ThreadLocalRandom.current().nextInt(10) % 2 == 0) {
                //é€šè¿‡RabbitMQå‘é€æ¶ˆæ¯
               rabbitTemplate.convertAndSend(RabbitConfiguration.EXCHANGE, RabbitConfiguration.ROUTING_KEY, user);
                log.info("sent mq user {}", user.getId());
            }
        });
    }
}
```

ç„¶åï¼Œå®šä¹‰MemberServiceç±»ç”¨äºæ¨¡æ‹Ÿä¼šå‘˜æœåŠ¡ã€‚ä¼šå‘˜æœåŠ¡ç›‘å¬ç”¨æˆ·æ³¨å†ŒæˆåŠŸçš„æ¶ˆæ¯ï¼Œå¹¶å‘é€æ¬¢è¿çŸ­ä¿¡ã€‚æˆ‘ä»¬ä½¿ç”¨ConcurrentHashMapæ¥å­˜æ”¾é‚£äº›å‘è¿‡çŸ­ä¿¡çš„ç”¨æˆ·IDå®ç°å¹‚ç­‰ï¼Œé¿å…ç›¸åŒçš„ç”¨æˆ·è¿›è¡Œè¡¥å¿æ—¶é‡å¤å‘é€çŸ­ä¿¡ï¼š

```
@Component
@Slf4j
public class MemberService {
    //å‘é€æ¬¢è¿æ¶ˆæ¯çš„çŠ¶æ€
    private Map<Long, Boolean> welcomeStatus = new ConcurrentHashMap<>();
    //ç›‘å¬ç”¨æˆ·æ³¨å†ŒæˆåŠŸçš„æ¶ˆæ¯ï¼Œå‘é€æ¬¢è¿æ¶ˆæ¯
    @RabbitListener(queues = RabbitConfiguration.QUEUE)
    public void listen(User user) {
        log.info("receive mq user {}", user.getId());
        welcome(user);
    }
    //å‘é€æ¬¢è¿æ¶ˆæ¯
    public void welcome(User user) {
        //å»é‡æ“ä½œ
        if (welcomeStatus.putIfAbsent(user.getId(), true) == null) {
            try {
                TimeUnit.SECONDS.sleep(2);
            } catch (InterruptedException e) {
            }
            log.info("memberService: welcome new user {}", user.getId());
        }
    }
}
```

å¯¹äºMQæ¶ˆè´¹ç¨‹åºï¼Œå¤„ç†é€»è¾‘åŠ¡å¿…è€ƒè™‘å»é‡ï¼ˆæ”¯æŒå¹‚ç­‰ï¼‰ï¼ŒåŸå› æœ‰å‡ ä¸ªï¼š

- MQæ¶ˆæ¯å¯èƒ½ä¼šå› ä¸ºä¸­é—´ä»¶æœ¬èº«é…ç½®é”™è¯¯ã€ç¨³å®šæ€§ç­‰åŸå› å‡ºç°é‡å¤ã€‚
- è‡ªåŠ¨è¡¥å¿é‡å¤ï¼Œæ¯”å¦‚æœ¬ä¾‹ï¼ŒåŒä¸€æ¡æ¶ˆæ¯å¯èƒ½æ—¢èµ°MQä¹Ÿèµ°è¡¥å¿ï¼Œè‚¯å®šä¼šå‡ºç°é‡å¤ï¼Œè€Œä¸”è€ƒè™‘åˆ°é«˜å†…èšï¼Œè¡¥å¿Jobæœ¬èº«ä¸ä¼šåšå»é‡å¤„ç†ã€‚
- äººå·¥è¡¥å¿é‡å¤ã€‚å‡ºç°æ¶ˆæ¯å †ç§¯æ—¶ï¼Œå¼‚æ­¥å¤„ç†æµç¨‹å¿…ç„¶ä¼šå»¶è¿Ÿã€‚å¦‚æœæˆ‘ä»¬æä¾›äº†é€šè¿‡åå°è¿›è¡Œè¡¥å¿çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆåœ¨å¤„ç†é‡åˆ°å»¶è¿Ÿçš„æ—¶å€™ï¼Œå¾ˆå¯èƒ½ä¼šå…ˆè¿›è¡Œäººå·¥è¡¥å¿ï¼Œè¿‡äº†ä¸€æ®µæ—¶é—´åå¤„ç†ç¨‹åºåˆæ”¶åˆ°æ¶ˆæ¯äº†ï¼Œé‡å¤å¤„ç†ã€‚æˆ‘ä¹‹å‰å°±é‡åˆ°è¿‡ä¸€æ¬¡ç”±MQæ•…éšœå¼•å‘çš„äº‹æ•…ï¼ŒMQä¸­å †ç§¯äº†å‡ åä¸‡æ¡å‘æ”¾èµ„é‡‘çš„æ¶ˆæ¯ï¼Œå¯¼è‡´ä¸šåŠ¡æ— æ³•åŠæ—¶å¤„ç†ï¼Œè¿è¥ä»¥ä¸ºç¨‹åºå‡ºé”™äº†å°±å…ˆé€šè¿‡åå°è¿›è¡Œäº†äººå·¥å¤„ç†ï¼Œç»“æœMQç³»ç»Ÿæ¢å¤åæ¶ˆæ¯åˆè¢«é‡å¤å¤„ç†äº†ä¸€æ¬¡ï¼Œé€ æˆå¤§é‡èµ„é‡‘é‡å¤å‘æ”¾ã€‚

æ¥ä¸‹æ¥ï¼Œå®šä¹‰è¡¥å¿Jobä¹Ÿå°±æ˜¯å¤‡çº¿æ“ä½œã€‚

æˆ‘ä»¬åœ¨CompensationJobä¸­å®šä¹‰ä¸€ä¸ª@Scheduledå®šæ—¶ä»»åŠ¡ï¼Œ5ç§’åšä¸€æ¬¡è¡¥å¿æ“ä½œï¼Œå› ä¸ºJobå¹¶ä¸çŸ¥é“å“ªäº›ç”¨æˆ·æ³¨å†Œçš„æ¶ˆæ¯å¯èƒ½ä¸¢å¤±ï¼Œæ‰€ä»¥æ˜¯å…¨é‡è¡¥å¿ï¼Œè¡¥å¿é€»è¾‘æ˜¯ï¼šæ¯5ç§’è¡¥å¿ä¸€æ¬¡ï¼ŒæŒ‰é¡ºåºä¸€æ¬¡è¡¥å¿5ä¸ªç”¨æˆ·ï¼Œä¸‹ä¸€æ¬¡è¡¥å¿æ“ä½œä»ä¸Šä¸€æ¬¡è¡¥å¿çš„æœ€åä¸€ä¸ªç”¨æˆ·IDå¼€å§‹ï¼›å¯¹äºè¡¥å¿ä»»åŠ¡æˆ‘ä»¬æäº¤åˆ°çº¿ç¨‹æ± è¿›è¡Œâ€œå¼‚æ­¥â€å¤„ç†ï¼Œæé«˜å¤„ç†èƒ½åŠ›ã€‚

```
@Component
@Slf4j
public class CompensationJob {
    //è¡¥å¿Jobå¼‚æ­¥å¤„ç†çº¿ç¨‹æ± 
    private static ThreadPoolExecutor compensationThreadPool = new ThreadPoolExecutor(
            10, 10,
            1, TimeUnit.HOURS,
            new ArrayBlockingQueue<>(1000),
            new ThreadFactoryBuilder().setNameFormat("compensation-threadpool-%d").get());
    @Autowired
    private UserService userService;
    @Autowired
    private MemberService memberService;
    //ç›®å‰è¡¥å¿åˆ°å“ªä¸ªç”¨æˆ·ID
    private long offset = 0;

    //10ç§’åå¼€å§‹è¡¥å¿ï¼Œ5ç§’è¡¥å¿ä¸€æ¬¡
    @Scheduled(initialDelay = 10_000, fixedRate = 5_000)
    public void compensationJob() {
        log.info("å¼€å§‹ä»ç”¨æˆ·ID {} è¡¥å¿", offset);
        //è·å–ä»offsetå¼€å§‹çš„ç”¨æˆ·
        userService.getUsersAfterIdWithLimit(offset, 5).forEach(user -> {
            compensationThreadPool.execute(() -> memberService.welcome(user));
            offset = user.getId();
        });
    }
}
```

ä¸ºäº†å®ç°é«˜å†…èšï¼Œä¸»çº¿å’Œå¤‡çº¿å¤„ç†æ¶ˆæ¯ï¼Œæœ€å¥½ä½¿ç”¨åŒä¸€ä¸ªæ–¹æ³•ã€‚æ¯”å¦‚ï¼Œæœ¬ä¾‹ä¸­MemberServiceç›‘å¬åˆ°MQæ¶ˆæ¯å’ŒCompensationJobè¡¥å¿ï¼Œè°ƒç”¨çš„éƒ½æ˜¯welcomeæ–¹æ³•ã€‚

æ­¤å¤–å€¼å¾—ä¸€è¯´çš„æ˜¯ï¼ŒDemoä¸­çš„è¡¥å¿é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œç”Ÿäº§çº§çš„ä»£ç åº”è¯¥åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡ŒåŠ å¼ºï¼š

- è€ƒè™‘é…ç½®è¡¥å¿çš„é¢‘æ¬¡ã€æ¯æ¬¡å¤„ç†æ•°é‡ï¼Œä»¥åŠè¡¥å¿çº¿ç¨‹æ± å¤§å°ç­‰å‚æ•°ä¸ºåˆé€‚çš„å€¼ï¼Œä»¥æ»¡è¶³è¡¥å¿çš„ååé‡ã€‚
- è€ƒè™‘å¤‡çº¿è¡¥å¿æ•°æ®è¿›è¡Œé€‚å½“å»¶è¿Ÿã€‚æ¯”å¦‚ï¼Œå¯¹æ³¨å†Œæ—¶é—´åœ¨30ç§’ä¹‹å‰çš„ç”¨æˆ·å†è¿›è¡Œè¡¥å¿ï¼Œä»¥æ–¹ä¾¿å’Œä¸»çº¿MQå®æ—¶æµç¨‹é”™å¼€ï¼Œé¿å…å†²çªã€‚
- è¯¸å¦‚å½“å‰è¡¥å¿åˆ°å“ªä¸ªç”¨æˆ·çš„offsetæ•°æ®ï¼Œéœ€è¦è½åœ°æ•°æ®åº“ã€‚
- è¡¥å¿Jobæœ¬èº«éœ€è¦é«˜å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼XXLJobæˆ–ElasticJobç­‰ä»»åŠ¡ç³»ç»Ÿã€‚

è¿è¡Œç¨‹åºï¼Œæ‰§è¡Œæ³¨å†Œæ–¹æ³•æ³¨å†Œ10ä¸ªç”¨æˆ·ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š

```
[17:01:16.570] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.a.compensation.UserController:28  ] - sent mq user 1
[17:01:16.571] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.a.compensation.UserController:28  ] - sent mq user 5
[17:01:16.572] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.a.compensation.UserController:28  ] - sent mq user 7
[17:01:16.573] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.a.compensation.UserController:28  ] - sent mq user 8
[17:01:16.594] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.compensation.MemberService:18  ] - receive mq user 1
[17:01:18.597] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.compensation.MemberService:28  ] - memberService: welcome new user 1
[17:01:18.601] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.compensation.MemberService:18  ] - receive mq user 5
[17:01:20.603] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.compensation.MemberService:28  ] - memberService: welcome new user 5
[17:01:20.604] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.compensation.MemberService:18  ] - receive mq user 7
[17:01:22.605] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.compensation.MemberService:28  ] - memberService: welcome new user 7
[17:01:22.606] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.compensation.MemberService:18  ] - receive mq user 8
[17:01:24.611] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.compensation.MemberService:28  ] - memberService: welcome new user 8
[17:01:25.498] [scheduling-1] [INFO ] [o.g.t.c.a.compensation.CompensationJob:29  ] - å¼€å§‹ä»ç”¨æˆ·ID 0 è¡¥å¿
[17:01:27.510] [compensation-threadpool-1] [INFO ] [o.g.t.c.a.compensation.MemberService:28  ] - memberService: welcome new user 2
[17:01:27.510] [compensation-threadpool-3] [INFO ] [o.g.t.c.a.compensation.MemberService:28  ] - memberService: welcome new user 4
[17:01:27.511] [compensation-threadpool-2] [INFO ] [o.g.t.c.a.compensation.MemberService:28  ] - memberService: welcome new user 3
[17:01:30.496] [scheduling-1] [INFO ] [o.g.t.c.a.compensation.CompensationJob:29  ] - å¼€å§‹ä»ç”¨æˆ·ID 5 è¡¥å¿
[17:01:32.500] [compensation-threadpool-6] [INFO ] [o.g.t.c.a.compensation.MemberService:28  ] - memberService: welcome new user 6
[17:01:32.500] [compensation-threadpool-9] [INFO ] [o.g.t.c.a.compensation.MemberService:28  ] - memberService: welcome new user 9
[17:01:35.496] [scheduling-1] [INFO ] [o.g.t.c.a.compensation.CompensationJob:29  ] - å¼€å§‹ä»ç”¨æˆ·ID 9 è¡¥å¿
[17:01:37.501] [compensation-threadpool-0] [INFO ] [o.g.t.c.a.compensation.MemberService:28  ] - memberService: welcome new user 10
[17:01:40.495] [scheduling-1] [INFO ] [o.g.t.c.a.compensation.CompensationJob:29  ] - å¼€å§‹ä»ç”¨æˆ·ID 10 è¡¥å¿
```

å¯ä»¥çœ‹åˆ°ï¼š

- æ€»å…±10ä¸ªç”¨æˆ·ï¼ŒMQå‘é€æˆåŠŸçš„ç”¨æˆ·æœ‰å››ä¸ªï¼Œåˆ†åˆ«æ˜¯ç”¨æˆ·1ã€5ã€7ã€8ã€‚
- è¡¥å¿ä»»åŠ¡ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œè¡¥å¿äº†ç”¨æˆ·2ã€3ã€4ï¼Œç¬¬äºŒæ¬¡è¿è¡Œè¡¥å¿äº†ç”¨æˆ·6ã€9ï¼Œç¬¬ä¸‰æ¬¡è¿è¡Œè¡¥å……äº†ç”¨æˆ·10ã€‚

æœ€åæä¸€ä¸‹ï¼Œé’ˆå¯¹æ¶ˆæ¯çš„è¡¥å¿é—­ç¯å¤„ç†çš„æœ€é«˜æ ‡å‡†æ˜¯ï¼Œèƒ½å¤Ÿè¾¾åˆ°è¡¥å¿å…¨é‡æ•°æ®çš„ååé‡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœè¡¥å¿å¤‡çº¿è¶³å¤Ÿå®Œå–„ï¼Œå³ä½¿ç›´æ¥æŠŠMQåœæœºï¼Œè™½ç„¶ä¼šç•¥å¾®å½±å“å¤„ç†çš„åŠæ—¶æ€§ï¼Œä½†è‡³å°‘ç¡®ä¿æµç¨‹éƒ½èƒ½æ­£å¸¸æ‰§è¡Œã€‚

## æ³¨æ„æ¶ˆæ¯æ¨¡å¼æ˜¯å¹¿æ’­è¿˜æ˜¯å·¥ä½œé˜Ÿåˆ—

åœ¨ä»Šå¤©è¿™ä¸€è®²çš„ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬æåˆ°å¼‚æ­¥å¤„ç†çš„ä¸€ä¸ªé‡è¦ä¼˜åŠ¿ï¼Œæ˜¯å®ç°æ¶ˆæ¯å¹¿æ’­ã€‚

æ¶ˆæ¯å¹¿æ’­ï¼Œå’Œæˆ‘ä»¬å¹³æ—¶è¯´çš„â€œå¹¿æ’­â€æ„æ€å·®ä¸å¤šï¼Œå°±æ˜¯å¸Œæœ›åŒä¸€æ¡æ¶ˆæ¯ï¼Œä¸åŒæ¶ˆè´¹è€…éƒ½èƒ½åˆ†åˆ«æ¶ˆè´¹ï¼›è€Œé˜Ÿåˆ—æ¨¡å¼ï¼Œå°±æ˜¯ä¸åŒæ¶ˆè´¹è€…å…±äº«æ¶ˆè´¹åŒä¸€ä¸ªé˜Ÿåˆ—çš„æ•°æ®ï¼Œç›¸åŒæ¶ˆæ¯åªèƒ½è¢«æŸä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ä¸€æ¬¡ã€‚

æ¯”å¦‚ï¼ŒåŒä¸€ä¸ªç”¨æˆ·çš„æ³¨å†Œæ¶ˆæ¯ï¼Œä¼šå‘˜æœåŠ¡éœ€è¦ç›‘å¬ä»¥å‘é€æ¬¢è¿çŸ­ä¿¡ï¼Œè¥é”€æœåŠ¡åŒæ ·éœ€è¦ç›‘å¬ä»¥å‘é€æ–°ç”¨æˆ·å°ç¤¼ç‰©ã€‚ä½†æ˜¯ï¼Œä¼šå‘˜æœåŠ¡ã€è¥é”€æœåŠ¡éƒ½å¯èƒ½æœ‰å¤šä¸ªå®ä¾‹ï¼Œæˆ‘ä»¬æœŸæœ›çš„æ˜¯åŒä¸€ä¸ªç”¨æˆ·çš„æ¶ˆæ¯ï¼Œå¯ä»¥åŒæ—¶å¹¿æ’­ç»™ä¸åŒçš„æœåŠ¡ï¼ˆå¹¿æ’­æ¨¡å¼ï¼‰ï¼Œä½†å¯¹äºåŒä¸€ä¸ªæœåŠ¡çš„ä¸åŒå®ä¾‹ï¼ˆæ¯”å¦‚ä¼šå‘˜æœåŠ¡1å’Œä¼šå‘˜æœåŠ¡2ï¼‰ï¼Œä¸ç®¡å“ªä¸ªå®ä¾‹æ¥å¤„ç†ï¼Œå¤„ç†ä¸€æ¬¡å³å¯ï¼ˆå·¥ä½œé˜Ÿåˆ—æ¨¡å¼ï¼‰ï¼š

![](https://static001.geekbang.org/resource/image/79/14/79994116247045ff90652254770a6d14.png?wh=1548%2A814)

åœ¨å®ç°ä»£ç çš„æ—¶å€™ï¼Œæˆ‘ä»¬åŠ¡å¿…ç¡®è®¤MQç³»ç»Ÿçš„æœºåˆ¶ï¼Œç¡®ä¿æ¶ˆæ¯çš„è·¯ç”±æŒ‰ç…§æˆ‘ä»¬çš„æœŸæœ›ã€‚

å¯¹äºç±»ä¼¼RocketMQè¿™æ ·çš„MQæ¥è¯´ï¼Œå®ç°ç±»ä¼¼åŠŸèƒ½æ¯”è¾ƒç®€å•ç›´ç™½ï¼šå¦‚æœæ¶ˆè´¹è€…å±äºä¸€ä¸ªç»„ï¼Œé‚£ä¹ˆæ¶ˆæ¯åªä¼šç”±åŒä¸€ä¸ªç»„çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¥æ¶ˆè´¹ï¼›å¦‚æœæ¶ˆè´¹è€…å±äºä¸åŒç»„ï¼Œé‚£ä¹ˆæ¯ä¸ªç»„éƒ½èƒ½æ¶ˆè´¹ä¸€éæ¶ˆæ¯ã€‚

è€Œå¯¹äºRabbitMQæ¥è¯´ï¼Œæ¶ˆæ¯è·¯ç”±çš„æ¨¡å¼é‡‡ç”¨çš„æ˜¯é˜Ÿåˆ—+äº¤æ¢å™¨ï¼Œé˜Ÿåˆ—æ˜¯æ¶ˆæ¯çš„è½½ä½“ï¼Œäº¤æ¢å™¨å†³å®šäº†æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ—çš„æ–¹å¼ï¼Œé…ç½®æ¯”è¾ƒå¤æ‚ï¼Œå®¹æ˜“å‡ºé”™ã€‚æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥æˆ‘é‡ç‚¹å’Œä½ è®²è®²RabbitMQçš„ç›¸å…³ä»£ç å®ç°ã€‚

æˆ‘ä»¬è¿˜æ˜¯ä»¥ä¸Šé¢çš„æ¶æ„å›¾ä¸ºä¾‹ï¼Œæ¥æ¼”ç¤ºä½¿ç”¨RabbitMQå®ç°å¹¿æ’­æ¨¡å¼å’Œå·¥ä½œé˜Ÿåˆ—æ¨¡å¼çš„å‘ã€‚

**ç¬¬ä¸€æ­¥ï¼Œå®ç°ä¼šå‘˜æœåŠ¡ç›‘å¬ç”¨æˆ·æœåŠ¡å‘å‡ºçš„æ–°ç”¨æˆ·æ³¨å†Œæ¶ˆæ¯çš„é‚£éƒ¨åˆ†é€»è¾‘ã€‚**

å¦‚æœæˆ‘ä»¬å¯åŠ¨ä¸¤ä¸ªä¼šå‘˜æœåŠ¡ï¼Œé‚£ä¹ˆåŒä¸€ä¸ªç”¨æˆ·çš„æ³¨å†Œæ¶ˆæ¯åº”è¯¥åªèƒ½è¢«å…¶ä¸­ä¸€ä¸ªå®ä¾‹æ¶ˆè´¹ã€‚

æˆ‘ä»¬åˆ†åˆ«å®ç°RabbitMQé˜Ÿåˆ—ã€äº¤æ¢å™¨ã€ç»‘å®šä¸‰ä»¶å¥—ã€‚å…¶ä¸­ï¼Œé˜Ÿåˆ—ç”¨çš„æ˜¯åŒ¿åé˜Ÿåˆ—ï¼Œäº¤æ¢å™¨ç”¨çš„æ˜¯ç›´æ¥äº¤æ¢å™¨DirectExchangeï¼Œäº¤æ¢å™¨ç»‘å®šåˆ°åŒ¿åé˜Ÿåˆ—çš„è·¯ç”±Keyæ˜¯ç©ºå­—ç¬¦ä¸²ã€‚åœ¨æ”¶åˆ°æ¶ˆæ¯ä¹‹åï¼Œæˆ‘ä»¬ä¼šæ‰“å°æ‰€åœ¨å®ä¾‹ä½¿ç”¨çš„ç«¯å£ï¼š

```
//ä¸ºäº†ä»£ç ç®€æ´ç›´è§‚ï¼Œæˆ‘ä»¬æŠŠæ¶ˆæ¯å‘å¸ƒè€…ã€æ¶ˆè´¹è€…ã€ä»¥åŠMQçš„é…ç½®ä»£ç éƒ½æ”¾åœ¨äº†ä¸€èµ·
@Slf4j
@Configuration
@RestController
@RequestMapping("workqueuewrong")
public class WorkQueueWrong {

    private static final String EXCHANGE = "newuserExchange";
    @Autowired
    private RabbitTemplate rabbitTemplate;

    @GetMapping
    public void sendMessage() {
        rabbitTemplate.convertAndSend(EXCHANGE, "", UUID.randomUUID().toString());
    }

    //ä½¿ç”¨åŒ¿åé˜Ÿåˆ—ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—
    @Bean
    public Queue queue() {
        return new AnonymousQueue();
    }
  
    //å£°æ˜DirectExchangeäº¤æ¢å™¨ï¼Œç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢å™¨
    @Bean
    public Declarables declarables() {
        DirectExchange exchange = new DirectExchange(EXCHANGE);
        return new Declarables(queue(), exchange,
                BindingBuilder.bind(queue()).to(exchange).with(""));
    }

    //ç›‘å¬é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—åç§°ç›´æ¥é€šè¿‡SpELè¡¨è¾¾å¼å¼•ç”¨Bean
    @RabbitListener(queues = "#{queue.name}")
    public void memberService(String userName) {
        log.info("memberService: welcome message sent to new user {} from {}", userName, System.getProperty("server.port"));

    }
}   
```

ä½¿ç”¨12345å’Œ45678ä¸¤ä¸ªç«¯å£å¯åŠ¨ä¸¤ä¸ªç¨‹åºå®ä¾‹åï¼Œè°ƒç”¨sendMessageæ¥å£å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œè¾“å‡ºçš„æ—¥å¿—ï¼Œæ˜¾ç¤º**åŒä¸€ä¸ªä¼šå‘˜æœåŠ¡ä¸¤ä¸ªå®ä¾‹éƒ½æ”¶åˆ°äº†æ¶ˆæ¯**ï¼š

![](https://static001.geekbang.org/resource/image/bd/5f/bd649f78f2f3a7c732b8883fd4d5255f.png?wh=2918%2A120)

![](https://static001.geekbang.org/resource/image/96/04/96278ba64ac411d5910d7ce8073c7304.png?wh=2898%2A126)

**å‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬æ²¡æœ‰ç†æ¸…æ¥šRabbitMQç›´æ¥äº¤æ¢å™¨å’Œé˜Ÿåˆ—çš„ç»‘å®šå…³ç³»ã€‚**

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒRabbitMQçš„ç›´æ¥äº¤æ¢å™¨æ ¹æ®routingKeyå¯¹æ¶ˆæ¯è¿›è¡Œè·¯ç”±ã€‚ç”±äºæˆ‘ä»¬çš„ç¨‹åºæ¯æ¬¡å¯åŠ¨éƒ½ä¼šåˆ›å»ºåŒ¿åï¼ˆéšæœºå‘½åï¼‰çš„é˜Ÿåˆ—ï¼Œæ‰€ä»¥ç›¸å½“äºæ¯ä¸€ä¸ªä¼šå‘˜æœåŠ¡å®ä¾‹éƒ½å¯¹åº”ç‹¬ç«‹çš„é˜Ÿåˆ—ï¼Œä»¥ç©ºroutingKeyç»‘å®šåˆ°ç›´æ¥äº¤æ¢å™¨ã€‚ç”¨æˆ·æœåŠ¡å‘å‡ºæ¶ˆæ¯çš„æ—¶å€™ä¹Ÿè®¾ç½®äº†routingKeyä¸ºç©ºï¼Œæ‰€ä»¥ç›´æ¥äº¤æ¢å™¨æ”¶åˆ°æ¶ˆæ¯ä¹‹åï¼Œå‘ç°æœ‰ä¸¤æ¡é˜Ÿåˆ—åŒ¹é…ï¼Œäºæ˜¯éƒ½è½¬å‘äº†æ¶ˆæ¯ï¼š

![](https://static001.geekbang.org/resource/image/c6/f8/c685c1a07347b040ee5ba1b48ce00af8.png?wh=1864%2A446)

è¦ä¿®å¤è¿™ä¸ªé—®é¢˜å…¶å®å¾ˆç®€å•ï¼Œå¯¹äºä¼šå‘˜æœåŠ¡ä¸è¦ä½¿ç”¨åŒ¿åé˜Ÿåˆ—ï¼Œè€Œæ˜¯ä½¿ç”¨åŒä¸€ä¸ªé˜Ÿåˆ—å³å¯ã€‚æŠŠä¸Šé¢ä»£ç ä¸­çš„åŒ¿åé˜Ÿåˆ—æ›¿æ¢ä¸ºä¸€ä¸ªæ™®é€šé˜Ÿåˆ—ï¼š

```
private static final String QUEUE = "newuserQueue";
@Bean
public Queue queue() {
    return new Queue(QUEUE);
}
```

æµ‹è¯•å‘ç°ï¼Œå¯¹äºåŒä¸€æ¡æ¶ˆæ¯æ¥è¯´ï¼Œä¸¤ä¸ªå®ä¾‹ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹å¯ä»¥æ”¶åˆ°ï¼Œä¸åŒçš„æ¶ˆæ¯æŒ‰ç…§è½®è¯¢åˆ†å‘ç»™ä¸åŒçš„å®ä¾‹ã€‚ç°åœ¨ï¼Œäº¤æ¢å™¨å’Œé˜Ÿåˆ—çš„å…³ç³»æ˜¯è¿™æ ·çš„ï¼š

![](https://static001.geekbang.org/resource/image/65/7b/65205002a2cdde62d55330263afd317b.png?wh=1724%2A424)

**ç¬¬äºŒæ­¥ï¼Œè¿›ä¸€æ­¥å®Œæ•´å®ç°ç”¨æˆ·æœåŠ¡éœ€è¦å¹¿æ’­æ¶ˆæ¯ç»™ä¼šå‘˜æœåŠ¡å’Œè¥é”€æœåŠ¡çš„é€»è¾‘ã€‚**

æˆ‘ä»¬å¸Œæœ›ä¼šå‘˜æœåŠ¡å’Œè¥é”€æœåŠ¡éƒ½å¯ä»¥æ”¶åˆ°å¹¿æ’­æ¶ˆæ¯ï¼Œä½†ä¼šå‘˜æœåŠ¡æˆ–è¥é”€æœåŠ¡ä¸­çš„æ¯ä¸ªå®ä¾‹åªéœ€è¦æ”¶åˆ°ä¸€æ¬¡æ¶ˆæ¯ã€‚

ä»£ç å¦‚ä¸‹ï¼Œæˆ‘ä»¬å£°æ˜äº†ä¸€ä¸ªé˜Ÿåˆ—å’Œä¸€ä¸ªå¹¿æ’­äº¤æ¢å™¨FanoutExchangeï¼Œç„¶åæ¨¡æ‹Ÿä¸¤ä¸ªç”¨æˆ·æœåŠ¡å’Œä¸¤ä¸ªè¥é”€æœåŠ¡ï¼š

```
@Slf4j
@Configuration
@RestController
@RequestMapping("fanoutwrong")
public class FanoutQueueWrong {
    private static final String QUEUE = "newuser";
    private static final String EXCHANGE = "newuser";
    @Autowired
    private RabbitTemplate rabbitTemplate;

    @GetMapping
    public void sendMessage() {
        rabbitTemplate.convertAndSend(EXCHANGE, "", UUID.randomUUID().toString());
    }
    //å£°æ˜FanoutExchangeï¼Œç„¶åç»‘å®šåˆ°é˜Ÿåˆ—ï¼ŒFanoutExchangeç»‘å®šé˜Ÿåˆ—çš„æ—¶å€™ä¸éœ€è¦routingKey
    @Bean
    public Declarables declarables() {
        Queue queue = new Queue(QUEUE);
        FanoutExchange exchange = new FanoutExchange(EXCHANGE);
        return new Declarables(queue, exchange,
                BindingBuilder.bind(queue).to(exchange));
    }
    //ä¼šå‘˜æœåŠ¡å®ä¾‹1
    @RabbitListener(queues = QUEUE)
    public void memberService1(String userName) {
        log.info("memberService1: welcome message sent to new user {}", userName);

    }
    //ä¼šå‘˜æœåŠ¡å®ä¾‹2
    @RabbitListener(queues = QUEUE)
    public void memberService2(String userName) {
        log.info("memberService2: welcome message sent to new user {}", userName);

    }
    //è¥é”€æœåŠ¡å®ä¾‹1
    @RabbitListener(queues = QUEUE)
    public void promotionService1(String userName) {
        log.info("promotionService1: gift sent to new user {}", userName);
    }
    //è¥é”€æœåŠ¡å®ä¾‹2
    @RabbitListener(queues = QUEUE)
    public void promotionService2(String userName) {
        log.info("promotionService2: gift sent to new user {}", userName);
    }
}
```

æˆ‘ä»¬è¯·æ±‚å››æ¬¡sendMessageæ¥å£ï¼Œæ³¨å†Œå››ä¸ªç”¨æˆ·ã€‚é€šè¿‡æ—¥å¿—å¯ä»¥å‘ç°ï¼Œ**ä¸€æ¡ç”¨æˆ·æ³¨å†Œçš„æ¶ˆæ¯ï¼Œè¦ä¹ˆè¢«ä¼šå‘˜æœåŠ¡æ”¶åˆ°ï¼Œè¦ä¹ˆè¢«è¥é”€æœåŠ¡æ”¶åˆ°ï¼Œæ˜¾ç„¶è¿™ä¸æ˜¯å¹¿æ’­**ã€‚é‚£ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„FanoutExchangeï¼Œçœ‹åå­—å°±åº”è¯¥æ˜¯å®ç°å¹¿æ’­çš„äº¤æ¢å™¨ï¼Œä¸ºä»€ä¹ˆæ ¹æœ¬æ²¡æœ‰èµ·ä½œç”¨å‘¢ï¼Ÿ

![](https://static001.geekbang.org/resource/image/34/6d/34e2ea5e0f38ac029ff3d909d8b9606d.png?wh=2974%2A390)

å…¶å®ï¼Œå¹¿æ’­äº¤æ¢å™¨éå¸¸ç®€å•ï¼Œå®ƒä¼šå¿½ç•¥routingKeyï¼Œå¹¿æ’­æ¶ˆæ¯åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ—ã€‚åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œä¸¤ä¸ªä¼šå‘˜æœåŠ¡å’Œä¸¤ä¸ªè¥é”€æœåŠ¡éƒ½ç»‘å®šäº†åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ‰€ä»¥è¿™å››ä¸ªæœåŠ¡åªèƒ½æ”¶åˆ°ä¸€æ¬¡æ¶ˆæ¯ï¼š

![](https://static001.geekbang.org/resource/image/20/cb/20adae38645d1cc169756fb4888211cb.png?wh=1656%2A462)

ä¿®æ”¹æ–¹å¼å¾ˆç®€å•ï¼Œæˆ‘ä»¬æŠŠé˜Ÿåˆ—è¿›è¡Œæ‹†åˆ†ï¼Œä¼šå‘˜å’Œè¥é”€ä¸¤ç»„æœåŠ¡åˆ†åˆ«ä½¿ç”¨ä¸€æ¡ç‹¬ç«‹é˜Ÿåˆ—ç»‘å®šåˆ°å¹¿æ’­äº¤æ¢å™¨å³å¯ï¼š

```
@Slf4j
@Configuration
@RestController
@RequestMapping("fanoutright")
public class FanoutQueueRight {
    private static final String MEMBER_QUEUE = "newusermember";
    private static final String PROMOTION_QUEUE = "newuserpromotion";
    private static final String EXCHANGE = "newuser";
    @Autowired
    private RabbitTemplate rabbitTemplate;
    @GetMapping
    public void sendMessage() {
        rabbitTemplate.convertAndSend(EXCHANGE, "", UUID.randomUUID().toString());
    }
    @Bean
    public Declarables declarables() {
        //ä¼šå‘˜æœåŠ¡é˜Ÿåˆ—
        Queue memberQueue = new Queue(MEMBER_QUEUE);
        //è¥é”€æœåŠ¡é˜Ÿåˆ—
        Queue promotionQueue = new Queue(PROMOTION_QUEUE);
        //å¹¿æ’­äº¤æ¢å™¨
        FanoutExchange exchange = new FanoutExchange(EXCHANGE);
        //ä¸¤ä¸ªé˜Ÿåˆ—ç»‘å®šåˆ°åŒä¸€ä¸ªäº¤æ¢å™¨
        return new Declarables(memberQueue, promotionQueue, exchange,
                BindingBuilder.bind(memberQueue).to(exchange),
                BindingBuilder.bind(promotionQueue).to(exchange));
    }
    @RabbitListener(queues = MEMBER_QUEUE)
    public void memberService1(String userName) {
        log.info("memberService1: welcome message sent to new user {}", userName);
    }
    @RabbitListener(queues = MEMBER_QUEUE)
    public void memberService2(String userName) {
        log.info("memberService2: welcome message sent to new user {}", userName);
    }
    @RabbitListener(queues = PROMOTION_QUEUE)
    public void promotionService1(String userName) {
        log.info("promotionService1: gift sent to new user {}", userName);
    }
    @RabbitListener(queues = PROMOTION_QUEUE)
    public void promotionService2(String userName) {
        log.info("promotionService2: gift sent to new user {}", userName);
    }
}
```

ç°åœ¨ï¼Œäº¤æ¢å™¨å’Œé˜Ÿåˆ—çš„ç»“æ„æ˜¯è¿™æ ·çš„ï¼š

![](https://static001.geekbang.org/resource/image/9a/78/9a3b06605913aa17025854dfbe6a5778.png?wh=1640%2A434)

ä»æ—¥å¿—è¾“å‡ºå¯ä»¥éªŒè¯ï¼Œå¯¹äºæ¯ä¸€æ¡MQæ¶ˆæ¯ï¼Œä¼šå‘˜æœåŠ¡å’Œè¥é”€æœåŠ¡åˆ†åˆ«éƒ½ä¼šæ”¶åˆ°ä¸€æ¬¡ï¼Œä¸€æ¡æ¶ˆæ¯å¹¿æ’­åˆ°ä¸¤ä¸ªæœåŠ¡çš„åŒæ—¶ï¼Œåœ¨æ¯ä¸€ä¸ªæœåŠ¡çš„ä¸¤ä¸ªå®ä¾‹ä¸­é€šè¿‡è½®è¯¢æ¥æ”¶ï¼š

![](https://static001.geekbang.org/resource/image/29/63/2975386cec273f3ca54b42872d9f4b63.png?wh=2886%2A390)

æ‰€ä»¥è¯´ï¼Œç†è§£äº†RabbitMQç›´æ¥äº¤æ¢å™¨ã€å¹¿æ’­äº¤æ¢å™¨çš„å·¥ä½œæ–¹å¼ä¹‹åï¼Œæˆ‘ä»¬å¯¹æ¶ˆæ¯çš„è·¯ç”±æ–¹å¼äº†è§£å¾—å¾ˆæ¸…æ™°äº†ï¼Œå®ç°ä»£ç å°±ä¸ä¼šå‡ºé”™ã€‚

å¯¹äºå¼‚æ­¥æµç¨‹æ¥è¯´ï¼Œæ¶ˆæ¯è·¯ç”±æ¨¡å¼ä¸€æ—¦é…ç½®å‡ºé”™ï¼Œè½»åˆ™å¯èƒ½å¯¼è‡´æ¶ˆæ¯çš„é‡å¤å¤„ç†ï¼Œé‡åˆ™å¯èƒ½å¯¼è‡´é‡è¦çš„æœåŠ¡æ— æ³•æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œæœ€ç»ˆé€ æˆä¸šåŠ¡é€»è¾‘é”™è¯¯ã€‚

æ¯ä¸ªMQä¸­é—´ä»¶å¯¹æ¶ˆæ¯çš„è·¯ç”±å¤„ç†çš„é…ç½®å„ä¸ç›¸åŒï¼Œæˆ‘ä»¬ä¸€å®šè¦å…ˆäº†è§£åŸç†å†ç€æ‰‹ç¼–ç ã€‚

## åˆ«è®©æ­»ä¿¡å µå¡äº†æ¶ˆæ¯é˜Ÿåˆ—

æˆ‘ä»¬åœ¨ä»‹ç»[çº¿ç¨‹æ± ](https://time.geekbang.org/column/article/210337)çš„æ—¶å€™æåˆ°ï¼Œå¦‚æœçº¿ç¨‹æ± çš„ä»»åŠ¡é˜Ÿåˆ—æ²¡æœ‰ä¸Šé™ï¼Œé‚£ä¹ˆæœ€ç»ˆå¯èƒ½ä¼šå¯¼è‡´OOMã€‚ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†å¼‚æ­¥æµç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹ŸåŒæ ·è¦æ³¨æ„æ¶ˆæ¯é˜Ÿåˆ—çš„ä»»åŠ¡å †ç§¯é—®é¢˜ã€‚å¯¹äºçªå‘æµé‡å¼•èµ·çš„æ¶ˆæ¯é˜Ÿåˆ—å †ç§¯ï¼Œé—®é¢˜å¹¶ä¸å¤§ï¼Œé€‚å½“è°ƒæ•´æ¶ˆè´¹è€…çš„æ¶ˆè´¹èƒ½åŠ›åº”è¯¥å°±å¯ä»¥è§£å†³ã€‚**ä½†åœ¨å¾ˆå¤šæ—¶å€™ï¼Œæ¶ˆæ¯é˜Ÿåˆ—çš„å †ç§¯å µå¡ï¼Œæ˜¯å› ä¸ºæœ‰å¤§é‡å§‹ç»ˆæ— æ³•å¤„ç†çš„æ¶ˆæ¯**ã€‚

æ¯”å¦‚ï¼Œç”¨æˆ·æœåŠ¡åœ¨ç”¨æˆ·æ³¨å†Œåå‘å‡ºä¸€æ¡æ¶ˆæ¯ï¼Œä¼šå‘˜æœåŠ¡ç›‘å¬åˆ°æ¶ˆæ¯åç»™ç”¨æˆ·æ´¾å‘ä¼˜æƒ åˆ¸ï¼Œä½†å› ä¸ºç”¨æˆ·å¹¶æ²¡æœ‰ä¿å­˜æˆåŠŸï¼Œä¼šå‘˜æœåŠ¡å¤„ç†æ¶ˆæ¯å§‹ç»ˆå¤±è´¥ï¼Œæ¶ˆæ¯é‡æ–°è¿›å…¥é˜Ÿåˆ—ï¼Œç„¶åè¿˜æ˜¯å¤„ç†å¤±è´¥ã€‚è¿™ç§åœ¨MQä¸­åƒå¹½çµä¸€æ ·å›è¡çš„åŒä¸€æ¡æ¶ˆæ¯ï¼Œå°±æ˜¯æ­»ä¿¡ã€‚

éšç€MQè¢«è¶Šæ¥è¶Šå¤šçš„æ­»ä¿¡å¡«æ»¡ï¼Œæ¶ˆè´¹è€…éœ€è¦èŠ±è´¹å¤§é‡æ—¶é—´åå¤å¤„ç†æ­»ä¿¡ï¼Œå¯¼è‡´æ­£å¸¸æ¶ˆæ¯çš„æ¶ˆè´¹å—é˜»ï¼Œ**æœ€ç»ˆMQå¯èƒ½å› ä¸ºæ•°æ®é‡è¿‡å¤§è€Œå´©æºƒ**ã€‚

æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹è¿™ä¸ªåœºæ™¯ã€‚é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªé˜Ÿåˆ—ã€ä¸€ä¸ªç›´æ¥äº¤æ¢å™¨ï¼Œç„¶åæŠŠé˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢å™¨ï¼š

```
@Bean
public Declarables declarables() {
    //é˜Ÿåˆ—
    Queue queue = new Queue(Consts.QUEUE);
    //äº¤æ¢å™¨
    DirectExchange directExchange = new DirectExchange(Consts.EXCHANGE);
    //å¿«é€Ÿå£°æ˜ä¸€ç»„å¯¹è±¡ï¼ŒåŒ…å«é˜Ÿåˆ—ã€äº¤æ¢å™¨ï¼Œä»¥åŠé˜Ÿåˆ—åˆ°äº¤æ¢å™¨çš„ç»‘å®š
    return new Declarables(queue, directExchange,
            BindingBuilder.bind(queue).to(directExchange).with(Consts.ROUTING_KEY));
}
```

ç„¶åï¼Œå®ç°ä¸€ä¸ªsendMessageæ–¹æ³•æ¥å‘é€æ¶ˆæ¯åˆ°MQï¼Œè®¿é—®ä¸€æ¬¡æäº¤ä¸€æ¡æ¶ˆæ¯ï¼Œä½¿ç”¨è‡ªå¢æ ‡è¯†ä½œä¸ºæ¶ˆæ¯å†…å®¹ï¼š

```
//è‡ªå¢æ¶ˆæ¯æ ‡è¯†
AtomicLong atomicLong = new AtomicLong();
@Autowired
private RabbitTemplate rabbitTemplate;

@GetMapping("sendMessage")
public void sendMessage() {
    String msg = "msg" + atomicLong.incrementAndGet();
    log.info("send message {}", msg);
    //å‘é€æ¶ˆæ¯
    rabbitTemplate.convertAndSend(Consts.EXCHANGE, msg);
}
```

æ”¶åˆ°æ¶ˆæ¯åï¼Œç›´æ¥æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œæ¨¡æ‹Ÿå¤„ç†å‡ºé”™çš„æƒ…å†µï¼š

```
@RabbitListener(queues = Consts.QUEUE)
public void handler(String data) {
    log.info("got message {}", data);
    throw new NullPointerException("error");
}
```

è°ƒç”¨sendMessageæ¥å£å‘é€ä¸¤æ¡æ¶ˆæ¯ï¼Œç„¶åæ¥åˆ°RabbitMQç®¡ç†å°ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸¤æ¡æ¶ˆæ¯å§‹ç»ˆåœ¨é˜Ÿåˆ—ä¸­ï¼Œä¸æ–­è¢«é‡æ–°æŠ•é€’ï¼Œå¯¼è‡´é‡æ–°æŠ•é€’QPSè¾¾åˆ°äº†1063ã€‚

![](https://static001.geekbang.org/resource/image/11/54/1130fc65dee6acba4df08227baf4d554.jpg?wh=2284%2A1281)

åŒæ—¶ï¼Œåœ¨æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°å¤§é‡å¼‚å¸¸ä¿¡æ¯ï¼š

```
[20:02:31.533] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [WARN ] [o.s.a.r.l.ConditionalRejectingErrorHandler:129 ] - Execution of Rabbit message listener failed.
org.springframework.amqp.rabbit.support.ListenerExecutionFailedException: Listener method 'public void org.geekbang.time.commonmistakes.asyncprocess.deadletter.MQListener.handler(java.lang.String)' threw exception
	at org.springframework.amqp.rabbit.listener.adapter.MessagingMessageListenerAdapter.invokeHandler(MessagingMessageListenerAdapter.java:219)
	at org.springframework.amqp.rabbit.listener.adapter.MessagingMessageListenerAdapter.invokeHandlerAndProcessResult(MessagingMessageListenerAdapter.java:143)
	at org.springframework.amqp.rabbit.listener.adapter.MessagingMessageListenerAdapter.onMessage(MessagingMessageListenerAdapter.java:132)
	at org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.doInvokeListener(AbstractMessageListenerContainer.java:1569)
	at org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.actualInvokeListener(AbstractMessageListenerContainer.java:1488)
	at org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.invokeListener(AbstractMessageListenerContainer.java:1476)
	at org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.doExecuteListener(AbstractMessageListenerContainer.java:1467)
	at org.springframework.amqp.rabbit.listener.AbstractMessageListenerContainer.executeListener(AbstractMessageListenerContainer.java:1411)
	at org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.doReceiveAndExecute(SimpleMessageListenerContainer.java:958)
	at org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.receiveAndExecute(SimpleMessageListenerContainer.java:908)
	at org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.access$1600(SimpleMessageListenerContainer.java:81)
	at org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer$AsyncMessageProcessingConsumer.mainLoop(SimpleMessageListenerContainer.java:1279)
	at org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer$AsyncMessageProcessingConsumer.run(SimpleMessageListenerContainer.java:1185)
	at java.lang.Thread.run(Thread.java:748)
Caused by: java.lang.NullPointerException: error
	at org.geekbang.time.commonmistakes.asyncprocess.deadletter.MQListener.handler(MQListener.java:14)
	at sun.reflect.GeneratedMethodAccessor46.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.springframework.messaging.handler.invocation.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:171)
	at org.springframework.messaging.handler.invocation.InvocableHandlerMethod.invoke(InvocableHandlerMethod.java:120)
	at org.springframework.amqp.rabbit.listener.adapter.HandlerAdapter.invoke(HandlerAdapter.java:50)
	at org.springframework.amqp.rabbit.listener.adapter.MessagingMessageListenerAdapter.invokeHandler(MessagingMessageListenerAdapter.java:211)
	... 13 common frames omitted
```

è§£å†³æ­»ä¿¡æ— é™é‡å¤è¿›å…¥é˜Ÿåˆ—æœ€ç®€å•çš„æ–¹å¼æ˜¯ï¼Œåœ¨ç¨‹åºå¤„ç†å‡ºé”™çš„æ—¶å€™ï¼Œç›´æ¥æŠ›å‡ºAmqpRejectAndDontRequeueExceptionå¼‚å¸¸ï¼Œé¿å…æ¶ˆæ¯é‡æ–°è¿›å…¥é˜Ÿåˆ—ï¼š

```
throw new AmqpRejectAndDontRequeueException("error");
```

ä½†ï¼Œæˆ‘ä»¬æ›´å¸Œæœ›çš„é€»è¾‘æ˜¯ï¼Œå¯¹äºåŒä¸€æ¡æ¶ˆæ¯ï¼Œèƒ½å¤Ÿå…ˆè¿›è¡Œå‡ æ¬¡é‡è¯•ï¼Œè§£å†³å› ä¸ºç½‘ç»œé—®é¢˜å¯¼è‡´çš„å¶å‘æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œå¦‚æœè¿˜æ˜¯ä¸è¡Œçš„è¯ï¼Œå†æŠŠæ¶ˆæ¯æŠ•é€’åˆ°ä¸“é—¨çš„ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—ã€‚å¯¹äºæ¥è‡ªæ­»ä¿¡é˜Ÿåˆ—çš„æ•°æ®ï¼Œæˆ‘ä»¬å¯èƒ½åªæ˜¯è®°å½•æ—¥å¿—å‘é€æŠ¥è­¦ï¼Œå³ä½¿å‡ºç°å¼‚å¸¸ä¹Ÿä¸ä¼šå†é‡å¤æŠ•é€’ã€‚æ•´ä¸ªé€»è¾‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://static001.geekbang.org/resource/image/40/28/40f0cf14933178fd07690372199e8428.png?wh=1478%2A684)

é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼ŒSpring AMQPæä¾›äº†éå¸¸æ–¹ä¾¿çš„è§£å†³æ–¹æ¡ˆï¼š

- é¦–å…ˆï¼Œå®šä¹‰æ­»ä¿¡äº¤æ¢å™¨å’Œæ­»ä¿¡é˜Ÿåˆ—ã€‚å…¶å®ï¼Œè¿™äº›éƒ½æ˜¯æ™®é€šçš„äº¤æ¢å™¨å’Œé˜Ÿåˆ—ï¼Œåªä¸è¿‡è¢«æˆ‘ä»¬ä¸“é—¨ç”¨äºå¤„ç†æ­»ä¿¡æ¶ˆæ¯ã€‚
- ç„¶åï¼Œé€šè¿‡RetryInterceptorBuilderæ„å»ºä¸€ä¸ªRetryOperationsInterceptorï¼Œç”¨äºå¤„ç†å¤±è´¥æ—¶å€™çš„é‡è¯•ã€‚è¿™é‡Œçš„ç­–ç•¥æ˜¯ï¼Œæœ€å¤šå°è¯•5æ¬¡ï¼ˆé‡è¯•4æ¬¡ï¼‰ï¼›å¹¶ä¸”é‡‡å–æŒ‡æ•°é€€é¿é‡è¯•ï¼Œé¦–æ¬¡é‡è¯•å»¶è¿Ÿ1ç§’ï¼Œç¬¬äºŒæ¬¡2ç§’ï¼Œä»¥æ­¤ç±»æ¨ï¼Œæœ€å¤§å»¶è¿Ÿæ˜¯10ç§’ï¼›å¦‚æœç¬¬4æ¬¡é‡è¯•è¿˜æ˜¯å¤±è´¥ï¼Œåˆ™ä½¿ç”¨RepublishMessageRecovereræŠŠæ¶ˆæ¯é‡æ–°æŠ•å…¥ä¸€ä¸ªâ€œæ­»ä¿¡äº¤æ¢å™¨â€ä¸­ã€‚
- æœ€åï¼Œå®šä¹‰æ­»ä¿¡é˜Ÿåˆ—çš„å¤„ç†ç¨‹åºã€‚è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•è®°å½•æ—¥å¿—ã€‚

å¯¹åº”çš„å®ç°ä»£ç å¦‚ä¸‹ï¼š

```
//å®šä¹‰æ­»ä¿¡äº¤æ¢å™¨å’Œé˜Ÿåˆ—ï¼Œå¹¶ä¸”è¿›è¡Œç»‘å®š
@Bean
public Declarables declarablesForDead() {
    Queue queue = new Queue(Consts.DEAD_QUEUE);
    DirectExchange directExchange = new DirectExchange(Consts.DEAD_EXCHANGE);
    return new Declarables(queue, directExchange,
            BindingBuilder.bind(queue).to(directExchange).with(Consts.DEAD_ROUTING_KEY));
}
//å®šä¹‰é‡è¯•æ“ä½œæ‹¦æˆªå™¨
@Bean
public RetryOperationsInterceptor interceptor() {
    return RetryInterceptorBuilder.stateless()
            .maxAttempts(5) //æœ€å¤šå°è¯•ï¼ˆä¸æ˜¯é‡è¯•ï¼‰5æ¬¡
            .backOffOptions(1000, 2.0, 10000) //æŒ‡æ•°é€€é¿é‡è¯•
            .recoverer(new RepublishMessageRecoverer(rabbitTemplate, Consts.DEAD_EXCHANGE, Consts.DEAD_ROUTING_KEY)) //é‡æ–°æŠ•é€’é‡è¯•è¾¾åˆ°ä¸Šé™çš„æ¶ˆæ¯
            .build();
}
//é€šè¿‡å®šä¹‰SimpleRabbitListenerContainerFactoryï¼Œè®¾ç½®å…¶adviceChainå±æ€§ä¸ºä¹‹å‰å®šä¹‰çš„RetryOperationsInterceptoræ¥å¯ç”¨é‡è¯•æ‹¦æˆªå™¨
@Bean
public SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(ConnectionFactory connectionFactory) {
    SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory();
    factory.setConnectionFactory(connectionFactory);
    factory.setAdviceChain(interceptor());
    return factory;
}
//æ­»ä¿¡é˜Ÿåˆ—å¤„ç†ç¨‹åº
@RabbitListener(queues = Consts.DEAD_QUEUE)
public void deadHandler(String data) {
    log.error("got dead message {}", data);
}
```

æ‰§è¡Œç¨‹åºï¼Œå‘é€ä¸¤æ¡æ¶ˆæ¯ï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š

```
[11:22:02.193] [http-nio-45688-exec-1] [INFO ] [o.g.t.c.a.d.DeadLetterController:24  ] - send message msg1
[11:22:02.219] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.deadletter.MQListener:13  ] - got message msg1
[11:22:02.614] [http-nio-45688-exec-2] [INFO ] [o.g.t.c.a.d.DeadLetterController:24  ] - send message msg2
[11:22:03.220] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.deadletter.MQListener:13  ] - got message msg1
[11:22:05.221] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.deadletter.MQListener:13  ] - got message msg1
[11:22:09.223] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.deadletter.MQListener:13  ] - got message msg1
[11:22:17.224] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.deadletter.MQListener:13  ] - got message msg1
[11:22:17.226] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [WARN ] [o.s.a.r.retry.RepublishMessageRecoverer:172 ] - Republishing failed message to exchange 'deadtest' with routing key deadtest
[11:22:17.227] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.deadletter.MQListener:13  ] - got message msg2
[11:22:17.229] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#1-1] [ERROR] [o.g.t.c.a.deadletter.MQListener:20  ] - got dead message msg1
[11:22:18.232] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.deadletter.MQListener:13  ] - got message msg2
[11:22:20.237] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.deadletter.MQListener:13  ] - got message msg2
[11:22:24.241] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.deadletter.MQListener:13  ] - got message msg2
[11:22:32.245] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [INFO ] [o.g.t.c.a.deadletter.MQListener:13  ] - got message msg2
[11:22:32.246] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] [WARN ] [o.s.a.r.retry.RepublishMessageRecoverer:172 ] - Republishing failed message to exchange 'deadtest' with routing key deadtest
[11:22:32.250] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#1-1] [ERROR] [o.g.t.c.a.deadletter.MQListener:20  ] - got dead message msg2
```

å¯ä»¥çœ‹åˆ°ï¼š

- msg1çš„4æ¬¡é‡è¯•é—´éš”åˆ†åˆ«æ˜¯1ç§’ã€2ç§’ã€4ç§’ã€8ç§’ï¼Œå†åŠ ä¸Šé¦–æ¬¡çš„å¤±è´¥ï¼Œæ‰€ä»¥æœ€å¤§å°è¯•æ¬¡æ•°æ˜¯5ã€‚
- 4æ¬¡é‡è¯•åï¼ŒRepublishMessageRecovereræŠŠæ¶ˆæ¯å‘å¾€äº†æ­»ä¿¡äº¤æ¢å™¨ã€‚
- æ­»ä¿¡å¤„ç†ç¨‹åºè¾“å‡ºäº†got dead messageæ—¥å¿—ã€‚

è¿™é‡Œéœ€è¦å°¤å…¶æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œè™½ç„¶æˆ‘ä»¬å‡ ä¹åŒæ—¶å‘é€äº†ä¸¤æ¡æ¶ˆæ¯ï¼Œä½†æ˜¯msg2æ˜¯åœ¨msg1çš„å››æ¬¡é‡è¯•å…¨éƒ¨ç»“æŸåæ‰å¼€å§‹å¤„ç†ã€‚åŸå› æ˜¯ï¼Œ**é»˜è®¤æƒ…å†µä¸‹SimpleMessageListenerContaineråªæœ‰ä¸€ä¸ªæ¶ˆè´¹çº¿ç¨‹**ã€‚å¯ä»¥é€šè¿‡å¢åŠ æ¶ˆè´¹çº¿ç¨‹æ¥é¿å…æ€§èƒ½é—®é¢˜ï¼Œå¦‚ä¸‹æˆ‘ä»¬ç›´æ¥è®¾ç½®concurrentConsumerså‚æ•°ä¸º10ï¼Œæ¥å¢åŠ åˆ°10ä¸ªå·¥ä½œçº¿ç¨‹ï¼š

```
@Bean
public SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(ConnectionFactory connectionFactory) {
    SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory();
    factory.setConnectionFactory(connectionFactory);
    factory.setAdviceChain(interceptor());
    factory.setConcurrentConsumers(10);
    return factory;
}
```

å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è®¾ç½®maxConcurrentConsumerså‚æ•°ï¼Œæ¥è®©SimpleMessageListenerContainerè‡ªå·±åŠ¨æ€åœ°è°ƒæ•´æ¶ˆè´¹è€…çº¿ç¨‹æ•°ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬éœ€è¦ç‰¹åˆ«æ³¨æ„å®ƒçš„åŠ¨æ€å¼€å¯æ–°çº¿ç¨‹çš„ç­–ç•¥ã€‚ä½ å¯ä»¥é€šè¿‡[å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-amqp/docs/2.2.1.RELEASE/reference/html/#listener-concurrency)ï¼Œæ¥äº†è§£è¿™ä¸ªç­–ç•¥ã€‚

## é‡ç‚¹å›é¡¾

åœ¨ä½¿ç”¨å¼‚æ­¥å¤„ç†è¿™ç§æ¶æ„æ¨¡å¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šä½¿ç”¨MQä¸­é—´ä»¶é…åˆå®ç°å¼‚æ­¥æµç¨‹ï¼Œéœ€è¦é‡ç‚¹è€ƒè™‘å››ä¸ªæ–¹é¢çš„é—®é¢˜ã€‚

ç¬¬ä¸€ï¼Œè¦è€ƒè™‘å¼‚æ­¥æµç¨‹ä¸¢æ¶ˆæ¯æˆ–å¤„ç†ä¸­æ–­çš„æƒ…å†µï¼Œå¼‚æ­¥æµç¨‹éœ€è¦æœ‰å¤‡çº¿è¿›è¡Œè¡¥å¿ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬ä»Šå¤©ä»‹ç»çš„å…¨é‡è¡¥å¿æ–¹å¼ï¼Œå³ä¾¿å¼‚æ­¥æµç¨‹å½»åº•å¤±æ•ˆï¼Œé€šè¿‡è¡¥å¿ä¹Ÿèƒ½è®©ä¸šåŠ¡ç»§ç»­è¿›è¡Œã€‚

ç¬¬äºŒï¼Œå¼‚æ­¥å¤„ç†çš„æ—¶å€™éœ€è¦è€ƒè™‘æ¶ˆæ¯é‡å¤çš„å¯èƒ½æ€§ï¼Œå¤„ç†é€»è¾‘éœ€è¦å®ç°å¹‚ç­‰ï¼Œé˜²æ­¢é‡å¤å¤„ç†ã€‚

ç¬¬ä¸‰ï¼Œå¾®æœåŠ¡åœºæ™¯ä¸‹ä¸åŒæœåŠ¡å¤šä¸ªå®ä¾‹ç›‘å¬æ¶ˆæ¯çš„æƒ…å†µï¼Œä¸€èˆ¬ä¸åŒæœåŠ¡éœ€è¦åŒæ—¶æ”¶åˆ°ç›¸åŒçš„æ¶ˆæ¯ï¼Œè€Œç›¸åŒæœåŠ¡çš„å¤šä¸ªå®ä¾‹åªéœ€è¦è½®è¯¢æ¥æ”¶æ¶ˆæ¯ã€‚æˆ‘ä»¬éœ€è¦ç¡®è®¤MQçš„æ¶ˆæ¯è·¯ç”±é…ç½®æ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Œä»¥é¿å…æ¶ˆæ¯é‡å¤æˆ–æ¼å‘é—®é¢˜ã€‚

ç¬¬å››ï¼Œè¦æ³¨æ„å§‹ç»ˆæ— æ³•å¤„ç†çš„æ­»ä¿¡æ¶ˆæ¯ï¼Œå¯èƒ½ä¼šå¼•å‘å µå¡MQçš„é—®é¢˜ã€‚ä¸€èˆ¬åœ¨é‡åˆ°æ¶ˆæ¯å¤„ç†å¤±è´¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€å®šçš„é‡è¯•ç­–ç•¥ã€‚å¦‚æœé‡è¯•è¿˜æ˜¯ä¸è¡Œï¼Œé‚£å¯ä»¥æŠŠè¿™ä¸ªæ¶ˆæ¯æ‰”åˆ°ä¸“æœ‰çš„æ­»ä¿¡é˜Ÿåˆ—ç‰¹åˆ«å¤„ç†ï¼Œä¸è¦è®©æ­»ä¿¡å½±å“åˆ°æ­£å¸¸æ¶ˆæ¯çš„å¤„ç†ã€‚

ä»Šå¤©ç”¨åˆ°çš„ä»£ç ï¼Œæˆ‘éƒ½æ”¾åœ¨äº†GitHubä¸Šï¼Œä½ å¯ä»¥ç‚¹å‡»[è¿™ä¸ªé“¾æ¥](https://github.com/JosephZhu1983/java-common-mistakes)æŸ¥çœ‹ã€‚

## æ€è€ƒä¸è®¨è®º

1. åœ¨ç”¨æˆ·æ³¨å†Œåå‘é€æ¶ˆæ¯åˆ°MQï¼Œç„¶åä¼šå‘˜æœåŠ¡ç›‘å¬æ¶ˆæ¯è¿›è¡Œå¼‚æ­¥å¤„ç†çš„åœºæ™¯ä¸‹ï¼Œæœ‰äº›æ—¶å€™æˆ‘ä»¬ä¼šå‘ç°ï¼Œè™½ç„¶ç”¨æˆ·æœåŠ¡å…ˆä¿å­˜æ•°æ®å†å‘é€MQï¼Œä½†ä¼šå‘˜æœåŠ¡æ”¶åˆ°æ¶ˆæ¯åå»æŸ¥è¯¢æ•°æ®åº“ï¼Œå´å‘ç°æ•°æ®åº“ä¸­è¿˜æ²¡æœ‰æ–°ç”¨æˆ·çš„ä¿¡æ¯ã€‚ä½ è§‰å¾—ï¼Œè¿™å¯èƒ½æ˜¯ä»€ä¹ˆé—®é¢˜å‘¢ï¼Œåˆè¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ
2. é™¤äº†ä½¿ç”¨Spring AMQPå®ç°æ­»ä¿¡æ¶ˆæ¯çš„é‡æŠ•é€’å¤–ï¼ŒRabbitMQ 2.8.0 åæ”¯æŒçš„æ­»ä¿¡äº¤æ¢å™¨DLXä¹Ÿå¯ä»¥å®ç°ç±»ä¼¼åŠŸèƒ½ã€‚ä½ èƒ½å°è¯•ç”¨DLXå®ç°å—ï¼Œå¹¶æ¯”è¾ƒä¸‹è¿™ä¸¤ç§å¤„ç†æœºåˆ¶ï¼Ÿ

å…³äºä½¿ç”¨MQè¿›è¡Œå¼‚æ­¥å¤„ç†æµç¨‹ï¼Œä½ è¿˜é‡åˆ°è¿‡å…¶ä»–é—®é¢˜å—ï¼Ÿæˆ‘æ˜¯æœ±æ™”ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºä¸æˆ‘ç•™è¨€åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ï¼Œä¸€èµ·äº¤æµã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>vivi</span> ğŸ‘ï¼ˆ35ï¼‰ ğŸ’¬ï¼ˆ7ï¼‰<p>æˆ‘ä¹‹å‰åšè¿‡ä¸€ä¸ªdemo æ˜¯åŸºäºcanalåšmysqlæ•°æ®åŒæ­¥ï¼Œéœ€è¦å°†è§£æå¥½çš„æ•°æ®å‘åˆ°kafkaé‡Œé¢ï¼Œå†è¿›è¡Œå¤„ç†ã€‚åœ¨ä½¿ç”¨çš„æ—¶å€™å‘ç°è¿™ä¹ˆä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯kafkaå¤špartitionæ¶ˆè´¹æ—¶ä¸èƒ½ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ¶ˆè´¹ï¼Œè¿›è€Œå¯¼è‡´mysqlæ•°æ®åŒæ­¥å¼‚å¸¸ã€‚
ç”±äºkafkaå¯ä»¥ä¿è¯åœ¨åŒä¸€ä¸ªpartitionå†…æ¶ˆæ¯æœ‰åºï¼Œäºæ˜¯æˆ‘è‡ªå®šä¹‰äº†ä¸€ä¸ªåˆ†åŒºå™¨ï¼Œå°†æ•°æ®çš„idå–hashcodeç„¶åæ ¹æ®partitionçš„æ•°é‡å–ä½™ä½œä¸ºåˆ†åŒºå·ï¼Œä¿è¯åŒä¸€æ¡æ•°æ®çš„binlogèƒ½æŠ•é€’åˆ°åŒä¸€ä¸ªpartitionä¸­ï¼Œä»è€Œè¾¾åˆ°æ¶ˆæ¯é¡ºåºæ¶ˆè´¹çš„ç›®çš„ã€‚</p>2020-05-12</li><br/><li><span>æ¯å¤©æ™’ç™½ç‰™</span> ğŸ‘ï¼ˆ30ï¼‰ ğŸ’¬ï¼ˆ9ï¼‰<p>è€å¸ˆï¼Œæˆ‘ç†è§£çš„å¼‚æ­¥å¤„ç†ä¸ä»…ä»…æ˜¯é€šè¿‡ MQ æ¥å®ç°ï¼Œè¿˜æœ‰å…¶ä»–æ–¹å¼
æ¯”å¦‚å¼€æ–°çº¿ç¨‹æ‰§è¡Œï¼Œè¿”å› Future
è¿˜æœ‰å„ç§å¼‚æ­¥æ¡†æ¶ï¼Œæ¯”å¦‚ Vertxï¼Œå®ƒæ˜¯é€šè¿‡ callback çš„æ–¹å¼å®ç°

æ€è€ƒé¢˜
1.å¯èƒ½æ˜¯æ•°æ®å†™åˆ°äº†ä¸»åº“ï¼Œç„¶åæŸ¥è¯¢äº†ä»åº“ã€‚ä½†å› ä¸ºä¸»ä»åŒæ­¥æœ‰å»¶è¿Ÿï¼Œå¯¼è‡´æ²¡æœ‰æŸ¥è¯¢åˆ°</p>2020-05-12</li><br/><li><span>Darren</span> ğŸ‘ï¼ˆ21ï¼‰ ğŸ’¬ï¼ˆ6ï¼‰<p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š
	æ¯å¤©æ™’ç™½ç‰™å¤§ä½¬çš„å›ç­”å’Œè€å¸ˆçš„å›å¤å·²ç»å¾ˆæ£’äº†ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚
ç¬¬äºŒä¸ªé—®é¢˜ï¼š
	è‡ªå®šä¹‰çš„ç§ä¿¡é˜Ÿåˆ—ï¼Œå…¶å®æ˜¯å‘é€å¤±è´¥ï¼Œä¸»è¦æ˜¯ç”Ÿäº§è€…å‘é€åˆ°mqçš„æ—¶å€™ï¼Œå‘é€å¤±è´¥ï¼Œè¿›äº†è‡ªå®šä¹‰çš„ç§ä¿¡é˜Ÿåˆ—ï¼›
	DLXçš„æ–¹å¼çš„æ–¹å¼å…¶å®è§£å†³å·²åˆ°äº†mqï¼Œä½†æ˜¯å› ä¸ºå„ç§åŸå› ï¼Œæ— æ³•åˆ°è¾¾æ­£å¸¸çš„é˜Ÿåˆ—ä¸­ï¼Œå¤§æ¦‚åˆ†ç±»ä¸‹é¢å‡ ç§å§ï¼š
		æ¶ˆæ¯æ¶ˆè´¹æ—¶è¢«æ‹’ç»(basic.reject &#47; basic.nack)ï¼Œå¹¶ä¸”requeue = false
		æ¶ˆæ¯TTLè¿‡æœŸ
		é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦

åˆ†äº«ä¸€ä¸‹ä¹‹å‰åœ¨å…¬å¸å†…éƒ¨åˆ†äº«çš„RabbitMQçš„èµ„æ–™ï¼Œæ¬¢è¿å¤§å®¶äº¤æµ
githubä¸Šä¼ ä¸ä¸Šå»ï¼Œåªèƒ½ç”¨æœ‰é“äº‘ç¬”è®°ï¼Œè¯·å¤§å®¶è§è°…
èµ„æ–™ä¸»è¦ä»ï¼š
    MQé€‰å‹åŠç‰¹ç‚¹ï¼›
    AMQPä¸RabbitMQæ¨¡å‹ï¼›
    RabbitMQæ ¸å¿ƒæ¦‚å¿µï¼›
    RabbitMQç›¸å…³æœºåˆ¶ï¼›
è¿™å‡ ä¸ªç‚¹å»åˆ†æçš„ï¼Œè¯·å¤§å®¶å¤šå¤šæŒ‡æ•™ã€‚
http:&#47;&#47;note.youdao.com&#47;noteshare?id=e9f2f88c6c7fcb7ac690463eb230650a
</p>2020-05-12</li><br/><li><span>203ã€‚</span> ğŸ‘ï¼ˆ7ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è€å¸ˆ æˆ‘è¿™é‡Œæœ‰ä¸ªé—®é¢˜ å…³äºStreamçš„ï¼Œä¸šåŠ¡éœ€æ±‚é‡Œéœ€è¦æŒ‰æŸå‡ ä¸ªå­—æ®µå»é‡(acctId,billingCycleId,prodInstId,offerId)
æˆ‘è¿™é‡Œæƒ³åˆ°äº†éå†é›†åˆareaDatas åç”¨containsæ–¹æ³•åˆ¤æ–­ é‡å†™AcctItemYzfBeanå®ä½“ç±»çš„equalsæ–¹æ³•å®ç°ï¼Œ
è¯·é—®æœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ³•ï¼Ÿ ä»£ç å¦‚ä¸‹

List&lt;AcctItemYzfBean&gt; newList = new CopyOnWriteArrayList&lt;&gt;();
&#47;&#47;å¾ªç¯è¿‡æ»¤ã€å¢å¼ºç¿¼æ”¯ä»˜æ•°æ®
Optional.ofNullable(areaDatas)&#47;&#47;é›†åˆåˆ¤ç©º
		.orElse(new ArrayList&lt;&gt;())
		.stream()&#47;&#47;è½¬åŒ–ä¸ºæµ ä¾¿äºä¸‹é¢è¿‡æ»¤å’Œå¢å¼ºæ•°æ®
		.filter(Objects::nonNull)&#47;&#47;å…ƒç´ åˆ¤ç©º
		.filter(yzfBean -&gt; this.judgeIfOfferId(yzfBean))&#47;&#47;åˆ¤æ–­é”€å”®å“IDæ˜¯å¦ç›¸åŒ
		.filter(yzfBean -&gt; this.enhanceYzfBean(yzfBean))&#47;&#47;å¢å¼ºè¿‡æ»¤accNbrå’ŒacctId
		.filter(yzfBean -&gt; this.judgeIfArrears(yzfBean))&#47;&#47;åˆ¤æ–­æ˜¯å¦ä¸æ¬ è´¹
		.filter(yzfBean -&gt; this.judgeIfCancel(yzfBean))&#47;&#47;åˆ¤æ–­æ˜¯å¦é”€è´¦é‡‘é¢å¤§äº0
		.filter(yzfBean -&gt; this.judgeIfReturn(yzfBean))&#47;&#47;åˆ¤æ–­æ˜¯å¦ä¸Šæœˆæœªè¿”è¿˜
		.forEach(yzfBean -&gt; {
			&#47;&#47;å»é‡ é‡å†™AcctItemYzfBean.equalsæ–¹æ³•
			if(!newList.contains(yzfBean)) {
				&#47;&#47;å¢å¼ºlatnName
				yzfBean.setLatnName(commonRegionMap.get(yzfBean.getRegionId()));
				&#47;&#47;å¢å¼ºareaCode
				yzfBean.setAreaCode(areaCode);
				&#47;&#47;æ•°æ®å°è£…
				newList.add(yzfBean);
			}
		});

é‡å†™çš„equalsæ–¹æ³•		
@Override
public boolean equals(Object yzfBeanObj) {
	if(yzfBeanObj instanceof AcctItemYzfBean) {
		AcctItemYzfBean yzfBean = (AcctItemYzfBean) yzfBeanObj;
		if(Tools.isEmpty(yzfBean.getAcctId(), yzfBean.getBillingCycleId(), yzfBean.getProdInstId(),  yzfBean.getOfferId())) {
			return false;
		}
		if(yzfBean.getAcctId().equals(this.acctId) &amp;&amp; yzfBean.getBillingCycleId().equals(this.billingCycleId)
				&amp;&amp; yzfBean.getProdInstId().equals(this.prodInstId) &amp;&amp; yzfBean.getOfferId().equals(this.offerId)) {
			return true;
		}
	}
	return super.equals(yzfBeanObj);
}</p>2020-05-12</li><br/><li><span>ä¼¼æ›¾ç›¸è¯†</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆ 
1.å¦‚æœå®é™…ç”Ÿäº§ä¸­ç”¨ä½¿ç”¨ ConcurrentHashMap æ¥å­˜æ”¾é‚£äº›å‘è¿‡çŸ­ä¿¡çš„ç”¨æˆ· ID å®ç°å¹‚ç­‰ï¼Œå¦‚ä½•ä¸€ç›´å¾€mapä¸­å¢åŠ ï¼Œä¼šä¸ä¼šoomå‘¢ï¼Ÿ
2.å¦‚æœæ•°æ®é‡å·¨å¤§ ä½¿ç”¨ConcurrentSkipListMap è·³è¡¨ä¼šä¸ä¼šæ›´å¥½ä¸€äº›å‘¢ï¼Ÿ
</p>2020-05-17</li><br/><li><span>ç‹é¹</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<p>mqå‘ä¿¡æ¯å†™åˆ°äº†äº‹åŠ¡ä¸­ï¼Œå¯¼è‡´äº†mqçš„æ¶ˆè´¹æ—¶ï¼Œäº‹åŠ¡è¿˜æ²¡æœ‰æäº¤</p>2020-05-12</li><br/><li><span>éƒ­çŸ³é¾™</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œä½ å¥½ï¼Œå¦‚æœæœ‰å¤šä¸ªè¡¥å¿å®ä¾‹ï¼Œä¼šä¸ä¼šé€ æˆæ¶ˆæ¯é‡å¤ï¼Ÿ</p>2020-05-12</li><br/><li><span>é²é¸£</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>åœ¨event sourcingçš„æ—¶å€™ï¼Œæœ‰ä¸€ç§æ–¹æ¡ˆæ˜¯outboxï¼Œåœ¨å‘é€æ–¹ç»´æŒä¸€ä¸ªæ•°æ®è¡¨ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ¶ˆæ¯å’Œä¸šåŠ¡æ•°æ®åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œä¹Ÿæ˜¯ä¸€ç§æ¶ˆæ¯å‘é€è®°å½•çš„æ–¹å¼</p>2020-09-25</li><br/><li><span>Gå°è°ƒ</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæ˜¯å¦å¯ä»¥è¿™æ ·è§£å†³
1.å…ˆä¿å­˜ç”¨æˆ·æ³¨å†Œçš„æ•°æ®ï¼ŒåŒæ—¶è®°å½•ä¸‹è¦å‘é€mqçš„æ¶ˆæ¯ï¼Œå…¥åº“åœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œ
2.é€šè¿‡å¼‚æ­¥ä»»åŠ¡å®šæ—¶æ‹‰å–mqçš„æ¶ˆæ¯è¡¨ï¼Œå‘é€åˆ°mqï¼Œè¿›è¡Œå¤„ç†

ä½†è¿™ä¸ªæœ‰ä¸ªé—®é¢˜ï¼Œå¼‚æ­¥ä»»åŠ¡å°±èƒ½æ‰§è¡Œmqçš„çš„ä¸šåŠ¡ï¼Œé‚£mqçš„ä»·å€¼æ˜¯ä¸æ˜¯å‡å°‘äº†</p>2020-05-15</li><br/><li><span>walleæ–Œ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>å¯¹äº†  è®¸å¤šåŒæ—¶ç”¨@Asyncæ ‡ç­¾å®ç° å¸Œæœ›èƒ½å¤Ÿåšåˆ°ï¼Œä½†æ˜¯åˆä¸ç”¨100%ä¿è¯çš„è§£è€¦åŠ¨ä½œã€‚å®é™…ä¹Ÿæœ‰éšæ‚£ï¼Œä¸æ”¾æŠŠ@Asyncæ ‡ç­¾åº•å±‚å®ç°æ›´æ¢ä¸ºmqï¼Œæ˜¯ä¸æ˜¯æ›´åˆé€‚ï¼Ÿ</p>2021-07-12</li><br/><li><span>é£è½»æ‰¬</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æˆ‘å‰å‡ å¤©å°±é‡åˆ°äº†é—®é¢˜ä¸€ã€‚æ˜¯å› ä¸ºmqå‘é€æ¶ˆæ¯åœ¨äº‹åŠ¡æ–¹æ³•é‡Œã€‚mqå‘æ¶ˆæ¯æ—¶ï¼Œæ•°æ®åº“äº‹åŠ¡å¯èƒ½è¿˜æ²¡æœ‰æäº¤(ä¸æ˜¯å¿…ç°)ã€‚
è€å¸ˆï¼Œä½ ç”¨çš„ThreadFactoryBuilderï¼Œæˆ‘å¼•å…¥å¯¹åº”çš„ä¾èµ–ä¹‹åï¼Œå‘ç°ä¼šè¯¥ä¾èµ–ä¼šå¼•å…¥å…¶ä»–Nå¤šä¸ªä¸ç›¸å¹²çš„ä¾èµ–ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚æ‚¨æ˜¯å’‹è§£å†³çš„ï¼Ÿ</p>2020-10-19</li><br/><li><span>è‹—</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼šrabbitmqä¸­çš„SimpleRabbitListenerContainerFactoryè®¾ç½®çš„æœ€å¤§æ¶ˆè´¹çº¿ç¨‹æ•°å’Œç›‘å¬çš„é˜Ÿåˆ—æ•°ä¹‹é—´åº”è¯¥æ˜¯ä»€ä¹ˆå…³ç³»æ¯”è¾ƒåˆé€‚ï¼Ÿæ˜¯ç›‘æ§æ¶ˆè´¹qpsï¼Œæ¶ˆæ¯æ€»é‡ç­‰æƒ…å†µï¼Œè°ƒæ•´æœ€å¤§æ¶ˆè´¹çº¿ç¨‹æ•°å—ï¼Ÿ
       </p>2020-09-09</li><br/><li><span>é£ç¿”</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆ ç”Ÿäº§è€…å‘é€ç»™mqæ¶ˆæ¯ å³ä½¿å¼‚æ­¥å‘é€ä¹Ÿä¼šæœ‰listener æ¥ç›‘å¬æŠ•é€’æ¶ˆæ¯æ˜¯å¦æˆåŠŸ å¦‚æœå¤±è´¥ é‡è¯•ä¸å°±è¡Œäº† ï¼Ÿ ä¸æ˜¯ç±»ä¼¼kafka æœ‰100%æŠ•é€’ 100%ä¿è¯æ¶ˆè´¹çš„é…ç½®å˜›</p>2020-05-30</li><br/><li><span>ç¨‹åºå‘˜å°è·ƒ</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>é—®é¢˜ä¸€å‡ºç°çš„é—®é¢˜æˆ‘ä¹Ÿé‡åˆ°äº†ï¼Œå’Œè¯„è®ºåŒºåŒ…æ‹¬å’Œè€å¸ˆé‡åˆ°çš„é—®é¢˜ä¸€æ ·ï¼Œè¿˜æ˜¯å› ä¸ºåœ¨äº‹åŠ¡æ²¡å®Œæˆçš„æ—¶å€™è¿›è¡Œäº†æäº¤ï¼Œå°±ä¼šäº§ç”Ÿæ¦‚ç‡æ€§çš„æŸ¥è¯¢ä¸åˆ°ç»“æœã€‚

è¿™ç§é”™è¯¯ï¼Œç»å†è¿‡ä¸€æ¬¡ï¼Œåé¢çš„äº‹æƒ…å°±å¥½åŠäº†ï¼Œä¼šå½“åšä¸€ä¸ªtipså§‹ç»ˆè®°åœ¨å¿ƒé‡Œï¼Œç¼–ç çš„æ—¶å€™ä¹Ÿä¸€ç›´æ³¨æ„ç€ ã€‚æ²¡æƒ³åˆ°åœ¨è¿™é‡Œè¿˜èƒ½å’Œå¤§å®¶é‡åˆ°ç±»ä¼¼çš„é—®é¢˜ï¼Œå¹¸ä¼šå¹¸ä¼š</p>2020-10-24</li><br/><li><span>walleæ–Œ</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>é¢ çœ‹å®Œè€å¸ˆç”¨rabbitmq ï¼Œå¾ˆåº†å¹¸å½“æ—¶æŠ€æœ¯é€‰å‹é€‰äº†rocketmqï¼Œè‡ªå¸¦è¡¥å¿ï¼Œæ—¶é—´é€’å¢é‡è¯•ã€‚ã€‚å¤–åŠ æ¶ˆè´¹ç«¯å¤©ç„¶æ”¯æŒå¹¶å‘æ¶ˆè´¹ã€‚æ¶ˆè´¹å¹¶å‘èƒ½åŠ›=  è¯»é˜Ÿåˆ—æ•°* æ¶ˆè´¹ç«¯çš„çº¿ç¨‹æ•°ã€‚ 
å¤–åŠ rocketmq æ”¯æŒåˆ†å¸ƒå¼äº‹ç‰©ã€‚ã€‚é«˜æ•ˆçš„tagså¹¿æ’­æ¶ˆæ¯æ¶ˆè´¹ï¼Œä½æ•ˆä½†æ˜¯å®šåˆ¶åŒ–æå¼ºçš„sqlç­›é€‰æ¶ˆæ¯æ¶ˆè´¹ï¼Œè€Œä¸”å»¶è¿Ÿä½ï¼Œæ”¯æŒæ¶ˆæ¯å †ç§¯èƒ½åŠ›å¼ºã€‚
æ€»ä½“è€Œè¨€ï¼Œã€‚å¯¹äºä¸šåŠ¡è€Œè¨€rocketmqçš„æ˜“ç”¨åº¦ æ˜¯å¥½äºrabbitmqçš„ã€‚è®¸å¤šæ˜¯å› ä¸ºä¹ æƒ¯çš„æƒ¯æ€§è¿˜åœ¨ç”¨rabbitmq</p>2021-07-12</li><br/>
</ul>