ä½ å¥½ï¼Œæˆ‘æ˜¯æœ±æ™”ã€‚

ä»Šå¤©ï¼Œæˆ‘ä»¬ç»§ç»­ä¸€èµ·åˆ†æè¿™é—¨è¯¾ç¬¬13~20è®²çš„è¯¾åæ€è€ƒé¢˜ã€‚è¿™äº›é¢˜ç›®æ¶‰åŠäº†æ—¥å¿—ã€æ–‡ä»¶IOã€åºåˆ—åŒ–ã€Java 8æ—¥æœŸæ—¶é—´ç±»ã€OOMã€Javaé«˜çº§ç‰¹æ€§ï¼ˆåå°„ã€æ³¨è§£å’Œæ³›å‹ï¼‰å’ŒSpringæ¡†æ¶çš„16é“é—®é¢˜ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä¸€ä¸€å…·ä½“åˆ†æå§ã€‚

### [13 | æ—¥å¿—ï¼šæ—¥å¿—è®°å½•çœŸæ²¡ä½ æƒ³è±¡çš„é‚£ä¹ˆç®€å•](https://time.geekbang.org/column/article/220307)

**é—®é¢˜1ï¼š**åœ¨è®²â€œä¸ºä»€ä¹ˆæˆ‘çš„æ—¥å¿—ä¼šé‡å¤è®°å½•ï¼Ÿâ€çš„æ¡ˆä¾‹æ—¶ï¼Œæˆ‘ä»¬æŠŠINFOçº§åˆ«çš„æ—¥å¿—å­˜æ”¾åˆ°\_info.logä¸­ï¼ŒæŠŠWARNå’ŒERRORçº§åˆ«çš„æ—¥å¿—å­˜æ”¾åˆ°\_error.logä¸­ã€‚å¦‚æœç°åœ¨è¦æŠŠINFOå’ŒWARNçº§åˆ«çš„æ—¥å¿—å­˜æ”¾åˆ°\_info.logä¸­ï¼ŒæŠŠERRORæ—¥å¿—å­˜æ”¾åˆ°\_error.logä¸­ï¼Œåº”è¯¥å¦‚ä½•é…ç½®Logbackå‘¢ï¼Ÿ

ç­”ï¼šè¦å®ç°è¿™ä¸ªé…ç½®æœ‰ä¸¤ç§æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯ï¼šç›´æ¥ä½¿ç”¨EvaluatorFilterå’Œè‡ªå®šä¹‰ä¸€ä¸ªFilterã€‚æˆ‘ä»¬åˆ†åˆ«çœ‹ä¸€ä¸‹ã€‚

ç¬¬ä¸€ç§æ–¹å¼æ˜¯ï¼Œç›´æ¥ä½¿ç”¨logbackè‡ªå¸¦çš„EvaluatorFilterï¼š

```
<filter class="ch.qos.logback.core.filter.EvaluatorFilter">
    <evaluator class="ch.qos.logback.classic.boolex.GEventEvaluator">
        <expression>
            e.level.toInt() == WARN.toInt() || e.level.toInt() == INFO.toInt()
        </expression>
    </evaluator>
    <OnMismatch>DENY</OnMismatch>
    <OnMatch>NEUTRAL</OnMatch>
</filter>
```

ç¬¬äºŒç§æ–¹å¼æ˜¯ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªFilterï¼Œå®ç°è§£æé…ç½®ä¸­çš„â€œ|â€å­—ç¬¦åˆ†å‰²çš„å¤šä¸ªLevelï¼š

```
public class MultipleLevelsFilter extends Filter<ILoggingEvent> {

    @Getter
    @Setter
    private String levels;
    private List<Integer> levelList;

    @Override
    public FilterReply decide(ILoggingEvent event) {

        if (levelList == null && !StringUtils.isEmpty(levels)) {
            //æŠŠç”±|åˆ†å‰²çš„å¤šä¸ªLevelè½¬æ¢ä¸ºList<Integer>
            levelList = Arrays.asList(levels.split("\\|")).stream()
                    .map(item -> Level.valueOf(item))
                    .map(level -> level.toInt())
                    .collect(Collectors.toList());
        }
        //å¦‚æœlevelListåŒ…å«å½“å‰æ—¥å¿—çš„çº§åˆ«ï¼Œåˆ™æ¥æ”¶å¦åˆ™æ‹’ç»
        if (levelList.contains(event.getLevel().toInt()))
            return FilterReply.ACCEPT;
        else
            return FilterReply.DENY;
    }
}
```

ç„¶åï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨è¿™ä¸ªMultipleLevelsFilterå°±å¯ä»¥äº†ï¼ˆå®Œæ•´çš„é…ç½®ä»£ç å‚è€ƒ[è¿™é‡Œ](https://github.com/JosephZhu1983/java-common-mistakes/blob/master/src/main/java/org/geekbang/time/commonmistakes/logging/duplicate/multiplelevelsfilter.xml)ï¼‰ï¼š

```
<filter class="org.geekbang.time.commonmistakes.logging.duplicate.MultipleLevelsFilter">
    <levels>INFO|WARN</levels>
</filter>
```

**é—®é¢˜2ï¼š**ç”Ÿäº§çº§é¡¹ç›®çš„æ–‡ä»¶æ—¥å¿—è‚¯å®šéœ€è¦æŒ‰æ—¶é—´å’Œæ—¥æœŸè¿›è¡Œåˆ†å‰²å’Œå½’æ¡£å¤„ç†ï¼Œä»¥é¿å…å•ä¸ªæ–‡ä»¶å¤ªå¤§ï¼ŒåŒæ—¶ä¿ç•™ä¸€å®šå¤©æ•°çš„å†å²æ—¥å¿—ï¼Œä½ çŸ¥é“å¦‚ä½•é…ç½®å—ï¼Ÿå¯ä»¥åœ¨[å®˜æ–¹æ–‡æ¡£](http://logback.qos.ch/manual/appenders.html#RollingFileAppender)æ‰¾åˆ°ç­”æ¡ˆã€‚

ç­”ï¼šå‚è€ƒé…ç½®å¦‚ä¸‹ï¼Œä½¿ç”¨SizeAndTimeBasedRollingPolicyæ¥å®ç°æŒ‰ç…§æ–‡ä»¶å¤§å°å’Œå†å²æ–‡ä»¶ä¿ç•™å¤©æ•°ï¼Œè¿›è¡Œæ–‡ä»¶åˆ†å‰²å’Œå½’æ¡£ï¼š

```
<rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
    <!--æ—¥å¿—æ–‡ä»¶ä¿ç•™å¤©æ•°-->
    <MaxHistory>30</MaxHistory>
    <!--æ—¥å¿—æ–‡ä»¶æœ€å¤§çš„å¤§å°-->
    <MaxFileSize>100MB</MaxFileSize>
    <!--æ—¥å¿—æ•´ä½“æœ€å¤§
     å¯é€‰çš„totalSizeCapå±æ€§æ§åˆ¶æ‰€æœ‰å½’æ¡£æ–‡ä»¶çš„æ€»å¤§å°ã€‚å½“è¶…è¿‡æ€»å¤§å°ä¸Šé™æ—¶ï¼Œå°†å¼‚æ­¥åˆ é™¤æœ€æ—§çš„å­˜æ¡£ã€‚
     totalSizeCapå±æ€§ä¹Ÿéœ€è¦è®¾ç½®maxHistoryå±æ€§ã€‚æ­¤å¤–ï¼Œâ€œæœ€å¤§å†å²â€é™åˆ¶æ€»æ˜¯é¦–å…ˆåº”ç”¨ï¼Œâ€œæ€»å¤§å°ä¸Šé™â€é™åˆ¶å…¶æ¬¡åº”ç”¨ã€‚
     -->
    <totalSizeCap>10GB</totalSizeCap>
</rollingPolicy>
```

### [14 | æ–‡ä»¶IOï¼šå®ç°é«˜æ•ˆæ­£ç¡®çš„æ–‡ä»¶è¯»å†™å¹¶éæ˜“äº‹](https://time.geekbang.org/column/article/223051)

**é—®é¢˜1ï¼š**Files.linesæ–¹æ³•è¿›è¡Œæµå¼å¤„ç†ï¼Œéœ€è¦ä½¿ç”¨try-with-resourcesè¿›è¡Œèµ„æºé‡Šæ”¾ã€‚é‚£ä¹ˆï¼Œä½¿ç”¨Filesç±»ä¸­å…¶ä»–è¿”å›StreamåŒ…è£…å¯¹è±¡çš„æ–¹æ³•è¿›è¡Œæµå¼å¤„ç†ï¼Œæ¯”å¦‚newDirectoryStreamæ–¹æ³•è¿”å›DirectoryStreamï¼Œlistã€walkå’Œfindæ–¹æ³•è¿”å›Streamï¼Œä¹ŸåŒæ ·æœ‰èµ„æºé‡Šæ”¾é—®é¢˜å—ï¼Ÿ

ç­”ï¼šä½¿ç”¨Filesç±»ä¸­å…¶ä»–è¿”å›StreamåŒ…è£…å¯¹è±¡çš„æ–¹æ³•è¿›è¡Œæµå¼å¤„ç†ï¼Œä¹ŸåŒæ ·ä¼šæœ‰èµ„æºé‡Šæ”¾é—®é¢˜ã€‚

å› ä¸ºï¼Œè¿™äº›æ¥å£éƒ½éœ€è¦ä½¿ç”¨try-with-resourcesæ¨¡å¼æ¥é‡Šæ”¾ã€‚æ­£å¦‚æ–‡ä¸­æ‰€è¯´ï¼Œå¦‚æœä¸æ˜¾å¼é‡Šæ”¾ï¼Œé‚£ä¹ˆå¯èƒ½å› ä¸ºåº•å±‚èµ„æºæ²¡æœ‰åŠæ—¶å…³é—­é€ æˆèµ„æºæ³„éœ²ã€‚

**é—®é¢˜2ï¼š**Javaçš„Fileç±»å’ŒFilesç±»æä¾›çš„æ–‡ä»¶å¤åˆ¶ã€é‡å‘½åã€åˆ é™¤ç­‰æ“ä½œï¼Œæ˜¯åŸå­æ€§çš„å—ï¼Ÿ

ç­”ï¼šJavaçš„Fileå’ŒFilesç±»çš„æ–‡ä»¶å¤åˆ¶ã€é‡å‘½åã€åˆ é™¤ç­‰æ“ä½œï¼Œéƒ½ä¸æ˜¯åŸå­æ€§çš„ã€‚åŸå› æ˜¯ï¼Œæ–‡ä»¶ç±»æ“ä½œåŸºæœ¬éƒ½æ˜¯è°ƒç”¨æ“ä½œç³»ç»Ÿæœ¬èº«çš„APIï¼Œä¸€èˆ¬æ¥è¯´è¿™äº›æ–‡ä»¶APIå¹¶ä¸åƒæ•°æ®åº“æœ‰äº‹åŠ¡æœºåˆ¶ï¼ˆä¹Ÿå¾ˆéš¾åŠåˆ°ï¼‰ï¼Œå³ä½¿æœ‰ä¹Ÿå¾ˆå¯èƒ½æœ‰å¹³å°å·®å¼‚æ€§ã€‚

æ¯”å¦‚ï¼ŒFile.renameToæ–¹æ³•çš„æ–‡æ¡£ä¸­æåˆ°ï¼š

> Many aspects of the behavior of this method are inherently platform-dependent: The rename operation might not be able to move a file from one filesystem to another, it might not be atomic, and it might not succeed if a file with the destination abstract pathname already exists. The return value should always be checked to make sure that the rename operation was successful.

åˆæ¯”å¦‚ï¼ŒFiles.copyæ–¹æ³•çš„æ–‡æ¡£ä¸­æåˆ°ï¼š

> Copying a file is not an atomic operation. If an IOException is thrown, then it is possible that the target file is incomplete or some of its file attributes have not been copied from the source file. When the REPLACE\_EXISTING option is specified and the target file exists, then the target file is replaced. The check for the existence of the file and the creation of the new file may not be atomic with respect to other file system activities.

### [15 | åºåˆ—åŒ–ï¼šä¸€æ¥ä¸€å›ä½ è¿˜æ˜¯åŸæ¥çš„ä½ å—ï¼Ÿ](https://time.geekbang.org/column/article/223111)

**é—®é¢˜1ï¼š**åœ¨è®¨è®ºRedisåºåˆ—åŒ–æ–¹å¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰äº†RedisTemplateï¼Œè®©Keyä½¿ç”¨Stringåºåˆ—åŒ–ã€è®©Valueä½¿ç”¨JSONåºåˆ—åŒ–ï¼Œä»è€Œä½¿Redisè·å¾—çš„Valueå¯ä»¥ç›´æ¥è½¬æ¢ä¸ºéœ€è¦çš„å¯¹è±¡ç±»å‹ã€‚é‚£ä¹ˆï¼Œä½¿ç”¨RedisTemplate&lt;String, Long&gt;èƒ½å¦å­˜å–Valueæ˜¯Longçš„æ•°æ®å‘¢ï¼Ÿè¿™å…¶ä¸­æœ‰ä»€ä¹ˆå‘å—ï¼Ÿ

ç­”ï¼šä½¿ç”¨RedisTemplate&lt;String, Long&gt;ï¼Œä¸ä¸€å®šèƒ½å­˜å–Valueæ˜¯Longçš„æ•°æ®ã€‚åœ¨IntegeråŒºé—´å†…è¿”å›çš„æ˜¯Integerï¼Œè¶…è¿‡è¿™ä¸ªåŒºé—´è¿”å›Longã€‚æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š

```
@GetMapping("wrong2")
public void wrong2() {
    String key = "testCounter";
    //æµ‹è¯•ä¸€ä¸‹è®¾ç½®åœ¨IntegerèŒƒå›´å†…çš„å€¼
    countRedisTemplate.opsForValue().set(key, 1L);
    log.info("{} {}", countRedisTemplate.opsForValue().get(key), countRedisTemplate.opsForValue().get(key) instanceof Long);
    Long l1 = getLongFromRedis(key);
    //æµ‹è¯•ä¸€ä¸‹è®¾ç½®è¶…è¿‡IntegerèŒƒå›´çš„å€¼
    countRedisTemplate.opsForValue().set(key, Integer.MAX_VALUE + 1L);
    log.info("{} {}", countRedisTemplate.opsForValue().get(key), countRedisTemplate.opsForValue().get(key) instanceof Long);
    //ä½¿ç”¨getLongFromRedisè½¬æ¢åçš„å€¼å¿…å®šæ˜¯Long
    Long l2 = getLongFromRedis(key);
    log.info("{} {}", l1, l2);
}

private Long getLongFromRedis(String key) {
    Object o = countRedisTemplate.opsForValue().get(key);
    if (o instanceof Integer) {
        return ((Integer) o).longValue();
    }
    if (o instanceof Long) {
        return (Long) o;
    }
    return null;
}
```

ä¼šå¾—åˆ°å¦‚ä¸‹è¾“å‡ºï¼š

```
1 false
2147483648 true
1 2147483648
```

å¯ä»¥çœ‹åˆ°ï¼Œå€¼è®¾ç½®1çš„æ—¶å€™ç±»å‹ä¸æ˜¯Longï¼Œè®¾ç½®2147483648çš„æ—¶å€™æ˜¯Longã€‚ä¹Ÿå°±æ˜¯ä½¿ç”¨RedisTemplate&lt;String, Long&gt;ä¸ä¸€å®šå°±ä»£è¡¨è·å–çš„åˆ°çš„Valueæ˜¯Longã€‚

æ‰€ä»¥ï¼Œè¿™è¾¹æˆ‘å†™äº†ä¸€ä¸ªgetLongFromRedisæ–¹æ³•æ¥åšè½¬æ¢é¿å…å‡ºé”™ï¼Œåˆ¤æ–­å½“å€¼æ˜¯Integerçš„æ—¶å€™è½¬æ¢ä¸ºLongã€‚

**é—®é¢˜2ï¼š**ä½ å¯ä»¥çœ‹ä¸€ä¸‹Jackson2ObjectMapperBuilderç±»æºç çš„å®ç°ï¼ˆæ³¨æ„configureæ–¹æ³•ï¼‰ï¼Œåˆ†æä¸€ä¸‹å…¶é™¤äº†å…³é—­FAIL\_ON\_UNKNOWN\_PROPERTIESå¤–ï¼Œè¿˜åšäº†ä»€ä¹ˆå—ï¼Ÿ

ç­”ï¼šé™¤äº†å…³é—­FAIL\_ON\_UNKNOWN\_PROPERTIESå¤–ï¼ŒJackson2ObjectMapperBuilderç±»æºç è¿˜ä¸»è¦åšäº†ä»¥ä¸‹ä¸¤æ–¹é¢çš„äº‹å„¿ã€‚

ç¬¬ä¸€ï¼Œè®¾ç½®Jacksonçš„ä¸€äº›é»˜è®¤å€¼ï¼Œæ¯”å¦‚ï¼š

- MapperFeature.DEFAULT\_VIEW\_INCLUSIONè®¾ç½®ä¸ºç¦ç”¨ï¼›
- DeserializationFeature.FAIL\_ON\_UNKNOWN\_PROPERTIESè®¾ç½®ä¸ºç¦ç”¨ã€‚

ç¬¬äºŒï¼Œè‡ªåŠ¨æ³¨å†Œclasspathä¸­å­˜åœ¨çš„ä¸€äº›jacksonæ¨¡å—ï¼Œæ¯”å¦‚ï¼š

- jackson-datatype-jdk8ï¼Œæ”¯æŒJDK8çš„ä¸€äº›ç±»å‹ï¼Œæ¯”å¦‚Optionalï¼›
- jackson-datatype-jsr310ï¼Œ æ”¯æŒJDK8çš„æ—¥æœŸæ—¶é—´ä¸€äº›ç±»å‹ã€‚
- jackson-datatype-jodaï¼Œæ”¯æŒJoda-Timeç±»å‹ã€‚
- jackson-module-kotlinï¼Œæ”¯æŒKotlinã€‚

### [16 | ç”¨å¥½Java 8çš„æ—¥æœŸæ—¶é—´ç±»ï¼Œå°‘è¸©ä¸€äº›â€œè€ä¸‰æ ·â€çš„å‘](https://time.geekbang.org/column/article/224240)

**é—®é¢˜1ï¼š**åœ¨è¿™ä¸€è®²ä¸­ï¼Œæˆ‘å¤šæ¬¡å¼ºè°ƒäº†Dateæ˜¯ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œæ˜¯UTCæ—¶é—´ã€æ²¡æœ‰æ—¶åŒºæ¦‚å¿µã€‚é‚£ï¼Œä¸ºä»€ä¹ˆè°ƒç”¨å…¶toStringæ–¹æ³•ï¼Œä¼šè¾“å‡ºç±»ä¼¼CSTä¹‹ç±»çš„æ—¶åŒºå­—æ ·å‘¢ï¼Ÿ

ç­”ï¼šå…³äºè¿™ä¸ªé—®é¢˜ï¼Œå‚è€ƒtoStringä¸­çš„ç›¸å…³æºç ï¼Œä½ å¯ä»¥çœ‹åˆ°ä¼šè·å–å½“å‰æ—¶åŒºï¼ˆå–ä¸åˆ°åˆ™æ˜¾ç¤ºGMTï¼‰è¿›è¡Œæ ¼å¼åŒ–ï¼š

```
public String toString() {
    BaseCalendar.Date date = normalize();
    ...
    TimeZone zi = date.getZone();
    if (zi != null) {
        sb.append(zi.getDisplayName(date.isDaylightTime(), TimeZone.SHORT, Locale.US)); // zzz
    } else {
        sb.append("GMT");
    }
    sb.append(' ').append(date.getYear());  // yyyy
    return sb.toString();
}

private final BaseCalendar.Date normalize() {
    if (cdate == null) {
        BaseCalendar cal = getCalendarSystem(fastTime);
        cdate = (BaseCalendar.Date) cal.getCalendarDate(fastTime,
                                                        TimeZone.getDefaultRef());
        return cdate;
    }
    // Normalize cdate with the TimeZone in cdate first. This is
    // required for the compatible behavior.
    if (!cdate.isNormalized()) {
        cdate = normalize(cdate);
    }
    // If the default TimeZone has changed, then recalculate the
    // fields with the new TimeZone.
    TimeZone tz = TimeZone.getDefaultRef();
    if (tz != cdate.getZone()) {
        cdate.setZone(tz);
        CalendarSystem cal = getCalendarSystem(cdate);
        cal.getCalendarDate(fastTime, cdate);
    }
    return cdate;
}
```

å…¶å®è¯´ç™½äº†ï¼Œè¿™é‡Œæ˜¾ç¤ºçš„æ—¶åŒºä»…ä»…ç”¨äºå‘ˆç°ï¼Œå¹¶ä¸ä»£è¡¨Dateç±»å†…ç½®äº†æ—¶åŒºä¿¡æ¯ã€‚

**é—®é¢˜2ï¼š**æ—¥æœŸæ—¶é—´æ•°æ®å§‹ç»ˆè¦ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼ŒMySQLä¸­æœ‰ä¸¤ç§æ•°æ®ç±»å‹datetimeå’Œtimestampå¯ä»¥ç”¨æ¥ä¿å­˜æ—¥æœŸæ—¶é—´ã€‚ä½ èƒ½è¯´è¯´å®ƒä»¬çš„åŒºåˆ«å—ï¼Œå®ƒä»¬æ˜¯å¦åŒ…å«æ—¶åŒºä¿¡æ¯å‘¢ï¼Ÿ

ç­”ï¼šdatetimeå’Œtimestampçš„åŒºåˆ«ï¼Œä¸»è¦ä½“ç°åœ¨å ç”¨ç©ºé—´ã€è¡¨ç¤ºçš„æ—¶é—´èŒƒå›´å’Œæ—¶åŒºä¸‰ä¸ªæ–¹é¢ã€‚

- å ç”¨ç©ºé—´ï¼šdatetimeå ç”¨8å­—èŠ‚ï¼›timestampå ç”¨4å­—èŠ‚ã€‚
- è¡¨ç¤ºçš„æ—¶é—´èŒƒå›´ï¼šdatetimeè¡¨ç¤ºçš„èŒƒå›´æ˜¯ä»â€œ1000-01-01 00:00:00.000000â€åˆ°â€œ9999-12-31 23:59:59.999999â€ï¼›timestampè¡¨ç¤ºçš„èŒƒå›´æ˜¯ä»â€œ1970-01-01 00:00:01.000000â€åˆ°â€œ2038-01-19 03:14:07.999999â€ã€‚
- æ—¶åŒºï¼štimestampä¿å­˜çš„æ—¶å€™æ ¹æ®å½“å‰æ—¶åŒºè½¬æ¢ä¸ºUTCï¼ŒæŸ¥è¯¢çš„æ—¶å€™å†æ ¹æ®å½“å‰æ—¶åŒºä»UTCè½¬å›æ¥ï¼›è€Œdatetimeå°±æ˜¯ä¸€ä¸ªæ­»çš„å­—ç¬¦ä¸²æ—¶é—´ï¼ˆä»…ä»…å¯¹MySQLæœ¬èº«è€Œè¨€ï¼‰è¡¨ç¤ºã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬è¯´datetimeä¸åŒ…å«æ—¶åŒºæ˜¯å›ºå®šçš„æ—¶é—´è¡¨ç¤ºï¼Œä»…ä»…æ˜¯æŒ‡MySQLæœ¬èº«ã€‚ä½¿ç”¨timestampï¼Œéœ€è¦è€ƒè™‘Javaè¿›ç¨‹çš„æ—¶åŒºå’ŒMySQLè¿æ¥çš„æ—¶åŒºã€‚è€Œä½¿ç”¨datetimeç±»å‹ï¼Œåˆ™åªéœ€è¦è€ƒè™‘Javaè¿›ç¨‹çš„æ—¶åŒºï¼ˆå› ä¸ºMySQL datetimeæ²¡æœ‰æ—¶åŒºä¿¡æ¯äº†ï¼ŒJDBCæ—¶é—´æˆ³è½¬æ¢æˆMySQL datetimeï¼Œä¼šæ ¹æ®MySQLçš„serverTimezoneåšä¸€æ¬¡è½¬æ¢ï¼‰ã€‚

å¦‚æœä½ çš„é¡¹ç›®æœ‰å›½é™…åŒ–éœ€æ±‚ï¼Œæˆ‘æ¨èä½¿ç”¨æ—¶é—´æˆ³ï¼Œå¹¶ä¸”è¦ç¡®ä¿ä½ çš„åº”ç”¨æœåŠ¡å™¨å’Œæ•°æ®åº“æœåŠ¡å™¨è®¾ç½®äº†æ­£ç¡®çš„åŒ¹é…å½“åœ°æ—¶åŒºçš„æ—¶åŒºé…ç½®ã€‚

å…¶å®ï¼Œå³ä¾¿ä½ çš„é¡¹ç›®æ²¡æœ‰å›½é™…åŒ–éœ€æ±‚ï¼Œè‡³å°‘æ˜¯åº”ç”¨æœåŠ¡å™¨å’Œæ•°æ®åº“æœåŠ¡å™¨è®¾ç½®ä¸€è‡´çš„æ—¶åŒºï¼Œä¹Ÿæ˜¯éœ€è¦çš„ã€‚

### [17 | åˆ«ä»¥ä¸ºâ€œè‡ªåŠ¨æŒ¡â€å°±ä¸å¯èƒ½å‡ºç°OOM](https://time.geekbang.org/column/article/224784)

**é—®é¢˜1ï¼š**Springçš„ConcurrentReferenceHashMapï¼Œé’ˆå¯¹Keyå’ŒValueæ”¯æŒè½¯å¼•ç”¨å’Œå¼±å¼•ç”¨ä¸¤ç§æ–¹å¼ã€‚ä½ è§‰å¾—å“ªç§æ–¹å¼æ›´é€‚åˆåšç¼“å­˜å‘¢ï¼Ÿ

ç­”ï¼šè½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„åŒºåˆ«åœ¨äºï¼šè‹¥ä¸€ä¸ªå¯¹è±¡æ˜¯å¼±å¼•ç”¨å¯è¾¾ï¼Œæ— è®ºå½“å‰å†…å­˜æ˜¯å¦å……è¶³å®ƒéƒ½ä¼šè¢«å›æ”¶ï¼Œè€Œè½¯å¼•ç”¨å¯è¾¾çš„å¯¹è±¡åœ¨å†…å­˜ä¸å……è¶³æ—¶æ‰ä¼šè¢«å›æ”¶ã€‚å› æ­¤ï¼Œè½¯å¼•ç”¨è¦æ¯”å¼±å¼•ç”¨â€œå¼ºâ€ä¸€äº›ã€‚

é‚£ä¹ˆï¼Œä½¿ç”¨å¼±å¼•ç”¨ä½œä¸ºç¼“å­˜å°±ä¼šè®©ç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸè¿‡çŸ­ï¼Œæ‰€ä»¥è½¯å¼•ç”¨æ›´é€‚åˆä½œä¸ºç¼“å­˜ã€‚

**é—®é¢˜2ï¼š**å½“æˆ‘ä»¬éœ€è¦åŠ¨æ€æ‰§è¡Œä¸€äº›è¡¨è¾¾å¼æ—¶ï¼Œå¯ä»¥ä½¿ç”¨GroovyåŠ¨æ€è¯­è¨€å®ç°ï¼šnewå‡ºä¸€ä¸ªGroovyShellç±»ï¼Œç„¶åè°ƒç”¨evaluateæ–¹æ³•åŠ¨æ€æ‰§è¡Œè„šæœ¬ã€‚è¿™ç§æ–¹å¼çš„é—®é¢˜æ˜¯ï¼Œä¼šé‡å¤äº§ç”Ÿå¤§é‡çš„ç±»ï¼Œå¢åŠ MetaspaceåŒºçš„GCè´Ÿæ‹…ï¼Œæœ‰å¯èƒ½ä¼šå¼•èµ·OOMã€‚ä½ çŸ¥é“å¦‚ä½•é¿å…è¿™ä¸ªé—®é¢˜å—ï¼Ÿ

ç­”ï¼šè°ƒç”¨evaluateæ–¹æ³•åŠ¨æ€æ‰§è¡Œè„šæœ¬ä¼šäº§ç”Ÿå¤§é‡çš„ç±»ï¼Œè¦é¿å…å¯èƒ½å› æ­¤å¯¼è‡´çš„OOMé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè„šæœ¬åŒ…è£…ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå…ˆè°ƒç”¨parseå‡½æ•°æ¥å¾—åˆ°Scriptå¯¹è±¡ï¼Œç„¶åç¼“å­˜èµ·æ¥ï¼Œä»¥åç›´æ¥ä½¿ç”¨invokeMethodæ–¹æ³•è°ƒç”¨è¿™ä¸ªå‡½æ•°å³å¯ï¼š

```
private Object rightGroovy(String script, String method, Object... args) {
    Script scriptObject;
 
    if (SCRIPT_CACHE.containsKey(script)) {
        //å¦‚æœè„šæœ¬å·²ç»ç”Ÿæˆè¿‡Scriptåˆ™ç›´æ¥ä½¿ç”¨
        scriptObject = SCRIPT_CACHE.get(script);
    } else {
        //å¦åˆ™æŠŠè„šæœ¬è§£æä¸ºScript
        scriptObject = shell.parse(script);
        SCRIPT_CACHE.put(script, scriptObject);
    }
    return scriptObject.invokeMethod(method, args);
}
```

æˆ‘åœ¨æºç ä¸­æä¾›äº†ä¸€ä¸ª[æµ‹è¯•ç¨‹åº](https://github.com/JosephZhu1983/java-common-mistakes/blob/master/src/main/java/org/geekbang/time/commonmistakes/oom/groovyoom/GroovyOOMController.java)ï¼Œä½ å¯ä»¥ç›´æ¥å»çœ‹ä¸€ä¸‹ã€‚

### [18 | å½“åå°„ã€æ³¨è§£å’Œæ³›å‹é‡åˆ°OOPæ—¶ï¼Œä¼šæœ‰å“ªäº›å‘ï¼Ÿ](https://time.geekbang.org/column/article/225596)

**é—®é¢˜1ï¼š**æ³›å‹ç±»å‹æ“¦é™¤åä¼šç”Ÿæˆä¸€ä¸ªbridgeæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åŒæ—¶åˆæ˜¯syntheticæ–¹æ³•ã€‚é™¤äº†æ³›å‹ç±»å‹æ“¦é™¤ï¼Œä½ çŸ¥é“è¿˜æœ‰ä»€ä¹ˆæƒ…å†µç¼–è¯‘å™¨ä¼šç”Ÿæˆsyntheticæ–¹æ³•å—ï¼Ÿ

ç­”ï¼šSyntheticæ–¹æ³•æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„æ–¹æ³•ï¼ˆåœ¨æºç ä¸­ä¸å‡ºç°ï¼‰ã€‚é™¤äº†æ–‡ä¸­æåˆ°çš„æ³›å‹ç±»å‹æ“¦é™¤å¤–ï¼ŒSyntheticæ–¹æ³•è¿˜å¯èƒ½å‡ºç°çš„ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„åœºæ™¯ï¼Œæ˜¯å†…éƒ¨ç±»å’Œé¡¶å±‚ç±»éœ€è¦ç›¸äº’è®¿é—®å¯¹æ–¹çš„privateå­—æ®µæˆ–æ–¹æ³•çš„æ—¶å€™ã€‚

ç¼–è¯‘åçš„å†…éƒ¨ç±»å’Œæ™®é€šç±»æ²¡æœ‰åŒºåˆ«ï¼Œéµå¾ªprivateå­—æ®µæˆ–æ–¹æ³•å¯¹å¤–éƒ¨ç±»ä¸å¯è§çš„åŸåˆ™ï¼Œä½†è¯­æ³•ä¸Šå†…éƒ¨ç±»å’Œé¡¶å±‚ç±»çš„ç§æœ‰å­—æ®µéœ€è¦å¯ä»¥ç›¸äº’è®¿é—®ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªçŸ›ç›¾ï¼Œç¼–è¯‘å™¨å°±åªèƒ½ç”Ÿæˆæ¡¥æ¥æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯Syntheticæ–¹æ³•ï¼Œæ¥æŠŠprivateæˆå‘˜è½¬æ¢ä¸ºpackageçº§åˆ«çš„è®¿é—®é™åˆ¶ã€‚

æ¯”å¦‚å¦‚ä¸‹ä»£ç ï¼ŒInnerClassApplicationç±»çš„testæ–¹æ³•éœ€è¦è®¿é—®å†…éƒ¨ç±»MyInnerClassç±»çš„ç§æœ‰å­—æ®µnameï¼Œè€Œå†…éƒ¨ç±»MyInnerClassç±»çš„testæ–¹æ³•éœ€è¦è®¿é—®å¤–éƒ¨ç±»InnerClassApplicationç±»çš„ç§æœ‰å­—æ®µgenderã€‚

```
public class InnerClassApplication {

    private String gender = "male";
    public static void main(String[] args) throws Exception {
        InnerClassApplication application = new InnerClassApplication();
        application.test();
    }

    private void test(){
        MyInnerClass myInnerClass = new MyInnerClass();
        System.out.println(myInnerClass.name);
        myInnerClass.test();
    }

    class MyInnerClass {
        private String name = "zhuye";
        void test(){
            System.out.println(gender);
        }
    }
}
```

ç¼–è¯‘å™¨ä¼šä¸ºInnerClassApplicationå’ŒMyInnerClasséƒ½ç”Ÿæˆæ¡¥æ¥æ–¹æ³•ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒInnerClassApplicationçš„testæ–¹æ³•ï¼Œå…¶å®è°ƒç”¨çš„æ˜¯å†…éƒ¨ç±»çš„access$000é™æ€æ–¹æ³•ï¼š

![](https://static001.geekbang.org/resource/image/93/66/93a0fd1feb705be9fd63c3b963943c66.png?wh=2654%2A964)

è¿™ä¸ªaccess$000æ–¹æ³•æ˜¯Syntheticæ–¹æ³•ï¼š

![](https://static001.geekbang.org/resource/image/2a/f0/2aa967cfbd7832d0893605c4249363f0.png?wh=2674%2A602)

è€ŒSyntheticæ–¹æ³•çš„å®ç°è½¬æ¥è°ƒç”¨äº†å†…éƒ¨ç±»çš„nameå­—æ®µï¼š

![](https://static001.geekbang.org/resource/image/06/3d/064809b7fba7dc34f5c955a1a7dbf33d.png?wh=2674%2A608)

åè¿‡æ¥ï¼Œå†…éƒ¨ç±»çš„testæ–¹æ³•ä¹Ÿæ˜¯é€šè¿‡å¤–éƒ¨ç±»InnerClassApplicationç±»çš„æ¡¥æ¥æ–¹æ³•access$100è°ƒç”¨åˆ°å…¶ç§æœ‰å­—æ®µï¼š

![](https://static001.geekbang.org/resource/image/eb/9e/ebefeeda2de626ca8cbdf5388763669e.png?wh=2504%2A720)

**é—®é¢˜2ï¼š**å…³äºæ³¨è§£ç»§æ‰¿é—®é¢˜ï¼Œä½ è§‰å¾—Springçš„å¸¸ç”¨æ³¨è§£@Serviceã€@Controlleræ˜¯å¦æ”¯æŒç»§æ‰¿å‘¢ï¼Ÿ

ç­”ï¼šSpringçš„å¸¸ç”¨æ³¨è§£@Serviceã€@Controllerï¼Œä¸æ”¯æŒç»§æ‰¿ã€‚è¿™äº›æ³¨è§£åªæ”¯æŒæ”¾åˆ°å…·ä½“çš„ï¼ˆéæ¥å£éæŠ½è±¡ï¼‰é¡¶å±‚ç±»ä¸Šï¼ˆæ¥è®©å®ƒä»¬æˆä¸ºBeanï¼‰ï¼Œå¦‚æœæ”¯æŒç»§æ‰¿ä¼šéå¸¸ä¸çµæ´»è€Œä¸”å®¹æ˜“å‡ºé”™ã€‚

### [19 | Springæ¡†æ¶ï¼šIoCå’ŒAOPæ˜¯æ‰©å±•çš„æ ¸å¿ƒ](https://time.geekbang.org/column/article/227917)

**é—®é¢˜1ï¼š**é™¤äº†é€šè¿‡@Autowiredæ³¨å…¥Beanå¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨@Injectæˆ–@Resourceæ¥æ³¨å…¥Beanã€‚ä½ çŸ¥é“è¿™ä¸‰ç§æ–¹å¼çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå—ï¼Ÿ

ç­”ï¼šæˆ‘ä»¬å…ˆè¯´ä¸€ä¸‹ä½¿ç”¨@Autowiredã€@Injectå’Œ@Resourceè¿™ä¸‰ç§æ³¨è§£æ³¨å…¥Beançš„æ–¹å¼ï¼š

- @Autowiredï¼Œæ˜¯Springçš„æ³¨è§£ï¼Œä¼˜å…ˆæŒ‰ç…§ç±»å‹æ³¨å…¥ã€‚å½“æ— æ³•ç¡®å®šå…·ä½“æ³¨å…¥ç±»å‹çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡@Qualifieræ³¨è§£æŒ‡å®šBeanåç§°ã€‚
- @Injectï¼šæ˜¯JSR330è§„èŒƒçš„å®ç°ï¼Œä¹Ÿæ˜¯æ ¹æ®ç±»å‹è¿›è¡Œè‡ªåŠ¨è£…é…çš„ï¼Œè¿™ä¸€ç‚¹å’Œ@Autowiredç±»ä¼¼ã€‚å¦‚æœéœ€è¦æŒ‰åç§°è¿›è¡Œè£…é…ï¼Œåˆ™éœ€è¦é…åˆä½¿ç”¨@Namedã€‚@Autowiredå’Œ@Injectçš„åŒºåˆ«åœ¨äºï¼Œå‰è€…å¯ä»¥ä½¿ç”¨required=falseå…è®¸æ³¨å…¥nullï¼Œåè€…å…è®¸æ³¨å…¥ä¸€ä¸ªProviderå®ç°å»¶è¿Ÿæ³¨å…¥ã€‚
- @Resourceï¼šJSR250è§„èŒƒçš„å®ç°ï¼Œå¦‚æœä¸æŒ‡å®šnameä¼˜å…ˆæ ¹æ®åç§°è¿›è¡ŒåŒ¹é…ï¼ˆç„¶åæ‰æ˜¯ç±»å‹ï¼‰ï¼Œå¦‚æœæŒ‡å®šnameåˆ™ä»…æ ¹æ®åç§°åŒ¹é…ã€‚

**é—®é¢˜2ï¼š**å½“Beanäº§ç”Ÿå¾ªç¯ä¾èµ–æ—¶ï¼Œæ¯”å¦‚BeanAçš„æ„é€ æ–¹æ³•ä¾èµ–BeanBä½œä¸ºæˆå‘˜éœ€è¦æ³¨å…¥ï¼ŒBeanBä¹Ÿä¾èµ–BeanAï¼Œä½ è§‰å¾—ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿåˆæœ‰å“ªäº›è§£å†³æ–¹å¼å‘¢ï¼Ÿ

ç­”ï¼šBeanäº§ç”Ÿå¾ªç¯ä¾èµ–ï¼Œä¸»è¦åŒ…æ‹¬ä¸¤ç§æƒ…å†µï¼šä¸€ç§æ˜¯æ³¨å…¥å±æ€§æˆ–å­—æ®µæ¶‰åŠå¾ªç¯ä¾èµ–ï¼Œå¦ä¸€ç§æ˜¯æ„é€ æ–¹æ³•æ³¨å…¥æ¶‰åŠå¾ªç¯ä¾èµ–ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘åˆ†åˆ«å’Œä½ è®²ä¸€è®²ã€‚

ç¬¬ä¸€ç§ï¼Œæ³¨å…¥å±æ€§æˆ–å­—æ®µæ¶‰åŠå¾ªç¯ä¾èµ–ï¼Œæ¯”å¦‚TestAå’ŒTestBç›¸äº’ä¾èµ–ï¼š

```
@Component
public class TestA {
    @Autowired
    @Getter
    private TestB testB;
}

@Component
public class TestB {
    @Autowired
    @Getter
    private TestA testA;
}
```

é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼ŒSpringå†…éƒ¨é€šè¿‡ä¸‰ä¸ªMapçš„æ–¹å¼è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä¸ä¼šå‡ºé”™ã€‚åŸºæœ¬åŸç†æ˜¯ï¼Œå› ä¸ºå¾ªç¯ä¾èµ–ï¼Œæ‰€ä»¥å®ä¾‹çš„åˆå§‹åŒ–æ— æ³•ä¸€æ¬¡åˆ°ä½ï¼Œéœ€è¦åˆ†æ­¥è¿›è¡Œï¼š

1. åˆ›å»ºAï¼ˆä»…ä»…å®ä¾‹åŒ–ï¼Œä¸æ³¨å…¥ä¾èµ–ï¼‰ï¼›
2. åˆ›å»ºBï¼ˆä»…ä»…å®ä¾‹åŒ–ï¼Œä¸æ³¨å…¥ä¾èµ–ï¼‰ï¼›
3. ä¸ºBæ³¨å…¥Aï¼ˆæ­¤æ—¶Bå·²å¥å…¨ï¼‰ï¼›
4. ä¸ºAæ³¨å…¥Bï¼ˆæ­¤æ—¶Aä¹Ÿå¥å…¨ï¼‰ã€‚

ç½‘ä¸Šæœ‰å¾ˆå¤šç›¸å…³çš„åˆ†æï¼Œæˆ‘æ‰¾äº†[ä¸€ç¯‡æ¯”è¾ƒè¯¦ç»†çš„](https://cloud.tencent.com/developer/article/1497692)ï¼Œå¯ä¾›ä½ å‚è€ƒã€‚

ç¬¬äºŒç§ï¼Œæ„é€ æ–¹æ³•æ³¨å…¥æ¶‰åŠå¾ªç¯ä¾èµ–ã€‚é‡åˆ°è¿™ç§æƒ…å†µçš„è¯ï¼Œç¨‹åºæ— æ³•å¯åŠ¨ï¼Œæ¯”å¦‚TestCå’ŒTestDçš„ç›¸äº’ä¾èµ–ï¼š

```
@Component
public class TestC {
    @Getter
    private TestD testD;

    @Autowired
    public TestC(TestD testD) {
        this.testD = testD;
    }
}

@Component
public class TestD {
    @Getter
    private TestC testC;

    @Autowired
    public TestD(TestC testC) {
        this.testC = testC;
    }
}
```

è¿™ç§å¾ªç¯ä¾èµ–çš„ä¸»è¦è§£å†³æ–¹å¼ï¼Œæœ‰2ç§ï¼š

- æ”¹ä¸ºå±æ€§æˆ–å­—æ®µæ³¨å…¥ï¼›
- ä½¿ç”¨@Lazyå»¶è¿Ÿæ³¨å…¥ã€‚æ¯”å¦‚å¦‚ä¸‹ä»£ç ï¼š

```
@Component
public class TestC {
    @Getter
    private TestD testD;

    @Autowired
    public TestC(@Lazy TestD testD) {
        this.testD = testD;
    }
}
```

å…¶å®ï¼Œè¿™ç§@Lazyæ–¹å¼æ³¨å…¥çš„å°±ä¸æ˜¯å®é™…çš„ç±»å‹äº†ï¼Œè€Œæ˜¯ä»£ç†ç±»ï¼Œè·å–çš„æ—¶å€™é€šè¿‡ä»£ç†å»æ‹¿å€¼ï¼ˆå®ä¾‹åŒ–ï¼‰ã€‚æ‰€ä»¥ï¼Œå®ƒå¯ä»¥è§£å†³å¾ªç¯ä¾èµ–æ— æ³•å®ä¾‹åŒ–çš„é—®é¢˜ã€‚

### [20 | Springæ¡†æ¶ï¼šæ¡†æ¶å¸®æˆ‘ä»¬åšäº†å¾ˆå¤šå·¥ä½œä¹Ÿå¸¦æ¥äº†å¤æ‚åº¦](https://time.geekbang.org/column/article/227918)

**é—®é¢˜1ï¼š**é™¤äº†Springæ¡†æ¶è¿™ä¸¤è®²æ¶‰åŠçš„executionã€withinã€@withinã€@annotation å››ä¸ªæŒ‡ç¤ºå™¨å¤–ï¼ŒSpring AOP è¿˜æ”¯æŒ thisã€targetã€argsã€@targetã€@argsã€‚ä½ èƒ½è¯´è¯´åé¢äº”ç§æŒ‡ç¤ºå™¨çš„ä½œç”¨å—ï¼Ÿ

ç­”ï¼šå…³äºè¿™äº›æŒ‡ç¤ºå™¨çš„ä½œç”¨ï¼Œä½ å¯ä»¥å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop-pointcuts-designators)ï¼Œæ–‡æ¡£é‡Œå·²ç»å†™çš„å¾ˆæ¸…æ™°ã€‚

æ€»ç»“ä¸€ä¸‹ï¼ŒæŒ‰ç…§ä½¿ç”¨åœºæ™¯ï¼Œå»ºè®®ä½¿ç”¨ä¸‹é¢è¿™äº›æŒ‡ç¤ºå™¨ï¼š

- é’ˆå¯¹æ–¹æ³•ç­¾åï¼Œä½¿ç”¨executionï¼›
- é’ˆå¯¹ç±»å‹åŒ¹é…ï¼Œä½¿ç”¨withinï¼ˆåŒ¹é…ç±»å‹ï¼‰ã€thisï¼ˆåŒ¹é…ä»£ç†ç±»å®ä¾‹ï¼‰ã€targetï¼ˆåŒ¹é…ä»£ç†èƒŒåçš„ç›®æ ‡ç±»å®ä¾‹ï¼‰ã€argsï¼ˆåŒ¹é…å‚æ•°ï¼‰ï¼›
- é’ˆå¯¹æ³¨è§£åŒ¹é…ï¼Œä½¿ç”¨@annotationï¼ˆä½¿ç”¨æŒ‡å®šæ³¨è§£æ ‡æ³¨çš„æ–¹æ³•ï¼‰ã€@targetï¼ˆä½¿ç”¨æŒ‡å®šæ³¨è§£æ ‡æ³¨çš„ç±»ï¼‰ã€@argsï¼ˆä½¿ç”¨æŒ‡å®šæ³¨è§£æ ‡æ³¨çš„ç±»ä½œä¸ºæŸä¸ªæ–¹æ³•çš„å‚æ•°ï¼‰ã€‚

ä½ å¯èƒ½ä¼šé—®ï¼Œ@withinæ€ä¹ˆæ²¡æœ‰å‘¢ï¼Ÿ

å…¶å®ï¼Œå¯¹äºSpringé»˜è®¤çš„åŸºäºåŠ¨æ€ä»£ç†æˆ–CGLIBçš„AOPï¼Œå› ä¸ºåˆ‡ç‚¹åªèƒ½æ˜¯æ–¹æ³•ï¼Œä½¿ç”¨@withinå’Œ@targetæŒ‡ç¤ºå™¨å¹¶æ— åŒºåˆ«ï¼›ä½†éœ€è¦æ³¨æ„å¦‚æœåˆ‡æ¢åˆ°AspectJï¼Œé‚£ä¹ˆä½¿ç”¨@withinå’Œ@targetè¿™ä¸¤ä¸ªæŒ‡ç¤ºå™¨çš„è¡Œä¸ºå°±ä¼šæœ‰æ‰€åŒºåˆ«äº†ï¼Œ@withinä¼šåˆ‡å…¥æ›´å¤šçš„æˆå‘˜çš„è®¿é—®ï¼ˆæ¯”å¦‚é™æ€æ„é€ æ–¹æ³•ã€å­—æ®µè®¿é—®ï¼‰ï¼Œä¸€èˆ¬è€Œè¨€ä½¿ç”¨@targetæŒ‡ç¤ºå™¨å³å¯ã€‚

**é—®é¢˜2ï¼š**Spring çš„ Environment ä¸­çš„ PropertySources å±æ€§å¯ä»¥åŒ…å«å¤šä¸ª PropertySourceï¼Œè¶Šå¾€å‰ä¼˜å…ˆçº§è¶Šé«˜ã€‚é‚£ï¼Œæˆ‘ä»¬èƒ½å¦åˆ©ç”¨è¿™ä¸ªç‰¹ç‚¹å®ç°é…ç½®æ–‡ä»¶ä¸­å±æ€§å€¼çš„è‡ªåŠ¨èµ‹å€¼å‘¢ï¼Ÿæ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ %%MYSQL.URL%%ã€%%MYSQL.USERNAME%% å’Œ %%MYSQL.PASSWORD%%ï¼Œåˆ†åˆ«ä»£è¡¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€ç”¨æˆ·åå’Œå¯†ç ã€‚åœ¨é…ç½®æ•°æ®æºæ—¶ï¼Œæˆ‘ä»¬åªè¦è®¾ç½®å…¶å€¼ä¸ºå ä½ç¬¦ï¼Œæ¡†æ¶å°±å¯ä»¥è‡ªåŠ¨æ ¹æ®å½“å‰åº”ç”¨ç¨‹åºå application.nameï¼Œç»Ÿä¸€æŠŠå ä½ç¬¦æ›¿æ¢ä¸ºçœŸå®çš„æ•°æ®åº“ä¿¡æ¯ã€‚è¿™æ ·ï¼Œç”Ÿäº§çš„æ•°æ®åº“ä¿¡æ¯å°±ä¸éœ€è¦æ”¾åœ¨é…ç½®æ–‡ä»¶ä¸­äº†ï¼Œä¼šæ›´å®‰å…¨ã€‚

ç­”ï¼šæˆ‘ä»¬åˆ©ç”¨PropertySourceå…·æœ‰ä¼˜å…ˆçº§çš„ç‰¹ç‚¹ï¼Œå®ç°é…ç½®æ–‡ä»¶ä¸­å±æ€§å€¼çš„è‡ªåŠ¨èµ‹å€¼ã€‚ä¸»è¦é€»è¾‘æ˜¯ï¼Œéå†ç°åœ¨çš„å±æ€§å€¼ï¼Œæ‰¾å‡ºèƒ½åŒ¹é…åˆ°å ä½ç¬¦çš„å±æ€§ï¼Œå¹¶æŠŠè¿™äº›å±æ€§çš„å€¼æ›¿æ¢ä¸ºå®é™…çš„æ•°æ®åº“ä¿¡æ¯ï¼Œç„¶åå†æŠŠè¿™äº›æ›¿æ¢åçš„å±æ€§å€¼æ„æˆæ–°çš„PropertiesPropertySourceï¼ŒåŠ å…¥PropertySourcesçš„ç¬¬ä¸€ä¸ªã€‚è¿™æ ·ï¼Œæˆ‘ä»¬è¿™ä¸ªPropertiesPropertySourceä¸­çš„å€¼å°±å¯ä»¥ç”Ÿæ•ˆäº†ã€‚

ä¸»è¦æºç å¦‚ä¸‹ï¼š

```
public static void main(String[] args) {
    Utils.loadPropertySource(CommonMistakesApplication.class, "db.properties");
    new SpringApplicationBuilder()
            .sources(CommonMistakesApplication.class)
            .initializers(context -> initDbUrl(context.getEnvironment()))
            .run(args);
}
private static final String MYSQL_URL_PLACEHOLDER = "%%MYSQL.URL%%";
private static final String MYSQL_USERNAME_PLACEHOLDER = "%%MYSQL.USERNAME%%";
private static final String MYSQL_PASSWORD_PLACEHOLDER = "%%MYSQL.PASSWORD%%";
private static void initDbUrl(ConfigurableEnvironment env) {

    String dataSourceUrl = env.getProperty("spring.datasource.url");
    String username = env.getProperty("spring.datasource.username");
    String password = env.getProperty("spring.datasource.password");

    if (dataSourceUrl != null && !dataSourceUrl.contains(MYSQL_URL_PLACEHOLDER))
        throw new IllegalArgumentException("è¯·ä½¿ç”¨å ä½ç¬¦" + MYSQL_URL_PLACEHOLDER + "æ¥æ›¿æ¢æ•°æ®åº“URLé…ç½®ï¼");
    if (username != null && !username.contains(MYSQL_USERNAME_PLACEHOLDER))
        throw new IllegalArgumentException("è¯·ä½¿ç”¨å ä½ç¬¦" + MYSQL_USERNAME_PLACEHOLDER + "æ¥æ›¿æ¢æ•°æ®åº“è´¦å·é…ç½®ï¼");
    if (password != null && !password.contains(MYSQL_PASSWORD_PLACEHOLDER))
        throw new IllegalArgumentException("è¯·ä½¿ç”¨å ä½ç¬¦" + MYSQL_PASSWORD_PLACEHOLDER + "æ¥æ›¿æ¢æ•°æ®åº“å¯†ç é…ç½®ï¼");

    //è¿™é‡Œæˆ‘æŠŠå€¼å†™æ­»äº†ï¼Œå®é™…åº”ç”¨ä¸­å¯ä»¥ä»å¤–éƒ¨æœåŠ¡æ¥è·å–
    Map<String, String> property = new HashMap<>();
    property.put(MYSQL_URL_PLACEHOLDER, "jdbc:mysql://localhost:6657/common_mistakes?characterEncoding=UTF-8&useSSL=false");
    property.put(MYSQL_USERNAME_PLACEHOLDER, "root");
    property.put(MYSQL_PASSWORD_PLACEHOLDER, "kIo9u7Oi0eg");
    //ä¿å­˜ä¿®æ”¹åçš„é…ç½®å±æ€§
    Properties modifiedProps = new Properties();
    //éå†ç°åœ¨çš„å±æ€§å€¼ï¼Œæ‰¾å‡ºèƒ½åŒ¹é…åˆ°å ä½ç¬¦çš„å±æ€§ï¼Œå¹¶æŠŠè¿™äº›å±æ€§çš„å€¼æ›¿æ¢ä¸ºå®é™…çš„æ•°æ®åº“ä¿¡æ¯
    StreamSupport.stream(env.getPropertySources().spliterator(), false)
            .filter(ps -> ps instanceof EnumerablePropertySource)
            .map(ps -> ((EnumerablePropertySource) ps).getPropertyNames())
            .flatMap(Arrays::stream)
            .forEach(propKey -> {
                String propValue = env.getProperty(propKey);
                property.entrySet().forEach(item -> {
                    //å¦‚æœåŸå…ˆé…ç½®çš„å±æ€§å€¼åŒ…å«æˆ‘ä»¬å®šä¹‰çš„å ä½ç¬¦
                    if (propValue.contains(item.getKey())) {
                        //é‚£ä¹ˆå°±æŠŠå®é™…çš„é…ç½®ä¿¡æ¯åŠ å…¥modifiedProps
                        modifiedProps.put(propKey, propValue.replaceAll(item.getKey(), item.getValue()));
                    }
                });
            });

    if (!modifiedProps.isEmpty()) {
        log.info("modifiedProps: {}", modifiedProps);
        env.getPropertySources().addFirst(new PropertiesPropertySource("mysql", modifiedProps));
    }
}
```

æˆ‘åœ¨GitHubä¸Šç¬¬20è®²å¯¹åº”çš„æºç ä¸­æ›´æ–°äº†æˆ‘çš„å®ç°ï¼Œä½ å¯ä»¥ç‚¹å‡»[è¿™é‡Œ](https://github.com/JosephZhu1983/java-common-mistakes/blob/master/src/main/java/org/geekbang/time/commonmistakes/springpart2/custompropertysource/CommonMistakesApplication.java)æŸ¥çœ‹ã€‚æœ‰ä¸€äº›åŒå­¦ä¼šé—®ï¼Œè¿™ä¹ˆåšçš„æ„ä¹‰åˆ°åº•åœ¨äºä»€ä¹ˆï¼Œä¸ºä½•ä¸ç›´æ¥ä½¿ç”¨ç±»ä¼¼Apolloè¿™æ ·çš„é…ç½®æ¡†æ¶å‘¢ï¼Ÿ

å…¶å®ï¼Œæˆ‘ä»¬çš„ç›®çš„å°±æ˜¯ä¸å¸Œæœ›è®©å¼€å‘äººå‘˜æ‰‹åŠ¨é…ç½®æ•°æ®åº“ä¿¡æ¯ï¼Œå¸Œæœ›ç¨‹åºå¯åŠ¨çš„æ—¶å€™è‡ªåŠ¨æ›¿æ¢å ä½ç¬¦å®ç°è‡ªåŠ¨é…ç½®ï¼ˆä»CMDBç›´æ¥æ‹¿ç€åº”ç”¨ç¨‹åºIDæ¥æ¢å–å¯¹åº”çš„æ•°æ®åº“ä¿¡æ¯ã€‚ä½ å¯èƒ½ä¼šé—®äº†ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºIDå¯¹åº”å¤šä¸ªæ•°æ®åº“æ€ä¹ˆåŠï¼Ÿå…¶å®ï¼Œä¸€èˆ¬å¯¹äºå¾®æœåŠ¡ç³»ç»Ÿæ¥è¯´ï¼Œä¸€ä¸ªåº”ç”¨å°±åº”è¯¥å¯¹åº”ä¸€ä¸ªæ•°æ®åº“ï¼‰ã€‚è¿™æ ·ä¸€æ¥ï¼Œé™¤äº†ç¨‹åºå…¶ä»–äººéƒ½ä¸ä¼šæ¥è§¦åˆ°ç”Ÿäº§çš„æ•°æ®åº“ä¿¡æ¯ï¼Œä¼šæ›´å®‰å…¨ã€‚

ä»¥ä¸Šï¼Œå°±æ˜¯å’±ä»¬è¿™é—¨è¯¾çš„ç¬¬13~20è®²çš„æ€è€ƒé¢˜ç­”æ¡ˆäº†ã€‚

å…³äºè¿™äº›é¢˜ç›®ï¼Œä»¥åŠèƒŒåæ¶‰åŠçš„çŸ¥è¯†ç‚¹ï¼Œå¦‚æœä½ è¿˜æœ‰å“ªé‡Œæ„Ÿè§‰ä¸æ¸…æ¥šçš„ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºä¸æˆ‘ç•™è¨€ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ï¼Œä¸€èµ·äº¤æµã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ4ï¼‰</strong></div><ul>
<li><span>å°±æ˜¯è¿™æ ·</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ç‰¹åˆ«èµï¼Œå—ç›Šè‰¯å¤š</p>2020-07-24</li><br/><li><span>giteebravo</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>
åœ¨ä½¿ç”¨ @Autowired æ—¶ï¼Œä»€ä¹ˆæƒ…å†µä¸‹ä¼šä½¿ç”¨ required = false å…è®¸æ³¨å…¥ null å‘¢ï¼Ÿ</p>2021-07-09</li><br/><li><span>Ethan New</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>èµèµèµ</p>2023-01-15</li><br/><li><span>æå’Œæ¡ƒ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>èµ</p>2021-02-18</li><br/>
</ul>