ä½ å¥½ï¼Œæˆ‘æ˜¯æœ±æ™”ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬æ¥èŠèŠSpringæ¡†æ¶ä¸­çš„IoCå’ŒAOPï¼ŒåŠå…¶å®¹æ˜“å‡ºé”™çš„åœ°æ–¹ã€‚

ç†Ÿæ‚‰Javaçš„åŒå­¦éƒ½çŸ¥é“ï¼ŒSpringçš„å®¶æ—åºå¤§ï¼Œå¸¸ç”¨çš„æ¨¡å—å°±æœ‰Spring Dataã€Spring Securityã€Spring Bootã€Spring Cloudç­‰ã€‚å…¶å®å‘¢ï¼ŒSpringä½“ç³»è™½ç„¶åºå¤§ï¼Œä½†éƒ½æ˜¯å›´ç»•Spring Coreå±•å¼€çš„ï¼Œè€ŒSpring Coreä¸­æœ€æ ¸å¿ƒçš„å°±æ˜¯IoCï¼ˆæ§åˆ¶åè½¬ï¼‰å’ŒAOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰ã€‚

æ¦‚æ‹¬åœ°è¯´ï¼ŒIoCå’ŒAOPçš„åˆè¡·æ˜¯è§£è€¦å’Œæ‰©å±•ã€‚ç†è§£è¿™ä¸¤ä¸ªæ ¸å¿ƒæŠ€æœ¯ï¼Œå°±å¯ä»¥è®©ä½ çš„ä»£ç å˜å¾—æ›´çµæ´»ã€å¯éšæ—¶æ›¿æ¢ï¼Œä»¥åŠä¸šåŠ¡ç»„ä»¶é—´æ›´è§£è€¦ã€‚åœ¨æ¥ä¸‹æ¥çš„ä¸¤è®²ä¸­ï¼Œæˆ‘ä¼šä¸ä½ æ·±å…¥å‰–æå‡ ä¸ªæ¡ˆä¾‹ï¼Œå¸¦ä½ ç»•è¿‡ä¸šåŠ¡ä¸­é€šè¿‡Springå®ç°IoCå’ŒAOPç›¸å…³çš„å‘ã€‚

ä¸ºäº†ä¾¿äºç†è§£è¿™ä¸¤è®²ä¸­çš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å…ˆå›é¡¾ä¸‹IoCå’ŒAOPçš„åŸºç¡€çŸ¥è¯†ã€‚

IoCï¼Œå…¶å®å°±æ˜¯ä¸€ç§è®¾è®¡æ€æƒ³ã€‚ä½¿ç”¨Springæ¥å®ç°IoCï¼Œæ„å‘³ç€å°†ä½ è®¾è®¡å¥½çš„å¯¹è±¡äº¤ç»™Springå®¹å™¨æ§åˆ¶ï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨å¯¹è±¡å†…éƒ¨æ§åˆ¶ã€‚é‚£ï¼Œä¸ºä»€ä¹ˆè¦è®©å®¹å™¨æ¥ç®¡ç†å¯¹è±¡å‘¢ï¼Ÿæˆ–è®¸ä½ èƒ½æƒ³åˆ°çš„æ˜¯ï¼Œä½¿ç”¨IoCæ–¹ä¾¿ã€å¯ä»¥å®ç°è§£è€¦ã€‚ä½†åœ¨æˆ‘çœ‹æ¥ï¼Œç›¸æ¯”äºè¿™ä¸¤ä¸ªåŸå› ï¼Œæ›´é‡è¦çš„æ˜¯IoCå¸¦æ¥äº†æ›´å¤šçš„å¯èƒ½æ€§ã€‚

å¦‚æœä»¥å®¹å™¨ä¸ºä¾æ‰˜æ¥ç®¡ç†æ‰€æœ‰çš„æ¡†æ¶ã€ä¸šåŠ¡å¯¹è±¡ï¼Œæˆ‘ä»¬ä¸ä»…å¯ä»¥æ— ä¾µå…¥åœ°è°ƒæ•´å¯¹è±¡çš„å…³ç³»ï¼Œè¿˜å¯ä»¥æ— ä¾µå…¥åœ°éšæ—¶è°ƒæ•´å¯¹è±¡çš„å±æ€§ï¼Œç”šè‡³æ˜¯å®ç°å¯¹è±¡çš„æ›¿æ¢ã€‚è¿™å°±ä½¿å¾—æ¡†æ¶å¼€å‘è€…åœ¨ç¨‹åºèƒŒåå®ç°ä¸€äº›æ‰©å±•ä¸å†æ˜¯é—®é¢˜ï¼Œå¸¦æ¥çš„å¯èƒ½æ€§æ˜¯æ— é™çš„ã€‚æ¯”å¦‚æˆ‘ä»¬è¦ç›‘æ§çš„å¯¹è±¡å¦‚æœæ˜¯Beanï¼Œå®ç°å°±ä¼šéå¸¸ç®€å•ã€‚æ‰€ä»¥ï¼Œè¿™å¥—å®¹å™¨ä½“ç³»ï¼Œä¸ä»…è¢«Spring Coreå’ŒSpring Bootå¤§é‡ä¾èµ–ï¼Œè¿˜å®ç°äº†ä¸€äº›å¤–éƒ¨æ¡†æ¶å’ŒSpringçš„æ— ç¼æ•´åˆã€‚

AOPï¼Œä½“ç°äº†æ¾è€¦åˆã€é«˜å†…èšçš„ç²¾é«“ï¼Œåœ¨åˆ‡é¢é›†ä¸­å®ç°æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆç¼“å­˜ã€æƒé™ã€æ—¥å¿—ç­‰ï¼‰ï¼Œç„¶åé€šè¿‡åˆ‡ç‚¹é…ç½®æŠŠä»£ç æ³¨å…¥åˆé€‚çš„åœ°æ–¹ã€‚åˆ‡é¢ã€åˆ‡ç‚¹ã€å¢å¼ºã€è¿æ¥ç‚¹ï¼Œæ˜¯AOPä¸­éå¸¸é‡è¦çš„æ¦‚å¿µï¼Œä¹Ÿæ˜¯æˆ‘ä»¬è¿™ä¸¤è®²ä¼šå¤§é‡æåŠçš„ã€‚

ä¸ºæ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬æŠŠSpring AOPæŠ€æœ¯çœ‹ä½œä¸ºè›‹ç³•åšå¥¶æ²¹å¤¹å±‚çš„å·¥åºã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„åœ°æ–¹æŠŠå¥¶æ²¹æ³¨å…¥è›‹ç³•èƒšå­ä¸­ï¼Œé‚£åº”è¯¥å¦‚ä½•æŒ‡å¯¼å·¥äººå®Œæˆæ“ä½œå‘¢ï¼Ÿ

![](https://static001.geekbang.org/resource/image/c7/db/c71f2ec73901f7bcaa8332f237dfeddb.png?wh=1410%2A572)

- é¦–å…ˆï¼Œæˆ‘ä»¬è¦æé†’ä»–ï¼Œåªèƒ½å¾€è›‹ç³•èƒšå­é‡Œé¢åŠ å¥¶æ²¹ï¼Œè€Œä¸èƒ½ä¸Šé¢æˆ–ä¸‹é¢åŠ å¥¶æ²¹ã€‚è¿™å°±æ˜¯è¿æ¥ç‚¹ï¼ˆJoin pointï¼‰ï¼Œå¯¹äºSpring AOPæ¥è¯´ï¼Œè¿æ¥ç‚¹å°±æ˜¯æ–¹æ³•æ‰§è¡Œã€‚
- ç„¶åï¼Œæˆ‘ä»¬è¦å‘Šè¯‰ä»–ï¼Œåœ¨ä»€ä¹ˆç‚¹åˆ‡å¼€è›‹ç³•åŠ å¥¶æ²¹ã€‚æ¯”å¦‚ï¼Œå¯ä»¥åœ¨è›‹ç³•å¯å­ä¸­é—´åŠ å…¥ä¸€å±‚å¥¶æ²¹ï¼Œåœ¨ä¸­é—´åˆ‡ä¸€æ¬¡ï¼›ä¹Ÿå¯ä»¥åœ¨ä¸­é—´åŠ ä¸¤å±‚å¥¶æ²¹ï¼Œåœ¨1/3å’Œ2/3çš„åœ°æ–¹åˆ‡ä¸¤æ¬¡ã€‚è¿™å°±æ˜¯åˆ‡ç‚¹ï¼ˆPointcutï¼‰ï¼ŒSpring AOPä¸­é»˜è®¤ä½¿ç”¨AspectJæŸ¥è¯¢è¡¨è¾¾å¼ï¼Œé€šè¿‡åœ¨è¿æ¥ç‚¹è¿è¡ŒæŸ¥è¯¢è¡¨è¾¾å¼æ¥åŒ¹é…åˆ‡å…¥ç‚¹ã€‚
- æ¥ä¸‹æ¥ä¹Ÿæ˜¯æœ€é‡è¦çš„ï¼Œæˆ‘ä»¬è¦å‘Šè¯‰ä»–ï¼Œåˆ‡å¼€è›‹ç³•åè¦åšä»€ä¹ˆï¼Œä¹Ÿå°±æ˜¯åŠ å…¥å¥¶æ²¹ã€‚è¿™å°±æ˜¯å¢å¼ºï¼ˆAdviceï¼‰ï¼Œä¹Ÿå«ä½œé€šçŸ¥ï¼Œå®šä¹‰äº†åˆ‡å…¥åˆ‡ç‚¹åå¢å¼ºçš„æ–¹å¼ï¼ŒåŒ…æ‹¬å‰ã€åã€ç¯ç»•ç­‰ã€‚Spring AOPä¸­ï¼ŒæŠŠå¢å¼ºå®šä¹‰ä¸ºæ‹¦æˆªå™¨ã€‚
- æœ€åï¼Œæˆ‘ä»¬è¦å‘Šè¯‰ä»–ï¼Œæ‰¾åˆ°è›‹ç³•èƒšå­ä¸­è¦åŠ å¥¶æ²¹çš„åœ°æ–¹å¹¶åŠ å…¥å¥¶æ²¹ã€‚ä¸ºè›‹ç³•åšå¥¶æ²¹å¤¹å±‚çš„æ“ä½œï¼Œå¯¹Spring AOPæ¥è¯´å°±æ˜¯åˆ‡é¢ï¼ˆAspectï¼‰ï¼Œä¹Ÿå«ä½œæ–¹é¢ã€‚åˆ‡é¢=åˆ‡ç‚¹+å¢å¼ºã€‚

å¥½äº†ï¼Œç†è§£äº†è¿™å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»§ç»­åˆ†ææ¡ˆä¾‹äº†ã€‚

æˆ‘è¦é¦–å…ˆè¯´æ˜çš„æ˜¯ï¼ŒSpringç›¸å…³é—®é¢˜çš„é—®é¢˜æ¯”è¾ƒå¤æ‚ï¼Œä¸€æ–¹é¢æ˜¯Springæä¾›çš„IoCå’ŒAOPæœ¬å°±çµæ´»ï¼Œå¦ä¸€æ–¹é¢Spring Bootçš„è‡ªåŠ¨è£…é…ã€Spring Cloudå¤æ‚çš„æ¨¡å—ä¼šè®©é—®é¢˜æ’æŸ¥å˜å¾—æ›´å¤æ‚ã€‚å› æ­¤ï¼Œä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä¼šå¸¦ä½ å…ˆæ‰“å¥½åŸºç¡€ï¼Œé€šè¿‡ä¸¤ä¸ªæ¡ˆä¾‹æ¥é‡ç‚¹èŠèŠIoCå’ŒAOPï¼›ç„¶åï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€è®²ä¸­ä¸ä½ åˆ†äº«Springç›¸å…³çš„å‘ã€‚

## å•ä¾‹çš„Beanå¦‚ä½•æ³¨å…¥Prototypeçš„Beanï¼Ÿ

æˆ‘ä»¬è™½ç„¶çŸ¥é“Springåˆ›å»ºçš„Beané»˜è®¤æ˜¯å•ä¾‹çš„ï¼Œä½†å½“Beané‡åˆ°ç»§æ‰¿çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå¿½ç•¥è¿™ä¸€ç‚¹ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå¿½ç•¥è¿™ä¸€ç‚¹åˆä¼šé€ æˆä»€ä¹ˆå½±å“å‘¢ï¼Ÿæ¥ä¸‹æ¥ï¼Œæˆ‘å°±å’Œä½ åˆ†äº«ä¸€ä¸ªç”±å•ä¾‹å¼•èµ·å†…å­˜æ³„éœ²çš„æ¡ˆä¾‹ã€‚

æ¶æ„å¸ˆä¸€å¼€å§‹å®šä¹‰äº†è¿™ä¹ˆä¸€ä¸ªSayServiceæŠ½è±¡ç±»ï¼Œå…¶ä¸­ç»´æŠ¤äº†ä¸€ä¸ªç±»å‹æ˜¯ArrayListçš„å­—æ®µdataï¼Œç”¨äºä¿å­˜æ–¹æ³•å¤„ç†çš„ä¸­é—´æ•°æ®ã€‚æ¯æ¬¡è°ƒç”¨sayæ–¹æ³•éƒ½ä¼šå¾€dataåŠ å…¥æ–°æ•°æ®ï¼Œå¯ä»¥è®¤ä¸ºSayServiceæ˜¯æœ‰çŠ¶æ€ï¼Œå¦‚æœSayServiceæ˜¯å•ä¾‹çš„è¯å¿…ç„¶ä¼šOOMï¼š

```
@Slf4j
public abstract class SayService {
    List<String> data = new ArrayList<>();

    public void say() {
        data.add(IntStream.rangeClosed(1, 1000000)
                .mapToObj(__ -> "a")
                .collect(Collectors.joining("")) + UUID.randomUUID().toString());
        log.info("I'm {} size:{}", this, data.size());
    }
}
```

ä½†å®é™…å¼€å‘çš„æ—¶å€™ï¼Œå¼€å‘åŒå­¦æ²¡æœ‰è¿‡å¤šæ€è€ƒå°±æŠŠSayHelloå’ŒSayByeç±»åŠ ä¸Šäº†@Serviceæ³¨è§£ï¼Œè®©å®ƒä»¬æˆä¸ºäº†Beanï¼Œä¹Ÿæ²¡æœ‰è€ƒè™‘åˆ°çˆ¶ç±»æ˜¯æœ‰çŠ¶æ€çš„ï¼š

```
@Service
@Slf4j
public class SayHello extends SayService {
    @Override
    public void say() {
        super.say();
        log.info("hello");
    }
}

@Service
@Slf4j
public class SayBye extends SayService {
    @Override
    public void say() {
        super.say();
        log.info("bye");
    }
}
```

è®¸å¤šå¼€å‘åŒå­¦è®¤ä¸ºï¼Œ@Serviceæ³¨è§£çš„æ„ä¹‰åœ¨äºï¼Œèƒ½é€šè¿‡@Autowiredæ³¨è§£è®©Springè‡ªåŠ¨æ³¨å…¥å¯¹è±¡ï¼Œå°±æ¯”å¦‚å¯ä»¥ç›´æ¥ä½¿ç”¨æ³¨å…¥çš„Listè·å–åˆ°SayHelloå’ŒSayByeï¼Œè€Œæ²¡æƒ³è¿‡ç±»çš„ç”Ÿå‘½å‘¨æœŸï¼š

```
@Autowired
List<SayService> sayServiceList;

@GetMapping("test")
public void test() {
    log.info("====================");
    sayServiceList.forEach(SayService::say);
}
```

è¿™ä¸€ä¸ªç‚¹éå¸¸å®¹æ˜“å¿½ç•¥ã€‚å¼€å‘åŸºç±»çš„æ¶æ„å¸ˆå°†åŸºç±»è®¾è®¡ä¸ºæœ‰çŠ¶æ€çš„ï¼Œä½†å¹¶ä¸çŸ¥é“å­ç±»æ˜¯æ€ä¹ˆä½¿ç”¨åŸºç±»çš„ï¼›è€Œå¼€å‘å­ç±»çš„åŒå­¦ï¼Œæ²¡å¤šæƒ³å°±ç›´æ¥æ ‡è®°äº†@Serviceï¼Œè®©ç±»æˆä¸ºäº†Beanï¼Œé€šè¿‡@Autowiredæ³¨è§£æ¥æ³¨å…¥è¿™ä¸ªæœåŠ¡ã€‚ä½†è¿™æ ·è®¾ç½®åï¼Œæœ‰çŠ¶æ€çš„åŸºç±»å°±å¯èƒ½äº§ç”Ÿå†…å­˜æ³„éœ²æˆ–çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

æ­£ç¡®çš„æ–¹å¼æ˜¯ï¼Œ**åœ¨ä¸ºç±»æ ‡è®°ä¸Š@Serviceæ³¨è§£æŠŠç±»å‹äº¤ç”±å®¹å™¨ç®¡ç†å‰ï¼Œé¦–å…ˆè¯„ä¼°ä¸€ä¸‹ç±»æ˜¯å¦æœ‰çŠ¶æ€ï¼Œç„¶åä¸ºBeanè®¾ç½®åˆé€‚çš„Scope**ã€‚å¥½åœ¨ä¸Šçº¿å‰ï¼Œæ¶æ„å¸ˆå‘ç°äº†è¿™ä¸ªå†…å­˜æ³„éœ²é—®é¢˜ï¼Œå¼€å‘åŒå­¦ä¹Ÿåšäº†ä¿®æ”¹ï¼Œä¸ºSayHelloå’ŒSayByeä¸¤ä¸ªç±»éƒ½æ ‡è®°äº†@Scopeæ³¨è§£ï¼Œè®¾ç½®äº†PROTOTYPEçš„ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯å¤šä¾‹ï¼š

```
@Scope(value = ConfigurableBeanFactory.SCOPE_PROTOTYPE)
```

ä½†ï¼Œä¸Šçº¿åè¿˜æ˜¯å‡ºç°äº†å†…å­˜æ³„æ¼ï¼Œè¯æ˜ä¿®æ”¹æ˜¯æ— æ•ˆçš„ã€‚

ä»æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨å’Œç¬¬äºŒæ¬¡è°ƒç”¨çš„æ—¶å€™ï¼ŒSayByeå¯¹è±¡éƒ½æ˜¯4c0bfe9eï¼ŒSayHelloä¹Ÿæ˜¯ä¸€æ ·çš„é—®é¢˜ã€‚ä»æ—¥å¿—ç¬¬7åˆ°10è¡Œè¿˜å¯ä»¥çœ‹åˆ°ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨åListçš„å…ƒç´ ä¸ªæ•°å˜ä¸ºäº†2ï¼Œè¯´æ˜çˆ¶ç±»SayServiceç»´æŠ¤çš„Liståœ¨ä¸æ–­å¢é•¿ï¼Œä¸æ–­è°ƒç”¨å¿…ç„¶å‡ºç°OOMï¼š

```
[15:01:09.349] [http-nio-45678-exec-1] [INFO ] [.s.d.BeanSingletonAndOrderController:22  ] - ====================
[15:01:09.401] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo1.SayService         :19  ] - I'm org.geekbang.time.commonmistakes.spring.demo1.SayBye@4c0bfe9e size:1
[15:01:09.402] [http-nio-45678-exec-1] [INFO ] [t.commonmistakes.spring.demo1.SayBye:16  ] - bye
[15:01:09.469] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo1.SayService         :19  ] - I'm org.geekbang.time.commonmistakes.spring.demo1.SayHello@490fbeaa size:1
[15:01:09.469] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo1.SayHello           :17  ] - hello
[15:01:15.167] [http-nio-45678-exec-2] [INFO ] [.s.d.BeanSingletonAndOrderController:22  ] - ====================
[15:01:15.197] [http-nio-45678-exec-2] [INFO ] [o.g.t.c.spring.demo1.SayService         :19  ] - I'm org.geekbang.time.commonmistakes.spring.demo1.SayBye@4c0bfe9e size:2
[15:01:15.198] [http-nio-45678-exec-2] [INFO ] [t.commonmistakes.spring.demo1.SayBye:16  ] - bye
[15:01:15.224] [http-nio-45678-exec-2] [INFO ] [o.g.t.c.spring.demo1.SayService         :19  ] - I'm org.geekbang.time.commonmistakes.spring.demo1.SayHello@490fbeaa size:2
[15:01:15.224] [http-nio-45678-exec-2] [INFO ] [o.g.t.c.spring.demo1.SayHello           :17  ] - hello
```

è¿™å°±å¼•å‡ºäº†å•ä¾‹çš„Beanå¦‚ä½•æ³¨å…¥Prototypeçš„Beanè¿™ä¸ªé—®é¢˜ã€‚Controlleræ ‡è®°äº†@RestControlleræ³¨è§£ï¼Œè€Œ@RestControlleræ³¨è§£=@Controlleræ³¨è§£+@ResponseBodyæ³¨è§£ï¼Œåˆå› ä¸º@Controlleræ ‡è®°äº†@Componentå…ƒæ³¨è§£ï¼Œæ‰€ä»¥@RestControlleræ³¨è§£å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªSpring Beanï¼š

```
//@RestControlleræ³¨è§£=@Controlleræ³¨è§£+@ResponseBodyæ³¨è§£@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Controller
@ResponseBody
public @interface RestController {}

//@Controlleråˆæ ‡è®°äº†@Componentå…ƒæ³¨è§£
@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Component
public @interface Controller {}
```

**Beané»˜è®¤æ˜¯å•ä¾‹çš„ï¼Œæ‰€ä»¥å•ä¾‹çš„Controlleræ³¨å…¥çš„Serviceä¹Ÿæ˜¯ä¸€æ¬¡æ€§åˆ›å»ºçš„ï¼Œå³ä½¿Serviceæœ¬èº«æ ‡è¯†äº†prototypeçš„èŒƒå›´ä¹Ÿæ²¡ç”¨ã€‚**

ä¿®å¤æ–¹å¼æ˜¯ï¼Œè®©Serviceä»¥ä»£ç†æ–¹å¼æ³¨å…¥ã€‚è¿™æ ·è™½ç„¶Controlleræœ¬èº«æ˜¯å•ä¾‹çš„ï¼Œä½†æ¯æ¬¡éƒ½èƒ½ä»ä»£ç†è·å–Serviceã€‚è¿™æ ·ä¸€æ¥ï¼ŒprototypeèŒƒå›´çš„é…ç½®æ‰èƒ½çœŸæ­£ç”Ÿæ•ˆï¼š

```
@Scope(value = ConfigurableBeanFactory.SCOPE_PROTOTYPE, proxyMode = ScopedProxyMode.TARGET_CLASS)
```

é€šè¿‡æ—¥å¿—å¯ä»¥ç¡®è®¤è¿™ç§ä¿®å¤æ–¹å¼æœ‰æ•ˆï¼š

```
[15:08:42.649] [http-nio-45678-exec-1] [INFO ] [.s.d.BeanSingletonAndOrderController:22  ] - ====================
[15:08:42.747] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo1.SayService         :19  ] - I'm org.geekbang.time.commonmistakes.spring.demo1.SayBye@3fa64743 size:1
[15:08:42.747] [http-nio-45678-exec-1] [INFO ] [t.commonmistakes.spring.demo1.SayBye:17  ] - bye
[15:08:42.871] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo1.SayService         :19  ] - I'm org.geekbang.time.commonmistakes.spring.demo1.SayHello@2f0b779 size:1
[15:08:42.872] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo1.SayHello           :17  ] - hello
[15:08:42.932] [http-nio-45678-exec-2] [INFO ] [.s.d.BeanSingletonAndOrderController:22  ] - ====================
[15:08:42.991] [http-nio-45678-exec-2] [INFO ] [o.g.t.c.spring.demo1.SayService         :19  ] - I'm org.geekbang.time.commonmistakes.spring.demo1.SayBye@7319b18e size:1
[15:08:42.992] [http-nio-45678-exec-2] [INFO ] [t.commonmistakes.spring.demo1.SayBye:17  ] - bye
[15:08:43.046] [http-nio-45678-exec-2] [INFO ] [o.g.t.c.spring.demo1.SayService         :19  ] - I'm org.geekbang.time.commonmistakes.spring.demo1.SayHello@77262b35 size:1
[15:08:43.046] [http-nio-45678-exec-2] [INFO ] [o.g.t.c.spring.demo1.SayHello           :17  ] - hello
```

è°ƒè¯•ä¸€ä¸‹ä¹Ÿå¯ä»¥å‘ç°ï¼Œæ³¨å…¥çš„Serviceéƒ½æ˜¯Springç”Ÿæˆçš„ä»£ç†ç±»ï¼š

![](https://static001.geekbang.org/resource/image/a9/30/a95f7a5f3a576b3b426c7c5625b29230.png?wh=2082%2A264)

å½“ç„¶ï¼Œå¦‚æœä¸å¸Œæœ›èµ°ä»£ç†çš„è¯è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯ï¼Œæ¯æ¬¡ç›´æ¥ä»ApplicationContextä¸­è·å–Beanï¼š

```
@Autowired
private ApplicationContext applicationContext;
@GetMapping("test2")
public void test2() {
applicationContext.getBeansOfType(SayService.class).values().forEach(SayService::say);
}
```

å¦‚æœç»†å¿ƒçš„è¯ï¼Œä½ å¯ä»¥å‘ç°å¦ä¸€ä¸ªæ½œåœ¨çš„é—®é¢˜ã€‚è¿™é‡ŒSpringæ³¨å…¥çš„SayServiceçš„Listï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯SayByeï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯SayHelloã€‚ä½†ï¼Œæˆ‘ä»¬æ›´å¸Œæœ›çš„æ˜¯å…ˆæ‰§è¡ŒHelloå†æ‰§è¡ŒByeï¼Œæ‰€ä»¥æ³¨å…¥ä¸€ä¸ªList Beanæ—¶ï¼Œéœ€è¦è¿›ä¸€æ­¥è€ƒè™‘Beançš„é¡ºåºæˆ–è€…è¯´ä¼˜å…ˆçº§ã€‚

å¤§å¤šæ•°æƒ…å†µä¸‹é¡ºåºå¹¶ä¸æ˜¯é‚£ä¹ˆé‡è¦ï¼Œä½†å¯¹äºAOPï¼Œé¡ºåºå¯èƒ½ä¼šå¼•å‘è‡´å‘½é—®é¢˜ã€‚æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹è¿™ä¸ªé—®é¢˜å§ã€‚

## ç›‘æ§åˆ‡é¢å› ä¸ºé¡ºåºé—®é¢˜å¯¼è‡´Springäº‹åŠ¡å¤±æ•ˆ

å®ç°æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œæ˜¯AOPéå¸¸å¸¸è§çš„ä¸€ä¸ªåº”ç”¨ã€‚æˆ‘æ›¾çœ‹åˆ°è¿‡ä¸€ä¸ªä¸é”™çš„AOPå®è·µï¼Œé€šè¿‡AOPå®ç°äº†ä¸€ä¸ªæ•´åˆæ—¥å¿—è®°å½•ã€å¼‚å¸¸å¤„ç†å’Œæ–¹æ³•è€—æ—¶æ‰“ç‚¹ä¸ºä¸€ä½“çš„ç»Ÿä¸€åˆ‡é¢ã€‚ä½†åæ¥å‘ç°ï¼Œä½¿ç”¨äº†AOPåˆ‡é¢åï¼Œè¿™ä¸ªåº”ç”¨çš„å£°æ˜å¼äº‹åŠ¡å¤„ç†å±…ç„¶éƒ½æ˜¯æ— æ•ˆçš„ã€‚ä½ å¯ä»¥å…ˆå›é¡¾ä¸‹[ç¬¬6è®²](https://time.geekbang.org/column/article/213295)ä¸­æåˆ°çš„ï¼ŒSpringäº‹åŠ¡å¤±æ•ˆçš„å‡ ç§å¯èƒ½æ€§ã€‚

ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªæ¡ˆä¾‹ï¼Œåˆ†æä¸‹AOPå®ç°çš„ç›‘æ§ç»„ä»¶å’Œäº‹åŠ¡å¤±æ•ˆæœ‰ä»€ä¹ˆå…³ç³»ï¼Œä»¥åŠé€šè¿‡AOPå®ç°ç›‘æ§ç»„ä»¶æ˜¯å¦è¿˜æœ‰å…¶ä»–å‘ã€‚

é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰æ³¨è§£Metricsï¼Œæ‰“ä¸Šäº†è¯¥æ³¨è§£çš„æ–¹æ³•å¯ä»¥å®ç°å„ç§ç›‘æ§åŠŸèƒ½ï¼š

```
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.METHOD, ElementType.TYPE})
public @interface Metrics {
    /**
     * åœ¨æ–¹æ³•æˆåŠŸæ‰§è¡Œåæ‰“ç‚¹ï¼Œè®°å½•æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´å‘é€åˆ°æŒ‡æ ‡ç³»ç»Ÿï¼Œé»˜è®¤å¼€å¯
     *
     * @return
     */
    boolean recordSuccessMetrics() default true;

    /**
     * åœ¨æ–¹æ³•æˆåŠŸå¤±è´¥åæ‰“ç‚¹ï¼Œè®°å½•æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´å‘é€åˆ°æŒ‡æ ‡ç³»ç»Ÿï¼Œé»˜è®¤å¼€å¯
     *
     * @return
     */
    boolean recordFailMetrics() default true;

    /**
     * é€šè¿‡æ—¥å¿—è®°å½•è¯·æ±‚å‚æ•°ï¼Œé»˜è®¤å¼€å¯
     *
     * @return
     */
    boolean logParameters() default true;

    /**
     * é€šè¿‡æ—¥å¿—è®°å½•æ–¹æ³•è¿”å›å€¼ï¼Œé»˜è®¤å¼€å¯
     *
     * @return
     */
    boolean logReturn() default true;

    /**
     * å‡ºç°å¼‚å¸¸åé€šè¿‡æ—¥å¿—è®°å½•å¼‚å¸¸ä¿¡æ¯ï¼Œé»˜è®¤å¼€å¯
     *
     * @return
     */
    boolean logException() default true;

    /**
     * å‡ºç°å¼‚å¸¸åå¿½ç•¥å¼‚å¸¸è¿”å›é»˜è®¤å€¼ï¼Œé»˜è®¤å…³é—­
     *
     * @return
     */
    boolean ignoreException() default false;
}
```

ç„¶åï¼Œå®ç°ä¸€ä¸ªåˆ‡é¢å®ŒæˆMetricsæ³¨è§£æä¾›çš„åŠŸèƒ½ã€‚è¿™ä¸ªåˆ‡é¢å¯ä»¥å®ç°æ ‡è®°äº†@RestControlleræ³¨è§£çš„Webæ§åˆ¶å™¨çš„è‡ªåŠ¨åˆ‡å…¥ï¼Œå¦‚æœè¿˜éœ€è¦å¯¹æ›´å¤šBeanè¿›è¡Œåˆ‡å…¥çš„è¯ï¼Œå†è‡ªè¡Œæ ‡è®°@Metricsæ³¨è§£ã€‚

> å¤‡æ³¨ï¼šè¿™æ®µä»£ç æœ‰äº›é•¿ï¼Œé‡Œé¢è¿˜ç”¨åˆ°äº†ä¸€äº›å°æŠ€å·§ï¼Œä½ éœ€è¦ä»”ç»†é˜…è¯»ä»£ç ä¸­çš„æ³¨é‡Šã€‚

```
@Aspect
@Component
@Slf4j
public class MetricsAspect {
    //è®©Springå¸®æˆ‘ä»¬æ³¨å…¥ObjectMapperï¼Œä»¥æ–¹ä¾¿é€šè¿‡JSONåºåˆ—åŒ–æ¥è®°å½•æ–¹æ³•å…¥å‚å’Œå‡ºå‚
    
    @Autowired
    private ObjectMapper objectMapper;

    //å®ç°ä¸€ä¸ªè¿”å›JavaåŸºæœ¬ç±»å‹é»˜è®¤å€¼çš„å·¥å…·ã€‚å…¶å®ï¼Œä½ ä¹Ÿå¯ä»¥é€ä¸€å†™å¾ˆå¤šif-elseåˆ¤æ–­ç±»å‹ï¼Œç„¶åæ‰‹åŠ¨è®¾ç½®å…¶é»˜è®¤å€¼ã€‚è¿™é‡Œä¸ºäº†å‡å°‘ä»£ç é‡ç”¨äº†ä¸€ä¸ªå°æŠ€å·§ï¼Œå³é€šè¿‡åˆå§‹åŒ–ä¸€ä¸ªå…·æœ‰1ä¸ªå…ƒç´ çš„æ•°ç»„ï¼Œç„¶åé€šè¿‡è·å–è¿™ä¸ªæ•°ç»„çš„å€¼æ¥è·å–åŸºæœ¬ç±»å‹é»˜è®¤å€¼
    private static final Map<Class<?>, Object> DEFAULT_VALUES = Stream
            .of(boolean.class, byte.class, char.class, double.class, float.class, int.class, long.class, short.class)
            .collect(toMap(clazz -> (Class<?>) clazz, clazz -> Array.get(Array.newInstance(clazz, 1), 0)));
    public static <T> T getDefaultValue(Class<T> clazz) {
        return (T) DEFAULT_VALUES.get(clazz);
    }

    //@annotationæŒ‡ç¤ºå™¨å®ç°å¯¹æ ‡è®°äº†Metricsæ³¨è§£çš„æ–¹æ³•è¿›è¡ŒåŒ¹é…
   @Pointcut("within(@org.geekbang.time.commonmistakes.springpart1.aopmetrics.Metrics *)")
    public void withMetricsAnnotation() {
    }

    //withinæŒ‡ç¤ºå™¨å®ç°äº†åŒ¹é…é‚£äº›ç±»å‹ä¸Šæ ‡è®°äº†@RestControlleræ³¨è§£çš„æ–¹æ³•
    @Pointcut("within(@org.springframework.web.bind.annotation.RestController *)")
    public void controllerBean() {
    }

    @Around("controllerBean() || withMetricsAnnotation())")
    public Object metrics(ProceedingJoinPoint pjp) throws Throwable {
        //é€šè¿‡è¿æ¥ç‚¹è·å–æ–¹æ³•ç­¾åå’Œæ–¹æ³•ä¸ŠMetricsæ³¨è§£ï¼Œå¹¶æ ¹æ®æ–¹æ³•ç­¾åç”Ÿæˆæ—¥å¿—ä¸­è¦è¾“å‡ºçš„æ–¹æ³•å®šä¹‰æè¿°
        MethodSignature signature = (MethodSignature) pjp.getSignature();
        Metrics metrics = signature.getMethod().getAnnotation(Metrics.class);
 
        String name = String.format("ã€%sã€‘ã€%sã€‘", signature.getDeclaringType().toString(), signature.toLongString());
        //å› ä¸ºéœ€è¦é»˜è®¤å¯¹æ‰€æœ‰@RestControlleræ ‡è®°çš„Webæ§åˆ¶å™¨å®ç°@Metricsæ³¨è§£çš„åŠŸèƒ½ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æ–¹æ³•ä¸Šå¿…ç„¶æ˜¯æ²¡æœ‰@Metricsæ³¨è§£çš„ï¼Œæˆ‘ä»¬éœ€è¦è·å–ä¸€ä¸ªé»˜è®¤æ³¨è§£ã€‚è™½ç„¶å¯ä»¥æ‰‹åŠ¨å®ä¾‹åŒ–ä¸€ä¸ª@Metricsæ³¨è§£çš„å®ä¾‹å‡ºæ¥ï¼Œä½†ä¸ºäº†èŠ‚çœä»£ç è¡Œæ•°ï¼Œæˆ‘ä»¬é€šè¿‡åœ¨ä¸€ä¸ªå†…éƒ¨ç±»ä¸Šå®šä¹‰@Metricsæ³¨è§£æ–¹å¼ï¼Œç„¶åé€šè¿‡åå°„è·å–æ³¨è§£çš„å°æŠ€å·§ï¼Œæ¥è·å¾—ä¸€ä¸ªé»˜è®¤çš„@Metricsæ³¨è§£çš„å®ä¾‹
        if (metrics == null) {
            @Metrics
            final class c {}
            metrics = c.class.getAnnotation(Metrics.class);
        }
        //å°è¯•ä»è¯·æ±‚ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰è·å¾—è¯·æ±‚URLï¼Œä»¥æ–¹ä¾¿å®šä½é—®é¢˜
        RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();
        if (requestAttributes != null) {
            HttpServletRequest request = ((ServletRequestAttributes) requestAttributes).getRequest();
            if (request != null)
                name += String.format("ã€%sã€‘", request.getRequestURL().toString());
        }
        //å®ç°çš„æ˜¯å…¥å‚çš„æ—¥å¿—è¾“å‡º
        if (metrics.logParameters())
            log.info(String.format("ã€å…¥å‚æ—¥å¿—ã€‘è°ƒç”¨ %s çš„å‚æ•°æ˜¯ï¼šã€%sã€‘", name, objectMapper.writeValueAsString(pjp.getArgs())));
        //å®ç°è¿æ¥ç‚¹æ–¹æ³•çš„æ‰§è¡Œï¼Œä»¥åŠæˆåŠŸå¤±è´¥çš„æ‰“ç‚¹ï¼Œå‡ºç°å¼‚å¸¸çš„æ—¶å€™è¿˜ä¼šè®°å½•æ—¥å¿—
        Object returnValue;
        Instant start = Instant.now();
        try {
            returnValue = pjp.proceed();
            if (metrics.recordSuccessMetrics())
                //åœ¨ç”Ÿäº§çº§ä»£ç ä¸­ï¼Œæˆ‘ä»¬åº”è€ƒè™‘ä½¿ç”¨ç±»ä¼¼Micrometerçš„æŒ‡æ ‡æ¡†æ¶ï¼ŒæŠŠæ‰“ç‚¹ä¿¡æ¯è®°å½•åˆ°æ—¶é—´åºåˆ—æ•°æ®åº“ä¸­ï¼Œå®ç°é€šè¿‡å›¾è¡¨æ¥æŸ¥çœ‹æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°å’Œæ‰§è¡Œæ—¶é—´ï¼Œåœ¨è®¾è®¡ç¯‡æˆ‘ä»¬ä¼šé‡ç‚¹ä»‹ç»
                log.info(String.format("ã€æˆåŠŸæ‰“ç‚¹ã€‘è°ƒç”¨ %s æˆåŠŸï¼Œè€—æ—¶ï¼š%d ms", name, Duration.between(start, Instant.now()).toMillis()));
        } catch (Exception ex) {
            if (metrics.recordFailMetrics())
                log.info(String.format("ã€å¤±è´¥æ‰“ç‚¹ã€‘è°ƒç”¨ %s å¤±è´¥ï¼Œè€—æ—¶ï¼š%d ms", name, Duration.between(start, Instant.now()).toMillis()));
            if (metrics.logException())
                log.error(String.format("ã€å¼‚å¸¸æ—¥å¿—ã€‘è°ƒç”¨ %s å‡ºç°å¼‚å¸¸ï¼", name), ex);

            //å¿½ç•¥å¼‚å¸¸çš„æ—¶å€™ï¼Œä½¿ç”¨ä¸€å¼€å§‹å®šä¹‰çš„getDefaultValueæ–¹æ³•ï¼Œæ¥è·å–åŸºæœ¬ç±»å‹çš„é»˜è®¤å€¼
            if (metrics.ignoreException())
                returnValue = getDefaultValue(signature.getReturnType());
            else
                throw ex;
        }
        //å®ç°äº†è¿”å›å€¼çš„æ—¥å¿—è¾“å‡º
        if (metrics.logReturn())
            log.info(String.format("ã€å‡ºå‚æ—¥å¿—ã€‘è°ƒç”¨ %s çš„è¿”å›æ˜¯ï¼šã€%sã€‘", name, returnValue));
        return returnValue;
    }
}
```

æ¥ä¸‹æ¥ï¼Œåˆ†åˆ«å®šä¹‰æœ€ç®€å•çš„Controllerã€Serviceå’ŒRepositoryï¼Œæ¥æµ‹è¯•MetricsAspectçš„åŠŸèƒ½ã€‚

å…¶ä¸­ï¼ŒServiceä¸­å®ç°åˆ›å»ºç”¨æˆ·çš„æ—¶å€™åšäº†äº‹åŠ¡å¤„ç†ï¼Œå½“ç”¨æˆ·ååŒ…å«testå­—æ ·æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´äº‹åŠ¡å›æ»šã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¸ºServiceä¸­çš„createUseræ ‡è®°äº†@Metricsæ³¨è§£ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ‰‹åŠ¨ä¸ºç±»æˆ–æ–¹æ³•æ ‡è®°@Metricsæ³¨è§£ï¼Œå®ç°Controllerä¹‹å¤–çš„å…¶ä»–ç»„ä»¶çš„è‡ªåŠ¨ç›‘æ§ã€‚

```
@Slf4j
@RestController //è‡ªåŠ¨è¿›è¡Œç›‘æ§
@RequestMapping("metricstest")
public class MetricsController {
    @Autowired
    private UserService userService;
    @GetMapping("transaction")
    public int transaction(@RequestParam("name") String name) {
        try {
            userService.createUser(new UserEntity(name));
        } catch (Exception ex) {
            log.error("create user failed because {}", ex.getMessage());
        }
        return userService.getUserCount(name);
    }
}

@Service
@Slf4j
public class UserService {
    @Autowired
    private UserRepository userRepository;
    @Transactional
    @Metrics //å¯ç”¨æ–¹æ³•ç›‘æ§
    public void createUser(UserEntity entity) {
        userRepository.save(entity);
        if (entity.getName().contains("test"))
            throw new RuntimeException("invalid username!");
    }

    public int getUserCount(String name) {
        return userRepository.findByName(name).size();
    }
}

@Repository
public interface UserRepository extends JpaRepository<UserEntity, Long> {
    List<UserEntity> findByName(String name);
}
```

ä½¿ç”¨ç”¨æˆ·åâ€œtestâ€æµ‹è¯•ä¸€ä¸‹æ³¨å†ŒåŠŸèƒ½ï¼š

```
[16:27:52.586] [http-nio-45678-exec-3] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :85  ] - ã€å…¥å‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.MetricsControllerã€‘ã€public int org.geekbang.time.commonmistakes.spring.demo2.MetricsController.transaction(java.lang.String)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ çš„å‚æ•°æ˜¯ï¼šã€["test"]ã€‘
[16:27:52.590] [http-nio-45678-exec-3] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :85  ] - ã€å…¥å‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.UserServiceã€‘ã€public void org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(org.geekbang.time.commonmistakes.spring.demo2.UserEntity)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ çš„å‚æ•°æ˜¯ï¼šã€[{"id":null,"name":"test"}]ã€‘
[16:27:52.609] [http-nio-45678-exec-3] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :96  ] - ã€å¤±è´¥æ‰“ç‚¹ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.UserServiceã€‘ã€public void org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(org.geekbang.time.commonmistakes.spring.demo2.UserEntity)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ å¤±è´¥ï¼Œè€—æ—¶ï¼š19 ms
[16:27:52.610] [http-nio-45678-exec-3] [ERROR] [o.g.t.c.spring.demo2.MetricsAspect      :98  ] - ã€å¼‚å¸¸æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.UserServiceã€‘ã€public void org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(org.geekbang.time.commonmistakes.spring.demo2.UserEntity)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ å‡ºç°å¼‚å¸¸ï¼
java.lang.RuntimeException: invalid username!
	at org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(UserService.java:18)
	at org.geekbang.time.commonmistakes.spring.demo2.UserService$$FastClassBySpringCGLIB$$9eec91f.invoke(<generated>)
[16:27:52.614] [http-nio-45678-exec-3] [ERROR] [g.t.c.spring.demo2.MetricsController:21  ] - create user failed because invalid username!
[16:27:52.617] [http-nio-45678-exec-3] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :93  ] - ã€æˆåŠŸæ‰“ç‚¹ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.MetricsControllerã€‘ã€public int org.geekbang.time.commonmistakes.spring.demo2.MetricsController.transaction(java.lang.String)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ æˆåŠŸï¼Œè€—æ—¶ï¼š31 ms
[16:27:52.618] [http-nio-45678-exec-3] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :108 ] - ã€å‡ºå‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.MetricsControllerã€‘ã€public int org.geekbang.time.commonmistakes.spring.demo2.MetricsController.transaction(java.lang.String)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ çš„è¿”å›æ˜¯ï¼šã€0ã€‘
```

çœ‹èµ·æ¥è¿™ä¸ªåˆ‡é¢å¾ˆä¸é”™ï¼Œæ—¥å¿—ä¸­æ‰“å‡ºäº†æ•´ä¸ªè°ƒç”¨çš„å‡ºå…¥å‚ã€æ–¹æ³•è€—æ—¶ï¼š

- ç¬¬1ã€8ã€9å’Œ10è¡Œåˆ†åˆ«æ˜¯Controlleræ–¹æ³•çš„å…¥å‚æ—¥å¿—ã€è°ƒç”¨Serviceæ–¹æ³•å‡ºé”™åè®°å½•çš„é”™è¯¯ä¿¡æ¯ã€æˆåŠŸæ‰§è¡Œçš„æ‰“ç‚¹å’Œå‡ºå‚æ—¥å¿—ã€‚å› ä¸ºControlleræ–¹æ³•å†…éƒ¨è¿›è¡Œäº†try-catchå¤„ç†ï¼Œæ‰€ä»¥å…¶æ–¹æ³•æœ€ç»ˆæ˜¯æˆåŠŸæ‰§è¡Œçš„ã€‚å‡ºå‚æ—¥å¿—ä¸­æ˜¾ç¤ºæœ€åæŸ¥è¯¢åˆ°çš„ç”¨æˆ·æ•°é‡æ˜¯0ï¼Œè¡¨ç¤ºç”¨æˆ·åˆ›å»ºå®é™…æ˜¯å¤±è´¥çš„ã€‚
- ç¬¬2ã€3å’Œ4~7è¡Œåˆ†åˆ«æ˜¯Serviceæ–¹æ³•çš„å…¥å‚æ—¥å¿—ã€å¤±è´¥æ‰“ç‚¹å’Œå¼‚å¸¸æ—¥å¿—ã€‚æ­£æ˜¯å› ä¸ºServiceæ–¹æ³•çš„å¼‚å¸¸æŠ›åˆ°äº†Controllerï¼Œæ‰€ä»¥æ•´ä¸ªæ–¹æ³•æ‰èƒ½è¢«@Transactionalå£°æ˜å¼äº‹åŠ¡å›æ»šã€‚åœ¨è¿™é‡Œï¼ŒMetricsAspectæ•è·äº†å¼‚å¸¸åˆé‡æ–°æŠ›å‡ºï¼Œè®°å½•äº†å¼‚å¸¸çš„åŒæ—¶åˆä¸å½±å“äº‹åŠ¡å›æ»šã€‚

ä¸€æ®µæ—¶é—´åï¼Œå¼€å‘åŒå­¦è§‰å¾—é»˜è®¤çš„@Metricsé…ç½®æœ‰ç‚¹ä¸åˆé€‚ï¼Œå¸Œæœ›è¿›è¡Œä¸¤ä¸ªè°ƒæ•´ï¼š

- å¯¹äºControllerçš„è‡ªåŠ¨æ‰“ç‚¹ï¼Œä¸è¦è‡ªåŠ¨è®°å½•å…¥å‚å’Œå‡ºå‚æ—¥å¿—ï¼Œå¦åˆ™æ—¥å¿—é‡å¤ªå¤§ï¼›
- å¯¹äºServiceä¸­çš„æ–¹æ³•ï¼Œæœ€å¥½å¯ä»¥è‡ªåŠ¨æ•è·å¼‚å¸¸ã€‚

äºæ˜¯ï¼Œä»–å°±ä¸ºMetricsControlleræ‰‹åŠ¨åŠ ä¸Šäº†@Metricsæ³¨è§£ï¼Œè®¾ç½®logParameterså’ŒlogReturnä¸ºfalseï¼›ç„¶åä¸ºServiceä¸­çš„createUseræ–¹æ³•çš„@Metricsæ³¨è§£ï¼Œè®¾ç½®äº†ignoreExceptionå±æ€§ä¸ºtrueï¼š

```
@Metrics(logParameters = false, logReturn = false) //æ”¹åŠ¨ç‚¹1
public class MetricsController {

@Service
@Slf4j
public class UserService {
    @Transactional
    @Metrics(ignoreException = true) //æ”¹åŠ¨ç‚¹2
    public void createUser(UserEntity entity) {
    ...
```

ä»£ç ä¸Šçº¿åå‘ç°æ—¥å¿—é‡å¹¶æ²¡æœ‰å‡å°‘ï¼Œæ›´è¦å‘½çš„æ˜¯äº‹åŠ¡å›æ»šå¤±æ•ˆäº†ï¼Œä»è¾“å‡ºçœ‹åˆ°æœ€åæŸ¥è¯¢åˆ°äº†åä¸ºtestçš„ç”¨æˆ·ï¼š

```
[17:01:16.549] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :75  ] - ã€å…¥å‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.MetricsControllerã€‘ã€public int org.geekbang.time.commonmistakes.spring.demo2.MetricsController.transaction(java.lang.String)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ çš„å‚æ•°æ˜¯ï¼šã€["test"]ã€‘
[17:01:16.670] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :75  ] - ã€å…¥å‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.UserServiceã€‘ã€public void org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(org.geekbang.time.commonmistakes.spring.demo2.UserEntity)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ çš„å‚æ•°æ˜¯ï¼šã€[{"id":null,"name":"test"}]ã€‘
[17:01:16.885] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :86  ] - ã€å¤±è´¥æ‰“ç‚¹ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.UserServiceã€‘ã€public void org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(org.geekbang.time.commonmistakes.spring.demo2.UserEntity)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ å¤±è´¥ï¼Œè€—æ—¶ï¼š211 ms
[17:01:16.899] [http-nio-45678-exec-1] [ERROR] [o.g.t.c.spring.demo2.MetricsAspect      :88  ] - ã€å¼‚å¸¸æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.UserServiceã€‘ã€public void org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(org.geekbang.time.commonmistakes.spring.demo2.UserEntity)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ å‡ºç°å¼‚å¸¸ï¼
java.lang.RuntimeException: invalid username!
	at org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(UserService.java:18)
	at org.geekbang.time.commonmistakes.spring.demo2.UserService$$FastClassBySpringCGLIB$$9eec91f.invoke(<generated>)
[17:01:16.902] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :98  ] - ã€å‡ºå‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.UserServiceã€‘ã€public void org.geekbang.time.commonmistakes.spring.demo2.UserService.createUser(org.geekbang.time.commonmistakes.spring.demo2.UserEntity)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ çš„è¿”å›æ˜¯ï¼šã€nullã€‘
[17:01:17.466] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :83  ] - ã€æˆåŠŸæ‰“ç‚¹ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.MetricsControllerã€‘ã€public int org.geekbang.time.commonmistakes.spring.demo2.MetricsController.transaction(java.lang.String)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ æˆåŠŸï¼Œè€—æ—¶ï¼š915 ms
[17:01:17.467] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo2.MetricsAspect      :98  ] - ã€å‡ºå‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.spring.demo2.MetricsControllerã€‘ã€public int org.geekbang.time.commonmistakes.spring.demo2.MetricsController.transaction(java.lang.String)ã€‘ã€http://localhost:45678/metricstest/transactionã€‘ çš„è¿”å›æ˜¯ï¼šã€1ã€‘
```

åœ¨ä»‹ç»[æ•°æ®åº“äº‹åŠ¡](https://time.geekbang.org/column/article/213295)æ—¶ï¼Œæˆ‘ä»¬åˆ†æäº†Springé€šè¿‡TransactionAspectSupportç±»å®ç°äº‹åŠ¡ã€‚åœ¨invokeWithinTransactionæ–¹æ³•ä¸­è®¾ç½®æ–­ç‚¹å¯ä»¥å‘ç°ï¼Œåœ¨æ‰§è¡ŒServiceçš„createUseræ–¹æ³•æ—¶ï¼ŒTransactionAspectSupportå¹¶æ²¡æœ‰æ•è·åˆ°å¼‚å¸¸ï¼Œæ‰€ä»¥è‡ªç„¶æ— æ³•å›æ»šäº‹åŠ¡ã€‚åŸå› å°±æ˜¯ï¼Œ**å¼‚å¸¸è¢«MetricsAspectåƒæ‰äº†**ã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œåˆ‡é¢æœ¬èº«æ˜¯ä¸€ä¸ªBeanï¼ŒSpringå¯¹ä¸åŒåˆ‡é¢å¢å¼ºçš„æ‰§è¡Œé¡ºåºæ˜¯ç”±Beanä¼˜å…ˆçº§å†³å®šçš„ï¼Œå…·ä½“è§„åˆ™æ˜¯ï¼š

- å…¥æ“ä½œï¼ˆAroundï¼ˆè¿æ¥ç‚¹æ‰§è¡Œå‰ï¼‰ã€Beforeï¼‰ï¼Œåˆ‡é¢ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆæ‰§è¡Œã€‚ä¸€ä¸ªåˆ‡é¢çš„å…¥æ“ä½œæ‰§è¡Œå®Œï¼Œæ‰è½®åˆ°ä¸‹ä¸€åˆ‡é¢ï¼Œæ‰€æœ‰åˆ‡é¢å…¥æ“ä½œæ‰§è¡Œå®Œï¼Œæ‰å¼€å§‹æ‰§è¡Œè¿æ¥ç‚¹ï¼ˆæ–¹æ³•ï¼‰ã€‚
- å‡ºæ“ä½œï¼ˆAroundï¼ˆè¿æ¥ç‚¹æ‰§è¡Œåï¼‰ã€Afterã€AfterReturningã€AfterThrowingï¼‰ï¼Œåˆ‡é¢ä¼˜å…ˆçº§è¶Šä½ï¼Œè¶Šå…ˆæ‰§è¡Œã€‚ä¸€ä¸ªåˆ‡é¢çš„å‡ºæ“ä½œæ‰§è¡Œå®Œï¼Œæ‰è½®åˆ°ä¸‹ä¸€åˆ‡é¢ï¼Œç›´åˆ°è¿”å›åˆ°è°ƒç”¨ç‚¹ã€‚
- åŒä¸€åˆ‡é¢çš„Aroundæ¯”Afterã€Beforeå…ˆæ‰§è¡Œã€‚

å¯¹äºBeanå¯ä»¥é€šè¿‡@Orderæ³¨è§£æ¥è®¾ç½®ä¼˜å…ˆçº§ï¼ŒæŸ¥çœ‹@Orderæ³¨è§£å’ŒOrderedæ¥å£æºç å¯ä»¥å‘ç°ï¼Œé»˜è®¤æƒ…å†µä¸‹Beançš„ä¼˜å…ˆçº§ä¸ºæœ€ä½ä¼˜å…ˆçº§ï¼Œå…¶å€¼æ˜¯Integerçš„æœ€å¤§å€¼ã€‚å…¶å®ï¼Œ**å€¼è¶Šå¤§ä¼˜å…ˆçº§åè€Œè¶Šä½ï¼Œè¿™ç‚¹æ¯”è¾ƒåç›´è§‰**ï¼š

```
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})
@Documented
public @interface Order {

   int value() default Ordered.LOWEST_PRECEDENCE;

}
public interface Ordered {
   int HIGHEST_PRECEDENCE = Integer.MIN_VALUE;
   int LOWEST_PRECEDENCE = Integer.MAX_VALUE;
   int getOrder();
}
```

æˆ‘ä»¬å†é€šè¿‡ä¸€ä¸ªä¾‹å­ï¼Œæ¥ç†è§£ä¸‹å¢å¼ºçš„æ‰§è¡Œé¡ºåºã€‚æ–°å»ºä¸€ä¸ªTestAspectWithOrder10åˆ‡é¢ï¼Œé€šè¿‡@Orderæ³¨è§£è®¾ç½®ä¼˜å…ˆçº§ä¸º10ï¼Œåœ¨å†…éƒ¨å®šä¹‰@Beforeã€@Afterã€@Aroundä¸‰ç±»å¢å¼ºï¼Œä¸‰ä¸ªå¢å¼ºçš„é€»è¾‘åªæ˜¯ç®€å•çš„æ—¥å¿—è¾“å‡ºï¼Œåˆ‡ç‚¹æ˜¯TestControlleræ‰€æœ‰æ–¹æ³•ï¼›ç„¶åå†å®šä¹‰ä¸€ä¸ªç±»ä¼¼çš„TestAspectWithOrder20åˆ‡é¢ï¼Œè®¾ç½®ä¼˜å…ˆçº§ä¸º20ï¼š

```
@Aspect
@Component
@Order(10)
@Slf4j
public class TestAspectWithOrder10 {
    @Before("execution(* org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestController.*(..))")
    public void before(JoinPoint joinPoint) throws Throwable {
        log.info("TestAspectWithOrder10 @Before");
    }
    @After("execution(* org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestController.*(..))")
    public void after(JoinPoint joinPoint) throws Throwable {
        log.info("TestAspectWithOrder10 @After");
    }
    @Around("execution(* org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestController.*(..))")
    public Object around(ProceedingJoinPoint pjp) throws Throwable {
        log.info("TestAspectWithOrder10 @Around before");
        Object o = pjp.proceed();
        log.info("TestAspectWithOrder10 @Around after");
        return o;
    }
}

@Aspect
@Component
@Order(20)
@Slf4j
public class TestAspectWithOrder20 {
	...
}
```

è°ƒç”¨TestControllerçš„æ–¹æ³•åï¼Œé€šè¿‡æ—¥å¿—è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œå¢å¼ºæ‰§è¡Œé¡ºåºç¬¦åˆåˆ‡é¢æ‰§è¡Œé¡ºåºçš„ä¸‰ä¸ªè§„åˆ™ï¼š

![](https://static001.geekbang.org/resource/image/3c/3e/3c687829083abebe1d6e347f5766903e.png?wh=782%2A676)

å› ä¸ºSpringçš„äº‹åŠ¡ç®¡ç†ä¹Ÿæ˜¯åŸºäºAOPçš„ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼˜å…ˆçº§æœ€ä½ä¹Ÿå°±æ˜¯ä¼šå…ˆæ‰§è¡Œå‡ºæ“ä½œï¼Œä½†æ˜¯è‡ªå®šä¹‰åˆ‡é¢MetricsAspectä¹ŸåŒæ ·æ˜¯æœ€ä½ä¼˜å…ˆçº§ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯èƒ½å‡ºç°é—®é¢˜ï¼šå¦‚æœå‡ºæ“ä½œå…ˆæ‰§è¡Œæ•è·äº†å¼‚å¸¸ï¼Œé‚£ä¹ˆSpringçš„äº‹åŠ¡å¤„ç†å°±ä¼šå› ä¸ºæ— æ³•æ•è·åˆ°å¼‚å¸¸å¯¼è‡´æ— æ³•å›æ»šäº‹åŠ¡ã€‚

è§£å†³æ–¹å¼æ˜¯ï¼Œæ˜ç¡®MetricsAspectçš„ä¼˜å…ˆçº§ï¼Œå¯ä»¥è®¾ç½®ä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼Œä¹Ÿå°±æ˜¯æœ€å…ˆæ‰§è¡Œå…¥æ“ä½œæœ€åæ‰§è¡Œå‡ºæ“ä½œï¼š

```
//å°†MetricsAspectè¿™ä¸ªBeançš„ä¼˜å…ˆçº§è®¾ç½®ä¸ºæœ€é«˜
@Order(Ordered.HIGHEST_PRECEDENCE)
public class MetricsAspect {
    ...
}
```

æ­¤å¤–ï¼Œ**æˆ‘ä»¬è¦çŸ¥é“åˆ‡å…¥çš„è¿æ¥ç‚¹æ˜¯æ–¹æ³•ï¼Œæ³¨è§£å®šä¹‰åœ¨ç±»ä¸Šæ˜¯æ— æ³•ç›´æ¥ä»æ–¹æ³•ä¸Šè·å–åˆ°æ³¨è§£çš„**ã€‚ä¿®å¤æ–¹å¼æ˜¯ï¼Œæ”¹ä¸ºä¼˜å…ˆä»æ–¹æ³•è·å–ï¼Œå¦‚æœè·å–ä¸åˆ°å†ä»ç±»è·å–ï¼Œå¦‚æœè¿˜æ˜¯è·å–ä¸åˆ°å†ä½¿ç”¨é»˜è®¤çš„æ³¨è§£ï¼š

```
Metrics metrics = signature.getMethod().getAnnotation(Metrics.class);
if (metrics == null) {
    metrics = signature.getMethod().getDeclaringClass().getAnnotation(Metrics.class);
}
```

ç»è¿‡è¿™2å¤„ä¿®æ”¹ï¼Œäº‹åŠ¡ç»ˆäºåˆå¯ä»¥å›æ»šäº†ï¼Œå¹¶ä¸”Controllerçš„ç›‘æ§æ—¥å¿—ä¹Ÿä¸å†å‡ºç°å…¥å‚ã€å‡ºå‚ä¿¡æ¯ã€‚

æˆ‘å†æ€»ç»“ä¸‹è¿™ä¸ªæ¡ˆä¾‹ã€‚åˆ©ç”¨åå°„+æ³¨è§£+Spring AOPå®ç°ç»Ÿä¸€çš„æ¨ªåˆ‡æ—¥å¿—å…³æ³¨ç‚¹æ—¶ï¼Œæˆ‘ä»¬é‡åˆ°çš„Springäº‹åŠ¡å¤±æ•ˆé—®é¢˜ï¼Œæ˜¯ç”±è‡ªå®šä¹‰çš„åˆ‡é¢æ‰§è¡Œé¡ºåºå¼•èµ·çš„ã€‚è¿™ä¹Ÿè®©æˆ‘ä»¬è®¤è¯†åˆ°ï¼Œå› ä¸ºSpringå†…éƒ¨å¤§é‡åˆ©ç”¨IoCå’ŒAOPå®ç°äº†å„ç§ç»„ä»¶ï¼Œå½“ä½¿ç”¨IoCå’ŒAOPæ—¶ï¼Œä¸€å®šè¦è€ƒè™‘æ˜¯å¦ä¼šå½±å“å…¶ä»–å†…éƒ¨ç»„ä»¶ã€‚

## é‡ç‚¹å›é¡¾

ä»Šå¤©ï¼Œæˆ‘é€šè¿‡2ä¸ªæ¡ˆä¾‹å’Œä½ åˆ†äº«äº†Spring IoCå’ŒAOPçš„åŸºæœ¬æ¦‚å¿µï¼Œä»¥åŠä¸‰ä¸ªæ¯”è¾ƒå®¹æ˜“å‡ºé”™çš„ç‚¹ã€‚

ç¬¬ä¸€ï¼Œè®©Springå®¹å™¨ç®¡ç†å¯¹è±¡ï¼Œè¦è€ƒè™‘å¯¹è±¡é»˜è®¤çš„Scopeå•ä¾‹æ˜¯å¦é€‚åˆï¼Œå¯¹äºæœ‰çŠ¶æ€çš„ç±»å‹ï¼Œå•ä¾‹å¯èƒ½äº§ç”Ÿå†…å­˜æ³„éœ²é—®é¢˜ã€‚

ç¬¬äºŒï¼Œå¦‚æœè¦ä¸ºå•ä¾‹çš„Beanæ³¨å…¥Prototypeçš„Beanï¼Œç»ä¸æ˜¯ä»…ä»…ä¿®æ”¹Scopeå±æ€§è¿™ä¹ˆç®€å•ã€‚ç”±äºå•ä¾‹çš„Beanåœ¨å®¹å™¨å¯åŠ¨æ—¶å°±ä¼šå®Œæˆä¸€æ¬¡æ€§åˆå§‹åŒ–ã€‚æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼ŒæŠŠPrototypeçš„Beanè®¾ç½®ä¸ºé€šè¿‡ä»£ç†æ³¨å…¥ï¼Œä¹Ÿå°±æ˜¯è®¾ç½®proxyModeå±æ€§ä¸ºTARGET\_CLASSã€‚

ç¬¬ä¸‰ï¼Œå¦‚æœä¸€ç»„ç›¸åŒç±»å‹çš„Beanæ˜¯æœ‰é¡ºåºçš„ï¼Œéœ€è¦æ˜ç¡®ä½¿ç”¨@Orderæ³¨è§£æ¥è®¾ç½®é¡ºåºã€‚ä½ å¯ä»¥å†å›é¡¾ä¸‹ï¼Œä¸¤ä¸ªä¸åŒä¼˜å…ˆçº§åˆ‡é¢ä¸­@Beforeã€@Afterå’Œ@Aroundä¸‰ç§å¢å¼ºçš„æ‰§è¡Œé¡ºåºï¼Œæ˜¯ä»€ä¹ˆæ ·çš„ã€‚

æœ€åæˆ‘è¦è¯´çš„æ˜¯ï¼Œæ–‡å†…ç¬¬äºŒä¸ªæ¡ˆä¾‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç»Ÿä¸€æ—¥å¿—ç›‘æ§æ¡ˆä¾‹ï¼Œç»§ç»­ä¿®æ”¹å°±å¯ä»¥å®ç°ä¸€ä¸ªå®Œå–„çš„ã€ç”Ÿäº§çº§çš„æ–¹æ³•è°ƒç”¨ç›‘æ§å¹³å°ã€‚è¿™äº›ä¿®æ”¹ä¸»è¦æ˜¯ä¸¤æ–¹é¢ï¼šæŠŠæ—¥å¿—æ‰“ç‚¹ï¼Œæ”¹ä¸ºå¯¹æ¥Metricsç›‘æ§ç³»ç»Ÿï¼›æŠŠå„ç§åŠŸèƒ½çš„ç›‘æ§å¼€å…³ï¼Œä»æ³¨è§£å±æ€§è·å–æ”¹ä¸ºé€šè¿‡é…ç½®ç³»ç»Ÿå®æ—¶è·å–ã€‚

ä»Šå¤©ç”¨åˆ°çš„ä»£ç ï¼Œæˆ‘éƒ½æ”¾åœ¨äº†GitHubä¸Šï¼Œä½ å¯ä»¥ç‚¹å‡»[è¿™ä¸ªé“¾æ¥](https://github.com/JosephZhu1983/java-common-mistakes)æŸ¥çœ‹ã€‚

## æ€è€ƒä¸è®¨è®º

1. é™¤äº†é€šè¿‡@Autowiredæ³¨å…¥Beanå¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨@Injectæˆ–@Resourceæ¥æ³¨å…¥Beanã€‚ä½ çŸ¥é“è¿™ä¸‰ç§æ–¹å¼çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå—ï¼Ÿ
2. å½“Beanäº§ç”Ÿå¾ªç¯ä¾èµ–æ—¶ï¼Œæ¯”å¦‚BeanAçš„æ„é€ æ–¹æ³•ä¾èµ–BeanBä½œä¸ºæˆå‘˜éœ€è¦æ³¨å…¥ï¼ŒBeanBä¹Ÿä¾èµ–BeanAï¼Œä½ è§‰å¾—ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿåˆæœ‰å“ªäº›è§£å†³æ–¹å¼å‘¢ï¼Ÿ

åœ¨ä¸‹ä¸€è®²ä¸­ï¼Œæˆ‘ä¼šç»§ç»­ä¸ä½ æ¢è®¨Springæ ¸å¿ƒçš„å…¶ä»–é—®é¢˜ã€‚æˆ‘æ˜¯æœ±æ™”ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºä¸æˆ‘ç•™è¨€åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ï¼Œä¸€èµ·äº¤æµã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>Darren</span> ğŸ‘ï¼ˆ107ï¼‰ ğŸ’¬ï¼ˆ7ï¼‰<p>ä¸€ã€æ³¨è§£åŒºåˆ«
@Autowired
	1ã€@Autowiredæ˜¯springè‡ªå¸¦çš„æ³¨è§£ï¼Œé€šè¿‡â€˜AutowiredAnnotationBeanPostProcessorâ€™ ç±»å®ç°çš„ä¾èµ–æ³¨å…¥ï¼›
	2ã€@Autowiredæ˜¯æ ¹æ®ç±»å‹è¿›è¡Œè‡ªåŠ¨è£…é…çš„ï¼Œå¦‚æœéœ€è¦æŒ‰åç§°è¿›è¡Œè£…é…ï¼Œåˆ™éœ€è¦é…åˆ@Qualifierï¼›
	3ã€@Autowiredæœ‰ä¸ªå±æ€§ä¸ºrequiredï¼Œå¯ä»¥é…ç½®ä¸ºfalseï¼Œå¦‚æœé…ç½®ä¸ºfalseä¹‹åï¼Œå½“æ²¡æœ‰æ‰¾åˆ°ç›¸åº”beançš„æ—¶å€™ï¼Œç³»ç»Ÿä¸ä¼šæŠ›é”™ï¼›
	4ã€@Autowiredå¯ä»¥ä½œç”¨åœ¨å˜é‡ã€setteræ–¹æ³•ã€æ„é€ å‡½æ•°ä¸Šã€‚

@Inject
	1ã€@Injectæ˜¯JSR330 (Dependency Injection for Java)ä¸­çš„è§„èŒƒï¼Œéœ€è¦å¯¼å…¥javax.inject.Inject;å®ç°æ³¨å…¥ã€‚
	2ã€@Injectæ˜¯æ ¹æ®ç±»å‹è¿›è¡Œè‡ªåŠ¨è£…é…çš„ï¼Œå¦‚æœéœ€è¦æŒ‰åç§°è¿›è¡Œè£…é…ï¼Œåˆ™éœ€è¦é…åˆ@Namedï¼›
	3ã€@Injectå¯ä»¥ä½œç”¨åœ¨å˜é‡ã€setteræ–¹æ³•ã€æ„é€ å‡½æ•°ä¸Šã€‚

@Resource
	1ã€@Resourceæ˜¯JSR250è§„èŒƒçš„å®ç°ï¼Œéœ€è¦å¯¼å…¥javax.annotationå®ç°æ³¨å…¥ã€‚
	2ã€@Resourceæ˜¯æ ¹æ®åç§°è¿›è¡Œè‡ªåŠ¨è£…é…çš„ï¼Œä¸€èˆ¬ä¼šæŒ‡å®šä¸€ä¸ªnameå±æ€§
	3ã€@Resourceå¯ä»¥ä½œç”¨åœ¨å˜é‡ã€setteræ–¹æ³•ä¸Šã€‚

æ€»ç»“ï¼š
1ã€@Autowiredæ˜¯springè‡ªå¸¦çš„ï¼Œ@Injectæ˜¯JSR330è§„èŒƒå®ç°çš„ï¼Œ@Resourceæ˜¯JSR250è§„èŒƒå®ç°çš„ï¼Œéœ€è¦å¯¼å…¥ä¸åŒçš„åŒ…
2ã€@Autowiredã€@Injectç”¨æ³•åŸºæœ¬ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯@Autowiredæœ‰ä¸€ä¸ªrequestå±æ€§
3ã€@Autowiredã€@Injectæ˜¯é»˜è®¤æŒ‰ç…§ç±»å‹åŒ¹é…çš„ï¼Œ@Resourceæ˜¯æŒ‰ç…§åç§°åŒ¹é…çš„
4ã€@Autowiredå¦‚æœéœ€è¦æŒ‰ç…§åç§°åŒ¹é…éœ€è¦å’Œ@Qualifierä¸€èµ·ä½¿ç”¨ï¼Œ@Injectå’Œ@Nameä¸€èµ·ä½¿ç”¨


äºŒï¼šå¾ªç¯ä¾èµ–ï¼š
ç›´è§‚è§£å†³æ–¹æ³•æ—¶é€šè¿‡setæ–¹æ³•å»å¤„ç†ï¼ŒèƒŒåçš„åŸç†å…¶å®æ˜¯ç¼“å­˜ã€‚
ä¸»è¦è§£å†³æ–¹å¼ï¼šä½¿ç”¨ä¸‰çº§ç¼“å­˜
singletonObjectsï¼š ä¸€çº§ç¼“å­˜ï¼Œ Cache of singleton objects: bean name --&gt; bean instance
earlySingletonObjectsï¼š äºŒçº§ç¼“å­˜ï¼Œ Cache of early singleton objects: bean name --&gt; bean instance  æå‰æ›å…‰çš„BEANç¼“å­˜
singletonFactoriesï¼š ä¸‰çº§ç¼“å­˜ï¼Œ Cache of singleton factories: bean name --&gt; ObjectFactory</p>2020-04-26</li><br/><li><span>norman</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>@Resource å’Œ @Autowired @Inject ä¸‰è€…åŒºåˆ«ï¼š
1 @Resourceé»˜è®¤æ˜¯æŒ‰ç…§åç§°æ¥è£…é…æ³¨å…¥çš„ï¼Œåªæœ‰å½“æ‰¾ä¸åˆ°ä¸åç§°åŒ¹é…çš„beanæ‰ä¼šæŒ‰ç…§ç±»å‹æ¥è£…é…æ³¨å…¥ã€‚
2 @Autowiredé»˜è®¤æ˜¯æŒ‰ç…§ç±»å‹è£…é…æ³¨å…¥çš„ï¼Œå¦‚æœæƒ³æŒ‰ç…§åç§°æ¥è½¬é…æ³¨å…¥ï¼Œåˆ™éœ€è¦ç»“åˆ@Qualifierã€‚è¿™ä¸ªæ³¨é‡Šæ˜¯Springç‰¹æœ‰çš„ã€‚
3 @Injectæ˜¯æ ¹æ®ç±»å‹è¿›è¡Œè‡ªåŠ¨è£…é…çš„ï¼Œå¦‚æœéœ€è¦æŒ‰åç§°è¿›è¡Œè£…é…ï¼Œåˆ™éœ€è¦é…åˆ@Named</p>2020-04-25</li><br/><li><span>å·¦çª</span> ğŸ‘ï¼ˆ7ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¿™é‡Œçš„ä»£ç†ç±»ä¸æ˜¯å•ä¾‹ä¹ˆï¼Œè¿˜æ˜¯è¯´ä¼šåœ¨å¢å¼ºé€»è¾‘é‡Œä¸æ–­åˆ›å»ºè¢«ä»£ç†ç±»ï¼Ÿ</p>2020-04-26</li><br/><li><span>Demon.Lee</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¿æ¥ç‚¹: ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­èƒ½å¤Ÿåº”ç”¨é€šçŸ¥çš„æ‰€æœ‰ç‚¹ï¼›é€šçŸ¥ï¼ˆå¢å¼ºï¼‰: å³åˆ‡é¢çš„å·¥ä½œï¼Œå®šä¹‰äº†Whatä»¥åŠWhenï¼›åˆ‡ç‚¹å®šä¹‰äº†Whereï¼Œé€šçŸ¥è¢«åº”ç”¨çš„å…·ä½“ä½ç½®ï¼ˆå“ªäº›è¿æ¥ç‚¹ï¼‰
----Springå®æˆ˜ï¼ˆç¬¬4ç‰ˆï¼‰</p>2020-04-25</li><br/><li><span>é¾™è¡Œç§€</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>â€œæ¶æ„å¸ˆä¸€å¼€å§‹å®šä¹‰äº†è¿™ä¹ˆä¸€ä¸ª SayService æŠ½è±¡ç±»ï¼Œå…¶ä¸­ç»´æŠ¤äº†ä¸€ä¸ªç±»å‹æ˜¯ ArrayList çš„å­—æ®µ dataï¼Œç”¨äºä¿å­˜æ–¹æ³•å¤„ç†çš„ä¸­é—´æ•°æ®ã€‚æ¯æ¬¡è°ƒç”¨ say æ–¹æ³•éƒ½ä¼šå¾€ data åŠ å…¥æ–°æ•°æ®ï¼Œå¯ä»¥è®¤ä¸º SayService æ˜¯æœ‰çŠ¶æ€ï¼Œå¦‚æœ SayService æ˜¯å•ä¾‹çš„è¯å¿…ç„¶ä¼š OOMâ€
-----ä¸ºä»€ä¹ˆå•ä¾‹å°±ä¼šOOMï¼Œå¤šä¾‹å°±ä¸ä¼šå‘¢ï¼Ÿæ²¡çœ‹æ‡‚</p>2020-09-01</li><br/><li><span>Joker</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸‹ï¼Œé‚£ä¸ªsayserviceé‡Œçš„dataæœ‰å•¥ç”¨ï¼Œé‚£ä¸ªå•ä¾‹æ˜¯ä¸ºäº†ä¸€ç§é‡å¤ä½¿ç”¨dataå¯¹å§ï¼Œé‚£æ¢æˆæ¯æ¬¡éƒ½ç”Ÿæˆä¸€ä¸ªæ–°çš„beanï¼Œé‚£ä¸ªdataè¿˜æœ‰æ•ˆæœå—ã€‚ã€‚</p>2020-04-25</li><br/><li><span>å°å­¦ç”Ÿ</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è€å¸ˆï¼Œæ‚¨å¥½ï¼Œæ‚¨è®² çš„åˆ‡é¢æ‰§è¡Œé¡ºåºå¥½åƒä¸å¯¹å•Šï¼Œæˆ‘çš„æ‰§è¡Œé¡ºåºå’Œä½ è¯´çš„ä¸ä¸€è‡´ï¼
[10:34:11.367] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.a.TestAspectWithOrder10:31  ] - TestAspectWithOrder10 @Around before
[10:34:11.377] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.a.TestAspectWithOrder10:21  ] - TestAspectWithOrder10 @Before
[10:34:11.377] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.a.TestAspectWithOrder20:31  ] - TestAspectWithOrder20 @Around before
[10:34:11.378] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.a.TestAspectWithOrder20:21  ] - TestAspectWithOrder20 @Before
[10:34:11.379] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.aopmetrics.MetricsAspect:79  ] - ã€å…¥å‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestControllerã€‘ã€public void org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestController.test()ã€‘ã€http:&#47;&#47;localhost:45678&#47;testã€‘ çš„å‚æ•°æ˜¯ï¼šã€[]ã€‘
[10:34:11.379] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.aopmetrics.MetricsAspect:88  ] - ã€æˆåŠŸæ‰“ç‚¹ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestControllerã€‘ã€public void org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestController.test()ã€‘ã€http:&#47;&#47;localhost:45678&#47;testã€‘ æˆåŠŸï¼Œè€—æ—¶ï¼š0 ms
[10:34:11.379] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.aopmetrics.MetricsAspect:107 ] - ã€å‡ºå‚æ—¥å¿—ã€‘è°ƒç”¨ ã€class org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestControllerã€‘ã€public void org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestController.test()ã€‘ã€http:&#47;&#47;localhost:45678&#47;testã€‘ çš„è¿”å›æ˜¯ï¼šã€nullã€‘
[10:34:11.380] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.a.TestAspectWithOrder20:26  ] - TestAspectWithOrder20 @After
[10:34:11.380] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.a.TestAspectWithOrder20:33  ] - TestAspectWithOrder20 @Around after
[10:34:11.380] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.a.TestAspectWithOrder10:26  ] - TestAspectWithOrder10 @After
[10:34:11.380] [http-nio-45678-exec-4] [INFO ] [o.g.t.c.s.a.TestAspectWithOrder10:33  ] - TestAspectWithOrder10 @Around after
</p>2020-10-16</li><br/><li><span>track6688</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä½¿ç”¨è¿™ä¸ªæ³¨è§£ï¼Œ@Order(Ordered.HIGHEST_PRECEDENCE)ï¼Œä½¿ç”¨@AfterThrowingè¿™ä¸ªæ—¶ï¼ŒæŠ¥No MethodInvocation found: Check that an AOP invocation is in progress, and that the ExposeInvocationInterceptor is upfront in the interceptor chain. Specifically, note that advices with order HIGHEST_PRECEDENCE will execute before ExposeInvocationInterceptor!ï¼Œæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p>2020-06-12</li><br/><li><span>çœ‹ä¸åˆ°deé¢œè‰²</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ„Ÿè§‰Spring Intercepterçš„æ‰§è¡Œé¡ºåºå’ŒServlet Filterçš„æ‰§è¡Œè¿‡ç¨‹æ˜¯ä¸€æ ·çš„ï¼Œä¸€ä¸ªé€’å½’è°ƒç”¨æ ˆã€‚
æœ‰ä¸ªç–‘é—®æƒ³è¯·è€å¸ˆè§£ç­”ä¸€ä¸‹ã€‚é‡‡ç”¨åˆ›å»ºå†…éƒ¨ç±»çš„æ–¹å¼è·å–é»˜è®¤æ³¨è§£é…ç½®ï¼Œè¿™æ ·ä¸ä¼šæ¯è°ƒç”¨ä¸€æ¬¡å°±ä¼šåœ¨å…ƒç©ºé—´ä¸­ç”Ÿæˆä¸€ä¸ªcçš„Classä¿¡æ¯å—ï¼Ÿ</p>2020-05-16</li><br/><li><span>David Mo</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>@sevice çš„å‘è¸©è¿‡ï¼Œä»£ç†ç±»ä¸€å¼€å§‹ä¸è¡Œç™½ï¼Œåæ¥è¯´åŠ¨æ€åˆ›å»ºå°±æ‡‚äº†ã€‚å½“æ—¶æ˜¯ç”¨ä¸€ä¸ªç±»ä¼¼å·¥å‚ç±»è§£å†³çš„</p>2020-04-30</li><br/><li><span>Geek_3b1096</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¾ˆæœ‰æ”¶è·è°¢è°¢è€å¸ˆ</p>2020-04-30</li><br/><li><span>Husiun</span> ğŸ‘ï¼ˆ17ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>é—®é¢˜2ï¼Œå¾ªç¯ä¾èµ–ä¼šæŠ›å‡ºå¼‚å¸¸BeanCurrentlyInCreationExceptionï¼Œå®˜ç½‘çš„è§£å†³æ–¹æ¡ˆæ˜¯ç”±æ„é€ å™¨æ³¨å…¥æ”¹ä¸ºsetteræ³¨å…¥</p>2020-04-25</li><br/><li><span>å’Œæµ·æ˜å¨ä¸‹æ£‹</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>&#47;&#47;@annotationæŒ‡ç¤ºå™¨å®ç°å¯¹æ ‡è®°äº†Metricsæ³¨è§£çš„æ–¹æ³•è¿›è¡ŒåŒ¹é…
   @Pointcut(&quot;within(@org.geekbang.time.commonmistakes.springpart1.aopmetrics.Metrics *)&quot;

è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰ç¬”è¯¯ï¼Ÿæˆ‘è¯•äº†ä¸‹withinæ— æ³•æ‹¦æˆªæ–¹æ³•çš„æ³¨è§£ï¼Œæ¢æˆ@annotationå°±å¯ä»¥äº†</p>2020-11-25</li><br/><li><span>OneDy</span> ğŸ‘ï¼ˆ7ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å…³äºå¾ªç¯ä¾èµ–çš„è§£å†³ï¼Œçœ‹åˆ°äº†ä¸‰ç§å¤„ç†æ–¹å¼ï¼š
1.ä½¿ç”¨@Lazy å¯¹å…¶ä¸­ä¸€ä¸ªbeanæ‡’åŠ è½½
2. ä½¿ç”¨setterå±æ€§æ³¨å…¥ï¼Œè€Œå¹¶ä¸æ˜¯æ„é€ å™¨æ³¨å…¥
3. ä½¿ç”¨@PostConstructåœ¨ä¾èµ–æ³¨å…¥åæ‰§è¡Œåˆå§‹åŒ–
å…·ä½“å¯ä»¥å‚è€ƒï¼šhttps:&#47;&#47;www.baeldung.com&#47;circular-dependencies-in-spring</p>2020-08-14</li><br/><li><span>W</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>MetricsAspect è¿™ä¸ªç±»é‡Œé¢çš„å°æŠ€å·§å­¦åˆ°äº†</p>2020-04-25</li><br/>
</ul>