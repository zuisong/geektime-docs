ä½ å¥½ï¼Œæˆ‘æ˜¯æœ±æ™”ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬æ¥èŠèŠä¸šåŠ¡ä»£ç å†™å®Œï¼Œæ˜¯ä¸æ˜¯å°±æ„å‘³ç€ç”Ÿäº§å°±ç»ªï¼Œå¯ä»¥ç›´æ¥æŠ•äº§äº†ã€‚

æ‰€è°“ç”Ÿäº§å°±ç»ªï¼ˆProduction-readyï¼‰ï¼Œæ˜¯æŒ‡åº”ç”¨å¼€å‘å®Œæˆè¦æŠ•å…¥ç”Ÿäº§ç¯å¢ƒï¼Œå¼€å‘å±‚é¢éœ€è¦é¢å¤–åšçš„ä¸€äº›å·¥ä½œã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œå¦‚æœåº”ç”¨åªæ˜¯å¼€å‘å®Œæˆäº†åŠŸèƒ½ä»£ç ï¼Œç„¶åå°±ç›´æ¥æŠ•äº§ï¼Œé‚£æ„å‘³ç€åº”ç”¨å…¶å®åœ¨è£¸å¥”ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé‡åˆ°é—®é¢˜å› ä¸ºç¼ºä¹æœ‰æ•ˆçš„ç›‘æ§å¯¼è‡´æ— æ³•æ’æŸ¥å®šä½é—®é¢˜ï¼ŒåŒæ—¶å¾ˆå¯èƒ½é‡åˆ°é—®é¢˜æˆ‘ä»¬è‡ªå·±éƒ½ä¸çŸ¥é“ï¼Œéœ€è¦ä¾é ç”¨æˆ·åé¦ˆæ‰çŸ¥é“åº”ç”¨å‡ºäº†é—®é¢˜ã€‚

é‚£ä¹ˆï¼Œç”Ÿäº§å°±ç»ªéœ€è¦åšå“ªäº›å·¥ä½œå‘¢ï¼Ÿæˆ‘è®¤ä¸ºï¼Œä»¥ä¸‹ä¸‰æ–¹é¢çš„å·¥ä½œæœ€é‡è¦ã€‚

ç¬¬ä¸€ï¼Œ**æä¾›å¥åº·æ£€æµ‹æ¥å£**ã€‚ä¼ ç»Ÿé‡‡ç”¨pingçš„æ–¹å¼å¯¹åº”ç”¨è¿›è¡Œæ¢æ´»æ£€æµ‹å¹¶ä¸å‡†ç¡®ã€‚æœ‰çš„æ—¶å€™ï¼Œåº”ç”¨çš„å…³é”®å†…éƒ¨æˆ–å¤–éƒ¨ä¾èµ–å·²ç»ç¦»çº¿ï¼Œå¯¼è‡´å…¶æ ¹æœ¬æ— æ³•æ­£å¸¸å·¥ä½œï¼Œä½†å…¶å¯¹å¤–çš„Webç«¯å£æˆ–ç®¡ç†ç«¯å£æ˜¯å¯ä»¥pingé€šçš„ã€‚æˆ‘ä»¬åº”è¯¥æä¾›ä¸€ä¸ªä¸“æœ‰çš„ç›‘æ§æ£€æµ‹æ¥å£ï¼Œå¹¶å°½å¯èƒ½è§¦è¾¾ä¸€äº›å†…éƒ¨ç»„ä»¶ã€‚

ç¬¬äºŒï¼Œ**æš´éœ²åº”ç”¨å†…éƒ¨ä¿¡æ¯**ã€‚åº”ç”¨å†…éƒ¨è¯¸å¦‚çº¿ç¨‹æ± ã€å†…å­˜é˜Ÿåˆ—ç­‰ç»„ä»¶ï¼Œå¾€å¾€åœ¨åº”ç”¨å†…éƒ¨æ‰®æ¼”äº†é‡è¦çš„è§’è‰²ï¼Œå¦‚æœåº”ç”¨æˆ–åº”ç”¨æ¡†æ¶å¯ä»¥å¯¹å¤–æš´éœ²è¿™äº›é‡è¦ä¿¡æ¯ï¼Œå¹¶åŠ ä»¥ç›‘æ§ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½åœ¨è¯¸å¦‚OOMç­‰é‡å¤§é—®é¢˜æš´éœ²ä¹‹å‰å‘ç°è››ä¸é©¬è¿¹ï¼Œé¿å…å‡ºç°æ›´å¤§çš„é—®é¢˜ã€‚

ç¬¬ä¸‰ï¼Œ**å»ºç«‹åº”ç”¨æŒ‡æ ‡Metricsç›‘æ§**ã€‚Metricså¯ä»¥ç¿»è¯‘ä¸ºåº¦é‡æˆ–è€…æŒ‡æ ‡ï¼ŒæŒ‡çš„æ˜¯å¯¹äºä¸€äº›å…³é”®ä¿¡æ¯ä»¥å¯èšåˆçš„ã€æ•°å€¼çš„å½¢å¼åšå®šæœŸç»Ÿè®¡ï¼Œå¹¶ç»˜åˆ¶å‡ºå„ç§è¶‹åŠ¿å›¾è¡¨ã€‚è¿™é‡Œçš„æŒ‡æ ‡ç›‘æ§ï¼ŒåŒ…æ‹¬ä¸¤ä¸ªæ–¹é¢ï¼šä¸€æ˜¯ï¼Œåº”ç”¨å†…éƒ¨é‡è¦ç»„ä»¶çš„æŒ‡æ ‡ç›‘æ§ï¼Œæ¯”å¦‚JVMçš„ä¸€äº›æŒ‡æ ‡ã€æ¥å£çš„QPSç­‰ï¼›äºŒæ˜¯ï¼Œåº”ç”¨çš„ä¸šåŠ¡æ•°æ®çš„ç›‘æ§ï¼Œæ¯”å¦‚ç”µå•†è®¢å•é‡ã€æ¸¸æˆåœ¨çº¿äººæ•°ç­‰ã€‚

ä»Šå¤©ï¼Œæˆ‘å°±é€šè¿‡å®é™…æ¡ˆä¾‹ï¼Œå’Œä½ èŠèŠå¦‚ä½•å¿«é€Ÿå®ç°è¿™ä¸‰æ–¹é¢çš„å·¥ä½œã€‚

## å‡†å¤‡å·¥ä½œï¼šé…ç½®Spring Boot Actuator

Spring Bootæœ‰ä¸€ä¸ªActuatoræ¨¡å—ï¼Œå°è£…äº†è¯¸å¦‚å¥åº·æ£€æµ‹ã€åº”ç”¨å†…éƒ¨ä¿¡æ¯ã€MetricsæŒ‡æ ‡ç­‰ç”Ÿäº§å°±ç»ªçš„åŠŸèƒ½ã€‚ä»Šå¤©è¿™ä¸€è®²åé¢çš„å†…å®¹éƒ½æ˜¯åŸºäºActuatorçš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å…ˆå®ŒæˆActuatorçš„å¼•å…¥å’Œé…ç½®ã€‚

æˆ‘ä»¬å¯ä»¥åƒè¿™æ ·åœ¨pomä¸­é€šè¿‡æ·»åŠ ä¾èµ–çš„æ–¹å¼å¼•å…¥Actuatorï¼š

```
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

ä¹‹åï¼Œä½ å°±å¯ä»¥ç›´æ¥ä½¿ç”¨Actuatoräº†ï¼Œä½†è¿˜è¦æ³¨æ„ä¸€äº›é‡è¦çš„é…ç½®ï¼š

- å¦‚æœä½ ä¸å¸Œæœ›Webåº”ç”¨çš„Actuatorç®¡ç†ç«¯å£å’Œåº”ç”¨ç«¯å£é‡åˆçš„è¯ï¼Œå¯ä»¥ä½¿ç”¨management.server.portè®¾ç½®ç‹¬ç«‹çš„ç«¯å£ã€‚
- Actuatorè‡ªå¸¦äº†å¾ˆå¤šå¼€ç®±å³ç”¨æä¾›ä¿¡æ¯çš„ç«¯ç‚¹ï¼ˆEndpointï¼‰ï¼Œå¯ä»¥é€šè¿‡JMXæˆ–Webä¸¤ç§æ–¹å¼è¿›è¡Œæš´éœ²ã€‚è€ƒè™‘åˆ°æœ‰äº›ä¿¡æ¯æ¯”è¾ƒæ•æ„Ÿï¼Œè¿™äº›å†…ç½®çš„ç«¯ç‚¹é»˜è®¤ä¸æ˜¯å®Œå…¨å¼€å¯çš„ï¼Œä½ å¯ä»¥é€šè¿‡[å®˜ç½‘](https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready-endpoints-exposing-endpoints)æŸ¥çœ‹è¿™äº›é»˜è®¤å€¼ã€‚åœ¨è¿™é‡Œï¼Œä¸ºäº†æ–¹ä¾¿åç»­Demoï¼Œæˆ‘ä»¬è®¾ç½®æ‰€æœ‰ç«¯ç‚¹é€šè¿‡Webæ–¹å¼å¼€å¯ã€‚
- é»˜è®¤æƒ…å†µä¸‹ï¼ŒActuatorçš„Webè®¿é—®æ–¹å¼çš„æ ¹åœ°å€ä¸º/actuatorï¼Œå¯ä»¥é€šè¿‡management.endpoints.web.base-pathå‚æ•°è¿›è¡Œä¿®æ”¹ã€‚æˆ‘æ¥æ¼”ç¤ºä¸‹ï¼Œå¦‚ä½•å°†å…¶ä¿®æ”¹ä¸º/adminã€‚

```
management.server.port=45679
management.endpoints.web.exposure.include=*
management.endpoints.web.base-path=/admin
```

ç°åœ¨ï¼Œä½ å°±å¯ä»¥è®¿é—® [http://localhost:45679/admin](http://localhost:45679/admin) ï¼Œæ¥æŸ¥çœ‹Actuatorçš„æ‰€æœ‰åŠŸèƒ½URLäº†ï¼š

![](https://static001.geekbang.org/resource/image/42/4b/420d5b3d9c10934e380e555c2347834b.png?wh=1636%2A1966)

å…¶ä¸­ï¼Œå¤§éƒ¨åˆ†ç«¯ç‚¹æä¾›çš„æ˜¯åªè¯»ä¿¡æ¯ï¼Œæ¯”å¦‚æŸ¥è¯¢Springçš„Beanã€ConfigurableEnvironmentã€å®šæ—¶ä»»åŠ¡ã€SpringBootè‡ªåŠ¨é…ç½®ã€Spring MVCæ˜ å°„ç­‰ï¼›å°‘éƒ¨åˆ†ç«¯ç‚¹è¿˜æä¾›äº†ä¿®æ”¹åŠŸèƒ½ï¼Œæ¯”å¦‚ä¼˜é›…å…³é—­ç¨‹åºã€ä¸‹è½½çº¿ç¨‹Dumpã€ä¸‹è½½å †Dumpã€ä¿®æ”¹æ—¥å¿—çº§åˆ«ç­‰ã€‚

ä½ å¯ä»¥è®¿é—®[è¿™é‡Œ](https://docs.spring.io/spring-boot/docs/2.2.4.RELEASE/actuator-api//html/)ï¼ŒæŸ¥çœ‹æ‰€æœ‰è¿™äº›ç«¯ç‚¹çš„åŠŸèƒ½ï¼Œè¯¦ç»†äº†è§£å®ƒä»¬æä¾›çš„ä¿¡æ¯ä»¥åŠå®ç°çš„æ“ä½œã€‚æ­¤å¤–ï¼Œæˆ‘å†åˆ†äº«ä¸€ä¸ªä¸é”™çš„Spring Bootç®¡ç†å·¥å…·[Spring Boot Admin](https://github.com/codecentric/spring-boot-admin)ï¼Œå®ƒæŠŠå¤§éƒ¨åˆ†Actuatorç«¯ç‚¹æä¾›çš„åŠŸèƒ½å°è£…ä¸ºäº†Web UIã€‚

## å¥åº·æ£€æµ‹éœ€è¦è§¦è¾¾å…³é”®ç»„ä»¶

åœ¨è¿™ä¸€è®²å¼€å§‹æˆ‘ä»¬æåˆ°ï¼Œå¥åº·æ£€æµ‹æ¥å£å¯ä»¥è®©ç›‘æ§ç³»ç»Ÿæˆ–å‘å¸ƒå·¥å…·çŸ¥æ™“åº”ç”¨çš„çœŸå®å¥åº·çŠ¶æ€ï¼Œæ¯”pingåº”ç”¨ç«¯å£æ›´å¯é ã€‚ä¸è¿‡ï¼Œè¦è¾¾åˆ°è¿™ç§æ•ˆæœæœ€å…³é”®çš„æ˜¯ï¼Œæˆ‘ä»¬èƒ½ç¡®ä¿å¥åº·æ£€æµ‹æ¥å£å¯ä»¥æ¢æŸ¥åˆ°å…³é”®ç»„ä»¶çš„çŠ¶æ€ã€‚

å¥½åœ¨Spring Boot Actuatorå¸®æˆ‘ä»¬é¢„å…ˆå®ç°äº†è¯¸å¦‚æ•°æ®åº“ã€InfluxDBã€Elasticsearchã€Redisã€RabbitMQç­‰ä¸‰æ–¹ç³»ç»Ÿçš„å¥åº·æ£€æµ‹æŒ‡ç¤ºå™¨HealthIndicatorã€‚

é€šè¿‡Spring Bootçš„è‡ªåŠ¨é…ç½®ï¼Œè¿™äº›æŒ‡ç¤ºå™¨ä¼šè‡ªåŠ¨ç”Ÿæ•ˆã€‚å½“è¿™äº›ç»„ä»¶æœ‰é—®é¢˜çš„æ—¶å€™ï¼ŒHealthIndicatorä¼šè¿”å›DOWNæˆ–OUT\_OF\_SERVICEçŠ¶æ€ï¼Œhealthç«¯ç‚¹HTTPå“åº”çŠ¶æ€ç ä¹Ÿä¼šå˜ä¸º503ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥æ­¤æ¥é…ç½®ç¨‹åºå¥åº·çŠ¶æ€ç›‘æ§æŠ¥è­¦ã€‚

ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ŒæŠŠmanagement.endpoint.health.show-detailså‚æ•°è®¾ç½®ä¸ºalwaysï¼Œè®©æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥ç›´æ¥æŸ¥çœ‹å„ä¸ªç»„ä»¶çš„å¥åº·æƒ…å†µï¼ˆå¦‚æœé…ç½®ä¸ºwhen-authorizedï¼Œé‚£ä¹ˆå¯ä»¥ç»“åˆmanagement.endpoint.health.rolesé…ç½®æˆæƒçš„è§’è‰²ï¼‰ï¼š

```
management.endpoint.health.show-details=always
```

è®¿é—®healthç«¯ç‚¹å¯ä»¥çœ‹åˆ°ï¼Œæ•°æ®åº“ã€ç£ç›˜ã€RabbitMQã€Redisç­‰ç»„ä»¶å¥åº·çŠ¶æ€æ˜¯UPï¼Œæ•´ä¸ªåº”ç”¨çš„çŠ¶æ€ä¹Ÿæ˜¯UPï¼š

![](https://static001.geekbang.org/resource/image/3c/be/3c98443ebb76b65c4231aa35086dc8be.png?wh=1232%2A1892)

åœ¨äº†è§£äº†åŸºæœ¬é…ç½®ä¹‹åï¼Œæˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹ï¼Œå¦‚æœç¨‹åºä¾èµ–ä¸€ä¸ªå¾ˆé‡è¦çš„ä¸‰æ–¹æœåŠ¡ï¼Œæˆ‘ä»¬å¸Œæœ›è¿™ä¸ªæœåŠ¡æ— æ³•è®¿é—®çš„æ—¶å€™ï¼Œåº”ç”¨æœ¬èº«çš„å¥åº·çŠ¶æ€ä¹Ÿæ˜¯DOWNã€‚

æ¯”å¦‚ä¸‰æ–¹æœåŠ¡æœ‰ä¸€ä¸ªuseræ¥å£ï¼Œå‡ºç°å¼‚å¸¸çš„æ¦‚ç‡æ˜¯50%ï¼š

```
@Slf4j
@RestController
@RequestMapping("user")
public class UserServiceController {
    @GetMapping
    public User getUser(@RequestParam("userId") long id) {
        //ä¸€åŠæ¦‚ç‡è¿”å›æ­£ç¡®å“åº”ï¼Œä¸€åŠæ¦‚ç‡æŠ›å¼‚å¸¸
        if (ThreadLocalRandom.current().nextInt() % 2 == 0)
            return new User(id, "name" + id);
        else
            throw new RuntimeException("error");
    }
}
```

è¦å®ç°è¿™ä¸ªuseræ¥å£æ˜¯å¦æ­£ç¡®å“åº”å’Œç¨‹åºæ•´ä½“çš„å¥åº·çŠ¶æ€æŒ‚é’©çš„è¯ï¼Œå¾ˆç®€å•ï¼Œåªéœ€å®šä¹‰ä¸€ä¸ªUserServiceHealthIndicatorå®ç°HealthIndicatoræ¥å£å³å¯ã€‚

åœ¨healthæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡RestTemplateæ¥è®¿é—®è¿™ä¸ªuseræ¥å£ï¼Œå¦‚æœç»“æœæ­£ç¡®åˆ™è¿”å›Health.up()ï¼Œå¹¶æŠŠè°ƒç”¨æ‰§è¡Œè€—æ—¶å’Œç»“æœä½œä¸ºè¡¥å……ä¿¡æ¯åŠ å…¥Healthå¯¹è±¡ä¸­ã€‚å¦‚æœè°ƒç”¨æ¥å£å‡ºç°å¼‚å¸¸ï¼Œåˆ™è¿”å›Health.down()ï¼Œå¹¶æŠŠå¼‚å¸¸ä¿¡æ¯ä½œä¸ºè¡¥å……ä¿¡æ¯åŠ å…¥Healthå¯¹è±¡ä¸­ï¼š

```
@Component
@Slf4j
public class UserServiceHealthIndicator implements HealthIndicator {
    @Autowired
    private RestTemplate restTemplate;

    @Override
    public Health health() {
        long begin = System.currentTimeMillis();
        long userId = 1L;
        User user = null;
        try {
            //è®¿é—®è¿œç¨‹æ¥å£
            user = restTemplate.getForObject("http://localhost:45678/user?userId=" + userId, User.class);
            if (user != null && user.getUserId() == userId) {
                //ç»“æœæ­£ç¡®ï¼Œè¿”å›UPçŠ¶æ€ï¼Œè¡¥å……æä¾›è€—æ—¶å’Œç”¨æˆ·ä¿¡æ¯
                return Health.up()
                        .withDetail("user", user)
                        .withDetail("took", System.currentTimeMillis() - begin)
                        .build();
            } else {
                //ç»“æœä¸æ­£ç¡®ï¼Œè¿”å›DOWNçŠ¶æ€ï¼Œè¡¥å……æä¾›è€—æ—¶
                return Health.down().withDetail("took", System.currentTimeMillis() - begin).build();
            }
        } catch (Exception ex) {
            //å‡ºç°å¼‚å¸¸ï¼Œå…ˆè®°å½•å¼‚å¸¸ï¼Œç„¶åè¿”å›DOWNçŠ¶æ€ï¼Œè¡¥å……æä¾›å¼‚å¸¸ä¿¡æ¯å’Œè€—æ—¶
            log.warn("health check failed!", ex);
            return Health.down(ex).withDetail("took", System.currentTimeMillis() - begin).build();
        }
    }
}
```

æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªèšåˆå¤šä¸ªHealthIndicatorçš„æ¡ˆä¾‹ï¼Œä¹Ÿå°±æ˜¯å®šä¹‰ä¸€ä¸ªCompositeHealthContributoræ¥èšåˆå¤šä¸ªHealthContributorï¼Œå®ç°ä¸€ç»„çº¿ç¨‹æ± çš„ç›‘æ§ã€‚

é¦–å…ˆï¼Œåœ¨ThreadPoolProviderä¸­å®šä¹‰ä¸¤ä¸ªçº¿ç¨‹æ± ï¼Œå…¶ä¸­demoThreadPoolæ˜¯åŒ…å«ä¸€ä¸ªå·¥ä½œçº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œç±»å‹æ˜¯ArrayBlockingQueueï¼Œé˜»å¡é˜Ÿåˆ—çš„é•¿åº¦ä¸º10ï¼›è¿˜æœ‰ä¸€ä¸ªioThreadPoolæ¨¡æ‹ŸIOæ“ä½œçº¿ç¨‹æ± ï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°10ï¼Œæœ€å¤§çº¿ç¨‹æ•°50ï¼š

```
public class ThreadPoolProvider {
    //ä¸€ä¸ªå·¥ä½œçº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œé˜Ÿåˆ—é•¿åº¦10
    private static ThreadPoolExecutor demoThreadPool = new ThreadPoolExecutor(
            1, 1,
            2, TimeUnit.SECONDS,
            new ArrayBlockingQueue<>(10),
            new ThreadFactoryBuilder().setNameFormat("demo-threadpool-%d").get());
    //æ ¸å¿ƒçº¿ç¨‹æ•°10ï¼Œæœ€å¤§çº¿ç¨‹æ•°50çš„çº¿ç¨‹æ± ï¼Œé˜Ÿåˆ—é•¿åº¦50
    private static ThreadPoolExecutor ioThreadPool = new ThreadPoolExecutor(
            10, 50,
            2, TimeUnit.SECONDS,
            new ArrayBlockingQueue<>(100),
            new ThreadFactoryBuilder().setNameFormat("io-threadpool-%d").get());

    public static ThreadPoolExecutor getDemoThreadPool() {
        return demoThreadPool;
    }

    public static ThreadPoolExecutor getIOThreadPool() {
        return ioThreadPool;
    }
}
```

ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œæ¥æŠŠè€—æ—¶å¾ˆé•¿çš„ä»»åŠ¡æäº¤åˆ°è¿™ä¸ªdemoThreadPoolçº¿ç¨‹æ± ï¼Œä»¥æ¨¡æ‹Ÿçº¿ç¨‹æ± é˜Ÿåˆ—æ»¡çš„æƒ…å†µï¼š

```
@GetMapping("slowTask")
public void slowTask() {
    ThreadPoolProvider.getDemoThreadPool().execute(() -> {
        try {
            TimeUnit.HOURS.sleep(1);
        } catch (InterruptedException e) {
        }
    });
}
```

åšäº†è¿™äº›å‡†å¤‡å·¥ä½œåï¼Œè®©æˆ‘ä»¬æ¥çœŸæ­£å®ç°è‡ªå®šä¹‰çš„HealthIndicatorç±»ï¼Œç”¨äºå•ä¸€çº¿ç¨‹æ± çš„å¥åº·çŠ¶æ€ã€‚

æˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¸€ä¸ªThreadPoolExecutorï¼Œé€šè¿‡åˆ¤æ–­é˜Ÿåˆ—å‰©ä½™å®¹é‡æ¥ç¡®å®šè¿™ä¸ªç»„ä»¶çš„å¥åº·çŠ¶æ€ï¼Œæœ‰å‰©ä½™é‡åˆ™è¿”å›UPï¼Œå¦åˆ™è¿”å›DOWNï¼Œå¹¶æŠŠçº¿ç¨‹æ± é˜Ÿåˆ—çš„ä¸¤ä¸ªé‡è¦æ•°æ®ï¼Œä¹Ÿå°±æ˜¯å½“å‰é˜Ÿåˆ—å…ƒç´ ä¸ªæ•°å’Œå‰©ä½™é‡ï¼Œä½œä¸ºè¡¥å……ä¿¡æ¯åŠ å…¥Healthï¼š

```
public class ThreadPoolHealthIndicator implements HealthIndicator {
    private ThreadPoolExecutor threadPool;

    public ThreadPoolHealthIndicator(ThreadPoolExecutor threadPool) {
        this.threadPool = threadPool;
    }
    @Override
    public Health health() {
        //è¡¥å……ä¿¡æ¯
        Map<String, Integer> detail = new HashMap<>();
        //é˜Ÿåˆ—å½“å‰å…ƒç´ ä¸ªæ•°
        detail.put("queue_size", threadPool.getQueue().size());
        //é˜Ÿåˆ—å‰©ä½™å®¹é‡
        detail.put("queue_remaining", threadPool.getQueue().remainingCapacity());
        //å¦‚æœè¿˜æœ‰å‰©ä½™é‡åˆ™è¿”å›UPï¼Œå¦åˆ™è¿”å›DOWN
        if (threadPool.getQueue().remainingCapacity() > 0) {
            return Health.up().withDetails(detail).build();
        } else {
            return Health.down().withDetails(detail).build();
        }
    }
}
```

å†å®šä¹‰ä¸€ä¸ªCompositeHealthContributorï¼Œæ¥èšåˆä¸¤ä¸ªThreadPoolHealthIndicatorçš„å®ä¾‹ï¼Œåˆ†åˆ«å¯¹åº”ThreadPoolProviderä¸­å®šä¹‰çš„ä¸¤ä¸ªçº¿ç¨‹æ± ï¼š

```
@Component
public class ThreadPoolsHealthContributor implements CompositeHealthContributor {
    //ä¿å­˜æ‰€æœ‰çš„å­HealthContributor
    private Map<String, HealthContributor> contributors = new HashMap<>();

    ThreadPoolsHealthContributor() {
        //å¯¹åº”ThreadPoolProviderä¸­å®šä¹‰çš„ä¸¤ä¸ªçº¿ç¨‹æ± 
        this.contributors.put("demoThreadPool", new ThreadPoolHealthIndicator(ThreadPoolProvider.getDemoThreadPool()));
        this.contributors.put("ioThreadPool", new ThreadPoolHealthIndicator(ThreadPoolProvider.getIOThreadPool()));
    }

    @Override
    public HealthContributor getContributor(String name) {
        //æ ¹æ®nameæ‰¾åˆ°æŸä¸€ä¸ªHealthContributor
        return contributors.get(name);
    }

    @Override
    public Iterator<NamedContributor<HealthContributor>> iterator() {
        //è¿”å›NamedContributorçš„è¿­ä»£å™¨ï¼ŒNamedContributorä¹Ÿå°±æ˜¯Contributorå®ä¾‹+ä¸€ä¸ªå‘½å
        return contributors.entrySet().stream()
                .map((entry) -> NamedContributor.of(entry.getKey(), entry.getValue())).iterator();
    }
}
```

ç¨‹åºå¯åŠ¨åå¯ä»¥çœ‹åˆ°ï¼Œhealthæ¥å£å±•ç°äº†çº¿ç¨‹æ± å’Œå¤–éƒ¨æœåŠ¡userServiceçš„å¥åº·çŠ¶æ€ï¼Œä»¥åŠä¸€äº›å…·ä½“ä¿¡æ¯ï¼š

![](https://static001.geekbang.org/resource/image/d2/dc/d2721794203dcabf411e15143e342cdc.png?wh=1150%2A1886)

æˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªdemoThreadPoolä¸ºDOWNå¯¼è‡´çˆ¶threadPoolsä¸ºDOWNï¼Œè¿›ä¸€æ­¥å¯¼è‡´æ•´ä¸ªç¨‹åºçš„statusä¸ºDOWNï¼š

![](https://static001.geekbang.org/resource/image/bc/54/bc947b0c6d4a2a71987f16f16120eb54.png?wh=1228%2A1924)

ä»¥ä¸Šï¼Œå°±æ˜¯é€šè¿‡è‡ªå®šä¹‰HealthContributorå’ŒCompositeHealthContributorï¼Œæ¥å®ç°ç›‘æ§æ£€æµ‹è§¦è¾¾ç¨‹åºå†…éƒ¨è¯¸å¦‚ä¸‰æ–¹æœåŠ¡ã€çº¿ç¨‹æ± ç­‰å…³é”®ç»„ä»¶ï¼Œæ˜¯ä¸æ˜¯å¾ˆæ–¹ä¾¿å‘¢ï¼Ÿ

é¢å¤–è¡¥å……ä¸€ä¸‹ï¼Œ[Spring Boot 2.3.0](https://spring.io/blog/2020/03/25/liveness-and-readiness-probes-with-spring-boot)å¢å¼ºäº†å¥åº·æ£€æµ‹çš„åŠŸèƒ½ï¼Œç»†åŒ–äº†Livenesså’ŒReadinessä¸¤ä¸ªç«¯ç‚¹ï¼Œä¾¿äºSpring Bootåº”ç”¨ç¨‹åºå’ŒKubernetesæ•´åˆã€‚

## å¯¹å¤–æš´éœ²åº”ç”¨å†…éƒ¨é‡è¦ç»„ä»¶çš„çŠ¶æ€

é™¤äº†å¯ä»¥æŠŠçº¿ç¨‹æ± çš„çŠ¶æ€ä½œä¸ºæ•´ä¸ªåº”ç”¨ç¨‹åºæ˜¯å¦å¥åº·çš„ä¾æ®å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡Actuatorçš„InfoContributoråŠŸèƒ½ï¼Œå¯¹å¤–æš´éœ²ç¨‹åºå†…éƒ¨é‡è¦ç»„ä»¶çš„çŠ¶æ€æ•°æ®ã€‚è¿™é‡Œï¼Œæˆ‘ä¼šç”¨ä¸€ä¸ªä¾‹å­æ¼”ç¤ºä½¿ç”¨infoçš„HTTPç«¯ç‚¹ã€JMX MBeanè¿™ä¸¤ç§æ–¹å¼ï¼Œå¦‚ä½•æŸ¥çœ‹çŠ¶æ€æ•°æ®ã€‚

æˆ‘ä»¬çœ‹ä¸€ä¸ªå…·ä½“æ¡ˆä¾‹ï¼Œå®ç°ä¸€ä¸ªThreadPoolInfoContributoræ¥å±•ç°çº¿ç¨‹æ± çš„ä¿¡æ¯ã€‚

```
@Component
public class ThreadPoolInfoContributor implements InfoContributor {
    private static Map threadPoolInfo(ThreadPoolExecutor threadPool) {
        Map<String, Object> info = new HashMap<>();
        info.put("poolSize", threadPool.getPoolSize());//å½“å‰æ± å¤§å°
        info.put("corePoolSize", threadPool.getCorePoolSize());//è®¾ç½®çš„æ ¸å¿ƒæ± å¤§å°
        info.put("largestPoolSize", threadPool.getLargestPoolSize());//æœ€å¤§è¾¾åˆ°è¿‡çš„æ± å¤§å°
        info.put("maximumPoolSize", threadPool.getMaximumPoolSize());//è®¾ç½®çš„æœ€å¤§æ± å¤§å°
        info.put("completedTaskCount", threadPool.getCompletedTaskCount());//æ€»å®Œæˆä»»åŠ¡æ•°
        return info;
    }

    @Override
    public void contribute(Info.Builder builder) {
        builder.withDetail("demoThreadPool", threadPoolInfo(ThreadPoolProvider.getDemoThreadPool()));
        builder.withDetail("ioThreadPool", threadPoolInfo(ThreadPoolProvider.getIOThreadPool()));
    }
}
```

è®¿é—®/admin/infoæ¥å£ï¼Œå¯ä»¥çœ‹åˆ°è¿™äº›æ•°æ®ï¼š

![](https://static001.geekbang.org/resource/image/7e/41/7ed02ed4d047293fe1287e82a6bf8041.png?wh=998%2A840)

æ­¤å¤–ï¼Œå¦‚æœè®¾ç½®å¼€å¯JMXçš„è¯ï¼š

```
spring.jmx.enabled=true
```

å¯ä»¥é€šè¿‡jconsoleå·¥å…·ï¼Œåœ¨org.springframework.boot.Endpointä¸­æ‰¾åˆ°Infoè¿™ä¸ªMBeanï¼Œç„¶åæ‰§è¡Œinfoæ“ä½œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åˆšæ‰è‡ªå®šä¹‰çš„InfoContributorè¾“å‡ºçš„æœ‰å…³ä¸¤ä¸ªçº¿ç¨‹æ± çš„ä¿¡æ¯ï¼š

![](https://static001.geekbang.org/resource/image/f7/14/f7c4dd062934be5ca9a5628e7c5d0714.png?wh=2218%2A1731)

è¿™é‡Œï¼Œæˆ‘å†é¢å¤–è¡¥å……ä¸€ç‚¹ã€‚å¯¹äºæŸ¥çœ‹å’Œæ“ä½œMBeanï¼Œé™¤äº†ä½¿ç”¨jconsoleä¹‹å¤–ï¼Œä½ å¯ä»¥ä½¿ç”¨jolokiaæŠŠJMXè½¬æ¢ä¸ºHTTPåè®®ï¼Œå¼•å…¥ä¾èµ–ï¼š

```
<dependency>
    <groupId>org.jolokia</groupId>
    <artifactId>jolokia-core</artifactId>
</dependency>
```

ç„¶åï¼Œä½ å°±å¯ä»¥é€šè¿‡jolokiaï¼Œæ¥æ‰§è¡Œorg.springframework.boot:type=Endpoint,name=Infoè¿™ä¸ªMBeançš„infoæ“ä½œï¼š

![](https://static001.geekbang.org/resource/image/f7/7f/f7a128cb3efc652b63b773fdceb65f7f.png?wh=1774%2A1204)

## æŒ‡æ ‡Metricsæ˜¯å¿«é€Ÿå®šä½é—®é¢˜çš„â€œé‡‘é’¥åŒ™â€

æŒ‡æ ‡æ˜¯æŒ‡ä¸€ç»„å’Œæ—¶é—´å…³è”çš„ã€è¡¡é‡æŸä¸ªç»´åº¦èƒ½åŠ›çš„é‡åŒ–æ•°å€¼ã€‚é€šè¿‡æ”¶é›†æŒ‡æ ‡å¹¶å±•ç°ä¸ºæ›²çº¿å›¾ã€é¥¼å›¾ç­‰å›¾è¡¨ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½ã€åˆ†æé—®é¢˜ã€‚

æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®é™…çš„æ¡ˆä¾‹ï¼Œæ¥çœ‹çœ‹å¦‚ä½•é€šè¿‡å›¾è¡¨å¿«é€Ÿå®šä½é—®é¢˜ã€‚

æœ‰ä¸€ä¸ªå¤–å–è®¢å•çš„ä¸‹å•å’Œé…é€æµç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚OrderControllerè¿›è¡Œä¸‹å•æ“ä½œï¼Œä¸‹å•æ“ä½œå‰å…ˆåˆ¤æ–­å‚æ•°ï¼Œå¦‚æœå‚æ•°æ­£ç¡®è°ƒç”¨å¦ä¸€ä¸ªæœåŠ¡æŸ¥è¯¢å•†æˆ·çŠ¶æ€ï¼Œå¦‚æœå•†æˆ·åœ¨è¥ä¸šçš„è¯ç»§ç»­ä¸‹å•ï¼Œä¸‹å•æˆåŠŸåå‘ä¸€æ¡æ¶ˆæ¯åˆ°RabbitMQè¿›è¡Œå¼‚æ­¥é…é€æµç¨‹ï¼›ç„¶åå¦ä¸€ä¸ªDeliverOrderHandlerç›‘å¬è¿™æ¡æ¶ˆæ¯è¿›è¡Œé…é€æ“ä½œã€‚

![](https://static001.geekbang.org/resource/image/d4/51/d45e1e97ce1f7881a5930e5eb6648351.png?wh=1914%2A1314)

å¯¹äºè¿™æ ·ä¸€ä¸ªæ¶‰åŠåŒæ­¥è°ƒç”¨å’Œå¼‚æ­¥è°ƒç”¨çš„ä¸šåŠ¡æµç¨‹ï¼Œå¦‚æœç”¨æˆ·åé¦ˆä¸‹å•å¤±è´¥ï¼Œé‚£æˆ‘ä»¬å¦‚ä½•æ‰èƒ½å¿«é€ŸçŸ¥é“æ˜¯å“ªä¸ªç¯èŠ‚å‡ºäº†é—®é¢˜å‘¢ï¼Ÿ

è¿™æ—¶ï¼ŒæŒ‡æ ‡ä½“ç³»å°±å¯ä»¥å‘æŒ¥ä½œç”¨äº†ã€‚æˆ‘ä»¬å¯ä»¥åˆ†åˆ«ä¸ºä¸‹å•å’Œé…é€è¿™ä¸¤ä¸ªé‡è¦æ“ä½œï¼Œå»ºç«‹ä¸€äº›æŒ‡æ ‡è¿›è¡Œç›‘æ§ã€‚

å¯¹äºä¸‹å•æ“ä½œï¼Œå¯ä»¥å»ºç«‹4ä¸ªæŒ‡æ ‡ï¼š

- ä¸‹å•æ€»æ•°é‡æŒ‡æ ‡ï¼Œç›‘æ§æ•´ä¸ªç³»ç»Ÿå½“å‰ç´¯è®¡çš„ä¸‹å•é‡ï¼›
- ä¸‹å•è¯·æ±‚æŒ‡æ ‡ï¼Œå¯¹äºæ¯æ¬¡æ”¶åˆ°ä¸‹å•è¯·æ±‚ï¼Œåœ¨å¤„ç†ä¹‹å‰+1ï¼›
- ä¸‹å•æˆåŠŸæŒ‡æ ‡ï¼Œæ¯æ¬¡ä¸‹å•æˆåŠŸå®Œæˆ+1ï¼›
- ä¸‹å•å¤±è´¥æŒ‡æ ‡ï¼Œä¸‹å•æ“ä½œå¤„ç†å‡ºç°å¼‚å¸¸+1ï¼Œå¹¶ä¸”æŠŠå¼‚å¸¸åŸå› é™„åŠ åˆ°æŒ‡æ ‡ä¸Šã€‚

å¯¹äºé…é€æ“ä½œï¼Œä¹Ÿæ˜¯å»ºç«‹ç±»ä¼¼çš„4ä¸ªæŒ‡æ ‡ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Micrometeræ¡†æ¶å®ç°æŒ‡æ ‡çš„æ”¶é›†ï¼Œå®ƒä¹Ÿæ˜¯Spring Boot Actuatoré€‰ç”¨çš„æŒ‡æ ‡æ¡†æ¶ã€‚å®ƒå®ç°äº†å„ç§æŒ‡æ ‡çš„æŠ½è±¡ï¼Œå¸¸ç”¨çš„æœ‰ä¸‰ç§ï¼š

- **gauge**ï¼ˆçº¢è‰²ï¼‰ï¼Œå®ƒåæ˜ çš„æ˜¯æŒ‡æ ‡å½“å‰çš„å€¼ï¼Œæ˜¯å¤šå°‘å°±æ˜¯å¤šå°‘ï¼Œä¸èƒ½ç´¯è®¡ï¼Œæ¯”å¦‚æœ¬ä¾‹ä¸­çš„ä¸‹å•æ€»æ•°é‡æŒ‡æ ‡ï¼Œåˆæ¯”å¦‚æ¸¸æˆçš„åœ¨çº¿äººæ•°ã€JVMå½“å‰çº¿ç¨‹æ•°éƒ½å¯ä»¥è®¤ä¸ºæ˜¯gaugeã€‚
- **counter**ï¼ˆç»¿è‰²ï¼‰ï¼Œæ¯æ¬¡è°ƒç”¨ä¸€æ¬¡æ–¹æ³•å€¼å¢åŠ 1ï¼Œæ˜¯å¯ä»¥ç´¯è®¡çš„ï¼Œæ¯”å¦‚æœ¬ä¾‹ä¸­çš„ä¸‹å•è¯·æ±‚æŒ‡æ ‡ã€‚ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå¦‚æœ5ç§’å†…æˆ‘ä»¬è°ƒç”¨äº†10æ¬¡æ–¹æ³•ï¼ŒMicrometerä¹Ÿæ˜¯æ¯éš”5ç§’æŠŠæŒ‡æ ‡å‘é€ç»™åç«¯å­˜å‚¨ç³»ç»Ÿä¸€æ¬¡ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥åªå‘é€ä¸€æ¬¡å€¼ï¼Œå…¶å€¼ä¸º10ã€‚
- **timer**ï¼ˆè“è‰²ï¼‰ï¼Œç±»ä¼¼counterï¼Œåªä¸è¿‡é™¤äº†è®°å½•æ¬¡æ•°ï¼Œè¿˜è®°å½•è€—æ—¶ï¼Œæ¯”å¦‚æœ¬ä¾‹ä¸­çš„ä¸‹å•æˆåŠŸå’Œä¸‹å•å¤±è´¥ä¸¤ä¸ªæŒ‡æ ‡ã€‚

æ‰€æœ‰çš„æŒ‡æ ‡è¿˜å¯ä»¥é™„åŠ ä¸€äº›tagsæ ‡ç­¾ï¼Œä½œä¸ºè¡¥å……æ•°æ®ã€‚æ¯”å¦‚ï¼Œå½“æ“ä½œæ‰§è¡Œå¤±è´¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±ä¼šé™„åŠ ä¸€ä¸ªreasonæ ‡ç­¾åˆ°æŒ‡æ ‡ä¸Šã€‚

Micrometeré™¤äº†æŠ½è±¡äº†æŒ‡æ ‡å¤–ï¼Œè¿˜æŠ½è±¡äº†å­˜å‚¨ã€‚ä½ å¯ä»¥æŠŠMicrometerç†è§£ä¸ºç±»ä¼¼SLF4Jè¿™æ ·çš„æ¡†æ¶ï¼Œåªä¸è¿‡åè€…é’ˆå¯¹æ—¥å¿—æŠ½è±¡ï¼Œè€ŒMicrometeræ˜¯é’ˆå¯¹æŒ‡æ ‡è¿›è¡ŒæŠ½è±¡ã€‚Micrometeré€šè¿‡å¼•å…¥å„ç§registryï¼Œå¯ä»¥å®ç°æ— ç¼å¯¹æ¥å„ç§ç›‘æ§ç³»ç»Ÿæˆ–æ—¶é—´åºåˆ—æ•°æ®åº“ã€‚

åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬å¼•å…¥äº†micrometer-registry-influxä¾èµ–ï¼Œç›®çš„æ˜¯å¼•å…¥Micrometerçš„æ ¸å¿ƒä¾èµ–ï¼Œä»¥åŠé€šè¿‡Micrometerå¯¹äº[InfluxDB](https://www.influxdata.com/products/influxdb-overview/)ï¼ˆInfluxDBæ˜¯ä¸€ä¸ªæ—¶é—´åºåˆ—æ•°æ®åº“ï¼Œå…¶ä¸“é•¿æ˜¯å­˜å‚¨æŒ‡æ ‡æ•°æ®ï¼‰çš„ç»‘å®šï¼Œä»¥å®ç°æŒ‡æ ‡æ•°æ®å¯ä»¥ä¿å­˜åˆ°InfluxDBï¼š

```
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-influx</artifactId>
</dependency>
```

ç„¶åï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå¯ç”¨æŒ‡æ ‡è¾“å‡ºåˆ°InfluxDBçš„å¼€å…³ã€é…ç½®InfluxDBçš„åœ°å€ï¼Œä»¥åŠè®¾ç½®æŒ‡æ ‡æ¯ç§’åœ¨å®¢æˆ·ç«¯èšåˆä¸€æ¬¡ï¼Œç„¶åå‘é€åˆ°InfluxDBï¼š

```
management.metrics.export.influx.enabled=true
management.metrics.export.influx.uri=http://localhost:8086
management.metrics.export.influx.step=1S
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨ä¸šåŠ¡é€»è¾‘ä¸­å¢åŠ ç›¸å…³çš„ä»£ç æ¥è®°å½•æŒ‡æ ‡ã€‚

ä¸‹é¢æ˜¯OrderControllerçš„å®ç°ï¼Œä»£ç ä¸­æœ‰è¯¦ç»†æ³¨é‡Šï¼Œæˆ‘å°±ä¸ä¸€ä¸€è¯´æ˜äº†ã€‚ä½ éœ€è¦æ³¨æ„è§‚å¯Ÿå¦‚ä½•é€šè¿‡Micrometeræ¡†æ¶ï¼Œæ¥å®ç°ä¸‹å•æ€»æ•°é‡ã€ä¸‹å•è¯·æ±‚ã€ä¸‹å•æˆåŠŸå’Œä¸‹å•å¤±è´¥è¿™å››ä¸ªæŒ‡æ ‡ï¼Œåˆ†åˆ«å¯¹åº”ä»£ç çš„ç¬¬17ã€25ã€43ã€47è¡Œï¼š

```
//ä¸‹å•æ“ä½œï¼Œä»¥åŠå•†æˆ·æœåŠ¡çš„æ¥å£
@Slf4j
@RestController
@RequestMapping("order")
public class OrderController {
    //æ€»è®¢å•åˆ›å»ºæ•°é‡
    private AtomicLong createOrderCounter = new AtomicLong();
    @Autowired
    private RabbitTemplate rabbitTemplate;
    @Autowired
    private RestTemplate restTemplate;


    @PostConstruct
    public void init() {
        //æ³¨å†ŒcreateOrder.receivedæŒ‡æ ‡ï¼ŒgaugeæŒ‡æ ‡åªéœ€è¦åƒè¿™æ ·åˆå§‹åŒ–ä¸€æ¬¡ï¼Œç›´æ¥å…³è”åˆ°AtomicLongå¼•ç”¨å³å¯
        Metrics.gauge("createOrder.totalSuccess", createOrderCounter);
    }


    //ä¸‹å•æ¥å£ï¼Œæä¾›ç”¨æˆ·IDå’Œå•†æˆ·IDä½œä¸ºå…¥å‚
    @GetMapping("createOrder")
    public void createOrder(@RequestParam("userId") long userId, @RequestParam("merchantId") long merchantId) {
        //è®°å½•ä¸€æ¬¡createOrder.receivedæŒ‡æ ‡ï¼Œè¿™æ˜¯ä¸€ä¸ªcounteræŒ‡æ ‡ï¼Œè¡¨ç¤ºæ”¶åˆ°ä¸‹å•è¯·æ±‚
        Metrics.counter("createOrder.received").increment();
        Instant begin = Instant.now();
        try {
            TimeUnit.MILLISECONDS.sleep(200);
            //æ¨¡æ‹Ÿæ— æ•ˆç”¨æˆ·çš„æƒ…å†µï¼ŒID<10ä¸ºæ— æ•ˆç”¨æˆ·
            if (userId < 10)
                throw new RuntimeException("invalid user");
            //æŸ¥è¯¢å•†æˆ·æœåŠ¡
            Boolean merchantStatus = restTemplate.getForObject("http://localhost:45678/order/getMerchantStatus?merchantId=" + merchantId, Boolean.class);
            if (merchantStatus == null || !merchantStatus)
                throw new RuntimeException("closed merchant");
            Order order = new Order();
            order.setId(createOrderCounter.incrementAndGet()); //gaugeæŒ‡æ ‡å¯ä»¥å¾—åˆ°è‡ªåŠ¨æ›´æ–°
            order.setUserId(userId);
            order.setMerchantId(merchantId);
            //å‘é€MQæ¶ˆæ¯
            rabbitTemplate.convertAndSend(Consts.EXCHANGE, Consts.ROUTING_KEY, order);
            //è®°å½•ä¸€æ¬¡createOrder.successæŒ‡æ ‡ï¼Œè¿™æ˜¯ä¸€ä¸ªtimeræŒ‡æ ‡ï¼Œè¡¨ç¤ºä¸‹å•æˆåŠŸï¼ŒåŒæ—¶æä¾›è€—æ—¶
            Metrics.timer("createOrder.success").record(Duration.between(begin, Instant.now()));
        } catch (Exception ex) {
            log.error("creareOrder userId {} failed", userId, ex);
            //è®°å½•ä¸€æ¬¡createOrder.failedæŒ‡æ ‡ï¼Œè¿™æ˜¯ä¸€ä¸ªtimeræŒ‡æ ‡ï¼Œè¡¨ç¤ºä¸‹å•å¤±è´¥ï¼ŒåŒæ—¶æä¾›è€—æ—¶ï¼Œå¹¶ä¸”ä»¥tagè®°å½•å¤±è´¥åŸå› 
            Metrics.timer("createOrder.failed", "reason", ex.getMessage()).record(Duration.between(begin, Instant.now()));
        }
    }


    //å•†æˆ·æŸ¥è¯¢æ¥å£
    @GetMapping("getMerchantStatus")
    public boolean getMerchantStatus(@RequestParam("merchantId") long merchantId) throws InterruptedException {
        //åªæœ‰å•†æˆ·IDä¸º2çš„å•†æˆ·æ‰æ˜¯è¥ä¸šçš„
        TimeUnit.MILLISECONDS.sleep(200);
        return merchantId == 2;
    }
}
```

å½“ç”¨æˆ·ID&lt;10çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®æ— æ•ˆçš„æƒ…å†µï¼Œå½“å•†æˆ·IDä¸ä¸º2çš„æ—¶å€™æˆ‘ä»¬æ¨¡æ‹Ÿå•†æˆ·ä¸è¥ä¸šçš„æƒ…å†µã€‚

æ¥ä¸‹æ¥æ˜¯DeliverOrderHandleré…é€æœåŠ¡çš„å®ç°ã€‚

å…¶ä¸­ï¼ŒdeliverOrderæ–¹æ³•ç›‘å¬OrderControllerå‘å‡ºçš„MQæ¶ˆæ¯æ¨¡æ‹Ÿé…é€ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œç¬¬17ã€25ã€32å’Œ36è¡Œä»£ç ï¼Œå®ç°äº†é…é€ç›¸å…³å››ä¸ªæŒ‡æ ‡çš„è®°å½•ï¼š

```
//é…é€æœåŠ¡æ¶ˆæ¯å¤„ç†ç¨‹åº
@RestController
@Slf4j
@RequestMapping("deliver")
public class DeliverOrderHandler {
    //é…é€æœåŠ¡è¿è¡ŒçŠ¶æ€
    private volatile boolean deliverStatus = true;
    private AtomicLong deliverCounter = new AtomicLong();
    //é€šè¿‡ä¸€ä¸ªå¤–éƒ¨æ¥å£æ¥æ”¹å˜é…é€çŠ¶æ€æ¨¡æ‹Ÿé…é€æœåŠ¡åœå·¥
    @PostMapping("status")
    public void status(@RequestParam("status") boolean status) {
        deliverStatus = status;
    }
    @PostConstruct
    public void init() {
        //åŒæ ·æ³¨å†Œä¸€ä¸ªgaugeæŒ‡æ ‡deliverOrder.totalSuccessï¼Œä»£è¡¨æ€»çš„é…é€å•é‡ï¼Œåªéœ€æ³¨å†Œä¸€æ¬¡å³å¯
        Metrics.gauge("deliverOrder.totalSuccess", deliverCounter);
    }

    //ç›‘å¬MQæ¶ˆæ¯
    @RabbitListener(queues = Consts.QUEUE_NAME)
    public void deliverOrder(Order order) {
        Instant begin = Instant.now();
        //å¯¹deliverOrder.receivedè¿›è¡Œé€’å¢ï¼Œä»£è¡¨æ”¶åˆ°ä¸€æ¬¡è®¢å•æ¶ˆæ¯ï¼Œcounterç±»å‹
        Metrics.counter("deliverOrder.received").increment();
        try {
            if (!deliverStatus)
                throw new RuntimeException("deliver outofservice");
            TimeUnit.MILLISECONDS.sleep(500);
            deliverCounter.incrementAndGet();
            //é…é€æˆåŠŸæŒ‡æ ‡deliverOrder.successï¼Œtimerç±»å‹
            Metrics.timer("deliverOrder.success").record(Duration.between(begin, Instant.now()));
        } catch (Exception ex) {
            log.error("deliver Order {} failed", order, ex);
            //é…é€å¤±è´¥æŒ‡æ ‡deliverOrder.failedï¼ŒåŒæ ·é™„åŠ äº†å¤±è´¥åŸå› ä½œä¸ºtagsï¼Œtimerç±»å‹
            Metrics.timer("deliverOrder.failed", "reason", ex.getMessage()).record(Duration.between(begin, Instant.now()));
        }
    }
}
```

åŒæ—¶ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿäº†ä¸€ä¸ªé…é€æœåŠ¡æ•´ä½“çŠ¶æ€çš„å¼€å…³ï¼Œè°ƒç”¨statusæ¥å£å¯ä»¥ä¿®æ”¹å…¶çŠ¶æ€ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†åœºæ™¯å‡†å¤‡ï¼Œæ¥ä¸‹æ¥å¼€å§‹é…ç½®æŒ‡æ ‡ç›‘æ§ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥[å®‰è£…Grafana](https://grafana.com/docs/grafana/latest/installation/)ã€‚ç„¶åè¿›å…¥Grafanaé…ç½®ä¸€ä¸ªInfluxDBæ•°æ®æºï¼š

![](https://static001.geekbang.org/resource/image/e7/96/e74a6f9ac6840974413486239eb4b796.jpg?wh=1574%2A1864)

é…ç½®å¥½æ•°æ®æºä¹‹åï¼Œå°±å¯ä»¥æ·»åŠ ä¸€ä¸ªç›‘æ§é¢æ¿ï¼Œç„¶ååœ¨é¢æ¿ä¸­æ·»åŠ å„ç§ç›‘æ§å›¾è¡¨ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ªä¸‹å•æ¬¡æ•°å›¾è¡¨ä¸­æ·»åŠ äº†ä¸‹å•æ”¶åˆ°ã€æˆåŠŸå’Œå¤±è´¥ä¸‰ä¸ªæŒ‡æ ‡ã€‚

![](https://static001.geekbang.org/resource/image/b9/25/b942d8bad647e10417acbc96ed289b25.jpg?wh=2092%2A1708)

å…³äºè¿™å¼ å›¾ä¸­çš„é…ç½®ï¼š

- çº¢è‰²æ¡†æ•°æ®æºé…ç½®ï¼Œé€‰æ‹©åˆšæ‰é…ç½®çš„æ•°æ®æºã€‚
- è“è‰²æ¡†FROMé…ç½®ï¼Œé€‰æ‹©æˆ‘ä»¬çš„æŒ‡æ ‡åã€‚
- ç»¿è‰²æ¡†SELECTé…ç½®ï¼Œé€‰æ‹©æˆ‘ä»¬è¦æŸ¥è¯¢çš„æŒ‡æ ‡å­—æ®µï¼Œä¹Ÿå¯ä»¥åº”ç”¨ä¸€äº›èšåˆå‡½æ•°ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å–countå­—æ®µçš„å€¼ï¼Œç„¶åä½¿ç”¨sumå‡½æ•°è¿›è¡Œæ±‚å’Œã€‚
- ç´«è‰²æ¡†GROUP BYé…ç½®ï¼Œæˆ‘ä»¬é…ç½®äº†æŒ‰1åˆ†é’Ÿæ—¶é—´ç²’åº¦å’Œreasonå­—æ®µè¿›è¡Œåˆ†ç»„ï¼Œè¿™æ ·æŒ‡æ ‡çš„Yè½´ä»£è¡¨QPMï¼ˆæ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼‰ï¼Œä¸”æ¯ç§å¤±è´¥çš„æƒ…å†µéƒ½ä¼šç»˜åˆ¶å•ç‹¬çš„æ›²çº¿ã€‚
- é»„è‰²æ¡†ALIAS BYé…ç½®ä¸­è®¾ç½®äº†æ¯ä¸€ä¸ªæŒ‡æ ‡çš„åˆ«åï¼Œåœ¨åˆ«åä¸­å¼•ç”¨äº†reasonè¿™ä¸ªtagã€‚

ä½¿ç”¨Grafanaé…ç½®InfluxDBæŒ‡æ ‡çš„è¯¦ç»†æ–¹å¼ï¼Œä½ å¯ä»¥å‚è€ƒ[è¿™é‡Œ](https://grafana.com/docs/grafana/latest/features/datasources/influxdb/)ã€‚å…¶ä¸­çš„FROMã€SELECTã€GROUP BYçš„å«ä¹‰å’ŒSQLç±»ä¼¼ï¼Œç†è§£èµ·æ¥åº”è¯¥ä¸å›°éš¾ã€‚

ç±»ä¼¼åœ°ï¼Œ æˆ‘ä»¬é…ç½®å‡ºä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡ç›‘æ§é¢æ¿ï¼ŒåŒ…å«ä¹‹å‰å®ç°çš„8ä¸ªæŒ‡æ ‡ï¼š

- é…ç½®2ä¸ªGaugeå›¾è¡¨åˆ†åˆ«å‘ˆç°æ€»è®¢å•å®Œæˆæ¬¡æ•°ã€æ€»é…é€å®Œæˆæ¬¡æ•°ã€‚
- é…ç½®4ä¸ªGraphå›¾è¡¨åˆ†åˆ«å‘ˆç°ä¸‹å•æ“ä½œçš„æ¬¡æ•°å’Œæ€§èƒ½ï¼Œä»¥åŠé…é€æ“ä½œçš„æ¬¡æ•°å’Œæ€§èƒ½ã€‚

ä¸‹é¢æˆ‘ä»¬è¿›å…¥å®æˆ˜ï¼Œä½¿ç”¨wrké’ˆå¯¹å››ç§æƒ…å†µè¿›è¡Œå‹æµ‹ï¼Œç„¶åé€šè¿‡æ›²çº¿æ¥åˆ†æå®šä½é—®é¢˜ã€‚

**ç¬¬ä¸€ç§æƒ…å†µæ˜¯ï¼Œä½¿ç”¨åˆæ³•çš„ç”¨æˆ·IDå’Œè¥ä¸šçš„å•†æˆ·IDè¿è¡Œä¸€æ®µæ—¶é—´ï¼š**

```
wrk -t 1 -c 1 -d 3600s http://localhost:45678/order/createOrder\?userId\=20\&merchantId\=2
```

**ä»ç›‘æ§é¢æ¿å¯ä»¥ä¸€ç›®äº†ç„¶åœ°çœ‹åˆ°æ•´ä¸ªç³»ç»Ÿçš„è¿ä½œæƒ…å†µã€‚**å¯ä»¥çœ‹åˆ°ï¼Œç›®å‰ç³»ç»Ÿè¿è¡Œè‰¯å¥½ï¼Œä¸ç®¡æ˜¯ä¸‹å•è¿˜æ˜¯é…é€æ“ä½œéƒ½æ˜¯æˆåŠŸçš„ï¼Œä¸”ä¸‹å•æ“ä½œå¹³å‡å¤„ç†æ—¶é—´400msã€é…é€æ“ä½œåˆ™æ˜¯åœ¨500mså·¦å³ï¼Œç¬¦åˆé¢„æœŸï¼ˆæ³¨æ„ï¼Œä¸‹å•æ¬¡æ•°æ›²çº¿ä¸­çš„ç»¿è‰²å’Œé»„è‰²ä¸¤æ¡æ›²çº¿å…¶å®æ˜¯é‡å åœ¨ä¸€èµ·çš„ï¼Œè¡¨ç¤ºæ‰€æœ‰ä¸‹å•éƒ½æˆåŠŸäº†ï¼‰ï¼š

![](https://static001.geekbang.org/resource/image/11/83/117071b8d4f339eceaf50c87b6e69083.png?wh=3096%2A1886)

**ç¬¬äºŒç§æƒ…å†µæ˜¯ï¼Œæ¨¡æ‹Ÿæ— æ•ˆç”¨æˆ·IDè¿è¡Œä¸€æ®µæ—¶é—´**ï¼š

```
wrk -t 1 -c 1 -d 3600s http://localhost:45678/order/createOrder\?userId\=2\&merchantId\=2
```

ä½¿ç”¨æ— æ•ˆç”¨æˆ·ä¸‹å•ï¼Œæ˜¾ç„¶ä¼šå¯¼è‡´ä¸‹å•å…¨éƒ¨å¤±è´¥ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±çœ‹çœ‹ä»ç›‘æ§å›¾ä¸­æ˜¯å¦èƒ½çœ‹åˆ°è¿™ä¸ªç°è±¡ã€‚

- ç»¿è‰²æ¡†å¯ä»¥çœ‹åˆ°ï¼Œä¸‹å•ç°åœ¨å‡ºç°äº†invalid userè¿™æ¡è“è‰²çš„æ›²çº¿ï¼Œå¹¶å’Œç»¿è‰²æ”¶åˆ°ä¸‹å•è¯·æ±‚çš„æ›²çº¿æ˜¯å»åˆçš„ï¼Œè¡¨ç¤ºæ‰€æœ‰ä¸‹å•éƒ½å¤±è´¥äº†ï¼ŒåŸå› æ˜¯æ— æ•ˆç”¨æˆ·é”™è¯¯ï¼Œè¯´æ˜æºå¤´å¹¶æ²¡æœ‰é—®é¢˜ã€‚
- çº¢è‰²æ¡†å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶ä¸‹å•éƒ½æ˜¯å¤±è´¥çš„ï¼Œä½†æ˜¯ä¸‹å•æ“ä½œæ—¶é—´ä»400mså‡å°‘ä¸º200msäº†ï¼Œè¯´æ˜ä¸‹å•å¤±è´¥ä¹‹å‰ä¹Ÿæ¶ˆè€—äº†200msï¼ˆå’Œä»£ç ç¬¦åˆï¼‰ã€‚è€Œå› ä¸ºä¸‹å•å¤±è´¥æ“ä½œçš„å“åº”æ—¶é—´å‡åŠäº†ï¼Œåè€Œå¯¼è‡´ååç¿»å€äº†ã€‚
- è§‚å¯Ÿä¸¤ä¸ªé…é€ç›‘æ§å¯ä»¥å‘ç°ï¼Œé…é€æ›²çº¿å‡ºç°æ‰0ç°è±¡ï¼Œæ˜¯å› ä¸ºä¸‹å•å¤±è´¥å¯¼è‡´çš„ï¼Œä¸‹å•å¤±è´¥MQæ¶ˆæ¯å‹æ ¹å°±ä¸ä¼šå‘å‡ºã€‚å†æ³¨æ„ä¸‹è“è‰²é‚£æ¡çº¿ï¼Œå¯ä»¥çœ‹åˆ°é…é€æ›²çº¿æ‰0å»¶åäºä¸‹å•æˆåŠŸæ›²çº¿çš„æ‰0ï¼ŒåŸå› æ˜¯é…é€èµ°çš„æ˜¯å¼‚æ­¥æµç¨‹ï¼Œè™½ç„¶ä»æŸä¸ªæ—¶åˆ»å¼€å§‹ä¸‹å•å…¨éƒ¨å¤±è´¥äº†ï¼Œä½†æ˜¯MQé˜Ÿåˆ—ä¸­è¿˜æœ‰ä¸€äº›ä¹‹å‰æœªå¤„ç†çš„æ¶ˆæ¯ã€‚

![](https://static001.geekbang.org/resource/image/53/5b/536ce4dad0e8bc00aa6d9ad4ff285b5b.jpg?wh=2284%2A1285)

**ç¬¬ä¸‰ç§æƒ…å†µæ˜¯ï¼Œå°è¯•ä¸€ä¸‹å› ä¸ºå•†æˆ·ä¸è¥ä¸šå¯¼è‡´çš„ä¸‹å•å¤±è´¥**ï¼š

```
wrk -t 1 -c 1 -d 3600s http://localhost:45678/order/createOrder\?userId\=20\&merchantId\=1
```

æˆ‘æŠŠå˜åŒ–çš„åœ°æ–¹åœˆäº†å‡ºæ¥ï¼Œä½ å¯ä»¥è‡ªå·±å°è¯•åˆ†æä¸€ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/4c/d4/4cf8d97266f5063550e5db57e61c73d4.jpg?wh=3108%2A1754)

**ç¬¬å››ç§æƒ…å†µæ˜¯ï¼Œé…é€åœæ­¢**ã€‚æˆ‘ä»¬é€šè¿‡curlè°ƒç”¨æ¥å£ï¼Œæ¥è®¾ç½®é…é€åœæ­¢å¼€å…³ï¼š

```
curl -X POST 'http://localhost:45678/deliver/status?status=false'
```

ä»ç›‘æ§å¯ä»¥çœ‹åˆ°ï¼Œä»å¼€å…³å…³é—­é‚£åˆ»å¼€å§‹ï¼Œæ‰€æœ‰çš„é…é€æ¶ˆæ¯å…¨éƒ¨å¤„ç†å¤±è´¥äº†ï¼ŒåŸå› æ˜¯deliver outofserviceï¼Œé…é€æ“ä½œæ€§èƒ½ä»500mså·¦å³åˆ°äº†0msï¼Œè¯´æ˜é…é€å¤±è´¥æ˜¯ä¸€ä¸ªæœ¬åœ°å¿«é€Ÿå¤±è´¥ï¼Œå¹¶ä¸æ˜¯å› ä¸ºæœåŠ¡è¶…æ—¶ç­‰å¯¼è‡´çš„å¤±è´¥ã€‚è€Œä¸”è™½ç„¶é…é€å¤±è´¥ï¼Œä½†ä¸‹å•æ“ä½œéƒ½æ˜¯æ­£å¸¸çš„ï¼š

![](https://static001.geekbang.org/resource/image/c4/bc/c49bfce8682d382a04bd9dd8182534bc.jpg?wh=3076%2A1604)

æœ€åå¸Œæœ›è¯´çš„æ˜¯ï¼Œé™¤äº†æ‰‹åŠ¨æ·»åŠ ä¸šåŠ¡ç›‘æ§æŒ‡æ ‡å¤–ï¼ŒMicrometeræ¡†æ¶è¿˜å¸®æˆ‘ä»¬è‡ªåŠ¨åšäº†å¾ˆå¤šæœ‰å…³JVMå†…éƒ¨å„ç§æ•°æ®çš„æŒ‡æ ‡ã€‚è¿›å…¥InfluxDBå‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼Œä½ å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„è¿™äº›è¡¨ï¼ˆæŒ‡æ ‡ï¼‰ï¼Œå…¶ä¸­å‰8ä¸ªæ˜¯æˆ‘ä»¬è‡ªå·±å»ºçš„ä¸šåŠ¡æŒ‡æ ‡ï¼Œåé¢éƒ½æ˜¯æ¡†æ¶å¸®æˆ‘ä»¬å»ºçš„JVMã€å„ç§ç»„ä»¶çŠ¶æ€çš„æŒ‡æ ‡ï¼š

```
> USE mydb
Using database mydb
> SHOW MEASUREMENTS
name: measurements
name
----
createOrder_failed
createOrder_received
createOrder_success
createOrder_totalSuccess
deliverOrder_failed
deliverOrder_received
deliverOrder_success
deliverOrder_totalSuccess
hikaricp_connections
hikaricp_connections_acquire
hikaricp_connections_active
hikaricp_connections_creation
hikaricp_connections_idle
hikaricp_connections_max
hikaricp_connections_min
hikaricp_connections_pending
hikaricp_connections_timeout
hikaricp_connections_usage
http_server_requests
jdbc_connections_max
jdbc_connections_min
jvm_buffer_count
jvm_buffer_memory_used
jvm_buffer_total_capacity
jvm_classes_loaded
jvm_classes_unloaded
jvm_gc_live_data_size
jvm_gc_max_data_size
jvm_gc_memory_allocated
jvm_gc_memory_promoted
jvm_gc_pause
jvm_memory_committed
jvm_memory_max
jvm_memory_used
jvm_threads_daemon
jvm_threads_live
jvm_threads_peak
jvm_threads_states
logback_events
process_cpu_usage
process_files_max
process_files_open
process_start_time
process_uptime
rabbitmq_acknowledged
rabbitmq_acknowledged_published
rabbitmq_channels
rabbitmq_connections
rabbitmq_consumed
rabbitmq_failed_to_publish
rabbitmq_not_acknowledged_published
rabbitmq_published
rabbitmq_rejected
rabbitmq_unrouted_published
spring_rabbitmq_listener
system_cpu_count
system_cpu_usage
system_load_average_1m
tomcat_sessions_active_current
tomcat_sessions_active_max
tomcat_sessions_alive_max
tomcat_sessions_created
tomcat_sessions_expired
tomcat_sessions_rejected
```

æˆ‘ä»¬å¯ä»¥æŒ‰ç…§è‡ªå·±çš„éœ€æ±‚ï¼Œé€‰å–å…¶ä¸­çš„ä¸€äº›æŒ‡æ ‡ï¼Œåœ¨Grafanaä¸­é…ç½®åº”ç”¨ç›‘æ§é¢æ¿ï¼š

![](https://static001.geekbang.org/resource/image/13/e9/1378d9c6a66ea733cf08200d7f4b65e9.png?wh=2660%2A1386)

çœ‹åˆ°è¿™é‡Œï¼Œé€šè¿‡ç›‘æ§å›¾è¡¨æ¥å®šä½é—®é¢˜ï¼Œæ˜¯ä¸æ˜¯æ¯”æ—¥å¿—æ–¹ä¾¿äº†å¾ˆå¤šå‘¢ï¼Ÿ

## é‡ç‚¹å›é¡¾

ä»Šå¤©ï¼Œæˆ‘å’Œä½ ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨Spring Boot Actuaorå®ç°ç”Ÿäº§å°±ç»ªçš„å‡ ä¸ªå…³é”®ç‚¹ï¼ŒåŒ…æ‹¬å¥åº·æ£€æµ‹ã€æš´éœ²åº”ç”¨ä¿¡æ¯å’ŒæŒ‡æ ‡ç›‘æ§ã€‚

æ‰€è°“ç£¨åˆ€ä¸è¯¯ç æŸ´å·¥ï¼Œå¥åº·æ£€æµ‹å¯ä»¥å¸®æˆ‘ä»¬å®ç°è´Ÿè½½å‡è¡¡çš„è”åŠ¨ï¼›åº”ç”¨ä¿¡æ¯ä»¥åŠActuaoræä¾›çš„å„ç§ç«¯ç‚¹ï¼Œå¯ä»¥å¸®æˆ‘ä»¬æŸ¥çœ‹åº”ç”¨å†…éƒ¨æƒ…å†µï¼Œç”šè‡³å¯¹åº”ç”¨çš„ä¸€äº›å‚æ•°è¿›è¡Œè°ƒæ•´ï¼›è€ŒæŒ‡æ ‡ç›‘æ§ï¼Œåˆ™æœ‰åŠ©äºæˆ‘ä»¬æ•´ä½“è§‚å¯Ÿåº”ç”¨è¿è¡Œæƒ…å†µï¼Œå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå‘ç°å’Œå®šä½é—®é¢˜ã€‚

å…¶å®ï¼Œå®Œæ•´çš„åº”ç”¨ç›‘æ§ä½“ç³»ä¸€èˆ¬ç”±ä¸‰ä¸ªæ–¹é¢æ„æˆï¼ŒåŒ…æ‹¬æ—¥å¿—Loggingã€æŒ‡æ ‡Metricså’Œè¿½è¸ªTracingã€‚å…¶ä¸­ï¼Œæ—¥å¿—å’ŒæŒ‡æ ‡æˆ‘ç›¸ä¿¡ä½ åº”è¯¥å·²ç»æ¯”è¾ƒæ¸…æ¥šäº†ã€‚è¿½è¸ªä¸€èˆ¬ä¸æ¶‰åŠå¼€å‘å·¥ä½œå°±æ²¡æœ‰å±•å¼€é˜è¿°ï¼Œæˆ‘å’Œä½ ç®€å•ä»‹ç»ä¸€ä¸‹ã€‚

è¿½è¸ªä¹Ÿå«åšå…¨é“¾è·¯è¿½è¸ªï¼Œæ¯”è¾ƒæœ‰ä»£è¡¨æ€§çš„å¼€æºç³»ç»Ÿæ˜¯[SkyWalking](https://skywalking.apache.org/)å’Œ[Pinpoint](https://github.com/naver/pinpoint)ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œæ¥å…¥æ­¤ç±»ç³»ç»Ÿæ— éœ€é¢å¤–å¼€å‘ï¼Œä½¿ç”¨å…¶æä¾›çš„javaagentæ¥å¯åŠ¨Javaç¨‹åºï¼Œå°±å¯ä»¥é€šè¿‡åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç å®ç°å„ç§ç»„ä»¶çš„æ”¹å†™ï¼Œä»¥åŠ å…¥è¿½è¸ªä»£ç ï¼ˆç±»ä¼¼AOPï¼‰ã€‚

å…¨é“¾è·¯è¿½è¸ªçš„åŸç†æ˜¯ï¼š

1. è¯·æ±‚è¿›å…¥ç¬¬ä¸€ä¸ªç»„ä»¶æ—¶ï¼Œå…ˆç”Ÿæˆä¸€ä¸ªTraceIDï¼Œä½œä¸ºæ•´ä¸ªè°ƒç”¨é“¾ï¼ˆTraceï¼‰çš„å”¯ä¸€æ ‡è¯†ï¼›
2. å¯¹äºæ¯æ¬¡æ“ä½œï¼Œéƒ½è®°å½•è€—æ—¶å’Œç›¸å…³ä¿¡æ¯å½¢æˆä¸€ä¸ªSpanæŒ‚è½½åˆ°è°ƒç”¨é“¾ä¸Šï¼ŒSpanå’ŒSpanä¹‹é—´åŒæ ·å¯ä»¥å½¢æˆæ ‘çŠ¶å…³è”ï¼Œå‡ºç°è¿œç¨‹è°ƒç”¨ã€è·¨ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ï¼ŒæŠŠTraceIDè¿›è¡Œé€ä¼ ï¼ˆæ¯”å¦‚ï¼ŒHTTPè°ƒç”¨é€šè¿‡è¯·æ±‚é€ä¼ ï¼ŒMQæ¶ˆæ¯åˆ™é€šè¿‡æ¶ˆæ¯é€ä¼ ï¼‰ï¼›
3. æŠŠè¿™äº›æ•°æ®æ±‡æ€»æäº¤åˆ°æ•°æ®åº“ä¸­ï¼Œé€šè¿‡ä¸€ä¸ªUIç•Œé¢æŸ¥è¯¢æ•´ä¸ªæ ‘çŠ¶è°ƒç”¨é“¾ã€‚

åŒæ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šæŠŠTraceIDè®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œæ–¹ä¾¿å®ç°æ—¥å¿—å’Œè¿½è¸ªçš„å…³è”ã€‚

æˆ‘ç”¨ä¸€å¼ å›¾å¯¹æ¯”äº†æ—¥å¿—ã€æŒ‡æ ‡å’Œè¿½è¸ªçš„åŒºåˆ«å’Œç‰¹ç‚¹ï¼š

![](https://static001.geekbang.org/resource/image/85/4c/85cabd7ecb4c6a669ff2e8930a369c4c.jpg?wh=3251%2A1450)

åœ¨æˆ‘çœ‹æ¥ï¼Œå®Œå–„çš„ç›‘æ§ä½“ç³»ä¸‰è€…ç¼ºä¸€ä¸å¯ï¼Œå®ƒä»¬è¿˜å¯ä»¥ç›¸äº’é…åˆï¼Œæ¯”å¦‚é€šè¿‡æŒ‡æ ‡å‘ç°æ€§èƒ½é—®é¢˜ï¼Œé€šè¿‡è¿½è¸ªå®šä½æ€§èƒ½é—®é¢˜æ‰€åœ¨çš„åº”ç”¨å’Œæ“ä½œï¼Œæœ€åé€šè¿‡æ—¥å¿—å®šä½å‡ºå…·ä½“è¯·æ±‚çš„æ˜ç»†å‚æ•°ã€‚

ä»Šå¤©ç”¨åˆ°çš„ä»£ç ï¼Œæˆ‘éƒ½æ”¾åœ¨äº†GitHubä¸Šï¼Œä½ å¯ä»¥ç‚¹å‡»[è¿™ä¸ªé“¾æ¥](https://github.com/JosephZhu1983/java-common-mistakes)æŸ¥çœ‹ã€‚

## æ€è€ƒä¸è®¨è®º

1. Spring Boot Actuatoræä¾›äº†å¤§é‡å†…ç½®ç«¯ç‚¹ï¼Œä½ è§‰å¾—ç«¯ç‚¹å’Œè‡ªå®šä¹‰ä¸€ä¸ª@RestControlleræœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿä½ èƒ½å¦æ ¹æ®[å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready-endpoints-custom)ï¼Œå¼€å‘ä¸€ä¸ªè‡ªå®šä¹‰ç«¯ç‚¹å‘¢ï¼Ÿ
2. åœ¨ä»‹ç»æŒ‡æ ‡Metricsæ—¶æˆ‘ä»¬çœ‹åˆ°ï¼ŒInfluxDBä¸­ä¿å­˜äº†ç”±Micrometeræ¡†æ¶è‡ªåŠ¨å¸®æˆ‘ä»¬æ”¶é›†çš„ä¸€äº›åº”ç”¨æŒ‡æ ‡ã€‚ä½ èƒ½å¦å‚è€ƒæºç ä¸­ä¸¤ä¸ªGrafanaé…ç½®çš„JSONæ–‡ä»¶ï¼ŒæŠŠè¿™äº›æŒ‡æ ‡åœ¨Grafanaä¸­é…ç½®å‡ºä¸€ä¸ªå®Œæ•´çš„åº”ç”¨ç›‘æ§é¢æ¿å‘¢ï¼Ÿ

åº”ç”¨æŠ•äº§ä¹‹å‰ï¼Œä½ è¿˜ä¼šåšå“ªäº›ç”Ÿäº§å°±ç»ªæ–¹é¢çš„å·¥ä½œå‘¢ï¼Ÿæˆ‘æ˜¯æœ±æ™”ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºä¸æˆ‘ç•™è¨€åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ï¼Œä¸€èµ·äº¤æµã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ13ï¼‰</strong></div><ul>
<li><span>winner_0715</span> ğŸ‘ï¼ˆ16ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<p>æˆ‘æ˜¯è´å£³æ‰¾æˆ¿çš„ï¼Œæ‰€ä»¥çœ‹åˆ°è€å¸ˆçš„è¯¾ç¨‹æ„Ÿè§‰å¾ˆäº²åˆ‡ï¼Œæœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼Œåœ¨å‘ç¬¬ä¸‰æ–¹æä¾›æ¥å£çš„æ—¶å€™ï¼Œæ˜¯æä¾›RPCï¼ˆå¦‚Dubboï¼‰,è¿˜æ˜¯HTTPå‘¢ï¼Œéœ€è¦è€ƒè™‘å“ªäº›å› ç´ å‘¢</p>2020-05-10</li><br/><li><span>Darren</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š
	ç«¯ç‚¹ä¸@RestControllerï¼š
		@Endpointç›¸å½“äº@WebEndpointå’Œ@JmxEndpointçš„æ•´åˆã€‚webå’Œjmxæ–¹å¼éƒ½æ”¯æŒ
		@WebEndpoint å°±ç›¸å½“äºå£°æ˜æˆä¸€ä¸ª@RestControllerçš„æ§åˆ¶ç±»

		è¯·æ±‚æ–¹æ³•åˆ†åˆ«è¢«ä¸‹é¢æ³¨è§£ä»£æ›¿ï¼š
			@ReadOperationç­‰åŒäºGET
			@WriteOperationç­‰åŒäº	POST
			@DeleteOperationç­‰åŒäºDELETE

ç¬¬äºŒä¸ªé—®é¢˜å°±ä¸å›ç­”äº†ï¼ŒPrometheus+Grafanaæš‚æ—¶è¿˜æœªå…¥é—¨</p>2020-05-11</li><br/><li><span>ç»ˆç»“è€…999å·</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¦å¤–è¯·é—®è€å¸ˆï¼Œä¸‹å•çš„metricç°åœ¨æ˜¯åŒæ­¥åˆ°InfluxDbçš„ï¼Œåº”è¯¥ä¹Ÿå¯ä»¥åŒæ­¥åˆ°Prometheuså§</p>2020-05-17</li><br/><li><span>hellojd</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æŠ•äº§å‰ä¹Ÿè¦å®¹é‡è¯„ä¼°ï¼Œåšå¥½æµé‡ç¡®è®¤ï¼ŒåŠ ä¸Šé™æµæ¨¡å—ã€‚</p>2020-05-09</li><br/><li><span>ç»ˆç»“è€…999å·</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>æˆ‘æ˜¯ä½œä¸ºä¸€ä¸ªå¤®ä¼å…³é”®éƒ¨é—¨çš„å¼€å‘äººå‘˜ï¼Œå¯¹è€å¸ˆçš„è¿™èŠ‚è¯¾ç¨‹æ„Ÿè§‰å—ç›ŠåŒªæµ…ï¼Œæ¯æ¬¡å‡ºç°é—®é¢˜éƒ½æ˜¯å®¢æˆ·æŠ¥ç»™æˆ‘ä»¬æ•…éšœï¼Œæˆ‘ä»¬çš„zabbixä¸èƒ½å®Œæˆmetricçš„å·¥ä½œï¼Œæ‰€ä»¥ä¹Ÿæƒ³å¼•å…¥Prometheus.</p>2020-05-17</li><br/><li><span>å›å­æ„å¦‚ä½•</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆè¿™èŠ‚è¯¾éå¸¸æ¥åœ°æ°”ï¼ç›‘æ§ç³»ç»Ÿä¹Ÿä¼šå ç”¨éƒ¨åˆ†ç³»ç»Ÿèµ„æºï¼Œæ¯”å¦‚æˆ‘ä»¬çš„å®¢æˆ·è§‰å¾—è‡ªå·±å¾ˆæ‡‚è½¯ä»¶ï¼Œç»™æˆ‘ä»¬æŒ‡å®šäº†ç¡¬ä»¶é…ç½®ï¼Œè·‘æ­£å¸¸çš„ä¸šåŠ¡ç³»ç»Ÿéƒ½æ‰è¥Ÿè§è‚˜ï¼ŒåŠ ç›‘æ§åæ€§èƒ½æœ‰æ˜æ˜¾çš„ä¸‹é™ï¼ŒçœŸæ˜¯ç—›è‹¦ã€‚</p>2021-01-27</li><br/><li><span>è‹—</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼ŒæŒ‡æ ‡æ”¶é›†çš„ä»£ç ä¸€èˆ¬æ”¾åœ¨å“ªä¸€å±‚æ¯”è¾ƒåˆé€‚ï¼Ÿ</p>2020-09-08</li><br/><li><span>Michael</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è€å¸ˆï¼Œä½ å¥½ï¼
OrderController ä¸­çš„ä¸šåŠ¡ä»£ç ä¸­æ¶‰åŠå¤§é‡çš„æŒ‡æ ‡æ³¨å…¥ä»£ç ä¼šä¸ä¼šä¾µå…¥æ€§å¤ªå¼ºäº†ï¼Œè‹¥æ˜¯éœ€è¦ç›‘æ§çš„ä¸šåŠ¡æŒ‡æ ‡å¾ˆå¤šï¼Œä»£ç ä¸­æ¶‰åŠå¤§é‡çš„è¿™ç§Metrics.timer(&quot;deliverOrder.success&quot;).record(Duration.between(begin, Instant.now()));é‡‡é›†ä»£ç ï¼Œè§‰å¾—æœ‰ç‚¹ä¸å¤ªå¥½ï¼Œè¿˜æœ‰å…¶ä»–çš„æ–¹æ³•å˜›ï¼Ÿ</p>2020-06-24</li><br/><li><span>ç¨‹åºå‘˜å°è·ƒ</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æˆ‘çš„å¤©ï¼Œè¿™ç¯‡å¯¹äºåˆšå…¥åç«¯ä¸ä¹…çš„æˆ‘æ¥è¯´ï¼Œç®€ç›´äº†ï¼Œæ‰“å¼€æ–°ä¸–ç•Œçš„å¤§é—¨ä¸€æ ·ã€‚</p>2020-10-24</li><br/><li><span>Seven.Linæ¾¤è€¿</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç»ˆäºè¶Šæ¥è¶Šæ˜ç™½Spring Cloudä¸ºå•¥å«Cloudäº†ï¼Œå¼ºå¤§</p>2020-05-12</li><br/><li><span>Jerry Wu</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>çœ‹æ¥è¦æƒ³æƒ³åŠæ³•ï¼Œå¤šæ¥è§¦äº›æŠ€æœ¯æ€§æ›´å¼ºçš„é¡¹ç›®äº†ã€‚è¿™å‡ èŠ‚è¯¾çš„å†…å®¹éƒ½æ²¡æ¥è§¦è¿‡ï¼Œè¯»èµ·æ¥å¾ˆåƒåŠ›ã€‚</p>2020-05-12</li><br/><li><span>é²é¸£</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>å°è¯•äº†ä¸€ä¸‹influxDB2.0ï¼Œéœ€è¦å®¢æˆ·ç«¯ä½¿ç”¨tokenè¿›è¡Œé‰´æƒï¼Œspring booté‡Œé¢çš„é…ç½®æš‚æ—¶æ— æ³•ç”Ÿæ•ˆäº†</p>2021-01-24</li><br/><li><span>ç§‹å¤©</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>é—®ä¸€ä¸‹è€å¸ˆï¼Œç°åœ¨ springbooåº”ç”¨çš„ä¸€äº› controlelr æ¥å£å¯ç”¨æ€§ç›‘æ§å’ŒæŠ¥è­¦ï¼Œåº”è¯¥ç”¨å“ªä¸ªæ¯”è¾ƒå¥½å•Šï¼Ÿ</p>2022-06-08</li><br/>
</ul>