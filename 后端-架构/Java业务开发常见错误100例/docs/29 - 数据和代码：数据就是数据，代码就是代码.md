ä½ å¥½ï¼Œæˆ‘æ˜¯æœ±æ™”ã€‚ä»Šå¤©ï¼Œæˆ‘æ¥å’Œä½ èŠèŠæ•°æ®å’Œä»£ç çš„é—®é¢˜ã€‚

æ­£å¦‚è¿™ä¸€è®²æ ‡é¢˜â€œæ•°æ®å°±æ˜¯æ•°æ®ï¼Œä»£ç å°±æ˜¯ä»£ç â€æ‰€è¯´ï¼ŒWebå®‰å…¨æ–¹é¢çš„å¾ˆå¤šæ¼æ´ï¼Œéƒ½æ˜¯æºè‡ªæŠŠæ•°æ®å½“æˆäº†ä»£ç æ¥æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æ³¨å…¥ç±»é—®é¢˜ï¼Œæ¯”å¦‚ï¼š

- å®¢æˆ·ç«¯æä¾›ç»™æœåŠ¡ç«¯çš„æŸ¥è¯¢å€¼ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®ï¼Œä¼šæˆä¸ºSQLæŸ¥è¯¢çš„ä¸€éƒ¨åˆ†ã€‚é»‘å®¢é€šè¿‡ä¿®æ”¹è¿™ä¸ªå€¼æ³¨å…¥ä¸€äº›SQLï¼Œæ¥è¾¾åˆ°åœ¨æœåŠ¡ç«¯è¿è¡ŒSQLçš„ç›®çš„ï¼Œç›¸å½“äºæŠŠæŸ¥è¯¢æ¡ä»¶çš„æ•°æ®å˜ä¸ºäº†æŸ¥è¯¢ä»£ç ã€‚è¿™ç§æ”»å‡»æ–¹å¼ï¼Œå«åšSQLæ³¨å…¥ã€‚
- å¯¹äºè§„åˆ™å¼•æ“ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç”¨åŠ¨æ€è¯­è¨€åšä¸€äº›è®¡ç®—ï¼Œå’ŒSQLæ³¨å…¥ä¸€æ ·å¤–éƒ¨ä¼ å…¥çš„æ•°æ®åªèƒ½å½“åšæ•°æ®ä½¿ç”¨ï¼Œå¦‚æœè¢«é»‘å®¢åˆ©ç”¨ä¼ å…¥äº†ä»£ç ï¼Œé‚£ä¹ˆä»£ç å¯èƒ½å°±ä¼šè¢«åŠ¨æ€æ‰§è¡Œã€‚è¿™ç§æ”»å‡»æ–¹å¼ï¼Œå«åšä»£ç æ³¨å…¥ã€‚
- å¯¹äºç”¨æˆ·æ³¨å†Œã€ç•™è¨€è¯„è®ºç­‰åŠŸèƒ½ï¼ŒæœåŠ¡ç«¯ä¼šä»å®¢æˆ·ç«¯æ”¶é›†ä¸€äº›ä¿¡æ¯ï¼Œæœ¬æ¥ç”¨æˆ·åã€é‚®ç®±è¿™ç±»ä¿¡æ¯æ˜¯çº¯æ–‡æœ¬ä¿¡æ¯ï¼Œä½†æ˜¯é»‘å®¢æŠŠä¿¡æ¯æ›¿æ¢ä¸ºäº†JavaScriptä»£ç ã€‚é‚£ä¹ˆï¼Œè¿™äº›ä¿¡æ¯åœ¨é¡µé¢å‘ˆç°æ—¶ï¼Œå¯èƒ½å°±ç›¸å½“äºæ‰§è¡Œäº†JavaScriptä»£ç ã€‚ç”šè‡³æ˜¯ï¼ŒæœåŠ¡ç«¯å¯èƒ½æŠŠè¿™æ ·çš„ä»£ç ï¼Œå½“ä½œæ™®é€šä¿¡æ¯ä¿å­˜åˆ°äº†æ•°æ®åº“ã€‚é»‘å®¢é€šè¿‡æ„å»ºJavaScriptä»£ç æ¥å®ç°ä¿®æ”¹é¡µé¢å‘ˆç°ã€ç›—å–ä¿¡æ¯ï¼Œç”šè‡³è •è™«æ”»å‡»çš„æ–¹å¼ï¼Œå«åšXSSï¼ˆè·¨ç«™è„šæœ¬ï¼‰æ”»å‡»ã€‚

ä»Šå¤©ï¼Œæˆ‘ä»¬å°±é€šè¿‡æ¡ˆä¾‹æ¥çœ‹ä¸€ä¸‹è¿™ä¸‰ä¸ªé—®é¢˜ï¼Œå¹¶äº†è§£ä¸‹åº”å¯¹æ–¹å¼ã€‚

## SQLæ³¨å…¥èƒ½å¹²çš„äº‹æƒ…æ¯”ä½ æƒ³è±¡çš„æ›´å¤š

æˆ‘ä»¬åº”è¯¥éƒ½å¬è¯´è¿‡SQLæ³¨å…¥ï¼Œä¹Ÿå¯èƒ½çŸ¥é“æœ€ç»å…¸çš„SQLæ³¨å…¥çš„ä¾‹å­ï¼Œæ˜¯é€šè¿‡æ„é€ â€™orâ€™1â€™='1ä½œä¸ºå¯†ç å®ç°ç™»å½•ã€‚è¿™ç§ç®€å•çš„æ”»å‡»æ–¹å¼ï¼Œåœ¨åå‡ å¹´å‰å¯ä»¥çªç ´å¾ˆå¤šåå°çš„ç™»å½•ï¼Œä½†ç°åœ¨å¾ˆéš¾å¥æ•ˆäº†ã€‚

æœ€è¿‘å‡ å¹´ï¼Œæˆ‘ä»¬çš„å®‰å…¨æ„è¯†å¢å¼ºäº†ï¼Œéƒ½çŸ¥é“ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢æ¥é¿å…SQLæ³¨å…¥é—®é¢˜ã€‚å…¶ä¸­çš„åŸç†æ˜¯ï¼Œä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢çš„è¯ï¼Œå‚æ•°åªèƒ½ä½œä¸ºæ™®é€šæ•°æ®ï¼Œä¸å¯èƒ½ä½œä¸ºSQLçš„ä¸€éƒ¨åˆ†ï¼Œä»¥æ­¤æœ‰æ•ˆé¿å…SQLæ³¨å…¥é—®é¢˜ã€‚

è™½ç„¶æˆ‘ä»¬å·²ç»å¼€å§‹å…³æ³¨SQLæ³¨å…¥çš„é—®é¢˜ï¼Œä½†è¿˜æ˜¯æœ‰ä¸€äº›è®¤çŸ¥ä¸Šçš„è¯¯åŒºï¼Œä¸»è¦è¡¨ç°åœ¨ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š

ç¬¬ä¸€ï¼Œ**è®¤ä¸ºSQLæ³¨å…¥é—®é¢˜åªå¯èƒ½å‘ç”ŸäºHttp Getè¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡URLä¼ å…¥çš„å‚æ•°æ‰å¯èƒ½äº§ç”Ÿæ³¨å…¥ç‚¹**ã€‚è¿™æ˜¯å¾ˆå±é™©çš„æƒ³æ³•ã€‚ä»æ³¨å…¥çš„éš¾æ˜“åº¦ä¸Šæ¥è¯´ï¼Œä¿®æ”¹URLä¸Šçš„QueryStringå’Œä¿®æ”¹Postè¯·æ±‚ä½“ä¸­çš„æ•°æ®ï¼Œæ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œå› ä¸ºé»‘å®¢æ˜¯é€šè¿‡å·¥å…·æ¥æ³¨å…¥çš„ï¼Œè€Œä¸æ˜¯é€šè¿‡ä¿®æ”¹æµè§ˆå™¨ä¸Šçš„URLæ¥æ³¨å…¥çš„ã€‚ç”šè‡³Cookieéƒ½å¯ä»¥ç”¨æ¥SQLæ³¨å…¥ï¼Œä»»ä½•æä¾›æ•°æ®çš„åœ°æ–¹éƒ½å¯èƒ½æˆä¸ºæ³¨å…¥ç‚¹ã€‚

ç¬¬äºŒï¼Œ**è®¤ä¸ºä¸è¿”å›æ•°æ®çš„æ¥å£ï¼Œä¸å¯èƒ½å­˜åœ¨æ³¨å…¥é—®é¢˜**ã€‚å…¶å®ï¼Œé»‘å®¢å®Œå…¨å¯ä»¥åˆ©ç”¨SQLè¯­å¥æ„é€ å‡ºä¸€äº›ä¸æ­£ç¡®çš„SQLï¼Œå¯¼è‡´æ‰§è¡Œå‡ºé”™ã€‚å¦‚æœæœåŠ¡ç«¯ç›´æ¥æ˜¾ç¤ºäº†é”™è¯¯ä¿¡æ¯ï¼Œé‚£é»‘å®¢éœ€è¦çš„æ•°æ®å°±æœ‰å¯èƒ½è¢«å¸¦å‡ºæ¥ï¼Œä»è€Œè¾¾åˆ°æŸ¥è¯¢æ•°æ®çš„ç›®çš„ã€‚ç”šè‡³æ˜¯ï¼Œå³ä½¿æ²¡æœ‰è¯¦ç»†çš„å‡ºé”™ä¿¡æ¯ï¼Œé»‘å®¢ä¹Ÿå¯ä»¥é€šè¿‡æ‰€è°“ç›²æ³¨çš„æ–¹å¼è¿›è¡Œæ”»å‡»ã€‚æˆ‘åé¢å†å…·ä½“è§£é‡Šã€‚

ç¬¬ä¸‰ï¼Œ**è®¤ä¸ºSQLæ³¨å…¥çš„å½±å“èŒƒå›´ï¼Œåªæ˜¯é€šè¿‡çŸ­è·¯å®ç°çªç ´ç™»å½•ï¼Œåªéœ€è¦ç™»å½•æ“ä½œåŠ å¼ºé˜²èŒƒå³å¯**ã€‚é¦–å…ˆï¼ŒSQLæ³¨å…¥å®Œå…¨å¯ä»¥å®ç°æ‹–åº“ï¼Œä¹Ÿå°±æ˜¯ä¸‹è½½æ•´ä¸ªæ•°æ®åº“çš„å†…å®¹ï¼ˆä¹‹åæˆ‘ä»¬ä¼šæ¼”ç¤ºï¼‰ï¼ŒSQLæ³¨å…¥çš„å±å®³ä¸ä»…ä»…æ˜¯çªç ´åå°ç™»å½•ã€‚å…¶æ¬¡ï¼Œæ ¹æ®æœ¨æ¡¶åŸç†ï¼Œæ•´ä¸ªç«™ç‚¹çš„å®‰å…¨æ€§å—é™äºå®‰å…¨çº§åˆ«æœ€ä½çš„é‚£å—çŸ­æ¿ã€‚å› æ­¤ï¼Œå¯¹äºå®‰å…¨é—®é¢˜ï¼Œç«™ç‚¹çš„æ‰€æœ‰æ¨¡å—å¿…é¡»ä¸€è§†åŒä»ï¼Œå¹¶ä¸æ˜¯åªåŠ å¼ºé˜²èŒƒæ‰€è°“çš„é‡ç‚¹æ¨¡å—ã€‚

åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œè™½ç„¶æˆ‘ä»¬æ˜¯ä½¿ç”¨æ¡†æ¶æ¥è¿›è¡Œæ•°æ®è®¿é—®çš„ï¼Œä½†è¿˜å¯èƒ½ä¼šå› ä¸ºç–æ¼è€Œå¯¼è‡´æ³¨å…¥é—®é¢˜ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°±ç”¨ä¸€ä¸ªå®é™…çš„ä¾‹å­é…åˆä¸“ä¸šçš„SQLæ³¨å…¥å·¥å…·[sqlmap](https://github.com/sqlmapproject/sqlmap)ï¼Œæ¥æµ‹è¯•ä¸‹SQLæ³¨å…¥ã€‚

é¦–å…ˆï¼Œåœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™ä½¿ç”¨JdbcTemplateåˆ›å»ºä¸€ä¸ªuserdataè¡¨ï¼ˆè¡¨ä¸­åªæœ‰IDã€ç”¨æˆ·åã€å¯†ç ä¸‰åˆ—ï¼‰ï¼Œå¹¶åˆå§‹åŒ–ä¸¤æ¡ç”¨æˆ·ä¿¡æ¯ã€‚ç„¶åï¼Œåˆ›å»ºä¸€ä¸ªä¸è¿”å›ä»»ä½•æ•°æ®çš„Http Postæ¥å£ã€‚åœ¨å®ç°ä¸Šï¼Œæˆ‘ä»¬é€šè¿‡SQLæ‹¼æ¥çš„æ–¹å¼ï¼ŒæŠŠä¼ å…¥çš„ç”¨æˆ·åå…¥å‚æ‹¼æ¥åˆ°LIKEå­å¥ä¸­å®ç°æ¨¡ç³ŠæŸ¥è¯¢ã€‚

```
//ç¨‹åºå¯åŠ¨æ—¶è¿›è¡Œè¡¨ç»“æ„å’Œæ•°æ®åˆå§‹åŒ–
@PostConstruct
public void init() {
    //åˆ é™¤è¡¨
    jdbcTemplate.execute("drop table IF EXISTS `userdata`;");
    //åˆ›å»ºè¡¨ï¼Œä¸åŒ…å«è‡ªå¢IDã€ç”¨æˆ·åã€å¯†ç ä¸‰åˆ—
    jdbcTemplate.execute("create TABLE `userdata` (\n" +
            "  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n" +
            "  `name` varchar(255) NOT NULL,\n" +
            "  `password` varchar(255) NOT NULL,\n" +
            "  PRIMARY KEY (`id`)\n" +
            ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;");
    //æ’å…¥ä¸¤æ¡æµ‹è¯•æ•°æ®
    jdbcTemplate.execute("INSERT INTO `userdata` (name,password) VALUES ('test1','haha1'),('test2','haha2')");
}
@Autowired
private JdbcTemplate jdbcTemplate;

//ç”¨æˆ·æ¨¡ç³Šæœç´¢æ¥å£
@PostMapping("jdbcwrong")
public void jdbcwrong(@RequestParam("name") String name) {
    //é‡‡ç”¨æ‹¼æ¥SQLçš„æ–¹å¼æŠŠå§“åå‚æ•°æ‹¼åˆ°LIKEå­å¥ä¸­
    log.info("{}", jdbcTemplate.queryForList("SELECT id,name FROM userdata WHERE name LIKE '%" + name + "%'"));
}
```

ä½¿ç”¨sqlmapæ¥æ¢ç´¢è¿™ä¸ªæ¥å£ï¼š

```
python sqlmap.py -u  http://localhost:45678/sqlinject/jdbcwrong --data name=test
```

ä¸€æ®µæ—¶é—´åï¼Œsqlmapç»™å‡ºäº†å¦‚ä¸‹ç»“æœï¼š

![](https://static001.geekbang.org/resource/image/2f/59/2f8e8530dd0f76778c45333adfad5259.png?wh=2605%2A1316)

å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ¥å£çš„nameå‚æ•°æœ‰ä¸¤ç§å¯èƒ½çš„æ³¨å…¥æ–¹å¼ï¼šä¸€ç§æ˜¯æŠ¥é”™æ³¨å…¥ï¼Œä¸€ç§æ˜¯åŸºäºæ—¶é—´çš„ç›²æ³¨ã€‚

æ¥ä¸‹æ¥ï¼Œ**ä»…éœ€ç®€å•çš„ä¸‰æ­¥ï¼Œå°±å¯ä»¥ç›´æ¥å¯¼å‡ºæ•´ä¸ªç”¨æˆ·è¡¨çš„å†…å®¹äº†**ã€‚

ç¬¬ä¸€æ­¥ï¼ŒæŸ¥è¯¢å½“å‰æ•°æ®åº“ï¼š

```
python sqlmap.py -u  http://localhost:45678/sqlinject/jdbcwrong --data name=test --current-db
```

å¯ä»¥å¾—åˆ°å½“å‰æ•°æ®åº“æ˜¯common\_mistakesï¼š

```
current database: 'common_mistakes'
```

ç¬¬äºŒæ­¥ï¼ŒæŸ¥è¯¢æ•°æ®åº“ä¸‹çš„è¡¨ï¼š

```
python sqlmap.py -u  http://localhost:45678/sqlinject/jdbcwrong --data name=test --tables -D "common_mistakes"
```

å¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰ä¸€ä¸ªæ•æ„Ÿè¡¨userdataï¼š

```
Database: common_mistakes
[7 tables]
+--------------------+
| user               |
| common_store       |
| hibernate_sequence |
| m                  |
| news               |
| r                  |
| userdata           |
+--------------------+
```

ç¬¬ä¸‰æ­¥ï¼ŒæŸ¥è¯¢userdataçš„æ•°æ®ï¼š

```
python sqlmap.py -u  http://localhost:45678/sqlinject/jdbcwrong --data name=test -D "common_mistakes" -T "userdata" --dump
```

ä½ çœ‹ï¼Œ**ç”¨æˆ·å¯†ç ä¿¡æ¯ä¸€è§ˆæ— é—ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ç»§ç»­æŸ¥çœ‹å…¶ä»–è¡¨çš„æ•°æ®**ï¼š

```
Database: common_mistakes
Table: userdata
[2 entries]
+----+-------+----------+
| id | name  | password |
+----+-------+----------+
| 1  | test1 | haha1    |
| 2  | test2 | haha2    |
+----+-------+----------+
```

åœ¨æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ï¼Œsqlmapå®ç°æ‹–åº“çš„æ–¹å¼æ˜¯ï¼Œè®©SQLæ‰§è¡Œåçš„å‡ºé”™ä¿¡æ¯åŒ…å«å­—æ®µå†…å®¹ã€‚æ³¨æ„çœ‹ä¸‹é”™è¯¯æ—¥å¿—çš„ç¬¬äºŒè¡Œï¼Œé”™è¯¯ä¿¡æ¯ä¸­åŒ…å«IDä¸º2çš„ç”¨æˆ·çš„å¯†ç å­—æ®µçš„å€¼â€œhaha2â€ã€‚è¿™ï¼Œå°±æ˜¯æŠ¥é”™æ³¨å…¥çš„åŸºæœ¬åŸç†ï¼š

```
[13:22:27.375] [http-nio-45678-exec-10] [ERROR] [o.a.c.c.C.[.[.[/].[dispatcherServlet]:175 ] - Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is org.springframework.dao.DuplicateKeyException: StatementCallback; SQL [SELECT id,name FROM userdata WHERE name LIKE '%test'||(SELECT 0x694a6e64 WHERE 3941=3941 AND (SELECT 9927 FROM(SELECT COUNT(*),CONCAT(0x71626a7a71,(SELECT MID((IFNULL(CAST(password AS NCHAR),0x20)),1,54) FROM common_mistakes.userdata ORDER BY id LIMIT 1,1),0x7170706271,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a))||'%']; Duplicate entry 'qbjzqhaha2qppbq1' for key '<group_key>'; nested exception is java.sql.SQLIntegrityConstraintViolationException: Duplicate entry 'qbjzqhaha2qppbq1' for key '<group_key>'] with root cause
java.sql.SQLIntegrityConstraintViolationException: Duplicate entry 'qbjzqhaha2qppbq1' for key '<group_key>'
```

æ—¢ç„¶æ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®ç°ä¸€ä¸ªExceptionHandleræ¥å±è”½å¼‚å¸¸ï¼Œçœ‹çœ‹èƒ½å¦è§£å†³æ³¨å…¥é—®é¢˜ï¼š

```
@ExceptionHandler
public void handle(HttpServletRequest req, HandlerMethod method, Exception ex) {
    log.warn(String.format("è®¿é—® %s -> %s å‡ºç°å¼‚å¸¸ï¼", req.getRequestURI(), method.toString()), ex);
}
```

é‡å¯ç¨‹åºåé‡æ–°è¿è¡Œåˆšæ‰çš„sqlmapå‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°æŠ¥é”™æ³¨å…¥æ˜¯æ²¡æˆäº†ï¼Œä½†ä½¿ç”¨æ—¶é—´ç›²æ³¨è¿˜æ˜¯å¯ä»¥æŸ¥è¯¢æ•´ä¸ªè¡¨çš„æ•°æ®ï¼š

![](https://static001.geekbang.org/resource/image/76/c4/76ec4c2217cc5ac190b578e7236dc9c4.png?wh=2512%2A1450)

æ‰€è°“ç›²æ³¨ï¼ŒæŒ‡çš„æ˜¯æ³¨å…¥åå¹¶ä¸èƒ½ä»æœåŠ¡å™¨å¾—åˆ°ä»»ä½•æ‰§è¡Œç»“æœï¼ˆç”šè‡³æ˜¯é”™è¯¯ä¿¡æ¯ï¼‰ï¼Œåªèƒ½å¯„å¸Œæœ›æœåŠ¡å™¨å¯¹äºSQLä¸­çš„çœŸå‡æ¡ä»¶è¡¨ç°å‡ºä¸åŒçš„çŠ¶æ€ã€‚æ¯”å¦‚ï¼Œå¯¹äºå¸ƒå°”ç›²æ³¨æ¥è¯´ï¼Œå¯èƒ½æ˜¯â€œçœŸâ€å¯ä»¥å¾—åˆ°200çŠ¶æ€ç ï¼Œâ€œå‡â€å¯ä»¥å¾—åˆ°500é”™è¯¯çŠ¶æ€ç ï¼›æˆ–è€…ï¼Œâ€œçœŸâ€å¯ä»¥å¾—åˆ°å†…å®¹è¾“å‡ºï¼Œâ€œå‡â€å¾—ä¸åˆ°ä»»ä½•è¾“å‡ºã€‚æ€»ä¹‹ï¼Œå¯¹äºä¸åŒçš„SQLæ³¨å…¥å¯ä»¥å¾—åˆ°ä¸åŒçš„è¾“å‡ºå³å¯ã€‚

åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œå› ä¸ºæ¥å£æ²¡æœ‰è¾“å‡ºï¼Œä¹Ÿå½»åº•å±è”½äº†é”™è¯¯ï¼Œå¸ƒå°”ç›²æ³¨è¿™æ‹›å„¿è¡Œä¸é€šäº†ã€‚é‚£ä¹ˆé€€è€Œæ±‚å…¶æ¬¡çš„æ–¹å¼ï¼Œå°±æ˜¯æ—¶é—´ç›²æ³¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé€šè¿‡åœ¨çœŸå‡æ¡ä»¶ä¸­åŠ å…¥SLEEPï¼Œæ¥å®ç°é€šè¿‡åˆ¤æ–­æ¥å£çš„å“åº”æ—¶é—´ï¼ŒçŸ¥é“æ¡ä»¶çš„ç»“æœæ˜¯çœŸè¿˜æ˜¯å‡ã€‚

ä¸ç®¡æ˜¯ä»€ä¹ˆç›²æ³¨ï¼Œéƒ½æ˜¯é€šè¿‡çœŸå‡ä¸¤ç§çŠ¶æ€æ¥å®Œæˆçš„ã€‚ä½ å¯èƒ½ä¼šå¥½å¥‡ï¼Œé€šè¿‡çœŸå‡ä¸¤ç§çŠ¶æ€å¦‚ä½•å®ç°æ•°æ®å¯¼å‡ºï¼Ÿ

å…¶å®ä½ å¯ä»¥æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬è™½ç„¶ä¸èƒ½ç›´æ¥æŸ¥è¯¢å‡ºpasswordå­—æ®µçš„å€¼ï¼Œä½†å¯ä»¥æŒ‰å­—ç¬¦é€ä¸€æ¥æŸ¥ï¼Œåˆ¤æ–­ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯å¦æ˜¯aã€æ˜¯å¦æ˜¯bâ€¦â€¦ï¼ŒæŸ¥è¯¢åˆ°hæ—¶å‘ç°å“åº”å˜æ…¢äº†ï¼Œè‡ªç„¶çŸ¥é“è¿™å°±æ˜¯çœŸçš„ï¼Œå¾—å‡ºç¬¬ä¸€ä½å°±æ˜¯hã€‚ä»¥æ­¤ç±»æ¨ï¼Œå¯ä»¥æŸ¥è¯¢å‡ºæ•´ä¸ªå€¼ã€‚

æ‰€ä»¥ï¼Œsqlmapåœ¨è¿”å›æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦è·³å‡ºç»“æœçš„ï¼Œå¹¶ä¸”æ—¶é—´ç›²æ³¨çš„æ•´ä¸ªè¿‡ç¨‹ä¼šæ¯”æŠ¥é”™æ³¨å…¥æ…¢è®¸å¤šã€‚

ä½ å¯ä»¥å¼•å…¥[p6spy](https://github.com/p6spy/p6spy)å·¥å…·æ‰“å°å‡ºæ‰€æœ‰æ‰§è¡Œçš„SQLï¼Œè§‚å¯Ÿsqlmapæ„é€ çš„ä¸€äº›SQLï¼Œæ¥åˆ†æå…¶ä¸­åŸç†ï¼š

```
<dependency>
    <groupId>com.github.gavlyukovskiy</groupId>
    <artifactId>p6spy-spring-boot-starter</artifactId>
    <version>1.6.1</version>
</dependency>
```

![](https://static001.geekbang.org/resource/image/5d/0d/5d9a582025bb06adf863ae21ccb9280d.png?wh=3048%2A1142)

æ‰€ä»¥è¯´ï¼Œå³ä½¿å±è”½é”™è¯¯ä¿¡æ¯é”™è¯¯ç ï¼Œä¹Ÿä¸èƒ½å½»åº•é˜²æ­¢SQLæ³¨å…¥ã€‚çœŸæ­£çš„è§£å†³æ–¹å¼ï¼Œè¿˜æ˜¯ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œè®©ä»»ä½•å¤–éƒ¨è¾“å…¥å€¼åªå¯èƒ½ä½œä¸ºæ•°æ®æ¥å¤„ç†ã€‚

æ¯”å¦‚ï¼Œå¯¹äºä¹‹å‰é‚£ä¸ªæ¥å£ï¼Œ**åœ¨SQLè¯­å¥ä¸­ä½¿ç”¨â€œ?â€ä½œä¸ºå‚æ•°å ä½ç¬¦ï¼Œç„¶åæä¾›å‚æ•°å€¼ã€‚**è¿™æ ·ä¿®æ”¹åï¼Œsqlmapä¹Ÿå°±æ— èƒ½ä¸ºåŠ›äº†ï¼š

```
@PostMapping("jdbcright")
public void jdbcright(@RequestParam("name") String name) {
    log.info("{}", jdbcTemplate.queryForList("SELECT id,name FROM userdata WHERE name LIKE ?", "%" + name + "%"));
}
```

**å¯¹äºMyBatisæ¥è¯´ï¼ŒåŒæ ·éœ€è¦ä½¿ç”¨å‚æ•°åŒ–çš„æ–¹å¼æ¥å†™SQLè¯­å¥ã€‚åœ¨MyBatisä¸­ï¼Œâ€œ#{}â€æ˜¯å‚æ•°åŒ–çš„æ–¹å¼ï¼Œâ€œ${}â€åªæ˜¯å ä½ç¬¦æ›¿æ¢ã€‚**

æ¯”å¦‚LIKEè¯­å¥ã€‚å› ä¸ºä½¿ç”¨â€œ#{}â€ä¼šä¸ºå‚æ•°å¸¦ä¸Šå•å¼•å·ï¼Œå¯¼è‡´LIKEè¯­æ³•é”™è¯¯ï¼Œæ‰€ä»¥ä¸€äº›åŒå­¦ä¼šé€€è€Œæ±‚å…¶æ¬¡ï¼Œé€‰æ‹©â€œ${}â€çš„æ–¹å¼ï¼Œæ¯”å¦‚ï¼š

```
@Select("SELECT id,name FROM `userdata` WHERE name LIKE '%${name}%'")
List<UserData> findByNameWrong(@Param("name") String name);
```

ä½ å¯ä»¥å°è¯•ä¸€ä¸‹ï¼Œä½¿ç”¨sqlmapåŒæ ·å¯ä»¥å®ç°æ³¨å…¥ã€‚æ­£ç¡®çš„åšæ³•æ˜¯ï¼Œä½¿ç”¨â€œ#{}â€æ¥å‚æ•°åŒ–nameå‚æ•°ï¼Œå¯¹äºLIKEæ“ä½œå¯ä»¥ä½¿ç”¨CONCATå‡½æ•°æ¥æ‹¼æ¥%ç¬¦å·ï¼š

```
@Select("SELECT id,name FROM `userdata` WHERE name LIKE CONCAT('%',#{name},'%')")
List<UserData> findByNameRight(@Param("name") String name);
```

åˆæ¯”å¦‚INå­å¥ã€‚å› ä¸ºæ¶‰åŠå¤šä¸ªå…ƒç´ çš„æ‹¼æ¥ï¼Œä¸€äº›åŒå­¦ä¸çŸ¥é“å¦‚ä½•å¤„ç†ï¼Œä¹Ÿå¯èƒ½ä¼šé€‰æ‹©ä½¿ç”¨â€œ${}â€ã€‚å› ä¸ºä½¿ç”¨â€œ#{}â€ä¼šæŠŠè¾“å…¥å½“åšä¸€ä¸ªå­—ç¬¦ä¸²æ¥å¯¹å¾…ï¼š

```
<select id="findByNamesWrong" resultType="org.geekbang.time.commonmistakes.codeanddata.sqlinject.UserData">
    SELECT id,name FROM `userdata` WHERE name in (${names})
</select>
```

ä½†æ˜¯ï¼Œè¿™æ ·ç›´æ¥æŠŠå¤–éƒ¨ä¼ å…¥çš„å†…å®¹æ›¿æ¢åˆ°INå†…éƒ¨ï¼ŒåŒæ ·ä¼šæœ‰æ³¨å…¥æ¼æ´ï¼š

```
@PostMapping("mybatiswrong2")
public List mybatiswrong2(@RequestParam("names") String names) {
    return userDataMapper.findByNamesWrong(names);
}
```

ä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™æ¡å‘½ä»¤æµ‹è¯•ä¸‹ï¼š

```
python sqlmap.py -u  http://localhost:45678/sqlinject/mybatiswrong2 --data names="'test1','test2'"
```

æœ€åå¯ä»¥å‘ç°ï¼Œæœ‰4ç§å¯è¡Œçš„æ³¨å…¥æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯å¸ƒå°”ç›²æ³¨ã€æŠ¥é”™æ³¨å…¥ã€æ—¶é—´ç›²æ³¨å’Œè”åˆæŸ¥è¯¢æ³¨å…¥ï¼š

![](https://static001.geekbang.org/resource/image/bd/d3/bdc7a7bcb34b59396f4a99d62425d6d3.png?wh=2606%2A704)

ä¿®æ”¹æ–¹å¼æ˜¯ï¼Œç»™MyBatisä¼ å…¥ä¸€ä¸ªListï¼Œç„¶åä½¿ç”¨å…¶foreachæ ‡ç­¾æ¥æ‹¼æ¥å‡ºINä¸­çš„å†…å®¹ï¼Œå¹¶ç¡®ä¿INä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯ä½¿ç”¨â€œ#{}â€æ¥æ³¨å…¥å‚æ•°ï¼š

```
@PostMapping("mybatisright2")
public List mybatisright2(@RequestParam("names") List<String> names) {
    return userDataMapper.findByNamesRight(names);
}

<select id="findByNamesRight" resultType="org.geekbang.time.commonmistakes.codeanddata.sqlinject.UserData">
    SELECT id,name FROM `userdata` WHERE name in
    <foreach collection="names" item="item" open="(" separator="," close=")">
        #{item}
    </foreach>
</select>
```

ä¿®æ”¹åè¿™ä¸ªæ¥å£å°±ä¸ä¼šè¢«æ³¨å…¥äº†ï¼Œä½ å¯ä»¥è‡ªè¡Œæµ‹è¯•ä¸€ä¸‹ã€‚

## å°å¿ƒåŠ¨æ€æ‰§è¡Œä»£ç æ—¶ä»£ç æ³¨å…¥æ¼æ´

æ€»ç»“ä¸‹ï¼Œæˆ‘ä»¬åˆšåˆšçœ‹åˆ°çš„SQLæ³¨å…¥æ¼æ´çš„åŸå› æ˜¯ï¼Œé»‘å®¢æŠŠSQLæ”»å‡»ä»£ç é€šè¿‡ä¼ å‚æ··å…¥SQLè¯­å¥ä¸­æ‰§è¡Œã€‚åŒæ ·ï¼Œå¯¹äºä»»ä½•è§£é‡Šæ‰§è¡Œçš„å…¶ä»–è¯­è¨€ä»£ç ï¼Œä¹Ÿå¯ä»¥äº§ç”Ÿç±»ä¼¼çš„æ³¨å…¥æ¼æ´ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸ªåŠ¨æ€æ‰§è¡ŒJavaScriptä»£ç å¯¼è‡´æ³¨å…¥æ¼æ´çš„æ¡ˆä¾‹ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬è¦å¯¹ç”¨æˆ·åå®ç°åŠ¨æ€çš„è§„åˆ™åˆ¤æ–­ï¼šé€šè¿‡ScriptEngineManagerè·å¾—ä¸€ä¸ªJavaScriptè„šæœ¬å¼•æ“ï¼Œä½¿ç”¨Javaä»£ç æ¥åŠ¨æ€æ‰§è¡ŒJavaScriptä»£ç ï¼Œå®ç°å½“å¤–éƒ¨ä¼ å…¥çš„ç”¨æˆ·åä¸ºadminçš„æ—¶å€™è¿”å›1ï¼Œå¦åˆ™è¿”å›0ï¼š

```
private ScriptEngineManager scriptEngineManager = new ScriptEngineManager();
//è·å¾—JavaScriptè„šæœ¬å¼•æ“
private ScriptEngine jsEngine = scriptEngineManager.getEngineByName("js");

@GetMapping("wrong")
public Object wrong(@RequestParam("name") String name) {
    try {
        //é€šè¿‡evalåŠ¨æ€æ‰§è¡ŒJavaScriptè„šæœ¬ï¼Œè¿™é‡Œnameå‚æ•°é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥æ–¹å¼æ··å…¥JavaScriptä»£ç 
        return jsEngine.eval(String.format("var name='%s'; name=='admin'?1:0;", name));
    } catch (ScriptException e) {
        e.printStackTrace();
    }
    return null;
}
```

è¿™ä¸ªåŠŸèƒ½æœ¬èº«æ²¡ä»€ä¹ˆé—®é¢˜ï¼š

![](https://static001.geekbang.org/resource/image/a5/08/a5c253d78b6b40f6e2aa8283732f0408.png?wh=1042%2A198)

ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æŠŠä¼ å…¥çš„ç”¨æˆ·åä¿®æ”¹ä¸ºè¿™æ ·ï¼š

```
haha';java.lang.System.exit(0);'
```

å°±å¯ä»¥è¾¾åˆ°å…³é—­æ•´ä¸ªç¨‹åºçš„ç›®çš„ã€‚åŸå› æ˜¯ï¼Œæˆ‘ä»¬ç›´æ¥æŠŠä»£ç å’Œæ•°æ®æ‹¼æ¥åœ¨äº†ä¸€èµ·ã€‚å¤–éƒ¨å¦‚æœæ„é€ äº†ä¸€ä¸ªç‰¹æ®Šçš„ç”¨æˆ·åå…ˆé—­åˆå­—ç¬¦ä¸²çš„å•å¼•å·ï¼Œå†æ‰§è¡Œä¸€æ¡System.exitå‘½ä»¤çš„è¯ï¼Œå°±å¯ä»¥æ»¡è¶³è„šæœ¬ä¸å‡ºé”™ï¼Œå‘½ä»¤è¢«æ‰§è¡Œã€‚

è§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ç§æ–¹å¼ã€‚

ç¬¬ä¸€ç§æ–¹å¼å’Œè§£å†³SQLæ³¨å…¥ä¸€æ ·ï¼Œéœ€è¦**æŠŠå¤–éƒ¨ä¼ å…¥çš„æ¡ä»¶æ•°æ®ä»…ä»…å½“åšæ•°æ®æ¥å¯¹å¾…ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡SimpleBindingsæ¥ç»‘å®šå‚æ•°åˆå§‹åŒ–nameå˜é‡**ï¼Œè€Œä¸æ˜¯ç›´æ¥æ‹¼æ¥ä»£ç ï¼š

```
@GetMapping("right")
public Object right(@RequestParam("name") String name) {
    try {
        //å¤–éƒ¨ä¼ å…¥çš„å‚æ•°
        Map<String, Object> parm = new HashMap<>();
        parm.put("name", name);
        //nameå‚æ•°ä½œä¸ºç»‘å®šä¼ ç»™evalæ–¹æ³•ï¼Œè€Œä¸æ˜¯æ‹¼æ¥JavaScriptä»£ç 
        return jsEngine.eval("name=='admin'?1:0;", new SimpleBindings(parm));
    } catch (ScriptException e) {
        e.printStackTrace();
    }
    return null;
}
```

è¿™æ ·å°±é¿å…äº†æ³¨å…¥é—®é¢˜ï¼š

![](https://static001.geekbang.org/resource/image/a0/49/a032842a5e551db18bd45dacf7794a49.png?wh=1410%2A204)

ç¬¬äºŒç§è§£å†³æ–¹æ³•æ˜¯ï¼Œä½¿ç”¨SecurityManageré…åˆAccessControlContextï¼Œæ¥æ„å»ºä¸€ä¸ªè„šæœ¬è¿è¡Œçš„æ²™ç®±ç¯å¢ƒã€‚è„šæœ¬èƒ½æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œæƒé™ï¼Œæ˜¯é€šè¿‡setPermissionsæ–¹æ³•ç²¾ç»†åŒ–è®¾ç½®çš„ï¼š

```
@Slf4j
public class ScriptingSandbox {
    private ScriptEngine scriptEngine;
    private AccessControlContext accessControlContext;

    private SecurityManager securityManager;
    private static ThreadLocal<Boolean> needCheck = ThreadLocal.withInitial(() -> false);

    public ScriptingSandbox(ScriptEngine scriptEngine) throws InstantiationException {
        this.scriptEngine = scriptEngine;
        securityManager = new SecurityManager(){
            //ä»…åœ¨éœ€è¦çš„æ—¶å€™æ£€æŸ¥æƒé™
            @Override
            public void checkPermission(Permission perm) {
                if (needCheck.get() && accessControlContext != null) {
                    super.checkPermission(perm, accessControlContext);
                }
            }
        };
        //è®¾ç½®æ‰§è¡Œè„šæœ¬éœ€è¦çš„æƒé™
        setPermissions(Arrays.asList(
                new RuntimePermission("getProtectionDomain"),
                new PropertyPermission("jdk.internal.lambda.dumpProxyClasses","read"),
                new FilePermission(Shell.class.getProtectionDomain().getPermissions().elements().nextElement().getName(),"read"),
                new RuntimePermission("createClassLoader"),
                new RuntimePermission("accessClassInPackage.jdk.internal.org.objectweb.*"),
                new RuntimePermission("accessClassInPackage.jdk.nashorn.internal.*"),
                new RuntimePermission("accessDeclaredMembers"),
                new ReflectPermission("suppressAccessChecks")
        ));
    }
    //è®¾ç½®æ‰§è¡Œä¸Šä¸‹æ–‡çš„æƒé™
    public void setPermissions(List<Permission> permissionCollection) {
        Permissions perms = new Permissions();

        if (permissionCollection != null) {
            for (Permission p : permissionCollection) {
                perms.add(p);
            }
        }

        ProtectionDomain domain = new ProtectionDomain(new CodeSource(null, (CodeSigner[]) null), perms);
        accessControlContext = new AccessControlContext(new ProtectionDomain[]{domain});
    }

    public Object eval(final String code) {
        SecurityManager oldSecurityManager = System.getSecurityManager();
        System.setSecurityManager(securityManager);
        needCheck.set(true);
        try {
            //åœ¨AccessControllerçš„ä¿æŠ¤ä¸‹æ‰§è¡Œè„šæœ¬
            return AccessController.doPrivileged((PrivilegedAction<Object>) () -> {
                try {
                    return scriptEngine.eval(code);
                } catch (ScriptException e) {
                    e.printStackTrace();
                }
                return null;
            }, accessControlContext);

        } catch (Exception ex) {
            log.error("æŠ±æ­‰ï¼Œæ— æ³•æ‰§è¡Œè„šæœ¬ {}", code, ex);
        } finally {
            needCheck.set(false);
            System.setSecurityManager(oldSecurityManager);
        }
        return null;
    }
```

å†™ä¸€æ®µæµ‹è¯•ä»£ç ï¼Œä½¿ç”¨åˆšæ‰å®šä¹‰çš„ScriptingSandboxæ²™ç®±å·¥å…·ç±»æ¥æ‰§è¡Œè„šæœ¬ï¼š

```
@GetMapping("right2")
public Object right2(@RequestParam("name") String name) throws InstantiationException {
    //ä½¿ç”¨æ²™ç®±æ‰§è¡Œè„šæœ¬
    ScriptingSandbox scriptingSandbox = new ScriptingSandbox(jsEngine);
    return scriptingSandbox.eval(String.format("var name='%s'; name=='admin'?1:0;", name));
}
```

è¿™æ¬¡ï¼Œæˆ‘ä»¬å†ä½¿ç”¨ä¹‹å‰çš„æ³¨å…¥è„šæœ¬è°ƒç”¨è¿™ä¸ªæ¥å£ï¼š

```
http://localhost:45678/codeinject/right2?name=haha%27;java.lang.System.exit(0);%27
```

å¯ä»¥çœ‹åˆ°ï¼Œç»“æœä¸­æŠ›å‡ºäº†AccessControlExceptionå¼‚å¸¸ï¼Œæ³¨å…¥æ”»å‡»å¤±æ•ˆäº†ï¼š

```
[13:09:36.080] [http-nio-45678-exec-1] [ERROR] [o.g.t.c.c.codeinject.ScriptingSandbox:77  ] - æŠ±æ­‰ï¼Œæ— æ³•æ‰§è¡Œè„šæœ¬ var name='haha';java.lang.System.exit(0);''; name=='admin'?1:0;
java.security.AccessControlException: access denied ("java.lang.RuntimePermission" "exitVM.0")
	at java.security.AccessControlContext.checkPermission(AccessControlContext.java:472)
	at java.lang.SecurityManager.checkPermission(SecurityManager.java:585)
	at org.geekbang.time.commonmistakes.codeanddata.codeinject.ScriptingSandbox$1.checkPermission(ScriptingSandbox.java:30)
	at java.lang.SecurityManager.checkExit(SecurityManager.java:761)
	at java.lang.Runtime.exit(Runtime.java:107)
```

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘åŒæ—¶ä½¿ç”¨è¿™ä¸¤ç§æ–¹æ³•ï¼Œç¡®ä¿ä»£ç æ‰§è¡Œçš„å®‰å…¨æ€§ã€‚

## XSSå¿…é¡»å…¨æ–¹ä½ä¸¥é˜²æ­»å µ

å¯¹äºä¸šåŠ¡å¼€å‘æ¥è¯´ï¼ŒXSSçš„é—®é¢˜åŒæ ·è¦å¼•èµ·å…³æ³¨ã€‚

XSSé—®é¢˜çš„æ ¹æºåœ¨äºï¼ŒåŸæœ¬æ˜¯è®©ç”¨æˆ·ä¼ å…¥æˆ–è¾“å…¥æ­£å¸¸æ•°æ®çš„åœ°æ–¹ï¼Œè¢«é»‘å®¢æ›¿æ¢ä¸ºäº†JavaScriptè„šæœ¬ï¼Œé¡µé¢æ²¡æœ‰ç»è¿‡è½¬ä¹‰ç›´æ¥æ˜¾ç¤ºäº†è¿™ä¸ªæ•°æ®ï¼Œç„¶åè„šæœ¬å°±è¢«æ‰§è¡Œäº†ã€‚æ›´ä¸¥é‡çš„æ˜¯ï¼Œè„šæœ¬æ²¡æœ‰ç»è¿‡è½¬ä¹‰å°±ä¿å­˜åˆ°äº†æ•°æ®åº“ä¸­ï¼Œéšåé¡µé¢åŠ è½½æ•°æ®çš„æ—¶å€™ï¼Œæ•°æ®ä¸­æ··å…¥çš„è„šæœ¬åˆå½“åšä»£ç æ‰§è¡Œäº†ã€‚é»‘å®¢å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¼æ´æ¥ç›—å–æ•æ„Ÿæ•°æ®ï¼Œè¯±éª—ç”¨æˆ·è®¿é—®é’“é±¼ç½‘ç«™ç­‰ã€‚

æˆ‘ä»¬å†™ä¸€æ®µä»£ç æµ‹è¯•ä¸‹ã€‚é¦–å…ˆï¼ŒæœåŠ¡ç«¯å®šä¹‰ä¸¤ä¸ªæ¥å£ï¼Œå…¶ä¸­indexæ¥å£æŸ¥è¯¢ç”¨æˆ·åä¿¡æ¯è¿”å›ç»™xssé¡µé¢ï¼Œsaveæ¥å£ä½¿ç”¨@RequestParamæ³¨è§£æ¥æ”¶ç”¨æˆ·åï¼Œå¹¶åˆ›å»ºç”¨æˆ·ä¿å­˜åˆ°æ•°æ®åº“ï¼›ç„¶åï¼Œé‡å®šå‘æµè§ˆå™¨åˆ°indexæ¥å£ï¼š

```
@RequestMapping("xss")
@Slf4j
@Controller
public class XssController {
    @Autowired
    private UserRepository userRepository;
    //æ˜¾ç¤ºxssé¡µé¢
    @GetMapping
    public String index(ModelMap modelMap) {
        //æŸ¥æ•°æ®åº“
        User user = userRepository.findById(1L).orElse(new User());
        //ç»™Viewæä¾›Model
        modelMap.addAttribute("username", user.getName());
        return "xss";
    }
    //ä¿å­˜ç”¨æˆ·ä¿¡æ¯
    @PostMapping
    public String save(@RequestParam("username") String username, HttpServletRequest request) {
        User user = new User();
        user.setId(1L);
        user.setName(username);
        userRepository.save(user);
        //ä¿å­˜å®Œæˆåé‡å®šå‘åˆ°é¦–é¡µ
        return "redirect:/xss/";
    }
 }
//ç”¨æˆ·ç±»ï¼ŒåŒæ—¶ä½œä¸ºDTOå’ŒEntity
@Entity
@Data
public class User {
    @Id
    private Long id;
    private String name;
}
```

æˆ‘ä»¬ä½¿ç”¨Thymeleafæ¨¡æ¿å¼•æ“æ¥æ¸²æŸ“é¡µé¢ã€‚æ¨¡æ¿ä»£ç æ¯”è¾ƒç®€å•ï¼Œé¡µé¢åŠ è½½çš„æ—¶å€™ä¼šåœ¨æ ‡ç­¾æ˜¾ç¤ºç”¨æˆ·åï¼Œç”¨æˆ·è¾“å…¥ç”¨æˆ·åæäº¤åè°ƒç”¨saveæ¥å£åˆ›å»ºç”¨æˆ·ï¼š

```
<div style="font-size: 14px">
    <form id="myForm" method="post" th:action="@{/xss/}">
        <label th:utext="${username}"/>
        <input id="username" name="username" size="100" type="text"/>
        <button th:text="Register" type="submit"/>
    </form>
</div>
```

æ‰“å¼€xssé¡µé¢åï¼Œåœ¨æ–‡æœ¬æ¡†ä¸­è¾“å…¥&lt;script&gt;alert(â€˜testâ€™)&lt;/script&gt;ç‚¹å‡»RegisteræŒ‰é’®æäº¤ï¼Œé¡µé¢ä¼šå¼¹å‡ºalertå¯¹è¯æ¡†ï¼š

![](https://static001.geekbang.org/resource/image/cc/7f/cc50a56d83b3687859a396081346a47f.png?wh=1682%2A192)

![](https://static001.geekbang.org/resource/image/c4/71/c4633bc6edc93c98e1d27969f6518571.png?wh=2230%2A342)

å¹¶ä¸”ï¼Œè„šæœ¬è¢«ä¿å­˜åˆ°äº†æ•°æ®åº“ï¼š

![](https://static001.geekbang.org/resource/image/7e/bc/7ed8a0a92059149ed32bae43458307bc.png?wh=640%2A126)

ä½ å¯èƒ½æƒ³åˆ°äº†ï¼Œè§£å†³æ–¹å¼å°±æ˜¯HTMLè½¬ç ã€‚æ—¢ç„¶æ˜¯é€šè¿‡@RequestParamæ¥è·å–è¯·æ±‚å‚æ•°ï¼Œé‚£æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª@InitBinderå®ç°æ•°æ®ç»‘å®šçš„æ—¶å€™ï¼Œå¯¹å­—ç¬¦ä¸²è¿›è¡Œè½¬ç å³å¯ï¼š

```
@ControllerAdvice
public class SecurityAdvice {
    @InitBinder
    protected void initBinder(WebDataBinder binder) {
        //æ³¨å†Œè‡ªå®šä¹‰çš„ç»‘å®šå™¨
        binder.registerCustomEditor(String.class, new PropertyEditorSupport() {
            @Override
            public String getAsText() {
                Object value = getValue();
                return value != null ? value.toString() : "";
            }
            @Override
            public void setAsText(String text) {
                //èµ‹å€¼æ—¶è¿›è¡ŒHTMLè½¬ä¹‰
                setValue(text == null ? null : HtmlUtils.htmlEscape(text));
            }
        });
    }
}
```

çš„ç¡®ï¼Œé’ˆå¯¹è¿™ä¸ªåœºæ™¯ï¼Œè¿™ç§åšæ³•æ˜¯å¯è¡Œçš„ã€‚æ•°æ®åº“ä¸­ä¿å­˜äº†è½¬ä¹‰åçš„æ•°æ®ï¼Œå› æ­¤æ•°æ®ä¼šè¢«å½“åšHTMLæ˜¾ç¤ºåœ¨é¡µé¢ä¸Šï¼Œè€Œä¸æ˜¯å½“åšè„šæœ¬æ‰§è¡Œï¼š

![](https://static001.geekbang.org/resource/image/5f/ca/5ff4c92a1571da41ccb804c4232171ca.png?wh=782%2A126)

![](https://static001.geekbang.org/resource/image/88/01/88cedbd1557690157e52010280386801.png?wh=2316%2A206)

ä½†æ˜¯ï¼Œè¿™ç§å¤„ç†æ–¹å¼çŠ¯äº†ä¸€ä¸ªä¸¥é‡çš„é”™è¯¯ï¼Œé‚£å°±æ˜¯æ²¡æœ‰ä»æ ¹å„¿ä¸Šæ¥å¤„ç†å®‰å…¨é—®é¢˜ã€‚å› ä¸º@InitBinderæ˜¯Spring Webå±‚é¢çš„å¤„ç†é€»è¾‘ï¼Œå¦‚æœæœ‰ä»£ç ä¸é€šè¿‡@RequestParamæ¥è·å–æ•°æ®ï¼Œè€Œæ˜¯ç›´æ¥ä»HTTPè¯·æ±‚è·å–æ•°æ®çš„è¯ï¼Œè¿™ç§æ–¹å¼å°±ä¸ä¼šå¥æ•ˆã€‚æ¯”å¦‚è¿™æ ·ï¼š

```
user.setName(request.getParameter("username"));
```

æ›´åˆç†çš„è§£å†³æ–¹å¼æ˜¯ï¼Œå®šä¹‰ä¸€ä¸ªservlet Filterï¼Œé€šè¿‡HttpServletRequestWrapperå®ç°servletå±‚é¢çš„ç»Ÿä¸€å‚æ•°æ›¿æ¢ï¼š

```
//è‡ªå®šä¹‰è¿‡æ»¤å™¨
@Component
@Order(Ordered.HIGHEST_PRECEDENCE)
public class XssFilter implements Filter {
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        chain.doFilter(new XssRequestWrapper((HttpServletRequest) request), response);
    }
}
public class XssRequestWrapper extends HttpServletRequestWrapper {

    public XssRequestWrapper(HttpServletRequest request) {
        super(request);
    }

    @Override
    public String[] getParameterValues(String parameter) {
        //è·å–å¤šä¸ªå‚æ•°å€¼çš„æ—¶å€™å¯¹æ‰€æœ‰å‚æ•°å€¼åº”ç”¨cleanæ–¹æ³•é€ä¸€æ¸…æ´
        return Arrays.stream(super.getParameterValues(parameter)).map(this::clean).toArray(String[]::new);
    }

    @Override
    public String getHeader(String name) {
        //åŒæ ·æ¸…æ´è¯·æ±‚å¤´
        return clean(super.getHeader(name));
    }

    @Override
    public String getParameter(String parameter) {
        //è·å–å‚æ•°å•ä¸€å€¼ä¹Ÿè¦å¤„ç†
        return clean(super.getParameter(parameter));
    }
    //cleanæ–¹æ³•å°±æ˜¯å¯¹å€¼è¿›è¡ŒHTMLè½¬ä¹‰
    private String clean(String value) {
      return StringUtils.isEmpty(value)? "" : HtmlUtils.htmlEscape(value);
    }
}    
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°æ‰€æœ‰è¯·æ±‚å‚æ•°çš„HTMLè½¬ä¹‰äº†ã€‚ä¸è¿‡ï¼Œè¿™ç§æ–¹å¼è¿˜æ˜¯ä¸å¤Ÿå½»åº•ï¼ŒåŸå› æ˜¯æ— æ³•å¤„ç†é€šè¿‡@RequestBodyæ³¨è§£æäº¤çš„JSONæ•°æ®ã€‚æ¯”å¦‚ï¼Œæœ‰è¿™æ ·ä¸€ä¸ªPUTæ¥å£ï¼Œç›´æ¥ä¿å­˜äº†å®¢æˆ·ç«¯ä¼ å…¥çš„JSON Userå¯¹è±¡ï¼š

```
@PutMapping
public void put(@RequestBody User user) {
    userRepository.save(user);
}
```

é€šè¿‡Postmanè¯·æ±‚è¿™ä¸ªæ¥å£ï¼Œä¿å­˜åˆ°æ•°æ®åº“ä¸­çš„æ•°æ®è¿˜æ˜¯æ²¡æœ‰è½¬ä¹‰ï¼š

![](https://static001.geekbang.org/resource/image/6d/4f/6d8e2b3b68e8a623d039d9d73999a64f.png?wh=1094%2A350)

æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªJacksonååˆ—åŒ–å™¨ï¼Œæ¥å®ç°ååºåˆ—åŒ–æ—¶çš„å­—ç¬¦ä¸²çš„HTMLè½¬ä¹‰ï¼š

```
//æ³¨å†Œè‡ªå®šä¹‰çš„Jacksonååºåˆ—å™¨
@Bean
public Module xssModule() {
    SimpleModule module = new SimpleModule();
    module.module.addDeserializer(String.class, new XssJsonDeserializer());
    return module;
}

public class XssJsonDeserializer extends JsonDeserializer<String> {
    @Override
    public String deserialize(JsonParser jsonParser, DeserializationContext ctxt) throws IOException, JsonProcessingException {
        String value = jsonParser.getValueAsString();
        if (value != null) {
            //å¯¹äºå€¼è¿›è¡ŒHTMLè½¬ä¹‰
            return HtmlUtils.htmlEscape(value);
        }
        return value;
    }

    @Override
    public Class<String> handledType() {
        return String.class;
    }
}
```

è¿™æ ·å°±å®ç°äº†æ—¢èƒ½è½¬ä¹‰Get/Posté€šè¿‡è¯·æ±‚å‚æ•°æäº¤çš„æ•°æ®ï¼Œåˆèƒ½è½¬ä¹‰è¯·æ±‚ä½“ä¸­ç›´æ¥æäº¤çš„JSONæ•°æ®ã€‚

ä½ å¯èƒ½è§‰å¾—åšåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„é˜²èŒƒå·²ç»å¾ˆå…¨é¢äº†ï¼Œä½†å…¶å®ä¸æ˜¯ã€‚è¿™ç§åªèƒ½å µæ–°æ¼ï¼Œç¡®ä¿æ–°æ•°æ®è¿›å…¥æ•°æ®åº“ä¹‹å‰è½¬ä¹‰ã€‚å¦‚æœå› ä¸ºä¹‹å‰çš„æ¼æ´ï¼Œæ•°æ®åº“ä¸­å·²ç»ä¿å­˜äº†ä¸€äº›JavaScriptä»£ç ï¼Œé‚£ä¹ˆè¯»å–çš„æ—¶å€™åŒæ ·å¯èƒ½å‡ºé—®é¢˜ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è¿˜è¦å®ç°æ•°æ®è¯»å–çš„æ—¶å€™ä¹Ÿè½¬ä¹‰ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å…·ä½“çš„å®ç°æ–¹å¼ã€‚

é¦–å…ˆï¼Œä¹‹å‰æˆ‘ä»¬å¤„ç†äº†JSONååºåˆ—åŒ–é—®é¢˜ï¼Œé‚£ä¹ˆå°±éœ€è¦åŒæ ·å¤„ç†åºåˆ—åŒ–ï¼Œå®ç°æ•°æ®ä»æ•°æ®åº“ä¸­è¯»å–çš„æ—¶å€™è½¬ä¹‰ï¼Œå¦åˆ™è¯»å‡ºæ¥çš„JSONå¯èƒ½åŒ…å«JavaScriptä»£ç ã€‚

æ¯”å¦‚ï¼Œæˆ‘ä»¬å®šä¹‰è¿™æ ·ä¸€ä¸ªGETæ¥å£ä»¥JSONæ¥è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼š

```
@GetMapping("user")
@ResponseBody
public User query() {
    return userRepository.findById(1L).orElse(new User());
}
```

![](https://static001.geekbang.org/resource/image/b2/f8/b2f919307e42e79ce78622b305d455f8.png?wh=1192%2A766)

ä¿®æ”¹ä¹‹å‰çš„SimpleModuleåŠ å…¥è‡ªå®šä¹‰åºåˆ—åŒ–å™¨ï¼Œå¹¶ä¸”å®ç°åºåˆ—åŒ–æ—¶å¤„ç†å­—ç¬¦ä¸²è½¬ä¹‰ï¼š

```
//æ³¨å†Œè‡ªå®šä¹‰çš„Jacksonåºåˆ—å™¨
@Bean
public Module xssModule() {
    SimpleModule module = new SimpleModule();
    module.addDeserializer(String.class, new XssJsonDeserializer());
    module.addSerializer(String.class, new XssJsonSerializer());
    return module;
}

public class XssJsonSerializer extends JsonSerializer<String> {
    @Override
    public Class<String> handledType() {
        return String.class;
    }

    @Override
    public void serialize(String value, JsonGenerator jsonGenerator, SerializerProvider serializerProvider) throws IOException {
        if (value != null) {
            //å¯¹å­—ç¬¦ä¸²è¿›è¡ŒHTMLè½¬ä¹‰
            jsonGenerator.writeString(HtmlUtils.htmlEscape(value));
        }
    }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ¬¡è¯»åˆ°çš„JSONä¹Ÿè½¬ä¹‰äº†ï¼š

![](https://static001.geekbang.org/resource/image/31/fc/315f67193d1f9efe4b09db85361c53fc.png?wh=1386%2A810)

å…¶æ¬¡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¤„ç†HTMLæ¨¡æ¿ã€‚å¯¹äºThymeleafæ¨¡æ¿å¼•æ“ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨th:utextæ¥æ˜¾ç¤ºæ•°æ®æ˜¯ä¸ä¼šè¿›è¡Œè½¬ä¹‰çš„ï¼Œéœ€è¦ä½¿ç”¨th:textï¼š

```
<label th:text="${username}"/>
```

ç»è¿‡ä¿®æ”¹åï¼Œå³ä½¿æ•°æ®åº“ä¸­å·²ç»ä¿å­˜äº†JavaScriptä»£ç ï¼Œå‘ˆç°çš„æ—¶å€™ä¹Ÿåªèƒ½ä½œä¸ºHTMLæ˜¾ç¤ºäº†ã€‚ç°åœ¨ï¼Œå¯¹äºè¿›å’Œå‡ºä¸¤ä¸ªæ–¹å‘ï¼Œæˆ‘ä»¬éƒ½å®ç°äº†è¡¥æ¼ã€‚

ä½†ï¼Œæ‰€è°“ç™¾å¯†æ€»æœ‰ä¸€ç–ã€‚ä¸ºäº†é¿å…ç–æ¼ï¼Œè¿›ä¸€æ­¥æ§åˆ¶XSSå¯èƒ½å¸¦æ¥çš„å±å®³ï¼Œæˆ‘ä»¬è¿˜è¦è€ƒè™‘ä¸€ç§æƒ…å†µï¼šå¦‚æœéœ€è¦åœ¨Cookieä¸­å†™å…¥æ•æ„Ÿä¿¡æ¯çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å¯HttpOnlyå±æ€§ã€‚è¿™æ ·JavaScriptä»£ç å°±æ— æ³•è¯»å–Cookieäº†ï¼Œå³ä¾¿é¡µé¢è¢«XSSæ³¨å…¥äº†æ”»å‡»ä»£ç ï¼Œä¹Ÿæ— æ³•è·å¾—æˆ‘ä»¬çš„Cookieã€‚

å†™æ®µä»£ç æµ‹è¯•ä¸€ä¸‹ã€‚å®šä¹‰ä¸¤ä¸ªæ¥å£ï¼Œå…¶ä¸­readCookieæ¥å£è¯»å–Keyä¸ºtestçš„Cookieï¼ŒwriteCookieæ¥å£å†™å…¥Cookieï¼Œæ ¹æ®å‚æ•°HttpOnlyç¡®å®šCookieæ˜¯å¦å¼€å¯HttpOnlyï¼š

```
//æœåŠ¡ç«¯è¯»å–Cookie
@GetMapping("readCookie")
@ResponseBody
public String readCookie(@CookieValue("test") String cookieValue) {
    return cookieValue;
}
//æœåŠ¡ç«¯å†™å…¥Cookie
@GetMapping("writeCookie")
@ResponseBody
public void writeCookie(@RequestParam("httpOnly") boolean httpOnly, HttpServletResponse response) {
    Cookie cookie = new Cookie("test", "zhuye");
    //æ ¹æ®httpOnlyå…¥å‚å†³å®šæ˜¯å¦å¼€å¯HttpOnlyå±æ€§
    cookie.setHttpOnly(httpOnly);
    response.addCookie(cookie);
}
```

å¯ä»¥çœ‹åˆ°ï¼Œç”±äºtestå’Œ\_gaè¿™ä¸¤ä¸ªCookieä¸æ˜¯HttpOnlyçš„ã€‚é€šè¿‡document.cookieå¯ä»¥è¾“å‡ºè¿™ä¸¤ä¸ªCookieçš„å†…å®¹ï¼š

![](https://static001.geekbang.org/resource/image/72/77/726e984d392aa1afc6d7371447700977.png?wh=3274%2A1968)

ä¸ºtestè¿™ä¸ªCookieå¯ç”¨äº†HttpOnlyå±æ€§åï¼Œå°±ä¸èƒ½è¢«document.cookieè¯»å–åˆ°äº†ï¼Œè¾“å‡ºä¸­åªæœ‰\_gaä¸€é¡¹ï¼š

![](https://static001.geekbang.org/resource/image/1b/0c/1b287474f0666d5a2fde8e9442ae2e0c.png?wh=2894%2A1862)

ä½†æ˜¯æœåŠ¡ç«¯å¯ä»¥è¯»å–åˆ°è¿™ä¸ªcookieï¼š

![](https://static001.geekbang.org/resource/image/b2/bd/b25da8d4aa5778798652f9685a93f6bd.png?wh=894%2A228)

## é‡ç‚¹å›é¡¾

ä»Šå¤©ï¼Œæˆ‘é€šè¿‡æ¡ˆä¾‹ï¼Œå’Œä½ å…·ä½“åˆ†æäº†SQLæ³¨å…¥å’ŒXSSæ”»å‡»è¿™ä¸¤ç±»æ³¨å…¥ç±»å®‰å…¨é—®é¢˜ã€‚

åœ¨å­¦ä¹ SQLæ³¨å…¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡sqlmapå·¥å…·çœ‹åˆ°äº†å‡ ç§å¸¸ç”¨æ³¨å…¥æ–¹å¼ï¼Œè¿™å¯èƒ½æ”¹å˜äº†æˆ‘ä»¬å¯¹SQLæ³¨å…¥å¨åŠ›çš„è®¤çŸ¥ï¼šå¯¹äºPOSTè¯·æ±‚ã€è¯·æ±‚æ²¡æœ‰ä»»ä½•è¿”å›æ•°æ®ã€è¯·æ±‚ä¸ä¼šå‡ºé”™çš„æƒ…å†µä¸‹ï¼Œä»ç„¶å¯ä»¥å®Œæˆæ³¨å…¥ï¼Œå¹¶å¯ä»¥å¯¼å‡ºæ•°æ®åº“çš„æ‰€æœ‰æ•°æ®ã€‚

å¯¹äºSQLæ³¨å…¥æ¥è¯´ï¼Œä½¿ç”¨å‚æ•°åŒ–çš„æŸ¥è¯¢æ˜¯æœ€å¥½çš„å µæ¼æ–¹å¼ï¼›å¯¹äºJdbcTemplateæ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨â€œ?â€ä½œä¸ºå‚æ•°å ä½ç¬¦ï¼›å¯¹äºMyBatisæ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨â€œ#{}â€è¿›è¡Œå‚æ•°åŒ–å¤„ç†ã€‚

å’ŒSQLæ³¨å…¥ç±»ä¼¼çš„æ˜¯ï¼Œè„šæœ¬å¼•æ“åŠ¨æ€æ‰§è¡Œä»£ç ï¼Œéœ€è¦ç¡®ä¿å¤–éƒ¨ä¼ å…¥çš„æ•°æ®åªèƒ½ä½œä¸ºæ•°æ®æ¥å¤„ç†ï¼Œä¸èƒ½å’Œä»£ç æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œåªèƒ½ä½œä¸ºå‚æ•°æ¥å¤„ç†ã€‚ä»£ç å’Œæ•°æ®ä¹‹é—´éœ€è¦åˆ’å‡ºæ¸…æ™°çš„ç•Œé™ï¼Œå¦åˆ™å¯èƒ½äº§ç”Ÿä»£ç æ³¨å…¥é—®é¢˜ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®ä¸€ä¸ªä»£ç çš„æ‰§è¡Œæ²™ç®±æ¥ç»†åŒ–ä»£ç çš„æƒé™ï¼Œè¿™æ ·å³ä¾¿äº§ç”Ÿäº†æ³¨å…¥é—®é¢˜ï¼Œå› ä¸ºæƒé™å—é™æ³¨å…¥æ”»å‡»ä¹Ÿå¾ˆéš¾å‘æŒ¥å¨åŠ›ã€‚

**éšåé€šè¿‡å­¦ä¹ XSSæ¡ˆä¾‹ï¼Œæˆ‘ä»¬è®¤è¯†åˆ°å¤„ç†å®‰å…¨é—®é¢˜éœ€è¦ç¡®ä¿ä¸‰ç‚¹ã€‚**

- ç¬¬ä¸€ï¼Œè¦ä»æ ¹æœ¬ä¸Šã€ä»æœ€åº•å±‚è¿›è¡Œå µæ¼ï¼Œå°½é‡ä¸è¦åœ¨é«˜å±‚æ¡†æ¶å±‚é¢åšï¼Œå¦åˆ™å µæ¼å¯èƒ½ä¸å½»åº•ã€‚
- ç¬¬äºŒï¼Œå µæ¼è¦åŒæ—¶è€ƒè™‘è¿›å’Œå‡ºï¼Œä¸ä»…è¦ç¡®ä¿æ•°æ®å­˜å…¥æ•°æ®åº“çš„æ—¶å€™è¿›è¡Œäº†è½¬ä¹‰æˆ–è¿‡æ»¤ï¼Œè¿˜è¦åœ¨å–å‡ºæ•°æ®å‘ˆç°çš„æ—¶å€™å†æ¬¡è½¬ä¹‰ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±ã€‚
- ç¬¬ä¸‰ï¼Œé™¤äº†ç›´æ¥å µæ¼å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä¸€äº›é¢å¤–çš„æ‰‹æ®µé™åˆ¶æ¼æ´çš„å¨åŠ›ã€‚æ¯”å¦‚ï¼Œä¸ºCookieè®¾ç½®HttpOnlyå±æ€§ï¼Œæ¥é˜²æ­¢æ•°æ®è¢«è„šæœ¬è¯»å–ï¼›åˆæ¯”å¦‚ï¼Œå°½å¯èƒ½é™åˆ¶å­—æ®µçš„æœ€å¤§ä¿å­˜é•¿åº¦ï¼Œå³ä½¿å‡ºç°æ¼æ´ï¼Œä¹Ÿä¼šå› ä¸ºé•¿åº¦é—®é¢˜é™åˆ¶é»‘å®¢æ„é€ å¤æ‚æ”»å‡»è„šæœ¬çš„èƒ½åŠ›ã€‚

ä»Šå¤©ç”¨åˆ°çš„ä»£ç ï¼Œæˆ‘éƒ½æ”¾åœ¨äº†GitHubä¸Šï¼Œä½ å¯ä»¥ç‚¹å‡»[è¿™ä¸ªé“¾æ¥](https://github.com/JosephZhu1983/java-common-mistakes)æŸ¥çœ‹ã€‚

## æ€è€ƒä¸è®¨è®º

1. åœ¨è®¨è®ºSQLæ³¨å…¥æ¡ˆä¾‹æ—¶ï¼Œæœ€åé‚£æ¬¡æµ‹è¯•æˆ‘ä»¬çœ‹åˆ°sqlmapè¿”å›äº†4ç§æ³¨å…¥æ–¹å¼ã€‚å…¶ä¸­ï¼Œå¸ƒå°”ç›²æ³¨ã€æ—¶é—´ç›²æ³¨å’ŒæŠ¥é”™æ³¨å…¥ï¼Œæˆ‘éƒ½ä»‹ç»è¿‡äº†ã€‚ä½ çŸ¥é“è”åˆæŸ¥è¯¢æ³¨å…¥ï¼Œæ˜¯ä»€ä¹ˆå—ï¼Ÿ
2. åœ¨è®¨è®ºXSSçš„æ—¶å€™ï¼Œå¯¹äºThymeleafæ¨¡æ¿å¼•æ“ï¼Œæˆ‘ä»¬çŸ¥é“å¦‚ä½•è®©æ–‡æœ¬è¿›è¡ŒHTMLè½¬ä¹‰æ˜¾ç¤ºã€‚FreeMarkerä¹Ÿæ˜¯Javaä¸­å¾ˆå¸¸ç”¨çš„æ¨¡æ¿å¼•æ“ï¼Œä½ çŸ¥é“å¦‚ä½•å¤„ç†è½¬ä¹‰å—ï¼Ÿ

ä½ è¿˜é‡åˆ°è¿‡å…¶ä»–ç±»å‹çš„æ³¨å…¥é—®é¢˜å—ï¼Ÿæˆ‘æ˜¯æœ±æ™”ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºä¸æˆ‘ç•™è¨€åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ï¼Œä¸€èµ·äº¤æµã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ11ï¼‰</strong></div><ul>
<li><span>Summer  ç©ºåŸ</span> ğŸ‘ï¼ˆ28ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œæ‚¨å¥½ï¼Œè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œå¾®æœåŠ¡ä¸­ä¸€ä¸ªæ¨¡å—è·Ÿå¤šä¸ªæ¨¡å—rpcäº¤äº’çš„æ—¶å€™ï¼Œå‚æ•°æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹æ˜¯æŠŠå…¶ä»–æ¨¡å—çš„pojoå¤åˆ¶è¿‡æ¥ï¼Œè¿˜æ˜¯æä¾›ä¸€ä¸ªjarå­˜æ”¾å¤šä¸ªæ¨¡å—äº¤äº’çš„pojoï¼Œä¾›å¤šä¸ªæ¨¡å—å¼•ç”¨ä¹ˆï¼Ÿè¿™ä¸¤ç§æ–¹å¼æ„Ÿè§‰éƒ½ä¸å¤ªå¥½ï¼Œè€å¸ˆæ‚¨é‡åˆ°è¿™ç§é—®é¢˜æ˜¯æ€æ ·å¤„ç†çš„å‘¢ï¼Œéº»çƒ¦è€å¸ˆæŒ‡ç‚¹ä¸‹ï¼Œè°¢è°¢è€å¸ˆo(^o^)o</p>2020-05-23</li><br/><li><span>Geek_299a34</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è€å¸ˆï¼Œå¯¹äºmybatisï¼Œæœ‰æ²¡æœ‰åªèƒ½ä½¿ç”¨${}è€Œä¸èƒ½ä½¿ç”¨#{}çš„æƒ…å†µï¼Ÿç”±äº#{}ä¼šç»™å‚æ•°å†…å®¹è‡ªåŠ¨åŠ ä¸Šå¼•å·ï¼Œä¼šåœ¨æœ‰äº›éœ€è¦è¡¨ç¤ºå­—æ®µåã€è¡¨åçš„åœºæ™¯ä¸‹ï¼ŒSQLå°†æ— æ³•æ­£å¸¸æ‰§è¡Œã€‚å¦‚æŸ¥è¯¢userè¡¨ä¿¡æ¯ï¼Œæ ¹æ®idæˆ–ageæ’åºSELECT * FROM USER ORDER BY #{value} descï¼Œvalueä¸ºidæ—¶ï¼Œidä¼šè¢«é”™è¯¯æ·»åŠ å¼•å·è€Œæ— æ³•æ’åºï¼Œè¿™ç§æƒ…å†µå¯ä»¥æŠŠ#{}æ¢æˆ${}å—ï¼Ÿè°¢è°¢è€å¸ˆ</p>2020-08-05</li><br/><li><span>æˆ‘å«éƒ­å°é»‘</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p> new FilePermission(Shell.class.getProtectionDomain().getPermissions().elements().nextElement().getName(),&quot;read&quot;),  è¿™ä¸ªShell å¼•å…¥ä¸è¿›æ¥å‘¢ï¼Ÿ</p>2020-09-25</li><br/><li><span>13963865700</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¯¹äºxssæ”»å‡»é˜²èŒƒï¼ŒESAPIçš„å»ºè®®æ˜¯åœ¨å‰ç«¯æ ¹æ®å˜é‡æ‰€å¤„çš„ä½ç½®ï¼ˆhtmlã€jsï¼‰é‡‡ç”¨ä¸åŒçš„ç¼–ç æ–¹å¼è¿›è¡Œè½¬ä¹‰ï¼Œå‰ç«¯çš„å¼€å‘æˆæœ¬è¾ƒé«˜ï¼›æ–‡ä¸­æåˆ°çš„æ–¹å¼æ˜¯åœ¨åç«¯é‡‡ç”¨è¿‡æ»¤å™¨ç»Ÿä¸€è½¬ä¹‰å­˜å‚¨ï¼Œå¯ä»¥ä¸€åŠ³æ°¸é€¸ã€‚è€å¸ˆåœ¨å®é™…ç”Ÿäº§é¡¹ç›®ä¸­é‡‡ç”¨çš„æ˜¯å“ªç§æ–¹å¼ï¼Œè½¬ä¹‰å­˜å‚¨å¯¹è¾“å…¥å†…å®¹è¿›è¡Œäº†ä¿®æ”¹ï¼Œä¼šä¸ä¼šäº§ç”Ÿä»€ä¹ˆå‰¯ä½œç”¨ï¼Ÿ</p>2020-05-23</li><br/><li><span>è‹—</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è€å¸ˆï¼Œè¿™äº›ç»éªŒä½ æ˜¯æ€ä¹ˆç§¯ç´¯èµ·æ¥çš„å‘€ï¼Ÿä¸Šé¢çš„ä»£ç å¯ä»¥ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒå—ï¼Ÿ</p>2020-09-11</li><br/><li><span>éƒ‘æ€é›¨</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ‰¾åˆ°ä¸€ç¯‡æ–‡ç« å¯¹äºè”åˆæŸ¥è¯¢æ³¨å…¥ï¼Œè®²çš„å¾ˆæ˜ç™½
https:&#47;&#47;blog.csdn.net&#47;weixin_42277564&#47;article&#47;details&#47;80583959

å…³äºFreeMarker  HTML è½¬ä¹‰å¤„ç†å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š
https:&#47;&#47;www.iteye.com&#47;blog&#47;yshjava-1870320

æ„Ÿè°¢è€å¸ˆè®²è§£äº†è¿™ä¹ˆå¤šå®ç”¨çš„æŠ€å·§ï¼Œå­¦åˆ°äº†å¾ˆå¤šã€‚</p>2020-12-23</li><br/><li><span>å¾€äº‹éšé£ï¼Œé¡ºå…¶è‡ªç„¶</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ²™ç®±ç¯å¢ƒç›®çš„æ˜¯å•¥ï¼Œä¸ºå•¥æœ‰æ£€æŸ¥æƒé™ï¼Ÿ</p>2020-08-21</li><br/><li><span>é¥­ç²’</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ”¶è·é¢‡å¤šğŸ‘</p>2021-10-18</li><br/><li><span>è¿ªç±³ä¹Œæ ¼æ–¯</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è€å¸ˆæ‚¨å¥½,æƒ³è¯·æ•™ä¸€ä¸‹, ç›®å‰çš„æ¶æ„ä¸éƒ½æ˜¯å‰åç«¯åˆ†ç¦»çš„å—? åç«¯åªå’Œå‰ç«¯è¿›è¡Œäº¤äº’, å‰ç«¯ä¼ æ¥çš„æ•°æ®åº”è¯¥æ˜¯èƒ½ç¡®è®¤å®‰å…¨çš„å§?</p>2021-05-26</li><br/><li><span>...</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¿™é‡Œåº”å¯¹xssæ”»å‡»çš„è§£å†³æ–¹æ¡ˆï¼Œä½œè€…æä¾›çš„æ–¹å¼ä¸ºservlet-filterã€ä»¥åŠjsonåºåˆ—åŒ–æ”¹å†™ï¼Œå¯ä»¥è¯´æ˜¯æ›´å…¨é¢æ›´åˆç†ã€‚æˆ‘è‡ªå·±çš„å®ç°ä¸ä½œè€…æä¾›çš„æ˜¯æœ‰å·®åˆ«çš„ï¼Œæˆ‘ä»¬è‡ªå·±çš„è§£å†³æ–¹æ¡ˆä¸ºï¼Œgetæ–¹å¼çš„é€šè¿‡nginxé…ç½®å…³é”®å­—è¿‡æ»¤ã€postä¸ä½œè€…æä¾›çš„æ–¹å¼æ˜¯ç±»ä¼¼çš„ï¼Œå®é™…ä¸Šè¿™ç§è§£å†³æ–¹æ¡ˆæ˜¯æ‹¼å‡‘çš„ã€å‰²è£‚çš„ï¼Œæˆ‘ä»¬åº”è¯¥å‚ç…§ä½œè€…æä¾›çš„æ€è·¯ï¼Œè°ƒæ•´ä¸‹æˆ‘ä»¬è‡ªå·±çš„æ–¹æ¡ˆï¼Œé›†æˆåœ¨ä¸€ä¸ªé¡¹ç›®å†…ï¼Œå¯ä»¥ä»¥æ’ä»¶åŒ…çš„æ–¹å¼æä¾›å‡ºå»ï¼Œæœ€å¥½èƒ½æä¾›çµæ´»çš„é’ˆå¯¹å•ä¸ªå±æ€§åšxssè¿‡æ»¤çš„é…ç½®ï¼Œå¦‚æ­¤è¿™å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä¹Ÿæ˜¯å¯¹è‡ªå·±èƒ½åŠ›çš„é”»ç‚¼ã€‚æ„Ÿè°¢ä½œè€…å¤§ä½¬ï¼
</p>2023-01-03</li><br/><li><span>JoJi</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è€å¸ˆï¼Œå¦‚æœåœ¨ä¸Šä¼ çš„å›¾ç‰‡ä¸­æ¤å…¥äº†htmlä»£ç ï¼Œè¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿå›¾ç‰‡æµ toStringååŸæœ¬å°±å«&lt;ï¼Œå°±æ²¡æ³•ç®€å•çš„é€šè¿‡å¯¹&lt;è½¬ä¹‰æ¥å¤„ç†äº†ã€‚</p>2022-04-12</li><br/>
</ul>