ä½ å¥½ï¼Œæˆ‘æ˜¯æœ±æ™”ã€‚ä»Šå¤©ï¼Œæˆ‘è¦å’Œä½ åˆ†äº«çš„å†…å®¹æ˜¯åˆ†æå®šä½Javaé—®é¢˜å¸¸ç”¨çš„ä¸€äº›å·¥å…·ã€‚

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„è¯¾ç¨‹æ›´æ–°17è®²äº†ï¼Œå·²ç»æ›´æ–°è¿‡åŠäº†ã€‚åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œä½ ä¼šå‘ç°æˆ‘åœ¨ä»‹ç»å„ç§å‘çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯ç›´æ¥ç»™å‡ºé—®é¢˜çš„ç»“è®ºï¼Œè€Œæ˜¯é€šè¿‡å·¥å…·æ¥äº²çœ¼çœ‹åˆ°é—®é¢˜ã€‚

ä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºæˆ‘å§‹ç»ˆè®¤ä¸ºï¼Œé‡åˆ°é—®é¢˜å°½é‡ä¸è¦å»çŒœï¼Œä¸€å®šè¦çœ¼è§ä¸ºå®ã€‚åªæœ‰é€šè¿‡æ—¥å¿—ã€ç›‘æ§æˆ–å·¥å…·çœŸæ­£çœ‹åˆ°é—®é¢˜ï¼Œç„¶åå†å›åˆ°ä»£ç ä¸­è¿›è¡Œæ¯”å¯¹ç¡®è®¤ï¼Œæˆ‘ä»¬æ‰èƒ½è®¤ä¸ºæ˜¯æ‰¾åˆ°äº†æ ¹æœ¬åŸå› ã€‚

ä½ å¯èƒ½ä¸€å¼€å§‹ä¼šæ¯”è¾ƒç•æƒ§ä½¿ç”¨å¤æ‚çš„å·¥å…·å»æ’æŸ¥é—®é¢˜ï¼Œåˆæˆ–è€…æ˜¯æ‰“å¼€äº†å·¥å…·æ„Ÿè§‰æ— ä»ä¸‹æ‰‹ï¼Œä½†æ˜¯éšç€å®è·µè¶Šæ¥è¶Šå¤šï¼Œå¯¹Javaç¨‹åºå’Œå„ç§æ¡†æ¶çš„è¿ä½œè¶Šæ¥è¶Šç†Ÿæ‚‰ï¼Œä½ ä¼šå‘ç°ä½¿ç”¨è¿™äº›å·¥å…·è¶Šæ¥è¶Šé¡ºæ‰‹ã€‚

å…¶å®å‘¢ï¼Œå·¥å…·åªæ˜¯æˆ‘ä»¬å®šä½é—®é¢˜çš„æ‰‹æ®µï¼Œè¦ç”¨å¥½å·¥å…·ä¸»è¦è¿˜æ˜¯å¾—å¯¹ç¨‹åºæœ¬èº«çš„è¿ä½œæœ‰å¤§æ¦‚çš„è®¤è¯†ï¼Œè¿™éœ€è¦é•¿æœŸçš„ç§¯ç´¯ã€‚

å› æ­¤ï¼Œæˆ‘ä¼šé€šè¿‡ä¸¤ç¯‡åŠ é¤ï¼Œå’Œä½ åˆ†äº«4ä¸ªæ¡ˆä¾‹ï¼Œåˆ†åˆ«å±•ç¤ºä½¿ç”¨JDKè‡ªå¸¦çš„å·¥å…·æ¥æ’æŸ¥JVMå‚æ•°é…ç½®é—®é¢˜ã€ä½¿ç”¨Wiresharkæ¥åˆ†æç½‘ç»œé—®é¢˜ã€é€šè¿‡MATæ¥åˆ†æå†…å­˜é—®é¢˜ï¼Œä»¥åŠä½¿ç”¨Arthasæ¥åˆ†æCPUä½¿ç”¨é«˜çš„é—®é¢˜ã€‚è¿™äº›æ¡ˆä¾‹ä¹Ÿåªæ˜¯å†°å±±ä¸€è§’ï¼Œä½ å¯ä»¥è‡ªå·±å†é€šè¿‡äº›ä¾‹å­è¿›ä¸€æ­¥å­¦ä¹ å’Œæ¢ç´¢ã€‚

åœ¨ä»Šå¤©è¿™ç¯‡åŠ é¤ä¸­ï¼Œæˆ‘ä»¬å°±å…ˆå­¦ä¹ ä¸‹å¦‚ä½•ä½¿ç”¨JDKè‡ªå¸¦å·¥å…·ã€Wiresharkæ¥åˆ†æå’Œå®šä½Javaç¨‹åºçš„é—®é¢˜å§ã€‚

## ä½¿ç”¨JDKè‡ªå¸¦å·¥å…·æŸ¥çœ‹JVMæƒ…å†µ

JDKè‡ªå¸¦äº†å¾ˆå¤šå‘½ä»¤è¡Œç”šè‡³æ˜¯å›¾å½¢ç•Œé¢å·¥å…·ï¼Œå¸®åŠ©æˆ‘ä»¬æŸ¥çœ‹JVMçš„ä¸€äº›ä¿¡æ¯ã€‚æ¯”å¦‚ï¼Œåœ¨æˆ‘çš„æœºå™¨ä¸Šè¿è¡Œlså‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°JDK 8æä¾›äº†éå¸¸å¤šçš„å·¥å…·æˆ–ç¨‹åºï¼š

![](https://static001.geekbang.org/resource/image/22/bd/22456d9186a4f36f83209168b782dbbd.png?wh=2718%2A198)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šä¸ä½ ä»‹ç»äº›å¸¸ç”¨çš„ç›‘æ§å·¥å…·ã€‚ä½ ä¹Ÿå¯ä»¥å…ˆé€šè¿‡ä¸‹é¢è¿™å¼ å›¾äº†è§£ä¸‹å„ç§å·¥å…·çš„åŸºæœ¬ä½œç”¨ï¼š

![](https://static001.geekbang.org/resource/image/b4/0d/b4e8ab0a76a8665879e0fc13964ebc0d.jpg?wh=3596%2A2384)

ä¸ºäº†æµ‹è¯•è¿™äº›å·¥å…·ï¼Œæˆ‘ä»¬å…ˆæ¥å†™ä¸€æ®µä»£ç ï¼šå¯åŠ¨10ä¸ªæ­»å¾ªç¯çš„çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ª10MBå·¦å³çš„å­—ç¬¦ä¸²ï¼Œç„¶åä¼‘çœ 10ç§’ã€‚å¯ä»¥æƒ³è±¡åˆ°ï¼Œè¿™ä¸ªç¨‹åºä¼šå¯¹GCé€ æˆå‹åŠ›ã€‚

```
//å¯åŠ¨10ä¸ªçº¿ç¨‹
IntStream.rangeClosed(1, 10).mapToObj(i -> new Thread(() -> {
    while (true) {
        //æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œä¼‘çœ 10ç§’ï¼Œæ‰“å°10Mæ•°æ®
        String payload = IntStream.rangeClosed(1, 10000000)
                .mapToObj(__ -> "a")
                .collect(Collectors.joining("")) + UUID.randomUUID().toString();
        try {
            TimeUnit.SECONDS.sleep(10);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(payload.length());
    }
})).forEach(Thread::start);


TimeUnit.HOURS.sleep(1);
```

ä¿®æ”¹pom.xmlï¼Œé…ç½®spring-boot-maven-pluginæ’ä»¶æ‰“åŒ…çš„Javaç¨‹åºçš„mainæ–¹æ³•ç±»ï¼š

```
<plugin>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-maven-plugin</artifactId>
    <configuration>
        <mainClass>org.geekbang.time.commonmistakes.troubleshootingtools.jdktool.CommonMistakesApplication
        </mainClass>
    </configuration>
</plugin>
```

ç„¶åä½¿ç”¨java -jarå¯åŠ¨è¿›ç¨‹ï¼Œè®¾ç½®JVMå‚æ•°ï¼Œè®©å †æœ€å°æœ€å¤§éƒ½æ˜¯1GBï¼š

```
java -jar common-mistakes-0.0.1-SNAPSHOT.jar -Xms1g -Xmx1g
```

å®Œæˆè¿™äº›å‡†å¤‡å·¥ä½œåï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨JDKæä¾›çš„å·¥å…·ï¼Œæ¥è§‚å¯Ÿåˆ†æè¿™ä¸ªæµ‹è¯•ç¨‹åºäº†ã€‚

### jps

é¦–å…ˆï¼Œä½¿ç”¨jpså¾—åˆ°Javaè¿›ç¨‹åˆ—è¡¨ï¼Œè¿™ä¼šæ¯”ä½¿ç”¨psæ¥çš„æ–¹ä¾¿ï¼š

```
âœ  ~ jps
12707
22261 Launcher
23864 common-mistakes-0.0.1-SNAPSHOT.jar
15608 RemoteMavenServer36
23243 Main
23868 Jps
22893 KotlinCompileDaemon
```

### jinfo

ç„¶åï¼Œå¯ä»¥ä½¿ç”¨jinfoæ‰“å°JVMçš„å„ç§å‚æ•°ï¼š

```
âœ  ~ jinfo 23864
Java System Properties:
#Wed Jan 29 12:49:47 CST 2020
...
user.name=zhuye
path.separator=\:
os.version=10.15.2
java.runtime.name=Java(TM) SE Runtime Environment
file.encoding=UTF-8
java.vm.name=Java HotSpot(TM) 64-Bit Server VM
...


VM Flags:
-XX:CICompilerCount=4 -XX:ConcGCThreads=2 -XX:G1ConcRefinementThreads=8 -XX:G1HeapRegionSize=1048576 -XX:GCDrainStackTargetSize=64 -XX:InitialHeapSize=268435456 -XX:MarkStackSize=4194304 -XX:MaxHeapSize=4294967296 -XX:MaxNewSize=2576351232 -XX:MinHeapDeltaBytes=1048576 -XX:NonNMethodCodeHeapSize=5835340 -XX:NonProfiledCodeHeapSize=122911450 -XX:ProfiledCodeHeapSize=122911450 -XX:ReservedCodeCacheSize=251658240 -XX:+SegmentedCodeCache -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseG1GC


VM Arguments:
java_command: common-mistakes-0.0.1-SNAPSHOT.jar -Xms1g -Xmx1g
java_class_path (initial): common-mistakes-0.0.1-SNAPSHOT.jar
Launcher Type: SUN_STANDARD
```

æŸ¥çœ‹ç¬¬15è¡Œå’Œ19è¡Œå¯ä»¥å‘ç°ï¼Œ**æˆ‘ä»¬è®¾ç½®JVMå‚æ•°çš„æ–¹å¼ä¸å¯¹ï¼Œ-Xms1gå’Œ-Xmx1gè¿™ä¸¤ä¸ªå‚æ•°è¢«å½“æˆäº†Javaç¨‹åºçš„å¯åŠ¨å‚æ•°**ï¼Œæ•´ä¸ªJVMç›®å‰æœ€å¤§å†…å­˜æ˜¯4GBå·¦å³ï¼Œè€Œä¸æ˜¯1GBã€‚

å› æ­¤ï¼Œå½“æˆ‘ä»¬æ€€ç–‘JVMçš„é…ç½®å¾ˆä¸æ­£å¸¸çš„æ—¶å€™ï¼Œè¦ç¬¬ä¸€æ—¶é—´ä½¿ç”¨å·¥å…·æ¥ç¡®è®¤å‚æ•°ã€‚é™¤äº†ä½¿ç”¨å·¥å…·ç¡®è®¤JVMå‚æ•°å¤–ï¼Œä½ ä¹Ÿå¯ä»¥æ‰“å°VMå‚æ•°å’Œç¨‹åºå‚æ•°ï¼š

```
System.out.println("VM options");
System.out.println(ManagementFactory.getRuntimeMXBean().getInputArguments().stream().collect(Collectors.joining(System.lineSeparator())));
System.out.println("Program arguments");
System.out.println(Arrays.stream(args).collect(Collectors.joining(System.lineSeparator())));
```

æŠŠJVMå‚æ•°æ”¾åˆ°-jarä¹‹å‰ï¼Œé‡æ–°å¯åŠ¨ç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼Œä»è¾“å‡ºä¹Ÿå¯ä»¥ç¡®è®¤è¿™æ¬¡JVMå‚æ•°çš„é…ç½®æ­£ç¡®äº†ï¼š

```
âœ  target git:(master) âœ— java -Xms1g -Xmx1g -jar common-mistakes-0.0.1-SNAPSHOT.jar test
VM options
-Xms1g
-Xmx1g
Program arguments
test
```

### jvisualvm

ç„¶åï¼Œå¯åŠ¨å¦ä¸€ä¸ªé‡é‡çº§å·¥å…·jvisualvmè§‚å¯Ÿä¸€ä¸‹ç¨‹åºï¼Œå¯ä»¥åœ¨æ¦‚è¿°é¢æ¿å†æ¬¡ç¡®è®¤JVMå‚æ•°è®¾ç½®æˆåŠŸäº†ï¼š

![](https://static001.geekbang.org/resource/image/4d/e4/4d8a600072b0b1aea3943dee584c72e4.png?wh=3285%2A2054)

ç»§ç»­è§‚å¯Ÿç›‘è§†é¢æ¿å¯ä»¥çœ‹åˆ°ï¼ŒJVMçš„GCæ´»åŠ¨åŸºæœ¬æ˜¯10ç§’å‘ç”Ÿä¸€æ¬¡ï¼Œå †å†…å­˜åœ¨250MBåˆ°900MBä¹‹é—´æ³¢åŠ¨ï¼Œæ´»åŠ¨çº¿ç¨‹æ•°æ˜¯22ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ç›‘è§†é¢æ¿çœ‹åˆ°JVMçš„åŸºæœ¬æƒ…å†µï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨è¿™é‡Œè¿›è¡Œæ‰‹åŠ¨GCå’Œå †Dumpæ“ä½œï¼š

![](https://static001.geekbang.org/resource/image/5b/02/5be531e51f6e49d5511d419c90b29302.png?wh=3285%2A2054)

### jconsole

å¦‚æœå¸Œæœ›çœ‹åˆ°å„ä¸ªå†…å­˜åŒºçš„GCæ›²çº¿å›¾ï¼Œå¯ä»¥ä½¿ç”¨jconsoleè§‚å¯Ÿã€‚jconsoleä¹Ÿæ˜¯ä¸€ä¸ªç»¼åˆæ€§å›¾å½¢ç•Œé¢ç›‘æ§å·¥å…·ï¼Œæ¯”jvisualvmæ›´æ–¹ä¾¿çš„ä¸€ç‚¹æ˜¯ï¼Œå¯ä»¥ç”¨æ›²çº¿çš„å½¢å¼ç›‘æ§å„ç§æ•°æ®ï¼ŒåŒ…æ‹¬MBeanä¸­çš„å±æ€§å€¼ï¼š

![](https://static001.geekbang.org/resource/image/6b/12/6b4c08d384eea532842d386638dddb12.png?wh=2598%2A1940)

### jstat

åŒæ ·ï¼Œå¦‚æœæ²¡æœ‰æ¡ä»¶ä½¿ç”¨å›¾å½¢ç•Œé¢ï¼ˆæ¯•ç«Ÿåœ¨LinuxæœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬ä¸»è¦ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ï¼‰ï¼Œåˆå¸Œæœ›çœ‹åˆ°GCè¶‹åŠ¿çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨jstatå·¥å…·ã€‚

jstatå·¥å…·å…è®¸ä»¥å›ºå®šçš„ç›‘æ§é¢‘æ¬¡è¾“å‡ºJVMçš„å„ç§ç›‘æ§æŒ‡æ ‡ï¼Œæ¯”å¦‚ä½¿ç”¨-gcutilè¾“å‡ºGCå’Œå†…å­˜å ç”¨æ±‡æ€»ä¿¡æ¯ï¼Œæ¯éš”5ç§’è¾“å‡ºä¸€æ¬¡ï¼Œè¾“å‡º100æ¬¡ï¼Œå¯ä»¥çœ‹åˆ°Young GCæ¯”è¾ƒé¢‘ç¹ï¼Œè€ŒFull GCåŸºæœ¬10ç§’ä¸€æ¬¡ï¼š

```
âœ  ~ jstat -gcutil 23940 5000 100
  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT
  0.00 100.00   0.36  87.63  94.30  81.06    539   14.021    33    3.972   837    0.976   18.968
  0.00 100.00   0.60  69.51  94.30  81.06    540   14.029    33    3.972   839    0.978   18.979
  0.00   0.00   0.50  99.81  94.27  81.03    548   14.143    34    4.002   840    0.981   19.126
  0.00 100.00   0.59  70.47  94.27  81.03    549   14.177    34    4.002   844    0.985   19.164
  0.00 100.00   0.57  99.85  94.32  81.09    550   14.204    34    4.002   845    0.990   19.196
  0.00 100.00   0.65  77.69  94.32  81.09    559   14.469    36    4.198   847    0.993   19.659
  0.00 100.00   0.65  77.69  94.32  81.09    559   14.469    36    4.198   847    0.993   19.659
  0.00 100.00   0.70  35.54  94.32  81.09    567   14.763    37    4.378   853    1.001   20.142
  0.00 100.00   0.70  41.22  94.32  81.09    567   14.763    37    4.378   853    1.001   20.142
  0.00 100.00   1.89  96.76  94.32  81.09    574   14.943    38    4.487   859    1.007   20.438
  0.00 100.00   1.39  39.20  94.32  81.09    575   14.946    38    4.487   861    1.010   20.442
```

> å…¶ä¸­ï¼ŒS0è¡¨ç¤ºSurvivor0åŒºå ç”¨ç™¾åˆ†æ¯”ï¼ŒS1è¡¨ç¤ºSurvivor1åŒºå ç”¨ç™¾åˆ†æ¯”ï¼ŒEè¡¨ç¤ºEdenåŒºå ç”¨ç™¾åˆ†æ¯”ï¼ŒOè¡¨ç¤ºè€å¹´ä»£å ç”¨ç™¾åˆ†æ¯”ï¼ŒMè¡¨ç¤ºå…ƒæ•°æ®åŒºå ç”¨ç™¾åˆ†æ¯”ï¼ŒYGCè¡¨ç¤ºå¹´è½»ä»£å›æ”¶æ¬¡æ•°ï¼ŒYGCTè¡¨ç¤ºå¹´è½»ä»£å›æ”¶è€—æ—¶ï¼ŒFGCè¡¨ç¤ºè€å¹´ä»£å›æ”¶æ¬¡æ•°ï¼ŒFGCTè¡¨ç¤ºè€å¹´ä»£å›æ”¶è€—æ—¶ã€‚

jstatå‘½ä»¤çš„å‚æ•°ä¼—å¤šï¼ŒåŒ…å«-classã€-compilerã€-gcç­‰ã€‚Java 8ã€Linux/Unixå¹³å°jstatå·¥å…·çš„å®Œæ•´ä»‹ç»ï¼Œä½ å¯ä»¥æŸ¥çœ‹[è¿™é‡Œ](https://docs.oracle.com/javase/8/docs/technotes/tools/#monitor)ã€‚jstatå®šæ—¶è¾“å‡ºçš„ç‰¹æ€§ï¼Œå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬æŒç»­è§‚å¯Ÿç¨‹åºçš„å„é¡¹æŒ‡æ ‡ã€‚

ç»§ç»­æ¥åˆ°çº¿ç¨‹é¢æ¿å¯ä»¥çœ‹åˆ°ï¼Œå¤§é‡ä»¥Threadå¼€å¤´çš„çº¿ç¨‹åŸºæœ¬éƒ½æ˜¯æœ‰èŠ‚å¥çš„10ç§’è¿è¡Œä¸€ä¸‹ï¼Œå…¶ä»–æ—¶é—´éƒ½åœ¨ä¼‘çœ ï¼Œå’Œæˆ‘ä»¬çš„ä»£ç é€»è¾‘åŒ¹é…ï¼š

![](https://static001.geekbang.org/resource/image/7a/85/7a1616295b4ec51c56437d2a92652185.png?wh=3285%2A2054)

ç‚¹å‡»é¢æ¿çš„çº¿ç¨‹DumpæŒ‰é’®ï¼Œå¯ä»¥æŸ¥çœ‹çº¿ç¨‹ç¬æ—¶çš„çº¿ç¨‹æ ˆï¼š

![](https://static001.geekbang.org/resource/image/0d/00/0ddcd3348d1c8b0bba16736f9221a900.png?wh=3285%2A2054)

### jstack

é€šè¿‡å‘½ä»¤è¡Œå·¥å…·jstackï¼Œä¹Ÿå¯ä»¥å®ç°æŠ“å–çº¿ç¨‹æ ˆçš„æ“ä½œï¼š

```
âœ  ~ jstack 23940
2020-01-29 13:08:15
Full thread dump Java HotSpot(TM) 64-Bit Server VM (11.0.3+12-LTS mixed mode):

...

"main" #1 prio=5 os_prio=31 cpu=440.66ms elapsed=574.86s tid=0x00007ffdd9800000 nid=0x2803 waiting on condition  [0x0000700003849000]
   java.lang.Thread.State: TIMED_WAITING (sleeping)
	at java.lang.Thread.sleep(java.base@11.0.3/Native Method)
	at java.lang.Thread.sleep(java.base@11.0.3/Thread.java:339)
	at java.util.concurrent.TimeUnit.sleep(java.base@11.0.3/TimeUnit.java:446)
	at org.geekbang.time.commonmistakes.troubleshootingtools.jdktool.CommonMistakesApplication.main(CommonMistakesApplication.java:41)
	at jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(java.base@11.0.3/Native Method)
	at jdk.internal.reflect.NativeMethodAccessorImpl.invoke(java.base@11.0.3/NativeMethodAccessorImpl.java:62)
	at jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(java.base@11.0.3/DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(java.base@11.0.3/Method.java:566)
	at org.springframework.boot.loader.MainMethodRunner.run(MainMethodRunner.java:48)
	at org.springframework.boot.loader.Launcher.launch(Launcher.java:87)
	at org.springframework.boot.loader.Launcher.launch(Launcher.java:51)
	at org.springframework.boot.loader.JarLauncher.main(JarLauncher.java:52)

"Thread-1" #13 prio=5 os_prio=31 cpu=17851.77ms elapsed=574.41s tid=0x00007ffdda029000 nid=0x9803 waiting on condition  [0x000070000539d000]
   java.lang.Thread.State: TIMED_WAITING (sleeping)
	at java.lang.Thread.sleep(java.base@11.0.3/Native Method)
	at java.lang.Thread.sleep(java.base@11.0.3/Thread.java:339)
	at java.util.concurrent.TimeUnit.sleep(java.base@11.0.3/TimeUnit.java:446)
	at org.geekbang.time.commonmistakes.troubleshootingtools.jdktool.CommonMistakesApplication.lambda$null$1(CommonMistakesApplication.java:33)
	at org.geekbang.time.commonmistakes.troubleshootingtools.jdktool.CommonMistakesApplication$$Lambda$41/0x00000008000a8c40.run(Unknown Source)
	at java.lang.Thread.run(java.base@11.0.3/Thread.java:834)


...
```

æŠ“å–åå¯ä»¥ä½¿ç”¨ç±»ä¼¼[fastthread](https://fastthread.io/)è¿™æ ·çš„åœ¨çº¿åˆ†æå·¥å…·æ¥åˆ†æçº¿ç¨‹æ ˆã€‚

### jcmd

æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Java HotSpotè™šæ‹Ÿæœºçš„NMTåŠŸèƒ½ã€‚

é€šè¿‡NMTï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿç»†ç²’åº¦å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œè®¾ç½®-XX:NativeMemoryTracking=summary/detailå¯ä»¥å¼€å¯NMTåŠŸèƒ½ï¼Œå¼€å¯åå¯ä»¥ä½¿ç”¨jcmdå·¥å…·æŸ¥çœ‹NMTæ•°æ®ã€‚

æˆ‘ä»¬é‡æ–°å¯åŠ¨ä¸€æ¬¡ç¨‹åºï¼Œè¿™æ¬¡åŠ ä¸ŠJVMå‚æ•°ä»¥detailæ–¹å¼å¼€å¯NMTï¼š

```
-Xms1g -Xmx1g -XX:ThreadStackSize=256k -XX:NativeMemoryTracking=detail
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è¿˜å¢åŠ äº†-XX:ThreadStackSizeå‚æ•°ï¼Œå¹¶å°†å…¶å€¼è®¾ç½®ä¸º256kï¼Œä¹Ÿå°±æ˜¯æœŸæœ›æŠŠçº¿ç¨‹æ ˆè®¾ç½®ä¸º256KBã€‚æˆ‘ä»¬é€šè¿‡NMTè§‚å¯Ÿä¸€ä¸‹è®¾ç½®æ˜¯å¦æˆåŠŸã€‚

å¯åŠ¨ç¨‹åºåæ‰§è¡Œå¦‚ä¸‹jcmdå‘½ä»¤ï¼Œä»¥æ¦‚è¦å½¢å¼è¾“å‡ºNMTç»“æœã€‚å¯ä»¥çœ‹åˆ°ï¼Œ**å½“å‰æœ‰32ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹æ ˆæ€»å…±ä¿ç•™äº†å·®ä¸å¤š4GBå·¦å³çš„å†…å­˜**ã€‚æˆ‘ä»¬æ˜æ˜é…ç½®çº¿ç¨‹æ ˆæœ€å¤§256KBå•Šï¼Œä¸ºä»€ä¹ˆä¼šå‡ºç°4GBè¿™ä¹ˆå¤¸å¼ çš„æ•°å­—å‘¢ï¼Œåˆ°åº•å“ªé‡Œå‡ºäº†é—®é¢˜å‘¢ï¼Ÿ

```
âœ  ~ jcmd 24404 VM.native_memory summary
24404:


Native Memory Tracking:


Total: reserved=6635310KB, committed=5337110KB
-                 Java Heap (reserved=1048576KB, committed=1048576KB)
                            (mmap: reserved=1048576KB, committed=1048576KB)


-                     Class (reserved=1066233KB, committed=15097KB)
                            (classes #902)
                            (malloc=9465KB #908)
                            (mmap: reserved=1056768KB, committed=5632KB)


-                    Thread (reserved=4209797KB, committed=4209797KB)
                            (thread #32)
                            (stack: reserved=4209664KB, committed=4209664KB)
                            (malloc=96KB #165)
                            (arena=37KB #59)


-                      Code (reserved=249823KB, committed=2759KB)
                            (malloc=223KB #730)
                            (mmap: reserved=249600KB, committed=2536KB)


-                        GC (reserved=48700KB, committed=48700KB)
                            (malloc=10384KB #135)
                            (mmap: reserved=38316KB, committed=38316KB)


-                  Compiler (reserved=186KB, committed=186KB)
                            (malloc=56KB #105)
                            (arena=131KB #7)


-                  Internal (reserved=9693KB, committed=9693KB)
                            (malloc=9661KB #2585)
                            (mmap: reserved=32KB, committed=32KB)


-                    Symbol (reserved=2021KB, committed=2021KB)
                            (malloc=1182KB #334)
                            (arena=839KB #1)


-    Native Memory Tracking (reserved=85KB, committed=85KB)
                            (malloc=5KB #53)
                            (tracking overhead=80KB)


-               Arena Chunk (reserved=196KB, committed=196KB)
                            (malloc=196KB)            
```

é‡æ–°ä»¥VM.native\_memory detailå‚æ•°è¿è¡Œjcmdï¼š

```
jcmd 24404 VM.native_memory detail
```

å¯ä»¥çœ‹åˆ°ï¼Œ**æœ‰16ä¸ªå¯ç–‘çº¿ç¨‹ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹ä¿ç•™äº†262144KBå†…å­˜ï¼Œä¹Ÿå°±æ˜¯256MB**ï¼ˆé€šè¿‡ä¸‹å›¾çº¢æ¡†å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨å…³é”®å­—262144KB for Thread Stack fromæœç´¢åˆ°äº†16ä¸ªç»“æœï¼‰ï¼š

![](https://static001.geekbang.org/resource/image/f2/6b/f24869cbd1190c508e085c9f3400d06b.png?wh=2501%2A1798)

å…¶å®ï¼ŒThreadStackSizeå‚æ•°çš„å•ä½æ˜¯KBï¼Œ**æ‰€ä»¥æˆ‘ä»¬å¦‚æœè¦è®¾ç½®çº¿ç¨‹æ ˆ256KBï¼Œé‚£ä¹ˆåº”è¯¥è®¾ç½®256è€Œä¸æ˜¯256k**ã€‚é‡æ–°è®¾ç½®æ­£ç¡®çš„å‚æ•°åï¼Œä½¿ç”¨jcmdå†æ¬¡éªŒè¯ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/d7/c9/d7228ec216003d31064698e7e16c81c9.png?wh=2256%2A1668)

é™¤äº†ç”¨äºæŸ¥çœ‹NMTå¤–ï¼Œjcmdè¿˜æœ‰è®¸å¤šåŠŸèƒ½ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡helpï¼Œçœ‹åˆ°å®ƒçš„æ‰€æœ‰åŠŸèƒ½ï¼š

```
jcmd 24781 help
```

å¯¹äºå…¶ä¸­æ¯ä¸€ç§åŠŸèƒ½ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥è¿›ä¸€æ­¥ä½¿ç”¨helpæ¥æŸ¥çœ‹ä»‹ç»ã€‚æ¯”å¦‚ï¼Œä½¿ç”¨GC.heap\_infoå‘½ä»¤å¯ä»¥æ‰“å°Javaå †çš„ä¸€äº›ä¿¡æ¯ï¼š

```
jcmd 24781 help GC.heap_info
```

é™¤äº†jpsã€jinfoã€jcmdã€jstackã€jstatã€jconsoleã€jvisualvmå¤–ï¼ŒJDKä¸­è¿˜æœ‰ä¸€äº›å·¥å…·ï¼Œä½ å¯ä»¥é€šè¿‡[å®˜æ–¹æ–‡æ¡£](https://docs.oracle.com/javase/8/docs/technotes/tools/)æŸ¥çœ‹å®Œæ•´ä»‹ç»ã€‚

## ä½¿ç”¨Wiresharkåˆ†æSQLæ‰¹é‡æ’å…¥æ…¢çš„é—®é¢˜

æˆ‘ä¹‹å‰é‡åˆ°è¿‡è¿™æ ·ä¸€ä¸ªæ¡ˆä¾‹ï¼šæœ‰ä¸€ä¸ªæ•°æ®å¯¼å…¥ç¨‹åºéœ€è¦å¯¼å…¥å¤§é‡çš„æ•°æ®ï¼Œå¼€å‘åŒå­¦å°±æƒ³åˆ°äº†ä½¿ç”¨Spring JdbcTemplateçš„æ‰¹é‡æ“ä½œåŠŸèƒ½è¿›è¡Œæ•°æ®æ‰¹é‡å¯¼å…¥ï¼Œä½†æ˜¯å‘ç°æ€§èƒ½éå¸¸å·®ï¼Œå’Œæ™®é€šçš„å•æ¡SQLæ‰§è¡Œæ€§èƒ½å·®ä¸å¤šã€‚

æˆ‘ä»¬é‡ç°ä¸‹è¿™ä¸ªæ¡ˆä¾‹ã€‚å¯åŠ¨ç¨‹åºåï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªtestuserè¡¨ï¼Œå…¶ä¸­åªæœ‰ä¸€åˆ—nameï¼Œç„¶åä½¿ç”¨JdbcTemplateçš„batchUpdateæ–¹æ³•ï¼Œæ‰¹é‡æ’å…¥10000æ¡è®°å½•åˆ°testuserè¡¨ï¼š

```
@SpringBootApplication
@Slf4j
public class BatchInsertAppliation implements CommandLineRunner {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    public static void main(String[] args) {
        SpringApplication.run(BatchInsertApplication.class, args);
    }

    @PostConstruct
    public void init() {
        //åˆå§‹åŒ–è¡¨
        jdbcTemplate.execute("drop table IF EXISTS `testuser`;");
        jdbcTemplate.execute("create TABLE `testuser` (\n" +
                "  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n" +
                "  `name` varchar(255) NOT NULL,\n" +
                "  PRIMARY KEY (`id`)\n" +
                ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;");
    }

    @Override
    public void run(String... args) {

        long begin = System.currentTimeMillis();
        String sql = "INSERT INTO `testuser` (`name`) VALUES (?)";
        //ä½¿ç”¨JDBCæ‰¹é‡æ›´æ–°
        jdbcTemplate.batchUpdate(sql, new BatchPreparedStatementSetter() {
            @Override
            public void setValues(PreparedStatement preparedStatement, int i) throws SQLException {
                //ç¬¬ä¸€ä¸ªå‚æ•°(ç´¢å¼•ä»1å¼€å§‹)ï¼Œä¹Ÿå°±æ˜¯nameåˆ—èµ‹å€¼
                preparedStatement.setString(1, "usera" + i);
            }

            @Override
            public int getBatchSize() {
                //æ‰¹æ¬¡å¤§å°ä¸º10000
                return 10000;
            }
        });
        log.info("took : {} ms", System.currentTimeMillis() - begin);
    }
}
```

æ‰§è¡Œç¨‹åºåå¯ä»¥çœ‹åˆ°ï¼Œ1ä¸‡æ¡æ•°æ®æ’å…¥è€—æ—¶26ç§’ï¼š

```
[14:44:19.094] [main] [INFO ] [o.g.t.c.t.network.BatchInsertApplication:52  ] - took : 26144 ms
```

å…¶å®ï¼Œå¯¹äºæ‰¹é‡æ“ä½œï¼Œæˆ‘ä»¬å¸Œæœ›ç¨‹åºå¯ä»¥æŠŠå¤šæ¡insert SQLè¯­å¥åˆå¹¶æˆä¸€æ¡ï¼Œæˆ–è‡³å°‘æ˜¯ä¸€æ¬¡æ€§æäº¤å¤šæ¡è¯­å¥åˆ°æ•°æ®åº“ï¼Œä»¥å‡å°‘å’ŒMySQLäº¤äº’æ¬¡æ•°ã€æé«˜æ€§èƒ½ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬çš„ç¨‹åºæ˜¯è¿™æ ·è¿ä½œçš„å—ï¼Ÿ

æˆ‘åœ¨[åŠ é¤3](https://time.geekbang.org/column/article/221982)ä¸­æåˆ°ä¸€æ¡åŸåˆ™ï¼Œâ€œåˆ†æé—®é¢˜ä¸€å®šæ˜¯éœ€è¦ä¾æ®çš„ï¼Œé çŒœæ˜¯çŒœä¸å‡ºæ¥çš„â€ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨ç½‘ç»œåˆ†æå·¥å…·Wiresharkæ¥åˆ†æä¸€ä¸‹è¿™ä¸ªæ¡ˆä¾‹ï¼Œçœ¼è§ä¸ºå®ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥åœ¨[è¿™é‡Œ](https://www.wireshark.org/download.html)ä¸‹è½½Wiresharkï¼Œå¯åŠ¨åé€‰æ‹©æŸä¸ªéœ€è¦æ•è·çš„ç½‘å¡ã€‚ç”±äºæˆ‘ä»¬è¿æ¥çš„æ˜¯æœ¬åœ°çš„MySQLï¼Œå› æ­¤é€‰æ‹©loopbackå›ç¯ç½‘å¡ï¼š

![](https://static001.geekbang.org/resource/image/d7/9b/d7c3cc2d997990d0c4b94f72f1679c9b.png?wh=2336%2A1753)

ç„¶åï¼ŒWiresharkæ•æ‰è¿™ä¸ªç½‘å¡çš„æ‰€æœ‰ç½‘ç»œæµé‡ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä¸Šæ–¹çš„æ˜¾ç¤ºè¿‡æ»¤æ è¾“å…¥tcp.port == 6657ï¼Œæ¥è¿‡æ»¤å‡ºæ‰€æœ‰6657ç«¯å£çš„TCPè¯·æ±‚ï¼ˆå› ä¸ºæˆ‘ä»¬æ˜¯é€šè¿‡6657ç«¯å£è¿æ¥MySQLçš„ï¼‰ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºè¿è¡ŒæœŸé—´å’ŒMySQLæœ‰å¤§é‡äº¤äº’ã€‚å› ä¸ºWiresharkç›´æ¥æŠŠTCPæ•°æ®åŒ…è§£æä¸ºäº†MySQLåè®®ï¼Œæ‰€ä»¥ä¸‹æ–¹çª—å£å¯ä»¥ç›´æ¥æ˜¾ç¤ºMySQLè¯·æ±‚çš„SQLæŸ¥è¯¢è¯­å¥ã€‚**æˆ‘ä»¬çœ‹åˆ°ï¼Œtestuserè¡¨çš„æ¯æ¬¡insertæ“ä½œï¼Œæ’å…¥çš„éƒ½æ˜¯ä¸€è¡Œè®°å½•**ï¼š

![](https://static001.geekbang.org/resource/image/bc/a2/bcb987cab3cccf4d8729cfe44f01a2a2.png?wh=2336%2A1752)

å¦‚æœåˆ—è¡¨ä¸­çš„Protocolæ²¡æœ‰æ˜¾ç¤ºMySQLçš„è¯ï¼Œä½ å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»Analyzeèœå•çš„Decode Asèœå•ï¼Œç„¶ååŠ ä¸€æ¡è§„åˆ™ï¼ŒæŠŠ6657ç«¯å£è®¾ç½®ä¸ºMySQLåè®®ï¼š

![](https://static001.geekbang.org/resource/image/6a/f2/6ae982e2013cf1c60300332068b58cf2.png?wh=1500%2A964)

è¿™å°±è¯´æ˜ï¼Œæˆ‘ä»¬çš„ç¨‹åºå¹¶ä¸æ˜¯åœ¨åšæ‰¹é‡æ’å…¥æ“ä½œï¼Œå’Œæ™®é€šçš„å•æ¡å¾ªç¯æ’å…¥æ²¡æœ‰åŒºåˆ«ã€‚è°ƒè¯•ç¨‹åºè¿›å…¥ClientPreparedStatementç±»ï¼Œå¯ä»¥çœ‹åˆ°æ‰§è¡Œæ‰¹é‡æ“ä½œçš„æ˜¯executeBatchInternalæ–¹æ³•ã€‚executeBatchInternalæ–¹æ³•çš„æºç å¦‚ä¸‹ï¼š

```
@Override
protected long[] executeBatchInternal() throws SQLException {
    synchronized (checkClosed().getConnectionMutex()) {
        if (this.connection.isReadOnly()) {
            throw new SQLException(Messages.getString("PreparedStatement.25") + Messages.getString("PreparedStatement.26"),
                    MysqlErrorNumbers.SQL_STATE_ILLEGAL_ARGUMENT);
        }
        if (this.query.getBatchedArgs() == null || this.query.getBatchedArgs().size() == 0) {
            return new long[0];
        }
        // we timeout the entire batch, not individual statements
        int batchTimeout = getTimeoutInMillis();
        setTimeoutInMillis(0);
        resetCancelledState();
        try {
            statementBegins();
            clearWarnings();
            if (!this.batchHasPlainStatements && this.rewriteBatchedStatements.getValue()) {
                if (((PreparedQuery<?>) this.query).getParseInfo().canRewriteAsMultiValueInsertAtSqlLevel()) {
                    return executeBatchedInserts(batchTimeout);
                }
                if (!this.batchHasPlainStatements && this.query.getBatchedArgs() != null
                        && this.query.getBatchedArgs().size() > 3 /* cost of option setting rt-wise */) {
                    return executePreparedBatchAsMultiStatement(batchTimeout);
                }
            }
            return executeBatchSerially(batchTimeout);
        } finally {
            this.query.getStatementExecuting().set(false);
            clearBatch();
        }
    }
}
```

æ³¨æ„ç¬¬18è¡Œï¼Œåˆ¤æ–­äº†rewriteBatchedStatementså‚æ•°æ˜¯å¦ä¸ºtrueï¼Œæ˜¯æ‰ä¼šå¼€å¯æ‰¹é‡çš„ä¼˜åŒ–ã€‚ä¼˜åŒ–æ–¹å¼æœ‰2ç§ï¼š

- å¦‚æœæœ‰æ¡ä»¶çš„è¯ï¼Œä¼˜å…ˆæŠŠinsertè¯­å¥ä¼˜åŒ–ä¸ºä¸€æ¡è¯­å¥ï¼Œä¹Ÿå°±æ˜¯executeBatchedInsertsæ–¹æ³•ï¼›
- å¦‚æœä¸è¡Œçš„è¯ï¼Œå†å°è¯•æŠŠinsertè¯­å¥ä¼˜åŒ–ä¸ºå¤šæ¡è¯­å¥ä¸€èµ·æäº¤ï¼Œä¹Ÿå°±æ˜¯executePreparedBatchAsMultiStatementæ–¹æ³•ã€‚

åˆ°è¿™é‡Œå°±æ˜æœ—äº†ï¼Œå®ç°æ‰¹é‡æäº¤ä¼˜åŒ–çš„å…³é”®ï¼Œåœ¨äºrewriteBatchedStatementså‚æ•°ã€‚æˆ‘ä»¬ä¿®æ”¹è¿æ¥å­—ç¬¦ä¸²ï¼Œå¹¶å°†å…¶å€¼è®¾ç½®ä¸ºtrueï¼š

```
spring.datasource.url=jdbc:mysql://localhost:6657/common_mistakes?characterEncoding=UTF-8&useSSL=false&rewriteBatchedStatements=true
```

é‡æ–°æŒ‰ç…§ä¹‹å‰çš„æ­¥éª¤æ‰“å¼€WiresharkéªŒè¯ï¼Œå¯ä»¥çœ‹åˆ°ï¼š

- è¿™æ¬¡insert SQLè¯­å¥è¢«æ‹¼æ¥æˆäº†ä¸€æ¡è¯­å¥ï¼ˆå¦‚ç¬¬äºŒä¸ªçº¢æ¡†æ‰€ç¤ºï¼‰ï¼›
- è¿™ä¸ªTCPåŒ…å› ä¸ºå¤ªå¤§è¢«åˆ†å‰²æˆäº†11ä¸ªç‰‡æ®µä¼ è¾“ï¼Œ#699è¯·æ±‚æ˜¯æœ€åä¸€ä¸ªç‰‡æ®µï¼Œå…¶å®é™…å†…å®¹æ˜¯insertè¯­å¥çš„æœ€åä¸€éƒ¨åˆ†å†…å®¹ï¼ˆå¦‚ç¬¬ä¸€å’Œç¬¬ä¸‰ä¸ªçº¢æ¡†æ˜¾ç¤ºï¼‰ã€‚

![](https://static001.geekbang.org/resource/image/3b/bc/3b7406c96a90e454a00e3c8ba82ecfbc.png?wh=2858%2A2030)

ä¸ºäº†æŸ¥çœ‹æ•´ä¸ªTCPè¿æ¥çš„æ‰€æœ‰æ•°æ®åŒ…ï¼Œä½ å¯ä»¥åœ¨è¯·æ±‚ä¸Šç‚¹å‡»å³é”®ï¼Œé€‰æ‹©Follow-&gt;TCP Streamï¼š

![](https://static001.geekbang.org/resource/image/5b/c2/5b18a8c6c227df50ad493f5aa546f9c2.png?wh=732%2A734)

æ‰“å¼€åå¯ä»¥çœ‹åˆ°ï¼Œä»MySQLè®¤è¯å¼€å§‹åˆ°insertè¯­å¥çš„æ‰€æœ‰æ•°æ®åŒ…çš„å†…å®¹ï¼š

![](https://static001.geekbang.org/resource/image/e1/5a/e154da637a2b44a65f9257beb842575a.png?wh=1904%2A2030)

æŸ¥çœ‹æœ€å¼€å§‹çš„æ¡æ‰‹æ•°æ®åŒ…å¯ä»¥å‘ç°ï¼ŒTCPçš„æœ€å¤§åˆ†æ®µå¤§å°ï¼ˆMSSï¼‰æ˜¯16344å­—èŠ‚ï¼Œè€Œæˆ‘ä»¬çš„MySQLè¶…é•¿insertçš„æ•°æ®ä¸€å…±138933å­—èŠ‚ï¼Œå› æ­¤è¢«åˆ†æˆäº†11æ®µä¼ è¾“ï¼Œå…¶ä¸­æœ€å¤§çš„ä¸€æ®µæ˜¯16332å­—èŠ‚ï¼Œä½äºMSSè¦æ±‚çš„16344å­—èŠ‚ã€‚

![](https://static001.geekbang.org/resource/image/3e/9e/3e66a004fd4b7dba14047751a57e089e.png?wh=2858%2A2030)

æœ€åå¯ä»¥çœ‹åˆ°æ’å…¥1ä¸‡æ¡æ•°æ®ä»…è€—æ—¶253æ¯«ç§’ï¼Œæ€§èƒ½æå‡äº†100å€ï¼š

```
[20:19:30.185] [main] [INFO ] [o.g.t.c.t.network.BatchInsertApplication:52  ] - took : 253 ms
```

è™½ç„¶æˆ‘ä»¬ä¸€ç›´åœ¨ä½¿ç”¨MySQLï¼Œä½†æˆ‘ä»¬å¾ˆå°‘ä¼šè€ƒè™‘MySQL Connector Javaæ˜¯æ€ä¹ˆå’ŒMySQLäº¤äº’çš„ï¼Œå®é™…å‘é€ç»™MySQLçš„SQLè¯­å¥åˆæ˜¯æ€æ ·çš„ã€‚æœ‰æ²¡æœ‰æ„Ÿè§‰åˆ°ï¼ŒMySQLåè®®å…¶å®å¹¶ä¸é¥è¿œï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ä½¿ç”¨Wiresharkæ¥è§‚å¯Ÿã€åˆ†æåº”ç”¨ç¨‹åºä¸MySQLäº¤äº’çš„æ•´ä¸ªæµç¨‹ã€‚

## é‡ç‚¹å›é¡¾

ä»Šå¤©ï¼Œæˆ‘å°±ä½¿ç”¨JDKè‡ªå¸¦å·¥å…·æŸ¥çœ‹JVMæƒ…å†µã€ä½¿ç”¨Wiresharkåˆ†æSQLæ‰¹é‡æ’å…¥æ…¢çš„é—®é¢˜ï¼Œå’Œä½ å±•ç¤ºäº†ä¸€äº›å·¥å…·åŠå…¶ç”¨æ³•ã€‚

é¦–å…ˆï¼ŒJDKè‡ªå¸¦çš„ä¸€äº›ç›‘æ§å’Œæ•…éšœè¯Šæ–­å·¥å…·ä¸­ï¼Œæœ‰å‘½ä»¤è¡Œå·¥å…·ä¹Ÿæœ‰å›¾å½¢å·¥å…·ã€‚å…¶ä¸­ï¼Œå‘½ä»¤è¡Œå·¥å…·æ›´é€‚åˆåœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨ï¼Œå›¾å½¢ç•Œé¢å·¥å…·ç”¨äºæœ¬åœ°è§‚å¯Ÿæ•°æ®æ›´ç›´è§‚ã€‚ä¸ºäº†å¸®åŠ©ä½ ç”¨å¥½è¿™äº›å·¥å…·ï¼Œæˆ‘ä»¬å¸¦ä½ ä½¿ç”¨è¿™äº›å·¥å…·ï¼Œåˆ†æäº†ç¨‹åºé”™è¯¯è®¾ç½®JVMå‚æ•°çš„ä¸¤ä¸ªé—®é¢˜ï¼Œå¹¶ä¸”è§‚å¯Ÿäº†GCå·¥ä½œçš„æƒ…å†µã€‚

ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨Wiresharkåˆ†æäº†MySQLæ‰¹é‡insertæ“ä½œæ…¢çš„é—®é¢˜ã€‚æˆ‘ä»¬çœ‹åˆ°ï¼Œé€šè¿‡Wiresharkåˆ†æç½‘ç»œåŒ…å¯ä»¥è®©ä¸€åˆ‡å˜å¾—å¦‚æ­¤é€æ˜ã€‚å› æ­¤ï¼Œå­¦å¥½Wiresharkï¼Œå¯¹æˆ‘ä»¬æ’æŸ¥C/Sç½‘ç»œç¨‹åºçš„Bugæˆ–æ€§èƒ½é—®é¢˜ï¼Œä¼šæœ‰éå¸¸å¤§çš„å¸®åŠ©ã€‚

æ¯”å¦‚ï¼Œé‡åˆ°è¯¸å¦‚Connection resetã€Broken pipeç­‰ç½‘ç»œé—®é¢˜çš„æ—¶å€™ï¼Œä½ å¯ä»¥åˆ©ç”¨Wiresharkæ¥å®šä½é—®é¢˜ï¼Œè§‚å¯Ÿå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´åˆ°åº•å‡ºäº†ä»€ä¹ˆé—®é¢˜ã€‚

æ­¤å¤–ï¼Œå¦‚æœä½ éœ€è¦å¼€å‘ç½‘ç»œç¨‹åºçš„è¯ï¼ŒWiresharkæ›´æ˜¯åˆ†æåè®®ã€ç¡®è®¤ç¨‹åºæ˜¯å¦æ­£ç¡®å®ç°çš„å¿…å¤‡å·¥å…·ã€‚

ä»Šå¤©ç”¨åˆ°çš„ä»£ç ï¼Œæˆ‘éƒ½æ”¾åœ¨äº†GitHubä¸Šï¼Œä½ å¯ä»¥ç‚¹å‡»[è¿™ä¸ªé“¾æ¥](https://github.com/JosephZhu1983/java-common-mistakes)æŸ¥çœ‹ã€‚

## æ€è€ƒä¸è®¨è®º

1. JDKä¸­è¿˜æœ‰ä¸€ä¸ªjmapå·¥å…·ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨jmap -dumpå‘½ä»¤æ¥è¿›è¡Œå †è½¬å‚¨ã€‚é‚£ä¹ˆï¼Œè¿™æ¡å‘½ä»¤å’Œjmap -dump:liveæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿä½ èƒ½å¦è®¾è®¡ä¸€ä¸ªå®éªŒï¼Œæ¥è¯æ˜ä¸‹å®ƒä»¬çš„åŒºåˆ«å‘¢ï¼Ÿ
2. ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œå®¢æˆ·ç«¯æ˜¯å¦‚ä½•å’ŒMySQLè¿›è¡Œè®¤è¯çš„å‘¢ï¼Ÿä½ èƒ½å¦å¯¹ç…§[MySQLçš„æ–‡æ¡£](https://dev.mysql.com/doc/internals/en/connection-phase-packets.html#packet-Protocol::Handshake)ï¼Œä½¿ç”¨Wiresharkè§‚å¯Ÿåˆ†æè¿™ä¸€è¿‡ç¨‹å‘¢ï¼Ÿ

åœ¨å¹³æ—¶å·¥ä½œä¸­ï¼Œä½ è¿˜ä¼šä½¿ç”¨ä»€ä¹ˆå·¥å…·æ¥åˆ†ææ’æŸ¥Javaåº”ç”¨ç¨‹åºçš„é—®é¢˜å‘¢ï¼Ÿæˆ‘æ˜¯æœ±æ™”ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºä¸æˆ‘ç•™è¨€åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ï¼Œä¸€èµ·äº¤æµã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>Darren</span> ğŸ‘ï¼ˆ24ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>1ã€jmap -dumpæ˜¯ä¼šdumpæ‰€æœ‰çš„å¯¹è±¡ï¼Œä¸å…³å¿ƒæ˜¯å¦å¯è¾¾ï¼›jmap -dump:liveåªä¼šdumpå­˜æ´»çš„å¯¹è±¡ï¼Œå³å¯ä»¥ä»GcRootå¯è¾¾çš„å¯¹è±¡ã€‚æµ‹è¯•æ˜¯åœ¨å¾ªç¯ä¸­ï¼Œä¸€ç›´åˆ›å»ºå¯¹è±¡ï¼Œç„¶åä¼‘çœ 1sï¼Œdump2æ¬¡ï¼Œå‘ç°åˆ›å»ºå¯¹è±¡çš„ä¸ªæ•°ä¸åŒã€‚</p>2020-04-22</li><br/><li><span>ç¨‹åºå‘˜å°è·ƒ</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è€å¸ˆï¼Œä½ è®©æˆ‘è¿™ä¸ªJavaé‡æ–°æ•´ç†äº†æ–¹å‘ï¼Œè¿™æ‰æ˜¯ Java æ›´é«˜å±‚æ¬¡éœ€è¦æŒæ¡çš„ä¸œè¥¿ï¼Œä¸ç„¶å¹³æ—¶åªçŸ¥é“å†™ä»£ç ï¼Œé‡åˆ°é—®é¢˜åªä¼šé‡å¯çš„è¯ï¼Œå¯¹è‡ªå·±èƒ½åŠ›çš„æå‡å®åœ¨æ˜¯å¤ªæ…¢äº†ã€‚

Java çš„ä¸–ç•Œï¼Œè¿˜æ˜¯ç¦»ä¸å¼€ JVMçš„åˆ¤æ–­ã€‚Wireshark åŸæ¥è¿˜å¯ä»¥åˆ†æ MySQL ç›¸å…³ï¼Œä»¥å‰ä¸€ç›´è§‰å¾—åªèƒ½ç½‘ç»œæŠ“åŒ…å‘¢ï¼Œå“ˆå“ˆ</p>2020-10-31</li><br/><li><span>å°æ°</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆç°åœ¨ç‰¹åˆ«ç«çš„é˜¿é‡Œå®šä½é—®é¢˜çš„å·¥å…·Arthas  æ˜¯ä¸æ˜¯éƒ½æ˜¯æ‹¿jvmå·¥å…·å®ç°çš„å‘¢ï¼Œæ„Ÿè§‰å¾ˆå¼ºå¤§</p>2020-04-21</li><br/><li><span>ğŸ‘½</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¢™è£‚å»ºè®®æ”¶è—ï¼Œæ€»æœ‰ä¸€å¤©ç”¨å¾—ç€ã€‚</p>2020-04-21</li><br/><li><span>æ¢¦å€šæ æ†</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>-XX:ThreadStackSize=256k å®é™…æ•ˆæœæ˜¯256M
-Xss:256k å®é™…æ•ˆæœæ˜¯256k
å®˜æ–¹æ–‡æ¡£æç¤ºè¿™ä¸¤ä¸ªå‚æ•°æ•ˆæœç­‰åŒï¼Œéƒ½æ˜¯byteä¸ºå•ä½
https:&#47;&#47;docs.oracle.com&#47;javase&#47;8&#47;docs&#47;technotes&#47;tools&#47;unix&#47;java.html#BABHDABI</p>2020-04-22</li><br/><li><span>æ¢¦å€šæ æ†</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<p>è€å¸ˆï¼Œä½ çš„ç¬¬ä¸€ä¸ªæ¼”ç¤ºæˆ‘è¿™å„¿ç›´æ¥å°±è¢«æ€æ‰äº†
 java -jar target&#47;java-common-mistakes-0.0.1-SNAPSHOT.jar -Xms1g -Xmx1g
 jps æ­£å¸¸
jinfo $pid
æç¤ºï¼šError attaching to process ï¼š Can&#39;t attach symbolicator to the process
å‘ç°è¿›ç¨‹å·²ç»è¢«killæ‰</p>2020-04-22</li><br/><li><span>è‹¥é•œ</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä½œä¸ºåŒæ ·çš„ä¸€ä¸ª15years+çš„programmer ä¸å¾—ä¸è¯´ è€å¸ˆåˆ†äº«çš„è¶³å¤Ÿå¹²è´§ å¤šè°¢ã€‚</p>2020-10-23</li><br/><li><span>Geek_3b1096</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é‡æ–°è®¤è¯†ç”¨Wiresharkåˆ†æé—®é¢˜ï¼Œè°¢è°¢è€å¸ˆ</p>2020-05-01</li><br/><li><span>vivi</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>jmap -dumpæ˜¯è¾“å‡ºå †ä¸­æ‰€æœ‰å¯¹è±¡  jmap -dump:liveæ˜¯è¾“å‡ºå †ä¸­æ‰€æœ‰æ´»ç€çš„å¯¹è±¡  è€Œä¸”jmap -dump:liveä¼šè§¦å‘gc  çº¿ä¸Šä½¿ç”¨è¦æ³¨æ„è¿™ä¸ª</p>2020-04-21</li><br/><li><span>åˆ˜å¤§æ˜</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¿™ç¯‡å®šä½javaé—®é¢˜çš„æ–‡ç« ,çœŸçš„æ˜¯æ‰“å¼€äº†æ–°å¤©åœ°.ä»¥å‰é‡æ¥æ²¡æœ‰å…³æ³¨è¿‡jvmç›¸å…³çš„ä¿¡æ¯,è¿™æ¬¡æ˜¯å¼€äº†çœ¼ç•Œ.</p>2020-04-21</li><br/><li><span>FelixFly</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œå’¨è¯¢ä¸€ä¸‹Full GC åŸºæœ¬ 10 ç§’ä¸€æ¬¡è¿™ä¸ªç»“è®ºæ˜¯æ€ä¹ˆæ€»ç»“å‡ºæ¥çš„ï¼ŸFull GCä¸€èˆ¬æ§åˆ¶åœ¨å¤šå°‘ç§’ä¸€æ¬¡æ¯”è¾ƒå¥½ï¼Ÿ</p>2020-05-13</li><br/><li><span>å­ä¸è¯­</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è€å¸ˆå¥½ï¼Œç¬¬ä¸€ä¸ªä¾‹å­ï¼Œå¯åŠ¨ 10 ä¸ªæ­»å¾ªç¯çš„çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ª 10MB å·¦å³çš„å­—ç¬¦ä¸²ï¼Œç„¶åä¼‘çœ  10 ç§’ï¼Œå®Œæ•´çš„ä»£ç èƒ½ç»™ä¸‹å—ã€‚æˆ–è€…èƒ½å¦æŠŠæ¡ˆä¾‹çš„ä»£ç éƒ½ä¸Šä¼ åˆ°githubã€‚</p>2020-05-02</li><br/><li><span>æ¶¦æ¬¢â¿</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆè¯¾ç¨‹çœŸçš„å¾ˆå¥½ï¼Œå¸¦æˆ‘è¿›å…¥äº†æ–°javaé¢†åŸŸã€‚

æ„Ÿè°¢ï¼Œæ¯èŠ‚è¯¾éƒ½æœ‰è®¤çœŸçœ‹ã€‚å†™mdç¬”è®°ã€‚</p>2020-05-12</li><br/><li><span>hellojd</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¿æ¥mysql,å¯ä»¥æŒ‡å®šå›ºå®šç«¯å£ï¼Ÿæ€ä¹ˆè®¾ç½®ï¼Ÿæœ‰å•¥æ„ä¹‰ï¼Ÿä¸å¤ªæ˜ç™½</p>2020-04-22</li><br/><li><span>ä¸èƒ½å¿çš„åœ°ç²¾</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>åˆšå¥½æœ€è¿‘åœ¨çœ‹JVM.æ˜¨å¤©åˆ©ç”¨jvmçš„å·¥å…·å‘ç°äº†ç”Ÿäº§OOMçš„åŸå› ,ä»Šå¤©åˆè¡¥è¯¾äº†</p>2020-04-21</li><br/>
</ul>