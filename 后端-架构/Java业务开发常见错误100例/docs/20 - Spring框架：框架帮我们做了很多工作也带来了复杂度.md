ä½ å¥½ï¼Œæˆ‘æ˜¯æœ±æ™”ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬èŠèŠSpringæ¡†æ¶ç»™ä¸šåŠ¡ä»£ç å¸¦æ¥çš„å¤æ‚åº¦ï¼Œä»¥åŠä¸ä¹‹ç›¸å…³çš„å‘ã€‚

åœ¨ä¸Šä¸€è®²ï¼Œé€šè¿‡AOPå®ç°ç»Ÿä¸€çš„ç›‘æ§ç»„ä»¶çš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†IoCå’ŒAOPé…åˆä½¿ç”¨çš„å¨åŠ›ï¼šå½“å¯¹è±¡ç”±Springå®¹å™¨ç®¡ç†æˆä¸ºBeanä¹‹åï¼Œæˆ‘ä»¬ä¸ä½†å¯ä»¥é€šè¿‡å®¹å™¨ç®¡ç†é…ç½®Beançš„å±æ€§ï¼Œè¿˜å¯ä»¥æ–¹ä¾¿åœ°å¯¹æ„Ÿå…´è¶£çš„æ–¹æ³•åšAOPã€‚

ä¸è¿‡ï¼Œå‰ææ˜¯å¯¹è±¡å¿…é¡»æ˜¯Beanã€‚ä½ å¯èƒ½ä¼šè§‰å¾—è¿™ä¸ªç»“è®ºå¾ˆæ˜æ˜¾ï¼Œä¹Ÿå¾ˆå®¹æ˜“ç†è§£å•Šã€‚ä½†å°±å’Œä¸Šä¸€è®²æåˆ°çš„Beané»˜è®¤æ˜¯å•ä¾‹ä¸€æ ·ï¼Œç†è§£èµ·æ¥ç®€å•ï¼Œå®è·µçš„æ—¶å€™å´éå¸¸å®¹æ˜“è¸©å‘ã€‚å…¶ä¸­åŸå› ï¼Œä¸€æ–¹é¢æ˜¯ï¼Œç†è§£Springçš„ä½“ç³»ç»“æ„å’Œä½¿ç”¨æ–¹å¼æœ‰ä¸€å®šæ›²çº¿ï¼›å¦ä¸€æ–¹é¢æ˜¯ï¼ŒSpringå¤šå¹´å‘å±•å †ç§¯èµ·æ¥çš„å†…éƒ¨ç»“æ„éå¸¸å¤æ‚ï¼Œè¿™ä¹Ÿæ˜¯æ›´é‡è¦çš„åŸå› ã€‚

åœ¨æˆ‘çœ‹æ¥ï¼ŒSpringæ¡†æ¶å†…éƒ¨çš„å¤æ‚åº¦ä¸»è¦è¡¨ç°ä¸ºä¸‰ç‚¹ï¼š

- ç¬¬ä¸€ï¼ŒSpringæ¡†æ¶å€ŸåŠ©IoCå’ŒAOPçš„åŠŸèƒ½ï¼Œå®ç°äº†ä¿®æ”¹ã€æ‹¦æˆªBeançš„å®šä¹‰å’Œå®ä¾‹çš„çµæ´»æ€§ï¼Œå› æ­¤çœŸæ­£æ‰§è¡Œçš„ä»£ç æµç¨‹å¹¶ä¸æ˜¯ä¸²è¡Œçš„ã€‚
- ç¬¬äºŒï¼ŒSpring Bootæ ¹æ®å½“å‰ä¾èµ–æƒ…å†µå®ç°äº†è‡ªåŠ¨é…ç½®ï¼Œè™½ç„¶çœå»äº†æ‰‹åŠ¨é…ç½®çš„éº»çƒ¦ï¼Œä½†ä¹Ÿå› æ­¤å¤šäº†ä¸€äº›é»‘ç›’ã€æå‡äº†å¤æ‚åº¦ã€‚
- ç¬¬ä¸‰ï¼ŒSpring Cloudæ¨¡å—å¤šç‰ˆæœ¬ä¹Ÿå¤šï¼ŒSpring Boot 1.xå’Œ2.xçš„åŒºåˆ«ä¹Ÿå¾ˆå¤§ã€‚å¦‚æœè¦å¯¹Spring Cloudæˆ–Spring Bootè¿›è¡ŒäºŒæ¬¡å¼€å‘çš„è¯ï¼Œè€ƒè™‘å…¼å®¹æ€§çš„æˆæœ¬ä¼šå¾ˆé«˜ã€‚

ä»Šå¤©ï¼Œæˆ‘ä»¬å°±é€šè¿‡é…ç½®AOPåˆ‡å…¥Spring Cloud Feignç»„ä»¶å¤±è´¥ã€Spring Bootç¨‹åºçš„æ–‡ä»¶é…ç½®è¢«è¦†ç›–è¿™ä¸¤ä¸ªæ¡ˆä¾‹ï¼Œæ„Ÿå—ä¸€ä¸‹Springçš„å¤æ‚åº¦ã€‚æˆ‘å¸Œæœ›è¿™ä¸€è®²çš„å†…å®¹ï¼Œèƒ½å¸®åŠ©ä½ é¢å¯¹Springè¿™ä¸ªå¤æ‚æ¡†æ¶å‡ºç°çš„é—®é¢˜æ—¶ï¼Œå¯ä»¥éå¸¸è‡ªä¿¡åœ°æ‰¾åˆ°è§£å†³æ–¹æ¡ˆã€‚

## Feign AOPåˆ‡ä¸åˆ°çš„è¯¡å¼‚æ¡ˆä¾‹

æˆ‘æ›¾é‡åˆ°è¿‡è¿™ä¹ˆä¸€ä¸ªæ¡ˆä¾‹ï¼šä½¿ç”¨Spring Cloudåšå¾®æœåŠ¡è°ƒç”¨ï¼Œä¸ºæ–¹ä¾¿ç»Ÿä¸€å¤„ç†Feignï¼Œæƒ³åˆ°äº†ç”¨AOPå®ç°ï¼Œå³ä½¿ç”¨withinæŒ‡ç¤ºå™¨åŒ¹é…feign.Clientæ¥å£çš„å®ç°è¿›è¡ŒAOPåˆ‡å…¥ã€‚

ä»£ç å¦‚ä¸‹ï¼Œé€šè¿‡@Beforeæ³¨è§£åœ¨æ‰§è¡Œæ–¹æ³•å‰æ‰“å°æ—¥å¿—ï¼Œå¹¶åœ¨ä»£ç ä¸­å®šä¹‰äº†ä¸€ä¸ªæ ‡è®°äº†@FeignClientæ³¨è§£çš„Clientç±»ï¼Œè®©å…¶æˆä¸ºä¸€ä¸ªFeignæ¥å£ï¼š

```
//æµ‹è¯•Feign
@FeignClient(name = "client")
public interface Client {
    @GetMapping("/feignaop/server")
    String api();
}

//AOPåˆ‡å…¥feign.Clientçš„å®ç°
@Aspect
@Slf4j
@Component
public class WrongAspect {
    @Before("within(feign.Client+)")
    public void before(JoinPoint pjp) {
        log.info("within(feign.Client+) pjp {}, args:{}", pjp, pjp.getArgs());
    }
}

//é…ç½®æ‰«æFeign
@Configuration
@EnableFeignClients(basePackages = "org.geekbang.time.commonmistakes.spring.demo4.feign")
public class Config {
}
```

é€šè¿‡Feignè°ƒç”¨æœåŠ¡åå¯ä»¥çœ‹åˆ°æ—¥å¿—ä¸­æœ‰è¾“å‡ºï¼Œçš„ç¡®å®ç°äº†feign.Clientçš„åˆ‡å…¥ï¼Œåˆ‡å…¥çš„æ˜¯executeæ–¹æ³•ï¼š

```
[15:48:32.850] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo4.WrongAspect        :20  ] - within(feign.Client+) pjp execution(Response feign.Client.execute(Request,Options)), args:[GET http://client/feignaop/server HTTP/1.1

Binary data, feign.Request$Options@5c16561a]
```

ä¸€å¼€å§‹è¿™ä¸ªé¡¹ç›®ä½¿ç”¨çš„æ˜¯å®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡ï¼Œä¹Ÿå°±æ˜¯è®©Ribbonæ¥åšè´Ÿè½½å‡è¡¡ï¼Œä»£ç æ²¡å•¥é—®é¢˜ã€‚åæ¥å› ä¸ºåç«¯æœåŠ¡é€šè¿‡Nginxå®ç°æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡ï¼Œæ‰€ä»¥å¼€å‘åŒå­¦æŠŠ@FeignClientçš„é…ç½®è®¾ç½®äº†URLå±æ€§ï¼Œç›´æ¥é€šè¿‡ä¸€ä¸ªå›ºå®šURLè°ƒç”¨åç«¯æœåŠ¡ï¼š

```
@FeignClient(name = "anotherClient",url = "http://localhost:45678")
public interface ClientWithUrl {
    @GetMapping("/feignaop/server")
    String api();
}
```

ä½†è¿™æ ·é…ç½®åï¼Œä¹‹å‰çš„AOPåˆ‡é¢ç«Ÿç„¶å¤±æ•ˆäº†ï¼Œä¹Ÿå°±æ˜¯within(feign.Client+)æ— æ³•åˆ‡å…¥ClientWithUrlçš„è°ƒç”¨äº†ã€‚

ä¸ºäº†è¿˜åŸè¿™ä¸ªåœºæ™¯ï¼Œæˆ‘å†™äº†ä¸€æ®µä»£ç ï¼Œå®šä¹‰ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«é€šè¿‡Clientå’ŒClientWithUrlè¿™ä¸¤ä¸ªFeignè¿›è¡Œæ¥å£è°ƒç”¨ï¼š

```
@Autowired
private Client client;

@Autowired
private ClientWithUrl clientWithUrl;

@GetMapping("client")
public String client() {
    return client.api();
}

@GetMapping("clientWithUrl")
public String clientWithUrl() {
    return clientWithUrl.api();
}
```

å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨ClientåAOPæœ‰æ—¥å¿—è¾“å‡ºï¼Œè°ƒç”¨ClientWithUrlåå´æ²¡æœ‰ï¼š

```
[15:50:32.850] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo4.WrongAspect        :20  ] - within(feign.Client+) pjp execution(Response feign.Client.execute(Request,Options)), args:[GET http://client/feignaop/server HTTP/1.1

Binary data, feign.Request$Options@5c16561
```

è¿™å°±å¾ˆè´¹è§£äº†ã€‚éš¾é“ä¸ºFeignæŒ‡å®šäº†URLï¼Œå…¶å®ç°å°±ä¸æ˜¯feign.Clinetäº†å—ï¼Ÿ

è¦æ˜ç™½åŸå› ï¼Œæˆ‘ä»¬éœ€è¦åˆ†æä¸€ä¸‹FeignClientçš„åˆ›å»ºè¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯åˆ†æFeignClientFactoryBeanç±»çš„getTargetæ–¹æ³•ã€‚æºç ç¬¬4è¡Œæœ‰ä¸€ä¸ªifåˆ¤æ–­ï¼Œå½“URLæ²¡æœ‰å†…å®¹ä¹Ÿå°±æ˜¯ä¸ºç©ºæˆ–è€…ä¸é…ç½®æ—¶è°ƒç”¨loadBalanceæ–¹æ³•ï¼Œåœ¨å…¶å†…éƒ¨é€šè¿‡FeignContextä»å®¹å™¨è·å–feign.Clientçš„å®ä¾‹ï¼š

```
<T> T getTarget() {
	FeignContext context = this.applicationContext.getBean(FeignContext.class);
	Feign.Builder builder = feign(context);
	if (!StringUtils.hasText(this.url)) {
		...
		return (T) loadBalance(builder, context,
				new HardCodedTarget<>(this.type, this.name, this.url));
	}
	...
	String url = this.url + cleanPath();
	Client client = getOptional(context, Client.class);
	if (client != null) {
		if (client instanceof LoadBalancerFeignClient) {
			// not load balancing because we have a url,
			// but ribbon is on the classpath, so unwrap
			client = ((LoadBalancerFeignClient) client).getDelegate();
		}
		builder.client(client);
	}
	...
}
protected <T> T loadBalance(Feign.Builder builder, FeignContext context,
		HardCodedTarget<T> target) {
	Client client = getOptional(context, Client.class);
	if (client != null) {
		builder.client(client);
		Targeter targeter = get(context, Targeter.class);
		return targeter.target(this, builder, context, target);
	}
...
}
protected <T> T getOptional(FeignContext context, Class<T> type) {
	return context.getInstance(this.contextId, type);
}
```

è°ƒè¯•ä¸€ä¸‹å¯ä»¥çœ‹åˆ°ï¼Œclientæ˜¯LoadBalanceFeignClientï¼Œå·²ç»æ˜¯ç»è¿‡ä»£ç†å¢å¼ºçš„ï¼Œæ˜æ˜¾æ˜¯ä¸€ä¸ªBeanï¼š

![](https://static001.geekbang.org/resource/image/05/fd/0510e28cd764aaf7f1b4b4ca03049ffd.png?wh=2310%2A924)

æ‰€ä»¥ï¼Œæ²¡æœ‰æŒ‡å®šURLçš„@FeignClientå¯¹åº”çš„LoadBalanceFeignClientï¼Œæ˜¯å¯ä»¥é€šè¿‡feign.Clientåˆ‡å…¥çš„ã€‚

åœ¨æˆ‘ä»¬ä¸Šé¢è´´å‡ºæ¥çš„æºç çš„16è¡Œå¯ä»¥çœ‹åˆ°ï¼Œå½“URLä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œclientè®¾ç½®ä¸ºäº†LoadBalanceFeignClientçš„delegateå±æ€§ã€‚å…¶åŸå› æ³¨é‡Šä¸­æœ‰æåˆ°ï¼Œå› ä¸ºæœ‰äº†URLå°±ä¸éœ€è¦å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡äº†ï¼Œä½†å› ä¸ºRibbonåœ¨classpathä¸­ï¼Œæ‰€ä»¥éœ€è¦ä»LoadBalanceFeignClientæå–å‡ºçœŸæ­£çš„Clientã€‚æ–­ç‚¹è°ƒè¯•ä¸‹å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ—¶clientæ˜¯ä¸€ä¸ªApacheHttpClientï¼š

![](https://static001.geekbang.org/resource/image/1b/30/1b872a900be7327f74bc09bde4c54230.png?wh=2306%2A1126)

é‚£ä¹ˆï¼Œè¿™ä¸ªApacheHttpClientæ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿè¿™é‡Œï¼Œæˆ‘æ•™ä½ ä¸€ä¸ªå°æŠ€å·§ï¼šå¦‚æœä½ å¸Œæœ›çŸ¥é“ä¸€ä¸ªç±»æ˜¯æ€æ ·è°ƒç”¨æ ˆåˆå§‹åŒ–çš„ï¼Œå¯ä»¥åœ¨æ„é€ æ–¹æ³•ä¸­è®¾ç½®ä¸€ä¸ªæ–­ç‚¹è¿›è¡Œè°ƒè¯•ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥åœ¨IDEçš„æ ˆçª—å£çœ‹åˆ°æ•´ä¸ªæ–¹æ³•è°ƒç”¨æ ˆï¼Œç„¶åç‚¹å‡»æ¯ä¸€ä¸ªæ ˆå¸§çœ‹åˆ°æ•´ä¸ªè¿‡ç¨‹ã€‚

ç”¨è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ˜¯HttpClientFeignLoadBalancedConfigurationç±»å®ä¾‹åŒ–çš„ApacheHttpClientï¼š

![](https://static001.geekbang.org/resource/image/7b/9a/7b712acf6d7062ae82f1fd04b954ff9a.png?wh=3020%2A1908)

è¿›ä¸€æ­¥æŸ¥çœ‹HttpClientFeignLoadBalancedConfigurationçš„æºç å¯ä»¥å‘ç°ï¼ŒLoadBalancerFeignClientè¿™ä¸ªBeanåœ¨å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œnewå‡ºæ¥ä¸€ä¸ªApacheHttpClientä½œä¸ºdelegateæ”¾åˆ°äº†LoadBalancerFeignClientä¸­ï¼š

```
@Bean
@ConditionalOnMissingBean(Client.class)
public Client feignClient(CachingSpringLoadBalancerFactory cachingFactory,
      SpringClientFactory clientFactory, HttpClient httpClient) {
   ApacheHttpClient delegate = new ApacheHttpClient(httpClient);
   return new LoadBalancerFeignClient(delegate, cachingFactory, clientFactory);
}

public LoadBalancerFeignClient(Client delegate,
      CachingSpringLoadBalancerFactory lbClientFactory,
      SpringClientFactory clientFactory) {
   this.delegate = delegate;
   this.lbClientFactory = lbClientFactory;
   this.clientFactory = clientFactory;
}
```

æ˜¾ç„¶ï¼ŒApacheHttpClientæ˜¯newå‡ºæ¥çš„ï¼Œå¹¶ä¸æ˜¯Beanï¼Œè€ŒLoadBalancerFeignClientæ˜¯ä¸€ä¸ªBeanã€‚

æœ‰äº†è¿™ä¸ªä¿¡æ¯ï¼Œæˆ‘ä»¬å†æ¥æ‹ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆwithin(feign.Client+)æ— æ³•åˆ‡å…¥è®¾ç½®è¿‡URLçš„@FeignClient ClientWithUrlï¼š

- è¡¨è¾¾å¼å£°æ˜çš„æ˜¯åˆ‡å…¥feign.Clientçš„å®ç°ç±»ã€‚
- Springåªèƒ½åˆ‡å…¥ç”±è‡ªå·±ç®¡ç†çš„Beanã€‚
- **è™½ç„¶LoadBalancerFeignClientå’ŒApacheHttpClientéƒ½æ˜¯feign.Clientæ¥å£çš„å®ç°ï¼Œä½†æ˜¯HttpClientFeignLoadBalancedConfigurationçš„è‡ªåŠ¨é…ç½®åªæ˜¯æŠŠå‰è€…å®šä¹‰ä¸ºBeanï¼Œåè€…æ˜¯newå‡ºæ¥çš„ã€ä½œä¸ºäº†LoadBalancerFeignClientçš„delegateï¼Œä¸æ˜¯Bean**ã€‚
- åœ¨å®šä¹‰äº†FeignClientçš„URLå±æ€§åï¼Œæˆ‘ä»¬è·å–çš„æ˜¯LoadBalancerFeignClientçš„delegateï¼Œå®ƒä¸æ˜¯Beanã€‚

å› æ­¤ï¼Œå®šä¹‰äº†URLçš„FeignClienté‡‡ç”¨within(feign.Client+)æ— æ³•åˆ‡å…¥ã€‚

é‚£ï¼Œå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæœ‰ä¸€ä½åŒå­¦æå‡ºï¼Œä¿®æ”¹ä¸€ä¸‹åˆ‡ç‚¹è¡¨è¾¾å¼ï¼Œé€šè¿‡@FeignClientæ³¨è§£æ¥åˆ‡ï¼š

```
@Before("@within(org.springframework.cloud.openfeign.FeignClient)")
public void before(JoinPoint pjp){
    log.info("@within(org.springframework.cloud.openfeign.FeignClient) pjp {}, args:{}", pjp, pjp.getArgs());
}
```

ä¿®æ”¹åé€šè¿‡æ—¥å¿—çœ‹åˆ°ï¼ŒAOPçš„ç¡®åˆ‡æˆåŠŸäº†ï¼š

```
[15:53:39.093] [http-nio-45678-exec-3] [INFO ] [o.g.t.c.spring.demo4.Wrong2Aspect       :17  ] - @within(org.springframework.cloud.openfeign.FeignClient) pjp execution(String org.geekbang.time.commonmistakes.spring.demo4.feign.ClientWithUrl.api()), args:[]
```

ä½†ä»”ç»†ä¸€çœ‹å°±ä¼šå‘ç°ï¼Œ**è¿™æ¬¡åˆ‡å…¥çš„æ˜¯ClientWithUrlæ¥å£çš„APIæ–¹æ³•ï¼Œå¹¶ä¸æ˜¯client.Feignæ¥å£çš„executeæ–¹æ³•ï¼Œæ˜¾ç„¶ä¸ç¬¦åˆé¢„æœŸ**ã€‚

è¿™ä½åŒå­¦çŠ¯çš„é”™è¯¯æ˜¯ï¼Œæ²¡æœ‰å¼„æ¸…æ¥šçœŸæ­£å¸Œæœ›åˆ‡çš„æ˜¯ä»€ä¹ˆå¯¹è±¡ã€‚@FeignClientæ³¨è§£æ ‡è®°åœ¨Feign Clientæ¥å£ä¸Šï¼Œæ‰€ä»¥åˆ‡çš„æ˜¯Feignå®šä¹‰çš„æ¥å£ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€ä¸ªå®é™…çš„APIæ¥å£ã€‚è€Œé€šè¿‡feign.Clientæ¥å£åˆ‡çš„æ˜¯å®¢æˆ·ç«¯å®ç°ç±»ï¼Œåˆ‡åˆ°çš„æ˜¯é€šç”¨çš„ã€æ‰§è¡Œæ‰€æœ‰Feignè°ƒç”¨çš„executeæ–¹æ³•ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒApacheHttpClientä¸æ˜¯Beanæ— æ³•åˆ‡å…¥ï¼Œåˆ‡Feignæ¥å£æœ¬èº«åˆä¸ç¬¦åˆè¦æ±‚ã€‚æ€ä¹ˆåŠå‘¢ï¼Ÿ

ç»è¿‡ä¸€ç•ªç ”ç©¶å‘ç°ï¼ŒApacheHttpClientå…¶å®æœ‰æœºä¼šç‹¬ç«‹æˆä¸ºBeanã€‚æŸ¥çœ‹HttpClientFeignConfigurationçš„æºç å¯ä»¥å‘ç°ï¼Œå½“æ²¡æœ‰ILoadBalancerç±»å‹çš„æ—¶å€™ï¼Œè‡ªåŠ¨è£…é…ä¼šæŠŠApacheHttpClientè®¾ç½®ä¸ºBeanã€‚

è¿™ä¹ˆåšçš„åŸå› å¾ˆæ˜ç¡®ï¼Œå¦‚æœæˆ‘ä»¬ä¸å¸Œæœ›åšå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„è¯ï¼Œåº”è¯¥ä¸ä¼šå¼•ç”¨Ribbonç»„ä»¶çš„ä¾èµ–ï¼Œè‡ªç„¶æ²¡æœ‰LoadBalancerFeignClientï¼Œåªæœ‰ApacheHttpClientï¼š

```
@Configuration
@ConditionalOnClass(ApacheHttpClient.class)
@ConditionalOnMissingClass("com.netflix.loadbalancer.ILoadBalancer")
@ConditionalOnMissingBean(CloseableHttpClient.class)
@ConditionalOnProperty(value = "feign.httpclient.enabled", matchIfMissing = true)
protected static class HttpClientFeignConfiguration {
	@Bean
	@ConditionalOnMissingBean(Client.class)
	public Client feignClient(HttpClient httpClient) {
		return new ApacheHttpClient(httpClient);
	}
}
```

é‚£ï¼ŒæŠŠpom.xmlä¸­çš„ribbonæ¨¡å—æ³¨é‡Šä¹‹åï¼Œæ˜¯ä¸æ˜¯å¯ä»¥è§£å†³é—®é¢˜å‘¢ï¼Ÿ

```
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-netflix-ribbon</artifactId>
</dependency>
```

ä½†ï¼Œé—®é¢˜å¹¶æ²¡è§£å†³ï¼Œå¯åŠ¨å‡ºé”™è¯¯äº†ï¼š

```
Caused by: java.lang.IllegalArgumentException: Cannot subclass final class feign.httpclient.ApacheHttpClient
	at org.springframework.cglib.proxy.Enhancer.generateClass(Enhancer.java:657)
	at org.springframework.cglib.core.DefaultGeneratorStrategy.generate(DefaultGeneratorStrategy.java:25)
```

è¿™é‡Œï¼Œåˆæ¶‰åŠäº†Springå®ç°åŠ¨æ€ä»£ç†çš„ä¸¤ç§æ–¹å¼ï¼š

- JDKåŠ¨æ€ä»£ç†ï¼Œé€šè¿‡åå°„å®ç°ï¼Œåªæ”¯æŒå¯¹å®ç°æ¥å£çš„ç±»è¿›è¡Œä»£ç†ï¼›
- CGLIBåŠ¨æ€å­—èŠ‚ç æ³¨å…¥æ–¹å¼ï¼Œé€šè¿‡ç»§æ‰¿å®ç°ä»£ç†ï¼Œæ²¡æœ‰è¿™ä¸ªé™åˆ¶ã€‚

**Spring Boot 2.xé»˜è®¤ä½¿ç”¨CGLIBçš„æ–¹å¼ï¼Œä½†é€šè¿‡ç»§æ‰¿å®ç°ä»£ç†æœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œæ— æ³•ç»§æ‰¿finalçš„ç±»ã€‚å› ä¸ºï¼ŒApacheHttpClientç±»å°±æ˜¯å®šä¹‰ä¸ºäº†final**ï¼š

```
public final class ApacheHttpClient implements Client {
```

ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æŠŠé…ç½®å‚æ•°proxy-target-classçš„å€¼ä¿®æ”¹ä¸ºfalseï¼Œä»¥åˆ‡æ¢åˆ°ä½¿ç”¨JDKåŠ¨æ€ä»£ç†çš„æ–¹å¼ï¼š

```
spring.aop.proxy-target-class=false
```

ä¿®æ”¹åæ‰§è¡ŒclientWithUrlæ¥å£å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡within(feign.Client+)æ–¹å¼å¯ä»¥åˆ‡å…¥feign.Clientå­ç±»äº†ã€‚ä»¥ä¸‹æ—¥å¿—æ˜¾ç¤ºäº†@withinå’Œwithinçš„ä¸¤æ¬¡åˆ‡å…¥ï¼š

```
[16:29:55.303] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo4.Wrong2Aspect       :16  ] - @within(org.springframework.cloud.openfeign.FeignClient) pjp execution(String org.geekbang.time.commonmistakes.spring.demo4.feign.ClientWithUrl.api()), args:[]
[16:29:55.310] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo4.WrongAspect        :15  ] - within(feign.Client+) pjp execution(Response feign.Client.execute(Request,Options)), args:[GET http://localhost:45678/feignaop/server HTTP/1.1


Binary data, feign.Request$Options@387550b0]
```

è¿™ä¸‹æˆ‘ä»¬å°±æ˜ç™½äº†ï¼ŒSpring Cloudä½¿ç”¨äº†è‡ªåŠ¨è£…é…æ¥æ ¹æ®ä¾èµ–è£…é…ç»„ä»¶ï¼Œç»„ä»¶æ˜¯å¦æˆä¸ºBeanå†³å®šäº†AOPæ˜¯å¦å¯ä»¥åˆ‡å…¥ï¼Œåœ¨å°è¯•é€šè¿‡AOPåˆ‡å…¥Spring Beançš„æ—¶å€™è¦æ³¨æ„ã€‚

åŠ ä¸Šä¸Šä¸€è®²çš„ä¸¤ä¸ªæ¡ˆä¾‹ï¼Œæˆ‘å°±æŠŠIoCå’ŒAOPç›¸å…³çš„å‘ç‚¹å’Œä½ è¯´æ¸…æ¥šäº†ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬åœ¨ä¸šåŠ¡å¼€å‘æ—¶ï¼Œè¿˜æœ‰ä¸€ä¸ªç»•ä¸å¼€çš„ç‚¹æ˜¯ï¼ŒSpringç¨‹åºçš„é…ç½®é—®é¢˜ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å…·ä½“çœ‹çœ‹å§ã€‚

## Springç¨‹åºé…ç½®çš„ä¼˜å…ˆçº§é—®é¢˜

æˆ‘ä»¬çŸ¥é“ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶application.propertiesï¼Œå¯ä»¥å®ç°Spring Bootåº”ç”¨ç¨‹åºçš„å‚æ•°é…ç½®ã€‚ä½†æˆ‘ä»¬å¯èƒ½ä¸çŸ¥é“çš„æ˜¯ï¼ŒSpringç¨‹åºé…ç½®æ˜¯æœ‰ä¼˜å…ˆçº§çš„ï¼Œå³å½“ä¸¤ä¸ªä¸åŒçš„é…ç½®æºåŒ…å«ç›¸åŒçš„é…ç½®é¡¹æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ªé…ç½®é¡¹å¾ˆå¯èƒ½ä¼šè¢«è¦†ç›–æ‰ã€‚è¿™ï¼Œä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¼šé‡åˆ°äº›çœ‹ä¼¼è¯¡å¼‚çš„é…ç½®å¤±æ•ˆé—®é¢˜ã€‚

æˆ‘ä»¬æ¥é€šè¿‡ä¸€ä¸ªå®é™…æ¡ˆä¾‹ï¼Œç ”ç©¶ä¸‹é…ç½®æºä»¥åŠé…ç½®æºçš„ä¼˜å…ˆçº§é—®é¢˜ã€‚

å¯¹äºSpring Bootåº”ç”¨ç¨‹åºï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šé€šè¿‡è®¾ç½®management.server.portå‚æ•°ï¼Œæ¥æš´éœ²ç‹¬ç«‹çš„actuatorç®¡ç†ç«¯å£ã€‚è¿™æ ·åšæ›´å®‰å…¨ï¼Œä¹Ÿæ›´æ–¹ä¾¿ç›‘æ§ç³»ç»Ÿç»Ÿä¸€ç›‘æ§ç¨‹åºæ˜¯å¦å¥åº·ã€‚

```
management.server.port=45679
```

æœ‰ä¸€å¤©ç¨‹åºé‡æ–°å‘å¸ƒåï¼Œç›‘æ§ç³»ç»Ÿæ˜¾ç¤ºç¨‹åºç¦»çº¿ã€‚ä½†æ’æŸ¥ä¸‹æ¥å‘ç°ï¼Œç¨‹åºæ˜¯æ­£å¸¸å·¥ä½œçš„ï¼Œåªæ˜¯actuatorç®¡ç†ç«¯å£çš„ç«¯å£å·è¢«æ”¹äº†ï¼Œä¸æ˜¯é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„45679äº†ã€‚

åæ¥å‘ç°ï¼Œè¿ç»´åŒå­¦åœ¨æœåŠ¡å™¨ä¸Šå®šä¹‰äº†ä¸¤ä¸ªç¯å¢ƒå˜é‡MANAGEMENT\_SERVER\_IPå’ŒMANAGEMENT\_SERVER\_PORTï¼Œç›®çš„æ˜¯æ–¹ä¾¿ç›‘æ§AgentæŠŠç›‘æ§æ•°æ®ä¸ŠæŠ¥åˆ°ç»Ÿä¸€çš„ç®¡ç†æœåŠ¡ä¸Šï¼š

```
MANAGEMENT_SERVER_IP=192.168.0.2
MANAGEMENT_SERVER_PORT=12345
```

é—®é¢˜å°±æ˜¯å‡ºåœ¨è¿™é‡Œã€‚MANAGEMENT\_SERVER\_PORTè¦†ç›–äº†é…ç½®æ–‡ä»¶ä¸­çš„management.server.portï¼Œä¿®æ”¹äº†åº”ç”¨ç¨‹åºæœ¬èº«çš„ç«¯å£ã€‚å½“ç„¶ï¼Œç›‘æ§ç³»ç»Ÿä¹Ÿå°±æ— æ³•é€šè¿‡è€çš„ç®¡ç†ç«¯å£è®¿é—®åˆ°åº”ç”¨çš„healthç«¯å£äº†ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œactuatorçš„ç«¯å£å·å˜æˆäº†12345ï¼š

![](https://static001.geekbang.org/resource/image/b2/e6/b287b7ad823a39bb604fa69e02c720e6.png?wh=1278%2A578)

åˆ°è¿™é‡Œå‘è¿˜æ²¡å®Œï¼Œä¸ºäº†æ–¹ä¾¿ç”¨æˆ·ç™»å½•ï¼Œéœ€è¦åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé»˜è®¤çš„ç®¡ç†å‘˜ç”¨æˆ·åï¼Œäºæ˜¯å¼€å‘åŒå­¦åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€ä¸ªuser.nameå±æ€§ï¼Œå¹¶è®¾ç½®ä¸ºdefaultadminnameï¼š

```
user.name=defaultadminname
```

åæ¥å‘ç°ï¼Œç¨‹åºè¯»å–å‡ºæ¥çš„ç”¨æˆ·åæ ¹æœ¬å°±ä¸æ˜¯é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„ã€‚è¿™ï¼Œåˆæ˜¯å’‹å›äº‹ï¼Ÿ

å¸¦ç€è¿™ä¸ªé—®é¢˜ï¼Œä»¥åŠä¹‹å‰ç¯å¢ƒå˜é‡è¦†ç›–é…ç½®æ–‡ä»¶é…ç½®çš„é—®é¢˜ï¼Œæˆ‘ä»¬å†™æ®µä»£ç çœ‹çœ‹ï¼Œä»Springä¸­åˆ°åº•èƒ½è¯»å–åˆ°å‡ ä¸ªmanagement.server.portå’Œuser.nameé…ç½®é¡¹ã€‚

è¦æƒ³æŸ¥è¯¢Springä¸­æ‰€æœ‰çš„é…ç½®ï¼Œæˆ‘ä»¬éœ€è¦ä»¥ç¯å¢ƒEnvironmentæ¥å£ä¸ºå…¥å£ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°±ä¸ä½ è¯´è¯´Springé€šè¿‡ç¯å¢ƒEnvironmentæŠ½è±¡å‡ºçš„Propertyå’ŒProfileï¼š

- é’ˆå¯¹Propertyï¼ŒåˆæŠ½è±¡å‡ºå„ç§PropertySourceç±»ä»£è¡¨é…ç½®æºã€‚ä¸€ä¸ªç¯å¢ƒä¸‹å¯èƒ½æœ‰å¤šä¸ªé…ç½®æºï¼Œæ¯ä¸ªé…ç½®æºä¸­æœ‰è¯¸å¤šé…ç½®é¡¹ã€‚åœ¨æŸ¥è¯¢é…ç½®ä¿¡æ¯æ—¶ï¼Œéœ€è¦æŒ‰ç…§é…ç½®æºä¼˜å…ˆçº§è¿›è¡ŒæŸ¥è¯¢ã€‚
- Profileå®šä¹‰äº†åœºæ™¯çš„æ¦‚å¿µã€‚é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šå®šä¹‰ç±»ä¼¼devã€testã€stageå’Œprodç­‰ç¯å¢ƒä½œä¸ºä¸åŒçš„Profileï¼Œç”¨äºæŒ‰ç…§åœºæ™¯å¯¹Beanè¿›è¡Œé€»è¾‘å½’å±ã€‚åŒæ—¶ï¼ŒProfileå’Œé…ç½®æ–‡ä»¶ä¹Ÿæœ‰å…³ç³»ï¼Œæ¯ä¸ªç¯å¢ƒéƒ½æœ‰ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ï¼Œä½†æˆ‘ä»¬åªä¼šæ¿€æ´»æŸä¸€ä¸ªç¯å¢ƒæ¥ç”Ÿæ•ˆç‰¹å®šç¯å¢ƒçš„é…ç½®æ–‡ä»¶ã€‚

![](https://static001.geekbang.org/resource/image/2c/c0/2c68da94d31182cad34c965f878196c0.png?wh=1302%2A1104)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹çœ‹Propertyçš„æŸ¥è¯¢è¿‡ç¨‹ã€‚

å¯¹äºéWebåº”ç”¨ï¼ŒSpringå¯¹äºEnvironmentæ¥å£çš„å®ç°æ˜¯StandardEnvironmentç±»ã€‚æˆ‘ä»¬é€šè¿‡Springæ³¨å…¥StandardEnvironmentåå¾ªç¯getPropertySourcesè·å¾—çš„PropertySourceï¼Œæ¥æŸ¥è¯¢æ‰€æœ‰çš„PropertySourceä¸­keyæ˜¯user.nameæˆ–management.server.portçš„å±æ€§å€¼ï¼›ç„¶åéå†getPropertySourcesæ–¹æ³•ï¼Œè·å¾—æ‰€æœ‰é…ç½®æºå¹¶æ‰“å°å‡ºæ¥ï¼š

```
@Autowired
private StandardEnvironment env;
@PostConstruct
public void init(){
    Arrays.asList("user.name", "management.server.port").forEach(key -> {
         env.getPropertySources().forEach(propertySource -> {
                    if (propertySource.containsProperty(key)) {
                        log.info("{} -> {} å®é™…å–å€¼ï¼š{}", propertySource, propertySource.getProperty(key), env.getProperty(key));
                    }
                });
    });

    System.out.println("é…ç½®ä¼˜å…ˆçº§ï¼š");
    env.getPropertySources().stream().forEach(System.out::println);
}
```

æˆ‘ä»¬ç ”ç©¶ä¸‹è¾“å‡ºçš„æ—¥å¿—ï¼š

```
2020-01-15 16:08:34.054  INFO 40123 --- [           main] o.g.t.c.s.d.CommonMistakesApplication    : ConfigurationPropertySourcesPropertySource {name='configurationProperties'} -> zhuye å®é™…å–å€¼ï¼šzhuye
2020-01-15 16:08:34.054  INFO 40123 --- [           main] o.g.t.c.s.d.CommonMistakesApplication    : PropertiesPropertySource {name='systemProperties'} -> zhuye å®é™…å–å€¼ï¼šzhuye
2020-01-15 16:08:34.054  INFO 40123 --- [           main] o.g.t.c.s.d.CommonMistakesApplication    : OriginTrackedMapPropertySource {name='applicationConfig: [classpath:/application.properties]'} -> defaultadminname å®é™…å–å€¼ï¼šzhuye
2020-01-15 16:08:34.054  INFO 40123 --- [           main] o.g.t.c.s.d.CommonMistakesApplication    : ConfigurationPropertySourcesPropertySource {name='configurationProperties'} -> 12345 å®é™…å–å€¼ï¼š12345
2020-01-15 16:08:34.054  INFO 40123 --- [           main] o.g.t.c.s.d.CommonMistakesApplication    : OriginAwareSystemEnvironmentPropertySource {name=''} -> 12345 å®é™…å–å€¼ï¼š12345
2020-01-15 16:08:34.054  INFO 40123 --- [           main] o.g.t.c.s.d.CommonMistakesApplication    : OriginTrackedMapPropertySource {name='applicationConfig: [classpath:/application.properties]'} -> 45679 å®é™…å–å€¼ï¼š12345
é…ç½®ä¼˜å…ˆçº§ï¼š
ConfigurationPropertySourcesPropertySource {name='configurationProperties'}
StubPropertySource {name='servletConfigInitParams'}
ServletContextPropertySource {name='servletContextInitParams'}
PropertiesPropertySource {name='systemProperties'}
OriginAwareSystemEnvironmentPropertySource {name='systemEnvironment'}
RandomValuePropertySource {name='random'}
OriginTrackedMapPropertySource {name='applicationConfig: [classpath:/application.properties]'}
MapPropertySource {name='springCloudClientHostInfo'}
MapPropertySource {name='defaultProperties'}
```

- æœ‰ä¸‰å¤„å®šä¹‰äº†user.nameï¼šç¬¬ä¸€ä¸ªæ˜¯configurationPropertiesï¼Œå€¼æ˜¯zhuyeï¼›ç¬¬äºŒä¸ªæ˜¯systemPropertiesï¼Œä»£è¡¨ç³»ç»Ÿé…ç½®ï¼Œå€¼æ˜¯zhuyeï¼›ç¬¬ä¸‰ä¸ªæ˜¯applicationConfigï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ï¼Œå€¼æ˜¯é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„defaultadminnameã€‚
- åŒæ ·åœ°ï¼Œä¹Ÿæœ‰ä¸‰å¤„å®šä¹‰äº†management.server.portï¼šç¬¬ä¸€ä¸ªæ˜¯configurationPropertiesï¼Œå€¼æ˜¯12345ï¼›ç¬¬äºŒä¸ªæ˜¯systemEnvironmentä»£è¡¨ç³»ç»Ÿç¯å¢ƒï¼Œå€¼æ˜¯12345ï¼›ç¬¬ä¸‰ä¸ªæ˜¯applicationConfigï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ï¼Œå€¼æ˜¯é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„45679ã€‚
- ç¬¬7åˆ°16è¡Œçš„è¾“å‡ºæ˜¾ç¤ºï¼ŒSpringä¸­æœ‰9ä¸ªé…ç½®æºï¼Œå€¼å¾—å…³æ³¨æ˜¯ConfigurationPropertySourcesPropertySourceã€PropertiesPropertySourceã€OriginAwareSystemEnvironmentPropertySourceå’Œæˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ã€‚

é‚£ä¹ˆï¼ŒSpringçœŸçš„æ˜¯æŒ‰è¿™ä¸ªé¡ºåºæŸ¥è¯¢é…ç½®å—ï¼Ÿæœ€å‰é¢çš„configurationPropertiesï¼Œåˆæ˜¯ä»€ä¹ˆï¼Ÿä¸ºäº†å›ç­”è¿™2ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦åˆ†æä¸‹æºç ã€‚æˆ‘å…ˆè¯´æ˜ä¸‹ï¼Œä¸‹é¢æºç åˆ†æçš„é€»è¾‘æœ‰äº›å¤æ‚ï¼Œä½ å¯ä»¥ç»“åˆç€ä¸‹é¢çš„æ•´ä½“æµç¨‹å›¾æ¥ç†è§£ï¼š

![](https://static001.geekbang.org/resource/image/3e/f9/3e6dc6456f6d1354da58fb260775c0f9.png?wh=2064%2A1450)

Demoä¸­æ³¨å…¥çš„StandardEnvironmentï¼Œç»§æ‰¿çš„æ˜¯AbstractEnvironmentï¼ˆå›¾ä¸­ç´«è‰²ç±»ï¼‰ã€‚AbstractEnvironmentçš„æºç å¦‚ä¸‹ï¼š

```
public abstract class AbstractEnvironment implements ConfigurableEnvironment {
	private final MutablePropertySources propertySources = new MutablePropertySources();
	private final ConfigurablePropertyResolver propertyResolver =
			new PropertySourcesPropertyResolver(this.propertySources);

	public String getProperty(String key) {
		return this.propertyResolver.getProperty(key);
	}
}
```

å¯ä»¥çœ‹åˆ°ï¼š

- MutablePropertySourcesç±»å‹çš„å­—æ®µpropertySourcesï¼Œçœ‹èµ·æ¥ä»£è¡¨äº†æ‰€æœ‰é…ç½®æºï¼›
- getPropertyæ–¹æ³•ï¼Œé€šè¿‡PropertySourcesPropertyResolverç±»è¿›è¡ŒæŸ¥è¯¢é…ç½®ï¼›
- å®ä¾‹åŒ–PropertySourcesPropertyResolverçš„æ—¶å€™ï¼Œä¼ å…¥äº†å½“å‰çš„MutablePropertySourcesã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­åˆ†æMutablePropertySourceså’ŒPropertySourcesPropertyResolverã€‚å…ˆçœ‹çœ‹MutablePropertySourcesçš„æºç ï¼ˆå›¾ä¸­è“è‰²ç±»ï¼‰ï¼š

```
public class MutablePropertySources implements PropertySources {

	private final List<PropertySource<?>> propertySourceList = new CopyOnWriteArrayList<>();

	public void addFirst(PropertySource<?> propertySource) {
		removeIfPresent(propertySource);
		this.propertySourceList.add(0, propertySource);
	}
	public void addLast(PropertySource<?> propertySource) {
		removeIfPresent(propertySource);
		this.propertySourceList.add(propertySource);
	}
	public void addBefore(String relativePropertySourceName, PropertySource<?> propertySource) {
		...
		int index = assertPresentAndGetIndex(relativePropertySourceName);
		addAtIndex(index, propertySource);
	}
    public void addAfter(String relativePropertySourceName, PropertySource<?> propertySource) {
       ...
       int index = assertPresentAndGetIndex(relativePropertySourceName);
       addAtIndex(index + 1, propertySource);
    }
    private void addAtIndex(int index, PropertySource<?> propertySource) {
       removeIfPresent(propertySource);
       this.propertySourceList.add(index, propertySource);
    }
}
```

å¯ä»¥å‘ç°ï¼š

- propertySourceListå­—æ®µç”¨æ¥çœŸæ­£ä¿å­˜PropertySourceçš„Listï¼Œä¸”è¿™ä¸ªListæ˜¯ä¸€ä¸ªCopyOnWriteArrayListã€‚
- ç±»ä¸­å®šä¹‰äº†addFirstã€addLastã€addBeforeã€addAfterç­‰æ–¹æ³•ï¼Œæ¥ç²¾ç¡®æ§åˆ¶PropertySourceåŠ å…¥propertySourceListçš„é¡ºåºã€‚è¿™ä¹Ÿè¯´æ˜äº†é¡ºåºçš„é‡è¦æ€§ã€‚

ç»§ç»­çœ‹ä¸‹PropertySourcesPropertyResolverï¼ˆå›¾ä¸­ç»¿è‰²ç±»ï¼‰çš„æºç ï¼Œæ‰¾åˆ°çœŸæ­£æŸ¥è¯¢é…ç½®çš„æ–¹æ³•getPropertyã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹ç¬¬9è¡Œä»£ç ï¼šéå†çš„propertySourcesæ˜¯PropertySourcesPropertyResolveræ„é€ æ–¹æ³•ä¼ å…¥çš„ï¼Œå†ç»“åˆAbstractEnvironmentçš„æºç å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªpropertySourcesæ­£æ˜¯AbstractEnvironmentä¸­çš„MutablePropertySourceså¯¹è±¡ã€‚éå†æ—¶ï¼Œå¦‚æœå‘ç°é…ç½®æºä¸­æœ‰å¯¹åº”çš„Keyå€¼ï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªå€¼ã€‚å› æ­¤ï¼ŒMutablePropertySourcesä¸­é…ç½®æºçš„æ¬¡åºå°¤ä¸ºé‡è¦ã€‚

```
public class PropertySourcesPropertyResolver extends AbstractPropertyResolver {
	private final PropertySources propertySources;
	public PropertySourcesPropertyResolver(@Nullable PropertySources propertySources) {
		this.propertySources = propertySources;
	}
	
	protected <T> T getProperty(String key, Class<T> targetValueType, boolean resolveNestedPlaceholders) {
		if (this.propertySources != null) {
			for (PropertySource<?> propertySource : this.propertySources) {
				if (logger.isTraceEnabled()) {
					logger.trace("Searching for key '" + key + "' in PropertySource '" +
							propertySource.getName() + "'");
				}
				Object value = propertySource.getProperty(key);
				if (value != null) {
					if (resolveNestedPlaceholders && value instanceof String) {
						value = resolveNestedPlaceholders((String) value);
					}
					logKeyFound(key, propertySource, value);
					return convertValueIfNecessary(value, targetValueType);
				}
			}
		}
		...
	}
}
```

å›åˆ°ä¹‹å‰çš„é—®é¢˜ï¼Œåœ¨æŸ¥è¯¢æ‰€æœ‰é…ç½®æºçš„æ—¶å€™ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°å¤„åœ¨ç¬¬ä¸€ä½çš„æ˜¯ConfigurationPropertySourcesPropertySourceï¼Œè¿™æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

å…¶å®ï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªå®é™…å­˜åœ¨çš„é…ç½®æºï¼Œæ‰®æ¼”çš„æ˜¯ä¸€ä¸ªä»£ç†çš„è§’è‰²ã€‚ä½†é€šè¿‡è°ƒè¯•ä½ ä¼šå‘ç°ï¼Œæˆ‘ä»¬è·å–çš„å€¼ç«Ÿç„¶æ˜¯ç”±å®ƒæä¾›å¹¶ä¸”è¿”å›çš„ï¼Œä¸”æ²¡æœ‰å¾ªç¯éå†åé¢çš„PropertySourceï¼š

![](https://static001.geekbang.org/resource/image/73/fb/7380c93e743e3fc41d8cc58b77895bfb.png?wh=2388%2A1140)

ç»§ç»­æŸ¥çœ‹ConfigurationPropertySourcesPropertySourceï¼ˆå›¾ä¸­çº¢è‰²ç±»ï¼‰çš„æºç å¯ä»¥å‘ç°ï¼ŒgetPropertyæ–¹æ³•å…¶å®æ˜¯é€šè¿‡findConfigurationPropertyæ–¹æ³•æŸ¥è¯¢é…ç½®çš„ã€‚å¦‚ç¬¬25è¡Œä»£ç æ‰€ç¤ºï¼Œè¿™å…¶å®è¿˜æ˜¯åœ¨éå†æ‰€æœ‰çš„é…ç½®æºï¼š

```
class ConfigurationPropertySourcesPropertySource extends PropertySource<Iterable<ConfigurationPropertySource>>
		implements OriginLookup<String> {

	ConfigurationPropertySourcesPropertySource(String name, Iterable<ConfigurationPropertySource> source) {
		super(name, source);
	}

	@Override
	public Object getProperty(String name) {
		ConfigurationProperty configurationProperty = findConfigurationProperty(name);
		return (configurationProperty != null) ? configurationProperty.getValue() : null;
	}
	private ConfigurationProperty findConfigurationProperty(String name) {
		try {
			return findConfigurationProperty(ConfigurationPropertyName.of(name, true));
		}
		catch (Exception ex) {
			return null;
		}
	}
	private ConfigurationProperty findConfigurationProperty(ConfigurationPropertyName name) {
		if (name == null) {
			return null;
		}
		for (ConfigurationPropertySource configurationPropertySource : getSource()) {
			ConfigurationProperty configurationProperty = configurationPropertySource.getConfigurationProperty(name);
			if (configurationProperty != null) {
				return configurationProperty;
			}
		}
		return null;
	}
}
```

è°ƒè¯•å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªå¾ªç¯éå†ï¼ˆgetSource()çš„ç»“æœï¼‰çš„é…ç½®æºï¼Œå…¶å®æ˜¯SpringConfigurationPropertySourcesï¼ˆå›¾ä¸­é»„è‰²ç±»ï¼‰ï¼Œå…¶ä¸­åŒ…å«çš„é…ç½®æºåˆ—è¡¨å°±æ˜¯ä¹‹å‰çœ‹åˆ°çš„9ä¸ªé…ç½®æºï¼Œè€Œç¬¬ä¸€ä¸ªå°±æ˜¯ConfigurationPropertySourcesPropertySourceã€‚çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€æ„Ÿè§‰æ˜¯ä¼šä¸ä¼šäº§ç”Ÿæ­»å¾ªç¯ï¼Œå®ƒåœ¨éå†çš„æ—¶å€™æ€ä¹ˆæ’é™¤è‡ªå·±å‘¢ï¼Ÿ

åŒæ—¶è§‚å¯ŸconfigurationPropertyå¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªConfigurationPropertyå…¶å®ç±»ä¼¼ä»£ç†çš„è§’è‰²ï¼Œå®é™…é…ç½®æ˜¯ä»ç³»ç»Ÿå±æ€§ä¸­è·å¾—çš„ï¼š

![](https://static001.geekbang.org/resource/image/95/0a/9551d5b5acada84262b7ddeae989750a.png?wh=2422%2A1564)

ç»§ç»­æŸ¥çœ‹SpringConfigurationPropertySourceså¯ä»¥å‘ç°ï¼Œå®ƒè¿”å›çš„è¿­ä»£å™¨æ˜¯å†…éƒ¨ç±»SourcesIteratorï¼Œåœ¨fetchNextæ–¹æ³•è·å–ä¸‹ä¸€ä¸ªé¡¹æ—¶ï¼Œé€šè¿‡isIgnoredæ–¹æ³•æ’é™¤äº†ConfigurationPropertySourcesPropertySourceï¼ˆæºç ç¬¬38è¡Œï¼‰ï¼š

```
class SpringConfigurationPropertySources implements Iterable<ConfigurationPropertySource> {

	private final Iterable<PropertySource<?>> sources;
	private final Map<PropertySource<?>, ConfigurationPropertySource> cache = new ConcurrentReferenceHashMap<>(16,
			ReferenceType.SOFT);

	SpringConfigurationPropertySources(Iterable<PropertySource<?>> sources) {
		Assert.notNull(sources, "Sources must not be null");
		this.sources = sources;
	}

	@Override
	public Iterator<ConfigurationPropertySource> iterator() {
		return new SourcesIterator(this.sources.iterator(), this::adapt);
	}

	private static class SourcesIterator implements Iterator<ConfigurationPropertySource> {

		@Override
		public boolean hasNext() {
			return fetchNext() != null;
		}

		private ConfigurationPropertySource fetchNext() {
			if (this.next == null) {
				if (this.iterators.isEmpty()) {
					return null;
				}
				if (!this.iterators.peek().hasNext()) {
					this.iterators.pop();
					return fetchNext();
				}
				PropertySource<?> candidate = this.iterators.peek().next();
				if (candidate.getSource() instanceof ConfigurableEnvironment) {
					push((ConfigurableEnvironment) candidate.getSource());
					return fetchNext();
				}
				if (isIgnored(candidate)) {
					return fetchNext();
				}
				this.next = this.adapter.apply(candidate);
			}
			return this.next;
		}


		private void push(ConfigurableEnvironment environment) {
			this.iterators.push(environment.getPropertySources().iterator());
		}


		private boolean isIgnored(PropertySource<?> candidate) {
			return (candidate instanceof StubPropertySource
					|| candidate instanceof ConfigurationPropertySourcesPropertySource);
		}
	}
}
```

æˆ‘ä»¬å·²ç»äº†è§£äº†ConfigurationPropertySourcesPropertySourceæ˜¯æ‰€æœ‰é…ç½®æºä¸­çš„ç¬¬ä¸€ä¸ªï¼Œå®ç°äº†å¯¹PropertySourcesPropertyResolverä¸­éå†é€»è¾‘çš„â€œåŠ«æŒâ€ï¼Œå¹¶ä¸”çŸ¥é“äº†å…¶éå†é€»è¾‘ã€‚æœ€åä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå®ƒå¦‚ä½•è®©è‡ªå·±æˆä¸ºç¬¬ä¸€ä¸ªé…ç½®æºå‘¢ï¼Ÿ

å†æ¬¡è¿ç”¨ä¹‹å‰æˆ‘ä»¬å­¦åˆ°çš„é‚£ä¸ªå°æŠ€å·§ï¼Œæ¥æŸ¥çœ‹å®ä¾‹åŒ–ConfigurationPropertySourcesPropertySourceçš„åœ°æ–¹ï¼š

![](https://static001.geekbang.org/resource/image/f4/5d/f43c15a2f491d88a0383023a42cebd5d.png?wh=2844%2A1318)

å¯ä»¥çœ‹åˆ°ï¼ŒConfigurationPropertySourcesPropertySourceç±»æ˜¯ç”±ConfigurationPropertySourcesçš„attachæ–¹æ³•å®ä¾‹åŒ–çš„ã€‚æŸ¥é˜…æºç å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªæ–¹æ³•çš„ç¡®ä»ç¯å¢ƒä¸­è·å¾—äº†åŸå§‹çš„MutablePropertySourcesï¼ŒæŠŠè‡ªå·±åŠ å…¥æˆä¸ºä¸€ä¸ªå…ƒç´ ï¼š

```
public final class ConfigurationPropertySources {
	public static void attach(Environment environment) {
		MutablePropertySources sources = ((ConfigurableEnvironment) environment).getPropertySources();
		PropertySource<?> attached = sources.get(ATTACHED_PROPERTY_SOURCE_NAME);
		if (attached == null) {
			sources.addFirst(new ConfigurationPropertySourcesPropertySource(ATTACHED_PROPERTY_SOURCE_NAME,
					new SpringConfigurationPropertySources(sources)));
		}
	}
}
```

è€Œè¿™ä¸ªattachæ–¹æ³•ï¼Œæ˜¯Springåº”ç”¨ç¨‹åºå¯åŠ¨æ—¶å‡†å¤‡ç¯å¢ƒçš„æ—¶å€™è°ƒç”¨çš„ã€‚åœ¨SpringApplicationçš„runæ–¹æ³•ä¸­è°ƒç”¨äº†prepareEnvironmentæ–¹æ³•ï¼Œç„¶ååˆè°ƒç”¨äº†ConfigurationPropertySources.attachæ–¹æ³•ï¼š

```
public class SpringApplication {

public ConfigurableApplicationContext run(String... args) {
		...
		try {
			ApplicationArguments applicationArguments = new DefaultApplicationArguments(args);
			ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments);
			...
	}
	private ConfigurableEnvironment prepareEnvironment(SpringApplicationRunListeners listeners,
			ApplicationArguments applicationArguments) {
		...
		ConfigurationPropertySources.attach(environment);
		...
    }
}
```

çœ‹åˆ°è¿™é‡Œä½ æ˜¯å¦å½»åº•ç†æ¸…æ¥šSpringåŠ«æŒPropertySourcesPropertyResolverçš„å®ç°æ–¹å¼ï¼Œä»¥åŠé…ç½®æºæœ‰ä¼˜å…ˆçº§çš„åŸå› äº†å‘¢ï¼Ÿå¦‚æœä½ æƒ³çŸ¥é“Springå„ç§é¢„å®šä¹‰çš„é…ç½®æºçš„ä¼˜å…ˆçº§ï¼Œå¯ä»¥å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-external-config)ã€‚

## é‡ç‚¹å›é¡¾

ä»Šå¤©ï¼Œæˆ‘ç”¨ä¸¤ä¸ªä¸šåŠ¡å¼€å‘ä¸­çš„å®é™…æ¡ˆä¾‹ï¼Œå¸¦ä½ è¿›ä¸€æ­¥å­¦ä¹ äº†Springçš„AOPå’Œé…ç½®ä¼˜å…ˆçº§è¿™ä¸¤å¤§çŸ¥è¯†ç‚¹ã€‚ç°åœ¨ï¼Œä½ åº”è¯¥ä¹Ÿæ„Ÿå—åˆ°Springå®ç°çš„å¤æ‚åº¦äº†ã€‚

å¯¹äºAOPåˆ‡Feignçš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬åœ¨å®ç°åŠŸèƒ½æ—¶èµ°äº†ä¸€äº›å¼¯è·¯ã€‚Spring Cloudä¼šä½¿ç”¨Spring Bootçš„ç‰¹æ€§ï¼Œæ ¹æ®å½“å‰å¼•å…¥åŒ…çš„æƒ…å†µåšå„ç§è‡ªåŠ¨è£…é…ã€‚å¦‚æœæˆ‘ä»¬è¦æ‰©å±•Springçš„ç»„ä»¶ï¼Œé‚£ä¹ˆåªæœ‰æ¸…æ™°äº†è§£Springè‡ªåŠ¨è£…é…çš„è¿ä½œæ–¹å¼ï¼Œæ‰èƒ½é‰´åˆ«è¿è¡Œæ—¶å¯¹è±¡åœ¨Springå®¹å™¨ä¸­çš„æƒ…å†µï¼Œä¸èƒ½æƒ³å½“ç„¶è®¤ä¸ºä»£ç ä¸­èƒ½çœ‹åˆ°çš„æ‰€æœ‰Springçš„ç±»éƒ½æ˜¯Beanã€‚

å¯¹äºé…ç½®ä¼˜å…ˆçº§çš„æ¡ˆä¾‹ï¼Œåˆ†æé…ç½®æºä¼˜å…ˆçº§æ—¶ï¼Œå¦‚æœæˆ‘ä»¬ä»¥ä¸ºçœ‹åˆ°PropertySourcesPropertyResolverå°±çœ‹åˆ°äº†çœŸç›¸ï¼Œåç»­è¿›è¡Œæ‰©å±•å¼€å‘æ—¶å°±å¯èƒ½ä¼šè¸©å‘ã€‚æˆ‘ä»¬ä¸€å®šè¦æ³¨æ„ï¼Œ**åˆ†æSpringæºç æ—¶ï¼Œä½ çœ‹åˆ°çš„è¡¨è±¡ä¸ä¸€å®šæ˜¯å®é™…è¿è¡Œæ—¶çš„æƒ…å†µï¼Œè¿˜éœ€è¦å€ŸåŠ©æ—¥å¿—æˆ–è°ƒè¯•å·¥å…·æ¥ç†æ¸…æ•´ä¸ªè¿‡ç¨‹**ã€‚å¦‚æœæ²¡æœ‰è°ƒè¯•å·¥å…·ï¼Œä½ å¯ä»¥å€ŸåŠ©[ç¬¬11è®²](https://time.geekbang.org/column/article/216830)ç”¨åˆ°çš„Arthasï¼Œæ¥åˆ†æä»£ç è°ƒç”¨è·¯å¾„ã€‚

ä»Šå¤©ç”¨åˆ°çš„ä»£ç ï¼Œæˆ‘éƒ½æ”¾åœ¨äº†GitHubä¸Šï¼Œä½ å¯ä»¥ç‚¹å‡»[è¿™ä¸ªé“¾æ¥](https://github.com/JosephZhu1983/java-common-mistakes)æŸ¥çœ‹ã€‚

## æ€è€ƒä¸è®¨è®º

1. é™¤äº†æˆ‘ä»¬è¿™ä¸¤è®²ç”¨åˆ°executionã€withinã€@withinã€@annotationå››ä¸ªæŒ‡ç¤ºå™¨å¤–ï¼ŒSpring AOPè¿˜æ”¯æŒthisã€targetã€argsã€@targetã€@argsã€‚ä½ èƒ½è¯´è¯´åé¢äº”ç§æŒ‡ç¤ºå™¨çš„ä½œç”¨å—ï¼Ÿ
2. Springçš„Environmentä¸­çš„PropertySourceså±æ€§å¯ä»¥åŒ…å«å¤šä¸ªPropertySourceï¼Œè¶Šå¾€å‰ä¼˜å…ˆçº§è¶Šé«˜ã€‚é‚£ï¼Œæˆ‘ä»¬èƒ½å¦åˆ©ç”¨è¿™ä¸ªç‰¹ç‚¹å®ç°é…ç½®æ–‡ä»¶ä¸­å±æ€§å€¼çš„è‡ªåŠ¨èµ‹å€¼å‘¢ï¼Ÿæ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰%%MYSQL.URL%%ã€%%MYSQL.USERNAME%%å’Œ%%MYSQL.PASSWORD%%ï¼Œåˆ†åˆ«ä»£è¡¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€ç”¨æˆ·åå’Œå¯†ç ã€‚åœ¨é…ç½®æ•°æ®æºæ—¶ï¼Œæˆ‘ä»¬åªè¦è®¾ç½®å…¶å€¼ä¸ºå ä½ç¬¦ï¼Œæ¡†æ¶å°±å¯ä»¥è‡ªåŠ¨æ ¹æ®å½“å‰åº”ç”¨ç¨‹åºåapplication.nameï¼Œç»Ÿä¸€æŠŠå ä½ç¬¦æ›¿æ¢ä¸ºçœŸå®çš„æ•°æ®åº“ä¿¡æ¯ã€‚è¿™æ ·ï¼Œç”Ÿäº§çš„æ•°æ®åº“ä¿¡æ¯å°±ä¸éœ€è¦æ”¾åœ¨é…ç½®æ–‡ä»¶ä¸­äº†ï¼Œä¼šæ›´å®‰å…¨ã€‚

å…³äºSpring Coreã€Spring Bootå’ŒSpring Cloudï¼Œä½ è¿˜é‡åˆ°è¿‡å…¶ä»–å‘å—ï¼Ÿæˆ‘æ˜¯æœ±æ™”ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºä¸æˆ‘ç•™è¨€åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ï¼Œä¸€èµ·äº¤æµã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ12ï¼‰</strong></div><ul>
<li><span>Darren</span> ğŸ‘ï¼ˆ35ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š
åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦
Spring AOP æ”¯æŒ10ç§åˆ‡ç‚¹æŒ‡ç¤ºç¬¦ï¼šexecutionã€withinã€thisã€targetã€argsã€@targetã€@argsã€@withinã€@annotationã€beanä¸‹é¢åšä¸‹ç®€è®°(æ²¡æœ‰å†™@Pointcut(),è¯·æ³¨æ„)ï¼š

execution: ç”¨æ¥åŒ¹é…æ‰§è¡Œæ–¹æ³•çš„è¿æ¥ç‚¹çš„æŒ‡ç¤ºç¬¦ã€‚
ç”¨æ³•ç›¸å¯¹å¤æ‚ï¼Œæ ¼å¼å¦‚ä¸‹:execution(æƒé™è®¿é—®ç¬¦ è¿”å›å€¼ç±»å‹ æ–¹æ³•æ‰€å±çš„ç±»ååŒ…è·¯å¾„.æ–¹æ³•å(å½¢å‚ç±»å‹) å¼‚å¸¸ç±»å‹)
e.g. execution(public String com.darren.hellxz.test.Test.access(String,String))

æƒé™ä¿®é¥°ç¬¦å’Œå¼‚å¸¸ç±»å‹å¯çœç•¥ï¼Œè¿”å›ç±»å‹æ”¯æŒé€šé…ç¬¦ï¼Œç±»åã€æ–¹æ³•åæ”¯æŒ*é€šé…ï¼Œæ–¹æ³•å½¢å‚æ”¯æŒ..é€šé…
within: ç”¨æ¥é™å®šè¿æ¥ç‚¹å±äºæŸä¸ªç¡®å®šç±»å‹çš„ç±»ã€‚
within(com.darren.hellxz.test.Test)
within(com.darren.hellxz.test.) &#47;&#47;åŒ…ä¸‹ç±»
within(com.darren.hellxz.test..) &#47;&#47;åŒ…ä¸‹åŠå­åŒ…ä¸‹

thiså’Œtarget: thisç”¨äºæ²¡æœ‰å®ç°æ¥å£çš„Cglibä»£ç†ç±»å‹ï¼Œtargetç”¨äºå®ç°äº†æ¥å£çš„JDKä»£ç†ç›®æ ‡ç±»å‹
ä¸¾ä¾‹ï¼šthis(com.darren.hellxz.test.Foo) &#47;&#47;Fooæ²¡æœ‰å®ç°æ¥å£ï¼Œä½¿ç”¨Cglibä»£ç†ï¼Œç”¨this
å®ç°äº†ä¸ªæ¥å£public class Foo implements Bar{...}
target(com.darren.hellxz.test.Test) &#47;&#47;Fooå®ç°äº†æ¥å£çš„æƒ…å†µ

args: å¯¹è¿æ¥ç‚¹çš„å‚æ•°ç±»å‹è¿›è¡Œé™åˆ¶ï¼Œè¦æ±‚å‚æ•°ç±»å‹æ˜¯æŒ‡å®šç±»å‹çš„å®ä¾‹ã€‚
args(Long)

@target: ç”¨äºåŒ¹é…ç±»å¤´æœ‰æŒ‡å®šæ³¨è§£çš„è¿æ¥ç‚¹
@target(org.springframework.stereotype.Repository)

@args: ç”¨æ¥åŒ¹é…è¿æ¥ç‚¹çš„å‚æ•°çš„ï¼Œ@argsæŒ‡å‡ºè¿æ¥ç‚¹åœ¨è¿è¡Œæ—¶ä¼ è¿‡æ¥çš„å‚æ•°çš„ç±»å¿…é¡»è¦æœ‰æŒ‡å®šçš„æ³¨è§£

@Pointcut(&quot;@args(org.springframework.web.bind.annotation.RequestBody)&quot;)  
public void methodsAcceptingEntities() {}

@within: æŒ‡å®šåŒ¹é…å¿…é¡»åŒ…æ‹¬æŸä¸ªæ³¨è§£çš„çš„ç±»é‡Œçš„æ‰€æœ‰è¿æ¥ç‚¹
@within(org.springframework.stereotype.Repository)

@annotation: åŒ¹é…é‚£äº›æœ‰æŒ‡å®šæ³¨è§£çš„è¿æ¥ç‚¹
@annotation(org.springframework.stereotype.Repository)

bean: ç”¨äºåŒ¹é…æŒ‡å®šBeanå®ä¾‹å†…çš„è¿æ¥ç‚¹ï¼Œä¼ å…¥beançš„idæˆ–name,æ”¯æŒä½¿ç”¨*é€šé…ç¬¦

åˆ‡ç‚¹è¡¨è¾¾å¼ç»„åˆ
ä½¿ç”¨&amp;&amp;ã€||ã€!ã€ä¸‰ç§è¿ç®—ç¬¦æ¥ç»„åˆåˆ‡ç‚¹è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºä¸æˆ–éçš„å…³ç³»

ç¬¬äºŒä¸ªé—®é¢˜å…¶å®ä¸å¤ªæ‡‚ï¼Œç½‘ä¸Šæœäº†æœï¼Œæ ¸å¿ƒåº”è¯¥æ˜¯è¿™ä¸ªæ–¹æ³•ï¼š
org.springframework.util.PropertyPlaceholderHelper#replacePlaceholders(java.lang.String, java.util.Properties)

å‚è€ƒé“¾æ¥ï¼šhttps:&#47;&#47;www.jianshu.com&#47;p&#47;5fecf71024af</p>2020-04-28</li><br/><li><span>hellojd</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æˆ‘ä¹Ÿç»å¸¸çœ‹æ¡†æ¶æºç ï¼Œä½†ç¼ºå¤±äº†è€å¸ˆçš„æ¼”ç¤ºåŠæº¯æºè¿‡ç¨‹ï¼Œå­¦ä¹ åˆ°äº†ã€‚</p>2020-04-28</li><br/><li><span>æ¢¦å€šæ æ†</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>1. é…ç½®ä¼˜å…ˆçº§çš„é—®é¢˜ï¼Œç†è§£çƒ­åŠ è½½çš„æ—¶å€™ä»”ç»†çš„çœ‹è¿‡ï¼ŒçŸ¥é“æœ‰è¿™ä¹ˆå›äº‹ï¼Œè€å¸ˆä¸¾å¾—è¿™ä¸ªä¾‹å­ï¼šå¼€å‘å’Œè¿ç»´éƒ½è®¾ç½®äº†é…ç½®ï¼Œç„¶åè¿ç»´çš„æŠŠå¼€å‘çš„è¦†ç›–äº†ï¼Œè¿™ç§é—®é¢˜å¦‚æœé‡åˆ°äº†æ€ä¹ˆæŸ¥å‘¢ï¼Ÿå¦‚æœæ˜¯åŒä¸€ä¸ªäººç»Ÿä¸€ç®¡ç†è¿˜å¥½è¯´ï¼Œä¸åŒçš„äººè°çŸ¥é“è°è®¾ç½®äº†ä»€ä¹ˆå‘¢ï¼Ÿ
2. åˆ‡é¢ä¸æˆåŠŸçš„å†…å®¹ï¼Œæˆ‘å¡åœ¨äº†åˆ‡é¢ä¸Šã€‚åˆ‡é¢æ€ä¹ˆç”¨è¿˜ä¸å¤ªäº†è§£ã€‚</p>2020-04-28</li><br/><li><span>æ‹›è´¢</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è€å¸ˆï¼Œæˆ‘ç°åœ¨é¡¹ç›®ä¸­é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ç”¨springbootçš„å…¨å±€å¼‚å¸¸å¤„ç†æ—¶ï¼Œå“åº”å‡ºå»çš„ä¿¡æ¯ï¼Œç¼–ç æ ¼å¼éƒ½æ˜¯ISO-8859-1ï¼Œè¯•è¿‡äº†åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®spring.http.encoding.charset=utf-8å’Œè¿‡æ»¤å™¨ä¸­ç»™responseå»setCharacterEncodingä¸ºutf-8ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸è¡Œã€‚æ­£å¸¸å“åº”çš„æ•°æ®æ˜¯ä¸ä¹±ç çš„ï¼Œåªæœ‰å…¨å±€å¼‚å¸¸å¤„ç†å‡ºå»çš„å“åº”æœ‰ä¹±ç ï¼Œè¿™ä¸ªåº”è¯¥æ€ä¹ˆè§£å†³å‘€</p>2020-05-21</li><br/><li><span>æ—…é€”</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆ é—®ä¸¤ä¸ªé—®é¢˜
1.ç¬¬ä¸€ä¸ªä¾‹å­ å»æ‰ribbonä¾èµ–å ApacheHttpClientæ³¨å†Œäº†bean æ‰€ä»¥@FeignClientè¿™é‡Œé¢ç›´æ¥å°±ä½¿ç”¨çš„ApacheHttpClientçš„bea ä¸èµ°é‚£ä¸ªnew çš„ä»£ç äº†æ˜¯å— ï¼Ÿ
2.ç¬¬äºŒä¸ªä¾‹å­. ConfigurationPropertySourcesPropertySourcessè¿™ä¸ªç±»å®é™…ä¸Šä¸€ä¸ªä»£ç† æŸ¥è¯¢çš„èµ°çš„è¿˜æ˜¯å…¶ä»–çš„é…ç½®æº è¿™ä¹ˆåšçš„æ„ä¹‰æ˜¯ä»€ä¹ˆ?</p>2020-05-03</li><br/><li><span>jacy</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æœ‰ä¸ªç–‘é—®ï¼Œæ€è€ƒä¸è®¨è®ºäºŒä¸­çš„çœŸå®æ•°æ®åº“å¯†ç æ”¾å“ªå‘¢ï¼Ÿ</p>2021-05-10</li><br/><li><span>é¾™çŒ«</span> ğŸ‘ï¼ˆ12ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¿™èŠ‚è¯¾æœ‰ç‚¹éš¾åº¦å•Š</p>2020-06-07</li><br/><li><span>æ±æ—å¤–å²</span> ğŸ‘ï¼ˆ11ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ„Ÿè§‰å°±åœ¨ç­‰æœ€åçš„è§£å†³æ–¹æ¡ˆï¼Œç„¶åæˆ›ç„¶è€Œæ­¢äº†ã€‚ã€‚ã€‚</p>2020-04-29</li><br/><li><span>ç¨‹åºå‘˜å°è·ƒ</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æºç ä¹‹ä¸‹æ— ç§˜å¯†ï¼Œä½†æ˜¯çœ‹æºç æŒ‘æˆ˜äº†ä¸€ä¸ªç¨‹åºå‘˜çš„å¿ƒå¢ƒï¼Œéœ€è¦è€å¿ƒï¼Œç»†å¿ƒï¼Œæ’å¿ƒï¼Œç»™è‡ªå·±åŠ æ²¹</p>2020-07-23</li><br/><li><span>Geek_8b92bf</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>within(feign.Client+) ä¸ºä»€ä¹ˆæ˜¯åˆ‡å…¥executeæ–¹æ³•ï¼Œä¸æ˜¯åˆ‡äººapiæ–¹æ³•ï¼Œè¿™ä¸ªä¸å¤ªæ˜ç™½</p>2022-06-24</li><br/><li><span>å¤©å¤©å‘ä¸Š</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è€å¸ˆå¥½ï¼Œå¯¹äºSpring aopä¸­çš„argsè¡¨è¾¾å¼æˆ‘æœ‰ç–‘é—®ï¼š
1.argså¯ä»¥å¯¹è¿æ¥ç‚¹çš„å‚æ•°ç±»å‹è¿›è¡Œé™åˆ¶ï¼Œè¦æ±‚å‚æ•°ç±»å‹æ˜¯æŒ‡å®šç±»å‹çš„å®ä¾‹ï¼Œç”¨æ³•æ˜¯args(ç±»å‹çš„å…¨é™å®šå)ã€‚
2.ä¹Ÿå¯ä»¥ç”¨æ¥è®¿é—®ç›®æ ‡æ–¹æ³•çš„å‚æ•°ï¼Œç”¨æ³•æ˜¯args(å˜é‡å)ã€‚
è¿™ä¸¤ç§ç”¨æ³•ç›®å‰æ²¡çœ‹åˆ°åœ¨åŒä¸€ä¸ªåœ°æ–¹è®²åˆ°çš„ã€‚æˆ‘æƒ³çŸ¥é“è¿™ä¸¤ç§ç”¨æ³•å¯¹åº”çš„argsæ˜¯åŒä¸€ä¸ªargså—ï¼ˆè™½ç„¶éƒ½å«åšargsï¼‰ã€‚å¦‚æœæ˜¯åŒä¸€ä¸ªçš„è¯ï¼Œé‚£springæ˜¯å¦‚ä½•çŸ¥é“éœ€è¦ç”¨åˆ°çš„æ˜¯å“ªç§ç”¨æ³•å‘¢ï¼Ÿ</p>2021-01-14</li><br/><li><span>9jay</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å¯¹FeignClientè¿›è¡ŒAround åˆ‡é¢åï¼Œæ‹¿åˆ°Responseçš„body å­—èŠ‚æµæ— æ³•é‡å¤è¯»å–ã€‚
å¯¼è‡´åœ¨åˆ‡é¢çš„æ—¶å€™è¯»å–äº†è¿”å›å€¼å­—èŠ‚æµåï¼ŒFeignå†å»ååºåˆ—åŒ–æ—¶å¯¹è±¡å°±ä¸ºç©ºã€‚
è¿™ä¸ªæœ‰å¥½çš„æ–¹æ³•è§£å†³å—ï¼Ÿ</p>2021-12-23</li><br/>
</ul>