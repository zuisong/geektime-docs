ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ­å±¹ã€‚ä»Šå¤©æˆ‘ä»¬ç»§ç»­æ‰‹å†™MiniTomcatã€‚

åœ¨å‰é¢çš„å­¦ä¹ å†…å®¹ä¸­ï¼Œæˆ‘ä»¬ä¸ºäº†ç¬¦åˆServletè§„èŒƒï¼Œæ–°å¢äº†HttpRequestä¸HttpResponseç±»ï¼Œä½†æˆªæ­¢åˆ°ç°åœ¨æˆ‘ä»¬åªå¯¹Requestè¯·æ±‚ç›¸å…³çš„ä»£ç è¿›è¡Œäº†å®ç°ï¼Œæ‰€ä»¥è¿™èŠ‚è¯¾æˆ‘ä»¬å°±æ¥æ”¹é€ Responseè¿”å›ä»£ç ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬ä¹Ÿæ³¨æ„åˆ°ï¼Œåœ¨HttpProcessorç±»é‡Œï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨çš„æ˜¯HttpRequestä¸HttpResponseï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡è¦ä¼ å…¥Servleté‡Œï¼Œä½†åœ¨è¿™ä¸¤ä¸ªç±»ä¸­æˆ‘ä»¬ä¹Ÿå®šä¹‰äº†è®¸å¤šå†…éƒ¨çš„æ–¹æ³•ï¼Œä¸€æ—¦è¢«ç”¨æˆ·çŸ¥æ™“æˆ‘ä»¬çš„å®ç°ç±»ï¼Œé‚£ä¹ˆè¿™äº›å†…éƒ¨æ–¹æ³•å°±æš´éœ²åœ¨ç”¨æˆ·é¢å‰äº†ï¼Œè¿™æ˜¯æˆ‘ä»¬ä¸æ„¿çœ‹åˆ°çš„ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦è§„é¿çš„ã€‚å› æ­¤è¿™èŠ‚è¯¾æˆ‘ä»¬è®¡åˆ’ç”¨é—¨é¢ï¼ˆFacadeï¼‰è®¾è®¡æ¨¡å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

ä¸‹é¢å°±è®©æˆ‘ä»¬ä¸€èµ·æ¥åŠ¨æ‰‹å®ç°ã€‚

## é¡¹ç›®ç»“æ„

è¿™èŠ‚è¯¾çš„é¡¹ç›®ç»“æ„ä¸»è¦æ–°å¢äº†HttpRequestFacade.javaä¸HttpResponseFacade.javaä¸¤ä¸ªç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```plain
MiniTomcat
â”œâ”€ src
â”‚  â”œâ”€ main
â”‚  â”‚  â”œâ”€ java
â”‚  â”‚  â”‚  â”œâ”€ server
â”‚  â”‚  â”‚  â”‚  â”œâ”€ DefaultHeaders.java
â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpConnector.java
â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpHeader.java
â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpProcessor.java
â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpRequest.java
â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpRequestFacade.java
â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpRequestLine.java
â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpResponse.java
â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpResponseFacade.java
â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpServer.java
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Request.java
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Response.java
â”‚  â”‚  â”‚  â”‚  â”œâ”€ ServletProcessor.java
â”‚  â”‚  â”‚  â”‚  â”œâ”€ SocketInputStream.java
â”‚  â”‚  â”‚  â”‚  â”œâ”€ StatisResourceProcessor.java
â”‚  â”‚  â”œâ”€ resources
â”‚  â”œâ”€ test
â”‚  â”‚  â”œâ”€ java
â”‚  â”‚  â”‚  â”œâ”€ test
â”‚  â”‚  â”‚  â”‚  â”œâ”€ HelloServlet.java
â”‚  â”‚  â”œâ”€ resources
â”œâ”€ webroot
â”‚  â”œâ”€ test
â”‚  â”‚  â”œâ”€ HelloServlet.class
â”‚  â”œâ”€ hello.txt
â”œâ”€ pom.xml
```

## Responseè¿”å›ä¿¡æ¯è§£æ

ä¸Šä¸€èŠ‚è¯¾æˆ‘ä»¬å®Œæˆäº†Requestè¯·æ±‚ä¿¡æ¯è§£æï¼Œæœ‰äº†å‰æ–‡é“ºå«ï¼Œæ¥ä¸‹æ¥é’ˆå¯¹Responseçš„æ”¹é€ å°±å®¹æ˜“å¾ˆå¤šäº†ã€‚

æˆ‘ä»¬åœ¨å‰é¢æåˆ°è¿‡ï¼ŒHTTPåè®®ä¸­è§„å®šResponseè¿”å›æ ¼å¼ç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆï¼šçŠ¶æ€è¡Œã€å“åº”å¤´ã€ç©ºè¡Œã€å“åº”ä½“ã€‚æˆ‘ä»¬å¸¸ç”¨çš„çŠ¶æ€ç ä¸€èˆ¬ä¸º200ã€401ã€404ã€500ã€503ã€504ç­‰ï¼Œæˆ‘ä»¬åœ¨HttpResponseé‡Œç”¨switchæ¡ä»¶è¯­å¥å…ˆå…³è”å¸¸ç”¨çš„çŠ¶æ€ç ä¸çŠ¶æ€ä¿¡æ¯ã€‚

```java
package server;
public class HttpResponse implements HttpServletResponse {
  protected String getStatusMessage(int status) {
    switch (status) {
        case SC_OK:
            return ("OK");
        case SC_ACCEPTED:
            return ("Accepted");
        case SC_BAD_GATEWAY:
            return ("Bad Gateway");
        case SC_BAD_REQUEST:
            return ("Bad Request");
        case SC_CONTINUE:
            return ("Continue");
        case SC_FORBIDDEN:
            return ("Forbidden");
        case SC_INTERNAL_SERVER_ERROR:
            return ("Internal Server Error");
        case SC_METHOD_NOT_ALLOWED:
            return ("Method Not Allowed");
        case SC_NOT_FOUND:
            return ("Not Found");
        case SC_NOT_IMPLEMENTED:
            return ("Not Implemented");
        case SC_REQUEST_URI_TOO_LONG:
            return ("Request URI Too Long");
        case SC_SERVICE_UNAVAILABLE:
            return ("Service Unavailable");
        case SC_UNAUTHORIZED:
            return ("Unauthorized");
        default:
            return ("HTTP Response Status " + status);
    }
}
```

å…¶ä¸­å®šä¹‰çš„çŠ¶æ€å¸¸é‡éƒ½æ¥è‡ªHttpServletResponseé‡Œçš„å®šä¹‰ã€‚  
æ¥ä¸‹æ¥æˆ‘ä»¬å…³æ³¨å¤´éƒ¨ä¿¡æ¯çš„æ“ä½œï¼Œä½¿ç”¨headersè¿™æ ·ä¸€ä¸ªconcurrentHashMapå­˜å‚¨å¤´éƒ¨çš„é”®å€¼ä¿¡æ¯ï¼Œé‡Œé¢æ˜¯content-lengthå’Œcontent-typeçš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜ä¼šè®¾ç½®ç›¸å…³å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
public class HttpResponse implements HttpServletResponse {
    Map<String, String> headers = new ConcurrentHashMap<>();
    @Override
    public void addHeader(String name, String value) {
        headers.put(name, value);
        if (name.toLowerCase() == DefaultHeaders.CONTENT_LENGTH_NAME) {
            setContentLength(Integer.parseInt(value));
        }
        if (name.toLowerCase() == DefaultHeaders.CONTENT_TYPE_NAME) {
            setContentType(value);
        }
    }
    
    @Override
    public void setHeader(String name, String value) {
        headers.put(name, value);
        if (name.toLowerCase() == DefaultHeaders.CONTENT_LENGTH_NAME) {
            setContentLength(Integer.parseInt(value));
        }
        if (name.toLowerCase() == DefaultHeaders.CONTENT_TYPE_NAME) {
            setContentType(value);
        }
    }
}
```

æœ‰äº†å†…éƒ¨çš„å¤´éƒ¨ä¿¡æ¯ï¼Œæˆ‘ä»¬è¿˜ä¼šæä¾›ä¸€ä¸ªsendHeadersæ–¹æ³•ï¼ŒæŒ‰ç…§HTTPåè®®çš„è§„å®šæ‹¼æ¥ï¼ŒåŒ…å«çŠ¶æ€è¡Œã€å¤´ä¿¡æ¯å’Œç©ºè¡Œï¼Œå°†Headeræ‰“å°å‡ºæ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public void sendHeaders() throws IOException {
    PrintWriter outputWriter = getWriter();
    //ä¸‹é¢è¿™ä¸€ç«¯æ˜¯è¾“å‡ºçŠ¶æ€è¡Œ
    outputWriter.print(this.getProtocol());
    outputWriter.print(" ");
    outputWriter.print(status);
    if (message != null) {
        outputWriter.print(" ");
        outputWriter.print(message);
    }
    outputWriter.print("\r\n");
    
    if (getContentType() != null) {
        outputWriter.print("Content-Type: " + getContentType() + "\r\n");
    }
    if (getContentLength() >= 0) {
        outputWriter.print("Content-Length: " + getContentLength() + "\r\n");
    }
    
    //è¾“å‡ºå¤´ä¿¡æ¯
    Iterator<String> names = headers.keySet().iterator();
    while (names.hasNext()) {
        String name = names.next();
        String value = headers.get(name);
        outputWriter.print(name);
        outputWriter.print(": ");
        outputWriter.print(value);
        outputWriter.print("\r\n");
    }
    
    //æœ€åè¾“å‡ºç©ºè¡Œ
    outputWriter.print("\r\n");
    outputWriter.flush();
}
```

å®Œæ•´çš„HttpResponseæ”¹é€ å¦‚ä¸‹ï¼Œç”±äºä»£ç å¤ªé•¿ï¼Œå…¶ä¸­éå…³é”®çš„å®ç°æ–¹æ³•å°±ä¸åˆ—åœ¨è¿™é‡Œäº†ã€‚

```java
package server;
public class HttpResponse implements HttpServletResponse {
    HttpRequest request;
    OutputStream output;
    PrintWriter writer;
    String contentType = null;
    long contentLength = -1;
    String charset = null;
    String characterEncoding = null;
    String protocol = "HTTP/1.1";
    //headersæ˜¯ä¸€ä¸ªä¿å­˜å¤´ä¿¡æ¯çš„map
    Map<String, String> headers = new ConcurrentHashMap<>();
    //é»˜è®¤è¿”å›OK
    String message = getStatusMessage(HttpServletResponse.SC_OK);
    int status = HttpServletResponse.SC_OK;
    
    public HttpResponse(OutputStream output) {
        this.output = output;
    }
    public void setRequest(HttpRequest request) {
        this.request = request;
    }
    //çŠ¶æ€ç ä»¥åŠæ¶ˆæ¯æ–‡æœ¬ï¼Œæ²¡æœ‰è€ƒè™‘å›½é™…åŒ–
    protected String getStatusMessage(int status) {
        switch (status) {
            case SC_OK:
                return ("OK");
            case SC_ACCEPTED:
                return ("Accepted");
            case SC_BAD_GATEWAY:
                return ("Bad Gateway");
            case SC_BAD_REQUEST:
                return ("Bad Request");
            case SC_CONTINUE:
                return ("Continue");
            case SC_FORBIDDEN:
                return ("Forbidden");
            case SC_INTERNAL_SERVER_ERROR:
                return ("Internal Server Error");
            case SC_METHOD_NOT_ALLOWED:
                return ("Method Not Allowed");
            case SC_NOT_FOUND:
                return ("Not Found");
            case SC_NOT_IMPLEMENTED:
                return ("Not Implemented");
            case SC_REQUEST_URI_TOO_LONG:
                return ("Request URI Too Long");
            case SC_SERVICE_UNAVAILABLE:
                return ("Service Unavailable");
            case SC_UNAUTHORIZED:
                return ("Unauthorized");
            default:
                return ("HTTP Response Status " + status);
        }
    }
    public void sendHeaders() throws IOException {
        PrintWriter outputWriter = getWriter();
        //ä¸‹é¢è¿™ä¸€ç«¯æ˜¯è¾“å‡ºçŠ¶æ€è¡Œ
        outputWriter.print(this.getProtocol());
        outputWriter.print(" ");
        outputWriter.print(status);
        if (message != null) {
            outputWriter.print(" ");
            outputWriter.print(message);
        }
        outputWriter.print("\r\n");
        if (getContentType() != null) {
            outputWriter.print("Content-Type: " + getContentType() + "\r\n");
        }
        if (getContentLength() >= 0) {
            outputWriter.print("Content-Length: " + getContentLength() + "\r\n");
        }
        //è¾“å‡ºå¤´ä¿¡æ¯
        Iterator<String> names = headers.keySet().iterator();
        while (names.hasNext()) {
            String name = names.next();
            String value = headers.get(name);
            outputWriter.print(name);
            outputWriter.print(": ");
            outputWriter.print(value);
            outputWriter.print("\r\n");
        }
        //æœ€åè¾“å‡ºç©ºè¡Œ
        outputWriter.print("\r\n");
        outputWriter.flush();
    }
    @Override
    public String getCharacterEncoding() {
        return this.characterEncoding;
    }
    @Override
    public String getContentType() {
        return this.contentType;
    }
    @Override
    public PrintWriter getWriter() throws IOException {
        writer = new PrintWriter(new OutputStreamWriter(output, getCharacterEncoding()), true);
        return writer;
    }
    @Override
    public void setCharacterEncoding(String arg0) {
        this.characterEncoding = arg0;
    }
    @Override
    public void setContentType(String arg0) {
        this.contentType = arg0;
    }
    @Override
    public void addHeader(String name, String value) {
        headers.put(name, value);
        if (name.toLowerCase() == DefaultHeaders.CONTENT_LENGTH_NAME) {
            setContentLength(Integer.parseInt(value));
        }
        if (name.toLowerCase() == DefaultHeaders.CONTENT_TYPE_NAME) {
            setContentType(value);
        }
    }
    @Override
    public String getHeader(String name) {
        return headers.get(name);
    }
    @Override
    public Collection<String> getHeaderNames() {
        return headers.keySet();
    }
    public void setHeader(String name, String value) {
        headers.put(name, value);
        if (name.toLowerCase() == DefaultHeaders.CONTENT_LENGTH_NAME) {
            setContentLength(Integer.parseInt(value));
        }
        if (name.toLowerCase() == DefaultHeaders.CONTENT_TYPE_NAME) {
            setContentType(value);
        }
    }

```

## Processorä¸­çš„æ”¹é€ 

ä¿®æ”¹å®Œresponseä¹‹åï¼Œè‡ªç„¶åœ°ï¼Œæˆ‘ä»¬åœ¨HttpProcessorä¸­ï¼Œå°†åŸæ¥å¼•ç”¨æˆ–åˆå§‹åŒ–Responseç±»çš„åœ°æ–¹ï¼Œå…¨éƒ¨ç”¨HttpResponseæ›¿ä»£ã€‚

```java
HttpProcessor.java
Â  // create Response object
Â  HttpResponse response = new HttpResponse(output);
Â  response.setRequest(request);
```

ServletProcessorç±»processä»£ç å¦‚ä¸‹ï¼š

```java
public class ServletProcessor {
    public void process(HttpRequest request, HttpResponse response) {
        String uri = request.getUri();
        String servletName = uri.substring(uri.lastIndexOf("/") + 1);
        URLClassLoader loader = null;
        try {
            // create a URLClassLoader
            URL[] urls = new URL[1];
            URLStreamHandler streamHandler = null;
            //è¿™ä¸ªURLClassloaderçš„å·¥ä½œç›®å½•è®¾ç½®åœ¨HttpServer.WEB_ROOT
            File classPath = new File(HttpServer.WEB_ROOT);
            String repository = (new URL("file", null, classPath.getCanonicalPath() + File.separator)).toString() ;
            urls[0] = new URL(null, repository, streamHandler);
            loader = new URLClassLoader(urls);
        }
        catch (IOException e) {
            System.out.println(e.toString() );
        }
        //responseé»˜è®¤ä¸ºUTF-8ç¼–ç 
        response.setCharacterEncoding("UTF-8");
        Class<?> servletClass = null;
        try {
            servletClass = loader.loadClass(servletName);
        }
        catch (ClassNotFoundException e) {
            System.out.println(e.toString());
        }
        //å›å†™å¤´ä¿¡æ¯
        try {
            response.sendHeaders();
        } catch (IOException e1) {
            e1.printStackTrace();
        }
        //åˆ›å»ºservletæ–°å®ä¾‹ï¼Œè°ƒç”¨service()
        Servlet servlet = null;
        try {
            servlet = (Servlet) servletClass.newInstance();
            servlet.service(request, response);
        }
        catch (Exception e) {
            System.out.println(e.toString());
        }
        catch (Throwable e) {
            System.out.println(e.toString());
        }
    }
}
```

åœ¨æ­¤æˆ‘ä»¬å®Œæˆäº†HttpRequestä¸HttpResponseçš„æ›¿æ¢ã€‚

## Facadeæ¨¡å¼çš„åº”ç”¨

ç°åœ¨æœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦æˆ‘ä»¬è§£å†³ï¼šæˆ‘ä»¬ç›´æ¥ä½¿ç”¨çš„æ˜¯HttpRequestä¸HttpResponseï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡è¦ä¼ å…¥Servletä¸­ï¼Œä½†åœ¨è¿™ä¸¤ä¸ªç±»ä¸­æˆ‘ä»¬ä¹Ÿå®šä¹‰äº†è®¸å¤šå†…éƒ¨çš„æ–¹æ³•ï¼Œä¸€æ—¦è¢«ç”¨æˆ·çŸ¥æ™“æˆ‘ä»¬çš„å®ç°ç±»ï¼Œåˆ™è¿™äº›å†…éƒ¨æ–¹æ³•å°±æš´éœ²åœ¨ç”¨æˆ·é¢å‰äº†ã€‚

è¿™æ ·å…¶å®æ˜¯ä¸å¥½çš„ã€‚é¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ€æƒ³ï¼Œæ˜¯å°†å†…éƒ¨å®ç°çš„ç»“æ„å’Œå¤æ‚æ€§åŒ…è£…åœ¨ä¸€å±‚å£³é‡Œé¢ï¼Œèƒ½ä¸å¯¹å¤–æš´éœ²å°±ä¸è¦å¯¹å¤–æš´éœ²ã€‚ä½œä¸ºå®¢æˆ·ç¨‹åºï¼Œæœ€å¥½åªçŸ¥é“æœ€å°çŸ¥è¯†é›†ã€‚å¦å¤–ï¼Œè¿™ä¸ªRequestå’ŒResponseç±»æ˜¯è¦ä¼ ç»™å¤–éƒ¨çš„Servletç¨‹åºçš„ï¼Œè·³å‡ºäº†Tomcatæœ¬èº«ï¼Œå¦‚æœè¿™ä¸ªå†™Servletçš„ç¨‹åºå‘˜ä»–çŸ¥é“ä¼ çš„è¿™ä¸ªç±»é‡Œé¢æœ‰ä¸€äº›é¢å¤–çš„æ–¹æ³•ï¼ŒåŸç†ä¸Šä»–å¯ä»¥è¿›è¡Œå¼ºåˆ¶è½¬æ¢ä¹‹åè°ƒç”¨ï¼Œè¿™æ ·ä¹Ÿä¸æ˜¯å¾ˆå®‰å…¨ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨é—¨é¢è®¾è®¡æ¨¡å¼ï¼Œè§„é¿ä¸Šè¿°é—®é¢˜ã€‚

å…ˆè§£é‡Šä¸€ä¸‹Facadeæ¨¡å¼ï¼ŒFacadeè¿™ä¸ªè¯æ¥è‡ªäºå»ºç­‘å­¦ï¼Œå­—é¢æ„æ€æ˜¯â€œç«‹é¢â€ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨å¤§è¡—ä¸Šçœ‹åˆ°çš„é—¨é¢ã€‚é—¨é¢æŠŠå»ºç­‘çš„å†…éƒ¨ç»“æ„åŒ…è£…èµ·æ¥ç»™äººä»¬å±•ç¤ºäº†ä¸€ä¸ªæ–°çš„å‹å¥½çš„æœ‰ç‰¹è‰²çš„å¤–è§‚ã€‚è½¯ä»¶ä¸­ç”¨åŒæ ·çš„æ‰‹æ³•ï¼Œå°†è½¯ä»¶çš„å†…éƒ¨ç»“æ„è¿›è¡ŒåŒ…è£…ï¼Œå¯¹å¤–ç”¨ç®€å•çš„APIä¾›äººä½¿ç”¨ã€‚

ä¸‹é¢æ˜¯Facadeçš„ç»“æ„å›¾ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/80/45/807b51e8b4d226b68e01aca29f121545.png?wh=1920x1229)

çœ‹ä¸Šå›¾ï¼Œæœ¬æ¥ä¸€ä¸ªè½¯ä»¶ä¸­æœ‰å‡ ä¸ªç±»ï¼Œä¸€ä¸ªç±»é‡Œé¢æœ‰ä¸€å †æ–¹æ³•ï¼Œç»™å¤–é¢çš„clientç¨‹åºç›´æ¥ç”¨ä¼šå¢æ·»å¾ˆå¤šå¤æ‚æ€§è€Œä¸”ä¸å®‰å…¨ï¼Œäºæ˜¯ä¸­é—´åŠ äº†ä¸€å±‚Facadeï¼Œæä¾›ä¸€ä¸ªç®€å•çš„doSomething()æ–¹æ³•ã€‚è¿™æ ·å¯¹ä½¿ç”¨è€…æ¥è¯´å¾ˆç®€å•æ–¹ä¾¿ï¼Œä¹Ÿä¾¿äºå†…éƒ¨ç»“æ„çš„è°ƒæ•´ï¼Œæœªæ¥éœ€è¦æ”¹åŠ¨å†…éƒ¨å®ç°çš„æ—¶å€™ï¼Œå› ä¸ºæœ‰è¿™ä¸ªFacadeå­˜åœ¨ï¼Œæ‰€ä»¥å¹¶ä¸éœ€è¦æ”¹åŠ¨å¯¹å¤–çš„æ¥å£ã€‚

Facadeç±»æ˜¯ä¸€ä¸ªæ–°ç±»ï¼Œå¤–éƒ¨ä½¿ç”¨è€…æ²¡æ³•æ ¹æ®å®ƒæ¥å¼ºåˆ¶è½¬æ¢è·å¾—å†…éƒ¨çš„ç»“æ„å’Œæ–¹æ³•ï¼Œè¿™æ ·å°†å®é™…å®ç°çš„å‡ ä¸ªç±»ä¿æŠ¤èµ·æ¥äº†ï¼Œæé«˜äº†å®‰å…¨æ€§ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬ç°åœ¨åœ¨å¤„ç†Requestå’ŒResponseçš„æ—¶å€™æ‰€å¸Œæœ›çœ‹åˆ°çš„ã€‚æˆ‘ä»¬æŒ‰ç…§è¿™ä¸ªæ€è·¯å†™è‡ªå·±çš„Facadeã€‚

é¦–å…ˆå®šä¹‰HttpRequestFacadeä¸HttpResponseFacadeï¼Œåˆ†åˆ«å®ç°HttpServletRequestä¸HttpServletResponseã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹æˆ‘ç»™å‡ºçš„ä»£ç ä¸»ä½“éƒ¨åˆ†ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯ç›´æ¥è½¬åˆ°requestå’Œresponseé‡Œé¢çš„ç›¸åº”è°ƒç”¨ï¼Œå®Œæ•´ä»£ç å°±ä¸ä¸€ä¸€å±•ç¤ºäº†ï¼Œä½ å¯ä»¥çœ‹æœ€åçš„Giteeé“¾æ¥ã€‚

HttpRequestFacade.javaï¼š

```java
package server;
public class HttpRequestFacade implements HttpServletRequest {
    private HttpServletRequest request;
    public HttpRequestFacade(HttpRequest request) {
        this.request = request;
    }
    /* implementation of the HttpServletRequest*/
    public Object getAttribute(String name) {
        return request.getAttribute(name);
    }
    public Enumeration getAttributeNames() {
        return request.getAttributeNames();
    }
    public String getCharacterEncoding() {
        return request.getCharacterEncoding();
    }
    public int getContentLength() {
        return request.getContentLength();
    }
    public String getContentType() {
        return request.getContentType();
    }
    public Cookie[] getCookies() {
        return request.getCookies();
    }
    public Enumeration getHeaderNames() {
        return request.getHeaderNames();
    }
    public String getHeader(String name) {
        return request.getHeader(name);
    }
    public Enumeration getHeaders(String name) {
        return request.getHeaders(name);
    }
    public ServletInputStream getInputStream() throws IOException {
        return request.getInputStream();
    }
    public int getIntHeader(String name) {
        return request.getIntHeader(name);
    }
    public String getMethod() {
        return request.getMethod();
    }
    public String getParameter(String name) {
        return request.getParameter(name);
    }
    public Map getParameterMap() {
        return request.getParameterMap();
    }
    public Enumeration getParameterNames() {
        return request.getParameterNames();
    }
    public String[] getParameterValues(String name) {
        return request.getParameterValues(name);
    }
    public String getQueryString() {
        return request.getQueryString();
    }
    public BufferedReader getReader() throws IOException {
        return request.getReader();
    }
    public String getRequestURI() {
        return request.getRequestURI();
    }
    public StringBuffer getRequestURL() {
        return request.getRequestURL();
    }
    public HttpSession getSession() {
        return request.getSession();
    }
    public HttpSession getSession(boolean create) {
        return request.getSession(create);
    }
    public void removeAttribute(String attribute) {
        request.removeAttribute(attribute);
    }
    public void setAttribute(String key, Object value) {
        request.setAttribute(key, value);
    }
    public void setCharacterEncoding(String encoding) throws UnsupportedEncodingException {
        request.setCharacterEncoding(encoding);
    }
}
```

HttpResponseFacade.javaç±»ä¸»ä½“å®šä¹‰å¦‚ä¸‹ï¼š

```java
package server;

public class HttpResponseFacade implements HttpServletResponse {
    private HttpServletResponse response;
    public HttpResponseFacade(HttpResponse response) {
        this.response = response;
    }
    public void addDateHeader(String name, long value) {
        response.addDateHeader(name, value);
    }
    public void addHeader(String name, String value) {
        response.addHeader(name, value);
    }
    public boolean containsHeader(String name) {
        return response.containsHeader(name);
    }
    public String encodeUrl(String url) {
        return response.encodeUrl(url);
    }
    public String encodeURL(String url) {
        return response.encodeURL(url);
    }
    public void flushBuffer() throws IOException {
        response.flushBuffer();
    }
    public String getCharacterEncoding() {
        return response.getCharacterEncoding();
    }
    @Override
    public String getContentType() {
        return null;
    }
    @Override
    public void setCharacterEncoding(String s) {
    }
    public void setContentLength(int length) {
        response.setContentLength(length);
    }
    public void setContentType(String type) {
        response.setContentType(type);
    }
    public void setHeader(String name, String value) {
        response.setHeader(name, value);
    }
    public ServletOutputStream getOutputStream() throws IOException {
        return response.getOutputStream();
    }
    @Override
    public PrintWriter getWriter() throws IOException {
        return response.getWriter();
    }
    @Override
    public void addCookie(Cookie arg0) {
        response.addCookie(arg0);
    }
    @Override
    public String getHeader(String arg0) {
        return response.getHeader(arg0);
    }
    @Override
    public Collection<String> getHeaderNames() {
        return response.getHeaderNames();
    }
    @Override
    public Collection<String> getHeaders(String arg0) {
        return response.getHeaders(arg0);
    }
}
```

åœ¨æ­¤ä¸¤ä¸ªFacadeå°±å®šä¹‰å®Œæ¯•äº†ï¼Œå‰é¢æˆ‘ä»¬ä¹Ÿè¯´è¿‡ï¼Œæˆ‘ä»¬è¦åšçš„æ˜¯å‘Servletä¼ å…¥å‚æ•°æ—¶è§„é¿å†…éƒ¨æ–¹æ³•ï¼Œè€ŒFacadeçš„ä½œç”¨å°±æ˜¯å°è£…ä¸å¸Œæœ›æš´éœ²çš„æ–¹æ³•ï¼Œæ›´æ·±å±‚çš„å†…éƒ¨æ–¹æ³•ä¸äºˆå±•ç¤ºã€‚å› è€Œåœ¨ServletProcessorä¸­ï¼ŒServletè°ƒç”¨serviceæ—¶æˆ‘ä»¬ä¼ å…¥HttpRequestFacadeä¸HttpResponseFacadeï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹éœ€è¦è°ƒæ•´çš„éƒ¨åˆ†ä»£ç ã€‚

```java
ServletProcessor.java

Servlet servlet = null;
//è°ƒç”¨servletçš„service()æ–¹æ³•æ—¶ä¼ å…¥çš„æ˜¯Facadeå¯¹è±¡
try {
    servlet = (Servlet) servletClass.newInstance();
    HttpRequestFacade requestFacade = new HttpRequestFacade(request);
    HttpResponseFacade responseFacade = new HttpResponseFacade(response);
    servlet.service(requestFacade, responseFacade);
}

```

è¿™æ ·åœ¨Servletä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°çš„åªæ˜¯Facadeï¼Œçœ‹ä¸è§å†…éƒ¨æ–¹æ³•ï¼Œåº”ç”¨ç¨‹åºå‘˜æƒ³è¿›è¡Œå¼ºåˆ¶è½¬åŒ–ä¹Ÿä¸è¡Œï¼Œè¿™æ ·æ—¢ç®€å•åˆå®‰å…¨ã€‚

è¿˜æœ‰ï¼ŒæŒ‰ç…§Servletçš„è§„èŒƒï¼Œå®¢æˆ·è‡ªå®šä¹‰çš„Servletæ˜¯è¦ç»§æ‰¿HttpServletçš„ï¼Œåœ¨è°ƒç”¨çš„serviceæ–¹æ³•å†…ï¼Œå®ƒçš„å®é™…è¡Œä¸ºæ˜¯é€šè¿‡methodåˆ¤æ–­è°ƒç”¨çš„æ˜¯å“ªä¸€ä¸ªæ–¹æ³•ï¼Œå¦‚æœæ˜¯Getæ–¹æ³•å°±è°ƒç”¨doGet()ï¼Œå¦‚æœæ˜¯Postæ–¹æ³•è°ƒç”¨çš„å°±æ˜¯doPost()ï¼Œå…¶ä»–çš„æ–¹æ³•ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ã€‚

æ‰€ä»¥åœ¨æˆ‘ä»¬è‡ªå®šä¹‰çš„HttpRequesté‡Œï¼Œä¸€å®šè¦å®ç°getMethodæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥è°ƒæ•´ä¸€ä¸‹ã€‚

```java
package server;
public class HttpRequest implements HttpServletRequest{
    @Override
    public String getMethod() {
      return new String(this.requestLine.method, 0, this.requestLine.methodEnd);
    }
}
```

è¿™æ ·åšå¯ä»¥ç®€åŒ–å®¢æˆ·ç¨‹åºï¼Œè®©ä¸šåŠ¡ç¨‹åºå‘˜å†™Servletçš„æ—¶å€™åªéœ€è¦é‡è½½doGet()æˆ–doPost()æ–¹æ³•å³å¯ã€‚

è¿™æ ·æˆ‘ä»¬è¿™ä¸ªé˜¶æ®µçš„æ”¹é€ å°±å®Œæˆäº†ã€‚

## æµ‹è¯•

æˆ‘ä»¬è¿™èŠ‚è¯¾çš„å®ç°åªæ˜¯å†…éƒ¨ç¨‹åºç»“æ„çš„å˜åŠ¨ï¼Œå¹¶ä¸å½±å“ç”¨æˆ·çš„Servletå’Œå®¢æˆ·ç«¯çš„è®¿é—®ã€‚æ‰€ä»¥è¿˜æ˜¯å¯ä»¥æ²¿ç”¨ä»¥å‰çš„æµ‹è¯•åŠæ³•è¿›è¡ŒéªŒè¯ã€‚

## å°ç»“

![](https://static001.geekbang.org/resource/image/02/b2/02f040768f67d31ba4bc8bab64d757b2.jpg?wh=3321x1536)

è¿™èŠ‚è¯¾æˆ‘ä»¬ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼šä¸€æ˜¯è§£æResponseçš„è¿”å›ä¿¡æ¯ï¼Œå­˜å‚¨Headerä¿¡æ¯ï¼Œå¯ä»¥è®©æˆ‘ä»¬æ›´å¥½åœ°å¤„ç†æœåŠ¡å™¨å“åº”ï¼›äºŒæ˜¯é‡‡ç”¨Facadeé—¨é¢æ¨¡å¼ï¼Œæ–°å¢HttpRequestFacadeä¸HttpResponseFacadeï¼Œå°è£…æˆ‘ä»¬ä¸å¸Œæœ›æš´éœ²çš„æ–¹æ³•ä½“ï¼Œé¿å…è¢«ä¸šåŠ¡ç¨‹åºå‘˜ç›´æ¥è°ƒç”¨å®ç°ç±»çš„å†…éƒ¨æ–¹æ³•ã€‚

é€šè¿‡è¿™ä¸¤ä»¶äº‹æƒ…ï¼Œæˆ‘ä»¬æ—¢ç¬¦åˆäº†Servletçš„è§„èŒƒï¼Œåˆè®©MiniTomcatæœ¬èº«åœ¨é¢å¯¹Servletåº”ç”¨ç¨‹åºå‘˜çš„æ—¶å€™æ›´åŠ å®‰å…¨ã€‚è¿™ä¸ªFacadeçš„è®¾è®¡æ˜¯Tomcatä¸­è¢«äººç§°èµçš„ä¼˜ç‚¹ï¼Œæˆ‘ä»¬è‡ªå·±å°è¯•è®¾è®¡æ¡†æ¶çš„æ—¶å€™å¯ä»¥å€Ÿé‰´ã€‚

æœ¬èŠ‚è¯¾å®Œæ•´ä»£ç å‚è§ï¼š[https://gitee.com/yaleguo1/minit-learning-demo/tree/geek\_chapter07](https://gitee.com/yaleguo1/minit-learning-demo/tree/geek_chapter07)

## æ€è€ƒé¢˜

å­¦å®Œäº†è¿™èŠ‚è¯¾çš„å†…å®¹ï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœæˆ‘ä»¬ä¸å¼•å…¥Facadeï¼Œé‚£ä¹ˆä¸€ä¸ªServletç¨‹åºå‘˜æœ‰å¯èƒ½åšäº›ä»€ä¹ˆæˆ‘ä»¬ä¸å¸Œæœ›ä»–ä»¬åšçš„äº‹æƒ…ï¼Ÿ

æ¬¢è¿ä½ æŠŠä½ æ€è€ƒåçš„ç»“æœåˆ†äº«åˆ°è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ5ï¼‰</strong></div><ul>
<li><span>HHğŸ·ğŸ </span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç›®å‰æƒ³åˆ°æœ‰ä¸¤ç‚¹
1ï¼Œç›´æ¥æ“ä½œè¯·æ±‚å‚æ•°ï¼Œ ä¼šæœ‰æ•°æ®ç¯¡æ”¹å«Œç–‘
2ï¼Œå½±å“æ­£å¸¸æµç¨‹ï¼Œ æ¯”å¦‚å·²ç»è°ƒç”¨ response.sendHeaders æ–¹æ³•ï¼Œ å¼€å‘äººå‘˜ä¸ç†Ÿæ‚‰æ•´ä¸ªå¤æ‚æµç¨‹æ­¥éª¤ï¼Œæœ‰å¯èƒ½ä¼šé‡å¤è°ƒç”¨ã€‚

è¯·è€å¸ˆæŒ‡ç‚¹</p>2023-12-24</li><br/><li><span>peter</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è¯·æ•™è€å¸ˆå‡ ä¸ªé—®é¢˜ï¼š
Q1ï¼šaddHeaderä¸setHeaderä»£ç ç›¸åŒï¼Œä¸å°±é‡å¤äº†å—ï¼Ÿ
HttpResponseä¸­çš„è¿™ä¸¤ä¸ªç±»ï¼Œä»£ç å®Œå…¨ç›¸åŒï¼Œé‡å¤å•Šã€‚

Q2ï¼šsendHeadersæ–¹æ³•å’Œservlet.serviceæ˜¯åˆ†åˆ«è¾“å‡ºåˆ°æµè§ˆå™¨å—ï¼Ÿ
ServletProcessorç±»çš„processæ–¹æ³•ä¸­ï¼Œå…ˆæ˜¯è°ƒç”¨response.sendHeaders(); è¿™ä¸ªæ–¹æ³•æ˜¯æŠŠå¤´éƒ¨ä¿¡æ¯è¾“å‡ºåˆ°æµè§ˆå™¨å—ï¼Ÿç´§æ¥ç€åˆè°ƒç”¨servlet.serviceï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯è¾“å‡ºå†…å®¹åˆ°æµè§ˆå™¨ã€‚è¿™ä¸¤æ¬¡è¾“å‡ºæ˜¯é¡ºåºå®Œæˆçš„å—ï¼Ÿæ„Ÿè§‰åº”è¯¥æ˜¯ä¸€èµ·è¾“å‡ºåˆ°æµè§ˆå™¨æ‰å¯¹ï¼Œä¸è¿‡ç”¨äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œæ„Ÿè§‰æ˜¯åˆ†åˆ«è¾“å‡ºåˆ°æµè§ˆå™¨ã€‚

Q3ï¼šnewInstanceè¿‡æ—¶äº†ï¼Œæ›¿ä»£æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Ÿ
æˆ‘ç”¨Idea2019ï¼Œå¯¹äºâ€œservlet = (Servlet) servletClass.newInstance();
â€è¿™è¡Œä»£ç ï¼ŒIdeaæç¤ºæ­¤æ–¹æ³•å·²ç»è¿‡æ—¶äº†ã€‚å¦‚æœè¿‡æ—¶äº†ï¼Œæ›¿ä»£æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Ÿ

Q4ï¼šgetMethodå¹¶æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå¯¹å—ï¼Ÿ
HttpRequestä¸­è™½ç„¶å®ç°äº†getMethodæ–¹æ³•ï¼Œä½†ç¨‹åºè¿è¡Œå¹¶æ²¡æœ‰ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œå¯¹å—ï¼Ÿï¼ˆä¹Ÿè®¸ç”¨äº†ï¼Œä½†æˆ‘æ²¡æœ‰çœ‹åˆ°ï¼‰

Q5ï¼šHttpRequestFacadeç±»ä¸­çš„æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰åŠ overrideæ³¨è§£ï¼Ÿ
æˆ‘è¿™é‡ŒIdea2019æœ‰çº¢çº¿æç¤ºï¼Œæç¤ºç¼ºå°‘overrideæ³¨è§£ï¼Œä½†æ˜¯èƒ½è¿è¡Œã€‚

Q6ï¼šTomcatæºç å¤§çº¦å¤šå°‘è¡Œï¼Ÿè€å¸ˆä¸€èˆ¬ç”¨ä»€ä¹ˆçœ‹Tomcatæºç ï¼Ÿ
ç”¨SourceInsight?è¿˜æ˜¯ç›´æ¥ç”¨Ideaçœ‹ï¼Ÿ

Q7ï¼šå¯¹URLä¸ºä»€ä¹ˆè¦ç”¨URLClassLoaderï¼Ÿä¼ ç»Ÿçš„å‡ ä¸ªClassLoaderéš¾é“ä¸èƒ½åŠ è½½å—ï¼Ÿ</p>2023-12-23</li><br/><li><span>å°å››</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¿™ä¸ªfacadeæ„Ÿè§‰ç”¨wrapperæ›´åˆç†ä¸€äº›å§ï¼Ÿ</p>2024-03-20</li><br/><li><span>é©¬ä»¥</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä¸å¸Œæœ›å¤–éƒ¨ä¿®æ”¹çš„æŠŠæ–¹æ³•è®¾ç½®ä¸ºç§æœ‰ï¼Œåªå¼€æ”¾å‡ºå¿…è¦çš„æ–¹æ³•ï¼Œè®¾ç½®ä¸ºpublic
</p>2024-01-08</li><br/><li><span>ç å“¥å­—èŠ‚</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¯·æ•™è€å¸ˆä¸€ä¸ªé—®é¢˜ï¼Œå“åº”ç»™æµè§ˆå™¨çš„é¡µé¢å˜æˆäº†htmlæ–‡æœ¬ï¼Œæµè§ˆå™¨f12 å“åº”å¤´ä¸ºç©ºã€‚</p>2024-09-11</li><br/>
</ul>