ä½ å¥½ï¼Œæˆ‘æ˜¯é»„ä¿Šå½¬ã€‚

ä¸ŠèŠ‚è¯¾æˆ‘ä»¬é‡æ„äº†æ¶ˆæ¯ç»„ä»¶ï¼Œæœ€åé—ç•™äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ¶ˆæ¯ç»„ä»¶çš„æ•°æ®å­˜å‚¨éƒ½æ˜¯é‡‡ç”¨SQLæ‹¼å†™çš„æ–¹å¼æ¥æ“ä½œï¼Œè¿™æ ·ä¸ä¾¿äºåç»­çš„æ‰©å±•åŠç»´æŠ¤ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œç›¸æ¯”å‰é¢çš„å…¶ä»–é‡æ„ï¼Œå‡çº§æ•°æ®æ¡†æ¶éœ€è¦è€ƒè™‘çš„åœºæ™¯ä¼šæ›´å¤šï¼Œä¾‹å¦‚å‡çº§æ¡†æ¶ä»¥åç”¨æˆ·çš„é‡è¦æ•°æ®ä¸èƒ½ä¸¢å¤±ã€‚

ä»Šå¤©æˆ‘ä»¬ä»¥Sharingé¡¹ç›®ä¸ºä¾‹ï¼Œä¸€èµ·æŠŠé¡¹ç›®ä¸­åŸå…ˆé‡‡ç”¨SQLæ‹¼å†™çš„æ–¹å¼æ›¿æ¢ä¸ºä½¿ç”¨Roomæ¡†æ¶æ¥ç»Ÿä¸€ç®¡ç†ç¼“å­˜æ•°æ®ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä¼šä¸ä½ åˆ†äº«å¦‚ä½•å°æ­¥å®‰å…¨é‡æ„ï¼Œåˆ†é˜¶æ®µå®Œæˆæ•°æ®åº“æ¡†æ¶çš„å‡çº§ã€‚ä¸ºäº†ç¡®ä¿é‡æ„å®Œçš„ä»£ç ä¸ä¼šç ´ååŸæœ‰åŠŸèƒ½ï¼Œè¿˜æœ‰ç”¨æˆ·çš„å…³é”®æ•°æ®ä¸ä¸¢å¤±ï¼Œæˆ‘è¿˜ä¼šè®²è§£å¦‚ä½•ç»™æ•°æ®æ“ä½œç›¸å…³åŠŸèƒ½åšè‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–ï¼Œä»¥åŠå¦‚ä½•å®ç°æ›´å®‰å…¨çš„æ•°æ®è¿ç§»ã€‚

## ä»£ç åˆ†æ

æˆ‘ä»¬å…ˆä¸€èµ·æ¥çœ‹çœ‹æ¶ˆæ¯ç»„ä»¶ä¸­åˆ›å»ºæ•°æ®åº“è¡¨çš„ç›¸å…³æ“ä½œï¼Œæ ¸å¿ƒä»£ç æ˜¯åé¢è¿™æ ·ã€‚

```plain
//æ•°æ®åº“è¡¨çš„åˆ›å»º
class DataBaseHelper(context: Context?) : SQLiteOpenHelper(context, "message.db", null, 1) {
    override fun onCreate(db: SQLiteDatabase) {
        createTable(db)
    }
    override fun onUpgrade(db: SQLiteDatabase, oldVersion: Int, newVersion: Int) {}
    fun createTable(db: SQLiteDatabase) {
        val createTableSql = """CREATE TABLE IF NOT EXISTS $message_info(
   $id INTEGER PRIMARY KEY AUTOINCREMENT,
   $content VARCHAR(1024) ,
   $fileName VARCHAR(1024) ,
   $date LONG 
)"""
        try {
            db.execSQL(createTableSql)
        } catch (e: Exception) {
            Log.d("Task:Sql", e.message!!)
        }
    }
    companion object {
        var message_info = "message_info"
        var id = "id"
        var content = "content"
        var fileName = "fileName"
        var date = "date"
    }
}
```

æˆ‘ä»¬ä»ä¸Šè¿°æ ¸å¿ƒä»£ç ï¼Œå¯ä»¥çœ‹å‡ºSharingé¡¹ç›®ä¸»è¦é€šè¿‡SQLiteæä¾›çš„SQLiteDatabaseä»¥åŠSQLiteOpenHelperæ¥åˆ›å»ºæ•°æ®è¡¨ã€‚

ç›®å‰Sharingé¡¹ç›®ä»…æœ‰ä¸€ä¸ªè¡¨ä»¥åŠç®€å•çš„å‡ ä¸ªå­—æ®µï¼Œé€šè¿‡SQLæ‹¼å†™çš„æ–¹å¼çœ‹èµ·æ¥ä¹Ÿè¿˜å¥½ç»´æŠ¤ï¼Œä½†æ˜¯**å¦‚æœç°åœ¨é¢ä¸´çš„æ˜¯å‡ åä¸ªè¡¨ä»¥åŠå‡ ç™¾ä¸ªå­—æ®µï¼Œé‚£ä¹ˆç®¡ç†å’Œç»´æŠ¤è¿™äº›æ‹¼å†™çš„SQLå­—ç¬¦ä¸²å°±ä¼šéå¸¸å›°éš¾ï¼Œå½“æœ‰ä¿®æ”¹çš„æ—¶å€™ä¹Ÿéå¸¸å®¹æ˜“å‡ºé”™ã€‚**

æˆ‘ä»¬ç»§ç»­æ¥çœ‹æ•°æ®çš„ç¼“å­˜ä»¥åŠè¯»å–æ“ä½œã€‚

```plain
//è¿›è¡Œä¿¡æ¯ç¼“å­˜ä»¥åŠè¯»å–çš„ä»£ç 
class LocalDataSource constructor( private var mContext: Context) : IDataSource {
    override fun getMessageListFromCache(): MutableList<Message> {
        val messageList: MutableList<Message> = ArrayList()
        val dataBaseHelper = DataBaseHelper(mContext)
        val c = dataBaseHelper.writableDatabase.query(
            DataBaseHelper.Companion.message_info, null,null, null, null, null,null)
        if (c.moveToFirst()) { 
            for (i in 0 until c.count) {
                c.move(i) //ç§»åŠ¨åˆ°æŒ‡å®šè®°å½•
                val id = c.getInt(c.getColumnIndex(DataBaseHelper.Companion.id))
                val content = c.getString(c.getColumnIndex(DataBaseHelper.Companion.content))
                val fileName = c.getString(c.getColumnIndex(DataBaseHelper.Companion.fileName))
                val date = c.getLong(c.getColumnIndex(DataBaseHelper.Companion.date))
                messageList.add(Message(id, content, fileName, date))
            }
        }
        return messageList
    }
    override fun saveMessageToCache(messageList: List<Message>) {
        val dataBaseHelper = DataBaseHelper(mContext)
        if (messageList.isNotEmpty()) {
            dataBaseHelper.writableDatabase.delete(
                DataBaseHelper.Companion.message_info, null,null)
            for (message in messageList) {
                val cv = ContentValues()
                cv.put(DataBaseHelper.Companion.id, message.id)
                cv.put(DataBaseHelper.Companion.content, message.content)
                cv.put(DataBaseHelper.Companion.date, message.date)
                cv.put(DataBaseHelper.Companion.fileName, message.fileName)
                dataBaseHelper.writableDatabase.insert(
                    DataBaseHelper.Companion.message_info,null,cv)
            }
        }
    }
}
```

é€šè¿‡ä¸Šè¿°ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œ**å‡å°‘è™½ç„¶SQLiteæä¾›äº†queryä»¥åŠdeleteç­‰æ“ä½œæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å‡å°‘ç¼–å†™SQLå­—ç¬¦ä¸²ï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶éœ€è¦å»ç¼–å†™å¤§é‡çš„å¯¹è±¡è½¬æ¢ä»£ç ã€‚**

å…¶å®è¿™äº›ä»£ç éƒ½æ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„éä¸šåŠ¡çš„æ¨¡æ¿ä»£ç ï¼Œè¿™ä¼šå¤§å¤§å¢åŠ æˆ‘ä»¬ç»´æŠ¤ä»£ç çš„æˆæœ¬ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå®˜æ–¹ä¹Ÿæä¾›äº†æ–°çš„æ•°æ®åº“æ¡†æ¶ [Room](https://developer.android.com/training/data-storage/room?hl=zh_cn)ã€‚å®˜æ–¹æ–‡æ¡£å¼ºçƒˆå»ºè®®ä½¿ç”¨ Roomï¼Œè€Œä¸æ˜¯[ç›´æ¥ä½¿ç”¨ SQLite API](https://developer.android.com/training/data-storage/sqlite?hl=zh-cn)ã€‚

ä¸‹é¢æˆ‘ä»¬å°±ä¸€èµ·æ¥çœ‹çœ‹å¦‚ä½•å®‰å…¨åœ°å‡çº§Roomæ¡†æ¶ã€‚

## è¡¥å……è‡ªåŠ¨åŒ–å®ˆæŠ¤æµ‹è¯•

é¦–å…ˆç¬¬ä¸€æ­¥è¿˜æ˜¯éœ€è¦å…ˆåšåŸºæœ¬çš„è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–ï¼Œä½œä¸ºåç»­é‡æ„çš„å®‰å…¨å®ˆæŠ¤ç½‘ã€‚

è¿™é‡Œæˆ‘ä»¬ä¸»è¦é’ˆå¯¹LocalDataSource ç±»æ¥åšæµ‹è¯•ï¼Œä¿è¯åŸºæœ¬çš„æ•°æ®ç¼“å­˜ä»¥åŠè¯»å–åŠŸèƒ½æ˜¯æ­£ç¡®çš„ã€‚ç”¨ä¾‹è®¾è®¡æ˜¯è¿™æ ·çš„ã€‚

- æµ‹è¯•ç”¨ä¾‹1ï¼šå½“messageæ•°æ®è¡¨æ²¡æœ‰ç¼“å­˜æ•°æ®æ—¶ï¼Œè·å–çš„ç¼“å­˜æ•°æ®ä¸ºç©ºã€‚
- æµ‹è¯•ç”¨ä¾‹2ï¼šå½“messageæ•°æ®è¡¨ä¸­æœ‰ç¼“å­˜æ•°æ®æ—¶ï¼Œèƒ½å¤ŸæˆåŠŸè·å–ç¼“å­˜æ•°æ®ã€‚è¯»å–çš„ç¼“å­˜æ•°æ®å†…å®¹éœ€è¦ä¸ä¿æŒçš„ç¼“å­˜æ•°æ®å†…å®¹ä¸€è‡´ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦å°†æµ‹è¯•ç”¨ä¾‹è½¬æ¢æˆè‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹ã€‚

```plain
class LocalDataSourceTest {
    //ç”¨ä¾‹1
    @Test
    fun `should get message list is empty when database has not data`() = runBlocking {
        //given
        val localDataSource = LocalDataSource(ApplicationProvider.getApplicationContext())
        //when
        val messageListFromCache = localDataSource.getMessageListFromCache()
        //then
        assert(messageListFromCache.isEmpty())
    }
    //ç”¨ä¾‹2
    @Test
    fun `should get message list success when database has data`() = runBlocking {
        //given
        val localDataSource = LocalDataSource(ApplicationProvider.getApplicationContext())
        localDataSource.saveMessageToCache(getMockData())
        //when
        val messageListFromCache = localDataSource.getMessageListFromCache()
        //then
        val messageOne = messageListFromCache[0]
        Truth.assertThat(messageOne.id).isEqualTo(1)
        Truth.assertThat(messageOne.content).isEqualTo("å¼ ä¸‰å…±äº«æ–‡ä»¶åˆ°æ¶ˆæ¯ä¸­...")
        Truth.assertThat(messageOne.fileName).isEqualTo("å¤§å‹Androidé—ç•™ç³»ç»Ÿé‡æ„.pdf")
        Truth.assertThat(messageOne.formatDate).isEqualTo("2021-03-17 14:47:55")
        val messageTwo = messageListFromCache[1]
        Truth.assertThat(messageTwo.id).isEqualTo(2)
        Truth.assertThat(messageTwo.content).isEqualTo("æå››å…±äº«è§†é¢‘åˆ°æ¶ˆæ¯ä¸­â€¦â€¦")
        Truth.assertThat(messageTwo.fileName).isEqualTo("ä¿®æ”¹ä»£ç çš„è‰ºæœ¯.pdf")
        Truth.assertThat(messageTwo.formatDate).isEqualTo("2021-03-17 14:48:08")
    }
}
```

åé¢æ˜¯æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹çš„ç»“æœã€‚

![](https://static001.geekbang.org/resource/image/1b/63/1b5fd583635f8aed02c496cc44104663.jpg?wh=2748x1455)

## å°æ­¥å®‰å…¨é‡æ„

æœ‰äº†åŸºæœ¬çš„æµ‹è¯•å®ˆæŠ¤ä»¥åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å°æ­¥åœ°åšå®‰å…¨é‡æ„ï¼Œ**æ³¨æ„åœ¨è¿‡ç¨‹ä¸­æ¯å½“æˆ‘ä»¬å®Œæˆä¸€æ­¥é‡æ„åï¼Œéƒ½å¯ä»¥é¢‘ç¹è¿è¡Œæµ‹è¯•æ¥éªŒè¯æ˜¯å¦æœ‰ç ´ååŸæœ‰çš„é€»è¾‘ã€‚**

æ‹†åˆ†é‡æ„è¿‡ç¨‹çš„è¦æ±‚æ˜¯ï¼Œæ¯ä¸€å°æ­¥çš„é‡æ„éƒ½ä¸èƒ½ç ´åä¹‹å‰çš„åŠŸèƒ½ï¼Œè€Œä¸”å…¨éƒ¨æ­¥éª¤éƒ½å®Œæˆä¹‹åå³å¯å®Œæˆæ•´ä½“çš„é‡æ„ã€‚

è¿™é‡Œæˆ‘ä»¬ç»“åˆRoomæ¡†æ¶çš„è®¾è®¡ï¼ŒæŠŠæ•´ä¸ªé‡æ„åˆ†æˆä¸‹é¢è¿™5ä¸ªæ­¥éª¤ã€‚

ç¬¬ä¸€æ­¥æ˜¯ä½¿ç”¨Roomæ³¨è§£æ›´æ–°å®ä½“ã€‚

ç¬¬äºŒæ­¥æ˜¯ä½¿ç”¨Roomçš„SupportSQLiteOpenHelperè¿›è¡ŒSQLæ“ä½œã€‚è¿™2ä¸ªæ­¥éª¤å®Œæˆåï¼Œä¸ä¼šä¿®æ”¹åŸæœ‰çš„æŸ¥è¯¢åŠåˆ é™¤æ“ä½œä»£ç ã€‚

æ¥ä¸‹æ¥æ˜¯ç¬¬ä¸‰æ­¥ï¼Œè¿›é˜¶ä½¿ç”¨Roomçš„Daoæ³¨è§£æ–¹å¼æ¥ç®¡ç†æ•°æ®çš„å¢åˆ æ”¹æŸ¥ï¼Œæ›¿æ¢æ‰åŸæœ‰çš„æŸ¥è¯¢åŠåˆ é™¤ä»£ç ã€‚ç¬¬å››æ­¥æ˜¯ä¼˜åŒ–æ“ä½œï¼Œä½¿ç”¨åç¨‹æ¥ä¼˜åŒ–IOçš„å¼‚æ­¥æ“ä½œã€‚æœ€åæ˜¯ç¬¬äº”æ­¥ï¼Œè¿ç§»æ—§æ•°æ®ã€‚

**1. ä½¿ç”¨Roomæ³¨è§£æ›´æ–°å®ä½“**

é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ç¬¬ä¸€æ­¥ï¼Œè¿™ä¸€æ­¥ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œä½¿ç”¨Roomçš„æ³¨è§£æ ‡è®°æ–°çš„å®ä½“ä»£ç å°±å¯ä»¥äº†ã€‚

```plain
@Entity(tableName = "message_info")
class Message(
    @PrimaryKey @ColumnInfo(name = "id") var id: Int,
    @ColumnInfo(name = "content") var content: String,
    @ColumnInfo(name = "fileName") var fileName: String,
    @ColumnInfo(name = "date") var date: Long
) {
    @Ignore
    val formatDate = DateUtil.getDateToString(date)
    @Ignore
    val downloadCount = ARouter.getInstance().navigation(IFileStatistics::class.java)
        ?.getDownloadCount(id.toString())
}
```

**2. ä½¿ç”¨Roomçš„SupportSQLiteOpenHelperè¿›è¡ŒSQLæ“ä½œ**

Roomæä¾›äº†SupportSQLiteOpenHelperç±»ï¼Œå¯ä»¥ç”¨å®ƒæ›¿æ¢SQLiteä¸­çš„SQLiteOpenHelperï¼Œæˆ‘ä»¬å°†åŸæœ¬ä½¿ç”¨SQLiteOpenHelperçš„åœ°æ–¹æ›¿æ¢ä¸ºä½¿ç”¨Roomçš„SupportSQLiteOpenHelperã€‚

```plain
@Database(entities = [Message::class], version = 1)
abstract class AppDatabase : RoomDatabase() {
}

class LocalDataSource constructor(
    private var mContext: Context
) : IDataSource {
    val db = Room.databaseBuilder(
        mContext,
        AppDatabase::class.java, "message.db"
    ).build()
    
   override fun getMessageListFromCache(): MutableList<Message> {
    val messageList: MutableList<Message> = ArrayList()
    val dataBaseHelper = db.openHelper
    //... ...
    return messageList
  }

  override fun saveMessageToCache(messageList: List<Message>) {
    val dataBaseHelper = db.openHelper
     //... ...
    }
}
```

**3. ä½¿ç”¨Daoæ³¨è§£æ–¹å¼æ¥ç®¡ç†æ•°æ®çš„å¢åˆ æ”¹æŸ¥**

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©å°†queryåŠdeleteç­‰çš„æ“ä½œï¼Œä½¿ç”¨Roomçš„Daoæ³¨è§£åšæ›¿æ¢ã€‚

```plain
@Dao
interface MessageDao {
    @Query("SELECT * FROM message_info")
    suspend fun getAll(): List<Message>
    @Insert
    suspend fun insertAll(vararg message: Message)

    @Query("DELETE FROM message_info")
    suspend fun deleteAll()
}
```

å®Œæˆåï¼Œå°±å¯ä»¥å°†LocalDataSourceçš„å®ç°æ›¿æ¢ä¸ºä½¿ç”¨MessageDaoè¿›è¡Œæ“ä½œäº†ã€‚

```plain
class LocalDataSource constructor(
    private var mContext: Context
) : IDataSource {
    val db = Room.databaseBuilder(
        mContext,
        AppDatabase::class.java, "message.db"
    ).build()
    override suspend fun getMessageListFromCache(): MutableList<Message> {
        return db.messageDao().getAll().toMutableList()
    }
    override suspend fun saveMessageToCache(messageList: List<Message>) {
        messageList.let {
            db.messageDao().deleteAll()
            db.messageDao().insertAll(*it.toTypedArray())
        }
    }
}
```

è‡³æ­¤æˆ‘ä»¬å®Œæˆäº†Roomæ¡†æ¶çš„å‡çº§ï¼Œä½ å¯ä»¥å¯¹æ¯”ä¸€ä¸‹LocalDataSourceæ”¹é€ å‰åçš„ä»£ç ï¼Œ**ä½¿ç”¨Roomæ¡†æ¶å¤§å¤§å¸®æˆ‘ä»¬å‡å°‘äº†æ¨¡æ¿ä»£ç çš„ç¼–å†™ï¼Œä»£ç æ›´åŠ å®¹æ˜“ç»´æŠ¤ã€‚**

**4. æ•°æ®è¿ç§»**

å¦‚æœæˆ‘ä»¬å‡çº§æ•°æ®åº“æ¡†æ¶æ—¶ï¼Œè°ƒæ•´è¿‡è¡¨ç»“æ„çš„è¯ï¼Œè¿™æ—¶å°±å¯ä»¥ç”¨Roomæä¾›çš„Migrationæœºåˆ¶å‡çº§æ•°æ®ã€‚

ä¾‹å¦‚Sharingé¡¹ç›®åœ¨å‡çº§Roomæ¡†æ¶æ—¶ï¼Œæˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ªcountå­—æ®µç”¨äºç¼“å­˜æ–‡ä»¶çš„ä¸‹è½½æ•°é‡ï¼Œä½†æ˜¯åœ¨æ—§çš„æ•°æ®è¡¨ä¸­å¹¶æ²¡æœ‰è¿™ä¸ªå­—æ®µï¼Œè¿™æ—¶å°±å¯ä»¥ä½¿ç”¨Migrationæœºåˆ¶æ¥è¿ç§»å‡çº§æ•°æ®ã€‚

```plain
private val MIGRATION_1_2 = object : Migration(1, 2) {
    override fun migrate(database: SupportSQLiteDatabase) {
        database.execSQL("ALTER TABLE message_info RENAME TO message_info_back_up")
        database.execSQL("CREATE TABLE message_info ( id  INTEGER PRIMARY KEY NOT NULL, content TEXT NOT NULL,date INTEGER NOT NULL, count INTEGER NOT NUL)")
        database.execSQL("INSERT INTO message_info (id, content,dateï¼Œ0) SELECT id, content,date FROM message_info_back_up")
    }
}
private val db = Room.databaseBuilder(
    mContext,
    AppDatabase::class.java, "message.db"
).addMigrations(MIGRATION_1_2).build()
```

åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®æ•°æ®å¯¹ç”¨æˆ·çš„é‡è¦æ€§ï¼Œæ¥å†³å®šæ˜¯å¦è¦åšæ•°æ®çš„è¿ç§»ã€‚ä¾‹å¦‚ä¸€äº›ç¼“å­˜æ•°æ®åªæ˜¯æé«˜ç”¨æˆ·çš„ä½“éªŒï¼Œå“ªæ€•è¿™éƒ¨åˆ†æ•°æ®æ²¡æœ‰äº†ï¼Œä»ç½‘ç»œè·å–å®ƒä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œæˆ‘ä»¬å°±ä¸å¿…è¿ç§»æ•°æ®ã€‚

ä½†å¦‚æœå¯¹ç”¨æˆ·æ¥è¯´æ˜¯å…³é”®çš„æ•°æ®ï¼Œå°±å¿…é¡»è¿ç§»å’Œåšä¸“é¡¹çš„æµ‹è¯•ã€‚ä¾‹å¦‚ä¸€ä¸ªçŸ­ä¿¡æ¯çš„APPï¼ˆä¿¡æ¯åªç¼“å­˜åœ¨æœ¬åœ°ï¼‰ï¼Œå½“å‡çº§æ¡†æ¶åï¼Œè¿ç§»è¿™äº›çŸ­ä¿¡æ¯å°±éå¸¸é‡è¦ï¼Œå› ä¸ºè¿™éƒ¨åˆ†æ•°æ®ä¸¢å¤±çš„è¯ï¼Œå¯¹ç”¨æˆ·æ¥è¯´æ˜¯éå¸¸ç³Ÿç³•çš„ä½“éªŒã€‚æ›´å¤šè¿ç§»æ•°æ®çš„æ–¹æ³•ï¼Œä½ å¯ä»¥å‚è€ƒ[å®˜ç½‘çš„è¯´æ˜](https://developer.android.google.cn/training/data-storage/room/migrating-db-versions)ã€‚

## é›†æˆéªŒæ”¶

è·Ÿä¹‹å‰çš„ç»„ä»¶å†…åˆ†å±‚æ¶æ„é‡æ„ä¸€æ ·ï¼Œå®Œæˆé‡æ„åæˆ‘ä»¬éœ€è¦å®Œæˆæœ€åçš„é›†æˆéªŒæ”¶ã€‚

éªŒæ”¶æœ‰ä¸‰ä¸ªæ ‡å‡†ï¼šç¬¬ä¸€æ˜¯ç¼–è¯‘é€šè¿‡ï¼Œèƒ½å¤Ÿæ‰“åŒ…å‡ºå®‰è£…åŒ…ï¼›ç¬¬äºŒæ˜¯æ¶æ„å®ˆæŠ¤ç”¨ä¾‹æ‰§è¡Œé€šè¿‡ï¼›ç¬¬ä¸‰æ˜¯éªŒæ”¶è‡ªåŠ¨åŒ–æµ‹è¯•æ‰§è¡Œé€šè¿‡ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ”¹é€ åç›¸å…³çš„è‡ªåŠ¨åŒ–æµ‹è¯•è¿è¡Œç»“æœã€‚

åŸºæœ¬å†’çƒŸåŠæ¶æ„å®ˆæŠ¤ç”¨ä¾‹è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Šå¦‚ä¸‹ï¼š  
![](https://static001.geekbang.org/resource/image/08/68/0865058ae824d41ce3585802de45c868.jpg?wh=2748x1084)

æ¶ˆæ¯ç»„ä»¶è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Šå¦‚ä¸‹ï¼š  
![](https://static001.geekbang.org/resource/image/05/6a/05ea5579a087fcb7dcb66e0edce3026a.jpg?wh=2748x1084)  
è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†å¯¹Sharingé¡¹ç›®çš„æ•°æ®åº“æ¡†æ¶å‡çº§é‡æ„ã€‚

## æ€»ç»“

ä»Šå¤©æˆ‘ç»™ä½ è®²è§£äº†å¦‚ä½•å°æ­¥å®‰å…¨åœ°å‡çº§æ•°æ®åº“æ¡†æ¶ã€‚

æ”¹é€ å‰Sharingé¡¹ç›®ä½¿ç”¨äº†SQLiteæ¥ç®¡ç†æ•°æ®åº“ï¼Œè¿™ä¸ªæ–¹å¼ä¸»è¦å­˜åœ¨2ä¸ªé—®é¢˜ã€‚ç¬¬ä¸€ä¸ªæ˜¯ä½¿ç”¨æ‹¼å†™SQLæ–¹å¼æ¥ç®¡ç†è¡¨åˆ›å»ºï¼Œä¸ä¾¿äºæ‰©å±•ï¼›ç¬¬äºŒä¸ªæ˜¯å­˜åœ¨å¤§é‡çš„å¯¹è±¡è½¬æ¢é‡å¤ä»£ç ï¼Œä¸ä¾¿äºç»´æŠ¤ã€‚æ‰€ä»¥æˆ‘ä»¬æ ¹æ®å®˜æ–¹çš„å»ºè®®ï¼Œä½¿ç”¨Roomæ¡†æ¶æ¥å¸®æˆ‘ä»¬å®Œæˆè¿™äº›é‡å¤çš„å·¥ä½œï¼Œè®©æˆ‘ä»¬å¯ä»¥æ›´èšç„¦åœ¨ä¸šåŠ¡å¼€å‘ä¸Šã€‚

Roomæ¡†æ¶çš„å‡çº§å¯ä»¥åˆ†2ä¸ªé˜¶æ®µå®Œæˆã€‚

ç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯å…ˆå¼•å…¥ **Roomæ¡†æ¶**ï¼Œå°†åŸæœ¬ä½¿ç”¨SQLiteOpenHelperæ“ä½œæ•°æ®åº“çš„æ–¹å¼ï¼Œè°ƒæ•´ä¸ºä½¿ç”¨Roomæä¾›çš„SupportSQLiteOpenHelperæ¥è¿›è¡Œç®¡ç†ï¼Œæ­¤æ—¶ä¸ä¼šä¿®æ”¹åŸæœ‰çš„æŸ¥è¯¢åŠåˆ é™¤æ“ä½œä»£ç ã€‚

ç¬¬äºŒä¸ªé˜¶æ®µå¯ä»¥ä½¿ç”¨ **Roomæä¾›çš„Daoæ³¨è§£æ–¹å¼**ï¼Œæ›¿æ¢æ‰åŸæ¥çš„insertã€queryç­‰æ–¹æ³•ï¼Œå®Œæˆåå¯ä»¥å‡å°‘å¤§é‡çš„å¢åˆ æ”¹æŸ¥æ¨¡æ¿ä»£ç ã€‚æ­¤æ—¶ä½ å°±å¯ä»¥å……åˆ†æ„Ÿå—åˆ°ä½¿ç”¨æ¡†æ¶å¸¦æ¥çš„æ”¶ç›Šã€‚åŒæ ·å®Œæˆä¸€ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å°‘å†™å¾ˆå¤šæ¨¡æ¿çš„ä»£ç ã€‚

ç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**å¦‚æœåœ¨æ”¹é€ è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ•°æ®è¡¨ç»“æ„æœ‰å˜åŒ–ï¼Œæˆ‘ä»¬éœ€è¦é‡‡ç”¨Roomæ¡†æ¶æä¾›çš„Migrationæœºåˆ¶æ¥è¿ç§»æ•°æ®ã€‚**

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†ç¬¬ä¸‰ç¯‡è§£è€¦é‡æ„ç¯‡çš„å­¦ä¹ ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†è¿›å…¥ç¬¬å››ç¯‡æŒç»­äº¤ä»˜ç¯‡çš„å­¦ä¹ ï¼Œè®©æˆ‘ä»¬ä¸€èµ·å­¦ä¹ ç»„ä»¶åŒ–æ¶æ„æŒç»­äº¤ä»˜çš„æ ¸å¿ƒå®è·µï¼Œå¸®åŠ©æˆ‘ä»¬æ›´å¥½æé«˜ç‰ˆæœ¬å‘å¸ƒçš„æ•ˆç‡åŠè´¨é‡ï¼Œæ•¬è¯·æœŸå¾…ï¼

## æ€è€ƒé¢˜

æ„Ÿè°¢ä½ å­¦å®Œäº†ä»Šå¤©çš„å†…å®¹ï¼Œä»Šå¤©çš„æ€è€ƒé¢˜æ˜¯è¿™æ ·çš„ï¼šæ›¾ç»åœ¨ä¸€ä¸ªé¡¹ç›®ä¸Šæœ‰ä¸€ä¸ªåŒå­¦é—®æˆ‘è¯´æˆ‘ä»¬å›¢é˜Ÿå°±æƒ³ä½¿ç”¨SQLæ‹¼å†™çš„æ–¹å¼ï¼Œå› ä¸ºè¿™æ ·èƒ½åšåˆ°æœ€æç«¯çš„æ€§èƒ½ä¼˜åŒ–ï¼Œä½ æ€ä¹ˆçœ‹è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ

æ„Ÿè°¢ä½ å­¦å®Œäº†ä»Šå¤©çš„è¯¾ç¨‹ï¼Œæ¬¢è¿ä½ æŠŠå®ƒåˆ†äº«ç»™ä½ çš„åŒäº‹æˆ–æœ‹å‹ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¥é«˜æ•ˆé«˜è´¨é‡äº¤ä»˜è½¯ä»¶ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ2ï¼‰</strong></div><ul>
<li><span>peter</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯·æ•™è€å¸ˆä¸¤ä¸ªé—®é¢˜ï¼š
Q1ï¼šå±å¹•é€‚é…ä¸€èˆ¬æ€ä¹ˆåšï¼Ÿé‡‡ç”¨æ¡†æ¶ï¼Ÿå¦‚é‡‡ç”¨ï¼Œä»€ä¹ˆæ¡†æ¶å¥½ï¼Ÿè¿˜æ˜¯é€é¡µé¢æ¥åšï¼Ÿä¸é‡‡ç”¨æ¡†æ¶çš„è¯ï¼Œå¸ƒå±€æ—¶æ§ä»¶å®½é«˜éƒ½ç”¨weightï¼Œè·ç¦»ç”¨dpï¼Œå­—ä½“ç”¨spï¼Œè¿™æ ·å°±å¯ä»¥é€‚é…å—ï¼Ÿ
Q2ï¼šMessageDaoçš„å®šä¹‰ä¸­ï¼Œ@Insertåé¢ä¸ºä»€ä¹ˆæ²¡æœ‰SQLè¯­å¥ï¼Ÿå¦å¤–ï¼ŒDeleteå‡½æ•°çš„æ³¨è§£å†™çš„æ˜¯@Queryï¼Œåº”è¯¥æ˜¯ç¬”è¯¯å§ã€‚</p>2023-03-20</li><br/><li><span>AÄî„ é˜³ï½</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è€å¸ˆï¼Œå¯ä»¥è§£é‡Šä¸€ä¸‹æ€è€ƒé¢˜å—</p>2023-10-12</li><br/>
</ul>