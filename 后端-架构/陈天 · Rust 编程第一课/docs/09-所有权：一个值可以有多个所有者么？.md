ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚

ä¹‹å‰ä»‹ç»çš„å•ä¸€æ‰€æœ‰æƒè§„åˆ™ï¼Œèƒ½æ»¡è¶³æˆ‘ä»¬å¤§éƒ¨åˆ†åœºæ™¯ä¸­åˆ†é…å’Œä½¿ç”¨å†…å­˜çš„éœ€æ±‚ï¼Œè€Œä¸”åœ¨ç¼–è¯‘æ—¶ï¼Œé€šè¿‡ Rust å€Ÿç”¨æ£€æŸ¥å™¨å°±èƒ½å®Œæˆé™æ€æ£€æŸ¥ï¼Œä¸ä¼šå½±å“è¿è¡Œæ—¶æ•ˆç‡ã€‚

ä½†æ˜¯ï¼Œè§„åˆ™æ€»ä¼šæœ‰ä¾‹å¤–ï¼Œåœ¨æ—¥å¸¸å·¥ä½œä¸­æœ‰äº›ç‰¹æ®Šæƒ…å†µè¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ

- ä¸€ä¸ªæœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰ä¸­ï¼ŒæŸä¸ªèŠ‚ç‚¹å¯èƒ½æœ‰ä¸¤ä¸ªä»¥ä¸Šçš„èŠ‚ç‚¹æŒ‡å‘å®ƒï¼Œè¿™ä¸ªæŒ‰ç…§æ‰€æœ‰æƒæ¨¡å‹æ€ä¹ˆè¡¨è¿°ï¼Ÿ
- å¤šä¸ªçº¿ç¨‹è¦è®¿é—®åŒä¸€å—å…±äº«å†…å­˜ï¼Œæ€ä¹ˆåŠï¼Ÿ

æˆ‘ä»¬çŸ¥é“ï¼Œè¿™äº›é—®é¢˜åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æ‰ä¼šé‡åˆ°ï¼Œåœ¨ç¼–è¯‘æœŸï¼Œæ‰€æœ‰æƒçš„é™æ€æ£€æŸ¥æ— æ³•å¤„ç†å®ƒä»¬ï¼Œæ‰€ä»¥ä¸ºäº†æ›´å¥½çš„çµæ´»æ€§ï¼ŒRust æä¾›äº†**è¿è¡Œæ—¶çš„åŠ¨æ€æ£€æŸ¥**ï¼Œæ¥æ»¡è¶³ç‰¹æ®Šåœºæ™¯ä¸‹çš„éœ€æ±‚ã€‚

è¿™ä¹Ÿæ˜¯ Rust å¤„ç†å¾ˆå¤šé—®é¢˜çš„æ€è·¯ï¼šç¼–è¯‘æ—¶ï¼Œå¤„ç†å¤§éƒ¨åˆ†ä½¿ç”¨åœºæ™¯ï¼Œä¿è¯å®‰å…¨æ€§å’Œæ•ˆç‡ï¼›è¿è¡Œæ—¶ï¼Œå¤„ç†æ— æ³•åœ¨ç¼–è¯‘æ—¶å¤„ç†çš„åœºæ™¯ï¼Œä¼šç‰ºç‰²ä¸€éƒ¨åˆ†æ•ˆç‡ï¼Œæé«˜çµæ´»æ€§ã€‚åç»­è®²åˆ°é™æ€åˆ†å‘å’ŒåŠ¨æ€åˆ†å‘ä¹Ÿä¼šæœ‰ä½“ç°ï¼Œè¿™ä¸ªæ€è·¯å¾ˆå€¼å¾—æˆ‘ä»¬å€Ÿé‰´ã€‚

é‚£å…·ä½“å¦‚ä½•åœ¨è¿è¡Œæ—¶åšåŠ¨æ€æ£€æŸ¥å‘¢ï¼Ÿè¿è¡Œæ—¶çš„åŠ¨æ€æ£€æŸ¥åˆå¦‚ä½•ä¸ç¼–è¯‘æ—¶çš„é™æ€æ£€æŸ¥è‡ªæ´½å‘¢ï¼Ÿ

Rust çš„ç­”æ¡ˆæ˜¯ä½¿ç”¨å¼•ç”¨è®¡æ•°çš„æ™ºèƒ½æŒ‡é’ˆï¼š**Rcï¼ˆReference counterï¼‰ å’Œ Arcï¼ˆAtomic reference counterï¼‰**ã€‚è¿™é‡Œè¦ç‰¹åˆ«è¯´æ˜ä¸€ä¸‹ï¼ŒArc å’Œ ObjC/Swift é‡Œçš„ ARCï¼ˆAutomatic Reference Countingï¼‰ä¸æ˜¯ä¸€ä¸ªæ„æ€ï¼Œä¸è¿‡å®ƒä»¬è§£å†³é—®é¢˜çš„æ‰‹æ®µç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°å®Œæˆçš„ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ30ï¼‰</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/5a/09/afa3e112.jpg" width="30px"><span>æ¸…é£å¾æ¥</span> ğŸ‘ï¼ˆ14ï¼‰ ğŸ’¬ï¼ˆ6ï¼‰<div>è€å¸ˆé—®ä¸€ä¸ªé¢å¤–çš„é—®é¢˜
ä»¥anyhowã€clapåº“ä¸ºä¾‹ï¼Œé€šç¯‡çœ‹rustæŠ€æœ¯æ–‡æ¡£æœ‰ä¸€ç§å¾ˆè’™è”½çš„æ„Ÿè§‰ï¼Œæ„Ÿè§‰æ–‡æ¡£åªæ˜¯æŠŠæŠ€æœ¯ç‚¹æ‹†çš„å¾ˆé›¶ç¢è¿›è¡Œè¯´æ˜ï¼ˆå¦‚ï¼šæœ‰å“ªäº›structã€traitç­‰ï¼‰ï¼Œå¤–åŠ ä¸€ä¸ªæ²¡æœ‰å®è´¨æ€§å¸®åŠ©çš„ä¸ºä¾‹æ–‡æ¡£ä»£ç ï¼Œæ„Ÿè§‰å’Œå…¶ä»–è¯­è¨€çš„æŠ€æœ¯æ–‡æ¡£å¾ˆä¸ä¸€æ ·ï¼›ä¸€å¥è¯æ¥è¯´æ˜ï¼šæ–‡æ¡£æè¿°æ‹†çš„å¾ˆé›¶ç¢ï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªæ¸…æ™°åœ°æ•´ä½“çš„ç»Ÿä¸€ä½¿ç”¨è¯´æ˜ï¼Œè‡´ä½¿æ— ä»ä¸‹æ‰‹ï¼›è¿™ä¸ªé—®é¢˜å¦‚ä½•è§£å†³ï¼Ÿï¼Ÿï¼Ÿ</div>2022-03-18</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/3XbCueYYVWTiclv8T5tFpwiblOxLphvSZxL4ujMdqVMibZnOiaFK2C5nKRGv407iaAsrI0CDICYVQJtiaITzkjfjbvrQ/132" width="30px"><span>æœ‰é“­</span> ğŸ‘ï¼ˆ69ï¼‰ ğŸ’¬ï¼ˆ7ï¼‰<div>ä»Šå¤©è¿™ç« æˆ‘çœ‹å®Œä»¥åæ„Ÿè§‰æœ‰ä¸€è‚¡éå¸¸é—æ†¾çš„æƒ…ç»ªï¼š
æˆ‘åŸæœ¬ä»¥ä¸ºrustçœŸçš„ç”¨ç¼–è¯‘æ—¶æ£€æŸ¥è§£å†³äº†å½“å¹´C++é¢ä¸´çš„é‚£äº›é—®é¢˜ã€‚ç»“æœæœ€åè¿˜æ˜¯å¦¥åæ’•å¼€äº†ä¸€é“å£å­å¼€äº†åé—¨ï¼Œè€Œä¸”è¿™ä¸ªåé—¨å¼€çš„å¾ˆå¤æ‚ï¼Œæˆ‘çš„æ„Ÿè§‰ï¼Œè¿™ä¸ªç‰¹æ€§ï¼Œå°†æ¥è¦ä¹ˆå°±æ˜¯æ²¡ä»€ä¹ˆäººç”¨ï¼Œè¦ä¹ˆå°±æ˜¯è¢«äººæ»¥ç”¨ã€‚è¿™ä¸ªä¸œè¥¿å¯¹äººçš„è‡ªæ§è¦æ±‚å¤ªé«˜äº†</div>2021-09-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/54/c6/c2481790.jpg" width="30px"><span>lisiur</span> ğŸ‘ï¼ˆ39ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>è€å¸ˆæ‚¨å¥½ï¼Œåœ¨ä»£ç 3é‡Œï¼ŒæŠŠå†…éƒ¨ä½œç”¨åŸŸå»æ‰ä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨æ™®é€šçš„å€Ÿç”¨æ–¹å¼åƒè¿™æ ·ï¼š

```rust
fn main() {
    let mut data = 1;
    let v = &amp;mut data;
    *v += 1;
    println!(&quot;data: {:?}&quot;, &amp;data);
}
```

å´ä¸éœ€è¦ä½¿ç”¨å¤šä½™çš„ä½œç”¨åŸŸã€‚

æˆ‘çš„ç†è§£æ˜¯æ™®é€šçš„å€Ÿç”¨æ–¹å¼èµ°çš„æ˜¯ç¼–è¯‘æœŸæ£€æŸ¥ï¼Œç¼–è¯‘å™¨æ ‡è®°å€Ÿç”¨çš„ç”Ÿå‘½æœŸçš„ç²’åº¦æ¯”ä½œç”¨åŸŸè¦å°ï¼Œæ¯”å¦‚ä¸Šè¿°ä»£ç çš„ mut å€Ÿç”¨ï¼Œæ­£å¸¸çš„ç”Ÿå‘½æœŸåº”è¯¥æ˜¯åˆ°mainå‡½æ•°ç»“æŸï¼Œä½†æ˜¯ç¼–è¯‘å™¨åº”è¯¥æ˜¯æŠŠå®ƒç¼©å°åˆ°äº† println ä»£ç ä¹‹å‰çš„ä½ç½®ï¼Œæ‰€ä»¥ println çš„ä¸å¯å˜å€Ÿç”¨å¹¶ä¸å’Œä¸Šé¢çš„å¯å˜å€Ÿç”¨å†²çªã€‚ä½†æ˜¯è¿è¡Œæ—¶çš„&quot;ç”Ÿå‘½æœŸæ£€æŸ¥&quot;åº”è¯¥å°±æ˜¯ä½œç”¨åŸŸç²’åº¦çš„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨é¢å¤–çš„ä½œç”¨åŸŸæ¥è¾¾åˆ°æ‰‹åŠ¨ drop å¯å˜å€Ÿç”¨çš„æ•ˆæœã€‚

æˆ‘çš„æƒ³æ³•æ˜¯ï¼Œæ—¢ç„¶ç¼–è¯‘æœŸèƒ½å¤Ÿåšåˆ°å°½å¯èƒ½å°çš„ç¼©å°å€Ÿç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œé‚£ç¼–è¯‘å™¨èƒ½ä¸èƒ½è‡ªåŠ¨å¯¹è¿™ç§ç‰¹æ®Šçš„å†…éƒ¨å¯å˜æ€§çš„å€Ÿç”¨åœ¨åˆé€‚çš„ä½ç½®æ’å…¥dropä»£ç ï¼Œä½¿å¾—ä¸ä½¿ç”¨é¢å¤–çš„ä½œç”¨åŸŸä¹Ÿèƒ½æ»¡è¶³è¿è¡Œæ—¶æ£€æŸ¥å‘¢ï¼Ÿ</div>2021-09-10</li><br/><li><img src="" width="30px"><span>åƒå›ç™¾è½¬æ— åŠ«å±±</span> ğŸ‘ï¼ˆ37ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>1. é”™è¯¯ä¸ºçº¿ç¨‹å€Ÿç”¨çš„arrç”Ÿå‘½å‘¨æœŸå¯èƒ½ä¼šé•¿äºmainå‡½æ•°ä¸­çš„arrï¼Œç®€å•å¤„ç†çš„è¯æŠŠmainä¸­arrçš„æ‰€æœ‰æƒmoveåˆ°çº¿ç¨‹é‡Œå³å¯ï¼Œç¼–è¯‘å™¨å¯¹æ­¤æœ‰è¯¦å°½çš„æç¤ºï¼š
```rust
fn main() {
    let arr = vec![1];

    std::thread::spawn(move || {
        println!(&quot;{:?}&quot;, arr);
    });
}
```
2. è¿™ä¸ªé—®é¢˜å…¶å®æ˜¯ç¬¬1ä¸ªé—®é¢˜çš„å»¶ç»­ï¼Œå¦‚æœå°†mainä¸­å˜é‡çš„æ‰€æœ‰æƒmoveåˆ°çº¿ç¨‹ä¸­ï¼Œé‚£ä¹ˆåœ¨mainä¸­å°†æ— æ³•è®¿é—®ï¼Œæ‰€ä»¥ä½¿ç”¨Arcè¿™ä¸ªæ™ºèƒ½æŒ‡é’ˆå³å¯å®ç°å…±äº«æ‰€æœ‰æƒï¼š
```rust
use std::sync::Arc;
fn main() {
    let s = Arc::new(&quot;rust rocks!&quot;);
    let s1 = s.clone();

    let handler = std::thread::spawn(move || {
        println!(&quot;thread: {:?}&quot;, s1);
    });
    println!(&quot;main: {:?}&quot;, s);
    handler.join().unwrap();
}
```
3. ä¸å¤ªç¡®å®šï¼ŒæŸ¥æ–‡æ¡£çœ‹è°ƒç”¨é“¾æ˜¯inneræ–¹æ³•è¿”å›äº†RcBoxï¼ŒRcBoxè°ƒç”¨çš„inc_strongæ˜¯RcInnerPtrè¿™ä¸ªtraitçš„æ–¹æ³•ï¼Œå®ƒä¼šé€šè¿‡è°ƒç”¨è¯¥traitçš„strong_refæ–¹æ³•è¿”å›cellï¼Œè€Œcellæ˜¯ä¸€ä¸ªå¯å˜çš„å…±äº«å®¹å™¨ï¼Œå³æœ€ç»ˆé€šè¿‡cellå…±äº«å†…å­˜æ¥æ”¹å˜å†…éƒ¨æ•°æ®ã€‚

çœ‹å®Œè¿™ä¸€å°èŠ‚äº§ç”Ÿä¸€ä¸ªç–‘é—®ï¼Œæœ¬å°èŠ‚ä»‹ç»çš„æ™ºèƒ½æŒ‡é’ˆéƒ½æ˜¯ä¸ºäº†çªç ´rustç¼–è¯‘æœŸçš„æ‰€æœ‰æƒè§„åˆ™é™åˆ¶ã€‚é‚£ä¸ºä»€ä¹ˆè¦å…ˆåšé™åˆ¶å†æä¾›çªç ´é™åˆ¶çš„æ–¹æ³•å‘¢ï¼Ÿè¿™æ ·åšçš„æ„ä¹‰æ˜¯å¦å¯ä»¥ç†è§£ä¸ºå°±åƒunsafeæˆ–è€…æœ€å°æƒé™åŸåˆ™ä¸€æ ·ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œéµå¾ªæ‰€æœ‰æƒè§„åˆ™ï¼Œä»…åœ¨å¿…è¦çš„æ—¶å€™ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆæ¥çªç ´é™åˆ¶ï¼Ÿå¦‚æœç”¨æˆ·æ»¥ç”¨äº†æ™ºèƒ½æŒ‡é’ˆï¼Œé‚£ä¹ˆæ˜¯å¦å°±åƒæ»¥ç”¨äº†unsafeä¸€æ ·ï¼Œrustå†…å­˜å®‰å…¨ç­‰ç‰¹æ€§å°±æ— æ³•ä¿è¯äº†ï¼Ÿ</div>2021-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/94/bb/1c8384a0.jpg" width="30px"><span>dotfiles</span> ğŸ‘ï¼ˆ17ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>1. rustç”±äºæ‰€æœ‰æƒä»¥åŠé»˜è®¤ä¸å¯å˜ç­‰é™åˆ¶,å¯¼è‡´æœ€å¸¸è§çš„æ•°æ®ç»“æ„---é“¾è¡¨çš„å®ç°å˜å¾—ç›¸å½“å¤æ‚,å¸¸è§çš„å®ç°ä½¿ç”¨äº†3å±‚ç»“æ„ä½“.
Option&lt;&gt;æä¾›ç©ºå’Œéç©º,ç›¸å…³: Some&#47;None
Rc&lt;T&gt;æä¾›å¼•ç”¨è®¡æ•°,ç›¸å…³: New&#47;clone; å¦‚æœä¸ºäº†é¿å…å¾ªç¯å¼•ç”¨,è¿˜è¦è€ƒè™‘downgrade&#47;upgrade; è¿™å—å’Œcppçš„shared_ptr&#47;weak_ptrç±»ä¼¼.
RefCell&lt;T&gt;æä¾›å†…éƒ¨å¯å˜æ€§,åŸºäºunsafeæœºåˆ¶,æä¾›è¿è¡Œæ—¶æ£€æŸ¥. ç›¸å…³: borrow&#47;borrow_mut

2. å†…éƒ¨å¯å˜æ€§
Rcçš„å¼•ç”¨è®¡æ•°å™¨å’ŒRefCellä¸­çš„æ•°æ®å¯å˜,éƒ½æ˜¯åŸºäºunsafeå®ç°çš„.
æˆ‘ä»¬ä»¥Rcå¼•ç”¨è®¡æ•°å™¨çš„æ›´æ–°ä¸ºä¾‹:
```
impl&lt;T&gt; Cell&lt;T&gt; {
    pub fn replace(&amp;self, val: T) -&gt; T {
        mem::replace(unsafe { &amp;mut *self.value.get() }, val)
    }
}
```
å¦‚ä¸Šå¯ä»¥çœ‹åˆ°,å³ä½¿replaceçš„å‚æ•°selfæ˜¯ä¸å¯å˜çš„,ä¹Ÿå¯ä»¥é€šè¿‡unsafeå»æ”¹å˜å…¶ä¸­çš„å€¼.ä¹Ÿå°±æ˜¯è¯´rusté€šè¿‡unsafeå…·æœ‰å®Œå…¨çš„c&#47;c++ç±»ä¼¼çš„èƒ½åŠ›.
åŒç†,å¯ä»¥çœ‹åˆ°Refcellè·å–å¯å˜å¼•ç”¨,ä¹Ÿæ˜¯é€šè¿‡unsafeå°†æŒ‡é’ˆç›´æ¥è½¬æˆå¯å˜å¼•ç”¨.å¯ä»¥æƒ³è±¡çš„æ˜¯,åœ¨RefCellä¸­,è¿˜éœ€è¦é€šè¿‡é¢å¤–çš„ä»£ç æ¥å¤„ç†å¯è¯»ä¸å¯å†™,å¯å†™ä¸å¯è¯»çš„ç±»ä¼¼è¯»å†™é”çš„é—®é¢˜.
```
impl&lt;T: ?Sized&gt; RefCell&lt;T&gt; {
    pub fn try_borrow_mut(&amp;self) -&gt; Result&lt;RefMut&lt;&#39;_, T&gt;, BorrowMutError&gt; {
                ...
                Ok(RefMut { value: unsafe { &amp;mut *self.value.get() }, borrow: b })
                ...
}
```
åœ¨rustçš„è®¾è®¡ä¸­,æ˜æ˜¾æ¨å´‡å°†é—®é¢˜å°½é‡åœ¨é™æ€ç¼–è¯‘æœŸè§£å†³.å®åœ¨æä¸å®šçš„,å°±æ˜¯é€šè¿‡unsafeå’Œé¢å¤–çš„å¤„ç†æ¨è¿Ÿåˆ°è¿è¡ŒæœŸè§£å†³.</div>2021-10-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/bc/2c/963688bb.jpg" width="30px"><span>noisyes</span> ğŸ‘ï¼ˆ10ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>fn main() {
    &#47;*let data = RefCell::new(1);

    let mut v = data.borrow_mut();
    *v += 1;

    println!(&quot;data: {:?}&quot;, data.borrow());
    *&#47;
    let mut v = vec![1, 2, 3];
    let data1 = &amp;mut v[1];
    *data1 = 2;
    let data2 = &amp;v[1];
    println!(&quot;{}&quot;, data2);
}

è€å¸ˆè¿™æ®µä»£ç æ³¨é‡Šçš„éƒ¨åˆ†ï¼Œè¿è¡Œæ—¶ä¸èƒ½é€šè¿‡ï¼Œå¯å˜å€Ÿç”¨å’Œä¸å¯å˜å€Ÿç”¨å¹¶æ²¡æœ‰å†²çªå‘€ï¼ˆvå¹¶æ²¡åœ¨borrowä¹‹åä½¿ç”¨ï¼ŒåŒä¸€æ—¶åˆ»å¹¶æ²¡æœ‰åŒæ—¶æœ‰å¯å˜å€Ÿç”¨å’Œä¸å¯å˜å€Ÿç”¨ï¼‰ï¼Œæˆ‘è‡ªå·±å†™çš„è¿™éƒ¨åˆ†å°±æ˜¯å¯ä»¥ç¼–è¯‘è¿è¡Œçš„ã€‚</div>2021-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg" width="30px"><span>Marvichov</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>ä¸ºå•¥è¦week == 0çš„æ—¶å€™æ‰deallocateæ‰€æœ‰å†…å­˜å‘¢? è¿™æ ·æ˜¯ä¸æ˜¯ä¸å¤ªé«˜æ•ˆ?

```
fn drop(&amp;mut self) {
    unsafe {
        self.inner().dec_strong();
        if self.inner().strong() == 0 {
            &#47;&#47; destroy the contained object
            ptr::drop_in_place(Self::get_mut_unchecked(self));

            &#47;&#47; remove the implicit &quot;strong weak&quot; pointer now that we&#39;ve
            &#47;&#47; destroyed the contents.
            self.inner().dec_weak();

            if self.inner().weak() == 0 {
                Global.deallocate(self.ptr.cast(), Layout::for_value(self.ptr.as_ref()));
            }
        }
    }
}
```</div>2021-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/29/ca/fd/4e6dd31c.jpg" width="30px"><span>æ¸æçº¢èŒ¶</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>1. çº¿ç¨‹çš„è¿è¡Œæ—¶é—´å¯èƒ½ä¼šæ¯”å½“å‰å‡½æ•°è¿˜è¦é•¿ï¼Œè€Œé—­åŒ…ä¸­åˆå€Ÿç”¨äº†arrï¼Œä½¿ç”¨moveå°†å½“å‰å‡½æ•°çš„arræ‰€æœ‰æƒè½¬ç§»ç»™çº¿ç¨‹ã€‚
```
use std::thread;

fn main() {
    let arr = vec![1];

    let handler = thread::spawn(move || {
        println!(&quot;{:?}&quot;, arr);
    });
    handler.join().unwrap();
}
```
2. 
```
use std::thread;
use std::sync::Arc;

fn main() {
    let five = Arc::new(&quot;hello Tyr&quot;);

    {
        let give_me_five = five.clone();
        let handler = thread::spawn(move || {
            println!(&quot;thread greeting: {:?}&quot;, give_me_five);
        });
        handler.join().unwrap();
    }
    println!(&quot;main greeting: {:?}&quot;, five);
}
```
3. Rcæºç ä¸­æœ‰è¿™ä¹ˆä¸€æ®µï¼Œ
```
#[doc(hidden)]
trait RcInnerPtr {
    fn weak_ref(&amp;self) -&gt; &amp;Cell&lt;usize&gt;;
    fn strong_ref(&amp;self) -&gt; &amp;Cell&lt;usize&gt;;

    #[inline]
    fn strong(&amp;self) -&gt; usize {
        self.strong_ref().get()
    }

    #[inline]
    fn inc_strong(&amp;self) {
        let strong = self.strong();

        &#47;&#47; We want to abort on overflow instead of dropping the value.
        &#47;&#47; The reference count will never be zero when this is called;
        &#47;&#47; nevertheless, we insert an abort here to hint LLVM at
        &#47;&#47; an otherwise missed optimization.
        if strong == 0 || strong == usize::MAX {
            abort();
        }
        self.strong_ref().set(strong + 1);
    }
    ...
}
```
å¢åŠ è®¡æ•°å™¨```self.inner().inc_strong();```è°ƒç”¨çš„```inc_strong```å‡½æ•°ä¿®æ”¹çš„æ˜¯```strong_ref()```ï¼Œå±äºCellç±»å‹ï¼ŒShareable mutable containersï¼Œå¯å…±äº«å¯ä¿®æ”¹çš„å®¹å™¨ã€‚</div>2021-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1f/74/d4/38d813f0.jpg" width="30px"><span>Kerry</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>è¯¾åæ€è€ƒé¢˜ï¼š

1. ç”Ÿå‘½å‘¨æœŸé—®é¢˜ï¼Œä¸»çº¿ç¨‹å¯èƒ½æ¯”æ´¾ç”Ÿçº¿ç¨‹æ›´æ—©ç»“æŸï¼Œå¯¼è‡´æ´¾ç”Ÿçº¿ç¨‹å¼•ç”¨äº†è¿‡æœŸçš„å€¼ã€‚

ä½ ä¹Ÿè®¸ä¼šæƒ³åˆ°åŠ ä¸Šjoinå¼ºåˆ¶æ´¾ç”Ÿçº¿ç¨‹å…ˆäºä¸»çº¿ç¨‹ç»“æŸï¼Œä»¥æ­¤è§£å†³ç¼–è¯‘é—®é¢˜ã€‚ç„¶è€Œè¿™æ˜¯è¡Œä¸é€šçš„ã€‚è¿™é‡Œçš„é—®é¢˜æ˜¯è¯­æ³•å±‚é¢çš„ï¼Œè€Œä¸æ˜¯è¯­ä¹‰å±‚é¢çš„ã€‚

è§£å†³æ–¹æ³•æœ‰ä¸¤ç§ï¼šä¸€æ˜¯moveï¼ŒäºŒæ˜¯ç”¨ARCã€‚æ–¹æ³•ä¸€çš„ä»£ç å¦‚ä¸‹ï¼š

fn main() {
    let arr = vec![1];

    std::thread::spawn(move || {
        println!(&quot;{:?}&quot;, arr);
    }).join().unwrap();
}

æ–¹æ³•äºŒå‚è€ƒæ€è€ƒé¢˜2å³å¯ã€‚

2. å¦‚ä¸‹æ‰€ç¤ºï¼Œç”¨ARCåŒ…ä¸€ä¸‹è¦å…±äº«çš„èµ„æºï¼š

use std::sync::{Arc, RwLock};
use std::rc::Rc;

fn main() {
    let s = Arc::new(RwLock::new(&quot;Hello&quot;));

    let r = s.clone();
    std::thread::spawn(move || {
        println!(&quot;{:?}&quot;, r.as_ref().read().unwrap());
    }).join().unwrap();

    println!(&quot;{:?}&quot;, s.as_ref().read().unwrap());
}

3. æ˜¯æ—¶å€™æ­¥å…¥unsafeçš„ä¸–ç•Œäº†~ç¼–è¯‘å™¨ç»ˆç©¶åªæ˜¯å¸®æˆ‘ä»¬å¹²æ´»ï¼Œè§„åˆ™å†ä¸¥æ ¼ï¼Œé‚£éƒ½æ˜¯æ­»çš„ã€‚ä¸ºäº†æä¾›ä¸€å®šçµæ´»æ€§ï¼Œä¼šåƒRefCellè¿™æ ·æä¾›ä¸€äº›æœºåˆ¶ç»™æˆ‘ä»¬åšä¸€äº›ä¸å®‰å…¨çš„æ“ä½œã€‚é€šè¿‡é˜…è¯»self.inner().inc_strong()çš„æºç ï¼Œå¯ä»¥çŸ¥é“åº•å±‚æ˜¯é€šè¿‡unsafeå®ç°ä¸å¯å˜è½¬å¯å˜å¼•ç”¨çš„ï¼š

unsafe { &amp;mut *self.value.get() }


</div>2021-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1b/38/c9/63ea8fe6.jpg" width="30px"><span>Arthur</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆå¥½ï¼Œå…³äºä½¿ç”¨èŠ±æ‹¬å·æå‰ç»“æŸç”Ÿå‘½å‘¨æœŸè¿™ç‚¹æœ‰ä¸€ç‚¹ä¸æ˜ç™½
```rust
fn main() {
    let mut v = vec![1, 2, 3];
    {
        v            &#47;&#47; ç¼–è¯‘ä¸é€šè¿‡
        v.push(3); &#47;&#47;ç¼–è¯‘é€šè¿‡
    };
    v.push(4);
}
```
èŠ±æ‹¬å·ä¸­çš„ä¸¤ç§å†™æ³•ï¼Œä¸€ç§ä¸é€šè¿‡ï¼ŒæŠ¥é”™error[E0382]: borrow of moved value: `v`ï¼›ä¸€ç§åˆå¯ä»¥é€šè¿‡ï¼Œæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä½¿ç”¨ä¸€ä¸ªèŠ±æ‹¬å·å¢åŠ äº†ä¸€ä¸ªä½œç”¨åŸŸä»¥åï¼Œå¯¹äºä½œç”¨åŸŸå†…ä½¿ç”¨çš„å¤–éƒ¨å˜é‡çš„æ‰€æœ‰æƒåˆ°åº•äº§ç”Ÿäº†æ€æ ·çš„å½±å“å‘¢ï¼Ÿ</div>2021-09-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/08/e1/b4748943.jpg" width="30px"><span>å¤æ´›å…‹Moriaty</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>ç»ˆäºç†è§£äº†Rcçš„æœ¬è´¨äº†ï¼Œä»¥å‰åªæ˜¯çŸ¥é“å®ç°äºŒå‰æ ‘è¿™ç§æ•°æ®ç»“æ„å¿…é¡»ç”¨Rcï¼Œå› ä¸ºä»–å…è®¸æœ‰å¤šä¸ªæ‰€æœ‰è€…ã€‚ä½†æ˜¯ä¸ç†è§£æˆ–è€…è¯´ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦æœ‰å†…éƒ¨å¯å˜æ€§å’Œè¿è¡Œæ—¶æ£€æŸ¥è¿™ä¸ªä¸œè¥¿ï¼Œä»Šå¤©çœ‹äº†Box::leak() æœºåˆ¶çš„è§£é‡Šç»ˆäºæ˜ç™½äº†ã€‚</div>2021-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/26/bc/2c/963688bb.jpg" width="30px"><span>noisyes</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æ€è€ƒé¢˜ï¼š
1. fn main() {
    let arr = vec![1];
    let handler = std::thread::spawn(move || {
        println!(&quot;{:?}&quot;, arr);
    });
    handler.join().unwrap();
}

2. fn main() {
    let ss = Arc::new(String::from(&quot;hello world&quot;));
    let ss1 = ss.clone();
    let handler = std::thread::spawn(move || {
        println!(&quot;{}&quot;, ss1);
    });
    println!(&quot;{}&quot;, ss);
    handler.join().unwrap();
}

3. è¿˜æ²¡çœ‹æºç  åº”è¯¥å°±æ˜¯å†…éƒ¨å¯å˜æ€§å§</div>2021-09-10</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/ajNVdqHZLLDoDeeNST87MZEdfT8n7yEWp06KsFCTs2ssFh2tbHu413nibrRObOia1Zn9pqiaHgIicVkSHRZM3LHOEA/132" width="30px"><span>è‘¡è„</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>3. Rcç±»åˆ›å»º
Box::leak(box RcBox { strong: Cell::new(1), weak: Cell::new(1), value })
self.inner().inc_strong()
è·å¾—äº†Rcé‡Œ strong, ä¹Ÿå°±æ˜¯Cellå¯¹è±¡ï¼ŒCellæ˜¯å†…éƒ¨å¯å˜çš„ï¼Œä½¿ç”¨setæ–¹æ³•è¿›è¡Œä¿®æ”¹ã€‚
fn inc_strong(&amp;self) {
        let strong = self.strong();
        self.strong_ref().set(strong + 1);
    }</div>2021-09-10</li><br/><li><img src="" width="30px"><span>chyuwei</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ä¸ªäººæ„Ÿè§‰å°±æ˜¯ æ‰€æœ‰æƒå¯¼è‡´ä¸èƒ½å‡ºç°å¤šä¸ªå¯å˜å¼•ç”¨ï¼Œ 
å€Ÿé‰´äº†å¤šçº¿ç¨‹é‡Œé¢çš„mutexï¼Œæ‰€ä»¥æœ‰äº†è¿™ä¸ªæ‰€è°“çš„å†…éƒ¨å¯å˜æ€§ã€‚
å¯¹äºmutexï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥ä¿è¯ç‹¬å æ€§ï¼Œ
å¯¹äºrefcellåº”è¯¥å°±æ˜¯åº“ä»£ç å»ä¿è¯ã€‚

è‡³äºæœ‰äº›åŒå­¦è¯´æ’•å£å­è¿™ä¸ªäº‹ï¼Œ safe rustå¯ä»¥å†™ç»å¤§å¤šæ•°ç¨‹åºäº†ã€‚
å½“ä½ ä¸å¾—ä¸å»æ’•å£å­ï¼Œå†™unsafeæ—¶ï¼Œå…¶å®å’Œc++å°±æ²¡ä»€ä¹ˆåŒºåˆ«äº†</div>2022-01-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/1d/c0/978fc470.jpg" width="30px"><span>dch666</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>åœ¨ä»£ç 1ä¸­ï¼Œæˆ‘æŠŠ self.downstream.as_ref().map(|v| v.clone()) æ”¹æˆäº† self.downstream.clone() çœ‹åˆ° print è¾“å‡ºç»“æœæ˜¯ä¸€æ ·çš„ï¼Œæƒ³é—®ä¸‹è¿™ä¸¤ç§å†™æ³•æœ‰åŒºåˆ«å—ï¼Ÿ</div>2021-11-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/51/22/d12f7a72.jpg" width="30px"><span>TheLudlows</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>é™ˆå¤©è€å¸ˆéº»çƒ¦é—®ä¸‹ä¸ºä»€ä¹ˆä¸‹é¢è¿™æ®µå¯ä»¥ç¼–è¯‘
```rust
fn main() {
    let mut data = 1;
    let p = &amp;mut data;
    *p += 2;
    println!(&quot;data: {:?}&quot;, &amp;data);
}
```
è€Œä¾‹å­ä¸­çš„è¿™æ®µä¸èƒ½ç¼–è¯‘å‘¢
use std::cell::RefCell;

fn main() {
    let data = RefCell::new(1);
    
    let mut v = data.borrow_mut();
    *v += 1;
    
    println!(&quot;data: {:?}&quot;, data.borrow());
}</div>2021-11-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg" width="30px"><span>æ ¸æ¡ƒ</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ä»£ç 1å’Œ4ä¸­ç•™æ„ä¸€ä¸‹struct å’Œimpléƒ½æ˜¯Nodeï¼Œè¿™æ ·çš„å†™æ³•çœ‹èµ·æ¥æ¯”è¾ƒç®€æ´ã€‚
å¦å¤–ä»£ç ä¸­æœ‰ä¸€å¥
self.downstream.as_ref().map(|v| v.clone())
è¿™é‡Œçš„mapè¯­æ³•æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿæ²¡å¤ªçœ‹æ‡‚ï¼Œå¤šè°¢äº†</div>2021-09-16</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/AqCAY0eAVuCLIiafWWUv871EsRhEnhYT1cy1g7CGBtYJgLxiajw68l2fff4Lu7FMmjKXuchlhcCKOqd2ghibcJgHA/132" width="30px"><span>Geek_364411</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>1.
fn main() {
  let arr = vec![1];

  std::thread::spawn(move || {
    println!(&quot;{:?}&quot;, arr);
  });
}
2.
fn main() {
    let name = &quot;Hello&quot;;
    let m_name = Arc::new(name);
    let clone_name = m_name.clone();
    std::thread::spawn(move || {
        println!(&quot;{:?}&quot;, clone_name);
    });
    println!(&quot;{:?}&quot;, m_name);
}
3.ä½¿ç”¨äº†è£¸æŒ‡é’ˆæ¥ä¿®æ”¹
pub fn replace&lt;T&gt;(dest: &amp;mut T, src: T) -&gt; T {
    unsafe {
        let result = ptr::read(dest);
        ptr::write(dest, src);
        result
    }
}</div>2021-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2b/4a/3b/a6bf9a5e.jpg" width="30px"><span>Ignis</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>1. å°†arrç§»åŠ¨åˆ°å­çº¿ç¨‹ï¼š
```rust
fn main() {
    let arr = vec![1];
    std::thread::spawn(move || {
        println!(&quot;{:?}&quot;, arr);
    });
}
```

2. ä½¿ç”¨ArcåŒ…ä¸€ä¸‹Stringï¼š
```rust
use std::sync::Arc;

fn main() {
    let s1 = Arc::new(String::from(&quot;arc&quot;));
    let s2 = s1.clone();
    let h = std::thread::spawn(move || {
        println!(&quot;child thread: {:?}&quot;, s2);
    });
    println!(&quot;main thread: {:?}&quot;, s1);
    h.join().unwrap();
}
```

3. æ„Ÿè§‰è¿™ä¸ªç±»ä¼¼Cè¯­è¨€é‡Œé¢çš„constæŒ‡é’ˆï¼ŒæŒ‡é’ˆæœ¬èº«çš„å€¼ä¸èƒ½æ›´æ”¹ï¼Œä½†æ˜¯å…¶æŒ‡å‘çš„å†…å®¹æ˜¯å¯ä»¥æ›´æ”¹çš„ã€‚</div>2021-11-12</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ5MUYIZAaFTyrvLgNptib49zGW5SvqUxYmSC7qib4ibQF6GUiafsoHRqGQQvGicial7q5Bg9n11rLTNicHw/132" width="30px"><span>æ³¡æ²«çš„å¿«ä¹</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆæ‚¨å¥½ã€‚ æˆ‘ä¸å¤ªæ˜ç™½ï¼Œä¸ºä»€ä¹ˆæ ˆåªèƒ½å­˜æ”¾ ç¡®å®šå ç”¨å¤šå°‘å†…å­˜ çš„ç±»å‹ï¼Ÿ  </div>2021-09-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/56/9e/020797cd.jpg" width="30px"><span>.nil?</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ç¬¬1é¢˜. æ ¹æ®é”™è¯¯æç¤ºå¯ä»¥çœ‹å‡ºï¼Œé—­åŒ…ä¸­å€Ÿç”¨çš„arrç”Ÿå‘½å‘¨æœŸå¤§äºmainå‡½æ•°ä¸­arrçš„ç”Ÿå‘½å‘¨æœŸï¼Œæ ¹æ®æç¤ºæ·»åŠ moveå°±å¯ä»¥
```
fn main() {
  let arr = vec![1];

  std::thread::spawn(move || {
    println!(&quot;{:?}&quot;, arr);
  });
}
```

ç¬¬2é¢˜
```
use std::sync::Arc;
fn main() {
  let s1 = Arc::new(&quot;test str&quot;);
  let s2 = s1.clone();

  let hander = std::thread::spawn(move || {
    println!(&quot;thread s is {:?}&quot;, s2);
  });
  println!(&quot;s1 is {:?}&quot;, s1);
  hander.join().unwrap();
}
```

ç¬¬3é¢˜ï¼Œç¿»çœ‹æºä»£ç ï¼Œå¯¹äº inc_strong() å‡½æ•°ä¸­è°ƒç”¨çš„ strong_ref()ï¼Œå®ƒçš„è¿”å›ç±»å‹æ˜¯ Cellï¼Œè€Œ Cell æ˜¯å†…éƒ¨å¯å˜
```
    fn strong_ref(&amp;self) -&gt; &amp;Cell&lt;usize&gt;;

    #[inline]
    fn strong(&amp;self) -&gt; usize {
        self.strong_ref().get()
    }

    #[inline]
    fn inc_strong(&amp;self) {
        let strong = self.strong();

        &#47;&#47; We want to abort on overflow instead of dropping the value.
        &#47;&#47; The reference count will never be zero when this is called;
        &#47;&#47; nevertheless, we insert an abort here to hint LLVM at
        &#47;&#47; an otherwise missed optimization.
        if strong == 0 || strong == usize::MAX {
            abort();
        }
        self.strong_ref().set(strong + 1);
    }
```</div>2021-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/62/e0/d2ff52da.jpg" width="30px"><span>è®°äº‹æœ¬</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div> x.borrow_mut() å’Œ &amp;mut x å¥½åƒç»“æœä¸€æ ·ä»–ä»¬ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿ
</div>2021-09-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg" width="30px"><span>ç½—æ°</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>å¬å–è€å¸ˆå»ºè®®ï¼Œè¯»æºç ï¼Œçœ‹åˆ° cell.rs é‡Œé¢æœ‰å¾ˆå¤šçš„ unsafeï¼Œä»£ç ä»”ç»†é˜…è¯»ä¹Ÿæ²¡æœ‰é‚£ä¹ˆéš¾ã€‚</div>2021-09-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/a3/87/eb923eb3.jpg" width="30px"><span>0@1</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œèƒ½ä¸èƒ½æå‰åˆ—å‡ºæ‰€æœ‰çš„è¯¾ç¨‹ç›®å½•ï¼Œè¿™æ ·ä¹Ÿå¥½æ–¹ä¾¿é—®é—®é¢˜ï¼Œ æœ‰äº›é—®é¢˜å¯èƒ½éœ€è¦åœ¨ç‰¹å®šè¯¾ç¨‹ç›®å½•ä¸‹é—®æ¯”è¾ƒåˆé€‚ã€‚</div>2021-09-12</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL8Rzicd8f8GlIiaLQ6bYKPdhFJ3tvXw96rMicPv4s2rXEanYKjKdEewjCUAnwfJiaN53WyexhYLu1bbQ/132" width="30px"><span>Tyler</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>1ã€åœ¨é—­åŒ…å‰åŠ moveå…³é”®å­—ã€‚  ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶æœ‰é”™è¯¯æç¤ºå¹¶æä¾›äº†ä¸€ä¸ªè§£å†³çš„æ–¹æ³•ã€‚
2ã€
use std::sync::Arc;

fn main() {
  let s = Arc::new(String::from(&quot;Hello World&quot;));
  let s1 = s.clone();
  let h = std::thread::spawn(move || {
    println!(&quot;thread: {:?}&quot;, s1);
  });
  
  println!(&quot;{:?}&quot;, s);
  h.join().unwrap();
}
```
3ã€æŸ¥çœ‹æºç inner()çš„å®ç°ä½¿ç”¨äº†unsafe 

</div>2021-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/93/96/81c8cc33.jpg" width="30px"><span>Quincy</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>1.
fn main() {
  let arr = vec![1];

  std::thread::spawn(move || {
    println!(&quot;{:?}&quot;, arr);
  });
}
2.
   1 â”‚ use std::sync::Arc;
   2 â”‚
   3 â”‚ fn main() {
   4 â”‚ let str = Arc::new(String::from(&quot;å…±äº«å­—ç¬¦ä¸²&quot;));
   5 â”‚ let a = str.clone();
   6 â”‚ let b = Arc::clone(&amp;str);
   7 â”‚
   8 â”‚ std::thread::spawn(move || {
   9 â”‚ println!(&quot;çº¿ç¨‹: {:?}&quot;, b);
  10 â”‚ });
  11 â”‚ println!(&quot;main: {:?}&quot;, a);
  12 â”‚ }
3.
æŸ¥çœ‹æºä»£ç 
```rust
impl&lt;T: ?Sized&gt; Clone for Rc&lt;T&gt; {
    #[inline]
    fn clone(&amp;self) -&gt; Rc&lt;T&gt; {
        self.inner().inc_strong();
        Self::from_inner(self.ptr)
    }
}
```

```rust
impl&lt;T: ?Sized&gt; Rc&lt;T&gt; {
    #[inline(always)]
    fn inner(&amp;self) -&gt; &amp;RcBox&lt;T&gt; {
        &#47;&#47; This unsafety is ok because while this Rc is alive we&#39;re guaranteed
        &#47;&#47; that the inner pointer is valid.
        unsafe { self.ptr.as_ref() }
    }
...
```

```rust
#[doc(hidden)]
trait RcInnerPtr {
    fn weak_ref(&amp;self) -&gt; &amp;Cell&lt;usize&gt;;
    fn strong_ref(&amp;self) -&gt; &amp;Cell&lt;usize&gt;;

    #[inline]
    fn strong(&amp;self) -&gt; usize { self.strong_ref().get() }

    #[inline]
    fn inc_strong(&amp;self) {
        let strong = self.strong();

        if strong == 0 || strong == usize::MAX {
            abort();
        }
        self.strong_ref().set(strong + 1);
    }
```

çœ‹æºä»£ç çŒœæµ‹â€œè¿™é‡Œå¯¹ self çš„ä¸å¯å˜å¼•ç”¨å¯ä»¥æ”¹å˜ self çš„å†…éƒ¨æ•°æ®â€æ˜¯å› ä¸ºï¼š
åœ¨ unsafe ä»£ç å—ä¸­è·å–äº† self çš„æŒ‡é’ˆï¼Œè¿”å›äº† `RcBox&lt;T&gt;` çš„å¼•ç”¨ç±»å‹ï¼Œç„¶ååœ¨ `inc_strong()` å‡½æ•°ä¸­ï¼Œé€šè¿‡ `self.strong_ref()` ä½¿ç”¨ `Cellï¼œTï¼` å†…éƒ¨å¯å˜å®¹å™¨ï¼Œé€šè¿‡å¯¹å¤–æš´éœ²çš„ `set` æ–¹æ³•å®ç°äº†å¯¹å†…éƒ¨å€¼çš„ä¿®æ”¹ï¼Œè€Œå…¶æœ¬èº«å´æ˜¯ä¸å¯å˜çš„ã€‚æ‰€ä»¥ï¼Œå®é™…ä¸Š `Cellï¼œTï¼` åŒ…è£¹çš„Tæœ¬èº«åˆæ³•åœ°é¿å¼€äº†å€Ÿç”¨æ£€æŸ¥ã€‚</div>2021-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/5a/d0/5be738e0.jpg" width="30px"><span>jin</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆå¥½ï¼Œæ–‡ç« æ„é€ DAGæ—¶ï¼Œæ˜¯å…ˆæ„å»ºäº†Node1ï¼Œ3ï¼Œ4çš„å…³ç³»ï¼Œå†æŠŠ2åŠ è¿›å»ã€‚ä½†è®©æˆ‘ç›´è§‰ä¸Šéš¾ä»¥æ¥å—çš„æ˜¯ï¼ŒåŠ è¿›å»çš„æ—¶å€™å´ç”¨åˆ°äº†Node1ï¼Œå› ä¸ºéœ€è¦è°ƒç”¨Rc.clone()å¢åŠ å¼•ç”¨è®¡æ•°ã€‚åœ¨å®é™…çš„å›¾è®ºé—®é¢˜ä¸­ï¼Œå‡è®¾æˆ‘ä»¬è¦æ’å…¥ç‚¹2ï¼Œæ‰¾åˆ°äº†ç‚¹3ï¼Œéš¾é“è¿˜è¦O(n)éå†æ‰€æœ‰ç‚¹ï¼Œä»è€Œæ‰¾åˆ°ç‚¹2çš„referenceå—ï¼Ÿæ„Ÿè§‰è¿™ä¸ªç¡®å®æœ‰ç‚¹é™åˆ¶çµæ´»æ€§äº†ï¼Œè¯·é—®æ‚¨æ€ä¹ˆçœ‹å‘¢ï¼Ÿ</div>2021-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/9d/e8/39433235.jpg" width="30px"><span>Christian</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>1. spawn è¦æ±‚é—­åŒ…å…·æœ‰é™æ€ç”Ÿå‘½å‘¨æœŸã€‚ä½†ä¼ å…¥çš„é—­åŒ…æ•è·äº† arr çš„å¼•ç”¨ï¼Œç”Ÿå‘½å‘¨æœŸä¸ä¼šè¶…å‡º main å‡½æ•°ã€‚ä¿®å¤ï¼š
```rust
fn main() {
    let arr = vec![1];
    std::thread::spawn(move || {
        println!(&quot;{:?}&quot;, arr);
    });
}
```

2. 
```rust
use std::sync::Arc;

fn main() {
    let s = Arc::new(&quot;foo&quot;.to_string());

    let handle = std::thread::spawn({
        let s = s.clone();

        move || {
            println!(&quot;{:?}&quot;, s);
        }
    });

    println!(&quot;{:?}&quot;, s);

    handle.join().unwrap();
}
```

3. inner() çš„è¿”å›ç±»å‹å…·æœ‰å†…éƒ¨å¯å˜è¡Œã€‚</div>2021-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/54/6d/c947ef55.jpg" width="30px"><span>Neo</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>é—®é¢˜1: æ–°çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸå¯èƒ½æ¯”ä¸»çº¿ç¨‹é•¿ï¼Œæ–°çº¿ç¨‹å€Ÿç”¨äº†arrä¼šè¶…å‡ºä¸»çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ
    let arr =vec![1];

    std::thread::spawn(move || {
        println!(&quot;arr1: {:?}&quot;, arr);
    }).join().unwrap();

é—®é¢˜2:
    let arr =Arc::new(vec![1]);
    let arr1 = arr.clone();
    std::thread::spawn(move || {
        println!(&quot;arr1: {:?}&quot;, arr1);
    }).join().unwrap();

    println!(&quot;arr: {:?}&quot;, arr);</div>2022-10-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/6d/6c/81fa79a2.jpg" width="30px"><span>â—‘â–‚â—</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆæœ‰ä¸€ä¸ªåˆçº§é—®é¢˜è¯·æ•™ä¸‹ï¼šself.downstream.as_ref().map(|v| v.clone())  ä¸­çš„ |v| æ˜¯ä»£è¡¨ä»€ä¹ˆè¯­æ³•ï¼›æˆ‘æ‰¾äº†å¾ˆå¤šrustç›¸å…³çš„è¯­æ³•çŸ¥è¯†éƒ½æ²¡æœ‰æ‰¾åˆ°ã€‚æˆ–è€…è€å¸ˆè¿™ä¸€å—æœ‰ä»€ä¹ˆä¹¦ç±å¯ä»¥æ¨èçš„ </div>2022-04-21</li><br/>
</ul>