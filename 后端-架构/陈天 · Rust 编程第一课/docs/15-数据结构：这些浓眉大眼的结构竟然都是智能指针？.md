ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚

åˆ°ç°åœ¨ä¸ºæ­¢æˆ‘ä»¬å­¦äº†Rustçš„æ‰€æœ‰æƒä¸ç”Ÿå‘½å‘¨æœŸã€å†…å­˜ç®¡ç†ä»¥åŠç±»å‹ç³»ç»Ÿï¼ŒåŸºç¡€çŸ¥è¯†é‡Œè¿˜å‰©ä¸€å—ç‰ˆå›¾æ²¡æœ‰æ¶‰åŠï¼šæ•°æ®ç»“æ„ï¼Œæ•°æ®ç»“æ„é‡Œæœ€å®¹æ˜“è®©äººå›°æƒ‘çš„å°±æ˜¯æ™ºèƒ½æŒ‡é’ˆï¼Œæ‰€ä»¥ä»Šå¤©æˆ‘ä»¬å°±æ¥è§£å†³è¿™ä¸ªéš¾ç‚¹ã€‚

æˆ‘ä»¬ä¹‹å‰ç®€å•ä»‹ç»è¿‡æŒ‡é’ˆï¼Œè¿™é‡Œè¿˜æ˜¯å…ˆå›é¡¾ä¸€ä¸‹ï¼šæŒ‡é’ˆæ˜¯ä¸€ä¸ªæŒæœ‰å†…å­˜åœ°å€çš„å€¼ï¼Œå¯ä»¥é€šè¿‡è§£å¼•ç”¨æ¥è®¿é—®å®ƒæŒ‡å‘çš„å†…å­˜åœ°å€ï¼Œç†è®ºä¸Šå¯ä»¥è§£å¼•ç”¨åˆ°ä»»æ„æ•°æ®ç±»å‹ï¼›å¼•ç”¨æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡é’ˆï¼Œå®ƒçš„è§£å¼•ç”¨è®¿é—®æ˜¯å—é™çš„ï¼Œåªèƒ½è§£å¼•ç”¨åˆ°å®ƒå¼•ç”¨æ•°æ®çš„ç±»å‹ï¼Œä¸èƒ½ç”¨ä½œå®ƒç”¨ã€‚

é‚£ä»€ä¹ˆæ˜¯æ™ºèƒ½æŒ‡é’ˆå‘¢ï¼Ÿ

## æ™ºèƒ½æŒ‡é’ˆ

åœ¨æŒ‡é’ˆå’Œå¼•ç”¨çš„åŸºç¡€ä¸Šï¼ŒRust å·å¸ˆ C++ï¼Œæä¾›äº†æ™ºèƒ½æŒ‡é’ˆã€‚æ™ºèƒ½æŒ‡é’ˆæ˜¯ä¸€ä¸ªè¡¨ç°è¡Œä¸ºå¾ˆåƒæŒ‡é’ˆçš„æ•°æ®ç»“æ„ï¼Œä½†é™¤äº†æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆå¤–ï¼Œå®ƒè¿˜æœ‰å…ƒæ•°æ®ä»¥æä¾›é¢å¤–çš„å¤„ç†èƒ½åŠ›ã€‚

è¿™ä¸ªå®šä¹‰æœ‰ç‚¹æ¨¡ç³Šï¼Œæˆ‘ä»¬å¯¹æ¯”å…¶ä»–çš„æ•°æ®ç»“æ„æ¥æ˜ç¡®ä¸€ä¸‹ã€‚

ä½ æœ‰æ²¡æœ‰è§‰å¾—å¾ˆåƒä¹‹å‰è®²çš„èƒ–æŒ‡é’ˆã€‚æ™ºèƒ½æŒ‡é’ˆä¸€å®šæ˜¯ä¸€ä¸ªèƒ–æŒ‡é’ˆï¼Œä½†èƒ–æŒ‡é’ˆä¸ä¸€å®šæ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆã€‚æ¯”å¦‚ &amp;str å°±åªæ˜¯ä¸€ä¸ªèƒ–æŒ‡é’ˆï¼Œå®ƒæœ‰æŒ‡å‘å †å†…å­˜å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼ŒåŒæ—¶è¿˜æœ‰å…³äºå­—ç¬¦ä¸²é•¿åº¦çš„å…ƒæ•°æ®ã€‚

æˆ‘ä»¬çœ‹æ™ºèƒ½æŒ‡é’ˆ String å’Œ &amp;str çš„åŒºåˆ«ï¼š![](https://static001.geekbang.org/resource/image/f4/59/f4401040f7d36b9e610b6867a5d0cf59.jpg?wh=1913x1206)

ä»å›¾ä¸Šå¯ä»¥çœ‹åˆ°ï¼ŒString é™¤äº†å¤šä¸€ä¸ª capacity å­—æ®µï¼Œä¼¼ä¹ä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šã€‚**ä½† String å¯¹å †ä¸Šçš„å€¼æœ‰æ‰€æœ‰æƒï¼Œè€Œ &amp;str æ˜¯æ²¡æœ‰æ‰€æœ‰æƒçš„ï¼Œè¿™æ˜¯ Rust ä¸­æ™ºèƒ½æŒ‡é’ˆå’Œæ™®é€šèƒ–æŒ‡é’ˆçš„åŒºåˆ«**ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ30ï¼‰</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/af/af/8b03ce2c.jpg" width="30px"><span>GengTeng</span> ğŸ‘ï¼ˆ19ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<div>1.
impl From&lt;String&gt; for MyString {
    fn from(s: String) -&gt; Self {
        if s.len() &gt; MINI_STRING_MAX_LEN {
            Self::Standard(s)
        } else {
            Self::Inline(MiniString::new(s))
        }
    }
}
2.
impl MyString {
    fn push_str(&amp;mut self, string: &amp;str) {
        match self {
            MyString::Inline(m) =&gt; {
                let l = m.len();
                let len = l + string.len();
                if len &gt; MINI_STRING_MAX_LEN {
                    *self = Self::Standard(m.to_string() + string);
                } else {
                    m.data[l..].copy_from_slice(string.as_bytes());
                    m.len = len as u8;
                }
            }
            MyString::Standard(s) =&gt; s.push_str(string),
        }
    }
}
3. 32 32
Cow&lt;&#39;a, B&gt; è¦æ±‚ B å®ç° ToOwnedï¼Œå…¶Ownedå˜ä½“çš„æ•°æ®ä¸º å¯¹åº”çš„ Owned ç±»å‹ï¼Œå³ [T] å¯¹åº”çš„æ˜¯ Vec&lt;T&gt;ï¼Œ str å¯¹åº”çš„æ˜¯ Stringï¼Œè¿™ä¸¤ä¸ªçš„å¤§å°éƒ½æ˜¯24å­—èŠ‚ï¼ŒåŠ ä¸Šæšä¸¾å ç”¨çš„ä¸€å­—èŠ‚ä»¥åŠ8å­—èŠ‚å¯¹é½ï¼Œå°±æ˜¯32å­—èŠ‚ã€‚
</div>2021-09-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/3f/23/3ea59027.jpg" width="30px"><span>Lucas</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ5ï¼‰<div>è·Ÿä¸ä¸Šäº† çœ‹ä¸æ‡‚äº†ğŸ˜­</div>2021-10-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/62/e0/d2ff52da.jpg" width="30px"><span>è®°äº‹æœ¬</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>Owned(&lt;B as ToOwned&gt;::Owned)  æ³›å‹Bè½¬æ¢ç‰¹å¾åç§°æ˜¯ä¸ªä»€ä¹ˆæ ·çš„è¯­æ³•ï¼Œè€å¸ˆ</div>2021-09-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/72/c1/59509397.jpg" width="30px"><span>æ²ˆç•…</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>è¯¾ç¨‹å­¦åˆ°è¿™ï¼Œæœ€å¤§çš„é—®é¢˜æ„Ÿè§‰ä¸æˆä½“ç³»ï¼Œæ¯ç¯‡æ–‡ç« åƒæ˜¯åšå®¢ä¸“é¢˜æ–‡ç« ã€‚ä½†æ˜¯ç« èŠ‚ä¹‹é—´æ²¡æœ‰ä½“ç³»ï¼Œä½œä¸ºç¬¬ä¸€è¯¾æ„Ÿè§‰æœ‰äº›ä¸å¦¥ã€‚</div>2022-07-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/62/e0/d2ff52da.jpg" width="30px"><span>è®°äº‹æœ¬</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>Stringåœ¨å †ä¸Šåˆ†é…å†…å­˜,Stringæ˜¯æ ˆä¸Šçš„ä¸€ä¸ªç»“æ„ä½“,å‡å¦‚Box::new(String),æ˜¯ä¸æ˜¯Stringç»“æ„ä½“ä¹Ÿåœ¨å †ä¸Šäº†</div>2021-10-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg" width="30px"><span>æ ¸æ¡ƒ</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>å…³äºæ‰€æœ‰æƒå’Œæ™ºèƒ½æŒ‡é’ˆçš„ç†è§£ï¼Œå¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« 
https:&#47;&#47;zhuanlan.zhihu.com&#47;p&#47;54078587
è¿™äº›æ¦‚å¿µåœ¨c++é‡Œé¢éƒ½æ˜¯æœ‰çš„ï¼Œå› æ­¤ä»c++çš„è§’åº¦å»ç†è§£ä¸€ä¸‹æ™ºèƒ½æŒ‡é’ˆä¸æ™®é€šæŒ‡é’ˆåŒºåˆ«ï¼Œä»€ä¹ˆæ˜¯ç§»åŠ¨è¯­ä¹‰ï¼Œé‚£æ ·è¿”å›æ¥çœ‹rustçš„æ¦‚å¿µï¼Œå°±æ˜ç™½æ¸…æ™°å¾ˆå¤šäº†ã€‚</div>2021-12-05</li><br/><li><img src="" width="30px"><span>Ryan</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è¿™æ ·å®ç°å‡ºæ¥çš„MyStringå¦‚æœä¼ é€’ç»™å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå†…éƒ¨æ ˆä¸Šçš„å†…å­˜å¯èƒ½è¢«é‡Šæ”¾äº†ã€‚è¿™æ–¹é¢ä¸æ ‡å‡†Stringçš„åŒºåˆ«æ˜¯å¦‚ä½•ä½“ç°å¹¶åŠ ä»¥ä¿è¯çš„å‘¢ï¼Ÿ</div>2021-10-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/e5/76/5d0b66aa.jpg" width="30px"><span>Mr_æå†²</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æ–‡ä¸­Cowéƒ¨åˆ†ç¤ºä¾‹æ®µUrl::parseæœ‰ä¸ªbugï¼Œurlå·¦å³ä¸¤è¾¹å„æœ‰ä¸ªå°–æ‹¬å·ï¼Œéœ€è¦å»æ‰ï¼Œå¦åˆ™ä¼šè§£æurlå¤±è´¥ï¼Œunwrapåå¯¼è‡´ç¨‹åºå´©æºƒã€‚
æ›´æ­£åæ˜¯ä¸‹é¢è¿™ä¸ªï¼š
let url = Url::parse(&quot;https:&#47;&#47;tyr.com&#47;rust?page=1024&amp;sort=desc&amp;extra=hello%20world&quot;).unwrap();</div>2021-12-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/58/fc/c3be5d8b.jpg" width="30px"><span>yg</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>é™ˆè€å¸ˆæ‚¨å¥½ï¼Œç”¨rustç¼–å†™å†…æ ¸æ¨¡å—çš„è¯ï¼Œå“ªé‡Œæœ‰èµ„æ–™å¯ä»¥å‚è€ƒä¹ˆ</div>2021-11-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/13/14/e5a80f4b.jpg" width="30px"><span>Ryan</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æˆ‘æ„Ÿè§‰è¿™è¯¾ç¨‹å¾—è‡³å°‘åˆ·3éæ‰èƒ½çœ‹æ‡‚ï¼Œå·²ç»è·Ÿä¸ä¸Šäº†ã€‚ã€‚ã€‚</div>2021-11-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/69/a2/c30ac459.jpg" width="30px"><span>hughieyu</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>1.impl From&lt;String&gt; for MyString {
    fn from(s: String) -&gt; Self {
        match s.len() &lt;= MINI_STRING_MAX_LEN {
            true =&gt; MyString::Inline(MiniString::new(s)),
            false =&gt; MyString::Standard(s),
        }
    }
}
2.impl MyString {
    fn push_str(&amp;mut self, string: &amp;str){
        match *self {
            MyString::Standard(ref mut s)=&gt; s.push_str(string),
            MyString::Inline(ref mut mini) =&gt; {
                let size = mini.len as usize;
                match size + string.len() &lt;= MINI_STRING_MAX_LEN {
                    true =&gt; { 
                        mini.data[size..size+string.len()].copy_from_slice(string.as_bytes());
                        mini.len = (size +string.len()) as u8;
                    },
                    false =&gt; *self =  MyString::Standard( format!(&quot;{}{}&quot;, mini.to_string(), string)),
                }
            },
        }
    }
}
3. å†³å®šCow&lt;&#39;a,B&gt;å¤§å°çš„æ˜¯è¾ƒå¤§çš„ä¸€ä¸ªå€¼(ä¸€èˆ¬æ˜¯&lt;B as ToOwned&gt;::Owned)ï¼Œ&lt;[u8] as ToOwned&gt;::Owned=Vec&lt;u8&gt;, &lt;str as ToOwned&gt;::Owned=String, ä¸¤ä¸ªçš„å¤§å°éƒ½ä¸º24å­—èŠ‚ï¼ŒåŠ ä¸Šenumä¸€ä¸ªå­—èŠ‚tagå’Œ7ä¸ªå­—èŠ‚å¯¹é½ï¼Œå…±è®¡32å­—èŠ‚ã€‚</div>2021-09-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg" width="30px"><span>Marvichov</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>Cow and ToOwnedä¸€ç›´åœ¨æˆ‘çš„todo listé‡Œé¢åƒç°, æ„Ÿè°¢è€å¸ˆè¿™ä¹ˆæ¸…æ™°çš„è®²è§£, è®©å®ƒä»¬å‡ºæ¥æ”¾é£ä¹‹åç»§ç»­å›å»èººç°...

1-3çš„ä»£ç  https:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=4e790189feaa66f784e60aa614931a13

1. 
    impl From&lt;String&gt; for MyString {
        fn from(s: String) -&gt; Self {
            if s.len() &gt; MINI_STRING_MAX_LEN {
                Self::Standard(s)
            } else {
                Self::Inline(MiniString::new(s))
            }
        }
    }

2.

    impl MyString {
        pub fn push_str(&amp;mut self, string: &amp;str) {
            match self {
                Self::Inline(s) =&gt; {
                    if s.len as usize + string.len() &lt;= MINI_STRING_MAX_LEN {
                        let bytes = string.as_bytes();
                        let offset = s.len as usize;
                        for ii in 0..bytes.len() {
                            s.data[offset + ii] = bytes[ii];
                        }
                        s.len += bytes.len() as u8;
                    } else {
                        let mut ss = String::with_capacity(s.len() as usize + string.len());
                        &#47;&#47; ä½¿ç”¨ from_utf8_unchecked ç‰ˆæœ¬çš„ deref
                        ss.push_str(s);
                        ss.push_str(string);
                        *self = MyString::from(ss);
                    }
                }
                Self::Standard(s) =&gt; {
                    s.push_str(string);
                }
            }
        }
    }
    
3. 32; str å¯¹åº”çš„ ownedæ˜¯String, 24 bytes. &amp;stræ˜¯fat ptr, 16 bytes; tag 1ä¸€ä¸ªå­—èŠ‚, ç„¶è€ŒStringçš„alignmentæ˜¯8, tagéœ€è¦å¯¹é½, äºæ˜¯åŠ ä¸Š7ä¸ªpadding; `[u8]` åŒç†</div>2021-09-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg" width="30px"><span>qinsi</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æœ‰ä¸ªå°ç–‘é—®ï¼šä¸ºä»€ä¹ˆè¯´Box&lt;T&gt;çš„Drop traitç”±ç¼–è¯‘å™¨å®ç°æ˜¯ä¸ºäº†ç¨³å®šæ¥å£ï¼Ÿåªè¦æ¥å£ç¡®å®šäº†ï¼Œæ¥å£çš„å®ç°æ€ä¹ˆæ¢å¯¹äºä½¿ç”¨è€…æ¥è¯´éƒ½æ— æ‰€è°“å§ï¼ŸçŒœæµ‹ä¼šä¸ä¼šæ˜¯ä¸ºäº†å®ç°ä¸Šçš„æ•ˆç‡ç›´æ¥ç”Ÿæˆæ±‡ç¼–ï¼Œè€Œæ±‡ç¼–æ˜¯unstableçš„ï¼Œæ— æ³•é€šè¿‡stableç¼–è¯‘ï¼Œæ‰€ä»¥åªèƒ½å…ˆæ”¾åœ¨ç¼–è¯‘å™¨é‡Œäº†ï¼Ÿä»è¿™ä¸ªè§’åº¦æ¥çœ‹çš„è¯ï¼Œå…¶å®è¦ç¨³å®šçš„ä¸æ˜¯Drop traitï¼Œè€Œæ˜¯ä»£ç å†…åµŒæ±‡ç¼–è¿™ä¸ªfeature?

(å…¶å®ä¸»è¦æ˜¯çœ‹åˆ°pythonè¢«æ‹¿å‡ºæ¥è¯´äº‹æœ‰ç‚¹ä¸å¼€å¿ƒï¼ŒæŠ¬ä¸ªæ  ;-ï¼‰</div>2021-09-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/58/79/266ca68e.jpg" width="30px"><span>LuYoo</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è·Ÿä¸ä¸Š+1ï¼Œæ„Ÿè§‰è¿˜æ˜¯è¦æ•´ä½“è¿‡ä¸€éï¼Œç„¶ååœ¨å›å¤´å…·ä½“çœ‹ä¸æ‡‚çš„ã€‚</div>2021-12-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/35/d0/f2ac6d91.jpg" width="30px"><span>é˜¿æˆ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>https:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=b77895530e3fc0df461ed8c8d7d34663</div>2021-11-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/51/22/d12f7a72.jpg" width="30px"><span>TheLudlows</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ä¸çŸ¥é“è¿™æ ·ç†è§£å¯¹ä¸å¯¹ï¼ŒMiniStringæ²¡æœ‰å®ç°ToString traitä½†æ˜¯èƒ½è°ƒç”¨to_stringæ–¹æ³•ï¼Œæ˜¯å› ä¸ºMiniStringå®ç°äº†Derefï¼Œå½“è°ƒç”¨to_stringæ—¶ï¼Œå…¥å‚æ˜¯&amp;selfï¼Œç›¸å½“äº*(&amp;miniString).to_stringï¼ŒåŒæ—¶stræ˜¯å®ç°äº†ToStringçš„ </div>2021-11-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/d2/1f/2ef2514b.jpg" width="30px"><span>newzai</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æœ‰ä»€ä¹ˆåˆ†é…å™¨å¯ä»¥ï¼Œæœ‰æ¥å£å¯ä»¥è¾“å‡ºå½“å‰è¿›ç¨‹çš„å†…å­˜åˆ†é…è®°å½•ä¸ï¼Œç±»ä¼¼go pprofæ˜¯heapå·¥å…·ï¼Œå†…åµŒåˆ°webä¸­ï¼Œå¯ä»¥éšæ—¶å®šä½ç³»ç»Ÿå†…å­˜åˆ†é…ï¼Œé‡Šæ”¾æ˜¯å¦æ­£å¸¸ã€‚

å¦å¤–rustæœ‰æ²¡æœ‰ç±»ä¼¼goçš„pprofå·¥å…·ï¼Œå¯ä»¥å†…åµŒwebä¸­ï¼ŒæŸ¥çœ‹å®æ—¶çš„æ‰€æœ‰çº¿ç¨‹stack ï¼Œæ‰€æœ‰heapåˆ†é…è®°å½•ã€‚ã€‚</div>2021-10-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/97/79/71aba0c4.jpg" width="30px"><span>é»„ç»´ä¸€</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>å®Œå…¨è·Ÿä¸ä¸Šäº†ï¼Œæ¶ˆåŒ–ä¸äº†çŸ¥è¯†äº†</div>2021-10-08</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg" width="30px"><span>pedro</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æ·±åº¦å¥½æ–‡ï¼å¾ˆå¤šå®ç”¨çš„å°æŠ€å·§ï¼Œæ¶¨çŸ¥è¯†ã€‚</div>2021-09-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/55/10/33310cb9.jpg" width="30px"><span>æ’</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>é¦–å…ˆï¼Œtype Owned: Borrow&lt;Self&gt; æ˜¯ä¸€ä¸ªå¸¦æœ‰å…³è”ç±»å‹çš„ trait ï¼Œå¦‚æœä½ å¯¹è¿™ä¸ªçŸ¥è¯†ç‚¹æœ‰äº›é—å¿˜ï¼Œå¯ä»¥å†å¤ä¹ ä¸€ä¸‹

è¿™é‡Œæ˜¯å¦å®é™…æ˜¯è¯´ToOwnedæ˜¯å¸¦å…³è”ç±»å‹çš„trait</div>2021-09-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/21/c5/f6/ebebd698.jpg" width="30px"><span>3vilive</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>è‡ªå®šä¹‰ GlobalAlloc çš„ä»£ç å·²ç»ä¸é€‚ç”¨å½“å‰ç‰ˆæœ¬äº†ï¼Œè¿™é‡Œæä¾› rustc 1.71.0 çš„å‚è€ƒä»£ç ï¼š

```rust
use std::alloc::{GlobalAlloc, Layout, System};

struct DebugAllocator;

unsafe impl GlobalAlloc for DebugAllocator {
    unsafe fn alloc(&amp;self, layout: Layout) -&gt; *mut u8 {
        let data = GlobalAlloc::alloc(&amp;System, layout);
        eprintln!(&quot;ALLOC: {:p}, size {}&quot;, data, layout.size());
        data
    }

    unsafe fn dealloc(&amp;self, ptr: *mut u8, layout: Layout) {
        GlobalAlloc::dealloc(&amp;System, ptr, layout);
        eprintln!(&quot;FREE: {:p}, size {}&quot;, ptr, layout.size());
    }
}

#[global_allocator]
static GLOBAL: DebugAllocator = DebugAllocator;
```

</div>2023-08-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/ba/d28174a9.jpg" width="30px"><span>Geek_zbvt62</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>ç”¨è€å¸ˆçš„æ¨è¿Ÿçš„è§†è§’ï¼ŒCowå…¶å®æ˜¯å°†æ•°æ®çš„ä½¿ç”¨æ–¹å¼(å€Ÿç”¨è¿˜æ˜¯æ‰€æœ‰æƒ)æ¨è¿Ÿåˆ°äº†å‡½æ•°ä¸­ã€‚</div>2022-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/de/f5/a9054651.jpg" width="30px"><span>ADkun</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>1. å°†impl From&lt;&amp;str&gt;æ”¹ä¸ºimpl&lt;T: AsRef&lt;str&gt;&gt; From&lt;T&gt;
```rust
impl&lt;T: AsRef&lt;str&gt;&gt; From&lt;T&gt; for MyString {
    fn from(s: T) -&gt; Self {
        let s_ref = s.as_ref();
        if s_ref.len() &gt; MINI_STRING_MAX_LEN {
            Self::Standard(s_ref.to_owned())
        } else {
            Self::Inline(MiniString::new(s_ref))
        }
    }
}
```

2. å®ç°ï¼š
impl MyString {
    pub fn push_str(&amp;mut self, s: impl AsRef&lt;str&gt;) {
        match self {
            MyString::Inline(ref mut v) =&gt; {
                let total_len = v.len as usize + s.as_ref().len();
                if total_len &gt; MINI_STRING_MAX_LEN {
                    *self = MyString::Standard(s.as_ref().to_owned());
                } else {
                    v.data[v.len as usize..total_len].copy_from_slice(s.as_ref().as_bytes());
                    v.len = total_len as u8;
                }
            }
            MyString::Standard(ref mut v) =&gt; {
                v.push_str(s.as_ref());
            }
        }
    }
}

3. éƒ½æ˜¯24ï¼Œå› ä¸ºBorrowedé‡Œé¢æ˜¯ä¸€ä¸ªèƒ–æŒ‡é’ˆï¼Œ16å­—èŠ‚ï¼ŒOwnedé‡Œæ˜¯Vec&lt;u8&gt;å’ŒStringï¼Œéƒ½æ˜¯24å­—èŠ‚</div>2024-08-11</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/6e/df/2a3a2fd0.jpg" width="30px"><span>zyg</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å¯¹äºè¿™ç¯‡å®åœ¨ä¸æ˜¯å¾ˆæ‡‚ï¼Œæ¯”å¦‚ï¼šã€
ä½†åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ Cow ç±»å‹è½»æ¾é«˜æ•ˆå¤„ç†å®ƒï¼Œåœ¨è¯»å– URL çš„è¿‡ç¨‹ä¸­ï¼š
1ã€æ¯è§£æå‡ºä¸€ä¸ª key æˆ–è€… valueï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª &amp;str æŒ‡å‘ URL ä¸­ç›¸åº”çš„ä½ç½®ï¼Œç„¶åç”¨ Cow å°è£…å®ƒï¼›2ã€è€Œå½“è§£æå‡ºæ¥çš„å†…å®¹ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦ decode æ—¶ï¼Œæ¯”å¦‚ â€œhello%20worldâ€ï¼Œæˆ‘ä»¬å¯ä»¥ç”Ÿæˆä¸€ä¸ªè§£æåçš„ Stringï¼ŒåŒæ ·ç”¨ Cow å°è£…å®ƒã€‚
ã€‘ç»“åˆä»£ç å®ä¾‹ä»£ç å‹æ ¹çœ‹æ‡‚  åªèƒ½å»çœ‹ urlæºç å—ï¼Ÿ </div>2024-04-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/28/d3/ef/b3b88181.jpg" width="30px"><span>overheat</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>Boxçš„newå’Œdropç°åœ¨éƒ½æœ‰äº›å˜åŒ–äº†ï¼Œåº”è¯¥æ˜¯è¯­è¨€æ…¢æ…¢è¿›æ­¥çš„ç»“æœã€‚</div>2024-03-31</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/NcWg3z7vkRdM6re0OMVattLrhQmPBZ1hFz0sVZ2biaAGabbrHW1ta42mLx4RgYAJuCmhbHIL2LKnpCuqA3Giau6Q/132" width="30px"><span>Geek_d7cf66</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å®ç°è‡ªå·±å†…å­˜åˆ†é…å™¨çš„ä»£ç æˆ‘åœ¨PlayGround ä¸Šæ˜¯å¯ä»¥è¿è¡Œçš„ï¼Œä½†æ˜¯åœ¨macç”µè„‘æ˜¯è¿è¡Œä¸äº†äº†ï¼ŒæŠ¥é”™ï¼š[1]    17887 illegal hardware instruction
</div>2024-03-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/61/c1/93031a2a.jpg" width="30px"><span>Aaaaaaaaaaayou</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>è€å¸ˆï¼Œæœ‰ä¸ªé—®é¢˜ï¼Œæ—¢ç„¶ enum çš„ tag æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œé‚£æ˜¯ä¸æ˜¯ enum çš„å˜ä½“ä¸ªæ•°å¿…é¡»å°äºç­‰äº 256 å‘¢ï¼Ÿ</div>2024-02-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/39/02/11/37e1a4d8.jpg" width="30px"><span>éš¾å¿µçš„ç»</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>```rust
use std::{ops::Deref, fmt::{Debug, Display}};
use core::str::from_utf8_unchecked;

const MINI_STRING_MAX_LEN: usize = 30;

struct MiniString{
    len: u8,
    data: [u8; MINI_STRING_MAX_LEN]
}
impl MiniString {
    fn new(v: impl AsRef&lt;str&gt;) -&gt; Self {
        let bytes = v.as_ref().as_bytes();
        let len = bytes.len();
        let mut data = [0u8; MINI_STRING_MAX_LEN];
        data[..len].copy_from_slice(bytes);
        Self {
            len: len as u8,
            data,
        }
    }
}

impl Deref for MiniString {
    type Target = str;

    fn deref(&amp;self) -&gt; &amp;Self::Target {
        unsafe { from_utf8_unchecked(&amp;self.data[..self.len as usize]) }
    }
}

impl Debug for MiniString {
    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;&#39;_&gt;) -&gt; std::fmt::Result {
        write!(f,&quot;{}&quot;,self.deref())
    }
}

enum MyString {
    Inline(MiniString),
    Standard(String),
} 

impl Deref for MyString {
    type Target = str;

    fn deref(&amp;self) -&gt; &amp;Self::Target {
        match self {
            &#47;&#47; è¿™é‡Œç”¨ä¸ç”¨reféƒ½ä¸€æ ·ï¼Œderefä¼šä¸€ç›´derefç›´åˆ°åŒ¹é…è¿”å›ç±»å‹
            MyString::Inline( v) =&gt; v.deref(),
            MyString::Standard(ref s) =&gt; s.deref(),
        }
    }
}
impl Display for MyString {
    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;&#39;_&gt;) -&gt; std::fmt::Result {
        write!(f, &quot;{:?}&quot;,self.deref())
    }
}

impl From&lt;&amp;str&gt; for MyString {
    fn from(value: &amp;str) -&gt; Self {
        match value.len() &gt; MINI_STRING_MAX_LEN {
            true =&gt; MyString::Standard(value.to_owned()),
            false =&gt; MyString::Inline(MiniString::new(value)),
        }
    }
}

fn main() {
    let len1 = std::mem::size_of::&lt;MiniString&gt;();
    let len2 = std::mem::size_of::&lt;MyString&gt;();
    println!(&quot;MiniString mem::len :{}&quot;,len1);
    println!(&quot;MyString mem::len :{}&quot;,len2);

    let s1: MyString = &quot;hello world&quot;.into(); 
    let s2: MyString = &quot;è¿™æ˜¯ä¸€ä¸ªè¶…è¿‡äº†ä¸‰åä¸ªå­—èŠ‚çš„å¾ˆé•¿å¾ˆé•¿çš„å­—ç¬¦ä¸²&quot;.into();
 

}
```</div>2024-01-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/30/5d/bd/c2bf1de5.jpg" width="30px"><span>Allanloo</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>çœ‹äº†å‡ è¡Œæœ‰ç‚¹æŠ•å…¥ä¸è¿›å»ï¼Œå°±æƒ³å¾€ä¸‹æ‹‰ï¼Œæƒ³æƒ³åˆä¸ç”˜å¿ƒï¼Œåˆå›æ¥å†ä¸€ä¸ªå­—ä¸€ä¸ªå­—å†è¯»</div>2023-10-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/20/f5/dd/bb991e80.jpg" width="30px"><span>é£æ–©æ–­æ™šéœ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>Standard çš„ MyString å¯¹é½åæ˜¯ä¸æ˜¯ç©ºäº† 7 ä¸ªå­—èŠ‚ï¼Ÿ</div>2022-09-15</li><br/>
</ul>