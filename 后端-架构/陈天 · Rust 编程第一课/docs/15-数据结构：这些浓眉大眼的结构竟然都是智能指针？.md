ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚

åˆ°ç°åœ¨ä¸ºæ­¢æˆ‘ä»¬å­¦äº†Rustçš„æ‰€æœ‰æƒä¸ç”Ÿå‘½å‘¨æœŸã€å†…å­˜ç®¡ç†ä»¥åŠç±»å‹ç³»ç»Ÿï¼ŒåŸºç¡€çŸ¥è¯†é‡Œè¿˜å‰©ä¸€å—ç‰ˆå›¾æ²¡æœ‰æ¶‰åŠï¼šæ•°æ®ç»“æ„ï¼Œæ•°æ®ç»“æ„é‡Œæœ€å®¹æ˜“è®©äººå›°æƒ‘çš„å°±æ˜¯æ™ºèƒ½æŒ‡é’ˆï¼Œæ‰€ä»¥ä»Šå¤©æˆ‘ä»¬å°±æ¥è§£å†³è¿™ä¸ªéš¾ç‚¹ã€‚

æˆ‘ä»¬ä¹‹å‰ç®€å•ä»‹ç»è¿‡æŒ‡é’ˆï¼Œè¿™é‡Œè¿˜æ˜¯å…ˆå›é¡¾ä¸€ä¸‹ï¼šæŒ‡é’ˆæ˜¯ä¸€ä¸ªæŒæœ‰å†…å­˜åœ°å€çš„å€¼ï¼Œå¯ä»¥é€šè¿‡è§£å¼•ç”¨æ¥è®¿é—®å®ƒæŒ‡å‘çš„å†…å­˜åœ°å€ï¼Œç†è®ºä¸Šå¯ä»¥è§£å¼•ç”¨åˆ°ä»»æ„æ•°æ®ç±»å‹ï¼›å¼•ç”¨æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡é’ˆï¼Œå®ƒçš„è§£å¼•ç”¨è®¿é—®æ˜¯å—é™çš„ï¼Œåªèƒ½è§£å¼•ç”¨åˆ°å®ƒå¼•ç”¨æ•°æ®çš„ç±»å‹ï¼Œä¸èƒ½ç”¨ä½œå®ƒç”¨ã€‚

é‚£ä»€ä¹ˆæ˜¯æ™ºèƒ½æŒ‡é’ˆå‘¢ï¼Ÿ

## æ™ºèƒ½æŒ‡é’ˆ

åœ¨æŒ‡é’ˆå’Œå¼•ç”¨çš„åŸºç¡€ä¸Šï¼ŒRust å·å¸ˆ C++ï¼Œæä¾›äº†æ™ºèƒ½æŒ‡é’ˆã€‚æ™ºèƒ½æŒ‡é’ˆæ˜¯ä¸€ä¸ªè¡¨ç°è¡Œä¸ºå¾ˆåƒæŒ‡é’ˆçš„æ•°æ®ç»“æ„ï¼Œä½†é™¤äº†æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆå¤–ï¼Œå®ƒè¿˜æœ‰å…ƒæ•°æ®ä»¥æä¾›é¢å¤–çš„å¤„ç†èƒ½åŠ›ã€‚

è¿™ä¸ªå®šä¹‰æœ‰ç‚¹æ¨¡ç³Šï¼Œæˆ‘ä»¬å¯¹æ¯”å…¶ä»–çš„æ•°æ®ç»“æ„æ¥æ˜ç¡®ä¸€ä¸‹ã€‚

ä½ æœ‰æ²¡æœ‰è§‰å¾—å¾ˆåƒä¹‹å‰è®²çš„èƒ–æŒ‡é’ˆã€‚æ™ºèƒ½æŒ‡é’ˆä¸€å®šæ˜¯ä¸€ä¸ªèƒ–æŒ‡é’ˆï¼Œä½†èƒ–æŒ‡é’ˆä¸ä¸€å®šæ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆã€‚æ¯”å¦‚ &amp;str å°±åªæ˜¯ä¸€ä¸ªèƒ–æŒ‡é’ˆï¼Œå®ƒæœ‰æŒ‡å‘å †å†…å­˜å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼ŒåŒæ—¶è¿˜æœ‰å…³äºå­—ç¬¦ä¸²é•¿åº¦çš„å…ƒæ•°æ®ã€‚

æˆ‘ä»¬çœ‹æ™ºèƒ½æŒ‡é’ˆ String å’Œ &amp;str çš„åŒºåˆ«ï¼š![](https://static001.geekbang.org/resource/image/f4/59/f4401040f7d36b9e610b6867a5d0cf59.jpg?wh=1913x1206)

ä»å›¾ä¸Šå¯ä»¥çœ‹åˆ°ï¼ŒString é™¤äº†å¤šä¸€ä¸ª capacity å­—æ®µï¼Œä¼¼ä¹ä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šã€‚**ä½† String å¯¹å †ä¸Šçš„å€¼æœ‰æ‰€æœ‰æƒï¼Œè€Œ &amp;str æ˜¯æ²¡æœ‰æ‰€æœ‰æƒçš„ï¼Œè¿™æ˜¯ Rust ä¸­æ™ºèƒ½æŒ‡é’ˆå’Œæ™®é€šèƒ–æŒ‡é’ˆçš„åŒºåˆ«**ã€‚

é‚£ä¹ˆåˆæœ‰ä¸€ä¸ªé—®é¢˜äº†ï¼Œæ™ºèƒ½æŒ‡é’ˆå’Œç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬çŸ¥é“ï¼ŒString æ˜¯ç”¨ç»“æ„ä½“å®šä¹‰çš„ï¼š

```rust
pub struct String {
    vec: Vec<u8>,
}
```

å’Œæ™®é€šçš„ç»“æ„ä½“ä¸åŒçš„æ˜¯ï¼ŒString å®ç°äº† Deref å’Œ DerefMutï¼Œè¿™ä½¿å¾—å®ƒåœ¨è§£å¼•ç”¨çš„æ—¶å€™ï¼Œä¼šå¾—åˆ° &amp;strï¼Œçœ‹ä¸‹é¢çš„[æ ‡å‡†åº“çš„å®ç°](https://doc.rust-lang.org/src/alloc/string.rs.html#2301-2316)ï¼š

```rust
impl ops::Deref for String {
    type Target = str;

    fn deref(&self) -> &str {
        unsafe { str::from_utf8_unchecked(&self.vec) }
    }
}

impl ops::DerefMut for String {
    fn deref_mut(&mut self) -> &mut str {
        unsafe { str::from_utf8_unchecked_mut(&mut *self.vec) }
    }
}
```

å¦å¤–ï¼Œç”±äºåœ¨å †ä¸Šåˆ†é…äº†æ•°æ®ï¼ŒString è¿˜éœ€è¦ä¸ºå…¶åˆ†é…çš„èµ„æºåšç›¸åº”çš„å›æ”¶ã€‚è€Œ String å†…éƒ¨ä½¿ç”¨äº† Vec&lt;u8&gt;ï¼Œæ‰€ä»¥å®ƒå¯ä»¥ä¾èµ– Vec&lt;T&gt; çš„èƒ½åŠ›æ¥é‡Šæ”¾å †å†…å­˜ã€‚ä¸‹é¢æ˜¯æ ‡å‡†åº“ä¸­ Vec&lt;T&gt; çš„ [Drop trait çš„å®ç°](https://doc.rust-lang.org/src/alloc/vec/mod.rs.html#2710-2720)ï¼š

```rust
unsafe impl<#[may_dangle] T, A: Allocator> Drop for Vec<T, A> {
    fn drop(&mut self) {
        unsafe {
            // use drop for [T]
            // use a raw slice to refer to the elements of the vector as weakest necessary type;
            // could avoid questions of validity in certain cases
            ptr::drop_in_place(ptr::slice_from_raw_parts_mut(self.as_mut_ptr(), self.len))
        }
        // RawVec handles deallocation
    }
}
```

æ‰€ä»¥å†æ¸…æ™°ä¸€ä¸‹å®šä¹‰ï¼Œ**åœ¨ Rust ä¸­ï¼Œå‡¡æ˜¯éœ€è¦åšèµ„æºå›æ”¶çš„æ•°æ®ç»“æ„ï¼Œä¸”å®ç°äº† Deref/DerefMut/Dropï¼Œéƒ½æ˜¯æ™ºèƒ½æŒ‡é’ˆ**ã€‚

æŒ‰ç…§è¿™ä¸ªå®šä¹‰ï¼Œé™¤äº† Stringï¼Œåœ¨ä¹‹å‰çš„è¯¾ç¨‹ä¸­æˆ‘ä»¬é‡åˆ°äº†å¾ˆå¤šæ™ºèƒ½æŒ‡é’ˆï¼Œæ¯”å¦‚ç”¨äºåœ¨å †ä¸Šåˆ†é…å†…å­˜çš„ Box&lt;T&gt; å’Œ Vec&lt;T&gt;ã€ç”¨äºå¼•ç”¨è®¡æ•°çš„ Rc&lt;T&gt; å’Œ Arc&lt;T&gt; ã€‚å¾ˆå¤šå…¶ä»–æ•°æ®ç»“æ„ï¼Œå¦‚ PathBufã€Cow&lt;'a, B&gt;ã€MutexGuard&lt;T&gt;ã€RwLockReadGuard&lt;T&gt; å’Œ RwLockWriteGuard ç­‰ä¹Ÿæ˜¯æ™ºèƒ½æŒ‡é’ˆã€‚

ä»Šå¤©æˆ‘ä»¬å°±æ·±å…¥åˆ†æä¸‰ä¸ªä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆçš„æ•°æ®ç»“æ„ï¼šåœ¨å †ä¸Šåˆ›å»ºå†…å­˜çš„ Box&lt;T&gt;ã€æä¾›å†™æ—¶å…‹éš†çš„ Cow&lt;'a, B&gt;ï¼Œä»¥åŠç”¨äºæ•°æ®åŠ é”çš„ MutexGuard&lt;T&gt;ã€‚

è€Œä¸”æœ€åæˆ‘ä»¬ä¼šå°è¯•å®ç°è‡ªå·±çš„æ™ºèƒ½æŒ‡é’ˆã€‚å¸Œæœ›å­¦å®Œåä½ ä¸ä½†èƒ½æ›´å¥½åœ°ç†è§£æ™ºèƒ½æŒ‡é’ˆï¼Œè¿˜èƒ½åœ¨éœ€è¦çš„æ—¶å€™ï¼Œæ„å»ºè‡ªå·±çš„æ™ºèƒ½æŒ‡é’ˆæ¥è§£å†³é—®é¢˜ã€‚

## Box&lt;T&gt;

æˆ‘ä»¬å…ˆçœ‹ Box&lt;T&gt;ï¼Œå®ƒæ˜¯ Rust ä¸­æœ€åŸºæœ¬çš„åœ¨å †ä¸Šåˆ†é…å†…å­˜çš„æ–¹å¼ï¼Œç»å¤§å¤šæ•°å…¶å®ƒåŒ…å«å †å†…å­˜åˆ†é…çš„æ•°æ®ç±»å‹ï¼Œå†…éƒ¨éƒ½æ˜¯é€šè¿‡ Box&lt;T&gt; å®Œæˆçš„ï¼Œæ¯”å¦‚ Vec&lt;T&gt;ã€‚

ä¸ºä»€ä¹ˆæœ‰Box&lt;T&gt;çš„è®¾è®¡ï¼Œæˆ‘ä»¬å¾—å…ˆå›å¿†ä¸€ä¸‹åœ¨ C è¯­è¨€ä¸­ï¼Œå †å†…å­˜æ˜¯æ€ä¹ˆåˆ†é…çš„ã€‚

C éœ€è¦ä½¿ç”¨ malloc/calloc/realloc/free æ¥å¤„ç†å†…å­˜çš„åˆ†é…ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œè¢«åˆ†é…å‡ºæ¥çš„å†…å­˜åœ¨å‡½æ•°è°ƒç”¨ä¸­æ¥æ¥å›å›ä½¿ç”¨ï¼Œå¯¼è‡´è°åº”è¯¥è´Ÿè´£é‡Šæ”¾è¿™ä»¶äº‹æƒ…å¾ˆéš¾ç¡®å®šï¼Œç»™å¼€å‘è€…é€ æˆäº†æå¤§çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚

C++ åœ¨æ­¤åŸºç¡€ä¸Šæ”¹è¿›äº†ä¸€ä¸‹ï¼Œæä¾›äº†ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆ [unique\_ptr](https://en.cppreference.com/w/cpp/memory/unique_ptr)ï¼Œå¯ä»¥åœ¨æŒ‡é’ˆé€€å‡ºä½œç”¨åŸŸçš„æ—¶å€™é‡Šæ”¾å †å†…å­˜ï¼Œè¿™æ ·ä¿è¯äº†å †å†…å­˜çš„å•ä¸€æ‰€æœ‰æƒã€‚è¿™ä¸ª unique\_ptr å°±æ˜¯ Rust çš„ Box&lt;T&gt; çš„å‰èº«ã€‚

ä½ çœ‹ Box&lt;T&gt; çš„å®šä¹‰é‡Œï¼Œå†…éƒ¨å°±æ˜¯ä¸€ä¸ª [Unique&lt;T&gt;](https://doc.rust-lang.org/src/core/ptr/unique.rs.html#36-44) ç”¨äºè‡´æ•¬ C++ï¼ŒUnique&lt;T&gt; æ˜¯ä¸€ä¸ªç§æœ‰çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œå®ƒåŒ…è£¹äº†ä¸€ä¸ª \*const T æŒ‡é’ˆï¼Œå¹¶å”¯ä¸€æ‹¥æœ‰è¿™ä¸ªæŒ‡é’ˆã€‚

```rust
pub struct Unique<T: ?Sized> {
    pointer: *const T,
    // NOTE: this marker has no consequences for variance, but is necessary
    // for dropck to understand that we logically own a `T`.
    //
    // For details, see:
    // https://github.com/rust-lang/rfcs/blob/master/text/0769-sound-generic-drop.md#phantom-data
    _marker: PhantomData<T>,
}
```

æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œéœ€è¦ä½¿ç”¨å†…å­˜åˆ†é…å™¨ï¼ˆAllocatorï¼‰ã€‚å¦‚æœä½ ä¸Šè¿‡æ“ä½œç³»ç»Ÿè¯¾ç¨‹ï¼Œåº”è¯¥è¿˜è®°å¾—ä¸€ä¸ªç®€å•çš„ [buddy system](https://en.wikipedia.org/wiki/Buddy_memory_allocation) æ˜¯å¦‚ä½•åˆ†é…å’Œç®¡ç†å †å†…å­˜çš„ã€‚

è®¾è®¡å†…å­˜åˆ†é…å™¨çš„ç›®çš„é™¤äº†ä¿è¯æ­£ç¡®æ€§ä¹‹å¤–ï¼Œå°±æ˜¯ä¸ºäº†æœ‰æ•ˆåœ°åˆ©ç”¨å‰©ä½™å†…å­˜ï¼Œå¹¶æ§åˆ¶å†…å­˜åœ¨åˆ†é…å’Œé‡Šæ”¾è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç¢ç‰‡çš„æ•°é‡ã€‚åœ¨å¤šæ ¸ç¯å¢ƒä¸‹ï¼Œå®ƒè¿˜è¦èƒ½å¤Ÿé«˜æ•ˆåœ°å¤„ç†å¹¶å‘è¯·æ±‚ã€‚ï¼ˆå¦‚æœä½ å¯¹é€šç”¨å†…å­˜åˆ†é…å™¨æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹å‚è€ƒèµ„æ–™ï¼‰

å †ä¸Šåˆ†é…å†…å­˜çš„ Box&lt;T&gt; å…¶å®æœ‰ä¸€ä¸ªç¼ºçœçš„æ³›å‹å‚æ•° Aï¼Œå°±éœ€è¦æ»¡è¶³ [Allocator trait](https://doc.rust-lang.org/std/alloc/trait.Allocator.html)ï¼Œå¹¶ä¸”é»˜è®¤æ˜¯ Globalï¼š

```rust
pub struct Box<T: ?Sized,A: Allocator = Global>(Unique<T>, A)
```

Allocator trait æä¾›å¾ˆå¤šæ–¹æ³•ï¼š

- allocateæ˜¯ä¸»è¦æ–¹æ³•ï¼Œç”¨äºåˆ†é…å†…å­˜ï¼Œå¯¹åº” C çš„ malloc/callocï¼›
- deallocateï¼Œç”¨äºé‡Šæ”¾å†…å­˜ï¼Œå¯¹åº” C çš„ freeï¼›
- è¿˜æœ‰ grow / shrinkï¼Œç”¨æ¥æ‰©å¤§æˆ–ç¼©å°å †ä¸Šå·²åˆ†é…çš„å†…å­˜ï¼Œå¯¹åº” C çš„ reallocã€‚

è¿™é‡Œå¯¹ Allocator trait æˆ‘ä»¬å°±ä¸è¯¦ç»†ä»‹ç»äº†ï¼Œå¦‚æœä½ æƒ³æ›¿æ¢é»˜è®¤çš„å†…å­˜åˆ†é…å™¨ï¼Œå¯ä»¥ä½¿ç”¨ #\[global\_allocator] æ ‡è®°å®ï¼Œå®šä¹‰ä½ è‡ªå·±çš„å…¨å±€åˆ†é…å™¨ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•åœ¨ Rust ä¸‹ä½¿ç”¨ [jemalloc](https://crates.io/crates/jemallocator)ï¼š

```rust
use jemallocator::Jemalloc;

#[global_allocator]
static GLOBAL: Jemalloc = Jemalloc;

fn main() {}
```

è¿™æ ·è®¾ç½®ä¹‹åï¼Œä½ ä½¿ç”¨ Box::new() åˆ†é…çš„å†…å­˜å°±æ˜¯ jemalloc åˆ†é…å‡ºæ¥çš„äº†ã€‚å¦å¤–ï¼Œå¦‚æœä½ æƒ³æ’°å†™è‡ªå·±çš„å…¨å±€åˆ†é…å™¨ï¼Œå¯ä»¥å®ç° [GlobalAlloc trait](https://doc.rust-lang.org/std/alloc/trait.GlobalAlloc.html)ï¼Œå®ƒå’Œ Allocator trait çš„åŒºåˆ«ï¼Œä¸»è¦åœ¨äºæ˜¯å¦å…è®¸åˆ†é…é•¿åº¦ä¸ºé›¶çš„å†…å­˜ã€‚

### ä½¿ç”¨åœºæ™¯

ä¸‹é¢æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªè‡ªå·±çš„å†…å­˜åˆ†é…å™¨ã€‚åˆ«æ‹…å¿ƒï¼Œè¿™é‡Œå°±æ˜¯æƒ³ debug ä¸€ä¸‹ï¼Œçœ‹çœ‹å†…å­˜å¦‚ä½•åˆ†é…å’Œé‡Šæ”¾ï¼Œå¹¶ä¸ä¼šå®é™…å®ç°æŸä¸ªåˆ†é…ç®—æ³•ã€‚

é¦–å…ˆçœ‹å†…å­˜çš„åˆ†é…ã€‚è¿™é‡Œ MyAllocator å°±ç”¨ System allocatorï¼Œç„¶ååŠ  eprintln!()ï¼Œå’Œæˆ‘ä»¬å¸¸ç”¨çš„ println!() ä¸åŒçš„æ˜¯ï¼Œeprintln!() å°†æ•°æ®æ‰“å°åˆ° stderrï¼ˆ[ä»£ç ](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=ca0ae6821e08e16609b1e10ac743e6c9)ï¼‰ï¼š

```rust
use std::alloc::{GlobalAlloc, Layout, System};

struct MyAllocator;

unsafe impl GlobalAlloc for MyAllocator {
    unsafe fn alloc(&self, layout: Layout) -> *mut u8 {
        let data = System.alloc(layout);
        eprintln!("ALLOC: {:p}, size {}", data, layout.size());
        data
    }

    unsafe fn dealloc(&self, ptr: *mut u8, layout: Layout) {
        System.dealloc(ptr, layout);
        eprintln!("FREE: {:p}, size {}", ptr, layout.size());
    }
}

#[global_allocator]
static GLOBAL: MyAllocator = MyAllocator;

#[allow(dead_code)]
struct Matrix {
    // ä½¿ç”¨ä¸è§„åˆ™çš„æ•°å­—å¦‚ 505 å¯ä»¥è®© dbg! çš„æ‰“å°å¾ˆå®¹æ˜“åˆ†è¾¨å‡ºæ¥
    data: [u8; 505],
}

impl Default for Matrix {
    fn default() -> Self {
        Self { data: [0; 505] }
    }
}

fn main() {
    // åœ¨è¿™å¥æ‰§è¡Œä¹‹å‰å·²ç»æœ‰å¥½å¤šå†…å­˜åˆ†é…
    let data = Box::new(Matrix::default());

    // è¾“å‡ºä¸­æœ‰ä¸€ä¸ª 1024 å¤§å°çš„å†…å­˜åˆ†é…ï¼Œæ˜¯ println! å¯¼è‡´çš„
    println!(
        "!!! allocated memory: {:p}, len: {}",
        &*data,
        std::mem::size_of::<Matrix>()
    );

    // data åœ¨è¿™é‡Œ dropï¼Œå¯ä»¥åœ¨æ‰“å°ä¸­çœ‹åˆ° FREE
    // ä¹‹åè¿˜æœ‰å¾ˆå¤šå…¶å®ƒå†…å­˜è¢«é‡Šæ”¾
}
```

æ³¨æ„è¿™é‡Œä¸èƒ½ä½¿ç”¨ println!() ã€‚å› ä¸º stdout ä¼šæ‰“å°åˆ°ä¸€ä¸ªç”± Mutex äº’æ–¥é”ä¿æŠ¤çš„å…±äº«å…¨å±€ buffer ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šæ¶‰åŠå†…å­˜çš„åˆ†é…ï¼Œåˆ†é…çš„å†…å­˜åˆä¼šè§¦å‘ println!()ï¼Œæœ€ç»ˆé€ æˆç¨‹åºå´©æºƒã€‚è€Œ eprintln! ç›´æ¥æ‰“å°åˆ° stderrï¼Œä¸ä¼š bufferã€‚

è¿è¡Œè¿™æ®µä»£ç ï¼Œä½ å¯ä»¥çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹è¾“å‡ºï¼Œå…¶ä¸­ 505 å¤§å°çš„å†…å­˜æ˜¯æˆ‘ä»¬ Box::new() å‡ºæ¥çš„ï¼š

```bash
â¯ cargo run --bin allocator --quiet
ALLOC: 0x7fbe0dc05c20, size 4
ALLOC: 0x7fbe0dc05c30, size 5
FREE: 0x7fbe0dc05c20, size 4
ALLOC: 0x7fbe0dc05c40, size 64
ALLOC: 0x7fbe0dc05c80, size 48
ALLOC: 0x7fbe0dc05cb0, size 80
ALLOC: 0x7fbe0dc05da0, size 24
ALLOC: 0x7fbe0dc05dc0, size 64
ALLOC: 0x7fbe0dc05e00, size 505
ALLOC: 0x7fbe0e008800, size 1024
!!! allocated memory: 0x7fbe0dc05e00, len: 505
FREE: 0x7fbe0dc05e00, size 505
FREE: 0x7fbe0e008800, size 1024
FREE: 0x7fbe0dc05c30, size 5
FREE: 0x7fbe0dc05c40, size 64
FREE: 0x7fbe0dc05c80, size 48
FREE: 0x7fbe0dc05cb0, size 80
FREE: 0x7fbe0dc05dc0, size 64
FREE: 0x7fbe0dc05da0, size 24
```

åœ¨ä½¿ç”¨ Box åˆ†é…å †å†…å­˜çš„æ—¶å€™è¦æ³¨æ„ï¼ŒBox::new() æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥ä¼ å…¥å®ƒçš„æ•°æ®ä¼šå‡ºç°åœ¨æ ˆä¸Šï¼Œå†ç§»åŠ¨åˆ°å †ä¸Šã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬çš„ Matrix ç»“æ„ä¸æ˜¯ 505 ä¸ªå­—èŠ‚ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å¤§çš„ç»“æ„ï¼Œå°±æœ‰å¯èƒ½å‡ºé—®é¢˜ã€‚

æ¯”å¦‚ä¸‹é¢çš„ä»£ç æƒ³åœ¨å †ä¸Šåˆ†é… 16M å†…å­˜ï¼Œå¦‚æœä½ åœ¨ playground é‡Œè¿è¡Œï¼Œç›´æ¥æ ˆæº¢å‡º stack overflowï¼ˆ[ä»£ç ](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=4aa8e21e6da6b572dae2ad8d68787e1e)ï¼‰ï¼š

```rust
fn main() {
    // åœ¨å †ä¸Šåˆ†é… 16M å†…å­˜ï¼Œä½†å®ƒä¼šç°åœ¨æ ˆä¸Šå‡ºç°ï¼Œå†ç§»åŠ¨åˆ°å †ä¸Š
    let boxed = Box::new([0u8; 1 << 24]);
    println!("len: {}", boxed.len());
}
```

ä½†å¦‚æœä½ åœ¨æœ¬åœ°ä½¿ç”¨ â€œcargo run â€”releaseâ€ ç¼–è¯‘æˆ release ä»£ç è¿è¡Œï¼Œä¼šæ­£å¸¸æ‰§è¡Œï¼

è¿™æ˜¯å› ä¸º â€œcargo runâ€ æˆ–è€…åœ¨ playground ä¸‹è¿è¡Œï¼Œé»˜è®¤æ˜¯ debug buildï¼Œå®ƒä¸ä¼šåšä»»ä½• inline çš„ä¼˜åŒ–ï¼Œè€Œ Box::new() çš„å®ç°å°±ä¸€è¡Œä»£ç ï¼Œå¹¶æ³¨æ˜äº†è¦ inlineï¼Œåœ¨ release æ¨¡å¼ä¸‹ï¼Œè¿™ä¸ªå‡½æ•°è°ƒç”¨ä¼šè¢«ä¼˜åŒ–æ‰ï¼š

```rust
#[cfg(not(no_global_oom_handling))]
#[inline(always)]
#[doc(alias = "alloc")]
#[doc(alias = "malloc")]
#[stable(feature = "rust1", since = "1.0.0")]
pub fn new(x: T) -> Self {
    box x
}
```

å¦‚æœä¸ inlineï¼Œæ•´ä¸ª 16M çš„å¤§æ•°ç»„ä¼šé€šè¿‡æ ˆå†…å­˜ä¼ é€’ç»™ Box::newï¼Œå¯¼è‡´æ ˆæº¢å‡ºã€‚è¿™é‡Œæˆ‘ä»¬æƒŠå–œåœ°å‘ç°äº†ä¸€ä¸ªæ–°çš„å…³é”®å­— boxã€‚ç„¶è€Œ box æ˜¯ Rust å†…éƒ¨çš„å…³é”®å­—ï¼Œç”¨æˆ·ä»£ç æ— æ³•è°ƒç”¨ï¼Œå®ƒåªå‡ºç°åœ¨ Rust ä»£ç ä¸­ï¼Œç”¨äºåˆ†é…å †å†…å­˜ï¼Œbox å…³é”®å­—åœ¨ç¼–è¯‘æ—¶ï¼Œä¼šä½¿ç”¨å†…å­˜åˆ†é…å™¨åˆ†é…å†…å­˜ã€‚

ææ˜ç™½ Box&lt;T&gt; çš„å†…å­˜åˆ†é…ï¼Œæˆ‘ä»¬è¿˜å¾ˆå…³å¿ƒå†…å­˜æ˜¯å¦‚ä½•é‡Šæ”¾çš„ï¼Œæ¥çœ‹å®ƒå®ç°çš„ Drop traitï¼š

```rust
#[stable(feature = "rust1", since = "1.0.0")]
unsafe impl<#[may_dangle] T: ?Sized, A: Allocator> Drop for Box<T, A> {
    fn drop(&mut self) {
        // FIXME: Do nothing, drop is currently performed by compiler.
    }
}
```

å“ˆï¼Œç›®å‰ drop trait ä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ’å…¥ deallocate çš„ä»£ç ã€‚è¿™æ˜¯ Rust è¯­è¨€çš„ä¸€ç§ç­–ç•¥ï¼š**åœ¨å…·ä½“å®ç°è¿˜æ²¡æœ‰ç¨³å®šä¸‹æ¥ä¹‹å‰ï¼Œæˆ‘å…ˆæŠŠæ¥å£ç¨³å®šï¼Œå®ç°éšç€ä¹‹åçš„è¿­ä»£æ…¢æ…¢ç¨³å®š**ã€‚

è¿™æ ·å¯ä»¥æå¤§åœ°é¿å…è¯­è¨€åœ¨å‘å±•çš„è¿‡ç¨‹ä¸­ï¼Œå¼•å…¥å¯¹å¼€å‘è€…è€Œè¨€çš„ç ´åæ€§æ›´æ–°ï¼ˆbreaking changeï¼‰ã€‚ç ´åæ€§æ›´æ–°ä¼šä½¿å¾—å¼€å‘è€…åœ¨å‡çº§è¯­è¨€çš„ç‰ˆæœ¬æ—¶ï¼Œä¸å¾—ä¸å¤§å¹…æ›´æ”¹åŸæœ‰ä»£ç ã€‚

Python æ˜¯ä¸ªå‰è½¦ä¹‹é‰´ï¼Œç”±äºå¼•å…¥äº†å¤§é‡çš„ç ´åæ€§æ›´æ–°ï¼ŒPython 2 åˆ° 3 çš„å‡çº§èŠ±äº†åå¤šå¹´æ‰æ…¢æ…¢å®Œæˆã€‚æ‰€ä»¥ Rust åœ¨è®¾è®¡æ¥å£æ—¶éå¸¸è°¨æ…ï¼Œå¾ˆå¤šé‡è¦çš„æ¥å£éƒ½å…ˆä»¥åº“çš„å½¢å¼å­˜åœ¨äº†å¾ˆä¹…ï¼Œæœ€ç»ˆæ‰æˆä¸ºæ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†ï¼Œæ¯”å¦‚ Future traitã€‚ä¸€æ—¦æ¥å£ç¨³å®šåï¼Œå†…éƒ¨çš„å®ç°å¯ä»¥æ…¢æ…¢ç¨³å®šã€‚

## Cow&lt;'a, B&gt;

äº†è§£äº† Box çš„å·¥ä½œåŸç†åï¼Œå†æ¥çœ‹ Cow&lt;'a, B&gt;çš„åŸç†å’Œä½¿ç”¨åœºæ™¯ï¼Œï¼ˆ[ç¬¬12è®²](https://time.geekbang.org/column/article/420021)ï¼‰è®²æ³›å‹æ•°æ®ç»“æ„çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç®€å•è®²è¿‡å‚æ•°Bçš„ä¸‰ä¸ªçº¦æŸã€‚

Cow æ˜¯ Rust ä¸‹ç”¨äºæä¾›å†™æ—¶å…‹éš†ï¼ˆClone-on-Writeï¼‰çš„ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒè·Ÿè™šæ‹Ÿå†…å­˜ç®¡ç†çš„å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-writeï¼‰æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼š**åŒ…è£¹ä¸€ä¸ªåªè¯»å€Ÿç”¨ï¼Œä½†å¦‚æœè°ƒç”¨è€…éœ€è¦æ‰€æœ‰æƒæˆ–è€…éœ€è¦ä¿®æ”¹å†…å®¹ï¼Œé‚£ä¹ˆå®ƒä¼š clone å€Ÿç”¨çš„æ•°æ®**ã€‚

æˆ‘ä»¬çœ‹Cowçš„å®šä¹‰ï¼š

```rust
pub enum Cow<'a, B> where B: 'a + ToOwned + ?Sized {
  Borrowed(&'a B),
  Owned(<B as ToOwned>::Owned),
}
```

å®ƒæ˜¯ä¸€ä¸ª enumï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªå¯¹ç±»å‹ B çš„åªè¯»å¼•ç”¨ï¼Œæˆ–è€…åŒ…å«å¯¹ç±»å‹ B çš„æ‹¥æœ‰æ‰€æœ‰æƒçš„æ•°æ®ã€‚

è¿™é‡Œåˆå¼•å…¥äº†ä¸¤ä¸ª traitï¼Œé¦–å…ˆæ˜¯ ToOwnedï¼Œåœ¨ ToOwned trait å®šä¹‰çš„æ—¶å€™ï¼Œåˆå¼•å…¥äº† Borrow traitï¼Œå®ƒä»¬éƒ½æ˜¯ [std::borrow](https://doc.rust-lang.org/std/borrow/index.html) ä¸‹çš„ traitï¼š

```rust
pub trait ToOwned {
    type Owned: Borrow<Self>;
    #[must_use = "cloning is often expensive and is not expected to have side effects"]
    fn to_owned(&self) -> Self::Owned;

    fn clone_into(&self, target: &mut Self::Owned) { ... }
}

pub trait Borrow<Borrowed> where Borrowed: ?Sized {
    fn borrow(&self) -> &Borrowed;
}
```

å¦‚æœä½ çœ‹ä¸æ‡‚è¿™æ®µä»£ç ï¼Œä¸è¦ç€æ€¥ï¼Œæƒ³è¦ç†è§£ Cow traitï¼ŒToOwned trait æ˜¯ä¸€é“åï¼Œå› ä¸º type Owned: Borrow&lt;Self&gt; ä¸å¥½ç†è§£ï¼Œè€ä¸‹å¿ƒæ¥æˆ‘ä»¬æ‹†å¼€ä¸€ç‚¹ç‚¹è§£è¯»ã€‚

é¦–å…ˆï¼Œtype Owned: Borrow&lt;Self&gt; æ˜¯ä¸€ä¸ªå¸¦æœ‰å…³è”ç±»å‹çš„ trait ï¼Œå¦‚æœä½ å¯¹è¿™ä¸ªçŸ¥è¯†ç‚¹æœ‰äº›é—å¿˜ï¼Œå¯ä»¥å†å¤ä¹ ä¸€ä¸‹[ç¬¬ 13 è®²](https://time.geekbang.org/column/article/420028)ã€‚è¿™é‡Œ Owned æ˜¯å…³è”ç±»å‹ï¼Œéœ€è¦ä½¿ç”¨è€…å®šä¹‰ï¼Œå’Œæˆ‘ä»¬ä¹‹å‰ä»‹ç»çš„å…³è”ç±»å‹ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œ Owned ä¸èƒ½æ˜¯ä»»æ„ç±»å‹ï¼Œå®ƒå¿…é¡»æ»¡è¶³ Borrow&lt;T&gt; traitã€‚ä¾‹å¦‚æˆ‘ä»¬çœ‹ [str å¯¹ ToOwned trait çš„å®ç°](https://doc.rust-lang.org/src/alloc/str.rs.html#215-227)ï¼š

```rust
impl ToOwned for str {
    type Owned = String;
    #[inline]
    fn to_owned(&self) -> String {
        unsafe { String::from_utf8_unchecked(self.as_bytes().to_owned()) }
    }

    fn clone_into(&self, target: &mut String) {
        let mut b = mem::take(target).into_bytes();
        self.as_bytes().clone_into(&mut b);
        *target = unsafe { String::from_utf8_unchecked(b) }
    }
}
```

å¯ä»¥çœ‹åˆ°å…³è”ç±»å‹ Owned è¢«å®šä¹‰ä¸º Stringï¼Œè€Œæ ¹æ®è¦æ±‚ï¼ŒString å¿…é¡»å®šä¹‰ Borrow&lt;T&gt;ï¼Œé‚£è¿™é‡Œ Borrow&lt;T&gt; é‡Œçš„æ³›å‹å˜é‡ T æ˜¯è°å‘¢ï¼Ÿ

ToOwned è¦æ±‚æ˜¯ Borrow&lt;Self&gt;ï¼Œè€Œæ­¤åˆ»å®ç° ToOwned çš„ä¸»ä½“æ˜¯ strï¼Œæ‰€ä»¥ Borrow&lt;Self&gt; æ˜¯ Borrow&lt;str&gt;ï¼Œä¹Ÿå°±æ˜¯è¯´ String è¦å®ç° Borrow&lt;str&gt;ï¼Œæˆ‘ä»¬çœ‹[æ–‡æ¡£](https://doc.rust-lang.org/std/string/struct.String.html#impl-Borrow%3Cstr%3E)ï¼Œå®ƒçš„ç¡®[å®ç°äº†è¿™ä¸ª trait](https://doc.rust-lang.org/src/alloc/str.rs.html#198-203)ï¼š

```rust
impl Borrow<str> for String {
    #[inline]
    fn borrow(&self) -> &str {
        &self[..]
    }
}
```

ä½ æ˜¯ä¸æ˜¯æœ‰ç‚¹æ™•äº†ï¼Œæˆ‘ç”¨ä¸€å¼ å›¾æ¢³ç†äº†è¿™å‡ ä¸ª trait ä¹‹é—´çš„å…³ç³»ï¼š  
![](https://static001.geekbang.org/resource/image/ay/52/ayyc5f85c3d9897ddd1acd4c067a5852.jpg?wh=3248x2012)

é€šè¿‡è¿™å¼ å›¾ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°ææ¸…æ¥š Cow å’Œ ToOwned / Borrow&lt;T&gt; ä¹‹é—´çš„å…³ç³»ã€‚

è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šç–‘æƒ‘ï¼Œä¸ºä½• Borrow è¦å®šä¹‰æˆä¸€ä¸ªæ³›å‹ trait å‘¢ï¼Ÿæè¿™ä¹ˆå¤æ‚ï¼Œéš¾é“ä¸€ä¸ªç±»å‹è¿˜å¯ä»¥è¢«å€Ÿç”¨æˆä¸åŒçš„å¼•ç”¨ä¹ˆï¼Ÿ

æ˜¯çš„ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼ˆ[ä»£ç ](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=36831f05a3e27690beac9fd5beb5b524)ï¼‰ï¼š

```rust
use std::borrow::Borrow;

fn main() {
    let s = "hello world!".to_owned();

    // è¿™é‡Œå¿…é¡»å£°æ˜ç±»å‹ï¼Œå› ä¸º String æœ‰å¤šä¸ª Borrow<T> å®ç°
    // å€Ÿç”¨ä¸º &String
    let r1: &String = s.borrow();
    // å€Ÿç”¨ä¸º &str
    let r2: &str = s.borrow();

    println!("r1: {:p}, r2: {:p}", r1, r2);
}
```

åœ¨è¿™é‡Œä¾‹å­é‡Œï¼ŒString å¯ä»¥è¢«å€Ÿç”¨ä¸º &amp;Stringï¼Œä¹Ÿå¯ä»¥è¢«å€Ÿç”¨ä¸º &amp;strã€‚

å¥½ï¼Œå†æ¥ç»§ç»­çœ‹ Cowã€‚æˆ‘ä»¬è¯´å®ƒæ˜¯æ™ºèƒ½æŒ‡é’ˆï¼Œé‚£å®ƒè‡ªç„¶éœ€è¦[å®ç° Deref trait](https://doc.rust-lang.org/src/alloc/borrow.rs.html#332-341)ï¼š

```rust
impl<B: ?Sized + ToOwned> Deref for Cow<'_, B> {
    type Target = B;

    fn deref(&self) -> &B {
        match *self {
            Borrowed(borrowed) => borrowed,
            Owned(ref owned) => owned.borrow(),
        }
    }
}
```

å®ç°çš„åŸç†å¾ˆç®€å•ï¼Œæ ¹æ® self æ˜¯ Borrowed è¿˜æ˜¯ Ownedï¼Œæˆ‘ä»¬åˆ†åˆ«å–å…¶å†…å®¹ï¼Œç”Ÿæˆå¼•ç”¨ï¼š

- å¯¹äº Borrowedï¼Œç›´æ¥å°±æ˜¯å¼•ç”¨ï¼›
- å¯¹äº Ownedï¼Œè°ƒç”¨å…¶ borrow() æ–¹æ³•ï¼Œè·å¾—å¼•ç”¨ã€‚

è¿™å°±å¾ˆå‰å®³äº†ã€‚è™½ç„¶ Cow æ˜¯ä¸€ä¸ª enumï¼Œä½†æ˜¯é€šè¿‡ Deref çš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—ç»Ÿä¸€çš„ä½“éªŒï¼Œæ¯”å¦‚ Cow&lt;str&gt;ï¼Œä½¿ç”¨çš„æ„Ÿè§‰å’Œ &amp;str / String æ˜¯åŸºæœ¬ä¸€è‡´çš„ã€‚æ³¨æ„ï¼Œ**è¿™ç§æ ¹æ® enum çš„ä¸åŒçŠ¶æ€æ¥è¿›è¡Œç»Ÿä¸€åˆ†å‘çš„æ–¹æ³•æ˜¯ç¬¬ä¸‰ç§åˆ†å‘æ‰‹æ®µ**ï¼Œä¹‹å‰è®²è¿‡å¯ä»¥ä½¿ç”¨æ³›å‹å‚æ•°åšé™æ€åˆ†å‘å’Œä½¿ç”¨ trait object åšåŠ¨æ€åˆ†å‘ã€‚

### ä½¿ç”¨åœºæ™¯

é‚£ä¹ˆ Cow æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿæ˜¾ç„¶ï¼Œå®ƒå¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™æ‰è¿›è¡Œå†…å­˜çš„åˆ†é…å’Œæ‹·è´ï¼Œåœ¨å¾ˆå¤šåº”ç”¨åœºåˆï¼Œå®ƒå¯ä»¥å¤§å¤§æå‡ç³»ç»Ÿçš„æ•ˆç‡ã€‚å¦‚æœ Cow&lt;'a, B&gt; ä¸­çš„ Owned æ•°æ®ç±»å‹æ˜¯ä¸€ä¸ªéœ€è¦åœ¨å †ä¸Šåˆ†é…å†…å­˜çš„ç±»å‹ï¼Œå¦‚ Stringã€Vec&lt;T&gt; ç­‰ï¼Œè¿˜èƒ½å‡å°‘å †å†…å­˜åˆ†é…çš„æ¬¡æ•°ã€‚

æˆ‘ä»¬è¯´è¿‡ï¼Œç›¸å¯¹äºæ ˆå†…å­˜çš„åˆ†é…é‡Šæ”¾æ¥è¯´ï¼Œå †å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾æ•ˆç‡è¦ä½å¾ˆå¤šï¼Œå…¶å†…éƒ¨è¿˜æ¶‰åŠç³»ç»Ÿè°ƒç”¨å’Œé”ï¼Œ**å‡å°‘ä¸å¿…è¦çš„å †å†…å­˜åˆ†é…æ˜¯æå‡ç³»ç»Ÿæ•ˆç‡çš„å…³é”®æ‰‹æ®µ**ã€‚è€Œ Rust çš„ Cow&lt;'a, B&gt;ï¼Œåœ¨å¸®åŠ©ä½ è¾¾æˆè¿™ä¸ªæ•ˆæœçš„åŒæ—¶ï¼Œä½¿ç”¨ä½“éªŒè¿˜éå¸¸ç®€å•èˆ’æœã€‚

å…‰è¿™ä¹ˆè¯´æ²¡æœ‰ä»£ç ä½è¯ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸ªä½¿ç”¨ Cow çš„å®é™…ä¾‹å­ã€‚

åœ¨è§£æ URL çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å°† querystring ä¸­çš„å‚æ•°ï¼Œæå–æˆ KV pair æ¥è¿›ä¸€æ­¥ä½¿ç”¨ã€‚ç»å¤§å¤šæ•°è¯­è¨€ä¸­ï¼Œæå–å‡ºæ¥çš„ KV éƒ½æ˜¯æ–°çš„å­—ç¬¦ä¸²ï¼Œåœ¨æ¯ç§’é’Ÿå¤„ç†å‡ å k ç”šè‡³ä¸Šç™¾ k è¯·æ±‚çš„ç³»ç»Ÿä¸­ï¼Œä½ å¯ä»¥æƒ³è±¡è¿™ä¼šå¸¦æ¥å¤šå°‘æ¬¡å †å†…å­˜çš„åˆ†é…ã€‚

ä½†åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ Cow ç±»å‹è½»æ¾é«˜æ•ˆå¤„ç†å®ƒï¼Œåœ¨è¯»å– URL çš„è¿‡ç¨‹ä¸­ï¼š

- æ¯è§£æå‡ºä¸€ä¸ª key æˆ–è€… valueï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª &amp;str æŒ‡å‘ URL ä¸­ç›¸åº”çš„ä½ç½®ï¼Œç„¶åç”¨ Cow å°è£…å®ƒï¼›
- è€Œå½“è§£æå‡ºæ¥çš„å†…å®¹ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦ decode æ—¶ï¼Œæ¯”å¦‚ â€œhello%20worldâ€ï¼Œæˆ‘ä»¬å¯ä»¥ç”Ÿæˆä¸€ä¸ªè§£æåçš„ Stringï¼ŒåŒæ ·ç”¨ Cow å°è£…å®ƒã€‚

çœ‹ä¸‹é¢çš„ä¾‹å­ï¼ˆ[ä»£ç ](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=4a7ec8125238dfefc0b8b82f262c3eaf)ï¼‰ï¼š

```rust
use std::borrow::Cow;

use url::Url;
fn main() {
    let url = Url::parse("https://tyr.com/rust?page=1024&sort=desc&extra=hello%20world").unwrap();
    let mut pairs = url.query_pairs();

    assert_eq!(pairs.count(), 3);

    let (mut k, v) = pairs.next().unwrap();
    // å› ä¸º k, v éƒ½æ˜¯ Cow<str> ä»–ä»¬ç”¨èµ·æ¥æ„Ÿè§‰å’Œ &str æˆ–è€… String ä¸€æ ·
    // æ­¤åˆ»ï¼Œä»–ä»¬éƒ½æ˜¯ Borrowed
    println!("key: {}, v: {}", k, v);
    // å½“ä¿®æ”¹å‘ç”Ÿæ—¶ï¼Œk å˜æˆ Owned
    k.to_mut().push_str("_lala");

    print_pairs((k, v));

    print_pairs(pairs.next().unwrap());
    // åœ¨å¤„ç† extra=hello%20world æ—¶ï¼Œvalue è¢«å¤„ç†æˆ "hello world"
    // æ‰€ä»¥è¿™é‡Œ value æ˜¯ Owned
    print_pairs(pairs.next().unwrap());
}

fn print_pairs(pair: (Cow<str>, Cow<str>)) {
    println!("key: {}, value: {}", show_cow(pair.0), show_cow(pair.1));
}

fn show_cow(cow: Cow<str>) -> String {
    match cow {
        Cow::Borrowed(v) => format!("Borrowed {}", v),
        Cow::Owned(v) => format!("Owned {}", v),
    }
}
```

æ˜¯ä¸æ˜¯å¾ˆç®€æ´ã€‚

ç±»ä¼¼ URL parse è¿™æ ·çš„å¤„ç†æ–¹å¼ï¼Œåœ¨ Rust æ ‡å‡†åº“å’Œç¬¬ä¸‰æ–¹åº“ä¸­éå¸¸å¸¸è§ã€‚æ¯”å¦‚ Rust ä¸‹è‘—åçš„ [serde åº“](https://serde.rs/)ï¼Œå¯ä»¥éå¸¸é«˜æ•ˆåœ°å¯¹ Rust æ•°æ®ç»“æ„ï¼Œè¿›è¡Œåºåˆ—åŒ–/ååºåˆ—åŒ–æ“ä½œï¼Œå®ƒå¯¹ Cow å°±æœ‰å¾ˆå¥½çš„æ”¯æŒã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç å°†ä¸€ä¸ª JSON æ•°æ®ååºåˆ—åŒ–æˆ User ç±»å‹ï¼ŒåŒæ—¶è®© User ä¸­çš„ name ä½¿ç”¨ Cow æ¥å¼•ç”¨ JSON æ–‡æœ¬ä¸­çš„å†…å®¹ï¼ˆ[ä»£ç ](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=5154f27658e3853fb894b3de993d877c)ï¼‰ï¼š

```rust
use serde::Deserialize;
use std::borrow::Cow;

#[derive(Debug, Deserialize)]
struct User<'input> {
    #[serde(borrow)]
    name: Cow<'input, str>,
    age: u8,
}

fn main() {
    let input = r#"{ "name": "Tyr", "age": 18 }"#;
    let user: User = serde_json::from_str(input).unwrap();

    match user.name {
        Cow::Borrowed(x) => println!("borrowed {}", x),
        Cow::Owned(x) => println!("owned {}", x),
    }
}
```

æœªæ¥åœ¨ä½ ç”¨ Rust æ„é€ ç³»ç»Ÿæ—¶ï¼Œä¹Ÿå¯ä»¥å……åˆ†è€ƒè™‘åœ¨æ•°æ®ç±»å‹ä¸­ä½¿ç”¨ Cowã€‚

## MutexGuard&lt;T&gt;

å¦‚æœè¯´ï¼Œä¸Šé¢ä»‹ç»çš„ Stringã€Box&lt;T&gt;ã€Cow&lt;'a, B&gt; ç­‰æ™ºèƒ½æŒ‡é’ˆï¼Œéƒ½æ˜¯é€šè¿‡ Deref æ¥æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œé‚£ä¹ˆ MutexGuard&lt;T&gt; æ˜¯å¦å¤–ä¸€ç±»å¾ˆæœ‰æ„æ€çš„æ™ºèƒ½æŒ‡é’ˆï¼šå®ƒä¸ä½†é€šè¿‡ Deref æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œ**è¿˜é€šè¿‡ Drop trait æ¥ç¡®ä¿ï¼Œä½¿ç”¨åˆ°çš„å†…å­˜ä»¥å¤–çš„èµ„æºåœ¨é€€å‡ºæ—¶è¿›è¡Œé‡Šæ”¾**ã€‚

MutexGuard è¿™ä¸ªç»“æ„æ˜¯åœ¨è°ƒç”¨ [Mutex::lock](https://doc.rust-lang.org/src/std/sync/mutex.rs.html#279-284) æ—¶ç”Ÿæˆçš„ï¼š

```rust
pub fn lock(&self) -> LockResult<MutexGuard<'_, T>> {
    unsafe {
        self.inner.raw_lock();
        MutexGuard::new(self)
    }
}
```

é¦–å…ˆï¼Œå®ƒä¼šå–å¾—é”èµ„æºï¼Œå¦‚æœæ‹¿ä¸åˆ°ï¼Œä¼šåœ¨è¿™é‡Œç­‰å¾…ï¼›å¦‚æœæ‹¿åˆ°äº†ï¼Œä¼šæŠŠ Mutex ç»“æ„çš„å¼•ç”¨ä¼ é€’ç»™ MutexGuardã€‚

æˆ‘ä»¬çœ‹ MutexGuard çš„[å®šä¹‰](https://doc.rust-lang.org/src/std/sync/mutex.rs.html#190-195)ä»¥åŠå®ƒçš„ Deref å’Œ Drop çš„[å®ç°](https://doc.rust-lang.org/src/std/sync/mutex.rs.html#462-487)ï¼Œå¾ˆç®€å•ï¼š

```rust
// è¿™é‡Œç”¨ must_useï¼Œå½“ä½ å¾—åˆ°äº†å´ä¸ä½¿ç”¨ MutexGuard æ—¶ä¼šæŠ¥è­¦
#[must_use = "if unused the Mutex will immediately unlock"]
pub struct MutexGuard<'a, T: ?Sized + 'a> {
    lock: &'a Mutex<T>,
    poison: poison::Guard,
}

impl<T: ?Sized> Deref for MutexGuard<'_, T> {
    type Target = T;

    fn deref(&self) -> &T {
        unsafe { &*self.lock.data.get() }
    }
}

impl<T: ?Sized> DerefMut for MutexGuard<'_, T> {
    fn deref_mut(&mut self) -> &mut T {
        unsafe { &mut *self.lock.data.get() }
    }
}

impl<T: ?Sized> Drop for MutexGuard<'_, T> {
    #[inline]
    fn drop(&mut self) {
        unsafe {
            self.lock.poison.done(&self.poison);
            self.lock.inner.raw_unlock();
        }
    }
}
```

ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå½“ MutexGuard ç»“æŸæ—¶ï¼ŒMutex ä¼šåš unlockï¼Œè¿™æ ·ç”¨æˆ·åœ¨ä½¿ç”¨ Mutex æ—¶ï¼Œå¯ä»¥ä¸å¿…å…³å¿ƒä½•æ—¶é‡Šæ”¾è¿™ä¸ªäº’æ–¥é”ã€‚å› ä¸ºæ— è®ºä½ åœ¨è°ƒç”¨æ ˆä¸Šæ€æ ·ä¼ é€’ MutexGuard ï¼Œå“ªæ€•åœ¨é”™è¯¯å¤„ç†æµç¨‹ä¸Šæå‰é€€å‡ºï¼ŒRust æœ‰æ‰€æœ‰æƒæœºåˆ¶ï¼Œå¯ä»¥ç¡®ä¿åªè¦ MutexGuard ç¦»å¼€ä½œç”¨åŸŸï¼Œé”å°±ä¼šè¢«é‡Šæ”¾ã€‚

### ä½¿ç”¨åœºæ™¯

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä½¿ç”¨ Mutex å’Œ MutexGuard çš„ä¾‹å­ï¼ˆ[ä»£ç ](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=f01427ed0a8534ade980b88791be9d5b)ï¼‰ï¼Œä»£ç å¾ˆç®€å•ï¼Œæˆ‘å†™äº†è¯¦å°½çš„æ³¨é‡Šå¸®åŠ©ä½ ç†è§£ã€‚

```rust
use lazy_static::lazy_static;
use std::borrow::Cow;
use std::collections::HashMap;
use std::sync::{Arc, Mutex};
use std::thread;
use std::time::Duration;

// lazy_static å®å¯ä»¥ç”Ÿæˆå¤æ‚çš„ static å¯¹è±¡
lazy_static! {
    // ä¸€èˆ¬æƒ…å†µä¸‹ Mutex å’Œ Arc ä¸€èµ·åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æä¾›å¯¹å…±äº«å†…å­˜çš„ä½¿ç”¨
    // å¦‚æœä½ æŠŠ Mutex å£°æ˜æˆ staticï¼Œå…¶ç”Ÿå‘½å‘¨æœŸæ˜¯é™æ€çš„ï¼Œä¸éœ€è¦ Arc
    static ref METRICS: Mutex<HashMap<Cow<'static, str>, usize>> =
        Mutex::new(HashMap::new());
}

fn main() {
    // ç”¨ Arc æ¥æä¾›å¹¶å‘ç¯å¢ƒä¸‹çš„å…±äº«æ‰€æœ‰æƒï¼ˆä½¿ç”¨å¼•ç”¨è®¡æ•°ï¼‰
    let metrics: Arc<Mutex<HashMap<Cow<'static, str>, usize>>> =
        Arc::new(Mutex::new(HashMap::new()));
    for _ in 0..32 {
        let m = metrics.clone();
        thread::spawn(move || {
            let mut g = m.lock().unwrap();
            // æ­¤æ—¶åªæœ‰æ‹¿åˆ° MutexGuard çš„çº¿ç¨‹å¯ä»¥è®¿é—® HashMap
            let data = &mut *g;
            // Cow å®ç°äº†å¾ˆå¤šæ•°æ®ç»“æ„çš„ From traitï¼Œ
						// æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ "hello".into() ç”Ÿæˆ Cow
            let entry = data.entry("hello".into()).or_insert(0);
            *entry += 1;
						// MutexGuard è¢« Dropï¼Œé”è¢«é‡Šæ”¾
        });
    }

    thread::sleep(Duration::from_millis(100));

    println!("metrics: {:?}", metrics.lock().unwrap());
}
```

å¦‚æœä½ æœ‰ç–‘é—®ï¼Œè¿™æ ·å¦‚ä½•ä¿è¯é”çš„çº¿ç¨‹å®‰å…¨å‘¢ï¼Ÿå¦‚æœæˆ‘åœ¨çº¿ç¨‹ 1 æ‹¿åˆ°äº†é”ï¼Œç„¶åæŠŠ MutexGuard ç§»åŠ¨ç»™çº¿ç¨‹ 2 ä½¿ç”¨ï¼ŒåŠ é”å’Œè§£é”åœ¨å®Œå…¨ä¸åŒçš„çº¿ç¨‹ä¸‹ï¼Œä¼šæœ‰å¾ˆå¤§çš„æ­»é”é£é™©ã€‚æ€ä¹ˆåŠï¼Ÿ

ä¸è¦æ‹…å¿ƒï¼ŒMutexGuard ä¸å…è®¸ Sendï¼Œåªå…è®¸ Syncï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥æŠŠ MutexGuard çš„å¼•ç”¨ä¼ ç»™å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä½†ä½ æ— æ³•æŠŠ MutexGuard æ•´ä¸ªç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼š

```rust
impl<T: ?Sized> !Send for MutexGuard<'_, T> {}
unsafe impl<T: ?Sized + Sync> Sync for MutexGuard<'_, T> {}
```

ç±»ä¼¼ MutexGuard çš„æ™ºèƒ½æŒ‡é’ˆæœ‰å¾ˆå¤šç”¨é€”ã€‚æ¯”å¦‚è¦åˆ›å»ºä¸€ä¸ªè¿æ¥æ± ï¼Œä½ å¯ä»¥åœ¨ Drop trait ä¸­ï¼Œå›æ”¶ checkout å‡ºæ¥çš„è¿æ¥ï¼Œå°†å…¶å†æ”¾å›è¿æ¥æ± ã€‚å¦‚æœä½ å¯¹æ­¤æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹çœ‹ [r2d2 çš„å®ç°](https://github.com/sfackler/r2d2/blob/master/src/lib.rs#L611)ï¼Œå®ƒæ˜¯ Rust ä¸‹ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ± çš„å®ç°ã€‚

## å®ç°è‡ªå·±çš„æ™ºèƒ½æŒ‡é’ˆ

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¸‰ä¸ªç»å…¸çš„æ™ºèƒ½æŒ‡é’ˆï¼Œåœ¨å †ä¸Šåˆ›å»ºå†…å­˜çš„ Box&lt;T&gt;ã€æä¾›å†™æ—¶å…‹éš†çš„ Cow&lt;'a, B&gt;ï¼Œä»¥åŠç”¨äºæ•°æ®åŠ é”çš„ MutexGuard&lt;T&gt;ï¼Œå®ƒä»¬çš„å®ç°å’Œä½¿ç”¨æ–¹æ³•å°±è®²å®Œäº†ã€‚

é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬æƒ³å®ç°è‡ªå·±çš„æ™ºèƒ½æŒ‡é’ˆï¼Œè¯¥æ€ä¹ˆåšï¼Ÿæˆ–è€…å’±ä»¬æ¢ä¸ªé—®é¢˜ï¼šæœ‰ä»€ä¹ˆæ•°æ®ç»“æ„é€‚åˆå®ç°æˆä¸ºæ™ºèƒ½æŒ‡é’ˆï¼Ÿ

å› ä¸ºå¾ˆå¤šæ—¶å€™ï¼Œ**æˆ‘ä»¬éœ€è¦å®ç°ä¸€äº›è‡ªåŠ¨ä¼˜åŒ–çš„æ•°æ®ç»“æ„**ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹æ˜¯ä¸€ç§ä¼˜åŒ–çš„æ•°æ®ç»“æ„å’Œç›¸åº”çš„ç®—æ³•ï¼Œåœ¨å…¶ä»–æƒ…å†µä¸‹ä½¿ç”¨é€šç”¨çš„ç»“æ„å’Œé€šç”¨çš„ç®—æ³•ã€‚

æ¯”å¦‚å½“ä¸€ä¸ª HashSet çš„å†…å®¹æ¯”è¾ƒå°‘çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨æ•°ç»„å®ç°ï¼Œä½†å†…å®¹é€æ¸å¢å¤šï¼Œå†è½¬æ¢æˆç”¨å“ˆå¸Œè¡¨å®ç°ã€‚å¦‚æœæˆ‘ä»¬æƒ³è®©ä½¿ç”¨è€…ä¸ç”¨å…³å¿ƒè¿™äº›å®ç°çš„ç»†èŠ‚ï¼Œä½¿ç”¨åŒæ ·çš„æ¥å£å°±èƒ½äº«å—åˆ°æ›´å¥½çš„æ€§èƒ½ï¼Œé‚£ä¹ˆï¼Œå°±å¯ä»¥è€ƒè™‘ç”¨æ™ºèƒ½æŒ‡é’ˆæ¥ç»Ÿä¸€å®ƒçš„è¡Œä¸ºã€‚

### ä½¿ç”¨å°ç»ƒä¹ 

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå®é™…çš„ä¾‹å­ã€‚ä¹‹å‰è®²è¿‡ï¼ŒRust ä¸‹ String åœ¨æ ˆä¸Šå äº† 24 ä¸ªå­—èŠ‚ï¼Œç„¶ååœ¨å †ä¸Šå­˜æ”¾å­—ç¬¦ä¸²å®é™…çš„å†…å®¹ï¼Œå¯¹äºä¸€äº›æ¯”è¾ƒçŸ­çš„å­—ç¬¦ä¸²ï¼Œè¿™å¾ˆæµªè´¹å†…å­˜ã€‚æœ‰æ²¡æœ‰åŠæ³•åœ¨å­—ç¬¦ä¸²é•¿åˆ°ä¸€å®šç¨‹åº¦åï¼Œæ‰ä½¿ç”¨æ ‡å‡†çš„å­—ç¬¦ä¸²å‘¢ï¼Ÿ

å‚è€ƒ Cowï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª enum æ¥å¤„ç†ï¼šå½“å­—ç¬¦ä¸²å°äº N å­—èŠ‚æ—¶ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨æ ˆä¸Šçš„æ•°ç»„ï¼Œå¦åˆ™ï¼Œä½¿ç”¨ Stringã€‚ä½†æ˜¯è¿™ä¸ª N ä¸å®œå¤ªå¤§ï¼Œå¦åˆ™å½“ä½¿ç”¨ String æ—¶ï¼Œä¼šæ¯”ç›®å‰çš„ç‰ˆæœ¬æµªè´¹å†…å­˜ã€‚

æ€ä¹ˆè®¾è®¡å‘¢ï¼Ÿä¹‹å‰åœ¨å†…å­˜ç®¡ç†çš„éƒ¨åˆ†è®²è¿‡ï¼Œå½“ä½¿ç”¨ enum æ—¶ï¼Œé¢å¤–çš„ tag + ä¸ºäº†å¯¹é½è€Œä½¿ç”¨çš„ padding ä¼šå ç”¨ä¸€äº›å†…å­˜ã€‚å› ä¸º String ç»“æ„æ˜¯ 8 å­—èŠ‚å¯¹é½çš„ï¼Œæˆ‘ä»¬çš„ enum æœ€å° 8 + 24 = 32 ä¸ªå­—èŠ‚ã€‚

æ‰€ä»¥ï¼Œå¯ä»¥è®¾è®¡ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œ**å†…éƒ¨ç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œç”¨ 30 ä¸ªå­—èŠ‚è¡¨ç¤ºå­—ç¬¦ä¸²å†…å®¹ï¼Œå†åŠ ä¸Š 1 ä¸ªå­—èŠ‚çš„ tagï¼Œæ­£å¥½ä¹Ÿæ˜¯ 32 å­—èŠ‚ï¼Œå¯ä»¥å’Œ String æ”¾åœ¨ä¸€ä¸ª enum é‡Œä½¿ç”¨**ã€‚æˆ‘ä»¬æš‚ä¸”ç§°è¿™ä¸ª enum å« MyStringï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://static001.geekbang.org/resource/image/f4/97/f45e1f15a1448943979f93d13cdc0197.jpg?wh=2987x1677)

ä¸ºäº†è®© MyString è¡¨ç°è¡Œä¸ºå’Œ &amp;str ä¸€è‡´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç° Deref trait è®© MyString å¯ä»¥è¢«è§£å¼•ç”¨æˆ &amp;strã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å®ç° Debug/Display å’Œ From&lt;T&gt; traitï¼Œè®© MyString ä½¿ç”¨èµ·æ¥æ›´æ–¹ä¾¿ã€‚

æ•´ä¸ªå®ç°çš„ä»£ç å¦‚ä¸‹ï¼ˆ[ä»£ç ](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=ce83a82cd66aa412e68eebf6b292a832)ï¼‰ï¼Œä»£ç æœ¬èº«ä¸éš¾ç†è§£ï¼Œä½ å¯ä»¥è¯•ç€è‡ªå·±å®ç°ä¸€ä¸‹ï¼Œæˆ–è€…ä¸€è¡Œè¡ŒæŠ„ä¸‹æ¥è¿è¡Œï¼Œæ„Ÿå—ä¸€ä¸‹ã€‚

```rust
use std::{fmt, ops::Deref, str};

const MINI_STRING_MAX_LEN: usize = 30;

// MyString é‡Œï¼ŒString æœ‰ 3 ä¸ª wordï¼Œä¾› 24 å­—èŠ‚ï¼Œæ‰€ä»¥å®ƒä»¥ 8 å­—èŠ‚å¯¹é½
// æ‰€ä»¥ enum çš„ tag + padding æœ€å°‘ 8 å­—èŠ‚ï¼Œæ•´ä¸ªç»“æ„å  32 å­—èŠ‚ã€‚
// MiniString å¯ä»¥æœ€å¤šæœ‰ 30 å­—èŠ‚ï¼ˆå†åŠ ä¸Š 1 å­—èŠ‚é•¿åº¦å’Œ 1å­—èŠ‚ tagï¼‰ï¼Œå°±æ˜¯ 32 å­—èŠ‚.
struct MiniString {
    len: u8,
    data: [u8; MINI_STRING_MAX_LEN],
}

impl MiniString {
    // è¿™é‡Œ new æ¥å£ä¸æš´éœ²å‡ºå»ï¼Œä¿è¯ä¼ å…¥çš„ v çš„å­—èŠ‚é•¿åº¦å°äºç­‰äº 30
    fn new(v: impl AsRef<str>) -> Self {
        let bytes = v.as_ref().as_bytes();
        // æˆ‘ä»¬åœ¨æ‹·è´å†…å®¹æ—¶ä¸€å®šè¦ä½¿ç”¨å­—ç¬¦ä¸²çš„å­—èŠ‚é•¿åº¦
        let len = bytes.len();
        let mut data = [0u8; MINI_STRING_MAX_LEN];
        data[..len].copy_from_slice(bytes);
        Self {
            len: len as u8,
            data,
        }
    }
}

impl Deref for MiniString {
    type Target = str;

    fn deref(&self) -> &Self::Target {
        // ç”±äºç”Ÿæˆ MiniString çš„æ¥å£æ˜¯éšè—çš„ï¼Œå®ƒåªèƒ½æ¥è‡ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ä¸‹é¢è¿™è¡Œæ˜¯å®‰å…¨çš„
        str::from_utf8(&self.data[..self.len as usize]).unwrap()
        // ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ unsafe ç‰ˆæœ¬
        // unsafe { str::from_utf8_unchecked(&self.data[..self.len as usize]) }
    }
}

impl fmt::Debug for MiniString {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        // è¿™é‡Œç”±äºå®ç°äº† Deref traitï¼Œå¯ä»¥ç›´æ¥å¾—åˆ°ä¸€ä¸ª &str è¾“å‡º
        write!(f, "{}", self.deref())
    }
}

#[derive(Debug)]
enum MyString {
    Inline(MiniString),
    Standard(String),
}

// å®ç° Deref æ¥å£å¯¹ä¸¤ç§ä¸åŒçš„åœºæ™¯ç»Ÿä¸€å¾—åˆ° &str
impl Deref for MyString {
    type Target = str;

    fn deref(&self) -> &Self::Target {
        match *self {
            MyString::Inline(ref v) => v.deref(),
            MyString::Standard(ref v) => v.deref(),
        }
    }
}

impl From<&str> for MyString {
    fn from(s: &str) -> Self {
        match s.len() > MINI_STRING_MAX_LEN {
            true => Self::Standard(s.to_owned()),
            _ => Self::Inline(MiniString::new(s)),
        }
    }
}

impl fmt::Display for MyString {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        write!(f, "{}", self.deref())
    }
}

fn main() {
    let len1 = std::mem::size_of::<MyString>();
    let len2 = std::mem::size_of::<MiniString>();
    println!("Len: MyString {}, MiniString {}", len1, len2);

    let s1: MyString = "hello world".into();
    let s2: MyString = "è¿™æ˜¯ä¸€ä¸ªè¶…è¿‡äº†ä¸‰åä¸ªå­—èŠ‚çš„å¾ˆé•¿å¾ˆé•¿çš„å­—ç¬¦ä¸²".into();

    // debug è¾“å‡º
    println!("s1: {:?}, s2: {:?}", s1, s2);
    // display è¾“å‡º
    println!(
        "s1: {}({} bytes, {} chars), s2: {}({} bytes, {} chars)",
        s1,
        s1.len(),
        s1.chars().count(),
        s2,
        s2.len(),
        s2.chars().count()
    );

    // MyString å¯ä»¥ä½¿ç”¨ä¸€åˆ‡ &str æ¥å£ï¼Œæ„Ÿè°¢ Rust çš„è‡ªåŠ¨ Deref
    assert!(s1.ends_with("world"));
    assert!(s2.starts_with("è¿™"));
}
```

è¿™ä¸ªç®€å•å®ç°çš„ MyStringï¼Œä¸ç®¡å®ƒå†…éƒ¨çš„æ•°æ®æ˜¯çº¯æ ˆä¸Šçš„ MiniString ç‰ˆæœ¬ï¼Œè¿˜æ˜¯åŒ…å«å †ä¸Šå†…å­˜çš„ String ç‰ˆæœ¬ï¼Œä½¿ç”¨çš„ä½“éªŒå’Œ &amp;str éƒ½ä¸€è‡´ï¼Œä»…ä»…ç‰ºç‰²äº†ä¸€ç‚¹ç‚¹æ•ˆç‡å’Œå†…å­˜ï¼Œå°±å¯ä»¥è®©å°å®¹é‡çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥é«˜æ•ˆåœ°å­˜å‚¨åœ¨æ ˆä¸Šå¹¶ä¸”è‡ªå¦‚åœ°ä½¿ç”¨ã€‚

äº‹å®ä¸Šï¼ŒRust æœ‰ä¸ªå« smartstring çš„ç¬¬ä¸‰æ–¹åº“å°±å®ç°äº†è¿™ä¸ªåŠŸèƒ½ã€‚æˆ‘ä»¬çš„ç‰ˆæœ¬åœ¨å†…å­˜ä¸Šä¸ç®—ç»æµï¼Œå¯¹äº String æ¥è¯´ï¼Œé¢å¤–å¤šç”¨äº† 8 ä¸ªå­—èŠ‚ï¼Œsmartstring é€šè¿‡ä¼˜åŒ–ï¼Œåªç”¨äº†å’Œ String ç»“æ„ä¸€æ ·å¤§å°çš„ 24 ä¸ªå­—èŠ‚ï¼Œå°±è¾¾åˆ°äº†æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚ä½ å¦‚æœæ„Ÿå…´è¶£çš„è¯ï¼Œæ¬¢è¿å»çœ‹çœ‹å®ƒçš„[æºä»£ç ](https://github.com/bodil/smartstring)ã€‚

## å°ç»“

ä»Šå¤©æˆ‘ä»¬ä»‹ç»äº†ä¸‰ä¸ªé‡è¦çš„æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒä»¬æœ‰å„è‡ªç‹¬ç‰¹çš„å®ç°æ–¹å¼å’Œä½¿ç”¨åœºæ™¯ã€‚

Box&lt;T&gt; å¯ä»¥åœ¨å †ä¸Šåˆ›å»ºå†…å­˜ï¼Œæ˜¯å¾ˆå¤šå…¶ä»–æ•°æ®ç»“æ„çš„åŸºç¡€ã€‚

Cow å®ç°äº† Clone-on-write çš„æ•°æ®ç»“æ„ï¼Œè®©ä½ å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™å†è·å¾—æ•°æ®çš„æ‰€æœ‰æƒã€‚Cow ç»“æ„æ˜¯ä¸€ç§ä½¿ç”¨ enum æ ¹æ®å½“å‰çš„çŠ¶æ€è¿›è¡Œåˆ†å‘çš„ç»å…¸æ–¹æ¡ˆã€‚ç”šè‡³ï¼Œä½ å¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹æ¡ˆå–ä»£ trait object åšåŠ¨æ€åˆ†å‘ï¼Œ[å…¶æ•ˆç‡æ˜¯åŠ¨æ€åˆ†å‘çš„æ•°åå€](https://gitlab.com/antonok/enum_dispatch)ã€‚

å¦‚æœä½ æƒ³åˆç†åœ°å¤„ç†èµ„æºç›¸å…³çš„ç®¡ç†ï¼ŒMutexGuard æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å‚è€ƒï¼Œå®ƒæŠŠä» Mutex ä¸­è·å¾—çš„é”åŒ…è£…èµ·æ¥ï¼Œå®ç°åªè¦ MutexGuard é€€å‡ºä½œç”¨åŸŸï¼Œé”å°±ä¸€å®šä¼šé‡Šæ”¾ã€‚å¦‚æœä½ è¦åšèµ„æºæ± ï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼ MutexGuard çš„æ–¹å¼ã€‚

## æ€è€ƒé¢˜

1. ç›®å‰ MyString åªèƒ½ä» &amp;str ç”Ÿæˆã€‚å¦‚æœè¦æ”¯æŒä» String ä¸­ç”Ÿæˆä¸€ä¸ª MyStringï¼Œè¯¥æ€ä¹ˆåšï¼Ÿ
2. ç›®å‰ MyString åªèƒ½è¯»å–ï¼Œä¸èƒ½ä¿®æ”¹ï¼Œèƒ½ä¸èƒ½ç»™å®ƒåŠ ä¸Šç±»ä¼¼ String çš„ [push\_str](https://doc.rust-lang.org/std/string/struct.String.html#method.push_str) æ¥å£ï¼Ÿ
3. ä½ çŸ¥é“ Cow&lt;\[u8]&gt; å’Œ Cow&lt;str&gt; çš„å¤§å°ä¹ˆï¼Ÿè¯•ç€æ‰“å°ä¸€ä¸‹çœ‹çœ‹ã€‚æƒ³æƒ³ï¼Œä¸ºä»€ä¹ˆå®ƒçš„å¤§å°æ˜¯è¿™æ ·å‘¢ï¼Ÿ

æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒã€‚ä»Šå¤©ä½ å·²ç»å®ŒæˆRustå­¦ä¹ ç¬¬15æ¬¡æ‰“å¡äº†ï¼Œç»§ç»­åŠ æ²¹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï½

## å‚è€ƒèµ„æ–™

å¸¸è§çš„é€šç”¨å†…å­˜åˆ†é…å™¨æœ‰ glibc çš„ [pthread malloc](http://www.malloc.de/en/)ã€Google å¼€å‘çš„ [tcmalloc](https://github.com/google/tcmalloc)ã€FreeBSD ä¸Šé»˜è®¤ä½¿ç”¨çš„ [jemalloc](https://github.com/jemalloc/jemalloc) ç­‰ã€‚é™¤äº†é€šç”¨å†…å­˜åˆ†é…å™¨ï¼Œå¯¹äºç‰¹å®šç±»å‹å†…å­˜çš„åˆ†é…ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç”¨ [slab](https://en.wikipedia.org/wiki/Slab_allocation)ï¼Œslab ç›¸å½“äºä¸€ä¸ªé¢„åˆ†é…å¥½çš„å¯¹è±¡æ± ï¼Œå¯ä»¥æ‰©å±•å’Œæ”¶ç¼©ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>GengTeng</span> ğŸ‘ï¼ˆ19ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<p>1.
impl From&lt;String&gt; for MyString {
    fn from(s: String) -&gt; Self {
        if s.len() &gt; MINI_STRING_MAX_LEN {
            Self::Standard(s)
        } else {
            Self::Inline(MiniString::new(s))
        }
    }
}
2.
impl MyString {
    fn push_str(&amp;mut self, string: &amp;str) {
        match self {
            MyString::Inline(m) =&gt; {
                let l = m.len();
                let len = l + string.len();
                if len &gt; MINI_STRING_MAX_LEN {
                    *self = Self::Standard(m.to_string() + string);
                } else {
                    m.data[l..].copy_from_slice(string.as_bytes());
                    m.len = len as u8;
                }
            }
            MyString::Standard(s) =&gt; s.push_str(string),
        }
    }
}
3. 32 32
Cow&lt;&#39;a, B&gt; è¦æ±‚ B å®ç° ToOwnedï¼Œå…¶Ownedå˜ä½“çš„æ•°æ®ä¸º å¯¹åº”çš„ Owned ç±»å‹ï¼Œå³ [T] å¯¹åº”çš„æ˜¯ Vec&lt;T&gt;ï¼Œ str å¯¹åº”çš„æ˜¯ Stringï¼Œè¿™ä¸¤ä¸ªçš„å¤§å°éƒ½æ˜¯24å­—èŠ‚ï¼ŒåŠ ä¸Šæšä¸¾å ç”¨çš„ä¸€å­—èŠ‚ä»¥åŠ8å­—èŠ‚å¯¹é½ï¼Œå°±æ˜¯32å­—èŠ‚ã€‚
</p>2021-09-27</li><br/><li><span>Lucas</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ5ï¼‰<p>è·Ÿä¸ä¸Šäº† çœ‹ä¸æ‡‚äº†ğŸ˜­</p>2021-10-11</li><br/><li><span>è®°äº‹æœ¬</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>Owned(&lt;B as ToOwned&gt;::Owned)  æ³›å‹Bè½¬æ¢ç‰¹å¾åç§°æ˜¯ä¸ªä»€ä¹ˆæ ·çš„è¯­æ³•ï¼Œè€å¸ˆ</p>2021-09-27</li><br/><li><span>æ²ˆç•…</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è¯¾ç¨‹å­¦åˆ°è¿™ï¼Œæœ€å¤§çš„é—®é¢˜æ„Ÿè§‰ä¸æˆä½“ç³»ï¼Œæ¯ç¯‡æ–‡ç« åƒæ˜¯åšå®¢ä¸“é¢˜æ–‡ç« ã€‚ä½†æ˜¯ç« èŠ‚ä¹‹é—´æ²¡æœ‰ä½“ç³»ï¼Œä½œä¸ºç¬¬ä¸€è¯¾æ„Ÿè§‰æœ‰äº›ä¸å¦¥ã€‚</p>2022-07-21</li><br/><li><span>è®°äº‹æœ¬</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>Stringåœ¨å †ä¸Šåˆ†é…å†…å­˜,Stringæ˜¯æ ˆä¸Šçš„ä¸€ä¸ªç»“æ„ä½“,å‡å¦‚Box::new(String),æ˜¯ä¸æ˜¯Stringç»“æ„ä½“ä¹Ÿåœ¨å †ä¸Šäº†</p>2021-10-16</li><br/><li><span>æ ¸æ¡ƒ</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å…³äºæ‰€æœ‰æƒå’Œæ™ºèƒ½æŒ‡é’ˆçš„ç†è§£ï¼Œå¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« 
https:&#47;&#47;zhuanlan.zhihu.com&#47;p&#47;54078587
è¿™äº›æ¦‚å¿µåœ¨c++é‡Œé¢éƒ½æ˜¯æœ‰çš„ï¼Œå› æ­¤ä»c++çš„è§’åº¦å»ç†è§£ä¸€ä¸‹æ™ºèƒ½æŒ‡é’ˆä¸æ™®é€šæŒ‡é’ˆåŒºåˆ«ï¼Œä»€ä¹ˆæ˜¯ç§»åŠ¨è¯­ä¹‰ï¼Œé‚£æ ·è¿”å›æ¥çœ‹rustçš„æ¦‚å¿µï¼Œå°±æ˜ç™½æ¸…æ™°å¾ˆå¤šäº†ã€‚</p>2021-12-05</li><br/><li><span>Ryan</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¿™æ ·å®ç°å‡ºæ¥çš„MyStringå¦‚æœä¼ é€’ç»™å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå†…éƒ¨æ ˆä¸Šçš„å†…å­˜å¯èƒ½è¢«é‡Šæ”¾äº†ã€‚è¿™æ–¹é¢ä¸æ ‡å‡†Stringçš„åŒºåˆ«æ˜¯å¦‚ä½•ä½“ç°å¹¶åŠ ä»¥ä¿è¯çš„å‘¢ï¼Ÿ</p>2021-10-30</li><br/><li><span>Mr_æå†²</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ–‡ä¸­Cowéƒ¨åˆ†ç¤ºä¾‹æ®µUrl::parseæœ‰ä¸ªbugï¼Œurlå·¦å³ä¸¤è¾¹å„æœ‰ä¸ªå°–æ‹¬å·ï¼Œéœ€è¦å»æ‰ï¼Œå¦åˆ™ä¼šè§£æurlå¤±è´¥ï¼Œunwrapåå¯¼è‡´ç¨‹åºå´©æºƒã€‚
æ›´æ­£åæ˜¯ä¸‹é¢è¿™ä¸ªï¼š
let url = Url::parse(&quot;https:&#47;&#47;tyr.com&#47;rust?page=1024&amp;sort=desc&amp;extra=hello%20world&quot;).unwrap();</p>2021-12-26</li><br/><li><span>yg</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é™ˆè€å¸ˆæ‚¨å¥½ï¼Œç”¨rustç¼–å†™å†…æ ¸æ¨¡å—çš„è¯ï¼Œå“ªé‡Œæœ‰èµ„æ–™å¯ä»¥å‚è€ƒä¹ˆ</p>2021-11-30</li><br/><li><span>Ryan</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æˆ‘æ„Ÿè§‰è¿™è¯¾ç¨‹å¾—è‡³å°‘åˆ·3éæ‰èƒ½çœ‹æ‡‚ï¼Œå·²ç»è·Ÿä¸ä¸Šäº†ã€‚ã€‚ã€‚</p>2021-11-07</li><br/><li><span>hughieyu</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>1.impl From&lt;String&gt; for MyString {
    fn from(s: String) -&gt; Self {
        match s.len() &lt;= MINI_STRING_MAX_LEN {
            true =&gt; MyString::Inline(MiniString::new(s)),
            false =&gt; MyString::Standard(s),
        }
    }
}
2.impl MyString {
    fn push_str(&amp;mut self, string: &amp;str){
        match *self {
            MyString::Standard(ref mut s)=&gt; s.push_str(string),
            MyString::Inline(ref mut mini) =&gt; {
                let size = mini.len as usize;
                match size + string.len() &lt;= MINI_STRING_MAX_LEN {
                    true =&gt; { 
                        mini.data[size..size+string.len()].copy_from_slice(string.as_bytes());
                        mini.len = (size +string.len()) as u8;
                    },
                    false =&gt; *self =  MyString::Standard( format!(&quot;{}{}&quot;, mini.to_string(), string)),
                }
            },
        }
    }
}
3. å†³å®šCow&lt;&#39;a,B&gt;å¤§å°çš„æ˜¯è¾ƒå¤§çš„ä¸€ä¸ªå€¼(ä¸€èˆ¬æ˜¯&lt;B as ToOwned&gt;::Owned)ï¼Œ&lt;[u8] as ToOwned&gt;::Owned=Vec&lt;u8&gt;, &lt;str as ToOwned&gt;::Owned=String, ä¸¤ä¸ªçš„å¤§å°éƒ½ä¸º24å­—èŠ‚ï¼ŒåŠ ä¸Šenumä¸€ä¸ªå­—èŠ‚tagå’Œ7ä¸ªå­—èŠ‚å¯¹é½ï¼Œå…±è®¡32å­—èŠ‚ã€‚</p>2021-09-27</li><br/><li><span>Marvichov</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>Cow and ToOwnedä¸€ç›´åœ¨æˆ‘çš„todo listé‡Œé¢åƒç°, æ„Ÿè°¢è€å¸ˆè¿™ä¹ˆæ¸…æ™°çš„è®²è§£, è®©å®ƒä»¬å‡ºæ¥æ”¾é£ä¹‹åç»§ç»­å›å»èººç°...

1-3çš„ä»£ç  https:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=4e790189feaa66f784e60aa614931a13

1. 
    impl From&lt;String&gt; for MyString {
        fn from(s: String) -&gt; Self {
            if s.len() &gt; MINI_STRING_MAX_LEN {
                Self::Standard(s)
            } else {
                Self::Inline(MiniString::new(s))
            }
        }
    }

2.

    impl MyString {
        pub fn push_str(&amp;mut self, string: &amp;str) {
            match self {
                Self::Inline(s) =&gt; {
                    if s.len as usize + string.len() &lt;= MINI_STRING_MAX_LEN {
                        let bytes = string.as_bytes();
                        let offset = s.len as usize;
                        for ii in 0..bytes.len() {
                            s.data[offset + ii] = bytes[ii];
                        }
                        s.len += bytes.len() as u8;
                    } else {
                        let mut ss = String::with_capacity(s.len() as usize + string.len());
                        &#47;&#47; ä½¿ç”¨ from_utf8_unchecked ç‰ˆæœ¬çš„ deref
                        ss.push_str(s);
                        ss.push_str(string);
                        *self = MyString::from(ss);
                    }
                }
                Self::Standard(s) =&gt; {
                    s.push_str(string);
                }
            }
        }
    }
    
3. 32; str å¯¹åº”çš„ ownedæ˜¯String, 24 bytes. &amp;stræ˜¯fat ptr, 16 bytes; tag 1ä¸€ä¸ªå­—èŠ‚, ç„¶è€ŒStringçš„alignmentæ˜¯8, tagéœ€è¦å¯¹é½, äºæ˜¯åŠ ä¸Š7ä¸ªpadding; `[u8]` åŒç†</p>2021-09-27</li><br/><li><span>qinsi</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æœ‰ä¸ªå°ç–‘é—®ï¼šä¸ºä»€ä¹ˆè¯´Box&lt;T&gt;çš„Drop traitç”±ç¼–è¯‘å™¨å®ç°æ˜¯ä¸ºäº†ç¨³å®šæ¥å£ï¼Ÿåªè¦æ¥å£ç¡®å®šäº†ï¼Œæ¥å£çš„å®ç°æ€ä¹ˆæ¢å¯¹äºä½¿ç”¨è€…æ¥è¯´éƒ½æ— æ‰€è°“å§ï¼ŸçŒœæµ‹ä¼šä¸ä¼šæ˜¯ä¸ºäº†å®ç°ä¸Šçš„æ•ˆç‡ç›´æ¥ç”Ÿæˆæ±‡ç¼–ï¼Œè€Œæ±‡ç¼–æ˜¯unstableçš„ï¼Œæ— æ³•é€šè¿‡stableç¼–è¯‘ï¼Œæ‰€ä»¥åªèƒ½å…ˆæ”¾åœ¨ç¼–è¯‘å™¨é‡Œäº†ï¼Ÿä»è¿™ä¸ªè§’åº¦æ¥çœ‹çš„è¯ï¼Œå…¶å®è¦ç¨³å®šçš„ä¸æ˜¯Drop traitï¼Œè€Œæ˜¯ä»£ç å†…åµŒæ±‡ç¼–è¿™ä¸ªfeature?

(å…¶å®ä¸»è¦æ˜¯çœ‹åˆ°pythonè¢«æ‹¿å‡ºæ¥è¯´äº‹æœ‰ç‚¹ä¸å¼€å¿ƒï¼ŒæŠ¬ä¸ªæ  ;-ï¼‰</p>2021-09-27</li><br/><li><span>LuYoo</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è·Ÿä¸ä¸Š+1ï¼Œæ„Ÿè§‰è¿˜æ˜¯è¦æ•´ä½“è¿‡ä¸€éï¼Œç„¶ååœ¨å›å¤´å…·ä½“çœ‹ä¸æ‡‚çš„ã€‚</p>2021-12-27</li><br/><li><span>é˜¿æˆ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>https:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=b77895530e3fc0df461ed8c8d7d34663</p>2021-11-30</li><br/>
</ul>