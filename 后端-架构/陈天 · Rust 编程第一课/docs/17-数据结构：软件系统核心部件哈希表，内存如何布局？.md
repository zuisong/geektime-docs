ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚

ä¸Šä¸€è®²æˆ‘ä»¬æ·±å…¥å­¦ä¹ äº†åˆ‡ç‰‡ï¼Œå¯¹æ¯”äº†æ•°ç»„ã€åˆ—è¡¨ã€å­—ç¬¦ä¸²å’Œå®ƒä»¬çš„åˆ‡ç‰‡ä»¥åŠåˆ‡ç‰‡å¼•ç”¨çš„å…³ç³»ã€‚ä»Šå¤©å°±ç»§ç»­è®² Rust é‡Œå¦ä¸€ä¸ªéå¸¸é‡è¦çš„é›†åˆå®¹å™¨ï¼šHashMapï¼Œä¹Ÿå°±æ˜¯å“ˆå¸Œè¡¨ã€‚

å¦‚æœè°ˆè®ºè½¯ä»¶å¼€å‘ä¸­æœ€é‡è¦ã€å‡ºé•œç‡æœ€é«˜çš„æ•°æ®ç»“æ„ï¼Œé‚£å“ˆå¸Œè¡¨ä¸€å®šä½åˆ—å…¶ä¸­ã€‚å¾ˆå¤šç¼–ç¨‹è¯­è¨€ç”šè‡³å°†å“ˆå¸Œè¡¨ä½œä¸ºä¸€ç§å†…ç½®çš„æ•°æ®ç»“æ„ï¼Œåšè¿›äº†è¯­è¨€çš„æ ¸å¿ƒã€‚æ¯”å¦‚ PHP çš„å…³è”æ•°ç»„ï¼ˆassociate arrayï¼‰ã€Python çš„å­—å…¸ï¼ˆdictï¼‰ã€JavaScript çš„å¯¹è±¡ï¼ˆobjectï¼‰å’Œ Mapã€‚

Google çš„å·¥ç¨‹å¸ˆMatt Kulukundis åœ¨ [cppCon 2017](https://youtu.be/ncHmEUmJZf4?t=210) åšçš„ä¸€ä¸ªæ¼”è®²ï¼Œè¯´ï¼šå…¨ä¸–ç•Œ Google çš„æœåŠ¡å™¨ä¸Š 1% çš„ CPU æ—¶é—´ç”¨æ¥åšå“ˆå¸Œè¡¨çš„è®¡ç®—ï¼Œè¶…è¿‡ 4% çš„å†…å­˜ç”¨æ¥å­˜å‚¨å“ˆå¸Œè¡¨ã€‚è¶³ä»¥è¯æ˜å“ˆå¸Œè¡¨çš„é‡è¦æ€§ã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œå“ˆå¸Œè¡¨å’Œåˆ—è¡¨ç±»ä¼¼ï¼Œéƒ½ç”¨äºå¤„ç†éœ€è¦éšæœºè®¿é—®çš„æ•°æ®ç»“æ„ã€‚å¦‚æœæ•°æ®ç»“æ„çš„è¾“å…¥å’Œè¾“å‡ºèƒ½ä¸€ä¸€å¯¹åº”ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨åˆ—è¡¨ï¼Œå¦‚æœæ— æ³•ä¸€ä¸€å¯¹åº”ï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨å“ˆå¸Œè¡¨ã€‚  
![](https://static001.geekbang.org/resource/image/4e/83/4e0c043a82e29886cd7b8e1dd79a5183.jpg?wh=2364x1304)

## Rust çš„å“ˆå¸Œè¡¨

é‚£ Rust ä¸ºæˆ‘ä»¬æä¾›äº†ä»€ä¹ˆæ ·çš„å“ˆå¸Œè¡¨å‘¢ï¼Ÿå®ƒé•¿ä»€ä¹ˆæ ·ï¼Ÿæ€§èƒ½å¦‚ä½•ï¼Ÿæˆ‘ä»¬ä»å®˜æ–¹æ–‡æ¡£å­¦èµ·ã€‚

å¦‚æœä½ æ‰“å¼€ [HashMap](https://doc.rust-lang.org/std/collections/struct.HashMap.html) çš„æ–‡æ¡£ï¼Œä¼šçœ‹åˆ°è¿™æ ·ä¸€å¥è¯ï¼š

> A hash map implemented with **quadratic probing** and **SIMD lookup**.

è¿™ä¸€çœ‹å°±æœ‰ç‚¹è‚¾ä¸Šè…ºç´ ä¸Šå‡äº†ï¼Œå‡ºç°äº†ä¸¤ä¸ªé«˜ç«¯è¯æ±‡ï¼šäºŒæ¬¡æ¢æŸ¥ï¼ˆquadratic probingï¼‰å’Œ SIMD æŸ¥è¡¨ï¼ˆSIMD lookupï¼‰ï¼Œéƒ½æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå®ƒä»¬æ˜¯Rustå“ˆå¸Œè¡¨ç®—æ³•çš„è®¾è®¡æ ¸å¿ƒï¼Œæˆ‘ä»¬ä»Šå¤©çš„å­¦ä¹ ä¹Ÿä¼šå›´ç»•ç€è¿™ä¸¤ä¸ªè¯å±•å¼€ï¼Œæ‰€ä»¥åˆ«ç€æ€¥ï¼Œç­‰å­¦å®Œç›¸ä¿¡ä½ ä¼šç†è§£è¿™å¥è¯çš„ã€‚

å…ˆæŠŠåŸºç¡€ç†è®ºæ‰«ä¸€éã€‚å“ˆå¸Œè¡¨æœ€æ ¸å¿ƒçš„ç‰¹ç‚¹å°±æ˜¯ï¼š**å·¨é‡çš„å¯èƒ½è¾“å…¥å’Œæœ‰é™çš„å“ˆå¸Œè¡¨å®¹é‡ã€‚**è¿™å°±ä¼šå¼•å‘å“ˆå¸Œå†²çªï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªæˆ–è€…å¤šä¸ªè¾“å…¥çš„å“ˆå¸Œè¢«æ˜ å°„åˆ°äº†åŒä¸€ä¸ªä½ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦èƒ½å¤Ÿå¤„ç†å“ˆå¸Œå†²çªã€‚

è¦è§£å†³å†²çªï¼Œé¦–å…ˆå¯ä»¥é€šè¿‡æ›´å¥½çš„ã€åˆ†å¸ƒæ›´å‡åŒ€çš„å“ˆå¸Œå‡½æ•°ï¼Œä»¥åŠä½¿ç”¨æ›´å¤§çš„å“ˆå¸Œè¡¨æ¥ç¼“è§£å†²çªï¼Œä½†æ— æ³•å®Œå…¨è§£å†³ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨å†²çªè§£å†³æœºåˆ¶ã€‚

### å¦‚ä½•è§£å†³å†²çªï¼Ÿ

ç†è®ºä¸Šï¼Œä¸»è¦çš„å†²çªè§£å†³æœºåˆ¶æœ‰é“¾åœ°å€æ³•ï¼ˆchainingï¼‰å’Œå¼€æ”¾å¯»å€æ³•ï¼ˆopen addressingï¼‰ã€‚

é“¾åœ°å€æ³•ï¼Œæˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå°±æ˜¯æŠŠè½åœ¨åŒä¸€ä¸ªå“ˆå¸Œä¸Šçš„æ•°æ®ç”¨å•é“¾è¡¨æˆ–è€…åŒé“¾è¡¨è¿æ¥èµ·æ¥ã€‚è¿™æ ·åœ¨æŸ¥æ‰¾çš„æ—¶å€™ï¼Œå…ˆæ‰¾åˆ°å¯¹åº”çš„å“ˆå¸Œæ¡¶ï¼ˆhash bucketï¼‰ï¼Œç„¶åå†åœ¨å†²çªé“¾ä¸ŠæŒ¨ä¸ªæ¯”è¾ƒï¼Œç›´åˆ°æ‰¾åˆ°åŒ¹é…çš„é¡¹ï¼š![](https://static001.geekbang.org/resource/image/a3/5d/a3334e4a3259e0bd231815a486b7c45d.jpg?wh=2364x1610)

å†²çªé“¾å¤„ç†å“ˆå¸Œå†²çªéå¸¸ç›´è§‚ï¼Œå¾ˆå®¹æ˜“ç†è§£å’Œæ’°å†™ä»£ç ï¼Œä½†ç¼ºç‚¹æ˜¯å“ˆå¸Œè¡¨å’Œå†²çªé“¾ä½¿ç”¨äº†ä¸åŒçš„å†…å­˜ï¼Œå¯¹ç¼“å­˜ä¸å‹å¥½ã€‚

å¼€æ”¾å¯»å€æ³•æŠŠæ•´ä¸ªå“ˆå¸Œè¡¨çœ‹åšä¸€ä¸ªå¤§æ•°ç»„ï¼Œä¸å¼•å…¥é¢å¤–çš„å†…å­˜ï¼Œå½“å†²çªäº§ç”Ÿæ—¶ï¼ŒæŒ‰ç…§ä¸€å®šçš„è§„åˆ™æŠŠæ•°æ®æ’å…¥åˆ°å…¶å®ƒç©ºé—²çš„ä½ç½®ã€‚æ¯”å¦‚çº¿æ€§æ¢å¯»ï¼ˆlinear probingï¼‰åœ¨å‡ºç°å“ˆå¸Œå†²çªæ—¶ï¼Œä¸æ–­å¾€åæ¢å¯»ï¼Œç›´åˆ°æ‰¾åˆ°ç©ºé—²çš„ä½ç½®æ’å…¥ã€‚

è€Œ**äºŒæ¬¡æ¢æŸ¥**ï¼Œç†è®ºä¸Šæ˜¯åœ¨å†²çªå‘ç”Ÿæ—¶ï¼Œä¸æ–­æ¢å¯»å“ˆå¸Œä½ç½®åŠ å‡ n çš„äºŒæ¬¡æ–¹ï¼Œæ‰¾åˆ°ç©ºé—²çš„ä½ç½®æ’å…¥ï¼Œæˆ‘ä»¬çœ‹å›¾ï¼Œæ›´å®¹æ˜“ç†è§£ï¼š  
![](https://static001.geekbang.org/resource/image/42/4e/42a18970ac2eec7510c69c1f8323bc4e.jpg?wh=2364x1304)ï¼ˆå›¾ä¸­ç¤ºæ„æ˜¯ç†è®ºä¸Šçš„å¤„ç†æ–¹æ³•ï¼Œå®é™…ä¸ºäº†æ€§èƒ½ä¼šæœ‰å¾ˆå¤šä¸åŒçš„å¤„ç†ã€‚ï¼‰

å¼€æ”¾å¯»å€è¿˜æœ‰å…¶å®ƒæ–¹æ¡ˆï¼Œæ¯”å¦‚äºŒæ¬¡å“ˆå¸Œä»€ä¹ˆçš„ï¼Œä»Šå¤©å°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚

å¥½ï¼Œææ˜ç™½å“ˆå¸Œè¡¨çš„äºŒæ¬¡æ¢æŸ¥çš„ç†è®ºçŸ¥è¯†ï¼Œæˆ‘ä»¬å¯ä»¥æ¨æµ‹ï¼ŒRust å“ˆå¸Œè¡¨ä¸æ˜¯ç”¨å†²çªé“¾æ¥è§£å†³å“ˆå¸Œå†²çªï¼Œè€Œæ˜¯ç”¨å¼€æ”¾å¯»å€æ³•çš„äºŒæ¬¡æ¢æŸ¥æ¥è§£å†³çš„ã€‚å½“ç„¶ï¼Œåé¢ä¼šè®²åˆ° Rust çš„äºŒæ¬¡æ¢æŸ¥å’Œç†è®ºçš„å¤„ç†æ–¹å¼æœ‰äº›å·®åˆ«ã€‚

è€Œå¦ä¸€ä¸ªå…³é”®è¯ï¼Œä½¿ç”¨ SIMD åšå•æŒ‡ä»¤å¤šæ•°æ®çš„æŸ¥è¡¨ï¼Œä¹Ÿå’Œä¸€ä¼šè¦è®²åˆ° Rust å“ˆå¸Œè¡¨å·§å¦™çš„å†…å­˜å¸ƒå±€æ¯æ¯ç›¸å…³ã€‚

### HashMap çš„æ•°æ®ç»“æ„

è¿›å…¥æ­£é¢˜ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Rust å“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œæ‰“å¼€æ ‡å‡†åº“çš„ [æºä»£ç ](https://doc.rust-lang.org/src/std/collections/hash/map.rs.html#206-208)ï¼š

```rust
use hashbrown::hash_map as base;

#[derive(Clone)]
pub struct RandomState {
    k0: u64,
    k1: u64,
}

pub struct HashMap<K, V, S = RandomState> {
    base: base::HashMap<K, V, S>,
}
```

å¯ä»¥çœ‹åˆ°ï¼ŒHashMap æœ‰ä¸‰ä¸ªæ³›å‹å‚æ•°ï¼ŒK å’Œ V ä»£è¡¨ key / value çš„ç±»å‹ï¼ŒS æ˜¯å“ˆå¸Œç®—æ³•çš„çŠ¶æ€ï¼Œå®ƒé»˜è®¤æ˜¯ RandomStateï¼Œå ä¸¤ä¸ª u64ã€‚RandomState ä½¿ç”¨ SipHash ä½œä¸ºç¼ºçœçš„å“ˆå¸Œç®—æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŠ å¯†å®‰å…¨çš„å“ˆå¸Œå‡½æ•°ï¼ˆcryptographically secure hashingï¼‰ã€‚

ä»å®šä¹‰ä¸­è¿˜èƒ½çœ‹åˆ°ï¼ŒRust çš„ HashMap å¤ç”¨äº† hashbrown çš„ HashMapã€‚hashbrown æ˜¯ Rust ä¸‹å¯¹ [Google Swiss Table](https://abseil.io/blog/20180927-swisstables) çš„ä¸€ä¸ªæ”¹è¿›ç‰ˆå®ç°ï¼Œæˆ‘ä»¬æ‰“å¼€ hashbrown çš„ä»£ç ï¼Œçœ‹å®ƒçš„[ç»“æ„](https://docs.rs/hashbrown/0.11.2/src/hashbrown/map.rs.html#192-195)ï¼š

```rust
pub struct HashMap<K, V, S = DefaultHashBuilder, A: Allocator + Clone = Global> {
    pub(crate) hash_builder: S,
    pub(crate) table: RawTable<(K, V), A>,
}
```

å¯ä»¥çœ‹åˆ°ï¼ŒHashMap é‡Œæœ‰ä¸¤ä¸ªåŸŸï¼Œä¸€ä¸ªæ˜¯ hash\_builderï¼Œç±»å‹æ˜¯åˆšæ‰æˆ‘ä»¬æåˆ°çš„æ ‡å‡†åº“ä½¿ç”¨çš„ RandomStateï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯å…·ä½“çš„ RawTableï¼š

```rust
pub struct RawTable<T, A: Allocator + Clone = Global> {
    table: RawTableInner<A>,
    // Tell dropck that we own instances of T.
    marker: PhantomData<T>,
}

struct RawTableInner<A> {
    // Mask to get an index from a hash value. The value is one less than the
    // number of buckets in the table.
    bucket_mask: usize,

    // [Padding], T1, T2, ..., Tlast, C1, C2, ...
    //                                ^ points here
    ctrl: NonNull<u8>,

    // Number of elements that can be inserted before we need to grow the table
    growth_left: usize,

    // Number of elements in the table, only really used by len()
    items: usize,

    alloc: A,
}
```

RawTable ä¸­ï¼Œå®é™…ä¸Šæœ‰æ„ä¹‰çš„æ•°æ®ç»“æ„æ˜¯ RawTableInnerï¼Œå‰å››ä¸ªå­—æ®µå¾ˆé‡è¦ï¼Œæˆ‘ä»¬ä¸€ä¼šè®²HashMapçš„å†…å­˜å¸ƒå±€ä¼šå†æåˆ°ï¼š

- usize çš„ bucket\_maskï¼Œæ˜¯å“ˆå¸Œè¡¨ä¸­å“ˆå¸Œæ¡¶çš„æ•°é‡å‡ä¸€ï¼›
- åå­—å« ctrl çš„æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘å“ˆå¸Œè¡¨å †å†…å­˜æœ«ç«¯çš„ ctrl åŒºï¼›
- usize çš„å­—æ®µ growth\_leftï¼ŒæŒ‡å“ˆå¸Œè¡¨åœ¨ä¸‹æ¬¡è‡ªåŠ¨å¢é•¿å‰è¿˜èƒ½å­˜å‚¨å¤šå°‘æ•°æ®ï¼›
- usize çš„ itemsï¼Œè¡¨æ˜å“ˆå¸Œè¡¨ç°åœ¨æœ‰å¤šå°‘æ•°æ®ã€‚

è¿™é‡Œæœ€åçš„ alloc å­—æ®µï¼Œå’Œ RawTable çš„ marker ä¸€æ ·ï¼Œåªæ˜¯ä¸€ä¸ªç”¨æ¥å ä½çš„ç±»å‹ï¼Œæˆ‘ä»¬ç°åœ¨åªéœ€çŸ¥é“ï¼Œå®ƒç”¨æ¥åˆ†é…åœ¨å †ä¸Šçš„å†…å­˜ã€‚

### HashMap çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•

æ•°æ®ç»“æ„ææ¸…æ¥šï¼Œæˆ‘ä»¬å†çœ‹å…·ä½“ä½¿ç”¨æ–¹æ³•ã€‚Rust å“ˆå¸Œè¡¨çš„ä½¿ç”¨å¾ˆç®€å•ï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—å¾ˆæ–¹ä¾¿çš„æ–¹æ³•ï¼Œä½¿ç”¨èµ·æ¥å’Œå…¶å®ƒè¯­è¨€éå¸¸ç±»ä¼¼ï¼Œä½ åªè¦çœ‹çœ‹[æ–‡æ¡£](https://doc.rust-lang.org/std/collections/struct.HashMap.html)ï¼Œå°±å¾ˆå®¹æ˜“ç†è§£ã€‚æˆ‘ä»¬æ¥å†™æ®µä»£ç ï¼Œå°è¯•ä¸€ä¸‹ï¼ˆ[ä»£ç ](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=a0543e873c9b6ecb49f56755493dc968)ï¼‰ï¼š

```rust
use std::collections::HashMap;

fn main() {
    let mut map = HashMap::new();
    explain("empty", &map);

    map.insert('a', 1);
    explain("added 1", &map);

    map.insert('b', 2);
    map.insert('c', 3);
    explain("added 3", &map);

    map.insert('d', 4);
    explain("added 4", &map);

    // get æ—¶éœ€è¦ä½¿ç”¨å¼•ç”¨ï¼Œå¹¶ä¸”ä¹Ÿè¿”å›å¼•ç”¨
    assert_eq!(map.get(&'a'), Some(&1));
    assert_eq!(map.get_key_value(&'b'), Some((&'b', &2)));

    map.remove(&'a');
    // åˆ é™¤åå°±æ‰¾ä¸åˆ°äº†
    assert_eq!(map.contains_key(&'a'), false);
    assert_eq!(map.get(&'a'), None);
    explain("removed", &map);
    // shrink åå“ˆå¸Œè¡¨å˜å°
    map.shrink_to_fit();
    explain("shrinked", &map);
}

fn explain<K, V>(name: &str, map: &HashMap<K, V>) {
    println!("{}: len: {}, cap: {}", name, map.len(), map.capacity());
}
```

è¿è¡Œè¿™æ®µä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ ·çš„è¾“å‡ºï¼š

```rust
empty: len: 0, cap: 0
added 1: len: 1, cap: 3
added 3: len: 3, cap: 3
added 4: len: 4, cap: 7
removed: len: 3, cap: 7
shrinked: len: 3, cap: 3
```

å¯ä»¥çœ‹åˆ°ï¼Œå½“ HashMap::new() æ—¶ï¼Œå®ƒå¹¶æ²¡æœ‰åˆ†é…ç©ºé—´ï¼Œå®¹é‡ä¸ºé›¶ï¼Œ**éšç€å“ˆå¸Œè¡¨ä¸æ–­æ’å…¥æ•°æ®ï¼Œå®ƒä¼šä»¥ 2çš„å¹‚å‡ä¸€çš„æ–¹å¼å¢é•¿**ï¼Œæœ€å°æ˜¯ 3ã€‚å½“åˆ é™¤è¡¨ä¸­çš„æ•°æ®æ—¶ï¼ŒåŸæœ‰çš„è¡¨å¤§å°ä¸å˜ï¼Œåªæœ‰æ˜¾å¼åœ°è°ƒç”¨ shrink\_to\_fitï¼Œæ‰ä¼šè®©å“ˆå¸Œè¡¨å˜å°ã€‚

## HashMap çš„å†…å­˜å¸ƒå±€

ä½†æ˜¯é€šè¿‡ HashMap çš„å…¬å¼€æ¥å£ï¼Œæˆ‘ä»¬æ— æ³•çœ‹åˆ° HashMap åœ¨å†…å­˜ä¸­æ˜¯å¦‚ä½•å¸ƒå±€çš„ï¼Œè¿˜æ˜¯éœ€è¦å€ŸåŠ©ä¹‹å‰ä½¿ç”¨è¿‡çš„ std::mem::transmute æ–¹æ³•ï¼Œæ¥æŠŠæ•°æ®ç»“æ„æ‰“å‡ºæ¥ã€‚æˆ‘ä»¬æŠŠåˆšæ‰çš„ä»£ç æ”¹ä¸€æ”¹ï¼ˆ[ä»£ç ](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=40a71cd4e349369e7255f173578ec9ae)ï¼‰ï¼š

```rust
use std::collections::HashMap;

fn main() {
    let map = HashMap::new();
    let mut map = explain("empty", map);

    map.insert('a', 1);
    let mut map = explain("added 1", map);
    map.insert('b', 2);
    map.insert('c', 3);

    let mut map = explain("added 3", map);

    map.insert('d', 4);

    let mut map = explain("added 4", map);

    map.remove(&'a');

    explain("final", map);
}

// HashMap ç»“æ„æœ‰ä¸¤ä¸ª u64 çš„ RandomStateï¼Œç„¶åæ˜¯å››ä¸ª usizeï¼Œ
// åˆ†åˆ«æ˜¯ bucket_mask, ctrl, growth_left å’Œ items
// æˆ‘ä»¬ transmute æ‰“å°ä¹‹åï¼Œå† transmute å›å»
fn explain<K, V>(name: &str, map: HashMap<K, V>) -> HashMap<K, V> {
    let arr: [usize; 6] = unsafe { std::mem::transmute(map) };
    println!(
        "{}: bucket_mask 0x{:x}, ctrl 0x{:x}, growth_left: {}, items: {}",
        name, arr[2], arr[3], arr[4], arr[5]
    );
    unsafe { std::mem::transmute(arr) }
}
```

è¿è¡Œä¹‹åï¼Œå¯ä»¥çœ‹åˆ°ï¼š

```rust
empty: bucket_mask 0x0, ctrl 0x1056df820, growth_left: 0, items: 0
added 1: bucket_mask 0x3, ctrl 0x7fa0d1405e30, growth_left: 2, items: 1
added 3: bucket_mask 0x3, ctrl 0x7fa0d1405e30, growth_left: 0, items: 3
added 4: bucket_mask 0x7, ctrl 0x7fa0d1405e90, growth_left: 3, items: 4
final: bucket_mask 0x7, ctrl 0x7fa0d1405e90, growth_left: 4, items: 3
```

æœ‰æ„æ€ï¼Œæˆ‘ä»¬å‘ç°åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œctrl å¯¹åº”çš„å †åœ°å€å‘ç”Ÿäº†æ”¹å˜ã€‚

åœ¨æˆ‘çš„ OS X ä¸‹ï¼Œä¸€å¼€å§‹å“ˆå¸Œè¡¨ä¸ºç©ºï¼Œctrl åœ°å€çœ‹ä¸Šå»æ˜¯ä¸€ä¸ª TEXT/RODATA æ®µçš„åœ°å€ï¼Œåº”è¯¥æ˜¯æŒ‡å‘äº†ä¸€ä¸ªé»˜è®¤çš„ç©ºè¡¨åœ°å€ï¼›æ’å…¥ç¬¬ä¸€ä¸ªæ•°æ®åï¼Œå“ˆå¸Œè¡¨åˆ†é…äº† 4 ä¸ª bucketï¼Œctrl åœ°å€å‘ç”Ÿæ”¹å˜ï¼›åœ¨æ’å…¥ä¸‰ä¸ªæ•°æ®åï¼Œgrowth\_left ä¸ºé›¶ï¼Œå†æ’å…¥æ—¶ï¼Œå“ˆå¸Œè¡¨é‡æ–°åˆ†é…ï¼Œctrl åœ°å€ç»§ç»­æ”¹å˜ã€‚

åˆšæ‰åœ¨æ¢ç´¢ HashMap æ•°æ®ç»“æ„æ—¶ï¼Œè¯´è¿‡ ctrl æ˜¯ä¸€ä¸ªæŒ‡å‘å“ˆå¸Œè¡¨å †åœ°å€æœ«ç«¯ ctrl åŒºçš„åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªåœ°å€ï¼Œè®¡ç®—å‡ºå“ˆå¸Œè¡¨å †åœ°å€çš„èµ·å§‹åœ°å€ã€‚

å› ä¸ºå“ˆå¸Œè¡¨æœ‰ 8 ä¸ª bucketï¼ˆ0x7 + 1ï¼‰ï¼Œæ¯ä¸ª bucket å¤§å°æ˜¯ keyï¼ˆcharï¼‰ + valueï¼ˆi32ï¼‰ çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯ 8 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ä¸€å…±æ˜¯ 64 ä¸ªå­—èŠ‚ã€‚å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œ**é€šè¿‡ ctrl åœ°å€å‡å» 64ï¼Œå°±å¯ä»¥å¾—åˆ°å“ˆå¸Œè¡¨çš„å †å†…å­˜èµ·å§‹åœ°å€**ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ rust-gdb / rust-lldb æ¥æ‰“å°è¿™ä¸ªå†…å­˜ï¼ˆå¦‚æœä½ å¯¹ rust-gdb / rust-lldb æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹æ–‡æœ«çš„å‚è€ƒé˜…è¯»ï¼‰ã€‚

è¿™é‡Œæˆ‘ç”¨ Linux ä¸‹çš„ rust-gdb è®¾ç½®æ–­ç‚¹ï¼Œä¾æ¬¡æŸ¥çœ‹å“ˆå¸Œè¡¨æœ‰ä¸€ä¸ªã€ä¸‰ä¸ªã€å››ä¸ªå€¼ï¼Œä»¥åŠåˆ é™¤ä¸€ä¸ªå€¼çš„çŠ¶æ€ï¼š

```rust
â¯ rust-gdb ~/.target/debug/hashmap2
GNU gdb (Ubuntu 9.2-0ubuntu2) 9.2
...
(gdb) b hashmap2.rs:32
Breakpoint 1 at 0xa43e: file src/hashmap2.rs, line 32.
(gdb) r
Starting program: /home/tchen/.target/debug/hashmap2
...
# æœ€åˆçš„çŠ¶æ€ï¼Œå“ˆå¸Œè¡¨ä¸ºç©º
empty: bucket_mask 0x0, ctrl 0x555555597be0, growth_left: 0, items: 0

Breakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32
32	    unsafe { std::mem::transmute(arr) }
(gdb) c
Continuing.
# æ’å…¥äº†ä¸€ä¸ªå…ƒç´ åï¼Œbucket æœ‰ 4 ä¸ªï¼ˆ0x3+1ï¼‰ï¼Œå †åœ°å€èµ·å§‹ä½ç½® 0x5555555a7af0 - 4*8(0x20)
added 1: bucket_mask 0x3, ctrl 0x5555555a7af0, growth_left: 2, items: 1

Breakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32
32	    unsafe { std::mem::transmute(arr) }
(gdb) x /12x 0x5555555a7ad0
0x5555555a7ad0:	0x00000061	0x00000001	0x00000000	0x00000000
0x5555555a7ae0:	0x00000000	0x00000000	0x00000000	0x00000000
0x5555555a7af0:	0x0affffff	0xffffffff	0xffffffff	0xffffffff
(gdb) c
Continuing.
# æ’å…¥äº†ä¸‰ä¸ªå…ƒç´ åï¼Œå“ˆå¸Œè¡¨æ²¡æœ‰å‰©ä½™ç©ºé—´ï¼Œå †åœ°å€èµ·å§‹ä½ç½®ä¸å˜ 0x5555555a7af0 - 4*8(0x20)
added 3: bucket_mask 0x3, ctrl 0x5555555a7af0, growth_left: 0, items: 3

Breakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32
32	    unsafe { std::mem::transmute(arr) }
(gdb) x /12x 0x5555555a7ad0
0x5555555a7ad0:	0x00000061	0x00000001	0x00000062	0x00000002
0x5555555a7ae0:	0x00000000	0x00000000	0x00000063	0x00000003
0x5555555a7af0:	0x0a72ff02	0xffffffff	0xffffffff	0xffffffff
(gdb) c
Continuing.
# æ’å…¥ç¬¬å››ä¸ªå…ƒç´ åï¼Œå“ˆå¸Œè¡¨æ‰©å®¹ï¼Œå †åœ°å€èµ·å§‹ä½ç½®å˜ä¸º 0x5555555a7b50 - 8*8(0x40)
added 4: bucket_mask 0x7, ctrl 0x5555555a7b50, growth_left: 3, items: 4

Breakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32
32	    unsafe { std::mem::transmute(arr) }
(gdb) x /20x 0x5555555a7b10
0x5555555a7b10:	0x00000061	0x00000001	0x00000000	0x00000000
0x5555555a7b20:	0x00000064	0x00000004	0x00000063	0x00000003
0x5555555a7b30:	0x00000000	0x00000000	0x00000062	0x00000002
0x5555555a7b40:	0x00000000	0x00000000	0x00000000	0x00000000
0x5555555a7b50:	0xff72ffff	0x0aff6502	0xffffffff	0xffffffff
(gdb) c
Continuing.
# åˆ é™¤ a åï¼Œå‰©ä½™ 4 ä¸ªä½ç½®ã€‚æ³¨æ„ ctrl bit çš„å˜åŒ–ï¼Œä»¥åŠ 0x61 0x1 å¹¶æ²¡æœ‰è¢«æ¸…é™¤
final: bucket_mask 0x7, ctrl 0x5555555a7b50, growth_left: 4, items: 3

Breakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32
32	    unsafe { std::mem::transmute(arr) }
(gdb) x /20x 0x5555555a7b10
0x5555555a7b10:	0x00000061	0x00000001	0x00000000	0x00000000
0x5555555a7b20:	0x00000064	0x00000004	0x00000063	0x00000003
0x5555555a7b30:	0x00000000	0x00000000	0x00000062	0x00000002
0x5555555a7b40:	0x00000000	0x00000000	0x00000000	0x00000000
0x5555555a7b50:	0xff72ffff	0xffff6502	0xffffffff	0xffffffff
```

è¿™æ®µè¾“å‡ºè•´è—äº†å¾ˆå¤šä¿¡æ¯ï¼Œæˆ‘ä»¬ç»“åˆç¤ºæ„å›¾æ¥ä»”ç»†æ¢³ç†ã€‚

é¦–å…ˆï¼Œæ’å…¥ç¬¬ä¸€ä¸ªå…ƒç´  â€˜aâ€™: 1 åï¼Œå“ˆå¸Œè¡¨çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š![](https://static001.geekbang.org/resource/image/d1/87/d126ceb74605b168d36bc1e83d4c9e87.jpg?wh=2364x1762)

key â€˜aâ€™ çš„ hash å’Œ bucket\_mask 0x3 è¿ç®—åå¾—åˆ°ç¬¬ 0 ä¸ªä½ç½®æ’å…¥ã€‚åŒæ—¶ï¼Œè¿™ä¸ª hash çš„å¤´ 7 ä½å–å‡ºæ¥ï¼Œåœ¨ ctrl è¡¨ä¸­å¯¹åº”çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ç¬¬ 0 ä¸ªå­—èŠ‚ï¼ŒæŠŠè¿™ä¸ªå€¼å†™å…¥ã€‚

è¦ç†è§£è¿™ä¸ªæ­¥éª¤ï¼Œå…³é”®å°±æ˜¯è¦ææ¸…æ¥šè¿™ä¸ª ctrl è¡¨æ˜¯ä»€ä¹ˆã€‚

### ctrl è¡¨

ctrl è¡¨çš„ä¸»è¦ç›®çš„æ˜¯å¿«é€ŸæŸ¥æ‰¾ã€‚å®ƒçš„è®¾è®¡éå¸¸ä¼˜é›…ï¼Œå€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚

ä¸€å¼  ctrl è¡¨é‡Œï¼Œæœ‰è‹¥å¹²ä¸ª 128bit æˆ–è€…è¯´ 16 ä¸ªå­—èŠ‚çš„åˆ†ç»„ï¼ˆgroupï¼‰ï¼Œgroup é‡Œçš„æ¯ä¸ªå­—èŠ‚å« ctrl byteï¼Œå¯¹åº”ä¸€ä¸ª bucketï¼Œé‚£ä¹ˆä¸€ä¸ª group å¯¹åº” 16 ä¸ª bucketã€‚å¦‚æœä¸€ä¸ª bucket å¯¹åº”çš„ ctrl byte é¦–ä½ä¸ä¸º 1ï¼Œå°±è¡¨ç¤ºè¿™ä¸ª ctrl byte è¢«ä½¿ç”¨ï¼›å¦‚æœæ‰€æœ‰ä½éƒ½æ˜¯ 1ï¼Œæˆ–è€…è¯´è¿™ä¸ªå­—èŠ‚æ˜¯ 0xffï¼Œé‚£ä¹ˆå®ƒæ˜¯ç©ºé—²çš„ã€‚

ä¸€ç»„ control byte çš„æ•´ä¸ª 128 bit çš„æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ä¸€æ¡æŒ‡ä»¤è¢«åŠ è½½è¿›æ¥ï¼Œç„¶åå’ŒæŸä¸ªå€¼è¿›è¡Œ maskï¼Œæ‰¾åˆ°å®ƒæ‰€åœ¨çš„ä½ç½®ã€‚è¿™å°±æ˜¯ä¸€å¼€å§‹æåˆ°çš„**SIMD æŸ¥è¡¨**ã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œç°ä»£ CPU éƒ½æ”¯æŒå•æŒ‡ä»¤å¤šæ•°æ®é›†çš„æ“ä½œï¼Œè€ŒRust å……åˆ†åˆ©ç”¨äº† CPU è¿™ç§èƒ½åŠ›ï¼Œä¸€æ¡æŒ‡ä»¤å¯ä»¥è®©å¤šä¸ªç›¸å…³çš„æ•°æ®è½½å…¥åˆ°ç¼“å­˜ä¸­å¤„ç†ï¼Œå¤§å¤§åŠ å¿«æŸ¥è¡¨çš„é€Ÿåº¦ã€‚æ‰€ä»¥ï¼ŒRust çš„å“ˆå¸Œè¡¨æŸ¥è¯¢çš„æ•ˆç‡éå¸¸é«˜ã€‚

å…·ä½“æ€ä¹ˆæ“ä½œï¼Œæˆ‘ä»¬æ¥çœ‹ HashMap æ˜¯å¦‚ä½•é€šè¿‡ ctrl è¡¨æ¥è¿›è¡Œæ•°æ®æŸ¥è¯¢çš„ã€‚å‡è®¾è¿™å¼ è¡¨é‡Œå·²ç»æ·»åŠ äº†ä¸€äº›æ•°æ®ï¼Œæˆ‘ä»¬ç°åœ¨è¦æŸ¥æ‰¾ key ä¸º â€˜câ€™ çš„æ•°æ®ï¼š

1. é¦–å…ˆå¯¹ â€˜câ€™ åšå“ˆå¸Œï¼Œå¾—åˆ°ä¸€ä¸ªå“ˆå¸Œå€¼ hï¼›
2. æŠŠ h è·Ÿ bucket\_mask åšä¸ï¼Œå¾—åˆ°ä¸€ä¸ªå€¼ï¼Œå›¾ä¸­æ˜¯ 139ï¼›
3. æ‹¿ç€è¿™ä¸ª 139ï¼Œæ‰¾åˆ°å¯¹åº”çš„ ctrl group çš„èµ·å§‹ä½ç½®ï¼Œå› ä¸º ctrl group ä»¥ 16 ä¸ºä¸€ç»„ï¼Œæ‰€ä»¥è¿™é‡Œæ‰¾åˆ° 128ï¼›
4. ç”¨ SIMD æŒ‡ä»¤åŠ è½½ä» 128 å¯¹åº”åœ°å€å¼€å§‹çš„ 16 ä¸ªå­—èŠ‚ï¼›
5. å¯¹ hash å–å¤´ 7 ä¸ª bitï¼Œç„¶åå’Œåˆšåˆšå–å‡ºçš„ 16 ä¸ªå­—èŠ‚ä¸€èµ·åšä¸ï¼Œæ‰¾åˆ°å¯¹åº”çš„åŒ¹é…ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œå®ƒï¼ˆä»¬ï¼‰å¾ˆå¤§æ¦‚ç‡æ˜¯è¦æ‰¾çš„å€¼ï¼›
6. å¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆä»¥äºŒæ¬¡æ¢æŸ¥ï¼ˆä»¥ 16 çš„å€æ•°ä¸æ–­ç´¯ç§¯ï¼‰çš„æ–¹å¼å¾€åæŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸ºæ­¢ã€‚

ä½ å¯ä»¥ç»“åˆä¸‹å›¾ç†è§£è¿™ä¸ªç®—æ³•ï¼š![](https://static001.geekbang.org/resource/image/d2/60/d2a3cc569c9a9b0728a659c030eb6560.jpg?wh=2364x1762)

æ‰€ä»¥ï¼Œå½“ HashMap æ’å…¥å’Œåˆ é™¤æ•°æ®ï¼Œä»¥åŠå› æ­¤å¯¼è‡´é‡æ–°åˆ†é…çš„æ—¶å€™ï¼Œä¸»è¦å·¥ä½œå°±æ˜¯åœ¨ç»´æŠ¤è¿™å¼  ctrl è¡¨å’Œæ•°æ®çš„å¯¹åº”ã€‚

å› ä¸º ctrl è¡¨æ˜¯æ‰€æœ‰æ“ä½œæœ€å…ˆè§¦åŠçš„å†…å­˜ï¼Œæ‰€ä»¥ï¼Œåœ¨ HashMap çš„ç»“æ„ä¸­ï¼Œ**å †å†…å­˜çš„æŒ‡é’ˆç›´æ¥æŒ‡å‘ ctrl è¡¨**ï¼Œè€Œä¸æ˜¯æŒ‡å‘å †å†…å­˜çš„èµ·å§‹ä½ç½®ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸€æ¬¡å†…å­˜çš„è®¿é—®ã€‚

### å“ˆå¸Œè¡¨é‡æ–°åˆ†é…ä¸å¢é•¿

å¥½ï¼Œå›åˆ°åˆšæ‰è®²çš„å†…å­˜å¸ƒå±€ç»§ç»­è¯´ã€‚åœ¨æ’å…¥ç¬¬ä¸€æ¡æ•°æ®åï¼Œæˆ‘ä»¬çš„å“ˆå¸Œè¡¨åªæœ‰ 4 ä¸ª bucketï¼Œæ‰€ä»¥åªæœ‰å¤´ 4 ä¸ªå­—èŠ‚çš„ ctrl è¡¨æœ‰ç”¨ã€‚éšç€å“ˆå¸Œè¡¨çš„å¢é•¿ï¼Œbucket ä¸å¤Ÿï¼Œå°±ä¼šå¯¼è‡´é‡æ–°åˆ†é…ã€‚ç”±äº bucket\_mask æ°¸è¿œæ¯” bucket æ•°é‡å°‘ 1ï¼Œæ‰€ä»¥æ’å…¥ä¸‰ä¸ªå…ƒç´ åå°±ä¼šé‡æ–°åˆ†é…ã€‚

æ ¹æ® rust-gdb ä¸­å¾—åˆ°çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬çœ‹æ’å…¥ä¸‰ä¸ªå…ƒç´ åæ²¡æœ‰å‰©ä½™ç©ºé—´çš„å“ˆå¸Œè¡¨ï¼Œåœ¨åŠ å…¥ â€˜dâ€™: 4 æ—¶ï¼Œæ˜¯å¦‚ä½•å¢é•¿çš„ã€‚

é¦–å…ˆï¼Œ**å“ˆå¸Œè¡¨ä¼šæŒ‰å¹‚æ‰©å®¹**ï¼Œä» 4 ä¸ª bucket æ‰©å±•åˆ° 8 ä¸ª bucketã€‚

è¿™ä¼šå¯¼è‡´åˆ†é…æ–°çš„å †å†…å­˜ï¼Œç„¶ååŸæ¥çš„ ctrl table å’Œå¯¹åº”çš„kvæ•°æ®ä¼šè¢«ç§»åŠ¨åˆ°æ–°çš„å†…å­˜ä¸­ã€‚è¿™ä¸ªä¾‹å­é‡Œå› ä¸º char å’Œ i32 å®ç°äº† Copy traitï¼Œæ‰€ä»¥æ˜¯æ‹·è´ï¼›å¦‚æœ key çš„ç±»å‹æ˜¯ Stringï¼Œé‚£ä¹ˆåªæœ‰ String çš„ 24 ä¸ªå­—èŠ‚ (ptr|cap|len) çš„ç»“æ„è¢«ç§»åŠ¨ï¼ŒString çš„å®é™…å†…å­˜ä¸éœ€è¦å˜åŠ¨ã€‚

åœ¨ç§»åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ¶‰åŠ**å“ˆå¸Œçš„é‡åˆ†é…**ã€‚ä»ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œâ€˜aâ€™ / â€˜câ€™ çš„ç›¸å¯¹ä½ç½®å’Œå®ƒä»¬çš„ ctrl byte æ²¡æœ‰å˜åŒ–ï¼Œä½†é‡æ–°åš hash åï¼Œâ€˜bâ€™ çš„ ctrl byte å’Œä½ç½®éƒ½å‘ç”Ÿäº†å˜åŒ–ï¼š  
![](https://static001.geekbang.org/resource/image/ec/e0/ec62494f0c576f932c9716195a1ba6e0.jpg?wh=2364x1762)

### åˆ é™¤ä¸€ä¸ªå€¼

æ˜ç™½äº†å“ˆå¸Œè¡¨æ˜¯å¦‚ä½•å¢é•¿çš„ï¼Œæˆ‘ä»¬å†æ¥çœ‹åˆ é™¤çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆã€‚

å½“è¦åœ¨å“ˆå¸Œè¡¨ä¸­åˆ é™¤ä¸€ä¸ªå€¼æ—¶ï¼Œæ•´ä¸ªè¿‡ç¨‹å’ŒæŸ¥æ‰¾ç±»ä¼¼ï¼Œå…ˆè¦æ‰¾åˆ°è¦è¢«åˆ é™¤çš„ key æ‰€åœ¨çš„ä½ç½®ã€‚åœ¨æ‰¾åˆ°å…·ä½“ä½ç½®åï¼Œ**å¹¶ä¸éœ€è¦å®é™…æ¸…é™¤å†…å­˜ï¼Œåªéœ€è¦å°†å®ƒçš„ ctrl byte è®¾å› 0xff**ï¼ˆæˆ–è€…æ ‡è®°æˆåˆ é™¤çŠ¶æ€ï¼‰ã€‚è¿™æ ·ï¼Œè¿™ä¸ª bucket å°±å¯ä»¥è¢«å†æ¬¡ä½¿ç”¨äº†ï¼š  
![](https://static001.geekbang.org/resource/image/82/9e/828f746528039b15b8601ee6f8cdd79e.jpg?wh=2364x1762)

è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå½“ key/value æœ‰é¢å¤–çš„å†…å­˜æ—¶ï¼Œæ¯”å¦‚ Stringï¼Œå®ƒçš„å†…å­˜ä¸ä¼šç«‹å³å›æ”¶ï¼Œåªæœ‰åœ¨ä¸‹ä¸€æ¬¡å¯¹åº”çš„ bucket è¢«ä½¿ç”¨æ—¶ï¼Œè®© HashMap ä¸å†æ‹¥æœ‰è¿™ä¸ª String çš„æ‰€æœ‰æƒä¹‹åï¼Œè¿™ä¸ª String çš„å†…å­˜æ‰è¢«å›æ”¶ã€‚æˆ‘ä»¬çœ‹ä¸‹é¢çš„ç¤ºæ„å›¾ï¼š  
![](https://static001.geekbang.org/resource/image/0d/4d/0d191c99c4201bb88fb5a11d70a9434d.jpg?wh=2364x1304)

ä¸€èˆ¬æ¥è¯´ï¼Œè¿™å¹¶ä¸ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Œé¡¶å¤šæ˜¯å†…å­˜å ç”¨ç‡ç¨é«˜ä¸€äº›ã€‚ä½†æŸäº›æç«¯æƒ…å†µä¸‹ï¼Œæ¯”å¦‚åœ¨å“ˆå¸Œè¡¨ä¸­æ·»åŠ å¤§é‡å†…å®¹ï¼Œåˆåˆ é™¤å¤§é‡å†…å®¹åè¿è¡Œï¼Œè¿™æ—¶ä½ å¯ä»¥é€šè¿‡ shrink\_to\_fit / shrink\_to é‡Šæ”¾æ‰ä¸éœ€è¦çš„å†…å­˜ã€‚

### è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„åš Hash key

æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„æˆä¸º HashMap çš„ keyã€‚æ­¤æ—¶ï¼Œè¦ä½¿ç”¨åˆ°ä¸‰ä¸ª traitï¼š[Hash](https://doc.rust-lang.org/std/hash/trait.Hash.html)ã€[PartialEq](https://doc.rust-lang.org/std/cmp/trait.PartialEq.html)ã€[Eq](https://doc.rust-lang.org/std/cmp/trait.Eq.html)ï¼Œä¸è¿‡è¿™ä¸‰ä¸ª trait éƒ½å¯ä»¥é€šè¿‡æ´¾ç”Ÿå®è‡ªåŠ¨ç”Ÿæˆã€‚å…¶ä¸­ï¼š

- å®ç°äº† Hash ï¼Œå¯ä»¥è®©æ•°æ®ç»“æ„è®¡ç®—å“ˆå¸Œï¼›
- å®ç°äº† PartialEq/Eqï¼Œå¯ä»¥è®©æ•°æ®ç»“æ„è¿›è¡Œç›¸ç­‰å’Œä¸ç›¸ç­‰çš„æ¯”è¾ƒã€‚Eq å®ç°äº†æ¯”è¾ƒçš„è‡ªåæ€§ï¼ˆa == aï¼‰ã€å¯¹ç§°æ€§ï¼ˆa == b åˆ™ b == aï¼‰ä»¥åŠä¼ é€’æ€§ï¼ˆa == bï¼Œb == cï¼Œåˆ™ a == cï¼‰ï¼ŒPartialEq æ²¡æœ‰å®ç°è‡ªåæ€§ã€‚

æˆ‘ä»¬å¯ä»¥å†™ä¸ªä¾‹å­ï¼Œçœ‹çœ‹è‡ªå®šä¹‰æ•°æ®ç»“æ„å¦‚ä½•æ”¯æŒ HashMapï¼š

```rust
use std::{
    collections::{hash_map::DefaultHasher, HashMap},
    hash::{Hash, Hasher},
};

// å¦‚æœè¦æ”¯æŒ Hashï¼Œå¯ä»¥ç”¨ #[derive(Hash)]ï¼Œå‰ææ˜¯æ¯ä¸ªå­—æ®µéƒ½å®ç°äº† Hash
// å¦‚æœè¦èƒ½ä½œä¸º HashMap çš„ keyï¼Œè¿˜éœ€è¦ PartialEq å’Œ Eq
#[derive(Debug, Hash, PartialEq, Eq)]
struct Student<'a> {
    name: &'a str,
    age: u8,
}

impl<'a> Student<'a> {
    pub fn new(name: &'a str, age: u8) -> Self {
        Self { name, age }
    }
}
fn main() {
    let mut hasher = DefaultHasher::new();
    let student = Student::new("Tyr", 18);
    // å®ç°äº† Hash çš„æ•°æ®ç»“æ„å¯ä»¥ç›´æ¥è°ƒç”¨ hash æ–¹æ³•
    student.hash(&mut hasher);
    let mut map = HashMap::new();
    // å®ç°äº† Hash / PartialEq / Eq çš„æ•°æ®ç»“æ„å¯ä»¥ä½œä¸º HashMap çš„ key
    map.insert(student, vec!["Math", "Writing"]);
    println!("hash: 0x{:x}, map: {:?}", hasher.finish(), map);
}
```

## HashSet / BTreeMap / BTreeSet

æœ€åæˆ‘ä»¬ç®€å•è®²è®²å’Œ HashMap ç›¸å…³çš„å…¶å®ƒå‡ ä¸ªæ•°æ®ç»“æ„ã€‚

æœ‰æ—¶æˆ‘ä»¬åªéœ€è¦ç®€å•ç¡®è®¤å…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ï¼Œå¦‚æœç”¨ HashMap å°±æœ‰äº›æµªè´¹ç©ºé—´äº†ã€‚è¿™æ—¶å¯ä»¥ç”¨HashSetï¼Œå®ƒå°±æ˜¯ç®€åŒ–çš„ HashMapï¼Œå¯ä»¥ç”¨æ¥å­˜æ”¾æ— åºçš„é›†åˆï¼Œå®šä¹‰ç›´æ¥æ˜¯ HashMap&lt;K, ()&gt;ï¼š

```rust
use hashbrown::hash_set as base;

pub struct HashSet<T, S = RandomState> {
    base: base::HashSet<T, S>,
}

pub struct HashSet<T, S = DefaultHashBuilder, A: Allocator + Clone = Global> {
    pub(crate) map: HashMap<T, (), S, A>,
}
```

ä½¿ç”¨ HashSet æŸ¥çœ‹ä¸€ä¸ªå…ƒç´ æ˜¯å¦å±äºé›†åˆçš„æ•ˆç‡éå¸¸é«˜ã€‚

å¦ä¸€ä¸ªå’Œ HashMap ä¸€æ ·å¸¸ç”¨çš„æ•°æ®ç»“æ„å°±æ˜¯BTreeMapäº†ã€‚BTreeMap æ˜¯å†…éƒ¨ä½¿ç”¨ [B-tree](https://en.wikipedia.org/wiki/B-tree) æ¥ç»„ç»‡å“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„ã€‚å¦å¤– BTreeSet å’Œ HashSet ç±»ä¼¼ï¼Œæ˜¯ BTreeMap çš„ç®€åŒ–ç‰ˆï¼Œå¯ä»¥ç”¨æ¥å­˜æ”¾æœ‰åºé›†åˆã€‚

æˆ‘ä»¬è¿™é‡Œé‡ç‚¹çœ‹ä¸‹BTreeMapï¼Œå®ƒçš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š

```rust
pub struct BTreeMap<K, V> {
    root: Option<Root<K, V>>,
    length: usize,
}

pub type Root<K, V> = NodeRef<marker::Owned, K, V, marker::LeafOrInternal>;

pub struct NodeRef<BorrowType, K, V, Type> {
    height: usize,
    node: NonNull<LeafNode<K, V>>,
    _marker: PhantomData<(BorrowType, Type)>,
}

struct LeafNode<K, V> {
    parent: Option<NonNull<InternalNode<K, V>>>,
    parent_idx: MaybeUninit<u16>,
    len: u16,
    keys: [MaybeUninit<K>; CAPACITY],
    vals: [MaybeUninit<V>; CAPACITY],
}

struct InternalNode<K, V> {
    data: LeafNode<K, V>,
    edges: [MaybeUninit<BoxedNode<K, V>>; 2 * B],
}
```

å’Œ HashMap ä¸åŒçš„æ˜¯ï¼ŒBTreeMap æ˜¯æœ‰åºçš„ã€‚æˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼ˆ[ä»£ç ](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=711b0bd9ac7dbdd882c4b84809212778)ï¼‰:

```rust
use std::collections::BTreeMap;

fn main() {
    let map = BTreeMap::new();
    let mut map = explain("empty", map);

    for i in 0..16usize {
        map.insert(format!("Tyr {}", i), i);
    }

    let mut map = explain("added", map);

    map.remove("Tyr 1");

    let map = explain("remove 1", map);

    for item in map.iter() {
        println!("{:?}", item);
    }
}

// BTreeMap ç»“æ„æœ‰ heightï¼Œnode å’Œ length
// æˆ‘ä»¬ transmute æ‰“å°ä¹‹åï¼Œå† transmute å›å»
fn explain<K, V>(name: &str, map: BTreeMap<K, V>) -> BTreeMap<K, V> {
    let arr: [usize; 3] = unsafe { std::mem::transmute(map) };
    println!(
        "{}: height: {}, root node: 0x{:x}, len: 0x{:x}",
        name, arr[0], arr[1], arr[2]
    );
    unsafe { std::mem::transmute(arr) }
}
```

å®ƒçš„è¾“å‡ºå¦‚ä¸‹ï¼š

```rust
empty: height: 0, root node: 0x0, len: 0x0
added: height: 1, root node: 0x7f8286406190, len: 0x10
remove 1: height: 1, root node: 0x7f8286406190, len: 0xf
("Tyr 0", 0)
("Tyr 10", 10)
("Tyr 11", 11)
("Tyr 12", 12)
("Tyr 13", 13)
("Tyr 14", 14)
("Tyr 15", 15)
("Tyr 2", 2)
("Tyr 3", 3)
("Tyr 4", 4)
("Tyr 5", 5)
("Tyr 6", 6)
("Tyr 7", 7)
("Tyr 8", 8)
("Tyr 9", 9)
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨éå†æ—¶ï¼ŒBTreeMap ä¼šæŒ‰ç…§ key çš„é¡ºåºæŠŠå€¼æ‰“å°å‡ºæ¥ã€‚å¦‚æœä½ æƒ³è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„å¯ä»¥ä½œä¸º BTreeMap çš„ keyï¼Œé‚£ä¹ˆéœ€è¦å®ç° [PartialOrd](https://doc.rust-lang.org/std/cmp/trait.PartialOrd.html) å’Œ [Ord](https://doc.rust-lang.org/std/cmp/trait.Ord.html)ï¼Œè¿™ä¸¤è€…çš„å…³ç³»å’Œ PartialEq / Eq ç±»ä¼¼ï¼ŒPartialOrd ä¹Ÿæ²¡æœ‰å®ç°è‡ªåæ€§ã€‚åŒæ ·çš„ï¼ŒPartialOrd å’Œ Ord ä¹Ÿå¯ä»¥é€šè¿‡æ´¾ç”Ÿå®æ¥å®ç°ã€‚

## å°ç»“

åœ¨å­¦ä¹ æ•°æ®ç»“æ„çš„æ—¶å€™ï¼Œå¸¸ç”¨æ•°æ®ç»“æ„çš„å†…å­˜å¸ƒå±€å’ŒåŸºæœ¬ç®—æ³•ä½ ä¸€å®šè¦ç†è§£æ¸…æ¥šï¼Œå¯¹å®ƒåœ¨ä¸åŒæƒ…å†µä¸‹å¦‚ä½•å¢é•¿ï¼Œä¹Ÿè¦å°½é‡åšåˆ°å¿ƒé‡Œæœ‰æ•°ã€‚

è¿™ä¸€è®²æˆ‘ä»¬èŠ±å¤§ç²¾åŠ›è¯¦ç»†å­¦ä¹ äº† HashMap çš„æ•°æ®ç»“æ„ä»¥åŠç®—æ³•çš„åŸºæœ¬æ€è·¯ï¼Œç®—æ˜¯æŠ›ç –å¼•ç‰ã€‚è¿™é—¨è¯¾æ— è®ºå¤šæ·±å…¥è®²è§£ï¼Œä¹Ÿåªèƒ½è§¦åŠ Rust æ•´ä¸ªç”Ÿæ€åœˆçš„ä¹ç‰›ä¸€æ¯›ï¼Œä¸å¯èƒ½é¢é¢ä¿±åˆ°ã€‚

æˆ‘çš„åŸåˆ™æ˜¯â€œæˆäººä»¥é±¼ä¸å¦‚æˆäººä»¥æ¸”â€ï¼Œåœ¨ä½ æŒæ¡è¿™æ ·çš„åˆ†ææ–¹æ³•åï¼Œä»¥åé‡åˆ°æ ‡å‡†åº“æˆ–è€…ç¬¬ä¸‰æ–¹åº“çš„å…¶å®ƒçš„æ•°æ®ç»“æ„ï¼Œä¹Ÿå¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹æ³•æ·±å…¥æ¢ç´¢å­¦ä¹ ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬ç¨‹åºå‘˜å­¦ä¸œè¥¿ï¼Œ**ä¼šç”¨æ˜¯ç¬¬ä¸€å±‚ï¼ŒçŸ¥é“å®ƒæ˜¯å¦‚ä½•è®¾è®¡çš„æ˜¯ç¬¬äºŒå±‚ï¼Œèƒ½å¤Ÿè‡ªå·±å†™å‡ºæ¥æ‰æ˜¯ç¬¬ä¸‰å±‚**ã€‚Rustå€Ÿé‰´çš„ Google Swiss table ç®—æ³•ç®€å•ç²¾å·§ï¼Œè™½ç„¶ hashbrown åœ¨å®ç°æ—¶ï¼Œä¸ºäº†æœ€å¤§åŒ–æ€§èƒ½å’Œåˆ©ç”¨ SSE æŒ‡ä»¤é›†ï¼Œä½¿ç”¨äº†å¾ˆå¤š unsafe ä»£ç ï¼Œä½†æˆ‘ä»¬æ’°å†™ä¸€ä¸ªæ€§èƒ½ä¸é‚£ä¹ˆå¥½çš„ safe ç‰ˆæœ¬ï¼Œå¹¶ä¸æ˜¯å¤æ‚çš„äº‹æƒ…ï¼Œéå¸¸æ¨èä½ å®ç°ä¸€ä¸‹ã€‚

é›†åˆç±»å‹æˆ‘ä»¬å°±æš‚æ—¶è®²è§£åˆ°è¿™é‡Œï¼Œæœªæ¥å®æˆ˜è¦ä½¿ç”¨åˆ°æŸäº›æ•°æ®ç»“æ„æ—¶ï¼Œæ¯”å¦‚ VecDequeï¼Œæˆ‘ä»¬å†æ·±å…¥æ¢ç´¢ã€‚å…¶ä»–çš„é›†åˆç±»å‹ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨è¦ç”¨çš„æ—¶å€™è‡ªè¡Œé˜…è¯»[æ–‡æ¡£](https://doc.rust-lang.org/std/collections/index.html)ã€‚

å¦‚æœä½ æƒ³äº†è§£è¿™ä¸¤è®²ä¸­é›†åˆç±»å‹çš„æ—¶é—´å¤æ‚åº¦ï¼Œå¯ä»¥çœ‹ä¸‹è¡¨ï¼ˆ[æ¥æº](https://doc.rust-lang.org/std/collections/index.html#performance)ï¼‰ï¼š![](https://static001.geekbang.org/resource/image/60/2f/60733157bd6e6171a7fee22981469b2f.jpg?wh=2364x1304)

### æ€è€ƒé¢˜

1.ä¿®æ”¹ä¸‹é¢ä»£ç çš„é”™è¯¯ï¼Œä½¿å…¶ç¼–è¯‘é€šè¿‡ï¼ˆ[ä»£ç ](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=c29bbe5c06183eec0892101298dfc510)ï¼‰ã€‚

```rust
use std::collections::BTreeMap;

#[derive(Debug)]
struct Name {
Â  Â  pub name: String,
Â  Â  pub flags: u32,
}

impl Name {
Â  Â  pub fn new(name: impl AsRef<str>, flags: u32) -> Self {
Â  Â  Â  Â  Self {
Â  Â  Â  Â  Â  Â  name: name.as_ref().to_string(),
Â  Â  Â  Â  Â  Â  flags,
Â  Â  Â  Â  }
Â  Â  }
}

fn main() {
Â  Â  let mut map = BTreeMap::new();
Â  Â  map.insert(Name::new("/etc/password", 0x1), 12);
Â  Â  map.insert(Name::new("/etc/hosts", 0x1), 4);
Â  Â  map.insert(Name::new("/home/tchen", 0x0), 28);
Â  Â Â 
Â  Â  for item in map.iter() {
Â  Â  Â  Â  println!("{:?}", item);
Â  Â  }
}

```

2.æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœä¸€ä¸ª session è¡¨çš„ key æ˜¯ (Source IPã€Source Portã€Dst IPã€Dst Portã€Proto) è¿™æ ·çš„é•¿åº¦ 15 ä¸ªå­—èŠ‚çš„äº”å…ƒç»„ï¼Œvalue æ˜¯ 200 å­—èŠ‚çš„ Session ç»“æ„ï¼Œè¦å®¹çº³ 1200000 ä¸ª Sessionï¼Œæ•´ä¸ªå“ˆå¸Œè¡¨è¦å å¤šå¤§çš„å †å†…å­˜ï¼Ÿå†…å­˜çš„åˆ©ç”¨ç‡å¦‚ä½•ï¼Ÿ

3.ä½¿ç”¨æ–‡ä¸­åŒæ ·çš„æ–¹å¼ï¼Œç»“åˆ rust-gdb / rust-lldb æ¢ç´¢ BTreeMapã€‚ä½ èƒ½ç”»å‡ºæ¥åœ¨æ’å…¥ä»¥ 26 ä¸ªå­—æ¯ä¸º keyï¼Œ1ï½26 ä¸º value åçš„ BTreeMap çš„å†…å­˜å¸ƒå±€ä¹ˆï¼Ÿ

ä»Šå¤©ä½ å®Œæˆäº†Rustå­¦ä¹ çš„ç¬¬17æ¬¡æ‰“å¡ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚

### å‚è€ƒèµ„æ–™

1.ä¸ºä»€ä¹ˆ Rust çš„ HashMap è¦ç¼ºçœé‡‡ç”¨åŠ å¯†å®‰å…¨çš„å“ˆå¸Œç®—æ³•ï¼Ÿ

æˆ‘ä»¬çŸ¥é“å“ˆå¸Œè¡¨åœ¨è½¯ä»¶ç³»ç»Ÿä¸­çš„é‡è¦åœ°ä½ï¼Œä½†å“ˆå¸Œè¡¨åœ¨æœ€åæƒ…å†µä¸‹ï¼Œå¦‚æœç»å¤§å¤šæ•° key çš„ hash éƒ½ç¢°æ’åœ¨ä¸€èµ·ï¼Œæ€§èƒ½ä¼šåˆ° O(n)ï¼Œè¿™ä¼šæå¤§æ‹–ç´¯ç³»ç»Ÿçš„æ•ˆç‡ã€‚

æ¯”å¦‚ 1M å¤§å°çš„ session è¡¨ï¼Œæ­£å¸¸æƒ…å†µä¸‹æŸ¥è¡¨é€Ÿåº¦æ˜¯ O(1)ï¼Œä½†æç«¯æƒ…å†µä¸‹ï¼Œéœ€è¦æ¯”è¾ƒ 1M ä¸ªæ•°æ®åæ‰èƒ½æ‰¾åˆ°ï¼Œè¿™æ ·çš„ç³»ç»Ÿå°±å®¹æ˜“è¢« DoS æ”»å‡»ã€‚æ‰€ä»¥å¦‚æœä¸æ˜¯åŠ å¯†å®‰å…¨çš„å“ˆå¸Œå‡½æ•°ï¼Œåªè¦é»‘å®¢çŸ¥é“å“ˆå¸Œç®—æ³•ï¼Œå°±å¯ä»¥æ„é€ å‡ºå¤§é‡çš„ key äº§ç”Ÿè¶³å¤Ÿå¤šçš„å“ˆå¸Œç¢°æ’ï¼Œé€ æˆç›®æ ‡ç³»ç»Ÿ DoSã€‚

[SipHash](https://en.wikipedia.org/wiki/SipHash) å°±æ˜¯ä¸ºäº†å›åº” DoS æ”»å‡»è€Œåˆ›å»ºçš„å“ˆå¸Œç®—æ³•ï¼Œè™½ç„¶å’Œ sha2 è¿™æ ·çš„åŠ å¯†å“ˆå¸Œä¸åŒï¼ˆä¸è¦å°† SipHash ç”¨äºåŠ å¯†ï¼ï¼‰ï¼Œä½†å®ƒå¯ä»¥æä¾›ç±»ä¼¼ç­‰çº§çš„å®‰å…¨æ€§ã€‚æŠŠ SipHash ä½œä¸º HashMap çš„ç¼ºçœçš„å“ˆå¸Œç®—æ³•ï¼ŒRust å¯ä»¥é¿å…å¼€å‘è€…åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹è¢« DoSï¼Œå°±åƒæ›¾ç»åœ¨ [Web ä¸–ç•Œ](https://arstechnica.com/information-technology/2011/12/huge-portions-of-web-vulnerable-to-hashing-denial-of-service-attack/)å‘ç”Ÿçš„é‚£æ ·ã€‚

å½“ç„¶ï¼Œè¿™ä¸€åˆ‡çš„ä»£ä»·æ˜¯æ€§èƒ½æŸè€—ï¼Œè™½ç„¶ SipHash éå¸¸å¿«ï¼Œä½†å®ƒæ¯” hashbrown ç¼ºçœä½¿ç”¨çš„ [Ahash](https://github.com/tkaitchuck/aHash) æ…¢äº†ä¸å°‘ã€‚å¦‚æœä½ ç¡®å®šä½¿ç”¨çš„ HashMap ä¸éœ€è¦ DoS é˜²æŠ¤ï¼ˆæ¯”å¦‚ä¸€ä¸ªå®Œå…¨å†…éƒ¨ä½¿ç”¨çš„ HashMapï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ Ahash æ¥æ›¿æ¢ã€‚ä½ åªéœ€è¦ä½¿ç”¨ Ahash æä¾›çš„ RandomState å³å¯ï¼š

```rust
use ahash::{AHasher, RandomState};
use std::collections::HashMap;
let mut map: HashMap<char, i32, RandomState> = HashMap::default();
map.insert('a', 1);
```

2.å¦‚ä½•ä½¿ç”¨ rust-gdb / rust-lldbï¼Ÿ

ä¹‹å‰çš„æ„šæ˜§ä¹‹å·…[åŠ é¤](https://time.geekbang.org/column/article/418778)æè¿‡ [gdb](https://www.gnu.org/software/gdb/) / [lldb](https://lldb.llvm.org/) ï¼Œä»Šå¤©å°±æ˜¯ä½¿ç”¨ç¤ºä¾‹ã€‚æ²¡æœ‰ä½¿ç”¨è¿‡çš„æœ‹å‹ï¼Œå¯ä»¥çœ‹çœ‹å®ƒä»¬çš„æ–‡æ¡£äº†è§£ä¸€ä¸‹ã€‚

gdb é€‚åˆåœ¨ Linux ä¸‹ï¼Œlldb å¯ä»¥åœ¨ OS X ä¸‹è°ƒè¯• Rust ç¨‹åºã€‚[rust-gdb](https://github.com/rust-lang/rust/blob/master/src/etc/rust-gdb) / [rust-lldb](https://github.com/rust-lang/rust/blob/master/src/etc/rust-lldb) æä¾›äº†ä¸€äº›å¯¹ Rust æ›´å‹å¥½çš„ pretty-print åŠŸèƒ½ï¼Œåœ¨å®‰è£… Rust æ—¶ï¼Œå®ƒä»¬ä¹Ÿä¼šè¢«å®‰è£…ã€‚ä½¿ç”¨è¿‡ gdb çš„åŒå­¦ï¼Œå¯ä»¥çœ‹ [gdb é€ŸæŸ¥æ‰‹å†Œ](https://darkdust.net/files/GDB%20Cheat%20Sheet.pdf)ï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹ [gdb/lldb å‘½ä»¤å¯¹åº”æ‰‹å†Œ](https://lldb.llvm.org/use/map.html)ã€‚

æˆ‘ä¸€èˆ¬ä¸ç”¨å®ƒä»¬è°ƒè¯•ç¨‹åºã€‚**ä¸ç®¡ä»»ä½•è¯­è¨€ï¼Œå¦‚æœå¼€å‘æ—¶ï¼Œä½ å‘ç°è‡ªå·±æ€»åœ¨è®¾ç½®æ–­ç‚¹è°ƒè¯•ç¨‹åºï¼Œè¯´æ˜ä½ æ’°å†™ä»£ç çš„æ–¹å¼æœ‰é—®é¢˜**ã€‚è¦ä¹ˆï¼Œæ²¡æœ‰æŠŠæ¥å£å’Œç®—æ³•è®¾è®¡æ¸…æ¥šï¼Œæƒ³åˆ°å“ªå†™åˆ°å“ªï¼›è¦ä¹ˆï¼Œæ˜¯ä½ çš„å‡½æ•°å†™å¾—è¿‡äºå¤æ‚ï¼Œå¤ªå¤šçŠ¶æ€çº ç¼ ï¼Œæ²¡æœ‰éµå¾ª SRPï¼ˆSingle Responsibility Principleï¼‰ã€‚

**å¥½çš„ä»£ç æ˜¯å†™å‡ºæ¥çš„ï¼Œä¸æ˜¯è°ƒå‡ºæ¥çš„ã€‚ä¸å…¶æŠŠæ—¶é—´èŠ±åœ¨è°ƒè¯•ä¸Šï¼Œä¸å¦‚æŠŠæ—¶é—´èŠ±åœ¨è®¾è®¡ã€æ—¥å¿—ï¼Œä»¥åŠå•å…ƒæµ‹è¯•ä¸Š**ã€‚æ‰€ä»¥ï¼Œgdb/lldb å¯¹æˆ‘æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªç†è§£æ•°æ®ç»“æ„åœ¨å†…å­˜ä¸­å¸ƒå±€ä»¥åŠæ¢ç´¢ç®—æ³•å¦‚ä½•è¿è¡Œçš„å·¥å…·ã€‚ä½ å¯ä»¥ä»”ç»†é˜…è¯»æ–‡ä¸­å±•ç¤ºçš„ gdb session å’Œä¸ä¹‹ç›¸å…³çš„ä»£ç ï¼Œçœ‹çœ‹å¦‚ä½•æ„é€ ä»£ç æ¥ç»“åˆ gdb æ¢ç´¢ HashMap åœ¨ä¸åŒçŠ¶æ€ä¸‹çš„è¡Œä¸ºã€‚

å¦‚æœä½ è§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œé‚€TAä¸€èµ·è®¨è®ºï½
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>Geek_5244fa</span> ğŸ‘ï¼ˆ15ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è¯´ä¸€ä¸‹å¯¹ hashbrown çš„ç†è§£ã€‚

ä¸€èˆ¬çš„å“ˆå¸Œè¡¨æ˜¯å¯¹æ•°ç»„å¤§å°å–æ¨¡ï¼ˆhash % lenï¼‰æ¥å®šä½ä½ç½®çš„ï¼Œä½†æ˜¯ hashbrown æŠŠ hash åˆ†ä¸¤éƒ¨åˆ†ä½¿ç”¨ï¼š

1. ä½å‡ ä½ï¼ˆ&amp; bucket_sizeï¼‰å®šä½åœ¨æ•°ç»„çš„ä½ç½®
2. é«˜ 7 ä½å­˜åˆ°å¯¹åº”ä½ç½®çš„ ctrl å—é‡Œï¼Œç±»ä¼¼æŒ‡çº¹çš„ä½œç”¨

ä¸€èˆ¬å“ˆå¸Œè¡¨è·å–æ—¶ï¼Œå–æ¨¡å®šä½åˆ°ä½ç½®åï¼Œè¦å®Œæ•´å¯¹æ¯” key æ‰èƒ½çŸ¥é“æ˜¯æ‰¾åˆ°ï¼ˆkeyç›¸åŒï¼‰è¿˜æ˜¯è¦æ¢æŸ¥ï¼ˆkey ä¸åŒï¼‰ã€‚

è€Œ hashbrown å¯ä»¥åˆ©ç”¨ ctrl é‡Œå­˜èµ·æ¥çš„é«˜ 7 ä½å¿«é€Ÿå‘ç°å†²çªçš„æƒ…å†µï¼ˆä½å‡ ä½ç›¸åŒä½†é«˜7 ä½ä¸åŒï¼‰ï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€æ­¥æ¢æŸ¥ã€‚</p>2021-10-05</li><br/><li><span>GeekCiao</span> ğŸ‘ï¼ˆ10ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>aHash å·²ç»å¯ä»¥åšåˆ°DOSé˜²æŠ¤äº†ï¼šhttps:&#47;&#47;github.com&#47;tkaitchuck&#47;aHash&#47;wiki&#47;How-aHash-is-resists-DOS-attacks</p>2021-10-01</li><br/><li><span>qinsi</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>SIMD lookupä¹Ÿåªæ˜¯åœ¨x86&#47;64ä¸Šç”¨sse2è€Œå·²ï¼Œæ®è¯´avx&#47;neonæ•ˆæœä¸ä½³ï¼š

https:&#47;&#47;github.com&#47;rust-lang&#47;hashbrown&#47;blob&#47;cedc3267e4&#47;src&#47;raw&#47;mod.rs#L16

çœ‹äº†ä¸‹å…¶ä»–å¹³å°ä¹Ÿéƒ½è¿˜æ²¡ç¨³å®šï¼š

https:&#47;&#47;doc.rust-lang.org&#47;core&#47;arch&#47;index.html#modules</p>2021-10-02</li><br/><li><span>äº¤æµä¼š</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆæ‚¨å¥½ï¼Œæœ‰ä¸ªç–‘é—®ä¸å¤ªæ‡‚è¯·æ•™ä¸€ä¸‹ï¼š
æ‚¨åœ¨æ–‡ä¸­è¯´ ----
...åœ¨æˆ‘çš„ OS X ä¸‹ï¼Œä¸€å¼€å§‹å“ˆå¸Œè¡¨ä¸ºç©ºï¼Œctrl åœ°å€çœ‹ä¸Šå»æ˜¯ä¸€ä¸ª TEXT&#47;RODATA æ®µçš„åœ°å€ï¼Œ...

æƒ³è¯·é—®ä¸€ä¸‹ï¼Œé€šè¿‡çœ‹æ•°æ®åœ°å€æ€ä¹ˆèƒ½åŒºåˆ†æ˜¯åœ¨ æ®µä¸Šè¿˜æ˜¯å †æ ˆä¸Šçš„ï¼Ÿ è°¢è°¢ï½</p>2021-12-05</li><br/><li><span>å¾æ´²æ›´</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>HashMapä½¿ç”¨çš„ä¸€ä¸ªé—®é¢˜ï¼šæ–‡ç« ä¾‹å­æ’å…¥çš„å…ƒç´ æ˜¯charå’Œi32, é•¿åº¦å›ºå®šéƒ½æ˜¯32å­—èŠ‚ï¼ŒHashMapåœ¨æ’å…¥æ•°æ®æ—¶ï¼Œä»å›¾ä¸Šçœ‹ï¼Œæ˜¯ç›´æ¥å°†å€¼è®°å½•åœ¨å †å†…å­˜ä¸­æ•°ç»„å¯¹åº”çš„ä½ç½®ä¸Šã€‚å¯¹äºä¸€ä¸ªå¤æ‚çš„æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚è¯´Keyæ˜¯Stringï¼ŒValueæ˜¯Vec&lt;String&gt;, é‚£ä¹ˆè®°å½•çš„æ˜¯ä¸æ˜¯å°±æ˜¯ å¤§å°ä¸ºusize çš„æŒ‡é’ˆå‘¢ï¼Ÿ</p>2021-10-20</li><br/><li><span>Ixa</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æŠŠ PartialOrd å’Œ PartialEq å®ç°å³å¯è§£å†³æŠ¥é”™ã€‚ä½¿ç”¨è¯å…¸çš„cmpæ¥è¿›è¡Œå¯¹æ¯”

impl Ord for Name {
    fn cmp(&amp;self, other: &amp;Self) -&gt; Ordering {
        (self.flags, &amp;self.name).cmp(&amp;(other.flags, &amp;other.name))
    }
}

impl PartialOrd for Name {
    fn partial_cmp(&amp;self, other: &amp;Self) -&gt; Option&lt;Ordering&gt; {
        Some(self.cmp(other))
    }
}

impl PartialEq for Name {
    fn eq(&amp;self, other: &amp;Self) -&gt; bool {
        (self.flags, &amp;self.name) == (other.flags, &amp;other.name)
    }
}
</p>2021-10-08</li><br/><li><span>Marvichov</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç¬¬ä¸‰é¢˜:
```
    # æœ€åˆ root insert a - k
    x&#47;24 0x100504080
    0x100504080: 0x004044a0 0x00000001 0x00000061 0x00000062
    0x100504090: 0x00000063 0x00000064 0x00000065 0x00000066
    0x1005040a0: 0x00000067 0x00000068 0x00000069 0x0000006a
    0x1005040b0: 0x0000006b 0x00000001 0x00000002 0x00000003
    0x1005040c0: 0x00000004 0x00000005 0x00000006 0x00000007
    0x1005040d0: 0x00000008 0x00000009 0x0000000a 0x0000000b
    # insert ç¬¬11ä¸ª å‡ºç°æ–°çš„root
    x 0x1004044a0
    0x1004044a0: 00 00 00 00 00 00 00 00 67 00 00 00 00 00 00 00 ........g.......
    0x1004044b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
    ## ç»§ç»­ insert åˆ° z
    x 0x1004044a0
    0x1004044a0: 00 00 00 00 00 00 00 00 67 00 00 00 6e 00 00 00 ........g...n...
    0x1004044b0: 5 00 00 00 ff ff ff ff ff ff ff ff ff ff ff ff  u...ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
```

`LeafNode`çš„capacityæ˜¯11, è£…æ»¡äº†è¿‡åå°±å˜æˆ6ä¸ª, ç•™5ä¸ªslotä»¥å¤‡depthåŠ æ·±

```
    root        &lt;g           n            u&gt; 
    leaf &lt;a-f&gt;   &lt;h-m&gt;     &lt;o-t&gt;      &lt;v-z&gt;
```

ç–‘é—®: 


1. `LeafNode` ç¬¬ä¸€ä¸ªfieldä¸æ˜¯parentå˜›? ä¸ºå•¥leaf 1çš„ç¬¬ä¸€ä½æ˜¯ `0x004044a0` ä»…ä»…æ˜¯32ä½? æˆ‘çš„æœºå™¨æ˜¯64ä½, è€Œä¸”ä¹‹åå‡ºç°çš„parentçš„addressæ˜¯ `0x1004044a0`, æ„Ÿè§‰è¿™ä¸¤ä¸ªå¾ˆæ¥è¿‘? ä¸çŸ¥é“è¿™æ˜¯ä»€ä¹ˆtrick

2. æ€ä¹ˆä»root node read leaf nodeçš„memoryå‘¢? root nodeçš„parentæ˜¯null, æ²¡æ‰¾åˆ°æ€ä¹ˆaccess leaf node. æˆ‘ç›®å‰åªèƒ½ä»æœ€åˆçš„root nodeçŒœ (ä»¥ä¸ºä¹‹åè¿™ä¸ªrootå˜æˆäº†leaf)

3. è¿™ä¸ªfieldèƒ½å¤§æ¦‚è®²ä¸€è®²big pictureå˜›? ç›®å‰è¯»æºç è¿˜æ˜¯æœ‰éš¾åº¦...
```
 struct InternalNode { data: LeafNode, edges: [MaybeUninit&gt;; 2 * B],}
````
</p>2021-10-05</li><br/><li><span>Marvichov</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>å¯¹æ–‡ä¸­çš„ä¾‹å­æœ‰äº›ç–‘é—®:

æˆ‘çš„ç†è§£æ˜¯, ctrl section, byteçš„postion, å¯¹åº”ç€bucketçš„position

`a` åœ¨ç¬¬ä¸€ä¸ªbucket, ä¸ºå•¥ctrl sectionçš„ç¬¬ä¸€ä¸ªbyteä¸æ˜¯`0x72` å‘¢? å’Œç¤ºæ„å›¾ (`ctrl è¡¨` é‚£ä¸€èŠ‚) å¯¹ä¸ä¸Š.

```
(gdb) c
Continuing.
# æ’å…¥ç¬¬å››ä¸ªå…ƒç´ åï¼Œå“ˆå¸Œè¡¨æ‰©å®¹ï¼Œå †åœ°å€èµ·å§‹ä½ç½®å˜ä¸º 0x5555555a7b50 - 8*8(0x40)
added 4: bucket_mask 0x7, ctrl 0x5555555a7b50, growth_left: 3, items: 4

Breakpoint 1, hashmap2::explain (name=..., map=...) at src&#47;hashmap2.rs:32
32      unsafe { std::mem::transmute(arr) }
(gdb) x &#47;20x 0x5555555a7b10
0x5555555a7b10:  0x00000061  0x00000001  0x00000000  0x00000000
0x5555555a7b20:  0x00000064  0x00000004  0x00000063  0x00000003
0x5555555a7b30:  0x00000000  0x00000000  0x00000062  0x00000002
0x5555555a7b40:  0x00000000  0x00000000  0x00000000  0x00000000
0x5555555a7b50:  0xff72ffff  0x0aff6502  0xffffffff  0xffffffff
```

ctrlçš„start addræ˜¯0x5555555a7b50, ç¬¬ä¸€ä¸ªbyteä¸åº”è¯¥å¯¹åº”bucket 1å—? ç„¶è€Œ`0a` å¯¹åº”çš„æ˜¯ç¬¬5ä¸ªbucket?</p>2021-10-04</li><br/><li><span>é˜¿æµ·</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ8ï¼‰<p>è¿™ä¸€ç« çœ‹çš„æ¯”ä¹‹å‰åƒåŠ›å¾ˆå¤šï¼Œå°¤å…¶æ˜¯ä¸­é—´è§‚å¯Ÿå†…å­˜å¸ƒå±€çš„å†…å®¹ã€‚åé¢æœ‰æœºä¼šå†æ¥ä»”ç»†ç¢ç£¨ä¸‹ã€‚

å°è¯•å›ç­”ä¸‹é—®é¢˜å§ï¼š

1. Nameéœ€è¦å®ç° Debug, PartialEq, Eq, PartialOrd, Ord è¿™å‡ ä¸ªtrait
```
#[derive(Debug, PartialEq, Eq, PartialOrd, Ord)]
struct Name {
    pub name: String,
    pub flags: u32,
}
```

2. ç²—ç•¥ç®—äº†ä¸‹ï¼Œ(15 + 200) * 1200000  &#47; ï¼ˆ1024 * 1024ï¼‰å¤§çº¦éœ€è¦246Må†…å­˜ã€‚å†…å­˜åˆ©ç”¨ç‡ä¸çŸ¥é“è¦æ€ä¹ˆç®—äº†ã€‚

3. ç­‰æœ‰æ—¶é—´å†ç¢ç£¨ä¸‹</p>2021-10-03</li><br/><li><span>Geek_5244fa</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>&gt; å¦‚æœæ•°æ®ç»“æ„çš„è¾“å…¥å’Œè¾“å‡ºèƒ½ä¸€ä¸€å¯¹åº”ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨åˆ—è¡¨ï¼Œå¦‚æœæ— æ³•ä¸€ä¸€å¯¹åº”ï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨å“ˆå¸Œè¡¨ã€‚


è¿™é‡Œè¯´çš„ä¸€ä¸€å¯¹åº”ï¼Œç»“åˆå›¾æ¥çœ‹ï¼Œä¼¼ä¹è¯´çš„æ˜¯ä½ç½®çš„æ˜ å°„ã€‚

HashMap æœ‰ä¸¤ä¸ªæ˜ å°„å…³ç³»ï¼Œä¸€ä¸ªæ˜¯ key åˆ°ä½ç½®çš„æ˜ å°„ï¼Œä¸€ä¸ªåˆ° value çš„æ˜ å°„ã€‚ä¸åŒ key å¯èƒ½æ˜ å°„åˆ°ç›¸åŒçš„ä½ç½®ï¼ˆå†²çªï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜ å°„åˆ°ç›¸åŒçš„å€¼ã€‚
</p>2021-10-05</li><br/><li><span>ç»™æˆ‘ç‚¹é˜³å…‰å°±ç¿çƒ‚</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ¯”å¦‚ä¸€ä¸ªå®Œå…¨å†…éƒ¨ä½¿ç”¨çš„ HashMapï¼Œè¿™ä¸ªæ²¡å¤ªæ‡‚ï¼Œå¦‚ä½•åˆ¤æ–­é¡¹ç›®ä¸­çš„hashmapæ˜¯å®Œå…¨å†…éƒ¨ä½¿ç”¨çš„å‘¢ï¼Ÿ</p>2021-10-04</li><br/><li><span>ç»™æˆ‘ç‚¹é˜³å…‰å°±ç¿çƒ‚</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è€å¸ˆï¼Œæœ‰ä¸ªä¸å¤ªæ‡‚çš„åœ°æ–¹ã€‚æ–‡ç« é‡Œè®²åˆ°äº†äºŒæ¬¡æ¢æŸ¥ï¼Œä½† Rusté‡Œé¢çš„hashmap åœ¨æ’å…¥çš„æ—¶å€™ï¼Œå¯¹keyè¿›è¡Œhashï¼Œè¿™ä¸ªåœ°æ–¹æ€ä¹ˆåŒºåˆ«hashå‡ºæ¥çš„keyè¦ä¸è¦è¿›è¡ŒäºŒæ¬¡æ¢æŸ¥å‘¢ï¼Ÿå› ä¸ºç°åœ¨æœ‰ä¸¤ç§å¯èƒ½ï¼Œç¬¬ä¸€ç§æ˜¯è¿™æ˜¯ä¸€ä¸ªæ–°çš„keyï¼Œhashå†²çªäº†ï¼Œéœ€è¦è¿›è¡ŒäºŒæ¬¡æ¢æŸ¥ã€‚ç¬¬äºŒç§æƒ…å†µæ˜¯ï¼Œè¿™è¿˜æ˜¯åŸæ¥çš„keyï¼Œè¦æ›´æ–°valueã€‚</p>2021-10-03</li><br/><li><span>æ…¢æ…¢æœ€å¿«</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>hash æ³•çš„å¯¹æ¯”ï¼Œä»¥åŠ swiss tablesçš„è¯¦è§£ï¼Œæ„Ÿè§‰çœ‹çœ‹è¿™ç¯‡æ–‡ç«  https:&#47;&#47;zhuanlan.zhihu.com&#47;p&#47;277732297ï¼Œç†è§£èµ·æ¥è¿˜æŒºå—ç”¨çš„</p>2022-02-09</li><br/><li><span>sword@zh</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è®¾è®¡çš„è¿™ä¹ˆå¤æ‚â€¦è„‘è¢‹æŠ½äº†</p>2024-12-30</li><br/><li><span>jackstraw</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å…³äºæŸ¥æ‰¾å…ƒç´ çš„è¯´æ˜ï¼šâ€œå¯¹ hash å–å¤´ 7 ä¸ª bitï¼Œç„¶åå’Œåˆšåˆšå–å‡ºçš„ 16 ä¸ªå­—èŠ‚ä¸€èµ·åšä¸â€ï¼Œè¿™é‡Œçš„è¡¨è¿°æœ‰é—®é¢˜å§ï¼Ÿåº”è¯¥æ˜¯å¯¹hashå–å¤´7ä¸ªbitï¼Œç”¨è¿™7bitæ•°æ®ä¸æœ¬16ä¸ªbucketçš„å¯¹åº”æ§åˆ¶byteè¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœåŒ¹é…ä¸Šäº†ï¼Œè¯´æ˜è¿™ä¸ªbucketå­˜åœ¨æ•°æ®ï¼Œå†è¿›ä¸€æ­¥é€šè¿‡keyæ¥æ¯”å¯¹æ˜¯å¦æ˜¯æ‰¾çš„å…ƒç´ ï¼ŒkeyåŒ¹é…ä¸ä¸Šå°±æ‰¾ä¸‹ä¸€ä¸ª16å­—èŠ‚æ§åˆ¶ç»„ï¼›è‹¥å¯¹åº”æ§åˆ¶byteæ˜¯0xffï¼Œå°±è¡¨ç¤ºä¸å­˜åœ¨è¯¥keyã€‚
ä¸çŸ¥é“è¿™ä¸ªç†è§£å¯¹ä¸å¯¹ï¼Ÿ</p>2023-12-29</li><br/>
</ul>