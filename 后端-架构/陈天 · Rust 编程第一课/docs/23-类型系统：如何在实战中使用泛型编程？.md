ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚

ä»è¿™ä¸€è®²å¼€å§‹ï¼Œæˆ‘ä»¬å°±åˆ°è¿›é˜¶ç¯‡äº†ã€‚åœ¨è¿›é˜¶ç¯‡ä¸­ï¼Œæˆ‘ä»¬ä¼šå…ˆè¿›ä¸€æ­¥å¤¯å®å¯¹ç±»å‹ç³»ç»Ÿçš„ç†è§£ï¼Œç„¶åå†å±•å¼€ç½‘ç»œå¤„ç†ã€Unsafe Rustã€FFI ç­‰ä¸»é¢˜ã€‚

ä¸ºä»€ä¹ˆè¦æŠŠç±»å‹ç³»ç»Ÿä½œä¸ºè¿›é˜¶ç¯‡çš„åŸºçŸ³ï¼Ÿä¹‹å‰è®²è§£ rgrep çš„ä»£ç æ—¶ä½ å¯ä»¥çœ‹åˆ°ï¼Œå½“è¦æ„å»ºå¯è¯»æ€§æ›´å¼ºã€æ›´åŠ çµæ´»ã€æ›´åŠ å¯æµ‹è¯•çš„ç³»ç»Ÿæ—¶ï¼Œæˆ‘ä»¬éƒ½è¦æˆ–å¤šæˆ–å°‘ä½¿ç”¨ trait å’Œæ³›å‹ç¼–ç¨‹ã€‚

æ‰€ä»¥å¯ä»¥è¯´åœ¨ Rust å¼€å‘ä¸­ï¼Œæ³›å‹ç¼–ç¨‹æ˜¯æˆ‘ä»¬å¿…é¡»æŒæ¡çš„ä¸€é¡¹æŠ€èƒ½ã€‚åœ¨ä½ æ„å»ºæ¯ä¸€ä¸ªæ•°æ®ç»“æ„æˆ–è€…å‡½æ•°æ—¶ï¼Œæœ€å¥½éƒ½é—®é—®è‡ªå·±ï¼šæˆ‘æ˜¯å¦æœ‰å¿…è¦åœ¨æ­¤åˆ»å°±æŠŠç±»å‹å®šæ­»ï¼Ÿæ˜¯ä¸æ˜¯å¯ä»¥æŠŠè¿™ä¸ªå†³ç­–å»¶è¿Ÿåˆ°å°½å¯èƒ½é åçš„æ—¶åˆ»ï¼Œè¿™æ ·å¯ä»¥ä¸ºæœªæ¥ç•™æœ‰ä½™åœ°ï¼Ÿ

åœ¨ã€Šæ¶æ„æ•´æ´ä¹‹é“ã€‹é‡Œ Uncle Bob è¯´ï¼š**æ¶æ„å¸ˆçš„å·¥ä½œä¸æ˜¯ä½œå‡ºå†³ç­–ï¼Œè€Œæ˜¯å°½å¯èƒ½ä¹…åœ°æ¨è¿Ÿå†³ç­–ï¼Œåœ¨ç°åœ¨ä¸ä½œå‡ºé‡å¤§å†³ç­–çš„æƒ…å†µä¸‹æ„å»ºç¨‹åºï¼Œä»¥ä¾¿ä»¥åæœ‰è¶³å¤Ÿä¿¡æ¯æ—¶å†ä½œå‡ºå†³ç­–**ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬èƒ½é€šè¿‡æ³›å‹æ¥æ¨è¿Ÿå†³ç­–ï¼Œç³»ç»Ÿçš„æ¶æ„å°±å¯ä»¥è¶³å¤Ÿçµæ´»ï¼Œå¯ä»¥æ›´å¥½åœ°é¢å¯¹æœªæ¥çš„å˜æ›´ã€‚

ä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥è®²è®²å¦‚ä½•åœ¨å®æˆ˜ä¸­ä½¿ç”¨æ³›å‹ç¼–ç¨‹ï¼Œæ¥å»¶è¿Ÿå†³ç­–ã€‚å¦‚æœä½ å¯¹ Rust çš„æ³›å‹ç¼–ç¨‹æŒæ¡åœ°è¿˜ä¸å¤Ÿç‰¢é ï¼Œå»ºè®®å†æ¸©ä¹ ä¸€ä¸‹ç¬¬ [12](https://time.geekbang.org/column/article/420021) å’Œ [13](https://time.geekbang.org/column/article/420028) è®²ï¼Œä¹Ÿå¯ä»¥é˜…è¯» The Rust Programming Language [ç¬¬ 10 ç« ](https://doc.rust-lang.org/book/ch10-00-generics.html)ä½œä¸ºè¾…åŠ©ã€‚

## æ³›å‹æ•°æ®ç»“æ„çš„é€æ­¥çº¦æŸ

åœ¨è¿›å…¥æ­£é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬ä»¥æ ‡å‡†åº“çš„ [BufReader](https://doc.rust-lang.org/src/std/io/buffered/bufreader.rs.html#48-53) ç»“æ„ä¸ºä¾‹ï¼Œå…ˆç®€å•å›é¡¾ä¸€ä¸‹ï¼Œåœ¨å®šä¹‰æ•°æ®ç»“æ„å’Œå®ç°æ•°æ®ç»“æ„æ—¶ï¼Œå¦‚æœä½¿ç”¨äº†æ³›å‹å‚æ•°ï¼Œåˆ°åº•æœ‰ä»€ä¹ˆæ ·çš„å¥½å¤„ã€‚

çœ‹è¿™ä¸ªå®šä¹‰çš„å°ä¾‹å­ï¼š

```rust
pub struct BufReader<R> {
    inner: R,
    buf: Box<[u8]>,
    pos: usize,
    cap: usize,
}
```

BufReader å¯¹è¦è¯»å–çš„ R åšäº†ä¸€ä¸ªæ³›å‹çš„æŠ½è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒR æ­¤åˆ»æ˜¯ä¸ª Fileï¼Œè¿˜æ˜¯ä¸€ä¸ª Cursorï¼Œæˆ–è€…ç›´æ¥æ˜¯ Vec&lt;u8&gt;ï¼Œéƒ½ä¸é‡è¦ã€‚åœ¨å®šä¹‰ struct çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶æœªå¯¹ R åšè¿›ä¸€æ­¥çš„é™åˆ¶ï¼Œè¿™æ˜¯æœ€å¸¸ç”¨çš„ä½¿ç”¨æ³›å‹çš„æ–¹å¼ã€‚

åˆ°äº†å®ç°é˜¶æ®µï¼Œæ ¹æ®ä¸åŒçš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸º R åšä¸åŒçš„é™åˆ¶ã€‚è¿™ä¸ªé™åˆ¶éœ€è¦ç»†è‡´åˆ°ä»€ä¹ˆç¨‹åº¦å‘¢ï¼Ÿåªéœ€è¦æ·»åŠ åˆšå¥½æ»¡è¶³å®ç°éœ€è¦çš„é™åˆ¶å³å¯ã€‚

æ¯”å¦‚åœ¨æä¾› capacity()ã€buffer() è¿™äº›ä¸éœ€è¦ä½¿ç”¨ R çš„ä»»ä½•ç‰¹æ®Šèƒ½åŠ›çš„æ—¶å€™ï¼Œå¯ä»¥[ä¸åšä»»ä½•é™åˆ¶](https://doc.rust-lang.org/src/std/io/buffered/bufreader.rs.html#102-230)ï¼š

```rust
impl<R> BufReader<R> {
    pub fn capacity(&self) -> usize { ... }
    pub fn buffer(&self) -> &[u8] { ... }
}
```

ä½†åœ¨å®ç° new() çš„æ—¶å€™ï¼Œå› ä¸ºä½¿ç”¨äº† Read trait é‡Œçš„æ–¹æ³•ï¼Œæ‰€ä»¥è¿™æ—¶éœ€è¦æ˜ç¡®ä¼ è¿›æ¥çš„ [R æ»¡è¶³ Read çº¦æŸ](https://doc.rust-lang.org/src/std/io/buffered/bufreader.rs.html#55-100)ï¼š

```rust
impl<R: Read> BufReader<R> {
    pub fn new(inner: R) -> BufReader<R> { ... }
    pub fn with_capacity(capacity: usize, inner: R) -> BufReader<R> { ... }
}
```

åŒæ ·ï¼Œåœ¨å®ç° Debug æ—¶ï¼Œä¹Ÿå¯ä»¥è¦æ±‚ [R æ»¡è¶³ Debug trait çš„çº¦æŸ](https://doc.rust-lang.org/src/std/io/buffered/bufreader.rs.html#333-344)ï¼š

```rust
impl<R> fmt::Debug for BufReader<R>
where
    R: fmt::Debug
{
    fn fmt(&self, fmt: &mut fmt::Formatter<'_>) -> fmt::Result { ... }
}
```

å¦‚æœä½ å¤šèŠ±ä¸€äº›æ—¶é—´ï¼ŒæŠŠ [bufreader.rs](https://doc.rust-lang.org/src/std/io/buffered/bufreader.rs.html) å¯¹æ¥å£çš„æ‰€æœ‰å®ç°éƒ½è¿‡ä¸€éï¼Œè¿˜ä¼šå‘ç° BufReader åœ¨å®ç°è¿‡ç¨‹ä¸­ä½¿ç”¨äº† Seek traitã€‚

æ•´ä½“è€Œè¨€ï¼Œimpl BufReader çš„ä»£ç æ ¹æ®ä¸åŒçš„çº¦æŸï¼Œåˆ†æˆäº†ä¸åŒçš„ä»£ç å—ã€‚è¿™æ˜¯ä¸€ç§éå¸¸å…¸å‹çš„å®ç°æ³›å‹ä»£ç çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å­¦ä¹ èµ·æ¥ï¼Œåœ¨è‡ªå·±çš„ä»£ç ä¸­ä¹Ÿåº”ç”¨è¿™ç§æ–¹æ³•ã€‚

é€šè¿‡ä½¿ç”¨æ³›å‹å‚æ•°ï¼ŒBufReader æŠŠå†³ç­–äº¤ç»™ä½¿ç”¨è€…ã€‚æˆ‘ä»¬åœ¨ä¸Šä¸€è®²æœŸä¸­è€ƒè¯•çš„ rgrep å®ç°ä¸­ä¹Ÿçœ‹åˆ°äº†ï¼Œåœ¨æµ‹è¯•å’Œ rgrep çš„å®ç°ä»£ç ä¸­ï¼Œæ˜¯å¦‚ä½•ä¸º BufReader æä¾›ä¸åŒçš„ç±»å‹æ¥æ»¡è¶³ä¸åŒçš„ä½¿ç”¨åœºæ™¯çš„ã€‚

## æ³›å‹å‚æ•°çš„ä¸‰ç§ä½¿ç”¨åœºæ™¯

æ³›å‹å‚æ•°çš„ä½¿ç”¨å’Œé€æ­¥çº¦æŸå°±ç®€å•å¤ä¹ åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å·²ç»æŒæ¡å¾—æ¯”è¾ƒå¥½äº†ï¼Œæˆ‘ä»¬å¼€å§‹ä»Šå¤©çš„é‡å¤´æˆï¼Œæ¥å­¦ä¹ å®æˆ˜ä¸­å¦‚ä½•ä½¿ç”¨æ³›å‹ç¼–ç¨‹ã€‚

å…ˆçœ‹æ³›å‹å‚æ•°ï¼Œå®ƒæœ‰ä¸‰ç§å¸¸è§çš„ä½¿ç”¨åœºæ™¯ï¼š

- ä½¿ç”¨æ³›å‹å‚æ•°å»¶è¿Ÿæ•°æ®ç»“æ„çš„ç»‘å®šï¼›
- ä½¿ç”¨æ³›å‹å‚æ•°å’Œ PhantomDataï¼Œå£°æ˜æ•°æ®ç»“æ„ä¸­ä¸ç›´æ¥ä½¿ç”¨ï¼Œä½†åœ¨å®ç°è¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°çš„ç±»å‹ï¼›
- ä½¿ç”¨æ³›å‹å‚æ•°è®©åŒä¸€ä¸ªæ•°æ®ç»“æ„å¯¹åŒä¸€ä¸ª trait å¯ä»¥æ‹¥æœ‰ä¸åŒçš„å®ç°ã€‚

### ç”¨æ³›å‹å‚æ•°åšå»¶è¿Ÿç»‘å®š

å…ˆæ¥çœ‹æˆ‘ä»¬å·²ç»æ¯”è¾ƒç†Ÿæ‚‰çš„ï¼Œç”¨æ³›å‹å‚æ•°åšå»¶è¿Ÿç»‘å®šã€‚åœ¨ KV server çš„[ä¸Šç¯‡](https://time.geekbang.org/column/article/425001)ä¸­ï¼Œæˆ‘æ„å»ºäº†ä¸€ä¸ª Service æ•°æ®ç»“æ„ï¼š

```rust
/// Service æ•°æ®ç»“æ„
pub struct Service<Store = MemTable> {
    inner: Arc<ServiceInner<Store>>,
}
```

å®ƒä½¿ç”¨äº†ä¸€ä¸ªæ³›å‹å‚æ•° Storeï¼Œå¹¶ä¸”è¿™ä¸ªæ³›å‹å‚æ•°æœ‰ä¸€ä¸ªç¼ºçœå€¼ MemTableã€‚æŒ‡å®šäº†æ³›å‹å‚æ•°ç¼ºçœå€¼çš„å¥½å¤„æ˜¯ï¼Œåœ¨ä½¿ç”¨æ—¶ï¼Œå¯ä»¥ä¸å¿…æä¾›æ³›å‹å‚æ•°ï¼Œç›´æ¥ä½¿ç”¨ç¼ºçœå€¼ã€‚è¿™ä¸ªæ³›å‹å‚æ•°åœ¨éšåçš„å®ç°ä¸­å¯ä»¥è¢«é€æ¸çº¦æŸï¼š

```rust
impl<Store> Service<Store> {
    pub fn new(store: Store) -> Self { ... }
}

impl<Store: Storage> Service<Store> {
    pub fn execute(&self, cmd: CommandRequest) -> CommandResponse { ... }
}
```

åŒæ ·çš„ï¼Œåœ¨æ³›å‹å‡½æ•°ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ impl Storage æˆ–è€… &lt;Store: Storage&gt; çš„æ–¹å¼å»çº¦æŸï¼š

```rust
pub fn dispatch(cmd: CommandRequest, store: &impl Storage) -> CommandResponse { ... }
// ç­‰ä»·äº
pub fn dispatch<Store: Storage>(cmd: CommandRequest, store: &Store) -> CommandResponse { ... }
```

è¿™ç§ç”¨æ³•ï¼Œæƒ³å¿…ä½ ç°åœ¨å·²ç»éå¸¸ç†Ÿæ‚‰äº†ï¼Œå¯ä»¥åœ¨å¼€å‘ä¸­ä½¿ç”¨æ³›å‹å‚æ•°æ¥å¯¹ç±»å‹è¿›è¡Œå»¶è¿Ÿç»‘å®šã€‚

### ä½¿ç”¨æ³›å‹å‚æ•°å’Œå¹½çµæ•°æ®ï¼ˆPhantomDataï¼‰æä¾›é¢å¤–ç±»å‹

åœ¨ç†Ÿæ‚‰äº†æ³›å‹å‚æ•°çš„åŸºæœ¬ç”¨æ³•åï¼Œæˆ‘æ¥è€ƒè€ƒä½ ï¼šç°åœ¨è¦è®¾è®¡ä¸€ä¸ª User å’Œ Product æ•°æ®ç»“æ„ï¼Œå®ƒä»¬éƒ½æœ‰ä¸€ä¸ª u64 ç±»å‹çš„ idã€‚ç„¶è€Œæˆ‘å¸Œæœ›æ¯ä¸ªæ•°æ®ç»“æ„çš„ id åªèƒ½å’ŒåŒç§ç±»å‹çš„ id æ¯”è¾ƒï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœ user.id å’Œ product.id æ¯”è¾ƒï¼Œç¼–è¯‘å™¨å°±èƒ½ç›´æ¥æŠ¥é”™ï¼Œæ‹’ç»è¿™ç§è¡Œä¸ºã€‚è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ

ä½ å¯ä»¥åœä¸‹æ¥å…ˆæƒ³ä¸€æƒ³ã€‚

å¾ˆå¯èƒ½ä¼šç«‹åˆ»æƒ³åˆ°è¿™ä¸ªåŠæ³•ã€‚å…ˆç”¨ä¸€ä¸ªè‡ªå®šä¹‰çš„æ•°æ®ç»“æ„ Identifier&lt;T&gt; æ¥è¡¨ç¤º idï¼š

```rust
pub struct Identifier<T> {
    inner: u64,
}
```

ç„¶åï¼Œåœ¨ User å’Œ Product ä¸­ï¼Œå„è‡ªç”¨ Identifier&lt;Self&gt; æ¥è®© Identifier å’Œè‡ªå·±çš„ç±»å‹ç»‘å®šï¼Œè¾¾åˆ°è®©ä¸åŒç±»å‹çš„ id æ— æ³•æ¯”è¾ƒçš„ç›®çš„ã€‚æœ‰äº†è¿™ä¸ªæ„æƒ³ï¼Œä½ å¯ä»¥å¾ˆå¿«å†™å‡ºè¿™æ ·çš„ä»£ç ï¼ˆ[ä»£ç ](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=d80dd549f6b57c7643381f75539ff1ca)ï¼‰ï¼š

```rust
#[derive(Debug, Default, PartialEq, Eq)]
pub struct Identifier<T> {
    inner: u64,
}

#[derive(Debug, Default, PartialEq, Eq)]
pub struct User {
    id: Identifier<Self>,
}

#[derive(Debug, Default, PartialEq, Eq)]
pub struct Product {
    id: Identifier<Self>,
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn id_should_not_be_the_same() {
        let user = User::default();
        let product = Product::default();

        // ä¸¤ä¸ª id ä¸èƒ½æ¯”è¾ƒï¼Œå› ä¸ºä»–ä»¬å±äºä¸åŒçš„ç±»å‹
        // assert_ne!(user.id, product.id);

        assert_eq!(user.id.inner, product.id.inner);
    }
}
```

ç„¶è€Œå®ƒæ— æ³•ç¼–è¯‘é€šè¿‡ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

å› ä¸º Identifier&lt;T&gt; åœ¨å®šä¹‰æ—¶ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨æ³›å‹å‚æ•° Tï¼Œç¼–è¯‘å™¨è®¤ä¸º T æ˜¯å¤šä½™çš„ï¼Œæ‰€ä»¥åªèƒ½æŠŠ T åˆ é™¤æ‰æ‰èƒ½ç¼–è¯‘é€šè¿‡ã€‚ä½†æ˜¯ï¼Œåˆ é™¤æ‰ Tï¼ŒUser å’Œ Product çš„ id å°±å¯ä»¥æ¯”è¾ƒäº†ï¼Œæˆ‘ä»¬å°±æ— æ³•å®ç°æƒ³è¦çš„åŠŸèƒ½äº†ï¼Œæ€ä¹ˆåŠï¼Ÿå”‰ï¼Œåˆšåˆšè¿˜è¸Œèº‡æ»¡å¿—è§‰å¾—å¯ä»¥ç”¨æ³›å‹æ¥æŒ‡ç‚¹æ±Ÿå±±ï¼Œç°åœ¨é¢å¯¹è¿™ä¹ˆä¸ªå°é—®é¢˜å´ä¸‡å¿µä¿±ç­ï¼Ÿ

åˆ«æ€¥ã€‚å¦‚æœä½ ä½¿ç”¨è¿‡ä»»ä½•å…¶ä»–æ”¯æŒæ³›å‹çš„è¯­è¨€ï¼Œæ— è®ºæ˜¯ Javaã€Swift è¿˜æ˜¯ TypeScriptï¼Œå¯èƒ½éƒ½æ¥è§¦è¿‡**Phantom Typeï¼ˆå¹½çµç±»å‹ï¼‰**çš„æ¦‚å¿µã€‚åƒåˆšæ‰çš„å†™æ³•ï¼ŒSwift / TypeScript ä¼šè®©å…¶é€šè¿‡ï¼Œå› ä¸ºå®ƒä»¬çš„ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æŠŠå¤šä½™çš„æ³›å‹å‚æ•°å½“æˆ Phantom type æ¥ç”¨ï¼Œæ¯”å¦‚ä¸‹é¢ TypeScript çš„ä¾‹å­ï¼Œå¯ä»¥ç¼–è¯‘ï¼š

```typescript
// NotUsed is allowed
class MyNumber<T, NotUsed> {
    inner: T;
    add: (x: T, y: T) => T;
}
```

ä½† Rust å¯¹æ­¤æœ‰æ´ç™–ã€‚Rust å¹¶ä¸å¸Œæœ›åœ¨å®šä¹‰ç±»å‹æ—¶ï¼Œå‡ºç°ç›®å‰è¿˜æ²¡ä½¿ç”¨ï¼Œä½†æœªæ¥ä¼šè¢«ä½¿ç”¨çš„æ³›å‹å‚æ•°ï¼Œæ‰€ä»¥ Rust ç¼–è¯‘å™¨å¯¹æ­¤æ— æƒ…æ‹’ç»ï¼ŒæŠŠé—¨å…³å¾—ä¸¥ä¸¥å®å®ã€‚

ä¸è¿‡ï¼Œåˆ«æ‹…å¿ƒï¼Œä½œä¸ºè¿‡æ¥äººï¼ŒRust çŸ¥é“ Phantom Type çš„å¿…è¦æ€§ï¼Œæ‰€ä»¥å¼€äº†ä¸€æ‰‡å« [PhantomData](https://doc.rust-lang.org/std/marker/struct.PhantomData.html) çš„çª—æˆ·ï¼šè®©æˆ‘ä»¬å¯ä»¥ç”¨ PhantomData æ¥æŒæœ‰ Phantom Typeã€‚PhantomData ä¸­æ–‡ä¸€èˆ¬ç¿»è¯‘æˆå¹½çµæ•°æ®ï¼Œè¿™åå­—é€ç€ä¸€è‚¡è®©äººä¸æ•¢äº²è¿‘çš„é‚ªé­…ï¼Œä½†å®ƒ**è¢«å¹¿æ³›ç”¨åœ¨å¤„ç†ï¼Œæ•°æ®ç»“æ„å®šä¹‰è¿‡ç¨‹ä¸­ä¸éœ€è¦ï¼Œä½†æ˜¯åœ¨å®ç°è¿‡ç¨‹ä¸­éœ€è¦çš„æ³›å‹å‚æ•°**ã€‚

æˆ‘ä»¬æ¥è¯•ä¸€ä¸‹ï¼š

```rust
use std::marker::PhantomData;

#[derive(Debug, Default, PartialEq, Eq)]
pub struct Identifier<T> {
    inner: u64,
    _tag: PhantomData<T>,
}

#[derive(Debug, Default, PartialEq, Eq)]
pub struct User {
    id: Identifier<Self>,
}

#[derive(Debug, Default, PartialEq, Eq)]
pub struct Product {
    id: Identifier<Self>,
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn id_should_not_be_the_same() {
        let user = User::default();
        let product = Product::default();

        // ä¸¤ä¸ª id ä¸èƒ½æ¯”è¾ƒï¼Œå› ä¸ºä»–ä»¬å±äºä¸åŒçš„ç±»å‹
        // assert_ne!(user.id, product.id);

        assert_eq!(user.id.inner, product.id.inner);
    }
}
```

Bingoï¼ç¼–è¯‘é€šè¿‡ï¼åœ¨ä½¿ç”¨äº† PhantomData åï¼Œç¼–è¯‘å™¨å…è®¸æ³›å‹å‚æ•° T çš„å­˜åœ¨ã€‚

ç°åœ¨æˆ‘ä»¬ç¡®è®¤äº†ï¼š**åœ¨å®šä¹‰æ•°æ®ç»“æ„æ—¶ï¼Œå¯¹äºé¢å¤–çš„ã€æš‚æ—¶ä¸éœ€è¦çš„æ³›å‹å‚æ•°ï¼Œç”¨ PhantomData æ¥â€œæ‹¥æœ‰â€å®ƒä»¬ï¼Œè¿™æ ·å¯ä»¥è§„é¿ç¼–è¯‘å™¨çš„æŠ¥é”™**ã€‚PhantomData æ­£å¦‚å…¶åï¼Œå®ƒå®é™…ä¸Šé•¿åº¦ä¸ºé›¶ï¼Œæ˜¯ä¸ª ZSTï¼ˆZero-Sized Typeï¼‰ï¼Œå°±åƒä¸å­˜åœ¨ä¸€æ ·ï¼Œå”¯ä¸€ä½œç”¨å°±æ˜¯ç±»å‹çš„æ ‡è®°ã€‚

å†æ¥å†™ä¸€ä¸ªä¾‹å­ï¼ŒåŠ æ·±å¯¹ PhantomData çš„ç†è§£ï¼ˆ[ä»£ç ](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=d7ae09e39026cba20b6bc0c4a92f458f)ï¼‰ï¼š

```rust
use std::{
    marker::PhantomData,
    sync::atomic::{AtomicU64, Ordering},
};

static NEXT_ID: AtomicU64 = AtomicU64::new(1);

pub struct Customer<T> {
    id: u64,
    name: String,
    _type: PhantomData<T>,
}

pub trait Free {
    fn feature1(&self);
    fn feature2(&self);
}

pub trait Personal: Free {
    fn advance_feature(&self);
}

impl<T> Free for Customer<T> {
    fn feature1(&self) {
        println!("feature 1 for {}", self.name);
    }

    fn feature2(&self) {
        println!("feature 2 for {}", self.name);
    }
}

impl Personal for Customer<PersonalPlan> {
    fn advance_feature(&self) {
        println!(
            "Dear {}(as our valuable customer {}), enjoy this advanced feature!",
            self.name, self.id
        );
    }
}

pub struct FreePlan;
pub struct PersonalPlan(f32);

impl<T> Customer<T> {
    pub fn new(name: String) -> Self {
        Self {
            id: NEXT_ID.fetch_add(1, Ordering::Relaxed),
            name,
            _type: PhantomData::default(),
        }
    }
}

impl From<Customer<FreePlan>> for Customer<PersonalPlan> {
    fn from(c: Customer<FreePlan>) -> Self {
        Self::new(c.name)
    }
}

/// è®¢é˜…æˆä¸ºä»˜è´¹ç”¨æˆ·
pub fn subscribe(customer: Customer<FreePlan>, payment: f32) -> Customer<PersonalPlan> {
    let _plan = PersonalPlan(payment);
    // å­˜å‚¨ plan åˆ° DB
    // ...
    customer.into()
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_customer() {
        // ä¸€å¼€å§‹æ˜¯ä¸ªå…è´¹ç”¨æˆ·
        let customer = Customer::<FreePlan>::new("Tyr".into());
        // ä½¿ç”¨å…è´¹ feature
        customer.feature1();
        customer.feature2();
        // ç”¨ç€ç”¨ç€è§‰å¾—äº§å“ä¸é”™æ„¿æ„ä»˜è´¹
        let customer = subscribe(customer, 6.99);
        customer.feature1();
        customer.feature1();
        // ä»˜è´¹ç”¨æˆ·è§£é”äº†æ–°æŠ€èƒ½
        customer.advance_feature();
    }
}
```

åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼ŒCustomer æœ‰ä¸ªé¢å¤–çš„ç±»å‹ Tã€‚

é€šè¿‡ç±»å‹ Tï¼Œæˆ‘ä»¬å¯ä»¥å°†ç”¨æˆ·åˆ†æˆä¸åŒçš„ç­‰çº§ï¼Œæ¯”å¦‚å…è´¹ç”¨æˆ·æ˜¯ Customer&lt;FreePlan&gt;ã€ä»˜è´¹ç”¨æˆ·æ˜¯ Customer&lt;PersonalPlan&gt;ï¼Œå…è´¹ç”¨æˆ·å¯ä»¥è½¬åŒ–æˆä»˜è´¹ç”¨æˆ·ï¼Œè§£é”æ›´å¤šæƒç›Šã€‚ä½¿ç”¨ PhantomData å¤„ç†è¿™æ ·çš„çŠ¶æ€ï¼Œå¯ä»¥åœ¨ç¼–è¯‘æœŸåšçŠ¶æ€çš„æ£€æµ‹ï¼Œé¿å…è¿è¡ŒæœŸæ£€æµ‹çš„è´Ÿæ‹…å’Œæ½œåœ¨çš„é”™è¯¯ã€‚

### ä½¿ç”¨æ³›å‹å‚æ•°æ¥æä¾›å¤šä¸ªå®ç°

ç”¨æ³›å‹å‚æ•°åšå»¶è¿Ÿç»‘å®šã€ç»“åˆPhantomDataæ¥æä¾›é¢å¤–ç±»å‹ï¼Œæ˜¯æˆ‘ä»¬ç»å¸¸èƒ½çœ‹åˆ°çš„æ³›å‹å‚æ•°çš„ç”¨æ³•ã€‚

æœ‰æ—¶å€™ï¼Œå¯¹äºåŒä¸€ä¸ª traitï¼Œæˆ‘ä»¬æƒ³è¦æœ‰ä¸åŒçš„å®ç°ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿæ¯”å¦‚ä¸€ä¸ªæ–¹ç¨‹ï¼Œå®ƒå¯ä»¥æ˜¯çº¿æ€§æ–¹ç¨‹ï¼Œä¹Ÿå¯ä»¥æ˜¯äºŒæ¬¡æ–¹ç¨‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸ºä¸åŒçš„ç±»å‹å®ç°ä¸åŒ Iteratorã€‚å¯ä»¥è¿™æ ·åšï¼ˆ[ä»£ç ](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=123d1c5c030d1719d5d2de39bb5f8b10)ï¼‰ï¼š

```rust
use std::marker::PhantomData;

#[derive(Debug, Default)]
pub struct Equation<IterMethod> {
    current: u32,
    _method: PhantomData<IterMethod>,
}

// çº¿æ€§å¢é•¿
#[derive(Debug, Default)]
pub struct Linear;

// äºŒæ¬¡å¢é•¿
#[derive(Debug, Default)]
pub struct Quadratic;

impl Iterator for Equation<Linear> {
    type Item = u32;

    fn next(&mut self) -> Option<Self::Item> {
        self.current += 1;
        if self.current >= u32::MAX {
            return None;
        }

        Some(self.current)
    }
}

impl Iterator for Equation<Quadratic> {
    type Item = u32;

    fn next(&mut self) -> Option<Self::Item> {
        self.current += 1;
        if self.current >= u16::MAX as u32 {
            return None;
        }

        Some(self.current * self.current)
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_linear() {
        let mut equation = Equation::<Linear>::default();
        assert_eq!(Some(1), equation.next());
        assert_eq!(Some(2), equation.next());
        assert_eq!(Some(3), equation.next());
    }

    #[test]
    fn test_quadratic() {
        let mut equation = Equation::<Quadratic>::default();
        assert_eq!(Some(1), equation.next());
        assert_eq!(Some(4), equation.next());
        assert_eq!(Some(9), equation.next());
    }
}
```

è¿™ä¸ªä»£ç å¾ˆå¥½ç†è§£ï¼Œä½†ä½ å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼šè¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸æ„å»ºä¸¤ä¸ªæ•°æ®ç»“æ„ LinearEquation å’Œ QuadraticEquationï¼Œåˆ†åˆ«å®ç° Iterator å‘¢ï¼Ÿ

çš„ç¡®ï¼Œå¯¹äºè¿™ä¸ªä¾‹å­ï¼Œä½¿ç”¨æ³›å‹çš„æ„ä¹‰å¹¶ä¸å¤§ï¼Œå› ä¸º Equation è‡ªèº«æ²¡æœ‰å¾ˆå¤šå…±äº«çš„ä»£ç ã€‚ä½†å¦‚æœ Equationï¼Œåªé™¤äº†å®ç° Iterator çš„é€»è¾‘ä¸ä¸€æ ·ï¼Œå…¶å®ƒå¤§é‡çš„ä»£ç éƒ½æ˜¯ç›¸åŒçš„ï¼Œå¹¶ä¸”æœªæ¥é™¤äº†ä¸€æ¬¡æ–¹ç¨‹å’ŒäºŒæ¬¡æ–¹ç¨‹ï¼Œè¿˜ä¼šæ”¯æŒä¸‰æ¬¡ã€å››æ¬¡â€¦â€¦ï¼Œé‚£ä¹ˆï¼Œ**ç”¨æ³›å‹æ•°æ®ç»“æ„æ¥ç»Ÿä¸€ç›¸åŒçš„é€»è¾‘ï¼Œç”¨æ³›å‹å‚æ•°çš„å…·ä½“ç±»å‹æ¥å¤„ç†å˜åŒ–çš„é€»è¾‘**ï¼Œå°±éå¸¸æœ‰å¿…è¦äº†ã€‚

æ¥çœ‹ä¸€ä¸ªçœŸå®å­˜åœ¨çš„ä¾‹å­[AsyncProstReader](https://docs.rs/async-prost/0.2.1/src/async_prost/reader.rs.html#26-31)ï¼Œå®ƒæ¥è‡ªä¹‹å‰æˆ‘ä»¬åœ¨ KV server é‡Œç”¨è¿‡çš„ [async-prost](https://docs.rs/async-prost/0.2.1/async_prost/) åº“ã€‚async-prost åº“ï¼Œå¯ä»¥æŠŠ TCP æˆ–è€…å…¶ä»–åè®®ä¸­çš„ stream é‡Œä¼ è¾“çš„æ•°æ®ï¼Œåˆ†æˆä¸€ä¸ªä¸ª frame å¤„ç†ã€‚å…¶ä¸­çš„ AsyncProstReader ä¸º AsyncDestination å’Œ AsyncFrameDestination æä¾›äº†ä¸åŒçš„å®ç°ï¼Œä½ å¯ä»¥ä¸ç”¨å…³å¿ƒå®ƒå…·ä½“åšäº†äº›ä»€ä¹ˆï¼Œåªè¦å­¦ä¹ å®ƒçš„æ¥å£çš„è®¾è®¡ï¼š

```rust
/// A marker that indicates that the wrapping type is compatible with `AsyncProstReader` with Prost support.
#[derive(Debug)]
pub struct AsyncDestination;

/// a marker that indicates that the wrapper type is compatible with `AsyncProstReader` with Framed support.
#[derive(Debug)]
pub struct AsyncFrameDestination;

/// A wrapper around an async reader that produces an asynchronous stream of prost-decoded values
#[derive(Debug)]
pub struct AsyncProstReader<R, T, D> {
    reader: R,
    pub(crate) buffer: BytesMut,
    into: PhantomData<T>,
    dest: PhantomData<D>,
}
```

è¿™ä¸ªæ•°æ®ç»“æ„è™½ç„¶ä½¿ç”¨äº†ä¸‰ä¸ªæ³›å‹å‚æ•°ï¼Œå…¶å®æ•°æ®ç»“æ„ä¸­çœŸæ­£ç”¨åˆ°çš„åªæœ‰ä¸€ä¸ª Rï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªå®ç°äº† AsyncRead çš„æ•°æ®ç»“æ„ï¼ˆç¨åä¼šçœ‹åˆ°ï¼‰ã€‚**å¦å¤–ä¸¤ä¸ªæ³›å‹å‚æ•° T å’Œ Dï¼Œåœ¨æ•°æ®ç»“æ„å®šä¹‰çš„æ—¶å€™å…¶å®å¹¶ä¸éœ€è¦ï¼Œåªæ˜¯åœ¨æ•°æ®ç»“æ„çš„å®ç°è¿‡ç¨‹ä¸­ï¼Œæ‰éœ€è¦ç”¨åˆ°å®ƒä»¬çš„çº¦æŸ**ã€‚å…¶ä¸­ï¼Œ

- T æ˜¯ä» R ä¸­è¯»å–å‡ºçš„æ•°æ®ååºåˆ—åŒ–å‡ºæ¥çš„ç±»å‹ï¼Œåœ¨å®ç°æ—¶ç”¨ prost::Message çº¦æŸã€‚
- D æ˜¯ä¸€ä¸ªç±»å‹å ä½ç¬¦ï¼Œå®ƒä¼šæ ¹æ®éœ€è¦è¢«å…·ä½“åŒ–ä¸º AsyncDestination æˆ–è€… AsyncFrameDestinationã€‚

ç±»å‹å‚æ•° D å¦‚ä½•ä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæƒ³åƒä¸€ä¸‹ã€‚å®ç° AsyncProstReader çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨ä½¿ç”¨ AsyncDestination æ—¶ï¼Œæä¾›ä¸€ç§å®ç°ï¼Œè€Œåœ¨ä½¿ç”¨ AsyncFrameDestination æ—¶ï¼Œæä¾›å¦ä¸€ç§å®ç°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™é‡Œçš„ç±»å‹å‚æ•° Dï¼Œåœ¨ impl çš„æ—¶å€™ï¼Œä¼šè¢«å…·ä½“åŒ–æˆæŸä¸ªç±»å‹ã€‚

æ‹¿ç€è¿™ä¸ªæƒ³æ³•ï¼Œæ¥çœ‹ AsyncProstReader åœ¨å®ç° [Stream](https://docs.rs/futures/0.3.17/futures/prelude/trait.Stream.html) æ—¶ï¼ŒD æ˜¯å¦‚ä½•å…·ä½“åŒ–çš„ã€‚è¿™é‡Œä½ ä¸ç”¨å…³å¿ƒ Stream å…·ä½“æ˜¯ä»€ä¹ˆä»¥åŠå¦‚ä½•å®ç°ã€‚å®ç°çš„ä»£ç ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯æ¥å£ï¼ˆ[ä»£ç ](https://docs.rs/async-prost/0.2.1/src/async_prost/reader.rs.html#81-105)ï¼‰ï¼š

```rust
impl<R, T> Stream for AsyncProstReader<R, T, AsyncDestination>
where
    T: Message + Default,
    R: AsyncRead + Unpin,
{
    type Item = Result<T, io::Error>;

    fn poll_next(mut self: Pin<&mut Self>, cx: &mut Context<'_>) -> Poll<Option<Self::Item>> {
        ...
    }
}
```

å†çœ‹å¯¹å¦å¤–ä¸€ä¸ªå¯¹ D çš„å…·ä½“å®ç°ï¼š

```rust
impl<R, T> Stream for AsyncProstReader<R, T, AsyncFrameDestination>
where
    R: AsyncRead + Unpin,
    T: Framed + Default,
{
    type Item = Result<T, io::Error>;

    fn poll_next(mut self: Pin<&mut Self>, cx: &mut Context<'_>) -> Poll<Option<Self::Item>> {
        ...
    }
}
```

åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œé™¤äº† Stream çš„å®ç°ä¸åŒå¤–ï¼ŒAsyncProstReader çš„å…¶å®ƒå®ç°éƒ½æ˜¯å…±äº«çš„ã€‚æ‰€ä»¥æˆ‘ä»¬æœ‰å¿…è¦ä¸ºå…¶å¢åŠ ä¸€ä¸ªæ³›å‹å‚æ•° Dï¼Œä½¿å…¶å¯ä»¥æ ¹æ®ä¸åŒçš„ D çš„ç±»å‹ï¼Œæ¥æä¾›ä¸åŒçš„ Stream å®ç°ã€‚

AsyncProstReader ç»¼åˆä½¿ç”¨äº†æ³›å‹çš„ä¸‰ç§ç”¨æ³•ï¼Œæ„Ÿå…´è¶£çš„è¯ä½ å¯ä»¥çœ‹æºä»£ç ã€‚å¦‚æœä½ æ— æ³•ä¸€ä¸‹å­é¢†æ‚Ÿå®ƒçš„ä»£ç ï¼Œä¹Ÿä¸å¿…æ‹…å¿ƒã€‚å¾ˆå¤šæ—¶å€™ï¼Œè¿™æ ·çš„é«˜çº§æŠ€å·§åœ¨é˜…è¯»ä»£ç æ—¶ç”¨é€”ä¼šæ›´å¤§ä¸€äº›ï¼Œèµ·ç ä½ èƒ½ææ˜ç™½åˆ«äººçš„ä»£ç ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™ã€‚è‡³äºè‡ªå·±å†™çš„æ—¶å€™æ˜¯å¦è¦è¿™ä¹ˆç”¨ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±æŒæ¡çš„ç¨‹åº¦æ¥å†³å®šã€‚

æ¯•ç«Ÿï¼Œ**æˆ‘ä»¬å†™ä»£ç çš„é¦–è¦ç›®æ ‡æ˜¯æ­£ç¡®åœ°å®ç°æ‰€éœ€è¦çš„åŠŸèƒ½**ï¼Œåœ¨æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œä¼˜é›…ç®€æ´çš„è¡¨è¾¾æ‰æœ‰æ„ä¹‰ã€‚

## æ³›å‹å‡½æ•°çš„é«˜çº§æŠ€å·§

å¦‚æœä½ æŒæ¡äº†æ³›å‹æ•°æ®ç»“æ„çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œé‚£ä¹ˆæ³›å‹å‡½æ•°å¹¶ä¸å¤æ‚ï¼Œå› ä¸ºåœ¨ä½¿ç”¨æ³›å‹å‚æ•°å’Œå¯¹æ³›å‹å‚æ•°è¿›è¡Œçº¦æŸæ–¹é¢æ˜¯ä¸€è‡´çš„ã€‚

ä¹‹å‰çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»åœ¨å‡½æ•°å‚æ•°ä¸­å¤šæ¬¡ä½¿ç”¨æ³›å‹å‚æ•°äº†ï¼Œæƒ³å¿…ä½ å·²ç»æœ‰è¶³å¤Ÿçš„æŒæ¡ã€‚å…³äºæ³›å‹å‡½æ•°ï¼Œæˆ‘ä»¬è®²ä¸¤ç‚¹ï¼Œä¸€æ˜¯è¿”å›å€¼å¦‚æœæƒ³è¿”å›æ³›å‹å‚æ•°ï¼Œè¯¥æ€ä¹ˆå¤„ç†ï¼ŸäºŒæ˜¯å¯¹äºå¤æ‚çš„æ³›å‹å‚æ•°ï¼Œè¯¥å¦‚ä½•å£°æ˜ï¼Ÿ

### è¿”å›å€¼æºå¸¦æ³›å‹å‚æ•°æ€ä¹ˆåŠï¼Ÿ

åœ¨ KV server ä¸­ï¼Œæ„å»º Storage trait çš„ get\_iter æ¥å£æ—¶ï¼Œæˆ‘ä»¬å·²ç»è§åˆ°äº†è¿™æ ·çš„ç”¨æ³•ï¼š

```rust
pub trait Storage {
    ...
    /// éå† HashTableï¼Œè¿”å› kv pair çš„ Iterator
    fn get_iter(&self, table: &str) -> 
		    Result<Box<dyn Iterator<Item = Kvpair>>, KvError>;
}
```

å¯¹äº get\_iter() æ–¹æ³•ï¼Œå¹¶ä¸å…³å¿ƒè¿”å›å€¼æ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„ Iteratorï¼Œåªè¦å®ƒèƒ½å¤Ÿå…è®¸æˆ‘ä»¬ä¸æ–­è°ƒç”¨ next() æ–¹æ³•ï¼Œè·å¾—ä¸€ä¸ª Kvpair çš„ç»“æ„ï¼Œå°±å¯ä»¥äº†ã€‚åœ¨å®ç°é‡Œï¼Œä½¿ç”¨äº† trait objectã€‚

ä½ ä¹Ÿè®¸ä¼šæœ‰ç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ä½¿ç”¨ impl Iterator å‘¢ï¼Ÿ

```plain
// ç›®å‰ trait è¿˜ä¸æ”¯æŒ
fn get_iter(&self, table: &str) -> Result<impl Iterator<Item = Kvpair>, KvError>;
```

åŸå› æ˜¯ Rust ç›®å‰è¿˜ä¸æ”¯æŒåœ¨ trait é‡Œä½¿ç”¨ impl trait åšè¿”å›å€¼ï¼š

```rust
pub trait ImplTrait {
    // å…è®¸
    fn impl_in_args(s: impl Into<String>) -> String {
        s.into()
    }

    // ä¸å…è®¸
    fn impl_as_return(s: String) -> impl Into<String> {
        s
    }
}
```

é‚£ä¹ˆä½¿ç”¨æ³›å‹å‚æ•°åšè¿”å›å€¼å‘¢ï¼Ÿå¯ä»¥ï¼Œä½†æ˜¯åœ¨å®ç°çš„æ—¶å€™ä¼šå¾ˆéº»çƒ¦ï¼Œä½ å¾ˆéš¾åœ¨å‡½æ•°ä¸­æ­£ç¡®æ„é€ ä¸€ä¸ªè¿”å›æ³›å‹å‚æ•°çš„è¯­å¥ï¼š

```rust
// å¯ä»¥æ­£ç¡®ç¼–è¯‘
pub fn generics_as_return_working(i: u32) -> impl Iterator<Item = u32> {
    std::iter::once(i)
}

// æœŸå¾…æ³›å‹ç±»å‹ï¼Œå´è¿”å›ä¸€ä¸ªå…·ä½“ç±»å‹
pub fn generics_as_return_not_working<T: Iterator<Item = u32>>(i: u32) -> T {
    std::iter::once(i)
}
```

é‚£æ€ä¹ˆåŠï¼Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥è¿”å› trait objectï¼Œå®ƒæ¶ˆé™¤äº†ç±»å‹çš„å·®å¼‚ï¼ŒæŠŠæ‰€æœ‰ä¸åŒçš„å®ç° Iterator çš„ç±»å‹éƒ½ç»Ÿä¸€åˆ°ä¸€ä¸ªç›¸åŒçš„ trait object ä¸‹ï¼š

```rust
// è¿”å› trait object
pub fn trait_object_as_return_working(i: u32) -> Box<dyn Iterator<Item = u32>> {
    Box::new(std::iter::once(i))
}
```

æ˜ç™½äº†è¿™ä¸€ç‚¹ï¼Œå›åˆ°åˆšæ‰ KV serverçš„ Storage traitï¼š

```rust
pub trait Storage {
    ...
    /// éå† HashTableï¼Œè¿”å› kv pair çš„ Iterator
    fn get_iter(&self, table: &str) -> 
		    Result<Box<dyn Iterator<Item = Kvpair>>, KvError>;
}
```

ç°åœ¨ä½ æ˜¯ä¸æ˜¯æ›´å¥½åœ°ç†è§£äº†ï¼Œåœ¨è¿™ä¸ª trait é‡Œï¼Œä¸ºä½•æˆ‘ä»¬éœ€è¦ä½¿ç”¨ Box&lt;dyn Iterator&lt;Item = Kvpair&gt;&gt; ï¼Ÿ

ä¸è¿‡ä½¿ç”¨ trait object æ˜¯æœ‰é¢å¤–çš„ä»£ä»·çš„ï¼Œé¦–å…ˆè¿™é‡Œæœ‰ä¸€æ¬¡é¢å¤–çš„å †åˆ†é…ï¼Œå…¶æ¬¡åŠ¨æ€åˆ†æ´¾ä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½æŸå¤±ã€‚

### å¤æ‚çš„æ³›å‹å‚æ•°è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ

åœ¨æ³›å‹å‡½æ•°ä¸­ï¼Œæœ‰æ—¶å€™æ³›å‹å‚æ•°å¯ä»¥éå¸¸å¤æ‚ã€‚æ¯”å¦‚æ³›å‹å‚æ•°æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œé—­åŒ…è¿”å›ä¸€ä¸ª Iteratorï¼ŒIterator ä¸­çš„ Item åˆæœ‰æŸä¸ªçº¦æŸã€‚çœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š

```rust
pub fn comsume_iterator<F, Iter,  T>(mut f: F)
where
    F: FnMut(i32) -> Iter, // F æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œæ¥å— i32ï¼Œè¿”å› Iter ç±»å‹
    Iter: Iterator<Item = T>, // Iter æ˜¯ä¸€ä¸ª Iteratorï¼ŒItem æ˜¯ T ç±»å‹
    T: std::fmt::Debug, // T å®ç°äº† Debug trait
{
    // æ ¹æ® F çš„ç±»å‹ï¼Œf(10) è¿”å› iteratorï¼Œæ‰€ä»¥å¯ä»¥ç”¨ for å¾ªç¯
    for item in f(10) {
        println!("{:?}", item); // item å®ç°äº† Debug traitï¼Œæ‰€ä»¥å¯ä»¥ç”¨ {:?} æ‰“å°
    }
}
```

è¿™ä¸ªä»£ç çš„æ³›å‹å‚æ•°è™½ç„¶éå¸¸å¤æ‚ï¼Œä¸è¿‡ä¸€æ­¥æ­¥åˆ†è§£ï¼Œå…¶å®å¹¶ä¸éš¾ç†è§£å…¶å®è´¨ï¼š

1. å‚æ•° F æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œæ¥å— i32ï¼Œè¿”å› Iter ç±»å‹ï¼›
2. å‚æ•° Iter æ˜¯ä¸€ä¸ª Iteratorï¼ŒItem æ˜¯ T ç±»å‹ï¼›
3. å‚æ•° T æ˜¯ä¸€ä¸ªå®ç°äº† Debug trait çš„ç±»å‹ã€‚

è¿™ä¹ˆåˆ†è§£ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ï¼Œä¸ºä½•è¿™æ®µä»£ç èƒ½å¤Ÿç¼–è¯‘é€šè¿‡ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å†™å‡ºåˆé€‚çš„æµ‹è¯•ç¤ºä¾‹ï¼Œæ¥æµ‹è¯•å®ƒï¼š

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_consume_iterator() {
        // ä¸ä¼š panic æˆ–è€…å‡ºé”™
        comsume_iterator(|i| (0..i).into_iter())
    }
}
```

## å°ç»“

æ³›å‹ç¼–ç¨‹åœ¨ Rust å¼€å‘ä¸­å æ®ç€ä¸¾è¶³è½»é‡çš„åœ°ä½ï¼Œå‡ ä¹ä½ å†™çš„æ¯ä¸€æ®µä»£ç éƒ½æˆ–å¤šæˆ–å°‘ä¼šä½¿ç”¨åˆ°æ³›å‹æœ‰å…³çš„ç»“æ„ï¼Œæ¯”å¦‚æ ‡å‡†åº“çš„ Vec&lt;T&gt;ã€HashMap&lt;K, V&gt; ç­‰ã€‚å½“æˆ‘ä»¬è‡ªå·±æ„å»ºæ•°æ®ç»“æ„å’Œå‡½æ•°æ—¶è¦æ€è€ƒï¼Œæ˜¯å¦ä½¿ç”¨æ³›å‹å‚æ•°ï¼Œè®©ä»£ç æ›´åŠ çµæ´»ã€å¯æ‰©å±•æ€§æ›´å¼ºã€‚

å½“ç„¶ï¼Œæ³›å‹ç¼–ç¨‹ä¹Ÿæ˜¯ä¸€æŠŠåŒåˆƒå‰‘ã€‚ä»»ä½•æ—¶å€™ï¼Œå½“æˆ‘ä»¬å¼•å…¥æŠ½è±¡ï¼Œå³ä¾¿èƒ½åšåˆ°é›¶æˆæœ¬æŠ½è±¡ï¼Œè¦è®°å¾—æŠ½è±¡æœ¬èº«ä¹Ÿæ˜¯ä¸€ç§æˆæœ¬ã€‚

å½“æˆ‘ä»¬æŠŠä»£ç æŠ½è±¡æˆå‡½æ•°ã€æŠŠæ•°æ®ç»“æ„æŠ½è±¡æˆæ³›å‹ç»“æ„ï¼Œå³ä¾¿è¿è¡Œæ—¶å‡ ä¹å¹¶æ— æ·»åŠ é¢å¤–æˆæœ¬ï¼Œå®ƒè¿˜æ˜¯ä¼šå¸¦æ¥è®¾è®¡æ—¶çš„æˆæœ¬ï¼Œå¦‚æœæŠ½è±¡å¾—ä¸å¥½ï¼Œè¿˜ä¼šå¸¦æ¥æ›´å¤§çš„ç»´æŠ¤ä¸Šçš„æˆæœ¬ã€‚**åšç³»ç»Ÿè®¾è®¡ï¼Œæˆ‘ä»¬è€ƒè™‘ ROIï¼ˆReturn On Investmentï¼‰æ—¶ï¼Œè¦æŠŠ TCOï¼ˆTotal Cost of Ownershipï¼‰ä¹Ÿè€ƒè™‘è¿›å»**ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¿‡åº¦è®¾è®¡çš„ç³»ç»Ÿå’Œä¸åšè®¾è®¡çš„ç³»ç»Ÿï¼Œå®ƒä»¬é•¿æœŸçš„ TCO éƒ½éå¸¸ç³Ÿç³•ã€‚

å»ºè®®ä½ åœ¨è‡ªå·±çš„ä»£ç ä¸­ä½¿ç”¨å¤æ‚çš„æ³›å‹ç»“æ„å‰ï¼Œæœ€å¥½å…ˆåšä¸€äº›å‡†å¤‡ã€‚

é¦–å…ˆï¼Œè‡ªç„¶æ˜¯äº†è§£ä½¿ç”¨æ³›å‹çš„åœºæ™¯ï¼Œä»¥åŠä¸»è¦çš„æ¨¡å¼ï¼Œå°±åƒæœ¬æ–‡ä»‹ç»çš„é‚£æ ·ï¼›ä¹‹åï¼Œå¯ä»¥å¤šè¯»åˆ«äººçš„ä»£ç ï¼Œå¤šçœ‹ä¼˜ç§€çš„ç³»ç»Ÿï¼Œéƒ½æ˜¯å¦‚ä½•ä½¿ç”¨æ³›å‹æ¥è§£å†³å®é™…é—®é¢˜çš„ã€‚åŒæ—¶ï¼Œä¸è¦ç€æ€¥æŠŠå¤æ‚çš„æ³›å‹å¼•å…¥åˆ°ä½ è‡ªå·±çš„ç³»ç»Ÿä¸­ï¼Œå¯ä»¥å…ˆå¤šå†™ä¸€äº›å°çš„ã€æµ‹è¯•æ€§è´¨çš„ä»£ç ï¼Œå°±åƒæ–‡ä¸­çš„é‚£äº›ç¤ºä¾‹ä»£ç ä¸€æ ·ï¼Œä»å°å¤„ç€æ‰‹ï¼Œå»æ›´æ·±å…¥åœ°ç†è§£æ³›å‹ï¼›

æœ‰äº†è¿™äº›å‡†å¤‡æ‰“åº•ï¼Œæœ€ååœ¨ä½ çš„å¤§å‹é¡¹ç›®ä¸­ï¼Œéœ€è¦çš„æ—¶å€™å¼•å…¥è‡ªå·±çš„æ³›å‹æ•°æ®ç»“æ„æˆ–è€…å‡½æ•°ï¼Œå»è§£å†³å®é™…é—®é¢˜ã€‚

### æ€è€ƒé¢˜

å¦‚æœä½ ç†è§£äº†ä»Šå¤©è®²çš„æ³›å‹çš„ç”¨æ³•ï¼Œé‚£ä¹ˆé˜…è¯» [futures](https://docs.rs/futures/0.3.17) åº“æ—¶ï¼Œé‡åˆ°ç±»ä¼¼çš„å¤æ‚æ³›å‹å£°æ˜ï¼Œæ¯”å¦‚è¯´ [StreamExt](https://docs.rs/futures/0.3.17/futures/stream/trait.StreamExt.html) trait çš„ [for\_each\_concurrent](https://docs.rs/futures/0.3.17/futures/stream/trait.StreamExt.html#method.for_each_concurrent)ï¼Œä½ èƒ½ææ˜ç™½å®ƒçš„å‚æ•° f ä»£è¡¨ä»€ä¹ˆå—ï¼Ÿä½ è¯¥æ€ä¹ˆä½¿ç”¨è¿™ä¸ªæ–¹æ³•å‘¢ï¼Ÿ

```rust
fn for_each_concurrent<Fut, F>(
    self,
    limit: impl Into<Option<usize>>,
    f: F,
) -> ForEachConcurrent<Self, Fut, F>
where
    F: FnMut(Self::Item) -> Fut,
    Fut: Future<Output = ()>,
    Self: Sized,
{
{ ... }
```

ä»Šå¤©ä½ å·²ç»å®Œæˆäº†Rustå­¦ä¹ çš„ç¬¬23æ¬¡æ‰“å¡ã€‚å¦‚æœä½ è§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·è®¨è®ºã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ9ï¼‰</strong></div><ul>
<li><span>ç½—æ°</span> ğŸ‘ï¼ˆ15ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>impl Iterator for Equation&lt;Quadratic&gt; åˆ¤æ–­è¿”å› None çš„åœ°æ–¹æ˜¯ä¸æ˜¯åº”è¯¥å†™æˆ `if self.current &gt;= u16::MAX as u32`ï¼Œä¸ç„¶ä¼šæœ‰é€»è¾‘é”™è¯¯ã€‚</p>2021-10-20</li><br/><li><span>Marvichov</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å’Œè€å¸ˆçš„å¯¹åº”ä¸‹...

1. ä½¿ç”¨æ³›å‹å‚æ•°å»¶è¿Ÿæ•°æ®ç»“æ„çš„ç»‘å®šï¼›
2. ä½¿ç”¨æ³›å‹å‚æ•°å’Œ PhantomDataï¼Œå£°æ˜æ•°æ®ç»“æ„ä¸­ä¸ç›´æ¥ä½¿ç”¨ï¼Œä½†åœ¨å®ç°è¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°çš„ç±»å‹
3. ä½¿ç”¨æ³›å‹å‚æ•°è®©åŒä¸€ä¸ªæ•°æ®ç»“æ„å¯¹åŒä¸€ä¸ª trait å¯ä»¥æ‹¥æœ‰ä¸åŒçš„å®ç°ã€‚

1. é¢å‘interfaceç¼–ç¨‹; åªä¸è¿‡é™æ€å¤šæ€
2. å¼•å…¥è‡ªç”±å‚æ•° -&gt; å¤§éƒ¨åˆ†implå…±äº«; å‰©ä¸‹çš„, æ ¹æ®è‡ªç”±å‚æ•°ç±»å‹çš„ä¸åŒåštemplate specialization -&gt; æ¯”å¦‚tag struct -&gt; æœ¬è´¨è¿˜æ˜¯ä»£ç å…±äº«
3. NewTypePattern; ä¸€å¥—ä»£ç ç»™å¤šä¸ªä¸åŒçš„typeå…±ç”¨; è¿™ä¸ªblogé‡Œé¢çš„ä¾‹å­æ¯”è¾ƒç”ŸåŠ¨: https:&#47;&#47;www.greyblake.com&#47;blog&#47;2021-10-11-phantom-types-in-rust&#47;; golangé‡Œé¢ä¹Ÿç»å¸¸ç”¨kilometer, mileæ¥åšä¾‹å­, ç±»ä¼¼äº`type mile i32`;</p>2021-10-18</li><br/><li><span>Marvichov</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>Cppé‡Œé¢ç”¨tagå’Œå¤šgeneric paramçš„ä¾‹å­ä¹Ÿå¾ˆå¤šâ€¦

æ¯”å¦‚Cppçš„iterator, å¤šä¸ªæ³›å‹åšå‚æ•°, ä¸éœ€è¦PhantomData; 

    template&lt;
        class Category,  &#47;&#47; tag data, ç±»ä¼¼äº AsyncProstReader D
        class T,
        class Distance = std::ptrdiff_t,
        class Pointer = T*,
        class Reference = T&amp;
    &gt; struct iterator;

æ‰€ä»¥, æ„Ÿè§‰PhantomDataçš„ä¸»è¦ç”¨é€”æ˜¯compile time ownership check;

æˆ‘çš„ç–‘é—®ä¹Ÿå°±ä¸»è¦é›†ä¸­åœ¨ownership...

é—®é¢˜1:

from PhantomData doc:
&gt; Adding a PhantomData field to your type tells the compiler that your type acts as though it stores a value of type T, even though it doesnâ€™t really. 

ä¸å¤ªæ˜ç™½, ä¸ºå•¥éœ€è¦ownership. æ¯”å¦‚AsyncProstReaderçš„Tæ˜¯çº¦æŸRçš„return typeçš„, æŒ‰ç†è¯´ä¸ç”¨own T;  è€Œä¸”intoå’Œdest memberå…¨ç¨‹æ²¡è¢«è°ƒç”¨è¿‡


    &#47;&#47;&#47; A wrapper around an async reader that produces an asynchronous stream of prost-decoded values
    #[derive(Debug)]
    pub struct AsyncProstReader&lt;R, T, D&gt; {
        reader: R,
        pub(crate) buffer: BytesMut,
        into: PhantomData&lt;T&gt;,
        dest: PhantomData&lt;D&gt;,
    }

å¦‚æœä¸éœ€è¦å¯¹T, Dçš„ownership, ä¸ºå•¥ä¸æ¥ä¸ª`PhantomDataNotOwned`æ¥æ»¡è¶³è¿™æ ·çš„åœºæ™¯: ä¸éœ€è¦ownership, ä½†æ˜¯è¿™ä¸ªgeneric type Tä¸æ˜¯å¤šä½™çš„å‘¢?

----

é—®é¢˜2:

&gt; This information is used when computing certain safety properties.

è¿™å¥ç›®å‰ç†è§£ä¸äº†â€¦å‡è®¾å¯¹Tæœ‰ownership, æ²¡çœ‹å‡ºæœ‰å•¥ç‰¹æ®Šçš„safetyéœ€æ±‚
</p>2021-10-18</li><br/><li><span>Quincy</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>1. å‚æ•° F æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œæ¥æ”¶ Self::Item,è¿”å› Fut ç±»å‹ï¼›
2. å‚æ•° Fut æ˜¯ä¸€ä¸ª Future&lt;Output=()&gt;;

æ‰€ä»¥ f æ˜¯ä¸€ä¸ªé—­åŒ…æ¥æ”¶ Self::Item é—­åŒ…çš„è¿”å›å€¼æ˜¯ Future&lt;Output=()&gt;

ä½¿ç”¨å‚è€ƒæºä»£ç ï¼š

```rust
.for_each_concurrent(
    &#47;* limit *&#47; 2,
    |rx| async move {
        rx.await.unwrap();
    }
)
```
</p>2021-10-28</li><br/><li><span>æ¸¡é¸¦10086</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å…³äºæ€è€ƒé¢˜ï¼š
f æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œä»¥ `Self::Item` ç±»å‹ä½œä¸ºè¾“å…¥ï¼Œä»¥ä¸€ä¸ªå®ç°äº† `Future` trait çš„ç±»å‹ Fut ä½œä¸ºè¾“å‡ºï¼Œå…¶ä¸­`Future` çš„å…³è”ç±»å‹ `Output` æ˜¯ unit ç±»å‹</p>2022-01-16</li><br/><li><span>Geek_7c0961</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è€å¸ˆç°åœ¨implement trait ç”¨åœ¨è¿”å›å€¼çš„ç±»å‹äº†,é‚£ä¹ˆ trait obejctè¿˜æœ‰ä»€ä¹ˆç”¨å¤„ä¹ˆ?å®ƒçš„æ€§èƒ½é‚£ä¹ˆå·®.
https:&#47;&#47;doc.rust-lang.org&#47;rust-by-example&#47;trait&#47;impl_trait.html</p>2022-05-16</li><br/><li><span>A.Y.</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å…³äºç¬¬ä¸‰ç‚¹ä½¿ç”¨åœºæ™¯ï¼Œä¼¼ä¹å¯ä»¥ç”¨äºæ›¿ä»£å…¶ä»–é¢å‘å¯¹è±¡è¯­è¨€ä¸­æœ‰è€Œrustä¸æ”¯æŒçš„ç±»ç»§æ‰¿ã€‚</p>2022-05-07</li><br/><li><span>ğŸ²ç¤sir</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç»ˆäºæ˜ç™½substrateçš„frame&#47;executiv&#47;src&#47;lib.rsé‡Œé¢è¿™æ®µä»£ç çš„ç”¨æ„ï¼š</p>2022-09-11</li><br/><li><span>zahi</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>phantom type çš„ä¾‹å­ï¼Œæ„Ÿè§‰åƒjavaä¸­çš„ç»§æ‰¿ã€‚</p>2022-08-14</li><br/>
</ul>