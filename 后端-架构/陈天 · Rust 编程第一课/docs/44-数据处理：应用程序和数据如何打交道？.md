ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚

æˆ‘ä»¬å¼€å‘è€…æ— è®ºæ˜¯ä»äº‹æœåŠ¡ç«¯çš„å¼€å‘ï¼Œè¿˜æ˜¯å®¢æˆ·ç«¯çš„å¼€å‘ï¼Œå’Œæ•°æ®æ‰“äº¤é“æ˜¯å¿…ä¸å¯å°‘çš„ã€‚

å¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œä»æœåŠ¡ç«¯è¯»å–åˆ°çš„æ•°æ®ï¼Œå¾€å¾€éœ€è¦åšç¼“å­˜ï¼ˆå†…å­˜ç¼“å­˜æˆ–è€… SQLite ç¼“å­˜ï¼‰ï¼Œç”šè‡³éœ€è¦æœ¬åœ°å­˜å‚¨ï¼ˆæ–‡ä»¶æˆ–è€… SQLiteï¼‰ã€‚

å¯¹äºæœåŠ¡å™¨æ¥è¯´ï¼Œè·Ÿæ•°æ®æ‰“äº¤é“çš„åœºæ™¯å°±æ›´åŠ ä¸°å¯Œäº†ã€‚é™¤äº†æ•°æ®åº“å’Œç¼“å­˜å¤–ï¼Œè¿˜æœ‰å¤§é‡æ–‡æœ¬æ•°æ®çš„ç´¢å¼•ï¼ˆæ¯”å¦‚æœç´¢å¼•æ“ï¼‰ã€å®æ—¶çš„æ¶ˆæ¯é˜Ÿåˆ—å¯¹æ•°æ®åšæµå¼å¤„ç†ï¼Œæˆ–è€…éå®æ—¶çš„æ‰¹å¤„ç†å¯¹æ•°æ®ä»“åº“ï¼ˆdata warehouseï¼‰ä¸­çš„æµ·é‡æ•°æ®è¿›è¡Œ ETLï¼ˆExtractã€Transform and Loadï¼‰ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/1c/eb/1c42e693f0848b4a389870f848ffaeeb.png?wh=1482x807)

ä»Šå¤©æˆ‘ä»¬å°±æ¥è®²è®²å¦‚ä½•ç”¨ Rust åšæ•°æ®å¤„ç†ï¼Œä¸»è¦è®²ä¸¤éƒ¨åˆ†ï¼Œå¦‚ä½•ç”¨ Rust è®¿é—®å…³ç³»æ•°æ®åº“ï¼Œä»¥åŠå¦‚ä½•ç”¨ Rust å¯¹åŠç»“æ„åŒ–æ•°æ®è¿›è¡Œåˆ†æå’Œå¤„ç†ã€‚å¸Œæœ›é€šè¿‡å­¦ä¹ è¿™ä¸€è®²çš„å†…å®¹ï¼Œå°¤å…¶æ˜¯ååŠéƒ¨åˆ†çš„å†…å®¹ï¼Œèƒ½å¸®ä½ æ‰“å¼€çœ¼ç•Œï¼Œå¯¹æ•°æ®å¤„ç†æœ‰æ›´åŠ æ·±åˆ»çš„è®¤è¯†ã€‚

## è®¿é—®å…³ç³»æ•°æ®åº“

ä½œä¸ºäº’è”ç½‘åº”ç”¨çš„æœ€ä¸»è¦çš„æ•°æ®å­˜å‚¨å’Œè®¿é—®å·¥å…·ï¼Œå…³ç³»æ•°æ®åº“ï¼Œæ˜¯å‡ ä¹æ¯é—¨ç¼–ç¨‹è¯­è¨€éƒ½æœ‰è‰¯å¥½æ”¯æŒçš„æ•°æ®åº“ç±»å‹ã€‚

åœ¨ Rust ä¸‹ï¼Œæœ‰å‡ ä¹æ‰€æœ‰ä¸»æµå…³ç³»æ•°æ®åº“çš„é©±åŠ¨ï¼Œæ¯”å¦‚ [rust-postgresã€rust-mysql-simple](https://github.com/sfackler/rust-postgres) ç­‰ï¼Œä¸è¿‡ä¸€èˆ¬æˆ‘ä»¬ä¸å¤ªä¼šç›´æ¥ä½¿ç”¨æ•°æ®åº“çš„é©±åŠ¨æ¥è®¿é—®æ•°æ®åº“ï¼Œå› ä¸ºé‚£æ ·ä¼šè®©åº”ç”¨è¿‡äºè€¦åˆäºæŸä¸ªæ•°æ®åº“ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šä½¿ç”¨ ORMã€‚

Rust ä¸‹æœ‰ [diesel](https://diesel.rs/) è¿™ä¸ªéå¸¸æˆç†Ÿçš„ ORMï¼Œè¿˜æœ‰ [sea-orm](https://github.com/SeaQL/sea-orm) è¿™æ ·çš„åèµ·ä¹‹ç§€ã€‚diesel ä¸æ”¯æŒå¼‚æ­¥ï¼Œè€Œ sea-orm æ”¯æŒå¼‚æ­¥ï¼Œæ‰€ä»¥ï¼Œæœ‰ç†ç”±ç›¸ä¿¡ï¼Œéšç€ sea-orm çš„ä¸æ–­æˆç†Ÿï¼Œä¼šæœ‰è¶Šæ¥è¶Šå¤šçš„åº”ç”¨åœ¨ sea-orm ä¸Šæ„å»ºã€‚

å¦‚æœä½ è§‰å¾— ORM å¤ªè¿‡ç¬¨é‡ï¼Œç¹æ–‡ç¼›èŠ‚å¤ªå¤šï¼Œä½†åˆä¸æƒ³ç›´æ¥ä½¿ç”¨æŸä¸ªæ•°æ®åº“çš„é©±åŠ¨æ¥è®¿é—®æ•°æ®åº“ï¼Œé‚£ä¹ˆä½ è¿˜å¯ä»¥ç”¨ [sqlx](https://github.com/launchbadge/sqlx)ã€‚sqlx æä¾›äº†å¯¹å¤šç§æ•°æ®åº“ï¼ˆPostgresã€MySQLã€SQLiteã€MSSQLï¼‰çš„å¼‚æ­¥è®¿é—®æ”¯æŒï¼Œå¹¶ä¸”ä¸ä½¿ç”¨ DSL å°±å¯ä»¥å¯¹ SQL query åšç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œéå¸¸è½»ä¾¿ï¼›å®ƒå¯ä»¥ä»æ•°æ®åº“ä¸­ç›´æ¥æŸ¥è¯¢å‡ºæ¥ä¸€è¡Œæ•°æ®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ´¾ç”Ÿå®è‡ªåŠ¨æŠŠè¡Œæ•°æ®è½¬æ¢æˆå¯¹åº”çš„ç»“æ„ã€‚

ä»Šå¤©ï¼Œæˆ‘ä»¬å°±å°è¯•ä½¿ç”¨ sqlx å¤„ç†ç”¨æˆ·æ³¨å†Œå’Œç™»å½•è¿™ä¸¤ä¸ªéå¸¸å¸¸è§çš„åŠŸèƒ½ã€‚

### sqlx

æ„å»ºä¸‹é¢çš„è¡¨ç»“æ„æ¥å¤„ç†ç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼š

```sql
CREATE TABLE IF NOT EXISTS users
(
    id              INTEGER PRIMARY KEY NOT NULL,
    email           VARCHAR UNIQUE      NOT NULL,
    hashed_password VARCHAR             NOT NULL
);
```

ç‰¹åˆ«è¯´æ˜ä¸€ä¸‹ï¼Œåœ¨æ•°æ®åº“ä¸­å­˜å‚¨ç”¨æˆ·ä¿¡æ¯éœ€è¦éå¸¸è°¨æ…ï¼Œå°¤å…¶æ˜¯æ¶‰åŠæ•æ„Ÿçš„æ•°æ®ï¼Œæ¯”å¦‚å¯†ç ï¼Œéœ€è¦ä½¿ç”¨ç‰¹å®šçš„å“ˆå¸Œç®—æ³•å­˜å‚¨ã€‚OWASP å¯¹å¯†ç çš„å­˜å‚¨æœ‰å¦‚ä¸‹[å®‰å…¨å»ºè®®](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)ï¼š

1. å¦‚æœ Argon2id å¯ç”¨ï¼Œé‚£ä¹ˆä½¿ç”¨ Argon2idï¼ˆéœ€è¦ç›®æ ‡æœºå™¨è‡³å°‘æœ‰ 15MB å†…å­˜ï¼‰ã€‚
2. å¦‚æœ Argon2id ä¸å¯ç”¨ï¼Œé‚£ä¹ˆä½¿ç”¨ bcryptï¼ˆç®—æ³•è‡³å°‘è¿­ä»£ 10 æ¬¡ï¼‰ã€‚
3. ä¹‹åå†è€ƒè™‘ scrypt / PBKDF2ã€‚

Argon2id æ˜¯ Argon2d å’Œ Argon2i çš„ç»„åˆï¼ŒArgon2d æä¾›äº†å¼ºå¤§çš„æŠ— GPU ç ´è§£èƒ½åŠ›ï¼Œä½†åœ¨ç‰¹å®šæƒ…å†µä¸‹ä¼šå®¹æ˜“é­å—[æ—è·¯æ”»å‡»](https://zh.wikipedia.org/wiki/%E6%97%81%E8%B7%AF%E6%94%BB%E5%87%BB)ï¼ˆside-channel attacksï¼‰ï¼Œè€Œ Argon2i åˆ™å¯ä»¥é˜²æ­¢æ—è·¯æ”»å‡»ï¼Œä½†æŠ— GPU ç ´è§£ç¨å¼±ã€‚æ‰€ä»¥åªè¦æ˜¯ç¼–ç¨‹è¯­è¨€æ”¯æŒ Argo2idï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯é¦–é€‰çš„å¯†ç å“ˆå¸Œå·¥å…·ã€‚

Rust ä¸‹æœ‰å®Œå–„çš„ [password-hashes](https://github.com/RustCrypto/password-hashes) å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…¶ä¸­çš„ [argon2](https://github.com/RustCrypto/password-hashes/tree/master/argon2) crateï¼Œç”¨å®ƒç”Ÿæˆçš„ä¸€ä¸ªå®Œæ•´çš„ï¼ŒåŒ…å«æ‰€æœ‰å‚æ•°çš„å¯†ç å“ˆå¸Œé•¿è¿™ä¸ªæ ·å­ï¼š

```plain
$argon2id$v=19$m=4096,t=3,p=1$l7IEIWV7puJYJAZHyyut8A$OPxL09ODxp/xDQEnlG1NWdOsTr7RzuleBtiYQsnCyXY
```

è¿™ä¸ªå­—ç¬¦ä¸²é‡ŒåŒ…å«äº† argon2id çš„ç‰ˆæœ¬ï¼ˆ19ï¼‰ã€ä½¿ç”¨çš„å†…å­˜å¤§å°ï¼ˆ4096kï¼‰ã€è¿­ä»£æ¬¡æ•°ï¼ˆ3 æ¬¡ï¼‰ã€å¹¶è¡Œç¨‹åº¦ï¼ˆ1 ä¸ªçº¿ç¨‹ï¼‰ï¼Œä»¥åŠ base64 ç¼–ç çš„ salt å’Œ hashã€‚

æ‰€ä»¥ï¼Œå½“æ–°ç”¨æˆ·æ³¨å†Œæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ argon2 æŠŠä¼ å…¥çš„å¯†ç å“ˆå¸Œä¸€ä¸‹ï¼Œå­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼›å½“ç”¨æˆ·ä½¿ç”¨ email/password ç™»å½•æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡ email æ‰¾åˆ°ç”¨æˆ·ï¼Œç„¶åå†é€šè¿‡ argon2 éªŒè¯å¯†ç ã€‚æ•°æ®åº“çš„è®¿é—®ä½¿ç”¨ sqlxï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œé¿å…å®‰è£…é¢å¤–çš„æ•°æ®åº“ï¼Œå°±ä½¿ç”¨ SQLiteæ¥å­˜å‚¨æ•°æ®ï¼ˆå¦‚æœä½ æœ¬åœ°æœ‰ MySQL æˆ–è€… PostgreSQLï¼Œå¯ä»¥è‡ªè¡Œæ›¿æ¢ç›¸åº”çš„è¯­å¥ï¼‰ã€‚

æœ‰äº†è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®ï¼Œæ·»åŠ ç›¸å…³çš„ä¾èµ–ï¼š

```rust
[dev-dependencies]
anyhow = "1"
argon2 = "0.3"
lazy_static = "1"
rand_core = { version = "0.6", features = ["std"] }
sqlx = { version = "0.5", features = ["runtime-tokio-rustls", "sqlite"] }
tokio = { version = "1", features = ["full" ] }
```

ç„¶ååˆ›å»º examples/user.rsï¼Œæ·»å…¥ä»£ç ï¼Œä½ å¯ä»¥å¯¹ç…§è¯¦ç»†çš„æ³¨é‡Šæ¥ç†è§£ï¼š

```rust
use anyhow::{anyhow, Result};
use argon2::{
    password_hash::{rand_core::OsRng, PasswordHash, PasswordHasher, SaltString},
    Argon2, PasswordVerifier,
};
use lazy_static::lazy_static;
use sqlx::{sqlite::SqlitePoolOptions, SqlitePool};
use std::env;

/// Argon2 hash ä½¿ç”¨çš„å¯†ç 
const ARGON_SECRET: &[u8] = b"deadbeef";
lazy_static! {
    /// Argon2
    static ref ARGON2: Argon2<'static> = Argon2::new_with_secret(
        ARGON_SECRET,
        argon2::Algorithm::default(),
        argon2::Version::default(),
        argon2::Params::default()
    )
    .unwrap();
}

/// user è¡¨å¯¹åº”çš„æ•°æ®ç»“æ„ï¼Œå¤„ç† login/register
pub struct UserDb {
    pool: SqlitePool,
}

/// ä½¿ç”¨ FromRow æ´¾ç”Ÿå®æŠŠä»æ•°æ®åº“ä¸­è¯»å–å‡ºæ¥çš„æ•°æ®è½¬æ¢æˆ User ç»“æ„
#[allow(dead_code)]
#[derive(Debug, sqlx::FromRow)]
pub struct User {
    id: i64,
    email: String,
    hashed_password: String,
}

impl UserDb {
    pub fn new(pool: SqlitePool) -> Self {
        Self { pool }
    }

    /// ç”¨æˆ·æ³¨å†Œï¼šåœ¨ users è¡¨ä¸­å­˜å‚¨ argon2 å“ˆå¸Œè¿‡çš„å¯†ç 
    pub async fn register(&self, email: &str, password: &str) -> Result<i64> {
        let hashed_password = generate_password_hash(password)?;
        let id = sqlx::query("INSERT INTO users(email, hashed_password) VALUES (?, ?)")
            .bind(email)
            .bind(hashed_password)
            .execute(&self.pool)
            .await?
            .last_insert_rowid();

        Ok(id)
    }

    /// ç”¨æˆ·ç™»å½•ï¼šä» users è¡¨ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶ç”¨éªŒè¯ç”¨æˆ·å¯†ç 
    pub async fn login(&self, email: &str, password: &str) -> Result<String> {
        let user: User = sqlx::query_as("SELECT * from users WHERE email = ?")
            .bind(email)
            .fetch_one(&self.pool)
            .await?;
        println!("find user: {:?}", user);
        if let Err(_) = verify_password(password, &user.hashed_password) {
            return Err(anyhow!("failed to login"));
        }

        // ç”Ÿæˆ JWT tokenï¼ˆæ­¤å¤„çœç•¥ JWT token ç”Ÿæˆçš„ç»†èŠ‚ï¼‰
        Ok("awesome token".into())
    }
}

/// é‡æ–°åˆ›å»º users è¡¨
async fn recreate_table(pool: &SqlitePool) -> Result<()> {
    sqlx::query("DROP TABLE IF EXISTS users").execute(pool).await?;
    sqlx::query(
        r#"CREATE TABLE IF NOT EXISTS users(
                id              INTEGER PRIMARY KEY NOT NULL,
                email           VARCHAR UNIQUE      NOT NULL,
                hashed_password VARCHAR             NOT NULL)"#,
    )
    .execute(pool)
    .await?;
    Ok(())
}

/// åˆ›å»ºå®‰å…¨çš„å¯†ç å“ˆå¸Œ
fn generate_password_hash(password: &str) -> Result<String> {
    let salt = SaltString::generate(&mut OsRng);
    Ok(ARGON2
        .hash_password(password.as_bytes(), &salt)
        .map_err(|_| anyhow!("failed to hash password"))?
        .to_string())
}

/// ä½¿ç”¨ argon2 éªŒè¯ç”¨æˆ·å¯†ç å’Œå¯†ç å“ˆå¸Œ
fn verify_password(password: &str, password_hash: &str) -> Result<()> {
    let parsed_hash =
        PasswordHash::new(password_hash).map_err(|_| anyhow!("failed to parse hashed password"))?;
    ARGON2
        .verify_password(password.as_bytes(), &parsed_hash)
        .map_err(|_| anyhow!("failed to verify password"))?;
    Ok(())
}

#[tokio::main]
async fn main() -> Result<()> {
    let url = env::var("DATABASE_URL").unwrap_or("sqlite://./data/example.db".into());
    // åˆ›å»ºè¿æ¥æ± 
    let pool = SqlitePoolOptions::new()
        .max_connections(5)
        .connect(&url)
        .await?;

    // æ¯æ¬¡è¿è¡Œéƒ½é‡æ–°åˆ›å»º users è¡¨
    recreate_table(&pool).await?;

    let user_db = UserDb::new(pool.clone());
    let email = "tyr@awesome.com";
    let password = "hunter42";

    // æ–°ç”¨æˆ·æ³¨å†Œ
    let id = user_db.register(email, password).await?;
    println!("registered id: {}", id);

    // ç”¨æˆ·æˆåŠŸç™»å½•
    let token = user_db.login(email, password).await?;
    println!("Login succeeded: {}", token);

    // ç™»å½•å¤±è´¥
    let result = user_db.login(email, "badpass").await;
    println!("Login should fail with bad password: {:?}", result);

    Ok(())
}
```

åœ¨è¿™æ®µä»£ç é‡Œï¼Œæˆ‘ä»¬æŠŠ argon2 çš„èƒ½åŠ›ç¨å¾®åŒ…è£…äº†ä¸€ä¸‹ï¼Œæä¾›äº† `generate_password_hash` å’Œ `verify_password` ä¸¤ä¸ªæ–¹æ³•ç»™æ³¨å†Œå’Œç™»å½•ä½¿ç”¨ã€‚å¯¹äºæ•°æ®åº“çš„è®¿é—®ï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªè¿æ¥æ±  SqlitePoolï¼Œä¾¿äºæ— é”è®¿é—®ã€‚

ä½ å¯èƒ½æ³¨æ„åˆ°äº†è¿™å¥å†™æ³•ï¼š

```rust
let user: User = sqlx::query_as("SELECT * from users WHERE email = ?")
    .bind(email)
    .fetch_one(&self.pool)
    .await?;
```

æ˜¯ä¸æ˜¯å¾ˆæƒŠè®¶ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™æ˜¯ ORM æ‰æœ‰çš„åŠŸèƒ½å•Šã€‚æ²¡é”™ï¼Œå®ƒå†æ¬¡ä½“ç°äº† Rust trait çš„å¼ºå¤§ï¼šæˆ‘ä»¬å¹¶ä¸éœ€è¦ ORM å°±å¯ä»¥æŠŠæ•°æ®åº“ä¸­çš„æ•°æ®è·ŸæŸä¸ª Model ç»“åˆèµ·æ¥ï¼Œåªéœ€è¦åœ¨æŸ¥è¯¢æ—¶ï¼Œæä¾›æƒ³è¦è½¬æ¢æˆçš„æ•°æ®ç»“æ„ T: FromRow å³å¯ã€‚

çœ‹ query\_as å‡½æ•°å’Œ FromRow trait çš„å®šä¹‰ï¼ˆ[ä»£ç ](https://docs.rs/sqlx-core/0.5.9/src/sqlx_core/query_as.rs.html#157-160)ï¼‰ï¼š

```rust
pub fn query_as<'q, DB, O>(sql: &'q str) -> QueryAs<'q, DB, O, <DB as HasArguments<'q>>::Arguments>
where
    DB: Database,
    O: for<'r> FromRow<'r, DB::Row>,
{
    QueryAs {
        inner: query(sql),
        output: PhantomData,
    }
}

pub trait FromRow<'r, R: Row>: Sized {
    fn from_row(row: &'r R) -> Result<Self, Error>;
}
```

è¦è®©ä¸€ä¸ªæ•°æ®ç»“æ„æ”¯æŒ FromRowï¼Œå¾ˆç®€å•ï¼Œä½¿ç”¨ sqlx::FromRow æ´¾ç”Ÿå®å³å¯ï¼š

```rust
#[derive(Debug, sqlx::FromRow)]
pub struct User {
    id: i64,
    email: String,
    hashed_password: String,
}
```

å¸Œæœ›è¿™ä¸ªä¾‹å­å¯ä»¥è®©ä½ ä½“ä¼šåˆ° Rust å¤„ç†æ•°æ®åº“çš„å¼ºå¤§å’Œç®€çº¦ã€‚æˆ‘ä»¬ç”¨ Rust å†™å‡ºäº† Node.js / Python éƒ½ä¸æ›¾æ‹¥æœ‰çš„ç›´è§‚æ„Ÿå—ã€‚å¦å¤–ï¼Œsqlx æ˜¯ä¸€ä¸ªéå¸¸æ¼‚äº®çš„ crateï¼Œæœ‰ç©ºçš„è¯å»ºè®®ä½ ä¹Ÿçœ‹çœ‹å®ƒçš„æºä»£ç ï¼Œå¼€å¤´ä»‹ç»çš„ sea-ormï¼Œåº•å±‚ä¹Ÿæ˜¯ä½¿ç”¨äº† sqlxã€‚

**ç‰¹åˆ«è¯´æ˜**ï¼Œä»¥ä¸Šä¾‹å­å¦‚æœè¿è¡Œå¤±è´¥ï¼Œå¯ä»¥å»[GitHub](https://github.com/tyrchen/geektime-rust/tree/master/44_data_processing/data)ä¸ŠæŠŠ example.db æ‹·è´åˆ°æœ¬åœ° data ç›®å½•ä¸‹ï¼Œç„¶åè¿è¡Œã€‚

## ç”¨ Rust å¯¹åŠç»“æ„åŒ–æ•°æ®è¿›è¡Œåˆ†æ

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¼šç´¯ç§¯å¤§é‡çš„åŠç»“æ„åŒ–æ•°æ®ï¼Œæ¯”å¦‚å„ç§å„æ ·çš„æ—¥å¿—ã€ç›‘æ§æ•°æ®å’Œåˆ†ææ•°æ®ã€‚

ä»¥æ—¥å¿—ä¸ºä¾‹ï¼Œè™½ç„¶é€šå¸¸ä¼šå°†å…¶çŒå…¥æ—¥å¿—åˆ†æå·¥å…·ï¼Œé€šè¿‡å¯è§†åŒ–ç•Œé¢è¿›è¡Œåˆ†æå’Œé—®é¢˜è¿½è¸ªï¼Œä½†å¶å°”æˆ‘ä»¬ä¹Ÿéœ€è¦è‡ªå·±å†™ç‚¹å°å·¥å…·è¿›è¡Œå¤„ç†ï¼Œä¸€èˆ¬ï¼Œä¼šç”¨ Python æ¥å¤„ç†è¿™æ ·çš„ä»»åŠ¡ï¼Œå› ä¸º Python æœ‰ pandas è¿™æ ·ç”¨èµ·æ¥éå¸¸èˆ’æœçš„å·¥å…·ã€‚ç„¶è€Œï¼Œpandas å¤ªåƒå†…å­˜ï¼Œè¿ç®—æ•ˆç‡ä¹Ÿä¸ç®—é«˜ã€‚æœ‰æ²¡æœ‰æ›´å¥½çš„é€‰æ‹©å‘¢ï¼Ÿ

åœ¨ç¬¬ 6 è®²æˆ‘ä»¬ä»‹ç»è¿‡ [polars](https://github.com/pola-rs/polars)ï¼Œä¹Ÿç”¨ polars å’Œ [sqlparser](https://github.com/sqlparser-rs/sqlparser-rs) å†™äº†ä¸€ä¸ªå¤„ç† csv çš„å·¥å…·ï¼Œå…¶å® polars åº•å±‚ä½¿ç”¨äº† [Apache arrow](https://arrow.apache.org)ã€‚å¦‚æœä½ ç»å¸¸è¿›è¡Œå¤§æ•°æ®å¤„ç†ï¼Œé‚£ä¹ˆä½ å¯¹åˆ—å¼å­˜å‚¨ï¼ˆ[columnar datastore](https://en.wikipedia.org/wiki/Column-oriented_DBMS)ï¼‰å’Œ [Data Frame](https://pandas.pydata.org/pandas-docs/stable/user_guide/dsintro.html#dataframe) åº”è¯¥æ¯”è¾ƒç†Ÿæ‚‰ï¼Œarrow å°±æ˜¯ä¸€ä¸ªåœ¨å†…å­˜ä¸­è¿›è¡Œå­˜å‚¨å’Œè¿ç®—çš„åˆ—å¼å­˜å‚¨ï¼Œå®ƒæ˜¯æ„å»ºä¸‹ä¸€ä»£æ•°æ®åˆ†æå¹³å°çš„åŸºç¡€è½¯ä»¶ã€‚

ç”±äº Rust åœ¨ä¸šç•Œçš„åœ°ä½è¶Šæ¥è¶Šé‡è¦ï¼ŒApache arrow ä¹Ÿæ„å»ºäº†å®Œå…¨ç”¨ [Rust å®ç°çš„ç‰ˆæœ¬](https://github.com/apache/arrow-rs)ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šæ„å»ºäº†é«˜æ•ˆçš„ in-memory æŸ¥è¯¢å¼•æ“ [datafusion](https://github.com/apache/arrow-datafusion) ï¼Œä»¥åŠåœ¨æŸäº›åœºæ™¯ä¸‹å¯ä»¥å–ä»£ Spark çš„åˆ†å¸ƒå¼æŸ¥è¯¢å¼•æ“ [ballista](https://github.com/apache/arrow-datafusion/blob/master/ballista/README.md)ã€‚

Apache arrow å’Œ datafusion ç›®å‰å·²ç»æœ‰å¾ˆå¤šé‡ç£…çº§çš„åº”ç”¨ï¼Œå…¶ä¸­æœ€ä»¤äººå…´å¥‹çš„æ˜¯ [InfluxDB IOx](https://github.com/influxdata/influxdb_iox)ï¼Œå®ƒæ˜¯[ä¸‹ä¸€ä»£çš„ InfluxDB çš„æ ¸å¿ƒå¼•æ“](https://www.influxdata.com/blog/announcing-influxdb-iox/)ã€‚

æ¥ä¸€èµ·æ„Ÿå—ä¸€ä¸‹ datafusion å¦‚ä½•ä½¿ç”¨ï¼š

```rust
use datafusion::prelude::*;
use datafusion::arrow::util::pretty::print_batches;
use datafusion::arrow::record_batch::RecordBatch;

#[tokio::main]
async fn main() -> datafusion::error::Result<()> {
  // register the table
  let mut ctx = ExecutionContext::new();
  ctx.register_csv("example", "tests/example.csv", CsvReadOptions::new()).await?;

  // create a plan to run a SQL query
  let df = ctx.sql("SELECT a, MIN(b) FROM example GROUP BY a LIMIT 100").await?;

  // execute and print results
  df.show().await?;
  Ok(())
}
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ CsvReadOptions æ¨æ–­ CSV çš„ schemaï¼Œç„¶åå°†å…¶æ³¨å†Œä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ example è¡¨ï¼Œä¹‹åå°±å¯ä»¥é€šè¿‡ SQL è¿›è¡ŒæŸ¥è¯¢äº†ï¼Œæ˜¯ä¸æ˜¯éå¸¸å¼ºå¤§ï¼Ÿ

ä¸‹é¢æˆ‘ä»¬å°±ä½¿ç”¨ datafusionï¼Œæ¥æ„å»ºä¸€ä¸ª Nginx æ—¥å¿—çš„å‘½ä»¤è¡Œåˆ†æå·¥å…·ã€‚

### datafusion

åœ¨è¿™é—¨è¯¾ç¨‹çš„ [GitHub repo](https://github.com/tyrchen/geektime-rust/tree/master/44_data_processing/fixtures) é‡Œï¼Œæˆ‘æ”¾äº†ä¸ªä»ç½‘ä¸Šæ‰¾åˆ°çš„æ ·æœ¬æ—¥å¿—ï¼Œæ”¹åä¸º nginx\_logs.csvï¼ˆæ³¨æ„åç¼€éœ€è¦æ˜¯ csvï¼‰ï¼Œå…¶æ ¼å¼å¦‚ä¸‹ï¼š

```bash
93.180.71.3 - - "17/May/2015:08:05:32 +0000" GET "/downloads/product_1" "HTTP/1.1" 304 0 "-" "Debian APT-HTTP/1.3 (0.8.16~exp12ubuntu10.21)"
93.180.71.3 - - "17/May/2015:08:05:23 +0000" GET "/downloads/product_1" "HTTP/1.1" 304 0 "-" "Debian APT-HTTP/1.3 (0.8.16~exp12ubuntu10.21)"
80.91.33.133 - - "17/May/2015:08:05:24 +0000" GET "/downloads/product_1" "HTTP/1.1" 304 0 "-" "Debian APT-HTTP/1.3 (0.8.16~exp12ubuntu10.17)"
```

è¿™ä¸ªæ—¥å¿—å…±æœ‰åä¸ªåŸŸï¼Œé™¤äº†å‡ ä¸ª â€œ-â€ï¼Œæ— æ³•çŒœæµ‹åˆ°æ˜¯ä»€ä¹ˆå†…å®¹å¤–ï¼Œå…¶å®ƒçš„åŸŸéƒ½å¾ˆå¥½çŒœæµ‹ã€‚

ç”±äº nginx\_logs çš„æ ¼å¼æ˜¯åœ¨ Nginx é…ç½®ä¸­æ„å»ºçš„ï¼Œæ‰€ä»¥ï¼Œæ—¥å¿—æ–‡ä»¶ï¼Œå¹¶ä¸åƒ CSV æ–‡ä»¶é‚£æ ·æœ‰ä¸€è¡Œ headerï¼Œæ²¡æœ‰ headerï¼Œå°±æ— æ³•è®© datafusion ç›´æ¥å¸®æˆ‘ä»¬æ¨æ–­å‡º schemaï¼Œä¹Ÿå°±æ˜¯è¯´**æˆ‘ä»¬éœ€è¦æ˜¾å¼åœ°å‘Šè¯‰ datafusion æ—¥å¿—æ–‡ä»¶çš„ schema é•¿ä»€ä¹ˆæ ·**ã€‚

ä¸è¿‡å¯¹äº datafusuion æ¥è¯´ï¼Œåˆ›å»ºä¸€ä¸ª schema å¾ˆç®€å•ï¼Œæ¯”å¦‚ï¼š

```rust
let schema = Arc::new(Schema::new(vec![
    Field::new("ip", DataType::Utf8, false),
    Field::new("code", DataType::Int32, false),
]));
```

ä¸ºäº†æœ€å¤§çš„çµæ´»æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹åº”åœ°æ„å»ºä¸€ä¸ªç®€å•çš„ schema å®šä¹‰æ–‡ä»¶ï¼Œé‡Œé¢æ¯ä¸ªå­—æ®µæŒ‰é¡ºåºå¯¹åº” nginx æ—¥å¿—çš„å­—æ®µï¼š

```yaml
---
- name: ip
  type: string
- name: unused1
  type: string
- name: unused2
  type: string
- name: date
  type: string
- name: method
  type: string
- name: url
  type: string
- name: version
  type: string
- name: code
  type: integer
- name: len
  type: integer
- name: unused3
  type: string
- name: ua
  type: string
```

è¿™æ ·ï¼Œæœªæ¥å¦‚æœé‡åˆ°ä¸ä¸€æ ·çš„æ—¥å¿—æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ schema çš„å®šä¹‰ï¼Œè€Œæ— éœ€ä¿®æ”¹ç¨‹åºæœ¬èº«ã€‚

å¯¹äºè¿™ä¸ª schema å®šä¹‰æ–‡ä»¶ï¼Œä½¿ç”¨ [serde](https://github.com/serde-rs/serde) å’Œ [serde-yaml](https://github.com/dtolnay/serde-yaml) æ¥è¯»å–ï¼Œç„¶åå†å®ç° From trait æŠŠ SchemaField å¯¹åº”åˆ° datafusion çš„ Field ç»“æ„ï¼š

```rust
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq, PartialOrd, Ord, Hash)]
#[serde(rename_all = "snake_case")]
pub enum SchemaDataType {
    /// Int64
    Integer,
    /// Utf8
    String,
    /// Date64,
    Date,
}

#[derive(Serialize, Deserialize, Debug, Clone, PartialEq, Eq, Hash, PartialOrd, Ord)]
struct SchemaField {
    name: String,
    #[serde(rename = "type")]
    pub(crate) data_type: SchemaDataType,
}

#[derive(Serialize, Deserialize, Debug, Clone, PartialEq, Eq, Hash, PartialOrd, Ord)]
struct SchemaFields(Vec<SchemaField>);

impl From<SchemaDataType> for DataType {
    fn from(dt: SchemaDataType) -> Self {
        match dt {
            SchemaDataType::Integer => Self::Int64,
            SchemaDataType::Date => Self::Date64,
            SchemaDataType::String => Self::Utf8,
        }
    }
}

impl From<SchemaField> for Field {
    fn from(f: SchemaField) -> Self {
        Self::new(&f.name, f.data_type.into(), false)
    }
}

impl From<SchemaFields> for SchemaRef {
    fn from(fields: SchemaFields) -> Self {
        let fields: Vec<Field> = fields.0.into_iter().map(|f| f.into()).collect();
        Arc::new(Schema::new(fields))
    }
}
```

æœ‰äº†è¿™ä¸ªåŸºæœ¬çš„ schema è½¬æ¢çš„åŠŸèƒ½ï¼Œå°±å¯ä»¥æ„å»ºæˆ‘ä»¬çš„ nginx æ—¥å¿—å¤„ç†ç»“æ„åŠå…¶åŠŸèƒ½äº†ï¼š

```rust
/// nginx æ—¥å¿—å¤„ç†çš„æ•°æ®ç»“æ„
pub struct NginxLog {
    ctx: ExecutionContext,
}

impl NginxLog {
    /// æ ¹æ® schema å®šä¹‰ï¼Œæ•°æ®æ–‡ä»¶ä»¥åŠåˆ†éš”ç¬¦æ„å»º NginxLog ç»“æ„
    pub async fn try_new(schema_file: &str, data_file: &str, delim: u8) -> Result<Self> {
        let content = tokio::fs::read_to_string(schema_file).await?;
        let fields: SchemaFields = serde_yaml::from_str(&content)?;
        let schema = SchemaRef::from(fields);

        let mut ctx = ExecutionContext::new();
        let options = CsvReadOptions::new()
            .has_header(false)
            .delimiter(delim)
            .schema(&schema);
        ctx.register_csv("nginx", data_file, options).await?;

        Ok(Self { ctx })
    }

    /// è¿›è¡Œ sql æŸ¥è¯¢
    pub async fn query(&mut self, query: &str) -> Result<Arc<dyn DataFrame>> {
        let df = self.ctx.sql(query).await?;
        Ok(df)
    }
}
```

ä»…ä»…å†™äº† 80 è¡Œä»£ç ï¼Œå°±å®Œæˆäº† nginx æ—¥å¿—æ–‡ä»¶çš„è¯»å–ã€è§£æå’ŒæŸ¥è¯¢åŠŸèƒ½ï¼Œå…¶ä¸­ 50 è¡Œä»£ç è¿˜æ˜¯ä¸ºäº†å¤„ç† schema é…ç½®æ–‡ä»¶ã€‚æ˜¯ä¸æ˜¯æœ‰ç‚¹ä¸æ•¢ç›¸ä¿¡è‡ªå·±çš„çœ¼ç›ï¼Ÿ

datafusion/arrow ä¹Ÿå¤ªå¼ºå¤§äº†å§ï¼Ÿè¿™ä¸ªç®€æ´çš„èƒŒåï¼Œæ˜¯ 10w è¡Œ arrow ä»£ç å’Œ 1w è¡Œ datafusion ä»£ç çš„åŠŸåŠ³ã€‚

å†æ¥å†™æ®µä»£ç è°ƒç”¨å®ƒï¼š

```rust
#[tokio::main]
async fn main() -> Result<()> {
    let mut nginx_log =
        NginxLog::try_new("fixtures/log_schema.yml", "fixtures/nginx_logs.csv", b' ').await?;
    // ä» stdin ä¸­æŒ‰è¡Œè¯»å–å†…å®¹ï¼Œå½“åš sql æŸ¥è¯¢ï¼Œè¿›è¡Œå¤„ç†
    let stdin = io::stdin();
    let mut lines = stdin.lock().lines();

    while let Some(Ok(line)) = lines.next() {
        if !line.starts_with("--") {
            println!("{}", line);
            // è¯»åˆ°ä¸€è¡Œ sqlï¼ŒæŸ¥è¯¢ï¼Œè·å– dataframe
            let df = nginx_log.query(&line).await?;
            // ç®€å•æ˜¾ç¤º dataframe
            df.show().await?;
        }
    }

    Ok(())
}
```

åœ¨è¿™æ®µä»£ç é‡Œï¼Œæˆ‘ä»¬ä» stdin ä¸­è·å–å†…å®¹ï¼ŒæŠŠæ¯ä¸€è¡Œè¾“å…¥éƒ½ä½œä¸ºä¸€ä¸ª SQL è¯­å¥ä¼ ç»™ nginx\_log.queryï¼Œç„¶åæ˜¾ç¤ºæŸ¥è¯¢ç»“æœã€‚

æ¥æµ‹è¯•ä¸€ä¸‹ï¼š

```sql
â¯ echo "SELECT ip, count(*) as total, cast(avg(len) as int) as avg_len FROM nginx GROUP BY ip ORDER BY total DESC LIMIT 10" | cargo run --example log --quiet
SELECT ip, count(*) as total, cast(avg(len) as int) as avg_len FROM nginx GROUP BY ip ORDER BY total DESC LIMIT 10
+-----------------+-------+---------+
| ip              | total | avg_len |
+-----------------+-------+---------+
| 216.46.173.126  | 2350  | 220     |
| 180.179.174.219 | 1720  | 292     |
| 204.77.168.241  | 1439  | 340     |
| 65.39.197.164   | 1365  | 241     |
| 80.91.33.133    | 1202  | 243     |
| 84.208.15.12    | 1120  | 197     |
| 74.125.60.158   | 1084  | 300     |
| 119.252.76.162  | 1064  | 281     |
| 79.136.114.202  | 628   | 280     |
| 54.207.57.55    | 532   | 289     |
+-----------------+-------+---------+
```

æ˜¯ä¸æ˜¯æŒºå‰å®³ï¼Ÿæˆ‘ä»¬å¯ä»¥å……åˆ†åˆ©ç”¨ SQL çš„å¼ºå¤§è¡¨ç°åŠ›ï¼Œåšå„ç§å¤æ‚çš„æŸ¥è¯¢ã€‚ä¸å…‰å¦‚æ­¤ï¼Œè¿˜å¯ä»¥ä»ä¸€ä¸ªåŒ…å«äº†å¤šä¸ª sql è¯­å¥çš„æ–‡ä»¶ä¸­ï¼Œä¸€æ¬¡æ€§åšå¤šä¸ªæŸ¥è¯¢ã€‚æ¯”å¦‚æˆ‘åˆ›å»ºäº†è¿™æ ·ä¸€ä¸ªæ–‡ä»¶ analyze.sqlï¼š

```sql
-- æŸ¥è¯¢ ip å‰ 10 å
SELECT ip, count(*) as total, cast(avg(len) as int) as avg_len FROM nginx GROUP BY ip ORDER BY total DESC LIMIT 10
-- æŸ¥è¯¢ UA å‰ 10 å
select ua, count(*) as total from nginx group by ua order by total desc limit 10
-- æŸ¥è¯¢è®¿é—®æœ€å¤šçš„ url å‰ 10 å
select url, count(*) as total from nginx group by url order by total desc limit 10
-- æŸ¥è¯¢è®¿é—®è¿”å› body é•¿åº¦å‰ 10 å
select len, count(*) as total from nginx group by len order by total desc limit 10
-- æŸ¥è¯¢ HEAD è¯·æ±‚
select ip, date, url, code, ua from nginx where method = 'HEAD' limit 10
-- æŸ¥è¯¢çŠ¶æ€ç æ˜¯ 403 çš„è¯·æ±‚
select ip, date, url, ua from nginx where code = 403 limit 10
-- æŸ¥è¯¢ UA ä¸ºç©ºçš„è¯·æ±‚
select ip, date, url, code from nginx where ua = '-' limit 10
-- å¤æ‚æŸ¥è¯¢ï¼Œæ‰¾è¿”å› body é•¿åº¦çš„ percentile åœ¨ 0.5-0.7 ä¹‹é—´çš„æ•°æ®
select * from (select ip, date, url, ua, len, PERCENT_RANK() OVER (ORDER BY len) as len_percentile from nginx where code = 200 order by len desc) as t where t.len_percentile > 0.5 and t.len_percentile < 0.7 order by t.len_percentile desc limit 10
```

é‚£ä¹ˆï¼Œæˆ‘å¯ä»¥è¿™æ ·è·å–ç»“æœï¼š

```sql
â¯ cat fixtures/analyze.sql | cargo run --example log --quiet
SELECT ip, count(*) as total, cast(avg(len) as int) as avg_len FROM nginx GROUP BY ip ORDER BY total DESC LIMIT 10
+-----------------+-------+---------+
| ip              | total | avg_len |
+-----------------+-------+---------+
| 216.46.173.126  | 2350  | 220     |
| 180.179.174.219 | 1720  | 292     |
| 204.77.168.241  | 1439  | 340     |
| 65.39.197.164   | 1365  | 241     |
| 80.91.33.133    | 1202  | 243     |
| 84.208.15.12    | 1120  | 197     |
| 74.125.60.158   | 1084  | 300     |
| 119.252.76.162  | 1064  | 281     |
| 79.136.114.202  | 628   | 280     |
| 54.207.57.55    | 532   | 289     |
+-----------------+-------+---------+
select ua, count(*) as total from nginx group by ua order by total desc limit 10
+-----------------------------------------------+-------+
| ua                                            | total |
+-----------------------------------------------+-------+
| Debian APT-HTTP/1.3 (1.0.1ubuntu2)            | 11830 |
| Debian APT-HTTP/1.3 (0.9.7.9)                 | 11365 |
| Debian APT-HTTP/1.3 (0.8.16~exp12ubuntu10.21) | 6719  |
| Debian APT-HTTP/1.3 (0.8.16~exp12ubuntu10.16) | 5740  |
| Debian APT-HTTP/1.3 (0.8.16~exp12ubuntu10.22) | 3855  |
| Debian APT-HTTP/1.3 (0.8.16~exp12ubuntu10.17) | 1827  |
| Debian APT-HTTP/1.3 (0.8.16~exp12ubuntu10.7)  | 1255  |
| urlgrabber/3.9.1 yum/3.2.29                   | 792   |
| Debian APT-HTTP/1.3 (0.9.7.8)                 | 750   |
| urlgrabber/3.9.1 yum/3.4.3                    | 708   |
+-----------------------------------------------+-------+
select url, count(*) as total from nginx group by url order by total desc limit 10
+----------------------+-------+
| url                  | total |
+----------------------+-------+
| /downloads/product_1 | 30285 |
| /downloads/product_2 | 21104 |
| /downloads/product_3 | 73    |
+----------------------+-------+
select len, count(*) as total from nginx group by len order by total desc limit 10
+-----+-------+
| len | total |
+-----+-------+
| 0   | 13413 |
| 336 | 6652  |
| 333 | 3771  |
| 338 | 3393  |
| 337 | 3268  |
| 339 | 2999  |
| 331 | 2867  |
| 340 | 1629  |
| 334 | 1393  |
| 332 | 1240  |
+-----+-------+
select ip, date, url, code, ua from nginx where method = 'HEAD' limit 10
+----------------+----------------------------+----------------------+------+-------------------------+
| ip             | date                       | url                  | code | ua                      |
+----------------+----------------------------+----------------------+------+-------------------------+
| 184.173.149.15 | 23/May/2015:15:05:53 +0000 | /downloads/product_2 | 403  | Wget/1.13.4 (linux-gnu) |
| 5.153.24.140   | 23/May/2015:17:05:30 +0000 | /downloads/product_2 | 200  | Wget/1.13.4 (linux-gnu) |
| 5.153.24.140   | 23/May/2015:17:05:33 +0000 | /downloads/product_2 | 403  | Wget/1.13.4 (linux-gnu) |
| 5.153.24.140   | 23/May/2015:17:05:34 +0000 | /downloads/product_2 | 403  | Wget/1.13.4 (linux-gnu) |
| 5.153.24.140   | 23/May/2015:17:05:52 +0000 | /downloads/product_2 | 200  | Wget/1.13.4 (linux-gnu) |
| 5.153.24.140   | 23/May/2015:17:05:43 +0000 | /downloads/product_2 | 200  | Wget/1.13.4 (linux-gnu) |
| 5.153.24.140   | 23/May/2015:17:05:42 +0000 | /downloads/product_2 | 200  | Wget/1.13.4 (linux-gnu) |
| 5.153.24.140   | 23/May/2015:17:05:46 +0000 | /downloads/product_2 | 200  | Wget/1.13.4 (linux-gnu) |
| 5.153.24.140   | 23/May/2015:18:05:10 +0000 | /downloads/product_2 | 200  | Wget/1.13.4 (linux-gnu) |
| 184.173.149.16 | 24/May/2015:18:05:37 +0000 | /downloads/product_2 | 403  | Wget/1.13.4 (linux-gnu) |
+----------------+----------------------------+----------------------+------+-------------------------+
select ip, date, url, ua from nginx where code = 403 limit 10
+----------------+----------------------------+----------------------+-----------------------------------------------------------------------------------------------------+
| ip             | date                       | url                  | ua                                                                                                  |
+----------------+----------------------------+----------------------+-----------------------------------------------------------------------------------------------------+
| 184.173.149.15 | 23/May/2015:15:05:53 +0000 | /downloads/product_2 | Wget/1.13.4 (linux-gnu)                                                                             |
| 5.153.24.140   | 23/May/2015:17:05:33 +0000 | /downloads/product_2 | Wget/1.13.4 (linux-gnu)                                                                             |
| 5.153.24.140   | 23/May/2015:17:05:34 +0000 | /downloads/product_2 | Wget/1.13.4 (linux-gnu)                                                                             |
| 184.173.149.16 | 24/May/2015:18:05:37 +0000 | /downloads/product_2 | Wget/1.13.4 (linux-gnu)                                                                             |
| 195.88.195.153 | 24/May/2015:23:05:05 +0000 | /downloads/product_2 | curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3 |
| 184.173.149.15 | 25/May/2015:04:05:14 +0000 | /downloads/product_2 | Wget/1.13.4 (linux-gnu)                                                                             |
| 87.85.173.82   | 17/May/2015:14:05:07 +0000 | /downloads/product_2 | Wget/1.13.4 (linux-gnu)                                                                             |
| 87.85.173.82   | 17/May/2015:14:05:11 +0000 | /downloads/product_2 | Wget/1.13.4 (linux-gnu)                                                                             |
| 194.76.107.17  | 17/May/2015:16:05:50 +0000 | /downloads/product_2 | Wget/1.13.4 (linux-gnu)                                                                             |
| 194.76.107.17  | 17/May/2015:17:05:40 +0000 | /downloads/product_2 | Wget/1.13.4 (linux-gnu)                                                                             |
+----------------+----------------------------+----------------------+-----------------------------------------------------------------------------------------------------+
select ip, date, url, code from nginx where ua = '-' limit 10
+----------------+----------------------------+----------------------+------+
| ip             | date                       | url                  | code |
+----------------+----------------------------+----------------------+------+
| 217.168.17.150 | 01/Jun/2015:14:06:45 +0000 | /downloads/product_2 | 200  |
| 217.168.17.180 | 01/Jun/2015:14:06:15 +0000 | /downloads/product_2 | 200  |
| 217.168.17.150 | 01/Jun/2015:14:06:18 +0000 | /downloads/product_1 | 200  |
| 204.197.211.70 | 24/May/2015:06:05:02 +0000 | /downloads/product_2 | 200  |
| 91.74.184.74   | 29/May/2015:14:05:17 +0000 | /downloads/product_2 | 403  |
| 91.74.184.74   | 29/May/2015:15:05:43 +0000 | /downloads/product_2 | 403  |
| 91.74.184.74   | 29/May/2015:22:05:53 +0000 | /downloads/product_2 | 403  |
| 217.168.17.5   | 31/May/2015:02:05:16 +0000 | /downloads/product_2 | 200  |
| 217.168.17.180 | 20/May/2015:23:05:22 +0000 | /downloads/product_2 | 200  |
| 204.197.211.70 | 21/May/2015:02:05:34 +0000 | /downloads/product_2 | 200  |
+----------------+----------------------------+----------------------+------+
select * from (select ip, date, url, ua, len, PERCENT_RANK() OVER (ORDER BY len) as len_percentile from nginx where code = 200 order by len desc) as t where t.len_percentile > 0.5 and t.len_percentile < 0.7 order by t.len_percentile desc limit 10
+----------------+----------------------------+----------------------+-----------------------------+------+--------------------+
| ip             | date                       | url                  | ua                          | len  | len_percentile     |
+----------------+----------------------------+----------------------+-----------------------------+------+--------------------+
| 54.229.83.18   | 26/May/2015:00:05:34 +0000 | /downloads/product_1 | urlgrabber/3.9.1 yum/3.4.3  | 2592 | 0.6342190216041719 |
| 54.244.37.198  | 18/May/2015:10:05:39 +0000 | /downloads/product_1 | urlgrabber/3.9.1 yum/3.4.3  | 2592 | 0.6342190216041719 |
| 67.132.206.254 | 29/May/2015:07:05:52 +0000 | /downloads/product_1 | urlgrabber/3.9.1 yum/3.2.29 | 2592 | 0.6342190216041719 |
| 128.199.60.184 | 24/May/2015:00:05:09 +0000 | /downloads/product_1 | urlgrabber/3.10 yum/3.4.3   | 2592 | 0.6342190216041719 |
| 54.173.6.142   | 27/May/2015:14:05:21 +0000 | /downloads/product_1 | urlgrabber/3.9.1 yum/3.4.3  | 2592 | 0.6342190216041719 |
| 104.156.250.12 | 03/Jun/2015:11:06:51 +0000 | /downloads/product_1 | urlgrabber/3.9.1 yum/3.2.29 | 2592 | 0.6342190216041719 |
| 115.198.47.126 | 25/May/2015:11:05:13 +0000 | /downloads/product_1 | urlgrabber/3.10 yum/3.4.3   | 2592 | 0.6342190216041719 |
| 198.105.198.4  | 29/May/2015:07:05:34 +0000 | /downloads/product_1 | urlgrabber/3.9.1 yum/3.2.29 | 2592 | 0.6342190216041719 |
| 107.23.164.80  | 31/May/2015:09:05:34 +0000 | /downloads/product_1 | urlgrabber/3.9.1 yum/3.4.3  | 2592 | 0.6342190216041719 |
| 108.61.251.29  | 31/May/2015:10:05:16 +0000 | /downloads/product_1 | urlgrabber/3.9.1 yum/3.2.29 | 2592 | 0.6342190216041719 |
+----------------+----------------------------+----------------------+-----------------------------+------+--------------------+
```

## å°ç»“

ä»Šå¤©æˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ Rust å¤„ç†å­˜æ”¾åœ¨å…³ç³»æ•°æ®åº“ä¸­çš„ç»“æ„åŒ–æ•°æ®ï¼Œä»¥åŠå­˜æ”¾åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„åŠç»“æ„åŒ–æ•°æ®ã€‚

è™½ç„¶åœ¨å·¥ä½œä¸­ï¼Œæˆ‘ä»¬ä¸å¤ªä¼šä½¿ç”¨ arrow/datafusion å»åˆ›å»ºæŸä¸ªâ€œä¸‹ä¸€ä»£â€çš„æ•°æ®å¤„ç†å¹³å°ï¼Œä½†æ‹¥æœ‰äº†å¤„ç†åŠç»“æ„åŒ–æ•°æ®çš„èƒ½åŠ›ï¼Œå¯ä»¥è§£å†³å¾ˆå¤šéå¸¸å®é™…çš„é—®é¢˜ã€‚

æ¯”å¦‚æ¯éš” 10 åˆ†é’Ÿæ‰«æ Nginx / CDNï¼Œä»¥åŠåº”ç”¨æœåŠ¡å™¨è¿‡å» 10 åˆ†é’Ÿçš„æ—¥å¿—ï¼Œæ‰¾åˆ°æŸäº›éæ­£å¸¸çš„è®¿é—®ï¼Œç„¶åæŠŠè¯¥ç”¨æˆ·/è®¾å¤‡çš„è®¿é—®åˆ‡æ–­ä¸€é˜µå­ã€‚è¿™æ ·çš„ç‰¹æ®Šéœ€æ±‚ï¼Œä¸€èˆ¬çš„æ•°æ®å¹³å°å¾ˆéš¾å¤„ç†ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±æ’°å†™ä»£ç æ¥å®ç°ã€‚æ­¤æ—¶ï¼Œarrow/datafusion è¿™æ ·çš„å·¥å…·å°±å¾ˆæ–¹ä¾¿ã€‚

### æ€è€ƒé¢˜

1. è¯·ä½ è‡ªå·±é˜…è¯» diesel æˆ–è€… sea-orm çš„æ–‡æ¡£ï¼Œç„¶åå°è¯•æŠŠæˆ‘ä»¬ç›´æ¥ç”¨ sqlx æ„å»ºçš„ç”¨æˆ·æ³¨å†Œ/ç™»å½•çš„åŠŸèƒ½ä½¿ç”¨ diesel æˆ–è€… sea-orm å®ç°ã€‚
2. datafusion ä¸ä½†æ”¯æŒ csvï¼Œè¿˜æ”¯æŒ ndJSON / parquet / avro ç­‰æ•°æ®ç±»å‹ã€‚å¦‚æœä½ å…¬å¸çš„ç”Ÿäº§ç¯å¢ƒä¸‹æœ‰è¿™äº›ç±»å‹çš„åŠç»“æ„åŒ–æ•°æ®ï¼Œå¯ä»¥å°è¯•ç€é˜…è¯»ç›¸å…³æ–‡æ¡£ï¼Œä½¿ç”¨ datafusion æ¥è¯»å–å’ŒæŸ¥è¯¢å®ƒä»¬ã€‚

æ„Ÿè°¢ä½ çš„æ”¶å¬ã€‚æ­å–œä½ å®Œæˆäº†ç¬¬44æ¬¡Rustå­¦ä¹ ï¼Œæ‰“å¡ä¹‹æ—…é©¬ä¸Šå°±è¦ç»“æŸå•¦ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ7ï¼‰</strong></div><ul>
<li><span>pedro</span> ğŸ‘ï¼ˆ7ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æœ€è¿‘å·¥ä½œå¾ˆå¿™ï¼Œç»å¸¸åŠ ç­ï¼Œæœ‰æ—¶é—´æŠ½ç©ºæ¥çœ‹çœ‹ï¼Œä»ç„¶æ”¶è·é¢‡ä¸°ã€‚

çœ‹å®Œä»Šå¤©è¿™ä¸€ç« ï¼Œæœ‰ä¸€ç§å¼ºçƒˆçš„æ„Ÿå—ï¼šè¿™ä¸ä»…æ˜¯Rustç¼–ç¨‹ç¬¬ä¸€è¯¾ï¼Œå¾ˆæœ‰å¯èƒ½ä¹Ÿæ˜¯å”¯ä¸€çš„ä¸€è¯¾ï¼Œå†…å®¹å¤ªä¸°å¯Œäº†ã€‚</p>2021-12-10</li><br/><li><span>ä¹Œé¾™çŒ¹</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯¾ç¨‹è¿›å…¥åˆ°äº†å°¾å£°ï¼Œæ„Ÿè§‰å•¥ä¹Ÿæ²¡å­¦åˆ°ï¼Œæ„Ÿè§‰åˆå­¦åˆ°äº†å¾ˆå¤šã€‚æ•´ä¸ªè¯¾ç¨‹å†…å®¹å¤¯å®ï¼Œä½“ç³»ç»“æ„æ¸…æ™°ã€‚å€¼å¾—åå¤å“å‘³ã€‚è¿™æ˜¯ Rust ç¼–ç¨‹çš„ç¬¬ä¸€è¯¾ï¼Œè€ŒçœŸæ­£çš„ Rust ä¹‹æ—…æ‰åˆšåˆšå¼€å§‹ã€‚</p>2021-12-10</li><br/><li><span>ç½—æ°</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å“ˆï¼Œæˆ‘ä¹Ÿè§‰å¾— ORM å¤ªè¿‡ç¬¨é‡ï¼Œè¿˜æ˜¯ sqlx ç›´è§‚ã€‚æˆ‘çš„é¡¹ç›®å…¨éƒ¨éƒ½æ˜¯ sqlxï¼ŒC++ å’Œ Go éƒ½æ˜¯ã€‚</p>2021-12-10</li><br/><li><span>Colt</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¡¥å……ä¸‹:
è¿è¡Œexample&#47;user çš„ä¾‹å­éœ€è¦æ³¨æ„ä¸‹é¢2ç‚¹:
1. éœ€è¦åœ¨example åŒçº§ç›®å½•ä¸‹åˆ›å»º data&#47;example.db æ–‡ä»¶å¦åˆ™æŠ¥ `unable to open database file`
2. `recreate_table` æ–¹æ³•ä¸‹ç¬¬ä¸€æ¡sql éœ€è¦æ”¹ä¸º `drop table if exists users` å¦åˆ™é¦–æ¬¡è¿è¡Œä¼šæŠ¥ `no such table: users`</p>2021-12-23</li><br/><li><span>Geek_b251b3</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>é™ˆè€å¸ˆèƒ½ç‚¹ä¸€ä¸‹ä¸ºä»€ä¹ˆä½¿ç”¨poolçš„æ—¶å€™éœ€è¦çš„æ˜¯pool.clone()ä¹ˆ</p>2022-05-28</li><br/><li><span>Jagger</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>sqlx è¿æ¥MySQL8 å­˜åœ¨8å°æ—¶æ—¶å·®çš„é—®é¢˜ï¼Œé™ˆè€å¸ˆæœ‰æ²¡æœ‰ä»€ä¹ˆå¥½çš„åŠæ³•è§£å†³ï¼Ÿ</p>2022-03-13</li><br/><li><span>Geek_994f3b</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ç”¨æˆ·æ³¨å†Œç™»å½•æœ‰ä»€ä¹ˆæœ€ä½³å®è·µå¯ä»¥å‚è€ƒä¹ˆ</p>2022-03-09</li><br/>
</ul>