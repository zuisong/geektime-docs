ä½ å¥½ï¼Œæˆ‘æ˜¯å¾é€¸ã€‚

åœ¨ä¸Šä¸€èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥æ¢è®¨äº†å¦‚ä½•åº”å¯¹Redisä¸­çš„çƒ­Keyé—®é¢˜ï¼Œå¹¶æŒæ¡äº†å¤šç§è§£å†³æ–¹æ¡ˆã€‚ç„¶è€Œï¼Œåœ¨é¢å¯¹é«˜å¹¶å‘çš„æŒ‘æˆ˜æ—¶ï¼Œæˆ‘ä»¬ä¸ä»…è¦å…³æ³¨çƒ­Keyé—®é¢˜ï¼Œè¿˜å¿…é¡»å…³æ³¨å¦ä¸€ä¸ªå¯èƒ½å½±å“Redisæ€§èƒ½çš„å› ç´ â€”â€”å¤§Keyé—®é¢˜ã€‚

ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±æ¥èŠèŠRediså¤§Keyé—®é¢˜å’Œç›¸åº”çš„è§£å†³æ–¹æ¡ˆã€‚

## ä»€ä¹ˆæ˜¯å¤§Keyé—®é¢˜

Redis ä½œä¸ºå•çº¿ç¨‹åº”ç”¨ç¨‹åºï¼Œå®ƒçš„è¯·æ±‚å¤„ç†æ¨¡å¼ç±»ä¼¼æ’é˜Ÿç³»ç»Ÿï¼Œå°±åƒä¸‹é¢çš„å›¾ä¸€æ ·ï¼Œæ‰€æœ‰è¯·æ±‚åªèƒ½ä¾åºé€ä¸ªå¤„ç†ã€‚ä¸€æ—¦å¤„äºé˜Ÿåˆ—å‰é¢çš„è¯·æ±‚å¤„ç†æ—¶é—´è¿‡é•¿ï¼Œåç»­è¯·æ±‚çš„ç­‰å¾…æ—¶é—´å°±ä¼šè¢«è¿«å»¶é•¿ã€‚

![](https://static001.geekbang.org/resource/image/30/92/3021ff0023b5b504d877f3f76ee2fc92.jpg?wh=3242x872 "å›¾1 Redis è¯·æ±‚æ’é˜Ÿå¤„ç†")

åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­ï¼Œè‹¥æ¶‰åŠçš„é”®ï¼ˆKeyï¼‰æˆ–é”®å…³è”çš„å€¼ï¼ˆValueï¼‰æ•°æ®é‡è¿‡å¤§ï¼ŒRedis é’ˆå¯¹è¿™ä¸ªè¯·æ±‚çš„ I/O æ“ä½œè€—æ—¶ä»¥åŠæ•´ä½“å¤„ç†æ—¶é—´éƒ½å°†æ˜¾è‘—å¢åŠ ã€‚

**å€˜è‹¥è¿™ç§æƒ…å†µé¢‘ç¹å‘ç”Ÿï¼Œä¸ä»…Redisçš„ååä¼šä¸‹é™ï¼Œè€Œä¸”å¤§é‡åç»­è¯·æ±‚éƒ½ä¼šå› é•¿æ—¶é—´å¾—ä¸åˆ°å“åº”ï¼Œè€Œå¯¼è‡´å»¶è¿Ÿä¸Šæ¶¨ï¼Œç”šè‡³å¼•å‘è¶…æ—¶ã€‚åœ¨å®é™…åº”ç”¨åœºæ™¯ä¸­ï¼Œè¿™ç§ç°è±¡è¢«å®šä¹‰ä¸º â€œå¤§ Key é—®é¢˜â€ï¼Œè€Œé‚£äº›æ•°æ®é‡è¿‡å¤§çš„é”®ï¼ˆKeyï¼‰ä¸å€¼ï¼ˆValueï¼‰åˆ™è¢«ç§°ä¸º â€œå¤§ Keyâ€**ã€‚

å½“ç„¶ï¼Œè¦åˆ¤æ–­ä»€ä¹ˆæ˜¯â€œå¤§Keyâ€ï¼Œæˆ‘ä»¬å¾—ç»¼åˆè€ƒè™‘ä¸¤ä¸ªå› ç´ ï¼š**Keyçš„å¤§å°å’ŒKeyä¸­åŒ…å«çš„æˆå‘˜æ•°é‡**ã€‚

ä¸è¿‡ï¼Œå¯¹äº Key ç©¶ç«Ÿè¦è¾¾åˆ°å¤šå¤§è§„æ¨¡æˆ–è€…åŒ…å«çš„æˆå‘˜æ•°é‡å…·ä½“ä¸ºå¤šå°‘æ‰èƒ½å¤Ÿè¢«è®¤å®šä¸ºå¤§ Keyï¼Œå®é™…ä¸Šå¹¶æ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„æ ‡å‡†ï¼Œè¿™ä¸ªæ ‡å‡†å¾—æ ¹æ®ä½ çš„Redisé…ç½®æ¥å®šã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ç»™ä½ åˆ†äº«ä¸€äº›[é˜¿é‡Œäº‘](https://www.alibabacloud.com/help/zh/tair/user-guide/identify-and-handle-large-keys-and-hotkeys)æä¾›çš„å…³äºå¤§Keyçš„å‚è€ƒæ ‡å‡†ï¼Œè¿™äº›æ ‡å‡†å¯ä»¥ä½œä¸ºä½ åˆ¤æ–­å’Œå¤„ç†å¤§Keyé—®é¢˜çš„å‚è€ƒã€‚

1. ä»Keyçš„æ•°æ®é‡æ¥è¯´ï¼Œä¸€ä¸ªStringç±»å‹çš„Keyï¼Œå¦‚æœå®ƒçš„æ•°æ®é‡è¾¾åˆ°5MBï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªâ€œå¤§Keyâ€ã€‚
2. ä»Keyæˆå‘˜æ•°é‡æ¥çœ‹ï¼Œä¸€ä¸ªZSETç±»å‹çš„Keyï¼Œå¦‚æœå®ƒåŒ…å«çš„æˆå‘˜æ•°é‡è¶…è¿‡äº†10,000ä¸ªï¼Œè¿™ä¹Ÿç¬¦åˆâ€œå¤§Keyâ€çš„å®šä¹‰ã€‚
3. ä»Keyçš„æˆå‘˜æ•°æ®é‡æ¥çœ‹ï¼Œä¸€ä¸ªHashç±»å‹çš„Keyï¼Œå³ä½¿å®ƒçš„æˆå‘˜æ•°é‡åªæœ‰2,000ä¸ªï¼Œä½†å¦‚æœè¿™äº›æˆå‘˜çš„Valueï¼ˆå€¼ï¼‰åŠ èµ·æ¥æ€»å¤§å°è¶…è¿‡äº†100MBï¼Œé‚£å®ƒåŒæ ·å¯ä»¥è¢«è§†ä¸ºâ€œå¤§Keyâ€ã€‚

åœ¨æ·±å…¥äº†è§£äº†å¤§Keyé—®é¢˜ä¹‹åï¼Œæˆ‘ä»¬æ¥æ¢è®¨ä¸€ä¸ªå®é™…é—®é¢˜ï¼šå¦‚æœåœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¸å¾—ä¸å°†è¶…è¿‡å¤§Keyæ ‡å‡†çš„æ•°æ®å­˜å‚¨åˆ°Redisä¸­ï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•è¿›è¡Œä¼˜åŒ–ä»¥è§„é¿å¤§Keyé—®é¢˜å‘¢ï¼Ÿ

åœ¨å®é™…æ“ä½œä¸­ï¼Œæˆ‘ä»¬ä¸»è¦æœ‰ä¸¤ç§æ–¹æ¡ˆå¯ä¾›é€‰æ‹©ã€‚

1. **ç¬¬ä¸€ä¸ªæ˜¯æ•°æ®å‹ç¼©æ–¹æ¡ˆï¼Œé€šè¿‡å‹ç¼©æŠ€æœ¯å‡å°‘æ•°æ®çš„ä½“ç§¯ï¼Œä½¿å…¶ç¬¦åˆå¤§Keyçš„æ ‡å‡†ï¼Œä»è€Œå‡å°‘å¯¹Redisæ€§èƒ½çš„å½±å“ã€‚**
2. **ç¬¬äºŒä¸ªæ˜¯å¤§Keyæ‹†åˆ†æ–¹æ¡ˆï¼Œå°†ä¸€ä¸ªå¤§å‹çš„Keyæ‹†åˆ†æˆå¤šä¸ªå°å‹çš„Keyï¼Œè¿™æ ·å¯ä»¥åˆ†æ•£å•ä¸ªKeyå¯¹Redisæ€§èƒ½çš„è´Ÿæ‹…ã€‚**

è¿™ä¸¤ç§æ€è·¯éƒ½èƒ½åœ¨ä¸åŒç¨‹åº¦ä¸Šå¸®åŠ©æˆ‘ä»¬å‡è½»å¤§Keyé—®é¢˜å¸¦æ¥çš„æŒ‘æˆ˜ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹æ¯ç§æ–¹æ¡ˆçš„å…·ä½“å®æ–½æ–¹æ³•ã€‚

## æ•°æ®å‹ç¼©æ–¹æ¡ˆ

åœ¨å®é™…çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å°†æ•°æ®ä»¥JSONå­—ç¬¦ä¸²çš„å½¢å¼å­˜å‚¨åˆ°Redisä¸­ã€‚å¯¹äºè¿™ç±»æ•°æ®ï¼Œå¦‚æœèƒ½åœ¨å­˜å‚¨å‰å»é™¤JSONä¸­å¤šä½™çš„æ•°æ®ï¼Œæ¯”å¦‚JSONé‡Œé¢çš„Keyï¼Œé‚£ä¹ˆå­˜å‚¨åˆ°Redisçš„æ•°æ®é‡å°±ä¼šç›¸åº”å‡å°‘ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥**åˆ©ç”¨ Protocol Buffersï¼ˆPBï¼‰ç­‰åºåˆ—åŒ–å·¥å…·å¯¹æ•°æ®è¿›è¡Œé¢„å¤„ç†ï¼Œç„¶åå†å­˜å‚¨åˆ°Redisä¸­**ã€‚è¿™æ ·åšå¯ä»¥æ˜¾è‘—å‡å°‘å­˜å‚¨åœ¨Redisä¸­çš„æ•°æ®å¤§å°ï¼Œé™ä½å‡ºç°å¤§Keyé—®é¢˜çš„é£é™©ã€‚

ä»¥ä¸‹é¢ä»£ç ä¸­çš„JSONå­—ç¬¦ä¸²ä¸ºä¾‹ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥å°†å…¶å­˜å‚¨åˆ°Redisä¸­ï¼Œæ‰€å çš„å­—èŠ‚å¤§å°ä¸º94å­—èŠ‚ã€‚

```go
func main() {
    dataStr := []byte(`{
        "product_id":1,
        "name":"aaaa",
        "price":111,
        "url":"https://www.xxx.com/image.jpg"
    }`)
    fmt.Println(len(dataStr)) // jsonå­—ç¬¦ä¸²å­—èŠ‚æ•°ï¼Œè¾“å‡º94
}
```

è€Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„PBæ–‡ä»¶æ ¼å¼ï¼Œæƒ…å†µå°±æœ‰æ‰€ä¸åŒäº†ã€‚

```go
syntax = "proto3";

option go_package = "./pb";  // å°†è¿™é‡Œä¿®æ”¹ä¸ºä½ æœŸæœ›çš„åŒ…åå’Œè·¯å¾„

message Product {
  int32 product_id = 1;
  string name = 2;
  int32 price = 3;
  string url = 4;
}
```

æŒ‰ä¸‹é¢çš„ä»£ç è¿›è¡Œåºåˆ—åŒ–ï¼Œå­˜å‚¨åˆ°Redisçš„æ•°æ®å°†æ˜¾è‘—å‡å°‘ï¼Œå˜æˆäº†41å­—èŠ‚ã€‚å’Œç›´æ¥å­˜å…¥JSONå­—ç¬¦ä¸²ç›¸æ¯”ï¼Œæ•°æ®å¤§å°é™ä½äº†50%ä»¥ä¸Šã€‚

```go
func main() {
    product := &pb.Product{
        ProductId: 1,
        Name:      "aaaa",
        Price:     111,
        Url:       "https://www.xxx.com/image.jpg",
    }
    data, _ := proto.Marshal(product)
    fmt.Println(len(data)) // PBåºåˆ—åŒ–åå­—èŠ‚æ•°ï¼Œè¾“å‡º41
}
```

å°½ç®¡æˆ‘ä»¬å¯ä»¥é€šè¿‡PBåºåˆ—åŒ–æ¥å‡å°‘å­˜å‚¨åˆ°Redisçš„æ•°æ®å¤§å°ï¼Œä½†å¦‚æœPBåºåˆ—åŒ–åçš„æ•°æ®ä»ç„¶è¾ƒå¤§ï¼Œæˆ–è€…ä¸é€‚åˆä½¿ç”¨PBåºåˆ—åŒ–çš„æƒ…å†µï¼Œæ¯”å¦‚Valueä¸æ˜¯JSONå½¢å¼ï¼Œæˆ‘ä»¬åˆè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

## å¤§Keyæ‹†åˆ†æ–¹æ¡ˆ

è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥é‡‡ç”¨å¤§Keyæ‹†åˆ†æ–¹æ¡ˆã€‚**æ‰€è°“å¤§Keyæ‹†åˆ†**ï¼Œ**æ˜¯æŒ‡å°†ä¸€ä¸ªKeyçš„æ•°æ®ï¼Œæ‹†åˆ†æˆå¤šä¸ªå°å—ï¼Œæ¯ä¸ªå°å—å­˜å…¥ä¸åŒçš„Redis Serveré‡Œï¼Œä»è€Œé¿å…å•ä¸ªRedis Serverå¤„ç†å¤§Keyçš„å‹åŠ›**ã€‚ä½ å¯ä»¥å‚è€ƒåé¢çš„ç¤ºæ„å›¾æ¥ç†è§£ã€‚

![](https://static001.geekbang.org/resource/image/cd/d7/cd0fbdd658ed1074f82089cc42a8f8d7.jpg?wh=3377x2937 "å›¾2 å¤§ Key æ‹†åˆ†")

å¯¹äºå¤§Keyçš„æ‹†åˆ†ï¼Œä¸åŒå›¢é˜Ÿå¯èƒ½ä¼šæœ‰ä¸åŒçš„å®ç°æ€è·¯ã€‚ç„¶è€Œï¼Œè¿™äº›æ–¹æ¡ˆéƒ½å­˜åœ¨ä¸€ä¸ªæ ¸å¿ƒéš¾ç‚¹ï¼Œå³å¦‚ä½•æœ‰æ•ˆè§„é¿è„è¯»ç°è±¡ã€‚

ä¸¾ä¾‹æ¥è¯´ï¼Œæ­£å¦‚ä¸‹æ–¹çš„å›¾é‡Œå‘ˆç°çš„é‚£æ ·ï¼Œå½“æ–°æ•°æ®å†™å…¥sub\_key1ï¼Œä½†å°šæœªæ›´æ–°sub\_key2 æ—¶ï¼Œå¦‚æœæœ‰è¯»Redisçš„è¯·æ±‚ï¼Œå°±æœ‰å¯èƒ½è¯»å–åˆ°æ—§çš„sub\_key2 æ•°æ®ä¸æ–°çš„sub\_key1æ•°æ®ï¼Œè¿›è€Œæ‹¼æ¥å‡ºä¸€ä¸ªåœ¨å®é™…ä¸­å¹¶ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè¿™ä¼šç»™æ•°æ®çš„å‡†ç¡®æ€§å’Œå¯é æ€§å¸¦æ¥æå¤§çš„è´Ÿé¢å½±å“ã€‚

![](https://static001.geekbang.org/resource/image/81/61/811f6ec9a796d8caa030dc210c9bd261.jpg?wh=3788x2618 "å›¾3 è„è¯»é—®")

é‚£æˆ‘ä»¬è¯¥å¦‚ä½•æ‹†åˆ†å¤§Keyæ‰èƒ½é˜²æ­¢è„è¯»å‘¢ï¼Ÿ

è¿™é‡Œæˆ‘ä»¬æ¥å­¦ä¹ ä¸€ç§åœ¨å®é™…åº”ç”¨ä¸­è¾ƒä¸ºé€šç”¨çš„å¤§ Key æ‹†åˆ†æ–¹æ¡ˆã€‚å®ƒçš„æ ¸å¿ƒè®¾è®¡ç†å¿µåœ¨äºå·§å¦™å€ŸåŠ©ç‰ˆæœ¬å·è¿™ä¸€æœºåˆ¶ï¼Œè€Œéé‡‡ç”¨ç›´æ¥è¦†ç›–åŸå§‹æ•°æ®çš„åšæ³•ï¼Œä»è€Œè¾¾æˆæœ‰æ•ˆé˜²æ­¢è„è¯»çš„ç›®çš„ã€‚

å°±åƒä¸‹é¢çš„ä»£ç å±•ç¤ºçš„ä¸€æ ·ï¼Œè¿™ä¸ªæ–¹æ¡ˆå¯¹å¤§Keyè¿›è¡Œæ‹†åˆ†ï¼Œå¹¶å†™å…¥Redisçš„å…³é”®æµç¨‹å¦‚ä¸‹ã€‚

1. é¦–å…ˆï¼Œå¯¹äºå¤§Keyï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°æ®è¿›è¡Œ MD5 è¿ç®—ï¼Œå¹¶æå–è¿ç®—ç»“æœçš„å 6 ä½ä½œä¸ºæœ¬æ¬¡æ•°æ®çš„ç‰¹å®šç‰ˆæœ¬å·ã€‚
2. æ¥ç€ï¼Œæˆ‘ä»¬æŒ‰å­—èŠ‚å¤§å°åšæ‹†åˆ†ï¼Œå­Keyæ‹¼æ¥ä¸Šç‰ˆæœ¬å·ï¼Œé¿å…ç›´æ¥è¦†ç›–ä¹‹å‰çš„æ•°æ®ï¼Œå¯¼è‡´è„è¯»ã€‚
3. ç„¶åï¼Œæˆ‘ä»¬æ›´æ–°Keyçš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œå…ƒæ•°æ®ä¿¡æ¯é‡Œè®°å½•äº†å­Keyä¿¡æ¯ï¼Œä»è€Œä½¿çº¿ä¸Šç”Ÿæ•ˆã€‚
4. æœ€åï¼Œæˆ‘ä»¬éœ€è¦ç»™æ—§å­Keyè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ é™¤ï¼Œé¿å…æœ‰Clientæ­£åœ¨è¯»æ—§å­Keyæ•°æ®ã€‚

```go
// æ•°æ®å…ƒä¿¡æ¯
type MetaInfo struct {
        Data     []byte   `json:"data"` // å¦‚æœä¸æ˜¯å¤§Keyç›´æ¥å–è¿™ä¸ªå­—æ®µï¼Œé¿å…éœ€è¦è¯·æ±‚Redisä¸¤æ¬¡
        IsBigKey bool     `json:"is_big_key"`// æ ‡è®°æ˜¯å¦æ˜¯å¤§Keyï¼Œå¦‚æœä¸æ˜¯ï¼Œç›´æ¥å–Dataå­—æ®µ
        Keys     []string `json:"keys"` // å­Keyæ•°ç»„
}

// å°†ValueæŒ‰å­—èŠ‚å¤§å°æ‹†åˆ†åå­˜å…¥Redis
func storeValueInRedis(ctx context.Context, key string, value []byte, chunkSize int) error {
        // è®¡ç®—éœ€è¦å¤šå°‘ä¸ªchunk
        totalChunks := len(value) / chunkSize
        if len(value)%chunkSize != 0 {
                totalChunks++
        }
        // é»˜è®¤å°Key
        meta := MetaInfo{IsBigKey: false, Data: value}
        // å¤§keyå¤„ç†
        if totalChunks > 1 {
                // md5å6ä½ä½œä¸ºæ•°æ®ç‰ˆæœ¬å·
                version := md5LastSixBytes(value)
                keys := make([]string, 0, totalChunks)
                // åˆ›å»ºPipeline
                pipe := redisClient.Pipeline()
                // å­˜å‚¨æ¯ä¸ªchunk
                for i := 0; i < totalChunks; i++ {
                        start := i * chunkSize
                        end := (i + 1) * chunkSize
                        if end > len(value) {
                                end = len(value)
                        }
                        chunk := value[start:end]

                        // æ„é€ æ¯ä¸ªchunkçš„Key
                        chunkKey := fmt.Sprintf("%s:%s:%d", key, version, i)
                        keys = append(keys, chunkKey)
                        // å°†chunkå­˜å…¥Pipeline
                        pipe.Set(ctx, chunkKey, chunk, 0)

                }
                // æ‰§è¡ŒPipelineä¸­çš„æ‰€æœ‰å‘½ä»¤
                _, err := pipe.Exec(ctx)
                if err != nil {
                        return err
                }
                meta = MetaInfo{IsBigKey: true, Keys: keys, Data: nil}
        }
        metaByte, err := json.Marshal(meta)
        if err != nil {
                return err
        }
        // è·å–åŸæ¥çš„æ•°æ®å…ƒä¿¡æ¯ï¼Œä»¥ä¾¿è®¾ç½®è¿‡æœŸæ—¶é—´
        oldMetaByte, err := redisClient.Get(ctx, key).Bytes()
        if err != nil {
                return err
        }
        // æ–°æ•°æ®ç”Ÿæ•ˆ
        _, err = redisClient.Set(ctx, key, metaByte, 0).Result()
        if err != nil {
                return err
        }
        var oldMetaInfo MetaInfo
        err = json.Unmarshal(oldMetaByte, &oldMetaInfo)
        if err != nil {
                return err
        }
        if oldMetaInfo.IsBigKey {
                // è·å–æ—§Key,è®¾ç½®æ—§Keyè¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚è¯´10åˆ†é’Ÿï¼Œé˜²æ­¢æœåŠ¡ç«¯è¿˜æœ‰æ—§æ•°æ®åœ¨è¯»
        }
        return nil
}
```

çœ‹å®Œå¤§Keyå†™å…¥ï¼Œç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¤§Keyè¯»å–çš„å…³é”®æµç¨‹ã€‚

1. é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®æŸ¥è¯¢çš„Keyï¼Œä»Redisè·å–åŒ…å«å­Keyçš„å…ƒæ•°æ®ä¿¡æ¯ã€‚
2. æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å­Keyï¼Œè·å–å„ä¸ªå­Keyçš„æ•°æ®ã€‚
3. æœ€åï¼ŒæŠŠè·å–çš„å­Keyæ•°æ®æ‹¼æ¥èµ·æ¥ï¼Œå°±å¾—åˆ°äº†æˆ‘ä»¬éœ€è¦çš„å®Œæ•´å¤§Keyæ•°æ®ã€‚

ä¸‹é¢æ˜¯è¯»å–çš„ä»£ç ï¼Œä¾›ä½ å‚è€ƒã€‚

```go
// ä»Redisè·å–æ•°æ®
func getDataFromRedis(ctx context.Context, key string) ([]byte, error) {
        // è·å–æ•°æ®å…ƒä¿¡æ¯
        metaByte, err := redisClient.Get(ctx, key).Bytes()
        if err != nil {
                return nil, err
        }

        var metaInfo MetaInfo
        err = json.Unmarshal(metaByte, &metaInfo)
        if err != nil {
                return nil, err
        }
        // ä¸æ˜¯å¤§Keyï¼Œç›´æ¥å–Dataå­—æ®µæ•°æ®
        if !metaInfo.IsBigKey {
                // å¦‚æœä¸æ˜¯å¤§Keyï¼Œç›´æ¥è¿”å›Dataå­—æ®µ
                return metaInfo.Data, nil
        }

        // å¦‚æœæ˜¯å¤§Keyï¼Œä½¿ç”¨Pipelineä»å¤šä¸ªé”®ä¸­è·å–æ•°æ®
        pipe := redisClient.Pipeline()

        // å°†æ‰€æœ‰Getæ“ä½œæ·»åŠ åˆ°Pipeline
        for _, chunkKey := range metaInfo.Keys {
                pipe.Get(ctx, chunkKey)
        }

        // æ‰§è¡ŒPipelineä¸­çš„æ‰€æœ‰å‘½ä»¤
        cmds, err := pipe.Exec(ctx)
        if err != nil {
                return nil, err
        }

        // è·å–çš„å„ä¸ªå­Keyæ•°æ®è¿›è¡Œæ‹¼æ¥ï¼Œå°±æ˜¯å®Œæ•´çš„æ•°æ®
        var data []byte
        for _, cmd := range cmds {
                if cmd.Err() != nil {
                        return nil, cmd.Err()
                }

                chunkData := []byte(cmd.String())
                if err != nil {
                        return nil, err
                }
                data = append(data, chunkData...)
        }

        return data, nil
}
```

## å°ç»“

ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬è®¨è®ºäº†å¤§Keyé—®é¢˜ï¼Œå¹¶æå‡ºäº†ä¸¤ç§æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä¸€èµ·å›é¡¾ä¸‹è¿™ä¸¤ä¸ªæ–¹æ¡ˆã€‚

é¦–å…ˆæ˜¯**åŸºäºPBåºåˆ—åŒ–çš„æ•°æ®å‹ç¼©æ–¹æ¡ˆ**ã€‚åœ¨å°†æ•°æ®å­˜å‚¨åˆ°Redisæ—¶ï¼Œæˆ‘ä»¬å¾ˆå¤šæ—¶å€™ä¼šä½¿ç”¨JSONæ ¼å¼ã€‚é€šè¿‡æ”¹ç”¨PBåºåˆ—åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥é¿å…ä¸å¿…è¦çš„æ•°æ®å†™å…¥ï¼Œä»è€Œæœ‰æ•ˆå‡å°‘æ•°æ®ä½“ç§¯ï¼Œé¢„é˜²å¤§Keyé—®é¢˜çš„å‘ç”Ÿã€‚

å…¶æ¬¡æ˜¯**åŸºäºç‰ˆæœ¬å·æœºåˆ¶çš„å¤§Keyæ‹†åˆ†æ–¹æ¡ˆ**ã€‚åœ¨æ•°æ®ç»è¿‡å‹ç¼©åï¼Œå¦‚æœå®ƒçš„å¤§å°ä»ç„¶è¶…å‡ºäº†å¤§Keyçš„æ ‡å‡†ï¼Œæˆ‘ä»¬å°±å¯ä»¥é‡‡ç”¨è¿™ä¸€æ–¹æ¡ˆã€‚é€šè¿‡å°†æ•°æ®æ‹†åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼Œå¹¶ä¸ºæ¯ä¸ªéƒ¨åˆ†æ·»åŠ ç‰ˆæœ¬å·ä½œä¸ºå­Keyï¼Œæˆ‘ä»¬å¯ä»¥æœ‰æ•ˆé¿å…å› æ‹†åˆ†æ“ä½œè€Œå¯èƒ½å¼•å‘çš„è„è¯»é—®é¢˜ã€‚

å¸Œæœ›ä½ å¥½å¥½ä½“ä¼šè¿™ä¸¤ä¸ªæ–¹æ¡ˆã€‚åœ¨æœªæ¥é‡åˆ°å¤§Keyé—®é¢˜æ—¶ï¼Œä¸å¦¨è€ƒè™‘è¿ç”¨è¿™äº›æ–¹æ¡ˆæ¥æœ‰æ•ˆè§£å†³é—®é¢˜ã€‚

## æ€è€ƒé¢˜

åœ¨å®è·µä¸­ï¼Œé¢å¯¹å¤§Keyé—®é¢˜ï¼Œä½ è¿˜æœ‰å“ªäº›è§£å†³æ–¹å¼å‘¢ï¼Ÿ

æ¬¢è¿ä½ æŠŠä½ çš„ç­”æ¡ˆåˆ†äº«åœ¨è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ2ï¼‰</strong></div><ul>
<li><span>lJ</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>1. ã€Šé˜¿é‡Œäº‘ã€‹æ–‡æ¡£æåˆ°äº†å››ç‚¹ï¼Œå¯¹å¤§Keyè¿›è¡Œæ‹†åˆ†ã€å¯¹å¤§Keyè¿›è¡Œæ¸…ç†ã€ç›‘æ§å®ä¾‹çš„å†…å­˜æ°´ä½ã€å¯¹è¿‡æœŸæ•°æ®è¿›è¡Œå®šæœŸæ¸…ç†ã€‚
2. æå‰è§„åˆ’æ•°æ®ç»“æ„ï¼Œä»ç³»ç»Ÿè®¾è®¡é˜¶æ®µå¼€å§‹ä¼˜åŒ–æ•°æ®ç»“æ„ï¼Œé¿å…äº§ç”Ÿå¤§ Keyã€‚
3. ä¸ºå¤§ Key è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼Œç¡®ä¿æ— ç”¨æ•°æ®åŠæ—¶æ¸…ç†ã€‚
4. å°†æ•°æ®åˆ†ç‰‡å­˜å‚¨åˆ°å¤šä¸ª Redis å®ä¾‹ä¸­ï¼Œé¿å…å•ä¸ªå®ä¾‹ä¸­çš„å¤§ Key é—®é¢˜ã€‚
5. é¿å…ç›´æ¥åˆ é™¤å¤§ Keyï¼Œé€šè¿‡å¼‚æ­¥ä»»åŠ¡åˆ†æ‰¹åˆ é™¤å…¶æ•°æ®ï¼Œå‡å°‘é˜»å¡ã€‚é€šè¿‡ UNLINK å‘½ä»¤æ›¿ä»£ DELã€‚</p>2025-01-06</li><br/><li><span>ã€WJã€</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä½ è¿™é‡Œå¤§Key çš„åˆ¤æ–­æ ‡å‡†å’Œé˜¿é‡Œäº‘å†™çš„ä¸ä¸€æ ·ï¼Œ5Må’Œ500Mæ¥è¯´å¤§å¤ªå¤šäº†ï¼Œæ˜¯ä¸æ˜¯å¼„é”™äº†</p>2025-01-06</li><br/>
</ul>