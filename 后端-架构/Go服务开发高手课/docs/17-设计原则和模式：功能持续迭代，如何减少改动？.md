ä½ å¥½ï¼Œæˆ‘æ˜¯å¾é€¸ã€‚

ä¸ŠèŠ‚è¯¾æˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•æ„å»ºä¸€ä¸ªè§„èŒƒçš„ç›®å½•ï¼Œä¸è¿‡å¯¹äºä¸€ä¸ªå¿«é€Ÿè¿­ä»£çš„é¡¹ç›®ï¼Œå³ä¾¿æœ‰äº†æ¸…æ™°çš„ç›®å½•ç»“æ„ï¼Œä½†å¦‚æœå†™ä»£ç ä¸è®²ç©¶ä¸€å®šçš„æ–¹æ³•ï¼Œåç»­ä¿®æ”¹å’Œæ‰©å±•ä¹Ÿä¼šéå¸¸å›°éš¾ã€‚é’ˆå¯¹å†™ä»£ç è¿‡ç¨‹ä¸­é¢ä¸´çš„ä¸€äº›åœºæ™¯ï¼Œä¸šç•Œæ—©å°±æ€»ç»“å½’çº³å‡ºäº†ä¸€äº›é€šç”¨è§£å†³æ–¹æ¡ˆï¼Œè€Œè¿™äº›åœºæ™¯å’Œå¯¹åº”çš„è§£å†³æ–¹æ¡ˆï¼Œæ­£æ˜¯æˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„è®¾è®¡åŸåˆ™å’Œè®¾è®¡æ¨¡å¼ã€‚

ä»Šå¤©æˆ‘å°±ä»¥ä¸€ä¸ªä¸ªéœ€æ±‚çš„å½¢å¼ï¼Œå¸¦ä½ ä½“ä¼šåœ¨åšéœ€æ±‚çš„è¿‡ç¨‹ä¸­ï¼Œä»£ç è®¾è®¡åŸåˆ™å’Œè®¾è®¡æ¨¡å¼æ˜¯å¦‚ä½•åœ¨Golangé¡¹ç›®ä¸­åº”ç”¨çš„ã€‚

åœ¨ä¸ŠèŠ‚è¯¾çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„å•†å“serviceæœ‰ä¸ªGetProductæ–¹æ³•ï¼Œç”¨äºä»Redisç¼“å­˜è¯»å•†å“ä¿¡æ¯ã€‚

```go
// product_service.go
// GetProduct è·å–å•†å“ä¿¡æ¯
func GetProduct(ctx context.Context, productID string) (*model.Product, error) {
    product, err := redis.GetProduct(ctx, productID)
    if err != nil {
        return nil, err
    }
    if product != nil {
        return product, nil
    }
    product, err = mysql.GetProduct(ctx, productID)
    if err != nil {
        return nil, err
    }
    redis.SetProduct(ctx, product)
    return product, nil
}
```

ç°åœ¨æˆ‘ä»¬åœ¨æœ¬åœ°å†™ä¸ªå•å…ƒæµ‹è¯•ï¼ŒéªŒè¯å„ç§æƒ…å†µä¸‹è¿™ä¸ªGetProductæ–¹æ³•æ˜¯å¦æ­£ç¡®ã€‚

```go
// product_service_test.go
func TestGetProduct(t *testing.T) {
    ctx := context.TODO()
    productID := "1"
    product, _ := GetProduct(ctx, productID)
    assert.Equal(t, productID, product.ProductID, "The two id should be the same.")
}
```

ä¸ºäº†éªŒè¯Rediså’ŒMySQLé‡Œé¢åˆ†åˆ«æœ‰å€¼çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„GetProductæ–¹æ³•è¿”å›æ˜¯å¦æ­£å¸¸ï¼Œæˆ‘ä»¬è¦ä¹ˆæ”¹dalç›®å½•é‡Œçš„ä»£ç ï¼Œå†™æ­»æ–¹æ³•çš„è¿”å›å€¼ç”¨äºæµ‹è¯•ï¼Œè¦ä¹ˆå¾€æµ‹è¯•ç¯å¢ƒRediså’ŒMySQLé‡Œé€ æ•°æ®ã€‚

ç„¶è€Œï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¸å¤ªç†æƒ³ã€‚æ”¹dalç›®å½•é‡Œä»£ç çš„æ–¹å¼ï¼Œå¾ˆå®¹æ˜“å°±å¿˜äº†æ”¹å›å»å¯¼è‡´çº¿ä¸ŠBugã€‚å¾€æµ‹è¯•ç¯å¢ƒRediså’ŒMySQLé€ æ•°æ®çš„æ–¹å¼ï¼Œç”±äºæµ‹è¯•ç¯å¢ƒä¸ç¨³å®šï¼Œåˆå¾ˆéš¾ä¿è¯æˆ‘ä»¬å•æµ‹ç»“æœçš„ç¨³å®šæ€§ã€‚

## ä¾èµ–åè½¬åŸåˆ™

é‚£æœ‰æ²¡æœ‰ä¸ç”¨æ”¹dalå±‚ä»£ç ï¼Œä¹Ÿä¸ç”¨å¾€Rediså’ŒMySQLé€ æ•°æ®ï¼Œè¿˜å¯ä»¥åœ¨æµ‹è¯•æ–‡ä»¶æ¨¡æ‹Ÿå¤–éƒ¨ä¾èµ–è¿”å›ï¼Œæ–¹ä¾¿æµ‹è¯•æˆ‘ä»¬serviceå±‚é€»è¾‘çš„æ–¹æ³•å‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥ç”¨Golangæ¥å£å’Œä¾èµ–åè½¬åŸåˆ™æ¥å®ç°mockå¤–éƒ¨ä¾èµ–çš„èƒ½åŠ›ã€‚**æ‰€è°“ä¾èµ–åè½¬ï¼Œæ˜¯æŒ‡é«˜å±‚æ¨¡å—ä¸åº”è¯¥ç›´æ¥ä¾èµ–äºä½å±‚æ¨¡å—çš„å…·ä½“å®ç°ï¼Œä¸¤è€…éƒ½åº”è¯¥ä¾èµ–äºæ¥å£ã€‚è¿™æ ·å½“ä½å±‚æ¨¡å—éœ€è¦æ›´æ¢æˆ–å‡çº§æ—¶ï¼Œåªè¦æ–°çš„æ¨¡å—ä»ç„¶æ»¡è¶³é«˜å±‚æ¨¡å—æ‰€ä¾èµ–çš„æ¥å£ï¼Œå°±ä¸ä¼šå½±å“é«˜å±‚æ¨¡å—çš„æ­£å¸¸è¿è¡Œ**ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹é¢ä»£ç ä¸­serviceå±‚è·å–å•†å“ä¿¡æ¯çš„GetProductæ–¹æ³•ï¼Œå°±æ˜¯å› ä¸ºç›´æ¥ä¾èµ–äº†Rediså’ŒMySQLç›®å½•é‡Œé¢çš„å®ç°å‡½æ•°ï¼Œæ‰€ä»¥æ‰å¯¼è‡´æ— æ³•åœ¨æµ‹è¯•æ–‡ä»¶é‡Œé¢æ›¿æ¢GetProductæ–¹æ³•å¯¹Rediså’ŒMySQLçš„è°ƒç”¨ï¼Œå®ç°mockå¤–éƒ¨ä¾èµ–èƒ½åŠ›ã€‚

```go
// product_service.go
// GetProduct è·å–å•†å“ä¿¡æ¯
func GetProduct(ctx context.Context, productID string) (*model.Product, error) {
    product, err := redis.GetProduct(ctx, productID)
    if err != nil {
        return nil, err
    }
    if product != nil {
        return product, nil
    }
    product, err = mysql.GetProduct(ctx, productID)
    if err != nil {
        return nil, err
    }
    redis.SetProduct(ctx, product)
    return product, nil
}
```

ç°åœ¨è®©æˆ‘ä»¬ç”¨Golangæ¥å£å’Œä¾èµ–åè½¬åŸåˆ™ï¼Œé‡æ„ä¸€ä¸‹ä»£ç ï¼Œå®ç°mockå¤–éƒ¨ä¾èµ–çš„èƒ½åŠ›ã€‚

é¦–å…ˆï¼Œé‡æ„ä¸€ä¸‹dalå±‚è¯»å†™Redisçš„å‡½æ•°ï¼Œå®šä¹‰ä¸€ä¸ªProductæ¥å£å’ŒProductImplç»“æ„ä½“ã€‚æ¥å£é‡Œé¢å®šä¹‰äº†è¯»å†™Redisçš„æ–¹æ³•ï¼ŒProductImplç»“æ„ä½“å®ç°äº†è¿™ä¸ªæ¥å£ã€‚

```go
// redis/product.go
type Product interface {
    GetProduct(ctx context.Context, productID string) (*model.Product, error)
    SetProduct(ctx context.Context, product *model.Product) error
}

// redis/product.go
// å•†å“ç»“æ„ä½“ï¼Œå®ç°äº†è¯»å†™redis
type ProductImpl struct {

}

// redisç›®å½•product.goæ–‡ä»¶
// GetProduct è·å–å•†å“ä¿¡æ¯
func (impl *ProductImpl) GetProduct(ctx context.Context, productID string) (*model.Product, error) {
    // ä» Redis ä¸­è·å–å•†å“ä¿¡æ¯
    productKey := fmt.Sprintf("product:%s", productID)
    result, err := client.Get(productKey).Result()

    if err == redis.Nil {
        return nil, nil
    } else if err != nil {
        return nil, err
    }

    // å‡è®¾å•†å“ä¿¡æ¯åœ¨ç¼“å­˜ä¸­æ˜¯ä»¥ JSON æ ¼å¼å­˜å‚¨çš„
    var product model.Product
    err = json.Unmarshal([]byte(result), &product)
    if err != nil {
        return nil, err
    }
    return &product, nil
}

func (impl *ProductImpl) SetProduct(ctx context.Context, product *model.Product) error {
    return nil
}
```

æ¥ç€ï¼Œæˆ‘ä»¬æŒ‰åŒæ ·çš„æ–¹å¼ï¼Œé‡æ„è¯»MySQLçš„é€»è¾‘ï¼Œåœ¨MySQLç›®å½•é‡Œå®šä¹‰ä¸€ä¸ªProductæ¥å£å’ŒProductImplç»“æ„ä½“ï¼ŒProductImplç»“æ„ä½“å®ç°äº†Productæ¥å£ï¼Œç”¨äºä»MySQLè¯»å–å•†å“ä¿¡æ¯ã€‚

```go
// mysqlç›®å½•product.goæ–‡ä»¶

type Product interface {
    GetProduct(ctx context.Context, productID string) (*model.Product, error)
}

type ProductImpl struct {
}

// GetProduct è·å–å•†å“ä¿¡æ¯
func (impl *ProductImpl) GetProduct(ctx context.Context, productID string) (*model.Product, error) {
    var product model.Product
    err := db.QueryRow("SELECT product_id,product_name, amount  FROM orders WHERE product_id =?", productID).Scan(&product.ProductID, &product.ProductName, &product.Amount)
    if err != nil {
        return nil, err
    }
    return &product, nil
}
```

ç„¶åï¼Œæˆ‘ä»¬æŠŠserviceå±‚ï¼Œè¯»å•†å“ä¿¡æ¯çš„GetProductæ–¹æ³•é‡æ„ä¸€ä¸‹ã€‚å®šä¹‰ProductServiceæ¥å£å’Œç»“æ„ä½“ProductServiceImplï¼ŒProductServiceImplå®ç°äº†ProductServiceæ¥å£ã€‚è¿™é‡Œè¯·ä½ ç•™æ„ä¸€ä¸‹ProductServiceImplç»“æ„ä½“å†…éƒ¨çš„æˆå‘˜å˜é‡ï¼Œ**å¹¶ä¸ç›´æ¥ä¾èµ–dalå±‚é‡Œé¢çš„ç»“æ„ä½“ï¼Œè€Œæ˜¯ä¾èµ–dalå±‚çš„æ¥å£ã€‚**

```go
type ProductService interface {
    GetProduct(ctx context.Context, productID string) (*model.Product, error)
}
type ProductServiceImpl struct {
    cache redis.Product // æ¥å£ç±»å‹
    db    mysql.Product // æ¥å£ç±»å‹
}

// GetProduct è·å–å•†å“ä¿¡æ¯
func (impl *ProductServiceImpl) GetProduct(ctx context.Context, productID string) (*model.Product, error) {
    product, err := impl.cache.GetProduct(ctx, productID)
    if err != nil {
        return nil, err
    }
    if product != nil {
        return product, nil
    }
    product, err = impl.db.GetProduct(ctx, productID)
    if err != nil {
        return nil, err
    }
    impl.cache.SetProduct(ctx, product)
    return product, nil
}
```

æœ€åï¼Œå¯¹äºProductServiceImplç»“æ„ä½“é‡Œé¢çš„æˆå‘˜å˜é‡ï¼Œæˆ‘ä»¬é€šè¿‡NewProductServiceæ–¹æ³•æ³¨å…¥ã€‚

```go
func NewProductService(cacheProduct redis.Product, dbProduct mysql.Product) ProductService {
    return &ProductServiceImpl{cache: cacheProduct, db: dbProduct}
}
```

é‡æ„ä¹‹åï¼Œæˆ‘ä»¬çš„serviceå±‚å°±ä¸ç›´æ¥ä¾èµ–dalå±‚çš„å®ç°ï¼Œè€Œæ˜¯ä¾èµ–dalå±‚çš„æ¥å£ï¼Œè€Œä¸”æ¥å£çš„å®ç°é€šè¿‡NewProductServiceæ–¹æ³•æ³¨å…¥ï¼Œç¬¦åˆä¾èµ–åè½¬åŸåˆ™ã€‚

ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼Œä»£ç é‡æ„ä¹‹åï¼Œåœ¨å•æµ‹æ—¶æ€ä¹ˆmockå¤–éƒ¨ä¾èµ–è¿”å›å‘¢ï¼Ÿ

```go
func TestGetProduct(t *testing.T) {
    ctx := context.TODO()
    // æ³¨å…¥mockç»“æ„ä½“
    impl := NewProductService(&MockProductCache{}, &MockProductDB{})
    productID := "1"
    product, _ := impl.GetProduct(ctx, productID)
    assert.Equal(t, productID, product.ProductID, "The two id should be the same.")
}

// mock å•†å“è¯»å†™redis
type MockProductCache struct {
}

func (cache *MockProductCache) GetProduct(ctx context.Context, productID string) (*model.Product, error) {
    return &model.Product{ProductID: productID}, nil
}

func (cache *MockProductCache) SetProduct(ctx context.Context, product *model.Product) error {
    return nil
}

// mockå•†å“ä»dbè¯»
type MockProductDB struct {
}

func (db *MockProductDB) GetProduct(ctx context.Context, productID string) (*model.Product, error) {
    return nil, nil
}
```

å°±åƒä¸Šé¢è¿™æ®µä»£ç ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨æµ‹è¯•æ–‡ä»¶å®ç°dalå±‚çš„æ¥å£ï¼Œæ¯”å¦‚MockProductCacheå’ŒMockProductDBç»“æ„ä½“ï¼Œå¹¶é€šè¿‡NewProductServiceæ–¹æ³•æ³¨å…¥serviceå±‚ã€‚

## ç­–ç•¥æ¨¡å¼å’Œç®€å•å·¥å‚æ–¹æ³•

å­¦å®Œäº†ä¾èµ–åè½¬åŸåˆ™ï¼Œç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹Golangé¡¹ç›®ä¸­å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ã€‚

ä¸ŠèŠ‚è¯¾çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬handlerå±‚æœ‰ä¸ªè·å–å•†å“ä¿¡æ¯çš„æ–¹æ³•ï¼Œå®ƒæ˜¯è°ƒç”¨serviceå±‚çš„ä¸€ä¸ªä»Redisè¯»å•†å“ä¿¡æ¯çš„æ–¹æ³•å®ç°çš„ã€‚

```go
// product_handler.go
// GetProduct è·å–å•†å“ä¿¡æ¯
func GetProduct(ctx context.Context, productID string) (*model.Product, error) {
    // ä»serviceå±‚è¯»å•†å“ä¿¡æ¯
    serviceImpl := service.NewProductService(&redis.ProductImpl{}, &mysql.ProductImpl{})
    return serviceImpl.GetProduct(ctx, productID)
}
```

å¯¹äºæŸäº›å¯¹å•†å“ä¿¡æ¯çš„å‡†ç¡®æ€§è¦æ±‚éå¸¸é«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚ç”µå•†çš„ä¸‹å•é¡µç­‰ï¼Œéœ€è¦æ ¹æ®å•†å“ä»·æ ¼è®¡ç®—è®¢å•é‡‘é¢ã€‚æ¯•ç«Ÿå•†å“ä»·æ ¼ä¸å¯¹ï¼Œé‚£ç®—å‡ºæ¥çš„æ”¯ä»˜é‡‘é¢ä¹Ÿä¼šä¸å‡†ã€‚è€ŒRedisç”±äºæ˜¯ç¼“å­˜ï¼Œå’ŒDBå­˜åœ¨çŸ­æœŸçš„ä¸€è‡´æ€§é—®é¢˜ï¼Œå› æ­¤å¯¹äºè¿™äº›åœºæ™¯ï¼Œå¿…é¡»ç›´æ¥ä»DBè·å–æ•°æ®ã€‚

ä¸ºäº†å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬å°±è¦å¯¹handlerå±‚è·å–å•†å“ä¿¡æ¯çš„æ–¹æ³•è¿›è¡Œæ”¹é€ ï¼Œåœ¨ä»£ç é‡Œå¢åŠ if elseåˆ†æ”¯é€»è¾‘ï¼Œç”±å‰ç«¯ä¼ å…¥çš„å‚æ•°æ¥å†³å®šæ˜¯ä»DBå’Œè¿˜æ˜¯Redisè·å–æ•°æ®ã€‚

```go
// product_handler.go æ–‡ä»¶
// GetProduct è·å–å•†å“ä¿¡æ¯
func GetProduct(ctx context.Context, productID string, scene int) (*model.Product, error) {
    if scene == 1 {
        // ç›´æ¥è¯»db
        impl := &mysql.ProductImpl{}
        return impl.GetProduct(ctx, productID)
    } else {
        // ç¼“å­˜è¯»å†™é€»è¾‘
        impl := service.NewProductService(&redis.ProductImpl{}, &mysql.ProductImpl{})
        return impl.GetProduct(ctx, productID)
    }
}
```

å‡å¦‚é™¤äº†GetProductæ–¹æ³•éœ€è¦ä¸Šé¢è¿™æ®µif elseçš„ä»£ç é€»è¾‘ï¼Œæ¥åˆ¤æ–­æ˜¯èµ°DBè¿˜æ˜¯ç¼“å­˜ï¼Œåœ¨handleå±‚å…¶å®ƒåœ°æ–¹ä¹Ÿéœ€è¦è¿™æ®µåˆ¤æ–­é€»è¾‘ã€‚æˆ‘ä»¬è¯¥æ€ä¹ˆé¿å…ä»£ç é‡å¤å‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥ç”¨ç­–ç•¥æ¨¡å¼å’Œç®€å•å·¥å‚æ–¹æ³•æ¨¡å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

å…ˆå¤ä¹ ä¸€ä¸‹ç­–ç•¥æ¨¡å¼ï¼Œ**ç­–ç•¥æ¨¡å¼æŒ‡å¯¹è±¡æœ‰æŸä¸ªè¡Œä¸ºï¼Œä½†æ˜¯åœ¨ä¸åŒçš„åœºæ™¯ä¸­ï¼Œè¯¥è¡Œä¸ºæœ‰ä¸åŒçš„å®ç°ç®—æ³•**ã€‚å°±æ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„GetProductæ–¹æ³•ï¼Œå®ƒæœ‰ä»å¤–éƒ¨è·å–å•†å“ä¿¡æ¯çš„è¡Œä¸ºï¼Œä¸”ä¼šæ ¹æ®sceneå‚æ•°çš„ä¸åŒï¼Œé€‰æ‹©ä¸¤ç§ç­–ç•¥ï¼Œä»DBæˆ–æ˜¯ç¼“å­˜æŸ¥å•†å“ä¿¡æ¯ã€‚**ç­–ç•¥æ¨¡å¼æœ‰ä¸¤ä¸ªé‡è¦çš„ç»„æˆè§’è‰²ï¼Œä¸€ä¸ªæ˜¯æŠ½è±¡çš„ç­–ç•¥æ¥å£ï¼Œä¸€ä¸ªæ˜¯å®ç°è¿™ä¸ªæ¥å£çš„ç­–ç•¥ç±»ã€‚**

é‚£æ€ä¹ˆåº”ç”¨ç­–ç•¥æ¨¡å¼é‡æ„serviceå±‚å‘¢ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯ç»“åˆä¾‹å­æ¥çœ‹ï¼Œä¸‹é¢æ˜¯æˆ‘ç”¨ç­–ç•¥æ¨¡å¼é‡æ„åçš„ä»£ç ã€‚

```go
// é‡æ–°å®šä¹‰ä¸€ä¸ªç›´æ¥ä»dbè¯»çš„serviceå¹¶å®ç°æ¥å£ProductServiceã€‚

// service/product_service.go
// æŸ¥è¯¢å•†å“ä¿¡æ¯çš„ç­–ç•¥æ¥å£
type ProductService interface {
    GetProduct(ctx context.Context, productID string) (*model.Product, error)
}

// ä»DBè¯»çš„ç­–ç•¥ç±»
type ProductServiceDBImpl struct {
    db mysql.Product
}

func NewProductDBService(dbProduct mysql.Product) ProductService {
    return &ProductServiceDBImpl{db: dbProduct}
}

// GetProduct è·å–å•†å“ä¿¡æ¯
func (impl *ProductServiceDBImpl) GetProduct(ctx context.Context, productID string) (*model.Product, error) {
    return impl.db.GetProduct(ctx, productID)
}

// ä»ç¼“å­˜è¯»çš„ç­–ç•¥ç±»
type ProductCacheServiceImpl struct {
    cache redis.Product // æ¥å£ç±»å‹
    db    mysql.Product // æ¥å£ç±»å‹
}

func NewProductCacheService(cacheProduct redis.Product, dbProduct mysql.Product) ProductService {
    return &ProductServiceImpl{cache: cacheProduct, db: dbProduct}
}

// GetProduct è·å–å•†å“ä¿¡æ¯
func (impl *ProductServiceImpl) GetProduct(ctx context.Context, productID string) (*model.Product, error) {
    // ä»ç¼“å­˜è¯»
}
```

è¿™æ®µä»£ç å®šä¹‰äº†ä¸€ä¸ªProductServiceç­–ç•¥æ¥å£å’Œä¸¤ä¸ªå®ç°æ¥å£çš„ç­–ç•¥ç±»ProductServiceDBImplã€ProductServiceCacheImplç»“æ„ä½“ï¼Œç”±ç­–ç•¥ç±»åˆ†åˆ«å®ç°ä»DBå’Œç¼“å­˜è¯»çš„é€»è¾‘ã€‚

æ”¹ä¸ºç­–ç•¥æ¨¡å¼åï¼Œhandlerå±‚çš„ä»£ç å˜æˆäº†ä¸‹é¢çš„æ ·å­ï¼Œä¸å†ä¾èµ–dalå±‚å’Œserviceå±‚ä¸¤ä¸ªæ¥å£ï¼Œè€Œæ˜¯ç»Ÿä¸€ä¾èµ–ProductServiceç­–ç•¥æ¥å£ï¼Œå¹¶ä¸”ä»£ç ä¹Ÿæ¯”ä¹‹å‰ç®€æ´äº†å¾ˆå¤šï¼Œif elseé‡Œé¢åªè´Ÿè´£ç­–ç•¥ç±»å‹æ„é€ ï¼Œè°ƒç”¨åº•å±‚è·å–å•†å“ä¿¡æ¯çš„åŠ¨ä½œæ”¾åœ¨äº†if elseé€»è¾‘å¤–é¢ã€‚

```go
// product_handler.go æ–‡ä»¶
// GetProduct è·å–å•†å“ä¿¡æ¯
func GetProduct(ctx context.Context, productID string, scene int) (*model.Product, error) {
    var impl service.ProductService
    if scene == 1 {
        // ç›´æ¥è¯»db
        impl = service.NewProductDBService(&mysql.ProductImpl{})
    } else {
        // ç¼“å­˜è¯»å†™é€»è¾‘
        impl = service.NewProductCacheService(&redis.ProductImpl{}, &mysql.ProductImpl{})
    }
    return impl.GetProduct(ctx, productID)
}
```

è™½ç„¶è¿™æ®µä»£ç ä¾ç„¶æ²¡è§£å†³æˆ‘ä»¬çš„if elseé€»è¾‘åœ¨å„ä¸ªhandleré‡å¤çš„é—®é¢˜ï¼Œä½†æ˜¯è®©ä¸åŒçš„ç»“æ„ä½“ç±»å‹å®ç°ç›¸åŒçš„æ¥å£ï¼Œæ˜¯æˆ‘ä»¬åº”ç”¨ç®€å•å·¥å‚æ¨¡å¼è§£å†³é—®é¢˜çš„åŸºç¡€ã€‚

**ç®€å•å·¥å‚æ–¹æ³•æ¨¡å¼çš„å®è´¨æ˜¯ç”±ä¸€ä¸ªå·¥å‚æ–¹æ³•æ ¹æ®ä¼ å…¥çš„å‚æ•°ï¼ŒåŠ¨æ€å†³å®šåº”è¯¥åˆ›å»ºå“ªä¸€ä¸ªç»“æ„ä½“ï¼ˆè¿™äº›ç»“æ„ä½“å®ç°äº†åŒä¸€ä¸ªæ¥å£ï¼‰çš„å®ä¾‹**ã€‚

ä¸‹é¢æ˜¯æˆ‘ç”¨ç®€å•å·¥å‚æ–¹æ³•å¯¹handleré‡æ„åçš„ä»£ç ã€‚

```go
//handler/product_handler.goæ–‡ä»¶
// GetProduct è·å–å•†å“ä¿¡æ¯
func GetProduct(ctx context.Context, productID string, scene int) (*model.Product, error) {
    // è°ƒç”¨ç®€å•å·¥å‚æ–¹æ³•åˆ›å»ºå¯¹è±¡
    impl := service.NewProductService(scene)
    return impl.GetProduct(ctx, productID)
}

// service/product_service.go
// ç®€å•å·¥å‚æ–¹æ³•ï¼Œæ ¹æ®ä¼ å…¥å‚æ•°åˆ›å»ºåŒç±»å¯¹è±¡
func NewProductService(scene int) ProductService {
    var impl ProductService
    if scene == 1 {
        // ç›´æ¥è¯»db
        impl = NewProductDBService(&mysql.ProductImpl{})
    } else {
        // ç¼“å­˜è¯»å†™é€»è¾‘
        impl = NewProductCacheService(&redis.ProductImpl{}, &mysql.ProductImpl{})
    }
    return impl
}
```

è¿™æ®µä»£ç å°†åˆ†æ•£åœ¨å„ä¸ªhandleré‡Œï¼Œç”¨if elseåˆ›å»ºç­–ç•¥å¯¹è±¡çš„é€»è¾‘ï¼Œä¸‹æ²‰åˆ°serviceå±‚çš„ç®€å•å·¥å‚æ–¹æ³•NewProductServiceã€‚è¿™ä¸ªæ–¹æ³•æ ¹æ®ä¼ å…¥çš„sceneå‚æ•°ï¼Œå†³å®šåˆ›å»ºå“ªä¸ªå…·ä½“çš„ç­–ç•¥å¯¹è±¡è¿”å›ã€‚

ç»è¿‡æˆ‘ä»¬ç”¨ç­–ç•¥æ¨¡å¼å’Œç®€å•å·¥å‚æ–¹æ³•æ¨¡å¼é‡æ„ï¼Œç°åœ¨çš„ä»£ç å·²ç»è§£å†³äº†if elseä»£ç é€»è¾‘åœ¨handlerå±‚å¤šä¸ªåœ°æ–¹é‡å¤çš„é—®é¢˜ã€‚æœªæ¥å†åŠ æ›´å¤šçš„ç­–ç•¥ç±»ï¼Œä¹Ÿåªéœ€è¦ä¿®æ”¹åˆ›å»ºç­–ç•¥ç±»çš„ç®€å•å·¥å‚æ–¹æ³•ã€‚

## å»ºé€ è€…æ¨¡å¼

è®²å®Œç­–ç•¥æ¨¡å¼å’Œç®€å•å·¥å‚æ–¹æ³•æ¨¡å¼ï¼Œè®©æˆ‘ä»¬çœ‹ä¸ªåœ¨è®¾è®¡Golang SDKæ—¶å¸¸ç”¨çš„æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯å»ºé€ è€…æ¨¡å¼å’Œå®ƒçš„å˜ç§å‡½æ•°é€‰é¡¹æ¨¡å¼ã€‚

ä¸‹é¢æ˜¯æˆ‘çš„Golang SDKé‡Œä¸€æ®µæ‹‰å–è¿œç¨‹é…ç½®çš„ä»£ç ã€‚å®ƒæœ‰ä¸€ä¸ªConfigç»“æ„ä½“å’Œä¸€ä¸ªä»è¿œç¨‹æ‹‰å–é…ç½®çš„å‡½æ•°FetchConfigByKeyã€‚ç»“æ„ä½“ç”±æœ‰ä¸€ä¸ªå¿…å¡«å‚æ•°çš„NewConfigå‡½æ•°æ„é€ ã€‚

```go
// è¿œç¨‹é…ç½®ç±»
type Config struct {
    apiKey string // é‰´æƒkey
    client *http.Client
}

func NewConfig(apiKey string) *Config {
    client := &http.Client{}
    config := &Config{apiKey: apiKey, client: client}
    return config
}

// FetchConfigByKey ä»è¿œç¨‹æ‹‰å–é…ç½®
func (c *Config) FetchConfigByKey(key string) (string, error) {
    url := fmt.Sprintf("http://example.com/config?apiKey=%s&key=%s", c.apiKey, key)
    resp, err := c.client.Get(url)
    if err != nil {
        return "", err
    }
    defer resp.Body.Close()

    body, err := io.ReadAll(resp.Body)
    if err != nil {
        return "", err
    }
    return string(body), nil
}
```

é‚£é—®é¢˜æ¥äº†ï¼Œå‡å¦‚æœªæ¥æˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ªNewConfigå‡½æ•°é‡ŒåŠ å¾ˆå¤šä¸åŒç±»å‹çš„å¯é€‰å‚æ•°ï¼ˆæ¯”å¦‚è¶…æ—¶æ—¶é—´ã€è¯·æ±‚ä¸‹æ¸¸çš„é›†ç¾¤ï¼‰ï¼Œä»¥ä¾¿è®©ä½¿ç”¨æˆ‘ä»¬SDKçš„äººï¼Œå¯ä»¥æ›´çµæ´»åœ°æ§åˆ¶FetchConfigByKeyå‡½æ•°çš„è¡Œä¸ºã€‚é‚£ä¹ˆè¯¥å¦‚ä½•è®¾è®¡æ‰èƒ½å®ç°è¿™ä¸ªç›®çš„å‘¢ï¼Ÿ

è¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥å€Ÿé‰´å»ºé€ è€…æ¨¡å¼å®ç°ã€‚å»ºé€ è€…æ¨¡å¼ä¹Ÿå«Builderæ¨¡å¼ï¼Œå®ƒçš„ä½œç”¨æ˜¯**å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚**å»ºé€ è€…æ¨¡å¼æœ‰ä¸¤ä¸ªæ ¸å¿ƒè§’è‰²ï¼Œ**ä¸€ä¸ªæ˜¯å»ºé€ è€…ï¼Œä¸€ä¸ªæ˜¯å»ºé€ è€…åˆ›å»ºçš„å¯¹è±¡**ã€‚

å»ºé€ è€…æ¨¡å¼çš„æ¦‚å¿µå¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œè®©æˆ‘ç”¨å»ºé€ è€…æ¨¡å¼é‡æ„ä¸€ä¸‹ä»£ç ï¼Œå¸®ä½ çœ‹æ¸…æ¥šæ¦‚å¿µå’Œå®è·µçš„å¯¹åº”å…³ç³»ã€‚

ä¸‹é¢ä»£ç é‡Œçš„ConfigBuilderå°±æ˜¯å»ºé€ è€…æ¨¡å¼ä¸­çš„å»ºé€ è€…è§’è‰²ï¼Œå®ƒç”±NewConfigBuilderæ„é€ å‡½æ•°æ„å»ºï¼Œæ„é€ å‡½æ•°é‡Œåªæœ‰å¿…å¡«å‚æ•°ã€‚å¯¹äºå¯é€‰å‚æ•°ï¼Œå®ƒæä¾›äº†ä¸€äº›è®¾ç½®å±æ€§çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨è¿™äº›æ–¹æ³•å³å¯è®¾ç½®å±æ€§ï¼Œç­‰è®¾ç½®å®Œå±æ€§ä¹‹åï¼Œé€šè¿‡å†è°ƒç”¨ConfigBuilderçš„Buildæ–¹æ³•æ„å»ºConfigå¯¹è±¡ã€‚

```go
// ConfigBuilderç»“æ„ä½“ç”¨äºæ„å»ºConfigç±»
type ConfigBuilder struct {
    apiKey  string // é‰´æƒkey
    client  *http.Client
    timeout int
    cluster string
}

// NewConfigBuilderåˆ›å»ºä¸€ä¸ªæ–°çš„ConfigBuilderå®ä¾‹
func NewConfigBuilder(apiKey string) *ConfigBuilder {
    return &ConfigBuilder{
        apiKey:  apiKey,
        client:  &http.Client{},
        timeout: 60,
        cluster: "default",
    }
}

// è®¾ç½®è¶…æ—¶æ—¶é—´
func (cfb *ConfigBuilder) SetTimeout(timeout int) *ConfigBuilder {
    cfb.timeout = timeout
    return cfb
}

// SetClusterè®¾ç½®è¯·æ±‚çš„ä¸‹æ¸¸é›†ç¾¤
func (cfb *ConfigBuilder) SetCluster(cluster string) *ConfigBuilder {
    cfb.cluster = cluster
    return cfb
}

// Buildæ„å»ºConfigå®ä¾‹
func (cfb *ConfigBuilder) Build() (*Config, error) {
    return &Config{
        apiKey:  cfb.apiKey,
        client:  cfb.client,
        timeout: cfb.timeout,
        cluster: cfb.cluster,
    }, nil
}
```

ä¸‹é¢æ˜¯ConfigBuilderæ„å»ºçš„Configå¯¹è±¡ï¼ŒConfigå¯¹è±¡å°±æ˜¯å»ºé€ è€…æ¨¡å¼ä¸­çš„å¤æ‚å¯¹è±¡ã€‚

```go
// Configç»“æ„ä½“ç”¨äºä»è¿œç¨‹æ‹‰å–é…ç½®
type Config struct {
    apiKey  string // é‰´æƒkey
    client  *http.Client
    timeout int
    cluster string
}

// FetchConfigæ‰§è¡Œä»è¿œç¨‹æŒ‰keyæ‹‰å–é…ç½®çš„æ“ä½œ
func (c *Config) FetchConfigByKey(key string) (string, error) {
    return "", nil
}
```

ç”¨å»ºé€ è€…æ¨¡å¼é‡æ–°å®ç°ä»è¿œç¨‹æ‹‰å–é…ç½®çš„åŠŸèƒ½åï¼ŒConfigBuilderå¯ä»¥æ‰©å±•æ›´å¤šçš„å¯é€‰å‚æ•°ï¼Œä¸ä¼šå¯¼è‡´æ„é€ å‡½æ•°å‚æ•°è¶Šæ¥è¶Šé•¿ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´å·²ç»ä½¿ç”¨æˆ‘ä»¬SDKçš„åœ°æ–¹æŠ¥é”™ã€‚

å®é™…ä¸Šï¼Œåœ¨Golangé¡¹ç›®ä¸­ç”¨å¾—æ¯”è¾ƒå¤šçš„æ˜¯ Builder æ¨¡å¼çš„ä¸€ç§å˜ç§ï¼Œå‡½æ•°é€‰é¡¹æ¨¡å¼ã€‚ç›¸æ¯” Builder æ¨¡å¼ï¼Œå‡½æ•°é€‰é¡¹æ¨¡å¼çš„ä»£ç ç»“æ„æ›´åŠ ç®€æ´ã€‚å®ƒ**ä¸éœ€è¦å®šä¹‰ä¸“é—¨çš„ Builder ç»“æ„ä½“å’Œå¤§é‡çš„è®¾ç½®æ–¹æ³•ï¼Œè€Œæ˜¯é€šè¿‡å®šä¹‰å‡½æ•°é€‰é¡¹ç±»å‹å’Œå¯¹åº”çš„å‡½æ•°é€‰é¡¹å‡½æ•°ï¼Œç›´æ¥åœ¨åˆ›å»ºå®ä¾‹æ—¶é€šè¿‡ä¼ é€’å‡½æ•°é€‰é¡¹æ¥è®¾ç½®å±æ€§**ã€‚

æˆ‘ä»¬è¿™å°±ç”¨å‡½æ•°é€‰é¡¹æ¨¡å¼å®ç°ä¸€æ®µä»£ç ï¼Œå…¶åŠŸèƒ½å’Œä¸Šé¢å»ºé€ è€…æ¨¡å¼çš„ä¾‹å­ç›¸åŒã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªOptionå‡½æ•°é€‰é¡¹ç±»å‹å’ŒWithå¼€å¤´çš„ä¸€ç³»åˆ—å‡½æ•°é€‰é¡¹å‡½æ•°ï¼Œç›´æ¥åœ¨NewConfigæ„é€ å‡½æ•°é‡Œæ ¹æ®ä¼ å…¥çš„å‡½æ•°é€‰é¡¹æ¥è®¾ç½®å±æ€§ï¼Œæ„é€ Configå¯¹è±¡ã€‚

```go
// Configç»“æ„ä½“ç”¨äºä»è¿œç¨‹HTTPæ‹‰å–é…ç½®
type Config struct {
    apiKey  string // é‰´æƒkey
    client  *http.Client
    timeout int
    cluster string
}

// Optionæ˜¯å‡½æ•°é€‰é¡¹ç±»å‹ï¼Œç”¨äºè®¾ç½®Configçš„å±æ€§
type Option func(*Config)

// WithTimeoutå‡½æ•°é€‰é¡¹ç”¨äºè®¾ç½®è¶…æ—¶æ—¶é—´
func WithTimeout(timeout int) Option {
    return func(cf *Config) {
        cf.timeout = timeout
    }
}

// WithClusterå‡½æ•°é€‰é¡¹ç”¨äºè®¾ç½®è°ƒç”¨é›†ç¾¤
func WithCluster(cluster string) Option {
    return func(cf *Config) {
        cf.cluster = cluster
    }
}

// NewConfigåˆ›å»ºä¸€ä¸ªæ–°çš„Configå®ä¾‹ï¼Œå¹¶æ ¹æ®ä¼ å…¥çš„å‡½æ•°é€‰é¡¹è¿›è¡Œè®¾ç½®
func NewConfig(apiKey string, opts ...Option) (*Config, error) {
    cf := &Config{
        apiKey:  apiKey,
        client:  &http.Client{},
        timeout: 60,
        cluster: "default",
    }

    for _, opt := range opts {
        opt(cf)
    }
    return cf, nil
}

// FetchConfigæ‰§è¡Œä»è¿œç¨‹HTTPæŒ‰æŒ‡å®šå‚æ•°æ‹‰å–é…ç½®çš„æ“ä½œ
func (c *Config) FetchConfigByKey(key string) (string, error) {
    return "", nil
}
```

## è´£ä»»é“¾æ¨¡å¼

é™¤äº†å»ºé€ è€…æ¨¡å¼ï¼Œåœ¨Golangé¡¹ç›®ä¸­ï¼Œè¿˜æœ‰ä¸ªç”±æ¡†æ¶å°è£…çš„æˆ‘ä»¬ç»å¸¸ä¼šä¸å®ƒæ‰“äº¤é“çš„è®¾è®¡æ¨¡å¼â€”â€”è´£ä»»é“¾æ¨¡å¼ã€‚

å‡å¦‚æˆ‘ä»¬æœ‰ä¸ªHandleræ–¹æ³•ï¼Œæ˜¯å¯¹HTTPè¯·æ±‚è¿›è¡Œå¤„ç†çš„ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚

```go
// å®šä¹‰å®é™…çš„ä¸šåŠ¡é€»è¾‘å¤„ç†å‡½æ•°
func Handler(w http.ResponseWriter,r *http.Request) {
    // ä¸šåŠ¡é€»è¾‘å¤„ç†
}
```

ç°åœ¨æˆ‘ä»¬æƒ³ç»™HandleråŠ ä¸ªæ¥å£å“åº”æ—¶é—´ç»Ÿè®¡åŠŸèƒ½ï¼Œä½ å¯ä»¥ç›´æ¥åœ¨Handleræ–¹æ³•å†…éƒ¨åŠ ä¸Šè¿™æ®µé€»è¾‘ã€‚

```go
// å®šä¹‰å®é™…çš„ä¸šåŠ¡é€»è¾‘å¤„ç†å‡½æ•°
func Handler(w http.ResponseWriter,r *http.Request) {
    // è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
    start := time.Now()
    defer func() { // è®¡ç®—å“åº”æ—¶é—´
        elapsed := time.Since(start) // æ‰“å°å“åº”æ—¶é—´
        log.Printf("å“åº”æ—¶é—´: %v\n", elapsed)
    }()
    fmt.Fprintf(w, "Hello, World!")
}
```

é‚£å‡å¦‚æˆ‘ä»¬æƒ³ç»™HTTPæœåŠ¡çš„æ‰€æœ‰æ¥å£åŠ ä¸Šå“åº”æ—¶é—´ç»Ÿè®¡åŠŸèƒ½å‘¢ï¼Ÿå¦‚æœç»§ç»­æŠŠè¿™æ®µé€»è¾‘æ”¾åœ¨æ¥å£çš„å®ç°é€»è¾‘é‡Œï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™æ®µä»£ç å¤åˆ¶åˆ°å„ä¸ªä¸šåŠ¡å¤„ç†å‡½æ•°ï¼Œä¼šé€ æˆå¤§é‡çš„ä»£ç é‡å¤ã€‚è€Œä¸”ï¼Œåç»­å¦‚æœéœ€è¦ç»™æ‰€æœ‰æ¥å£åŠ ä¸Šé‰´æƒç­‰æ›´å¤šåŠŸèƒ½ï¼Œæ‰€æœ‰çš„æ¥å£å®ç°å‡½æ•°åˆå¾—æ”¹ä¸€éã€‚æ€ä¹ˆæ‰èƒ½é¿å…è¿™ç§æƒ…å†µå‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥ç”¨è´£ä»»é“¾æ¨¡å¼å®ç°ç»™æ‰€æœ‰æ¥å£åŠ ä¸Šç»Ÿä¸€çš„å¤„ç†é€»è¾‘ã€‚**è´£ä»»é“¾æ¨¡å¼å…è®¸ä½ å°†è¯·æ±‚æ²¿ç€å¤„ç†è€…é“¾è¿›è¡Œå‘é€ã€‚æ”¶åˆ°è¯·æ±‚åï¼Œæ¯ä¸ªå¤„ç†è€…å‡å¯å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œæˆ–å°†å…¶ä¼ é€’ç»™é“¾ä¸Šçš„ä¸‹ä¸ªå¤„ç†è€…**ã€‚

ä¸‹é¢çš„ä»£ç æˆ‘å®šä¹‰äº†è€—æ—¶ç»Ÿè®¡å‡½æ•°CostMiddlewareå’Œé‰´æƒå‡½æ•°AuthMiddlewareï¼Œå®ƒä»¬æ¥æ”¶è¯·æ±‚å¤„ç†å‡½æ•°ç±»å‹çš„å‚æ•°nextï¼Œå¹¶ä¸”è¿”å›äº†ä¸€ä¸ªæ–°çš„è¯·æ±‚å¤„ç†å‡½æ•°ã€‚è¿™ä¸ªæ–°çš„è¯·æ±‚å¤„ç†å‡½æ•°çš„å†…éƒ¨å®ç°æ˜¯ï¼Œåœ¨è°ƒç”¨nextå‡½æ•°ä¹‹å‰ï¼Œå…ˆæ‰§è¡Œè€—æ—¶ç»Ÿè®¡å’Œé‰´æƒçš„é€»è¾‘ã€‚å°è£…è¿”å›çš„è¯·æ±‚å¤„ç†å‡½æ•°å°±æ˜¯è´£ä»»é“¾ä¸­çš„å¤„ç†è€…èŠ‚ç‚¹ã€‚

```go
// å®šä¹‰ä¸€ä¸ªå‡½æ•°ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºä¸­é—´ä»¶å‡½æ•°
type Middleware func(http.HandlerFunc) http.HandlerFunc

// æ¥å£è€—æ—¶è®°å½•ä¸­é—´ä»¶
func CostMiddleware(next http.HandlerFunc) http.HandlerFunc {
    return func(w http.ResponseWriter, r *http.Request) {
        start := time.Now()
        defer func() { // è®¡ç®—å“åº”æ—¶é—´
            elapsed := time.Since(start) // æ‰“å°å“åº”æ—¶é—´
            log.Printf("å“åº”æ—¶é—´: %v\n", elapsed)
        }()
        next(w, r)
    }
}

// æƒé™éªŒè¯ä¸­é—´ä»¶
func AuthMiddleware(next http.HandlerFunc) http.HandlerFunc {
    return func(w http.ResponseWriter, r *http.Request) {
        // è¿™é‡Œç®€å•æ¨¡æ‹Ÿæƒé™éªŒè¯ï¼Œå‡è®¾åªæœ‰ç‰¹å®šçš„ç”¨æˆ·å¯ä»¥è®¿é—®
        if r.Header.Get("Authorization") != "valid_token" {
            http.Error(w, "æƒé™ä¸è¶³", http.StatusUnauthorized)
            return
        }
        next(w, r)
    }
}

// å®šä¹‰å®é™…çš„ä¸šåŠ¡é€»è¾‘å¤„ç†å‡½æ•°
func Handler(w http.ResponseWriter, r *http.Request) {
    fmt.Fprintf(w, "Hello, World!")
}
```

å®ç°è´£ä»»é“¾ä¸­çš„å¤„ç†è€…èŠ‚ç‚¹åï¼Œæˆ‘ç”¨äº†ApplyMiddlewareæ–¹æ³•ï¼Œå°†ä¼ å…¥çš„ä¸šåŠ¡é€»è¾‘å¤„ç†å‡½æ•°å’Œè€—æ—¶ç»Ÿè®¡å‡½æ•°ã€é‰´æƒå‡½æ•°æ„é€ æˆè´£ä»»é“¾ï¼Œå¹¶å°†è´£ä»»é“¾ä½œä¸ºhttpè¯·æ±‚çš„å¤„ç†å‡½æ•°ï¼Œå°±èƒ½ç»™æ‰€æœ‰æ¥å£åŠ ä¸Šè€—æ—¶ç»Ÿè®¡å’Œæƒé™éªŒè¯åŠŸèƒ½ã€‚

```go

// åº”ç”¨ä¸­é—´ä»¶åˆ°å¤„ç†å‡½æ•°çš„å‡½æ•°
func ApplyMiddleware(middlewares []Middleware, handler http.HandlerFunc) http.HandlerFunc {
    for _, middleware := range middlewares {
        handler = middleware(handler)
    }
    return handler
}

func main() {
    // åˆ›å»ºä¸€ä¸ªHTTPæœåŠ¡å™¨
    http.HandleFunc("/", ApplyMiddleware(
        []Middleware{CostMiddleware, AuthMiddleware},
        Handler,
    ))

    // å¯åŠ¨æœåŠ¡å™¨å¹¶ç›‘å¬ç«¯å£
    log.Fatal(http.ListenAndServe(":8080", nil))
}
```

## å°ç»“

ä»Šå¤©è¿™èŠ‚è¯¾çš„å†…å®¹é‡Œï¼Œæˆ‘ä»¬ä¸€å…±å­¦ä¹ äº†1ä¸ªè®¾è®¡åŸåˆ™å’Œ4ä¸ªè®¾è®¡æ¨¡å¼ï¼Œå¹¶å¸¦ä½ ç”¨è¿™äº›è®¾è®¡åŸåˆ™å’Œæ¨¡å¼è§£å†³äº†ä¸€ä¸ªä¸ªç¼–ç çš„æ‰©å±•æ€§é—®é¢˜ã€‚ç°åœ¨è®©æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹è¿™äº›åŸåˆ™å’Œæ¨¡å¼çš„å«ä¹‰ä¸ç”¨æ³•ã€‚

![](https://static001.geekbang.org/resource/image/92/7f/923e84b23544fae2c5887f8d2a83be7f.jpg?wh=4190x2408)

å¸Œæœ›ä½ å¥½å¥½ä½“ä¼šè¿™äº›è®¾è®¡åŸåˆ™å’Œè®¾è®¡æ¨¡å¼çš„åº”ç”¨ã€‚åœ¨ä¸‹æ¬¡é‡åˆ°ç¼–ç é—®é¢˜æ—¶ï¼Œåˆ«å¿˜äº†å°è¯•è¿ç”¨è¿™äº›è®¾è®¡æ¨¡å¼ï¼Œè®©ä½ çš„ä»£ç æ›´å¥½æ‰©å±•ã€æ›´å¥½ç»´æŠ¤ã€‚

## æ€è€ƒé¢˜

é™¤äº†è¿™èŠ‚è¯¾ä»‹ç»çš„4ç§è®¾è®¡æ¨¡å¼ï¼Œä½ åœ¨Goé¡¹ç›®ä¸­è¿˜ç”¨åˆ°äº†å“ªäº›è®¾è®¡æ¨¡å¼å‘¢ï¼Ÿ

æ¬¢è¿ä½ æŠŠä½ çš„ç­”æ¡ˆåˆ†äº«åœ¨è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ1ï¼‰</strong></div><ul>
<li><span>æ ‘å¿ƒ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯¾ç¨‹ä»‹ç»çš„å‡ ç§åŸºæœ¬éƒ½ç”¨è¿‡ï¼Œå¾ˆå®ç”¨ã€‚ä½†æ˜¯å­¦åˆ°ç®€å•å·¥å‚æ¨¡å¼çš„æ—¶å€™ä¼šæœ‰ä¸€ç§æ„Ÿè§‰ï¼Œå°±è¿™ï¼Ÿä»…ä»…æ˜¯æ¥å£æŠ½è±¡ï¼Ÿå¥½åƒä¹Ÿä¸æ˜¯å¾ˆéš¾...</p>2025-01-16</li><br/>
</ul>