ä½ å¥½ï¼Œæˆ‘æ˜¯å¾é€¸ã€‚

é€šè¿‡ä¸ŠèŠ‚è¯¾çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“äº†æå‡å•æœºååçš„æ€è·¯æ˜¯å®šä½åˆ°å•æœºç“¶é¢ˆèµ„æºã€‚å¯¹äºç“¶é¢ˆèµ„æºï¼Œè¦ä¹ˆå¢åŠ èµ„æºï¼Œæ¯”å¦‚æå‡å•æœºCPUã€å†…å­˜ç­‰çš„è§„æ ¼ï¼›è¦ä¹ˆå‡å°‘å•ä¸ªè¯·æ±‚å¯¹ç“¶é¢ˆèµ„æºçš„æ¶ˆè€—ï¼Œè®©ç›¸åŒçš„èµ„æºå¯ä»¥å¤„ç†æ›´å¤šè¯·æ±‚ã€‚

å¯¹äºCPUå’Œå†…å­˜ç“¶é¢ˆï¼Œæˆ‘ä»¬ä¹Ÿä»‹ç»äº†å®¹å™¨ç±»å‹çš„ä½¿ç”¨æ–¹æ³•ï¼Œä»è€Œé™ä½CPUå’Œå†…å­˜èµ„æºæ¶ˆè€—ï¼Œæå‡å•æœºååã€‚

æœ‰äº†æ•°æ®ç±»å‹ï¼Œè‡ªç„¶å°‘ä¸äº†å¯¹æ•°æ®çš„å¤„ç†ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥èŠèŠå¯¹äºCPUå’Œå†…å­˜ç“¶é¢ˆï¼Œæœ‰å“ªäº›å¸¸ç”¨çš„é«˜æ€§èƒ½æ•°æ®å¤„ç†æŠ€å·§ã€‚åªè¦èƒ½å¤Ÿçµæ´»è¿ç”¨è¿™äº›æŠ€å·§ï¼Œæˆ‘ä»¬å°±èƒ½é™ä½å•ä¸ªè¯·æ±‚å¯¹CPUå’Œå†…å­˜èµ„æºæ¶ˆè€—ï¼Œæå‡å•æœºååã€‚

ä¸ºäº†ä¾¿äºè¯´æ˜ï¼Œæˆ‘å…ˆæ„é€ ä¸€æ®µä»£ç ï¼Œè¿™æ®µä»£ç ä¼šå¾ªç¯åšå­—ç¬¦ä¸²æ‹¼æ¥ã€æ•´å‹è½¬å­—ç¬¦ä¸²å’Œå­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡æ“ä½œã€‚æˆ‘ä»¬ä»Šå¤©ä¼šåŸºäºè¿™æ®µä»£ç çš„æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹ï¼Œå¸¦ä½ æŒæ¡è¿™äº›é«˜æ€§èƒ½æŠ€å·§ã€‚

```go
package performance

import (
    "fmt"
)

type User struct {
    Id   int
    Name string
}

// GenerateIdsRaw åŸå§‹å¾…ä¼˜åŒ–å‡½æ•°
func GenerateIdsRaw(users []*User) (string, string, []byte) {
    names := ""
    idStr := ""
    var nameByte []byte
    for index := range users {
        idStr = fmt.Sprint(users[index].Id)
        names = names + "," + users[index].Name
        nameByte = []byte(users[index].Name)
    }
    return idStr, names, nameByte
}
```

æ¥ä¸‹æ¥æ˜¯Benchmarkä»£ç ï¼Œä¹Ÿå°±æ˜¯å¯¹å‰é¢æ„é€ çš„é‚£æ®µä»£ç åšåŸºå‡†æµ‹è¯•ï¼Œè¯„ä¼°å‰é¢ä»£ç åœ¨å¤§è§„æ¨¡ç”¨æˆ·æ•°æ®å¤„ç†æ—¶çš„æ€§èƒ½ã€‚

```go
package performance

import (
    "fmt"
    "testing"
)

// åˆå§‹åŒ–æ„é€ æµ‹è¯•ç”¨ä¾‹
var users []*User

func init() {
    for i := 0; i < 1000; i++ {
        users = append(users, &User{Id: i, Name: fmt.Sprintf("user%d", i)})
    }
}

func BenchmarkGenerateIdsRaw(b *testing.B) {
    for n := 0; n < b.N; n++ {
        GenerateIdsRaw(users)
    }
}
```

åé¢è¦è®²çš„æŠ€å·§æ—¢å¯ä»¥é™ä½CPUæ¶ˆè€—ï¼Œä¹Ÿå¯ä»¥é™ä½å†…å­˜æ¶ˆè€—ã€‚ä¸ºäº†å™è¿°æ–¹ä¾¿ï¼Œæˆ‘ä»¬è¿™é‡Œä»¥é™ä½CPUæ¶ˆè€—ä¸ºä¾‹ã€‚ä½†åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¦‚æœä½ çš„èµ„æºç“¶é¢ˆæ˜¯å†…å­˜ï¼Œä¹Ÿå¯ä»¥ç”¨è¿™äº›æŠ€å·§é™ä½å†…å­˜å ç”¨ã€‚

ç°åœ¨è®©æˆ‘ä»¬åŸºäºå‰é¢çš„Benchmarkä»£ç æ¥ç”Ÿæˆå¹¶æŸ¥çœ‹ä¸€ä¸‹CPUç«ç„°å›¾ï¼Œçœ‹ä¸‹å“ªæ®µé€»è¾‘æ¶ˆè€—CPUèµ„æºæ¯”è¾ƒé«˜ï¼Œæˆ‘ä»¬å†é’ˆå¯¹æœ€æ¶ˆè€—CPUçš„ä»£ç é€»è¾‘è¿›è¡Œä¼˜åŒ–ã€‚

```shell
go test -run=none -bench=BenchmarkGenerateIdsRaw -benchtime=10s -gcflags=all=-l -cpuprofile cpu.prof
go tool pprof -http=":8081" cpu.prof
```

![](https://static001.geekbang.org/resource/image/a0/23/a0e48982f12d0328c132dd8e596bff23.jpg?wh=3814x1600 "å›¾1 åŸå§‹å‡½æ•° CPU ç«ç„°å›¾")

ä»ç«ç„°å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ¶ˆè€—CPUæœ€å¤šçš„æ˜¯runtime.concatstringså‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°æ˜¯Goè¯­è¨€ â€œ+â€ æ“ä½œç¬¦è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥çš„åº•å±‚å®ç°å‡½æ•°ã€‚

## é«˜æ€§èƒ½å­—ç¬¦ä¸²æ‹¼æ¥

é‚£è¿™ä¸ª â€œ+â€ æ“ä½œç¬¦åˆ°åº•æ˜¯æ€ä¹ˆæ‹¼æ¥å­—ç¬¦ä¸²çš„å‘¢ï¼Ÿè¿™é‡Œé¢æ˜¯ä¸æ˜¯æœ‰å•¥ä¼˜åŒ–ç©ºé—´å‘¢ï¼Ÿæƒ³è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦å…ˆå¼„æ¸…æ¥š â€œ+â€ æ“ä½œç¬¦æ‹¼æ¥å­—ç¬¦ä¸²çš„é€»è¾‘ã€‚

å½“**ç”¨ â€œ+â€ è¿æ¥ç¬¦æ‹¼æ¥ä¸¤ä¸ªå­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œå¾—å…ˆå¼€è¾Ÿä¸€å—æ–°çš„å†…å­˜ç©ºé—´æ¥å­˜æ”¾æ‹¼æ¥åçš„å­—ç¬¦ä¸²ï¼Œç„¶åæŠŠè¿™ä¸¤ä¸ªå­—ç¬¦ä¸²æŒ‰ç…§æ‹¼æ¥çš„é¡ºåºæ‹·è´åˆ°æ–°ç©ºé—´**ã€‚è¿™ä¸ªæ–°ç©ºé—´çš„å¤§å°ç­‰äºåŸæ¥ä¸¤ä¸ªå­—ç¬¦ä¸²é•¿åº¦çš„å’Œã€‚

æ¯”å¦‚å­—ç¬¦ä¸²â€œabâ€ å’Œ å­—ç¬¦ä¸²â€œcdâ€ è¦æ‹¼æ¥ï¼Œå°±å¾—å…ˆç»™ç»“æœå­—ç¬¦ä¸²æ‰¾ä¸ªåœ°æ–¹ï¼Œç„¶åæŠŠå­—ç¬¦ä¸²â€œabâ€ å’Œ â€œcdâ€ åˆ†åˆ«æ‹·è´è¿‡å»ï¼Œè¿™æ ·å°±å¾—åˆ°äº†æ–°çš„å­—ç¬¦ä¸²ã€‚

```go
s1 := "ab" + "cd"
```

![](https://static001.geekbang.org/resource/image/21/35/210c1dfaf94486225dbc39d8711c7735.jpg?wh=1212x540 "å›¾2 â€œ+â€ æ“ä½œç¬¦æ‹¼æ¥å­—ç¬¦ä¸²")

å¦‚æœæ˜¯å¾ªç¯æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œæ¯æ¬¡å¾ªç¯è¿­ä»£éƒ½è¦åˆ†é…æ–°ç©ºé—´çš„è¯ï¼Œå°±éœ€è¦**ä¸åœåœ°åœ¨å †ä¸Šåˆ†é…å†…å­˜**ã€‚è€Œä¸”æ¯æ¬¡è¿­ä»£è¿˜å¾—æŠŠæ‹¼æ¥çš„å­—ç¬¦ä¸²éƒ½æ‹·è´åˆ°ç»“æœç©ºé—´ï¼Œéœ€è¦**ä¸åœåœ°æ‹·è´**ã€‚è€Œå †å†…å­˜åˆ†é…å’Œæ‹·è´éƒ½æ˜¯æ¯”è¾ƒæ¶ˆè€—CPUçš„æ“ä½œã€‚

å› æ­¤ï¼Œè¦å‡å°‘å­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œå¯¹CPUèµ„æºçš„æ¶ˆè€—ï¼Œå°±éœ€è¦å‡å°‘å­—ç¬¦ä¸²æ‹¼æ¥çš„å†…å­˜åˆ†é…å’Œæ‹·è´ã€‚Go è¯­è¨€æœ‰æ²¡æœ‰ä»€ä¹ˆå¥½åŠæ³•å‘¢ï¼Ÿ

æœ‰ã€‚Go è¯­è¨€é‡Œæœ‰ä¸ª **strings.Builder ç±»å‹**ï¼Œè¿™ä¸ª strings.Builder ç±»å‹å¯ä»¥å‡å°‘å†…å­˜åˆ†é…å’Œæ‹·è´ï¼Œé«˜æ•ˆåœ°æ‹¼æ¥å­—ç¬¦ä¸²ã€‚

ç»™ä½ çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆç”¨çš„ï¼š

```go
package main

import (
        "fmt"
        "strings"
)

func main() {
    var b strings.Builder
    for i := 3; i >= 1; i-- {
            fmt.Fprintf(&b, "%d...", i)
    }
    b.WriteString("ignition")
    fmt.Println(b.String()) // è¾“å‡º 3...2...1...ignition
}
```

è¿™ä¸ª strings.Builder ç±»å‹æœ‰ä¸¤ä¸ªå¾ˆå‰å®³çš„åœ°æ–¹ã€‚

ç¬¬ä¸€ä¸ªæ˜¯å®ƒæœ‰**å†…å­˜é¢„åˆ†é…**çš„åŠŸèƒ½ã€‚è¿™ä¸ªç±»å‹æœ‰ä¸€ä¸ª Grow æ–¹æ³•ï¼Œå¯ä»¥æå‰æŠŠå†…å­˜åˆ†é…å¥½ï¼Œå®ç°é¢„åˆ†é…åŠŸèƒ½ã€‚è¿™æ ·æ¯æ¬¡å¾ªç¯è¿­ä»£æ—¶å°±ä¸ç”¨é‡æ–°åˆ†é…å†…å­˜ï¼Œå†…å­˜é¢‘ç¹åˆ†é…çš„é—®é¢˜å°±è§£å†³äº†ã€‚

```go
// Grow grows b's capacity, if necessary, to guarantee space for another n bytes. 
// After Grow(n), at least n bytes can be written to b without another allocation. 
func (b *Builder) Grow(n int)
```

ç¬¬äºŒä¸ªå‰å®³çš„åœ°æ–¹æ˜¯ï¼Œ**å­—ç¬¦ä¸²æ‹¼æ¥æ—¶ï¼Œå†…å­˜æ‹·è´æ¬¡æ•°æ›´å°‘**ã€‚

ä¸ºå•¥å‘¢ï¼Ÿå› ä¸º Builder åº•å±‚æ˜¯ç”¨ \[] byte ç±»å‹æ¥å­˜å­—ç¬¦ä¸²çš„ã€‚å¾€ Builder é‡Œå†™ä¸œè¥¿çš„æ—¶å€™ï¼Œåªæœ‰å®ƒçš„ buf å®¹é‡ä¸å¤Ÿã€éœ€è¦æ‰©å®¹æ—¶ï¼Œæ‰ä¼šå‘ç”Ÿå†…å­˜è¿ç§»æ‹·è´ï¼Œä¸åƒä¹‹å‰æ¯æ¬¡å¾ªç¯éƒ½å¾—æ‹·è´å­—ç¬¦ä¸²ã€‚è¦æ˜¯æå‰ç”¨ Grow æ–¹æ³•åˆ†é…å¥½è¶³å¤Ÿçš„å†…å­˜ï¼Œåœ¨å¾ªç¯æ‹¼æ¥çš„æ—¶å€™ï¼Œå°±ä¸ä¼šå‘ç”Ÿæ‰©å®¹è¿ç§»ï¼Œå¯¼è‡´æ‹·è´äº†ã€‚

```go
type Builder struct {
    buf  []byte
}

// WriteString appends the contents of s to b's buffer.
// It returns the length of s and a nil error.
func (b *Builder) WriteString(s string) (int, error) {
    b.buf = append(b.buf, s...)
    return len(s), nil
}
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬ç”¨è¿™ä¸ª strings.Builder æ¥é‡æ–°å®ç°ä¸€ä¸‹æˆ‘ä»¬çš„å‡½æ•°ï¼š

```go
// GenerateIdsBuilder ä½¿ç”¨strings.Builderæ‹¼æ¥å­—ç¬¦ä¸²
func GenerateIdsBuilder(users []*User) (string, string, []byte) {
    names := ""
    idStr := ""
    var nameByte []byte
    length := 0
    for index := range users {
        idStr = fmt.Sprint(users[index].Id)
        nameByte = []byte(users[index].Name)
        length += len(users[index].Name) + 1
    }
    var builder strings.Builder
    builder.Grow(length) // é¢„åˆ†é…
    for index := range users {
        builder.WriteString(",")
        builder.WriteString(users[index].Name)
    }
    return idStr, names, nameByte
}
```

åˆ°åº• strings.Builderç±»å‹æœ‰æ²¡æœ‰æˆ‘ä»¬è¯´çš„è¿™ä¹ˆå‰å®³å‘¢ï¼Ÿå’±ä»¬æ¥åšä¸ªæµ‹è¯•ï¼Œç”¨ Benchmark æ¥æµ‹ä¸€æµ‹ â€œ+â€ æ“ä½œç¬¦å®ç°å­—ç¬¦ä¸²æ‹¼æ¥å’Œstrings.Builderå®ç°å­—ç¬¦ä¸²æ‹¼æ¥çš„æ€§èƒ½ã€‚

ä¸‹é¢æ˜¯æˆ‘ä»¬çš„Benchmarkè„šæœ¬ï¼š

```go
package performance

import (
    "fmt"
    "testing"
)

// åˆå§‹åŒ–æ„é€ æµ‹è¯•ç”¨ä¾‹
var users []*User

func init() {
    for i := 0; i < 1000; i++ {
        users = append(users, &User{Id: i, Name: fmt.Sprintf("user%d", i)})
    }
}

func BenchmarkGenerateIdsRaw(b *testing.B) {
    for n := 0; n < b.N; n++ {
        GenerateIdsRaw(users)
    }
}

func BenchmarkGenerateIdsBuilder(b *testing.B) {
    for n := 0; n < b.N; n++ {
        GenerateIdsBuilder(users)
    }
}
```

æµ‹è¯•ç»“æœå‡ºæ¥äº†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°**ç”¨strings.Builderæ‹¼æ¥å­—ç¬¦ä¸²çš„æ–¹å¼ï¼Œæ€§èƒ½æœ‰å·¨å¤§çš„æå‡**ã€‚

```shell
killianxu@KILLIANXU-MB0 performance % go test -run=none -benchmemÂ  -bench=. -gcflags=all=-l
goos: darwin
goarch: amd64
pkg: example.com/performance
cpu: Intel(R) Core(TM) i5-7360U CPU @ 2.30GHz
BenchmarkGenerateIdsRaw-4Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  862Â  Â  Â  Â  Â  Â 1190253 ns/opÂ  4194661 B/opÂ  Â  Â  Â  3739 allocs/op
BenchmarkGenerateIdsBuilder-4Â  Â  Â  Â  Â  Â  Â  Â 6018Â  Â  Â  Â  Â  Â  167267 ns/opÂ  Â  30069 B/opÂ  Â  Â  Â  2735 allocs/op
```

- ä» CPU èµ„æºæ¶ˆè€—æ¥çœ‹ï¼Œâ€œ+â€ æ“ä½œç¬¦æ‹¼æ¥å­—ç¬¦ä¸²çš„æ–¹å¼ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦1190253nsï¼Œè€Œstrings.Builder æ‹¼æ¥æ–¹å¼åªè¦167267nsï¼ŒèŠ‚çº¦äº† 86% å·¦å³çš„ CPU èµ„æºã€‚
- ä»å†…å­˜æ¶ˆè€—æ¥çœ‹ï¼Œâ€œ+â€ æ“ä½œç¬¦æ‹¼æ¥å­—ç¬¦ä¸²çš„æ–¹å¼ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦4194661å­—èŠ‚å†…å­˜ï¼Œè€Œç”¨ strings.Builder æ‹¼æ¥å­—ç¬¦ä¸²çš„æ–¹å¼ï¼Œæ¯æ¬¡å‡½æ•°è°ƒç”¨åªè¦30069å­—èŠ‚å†…å­˜ï¼ŒèŠ‚çº¦äº† 99% å·¦å³çš„å†…å­˜èµ„æºã€‚

å…¶å®ï¼Œåœ¨Golangå®˜æ–¹æ–‡æ¡£æ³¨é‡Šä¸­ï¼Œä¹Ÿç‰¹æ„æåˆ°äº†strings.Builderã€‚

> A Builder is used to efficiently build a string usingÂ Builder.WriteÂ methods. It minimizes memory copying. The zero value is ready to use. Do not copy a non-zero Builder.

è€Œä¸”ï¼ŒGoæœ¬èº«çš„åº“å‡½æ•°ï¼Œä¹Ÿæœ‰å¾ˆå¤šæ˜¯ç”¨strings.Builderå®ç°çš„ã€‚æ¯”å¦‚æˆ‘ä»¬å¸¸ç”¨çš„strings.Joinå’Œstrings.Replaceå‡½æ•°ã€‚

```go
func Join(elems []string, sep string) string {
    n := len(sep) * (len(elems) - 1)
    for i := 0; i < len(elems); i++ {
        n += len(elems[i])
    }

    var b Builder
    b.Grow(n)
    b.WriteString(elems[0])
    for _, s := range elems[1:] {
        b.WriteString(sep)
        b.WriteString(s)
    }
    return b.String()
}

func Replace(s, old, new string, n int) string {
    if old == new || n == 0 {
        return s // avoid allocation
    }

    // Compute number of replacements.
    if m := Count(s, old); m == 0 {
        return s // avoid allocation
    } else if n < 0 || m < n {
        n = m
    }

    // Apply replacements to buffer.
    var b Builder
    b.Grow(len(s) + n*(len(new)-len(old)))
    start := 0
    for i := 0; i < n; i++ {
        j := start
        if len(old) == 0 {
            if i > 0 {
                _, wid := utf8.DecodeRuneInString(s[start:])
                j += wid
            }
        } else {
            j += Index(s[start:], old)
        }
        b.WriteString(s[start:j])
        b.WriteString(new)
        start = j + len(old)
    }
    b.WriteString(s[start:])
    return b.String()
}
```

ç°åœ¨è®©æˆ‘ä»¬å†çœ‹ä¸€ä¸‹CPUç«ç„°å›¾ï¼Œçœ‹çœ‹å°†å­—ç¬¦ä¸²æ‹¼æ¥æ–¹å¼ä¼˜åŒ–åï¼Œæˆ‘ä»¬çš„ä»£ç æ˜¯å¦è¿˜æœ‰ä¼˜åŒ–ç©ºé—´ã€‚

```shell
go test  -run=none -bench=BenchmarkGenerateIdsBuilder -benchtime=10s -gcflags=all=-l -cpuprofile cpu.prof
go tool pprof -http=":8081" cpu.prof
```

![](https://static001.geekbang.org/resource/image/cc/cc/cc79cb9813e62875bccd8c38f6a25dcc.jpg?wh=5655x1693 "å›¾3 ç”¨ strings.Builder ä¼˜åŒ–åçš„ç«ç„°å›¾")

ä»ç«ç„°å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç”¨strings.Builderä¼˜åŒ–åï¼Œæ¶ˆè€—CPUæœ€å¤šçš„å‡½æ•°å˜æˆäº†fmt.Sprintå‡½æ•°ã€‚

## é«˜æ€§èƒ½æ•´å‹è½¬å­—ç¬¦ä¸²

è¿™ä¸ªå‡½æ•°åœ¨æˆ‘ä»¬ä»£ç é‡Œçš„ä½œç”¨æ˜¯å°†æ•´å‹è½¬åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚è¿™ä¸ªfmt.Sprintå‡½æ•°ä¸ºä»€ä¹ˆä¼šæ¶ˆè€—CPUï¼Ÿè¿™é‡Œé¢æ˜¯ä¸æ˜¯ä¹Ÿæœ‰ä¼˜åŒ–ç©ºé—´å‘¢ï¼Ÿ

```go
idStr := fmt.Sprint(user.Id)
```

fmt.SprintåŠå…¶å˜ä½“å‡½æ•°ï¼Œéœ€è¦ç”¨åå°„æ¥è¯†åˆ«å®ƒä»¬æ­£åœ¨å¤„ç†çš„ç±»å‹ï¼Œç„¶åç¡®å®šå¦‚ä½•å°†å…¶æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚è€Œè¿™ä¸¤è€…éƒ½å¢åŠ äº†æ—¶é—´å’Œå†…å­˜å¼€é”€ã€‚

```go
func (p *pp) doPrint(a []any) {
    prevString := false
    for argNum, arg := range a {
        // åå°„
        isString := arg != nil && reflect.TypeOf(arg).Kind() == reflect.String
        // Add a space between two non-string arguments.
        if argNum > 0 && !isString && !prevString {
            p.buf.writeByte(' ')
        }
        // æ ¼å¼åŒ–é€»è¾‘
        p.printArg(arg, 'v')
        prevString = isString
    }
}
```

æœ‰æ²¡æœ‰å¼€é”€æ›´å°çš„æ•´å‹è½¬å­—ç¬¦ä¸²çš„æ–¹å¼å‘¢ï¼Ÿ

è¿™æ—¶å€™ä¸€ä¸ªå«strconvÂ åº“çš„ä¸œè¥¿å°±æ´¾ä¸Šç”¨åœºäº†ã€‚strconvåº“é‡Œé¢çš„å‡½æ•°æ˜¯ä¸ºç‰¹å®šçš„è½¬æ¢ä»»åŠ¡è®¾è®¡çš„ï¼Œæ‰€ä»¥å®ƒä»¬æ¯”æ›´é€šç”¨çš„Â fmtÂ å‡½æ•°æ‰§è¡Œå¾—æ›´å¿«ã€‚

è®©æˆ‘ä»¬ç”¨strconvåº“æ¥é‡æ–°å®ç°ä¸€ä¸‹æˆ‘ä»¬çš„å‡½æ•°ï¼š

```go
// GenerateIdsStrconv ä½¿ç”¨strconvå®ç°æ•´å‹è½¬å­—ç¬¦ä¸²
func GenerateIdsStrconv(users []*User) (string, string, []byte) {
    names := ""
    idStr := ""
    var nameByte []byte
    length := 0
    for index := range users {
        idStr = strconv.Itoa(users[index].Id)
        nameByte = []byte(users[index].Name)
        length += len(users[index].Name) + 1
    }
    var builder strings.Builder
    builder.Grow(length) // é¢„åˆ†é…
    for index := range users {
        builder.WriteString(",")
        builder.WriteString(users[index].Name)
    }
    return idStr, names, nameByte
}
```

strconvåº“çš„ä½¿ç”¨ï¼Œåˆèƒ½ç»™å’±ä»¬å¸¦æ¥å¤šå¤§çš„æ€§èƒ½æå‡å‘¢ï¼Ÿå’±ä»¬ç»§ç»­ç”¨Benchmarkæ¥æµ‹ä¸€æµ‹ã€‚

ä¸‹é¢æ˜¯Benchmarkè„šæœ¬ï¼š

```go
func BenchmarkGenerateIdsStrconv(b *testing.B) {
    for n := 0; n < b.N; n++ {
        GenerateIdsStrconv(users)
    }
}
```

ç„¶åä½ ä¼šå‘ç°ï¼Œ**ä½¿ç”¨strconvåº“å°†æ•´å‹è½¬æ¢ä¸ºå­—ç¬¦ä¸²çš„æ–¹å¼ï¼Œæ€§èƒ½æå‡æ˜æ˜¾ã€‚**

```shell
killianxu@KILLIANXU-MB0 performance % go test -run=none -benchmemÂ  -bench=. -gcflags=all=-lÂ 
goos: darwin
goarch: amd64
pkg: example.com/performance
cpu: Intel(R) Core(TM) i5-7360U CPU @ 2.30GHz
BenchmarkGenerateIdsBuilder-4Â  Â  Â  Â  Â  Â  Â  Â 7215Â  Â  Â  Â  Â  Â  165601 ns/opÂ  Â  Â  Â  Â 30069 B/opÂ  Â  Â  Â 2735 allocs/op
BenchmarkGenerateIdsStrconv-4Â  Â  Â  Â  Â  Â  Â  15163Â  Â  Â  Â  Â  Â  Â 79333 ns/opÂ  Â  Â  Â  Â 23392 B/opÂ  Â  Â  Â 1901 allocs/op
```

- ä» CPU èµ„æºæ¶ˆè€—æ¥çœ‹ï¼Œfmtçš„æ–¹å¼ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦165601nsï¼Œè€Œstrconvçš„æ–¹å¼ï¼Œåªè¦ 79333nsï¼ŒèŠ‚çº¦äº† 52% å·¦å³çš„ CPU èµ„æºã€‚
- ä»å†…å­˜æ¶ˆè€—æ¥çœ‹ï¼Œfmtçš„æ–¹å¼ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦30069å­—èŠ‚å†…å­˜ï¼Œè€Œstrconvçš„æ–¹å¼ï¼Œæ¯æ¬¡å‡½æ•°è°ƒç”¨åªè¦23392å­—èŠ‚å†…å­˜ï¼ŒèŠ‚çº¦äº† 22% å·¦å³çš„å†…å­˜èµ„æºã€‚

ç°åœ¨è®©æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹ç«ç„°å›¾ï¼Œçœ‹çœ‹å°†æ•´å‹è½¬åŒ–ä¸ºå­—ç¬¦ä¸²çš„æ–¹å¼æ”¹ä¸ºstrconvåº“åï¼Œæˆ‘ä»¬çš„ä»£ç æ˜¯å¦è¿˜æœ‰ä¼˜åŒ–ç©ºé—´ã€‚

```shell
go test  -run=none -bench=GenerateIdsStrconv -benchtime=10s -gcflags=all=-l -cpuprofile cpu.prof
go tool pprof -http=":8081" cpu.prof
```

![](https://static001.geekbang.org/resource/image/1b/96/1bce63a310977cf52b070bef2106e696.jpg?wh=3761x1213 "å›¾4 ç”¨ strconv åº“ä¼˜åŒ–åçš„ç«ç„°å›¾")

ä»ç«ç„°å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç”¨strconvåº“ä¼˜åŒ–åï¼Œé™¤äº†å·²ç»ä¼˜åŒ–è¿‡çš„å­—ç¬¦ä¸²æ‹¼æ¥å’Œæ•´å‹è½¬å­—ç¬¦ä¸²æ“ä½œï¼Œè¿˜æœ‰ä¸ªruntime.stringtoslicebyteå‡½æ•°æ¶ˆè€—CPUèµ„æºä¹Ÿæ¯”è¾ƒå¤šã€‚

## é«˜æ€§èƒ½å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡

è¿™ä¸ªå‡½æ•°å…¶å®å°±æ˜¯æˆ‘ä»¬çš„å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡æ“ä½œã€‚runtime.stringtoslicebyteå‡½æ•°æ˜¯æ€ä¹ˆå®ç°å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡çš„å‘¢ï¼Ÿè¿™é‡Œé¢æ˜¯ä¸æ˜¯ä¹Ÿæœ‰ä¼˜åŒ–ç©ºé—´å‘¢ï¼Ÿ

```shell
nameByte = []byte(users[index].Name)
```

åœ¨ææ˜ç™½runtime.stringtoslicebyteå‡½æ•°çš„å®ç°é€»è¾‘ä¹‹å‰ï¼Œå’±ä»¬å…ˆçœ‹çœ‹å­—ç¬¦ä¸²å’Œåˆ‡ç‰‡çš„æ•°æ®ç»“æ„ã€‚

**å­—ç¬¦ä¸²åœ¨Golangåº•å±‚å¯¹åº”çš„æ˜¯ stringStruct ç»“æ„ï¼Œè¿™ä¸ªç»“æ„é‡Œæœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼Œstr æŒ‡é’ˆå’Œlenï¼ŒstræŒ‡é’ˆæŒ‡å‘å­—ç¬¦ä¸²çš„å†…å®¹ï¼Œlen å­˜å‚¨å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚**

**åˆ‡ç‰‡å¯¹åº”çš„æ˜¯ slice ç»“æ„ï¼Œè¿™ä¸ªç»“æ„é‡Œæœ‰ä¸‰ä¸ªæˆå‘˜å˜é‡ï¼Œarrayã€len å’Œ capã€‚array æ˜¯æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæ•°ç»„é‡Œé¢å­˜çš„å°±æ˜¯åˆ‡ç‰‡å†…å®¹ï¼Œlen è¡¨ç¤ºåˆ‡ç‰‡çš„é•¿åº¦ï¼Œcap è¡¨ç¤ºåˆ‡ç‰‡çš„å®¹é‡ã€‚**

```go
// å­—ç¬¦ä¸²æ•°æ®ç»“æ„
type stringStruct struct {
    str unsafe.Pointer //æŒ‡é’ˆç±»å‹ï¼ŒæŒ‡å‘å­—èŠ‚æ•°ç»„
    len int
}

// åˆ‡ç‰‡æ•°æ®ç»“æ„
type slice struct {
    array unsafe.Pointer // æ•°ç»„æŒ‡é’ˆç±»å‹ï¼ŒæŒ‡å‘æ•°æ®æ•°ç»„
    len   int
    cap   int
}
```

å›åˆ°å‰é¢çš„é—®é¢˜ï¼Œruntime.stringtoslicebyteå‡½æ•°æ˜¯æ€ä¹ˆå®ç°å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡çš„å‘¢ï¼Ÿè¿™é‡Œé¢æœ‰ä¸‰ä¸ªæ­¥éª¤ã€‚

- ç¬¬ä¸€æ­¥ï¼Œæ ¹æ®å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œä¸ºå­—èŠ‚æ•°ç»„ç”³è¯·å†…å­˜ã€‚
- ç¬¬äºŒæ­¥ï¼Œæ„å»ºå­—èŠ‚åˆ‡ç‰‡å¯¹è±¡ï¼Œè®¾ç½®sliceç»“æ„çš„æˆå‘˜å˜é‡ã€‚
- ç¬¬ä¸‰æ­¥ï¼ŒæŠŠå­—ç¬¦ä¸²çš„å†…å®¹æ‹·è´åˆ°å­—èŠ‚åˆ‡ç‰‡çš„åº•å±‚æ•°ç»„é‡Œã€‚

è¿™ä¸ªå‡½æ•°çš„å…·ä½“å®ç°é€»è¾‘å¦‚ä¸‹ï¼š

```go
func stringtoslicebyte(s string) []byte {
    var b []byte
    // åˆ†é…å†…å­˜ï¼Œæ„å»ºå­—èŠ‚åˆ‡ç‰‡å¯¹è±¡
    b := rawbyteslice(len(s))
    // å­—ç¬¦ä¸²æ‹·è´åˆ°å­—èŠ‚åˆ‡ç‰‡çš„arrayæ•°ç»„
    copy(b, s)
    return b
}
// rawbyteslice allocates a new byte slice. The byte slice is not zeroed.
func rawbyteslice(size int) (b []byte) {
    cap := roundupsize(uintptr(size))
    // åˆ†é…å†…å­˜
    p := mallocgc(cap, nil, false)
    *(*slice)(unsafe.Pointer(&b)) = slice{p, size, int(cap)}
    return
}
```

å¯ä»¥çœ‹å‡º**ï¼Œå½“å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡æ—¶ï¼Œä¼šå‘ç”Ÿåº•å±‚å­—èŠ‚æ•°ç»„ç©ºé—´çš„å†…å­˜ç”³è¯·å’Œæ‹·è´ã€‚è€Œä¸”éšç€å­—ç¬¦ä¸²é•¿åº¦å˜é•¿ï¼Œå†…å­˜æ‹·è´çš„æ€§èƒ½æŸè€—ä¹Ÿä¼šå˜å¤§**ã€‚

æœ‰æ²¡æœ‰ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥ä¸ç”¨ç”³è¯·å­—èŠ‚æ•°ç»„å†…å­˜å’Œåšå†…å­˜æ‹·è´ï¼Œå®ç°é«˜æ€§èƒ½è½¬æ¢å‘¢ï¼Ÿ

åœ¨è¯´è¿™ä¸ªæ–¹æ³•ä¹‹å‰ï¼Œå’±ä»¬å…ˆäº†è§£ä¸€äº›å‰ç½®çŸ¥è¯†ï¼Œunsafe åŒ…å’Œ Go è¯­è¨€é‡Œå‡ ä¸ªç±»å‹çš„å¤§å°ã€‚

**unsafe åŒ…å¯ä»¥åšä¸€äº›ç»•è¿‡ Go ç±»å‹å®‰å…¨æ£€æŸ¥çš„æ“ä½œï¼Œæ›´çµæ´»åœ°æ“ä½œå†…å­˜ã€‚**å®ƒæœ‰ä¸¤ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½ã€‚

**ç¬¬ä¸€ä¸ªæ˜¯å®šä¹‰äº† Pointer ç±»å‹ï¼Œä»»ä½•ç±»å‹çš„æŒ‡é’ˆéƒ½èƒ½å’Œè¿™ä¸ª Pointer äº’ç›¸è½¬æ¢**ï¼Œæœ‰ç‚¹åƒ C è¯­è¨€é‡Œçš„ä¸‡èƒ½æŒ‡é’ˆvoid\*ã€‚

```go
var a int = 1
p := unsafe.Pointer(&a) // å…¶å®ƒç±»å‹æŒ‡é’ˆè½¬Pointer
b := (*int)(p) // Pointerç±»å‹è½¬å…¶å®ƒç±»å‹æŒ‡é’ˆ
fmt.Println(*b) // è¾“å‡º1
```

**ç¬¬äºŒä¸ªåŠŸèƒ½æ˜¯å®šä¹‰äº† uintptr ç±»å‹ï¼ŒPointer å’Œ uintptr å¯ä»¥äº’ç›¸è½¬æ¢**ï¼Œè¿™æ ·å°±èƒ½åšæŒ‡é’ˆçš„åŠ å‡ç­‰ç®—æœ¯è¿ç®—äº†ã€‚

```go
type Person struct {
    age int
    name string
}
person := Person{age:18,name:"kå“¥"}
p := unsafe.Pointer(&person) // å…¶å®ƒç±»å‹æŒ‡é’ˆè½¬Pointer
u := uintptr(p) // Pointerç±»å‹è½¬ä¸ºuintptr
u=u+8 // uintptråŠ å‡æ“ä½œ
pName := unsafe.Pointer(u) // uintptrè½¬æ¢ä¸ºPointer
name := *(*string)(pName)
fmt.Println(name) // è¾“å‡ºkå“¥
```

**åœ¨ Go è¯­è¨€é‡Œï¼Œintã€uintptrã€unsafe.Pointer è¿™ä¸‰ä¸ªç±»å‹æ‰€å çš„å¤§å°æ˜¯ç›¸ç­‰çš„ï¼Œ32 ä½æœºå™¨ä¸Šæ˜¯ 4 å­—èŠ‚ï¼Œ64 ä½æœºå™¨ä¸Šæ˜¯ 8 å­—èŠ‚ã€‚**

å’±ä»¬å¯ä»¥å†™ä¸ªå°æµ‹è¯•æ¥çœ‹çœ‹ï¼š

```go
func TestSize(t *testing.T) {
    var i int
    var u uintptr
    var p unsafe.Pointer
    fmt.Printf("int size: %d byte\n", unsafe.Sizeof(i))
    fmt.Printf("uintptr size: %d byte\n", unsafe.Sizeof(u))
    fmt.Printf("unsafe.Pointer size: %d byte\n", unsafe.Sizeof(p))
}
```

è¿è¡Œè¿™ä¸ªæµ‹è¯•å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°intã€uintptrå’Œunsafe.Pointeréƒ½æ˜¯å äº†8å­—èŠ‚ã€‚

```shell
=== RUN   TestSize
int size: 8 byte
uintptr size: 8 byte
unsafe.Pointer size: 8 byte
```

æœ‰äº†è¿™äº›åŠŸèƒ½ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨ unsafe åŒ…å’Œè¿™å‡ ä¸ªç±»å‹å¤§å°ç›¸ç­‰çš„ç‰¹æ€§ï¼Œé‡æ–°è§£é‡Šåº•å±‚çš„æ•°æ®ç»“æ„ï¼Œé¿å…å­—èŠ‚æ•°ç»„çš„å†…å­˜åˆ†é…å’Œæ‹·è´ï¼Œå®ç°é«˜æ€§èƒ½ç±»å‹è½¬æ¢ã€‚

è®©æˆ‘ä»¬ç”¨unsafeåŒ…å®ç°ä¸€ä¸ªå­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡çš„å‡½æ•°ã€‚

- ç¬¬ä¸€æ­¥ï¼Œå¯ä»¥æŠŠå­—ç¬¦ä¸²å¯¹è±¡æƒ³è±¡æˆä¸€ä¸ªé•¿åº¦ä¸º 2 çš„ uintptr ç±»å‹æ•°ç»„ xï¼Œè¿™ä¸ªæ•°ç»„çš„ 0 å·ä½ç½®å…¶å®å°±æ˜¯å­—ç¬¦ä¸²çš„ str æˆå‘˜å˜é‡ï¼Œ1 å·ä½ç½®å°±æ˜¯å­—ç¬¦ä¸²çš„ len æˆå‘˜å˜é‡ã€‚
- ç¬¬äºŒæ­¥ï¼Œæ„é€ ä¸€ä¸ªé•¿åº¦ä¸º 3 çš„ uintptr ç±»å‹æ•°ç»„ bï¼Œ0 å·ä½ç½®ä»£è¡¨å­—èŠ‚æ•°ç»„æŒ‡é’ˆï¼Œ1 å·ä½ç½®ä»£è¡¨å­—èŠ‚åˆ‡ç‰‡é•¿åº¦ï¼Œ2 å·ä½ç½®ä»£è¡¨å­—èŠ‚åˆ‡ç‰‡å®¹é‡ã€‚
- ç¬¬ä¸‰æ­¥ï¼ŒæŠŠè¿™ä¸ª uintptr ç±»å‹æ•°ç»„é‡æ–°è§£é‡Šæˆå­—èŠ‚åˆ‡ç‰‡ã€‚

```go
func Str2Bytes(s string) []byte {
    x := (*[2]uintptr)(unsafe.Pointer(&s))
    b := [3]uintptr{x[0], x[1], x[1]}
    res := *(*[]byte)(unsafe.Pointer(&b))
    return res
}
```

![](https://static001.geekbang.org/resource/image/38/60/38d75690338afaf1e57d9275a4eb3a60.jpg?wh=2703x1358 "å›¾5 unsafe åŒ…å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡")

è®©æˆ‘ä»¬ç”¨unsafeåŒ…æ¥é‡æ–°å®ç°ä¸€ä¸‹æˆ‘ä»¬çš„å‡½æ•°ï¼š

```go
func GenerateIdsUnsafe(users []*User) (string, string, []byte) {
    names := ""
    idStr := ""
    var nameByte []byte
    length := 0
    for index := range users {
        idStr = strconv.Itoa(users[index].Id)
        // unsafeåŒ…å®ç°å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡
        nameByte = Str2Bytes(users[index].Name)
        length += len(users[index].Name) + 1
    }
    var builder strings.Builder
    builder.Grow(length) // é¢„åˆ†é…
    for index := range users {
        builder.WriteString(",")
        builder.WriteString(users[index].Name)
    }
    return idStr, names, nameByte
}
```

ä½¿ç”¨unsafeåŒ…å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡ï¼Œåˆèƒ½ç»™å’±ä»¬å¸¦æ¥å¤šå¤§çš„æ€§èƒ½æå‡å‘¢ï¼Ÿå’±ä»¬ç”¨ Benchmark æ¥æµ‹ä¸€æµ‹ã€‚ä¸‹é¢æ˜¯Benchmarkè„šæœ¬ï¼š

```go
func BenchmarkGenerateIdsUnsafe(b *testing.B) {
    for n := 0; n < b.N; n++ {
        GenerateIdsUnsafe(users)
    }
}
```

æœç„¶ï¼Œä½¿ç”¨ **unsafeåŒ…å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡çš„æ–¹å¼ï¼Œæ€§èƒ½æå‡éå¸¸æ˜æ˜¾ã€‚**

```shell
killianxu@KILLIANXU-MB0 performance % go test -run=none -benchmemÂ  -bench=. -gcflags=all=-l
goos: darwin
goarch: amd64
pkg: example.com/performance
cpu: Intel(R) Core(TM) i5-7360U CPU @ 2.30GHz
BenchmarkGenerateIdsStrconv-4Â  Â  Â  Â  Â  Â  Â  14966Â  Â  Â  Â  Â  Â  Â 78975 ns/opÂ  Â  23392 B/opÂ  Â  Â  Â  1901 allocs/op
BenchmarkGenerateIdsUnsafe-4Â  Â  Â  Â  Â  Â  Â  Â 26529Â  Â  Â  Â  Â  Â  Â 44976 ns/opÂ  Â  11072 B/opÂ  Â  Â  Â  Â 901 allocs/op
```

- ä» CPU èµ„æºæ¶ˆè€—æ¥çœ‹ï¼Œruntime.stringtoslicebyteçš„æ–¹å¼ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦78975nsï¼Œè€ŒunsafeåŒ…çš„æ–¹å¼ï¼Œåªè¦44976nsï¼ŒèŠ‚çº¦äº† 43% å·¦å³çš„ CPU èµ„æºã€‚
- ä»å†…å­˜æ¶ˆè€—æ¥çœ‹ï¼Œruntime.stringtoslicebyteçš„æ–¹å¼ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦23392å­—èŠ‚å†…å­˜ï¼Œè€ŒunsafeåŒ…çš„æ–¹å¼ï¼Œæ¯æ¬¡å‡½æ•°è°ƒç”¨åªè¦11072å­—èŠ‚å†…å­˜ï¼ŒèŠ‚çº¦äº† 52.7% å·¦å³çš„å†…å­˜èµ„æºã€‚

å®é™…ä¸Šï¼ŒunsafeåŒ…é™¤äº†å¯ä»¥é«˜æ•ˆåœ°å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚åˆ‡ç‰‡ï¼Œä¹Ÿå¯ä»¥é«˜æ•ˆåœ°å°†å­—èŠ‚åˆ‡ç‰‡è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚

```go
func Bytes2Str(b []byte) string {
    return *(*string)(unsafe.Pointer(&b))
}
```

å…¶å®ç”¨unsafeåŒ…å°†å­—èŠ‚åˆ‡ç‰‡è½¬æ¢ä¸ºå­—ç¬¦ä¸²çš„æ“ä½œï¼Œåœ¨Golangåº“é‡Œä¹Ÿå¾ˆå¸¸è§ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨å‰é¢ä»‹ç»çš„é«˜æ€§èƒ½å­—ç¬¦ä¸²æ‹¼æ¥ï¼ŒBuilderç±»å‹æœ€åè½¬åŒ–ä¸ºå­—ç¬¦ä¸²çš„æºç ï¼Œå°±æ˜¯ç”¨unsafeåŒ…å®ç°çš„ã€‚

```go
// String returns the accumulated string.
func (b *Builder) String() string {
    return *(*string)(unsafe.Pointer(&b.buf))
}
```

è®©æˆ‘ä»¬ç”¨ç«ç„°å›¾å†çœ‹çœ‹æˆ‘ä»¬çš„å‡½æ•°æ˜¯å¦è¿˜æœ‰ä¼˜åŒ–ç©ºé—´ã€‚

```go
go test  -run=none -bench=BenchmarkGenerateIdsUnsafe -benchtime=10s -gcflags=all=-l -cpuprofile cpu.prof
go tool pprof -http=":8081" cpu.prof
```

![](https://static001.geekbang.org/resource/image/e2/e5/e27f9f3d73702f46099ee110e20163e5.jpg?wh=3775x1339 "å›¾6 ç”¨ unsafe åŒ…ä¼˜åŒ–åçš„ç«ç„°å›¾")

ä»ç«ç„°å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼Œç»è¿‡å‰é¢å‡ æ¬¡çš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬çš„å‡½æ•°æœ€è€—æ—¶çš„æ“ä½œå°±åªå‰©ä¸‹å·²ç»ä¼˜åŒ–è¿‡ä¹‹åçš„å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡ã€æ•´å‹è½¬å­—ç¬¦ä¸²å’Œå­—ç¬¦ä¸²æ‹¼æ¥è¿™3ä¸ªæ“ä½œï¼Œå› æ­¤æ²¡æœ‰è¿›ä¸€æ­¥ä¼˜åŒ–çš„ç©ºé—´äº†ã€‚

è®©æˆ‘ä»¬æ¥å’Œæœ€åˆå®ç°çš„å‡½æ•°é€»è¾‘å¯¹æ¯”ä¸‹ï¼Œçœ‹ä¸‹ç»è¿‡å‰é¢å‡ æ¬¡çš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬çš„æ€§èƒ½æ€»ä½“æå‡äº†å¤šå°‘ã€‚

```go
killianxu@KILLIANXU-MB0 performance % go test -run=none -benchmemÂ  -bench=. -gcflags=all=-lÂ 
goos: darwin
goarch: amd64
pkg: example.com/performance
cpu: Intel(R) Core(TM) i5-7360U CPU @ 2.30GHz
BenchmarkGenerateIdsRaw-4Â  Â  Â  Â  Â  Â  951Â  Â  Â  Â  Â  Â 1226580 ns/opÂ  Â  Â  Â  Â 4194656 B/opÂ  Â  Â  Â 3739 allocs/op
BenchmarkGenerateIdsUnsafe-4Â  Â  Â  Â 26372Â  Â  Â  Â  Â  Â  Â 45221 ns/opÂ  Â  Â  Â  Â  Â 11072 B/opÂ  Â  Â  Â  901 allocs/op
```

ä»Benchmarkæµ‹è¯•ï¼Œå¯ä»¥çœ‹å‡ºæ¥ï¼Œæˆ‘ä»¬å¯¹CPUèµ„æºçš„æ¶ˆè€—é™ä½äº†27å€ï¼Œå¯¹å†…å­˜çš„æ¶ˆè€—é™ä½äº†379å€ã€‚

## å°ç»“

ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¥ä¸€æ®µå¾…ä¼˜åŒ–çš„å‡½æ•°ä»£ç ä¸ºä¾‹ï¼Œåœ¨é€æ­¥ä¼˜åŒ–å…¶å¯¹CPUèµ„æºçš„æ¶ˆè€—è¿‡ç¨‹ä¸­ï¼Œå‘ä½ å±•ç¤ºäº†èƒ½é™ä½CPUå’Œå†…å­˜èµ„æºæ¶ˆè€—çš„3ä¸ªé«˜æ€§èƒ½æ•°æ®å¤„ç†æŠ€å·§ã€‚

- é«˜æ€§èƒ½å­—ç¬¦ä¸²æ‹¼æ¥æŠ€å·§ã€‚å½“æˆ‘ä»¬ä»£ç æœ‰å¤§é‡å­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ **strings.Builder** ç±»å‹ï¼Œå¹¶åˆ©ç”¨å®ƒçš„å†…å­˜é¢„åˆ†é…åŠŸèƒ½åšå­—ç¬¦ä¸²æ‹¼æ¥ã€‚
- é«˜æ€§èƒ½æ•´å‹è½¬å­—ç¬¦ä¸²æŠ€å·§ã€‚å½“æˆ‘ä»¬ä»£ç æœ‰å¤§é‡æ•´å‹è½¬å­—ç¬¦ä¸²æ“ä½œæ—¶ï¼Œå¯ä»¥ç”¨ **strconv** åº“åšè½¬æ¢ï¼Œé¿å…ä½¿ç”¨fmt.Sprintå‡½æ•°çš„åå°„å’Œæ ¼å¼åŒ–èµ„æºæ¶ˆè€—ã€‚
- é«˜æ€§èƒ½å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡æŠ€å·§ã€‚å½“æˆ‘ä»¬ä»£ç æœ‰å¤§é‡å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡æ“ä½œæ—¶ï¼Œå¯ä»¥ç”¨ **unsafe** åŒ…ï¼Œé€šè¿‡å­—ç¬¦ä¸²å’Œå­—èŠ‚åˆ‡ç‰‡åº•å±‚æ•°ç»„ç©ºé—´å…±ç”¨ï¼Œå®ç°é«˜æ€§èƒ½è½¬æ¢ã€‚å¹¶ä¸”ï¼Œä¹Ÿå¯ä»¥ç”¨unsafeåŒ…å°†å­—èŠ‚åˆ‡ç‰‡è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚

å¸Œæœ›ä½ å¥½å¥½ä½“ä¼šè¿™ä¸ªç”¨ç«ç„°å›¾å¯»æ‰¾ç“¶é¢ˆï¼Œå†ç»“åˆGoè¯­è¨€åº•å±‚å®ç°åˆ†æå¯»æ‰¾æ›´ä¼˜æ–¹æ¡ˆçš„è¿‡ç¨‹ã€‚åœ¨é‡åˆ°å†…å­˜å’ŒCPUç“¶é¢ˆæ—¶ï¼Œåˆ«å¿˜äº†å°è¯•è¿ç”¨è¿™äº›é«˜æ€§èƒ½æ“ä½œæŠ€å·§ï¼Œå¸®ä½ èŠ‚çº¦æ›´å¤šCPUå’Œå†…å­˜èµ„æºï¼Œæå‡å•æœºååã€‚

## æ€è€ƒé¢˜

é™¤äº†è¿™èŠ‚è¯¾é‡Œæåˆ°çš„3ç§é«˜æ€§èƒ½æ•°æ®å¤„ç†æŠ€å·§ï¼Œä½ è¿˜çŸ¥é“å“ªäº›é«˜æ€§èƒ½æ•°æ®å¤„ç†æŠ€å·§å‘¢ï¼Ÿ

æ¬¢è¿ä½ æŠŠä½ çš„ç­”æ¡ˆåˆ†äº«åœ¨è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ3ï¼‰</strong></div><ul>
<li><span>lJ</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<p>1. ä½¿ç”¨æ ‡å‡†åº“çš„ encoding&#47;json ç¼–è§£ç æ€§èƒ½è¾ƒä½ï¼Œæ¨èä½¿ç”¨github.com&#47;json-iterator&#47;goã€‚
2. ä½¿ç”¨ io.Reader å’Œ io.Writer è¿›è¡Œæµå¼ä¼ è¾“ï¼Œio.Copy æ–¹æ³•æ˜¯ä¸€ä¸ªé«˜æ•ˆå®ç°çš„æ‹·è´å·¥å…·ï¼Œå¯ä»¥åœ¨ä¸¤ä¸ªæµä¹‹é—´ä¼ è¾“æ•°æ®ã€‚æ¯”å¦‚ï¼Œå¦‚æœ src å®ç°äº† WriterTo æ¥å£ï¼ˆå¦‚ TCPConnï¼‰ï¼Œä¼šç›´æ¥è°ƒç”¨ src.WriteTo(dst)ã€‚è¿™é¿å…äº† io.Copy æ‰‹åŠ¨åˆ†é…ç¼“å†²åŒºå¹¶å¾ªç¯è¯»å–&#47;å†™å…¥çš„è¿‡ç¨‹ï¼Œå°†é«˜æ•ˆä¼ è¾“çš„è´£ä»»äº¤ç»™åº•å±‚ç±»å‹çš„å®ç°ã€‚ä¼˜å…ˆå°è¯•è°ƒç”¨å†…æ ¸çš„ splice ç³»ç»Ÿè°ƒç”¨ï¼Œé¿å…æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´å†æ‹·è´å›å†…æ ¸ç©ºé—´çš„å¼€é”€ã€‚å¦‚æœ spliceTo æ— æ³•å¤„ç†ï¼Œåˆ™å›é€€åˆ°é€šç”¨çš„æ‹·è´é€»è¾‘ genericWriteToã€‚</p>2024-12-18</li><br/><li><span>Jayleonc</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä½†æ˜¯ä¸è¿‡ç”¨unsafeå°±è¿åäº†å­—ç¬¦ä¸²çš„åªè¯»ç‰¹æ€§ï¼Œä½¿ç”¨ä¸å½“æœ‰å¯èƒ½å¯¼è‡´ç¨‹åºå¼‚å¸¸</p>2025-01-13</li><br/><li><span>jxs1211</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¿™ç§å†™æ³•å¯ä»¥å—ï¼Œbenchmarkæµ‹ä¸‹æ¥æ„Ÿè§‰å·®ä¸å¤š
func Str2Bytes(s string) []byte {
	return *(*[]byte)(unsafe.Pointer(&amp;s))
}</p>2024-12-19</li><br/>
</ul>