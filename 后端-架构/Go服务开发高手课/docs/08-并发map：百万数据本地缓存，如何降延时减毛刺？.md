ä½ å¥½ï¼Œæˆ‘æ˜¯å¾é€¸ã€‚

åœ¨ä¸ŠèŠ‚è¯¾çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†é”å’Œæ— é”ç¼–ç¨‹æŠ€æœ¯ï¼Œè¿˜ä½¿ç”¨åˆ†æ®µé”å’Œmapç±»å‹ï¼Œå®ç°äº†ä¸€ä¸ªç¼“å­˜ç»“æ„ã€‚ä¸è¿‡ï¼Œå€¼å¾—ç•™æ„çš„æ˜¯ï¼Œå…¶å® Go è¯­è¨€çš„ sync åŒ…å·²ç»æä¾›äº†ä¸€ç§å¹¶å‘å®‰å…¨çš„ Map ç±»å‹ã€‚

ä»Šå¤©ï¼Œæˆ‘å°±ä»¥å¤§è§„æ¨¡æ•°æ®ç¼“å­˜çš„æ•°æ®ç»“æ„è®¾è®¡è¦ç‚¹ä¸ºä¾‹ï¼Œå¸¦ä½ æŒæ¡sync.Mapç±»å‹ä»¥åŠé’ˆå¯¹mapçš„GCä¼˜åŒ–æŠ€å·§ã€‚

å‡å¦‚æˆ‘ä»¬ç°åœ¨éœ€è¦å®ç°ä¸€ä¸ªkey-valueç±»å‹çš„æœ¬åœ°ç¼“å­˜ï¼Œä¸”ç¼“å­˜çš„keyç‰¹åˆ«å¤šï¼Œè¾¾åˆ°ç™¾ä¸‡ç”šè‡³åƒä¸‡çº§åˆ«ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥æ€ä¹ˆè®¾è®¡ï¼Œæ‰èƒ½åœ¨å¹¶å‘ç¯å¢ƒä¸‹é«˜æ€§èƒ½ã€å®‰å…¨åœ°è®¿é—®è¿™ä¸ªç¼“å­˜å‘¢ï¼Ÿ

é’ˆå¯¹å¤§è§„æ¨¡æ•°æ®ç¼“å­˜çš„åœºæ™¯ï¼Œæˆ‘ä»¬åœ¨æ•°æ®ç»“æ„è®¾è®¡ä¸Šè¦è€ƒè™‘çš„æŠ€æœ¯ç‚¹æœ‰ä¸¤ä¸ªã€‚

1. å¦‚ä½•å®ç°å¹¶å‘å®‰å…¨çš„mapç±»å‹ã€‚
2. å¦‚ä½•å‡å°‘ç”šè‡³é¿å…å› å¤§è§„æ¨¡æ•°æ®ç¼“å­˜å¯¼è‡´çš„GCå¼€é”€ã€‚

## å¹¶å‘mapé€‰æ‹©

å®é™…ä¸Šï¼Œå¤§è§„æ¨¡ä¸”æœ‰è¯»å†™æ“ä½œçš„æ•°æ®ç¼“å­˜ï¼Œå’±ä»¬å¯ä»¥è€ƒè™‘çš„mapç±»å‹æœ‰ä¸¤ç§ï¼Œä¸€ä¸ªæ˜¯åˆ†æ®µé”å®ç°çš„mapç±»å‹ï¼Œå¦ä¸€ä¸ªæ˜¯syncåŒ…æä¾›çš„Mapç±»å‹ã€‚

é‚£ä¹ˆæˆ‘ä»¬åˆ°åº•è¯¥é€‰æ‹©å“ªä¸ªå‘¢ï¼Ÿ

åœ¨é€‰å‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæŒæ¡sync.Mapç±»å‹çš„åŸºç¡€çŸ¥è¯†å’ŒåŸç†ã€‚

sync.Mapæ˜¯ Go è¯­è¨€syncåŒ…ä¸­æä¾›çš„ä¸€ä¸ªå†…ç½®çš„å¹¶å‘å®‰å…¨çš„mapç±»å‹ã€‚å®ƒåœ¨è®¾è®¡ä¸Šè€ƒè™‘äº†é«˜å¹¶å‘åœºæ™¯ï¼Œå°½é‡é¿å…åŠ é”æ“ä½œä»è€Œæå‡è¯»å†™æ€§èƒ½ã€‚

sync.Mapè¯¥å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿä¸‹é¢æˆ‘ç»™äº†ä¸€æ®µç®€å•çš„ä»£ç ï¼Œè¿™æ®µä»£ç ä½¿ç”¨äº†sync.Mapæä¾›çš„Storeã€Loadå’ŒDeleteæ–¹æ³•ï¼Œåˆ†åˆ«ç”¨äºå†™ã€è¯»å’Œåˆ é™¤æ“ä½œã€‚

```go
package main

import (
    "fmt"
    "sync"
)

func main() {
    var m sync.Map
    m.Store("key1", "value1")
    m.Store("key2", 2)
    value, ok := m.Load("key1")
    if ok {
        fmt.Println("Value:", value)
    }
    m.Delete("key1")
    value, ok = m.Load("key1")
    if ok {
        fmt.Println("Value:", value)
    } else {
        fmt.Println("Key not found")
    }
}
```

sync.Mapæ˜¯å¦‚ä½•å®ç°å¹¶å‘é«˜æ€§èƒ½æ“ä½œçš„å‘¢ï¼Ÿ

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹sync.Mapçš„åº•å±‚æ•°æ®ç»“æ„ï¼Œå®ƒçš„æ ¸å¿ƒæ˜¯readå’Œdirtyä¸¤ä¸ªmapç»“æ„ã€‚readå­˜å‚¨äº†éƒ¨åˆ†å†™å…¥Mapçš„å†…å®¹ï¼Œç”¨æ¥åŠ é€Ÿè¯»æ“ä½œã€‚è€Œdirtyå­˜å‚¨äº†å…¨é‡å†…å®¹ï¼Œéœ€è¦åŠ é”æ‰èƒ½è¯»å†™æ•°æ®ã€‚

```go
type Map struct {
    mu Mutex
    read atomic.Pointer[readOnly] // æ— é”è¯»map
    dirty map[any]*entry // åŠ é”è¯»å†™map
    misses int
}

// readOnly is an immutable struct stored atomically in the Map.read field.
type readOnly struct {
    m       map[any]*entry
    amended bool // true if the dirty map contains some key not in m.
}
```

æ¥ç€ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸‹å†™å…¥æ“ä½œã€‚å½“æœ‰key-valueå€¼å†™å…¥æ—¶ï¼Œå¦‚æœè¿™ä¸ªkeyåœ¨readä¸­ä¸å­˜åœ¨ï¼Œæ¥ä¸‹æ¥å°±è¦åšæ–°å¢æ“ä½œï¼Œå®ƒä¼šåŠ é”å†™å…¥dirty mapä¸­ï¼Œå¹¶ä¸”å°†amendedæ ‡è®°è®¾ç½®ä¸ºtrueã€‚è€Œamendedæ ‡è®°ç”¨äºè¡¨ç¤ºdirtyä¸­æ˜¯å¦æœ‰ä¸åœ¨readä¸­çš„key-valueå€¼ã€‚

è¿™ä¸ªæ“ä½œè¿‡ç¨‹ä½ å¯ä»¥ç»“åˆåé¢çš„ç¤ºæ„å›¾çœ‹ä¸€ä¸‹ï¼Œè¿™æ ·ç†è§£èµ·æ¥æ›´ç›´è§‚ã€‚

![](https://static001.geekbang.org/resource/image/ey/7d/eyybed76bbdd94d0d86057dd02ab3b7d.jpg?wh=2900x1683 "å›¾1 key-value å†™å…¥")

å¦‚æœè¿™ä¸ªkeyåœ¨readä¸­å­˜åœ¨ï¼Œåˆ™ä¼šè¿›è¡Œæ›´æ–°æ“ä½œï¼Œç”±äºread mapå’Œdirty mapé‡Œé¢å­˜å‚¨çš„å€¼æ˜¯entryç±»å‹çš„æŒ‡é’ˆï¼Œä¸”entryç±»å‹çš„æˆå‘˜å˜é‡ä¹Ÿæ˜¯atomic.Pointerç±»å‹ï¼ˆå¦‚åé¢ä»£ç æ‰€ç¤ºï¼‰ã€‚

```go
// An entry is a slot in the map corresponding to a particular key.
type entry struct {
    p atomic.Pointer[any]
}
```

å› æ­¤åœ¨æ›´æ–°æ—¶å°±åƒä¸‹é¢çš„å›¾é‚£æ ·ï¼Œå¯ä»¥ç›´æ¥ç”¨CASæ— é”æ“ä½œæ›¿æ¢æŒ‡é’ˆpæŒ‡å‘çš„å˜é‡ï¼Œè€Œæ— éœ€åšåŠ é”æ“ä½œã€‚

![](https://static001.geekbang.org/resource/image/28/6b/2818fca6cdc5aeeb89111640a52c616b.jpg?wh=2800x1239 "å›¾2 value æ›´æ–°")

ç„¶åï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹è¯»å–æ“ä½œï¼Œæˆ‘ä»¬è¿˜æ˜¯ç»“åˆå…·ä½“ä»£ç æ¥ç†è§£ã€‚

```go
// Load returns the value stored in the map for a key, or nil if no
// value is present.
// The ok result indicates whether value was found in the map.
func (m *Map) Load(key any) (value any, ok bool) {
    read := m.loadReadOnly()
    e, ok := read.m[key]
    if !ok && read.amended {
        m.mu.Lock()
        // Avoid reporting a spurious miss if m.dirty got promoted while we were
        // blocked on m.mu. (If further loads of the same key will not miss, it's
        // not worth copying the dirty map for this key.)
        read = m.loadReadOnly()
        e, ok = read.m[key]
        if !ok && read.amended {
            e, ok = m.dirty[key]
            // Regardless of whether the entry was present, record a miss: this key
            // will take the slow path until the dirty map is promoted to the read
            // map.
            m.missLocked()
        }
        m.mu.Unlock()
    }
    if !ok {
        return nil, false
    }
    return e.load()
}
```

å½“è¯»å–keyå¯¹åº”çš„å€¼æ—¶ï¼Œä¼šå…ˆä»readä¸­è¯»å–ï¼Œå½“readä¸­è¯»ä¸åˆ°ï¼Œå¹¶ä¸”amendedä¸ºtrueæ—¶ï¼Œåˆ™ä¼šåŠ é”ä»dirty mapä¸­è¯»ã€‚**è¿™é‡Œå¯èƒ½å¯¼è‡´ä»sync.Mapè¯»å–çš„æ€§èƒ½åŠ£åŒ–ï¼Œå› ä¸ºå®ƒæ—¢è¦ä»readä¸­è¯»ä¸€éï¼Œåˆè¦åŠ é”ä»dirty mapä¸­è¯»ä¸€éã€‚**

![](https://static001.geekbang.org/resource/image/2f/f5/2f59ace16127a243ebc620d9b4d78cf5.jpg?wh=2900x1857 "å›¾3 è¯» Key æ•°æ®")

åŒæ—¶ï¼Œæ¯æ¬¡readè¯»ä¸åˆ°ï¼Œä»dirty mapä¸­è¯»æ—¶ï¼Œå®ƒä¼šè°ƒç”¨missLockedæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨äºå°†mapçš„misseså­—æ®µåŠ 1ï¼Œmisseså­—æ®µç”¨äºè¡¨ç¤ºreadè¯»æœªå‘½ä¸­æ¬¡æ•°ï¼Œå¦‚æœmisseså€¼æ¯”è¾ƒå¤§ï¼Œè¯´æ˜read mapçš„æ•°æ®å¯èƒ½æ¯”dirty mapå°‘äº†å¾ˆå¤šã€‚ä¸ºäº†æå‡è¯»æ€§èƒ½ï¼ŒmissLockedæ–¹æ³•é‡Œä¼šå°†dirty mapå˜æˆæ–°çš„read mapï¼Œä»£ç å¦‚ä¸‹ã€‚

```go
func (m *Map) missLocked() {
    m.misses++
    if m.misses < len(m.dirty) {
        return
    }
    m.read.Store(&readOnly{m: m.dirty})
    m.dirty = nil
    m.misses = 0
}
```

![](https://static001.geekbang.org/resource/image/3b/fe/3bd3484c3532bfa5e7108280b23e52fe.jpg?wh=2653x1688 "å›¾4 dirty åˆ‡æ¢ä¸º read")

æœ€åï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦ä¸€ä¸ªå¯èƒ½å¯¼è‡´å†™å…¥sync.Mapçš„æ€§èƒ½åŠ£åŒ–çš„ç‚¹ã€‚ä¸Šé¢çš„missLockedæ–¹æ³•ï¼Œä¼šå°†dirty mapç½®ä¸ºnilï¼Œå½“æœ‰æ–°çš„key-valueå€¼å†™å…¥æ—¶ï¼Œä¸ºäº†èƒ½ä¿æŒdirty mapæœ‰å…¨é‡æ•°æ®ï¼Œå°±åƒä¸‹é¢ä»£ç çš„swapæ–¹æ³•ï¼Œå®ƒä¼šåŠ é”å¹¶ä¸”è°ƒç”¨dirtyLockedæ–¹æ³•ï¼Œéå†read mapå¹¶å…¨é‡èµ‹å€¼æ‹·è´ç»™dirty mapã€‚

ä½ å¯ä»¥çœ‹çœ‹åé¢çš„ä»£ç ï¼Œå†æƒ³æƒ³è¿™æ ·å†™ä¼šä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

```go
// Swap swaps the value for a key and returns the previous value if any.
// The loaded result reports whether the key was present.
func (m *Map) Swap(key, value any) (previous any, loaded bool) {
    ...
    m.mu.Lock()
    if !read.amended {
        // We're adding the first new key to the dirty map.
        // Make sure it is allocated and mark the read-only map as incomplete.
        m.dirtyLocked()
        m.read.Store(&readOnly{m: read.m, amended: true})
    }
    m.dirty[key] = newEntry(value)
    m.mu.Unlock()
    return previous, loaded
}

func (m *Map) dirtyLocked() {
    if m.dirty != nil {
        return
    }
    // read mapå…¨é‡å¤åˆ¶åˆ°dirty
    read := m.loadReadOnly()
    m.dirty = make(map[any]*entry, len(read.m))
    for k, e := range read.m {
        if !e.tryExpungeLocked() {
            m.dirty[k] = e
        }
    }
}
```

ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰å‘ç°ï¼Ÿå½“æ•°æ®é‡æ¯”è¾ƒå¤§æ—¶ï¼Œè¿™æ ·ä¼šå¯¼è‡´å¤§é‡æ•°æ®çš„æ‹·è´ï¼Œæ€§èƒ½ä¼šåŠ£åŒ–ä¸¥é‡ã€‚æ¯”å¦‚æˆ‘ä»¬ç¼“å­˜å‡ ç™¾ä¸‡æ¡æ•°æ®ï¼Œå°±å­˜åœ¨å‡ ç™¾ä¸‡æ¡æ•°æ®çš„èµ‹å€¼æ‹·è´ã€‚

é€šè¿‡ä¸Šé¢sync.Mapçš„åŸç†åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œsync.Mapæ˜¯é€šè¿‡ä¸¤ä¸ªmapæ¥å®ç°è¯»å†™åˆ†ç¦»ï¼Œä»è€Œè¾¾åˆ°é«˜æ€§èƒ½è¯»çš„ç›®çš„ã€‚ä¸è¿‡å®ƒå­˜åœ¨ä¸‹é¢å‡ ä¸ªç¼ºç‚¹ã€‚

1. ç”±äºæœ‰ä¸¤ä¸ªmapï¼Œå› æ­¤å ç”¨å†…å­˜ä¼šæ¯”è¾ƒé«˜ã€‚
2. æ›´é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå½“ç”±äºå†™æ¯”è¾ƒå¤šæˆ–è€…æœ¬åœ°ç¼“å­˜æ²¡æœ‰å…¨é‡æ•°æ®æ—¶ï¼Œä¼šå¯¼è‡´è¯»mapç»å¸¸è¯»ä¸åˆ°æ•°æ®ï¼Œè€Œéœ€è¦åŠ é”å†è¯»ä¸€æ¬¡ï¼Œä»è€Œå¯¼è‡´è¯»æ€§èƒ½é€€åŒ–ã€‚
3. å½“æ•°æ®é‡æ¯”è¾ƒå¤§æ—¶ï¼Œå¦‚æœå†™å…¥è§¦å‘è¯»mapå‘å†™mapæ‹·è´ï¼Œä¼šå¯¼è‡´è¾ƒå¤§çš„æ€§èƒ½å¼€é”€ã€‚

å¯ä»¥çœ‹å‡ºæ¥ï¼Œsync.Mapçš„ä½¿ç”¨åœºæ™¯è¿˜æ˜¯æ¯”è¾ƒè‹›åˆ»çš„ã€‚

é‚£å›åˆ°åˆšå¼€å§‹çš„é—®é¢˜ï¼Œåœ¨å¤§è§„æ¨¡æ•°æ®ç¼“å­˜æ—¶ï¼Œæˆ‘ä»¬æ˜¯è¯¥é€‰æ‹©åˆ†æ®µé”å®ç°çš„mapè¿˜æ˜¯sync.Mapç±»å‹æ¥ç¼“å­˜æ•°æ®å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯åˆ†æ®µé”mapã€‚åŸå› æ˜¯æˆ‘ä»¬å¾ˆéš¾å‡†ç¡®åœ°é¢„ä¼°è¯»å†™æ¯”ä¾‹ï¼Œè€Œä¸”è¯»å†™æ¯”ä¾‹ä¹Ÿä¼šéšç€ä¸šåŠ¡çš„å‘å±•å˜åŒ–ã€‚æ­¤å¤–ï¼Œåœ¨å¤§è§„æ¨¡æ•°æ®ç¼“å­˜æ—¶ï¼Œä¸¤ä¸ªmapçš„å†…å­˜å’Œæ‹·è´å¼€é”€ä¹Ÿæ˜¯ä¸å¾—ä¸è€ƒè™‘çš„ç¨³å®šæ€§é£é™©ç‚¹ï¼Œå› æ­¤åœ¨å¤§è§„æ¨¡æ•°æ®ç¼“å­˜æ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨åˆ†æ®µé”å®ç°çš„mapæ¥ç¼“å­˜æ•°æ®ã€‚

## map gcä¼˜åŒ–

åœ¨åšäº†å¹¶å‘mapçš„é€‰å‹ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘çš„ä¸€ç‚¹æ˜¯åœ¨ç¼“å­˜å¤§é‡æ•°æ®æ—¶ï¼Œå¦‚ä½•é¿å…GCå¯¼è‡´çš„æ€§èƒ½å¼€é”€ã€‚

æˆ‘ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹ï¼Œåˆ†åˆ«æµ‹è¯•keyã€valueä¸ºstringç±»å‹çš„mapåœ¨ä¸åŒæ•°æ®è§„æ¨¡ä¸‹çš„GCå¼€é”€ã€‚

```go
import (
    "fmt"
    "runtime"
    "testing"
    "time"
)

// Test1kGCDuration æµ‹è¯•å°è§„æ¨¡æ•°æ®gcæ—¶é•¿
func Test1kGCDuration(t *testing.T) {
    size := 1000
    m := GenerateStringMap(size)
    runtime.GC()
    gcCost := timeGC()
    t.Logf("size %d GC duration: %v\n", size, gcCost)
    _ = m["1"]
}

// æµ‹è¯•å¤§è§„æ¨¡æ•°æ®gcæ—¶é•¿
func Test500wGCDuration(t *testing.T) {
    size := 5000000
    m := GenerateStringMap(size)
    runtime.GC()
    gcCost := timeGC()
    t.Logf("size %d GC duration: %v\n", size, gcCost)
    _ = m["1"]
}
func GenerateStringMap(size int) map[string]string {
    // åœ¨è¿™é‡Œæ‰§è¡Œä¸€äº›å¯èƒ½ä¼šè§¦å‘GCçš„æ“ä½œï¼Œä¾‹å¦‚åˆ›å»ºå¤§é‡å¯¹è±¡ç­‰
    // ä»¥ä¸‹ç¤ºä¾‹åˆ›å»ºä¸€ä¸ªè¾ƒå¤§çš„mapå¹¶å¡«å……æ•°æ®
    m := make(map[string]string)
    for i := 0; i < size; i++ {
        key := fmt.Sprintf("key_%d", i)
        value := fmt.Sprintf("val_%d", i)
        m[key] = value

    }
    return m
}

func timeGC() time.Duration {
    // è®°å½•GCå¼€å§‹æ—¶é—´
    gcStartTime := time.Now()
    // æ‰‹åŠ¨è§¦å‘GCï¼Œä»¥ä¾¿æ›´å‡†ç¡®åœ°æµ‹é‡æ­¤æ¬¡æ“ä½œç›¸å…³çš„GCæ—¶é•¿
    runtime.GC()

    // è®¡ç®—æ€»çš„GCæ—¶é•¿
    gcCost := time.Since(gcStartTime)
    return gcCost
}
```

æµ‹è¯•ç»“æœå‡ºæ¥äº†ï¼Œ**mapä¸­å‚¨å­˜1kæ¡æ•°æ®å’Œ500wæ¡æ•°æ®çš„GCè€—æ—¶å·®å¼‚å·¨å¤§**ã€‚500wæ¡æ•°æ®ï¼ŒGCè€—æ—¶290msï¼Œè€Œ1kæ¡æ•°æ®è€—æ—¶åªéœ€è¦480Âµsï¼Œæœ‰600å€çš„æ€§èƒ½å·®å¼‚ã€‚

```shell
killianxu@KILLIANXU-MB0 8 % go test -gcflags=all=-l gc_size_test.go -v
=== RUN   Test1kGCDuration
    gc_size_test.go:16: size 1000 GC duration: 480.718Âµs
--- PASS: Test1kGCDuration (0.00s)
=== RUN   Test500wGCDuration
    gc_size_test.go:26: size 5000000 GC duration: 290.422382ms
--- PASS: Test500wGCDuration (5.12s)
```

é‚£ä¹ˆåœ¨å¤§è§„æ¨¡æ•°æ®ç¼“å­˜ä¸‹ï¼ŒGCä¸ºä»€ä¹ˆè€—æ—¶ä¼šè¿™ä¹ˆé•¿å‘¢ï¼Ÿ

è¿™æ˜¯å› ä¸ºGCåœ¨åšå¯¹è±¡æ‰«ææ ‡è®°æ—¶ï¼Œéœ€è¦æ‰«ææ ‡è®°mapé‡Œé¢çš„å…¨é‡key-valueå¯¹è±¡ï¼Œæ•°æ®è¶Šå¤šï¼Œéœ€è¦æ‰«æçš„å¯¹è±¡è¶Šå¤šï¼ŒGCæ—¶é—´ä¹Ÿå°±è¶Šé•¿ã€‚

æ‰«ææ ‡è®°çš„è€—æ—¶è¿‡é•¿ï¼Œä¼šå¼•å‘ä¸€ç³»åˆ—ä¸è‰¯å½±å“ã€‚å®ƒä¸ä»…ä¼šå¤§é‡æ¶ˆè€— CPU èµ„æºï¼Œé™ä½æœåŠ¡ååï¼Œè€Œä¸”åœ¨æ ‡è®°å·¥ä½œæœªèƒ½åŠæ—¶å®Œæˆçš„æƒ…å†µä¸‹ï¼ŒGC ä¼šè¦æ±‚å¤„ç†è¯·æ±‚çš„åç¨‹æš‚åœæ‰‹å¤´çš„ä¸šåŠ¡é€»è¾‘å¤„ç†æµç¨‹ï¼Œè½¬è€ŒååŠ© GC å¼€å±•æ ‡è®°ä»»åŠ¡ã€‚è¿™æ ·ä¸€æ¥ï¼Œéƒ¨åˆ†è¯·æ±‚çš„å“åº”å»¶æ—¶å°†ä¼šä¸å¯é¿å…åœ°å¤§å¹…å‡é«˜ï¼Œä¸¥é‡å½±å“ç³»ç»Ÿçš„å“åº”æ•ˆç‡ä¸æ€§èƒ½è¡¨ç°ã€‚

ä¸ºäº†é¿å…GCå¯¹ç¨‹åºæ€§èƒ½é€ æˆå½±å“ï¼Œå¯¹äºmapç±»å‹ï¼ŒGolangåœ¨ [1.5ç‰ˆæœ¬](https://go-review.googlesource.com/c/go/+/3288)æä¾›äº†ä¸€ç§ç»•è¿‡GCæ‰«æçš„æ–¹æ³•ã€‚ç»•è¿‡GCè¦æ»¡è¶³ä¸‹é¢ä¸¤ä¸ªæ¡ä»¶ã€‚

**ç¬¬ä¸€ï¼Œmapçš„key-valueç±»å‹ä¸èƒ½æ˜¯æŒ‡é’ˆç±»å‹ä¸”å†…éƒ¨ä¸èƒ½åŒ…å«æŒ‡é’ˆ**ã€‚æ¯”å¦‚stringç±»å‹ï¼Œå®ƒçš„åº•å±‚æ•°æ®ç»“æ„ä¸­æœ‰æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆï¼Œå› æ­¤ä¸æ»¡è¶³è¿™ä¸ªæ¡ä»¶ã€‚

```go
// å­—ç¬¦ä¸²æ•°æ®ç»“æ„
type stringStruct struct {
    str unsafe.Pointer //æŒ‡é’ˆç±»å‹ï¼ŒæŒ‡å‘å­—èŠ‚æ•°ç»„
    len int
}
```

é‚£åˆ°åº•ä¸å«æŒ‡é’ˆç±»å‹ï¼Œèƒ½ä¸èƒ½ç¼©çŸ­GCå¼€é”€å‘¢ï¼Ÿå’±ä»¬å°†ä»£ç é‡Œmapçš„key-valueç±»å‹æ¢æˆintç±»å‹å†è¯•ä¸€ä¸‹ã€‚

```go
// æµ‹è¯•key-valueéæŒ‡é’ˆç±»å‹,intçš„gcå¼€é”€
func Test500wIntGCDuration(t *testing.T) {
    size := 5000000
    m := GenerateIntMap(size)
    runtime.GC()
    gcCost := timeGC()
    t.Logf("size %d GC duration: %v\n", size, gcCost)
    _ = m[1]
}
func GenerateIntMap(size int) map[int]int {
    // åœ¨è¿™é‡Œæ‰§è¡Œä¸€äº›å¯èƒ½ä¼šè§¦å‘GCçš„æ“ä½œï¼Œä¾‹å¦‚åˆ›å»ºå¤§é‡å¯¹è±¡ç­‰
    // ä»¥ä¸‹ç¤ºä¾‹åˆ›å»ºä¸€ä¸ªè¾ƒå¤§çš„mapå¹¶å¡«å……æ•°æ®
    m := make(map[int]int)
    for i := 0; i < size; i++ {
        m[i] = i

    }
    return m
}
```

**ä½ ä¼šå‘ç°ï¼Œkey-valueæ¢æˆintç±»å‹çš„mapï¼Œgcæ€§èƒ½æå‡éå¸¸æ˜æ˜¾**ï¼Œgcæ—¶é—´ä»290mså˜æˆäº†2.3msï¼Œæå‡äº†å‡ ç™¾å€ã€‚

```plain
killianxu@KILLIANXU-MB0 8 % go test -gcflags=all=-l -run Test500wIntGCDuration -v
=== RUN   Test500wIntGCDuration
    gc_type_test.go:14: size 5000000 GC duration: 2.29631ms
--- PASS: Test500wIntGCDuration (1.33s)
```

**ç¬¬äºŒï¼Œkey-valueé™¤äº†éœ€è¦æ»¡è¶³éæŒ‡é’ˆè¿™ä¸ªæ¡ä»¶ï¼Œkey/valueçš„å¤§å°ä¹Ÿä¸èƒ½è¶…è¿‡ 128 å­—èŠ‚ï¼Œå¦‚æœè¶…è¿‡128å­—èŠ‚ï¼Œkey-valueå°±ä¼šé€€åŒ–æˆæŒ‡é’ˆï¼Œå¯¼è‡´è¢«GCæ‰«æã€‚**

æˆ‘ä»¬ç”¨valueå¤§å°åˆ†åˆ«æ˜¯128ã€129å­—èŠ‚çš„ç»“æ„ä½“æµ‹è¯•ä¸€ä¸‹ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ã€‚

```go
func TestSmallStruct(t *testing.T) {
    type SmallStruct struct {
        data [128]byte
    }
    m := make(map[int]SmallStruct)
    size := 5000000
    for i := 0; i < size; i++ {
        m[i] = SmallStruct{}
    }
    runtime.GC()
    gcCost := timeGC()
    t.Logf("size %d GC duration: %v\n", size, gcCost)
    _ = m[1]
}
func TestBigStruct(t *testing.T) {
    type BigStruct struct {
        data [129]byte
    }
    m := make(map[int]BigStruct)
    size := 5000000
    for i := 0; i < size; i++ {
        m[i] = BigStruct{}
    }
    runtime.GC()
    gcCost := timeGC()
    t.Logf("size %d GC duration: %v\n", size, gcCost)
    _ = m[1]
}
```

**æœç„¶ï¼Œkey-valueçš„å¤§å°è¶…è¿‡128å­—èŠ‚ä¼šå¯¼è‡´GCæ€§èƒ½å¼€é”€å˜å¤§ã€‚**å¯¹äº129å­—èŠ‚çš„ç»“æ„ä½“ï¼ŒGCè€—æ—¶264msï¼Œè€Œ128å­—èŠ‚ï¼Œåªéœ€è¦2.4msï¼Œæ€§èƒ½å·®è·é«˜è¾¾ç™¾å€ã€‚

```shell
killianxu@KILLIANXU-MB0 8 % go test -gcflags=all=-l -run "TestSmallStruct|TestBigStruct" -v
=== RUN   TestSmallStruct
    gc_type_test.go:39: size 5000000 GC duration: 2.444276ms
--- PASS: TestSmallStruct (4.13s)
=== RUN   TestBigStruct
    gc_type_test.go:53: size 5000000 GC duration: 264.834283ms
--- PASS: TestBigStruct (2.07s)
```

é€šè¿‡å‰é¢çš„æµ‹è¯•ï¼Œæˆ‘ä»¬çŸ¥é“äº†ï¼Œ**åœ¨ç¼“å­˜å¤§è§„æ¨¡æ•°æ®æ—¶ï¼Œä¸ºäº†é¿å…GCå¼€é”€ï¼Œkey-valueä¸èƒ½å«æŒ‡é’ˆç±»å‹ä¸”key-valueçš„å¤§å°ä¸èƒ½è¶…è¿‡128å­—èŠ‚ã€‚**

å®é™…ä¸Šï¼Œå’±ä»¬åœ¨ç¼“å­˜å¤§è§„æ¨¡æ•°æ®æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æˆç†Ÿçš„å¼€æºåº“æ¥å®ç°ï¼Œæ¯”å¦‚ [bigcache](https://github.com/allegro/bigcache/tree/main)ã€[freecache](https://github.com/coocood/freecache) ç­‰ã€‚å®ƒä»¬çš„åº•å±‚å°±æ˜¯ä½¿ç”¨åˆ†æ®µé”åŠ mapç±»å‹æ¥å®ç°æ•°æ®å­˜å‚¨çš„ï¼ŒåŒæ—¶ï¼Œå®ƒä»¬ä¹Ÿåˆ©ç”¨äº†åˆšåˆšè®²è¿‡çš„mapçš„key-valueç‰¹æ€§ï¼Œæ¥é¿å…GCæ‰«æã€‚

ä»¥bigcacheä¸ºä¾‹ï¼Œå®ƒçš„ä½¿ç”¨æ¯”è¾ƒç®€å•ã€‚é€šè¿‡Getå’ŒSetæ–¹æ³•å°±å¯ä»¥å®ç°è¯»å†™æ“ä½œã€‚

```go
import (
     "fmt""context""github.com/allegro/bigcache/v3"
)

cache, _ := bigcache.New(context.Background(), bigcache.DefaultConfig(10 * time.Minute))

cache.Set("my-unique-key", []byte("value"))

entry, _ := cache.Get("my-unique-key")
fmt.Println(string(entry))
```

## å°ç»“

ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¥å¤§è§„æ¨¡æ•°æ®ç¼“å­˜çš„åœºæ™¯ä¸ºä¾‹ï¼Œå¸¦ä½ å­¦ä¹ äº†golang syncåŒ…çš„Mapç±»å‹ä»¥åŠmapçš„gcä¼˜åŒ–æŠ€å·§ã€‚

ç°åœ¨è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹sync.Mapçš„çŸ¥è¯†ä»¥åŠmapçš„zero gcç‰¹æ€§ã€‚

sync.Map åœ¨åº•å±‚å·§å¦™åœ°å€ŸåŠ©ä¸¤ä¸ª map æ¥è¾¾æˆè¯»å†™åˆ†ç¦»çš„è®¾è®¡æ¶æ„ï¼Œä»¥æ­¤å®ç°é«˜æ€§èƒ½çš„è¯»å–æ“ä½œã€‚ç„¶è€Œï¼Œè¿™ç§è®¾è®¡å¹¶éæ¯«æ— ç‘•ç–µï¼Œå®ƒå­˜åœ¨ç€ä¸€äº›ä¸å®¹å¿½è§†çš„é—®é¢˜ã€‚

ä¸€æ–¹é¢ï¼Œå…¶å†…å­˜å ç”¨ç›¸å¯¹è¾ƒé«˜ï¼›å¦ä¸€æ–¹é¢ï¼Œå½“å†™å…¥æ“ä½œè¾ƒä¸ºé¢‘ç¹æ—¶ï¼Œè¯»å–æ€§èƒ½ä¼šå‡ºç°æ˜æ˜¾çš„é€€åŒ–ç°è±¡ã€‚

æ­¤å¤–ï¼Œç”±äºå…¶åŸºäºä¸¤ä¸ª map çš„æ¶æ„ç‰¹æ€§ï¼Œåœ¨æ•°æ®å¤„ç†è¿‡ç¨‹ä¸­è¿˜ä¼šäº§ç”Ÿä¸¤ä¸ª map ä¹‹é—´çš„æ•°æ®æ‹·è´å¼€é”€ï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šå½±å“äº†æ•´ä½“çš„æ€§èƒ½è¡¨ç°ä¸èµ„æºåˆ©ç”¨æ•ˆç‡ã€‚æ­£å› ä¸º sync.Map çš„ä½¿ç”¨åœºæ™¯è¾ƒä¸ºä¸¥è‹›ï¼Œåœ¨å®é™…çš„ç¼–ç¨‹å®è·µä¸­ï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ³•çš„é¢‘ç‡åå€’æ¯”è¾ƒä½ã€‚

å½“mapä¸­ç¼“å­˜çš„æ•°æ®æ¯”è¾ƒå¤šæ—¶ï¼Œä¸ºäº†é¿å…GCå¼€é”€ï¼Œæˆ‘ä»¬å¯ä»¥å°†mapä¸­çš„key-valueç±»å‹è®¾è®¡æˆéæŒ‡é’ˆç±»å‹ä¸”å¤§å°ä¸è¶…è¿‡128å­—èŠ‚ï¼Œä»è€Œé¿å…GCæ‰«æã€‚

å¸Œæœ›ä½ èƒ½å¤Ÿç”¨å¿ƒå»ä½“ä¼šmap gcçš„ä¼˜åŒ–æŠ€å·§ã€‚åœ¨ä»Šåé‡åˆ°å¤§è§„æ¨¡æ•°æ®ç¼“å­˜çš„åœºæ™¯ï¼Œåˆ«å¿˜äº†ç”¨ä¸Šå­¦åˆ°çš„æŠ€å·§å»åšGCä¼˜åŒ–ã€‚

## æ€è€ƒé¢˜

åœ¨å¤§è§„æ¨¡æ•°æ®ç¼“å­˜æ—¶ï¼Œæˆ‘ä»¬è™½ç„¶å¯ä»¥ç”¨bigcacheæ¥é¿å…gcï¼Œä½†æ˜¯å´ä¼šå¼•èµ·å…¶å®ƒå¼€é”€ï¼Œé‚£ä¹ˆæ˜¯å“ªäº›å¼€é”€å‘¢ï¼Ÿ

æ¬¢è¿ä½ æŠŠä½ çš„ç­”æ¡ˆåˆ†äº«åœ¨è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ4ï¼‰</strong></div><ul>
<li><span>Geek_e73ba0</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>cache.Set(&quot;my-unique-key&quot;, []byte(&quot;value&quot;)) è¿™é‡Œçš„keyæ˜¯&quot;my-unique-key&quot;ï¼Œä¸å°±æ˜¯å­—ç¬¦ä¸²å—ï¼ŸæŒ‰ç…§ä¹‹å‰çš„è¯´æ³•ï¼Œå­—ç¬¦ä¸²åº•å±‚æ•°æ®ç»“æ„ä¸­æœ‰æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆï¼Œæ˜¯ä¸ç¬¦åˆæ¡ä»¶çš„ï¼Œè¿™ä¸æ˜¯è‡ªç›¸çŸ›ç›¾å—ï¼Ÿè¿˜å¥½æˆ‘æœ‰deepseekå’ŒGPT 03-miniï¼Œé€šè¿‡å®ƒä¿©å¾—çŸ¥ï¼Œç”¨æˆ·ä¾§æ¥å£çš„æŠ½è±¡ï¼šSet(key string, value []byte) åªæ˜¯ API æ¥å£ï¼Œå®é™…å­˜å‚¨æ—¶ï¼š

å°† key è½¬æ¢ä¸º uint64 å“ˆå¸Œå€¼ï¼ˆæ— æŒ‡é’ˆï¼‰

å°† key å’Œ value åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶å­˜å…¥ entriesï¼ˆæ— æŒ‡é’ˆç»“æ„ï¼‰

æœ€ç»ˆå­˜å‚¨ç»“æ„æ— æŒ‡é’ˆï¼šæ ¸å¿ƒå­˜å‚¨ç»“æ„ map[uint64]uint32 å’Œ []byte å‡ä¸å«æŒ‡é’ˆï¼ŒGC å®Œå…¨å¿½ç•¥ã€‚é€‚ç”¨åœºæ™¯ä¸é™åˆ¶
1. æœ€ä½³é€‚ç”¨åœºæ™¯
æµ·é‡å°å¯¹è±¡ç¼“å­˜ï¼ˆå¦‚ç¼“å­˜ä¼šè¯æ•°æ®ã€é…ç½®é¡¹ï¼‰

é«˜ååé‡åœºæ™¯ï¼ˆéœ€è¦æä½ GC å¼€é”€ï¼‰

é”®å€¼æ— éœ€éå†ï¼ˆbigcache ä¸æ”¯æŒéå†æ“ä½œï¼‰

2. ä¸»è¦é™åˆ¶
å†…å­˜ä¸å¯å›æ”¶ï¼šentries æ•°ç»„é‡‡ç”¨é¢„åˆ†é…+ç¯å½¢ç¼“å†²åŒºè®¾è®¡ï¼Œæ—§æ•°æ®ä¼šè¢«æ–°æ•°æ®è¦†ç›–ï¼Œä½†æ— æ³•ä¸»åŠ¨é‡Šæ”¾å†…å­˜ã€‚

æ— æŒä¹…åŒ–èƒ½åŠ›ï¼šçº¯å†…å­˜ç¼“å­˜ï¼Œè¿›ç¨‹é€€å‡ºåæ•°æ®ä¸¢å¤±ã€‚

æ€»ç»“
bigcache é€šè¿‡ä»¥ä¸‹è®¾è®¡å®ç° GC ä¼˜åŒ–ï¼š

å“ˆå¸Œå€¼æ˜ å°„ï¼šå°†å­—ç¬¦ä¸²é”®è½¬æ¢ä¸ºæ— æŒ‡é’ˆçš„ uint64ã€‚

è¿ç»­å†…å­˜å­˜å‚¨ï¼šé”®å€¼æ•°æ®ä»¥äºŒè¿›åˆ¶å½¢å¼å­˜å‚¨åœ¨ []byte æ•°ç»„ä¸­ï¼Œé¿å…æŒ‡é’ˆã€‚

æ— æŒ‡é’ˆå“ˆå¸Œè¡¨ï¼šmap[uint64]uint32 çš„é”®å€¼å‡ä¸ºåŸºæœ¬ç±»å‹ï¼ŒGC ä¸ä¼šæ‰«æã€‚

ç”¨æˆ·ä»£ç ä¸­çœ‹ä¼¼ä½¿ç”¨äº†å¸¦æŒ‡é’ˆçš„å­—ç¬¦ä¸²é”®ï¼Œä½†é€šè¿‡å†…éƒ¨è½¬æ¢ï¼Œæœ€ç»ˆå­˜å‚¨ç»“æ„å®Œå…¨ä¸å«æŒ‡é’ˆï¼Œå®Œç¾å¥‘åˆ Go çš„ GC ä¼˜åŒ–æœºåˆ¶ã€‚</p>2025-02-14</li><br/><li><span>å‡è£…åœ¨å…»ğŸ·</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œè¿™å¥è¯çš„å…·ä½“å«ä¹‰èƒ½è§£é‡Šä¸€ä¸‹å—
read å­˜å‚¨äº†éƒ¨åˆ†å†™å…¥ Map çš„å†…å®¹ï¼Œç”¨æ¥åŠ é€Ÿè¯»æ“ä½œã€‚è€Œ dirty å­˜å‚¨äº†å…¨é‡å†…å®¹ï¼Œéœ€è¦åŠ é”æ‰èƒ½è¯»å†™æ•°æ®ã€‚ </p>2024-12-30</li><br/><li><span>lJ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>1. åªæ”¯æŒ []byte ç±»å‹çš„æ•°æ®å­˜å‚¨ï¼Œä¸æ”¯æŒå¤æ‚çš„æ•°æ®ç»“æ„ï¼Œéœ€è¦è‡ªè¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ï¼Œå¢åŠ äº†å¼€å‘å¤æ‚åº¦ã€‚
2. ä½¿ç”¨ç¯å½¢ç¼“å†²åŒºå­˜å‚¨æ•°æ®ï¼Œæ•°æ®å†™å…¥æ—¶æ˜¯è¿ç»­åˆ†é…çš„ï¼Œä½†åˆ é™¤æ—¶åªæ ‡è®°ä¸ºæ— æ•ˆï¼Œä¸å›æ”¶ç©ºé—´ã€‚å¯¼è‡´å†…å­˜åˆ©ç”¨ç‡é™ä½ã€‚</p>2024-12-25</li><br/><li><span>å¿«å«æˆ‘å°ç™½</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>runtime.GC è¿™ä¸ªå‡½æ•°ä¸ºä½•åœ¨å‡½æ•°å†…å¤–éƒ½è°ƒç”¨ä¸€æ¬¡å‘€ï¼Ÿè€Œä¸”æµ‹è¯•å‡½æ•°ä¼¼ä¹æ²¡äº§ç”Ÿéœ€è¦å›æ”¶çš„ä¸´æ—¶ç»“æ„ä½“ï¼Œæˆ‘ä»¬è°ƒç”¨GCå‡½æ•°ä»…ä»…æ˜¯ä¸ºäº†è§‚å¯Ÿåƒåœ¾å›æ”¶çš„æ‰«ææ—¶é—´å—ï¼Ÿ</p>2024-12-25</li><br/>
</ul>