ä½ å¥½ï¼Œæˆ‘æ˜¯é¸Ÿçªã€‚

å…±äº«èµ„æºä¿æŠ¤ã€ä»»åŠ¡ç¼–æ’å’Œæ¶ˆæ¯ä¼ é€’æ˜¯Goå¹¶å‘ç¼–ç¨‹ä¸­å¸¸è§çš„åœºæ™¯ï¼Œè€Œ**åˆ†ç»„æ‰§è¡Œä¸€æ‰¹ç›¸åŒçš„æˆ–ç±»ä¼¼çš„ä»»åŠ¡åˆ™æ˜¯ä»»åŠ¡ç¼–æ’ä¸­ä¸€ç±»æƒ…å½¢**ï¼Œæ‰€ä»¥ï¼Œè¿™èŠ‚è¯¾ï¼Œæˆ‘ä¸“é—¨æ¥ä»‹ç»ä¸€ä¸‹åˆ†ç»„ç¼–æ’çš„ä¸€äº›å¸¸ç”¨åœºæ™¯å’Œå¹¶å‘åŸè¯­ï¼ŒåŒ…æ‹¬ErrGroupã€gollbackã€Hunchå’Œschedgroupã€‚

æˆ‘ä»¬å…ˆæ¥å­¦ä¹ ä¸€ç±»éå¸¸å¸¸ç”¨çš„å¹¶å‘åŸè¯­ï¼Œé‚£å°±æ˜¯ErrGroupã€‚

# ErrGroup

[ErrGroup](https://github.com/golang/sync/tree/master/errgroup)æ˜¯Goå®˜æ–¹æä¾›çš„ä¸€ä¸ªåŒæ­¥æ‰©å±•åº“ã€‚æˆ‘ä»¬ç»å¸¸ä¼šç¢°åˆ°éœ€è¦å°†ä¸€ä¸ªé€šç”¨çš„çˆ¶ä»»åŠ¡æ‹†æˆå‡ ä¸ªå°ä»»åŠ¡å¹¶å‘æ‰§è¡Œçš„åœºæ™¯ï¼Œå…¶å®ï¼Œå°†ä¸€ä¸ªå¤§çš„ä»»åŠ¡æ‹†æˆå‡ ä¸ªå°ä»»åŠ¡å¹¶å‘æ‰§è¡Œï¼Œå¯ä»¥æœ‰æ•ˆåœ°æé«˜ç¨‹åºçš„å¹¶å‘åº¦ã€‚å°±åƒä½ åœ¨å¨æˆ¿åšé¥­ä¸€æ ·ï¼Œä½ å¯ä»¥åœ¨è’¸ç±³é¥­çš„åŒæ—¶ç‚’å‡ ä¸ªå°èœï¼Œç±³é¥­è’¸å¥½äº†ï¼ŒèœåŒæ—¶ä¹Ÿåšå¥½äº†ï¼Œå¾ˆå¿«å°±èƒ½åƒåˆ°å¯å£çš„é¥­èœã€‚

ErrGroupå°±æ˜¯ç”¨æ¥åº”å¯¹è¿™ç§åœºæ™¯çš„ã€‚å®ƒå’ŒWaitGroupæœ‰äº›ç±»ä¼¼ï¼Œä½†æ˜¯å®ƒæä¾›åŠŸèƒ½æ›´åŠ ä¸°å¯Œï¼š

- å’ŒContexté›†æˆï¼›
- errorå‘ä¸Šä¼ æ’­ï¼Œå¯ä»¥æŠŠå­ä»»åŠ¡çš„é”™è¯¯ä¼ é€’ç»™Waitçš„è°ƒç”¨è€…ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘æ¥ç»™ä½ ä»‹ç»ä¸€ä¸‹ErrGroupçš„åŸºæœ¬ç”¨æ³•å’Œå‡ ç§åº”ç”¨åœºæ™¯ã€‚

## åŸºæœ¬ç”¨æ³•

golang.org/x/sync/errgroupåŒ…ä¸‹å®šä¹‰äº†ä¸€ä¸ªGroup structï¼Œå®ƒå°±æ˜¯æˆ‘ä»¬è¦ä»‹ç»çš„ErrGroupå¹¶å‘åŸè¯­ï¼Œåº•å±‚ä¹Ÿæ˜¯åŸºäºWaitGroupå®ç°çš„ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ16ï¼‰</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/12/4b/69/c02eac91.jpg" width="30px"><span>å¤§æ¼ èƒ¡èåœ</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>çœ‹äº†è¿™ç¯‡æ–‡ç« è¿˜æ˜¯æ”¶è·å·¨å¤§ï¼Œä»¥å‰ä¸çŸ¥é“ï¼Œä¹Ÿæ²¡ç”¨ç”¨è¿‡ã€‚

é¦–å…ˆæ˜¯ï¼ŒErrGroup,
å®˜æ–¹çš„å®ç°ï¼Œbilibili&#47;errgroupï¼Œneilotoole&#47;errgroupï¼Œfacebookgo&#47;errgroup

å…¶å®ƒå®ç”¨çš„ Group å¹¶å‘åŸè¯­SizedGroup&#47;ErrSizedGroup

gollbackå„ç§å®ç°ï¼Œä»¥å‰åœ¨nodejsä¸­ç»å¸¸ä½¿ç”¨ï¼Œæ²¡æƒ³åˆ°golangä¹Ÿæœ‰å®ç°ã€‚
ç±»ä¼¼çš„è¿˜æœ‰Hunchå®ç°ã€‚

å¦å¤–ï¼Œå¦‚æœé’ˆå¯¹å®šæ—¶å™¨æ¯”è¾ƒå¤šçš„æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨ schedgroup </div>2020-11-23</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJsOFUdib57ORVyia33dibSGRgwZZ9L2hQ90Xh5WsDUHfpHoCW2AMibnawMLBS6upGH3Qic57kl4PE6v2w/132" width="30px"><span>mbc</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>è€å¸ˆï¼Œè¿™ç§å’Œç”¨æ™®é€šçš„goåç¨‹æˆ–è€…channelå»å®Œæˆä¸€ç»„ä»»åŠ¡çš„ç¼–å†™æœ‰å•¥ä¸ä¸€æ ·å—ï¼Ÿå¥½å¤„æ˜¯å•¥</div>2020-11-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/2a/46/e4/0860c82f.jpg" width="30px"><span>ä¸œæ³½</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æ–‡ç« ä¸­å¤šæ¬¡å‡ºç°çš„â€œè®©å­ä»»åŠ¡ä¸­æ–­æ‰§è¡Œâ€ï¼Œè¿™é‡Œçš„è¯­ä¹‰æ˜¯ä¸­æ–­å­goroutineçš„æ‰§è¡Œè¿˜æ˜¯åœ¨å­goroutineä¸­ç”¨ç±»ä¼¼select &lt;-ctx.Done()çš„æ–¹å¼åœ¨æ‰§è¡Œä»»åŠ¡å‰åˆ¤æ–­ä»»åŠ¡æ˜¯å¦åº”è¯¥è¿›è¡Œã€‚</div>2021-12-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/62/dc/8876c73b.jpg" width="30px"><span>moooofly</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>```go
    ...
    for i := 0; i &lt; total; i++ { &#47;&#47; å¹¶å‘ä¸€ä¸‡ä¸ªgoroutineæ‰§è¡Œå­ä»»åŠ¡ï¼Œç†è®ºä¸Šè¿™äº›å­ä»»åŠ¡éƒ½ä¼šåŠ å…¥åˆ°Groupçš„å¾…å¤„ç†åˆ—è¡¨ä¸­
        go func() {
            g.Go(func(ctx context.Context) error {
                atomic.AddInt64(&amp;count, 1)
                return nil
            })
        }()
    }
	...
```

è¿™ä¸ªåœ°æ–¹æœ‰ç‚¹ä¸ç†è§£ï¼Œg.Go() ä¸å°±æ˜¯åˆ›å»ºäº†å­ goroutine äº†ä¹ˆï¼Œä¸ºå•¥è¿™é‡Œè¿˜è¦ä½¿ç”¨ go func() {...} ï¼›æˆ‘çœ‹æ–‡ç« ä¸­å…¶ä»–ç±»ä¼¼åœ°æ–¹éƒ½æ²¡æœ‰è¿™ä¹ˆç”¨ï¼Œåªæœ‰è¿™é‡Œæ˜¯è¿™æ ·~</div>2020-11-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/11/cd/9122abaf.jpg" width="30px"><span>MyronMeng</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æˆ‘ä»¬åº”è¯¥æ‹…å¿ƒã€æ›´è¿›ä¸€æ­¥ï¼Œè¿”å›æ‰€æœ‰å­ä»»åŠ¡çš„é”™è¯¯ã€‘è¿™ä¸€èŠ‚ï¼š
func main() {
    var g errgroup.Group
    var result = make([]error, 3)    &#47;&#47; å¯åŠ¨ç¬¬ä¸€ä¸ªå­ä»»åŠ¡,å®ƒæ‰§è¡ŒæˆåŠŸ
    g.Go(func() error {
        time.Sleep(5 * time.Second)
        fmt.Println(&quot;exec #1&quot;)
        result[0] = nil &#47;&#47; ä¿å­˜æˆåŠŸæˆ–è€…å¤±è´¥çš„ç»“æœ
        return nil    })
       ....
}

è¿™æ®µä»£ç å¤šä¸ª goroutine å†™åŒä¸€ä¸ª slice å¯¼è‡´ panic å—ï¼Ÿ</div>2023-04-27</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJv3HPde36ll9u5EpEIJyR9jMXE0K7pcuxOlf4HUcbs0po9nkicR0mbXlF1Vdoytj1vxSRCZJGOH7Q/132" width="30px"><span>æ„¤æ€’çš„å°çŒ¥ç</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>errorgroup 49-55 è¡Œ ä¸ºä»€ä¹ˆè¦ç”¨ go func(){} å»æ‰§è¡Œ g.Wait() å’Œ close(ch) å‘¢ï¼ŒæŒ‰ç†è¯´ä¸æ˜¯åº”è¯¥å µå¡ç­‰å¾…å®Œæˆå—ï¼Ÿ</div>2022-06-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/0a/65/9cd6d109.jpg" width="30px"><span>ç§‹æ™¨</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ä»»åŠ¡æ‰§è¡Œæµæ°´çº¿ Pipeline çš„ä¾‹å­ç¬¬44è¡Œï¼Œå¦‚æœå¤„ç†å¤±è´¥ï¼Œè¿”å›errï¼Œå½“å‰çš„goroutineæ˜¯å¦ä¼šé€€å‡ºå‘¢ï¼Œå¦‚æœä¼šé€€å‡ºçš„è¯ï¼Œå¼€å¯çš„goroutineæ•°é‡å°‘äºå¾…å¤„ç†çš„æ•°æ®é‡çš„è¯ï¼Œä¼šä¸ä¼šå‡ºç°å¾…å¤„ç†çš„æ•°æ®æ— goroutineå¤„ç†</div>2021-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/53/ec/3f6ae1aa.jpg" width="30px"><span>çš®å¡ä¸˜</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>cancelï¼Œå¤±è´¥çš„å­ä»»åŠ¡å¯ä»¥ cancel æ‰€æœ‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œè¿™å¥è¯æ˜¯ä¸æ˜¯æœ‰ç‚¹ç»å¯¹ï¼Œctxåªæ˜¯ä¼ é€’ä¿¡å·ï¼Œå¦‚æœcancelæ—¶ï¼Œè¿˜æœ‰å­ä»»åŠ¡çš„gouroutineæ²¡æœ‰è°ƒåº¦æˆ–è€…å†…éƒ¨è¿˜æ²¡æœ‰è¿è¡Œåˆ°ç›‘å¬ä¿¡å·æ‰ä¼šè¢«cancelæ‰</div>2020-11-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/69/bc/defd41a9.jpg" width="30px"><span>è€ç‹</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>ä½¿ç”¨ errgroup ä¿å­˜å¤šä¸ªé”™è¯¯çš„ä»£ç ï¼Œè¿è¡Œä¼šæŠ¥ data race å§</div>2020-12-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/30/49/f9e37ced.jpg" width="30px"><span>ä¼Ÿä¼Ÿ</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>package main

import (
	&quot;context&quot;
	&quot;fmt&quot;
	&quot;time&quot;

	&quot;golang.org&#47;x&#47;sync&#47;errgroup&quot;
)

type Data struct {
}

func getData() (*Data, error) {
	time.Sleep(3 * time.Second)
	return &amp;Data{}, nil
}

func main() {
	c, cancel := context.WithCancel(context.Background())
	defer cancel()
	g, ctx := errgroup.WithContext(c)

	datas := make(chan *Data, 10)

	g.Go(func() error {
		&#47;&#47; ä¸šåŠ¡é€»è¾‘
		data, err := getData()
		if err != nil {
			return err
		}

		select {
		case &lt;-ctx.Done():
			return ctx.Err()
		default:
		}
		datas &lt;- data
		return nil
	})

	go func() {
		time.Sleep(1 * time.Second)
		cancel()
	}()

	err := g.Wait()
	if err == nil {
		fmt.Println(&quot;success&quot;)
		return
	}
	fmt.Println(&quot;fail&quot;, err)
}
è¿™é‡Œç†è§£çš„æ˜¯å–æ¶ˆåšåœ¨ä¸šåŠ¡ç›¸å…³å±‚</div>2020-11-26</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/18/3e/89/77829168.jpg" width="30px"><span>fliyu</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>ErrGroupæ”¯æŒè®¾ç½®å¹¶å‘ä¸ªæ•°äº†ï¼Œå³æ–¹æ³•SetLimit</div>2022-11-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/b8/3c/1a294619.jpg" width="30px"><span>Panda</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>CSP æ˜¯é“   å¹¶å‘åŸè¯­æ˜¯æœ¯</div>2021-06-15</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/55/aa/e05a5778.jpg" width="30px"><span>æ­¦å®‰å›</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å†…å®¹ä¸°å¯Œã€å°†æˆ‘çš„å…µæ³•ç¼–ç¨‹ä¸²æˆäº†ä¸€ä¸ªè„‘å›¾ï¼æ›´ç³»ç»Ÿæ›´å…¨ï¼æ‰“é€šäº†å…³ç³»å›¾ã€å‰©ä¸‹çš„å°±æ˜¯è‡ªå·±å¥½å¥½ç ”è¯»æºç ã€å°†æŠ€æœ¯é©±åŠ¨ä¸šåŠ¡å³å¯ï¼è°¢è°¢è€å¸ˆï¼</div>2021-01-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/cf/cc/8de5007b.jpg" width="30px"><span>å¾æ”¹</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>package main

import (
	&quot;context&quot;
	&quot;errors&quot;
	&quot;fmt&quot;
	&quot;sync&quot;
	&quot;time&quot;
)

type errgroupWithCancel struct {
	wg sync.WaitGroup
	errs []string
}

func (egc * errgroupWithCancel) Go(exec func(ctx context.Context), ctx context.Context) {
	egc.wg.Add(1)
	go exec(ctx)
}

func (egc *errgroupWithCancel) Wait() {
	egc.wg.Wait()
}


func main() {
	ctx, cancelFunc := context.WithCancel(context.Background())
	egc := &amp;errgroupWithCancel{wg: sync.WaitGroup{}}
	egc.Go(func(ctx context.Context) {
		defer egc.wg.Done()
		select {
		case &lt;-ctx.Done():
			egc.errs = append(egc.errs, errors.New(&quot;cancel context&quot;).Error())
		case &lt;-time.After(time.Millisecond * 10):
			fmt.Println(&quot;work done&quot;)
		}
	}, ctx)
	time.Sleep(time.Millisecond * 15)
	cancelFunc()
	egc.Wait()
	if len(egc.errs) &gt; 0 {
		for _, err := range egc.errs {
			fmt.Println(err)
		}
	} else {
		fmt.Println(&quot;finish work&quot;)
	}
}
</div>2022-02-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/19/22/c8/f2892022.jpg" width="30px"><span>ç§‘ç§‘</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å¾ˆå¼ºå¤§ï¼Œæ”¶è—äº†ï¼Œä¹‹åæœ‰æ—¶é—´ä¼šæŠŠæºç éƒ½æ‹¿å‡ºæ¥ä»”ç»†çœ‹çœ‹çš„ï¼ŒçœŸæ˜¯å¾ˆå¼ºå¤§çš„å·¥å…·</div>2021-05-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/17/6e/76b4aa3d.jpg" width="30px"><span>æ©™å­888</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>æ‰“å¡ã€‚</div>2020-11-20</li><br/>
</ul>