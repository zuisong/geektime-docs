ä½ å¥½ï¼Œæˆ‘æ˜¯é¸Ÿçªã€‚

å…±äº«èµ„æºä¿æŠ¤ã€ä»»åŠ¡ç¼–æ’å’Œæ¶ˆæ¯ä¼ é€’æ˜¯Goå¹¶å‘ç¼–ç¨‹ä¸­å¸¸è§çš„åœºæ™¯ï¼Œè€Œ**åˆ†ç»„æ‰§è¡Œä¸€æ‰¹ç›¸åŒçš„æˆ–ç±»ä¼¼çš„ä»»åŠ¡åˆ™æ˜¯ä»»åŠ¡ç¼–æ’ä¸­ä¸€ç±»æƒ…å½¢**ï¼Œæ‰€ä»¥ï¼Œè¿™èŠ‚è¯¾ï¼Œæˆ‘ä¸“é—¨æ¥ä»‹ç»ä¸€ä¸‹åˆ†ç»„ç¼–æ’çš„ä¸€äº›å¸¸ç”¨åœºæ™¯å’Œå¹¶å‘åŸè¯­ï¼ŒåŒ…æ‹¬ErrGroupã€gollbackã€Hunchå’Œschedgroupã€‚

æˆ‘ä»¬å…ˆæ¥å­¦ä¹ ä¸€ç±»éå¸¸å¸¸ç”¨çš„å¹¶å‘åŸè¯­ï¼Œé‚£å°±æ˜¯ErrGroupã€‚

# ErrGroup

[ErrGroup](https://github.com/golang/sync/tree/master/errgroup)æ˜¯Goå®˜æ–¹æä¾›çš„ä¸€ä¸ªåŒæ­¥æ‰©å±•åº“ã€‚æˆ‘ä»¬ç»å¸¸ä¼šç¢°åˆ°éœ€è¦å°†ä¸€ä¸ªé€šç”¨çš„çˆ¶ä»»åŠ¡æ‹†æˆå‡ ä¸ªå°ä»»åŠ¡å¹¶å‘æ‰§è¡Œçš„åœºæ™¯ï¼Œå…¶å®ï¼Œå°†ä¸€ä¸ªå¤§çš„ä»»åŠ¡æ‹†æˆå‡ ä¸ªå°ä»»åŠ¡å¹¶å‘æ‰§è¡Œï¼Œå¯ä»¥æœ‰æ•ˆåœ°æé«˜ç¨‹åºçš„å¹¶å‘åº¦ã€‚å°±åƒä½ åœ¨å¨æˆ¿åšé¥­ä¸€æ ·ï¼Œä½ å¯ä»¥åœ¨è’¸ç±³é¥­çš„åŒæ—¶ç‚’å‡ ä¸ªå°èœï¼Œç±³é¥­è’¸å¥½äº†ï¼ŒèœåŒæ—¶ä¹Ÿåšå¥½äº†ï¼Œå¾ˆå¿«å°±èƒ½åƒåˆ°å¯å£çš„é¥­èœã€‚

ErrGroupå°±æ˜¯ç”¨æ¥åº”å¯¹è¿™ç§åœºæ™¯çš„ã€‚å®ƒå’ŒWaitGroupæœ‰äº›ç±»ä¼¼ï¼Œä½†æ˜¯å®ƒæä¾›åŠŸèƒ½æ›´åŠ ä¸°å¯Œï¼š

- å’ŒContexté›†æˆï¼›
- errorå‘ä¸Šä¼ æ’­ï¼Œå¯ä»¥æŠŠå­ä»»åŠ¡çš„é”™è¯¯ä¼ é€’ç»™Waitçš„è°ƒç”¨è€…ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘æ¥ç»™ä½ ä»‹ç»ä¸€ä¸‹ErrGroupçš„åŸºæœ¬ç”¨æ³•å’Œå‡ ç§åº”ç”¨åœºæ™¯ã€‚

## åŸºæœ¬ç”¨æ³•

golang.org/x/sync/errgroupåŒ…ä¸‹å®šä¹‰äº†ä¸€ä¸ªGroup structï¼Œå®ƒå°±æ˜¯æˆ‘ä»¬è¦ä»‹ç»çš„ErrGroupå¹¶å‘åŸè¯­ï¼Œåº•å±‚ä¹Ÿæ˜¯åŸºäºWaitGroupå®ç°çš„ã€‚

åœ¨ä½¿ç”¨ErrGroupæ—¶ï¼Œæˆ‘ä»¬è¦ç”¨åˆ°ä¸‰ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯WithContextã€Goå’ŒWaitã€‚

**1.WithContext**

åœ¨åˆ›å»ºä¸€ä¸ªGroupå¯¹è±¡æ—¶ï¼Œéœ€è¦ä½¿ç”¨WithContextæ–¹æ³•ï¼š

```
func WithContext(ctx context.Context) (*Group, context.Context)
```

è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªGroupå®ä¾‹ï¼ŒåŒæ—¶è¿˜ä¼šè¿”å›ä¸€ä¸ªä½¿ç”¨context.WithCancel(ctx)ç”Ÿæˆçš„æ–°Contextã€‚ä¸€æ—¦æœ‰ä¸€ä¸ªå­ä»»åŠ¡è¿”å›é”™è¯¯ï¼Œæˆ–è€…æ˜¯Waitè°ƒç”¨è¿”å›ï¼Œè¿™ä¸ªæ–°Contextå°±ä¼šè¢«cancelã€‚

Groupçš„é›¶å€¼ä¹Ÿæ˜¯åˆæ³•çš„ï¼Œåªä¸è¿‡ï¼Œä½ å°±æ²¡æœ‰ä¸€ä¸ªå¯ä»¥ç›‘æ§æ˜¯å¦cancelçš„Contextäº†ã€‚

æ³¨æ„ï¼Œå¦‚æœä¼ é€’ç»™WithContextçš„ctxå‚æ•°ï¼Œæ˜¯ä¸€ä¸ªå¯ä»¥cancelçš„Contextçš„è¯ï¼Œé‚£ä¹ˆï¼Œå®ƒè¢«cancelçš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šç»ˆæ­¢æ­£åœ¨æ‰§è¡Œçš„å­ä»»åŠ¡ã€‚

**2.Go**

æˆ‘ä»¬å†æ¥å­¦ä¹ ä¸‹æ‰§è¡Œå­ä»»åŠ¡çš„Goæ–¹æ³•ï¼š

```
func (g *Group) Go(f func() error)
```

ä¼ å…¥çš„å­ä»»åŠ¡å‡½æ•°fæ˜¯ç±»å‹ä¸ºfunc() errorçš„å‡½æ•°ï¼Œå¦‚æœä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œå°±è¿”å›nilï¼Œå¦åˆ™å°±è¿”å›errorï¼Œå¹¶ä¸”ä¼šcancel é‚£ä¸ªæ–°çš„Contextã€‚

ä¸€ä¸ªä»»åŠ¡å¯ä»¥åˆ†æˆå¥½å¤šä¸ªå­ä»»åŠ¡ï¼Œè€Œä¸”ï¼Œå¯èƒ½æœ‰å¤šä¸ªå­ä»»åŠ¡æ‰§è¡Œå¤±è´¥è¿”å›errorï¼Œä¸è¿‡ï¼ŒWaitæ–¹æ³•åªä¼šè¿”å›ç¬¬ä¸€ä¸ªé”™è¯¯ï¼Œæ‰€ä»¥ï¼Œå¦‚æœæƒ³è¿”å›æ‰€æœ‰çš„é”™è¯¯ï¼Œéœ€è¦ç‰¹åˆ«çš„å¤„ç†ï¼Œæˆ‘å…ˆç•™ä¸ªå°æ‚¬å¿µï¼Œä¸€ä¼šå„¿å†è®²ã€‚

**3.Wait**

ç±»ä¼¼WaitGroupï¼ŒGroupä¹Ÿæœ‰Waitæ–¹æ³•ï¼Œç­‰æ‰€æœ‰çš„å­ä»»åŠ¡éƒ½å®Œæˆåï¼Œå®ƒæ‰ä¼šè¿”å›ï¼Œå¦åˆ™åªä¼šé˜»å¡ç­‰å¾…ã€‚å¦‚æœæœ‰å¤šä¸ªå­ä»»åŠ¡è¿”å›é”™è¯¯ï¼Œå®ƒåªä¼šè¿”å›ç¬¬ä¸€ä¸ªå‡ºç°çš„é”™è¯¯ï¼Œå¦‚æœæ‰€æœ‰çš„å­ä»»åŠ¡éƒ½æ‰§è¡ŒæˆåŠŸï¼Œå°±è¿”å›nilï¼š

```
func (g *Group) Wait() error
```

## ErrGroupä½¿ç”¨ä¾‹å­

å¥½äº†ï¼ŒçŸ¥é“äº†åŸºæœ¬ç”¨æ³•ï¼Œä¸‹é¢æˆ‘æ¥ç»™ä½ ä»‹ç»å‡ ä¸ªä¾‹å­ï¼Œå¸®åŠ©ä½ å…¨é¢åœ°æŒæ¡ErrGroupçš„ä½¿ç”¨æ–¹æ³•å’Œåº”ç”¨åœºæ™¯ã€‚

### ç®€å•ä¾‹å­ï¼šè¿”å›ç¬¬ä¸€ä¸ªé”™è¯¯

å…ˆæ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¯åŠ¨äº†ä¸‰ä¸ªå­ä»»åŠ¡ï¼Œå…¶ä¸­ï¼Œå­ä»»åŠ¡2ä¼šè¿”å›æ‰§è¡Œå¤±è´¥ï¼Œå…¶å®ƒä¸¤ä¸ªæ‰§è¡ŒæˆåŠŸã€‚åœ¨ä¸‰ä¸ªå­ä»»åŠ¡éƒ½æ‰§è¡Œåï¼Œgroup.Waitæ‰ä¼šè¿”å›ç¬¬2ä¸ªå­ä»»åŠ¡çš„é”™è¯¯ã€‚

```
package main


import (
    "errors"
    "fmt"
    "time"

    "golang.org/x/sync/errgroup"
)

func main() {
    var g errgroup.Group


    // å¯åŠ¨ç¬¬ä¸€ä¸ªå­ä»»åŠ¡,å®ƒæ‰§è¡ŒæˆåŠŸ
    g.Go(func() error {
        time.Sleep(5 * time.Second)
        fmt.Println("exec #1")
        return nil
    })
    // å¯åŠ¨ç¬¬äºŒä¸ªå­ä»»åŠ¡ï¼Œå®ƒæ‰§è¡Œå¤±è´¥
    g.Go(func() error {
        time.Sleep(10 * time.Second)
        fmt.Println("exec #2")
        return errors.New("failed to exec #2")
    })

    // å¯åŠ¨ç¬¬ä¸‰ä¸ªå­ä»»åŠ¡ï¼Œå®ƒæ‰§è¡ŒæˆåŠŸ
    g.Go(func() error {
        time.Sleep(15 * time.Second)
        fmt.Println("exec #3")
        return nil
    })
    // ç­‰å¾…ä¸‰ä¸ªä»»åŠ¡éƒ½å®Œæˆ
    if err := g.Wait(); err == nil {
        fmt.Println("Successfully exec all")
    } else {
        fmt.Println("failed:", err)
    }
}
```

å¦‚æœæ‰§è¡Œä¸‹é¢çš„è¿™ä¸ªç¨‹åºï¼Œä¼šæ˜¾ç¤ºä¸‰ä¸ªä»»åŠ¡éƒ½æ‰§è¡Œäº†ï¼Œè€ŒWaitè¿”å›äº†å­ä»»åŠ¡2çš„é”™è¯¯ï¼š

![](https://static001.geekbang.org/resource/image/92/11/92d746f7a1ab943e73b83796fb436a11.png?wh=782%2A129)

### æ›´è¿›ä¸€æ­¥ï¼Œè¿”å›æ‰€æœ‰å­ä»»åŠ¡çš„é”™è¯¯

Groupåªèƒ½è¿”å›å­ä»»åŠ¡çš„ç¬¬ä¸€ä¸ªé”™è¯¯ï¼Œåç»­çš„é”™è¯¯éƒ½ä¼šè¢«ä¸¢å¼ƒã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦çŸ¥é“æ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µã€‚æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨ç¨å¾®æœ‰ç‚¹æ›²æŠ˜çš„æ–¹å¼å»å®ç°ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªresult sliceä¿å­˜å­ä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œè¿™æ ·ï¼Œé€šè¿‡æŸ¥è¯¢resultï¼Œå°±å¯ä»¥çŸ¥é“æ¯ä¸€ä¸ªå­ä»»åŠ¡çš„ç»“æœäº†ã€‚

ä¸‹é¢çš„è¿™ä¸ªä¾‹å­ï¼Œå°±æ˜¯ä½¿ç”¨resultè®°å½•æ¯ä¸ªå­ä»»åŠ¡æˆåŠŸæˆ–å¤±è´¥çš„ç»“æœã€‚å…¶å®ï¼Œä½ ä¸ä»…å¯ä»¥ä½¿ç”¨resultè®°å½•errorä¿¡æ¯ï¼Œè¿˜å¯ä»¥ç”¨å®ƒè®°å½•è®¡ç®—ç»“æœã€‚

```
package main

import (
    "errors"
    "fmt"
    "time"

    "golang.org/x/sync/errgroup"
)

func main() {
    var g errgroup.Group
    var result = make([]error, 3)

    // å¯åŠ¨ç¬¬ä¸€ä¸ªå­ä»»åŠ¡,å®ƒæ‰§è¡ŒæˆåŠŸ
    g.Go(func() error {
        time.Sleep(5 * time.Second)
        fmt.Println("exec #1")
        result[0] = nil // ä¿å­˜æˆåŠŸæˆ–è€…å¤±è´¥çš„ç»“æœ
        return nil
    })


    // å¯åŠ¨ç¬¬äºŒä¸ªå­ä»»åŠ¡ï¼Œå®ƒæ‰§è¡Œå¤±è´¥
    g.Go(func() error {
        time.Sleep(10 * time.Second)
        fmt.Println("exec #2")

        result[1] = errors.New("failed to exec #2") // ä¿å­˜æˆåŠŸæˆ–è€…å¤±è´¥çš„ç»“æœ
        return result[1]
    })

    // å¯åŠ¨ç¬¬ä¸‰ä¸ªå­ä»»åŠ¡ï¼Œå®ƒæ‰§è¡ŒæˆåŠŸ
    g.Go(func() error {
        time.Sleep(15 * time.Second)
        fmt.Println("exec #3")
        result[2] = nil // ä¿å­˜æˆåŠŸæˆ–è€…å¤±è´¥çš„ç»“æœ
        return nil
    })

    if err := g.Wait(); err == nil {
        fmt.Printf("Successfully exec all. result: %v\n", result)
    } else {
        fmt.Printf("failed: %v\n", result)
    }
}
```

### ä»»åŠ¡æ‰§è¡Œæµæ°´çº¿Pipeline

Goå®˜æ–¹æ–‡æ¡£ä¸­è¿˜æä¾›äº†ä¸€ä¸ªpipelineçš„ä¾‹å­ã€‚è¿™ä¸ªä¾‹å­æ˜¯è¯´ï¼Œç”±ä¸€ä¸ªå­ä»»åŠ¡éå†æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ï¼Œç„¶åæŠŠéå†å‡ºçš„æ–‡ä»¶äº¤ç»™20ä¸ªgoroutineï¼Œè®©è¿™äº›goroutineå¹¶è¡Œè®¡ç®—æ–‡ä»¶çš„md5ã€‚

è¿™ä¸ªä¾‹å­ä¸­çš„è®¡ç®—é€»è¾‘ä½ ä¸éœ€è¦é‡ç‚¹æŒæ¡ï¼Œæˆ‘æ¥æŠŠè¿™ä¸ªä¾‹å­ç®€åŒ–ä¸€ä¸‹ï¼ˆå¦‚æœä½ æƒ³çœ‹åŸå§‹çš„ä»£ç ï¼Œå¯ä»¥çœ‹[è¿™é‡Œ](https://godoc.org/golang.org/x/sync/errgroup#example-Group--Pipeline)ï¼‰ï¼š

```
package main

import (
   ......
    "golang.org/x/sync/errgroup"
)

// ä¸€ä¸ªå¤šé˜¶æ®µçš„pipeline.ä½¿ç”¨æœ‰é™çš„goroutineè®¡ç®—æ¯ä¸ªæ–‡ä»¶çš„md5å€¼.
func main() {
    m, err := MD5All(context.Background(), ".")
    if err != nil {
        log.Fatal(err)
    }

    for k, sum := range m {
        fmt.Printf("%s:\t%x\n", k, sum)
    }
}

type result struct {
    path string
    sum  [md5.Size]byte
}

// éå†æ ¹ç›®å½•ä¸‹æ‰€æœ‰çš„æ–‡ä»¶å’Œå­æ–‡ä»¶å¤¹,è®¡ç®—å®ƒä»¬çš„md5çš„å€¼.
func MD5All(ctx context.Context, root string) (map[string][md5.Size]byte, error) {
    g, ctx := errgroup.WithContext(ctx)
    paths := make(chan string) // æ–‡ä»¶è·¯å¾„channel

    g.Go(func() error {
        defer close(paths) // éå†å®Œå…³é—­paths chan
        return filepath.Walk(root, func(path string, info os.FileInfo, err error) error {
            ...... //å°†æ–‡ä»¶è·¯å¾„æ”¾å…¥åˆ°paths
            return nil
        })
    })

    // å¯åŠ¨20ä¸ªgoroutineæ‰§è¡Œè®¡ç®—md5çš„ä»»åŠ¡ï¼Œè®¡ç®—çš„æ–‡ä»¶ç”±ä¸Šä¸€é˜¶æ®µçš„æ–‡ä»¶éå†å­ä»»åŠ¡ç”Ÿæˆ.
    c := make(chan result)
    const numDigesters = 20
    for i := 0; i < numDigesters; i++ {
        g.Go(func() error {
            for path := range paths { // éå†ç›´åˆ°paths chanè¢«å…³é—­
                ...... // è®¡ç®—pathçš„md5å€¼ï¼Œæ”¾å…¥åˆ°cä¸­
            }
            return nil
        })
    }
    go func() {
        g.Wait() // 20ä¸ªgoroutineä»¥åŠéå†æ–‡ä»¶çš„goroutineéƒ½æ‰§è¡Œå®Œ
        close(c) // å…³é—­æ”¶é›†ç»“æœçš„chan
    }()


    m := make(map[string][md5.Size]byte)
    for r := range c { // å°†md5ç»“æœä»chanä¸­è¯»å–åˆ°mapä¸­,ç›´åˆ°cè¢«å…³é—­æ‰é€€å‡º
        m[r.path] = r.sum
    }

    // å†æ¬¡è°ƒç”¨Waitï¼Œä¾ç„¶å¯ä»¥å¾—åˆ°groupçš„errorä¿¡æ¯
    if err := g.Wait(); err != nil {
        return nil, err
    }
    return m, nil
}
```

é€šè¿‡è¿™ä¸ªä¾‹å­ï¼Œä½ å¯ä»¥å­¦ä¹ åˆ°å¤šé˜¶æ®µpipelineçš„å®ç°ï¼ˆè¿™ä¸ªä¾‹å­æ˜¯éå†æ–‡ä»¶å¤¹å’Œè®¡ç®—md5ä¸¤ä¸ªé˜¶æ®µï¼‰ï¼Œè¿˜å¯ä»¥å­¦ä¹ åˆ°å¦‚ä½•æ§åˆ¶æ‰§è¡Œå­ä»»åŠ¡çš„goroutineæ•°é‡ã€‚

å¾ˆå¤šå…¬å¸éƒ½åœ¨ä½¿ç”¨ErrGroupå¤„ç†å¹¶å‘å­ä»»åŠ¡ï¼Œæ¯”å¦‚Facebookã€bilibiliç­‰å…¬å¸çš„ä¸€äº›é¡¹ç›®ï¼Œä½†æ˜¯ï¼Œè¿™äº›å…¬å¸åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œå‘ç°äº†ä¸€äº›ä¸æ–¹ä¾¿çš„åœ°æ–¹ï¼Œæˆ–è€…è¯´ï¼Œå®˜æ–¹çš„ErrGroupçš„åŠŸèƒ½è¿˜ä¸å¤Ÿä¸°å¯Œã€‚æ‰€ä»¥ï¼Œä»–ä»¬éƒ½å¯¹ErrGroupè¿›è¡Œäº†æ‰©å±•ã€‚æ¥ä¸‹æ¥å‘¢ï¼Œæˆ‘å°±å¸¦ä½ çœ‹çœ‹å‡ ä¸ªæ‰©å±•åº“ã€‚

## æ‰©å±•åº“

### [bilibili/errgroup](https://godoc.org/github.com/bilibili/kratos/pkg/sync/errgroup)

å¦‚æœæˆ‘ä»¬æ— é™åˆ¶åœ°ç›´æ¥è°ƒç”¨ErrGroupçš„Goæ–¹æ³•ï¼Œå°±å¯èƒ½ä¼šåˆ›å»ºå‡ºéå¸¸å¤šçš„goroutineï¼Œå¤ªå¤šçš„goroutineä¼šå¸¦æ¥è°ƒåº¦å’ŒGCçš„å‹åŠ›ï¼Œè€Œä¸”ä¹Ÿä¼šå ç”¨æ›´å¤šçš„å†…å­˜èµ„æºã€‚å°±åƒ[go#34457](https://github.com/golang/go/issues/34457)æŒ‡å‡ºçš„é‚£æ ·ï¼Œå½“å‰Goè¿è¡Œæ—¶åˆ›å»ºçš„gå¯¹è±¡åªä¼šå¢é•¿å’Œé‡ç”¨ï¼Œä¸ä¼šå›æ”¶ï¼Œæ‰€ä»¥åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œä¹Ÿè¦å°½å¯èƒ½å‡å°‘goroutineçš„ä½¿ç”¨ã€‚

å¸¸ç”¨çš„ä¸€ä¸ªæ‰‹æ®µå°±æ˜¯ä½¿ç”¨worker pool(goroutine pool)ï¼Œæˆ–è€…æ˜¯ç±»ä¼¼[containerd/stargz-snapshotter](https://github.com/containerd/stargz-snapshotter/pull/157)çš„æ–¹æ¡ˆï¼Œä½¿ç”¨å‰é¢æˆ‘ä»¬è®²çš„ä¿¡å·é‡ï¼Œä¿¡å·é‡çš„èµ„æºçš„æ•°é‡å°±æ˜¯å¯ä»¥å¹¶è¡Œçš„goroutineçš„æ•°é‡ã€‚ä½†æ˜¯åœ¨è¿™ä¸€è®²ï¼Œæˆ‘æ¥ä»‹ç»ä¸€äº›å…¶å®ƒçš„æ‰‹æ®µï¼Œæ¯”å¦‚ä¸‹é¢ä»‹ç»çš„bilibiliå®ç°çš„errgroupã€‚

bilibiliå®ç°äº†ä¸€ä¸ªæ‰©å±•çš„ErrGroupï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå›ºå®šæ•°é‡çš„goroutineå¤„ç†å­ä»»åŠ¡ã€‚å¦‚æœä¸è®¾ç½®goroutineçš„æ•°é‡ï¼Œé‚£ä¹ˆæ¯ä¸ªå­ä»»åŠ¡éƒ½ä¼šæ¯”è¾ƒâ€œæ”¾è‚†åœ°â€åˆ›å»ºä¸€ä¸ªgoroutineå¹¶å‘æ‰§è¡Œã€‚

è¿™ä¸ªé“¾æ¥é‡Œçš„æ–‡æ¡£å·²ç»å¾ˆè¯¦ç»†åœ°ä»‹ç»äº†å®ƒçš„å‡ ä¸ªæ‰©å±•åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘å°±ä¸é€šè¿‡ç¤ºä¾‹çš„æ–¹å¼æ¥è¿›è¡Œè®²è§£äº†ã€‚

é™¤äº†å¯ä»¥æ§åˆ¶å¹¶å‘goroutineçš„æ•°é‡ï¼Œå®ƒè¿˜æä¾›äº†2ä¸ªåŠŸèƒ½ï¼š

1. cancelï¼Œå¤±è´¥çš„å­ä»»åŠ¡å¯ä»¥cancelæ‰€æœ‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼›
2. recoverï¼Œè€Œä¸”ä¼šæŠŠpanicçš„å †æ ˆä¿¡æ¯æ”¾åˆ°errorä¸­ï¼Œé¿å…å­ä»»åŠ¡panicå¯¼è‡´çš„ç¨‹åºå´©æºƒã€‚

ä½†æ˜¯ï¼Œæœ‰ä¸€ç‚¹ä¸å¤ªå¥½çš„åœ°æ–¹å°±æ˜¯ï¼Œä¸€æ—¦ä½ è®¾ç½®äº†å¹¶å‘æ•°ï¼Œè¶…è¿‡å¹¶å‘æ•°çš„å­ä»»åŠ¡éœ€è¦ç­‰åˆ°è°ƒç”¨è€…è°ƒç”¨Waitä¹‹åæ‰ä¼šæ‰§è¡Œï¼Œè€Œä¸æ˜¯åªè¦goroutineç©ºé—²ä¸‹æ¥ï¼Œå°±å»æ‰§è¡Œã€‚å¦‚æœä¸æ³¨æ„è¿™ä¸€ç‚¹çš„è¯ï¼Œå¯èƒ½ä¼šå‡ºç°å­ä»»åŠ¡ä¸èƒ½åŠæ—¶å¤„ç†çš„æƒ…å†µï¼Œè¿™æ˜¯è¿™ä¸ªåº“å¯ä»¥ä¼˜åŒ–çš„ä¸€ç‚¹ã€‚

å¦å¤–ï¼Œè¿™ä¸ªåº“å…¶å®æ˜¯æœ‰ä¸€ä¸ªå¹¶å‘é—®é¢˜çš„ã€‚åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä»»åŠ¡æ•°å¤§äºè®¾å®šçš„goroutineçš„æ•°é‡ï¼Œå¹¶ä¸”è¿™äº›ä»»åŠ¡è¢«é›†ä¸­åŠ å…¥åˆ°Groupä¸­ï¼Œè¿™ä¸ªåº“çš„å¤„ç†æ–¹å¼æ˜¯æŠŠå­ä»»åŠ¡åŠ å…¥åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œä½†æ˜¯ï¼Œè¿™ä¸ªæ•°ç»„ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæœ‰å¹¶å‘é—®é¢˜ï¼Œé—®é¢˜å°±åœ¨äºï¼Œä¸‹é¢å›¾ç‰‡ä¸­çš„æ ‡è®°ä¸º96è¡Œçš„é‚£ä¸€è¡Œï¼Œè¿™ä¸€è¡Œå¯¹sliceçš„appendæ“ä½œä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼š

![](https://static001.geekbang.org/resource/image/ef/5b/ef65c08c041f7b98c71e461f1497bc5b.png?wh=835%2A348)

æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªç®€å•çš„ç¨‹åºæ¥æµ‹è¯•è¿™ä¸ªé—®é¢˜ï¼š

```
package main

import (
    "context"
    "fmt"
    "sync/atomic"
    "time"

    "github.com/bilibili/kratos/pkg/sync/errgroup"
)

func main() {
    var g errgroup.Group
    g.GOMAXPROCS(1) // åªä½¿ç”¨ä¸€ä¸ªgoroutineå¤„ç†å­ä»»åŠ¡

    var count int64
    g.Go(func(ctx context.Context) error {
        time.Sleep(time.Second) //ç¡çœ 5ç§’ï¼ŒæŠŠè¿™ä¸ªgoroutineå ä½
        return nil
    })

    total := 10000

    for i := 0; i < total; i++ { // å¹¶å‘ä¸€ä¸‡ä¸ªgoroutineæ‰§è¡Œå­ä»»åŠ¡ï¼Œç†è®ºä¸Šè¿™äº›å­ä»»åŠ¡éƒ½ä¼šåŠ å…¥åˆ°Groupçš„å¾…å¤„ç†åˆ—è¡¨ä¸­
        go func() {
            g.Go(func(ctx context.Context) error {
                atomic.AddInt64(&count, 1)
                return nil
            })
        }()
    }

    // ç­‰å¾…æ‰€æœ‰çš„å­ä»»åŠ¡å®Œæˆã€‚ç†è®ºä¸Š10001ä¸ªå­ä»»åŠ¡éƒ½ä¼šè¢«å®Œæˆ
    if err := g.Wait(); err != nil {
        panic(err)
    }

    got := atomic.LoadInt64(&count)
    if got != int64(total) {
        panic(fmt.Sprintf("expect %d but got %d", total, got))
    }
}
```

è¿è¡Œè¿™ä¸ªç¨‹åºçš„è¯ï¼Œä½ å°±ä¼šå‘ç°æ­»é”é—®é¢˜ï¼Œå› ä¸ºæˆ‘ä»¬çš„æµ‹è¯•ç¨‹åºæ˜¯ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç¨‹åºé€€å‡ºçš„æ—¶å€™ï¼ŒGo runtimeèƒ½æ£€æµ‹åˆ°æ­»é”é—®é¢˜ã€‚å¦‚æœæ˜¯ä¸€ç›´è¿è¡Œçš„æœåŠ¡å™¨ç¨‹åºï¼Œæ­»é”é—®é¢˜æœ‰å¯èƒ½æ˜¯æ£€æµ‹ä¸å‡ºæ¥çš„ï¼Œç¨‹åºä¸€ç›´ä¼šhangåœ¨Waitçš„è°ƒç”¨ä¸Šã€‚

### [neilotoole/errgroup](https://github.com/neilotoole/errgroup)

neilotoole/errgroupæ˜¯ä»Šå¹´å¹´ä¸­æ–°å‡ºç°çš„ä¸€ä¸ªErrGroupæ‰©å±•åº“ï¼Œå®ƒå¯ä»¥ç›´æ¥æ›¿æ¢å®˜æ–¹çš„ErrGroupï¼Œæ–¹æ³•éƒ½ä¸€æ ·ï¼ŒåŸæœ‰åŠŸèƒ½ä¹Ÿä¸€æ ·ï¼Œåªä¸è¿‡**å¢åŠ äº†å¯ä»¥æ§åˆ¶å¹¶å‘goroutineçš„åŠŸèƒ½**ã€‚å®ƒçš„æ–¹æ³•é›†å¦‚ä¸‹ï¼š

```
type Group
  func WithContext(ctx context.Context) (*Group, context.Context)
  func WithContextN(ctx context.Context, numG, qSize int) (*Group, context.Context)
  func (g *Group) Go(f func() error)
  func (g *Group) Wait() error
```

æ–°å¢åŠ çš„æ–¹æ³•WithContextNï¼Œå¯ä»¥è®¾ç½®å¹¶å‘çš„goroutineæ•°ï¼Œä»¥åŠç­‰å¾…å¤„ç†çš„å­ä»»åŠ¡é˜Ÿåˆ—çš„å¤§å°ã€‚å½“é˜Ÿåˆ—æ»¡çš„æ—¶å€™ï¼Œå¦‚æœè°ƒç”¨Goæ–¹æ³•ï¼Œå°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å­ä»»åŠ¡å¯ä»¥æ”¾å…¥åˆ°é˜Ÿåˆ—ä¸­æ‰è¿”å›ã€‚å¦‚æœä½ ä¼ ç»™è¿™ä¸¤ä¸ªå‚æ•°çš„å€¼ä¸æ˜¯æ­£æ•´æ•°ï¼Œå®ƒå°±ä¼šä½¿ç”¨runtime.NumCPUä»£æ›¿ä½ ä¼ å…¥çš„å‚æ•°ã€‚

å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠbilibiliçš„recoveråŠŸèƒ½æ‰©å±•åˆ°è¿™ä¸ªåº“ä¸­ï¼Œä»¥é¿å…å­ä»»åŠ¡çš„panicå¯¼è‡´ç¨‹åºå´©æºƒã€‚

### [facebookgo/errgroup](https://github.com/facebookarchive/errgroup)

Facebookæä¾›çš„è¿™ä¸ªErrGroupï¼Œå…¶å®å¹¶ä¸æ˜¯å¯¹Goæ‰©å±•åº“ErrGroupçš„æ‰©å±•ï¼Œè€Œæ˜¯å¯¹æ ‡å‡†åº“WaitGroupçš„æ‰©å±•ã€‚ä¸è¿‡ï¼Œå› ä¸ºå®ƒä»¬çš„åå­—ä¸€æ ·ï¼Œå¤„ç†çš„åœºæ™¯ä¹Ÿç±»ä¼¼ï¼Œæ‰€ä»¥æˆ‘æŠŠå®ƒä¹Ÿåˆ—åœ¨äº†è¿™é‡Œã€‚

æ ‡å‡†åº“çš„WaitGroupåªæä¾›äº†Addã€Doneã€Waitæ–¹æ³•ï¼Œè€Œä¸”Waitæ–¹æ³•ä¹Ÿæ²¡æœ‰è¿”å›å­goroutineçš„errorã€‚è€ŒFacebookæä¾›çš„ErrGroupæä¾›çš„Waitæ–¹æ³•å¯ä»¥è¿”å›errorï¼Œè€Œä¸”å¯ä»¥åŒ…å«å¤šä¸ªerrorã€‚å­ä»»åŠ¡åœ¨è°ƒç”¨Doneä¹‹å‰ï¼Œå¯ä»¥æŠŠè‡ªå·±çš„errorä¿¡æ¯è®¾ç½®ç»™ErrGroupã€‚æ¥ç€ï¼ŒWaitåœ¨è¿”å›çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠè¿™äº›errorä¿¡æ¯è¿”å›ç»™è°ƒç”¨è€…ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸‹Groupçš„æ–¹æ³•ï¼š

```
type Group
  func (g *Group) Add(delta int)
  func (g *Group) Done()
  func (g *Group) Error(e error)
  func (g *Group) Wait() error
```

å…³äºWaitæ–¹æ³•ï¼Œæˆ‘åˆšåˆšå·²ç»ä»‹ç»äº†å®ƒå’Œæ ‡å‡†åº“WaitGroupçš„ä¸åŒï¼Œæˆ‘å°±ä¸å¤šè¯´äº†ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªä¸åŒçš„æ–¹æ³•ï¼Œå°±æ˜¯Erroræ–¹æ³•ï¼Œ

æˆ‘ä¸¾ä¸ªä¾‹å­æ¼”ç¤ºä¸€ä¸‹Errorçš„ä½¿ç”¨æ–¹æ³•ã€‚

åœ¨ä¸‹é¢çš„è¿™ä¸ªä¾‹å­ä¸­ï¼Œç¬¬26è¡Œçš„å­goroutineè®¾ç½®äº†errorä¿¡æ¯ï¼Œç¬¬39è¡Œä¼šæŠŠè¿™ä¸ªerrorä¿¡æ¯è¾“å‡ºå‡ºæ¥ã€‚

```
package main

import (
    "errors"
    "fmt"
    "time"

    "github.com/facebookgo/errgroup"
)

func main() {
    var g errgroup.Group
    g.Add(3)

    // å¯åŠ¨ç¬¬ä¸€ä¸ªå­ä»»åŠ¡,å®ƒæ‰§è¡ŒæˆåŠŸ
    go func() {
        time.Sleep(5 * time.Second)
        fmt.Println("exec #1")
        g.Done()
    }()

    // å¯åŠ¨ç¬¬äºŒä¸ªå­ä»»åŠ¡ï¼Œå®ƒæ‰§è¡Œå¤±è´¥
    go func() {
        time.Sleep(10 * time.Second)
        fmt.Println("exec #2")
        g.Error(errors.New("failed to exec #2"))
        g.Done()
    }()

    // å¯åŠ¨ç¬¬ä¸‰ä¸ªå­ä»»åŠ¡ï¼Œå®ƒæ‰§è¡ŒæˆåŠŸ
    go func() {
        time.Sleep(15 * time.Second)
        fmt.Println("exec #3")
        g.Done()
    }()

    // ç­‰å¾…æ‰€æœ‰çš„goroutineå®Œæˆï¼Œå¹¶æ£€æŸ¥error
    if err := g.Wait(); err == nil {
        fmt.Println("Successfully exec all")
    } else {
        fmt.Println("failed:", err)
    }
}
```

å…³äºErrGroupï¼Œä½ æŒæ¡è¿™äº›å°±è¶³å¤Ÿäº†ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘å†ä»‹ç»å‡ ç§æœ‰è¶£è€Œå®ç”¨çš„Groupå¹¶å‘åŸè¯­ã€‚è¿™äº›å¹¶å‘åŸè¯­éƒ½æ˜¯æ§åˆ¶ä¸€ç»„å­goroutineæ‰§è¡Œçš„é¢å‘ç‰¹å®šåœºæ™¯çš„å¹¶å‘åŸè¯­ï¼Œå½“ä½ é‡è§è¿™äº›ç‰¹å®šåœºæ™¯æ—¶ï¼Œå°±å¯ä»¥å‚è€ƒè¿™äº›åº“ã€‚

## å…¶å®ƒå®ç”¨çš„Groupå¹¶å‘åŸè¯­

### SizedGroup/ErrSizedGroup

[go-pkgz/syncs](https://github.com/go-pkgz/syncs)æä¾›äº†ä¸¤ä¸ªGroupå¹¶å‘åŸè¯­ï¼Œåˆ†åˆ«æ˜¯SizedGroupå’ŒErrSizedGroupã€‚

SizedGroupå†…éƒ¨æ˜¯ä½¿ç”¨ä¿¡å·é‡å’ŒWaitGroupå®ç°çš„ï¼Œå®ƒé€šè¿‡ä¿¡å·é‡æ§åˆ¶å¹¶å‘çš„goroutineæ•°é‡ï¼Œæˆ–è€…æ˜¯ä¸æ§åˆ¶goroutineæ•°é‡ï¼Œåªæ§åˆ¶å­ä»»åŠ¡å¹¶å‘æ‰§è¡Œæ—¶å€™çš„æ•°é‡ï¼ˆé€šè¿‡ï¼‰ã€‚

å®ƒçš„ä»£ç å®ç°éå¸¸ç®€æ´ï¼Œä½ å¯ä»¥åˆ°å®ƒçš„ä»£ç åº“ä¸­äº†è§£å®ƒçš„å…·ä½“å®ç°ï¼Œä½ ä¸€çœ‹å°±æ˜ç™½äº†ï¼Œæˆ‘å°±ä¸å¤šè¯´äº†ã€‚ä¸‹é¢æˆ‘é‡ç‚¹è¯´è¯´å®ƒçš„åŠŸèƒ½ã€‚

**é»˜è®¤æƒ…å†µä¸‹ï¼ŒSizedGroupæ§åˆ¶çš„æ˜¯å­ä»»åŠ¡çš„å¹¶å‘æ•°é‡ï¼Œè€Œä¸æ˜¯goroutineçš„æ•°é‡**ã€‚åœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œæ¯æ¬¡è°ƒç”¨Goæ–¹æ³•éƒ½ä¸ä¼šè¢«é˜»å¡ï¼Œè€Œæ˜¯æ–°å»ºä¸€ä¸ªgoroutineå»æ‰§è¡Œã€‚

å¦‚æœæƒ³æ§åˆ¶goroutineçš„æ•°é‡ï¼Œä½ å¯ä»¥ä½¿ç”¨syncs.Preemptiveè®¾ç½®è¿™ä¸ªå¹¶å‘åŸè¯­çš„å¯é€‰é¡¹ã€‚å¦‚æœè®¾ç½®äº†è¿™ä¸ªå¯é€‰é¡¹ï¼Œä½†åœ¨è°ƒç”¨Goæ–¹æ³•çš„æ—¶å€™æ²¡æœ‰å¯ç”¨çš„goroutineï¼Œé‚£ä¹ˆè°ƒç”¨è€…å°±ä¼šç­‰å¾…ï¼Œç›´åˆ°æœ‰goroutineå¯ä»¥å¤„ç†è¿™ä¸ªå­ä»»åŠ¡æ‰è¿”å›ï¼Œè¿™ä¸ªæ§åˆ¶åœ¨å†…éƒ¨æ˜¯ä½¿ç”¨ä¿¡å·é‡å®ç°çš„ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä½¿ç”¨SizedGroupçš„ä¾‹å­ï¼š

```
package main

import (
    "context"
    "fmt"
    "sync/atomic"
    "time"

    "github.com/go-pkgz/syncs"
)

func main() {
    // è®¾ç½®goroutineæ•°æ˜¯10
    swg := syncs.NewSizedGroup(10)
    // swg := syncs.NewSizedGroup(10, syncs.Preemptive)
    var c uint32

    // æ‰§è¡Œ1000ä¸ªå­ä»»åŠ¡ï¼Œåªä¼šæœ‰10ä¸ªgoroutineå»æ‰§è¡Œ
    for i := 0; i < 1000; i++ {
        swg.Go(func(ctx context.Context) {
            time.Sleep(5 * time.Millisecond)
            atomic.AddUint32(&c, 1)
        })
    }

    // ç­‰å¾…ä»»åŠ¡å®Œæˆ
    swg.Wait()
    // è¾“å‡ºç»“æœ
    fmt.Println(c)
}
```

ErrSizedGroupä¸ºSizedGroupæä¾›äº†errorå¤„ç†çš„åŠŸèƒ½ï¼Œå®ƒçš„åŠŸèƒ½å’ŒGoå®˜æ–¹æ‰©å±•åº“çš„åŠŸèƒ½ä¸€æ ·ï¼Œå°±æ˜¯ç­‰å¾…å­ä»»åŠ¡å®Œæˆå¹¶è¿”å›ç¬¬ä¸€ä¸ªå‡ºç°çš„errorã€‚ä¸è¿‡ï¼Œå®ƒè¿˜æä¾›äº†é¢å¤–çš„åŠŸèƒ½ï¼Œæˆ‘æ¥ä»‹ç»ä¸€ä¸‹ã€‚

ç¬¬ä¸€ä¸ªé¢å¤–çš„åŠŸèƒ½ï¼Œå°±æ˜¯å¯ä»¥æ§åˆ¶å¹¶å‘çš„goroutineæ•°é‡ï¼Œè¿™å’ŒSizedGroupçš„åŠŸèƒ½ä¸€æ ·ã€‚

ç¬¬äºŒä¸ªåŠŸèƒ½æ˜¯ï¼Œå¦‚æœè®¾ç½®äº†termOnErrorï¼Œå­ä»»åŠ¡å‡ºç°ç¬¬ä¸€ä¸ªé”™è¯¯çš„æ—¶å€™ä¼šcancel Contextï¼Œè€Œä¸”åç»­çš„Goè°ƒç”¨ä¼šç›´æ¥è¿”å›ï¼ŒWaitè°ƒç”¨è€…ä¼šå¾—åˆ°è¿™ä¸ªé”™è¯¯ï¼Œè¿™ç›¸å½“äºæ˜¯é‡åˆ°é”™è¯¯å¿«é€Ÿè¿”å›ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®termOnErrorï¼ŒWaitä¼šè¿”å›æ‰€æœ‰çš„å­ä»»åŠ¡çš„é”™è¯¯ã€‚

ä¸è¿‡ï¼ŒErrSizedGroupå’ŒSizedGroupè®¾è®¡å¾—ä¸å¤ªä¸€è‡´çš„åœ°æ–¹æ˜¯ï¼Œ**SizedGroupå¯ä»¥æŠŠContextä¼ é€’ç»™å­ä»»åŠ¡ï¼Œè¿™æ ·å¯ä»¥é€šè¿‡cancelè®©å­ä»»åŠ¡ä¸­æ–­æ‰§è¡Œï¼Œä½†æ˜¯ErrSizedGroupå´æ²¡æœ‰å®ç°ã€‚æˆ‘è®¤ä¸ºï¼Œè¿™æ˜¯ä¸€ä¸ªå€¼å¾—åŠ å¼ºçš„åœ°æ–¹**ã€‚

æ€»ä½“æ¥è¯´ï¼ŒsyncsåŒ…æä¾›çš„å¹¶å‘åŸè¯­çš„è´¨é‡å’ŒåŠŸèƒ½è¿˜æ˜¯éå¸¸èµçš„ã€‚ä¸è¿‡ï¼Œç›®å‰çš„staråªæœ‰åå‡ ä¸ªï¼Œè¿™å’Œå®ƒçš„åŠŸèƒ½ä¸¥é‡ä¸åŒ¹é…ï¼Œæˆ‘å»ºè®®ä½ starè¿™ä¸ªé¡¹ç›®ï¼Œæ”¯æŒä¸€ä¸‹ä½œè€…ã€‚

å¥½äº†ï¼Œå…³äºErrGroupï¼Œä½ æŒæ¡è¿™äº›å°±è¶³å¤Ÿäº†ï¼Œä¸‹é¢æˆ‘å†æ¥ç»™ä½ ä»‹ç»ä¸€äº›éErrGroupçš„å¹¶å‘åŸè¯­ï¼Œå®ƒä»¬ç”¨æ¥ç¼–æ’å­ä»»åŠ¡ã€‚

# gollback

[gollback](https://github.com/vardius/gollback)ä¹Ÿæ˜¯ç”¨æ¥å¤„ç†ä¸€ç»„å­ä»»åŠ¡çš„æ‰§è¡Œçš„ï¼Œä¸è¿‡å®ƒè§£å†³äº†ErrGroupæ”¶é›†å­ä»»åŠ¡è¿”å›ç»“æœçš„ç—›ç‚¹ã€‚ä½¿ç”¨ErrGroupæ—¶ï¼Œå¦‚æœä½ è¦æ”¶åˆ°å­ä»»åŠ¡çš„ç»“æœå’Œé”™è¯¯ï¼Œä½ éœ€è¦å®šä¹‰é¢å¤–çš„å˜é‡æ”¶é›†æ‰§è¡Œç»“æœå’Œé”™è¯¯ï¼Œä½†æ˜¯è¿™ä¸ªåº“å¯ä»¥æä¾›æ›´ä¾¿åˆ©çš„æ–¹å¼ã€‚

æˆ‘åˆšåˆšåœ¨è¯´å®˜æ–¹æ‰©å±•åº“ErrGroupçš„æ—¶å€™ï¼Œä¸¾äº†ä¸€äº›ä¾‹å­ï¼ˆè¿”å›ç¬¬ä¸€ä¸ªé”™è¯¯çš„ä¾‹å­å’Œè¿”å›æ‰€æœ‰å­ä»»åŠ¡é”™è¯¯çš„ä¾‹å­ï¼‰ï¼Œåœ¨ä¾‹å­ä¸­ï¼Œå¦‚æœæƒ³å¾—åˆ°æ¯ä¸€ä¸ªå­ä»»åŠ¡çš„ç»“æœæˆ–è€…errorï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–æä¾›ä¸€ä¸ªresult sliceè¿›è¡Œæ”¶é›†ã€‚ä½¿ç”¨gollbackçš„è¯ï¼Œå°±ä¸éœ€è¦è¿™äº›é¢å¤–çš„å¤„ç†äº†ï¼Œå› ä¸ºå®ƒçš„æ–¹æ³•ä¼šæŠŠç»“æœå’Œerrorä¿¡æ¯éƒ½è¿”å›ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒæä¾›çš„ä¸‰ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯**Allã€Raceå’ŒRetry**ã€‚

**Allæ–¹æ³•**

Allæ–¹æ³•çš„ç­¾åå¦‚ä¸‹ï¼š

```
func All(ctx context.Context, fns ...AsyncFunc) ([]interface{}, []error)
```

å®ƒä¼šç­‰å¾…æ‰€æœ‰çš„å¼‚æ­¥å‡½æ•°ï¼ˆAsyncFuncï¼‰éƒ½æ‰§è¡Œå®Œæ‰è¿”å›ï¼Œè€Œä¸”è¿”å›ç»“æœçš„é¡ºåºå’Œä¼ å…¥çš„å‡½æ•°çš„é¡ºåºä¿æŒä¸€è‡´ã€‚ç¬¬ä¸€ä¸ªè¿”å›å‚æ•°æ˜¯å­ä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å­ä»»åŠ¡æ‰§è¡Œæ—¶çš„é”™è¯¯ä¿¡æ¯ã€‚

å…¶ä¸­ï¼Œå¼‚æ­¥å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š

```
type AsyncFunc func(ctx context.Context) (interface{}, error)
```

å¯ä»¥çœ‹åˆ°ï¼Œctxä¼šè¢«ä¼ é€’ç»™å­ä»»åŠ¡ã€‚å¦‚æœä½ cancelè¿™ä¸ªctxï¼Œå¯ä»¥å–æ¶ˆå­ä»»åŠ¡ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä½¿ç”¨Allæ–¹æ³•çš„ä¾‹å­ï¼š

```
package main

import (
	"context"
	"errors"
	"fmt"
	"github.com/vardius/gollback"
	"time"
)

func main() {
	rs, errs := gollback.All( // è°ƒç”¨Allæ–¹æ³•
		context.Background(),
		func(ctx context.Context) (interface{}, error) { 
			time.Sleep(3 * time.Second)
			return 1, nil // ç¬¬ä¸€ä¸ªä»»åŠ¡æ²¡æœ‰é”™è¯¯ï¼Œè¿”å›1
		},
		func(ctx context.Context) (interface{}, error) {
			return nil, errors.New("failed") // ç¬¬äºŒä¸ªä»»åŠ¡è¿”å›ä¸€ä¸ªé”™è¯¯
		},
		func(ctx context.Context) (interface{}, error) {
			return 3, nil // ç¬¬ä¸‰ä¸ªä»»åŠ¡æ²¡æœ‰é”™è¯¯ï¼Œè¿”å›3
		},
	)

	fmt.Println(rs) // è¾“å‡ºå­ä»»åŠ¡çš„ç»“æœ
	fmt.Println(errs) // è¾“å‡ºå­ä»»åŠ¡çš„é”™è¯¯ä¿¡æ¯
}
```

**Raceæ–¹æ³•**

Raceæ–¹æ³•è·ŸAllæ–¹æ³•ç±»ä¼¼ï¼Œåªä¸è¿‡ï¼Œåœ¨ä½¿ç”¨Raceæ–¹æ³•çš„æ—¶å€™ï¼Œåªè¦ä¸€ä¸ªå¼‚æ­¥å‡½æ•°æ‰§è¡Œæ²¡æœ‰é”™è¯¯ï¼Œå°±ç«‹é©¬è¿”å›ï¼Œè€Œä¸ä¼šè¿”å›æ‰€æœ‰çš„å­ä»»åŠ¡ä¿¡æ¯ã€‚å¦‚æœæ‰€æœ‰çš„å­ä»»åŠ¡éƒ½æ²¡æœ‰æˆåŠŸï¼Œå°±ä¼šè¿”å›æœ€åä¸€ä¸ªerrorä¿¡æ¯ã€‚

Raceæ–¹æ³•ç­¾åå¦‚ä¸‹ï¼š

```
func Race(ctx context.Context, fns ...AsyncFunc) (interface{}, error)
```

å¦‚æœæœ‰ä¸€ä¸ªæ­£å¸¸çš„å­ä»»åŠ¡çš„ç»“æœè¿”å›ï¼ŒRaceä¼šæŠŠä¼ å…¥åˆ°å…¶å®ƒå­ä»»åŠ¡çš„Context cancelæ‰ï¼Œè¿™æ ·å­ä»»åŠ¡å°±å¯ä»¥ä¸­æ–­è‡ªå·±çš„æ‰§è¡Œã€‚

Raceçš„ä½¿ç”¨æ–¹æ³•ä¹Ÿè·ŸAllæ–¹æ³•ç±»ä¼¼ï¼Œæˆ‘å°±ä¸å†ä¸¾ä¾‹å­äº†ï¼Œä½ å¯ä»¥æŠŠAllæ–¹æ³•çš„ä¾‹å­ä¸­çš„Allæ›¿æ¢æˆRaceæ–¹å¼æµ‹è¯•ä¸‹ã€‚

**Retryæ–¹æ³•**

**Retryä¸æ˜¯æ‰§è¡Œä¸€ç»„å­ä»»åŠ¡ï¼Œè€Œæ˜¯æ‰§è¡Œä¸€ä¸ªå­ä»»åŠ¡**ã€‚å¦‚æœå­ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œå®ƒä¼šå°è¯•ä¸€å®šçš„æ¬¡æ•°ï¼Œå¦‚æœä¸€ç›´ä¸æˆåŠŸ ï¼Œå°±ä¼šè¿”å›å¤±è´¥é”™è¯¯ ï¼Œå¦‚æœæ‰§è¡ŒæˆåŠŸï¼Œå®ƒä¼šç«‹å³è¿”å›ã€‚å¦‚æœretiresç­‰äº0ï¼Œå®ƒä¼šæ°¸è¿œå°è¯•ï¼Œç›´åˆ°æˆåŠŸã€‚

```
func Retry(ctx context.Context, retires int, fn AsyncFunc) (interface{}, error)
```

å†æ¥çœ‹ä¸€ä¸ªä½¿ç”¨Retryçš„ä¾‹å­ï¼š

```
package main

import (
	"context"
	"errors"
	"fmt"
	"github.com/vardius/gollback"
	"time"
)

func main() {
	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()

	// å°è¯•5æ¬¡ï¼Œæˆ–è€…è¶…æ—¶è¿”å›
	res, err := gollback.Retry(ctx, 5, func(ctx context.Context) (interface{}, error) {
		return nil, errors.New("failed")
	})

	fmt.Println(res) // è¾“å‡ºç»“æœ
	fmt.Println(err) // è¾“å‡ºé”™è¯¯ä¿¡æ¯
} 
```

# Hunch

[Hunch](https://github.com/AaronJan/Hunch)æä¾›çš„åŠŸèƒ½å’Œgollbackç±»ä¼¼ï¼Œä¸è¿‡å®ƒæä¾›çš„æ–¹æ³•æ›´å¤šï¼Œè€Œä¸”å®ƒæä¾›çš„å’Œgollbackç›¸åº”çš„æ–¹æ³•ï¼Œä¹Ÿæœ‰ä¸€äº›ä¸åŒã€‚æˆ‘æ¥ä¸€ä¸€ä»‹ç»ä¸‹ã€‚

å®ƒå®šä¹‰äº†æ‰§è¡Œå­ä»»åŠ¡çš„å‡½æ•°ï¼Œè¿™å’Œgollbackçš„AyncFuncæ˜¯ä¸€æ ·çš„ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š

```
type Executable func(context.Context) (interface{}, error)
```

**Allæ–¹æ³•**

Allæ–¹æ³•çš„ç­¾åå¦‚ä¸‹ï¼š

```
func All(parentCtx context.Context, execs ...Executable) ([]interface{}, error)
```

å®ƒä¼šä¼ å…¥ä¸€ç»„å¯æ‰§è¡Œçš„å‡½æ•°ï¼ˆå­ä»»åŠ¡ï¼‰ï¼Œè¿”å›å­ä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚å’Œgollbackçš„Allæ–¹æ³•ä¸ä¸€æ ·çš„æ˜¯ï¼Œä¸€æ—¦ä¸€ä¸ªå­ä»»åŠ¡å‡ºç°é”™è¯¯ï¼Œå®ƒå°±ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œæ‰§è¡Œç»“æœï¼ˆç¬¬ä¸€ä¸ªè¿”å›å‚æ•°ï¼‰ä¸ºnilã€‚

**Takeæ–¹æ³•**

Takeæ–¹æ³•çš„ç­¾åå¦‚ä¸‹ï¼š

```
func Take(parentCtx context.Context, num int, execs ...Executable) ([]interface{}, error)
```

ä½ å¯ä»¥æŒ‡å®šnumå‚æ•°ï¼Œåªè¦æœ‰numä¸ªå­ä»»åŠ¡æ­£å¸¸æ‰§è¡Œå®Œæ²¡æœ‰é”™è¯¯ï¼Œè¿™ä¸ªæ–¹æ³•å°±ä¼šè¿”å›è¿™å‡ ä¸ªå­ä»»åŠ¡çš„ç»“æœã€‚ä¸€æ—¦ä¸€ä¸ªå­ä»»åŠ¡å‡ºç°é”™è¯¯ï¼Œå®ƒå°±ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œæ‰§è¡Œç»“æœï¼ˆç¬¬ä¸€ä¸ªè¿”å›å‚æ•°ï¼‰ä¸ºnilã€‚

**Lastæ–¹æ³•**

Lastæ–¹æ³•çš„ç­¾åå¦‚ä¸‹ï¼š

```
func Last(parentCtx context.Context, num int, execs ...Executable) ([]interface{}, error)
```

å®ƒåªè¿”å›æœ€ånumä¸ªæ­£å¸¸æ‰§è¡Œçš„ã€æ²¡æœ‰é”™è¯¯çš„å­ä»»åŠ¡çš„ç»“æœã€‚ä¸€æ—¦ä¸€ä¸ªå­ä»»åŠ¡å‡ºç°é”™è¯¯ï¼Œå®ƒå°±ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œæ‰§è¡Œç»“æœï¼ˆç¬¬ä¸€ä¸ªè¿”å›å‚æ•°ï¼‰ä¸ºnilã€‚

æ¯”å¦‚numç­‰äº1ï¼Œé‚£ä¹ˆï¼Œå®ƒåªä¼šè¿”å›æœ€åä¸€ä¸ªæ— é”™çš„å­ä»»åŠ¡çš„ç»“æœã€‚

**Retryæ–¹æ³•**

Retryæ–¹æ³•çš„ç­¾åå¦‚ä¸‹ï¼š

```
func Retry(parentCtx context.Context, retries int, fn Executable) (interface{}, error)
```

å®ƒçš„åŠŸèƒ½å’Œgollbackçš„Retryæ–¹æ³•çš„åŠŸèƒ½ä¸€æ ·ï¼Œå¦‚æœå­ä»»åŠ¡æ‰§è¡Œå‡ºé”™ï¼Œå°±ä¼šä¸æ–­å°è¯•ï¼Œç›´åˆ°æˆåŠŸæˆ–è€…æ˜¯è¾¾åˆ°é‡è¯•ä¸Šé™ã€‚å¦‚æœè¾¾åˆ°é‡è¯•ä¸Šé™ï¼Œå°±ä¼šè¿”å›é”™è¯¯ã€‚å¦‚æœretriesç­‰äº0ï¼Œå®ƒä¼šä¸æ–­å°è¯•ã€‚

**Waterfallæ–¹æ³•**

Waterfallæ–¹æ³•ç­¾åå¦‚ä¸‹ï¼š

```
func Waterfall(parentCtx context.Context, execs ...ExecutableInSequence) (interface{}, error)
```

å®ƒå…¶å®æ˜¯ä¸€ä¸ªpipelineçš„å¤„ç†æ–¹å¼ï¼Œæ‰€æœ‰çš„å­ä»»åŠ¡éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œå‰ä¸€ä¸ªå­ä»»åŠ¡çš„æ‰§è¡Œç»“æœä¼šè¢«å½“ä½œå‚æ•°ä¼ ç»™ä¸‹ä¸€ä¸ªå­ä»»åŠ¡ï¼Œç›´åˆ°æ‰€æœ‰çš„ä»»åŠ¡éƒ½å®Œæˆï¼Œè¿”å›æœ€åçš„æ‰§è¡Œç»“æœã€‚ä¸€æ—¦ä¸€ä¸ªå­ä»»åŠ¡å‡ºç°é”™è¯¯ï¼Œå®ƒå°±ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œæ‰§è¡Œç»“æœï¼ˆç¬¬ä¸€ä¸ªè¿”å›å‚æ•°ï¼‰ä¸ºnilã€‚

gollbackå’ŒHunchæ˜¯å±äºåŒä¸€ç±»çš„å¹¶å‘åŸè¯­ï¼Œå¯¹ä¸€ç»„å­ä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œå¯ä»¥é€‰æ‹©ä¸€ä¸ªç»“æœæˆ–è€…å¤šä¸ªç»“æœï¼Œè¿™ä¹Ÿæ˜¯ç°åœ¨çƒ­é—¨çš„å¾®æœåŠ¡å¸¸ç”¨çš„æœåŠ¡æ²»ç†çš„æ–¹æ³•ã€‚

# schedgroup

æ¥ä¸‹æ¥ï¼Œæˆ‘å†ä»‹ç»ä¸€ä¸ª**å’Œæ—¶é—´ç›¸å…³çš„å¤„ç†ä¸€ç»„goroutineçš„å¹¶å‘åŸè¯­schedgroup**ã€‚

[schedgroup](https://github.com/mdlayher/schedgroup)æ˜¯Matt Layherå¼€å‘çš„worker poolï¼Œå¯ä»¥æŒ‡å®šä»»åŠ¡åœ¨æŸä¸ªæ—¶é—´æˆ–è€…æŸä¸ªæ—¶é—´ä¹‹åæ‰§è¡Œã€‚Matt Layherä¹Ÿæ˜¯ä¸€ä¸ªçŸ¥åçš„Gopherï¼Œç»å¸¸åœ¨ä¸€äº›ä¼šè®®ä¸Šåˆ†äº«ä¸€äº›ä»–çš„Goå¼€å‘ç»éªŒï¼Œä»–åœ¨GopherCon Europe 2020å¤§ä¼šä¸Šä¸“é—¨ä»‹ç»äº†è¿™ä¸ªå¹¶å‘åŸè¯­ï¼š[schedgroup: a timer-based goroutine concurrency primitive](https://talks.godoc.org/github.com/mdlayher/talks/conferences/2020/gopherconeu/schedgroup.slide) ï¼Œè¯¾ä¸‹ä½ å¯ä»¥ç‚¹å¼€è¿™ä¸ªé“¾æ¥çœ‹ä¸€ä¸‹ï¼Œä¸‹é¢æˆ‘æ¥ç»™ä½ ä»‹ç»ä¸€äº›é‡ç‚¹ã€‚

è¿™ä¸ªå¹¶å‘åŸè¯­åŒ…å«çš„æ–¹æ³•å¦‚ä¸‹ï¼š

```
type Group
  func New(ctx context.Context) *Group
  func (g *Group) Delay(delay time.Duration, fn func())
  func (g *Group) Schedule(when time.Time, fn func())
  func (g *Group) Wait() error
```

æˆ‘æ¥ä»‹ç»ä¸‹è¿™äº›æ–¹æ³•ã€‚

å…ˆè¯´Delayå’ŒScheduleã€‚

å®ƒä»¬çš„åŠŸèƒ½å…¶å®æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ç”¨æ¥æŒ‡å®šåœ¨æŸä¸ªæ—¶é—´æˆ–è€…ä¹‹åæ‰§è¡Œä¸€ä¸ªå‡½æ•°ã€‚åªä¸è¿‡ï¼ŒDelayä¼ å…¥çš„æ˜¯ä¸€ä¸ªtime.Durationå‚æ•°ï¼Œå®ƒä¼šåœ¨time.Now()+delayä¹‹åæ‰§è¡Œå‡½æ•°ï¼Œè€ŒScheduleå¯ä»¥æŒ‡å®šæ˜ç¡®çš„æŸä¸ªæ—¶é—´æ‰§è¡Œã€‚

å†æ¥è¯´è¯´Waitæ–¹æ³•ã€‚

è¿™ä¸ªæ–¹æ³•è°ƒç”¨ä¼šé˜»å¡è°ƒç”¨è€…ï¼Œç›´åˆ°ä¹‹å‰å®‰æ’çš„æ‰€æœ‰å­ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ‰è¿”å›ã€‚å¦‚æœContextè¢«å–æ¶ˆï¼Œé‚£ä¹ˆï¼ŒWaitæ–¹æ³•ä¼šè¿”å›è¿™ä¸ªcancel errorã€‚

åœ¨ä½¿ç”¨Waitæ–¹æ³•çš„æ—¶å€™ï¼Œæœ‰2ç‚¹éœ€è¦æ³¨æ„ä¸€ä¸‹ã€‚

**ç¬¬ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœè°ƒç”¨äº†Waitæ–¹æ³•ï¼Œä½ å°±ä¸èƒ½å†è°ƒç”¨å®ƒçš„Delayå’ŒScheduleæ–¹æ³•ï¼Œå¦åˆ™ä¼španicã€‚**

**ç¬¬äºŒç‚¹æ˜¯ï¼ŒWaitæ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœå¤šæ¬¡è°ƒç”¨çš„è¯ï¼Œå°±ä¼španicã€‚**

ä½ å¯èƒ½è®¤ä¸ºï¼Œç®€å•åœ°ä½¿ç”¨timerå°±å¯ä»¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚å…¶å®ï¼Œå¦‚æœåªæœ‰å‡ ä¸ªå­ä»»åŠ¡ï¼Œä½¿ç”¨timerä¸æ˜¯é—®é¢˜ï¼Œä½†ä¸€æ—¦æœ‰å¤§é‡çš„å­ä»»åŠ¡ï¼Œè€Œä¸”è¿˜è¦èƒ½å¤Ÿcancelï¼Œé‚£ä¹ˆï¼Œä½¿ç”¨timerçš„è¯ï¼ŒCPUèµ„æºæ¶ˆè€—å°±æ¯”è¾ƒå¤§äº†ã€‚æ‰€ä»¥ï¼Œschedgroupåœ¨å®ç°çš„æ—¶å€™ï¼Œå°±ä½¿ç”¨container/heapï¼ŒæŒ‰ç…§å­ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´è¿›è¡Œæ’åºï¼Œè¿™æ ·å¯ä»¥é¿å…ä½¿ç”¨å¤§é‡çš„timerï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä½¿ç”¨schedgroupçš„ä¾‹å­ï¼Œä¸‹é¢ä»£ç ä¼šä¾æ¬¡è¾“å‡º1ã€2ã€3ï¼š

```
sg := schedgroup.New(context.Background())

// è®¾ç½®å­ä»»åŠ¡åˆ†åˆ«åœ¨100ã€200ã€300ä¹‹åæ‰§è¡Œ
for i := 0; i < 3; i++ {
    n := i + 1
    sg.Delay(time.Duration(n)*100*time.Millisecond, func() {
        log.Println(n) //è¾“å‡ºä»»åŠ¡ç¼–å·
    })
}

// ç­‰å¾…æ‰€æœ‰çš„å­ä»»åŠ¡éƒ½å®Œæˆ
if err := sg.Wait(); err != nil {
    log.Fatalf("failed to wait: %v", err)
}
```

# æ€»ç»“

è¿™èŠ‚è¯¾ï¼Œæˆ‘ç»™ä½ ä»‹ç»äº†å‡ ç§å¸¸è§çš„å¤„ç†ä¸€ç»„å­ä»»åŠ¡çš„å¹¶å‘åŸè¯­ï¼ŒåŒ…æ‹¬ErrGroupã€gollbackã€Hunchã€schedgroupï¼Œç­‰ç­‰ã€‚è¿™äº›å¸¸è§çš„ä¸šåŠ¡åœºæ™¯å…±æ€§å¤„ç†æ–¹å¼çš„æ€»ç»“ï¼Œä½ å¯ä»¥æŠŠå®ƒä»¬åŠ å…¥åˆ°ä½ çš„çŸ¥è¯†åº“ä¸­ï¼Œç­‰ä»¥åé‡åˆ°ç›¸åŒçš„ä¸šåŠ¡åœºæ™¯æ—¶ï¼Œä½ å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨è¿™äº›å¹¶å‘åŸè¯­ã€‚

å½“ç„¶ï¼Œç±»ä¼¼çš„å¹¶å‘åŸè¯­è¿˜æœ‰åˆ«çš„ï¼Œæ¯”å¦‚[go-waitgroup](https://github.com/pieterclaerhout/go-waitgroup)ç­‰ï¼Œè€Œä¸”ï¼Œæˆ‘ç›¸ä¿¡è¿˜ä¼šæœ‰æ–°çš„å¹¶å‘åŸè¯­ä¸æ–­å‡ºç°ã€‚æ‰€ä»¥ï¼Œä½ ä¸ä»…ä»…è¦æŒæ¡è¿™äº›å¹¶å‘åŸè¯­ï¼Œè€Œä¸”è¿˜è¦é€šè¿‡å­¦ä¹ è¿™äº›å¹¶å‘åŸè¯­ï¼Œå­¦ä¼šæ„é€ æ–°çš„å¹¶å‘åŸè¯­æ¥å¤„ç†åº”å¯¹ä½ çš„ç‰¹æœ‰åœºæ™¯ï¼Œå®ç°ä»£ç é‡ç”¨å’Œä¸šåŠ¡é€»è¾‘ç®€åŒ–ã€‚

![](https://static001.geekbang.org/resource/image/ee/9c/ee46d1dbed154a24063d3b0795fb5d9c.jpg?wh=2250%2A2664)

# æ€è€ƒé¢˜

è¿™èŠ‚è¯¾ï¼Œæˆ‘è®²çš„å®˜æ–¹æ‰©å±•åº“ErrGroupæ²¡æœ‰å®ç°å¯ä»¥å–æ¶ˆå­ä»»åŠ¡çš„åŠŸèƒ½ï¼Œè¯·ä½ è¯¾ä¸‹å¯ä»¥è‡ªå·±å»å®ç°ä¸€ä¸ªå­ä»»åŠ¡å¯å–æ¶ˆçš„ErrGroupã€‚

æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµè®¨è®ºã€‚å¦‚æœä½ è§‰å¾—æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>å¤§æ¼ èƒ¡èåœ</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>çœ‹äº†è¿™ç¯‡æ–‡ç« è¿˜æ˜¯æ”¶è·å·¨å¤§ï¼Œä»¥å‰ä¸çŸ¥é“ï¼Œä¹Ÿæ²¡ç”¨ç”¨è¿‡ã€‚

é¦–å…ˆæ˜¯ï¼ŒErrGroup,
å®˜æ–¹çš„å®ç°ï¼Œbilibili&#47;errgroupï¼Œneilotoole&#47;errgroupï¼Œfacebookgo&#47;errgroup

å…¶å®ƒå®ç”¨çš„ Group å¹¶å‘åŸè¯­SizedGroup&#47;ErrSizedGroup

gollbackå„ç§å®ç°ï¼Œä»¥å‰åœ¨nodejsä¸­ç»å¸¸ä½¿ç”¨ï¼Œæ²¡æƒ³åˆ°golangä¹Ÿæœ‰å®ç°ã€‚
ç±»ä¼¼çš„è¿˜æœ‰Hunchå®ç°ã€‚

å¦å¤–ï¼Œå¦‚æœé’ˆå¯¹å®šæ—¶å™¨æ¯”è¾ƒå¤šçš„æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨ schedgroup </p>2020-11-23</li><br/><li><span>mbc</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è€å¸ˆï¼Œè¿™ç§å’Œç”¨æ™®é€šçš„goåç¨‹æˆ–è€…channelå»å®Œæˆä¸€ç»„ä»»åŠ¡çš„ç¼–å†™æœ‰å•¥ä¸ä¸€æ ·å—ï¼Ÿå¥½å¤„æ˜¯å•¥</p>2020-11-28</li><br/><li><span>ä¸œæ³½</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ–‡ç« ä¸­å¤šæ¬¡å‡ºç°çš„â€œè®©å­ä»»åŠ¡ä¸­æ–­æ‰§è¡Œâ€ï¼Œè¿™é‡Œçš„è¯­ä¹‰æ˜¯ä¸­æ–­å­goroutineçš„æ‰§è¡Œè¿˜æ˜¯åœ¨å­goroutineä¸­ç”¨ç±»ä¼¼select &lt;-ctx.Done()çš„æ–¹å¼åœ¨æ‰§è¡Œä»»åŠ¡å‰åˆ¤æ–­ä»»åŠ¡æ˜¯å¦åº”è¯¥è¿›è¡Œã€‚</p>2021-12-10</li><br/><li><span>moooofly</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>```go
    ...
    for i := 0; i &lt; total; i++ { &#47;&#47; å¹¶å‘ä¸€ä¸‡ä¸ªgoroutineæ‰§è¡Œå­ä»»åŠ¡ï¼Œç†è®ºä¸Šè¿™äº›å­ä»»åŠ¡éƒ½ä¼šåŠ å…¥åˆ°Groupçš„å¾…å¤„ç†åˆ—è¡¨ä¸­
        go func() {
            g.Go(func(ctx context.Context) error {
                atomic.AddInt64(&amp;count, 1)
                return nil
            })
        }()
    }
	...
```

è¿™ä¸ªåœ°æ–¹æœ‰ç‚¹ä¸ç†è§£ï¼Œg.Go() ä¸å°±æ˜¯åˆ›å»ºäº†å­ goroutine äº†ä¹ˆï¼Œä¸ºå•¥è¿™é‡Œè¿˜è¦ä½¿ç”¨ go func() {...} ï¼›æˆ‘çœ‹æ–‡ç« ä¸­å…¶ä»–ç±»ä¼¼åœ°æ–¹éƒ½æ²¡æœ‰è¿™ä¹ˆç”¨ï¼Œåªæœ‰è¿™é‡Œæ˜¯è¿™æ ·~</p>2020-11-24</li><br/><li><span>MyronMeng</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æˆ‘ä»¬åº”è¯¥æ‹…å¿ƒã€æ›´è¿›ä¸€æ­¥ï¼Œè¿”å›æ‰€æœ‰å­ä»»åŠ¡çš„é”™è¯¯ã€‘è¿™ä¸€èŠ‚ï¼š
func main() {
    var g errgroup.Group
    var result = make([]error, 3)    &#47;&#47; å¯åŠ¨ç¬¬ä¸€ä¸ªå­ä»»åŠ¡,å®ƒæ‰§è¡ŒæˆåŠŸ
    g.Go(func() error {
        time.Sleep(5 * time.Second)
        fmt.Println(&quot;exec #1&quot;)
        result[0] = nil &#47;&#47; ä¿å­˜æˆåŠŸæˆ–è€…å¤±è´¥çš„ç»“æœ
        return nil    })
       ....
}

è¿™æ®µä»£ç å¤šä¸ª goroutine å†™åŒä¸€ä¸ª slice å¯¼è‡´ panic å—ï¼Ÿ</p>2023-04-27</li><br/><li><span>æ„¤æ€’çš„å°çŒ¥ç</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>errorgroup 49-55 è¡Œ ä¸ºä»€ä¹ˆè¦ç”¨ go func(){} å»æ‰§è¡Œ g.Wait() å’Œ close(ch) å‘¢ï¼ŒæŒ‰ç†è¯´ä¸æ˜¯åº”è¯¥å µå¡ç­‰å¾…å®Œæˆå—ï¼Ÿ</p>2022-06-13</li><br/><li><span>ç§‹æ™¨</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä»»åŠ¡æ‰§è¡Œæµæ°´çº¿ Pipeline çš„ä¾‹å­ç¬¬44è¡Œï¼Œå¦‚æœå¤„ç†å¤±è´¥ï¼Œè¿”å›errï¼Œå½“å‰çš„goroutineæ˜¯å¦ä¼šé€€å‡ºå‘¢ï¼Œå¦‚æœä¼šé€€å‡ºçš„è¯ï¼Œå¼€å¯çš„goroutineæ•°é‡å°‘äºå¾…å¤„ç†çš„æ•°æ®é‡çš„è¯ï¼Œä¼šä¸ä¼šå‡ºç°å¾…å¤„ç†çš„æ•°æ®æ— goroutineå¤„ç†</p>2021-06-15</li><br/><li><span>çš®å¡ä¸˜</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>cancelï¼Œå¤±è´¥çš„å­ä»»åŠ¡å¯ä»¥ cancel æ‰€æœ‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œè¿™å¥è¯æ˜¯ä¸æ˜¯æœ‰ç‚¹ç»å¯¹ï¼Œctxåªæ˜¯ä¼ é€’ä¿¡å·ï¼Œå¦‚æœcancelæ—¶ï¼Œè¿˜æœ‰å­ä»»åŠ¡çš„gouroutineæ²¡æœ‰è°ƒåº¦æˆ–è€…å†…éƒ¨è¿˜æ²¡æœ‰è¿è¡Œåˆ°ç›‘å¬ä¿¡å·æ‰ä¼šè¢«cancelæ‰</p>2020-11-20</li><br/><li><span>è€ç‹</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä½¿ç”¨ errgroup ä¿å­˜å¤šä¸ªé”™è¯¯çš„ä»£ç ï¼Œè¿è¡Œä¼šæŠ¥ data race å§</p>2020-12-16</li><br/><li><span>ä¼Ÿä¼Ÿ</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>package main

import (
	&quot;context&quot;
	&quot;fmt&quot;
	&quot;time&quot;

	&quot;golang.org&#47;x&#47;sync&#47;errgroup&quot;
)

type Data struct {
}

func getData() (*Data, error) {
	time.Sleep(3 * time.Second)
	return &amp;Data{}, nil
}

func main() {
	c, cancel := context.WithCancel(context.Background())
	defer cancel()
	g, ctx := errgroup.WithContext(c)

	datas := make(chan *Data, 10)

	g.Go(func() error {
		&#47;&#47; ä¸šåŠ¡é€»è¾‘
		data, err := getData()
		if err != nil {
			return err
		}

		select {
		case &lt;-ctx.Done():
			return ctx.Err()
		default:
		}
		datas &lt;- data
		return nil
	})

	go func() {
		time.Sleep(1 * time.Second)
		cancel()
	}()

	err := g.Wait()
	if err == nil {
		fmt.Println(&quot;success&quot;)
		return
	}
	fmt.Println(&quot;fail&quot;, err)
}
è¿™é‡Œç†è§£çš„æ˜¯å–æ¶ˆåšåœ¨ä¸šåŠ¡ç›¸å…³å±‚</p>2020-11-26</li><br/><li><span>fliyu</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ErrGroupæ”¯æŒè®¾ç½®å¹¶å‘ä¸ªæ•°äº†ï¼Œå³æ–¹æ³•SetLimit</p>2022-11-07</li><br/><li><span>Panda</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>CSP æ˜¯é“   å¹¶å‘åŸè¯­æ˜¯æœ¯</p>2021-06-15</li><br/><li><span>æ­¦å®‰å›</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å†…å®¹ä¸°å¯Œã€å°†æˆ‘çš„å…µæ³•ç¼–ç¨‹ä¸²æˆäº†ä¸€ä¸ªè„‘å›¾ï¼æ›´ç³»ç»Ÿæ›´å…¨ï¼æ‰“é€šäº†å…³ç³»å›¾ã€å‰©ä¸‹çš„å°±æ˜¯è‡ªå·±å¥½å¥½ç ”è¯»æºç ã€å°†æŠ€æœ¯é©±åŠ¨ä¸šåŠ¡å³å¯ï¼è°¢è°¢è€å¸ˆï¼</p>2021-01-31</li><br/><li><span>å¾æ”¹</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>package main

import (
	&quot;context&quot;
	&quot;errors&quot;
	&quot;fmt&quot;
	&quot;sync&quot;
	&quot;time&quot;
)

type errgroupWithCancel struct {
	wg sync.WaitGroup
	errs []string
}

func (egc * errgroupWithCancel) Go(exec func(ctx context.Context), ctx context.Context) {
	egc.wg.Add(1)
	go exec(ctx)
}

func (egc *errgroupWithCancel) Wait() {
	egc.wg.Wait()
}


func main() {
	ctx, cancelFunc := context.WithCancel(context.Background())
	egc := &amp;errgroupWithCancel{wg: sync.WaitGroup{}}
	egc.Go(func(ctx context.Context) {
		defer egc.wg.Done()
		select {
		case &lt;-ctx.Done():
			egc.errs = append(egc.errs, errors.New(&quot;cancel context&quot;).Error())
		case &lt;-time.After(time.Millisecond * 10):
			fmt.Println(&quot;work done&quot;)
		}
	}, ctx)
	time.Sleep(time.Millisecond * 15)
	cancelFunc()
	egc.Wait()
	if len(egc.errs) &gt; 0 {
		for _, err := range egc.errs {
			fmt.Println(err)
		}
	} else {
		fmt.Println(&quot;finish work&quot;)
	}
}
</p>2022-02-12</li><br/><li><span>ç§‘ç§‘</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å¾ˆå¼ºå¤§ï¼Œæ”¶è—äº†ï¼Œä¹‹åæœ‰æ—¶é—´ä¼šæŠŠæºç éƒ½æ‹¿å‡ºæ¥ä»”ç»†çœ‹çœ‹çš„ï¼ŒçœŸæ˜¯å¾ˆå¼ºå¤§çš„å·¥å…·</p>2021-05-30</li><br/>
</ul>