ä½ å¥½ï¼Œæˆ‘æ˜¯é¸Ÿçªã€‚

åœ¨å‰é¢çš„è¯¾ç¨‹é‡Œï¼Œæˆ‘ä»¬å­¦ä¹ äº†æ ‡å‡†åº“çš„å¹¶å‘åŸè¯­ã€åŸå­æ“ä½œå’ŒChannelï¼ŒæŒæ¡äº†è¿™äº›ï¼Œä½ å°±å¯ä»¥è§£å†³80%çš„å¹¶å‘ç¼–ç¨‹é—®é¢˜äº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ è¦æƒ³è¿›ä¸€æ­¥æå‡ä½ çš„å¹¶å‘ç¼–ç¨‹èƒ½åŠ›ï¼Œå°±éœ€è¦å­¦ä¹ ä¸€äº›ç¬¬ä¸‰æ–¹åº“ã€‚

æ‰€ä»¥ï¼Œåœ¨æ¥ä¸‹æ¥çš„å‡ èŠ‚è¯¾é‡Œï¼Œæˆ‘ä¼šç»™ä½ åˆ†äº«Goå®˜æ–¹æˆ–è€…å…¶ä»–äººæä¾›çš„ç¬¬ä¸‰æ–¹åº“ï¼Œè¿™èŠ‚è¯¾æˆ‘ä»¬å…ˆæ¥å­¦ä¹ ä¿¡å·é‡ï¼Œä¿¡å·é‡ï¼ˆSemaphoreï¼‰æ˜¯ç”¨æ¥æ§åˆ¶å¤šä¸ªgoroutineåŒæ—¶è®¿é—®å¤šä¸ªèµ„æºçš„å¹¶å‘åŸè¯­ã€‚

# ä¿¡å·é‡æ˜¯ä»€ä¹ˆï¼Ÿéƒ½æœ‰ä»€ä¹ˆæ“ä½œï¼Ÿ

ä¿¡å·é‡çš„æ¦‚å¿µæ˜¯è·å…°è®¡ç®—æœºç§‘å­¦å®¶Edsger Dijkstraåœ¨1963å¹´å·¦å³æå‡ºæ¥çš„ï¼Œå¹¿æ³›åº”ç”¨åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸­ã€‚åœ¨ç³»ç»Ÿä¸­ï¼Œä¼šç»™æ¯ä¸€ä¸ªè¿›ç¨‹ä¸€ä¸ªä¿¡å·é‡ï¼Œä»£è¡¨æ¯ä¸ªè¿›ç¨‹ç›®å‰çš„çŠ¶æ€ã€‚æœªå¾—åˆ°æ§åˆ¶æƒçš„è¿›ç¨‹ï¼Œä¼šåœ¨ç‰¹å®šçš„åœ°æ–¹è¢«è¿«åœä¸‹æ¥ï¼Œç­‰å¾…å¯ä»¥ç»§ç»­è¿›è¡Œçš„ä¿¡å·åˆ°æ¥ã€‚

æœ€ç®€å•çš„ä¿¡å·é‡å°±æ˜¯ä¸€ä¸ªå˜é‡åŠ ä¸€äº›å¹¶å‘æ§åˆ¶çš„èƒ½åŠ›ï¼Œè¿™ä¸ªå˜é‡æ˜¯0åˆ°nä¹‹é—´çš„ä¸€ä¸ªæ•°å€¼ã€‚å½“goroutineå®Œæˆå¯¹æ­¤ä¿¡å·é‡çš„ç­‰å¾…ï¼ˆwaitï¼‰æ—¶ï¼Œè¯¥è®¡æ•°å€¼å°±å‡1ï¼Œå½“goroutineå®Œæˆå¯¹æ­¤ä¿¡å·é‡çš„é‡Šæ”¾ï¼ˆreleaseï¼‰æ—¶ï¼Œè¯¥è®¡æ•°å€¼å°±åŠ 1ã€‚å½“è®¡æ•°å€¼ä¸º0çš„æ—¶å€™ï¼Œgoroutineè°ƒç”¨waitç­‰å¾…è¯¥ä¿¡å·é‡æ˜¯ä¸ä¼šæˆåŠŸçš„ï¼Œé™¤éè®¡æ•°å™¨åˆå¤§äº0ï¼Œç­‰å¾…çš„goroutineæ‰æœ‰å¯èƒ½æˆåŠŸè¿”å›ã€‚

æ›´å¤æ‚çš„ä¿¡å·é‡ç±»å‹ï¼Œå°±æ˜¯ä½¿ç”¨æŠ½è±¡æ•°æ®ç±»å‹ä»£æ›¿å˜é‡ï¼Œç”¨æ¥ä»£è¡¨å¤æ‚çš„èµ„æºç±»å‹ã€‚å®é™…ä¸Šï¼Œå¤§éƒ¨åˆ†çš„ä¿¡å·é‡éƒ½ä½¿ç”¨ä¸€ä¸ªæ•´å‹å˜é‡æ¥è¡¨ç¤ºä¸€ç»„èµ„æºï¼Œå¹¶æ²¡æœ‰å®ç°å¤ªå¤æ‚çš„æŠ½è±¡æ•°æ®ç±»å‹ï¼Œæ‰€ä»¥ä½ åªè¦çŸ¥é“æœ‰æ›´å¤æ‚çš„ä¿¡å·é‡å°±è¡Œäº†ï¼Œæˆ‘ä»¬è¿™èŠ‚è¯¾ä¸»è¦æ˜¯å­¦ä¹ æœ€ç®€å•çš„ä¿¡å·é‡ã€‚

è¯´åˆ°è¿™å„¿å‘¢ï¼Œæˆ‘æƒ³å€ŸåŠ©ä¸€ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼Œæ¥å¸®ä½ è¿›ä¸€æ­¥ç†è§£ä¿¡å·é‡ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå›¾ä¹¦é¦†æ–°è´­ä¹°äº†10æœ¬ã€ŠGoå¹¶å‘ç¼–ç¨‹çš„ç‹¬å®¶ç§˜ç±ã€‹ï¼Œæœ‰1ä¸‡ä¸ªå­¦ç”Ÿéƒ½æƒ³è¯»è¿™æœ¬ä¹¦ï¼Œâ€œåƒ§å¤šç²¥å°‘â€ã€‚æ‰€ä»¥ï¼Œå›¾ä¹¦é¦†ç®¡ç†å‘˜å…ˆä¼šè®©è¿™1ä¸‡ä¸ªåŒå­¦è¿›è¡Œç™»è®°ï¼ŒæŒ‰ç…§ç™»è®°çš„é¡ºåºï¼Œå€Ÿé˜…æ­¤ä¹¦ã€‚å¦‚æœä¹¦å…¨éƒ¨è¢«å€Ÿèµ°ï¼Œé‚£ä¹ˆï¼Œå…¶ä»–æƒ³çœ‹æ­¤ä¹¦çš„åŒå­¦å°±éœ€è¦ç­‰å¾…ï¼Œå¦‚æœæœ‰äººè¿˜ä¹¦äº†ï¼Œå›¾ä¹¦é¦†ç®¡ç†å‘˜å°±ä¼šé€šçŸ¥ä¸‹ä¸€ä½åŒå­¦æ¥å€Ÿé˜…è¿™æœ¬ä¹¦ã€‚è¿™é‡Œçš„èµ„æºæ˜¯ã€ŠGoå¹¶å‘ç¼–ç¨‹çš„ç‹¬å®¶ç§˜ç±ã€‹è¿™åæœ¬ä¹¦ï¼Œæƒ³è¯»æ­¤ä¹¦çš„åŒå­¦å°±æ˜¯goroutineï¼Œå›¾ä¹¦ç®¡ç†å‘˜å°±æ˜¯ä¿¡å·é‡ã€‚

æ€ä¹ˆæ ·ï¼Œç°åœ¨æ˜¯ä¸æ˜¯å¾ˆå¥½ç†è§£äº†ï¼Ÿé‚£ä¹ˆï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ ä¸‹ä¿¡å·é‡çš„P/Væ“ä½œã€‚

## P/Væ“ä½œ

Dijkstraåœ¨ä»–çš„è®ºæ–‡ä¸­ä¸ºä¿¡å·é‡å®šä¹‰äº†ä¸¤ä¸ªæ“ä½œPå’ŒVã€‚Pæ“ä½œï¼ˆdescreaseã€waitã€acquireï¼‰æ˜¯å‡å°‘ä¿¡å·é‡çš„è®¡æ•°å€¼ï¼Œè€ŒVæ“ä½œï¼ˆincreaseã€signalã€releaseï¼‰æ˜¯å¢åŠ ä¿¡å·é‡çš„è®¡æ•°å€¼ã€‚

ä½¿ç”¨ä¼ªä»£ç è¡¨ç¤ºå¦‚ä¸‹ï¼ˆä¸­æ‹¬å·ä»£è¡¨åŸå­æ“ä½œï¼‰ï¼š

```
function V(semaphore S, integer I):
    [S â† S + I]

function P(semaphore S, integer I):
    repeat:
        [if S â‰¥ I:
        S â† S âˆ’ I
        break]
```

å¯ä»¥çœ‹åˆ°ï¼Œåˆå§‹åŒ–ä¿¡å·é‡Sæœ‰ä¸€ä¸ªæŒ‡å®šæ•°é‡ï¼ˆ**n**ï¼‰çš„èµ„æºï¼Œå®ƒå°±åƒæ˜¯ä¸€ä¸ªæœ‰nä¸ªèµ„æºçš„æ± å­ã€‚Pæ“ä½œç›¸å½“äºè¯·æ±‚èµ„æºï¼Œå¦‚æœèµ„æºå¯ç”¨ï¼Œå°±ç«‹å³è¿”å›ï¼›å¦‚æœæ²¡æœ‰èµ„æºæˆ–è€…ä¸å¤Ÿï¼Œé‚£ä¹ˆï¼Œå®ƒå¯ä»¥ä¸æ–­å°è¯•æˆ–è€…é˜»å¡ç­‰å¾…ã€‚Væ“ä½œä¼šé‡Šæ”¾è‡ªå·±æŒæœ‰çš„èµ„æºï¼ŒæŠŠèµ„æºè¿”è¿˜ç»™ä¿¡å·é‡ã€‚ä¿¡å·é‡çš„å€¼é™¤äº†åˆå§‹åŒ–çš„æ“ä½œä»¥å¤–ï¼Œåªèƒ½ç”±P/Væ“ä½œæ”¹å˜ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬æ¥æ€»ç»“ä¸‹ä¿¡å·é‡çš„å®ç°ã€‚

- åˆå§‹åŒ–ä¿¡å·é‡ï¼šè®¾å®šåˆå§‹çš„èµ„æºçš„æ•°é‡ã€‚
- Pæ“ä½œï¼šå°†ä¿¡å·é‡çš„è®¡æ•°å€¼å‡å»1ï¼Œå¦‚æœæ–°å€¼å·²ç»ä¸ºè´Ÿï¼Œé‚£ä¹ˆè°ƒç”¨è€…ä¼šè¢«é˜»å¡å¹¶åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚å¦åˆ™ï¼Œè°ƒç”¨è€…ä¼šç»§ç»­æ‰§è¡Œï¼Œå¹¶ä¸”è·å¾—ä¸€ä¸ªèµ„æºã€‚
- Væ“ä½œï¼šå°†ä¿¡å·é‡çš„è®¡æ•°å€¼åŠ 1ï¼Œå¦‚æœå…ˆå‰çš„è®¡æ•°å€¼ä¸ºè´Ÿï¼Œå°±è¯´æ˜æœ‰ç­‰å¾…çš„Pæ“ä½œçš„è°ƒç”¨è€…ã€‚å®ƒä¼šä»ç­‰å¾…é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªç­‰å¾…çš„è°ƒç”¨è€…ï¼Œå”¤é†’å®ƒï¼Œè®©å®ƒç»§ç»­æ‰§è¡Œã€‚

è®²åˆ°è¿™é‡Œï¼Œæˆ‘æƒ³å†ç¨å¾®è¯´ä¸€ä¸ªé¢˜å¤–è¯ï¼Œæˆ‘ä»¬åœ¨[ç¬¬2è®²](https://time.geekbang.org/column/article/295850)æåˆ°è¿‡é¥¥é¥¿ï¼Œå°±æ˜¯è¯´åœ¨é«˜å¹¶å‘çš„æç«¯åœºæ™¯ä¸‹ï¼Œä¼šæœ‰äº›goroutineå§‹ç»ˆæŠ¢ä¸åˆ°é”ã€‚ä¸ºäº†å¤„ç†é¥¥é¥¿çš„é—®é¢˜ï¼Œä½ å¯ä»¥åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­åšä¸€äº›â€œæ–‡ç« â€ã€‚æ¯”å¦‚å®ç°ä¸€ä¸ªä¼˜å…ˆçº§çš„é˜Ÿåˆ—ï¼Œæˆ–è€…å…ˆå…¥å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç­‰ç­‰ï¼Œä¿æŒå…¬å¹³æ€§ï¼Œå¹¶ä¸”ç…§é¡¾åˆ°ä¼˜å…ˆçº§ã€‚

åœ¨æ­£å¼è¿›å…¥å®ç°ä¿¡å·é‡çš„å…·ä½“å®ç°åŸç†ä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆè®²ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œå°±æ˜¯ä¿¡å·é‡å’Œäº’æ–¥é”çš„åŒºåˆ«ä¸è”ç³»ï¼Œè¿™æœ‰åŠ©äºæˆ‘ä»¬æŒæ¡æ¥ä¸‹æ¥çš„å†…å®¹ã€‚

å…¶å®ï¼Œä¿¡å·é‡å¯ä»¥åˆ†ä¸ºè®¡æ•°ä¿¡å·é‡ï¼ˆcounting semaphoreï¼‰å’ŒäºŒè¿›ä½ä¿¡å·é‡ï¼ˆbinary semaphoreï¼‰ã€‚åˆšåˆšæ‰€è¯´çš„å›¾ä¹¦é¦†å€Ÿä¹¦çš„ä¾‹å­å°±æ˜¯ä¸€ä¸ªè®¡æ•°ä¿¡å·é‡ï¼Œå®ƒçš„è®¡æ•°å¯ä»¥æ˜¯ä»»æ„ä¸€ä¸ªæ•´æ•°ã€‚åœ¨ç‰¹æ®Šçš„æƒ…å†µä¸‹ï¼Œå¦‚æœè®¡æ•°å€¼åªèƒ½æ˜¯0æˆ–è€…1ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªä¿¡å·é‡å°±æ˜¯äºŒè¿›ä½ä¿¡å·é‡ï¼Œæä¾›äº†äº’æ–¥çš„åŠŸèƒ½ï¼ˆè¦ä¹ˆæ˜¯0ï¼Œè¦ä¹ˆæ˜¯1ï¼‰ï¼Œæ‰€ä»¥ï¼Œæœ‰æ—¶å€™äº’æ–¥é”ä¹Ÿä¼šä½¿ç”¨äºŒè¿›ä½ä¿¡å·é‡æ¥å®ç°ã€‚

æˆ‘ä»¬ä¸€èˆ¬ç”¨ä¿¡å·é‡ä¿æŠ¤ä¸€ç»„èµ„æºï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥æ± ã€ä¸€ç»„å®¢æˆ·ç«¯çš„è¿æ¥ã€å‡ ä¸ªæ‰“å°æœºèµ„æºï¼Œç­‰ç­‰ã€‚å¦‚æœä¿¡å·é‡èœ•å˜æˆäºŒè¿›ä½ä¿¡å·é‡ï¼Œé‚£ä¹ˆï¼Œå®ƒçš„P/Vå°±å’Œäº’æ–¥é”çš„Lock/Unlockä¸€æ ·äº†ã€‚

æœ‰äººä¼šå¾ˆç»†è‡´åœ°åŒºåˆ†äºŒè¿›ä½ä¿¡å·é‡å’Œäº’æ–¥é”ã€‚æ¯”å¦‚è¯´ï¼Œæœ‰äººæå‡ºï¼Œåœ¨Windowsç³»ç»Ÿä¸­ï¼Œäº’æ–¥é”åªèƒ½ç”±æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾é”ï¼Œè€ŒäºŒè¿›ä½ä¿¡å·é‡åˆ™æ²¡æœ‰è¿™ä¸ªé™åˆ¶ï¼ˆ[Stack Overflow](https://stackoverflow.com/questions/62814/difference-between-binary-semaphore-and-mutex)ä¸Šä¹Ÿæœ‰ç›¸å…³çš„è®¨è®ºï¼‰ã€‚å®é™…ä¸Šï¼Œè™½ç„¶åœ¨Windowsç³»ç»Ÿä¸­ï¼Œå®ƒä»¬çš„ç¡®æœ‰äº›åŒºåˆ«ï¼Œä½†æ˜¯å¯¹Goè¯­è¨€æ¥è¯´ï¼Œäº’æ–¥é”ä¹Ÿå¯ä»¥ç”±éæŒæœ‰çš„goroutineæ¥é‡Šæ”¾ï¼Œæ‰€ä»¥ï¼Œä»è¡Œä¸ºä¸Šæ¥è¯´ï¼Œå®ƒä»¬å¹¶æ²¡æœ‰ä¸¥æ ¼çš„åŒºåˆ«ã€‚

æˆ‘ä¸ªäººè®¤ä¸ºï¼Œæ²¡å¿…è¦è¿›è¡Œç»†è‡´çš„åŒºåˆ†ï¼Œå› ä¸ºäº’æ–¥é”å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆä¸¥æ ¼çš„å®šä¹‰ã€‚å®é™…åœ¨é‡åˆ°äº’æ–¥å¹¶å‘çš„é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬é€‰ç”¨äº’æ–¥é”ã€‚

å¥½äº†ï¼Œè¨€å½’æ­£ä¼ ï¼Œåˆšåˆšæˆ‘ä»¬æŒæ¡äº†ä¿¡å·é‡çš„å«ä¹‰å’Œå…·ä½“æ“ä½œæ–¹å¼ï¼Œä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥å…·ä½“äº†è§£ä¸‹å®˜æ–¹æ‰©å±•åº“çš„å®ç°ã€‚

# Goå®˜æ–¹æ‰©å±•åº“çš„å®ç°

åœ¨è¿è¡Œæ—¶ï¼ŒGoå†…éƒ¨ä½¿ç”¨ä¿¡å·é‡æ¥æ§åˆ¶goroutineçš„é˜»å¡å’Œå”¤é†’ã€‚æˆ‘ä»¬åœ¨å­¦ä¹ åŸºæœ¬å¹¶å‘åŸè¯­çš„å®ç°æ—¶ä¹Ÿçœ‹åˆ°äº†ï¼Œæ¯”å¦‚äº’æ–¥é”çš„ç¬¬äºŒä¸ªå­—æ®µï¼š

```
type Mutex struct {
		state int32
		sema  uint32
}
```

ä¿¡å·é‡çš„P/Væ“ä½œæ˜¯é€šè¿‡å‡½æ•°å®ç°çš„ï¼š

```
func runtime_Semacquire(s *uint32)
func runtime_SemacquireMutex(s *uint32, lifo bool, skipframes int)
func runtime_Semrelease(s *uint32, handoff bool, skipframes int)
```

é—æ†¾çš„æ˜¯ï¼Œå®ƒæ˜¯Goè¿è¡Œæ—¶å†…éƒ¨ä½¿ç”¨çš„ï¼Œå¹¶æ²¡æœ‰å°è£…æš´éœ²æˆä¸€ä¸ªå¯¹å¤–çš„ä¿¡å·é‡å¹¶å‘åŸè¯­ï¼ŒåŸåˆ™ä¸Šæˆ‘ä»¬æ²¡æœ‰åŠæ³•ä½¿ç”¨ã€‚ä¸è¿‡æ²¡å…³ç³»ï¼ŒGoåœ¨å®ƒçš„æ‰©å±•åŒ…ä¸­æä¾›äº†ä¿¡å·é‡[semaphore](https://godoc.org/golang.org/x/sync/semaphore)ï¼Œä¸è¿‡è¿™ä¸ªä¿¡å·é‡çš„ç±»å‹åå¹¶ä¸å«Semaphoreï¼Œè€Œæ˜¯å«Weightedã€‚

ä¹‹æ‰€ä»¥å«åšWeightedï¼Œæˆ‘æƒ³ï¼Œåº”è¯¥æ˜¯å› ä¸ºå¯ä»¥åœ¨åˆå§‹åŒ–åˆ›å»ºè¿™ä¸ªä¿¡å·é‡çš„æ—¶å€™è®¾ç½®æƒé‡ï¼ˆåˆå§‹åŒ–çš„èµ„æºæ•°ï¼‰ï¼Œå…¶å®æˆ‘è§‰å¾—å«Semaphoreæˆ–è®¸ä¼šæ›´å¥½ã€‚

![](https://static001.geekbang.org/resource/image/1a/b0/1a13a551346cd6b910f38f5ed2bfc6b0.png?wh=702%2A174)

æˆ‘ä»¬æ¥åˆ†æä¸‹è¿™ä¸ªä¿¡å·é‡çš„å‡ ä¸ªå®ç°æ–¹æ³•ã€‚

1. **Acquireæ–¹æ³•**ï¼šç›¸å½“äºPæ“ä½œï¼Œä½ å¯ä»¥ä¸€æ¬¡è·å–å¤šä¸ªèµ„æºï¼Œå¦‚æœæ²¡æœ‰è¶³å¤Ÿå¤šçš„èµ„æºï¼Œè°ƒç”¨è€…å°±ä¼šè¢«é˜»å¡ã€‚å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Contextï¼Œè¿™å°±æ„å‘³ç€ï¼Œä½ å¯ä»¥é€šè¿‡Contextå¢åŠ è¶…æ—¶æˆ–è€…cancelçš„æœºåˆ¶ã€‚å¦‚æœæ˜¯æ­£å¸¸è·å–äº†èµ„æºï¼Œå°±è¿”å›nilï¼›å¦åˆ™ï¼Œå°±è¿”å›ctx.Err()ï¼Œä¿¡å·é‡ä¸æ”¹å˜ã€‚
2. **Releaseæ–¹æ³•**ï¼šç›¸å½“äºVæ“ä½œï¼Œå¯ä»¥å°†nä¸ªèµ„æºé‡Šæ”¾ï¼Œè¿”è¿˜ç»™ä¿¡å·é‡ã€‚
3. **TryAcquireæ–¹æ³•**ï¼šå°è¯•è·å–nä¸ªèµ„æºï¼Œä½†æ˜¯å®ƒä¸ä¼šé˜»å¡ï¼Œè¦ä¹ˆæˆåŠŸè·å–nä¸ªèµ„æºï¼Œè¿”å›trueï¼Œè¦ä¹ˆä¸€ä¸ªä¹Ÿä¸è·å–ï¼Œè¿”å›falseã€‚

çŸ¥é“äº†ä¿¡å·é‡çš„å®ç°æ–¹æ³•ï¼Œåœ¨å®é™…çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆç”¨å‘¢ï¼Ÿæˆ‘æ¥ä¸¾ä¸ªWorker Poolçš„ä¾‹å­ï¼Œæ¥å¸®åŠ©ä½ ç†è§£ã€‚

æˆ‘ä»¬åˆ›å»ºå’ŒCPUæ ¸æ•°ä¸€æ ·å¤šçš„Workerï¼Œè®©å®ƒä»¬å»å¤„ç†ä¸€ä¸ª4å€æ•°é‡çš„æ•´æ•°sliceã€‚æ¯ä¸ªWorkerä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªæ•´æ•°ï¼Œå¤„ç†å®Œä¹‹åï¼Œæ‰èƒ½å¤„ç†ä¸‹ä¸€ä¸ªã€‚

å½“ç„¶ï¼Œè¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆæœ‰å¾ˆå¤šç§ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬ä½¿ç”¨ä¿¡å·é‡ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
var (
    maxWorkers = runtime.GOMAXPROCS(0)                    // workeræ•°é‡
    sema       = semaphore.NewWeighted(int64(maxWorkers)) //ä¿¡å·é‡
    task       = make([]int, maxWorkers*4)                // ä»»åŠ¡æ•°ï¼Œæ˜¯workerçš„å››å€
)

func main() {
    ctx := context.Background()

    for i := range task {
        // å¦‚æœæ²¡æœ‰workerå¯ç”¨ï¼Œä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œç›´åˆ°æŸä¸ªworkerè¢«é‡Šæ”¾
        if err := sema.Acquire(ctx, 1); err != nil {
            break
        }

        // å¯åŠ¨worker goroutine
        go func(i int) {
            defer sema.Release(1)
            time.Sleep(100 * time.Millisecond) // æ¨¡æ‹Ÿä¸€ä¸ªè€—æ—¶æ“ä½œ
            task[i] = i + 1
        }(i)
    }

    // è¯·æ±‚æ‰€æœ‰çš„worker,è¿™æ ·èƒ½ç¡®ä¿å‰é¢çš„workeréƒ½æ‰§è¡Œå®Œ
    if err := sema.Acquire(ctx, int64(maxWorkers)); err != nil {
        log.Printf("è·å–æ‰€æœ‰çš„workerå¤±è´¥: %v", err)
    }

    fmt.Println(task)
}
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œmain goroutineç›¸å½“äºä¸€ä¸ªdispatcherï¼Œè´Ÿè´£ä»»åŠ¡çš„åˆ†å‘ã€‚å®ƒå…ˆè¯·æ±‚ä¿¡å·é‡ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œå°±ä¼šå¯åŠ¨ä¸€ä¸ªgoroutineå»å¤„ç†è®¡ç®—ï¼Œç„¶åï¼Œè¿™ä¸ªgoroutineä¼šé‡Šæ”¾è¿™ä¸ªä¿¡å·é‡ï¼ˆæœ‰æ„æ€çš„æ˜¯ï¼Œä¿¡å·é‡çš„è·å–æ˜¯åœ¨main goroutineï¼Œä¿¡å·é‡çš„é‡Šæ”¾æ˜¯åœ¨worker goroutineä¸­ï¼‰ï¼Œå¦‚æœè·å–ä¸æˆåŠŸï¼Œå°±ç­‰åˆ°æœ‰ä¿¡å·é‡å¯ä»¥ä½¿ç”¨çš„æ—¶å€™ï¼Œå†å»è·å–ã€‚

éœ€è¦æé†’ä½ çš„æ˜¯ï¼Œå…¶å®ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªå€¼å¾—æˆ‘ä»¬å­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼Œå°±æ˜¯æœ€åçš„é‚£ä¸€æ®µå¤„ç†ï¼ˆç¬¬25è¡Œï¼‰ã€‚**å¦‚æœåœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ æƒ³ç­‰æ‰€æœ‰çš„Workeréƒ½æ‰§è¡Œå®Œï¼Œå°±å¯ä»¥è·å–æœ€å¤§è®¡æ•°å€¼çš„ä¿¡å·é‡**ã€‚

Goæ‰©å±•åº“ä¸­çš„ä¿¡å·é‡æ˜¯ä½¿ç”¨äº’æ–¥é”+Listå®ç°çš„ã€‚äº’æ–¥é”å®ç°å…¶å®ƒå­—æ®µçš„ä¿æŠ¤ï¼Œè€ŒListå®ç°äº†ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œç­‰å¾…è€…çš„é€šçŸ¥æ˜¯é€šè¿‡Channelçš„é€šçŸ¥æœºåˆ¶å®ç°çš„ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¿¡å·é‡Weightedçš„æ•°æ®ç»“æ„ï¼š

```
type Weighted struct {
		size    int64         // æœ€å¤§èµ„æºæ•°
		cur     int64         // å½“å‰å·²è¢«ä½¿ç”¨çš„èµ„æº
		mu      sync.Mutex    // äº’æ–¥é”ï¼Œå¯¹å­—æ®µçš„ä¿æŠ¤
		waiters list.List     // ç­‰å¾…é˜Ÿåˆ—
}
```

åœ¨ä¿¡å·é‡çš„å‡ ä¸ªå®ç°æ–¹æ³•é‡Œï¼ŒAcquireæ˜¯ä»£ç æœ€å¤æ‚çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒä¸ä»…ä»…è¦ç›‘æ§èµ„æºæ˜¯å¦å¯ç”¨ï¼Œè€Œä¸”è¿˜è¦æ£€æµ‹Contextçš„Doneæ˜¯å¦å·²å…³é—­ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„å®ç°ä»£ç ã€‚

```
func (s *Weighted) Acquire(ctx context.Context, n int64) error {
		s.mu.Lock()
        // fast path, å¦‚æœæœ‰è¶³å¤Ÿçš„èµ„æºï¼Œéƒ½ä¸è€ƒè™‘ctx.Doneçš„çŠ¶æ€ï¼Œå°†curåŠ ä¸Šnå°±è¿”å›
		if s.size-s.cur >= n && s.waiters.Len() == 0 {
			s.cur += n
			s.mu.Unlock()
			return nil
		}
	
        // å¦‚æœæ˜¯ä¸å¯èƒ½å®Œæˆçš„ä»»åŠ¡ï¼Œè¯·æ±‚çš„èµ„æºæ•°å¤§äºèƒ½æä¾›çš„æœ€å¤§çš„èµ„æºæ•°
		if n > s.size {
			s.mu.Unlock()
            // ä¾èµ–ctxçš„çŠ¶æ€è¿”å›ï¼Œå¦åˆ™ä¸€ç›´ç­‰å¾…
			<-ctx.Done()
			return ctx.Err()
		}
	
        // å¦åˆ™å°±éœ€è¦æŠŠè°ƒç”¨è€…åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­
        // åˆ›å»ºäº†ä¸€ä¸ªready chan,ä»¥ä¾¿è¢«é€šçŸ¥å”¤é†’
		ready := make(chan struct{})
		w := waiter{n: n, ready: ready}
		elem := s.waiters.PushBack(w)
		s.mu.Unlock()
	

        // ç­‰å¾…
		select {
		case <-ctx.Done(): // contextçš„Doneè¢«å…³é—­
			err := ctx.Err()
			s.mu.Lock()
			select {
			case <-ready: // å¦‚æœè¢«å”¤é†’äº†ï¼Œå¿½ç•¥ctxçš„çŠ¶æ€
				err = nil
			default: é€šçŸ¥waiter
				isFront := s.waiters.Front() == elem
				s.waiters.Remove(elem)
				// é€šçŸ¥å…¶å®ƒçš„waiters,æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æº
				if isFront && s.size > s.cur {
					s.notifyWaiters()
				}
			}
			s.mu.Unlock()
			return err
		case <-ready: // è¢«å”¤é†’äº†
			return nil
		}
	}
```

å…¶å®ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­çš„fast pathä¹‹å¤–çš„ä»£ç ï¼Œå¯ä»¥æŠ½å–æˆacquireSlowæ–¹æ³•ï¼Œä»¥ä¾¿å…¶å®ƒAcquireè¢«å†…è”ã€‚

Releaseæ–¹æ³•å°†å½“å‰è®¡æ•°å€¼å‡å»é‡Šæ”¾çš„èµ„æºæ•°nï¼Œå¹¶å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è°ƒç”¨è€…ï¼Œçœ‹æ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æºè¢«è·å–ã€‚

```
func (s *Weighted) Release(n int64) {
		s.mu.Lock()
		s.cur -= n
		if s.cur < 0 {
			s.mu.Unlock()
			panic("semaphore: released more than held")
		}
		s.notifyWaiters()
		s.mu.Unlock()
}
```

notifyWaitersæ–¹æ³•å°±æ˜¯é€ä¸ªæ£€æŸ¥ç­‰å¾…çš„è°ƒç”¨è€…ï¼Œå¦‚æœèµ„æºä¸å¤Ÿï¼Œæˆ–è€…æ˜¯æ²¡æœ‰ç­‰å¾…è€…äº†ï¼Œå°±è¿”å›ï¼š

```
func (s *Weighted) notifyWaiters() {
		for {
			next := s.waiters.Front()
			if next == nil {
				break // No more waiters blocked.
			}
	

			w := next.Value.(waiter)
			if s.size-s.cur < w.n {
				//é¿å…é¥¥é¥¿ï¼Œè¿™é‡Œè¿˜æ˜¯æŒ‰ç…§å…ˆå…¥å…ˆå‡ºçš„æ–¹å¼å¤„ç†
				break
			}

			s.cur += w.n
			s.waiters.Remove(next)
			close(w.ready)
		}
	}
```

notifyWaitersæ–¹æ³•æ˜¯æŒ‰ç…§å…ˆå…¥å…ˆå‡ºçš„æ–¹å¼å”¤é†’è°ƒç”¨è€…ã€‚å½“é‡Šæ”¾100ä¸ªèµ„æºçš„æ—¶å€™ï¼Œå¦‚æœç¬¬ä¸€ä¸ªç­‰å¾…è€…éœ€è¦101ä¸ªèµ„æºï¼Œé‚£ä¹ˆï¼Œé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ç­‰å¾…è€…éƒ½ä¼šç»§ç»­ç­‰å¾…ï¼Œå³ä½¿æœ‰çš„ç­‰å¾…è€…åªéœ€è¦1ä¸ªèµ„æºã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯é¿å…é¥¥é¥¿ï¼Œå¦åˆ™çš„è¯ï¼Œèµ„æºå¯èƒ½æ€»æ˜¯è¢«é‚£äº›è¯·æ±‚èµ„æºæ•°å°çš„è°ƒç”¨è€…è·å–ï¼Œè¿™æ ·ä¸€æ¥ï¼Œè¯·æ±‚èµ„æºæ•°å·¨å¤§çš„è°ƒç”¨è€…ï¼Œå°±æ²¡æœ‰æœºä¼šè·å¾—èµ„æºäº†ã€‚

å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼Œä½ å°±çŸ¥é“äº†å®˜æ–¹æ‰©å±•åº“çš„ä¿¡å·é‡å®ç°æ–¹æ³•ï¼Œæ¥ä¸‹æ¥ä½ å°±å¯ä»¥ä½¿ç”¨ä¿¡å·é‡äº†ã€‚ä¸è¿‡ï¼Œåœ¨æ­¤ä¹‹å‰å‘¢ï¼Œæˆ‘æƒ³ç»™ä½ è®²å‡ ä¸ªä½¿ç”¨æ—¶çš„å¸¸è§é”™è¯¯ã€‚è¿™éƒ¨åˆ†å†…å®¹å¯æ˜¯å¸®åŠ©ä½ é¿å‘çš„ï¼Œæˆ‘å»ºè®®ä½ å¥½å¥½å­¦ä¹ ã€‚

# ä½¿ç”¨ä¿¡å·é‡çš„å¸¸è§é”™è¯¯

ä¿è¯ä¿¡å·é‡ä¸å‡ºé”™çš„å‰ææ˜¯æ­£ç¡®åœ°ä½¿ç”¨å®ƒï¼Œå¦åˆ™ï¼Œå…¬å¹³æ€§å’Œå®‰å…¨æ€§å°±ä¼šå—åˆ°æŸå®³ï¼Œå¯¼è‡´ç¨‹åºpanicã€‚

åœ¨ä½¿ç”¨ä¿¡å·é‡æ—¶ï¼Œæœ€å¸¸è§çš„å‡ ä¸ªé”™è¯¯å¦‚ä¸‹ï¼š

- è¯·æ±‚äº†èµ„æºï¼Œä½†æ˜¯å¿˜è®°é‡Šæ”¾å®ƒï¼›
- é‡Šæ”¾äº†ä»æœªè¯·æ±‚çš„èµ„æºï¼›
- é•¿æ—¶é—´æŒæœ‰ä¸€ä¸ªèµ„æºï¼Œå³ä½¿ä¸éœ€è¦å®ƒï¼›
- ä¸æŒæœ‰ä¸€ä¸ªèµ„æºï¼Œå´ç›´æ¥ä½¿ç”¨å®ƒã€‚

ä¸è¿‡ï¼Œå³ä½¿ä½ è§„é¿äº†è¿™äº›å‘ï¼Œåœ¨åŒæ—¶ä½¿ç”¨å¤šç§èµ„æºï¼Œä¸åŒçš„ä¿¡å·é‡æ§åˆ¶ä¸åŒçš„èµ„æºçš„æ—¶å€™ï¼Œä¹Ÿå¯èƒ½ä¼šå‡ºç°æ­»é”ç°è±¡ï¼Œæ¯”å¦‚[å“²å­¦å®¶å°±é¤é—®é¢˜](https://en.wikipedia.org/wiki/Dining_philosophers_problem)ã€‚

å°±Goæ‰©å±•åº“å®ç°çš„ä¿¡å·é‡æ¥è¯´ï¼Œåœ¨è°ƒç”¨Releaseæ–¹æ³•çš„æ—¶å€™ï¼Œä½ å¯ä»¥ä¼ é€’ä»»æ„çš„æ•´æ•°ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ ä¼ é€’ä¸€ä¸ªæ¯”è¯·æ±‚åˆ°çš„æ•°é‡å¤§çš„é”™è¯¯çš„æ•°å€¼ï¼Œç¨‹åºå°±ä¼španicã€‚å¦‚æœä¼ é€’ä¸€ä¸ªè´Ÿæ•°ï¼Œä¼šå¯¼è‡´èµ„æºæ°¸ä¹…è¢«æŒæœ‰ã€‚å¦‚æœä½ è¯·æ±‚çš„èµ„æºæ•°æ¯”æœ€å¤§çš„èµ„æºæ•°è¿˜å¤§ï¼Œé‚£ä¹ˆï¼Œè°ƒç”¨è€…å¯èƒ½æ°¸è¿œè¢«é˜»å¡ã€‚

æ‰€ä»¥ï¼Œ**ä½¿ç”¨ä¿¡å·é‡éµå¾ªçš„åŸåˆ™å°±æ˜¯è¯·æ±‚å¤šå°‘èµ„æºï¼Œå°±é‡Šæ”¾å¤šå°‘èµ„æº**ã€‚ä½ ä¸€å®šè¦æ³¨æ„ï¼Œå¿…é¡»ä½¿ç”¨æ­£ç¡®çš„æ–¹æ³•ä¼ é€’æ•´æ•°ï¼Œä¸è¦â€œè€å°èªæ˜â€ï¼Œè€Œä¸”ï¼Œè¯·æ±‚çš„èµ„æºæ•°ä¸€å®šä¸è¦è¶…è¿‡æœ€å¤§èµ„æºæ•°ã€‚

# å…¶å®ƒä¿¡å·é‡çš„å®ç°

é™¤äº†å®˜æ–¹æ‰©å±•åº“çš„å®ç°ï¼Œå®é™…ä¸Šï¼Œæˆ‘ä»¬è¿˜æœ‰å¾ˆå¤šæ–¹æ³•å®ç°ä¿¡å·é‡ï¼Œæ¯”è¾ƒå…¸å‹çš„å°±æ˜¯ä½¿ç”¨Channelæ¥å®ç°ã€‚

æ ¹æ®ä¹‹å‰çš„Channelç±»å‹çš„ä»‹ç»ä»¥åŠGoå†…å­˜æ¨¡å‹çš„å®šä¹‰ï¼Œä½ åº”è¯¥èƒ½æƒ³åˆ°ï¼Œä½¿ç”¨ä¸€ä¸ªbufferä¸ºnçš„Channelå¾ˆå®¹æ˜“å®ç°ä¿¡å·é‡ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬å°±æ˜¯ä½¿ç”¨chan struct{}ç±»å‹æ¥å®ç°çš„ã€‚

åœ¨åˆå§‹åŒ–è¿™ä¸ªä¿¡å·é‡çš„æ—¶å€™ï¼Œæˆ‘ä»¬è®¾ç½®å®ƒçš„åˆå§‹å®¹é‡ï¼Œä»£è¡¨æœ‰å¤šå°‘ä¸ªèµ„æºå¯ä»¥ä½¿ç”¨ã€‚å®ƒä½¿ç”¨Lockå’ŒUnlockæ–¹æ³•å®ç°è¯·æ±‚èµ„æºå’Œé‡Šæ”¾èµ„æºï¼Œæ­£å¥½å®ç°äº†Lockeræ¥å£ã€‚

```
	// Semaphore æ•°æ®ç»“æ„ï¼Œå¹¶ä¸”è¿˜å®ç°äº†Lockeræ¥å£
	type semaphore struct {
		sync.Locker
		ch chan struct{}
	}
	
	// åˆ›å»ºä¸€ä¸ªæ–°çš„ä¿¡å·é‡
	func NewSemaphore(capacity int) sync.Locker {
		if capacity <= 0 {
			capacity = 1 // å®¹é‡ä¸º1å°±å˜æˆäº†ä¸€ä¸ªäº’æ–¥é”
		}
		return &semaphore{ch: make(chan struct{}, capacity)}
	}
	
	// è¯·æ±‚ä¸€ä¸ªèµ„æº
	func (s *semaphore) Lock() {
		s.ch <- struct{}{}
	}
	
	// é‡Šæ”¾èµ„æº
	func (s *semaphore) Unlock() {
		<-s.ch
	}
```

å½“ç„¶ï¼Œä½ è¿˜å¯ä»¥è‡ªå·±æ‰©å±•ä¸€äº›æ–¹æ³•ï¼Œæ¯”å¦‚åœ¨è¯·æ±‚èµ„æºçš„æ—¶å€™ä½¿ç”¨Contextå‚æ•°ï¼ˆAcquire(ctx)ï¼‰ã€å®ç°TryLockç­‰åŠŸèƒ½ã€‚

çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šé—®ï¼Œè¿™ä¸ªä¿¡å·é‡çš„å®ç°çœ‹èµ·æ¥éå¸¸ç®€å•ï¼Œè€Œä¸”ä¹Ÿèƒ½åº”å¯¹å¤§éƒ¨åˆ†çš„ä¿¡å·é‡çš„åœºæ™¯ï¼Œä¸ºä»€ä¹ˆå®˜æ–¹æ‰©å±•åº“çš„ä¿¡å·é‡çš„å®ç°ä¸é‡‡ç”¨è¿™ç§æ–¹æ³•å‘¢ï¼Ÿå…¶å®ï¼Œå…·ä½“æ˜¯ä»€ä¹ˆåŸå› ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œä½†æ˜¯æˆ‘å¿…é¡»è¦å¼ºè°ƒçš„æ˜¯ï¼Œå®˜æ–¹çš„å®ç°æ–¹å¼æœ‰è¿™æ ·ä¸€ä¸ªåŠŸèƒ½ï¼š**å®ƒå¯ä»¥ä¸€æ¬¡è¯·æ±‚å¤šä¸ªèµ„æºï¼Œè¿™æ˜¯é€šè¿‡Channelå®ç°çš„ä¿¡å·é‡æ‰€ä¸å…·å¤‡çš„**ã€‚

é™¤äº†Channelï¼Œ[marusama/semaphore](https://github.com/marusama/semaphore)ä¹Ÿå®ç°äº†ä¸€ä¸ªå¯ä»¥åŠ¨æ€æ›´æ”¹èµ„æºå®¹é‡çš„ä¿¡å·é‡ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸æœ‰ç‰¹è‰²çš„å®ç°ã€‚å¦‚æœä½ çš„èµ„æºæ•°é‡å¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæˆ‘å»ºè®®ä½ è€ƒè™‘ä¸€ä¸‹è¿™ä¸ªä¿¡å·é‡åº“ã€‚

# æ€»ç»“

è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„ç°è±¡ï¼šæ ‡å‡†åº“ä¸­å®ç°åŸºæœ¬å¹¶å‘åŸè¯­ï¼ˆæ¯”å¦‚Mutexï¼‰çš„æ—¶å€™ï¼Œå¼ºçƒˆä¾èµ–ä¿¡å·é‡å®ç°ç­‰å¾…é˜Ÿåˆ—å’Œé€šçŸ¥å”¤é†’ï¼Œä½†æ˜¯ï¼Œæ ‡å‡†åº“ä¸­å´æ²¡æœ‰æŠŠè¿™ä¸ªå®ç°ç›´æ¥æš´éœ²å‡ºæ¥æ”¾åˆ°æ ‡å‡†åº“ï¼Œè€Œæ˜¯é€šè¿‡ç¬¬ä¸‰åº“æä¾›ã€‚

ä¸ç®¡æ€æ ·ï¼Œä¿¡å·é‡è¿™ä¸ªå¹¶å‘åŸè¯­åœ¨å¤šèµ„æºå…±äº«çš„å¹¶å‘æ§åˆ¶çš„åœºæ™¯ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œæœ‰æ—¶å€™ä¹Ÿä¼šè¢«Channelç±»å‹æ‰€å–ä»£ï¼Œå› ä¸ºä¸€ä¸ªbuffered chanä¹Ÿå¯ä»¥ä»£è¡¨nä¸ªèµ„æºã€‚

ä½†æ˜¯ï¼Œå®˜æ–¹æ‰©å±•çš„ä¿¡å·é‡ä¹Ÿæœ‰å®ƒçš„ä¼˜åŠ¿ï¼Œå°±æ˜¯å¯ä»¥ä¸€æ¬¡è·å–å¤šä¸ªèµ„æºã€‚**åœ¨æ‰¹é‡è·å–èµ„æºçš„åœºæ™¯ä¸­ï¼Œæˆ‘å»ºè®®ä½ å°è¯•ä½¿ç”¨å®˜æ–¹æ‰©å±•çš„ä¿¡å·é‡**ã€‚

![](https://static001.geekbang.org/resource/image/67/73/674bc464d4e3d11c96fa1ac71d317e73.jpg?wh=2250%2A1413)

# æ€è€ƒé¢˜

1. ä½ èƒ½ç”¨Channelå®ç°ä¿¡å·é‡å¹¶å‘åŸè¯­å—ï¼Ÿä½ èƒ½æƒ³åˆ°å‡ ç§å®ç°æ–¹å¼ï¼Ÿ
2. ä¸ºä»€ä¹ˆä¿¡å·é‡çš„èµ„æºæ•°è®¾è®¡æˆint64è€Œä¸æ˜¯uint64å‘¢ï¼Ÿ

æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµè®¨è®ºã€‚å¦‚æœä½ è§‰å¾—æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>æœ¨å¤´å‘èŠ½</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>semaphoreæ˜¯ç”¨Mutexå’ŒChannelé€šçŸ¥å®ç°çš„,è€ŒMutexåˆä¾èµ–äºgoå†…éƒ¨çš„ä¿¡å·é‡å®ç°,é‚£è¿™ä¸ªå†…éƒ¨çš„ä¿¡å·é‡åˆæ˜¯ç”¨ä»€ä¹ˆå®ç°çš„?</p>2020-12-14</li><br/><li><span>åˆšå­</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä¸æ˜¯å¾ˆç†è§£è¿™å¥è¯ ï¼š&quot;ä¸€æ¬¡è¯·æ±‚å¤šä¸ªèµ„æºï¼Œè¿™æ˜¯é€šè¿‡ Channel å®ç°çš„ä¿¡å·é‡æ‰€ä¸å…·å¤‡çš„ã€‚&quot;
Channel ä¹Ÿå¯ä»¥å¼€å¯å¤šä¸ªgoroutine å»è¯·æ±‚å¤šä¸ªèµ„æº</p>2020-11-16</li><br/><li><span>lufofire</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>
import (
	&quot;context&quot;
	&quot;errors&quot;
)

type ChannelSemaphore struct {
	ch chan struct{}
}

func NewChannelSemaphore(size int) *ChannelSemaphore {
	return &amp;ChannelSemaphore{
		ch: make(chan struct{}, size),
	}
}

func (s *ChannelSemaphore) Acquire(ctx context.Context, n int64) error {
	&#47;&#47; åˆ¤æ–­ç”³è¯·æ•°é‡å¤§äºå®¹é‡
	if n &gt; int64(cap(s.ch)) {
		return errors.New(&quot;acquire too many&quot;)
	}

	for i := int64(0); i &lt; n; i++ {
		select {
		case s.ch &lt;- struct{}{}:
		case &lt;-ctx.Done():
			return ctx.Err()
		}
	}
	return nil
}

func (s *ChannelSemaphore) Release(ctx context.Context, n int64) error {
	&#47;&#47; åˆ¤æ–­é‡Šæ”¾æ•°é‡å¤§äºå®¹é‡
	if n &gt; int64(cap(s.ch)) {
		return errors.New(&quot;release too many&quot;)
	}

	for i := int64(0); i &lt; n; i++ {
		select {
		case &lt;-s.ch:
		case &lt;-ctx.Done():
			return ctx.Err()
		}
	}
	return nil
}
</p>2024-12-25</li><br/><li><span>Geek_2c2c44</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>åŸºäºchannelçš„lockå®ç°è¿™é‡Œï¼Œ Lockå’ŒUnLockçš„å®ç°äº’æ¢ä¸€ä¸‹é¡ºåºæ˜¯ä¸æ˜¯ä¹Ÿæ˜¯å¯ä»¥çš„å‘¢ï¼Ÿå¦‚æœå¯»Accquireï¼ˆPï¼‰æ˜¯å‡å»ä¿¡å·é‡çš„è§„èŒƒçš„è¯ï¼Œ æ˜¯ä¸æ˜¯locké‚£é‡ŒæŠŠchannelå†™åœ¨å³è¾¹ä¼šæ›´å¥½ï¼ˆä»channelä¸­æ‹¿å‡ºä¸€ä¸ªä¿¡å·é‡ï¼‰ï¼ŸPSï¼šå‰é¢ä¸€èŠ‚çš„Locké¡ºåºå’Œè¿™é‡Œå°±æ˜¯ä¸åŒçš„</p>2024-01-24</li><br/><li><span>ç™½å¼€dæ°´</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ‰“å¡</p>2023-03-23</li><br/><li><span>Geek_a6104e</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>return &amp;semaphore{ch: make(chan struct{}, capacity)} è¯·é—®ä¸€ä¸‹æœ€åä¸€ä¸ªä¾‹å­semaphoreç»“æ„åˆå§‹åŒ–ä¸ºå•¥ä¼šå¤šä¸ªcapacity</p>2022-07-31</li><br/><li><span>8.13.3.27.30</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ‰“å¡å®Œæˆ</p>2022-01-06</li><br/><li><span>ä¼Ÿä¼Ÿ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ6ï¼‰<p>type Semaphore chan struct{}

func NewSemaphore(cap int) Semaphore {
	return make(chan struct{}, cap)
}

func (s Semaphore) Acquire(n int) {
	for i := 0; i &lt; n; i++ {
		s &lt;- struct{}{}
	}
}

func (s Semaphore) Release(n int) {
	for i := 0; i &lt; n; i++ {
		&lt;-s
	}
}

func NewSemaphore2(cap int) Semaphore {
	sem := make(chan struct{}, cap)
	for i := 0; i &lt; cap; i++ {
		sem &lt;- struct{}{}
	}
	return sem
}

func (s Semaphore) Acquire2(n int) {
	for i := 0; i &lt; n; i++ {
		&lt;-s
	}
}

func (s Semaphore) Release2(n int) {
	for i := 0; i &lt; n; i++ {
		s &lt;- struct{}{}
	}
}</p>2020-11-23</li><br/><li><span>è™«å­æ¨±æ¡ƒ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆçš„ä¾‹å­é‡Œé¢ï¼Œæ˜¯é€šè¿‡ è®¡ç®—æœºçš„åç¨‹ runtime.GOMAXPROCS(0) æ¥æ¨¡æ‹Ÿæœ‰é™çš„èµ„æºï¼ˆæ¯”å–»ä¾‹å­é‡Œé¢çš„ä¹¦ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªsemaphoreçš„åœºæ™¯æ˜¯ä¸æ˜¯å°±æ˜¯æ¯”è¾ƒé€‚ç”¨äºè¯·æ±‚æœ‰æµé‡æˆ–è€…è°ƒç”¨æ¬¡æ•°é™åˆ¶çš„åœºæ™¯å‘¢ï¼Ÿ</p>2020-11-19</li><br/><li><span>Ethan Liu</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è€å¸ˆï¼ŒAcquireå‡½æ•°ä¸ºä»€ä¹ˆè¿˜ä¼šæœ‰ç¬¬äºŒä¸ªselectè¯­å¥ï¼Ÿè¿™éƒ¨åˆ†é€»è¾‘æ˜¯ä»€ä¹ˆå•Šï¼Ÿ</p>2020-11-17</li><br/><li><span>thomas</span> ğŸ‘ï¼ˆ20ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¡¥å……è¯´æ˜ä¸‹ ä¿¡å·é‡ p&#47;vçš„å«ä¹‰ï¼š
Pâ€”â€” passerenï¼Œä¸­æ–‡è¯‘ä¸º&quot;é€šè¿‡&quot;ï¼ŒVâ€”â€” vrijgevenï¼Œä¸­æ–‡è¯‘ä¸º&quot;é‡Šæ”¾&quot; ï¼ˆå› ä¸ºä½œè€…æ˜¯è·å…°äººï¼Œä¸Šé¢å•è¯ä¸ºè·å…°è¯­ï¼‰</p>2021-01-01</li><br/><li><span>myrfy</span> ğŸ‘ï¼ˆ7ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç¬¬ä¸€ä¸ªé—®é¢˜:
è‡³å°‘ä¸¤ç§ï¼Œå†™å…¥chç®—è·å–ï¼Œè‡ªå·±è¯»å–chç®—è·å–

ç¬¬äºŒä¸ªé—®é¢˜åº”è¯¥æ˜¯é˜²æ­¢é”™è¯¯è·å–æˆ–è€…é‡Šæ”¾ä¿¡å·é‡æ—¶ï¼Œå‡ºç°è´Ÿæ•°æº¢å‡ºåˆ°æ— ç©·å¤§çš„é—®é¢˜ã€‚å¦‚æœæº¢å‡ºåˆ°æ— ç©·å¤§ï¼Œå°±ä¼šè®©ä¿¡å·é‡å¤±æ•ˆï¼Œä»è€Œå¯¼è‡´1è¢«ä¿æŠ¤èµ„æºæ›´å¤§è§„æ¨¡çš„ç ´å</p>2020-11-16</li><br/><li><span>å¤§æ¼ èƒ¡èåœ</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæ²¡æ€ä¹ˆä½¿ç”¨ä¿¡å·é‡semaphoreï¼Œä¸€èˆ¬ä½¿ç”¨channelæ¥è§£å†³è¿™ç§é—®é¢˜ã€‚
å¦å¤–ï¼Œå¹¶å‘çš„æ—¶å€™ä½¿ç”¨æ± åŒ–æŠ€æœ¯æ„Ÿè§‰æ›´åŠ é€šç”¨å§ã€‚</p>2020-11-21</li><br/><li><span>ç±³ç´é¦™å…‰</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>type Semaphore struct {
	c        chan struct{}
	acq, rel chan []struct{}
}

func NewSemaphore(cap int) Semaphore {
	return Semaphore{
		c:   make(chan struct{}, cap),
		acq: make(chan []struct{}, 1),
		rel: make(chan []struct{}, 1),
	}
}

func (s Semaphore) Acquire(n int) {
	s.acq &lt;- make([]struct{}, n)
	for range &lt;-s.acq {
		s.c &lt;- struct{}{}
	}
}

func (s Semaphore) Release(n int) {
	s.rel &lt;- make([]struct{}, n)
	for range &lt;-s.rel {
		&lt;-s.c
	}
}</p>2024-01-15</li><br/><li><span>å‹</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>https:&#47;&#47;github.com&#47;zzm996-zzm&#47;go-concurrent&#47;blob&#47;main&#47;semaphore&#47;semaphore.go
åŸºäºchanå®ç°çš„ä¿¡å·é‡ å…¶å®å’Œæ–‡ç« ä¸­çš„æ€è·¯æ˜¯ä¸€æ ·çš„ ä¸è¿‡å…¨éƒ½æ˜¯è‡ªå·±å®ç°çš„</p>2021-08-21</li><br/>
</ul>