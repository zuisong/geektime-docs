ä»Šå¤©æˆ‘ä»¬æ¥ç»§ç»­å­¦ä¹ åŸºå‡†æµ‹è¯•æ¡†æ¶JMHã€‚

## @Forkå’Œ@BenchmarkMode

åœ¨ä¸Šä¸€ç¯‡çš„æœ«å°¾ï¼Œæˆ‘ä»¬å·²ç»è¿è¡Œè¿‡ç”±JMHé¡¹ç›®ç¼–è¯‘ç”Ÿæˆçš„jaråŒ…äº†ã€‚ä¸‹é¢æ˜¯å®ƒçš„è¾“å‡ºç»“æœï¼š

```
$ java -jar target/benchmarks.jar
...
# JMH version: 1.21
# VM version: JDK 10.0.2, Java HotSpot(TM) 64-Bit Server VM, 10.0.2+13
# VM invoker: /Library/Java/JavaVirtualMachines/jdk-10.0.2.jdk/Contents/Home/bin/java
# VM options: <none>
# Warmup: 5 iterations, 10 s each
# Measurement: 5 iterations, 10 s each
# Timeout: 10 min per iteration
# Threads: 1 thread, will synchronize iterations
# Benchmark mode: Throughput, ops/time
# Benchmark: org.sample.MyBenchmark.testMethod

# Run progress: 0,00% complete, ETA 00:08:20
# Fork: 1 of 5
# Warmup Iteration   1: 1023500,647 ops/s
# Warmup Iteration   2: 1030767,909 ops/s
# Warmup Iteration   3: 1018212,559 ops/s
# Warmup Iteration   4: 1002045,519 ops/s
# Warmup Iteration   5: 1004210,056 ops/s
Iteration   1: 1010251,342 ops/s
Iteration   2: 1005717,344 ops/s
Iteration   3: 1004751,523 ops/s
Iteration   4: 1003034,640 ops/s
Iteration   5: 997003,830 ops/s

# Run progress: 20,00% complete, ETA 00:06:41
# Fork: 2 of 5
...

# Run progress: 80,00% complete, ETA 00:01:40
# Fork: 5 of 5
# Warmup Iteration   1: 988321,959 ops/s
# Warmup Iteration   2: 999486,531 ops/s
# Warmup Iteration   3: 1004856,886 ops/s
# Warmup Iteration   4: 1004810,860 ops/s
# Warmup Iteration   5: 1002332,077 ops/s
Iteration   1: 1011871,670 ops/s
Iteration   2: 1002653,844 ops/s
Iteration   3: 1003568,030 ops/s
Iteration   4: 1002724,752 ops/s
Iteration   5: 1001507,408 ops/s


Result "org.sample.MyBenchmark.testMethod":
  1004801,393 Â±(99.9%) 4055,462 ops/s [Average]
  (min, avg, max) = (992193,459, 1004801,393, 1014504,226), stdev = 5413,926
  CI (99.9%): [1000745,931, 1008856,856] (assumes normal distribution)


# Run complete. Total time: 00:08:22

...

Benchmark                Mode  Cnt        Score      Error  Units
MyBenchmark.testMethod  thrpt   25  1004801,393 Â± 4055,462  ops/s
```

åœ¨ä¸Šé¢è¿™æ®µè¾“å‡ºä¸­ï¼Œæˆ‘ä»¬æš‚ä¸”å¿½ç•¥æœ€å¼€å§‹çš„Warningä»¥åŠæ‰“å°å‡ºæ¥çš„é…ç½®ä¿¡æ¯ï¼Œç›´æ¥çœ‹æ¥ä¸‹æ¥è²Œä¼¼é‡å¤çš„äº”æ®µè¾“å‡ºã€‚

```
# Run progress: 0,00% complete, ETA 00:08:20
# Fork: 1 of 5
# Warmup Iteration   1: 1023500,647 ops/s
# Warmup Iteration   2: 1030767,909 ops/s
# Warmup Iteration   3: 1018212,559 ops/s
# Warmup Iteration   4: 1002045,519 ops/s
# Warmup Iteration   5: 1004210,056 ops/s
Iteration   1: 1010251,342 ops/s
Iteration   2: 1005717,344 ops/s
Iteration   3: 1004751,523 ops/s
Iteration   4: 1003034,640 ops/s
Iteration   5: 997003,830 ops/s
```

ä½ åº”è¯¥å·²ç»ç•™æ„åˆ°`Fork: 1 of 5`çš„å­—æ ·ã€‚è¿™é‡ŒæŒ‡çš„æ˜¯JMHä¼šForkå‡ºä¸€ä¸ªæ–°çš„Javaè™šæ‹Ÿæœºï¼Œæ¥è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•ã€‚

ä¹‹æ‰€ä»¥å¦å¤–å¯åŠ¨ä¸€ä¸ªJavaè™šæ‹Ÿæœºè¿›è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Œæ˜¯ä¸ºäº†è·å¾—ä¸€ä¸ªç›¸å¯¹å¹²å‡€çš„è™šæ‹Ÿæœºç¯å¢ƒã€‚

åœ¨ä»‹ç»åå°„çš„é‚£ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°±å·²ç»æ¼”ç¤ºè¿‡å› ä¸ºç±»å‹profileè¢«æ±¡æŸ“ï¼Œè€Œå¯¼è‡´æ— æ³•å†…è”çš„æƒ…å†µã€‚ä½¿ç”¨æ–°çš„è™šæ‹Ÿæœºï¼Œå°†æå¤§åœ°é™ä½è¢«ä¸Šè¿°æƒ…å†µå¹²æ‰°çš„å¯èƒ½æ€§ï¼Œä»è€Œä¿è¯æ›´åŠ ç²¾ç¡®çš„æ€§èƒ½æ•°æ®ã€‚

åœ¨ä»‹ç»è™šæ–¹æ³•å†…è”çš„é‚£ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è®²è§£è¿‡åŸºäºç±»å±‚æ¬¡åˆ†æçš„å®Œå…¨å†…è”ã€‚æ–°å¯åŠ¨çš„Javaè™šæ‹Ÿæœºï¼Œå…¶åŠ è½½çš„ä¸æµ‹è¯•æ— å…³çš„æŠ½è±¡ç±»å­ç±»æˆ–æ¥å£å®ç°ç›¸å¯¹è¾ƒå°‘ã€‚å› æ­¤ï¼Œå…·ä½“æ˜¯å¦è¿›è¡Œå®Œå…¨å†…è”å°†äº¤ç”±å¼€å‘äººå‘˜æ¥å†³å®šã€‚

å…³äºè¿™ç§æƒ…å†µï¼ŒJMHæä¾›äº†ä¸€ä¸ªæ€§èƒ½æµ‹è¯•æ¡ˆä¾‹\[1]ã€‚å¦‚æœä½ æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥ä¸‹è½½ä¸‹æ¥è‡ªå·±è·‘ä¸€éã€‚

é™¤äº†å¯¹å³æ—¶ç¼–è¯‘å™¨çš„å½±å“ä¹‹å¤–ï¼ŒForkå‡ºæ–°çš„Javaè™šæ‹Ÿæœºè¿˜ä¼šæå‡æ€§èƒ½æ•°æ®çš„å‡†ç¡®åº¦ã€‚

è¿™ä¸»è¦æ˜¯å› ä¸ºä¸å°‘Javaè™šæ‹Ÿæœºçš„ä¼˜åŒ–ä¼šå¸¦æ¥ä¸ç¡®å®šæ€§ï¼Œä¾‹å¦‚TLABå†…å­˜åˆ†é…ï¼ˆTLABçš„å¤§å°ä¼šå˜åŒ–ï¼‰ï¼Œåå‘é”ã€è½»é‡é”ç®—æ³•ï¼Œå¹¶å‘æ•°æ®ç»“æ„ç­‰ã€‚è¿™äº›ä¸ç¡®å®šæ€§éƒ½å¯èƒ½å¯¼è‡´ä¸åŒJavaè™šæ‹Ÿæœºä¸­è¿è¡Œçš„æ€§èƒ½æµ‹è¯•çš„ç»“æœä¸åŒï¼Œä¾‹å¦‚JMHè¿™ä¸€æ€§èƒ½çš„æµ‹è¯•æ¡ˆä¾‹\[2]ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé€šè¿‡è¿è¡Œæ›´å¤šçš„Forkï¼Œå¹¶å°†æ¯ä¸ªJavaè™šæ‹Ÿæœºçš„æ€§èƒ½æµ‹è¯•ç»“æœå¹³å‡èµ·æ¥ï¼Œå¯ä»¥å¢å¼ºæœ€ç»ˆæ•°æ®çš„å¯ä¿¡åº¦ï¼Œä½¿å…¶è¯¯å·®æ›´å°ã€‚åœ¨JMHä¸­ï¼Œä½ å¯ä»¥é€šè¿‡`@Fork`æ³¨è§£æ¥é…ç½®ï¼Œå…·ä½“å¦‚ä¸‹è¿°ä»£ç æ‰€ç¤ºï¼š

```
@Fork(10)
public class MyBenchmark {
  ...
}
```

è®©æˆ‘ä»¬å›åˆ°åˆšåˆšçš„è¾“å‡ºç»“æœã€‚æ¯ä¸ªForkåŒ…å«äº†5ä¸ªé¢„çƒ­è¿­ä»£ï¼ˆwarmup iterationï¼Œå¦‚`# Warmup Iteration 1: 1023500,647 ops/s`ï¼‰ä»¥åŠ5ä¸ªæµ‹è¯•è¿­ä»£ï¼ˆmeasurement iterationï¼Œå¦‚`IterationÂ  Â 1: 1010251,342 ops/s`ï¼‰ã€‚

æ¯ä¸ªè¿­ä»£åéƒ½è·Ÿç€ä¸€ä¸ªæ•°æ®ï¼Œä»£è¡¨æœ¬æ¬¡è¿­ä»£çš„ååé‡ï¼Œä¹Ÿå°±æ˜¯æ¯ç§’è¿è¡Œäº†å¤šå°‘æ¬¡æ“ä½œï¼ˆoperations/sï¼Œæˆ–ops/sï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€æ¬¡æ“ä½œæŒ‡çš„æ˜¯è°ƒç”¨ä¸€æ¬¡æµ‹è¯•æ–¹æ³•`testMethod`ã€‚

é™¤äº†ååé‡ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è¾“å‡ºå…¶ä»–æ ¼å¼çš„æ€§èƒ½æ•°æ®ï¼Œä¾‹å¦‚è¿è¡Œä¸€æ¬¡æ“ä½œçš„å¹³å‡æ—¶é—´ã€‚å…·ä½“çš„é…ç½®æ–¹æ³•ä»¥åŠå¯¹åº”å‚æ•°å¦‚ä¸‹è¿°ä»£ç ä»¥åŠä¸‹è¡¨æ‰€ç¤ºï¼š

```
@BenchmarkMode(Mode.AverageTime)
public class MyBenchmark {
  ...
}
```

ä¸€èˆ¬æ¥è¯´ï¼Œé»˜è®¤ä½¿ç”¨çš„ååé‡å·²è¶³å¤Ÿæ»¡è¶³å¤§å¤šæ•°æµ‹è¯•éœ€æ±‚äº†ã€‚

## @Warmupå’Œ@Measurement

ä¹‹æ‰€ä»¥åŒºåˆ†é¢„çƒ­è¿­ä»£å’Œæµ‹è¯•è¿­ä»£ï¼Œæ˜¯ä¸ºäº†åœ¨è®°å½•æ€§èƒ½æ•°æ®ä¹‹å‰ï¼Œå°†Javaè™šæ‹Ÿæœºå¸¦è‡³ä¸€ä¸ªç¨³å®šçŠ¶æ€ã€‚

è¿™é‡Œçš„ç¨³å®šçŠ¶æ€ï¼Œä¸ä»…åŒ…æ‹¬æµ‹è¯•æ–¹æ³•è¢«å³æ—¶ç¼–è¯‘æˆæœºå™¨ç ï¼Œè¿˜åŒ…æ‹¬Javaè™šæ‹Ÿæœºä¸­å„ç§è‡ªé€‚é…ä¼˜åŒ–ç®—æ³•èƒ½å¤Ÿç¨³å®šä¸‹æ¥ï¼Œå¦‚å‰é¢æåˆ°çš„TLABå¤§å°ï¼Œäº¦æˆ–è€…æ˜¯ä½¿ç”¨ä¼ ç»Ÿåƒåœ¾å›æ”¶å™¨æ—¶çš„EdenåŒºã€SurvivoråŒºå’Œè€å¹´ä»£çš„å¤§å°ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œé¢„çƒ­è¿­ä»£çš„æ•°ç›®ä»¥åŠæ¯æ¬¡é¢„çƒ­è¿­ä»£çš„æ—¶é—´ï¼Œéœ€è¦ç”±ä½ æ ¹æ®æ‰€è¦æµ‹è¯•çš„ä¸šåŠ¡é€»è¾‘ä»£ç æ¥è°ƒé…ã€‚é€šå¸¸çš„åšæ³•ä¾¿æ˜¯åœ¨é¦–æ¬¡è¿è¡Œæ—¶é…ç½®è¾ƒå¤šæ¬¡è¿­ä»£ï¼Œå¹¶ç›‘æ§æ€§èƒ½æ•°æ®è¾¾åˆ°ç¨³å®šçŠ¶æ€æ—¶çš„è¿­ä»£æ•°ç›®ã€‚

ä¸å°‘æ€§èƒ½è¯„æµ‹æ¡†æ¶éƒ½ä¼šè‡ªåŠ¨æ£€æµ‹ç¨³å®šçŠ¶æ€ã€‚å®ƒä»¬æ‰€é‡‡ç”¨çš„ç®—æ³•æ˜¯è®¡ç®—è¿­ä»£ä¹‹é—´çš„å·®å€¼ï¼Œå¦‚æœè¿ç»­å‡ ä¸ªè¿­ä»£ä¸å‰ä¸€è¿­ä»£çš„å·®å€¼å‡å°äºæŸä¸ªå€¼ï¼Œä¾¿å°†è¿™å‡ ä¸ªè¿­ä»£ä»¥åŠä¹‹åçš„è¿­ä»£å½“æˆç¨³å®šçŠ¶æ€ã€‚

è¿™ç§åšæ³•æœ‰ä¸€ä¸ªç¼ºé™·ï¼Œé‚£ä¾¿æ˜¯åœ¨è¾¾åˆ°æœ€ç»ˆç¨³å®šçŠ¶æ€å‰ï¼Œç¨‹åºå¯èƒ½æ‹¥æœ‰å¤šä¸ªä¸­é—´ç¨³å®šçŠ¶æ€ã€‚ä¾‹å¦‚é€šè¿‡Javaä¸Šçš„JavaScriptå¼•æ“Nashornè¿è¡ŒJavaScriptä»£ç ï¼Œä¾¿å¯èƒ½å‡ºç°å¤šä¸ªä¸­é—´ç¨³å®šçŠ¶æ€çš„æƒ…å†µã€‚ï¼ˆå…·ä½“å¯å‚è€ƒAleksey Shipilevçš„devoxx 2013æ¼”è®²\[3]çš„ç¬¬21é¡µã€‚ï¼‰

æ€»è€Œè¨€ä¹‹ï¼Œå¼€å‘äººå‘˜éœ€è¦è‡ªè¡Œå†³å®šé¢„çƒ­è¿­ä»£çš„æ¬¡æ•°ä»¥åŠæ¯æ¬¡è¿­ä»£çš„æŒç»­æ—¶é—´ã€‚

é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä¼šåœ¨ä¿æŒ5-10ä¸ªé¢„çƒ­è¿­ä»£çš„å‰æä¸‹ï¼ˆè¿™æ ·å¯ä»¥çœ‹å‡ºæ˜¯å¦è¾¾åˆ°ç¨³å®šçŠ¶å†µï¼‰ï¼Œå°†æ€»çš„é¢„çƒ­æ—¶é—´ä¼˜åŒ–è‡³æœ€å°‘ï¼Œä»¥ä¾¿èŠ‚çœæ€§èƒ½æµ‹è¯•çš„æœºå™¨æ—¶é—´ã€‚ï¼ˆè¿™åœ¨æŒç»­é›†æˆ/å›å½’æµ‹è¯•çš„ç¡¬ä»¶èµ„æºè·Ÿä¸ä¸Šä»£ç æäº¤é€Ÿåº¦çš„å›¢é˜Ÿä¸­éå¸¸é‡è¦ã€‚ï¼‰

å½“ç¡®å®šäº†é¢„çƒ­è¿­ä»£çš„æ¬¡æ•°ä»¥åŠæ¯æ¬¡è¿­ä»£çš„æŒç»­æ—¶é—´ä¹‹åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡`@Warmup`æ³¨è§£æ¥è¿›è¡Œé…ç½®ï¼Œå¦‚ä¸‹è¿°ä»£ç æ‰€ç¤ºï¼š

```
@Warmup(iterations=10, time=100, timeUnit=TimeUnit.MILLISECONDS, batchSize=10)
public class MyBenchmark {
  ...
}
```

`@Warmup`æ³¨è§£æœ‰å››ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸ºé¢„çƒ­è¿­ä»£çš„æ¬¡æ•°`iterations`ï¼Œæ¯æ¬¡è¿­ä»£æŒç»­çš„æ—¶é—´`time`å’Œ`timeUnit`ï¼ˆå‰è€…æ˜¯æ•°å€¼ï¼Œåè€…æ˜¯å•ä½ã€‚ä¾‹å¦‚ä¸Šé¢ä»£ç ä»£è¡¨çš„æ˜¯æ¯æ¬¡è¿­ä»£æŒç»­100æ¯«ç§’ï¼‰ï¼Œä»¥åŠæ¯æ¬¡æ“ä½œåŒ…å«å¤šå°‘æ¬¡å¯¹æµ‹è¯•æ–¹æ³•çš„è°ƒç”¨`batchSize`ã€‚

æµ‹è¯•è¿­ä»£å¯é€šè¿‡`@Measurement`æ³¨è§£æ¥è¿›è¡Œé…ç½®ã€‚å®ƒçš„å¯é…ç½®é€‰é¡¹å’Œ`@Warmup`çš„ä¸€è‡´ï¼Œè¿™é‡Œå°±ä¸å†é‡å¤äº†ã€‚ä¸é¢„çƒ­è¿­ä»£ä¸åŒçš„æ˜¯ï¼Œæ¯ä¸ªForkä¸­æµ‹è¯•è¿­ä»£çš„æ•°ç›®è¶Šå¤šï¼Œæˆ‘ä»¬å¾—åˆ°çš„æ€§èƒ½æ•°æ®ä¹Ÿå°±è¶Šç²¾ç¡®ã€‚

## @Stateã€@Setupå’Œ@TearDown

é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬æ‰€è¦æµ‹è¯•çš„ä¸šåŠ¡é€»è¾‘åªæ˜¯æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­çš„ä¸€å°éƒ¨åˆ†ï¼Œä¾‹å¦‚æŸä¸ªå…·ä½“çš„web appè¯·æ±‚ã€‚è¿™è¦æ±‚åœ¨æ¯æ¬¡è°ƒç”¨æµ‹è¯•æ–¹æ³•å‰ï¼Œç¨‹åºå¤„äºå‡†å¤‡æ¥æ”¶è¯·æ±‚çš„çŠ¶æ€ã€‚

æˆ‘ä»¬å¯ä»¥æŠŠä¸Šè¿°åœºæ™¯æŠ½è±¡ä¸€ä¸‹ï¼Œå˜æˆç¨‹åºä»æŸç§çŠ¶æ€åˆ°å¦ä¸€ç§çŠ¶æ€çš„è½¬æ¢ï¼Œè€Œæ€§èƒ½æµ‹è¯•ï¼Œä¾¿æ˜¯åœ¨æ”¶é›†è¯¥è½¬æ¢çš„æ€§èƒ½æ•°æ®ã€‚

JMHæä¾›äº†`@State`æ³¨è§£ï¼Œè¢«å®ƒæ ‡æ³¨çš„ç±»ä¾¿æ˜¯ç¨‹åºçš„çŠ¶æ€ã€‚ç”±äºJMHå°†è´Ÿè´£ç”Ÿæˆè¿™äº›çŠ¶æ€ç±»çš„å®ä¾‹ï¼Œå› æ­¤ï¼Œå®ƒè¦æ±‚çŠ¶æ€ç±»å¿…é¡»æ‹¥æœ‰æ— å‚æ•°æ„é€ å™¨ï¼Œä»¥åŠå½“çŠ¶æ€ç±»ä¸ºå†…éƒ¨ç±»æ—¶ï¼Œè¯¥çŠ¶æ€ç±»å¿…é¡»æ˜¯é™æ€çš„ã€‚

JMHè¿˜å°†ç¨‹åºçŠ¶æ€ç»†åˆ†ä¸ºæ•´ä¸ªè™šæ‹Ÿæœºçš„ç¨‹åºçŠ¶æ€ï¼Œçº¿ç¨‹ç§æœ‰çš„ç¨‹åºçŠ¶æ€ï¼Œä»¥åŠçº¿ç¨‹ç»„ç§æœ‰çš„ç¨‹åºçŠ¶æ€ï¼Œåˆ†åˆ«å¯¹åº”`@State`æ³¨è§£çš„å‚æ•°`Scope.Benchmark`ï¼Œ`Scope.Thread`å’Œ`Scope.Group`ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„çº¿ç¨‹ç»„å¹¶éJDKä¸­çš„é‚£ä¸ªæ¦‚å¿µï¼Œè€Œæ˜¯JMHè‡ªå·±å®šä¹‰çš„æ¦‚å¿µã€‚å…·ä½“å¯ä»¥å‚è€ƒ`@GroupThreads`æ³¨è§£\[4]ï¼Œä»¥åŠè¿™ä¸ªæ¡ˆä¾‹\[5]ã€‚

`@State`çš„é…ç½®æ–¹æ³•ä»¥åŠçŠ¶æ€ç±»çš„ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š

```
public class MyBenchmark {
    @State(Scope.Benchmark)
    public static class MyBenchmarkState {
      String message = "exception";
    }

    @Benchmark
    public void testMethod(MyBenchmarkState state) {
        new Exception(state.message);
    }
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒçŠ¶æ€ç±»æ˜¯é€šè¿‡æ–¹æ³•å‚æ•°çš„æ–¹å¼ä¼ å…¥æµ‹è¯•æ–¹æ³•ä¹‹ä¸­çš„ã€‚JMHå°†è´Ÿè´£æŠŠæ‰€æ„é€ çš„çŠ¶æ€ç±»å®ä¾‹ä¼ å…¥è¯¥æ–¹æ³•ä¹‹ä¸­ã€‚

ä¸è¿‡ï¼Œå¦‚æœ`MyBenchmark`è¢«æ ‡æ³¨ä¸º`@State`ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä¸ç”¨åœ¨æµ‹è¯•æ–¹æ³•ä¸­å®šä¹‰é¢å¤–çš„å‚æ•°ï¼Œè€Œæ˜¯ç›´æ¥è®¿é—®`MyBenchmark`ç±»ä¸­çš„å®ä¾‹å˜é‡ã€‚

å’ŒJUnitæµ‹è¯•ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•å‰åˆå§‹åŒ–ç¨‹åºçŠ¶æ€ï¼Œåœ¨æµ‹è¯•åæ ¡éªŒç¨‹åºçŠ¶æ€ã€‚è¿™ä¸¤ç§æ“ä½œåˆ†åˆ«å¯¹åº”`@Setup`å’Œ`@TearDown`æ³¨è§£ï¼Œè¢«å®ƒä»¬æ ‡æ³¨çš„æ–¹æ³•å¿…é¡»æ˜¯çŠ¶æ€ç±»ä¸­çš„æ–¹æ³•ã€‚

è€Œä¸”ï¼ŒJMHå¹¶ä¸é™å®šçŠ¶æ€ç±»ä¸­`@Setup`æ–¹æ³•ä»¥åŠ`@TearDown`æ–¹æ³•çš„æ•°ç›®ã€‚å½“å­˜åœ¨å¤šä¸ª`@Setup`æ–¹æ³•æˆ–è€…`@TearDown`æ–¹æ³•æ—¶ï¼ŒJMHå°†æŒ‰ç…§å®šä¹‰çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚

JMHå¯¹`@Setup`æ–¹æ³•ä»¥åŠ`@TearDown`æ–¹æ³•çš„è°ƒç”¨æ—¶æœºæ˜¯å¯é…ç½®çš„ã€‚å¯ä¾›é€‰æ‹©çš„ç²’åº¦æœ‰åœ¨æ•´ä¸ªæ€§èƒ½æµ‹è¯•å‰åè°ƒç”¨ï¼Œåœ¨æ¯ä¸ªè¿­ä»£å‰åè°ƒç”¨ï¼Œä»¥åŠåœ¨æ¯æ¬¡è°ƒç”¨æµ‹è¯•æ–¹æ³•å‰åè°ƒç”¨ã€‚å…¶ä¸­ï¼Œæœ€åä¸€ä¸ªç²’åº¦å°†å½±å“æµ‹è¯•æ•°æ®çš„ç²¾åº¦ã€‚

è¿™ä¸‰ç§ç²’åº¦åˆ†åˆ«å¯¹åº”`@Setup`å’Œ`@TearDown`æ³¨è§£çš„å‚æ•°`Level.Trial`ï¼Œ`Level.Iteration`ï¼Œä»¥åŠ`Level.Invocation`ã€‚å…·ä½“çš„ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š

```
public class MyBenchmark {
  @State(Scope.Benchmark)
  public static class MyBenchmarkState {
    int count;

    @Setup(Level.Invocation)
    public void before() {
      count = 0;
    }

    @TearDown(Level.Invocation)
    public void after() {
      // Run with -ea
      assert count == 1 : "ERROR";
    }
  }

  @Benchmark
  public void testMethod(MyBenchmarkState state) {
    state.count++;
  }
}
```

## å³æ—¶ç¼–è¯‘ç›¸å…³åŠŸèƒ½

JMHè¿˜æä¾›äº†ä¸å°‘æ§åˆ¶å³æ—¶ç¼–è¯‘çš„åŠŸèƒ½ï¼Œä¾‹å¦‚å¯ä»¥æ§åˆ¶æ¯ä¸ªæ–¹æ³•å†…è”ä¸å¦çš„`@CompilerControl`æ³¨è§£\[6]ã€‚

å¦å¤–ä¸€ä¸ªæ›´å°ç²’åº¦çš„åŠŸèƒ½åˆ™æ˜¯`Blackhole`ç±»ã€‚å®ƒé‡Œè¾¹çš„`consume`æ–¹æ³•å¯ä»¥é˜²æ­¢å³æ—¶ç¼–è¯‘å™¨å°†æ‰€ä¼ å…¥çš„å€¼ç»™ä¼˜åŒ–æ‰ã€‚

å…·ä½“çš„ä½¿ç”¨æ–¹æ³•ä¾¿æ˜¯ä¸ºè¢«`@Benchmark`æ³¨è§£æ ‡æ³¨äº†çš„æµ‹è¯•æ–¹æ³•å¢æ·»ä¸€ä¸ªç±»å‹ä¸º`Blackhole`çš„å‚æ•°ï¼Œå¹¶ä¸”åœ¨æµ‹è¯•æ–¹æ³•çš„ä»£ç ä¸­è°ƒç”¨å…¶å®ä¾‹æ–¹æ³•`Blackhole.consume`ï¼Œå¦‚ä¸‹è¿°ä»£ç æ‰€ç¤ºï¼š

```
@Benchmark
public void testMethod(Blackhole bh) {
  bh.consume(new Object()); // prevents escape analysis
}
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒå¹¶ä¸ä¼šé˜»æ­¢å¯¹ä¼ å…¥å€¼çš„è®¡ç®—çš„ä¼˜åŒ–ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸‹é¢è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘å°†`3+4`çš„å€¼ä¼ å…¥`Blackhole.consume`æ–¹æ³•ä¸­ã€‚å³æ—¶ç¼–è¯‘å™¨ä»æ—§ä¼šè¿›è¡Œå¸¸é‡æŠ˜å ï¼Œè€Œ`Blackhole`å°†é˜»æ­¢å³æ—¶ç¼–è¯‘å™¨æŠŠæ‰€å¾—åˆ°çš„å¸¸é‡å€¼7ç»™ä¼˜åŒ–æ¶ˆé™¤æ‰ã€‚

```
@Benchmark
public void testMethod(Blackhole bh) {
  bh.consume(3+4);
}
```

é™¤äº†é˜²æ­¢æ­»ä»£ç æ¶ˆé™¤çš„`consume`ä¹‹å¤–ï¼Œ`Blackhole`ç±»è¿˜æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³•`consumeCPU`ï¼Œæ¥æ¶ˆè€—CPUæ—¶é—´ã€‚è¯¥æ–¹æ³•å°†æ¥æ”¶ä¸€ä¸ªlongç±»å‹çš„å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°ä¸æ‰€æ¶ˆè€—çš„CPUæ—¶é—´å‘ˆçº¿æ€§ç›¸å…³ã€‚

## æ€»ç»“ä¸å®è·µ

ä»Šå¤©æˆ‘ä»‹ç»äº†åŸºå‡†æµ‹è¯•æ¡†æ¶JMHçš„è¿›é˜¶åŠŸèƒ½ã€‚æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹ã€‚

- `@Fork`å…è®¸å¼€å‘äººå‘˜æŒ‡å®šæ‰€è¦Forkå‡ºçš„Javaè™šæ‹Ÿæœºçš„æ•°ç›®ã€‚
- `@BenchmarkMode`å…è®¸æŒ‡å®šæ€§èƒ½æ•°æ®çš„æ ¼å¼ã€‚
- `@Warmup`å’Œ`@Measurement`å…è®¸é…ç½®é¢„çƒ­è¿­ä»£æˆ–è€…æµ‹è¯•è¿­ä»£çš„æ•°ç›®ï¼Œæ¯ä¸ªè¿­ä»£çš„æ—¶é—´ä»¥åŠæ¯ä¸ªæ“ä½œåŒ…å«å¤šå°‘æ¬¡å¯¹æµ‹è¯•æ–¹æ³•çš„è°ƒç”¨ã€‚
- `@State`å…è®¸é…ç½®æµ‹è¯•ç¨‹åºçš„çŠ¶æ€ã€‚æµ‹è¯•å‰å¯¹ç¨‹åºçŠ¶æ€çš„åˆå§‹åŒ–ä»¥åŠæµ‹è¯•åå¯¹ç¨‹åºçŠ¶æ€çš„æ¢å¤æˆ–è€…æ ¡éªŒå¯åˆ†åˆ«é€šè¿‡`@Setup`å’Œ`@TearDown`æ¥å®ç°ã€‚

* * *

ä»Šå¤©çš„å®è·µç¯èŠ‚ï¼Œè¯·é€ä¸ªè¿è¡ŒJMHçš„å®˜æ–¹æ¡ˆä¾‹\[7]ï¼Œå…·ä½“æ¯ä¸ªæ¡ˆä¾‹çš„æ„ä¹‰éƒ½åœ¨ä»£ç æ³¨é‡Šä¹‹ä¸­ã€‚

æœ€åç»™å¤§å®¶æ¨èä¸€ä¸‹Aleksey Shipilevçš„devoxx 2013æ¼”è®²ï¼ˆSlides\[8]ï¼›è§†é¢‘\[9]ï¼Œè¯·è‡ªå¤‡æ¢¯å­ï¼‰ã€‚å¦‚æœä½ å·²ç»å®Œæˆæœ¬ä¸“æ å‰é¢ä¸¤éƒ¨åˆ†ï¼Œç‰¹åˆ«æ˜¯ç¬¬äºŒéƒ¨åˆ†çš„å­¦ä¹ ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¼”è®²é‡Œçš„ç»å¤§éƒ¨åˆ†å†…å®¹ä½ åº”è¯¥éƒ½èƒ½ç†è§£ã€‚

\[1] [http://hg.openjdk.java.net/code-tools/jmh/file/3769055ad883/jmh-samples/src/main/java/org/openjdk/jmh/samples/JMHSample\_12\_Forking.java](http://hg.openjdk.java.net/code-tools/jmh/file/3769055ad883/jmh-samples/src/main/java/org/openjdk/jmh/samples/JMHSample_12_Forking.java)  
\[2] [http://hg.openjdk.java.net/code-tools/jmh/file/3769055ad883/jmh-samples/src/main/java/org/openjdk/jmh/samples/JMHSample\_13\_RunToRun.java](http://hg.openjdk.java.net/code-tools/jmh/file/3769055ad883/jmh-samples/src/main/java/org/openjdk/jmh/samples/JMHSample_13_RunToRun.java)  
\[3] [https://shipilev.net/talks/devoxx-Nov2013-benchmarking.pdf](https://shipilev.net/talks/devoxx-Nov2013-benchmarking.pdf)  
\[4] [http://hg.openjdk.java.net/code-tools/jmh/file/3769055ad883/jmh-core/src/main/java/org/openjdk/jmh/annotations/GroupThreads.java](http://hg.openjdk.java.net/code-tools/jmh/file/3769055ad883/jmh-core/src/main/java/org/openjdk/jmh/annotations/GroupThreads.java)  
\[5] [http://hg.openjdk.java.net/code-tools/jmh/file/3769055ad883/jmh-samples/src/main/java/org/openjdk/jmh/samples/JMHSample\_15\_Asymmetric.java](http://hg.openjdk.java.net/code-tools/jmh/file/3769055ad883/jmh-samples/src/main/java/org/openjdk/jmh/samples/JMHSample_15_Asymmetric.java)  
\[6] [http://hg.openjdk.java.net/code-tools/jmh/file/3769055ad883/jmh-core/src/main/java/org/openjdk/jmh/annotations/CompilerControl.java](http://hg.openjdk.java.net/code-tools/jmh/file/3769055ad883/jmh-core/src/main/java/org/openjdk/jmh/annotations/CompilerControl.java)  
\[7] [http://hg.openjdk.java.net/code-tools/jmh/file/3769055ad883/jmh-samples/src/main/java/org/openjdk/jmh/samples](http://hg.openjdk.java.net/code-tools/jmh/file/3769055ad883/jmh-samples/src/main/java/org/openjdk/jmh/samples)  
\[8] [https://shipilev.net/talks/devoxx-Nov2013-benchmarking.pdf](https://shipilev.net/talks/devoxx-Nov2013-benchmarking.pdf)  
\[9] [https://www.youtube.com/watch?v=VaWgOCDBxYw](https://www.youtube.com/watch?v=VaWgOCDBxYw)
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ6ï¼‰</strong></div><ul>
<li><span>æ°¸çƒæ˜Ÿå…‰</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è€å¸ˆ @Stateæ³¨è§£ è¿™ä¸ªç¨‹åºçŠ¶æ€ç±» å®åœ¨æ²¡æœ‰çœ‹æ‡‚ï¼Œå…¶ç”¨å¤„åœ¨äºä»€ä¹ˆï¼Ÿ</p>2018-10-12</li><br/><li><span>the geek</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>çœ‹ç½‘ä¸Šå…¶ä»–æ–‡ç« ï¼Œéƒ½æ˜¯è¯´@Stateæ³¨è§£æ˜¯ç”¨æ¥è®¾ç½®æ ‡æ³¨ç±»çš„å®ä¾‹èŒƒå›´ã€‚æ€§èƒ½æµ‹è¯•ç±»ç”±JMHç®¡ç†ï¼Œå’Œspringçš„@Scopeæ³¨è§£ç›¸ä¼¼ã€‚</p>2020-02-10</li><br/><li><span>éšå¿ƒè€Œè‡³</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>åŠ¨æ‰‹åšä¸€éï¼Œæ„Ÿå—ä¼šæ›´æ·±äº›</p>2019-10-29</li><br/><li><span>cras</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>éœ€è¦é‚£äº›åŸºç¡€çŸ¥è¯†æ‰å¬å¾—æ‡‚è€å¸ˆçš„å†…å®¹?</p>2019-09-08</li><br/><li><span>neohope</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å»ºè®®è€å¸ˆç»™ä¸€ä¸ªæ›´è´´åˆç”Ÿäº§ç¯å¢ƒçš„ä¾‹å­ï¼Œæ¯”å¦‚ç”¨JMHæµ‹è¯•SpringBoot RestControllerçš„æ€§èƒ½ï¼Œå¯èƒ½æ•ˆæœä¼šæ›´å¥½ä¸€äº›ï¼Ÿ</p>2019-09-07</li><br/><li><span>HELSING</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>éƒ‘è€å¸ˆï¼Œèƒ½ä¸èƒ½ä»‹ç»ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆZGCä¼šå¿«é‚£ä¹ˆå¤šå•Š</p>2018-09-26</li><br/>
</ul>