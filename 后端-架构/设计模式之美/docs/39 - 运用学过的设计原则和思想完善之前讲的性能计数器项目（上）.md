åœ¨[ç¬¬25èŠ‚](https://time.geekbang.org/column/article/179644)ã€[ç¬¬26èŠ‚](https://time.geekbang.org/column/article/179673)ä¸­ï¼Œæˆ‘ä»¬è®²äº†å¦‚ä½•å¯¹ä¸€ä¸ªæ€§èƒ½è®¡æ•°å™¨æ¡†æ¶è¿›è¡Œåˆ†æã€è®¾è®¡ä¸å®ç°ï¼Œå¹¶ä¸”å®è·µäº†ä¹‹å‰å­¦è¿‡çš„ä¸€äº›è®¾è®¡åŸåˆ™å’Œè®¾è®¡æ€æƒ³ã€‚å½“æ—¶æˆ‘ä»¬æåˆ°ï¼Œå°æ­¥å¿«è·‘ã€é€æ­¥è¿­ä»£æ˜¯ä¸€ç§éå¸¸å®ç”¨çš„å¼€å‘æ¨¡å¼ã€‚æ‰€ä»¥ï¼Œé’ˆå¯¹è¿™ä¸ªæ¡†æ¶çš„å¼€å‘ï¼Œæˆ‘ä»¬åˆ†å¤šä¸ªç‰ˆæœ¬æ¥é€æ­¥å®Œå–„ã€‚

åœ¨ç¬¬25ã€26èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†æ¡†æ¶çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œå®ƒåªåŒ…å«æœ€åŸºæœ¬çš„ä¸€äº›åŠŸèƒ½ï¼Œåœ¨è®¾è®¡ä¸å®ç°ä¸Šè¿˜æœ‰å¾ˆå¤šä¸è¶³ã€‚æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šé’ˆå¯¹è¿™äº›ä¸è¶³ï¼Œç»§ç»­è¿­ä»£å¼€å‘ä¸¤ä¸ªç‰ˆæœ¬ï¼šç‰ˆæœ¬2å’Œç‰ˆæœ¬3ï¼Œåˆ†åˆ«å¯¹åº”ç¬¬39èŠ‚å’Œç¬¬40èŠ‚çš„å†…å®¹ã€‚

åœ¨ç‰ˆæœ¬2ä¸­ï¼Œæˆ‘ä»¬ä¼šåˆ©ç”¨ä¹‹å‰å­¦è¿‡çš„é‡æ„æ–¹æ³•ï¼Œå¯¹ç‰ˆæœ¬1çš„è®¾è®¡ä¸å®ç°è¿›è¡Œé‡æ„ï¼Œè§£å†³ç‰ˆæœ¬1å­˜åœ¨çš„è®¾è®¡é—®é¢˜ï¼Œè®©å®ƒæ»¡è¶³ä¹‹å‰å­¦è¿‡çš„è®¾è®¡åŸåˆ™ã€æ€æƒ³ã€ç¼–ç¨‹è§„èŒƒã€‚åœ¨ç‰ˆæœ¬3ä¸­ï¼Œæˆ‘ä»¬å†å¯¹ç‰ˆæœ¬2è¿›è¡Œè¿­ä»£ï¼Œå¹¶ä¸”å®Œå–„æ¡†æ¶çš„åŠŸèƒ½å’ŒéåŠŸèƒ½éœ€æ±‚ï¼Œè®©å…¶æ»¡è¶³ç¬¬25èŠ‚è¯¾ä¸­ç½—åˆ—çš„æ‰€æœ‰éœ€æ±‚ã€‚

è¯ä¸å¤šè¯´ï¼Œè®©æˆ‘ä»¬æ­£å¼å¼€å§‹ç‰ˆæœ¬2çš„è®¾è®¡ä¸å®ç°å§ï¼

## å›é¡¾ç‰ˆæœ¬1çš„è®¾è®¡ä¸å®ç°

é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä¸€å—å›é¡¾ä¸€ä¸‹ç‰ˆæœ¬1çš„è®¾è®¡ä¸å®ç°ã€‚å½“ç„¶ï¼Œå¦‚æœæ—¶é—´å……è¶³ï¼Œä½ æœ€å¥½èƒ½å†é‡æ–°çœ‹ä¸€ä¸‹ç¬¬25ã€26èŠ‚çš„å†…å®¹ã€‚åœ¨ç‰ˆæœ¬1ä¸­ï¼Œæ•´ä¸ªæ¡†æ¶çš„ä»£ç è¢«åˆ’åˆ†ä¸ºä¸‹é¢è¿™å‡ ä¸ªç±»ã€‚

- MetricsCollectorï¼šè´Ÿè´£æ‰“ç‚¹é‡‡é›†åŸå§‹æ•°æ®ï¼ŒåŒ…æ‹¬è®°å½•æ¯æ¬¡æ¥å£è¯·æ±‚çš„å“åº”æ—¶é—´å’Œè¯·æ±‚æ—¶é—´æˆ³ï¼Œå¹¶è°ƒç”¨MetricsStorageæä¾›çš„æ¥å£æ¥å­˜å‚¨è¿™äº›åŸå§‹æ•°æ®ã€‚
- MetricsStorageå’ŒRedisMetricsStorageï¼šè´Ÿè´£åŸå§‹æ•°æ®çš„å­˜å‚¨å’Œè¯»å–ã€‚
- Aggregatorï¼šæ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œè´Ÿè´£å„ç§ç»Ÿè®¡æ•°æ®çš„è®¡ç®—ï¼Œæ¯”å¦‚å“åº”æ—¶é—´çš„æœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ã€ç™¾åˆ†ä½å€¼ã€æ¥å£è®¿é—®æ¬¡æ•°ã€tpsã€‚
- ConsoleReporterå’ŒEmailReporterï¼šç›¸å½“äºä¸€ä¸ªä¸Šå¸ç±»ï¼ˆGod Classï¼‰ï¼Œå®šæ—¶æ ¹æ®ç»™å®šçš„æ—¶é—´åŒºé—´ï¼Œä»æ•°æ®åº“ä¸­å–å‡ºæ•°æ®ï¼Œå€ŸåŠ©Aggregatorç±»å®Œæˆç»Ÿè®¡å·¥ä½œï¼Œå¹¶å°†ç»Ÿè®¡ç»“æœè¾“å‡ºåˆ°ç›¸åº”çš„ç»ˆç«¯ï¼Œæ¯”å¦‚å‘½ä»¤è¡Œã€é‚®ä»¶ã€‚

MetricCollectorã€MetricsStorageã€RedisMetricsStorageçš„è®¾è®¡ä¸å®ç°æ¯”è¾ƒç®€å•ï¼Œä¸æ˜¯ç‰ˆæœ¬2é‡æ„çš„é‡ç‚¹ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬é‡ç‚¹æ¥çœ‹ä¸€ä¸‹Aggregatorå’ŒConsoleReporterã€EmailReporterè¿™å‡ ä¸ªç±»ã€‚

**æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹Aggregatorç±»å­˜åœ¨çš„é—®é¢˜ã€‚**

Aggregatorç±»é‡Œé¢åªæœ‰ä¸€ä¸ªé™æ€å‡½æ•°ï¼Œæœ‰50è¡Œå·¦å³çš„ä»£ç é‡ï¼Œè´Ÿè´£å„ç§ç»Ÿè®¡æ•°æ®çš„è®¡ç®—ã€‚å½“è¦æ·»åŠ æ–°çš„ç»Ÿè®¡åŠŸèƒ½çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹aggregate()å‡½æ•°ä»£ç ã€‚ä¸€æ—¦è¶Šæ¥è¶Šå¤šçš„ç»Ÿè®¡åŠŸèƒ½æ·»åŠ è¿›æ¥ä¹‹åï¼Œè¿™ä¸ªå‡½æ•°çš„ä»£ç é‡ä¼šæŒç»­å¢åŠ ï¼Œå¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§å°±å˜å·®äº†ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç‰ˆæœ¬2ä¸­å¯¹å…¶è¿›è¡Œé‡æ„ã€‚

```
public class Aggregator {
  public static RequestStat aggregate(List<RequestInfo> requestInfos, long durationInMillis) {
    double maxRespTime = Double.MIN_VALUE;
    double minRespTime = Double.MAX_VALUE;
    double avgRespTime = -1;
    double p999RespTime = -1;
    double p99RespTime = -1;
    double sumRespTime = 0;
    long count = 0;
    for (RequestInfo requestInfo : requestInfos) {
      ++count;
      double respTime = requestInfo.getResponseTime();
      if (maxRespTime < respTime) {
        maxRespTime = respTime;
      }
      if (minRespTime > respTime) {
        minRespTime = respTime;
      }
      sumRespTime += respTime;
    }
    if (count != 0) {
      avgRespTime = sumRespTime / count;
    }
    long tps = (long)(count / durationInMillis * 1000);
    Collections.sort(requestInfos, new Comparator<RequestInfo>() {
      @Override
      public int compare(RequestInfo o1, RequestInfo o2) {
        double diff = o1.getResponseTime() - o2.getResponseTime();
        if (diff < 0.0) {
          return -1;
        } else if (diff > 0.0) {
          return 1;
        } else {
          return 0;
        }
      }
    });
 
    if (count != 0) {
      int idx999 = (int)(count * 0.999);
      int idx99 = (int)(count * 0.99);
      p999RespTime = requestInfos.get(idx999).getResponseTime();
      p99RespTime = requestInfos.get(idx99).getResponseTime();
    }
    RequestStat requestStat = new RequestStat();
    requestStat.setMaxResponseTime(maxRespTime);
    requestStat.setMinResponseTime(minRespTime);
    requestStat.setAvgResponseTime(avgRespTime);
    requestStat.setP999ResponseTime(p999RespTime);
    requestStat.setP99ResponseTime(p99RespTime);
    requestStat.setCount(count);
    requestStat.setTps(tps);
    return requestStat;
  }
}

public class RequestStat {
  private double maxResponseTime;
  private double minResponseTime;
  private double avgResponseTime;
  private double p999ResponseTime;
  private double p99ResponseTime;
  private long count;
  private long tps;
  //...çœç•¥getter/setteræ–¹æ³•...
}
```

**æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ConsoleReporterå’ŒEmailReporterè¿™ä¸¤ä¸ªç±»å­˜åœ¨çš„é—®é¢˜ã€‚**

ConsoleReporterå’ŒEmailReporterä¸¤ä¸ªç±»ä¸­å­˜åœ¨ä»£ç é‡å¤é—®é¢˜ã€‚åœ¨è¿™ä¸¤ä¸ªç±»ä¸­ï¼Œä»æ•°æ®åº“ä¸­å–æ•°æ®ã€åšç»Ÿè®¡çš„é€»è¾‘éƒ½æ˜¯ç›¸åŒçš„ï¼Œå¯ä»¥æŠ½å–å‡ºæ¥å¤ç”¨ï¼Œå¦åˆ™å°±è¿åäº†DRYåŸåˆ™ã€‚

æ•´ä¸ªç±»è´Ÿè´£çš„äº‹æƒ…æ¯”è¾ƒå¤šï¼Œä¸ç›¸å¹²çš„é€»è¾‘ç³…åˆåœ¨é‡Œé¢ï¼ŒèŒè´£ä¸å¤Ÿå•ä¸€ã€‚ç‰¹åˆ«æ˜¯æ˜¾ç¤ºéƒ¨åˆ†çš„ä»£ç å¯èƒ½ä¼šæ¯”è¾ƒå¤æ‚ï¼ˆæ¯”å¦‚Emailçš„æ˜¾ç¤ºæ–¹å¼ï¼‰ï¼Œæœ€å¥½èƒ½å°†è¿™éƒ¨åˆ†æ˜¾ç¤ºé€»è¾‘å‰¥ç¦»å‡ºæ¥ï¼Œè®¾è®¡æˆä¸€ä¸ªç‹¬ç«‹çš„ç±»ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œå› ä¸ºä»£ç ä¸­æ¶‰åŠçº¿ç¨‹æ“ä½œï¼Œå¹¶ä¸”è°ƒç”¨äº†Aggregatorçš„é™æ€å‡½æ•°ï¼Œæ‰€ä»¥ä»£ç çš„å¯æµ‹è¯•æ€§ä¹Ÿæœ‰å¾…æé«˜ã€‚

```
public class ConsoleReporter {
  private MetricsStorage metricsStorage;
  private ScheduledExecutorService executor;

  public ConsoleReporter(MetricsStorage metricsStorage) {
    this.metricsStorage = metricsStorage;
    this.executor = Executors.newSingleThreadScheduledExecutor();
  }

  public void startRepeatedReport(long periodInSeconds, long durationInSeconds) {
    executor.scheduleAtFixedRate(new Runnable() {
      @Override
      public void run() {
        long durationInMillis = durationInSeconds * 1000;
        long endTimeInMillis = System.currentTimeMillis();
        long startTimeInMillis = endTimeInMillis - durationInMillis;
        Map<String, List<RequestInfo>> requestInfos =
                metricsStorage.getRequestInfos(startTimeInMillis, endTimeInMillis);
        Map<String, RequestStat> stats = new HashMap<>();
        for (Map.Entry<String, List<RequestInfo>> entry : requestInfos.entrySet()) {
          String apiName = entry.getKey();
          List<RequestInfo> requestInfosPerApi = entry.getValue();
          RequestStat requestStat = Aggregator.aggregate(requestInfosPerApi, durationInMillis);
          stats.put(apiName, requestStat);
        }
        System.out.println("Time Span: [" + startTimeInMillis + ", " + endTimeInMillis + "]");
        Gson gson = new Gson();
        System.out.println(gson.toJson(stats));
      }
    }, 0, periodInSeconds, TimeUnit.SECONDS);
  }

}

public class EmailReporter {
  private static final Long DAY_HOURS_IN_SECONDS = 86400L;

  private MetricsStorage metricsStorage;
  private EmailSender emailSender;
  private List<String> toAddresses = new ArrayList<>();

  public EmailReporter(MetricsStorage metricsStorage) {
    this(metricsStorage, new EmailSender(/*çœç•¥å‚æ•°*/));
  }

  public EmailReporter(MetricsStorage metricsStorage, EmailSender emailSender) {
    this.metricsStorage = metricsStorage;
    this.emailSender = emailSender;
  }

  public void addToAddress(String address) {
    toAddresses.add(address);
  }

  public void startDailyReport() {
    Calendar calendar = Calendar.getInstance();
    calendar.add(Calendar.DATE, 1);
    calendar.set(Calendar.HOUR_OF_DAY, 0);
    calendar.set(Calendar.MINUTE, 0);
    calendar.set(Calendar.SECOND, 0);
    calendar.set(Calendar.MILLISECOND, 0);
    Date firstTime = calendar.getTime(); 
    Timer timer = new Timer();
    timer.schedule(new TimerTask() {
      @Override
      public void run() {
        long durationInMillis = DAY_HOURS_IN_SECONDS * 1000;
        long endTimeInMillis = System.currentTimeMillis();
        long startTimeInMillis = endTimeInMillis - durationInMillis;
        Map<String, List<RequestInfo>> requestInfos =
                metricsStorage.getRequestInfos(startTimeInMillis, endTimeInMillis);
        Map<String, RequestStat> stats = new HashMap<>();
        for (Map.Entry<String, List<RequestInfo>> entry : requestInfos.entrySet()) {
          String apiName = entry.getKey();
          List<RequestInfo> requestInfosPerApi = entry.getValue();
          RequestStat requestStat = Aggregator.aggregate(requestInfosPerApi, durationInMillis);
          stats.put(apiName, requestStat);
        }
        // TODO: æ ¼å¼åŒ–ä¸ºhtmlæ ¼å¼ï¼Œå¹¶ä¸”å‘é€é‚®ä»¶
      }
    }, firstTime, DAY_HOURS_IN_SECONDS * 1000);
  }

}
```

## é’ˆå¯¹ç‰ˆæœ¬1çš„é—®é¢˜è¿›è¡Œé‡æ„

Aggregatorç±»å’ŒConsoleReporterã€EmailReporterç±»ä¸»è¦è´Ÿè´£ç»Ÿè®¡æ˜¾ç¤ºçš„å·¥ä½œã€‚åœ¨ç¬¬26èŠ‚ä¸­ï¼Œæˆ‘ä»¬æåˆ°ï¼Œå¦‚æœæˆ‘ä»¬æŠŠç»Ÿè®¡æ˜¾ç¤ºæ‰€è¦å®Œæˆçš„åŠŸèƒ½é€»è¾‘ç»†åˆ†ä¸€ä¸‹ï¼Œä¸»è¦åŒ…å«ä¸‹é¢4ç‚¹ï¼š

1. æ ¹æ®ç»™å®šçš„æ—¶é—´åŒºé—´ï¼Œä»æ•°æ®åº“ä¸­æ‹‰å–æ•°æ®ï¼›
2. æ ¹æ®åŸå§‹æ•°æ®ï¼Œè®¡ç®—å¾—åˆ°ç»Ÿè®¡æ•°æ®ï¼›
3. å°†ç»Ÿè®¡æ•°æ®æ˜¾ç¤ºåˆ°ç»ˆç«¯ï¼ˆå‘½ä»¤è¡Œæˆ–é‚®ä»¶ï¼‰ï¼›
4. å®šæ—¶è§¦å‘ä»¥ä¸Šä¸‰ä¸ªè¿‡ç¨‹çš„æ‰§è¡Œã€‚

ä¹‹å‰çš„åˆ’åˆ†æ–¹æ³•æ˜¯å°†æ‰€æœ‰çš„é€»è¾‘éƒ½æ”¾åˆ°ConsoleReporterå’ŒEmailReporterè¿™ä¸¤ä¸ªä¸Šå¸ç±»ä¸­ï¼Œè€ŒAggregatoråªæ˜¯ä¸€ä¸ªåŒ…å«é™æ€æ–¹æ³•çš„å·¥å…·ç±»ã€‚è¿™æ ·çš„åˆ’åˆ†æ–¹æ³•å­˜åœ¨å‰é¢æåˆ°çš„ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œé‡æ–°åˆ’åˆ†ã€‚

é¢å‘å¯¹è±¡è®¾è®¡ä¸­çš„æœ€åä¸€æ­¥æ˜¯ç»„è£…ç±»å¹¶æä¾›æ‰§è¡Œå…¥å£ï¼Œæ‰€ä»¥ï¼Œç»„è£…å‰ä¸‰éƒ¨åˆ†é€»è¾‘çš„ä¸Šå¸ç±»æ˜¯å¿…é¡»è¦æœ‰çš„ã€‚æˆ‘ä»¬å¯ä»¥å°†ä¸Šå¸ç±»åšçš„å¾ˆè½»é‡çº§ï¼ŒæŠŠæ ¸å¿ƒé€»è¾‘éƒ½å‰¥ç¦»å‡ºå»ï¼Œå½¢æˆç‹¬ç«‹çš„ç±»ï¼Œä¸Šå¸ç±»åªè´Ÿè´£ç»„è£…ç±»å’Œä¸²è”æ‰§è¡Œæµç¨‹ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œä»£ç ç»“æ„æ›´åŠ æ¸…æ™°ï¼Œåº•å±‚æ ¸å¿ƒé€»è¾‘æ›´å®¹æ˜“è¢«å¤ç”¨ã€‚æŒ‰ç…§è¿™ä¸ªè®¾è®¡æ€è·¯ï¼Œå…·ä½“çš„é‡æ„å·¥ä½œåŒ…å«ä»¥ä¸‹4ä¸ªæ–¹é¢ã€‚

- ç¬¬1ä¸ªé€»è¾‘ï¼šæ ¹æ®ç»™å®šæ—¶é—´åŒºé—´ï¼Œä»æ•°æ®åº“ä¸­æ‹‰å–æ•°æ®ã€‚è¿™éƒ¨åˆ†é€»è¾‘å·²ç»è¢«å°è£…åœ¨MetricsStorageç±»ä¸­äº†ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†ä¸éœ€è¦å¤„ç†ã€‚
- ç¬¬2ä¸ªé€»è¾‘ï¼šæ ¹æ®åŸå§‹æ•°æ®ï¼Œè®¡ç®—å¾—åˆ°ç»Ÿè®¡æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥å°†è¿™éƒ¨åˆ†é€»è¾‘ç§»åŠ¨åˆ°Aggregatorç±»ä¸­ã€‚è¿™æ ·Aggregatorç±»å°±ä¸ä»…ä»…æ˜¯åªåŒ…å«ç»Ÿè®¡æ–¹æ³•çš„å·¥å…·ç±»äº†ã€‚æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œé‡æ„ä¹‹åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```
public class Aggregator {
  public Map<String, RequestStat> aggregate(
          Map<String, List<RequestInfo>> requestInfos, long durationInMillis) {
    Map<String, RequestStat> requestStats = new HashMap<>();
    for (Map.Entry<String, List<RequestInfo>> entry : requestInfos.entrySet()) {
      String apiName = entry.getKey();
      List<RequestInfo> requestInfosPerApi = entry.getValue();
      RequestStat requestStat = doAggregate(requestInfosPerApi, durationInMillis);
      requestStats.put(apiName, requestStat);
    }
    return requestStats;
  }

  private RequestStat doAggregate(List<RequestInfo> requestInfos, long durationInMillis) {
    List<Double> respTimes = new ArrayList<>();
    for (RequestInfo requestInfo : requestInfos) {
      double respTime = requestInfo.getResponseTime();
      respTimes.add(respTime);
    }

    RequestStat requestStat = new RequestStat();
    requestStat.setMaxResponseTime(max(respTimes));
    requestStat.setMinResponseTime(min(respTimes));
    requestStat.setAvgResponseTime(avg(respTimes));
    requestStat.setP999ResponseTime(percentile999(respTimes));
    requestStat.setP99ResponseTime(percentile99(respTimes));
    requestStat.setCount(respTimes.size());
    requestStat.setTps((long) tps(respTimes.size(), durationInMillis/1000));
    return requestStat;
  }

  // ä»¥ä¸‹çš„å‡½æ•°çš„ä»£ç å®ç°å‡çœç•¥...
  private double max(List<Double> dataset) {}
  private double min(List<Double> dataset) {}
  private double avg(List<Double> dataset) {}
  private double tps(int count, double duration) {}
  private double percentile999(List<Double> dataset) {}
  private double percentile99(List<Double> dataset) {}
  private double percentile(List<Double> dataset, double ratio) {}
}
```

- ç¬¬3ä¸ªé€»è¾‘ï¼šå°†ç»Ÿè®¡æ•°æ®æ˜¾ç¤ºåˆ°ç»ˆç«¯ã€‚æˆ‘ä»¬å°†è¿™éƒ¨åˆ†é€»è¾‘å‰¥ç¦»å‡ºæ¥ï¼Œè®¾è®¡æˆä¸¤ä¸ªç±»ï¼šConsoleViewerç±»å’ŒEmailViewerç±»ï¼Œåˆ†åˆ«è´Ÿè´£å°†ç»Ÿè®¡ç»“æœæ˜¾ç¤ºåˆ°å‘½ä»¤è¡Œå’Œé‚®ä»¶ä¸­ã€‚å…·ä½“çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š

```
public interface StatViewer {
  void output(Map<String, RequestStat> requestStats, long startTimeInMillis, long endTimeInMills);
}

public class ConsoleViewer implements StatViewer {
  public void output(
          Map<String, RequestStat> requestStats, long startTimeInMillis, long endTimeInMills) {
    System.out.println("Time Span: [" + startTimeInMillis + ", " + endTimeInMills + "]");
    Gson gson = new Gson();
    System.out.println(gson.toJson(requestStats));
  }
}

public class EmailViewer implements StatViewer {
  private EmailSender emailSender;
  private List<String> toAddresses = new ArrayList<>();

  public EmailViewer() {
    this.emailSender = new EmailSender(/*çœç•¥å‚æ•°*/);
  }

  public EmailViewer(EmailSender emailSender) {
    this.emailSender = emailSender;
  }

  public void addToAddress(String address) {
    toAddresses.add(address);
  }

  public void output(
          Map<String, RequestStat> requestStats, long startTimeInMillis, long endTimeInMills) {
    // format the requestStats to HTML style.
    // send it to email toAddresses.
  }
}
```

- ç¬¬4ä¸ªé€»è¾‘ï¼šç»„è£…ç±»å¹¶å®šæ—¶è§¦å‘æ‰§è¡Œç»Ÿè®¡æ˜¾ç¤ºã€‚åœ¨å°†æ ¸å¿ƒé€»è¾‘å‰¥ç¦»å‡ºæ¥ä¹‹åï¼Œè¿™ä¸ªç±»çš„ä»£ç å˜å¾—æ›´åŠ ç®€æ´ã€æ¸…æ™°ï¼Œåªè´Ÿè´£ç»„è£…å„ä¸ªç±»ï¼ˆMetricsStorageã€Aggegratorã€StatViewerï¼‰æ¥å®Œæˆæ•´ä¸ªå·¥ä½œæµç¨‹ã€‚é‡æ„ä¹‹åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```
public class ConsoleReporter {
  private MetricsStorage metricsStorage;
  private Aggregator aggregator;
  private StatViewer viewer;
  private ScheduledExecutorService executor;

  public ConsoleReporter(MetricsStorage metricsStorage, Aggregator aggregator, StatViewer viewer) {
    this.metricsStorage = metricsStorage;
    this.aggregator = aggregator;
    this.viewer = viewer;
    this.executor = Executors.newSingleThreadScheduledExecutor();
  }

  public void startRepeatedReport(long periodInSeconds, long durationInSeconds) {
    executor.scheduleAtFixedRate(new Runnable() {
      @Override
      public void run() {
        long durationInMillis = durationInSeconds * 1000;
        long endTimeInMillis = System.currentTimeMillis();
        long startTimeInMillis = endTimeInMillis - durationInMillis;
        Map<String, List<RequestInfo>> requestInfos =
                metricsStorage.getRequestInfos(startTimeInMillis, endTimeInMillis);
        Map<String, RequestStat> requestStats = aggregator.aggregate(requestInfos, durationInMillis);
        viewer.output(requestStats, startTimeInMillis, endTimeInMillis);
      }
    }, 0L, periodInSeconds, TimeUnit.SECONDS);
  }

}

public class EmailReporter {
  private static final Long DAY_HOURS_IN_SECONDS = 86400L;

  private MetricsStorage metricsStorage;
  private Aggregator aggregator;
  private StatViewer viewer;

  public EmailReporter(MetricsStorage metricsStorage, Aggregator aggregator, StatViewer viewer) {
    this.metricsStorage = metricsStorage;
    this.aggregator = aggregator;
    this.viewer = viewer;
  }

  public void startDailyReport() {
    Calendar calendar = Calendar.getInstance();
    calendar.add(Calendar.DATE, 1);
    calendar.set(Calendar.HOUR_OF_DAY, 0);
    calendar.set(Calendar.MINUTE, 0);
    calendar.set(Calendar.SECOND, 0);
    calendar.set(Calendar.MILLISECOND, 0);
    Date firstTime = calendar.getTime();
    Timer timer = new Timer();
    timer.schedule(new TimerTask() {
      @Override
      public void run() {
        long durationInMillis = DAY_HOURS_IN_SECONDS * 1000;
        long endTimeInMillis = System.currentTimeMillis();
        long startTimeInMillis = endTimeInMillis - durationInMillis;
        Map<String, List<RequestInfo>> requestInfos =
                metricsStorage.getRequestInfos(startTimeInMillis, endTimeInMillis);
        Map<String, RequestStat> stats = aggregator.aggregate(requestInfos, durationInMillis);
        viewer.output(stats, startTimeInMillis, endTimeInMillis);
      }
    }, firstTime, DAY_HOURS_IN_SECONDS * 1000);
  }
} 
```

ç»è¿‡ä¸Šé¢çš„é‡æ„ä¹‹åï¼Œæˆ‘ä»¬ç°åœ¨å†æ¥çœ‹ä¸€ä¸‹ï¼Œç°åœ¨æ¡†æ¶è¯¥å¦‚ä½•æ¥ä½¿ç”¨ã€‚

æˆ‘ä»¬éœ€è¦åœ¨åº”ç”¨å¯åŠ¨çš„æ—¶å€™ï¼Œåˆ›å»ºå¥½ConsoleReporterå¯¹è±¡ï¼Œå¹¶ä¸”è°ƒç”¨å®ƒçš„startRepeatedReport()å‡½æ•°ï¼Œæ¥å¯åŠ¨å®šæ—¶ç»Ÿè®¡å¹¶è¾“å‡ºæ•°æ®åˆ°ç»ˆç«¯ã€‚åŒç†ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ›å»ºå¥½EmailReporterå¯¹è±¡ï¼Œå¹¶ä¸”è°ƒç”¨å®ƒçš„startDailyReport()å‡½æ•°ï¼Œæ¥å¯åŠ¨æ¯æ—¥ç»Ÿè®¡å¹¶è¾“å‡ºæ•°æ®åˆ°åˆ¶å®šé‚®ä»¶åœ°å€ã€‚æˆ‘ä»¬é€šè¿‡MetricsCollectorç±»æ¥æ”¶é›†æ¥å£çš„è®¿é—®æƒ…å†µï¼Œè¿™éƒ¨åˆ†æ”¶é›†ä»£ç ä¼šè·Ÿä¸šåŠ¡é€»è¾‘ä»£ç è€¦åˆåœ¨ä¸€èµ·ï¼Œæˆ–è€…ç»Ÿä¸€æ”¾åˆ°ç±»ä¼¼Spring AOPçš„åˆ‡é¢ä¸­å®Œæˆã€‚å…·ä½“çš„ä½¿ç”¨ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š

```
public class PerfCounterTest {
  public static void main(String[] args) {
    MetricsStorage storage = new RedisMetricsStorage();
    Aggregator aggregator = new Aggregator();

    // å®šæ—¶è§¦å‘ç»Ÿè®¡å¹¶å°†ç»“æœæ˜¾ç¤ºåˆ°ç»ˆç«¯
    ConsoleViewer consoleViewer = new ConsoleViewer();
    ConsoleReporter consoleReporter = new ConsoleReporter(storage, aggregator, consoleViewer);
    consoleReporter.startRepeatedReport(60, 60);

    // å®šæ—¶è§¦å‘ç»Ÿè®¡å¹¶å°†ç»“æœè¾“å‡ºåˆ°é‚®ä»¶
    EmailViewer emailViewer = new EmailViewer();
    emailViewer.addToAddress("wangzheng@xzg.com");
    EmailReporter emailReporter = new EmailReporter(storage, aggregator, emailViewer);
    emailReporter.startDailyReport();

    // æ”¶é›†æ¥å£è®¿é—®æ•°æ®
    MetricsCollector collector = new MetricsCollector(storage);
    collector.recordRequest(new RequestInfo("register", 123, 10234));
    collector.recordRequest(new RequestInfo("register", 223, 11234));
    collector.recordRequest(new RequestInfo("register", 323, 12334));
    collector.recordRequest(new RequestInfo("login", 23, 12434));
    collector.recordRequest(new RequestInfo("login", 1223, 14234));

    try {
      Thread.sleep(100000);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
  }
}
```

## Reviewç‰ˆæœ¬2çš„è®¾è®¡ä¸å®ç°

ç°åœ¨ï¼Œæˆ‘ä»¬Reviewä¸€ä¸‹ï¼Œé’ˆå¯¹ç‰ˆæœ¬1é‡æ„ä¹‹åï¼Œç‰ˆæœ¬2çš„è®¾è®¡ä¸å®ç°ã€‚

é‡æ„ä¹‹åï¼ŒMetricsStorageè´Ÿè´£å­˜å‚¨ï¼ŒAggregatorè´Ÿè´£ç»Ÿè®¡ï¼ŒStatViewerï¼ˆConsoleViewerã€EmailViewerï¼‰è´Ÿè´£æ˜¾ç¤ºï¼Œä¸‰ä¸ªç±»å„å¸å…¶èŒã€‚ConsoleReporterå’ŒEmailReporterè´Ÿè´£ç»„è£…è¿™ä¸‰ä¸ªç±»ï¼Œå°†è·å–åŸå§‹æ•°æ®ã€èšåˆç»Ÿè®¡ã€æ˜¾ç¤ºç»Ÿè®¡ç»“æœåˆ°ç»ˆç«¯è¿™ä¸‰ä¸ªé˜¶æ®µçš„å·¥ä½œä¸²è”èµ·æ¥ï¼Œå®šæ—¶è§¦å‘æ‰§è¡Œã€‚

é™¤æ­¤ä¹‹å¤–ï¼ŒMetricsStorageã€Aggregatorã€StatViewerä¸‰ä¸ªç±»çš„è®¾è®¡ä¹Ÿç¬¦åˆè¿ªç±³ç‰¹æ³•åˆ™ã€‚å®ƒä»¬åªä¸è·Ÿè‡ªå·±æœ‰ç›´æ¥ç›¸å…³çš„æ•°æ®è¿›è¡Œäº¤äº’ã€‚MetricsStorageè¾“å‡ºçš„æ˜¯RequestInfoç›¸å…³æ•°æ®ã€‚Aggregatorç±»è¾“å…¥çš„æ˜¯RequestInfoæ•°æ®ï¼Œè¾“å‡ºçš„æ˜¯RequestStatæ•°æ®ã€‚StatViewerè¾“å…¥çš„æ˜¯RequestStatæ•°æ®ã€‚

é’ˆå¯¹ç‰ˆæœ¬1å’Œç‰ˆæœ¬2ï¼Œæˆ‘ç”»äº†ä¸€å¼ å®ƒä»¬çš„ç±»ä¹‹é—´ä¾èµ–å…³ç³»çš„å¯¹æ¯”å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ä»å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œé‡æ„ä¹‹åçš„ä»£ç ç»“æ„æ›´åŠ æ¸…æ™°ã€æœ‰æ¡ç†ã€‚è¿™ä¹Ÿå°è¯äº†ä¹‹å‰æåˆ°çš„ï¼šé¢å‘å¯¹è±¡è®¾è®¡å’Œå®ç°è¦åšçš„äº‹æƒ…ï¼Œå°±æ˜¯æŠŠåˆé€‚çš„ä»£ç æ”¾åˆ°åˆé€‚çš„ç±»ä¸­ã€‚

![](https://static001.geekbang.org/resource/image/13/34/1303d16f75c7266cef9105f540c54834.jpg?wh=3263%2A1463)

åˆšåˆšæˆ‘ä»¬åˆ†æäº†ä»£ç çš„æ•´ä½“ç»“æ„å’Œä¾èµ–å…³ç³»ï¼Œæˆ‘ä»¬ç°åœ¨å†æ¥å…·ä½“çœ‹æ¯ä¸ªç±»çš„è®¾è®¡ã€‚

Aggregatorç±»ä»ä¸€ä¸ªåªåŒ…å«ä¸€ä¸ªé™æ€å‡½æ•°çš„å·¥å…·ç±»ï¼Œå˜æˆäº†ä¸€ä¸ªæ™®é€šçš„èšåˆç»Ÿè®¡ç±»ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¾èµ–æ³¨å…¥çš„æ–¹å¼ï¼Œå°†å…¶ç»„è£…è¿›ConsoleReporterå’ŒEmailReporterç±»ä¸­ï¼Œè¿™æ ·å°±æ›´åŠ å®¹æ˜“ç¼–å†™å•å…ƒæµ‹è¯•ã€‚

Aggregatorç±»åœ¨é‡æ„å‰ï¼Œæ‰€æœ‰çš„é€»è¾‘éƒ½é›†ä¸­åœ¨aggregate()å‡½æ•°å†…ï¼Œä»£ç è¡Œæ•°è¾ƒå¤šï¼Œä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§è¾ƒå·®ã€‚åœ¨é‡æ„ä¹‹åï¼Œæˆ‘ä»¬å°†æ¯ä¸ªç»Ÿè®¡é€»è¾‘æ‹†åˆ†æˆç‹¬ç«‹çš„å‡½æ•°ï¼Œaggregate()å‡½æ•°å˜å¾—æ¯”è¾ƒå•è–„ï¼Œå¯è¯»æ€§æé«˜äº†ã€‚å°½ç®¡æˆ‘ä»¬è¦æ·»åŠ æ–°çš„ç»Ÿè®¡åŠŸèƒ½ï¼Œè¿˜æ˜¯è¦ä¿®æ”¹aggregate()å‡½æ•°ï¼Œä½†ç°åœ¨çš„aggregate()å‡½æ•°ä»£ç è¡Œæ•°å¾ˆå°‘ï¼Œç»“æ„éå¸¸æ¸…æ™°ï¼Œä¿®æ”¹èµ·æ¥æ›´åŠ å®¹æ˜“ï¼Œå¯ç»´æŠ¤æ€§æé«˜ã€‚

ç›®å‰æ¥çœ‹ï¼ŒAggregatorçš„è®¾è®¡è¿˜ç®—åˆç†ã€‚ä½†æ˜¯ï¼Œå¦‚æœéšç€æ›´å¤šçš„ç»Ÿè®¡åŠŸèƒ½çš„åŠ å…¥ï¼ŒAggregatorç±»çš„ä»£ç ä¼šè¶Šæ¥è¶Šå¤šã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥å°†ç»Ÿè®¡å‡½æ•°å‰¥ç¦»å‡ºæ¥ï¼Œè®¾è®¡æˆç‹¬ç«‹çš„ç±»ï¼Œä»¥è§£å†³Aggregatorç±»çš„æ— é™è†¨èƒ€é—®é¢˜ã€‚ä¸è¿‡ï¼Œæš‚æ—¶æ¥è¯´æ²¡æœ‰å¿…è¦è¿™ä¹ˆåšï¼Œæ¯•ç«Ÿå°†æ¯ä¸ªç»Ÿè®¡å‡½æ•°ç‹¬ç«‹æˆç±»ï¼Œä¼šå¢åŠ ç±»çš„ä¸ªæ•°ï¼Œä¹Ÿä¼šå½±å“åˆ°ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

ConsoleReporterå’ŒEmailReporterç»è¿‡é‡æ„ä¹‹åï¼Œä»£ç çš„é‡å¤é—®é¢˜å˜å°äº†ï¼Œä½†ä»ç„¶æ²¡æœ‰å®Œå…¨è§£å†³ã€‚å°½ç®¡è¿™ä¸¤ä¸ªç±»ä¸å†è°ƒç”¨Aggregatorçš„é™æ€æ–¹æ³•ï¼Œä½†å› ä¸ºæ¶‰åŠå¤šçº¿ç¨‹å’Œæ—¶é—´ç›¸å…³çš„è®¡ç®—ï¼Œä»£ç çš„æµ‹è¯•æ€§ä»ç„¶ä¸å¤Ÿå¥½ã€‚è¿™ä¸¤ä¸ªé—®é¢˜æˆ‘ä»¬ç•™åœ¨ä¸‹ä¸€èŠ‚è¯¾ä¸­è§£å†³ï¼Œä½ ä¹Ÿå¯ä»¥ç•™è¨€è¯´è¯´çš„ä½ è§£å†³æ–¹æ¡ˆã€‚

## é‡ç‚¹å›é¡¾

å¥½äº†ï¼Œä»Šå¤©çš„å†…å®¹åˆ°æ­¤å°±è®²å®Œäº†ã€‚æˆ‘ä»¬ä¸€å—æ¥æ€»ç»“å›é¡¾ä¸€ä¸‹ï¼Œä½ éœ€è¦æŒæ¡çš„é‡ç‚¹å†…å®¹ã€‚

é¢å‘å¯¹è±¡è®¾è®¡ä¸­çš„æœ€åä¸€æ­¥æ˜¯ç»„è£…ç±»å¹¶æä¾›æ‰§è¡Œå…¥å£ï¼Œä¹Ÿå°±æ˜¯ä¸Šå¸ç±»è¦åšçš„äº‹æƒ…ã€‚è¿™ä¸ªä¸Šå¸ç±»æ˜¯æ²¡åŠæ³•å»æ‰çš„ï¼Œä½†æˆ‘ä»¬å¯ä»¥å°†ä¸Šå¸ç±»åšå¾—å¾ˆè½»é‡çº§ï¼ŒæŠŠæ ¸å¿ƒé€»è¾‘éƒ½å‰¥ç¦»å‡ºå»ï¼Œä¸‹æ²‰å½¢æˆç‹¬ç«‹çš„ç±»ã€‚ä¸Šå¸ç±»åªè´Ÿè´£ç»„è£…ç±»å’Œä¸²è”æ‰§è¡Œæµç¨‹ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œä»£ç ç»“æ„æ›´åŠ æ¸…æ™°ï¼Œåº•å±‚æ ¸å¿ƒé€»è¾‘æ›´å®¹æ˜“è¢«å¤ç”¨ã€‚

é¢å‘å¯¹è±¡è®¾è®¡å’Œå®ç°è¦åšçš„äº‹æƒ…ï¼Œå°±æ˜¯æŠŠåˆé€‚çš„ä»£ç æ”¾åˆ°åˆé€‚çš„ç±»ä¸­ã€‚å½“æˆ‘ä»¬è¦å®ç°æŸä¸ªåŠŸèƒ½çš„æ—¶å€™ï¼Œä¸ç®¡å¦‚ä½•è®¾è®¡ï¼Œæ‰€éœ€è¦ç¼–å†™çš„ä»£ç é‡åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯å¦‚ä½•å°†è¿™äº›ä»£ç åˆ’åˆ†åˆ°ä¸åŒçš„ç±»ä¸­ã€‚ä¸åŒçš„äººæœ‰ä¸åŒçš„åˆ’åˆ†æ–¹æ³•ï¼Œå¯¹åº”å¾—åˆ°çš„ä»£ç ç»“æ„ï¼ˆæ¯”å¦‚ç±»ä¸ç±»ä¹‹é—´äº¤äº’ç­‰ï¼‰ä¹Ÿä¸å°½ç›¸åŒã€‚

å¥½çš„è®¾è®¡ä¸€å®šæ˜¯ç»“æ„æ¸…æ™°ã€æœ‰æ¡ç†ã€é€»è¾‘æ€§å¼ºï¼Œçœ‹èµ·æ¥ä¸€ç›®äº†ç„¶ï¼Œè¯»å®Œä¹‹åå¸¸å¸¸æœ‰ä¸€ç§åŸæ¥å¦‚æ­¤çš„æ„Ÿè§‰ã€‚å·®çš„è®¾è®¡å¾€å¾€é€»è¾‘ã€ä»£ç ä¹±å¡ä¸€é€šï¼Œæ²¡æœ‰ä»€ä¹ˆè®¾è®¡æ€è·¯å¯è¨€ï¼Œçœ‹èµ·æ¥è«åå…¶å¦™ï¼Œè¯»å®Œä¹‹åä¸€å¤´é›¾æ°´ã€‚

## è¯¾å ‚è®¨è®º

1. ä»Šå¤©æˆ‘ä»¬æåˆ°ï¼Œé‡æ„ä¹‹åçš„ConsoleReporterå’ŒEmailReporterä»ç„¶å­˜åœ¨ä»£ç é‡å¤å’Œå¯æµ‹è¯•æ€§å·®çš„é—®é¢˜ï¼Œä½ å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼Œåº”è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ
2. ä»ä¸Šé¢çš„ä½¿ç”¨ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæ¡†æ¶æ˜“ç”¨æ€§æœ‰å¾…æé«˜ï¼šConsoleReporterå’ŒEmailReporterçš„åˆ›å»ºè¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œä½¿ç”¨è€…éœ€è¦æ­£ç¡®åœ°ç»„è£…å„ç§ç±»æ‰è¡Œã€‚å¯¹äºæ¡†æ¶çš„æ˜“ç”¨æ€§ï¼Œä½ æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•æ”¹å–„ä¸€ä¸‹å‘¢ï¼Ÿ

æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æ€è€ƒå’Œæƒ³æ³•ï¼Œå’ŒåŒå­¦ä¸€èµ·äº¤æµå’Œåˆ†äº«ã€‚å¦‚æœæœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>è¾£ä¹ˆå¤§</span> ğŸ‘ï¼ˆ55ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>é—®é¢˜1ï¼Œreporterå¯æµ‹æ€§å·®çš„é—®é¢˜ï¼Œå¯ä»¥mock storageï¼Œå°†requestä¿¡æ¯åˆ°mapä¸­ã€‚
&#47;&#47; mock
MetricsStorage storage = new MockRedisMetricsStorage();

é—®é¢˜2ï¼Œreporterçš„åˆ›å»ºè¿‡ç¨‹å¯ä»¥ä½¿ç”¨ç®€å•å·¥å‚æ–¹æ³•ã€‚Aggregatorå®Œå…¨æ²¡æœ‰å¿…è¦æš´éœ²å‡ºæ¥ï¼Œå¯ä»¥éšè—ã€‚
ConsoleReporter consoleReporter = ReporterFactory.createConsoleReporter(storage);

äº‰å“¥çš„ä»£ç æˆ‘å¤åˆ¶ä¸‹æ¥ï¼Œå¹¶ä¸”è·Ÿç€é‡æ„äº†ä¸€ä¸‹ï¼Œæƒ³è·‘è·‘çœ‹çš„åŒå­¦è¯·å‚è€ƒï¼š
https:&#47;&#47;github.com&#47;gdhucoder&#47;Algorithms4&#47;tree&#47;master&#47;designpattern&#47;u39</p>2020-02-01</li><br/><li><span>javaadu</span> ğŸ‘ï¼ˆ27ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>1. çœ‹äº†ä¸‹ï¼ŒConoleReporterå’ŒEmailReporterçš„æ ¸å¿ƒåŒºåˆ«åœ¨äºä½¿ç”¨çš„æ˜¾ç¤ºå™¨ä¸åŒï¼Œå¦å¤–å°±æ˜¯è°ƒåº¦çš„é¢‘æ¬¡ä¸åŒï¼Œç¬¬äºŒä¸ªä¸åŒæ˜¯å¯ä»¥é€šç”¨åŒ–çš„ï¼Œå¯ä»¥æå–å‡ºä¸€ä¸ªæŠ½è±¡çš„è°ƒåº¦å™¨ï¼ˆæŠŠæŸ¥è¯¢æ•°æ®ã€è°ƒç”¨èšåˆç»Ÿè®¡å¯¹è±¡çš„ä»£ç éƒ½æ”¾è¿›å»ï¼‰ï¼Œæ”¯æŒæ¯ç§’ã€åˆ†ã€æ—¶ã€å¤©è°ƒåº¦ï¼›ConsoleReportorå’ŒEmailReporteréƒ½ä½¿ç”¨è¿™ä¸ªè°ƒåº¦å™¨ï¼Œè‡ªå·±åªç»´æŠ¤å¯¹åº”çš„æ˜¾ç¤ºå™¨å¯¹è±¡çš„å¼•ç”¨å°±å¯ä»¥äº†ã€‚</p>2020-01-31</li><br/><li><span>å°æ™å­</span> ğŸ‘ï¼ˆ21ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¯¾åæ€è€ƒï¼š
1. å°†ä¸¤ä¸ªreporterä¸­çš„runé‡Œçš„é€»è¾‘å•ç‹¬æå–å‡ºæ¥åšæˆä¸€ä¸ªå…¬å…±å‡½æ•°void doReport(duration, endTime, startTime)ï¼Œè¿™ä¸ªå‡½æ•°æ˜“äºå•ç‹¬æµ‹è¯•ï¼Œä¸¤ä¸ªreporterç±»ä¸­è°ƒç”¨doReportï¼Œå› ä¸ºä¸¤ä¸ªreporterç±»ä¸­å¹¶æ— ç‰¹æ®Šçš„é€»è¾‘å¤„ç†ï¼Œåªä½¿ç”¨äº†jdkæœ¬èº«æä¾›çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ç›¸ä¿¡jdkæœ¬èº«çš„æ­£ç¡®æ€§ï¼Œæ‰€ä»¥è¿™å—å°±å¯ä»¥ä¸å†™å•å…ƒæµ‹è¯•äº†ï¼Œè¿™å°±ç®€åŒ–äº†æµ‹è¯•ä¹Ÿè§£å†³äº†é‡å¤ä»£ç çš„é—®é¢˜ã€‚
</p>2020-01-31</li><br/><li><span>javaadu</span> ğŸ‘ï¼ˆ16ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>2. å¦‚æœä½¿ç”¨Spring Bootä¹‹ç±»çš„æ¡†æ¶ï¼Œå°±å¯ä»¥åˆ©ç”¨æ¡†æ¶åšè‡ªåŠ¨æ³¨å…¥ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™å¯ä»¥ç”¨å·¥å‚æ–¹æ³•è®¾è®¡æ¨¡å¼æ¥æ‹¼æ¯”æ‰å¤æ‚çš„å¯¹è±¡åˆ›å»ºè¿‡ç¨‹</p>2020-01-31</li><br/><li><span>å®ˆæ‹™</span> ğŸ‘ï¼ˆ15ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¯¾å ‚è®¨è®º

1. ä»Šå¤©æˆ‘ä»¬æåˆ°ï¼Œé‡æ„ä¹‹åçš„ ConsoleReporter å’Œ EmailReporter ä»ç„¶å­˜åœ¨ä»£ç é‡å¤å’Œå¯æµ‹è¯•æ€§å·®çš„é—®é¢˜ï¼Œä½ å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼Œåº”è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ

   ConsoleReporterå’ŒEmailReporterçš„ä»£ç é‡å¤é›†ä¸­åœ¨viewer#output()éƒ¨åˆ†.å¯ä»¥æŠ½è±¡ä¸€ä¸ªAbsReporter,å°†é‡å¤ä»£ç æ”¾åœ¨åŸºç±»ä¸­,å¹¶è®©ConsoleReporterå’ŒEmailReporterç»§æ‰¿è‡ªAbsReporter. è¿™é‡ŒåŸºç±»ä¸è¡ç”Ÿç±»å®Œå…¨ç¬¦åˆis-aå…³ç³», ä½†å¹¶æœªä½¿ç”¨å¤šæ€æ€§. 

2. ä»ä¸Šé¢çš„ä½¿ç”¨ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæ¡†æ¶æ˜“ç”¨æ€§æœ‰å¾…æé«˜ï¼šConsoleReporter å’Œ EmailReporter çš„åˆ›å»ºè¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œä½¿ç”¨è€…éœ€è¦æ­£ç¡®åœ°ç»„è£…å„ç§ç±»æ‰è¡Œã€‚å¯¹äºæ¡†æ¶çš„æ˜“ç”¨æ€§ï¼Œä½ æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•æ”¹å–„ä¸€ä¸‹å‘¢ï¼Ÿ

â€‹       å¯ä»¥ä½¿ç”¨builderæ¨¡å¼æ”¹é€ , æä¾›æ›´å‹å¥½çš„ä¾èµ–æ³¨å…¥æ–¹å¼. é™¤æ­¤ä»¥å¤–, è¿˜åº”ç¼–å†™è‰¯å¥½çš„æ³¨é‡Š, å¸®åŠ©å®¢æˆ·ç«¯ç¨‹åºå‘˜æ­£ç¡®çš„ä½¿ç”¨æ¡†æ¶.

â€‹		ç¤ºä¾‹:

â€‹		ConsoleReporter instance = ConsoleReporter.Builder()

â€‹		    .setMetricsStorate(storage)

â€‹		    .setAggregator(aggregator)

â€‹			.setStatViewer(viewer)

â€‹			.setExecutor(executor)

â€‹			.build();</p>2020-01-31</li><br/><li><span>Jessica</span> ğŸ‘ï¼ˆ12ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¿™å¥è¯å¤ªèµåŒäº†ï¼šé¢å‘å¯¹è±¡è®¾è®¡å’Œå®ç°è¦åšçš„äº‹æƒ…ï¼Œå°±æ˜¯æŠŠåˆé€‚çš„ä»£ç æ”¾åˆ°åˆé€‚çš„ç±»ä¸­ã€‚å½“æˆ‘ä»¬è¦å®ç°æŸä¸ªåŠŸèƒ½çš„æ—¶å€™ï¼Œä¸ç®¡å¦‚ä½•è®¾è®¡ï¼Œæ‰€éœ€è¦ç¼–å†™çš„ä»£ç é‡åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯å¦‚ä½•å°†è¿™äº›ä»£ç åˆ’åˆ†åˆ°ä¸åŒçš„ç±»ä¸­ã€‚ä¸åŒçš„äººæœ‰ä¸åŒçš„åˆ’åˆ†æ–¹æ³•ï¼Œå¯¹åº”å¾—åˆ°çš„ä»£ç ç»“æ„ï¼ˆæ¯”å¦‚ç±»ä¸ç±»ä¹‹é—´äº¤äº’ç­‰ï¼‰ä¹Ÿä¸å°½ç›¸åŒã€‚</p>2020-03-17</li><br/><li><span>Jxin</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>1.å°†å®šæ—¶å’Œè¾“å‡ºæŠ¥è¡¨è¿™ä¸¤ä»¶äº‹åˆ†ç¦»ã€‚å•ç‹¬çš„å®šæ—¶çº¿ç¨‹ï¼Œåœ¨å…³é”®çš„æ—¶é—´ç‚¹éƒ½è§¦å‘ä¸€ä¸ªäº‹ä»¶ã€‚è¾“å‡ºæŠ¥è¡¨çš„ä¸¤ä¸ªç±»å»ç›‘å¬è‡ªå·±å…³å¿ƒçš„æ—¶é—´jobçš„äº‹ä»¶ï¼ˆç”Ÿäº§æ¶ˆè´¹æ¨¡å¼ï¼‰ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå®šæ—¶è§¦å‘å¥½ä¸å¥½ä½¿ä¸å†æ˜¯æˆ‘apiä½¿ç”¨æ–¹è€ƒè™‘çš„äº‹ã€‚æˆ‘åªéœ€è¦æµ‹è¯•å¯¹åº”è¾“å‡ºæŠ¥è¡¨çš„ä¸šåŠ¡æ˜¯å¦æ­£å¸¸ã€‚ç„¶åå°±æ§åˆ¶å°å’Œé‚®ä»¶è¿™ä¸¤ä¸ªæŠ¥è¡¨ç±»ï¼Œå…¶ç”ŸæˆæŠ¥è¡¨çš„é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œä»…ä»…æ˜¯å±•ç¤ºçš„â€œæ–¹å¼â€ä¸ä¸€æ ·ã€‚æ‰€ä»¥è®©æˆ‘é€‰ï¼Œæˆ‘ä¼šåˆå¹¶è¿™ä¸¤ä¸ªç±»ï¼Œç”ŸæˆæŠ¥è¡¨çš„é€»è¾‘ä¸ºç§æœ‰æ–¹æ³•ï¼Œç„¶åå•ç‹¬å†™ä¸€ä¸ªæ§åˆ¶å°è¾“å‡ºçš„publicæ–¹æ³•å’Œé‚®ç®±è¾“å‡ºçš„publicæ–¹æ³•ï¼ˆè¾“å‡ºæ¨¡å¼å¤šï¼Œä¸”å­˜åœ¨ç»„åˆéœ€æ±‚çš„è¯ä¼šé‡‡ç”¨åˆ†å‘+çº¦å®šçš„æ–¹å¼ï¼Œé™ä½è°ƒç”¨æ–¹è´Ÿæ‹…ï¼‰ã€‚é‚£ä¹ˆè¿™ä¸ªç±»ï¼Œç”ŸæˆæŠ¥è¡¨é€»è¾‘å…¬ç”¨ï¼Œä¸¤ä¸ªè¾“å‡ºæ–¹æ³•æ˜¯èµ°çš„apiï¼Œæ‰€ä»¥ä¹Ÿä¸å…³å¿ƒï¼Œæˆ‘åªéœ€è¦æµ‹è¯• æŠ¥è¡¨ç”Ÿæˆçš„é€»è¾‘å³å¯ã€‚

2.è¶Šçµæ´»è‡ªç„¶è¶Šå¤æ‚ã€‚ çº¦å®šå¤§äºé…ç½®å‘—ã€‚é™¤äº†ä¸šåŠ¡åŸ‹ç‚¹å¿…é¡»å®ç°ï¼Œå…¶ä»–éƒ½å¯ä»¥çº¦å®šã€‚</p>2020-01-31</li><br/><li><span>çº¢è±†æˆé¦™</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ5ï¼‰<p>è€å¸ˆï¼Œå¤§å®¶å¥½ï¼Œæœ‰ä¸ªé—®é¢˜ä¸€ç›´å›°æ‰°ç€æˆ‘ï¼Œçœ‹åˆ°è€å¸ˆè¿™é‡Œä¹Ÿå­˜åœ¨ï¼Œå¸Œæœ›è€å¸ˆå’ŒåŒå­¦ä»¬å¸®æˆ‘è§£æƒ‘ï¼šmaxå’Œminç­‰æ‹†åˆ†æˆç‹¬ç«‹çš„å‡½æ•°ä¹‹å‰ï¼Œä¸€ä¸ªforå¾ªç¯å°±å¯ä»¥åŒæ—¶å®Œæˆè®¡ç®—ï¼›æ‹†åˆ†ä¹‹åï¼Œæ¯ä¸ªç‹¬ç«‹çš„æ–¹æ³•éƒ½è¦å¾ªç¯ä¸€æ¬¡ï¼Œå¦‚æœæ•°æ®å¾ˆå¤§ï¼Œè¿™æ ·å°±å¾ˆè€—æ—¶é—´ï¼Œè€Œä¸”æˆ‘æ€»è§‰å¾—ä¸€ä¸ªforå¾ªç¯èƒ½è§£å†³å¤šä¸ªé—®é¢˜ç‰¹åˆ«çš„çˆ½ï¼Œæœ‰ä¸€ç§ä¸€çŸ³äºŒé¸Ÿçš„æ„Ÿè§‰ï¼Œä½†æ˜¯æ‹†åˆ†ä¹‹åä»£ç é€»è¾‘æ›´åŠ æ¸…æ™°ï¼Œæˆ‘ä¸çŸ¥é“è¦æ€ä¹ˆå–èˆäº†</p>2020-11-10</li><br/><li><span>liu_liu</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>1. å¯å®šä¹‰çˆ¶ç±»ï¼Œé‡å¤ä»£ç æŠ½å–ä¸ºå‡½æ•°è¿›è¡Œå¤ç”¨
2. ç”¨å·¥å‚æ–¹æ³•ï¼Œå±è”½åˆ›å»ºè¿‡ç¨‹</p>2020-01-31</li><br/><li><span>æ—¶ç†µ</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>Aggregatoré‡æ„åæ—¶é—´å¤æ‚åº¦æ„Ÿè§‰ä¸Šå‡äº†å¥½å¤š</p>2021-07-02</li><br/><li><span>å¹³é£é€ é›¨</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>1. Reporterä¸­çº¿ç¨‹è°ƒç”¨çš„runæ–¹æ³•å¯ä»¥å•ç‹¬æå–ä¸€ä¸ªæ–¹æ³•ä¸ä¾èµ–é¢å¤–çš„çº¿ç¨‹å»è°ƒç”¨ï¼Œæ–¹ä¾¿å•å…ƒæµ‹è¯•ã€‚
2. å¦å¤–Reporterä¸­çš„çº¿ç¨‹æ¨¡å‹æ˜¯å¦å¯ä»¥å•ç‹¬æå–å‡ºä¸€ä¸ªç±»ï¼Œè¯¥ç±»è´Ÿè´£æŒ‰éœ€åˆ›å»ºçº¿ç¨‹ï¼Œå¹¶ä¸”è°ƒç”¨å®é™…çš„åŸ‹ç‚¹ç»Ÿè®¡æ–¹æ³•ã€‚
3. å¯ä»¥å€ŸåŠ©æ¡†æ¶å±‚é¢ä¾èµ–æ³¨å…¥çš„æ–¹å¼ï¼Œæ›´ä¸ºç®€å•çš„æ„é€ Reporterç±»ã€‚</p>2020-02-01</li><br/><li><span>- -</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ä¸‹é¢æ˜¯ç›®å‰çš„æƒ³æ³•ï¼Œå¸Œæœ›åé¢èƒ½é¢ è¦†ç°åœ¨çš„æƒ³æ³•å“ˆå“ˆ
1ã€è™½ç„¶è¿™ä¸¤ä¸ªç±»çš„æ‰§è¡Œé€»è¾‘ä»£ç æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªç±»æ˜¯å±äºä¸²è”æ‰§è¡Œè¿‡ç¨‹çš„ä¸Šå¸ç±»ï¼Œå®ƒä»¬çš„å®ç°ä»£ç é€»è¾‘æ˜¯é‡å¤çš„ï¼Œä½†è¯­ä¹‰ä¸Šæ˜¯å±äºä¸ä¸€æ ·çš„åŠŸèƒ½ï¼Œæ‰€ä»¥å…¶å®æ²¡æœ‰ä»£ç é‡å¤çš„é—®é¢˜ã€‚
è¿™ä¸¤ä¸ªç±»çš„æµ‹è¯•æˆ‘è§‰å¾—åº”è¯¥ä¸å«å•å…ƒæµ‹è¯•è€Œæ˜¯é›†æˆæµ‹è¯•äº†å§ï¼Ÿæ‰€ä»¥åº”è¯¥æ˜¯æŠŠå‡½æ•°é‡Œçš„å„ä¸ªå°å‡½æ•°åˆ†åˆ«åšå•å…ƒæµ‹è¯•ã€‚è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œåƒç±»ä¼¼å¾—åˆ°ç»Ÿè®¡æ•°æ®è¿™ç§å‡½æ•°åº”è¯¥æ€ä¹ˆè¿›è¡Œæµ‹è¯•å‘¢?æ¯”å¦‚aggregate()å°±å¾ˆéš¾è¿›è¡Œæµ‹è¯•ã€‚
2ã€å¯ä»¥è®¾æœ‰é»˜è®¤çš„ç»„è£…ç±»ï¼Œåªæœ‰å½“éœ€è¦å¦å¤–æŒ‡å®šå…¶å®ƒç»„è£…ç±»çš„æ—¶å€™æ‰éœ€è¦ä½¿ç”¨è€…äº²è‡ªåˆ›å»ºç»„è£…ç±»ï¼Œè¿™åº”è¯¥ä¹Ÿæ˜¯ç¬¦åˆæ¡†æ¶çš„æ˜“ç”¨æ€§åŠæ‰©å±•æ€§çš„ã€‚</p>2020-02-09</li><br/><li><span>ä¸€åå°å­¦ç”Ÿ</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ‰“å¡ï½çœ‹å®Œä¸€éç†è§£ä¸æ˜¯å¾ˆæ·±åˆ»ï¼Œå‡†å¤‡æ‰‹æ•²ä¸€éã€‚</p>2020-02-07</li><br/><li><span>é«˜æº</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ä»”ç»†å­¦ä¹ åˆ†æä¸€ä¸‹é‡æ„åå¸¦æ¥çš„å¥½å¤„ï¼Œè§£å†³äº†å“ªäº›é—®é¢˜</p>2020-01-31</li><br/><li><span>ã¡ã‚ˆãã‚“</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ‰“å¡</p>2020-01-31</li><br/>
</ul>