ä¸Šä¸€èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬é’ˆå¯¹ç‰ˆæœ¬1å­˜åœ¨çš„é—®é¢˜ï¼ˆç‰¹åˆ«æ˜¯Aggregatorç±»ã€ConsoleReporterå’ŒEmailReporterç±»ï¼‰è¿›è¡Œäº†é‡æ„ä¼˜åŒ–ã€‚ç»è¿‡é‡æ„ä¹‹åï¼Œä»£ç ç»“æ„æ›´åŠ æ¸…æ™°ã€åˆç†ã€æœ‰é€»è¾‘æ€§ã€‚ä¸è¿‡ï¼Œåœ¨ç»†èŠ‚æ–¹é¢è¿˜æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ConsoleReporterã€EmailReporterç±»ä»ç„¶å­˜åœ¨ä»£ç é‡å¤ã€å¯æµ‹è¯•æ€§å·®çš„é—®é¢˜ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°±åœ¨ç‰ˆæœ¬3ä¸­æŒç»­é‡æ„è¿™éƒ¨åˆ†ä»£ç ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨ç‰ˆæœ¬3ä¸­ï¼Œæˆ‘ä»¬è¿˜ä¼šç»§ç»­å®Œå–„æ¡†æ¶çš„åŠŸèƒ½å’ŒéåŠŸèƒ½éœ€æ±‚ã€‚æ¯”å¦‚ï¼Œè®©åŸå§‹æ•°æ®çš„é‡‡é›†å’Œå­˜å‚¨å¼‚æ­¥æ‰§è¡Œï¼Œè§£å†³èšåˆç»Ÿè®¡åœ¨æ•°æ®é‡å¤§çš„æƒ…å†µä¸‹ä¼šå¯¼è‡´å†…å­˜åƒç´§é—®é¢˜ï¼Œä»¥åŠæé«˜æ¡†æ¶çš„æ˜“ç”¨æ€§ç­‰ï¼Œè®©å®ƒæˆä¸ºä¸€ä¸ªèƒ½ç”¨ä¸”å¥½ç”¨çš„æ¡†æ¶ã€‚

è¯ä¸å¤šè¯´ï¼Œè®©æˆ‘ä»¬æ­£å¼å¼€å§‹ç‰ˆæœ¬3çš„è®¾è®¡ä¸å®ç°å§ï¼

## ä»£ç é‡æ„ä¼˜åŒ–

æˆ‘ä»¬çŸ¥é“ï¼Œç»§æ‰¿èƒ½è§£å†³ä»£ç é‡å¤çš„é—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥å°†ConsoleReporterå’ŒEmailReporterä¸­çš„ç›¸åŒä»£ç é€»è¾‘ï¼Œæå–åˆ°çˆ¶ç±»ScheduledReporterä¸­ï¼Œä»¥è§£å†³ä»£ç é‡å¤é—®é¢˜ã€‚æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œé‡æ„ä¹‹åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```
public abstract class ScheduledReporter {
  protected MetricsStorage metricsStorage;
  protected Aggregator aggregator;
  protected StatViewer viewer;

  public ScheduledReporter(MetricsStorage metricsStorage, Aggregator aggregator, StatViewer viewer) {
    this.metricsStorage = metricsStorage;
    this.aggregator = aggregator;
    this.viewer = viewer;
  }

  protected void doStatAndReport(long startTimeInMillis, long endTimeInMillis) {
    long durationInMillis = endTimeInMillis -  startTimeInMillis;
    Map<String, List<RequestInfo>> requestInfos =
            metricsStorage.getRequestInfos(startTimeInMillis, endTimeInMillis);
    Map<String, RequestStat> requestStats = aggregator.aggregate(requestInfos, durationInMillis);
    viewer.output(requestStats, startTimeInMillis, endTimeInMillis);
  }

}
```

ConsoleReporterå’ŒEmailReporterä»£ç é‡å¤çš„é—®é¢˜è§£å†³äº†ï¼Œé‚£æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ä»£ç çš„å¯æµ‹è¯•æ€§é—®é¢˜ã€‚å› ä¸ºConsoleReporterå’ŒEmailReporterçš„ä»£ç æ¯”è¾ƒç›¸ä¼¼ï¼Œä¸”EmailReporterçš„ä»£ç æ›´å¤æ‚äº›ï¼Œæ‰€ä»¥ï¼Œå…³äºå¦‚ä½•é‡æ„æ¥æé«˜å…¶å¯æµ‹è¯•æ€§ï¼Œæˆ‘ä»¬æ‹¿EmailReporteræ¥ä¸¾ä¾‹è¯´æ˜ã€‚å°†é‡å¤ä»£ç æå–åˆ°çˆ¶ç±»ScheduledReporterä¹‹åï¼ŒEmailReporterä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```
public class EmailReporter extends ScheduledReporter {
  private static final Long DAY_HOURS_IN_SECONDS = 86400L;

  private MetricsStorage metricsStorage;
  private Aggregator aggregator;
  private StatViewer viewer;

  public EmailReporter(MetricsStorage metricsStorage, Aggregator aggregator, StatViewer viewer) {
    this.metricsStorage = metricsStorage;
    this.aggregator = aggregator;
    this.viewer = viewer;
  }

  public void startDailyReport() {
    Calendar calendar = Calendar.getInstance();
    calendar.add(Calendar.DATE, 1);
    calendar.set(Calendar.HOUR_OF_DAY, 0);
    calendar.set(Calendar.MINUTE, 0);
    calendar.set(Calendar.SECOND, 0);
    calendar.set(Calendar.MILLISECOND, 0);
    Date firstTime = calendar.getTime();

    Timer timer = new Timer();
    timer.schedule(new TimerTask() {
      @Override
      public void run() {
        long durationInMillis = DAY_HOURS_IN_SECONDS * 1000;
        long endTimeInMillis = System.currentTimeMillis();
        long startTimeInMillis = endTimeInMillis - durationInMillis;
        doStatAndReport(startTimeInMillis, endTimeInMillis);
      }
    }, firstTime, DAY_HOURS_IN_SECONDS * 1000);
  }
}
```

å‰é¢æåˆ°ï¼Œä¹‹æ‰€ä»¥EmailReporterå¯æµ‹è¯•æ€§ä¸å¥½ï¼Œä¸€æ–¹é¢æ˜¯å› ä¸ºç”¨åˆ°äº†çº¿ç¨‹ï¼ˆå®šæ—¶å™¨ä¹Ÿç›¸å½“äºå¤šçº¿ç¨‹ï¼‰ï¼Œå¦ä¸€æ–¹é¢æ˜¯å› ä¸ºæ¶‰åŠæ—¶é—´çš„è®¡ç®—é€»è¾‘ã€‚

å®é™…ä¸Šï¼Œåœ¨ç»è¿‡ä¸Šä¸€æ­¥çš„é‡æ„ä¹‹åï¼ŒEmailReporterä¸­çš„startDailyReport()å‡½æ•°çš„æ ¸å¿ƒé€»è¾‘å·²ç»è¢«æŠ½ç¦»å‡ºå»äº†ï¼Œè¾ƒå¤æ‚çš„ã€å®¹æ˜“å‡ºbugçš„å°±åªå‰©ä¸‹è®¡ç®—firstTimeçš„é‚£éƒ¨åˆ†ä»£ç äº†ã€‚æˆ‘ä»¬å¯ä»¥å°†è¿™éƒ¨åˆ†ä»£ç ç»§ç»­æŠ½ç¦»å‡ºæ¥ï¼Œå°è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œç„¶åï¼Œå•ç‹¬é’ˆå¯¹è¿™ä¸ªå‡½æ•°å†™å•å…ƒæµ‹è¯•ã€‚é‡æ„ä¹‹åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```
public class EmailReporter extends ScheduledReporter {
  // çœç•¥å…¶ä»–ä»£ç ...
  public void startDailyReport() {
    Date firstTime = trimTimeFieldsToZeroOfNextDay();
    Timer timer = new Timer();
    timer.schedule(new TimerTask() {
      @Override
      public void run() {
        // çœç•¥å…¶ä»–ä»£ç ...
      }
    }, firstTime, DAY_HOURS_IN_SECONDS * 1000);
  }

  // è®¾ç½®æˆprotectedè€Œéprivateæ˜¯ä¸ºäº†æ–¹ä¾¿å†™å•å…ƒæµ‹è¯•
  @VisibleForTesting
  protected Date trimTimeFieldsToZeroOfNextDay() {
    Calendar calendar = Calendar.getInstance(); // è¿™é‡Œå¯ä»¥è·å–å½“å‰æ—¶é—´
    calendar.add(Calendar.DATE, 1);
    calendar.set(Calendar.HOUR_OF_DAY, 0);
    calendar.set(Calendar.MINUTE, 0);
    calendar.set(Calendar.SECOND, 0);
    calendar.set(Calendar.MILLISECOND, 0);
    return calendar.getTime();
  }
}
```

ç®€å•çš„ä»£ç æŠ½ç¦»æˆtrimTimeFieldsToZeroOfNextDay()å‡½æ•°ä¹‹åï¼Œè™½ç„¶ä»£ç æ›´åŠ æ¸…æ™°äº†ï¼Œä¸€çœ¼å°±èƒ½ä»åå­—ä¸ŠçŸ¥é“è¿™æ®µä»£ç çš„æ„å›¾ï¼ˆè·å–å½“å‰æ—¶é—´çš„ä¸‹ä¸€å¤©çš„0ç‚¹æ—¶é—´ï¼‰ï¼Œä½†æˆ‘ä»¬å‘ç°è¿™ä¸ªå‡½æ•°çš„å¯æµ‹è¯•æ€§ä»ç„¶ä¸å¥½ï¼Œå› ä¸ºå®ƒå¼ºä¾èµ–å½“å‰çš„ç³»ç»Ÿæ—¶é—´ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªé—®é¢˜æŒºæ™®éçš„ã€‚ä¸€èˆ¬çš„è§£å†³æ–¹æ³•æ˜¯ï¼Œå°†å¼ºä¾èµ–çš„éƒ¨åˆ†é€šè¿‡å‚æ•°ä¼ é€’è¿›æ¥ï¼Œè¿™æœ‰ç‚¹ç±»ä¼¼æˆ‘ä»¬ä¹‹å‰è®²çš„ä¾èµ–æ³¨å…¥ã€‚æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬å†å¯¹trimTimeFieldsToZeroOfNextDay()å‡½æ•°è¿›è¡Œé‡æ„ã€‚é‡æ„ä¹‹åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```
public class EmailReporter extends ScheduledReporter {
  // çœç•¥å…¶ä»–ä»£ç ...
  public void startDailyReport() {
    // new Date()å¯ä»¥è·å–å½“å‰æ—¶é—´
    Date firstTime = trimTimeFieldsToZeroOfNextDay(new Date());
    Timer timer = new Timer();
    timer.schedule(new TimerTask() {
      @Override
      public void run() {
        // çœç•¥å…¶ä»–ä»£ç ...
      }
    }, firstTime, DAY_HOURS_IN_SECONDS * 1000);
  }

  protected Date trimTimeFieldsToZeroOfNextDay(Date date) {
    Calendar calendar = Calendar.getInstance(); // è¿™é‡Œå¯ä»¥è·å–å½“å‰æ—¶é—´
    calendar.setTime(date); // é‡æ–°è®¾ç½®æ—¶é—´
    calendar.add(Calendar.DATE, 1);
    calendar.set(Calendar.HOUR_OF_DAY, 0);
    calendar.set(Calendar.MINUTE, 0);
    calendar.set(Calendar.SECOND, 0);
    calendar.set(Calendar.MILLISECOND, 0);
    return calendar.getTime();
  }
}
```

ç»è¿‡è¿™æ¬¡é‡æ„ä¹‹åï¼ŒtrimTimeFieldsToZeroOfNextDay()å‡½æ•°ä¸å†å¼ºä¾èµ–å½“å‰çš„ç³»ç»Ÿæ—¶é—´ï¼Œæ‰€ä»¥éå¸¸å®¹æ˜“å¯¹å…¶ç¼–å†™å•å…ƒæµ‹è¯•ã€‚ä½ å¯ä»¥æŠŠå®ƒä½œä¸ºç»ƒä¹ ï¼Œå†™ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å•å…ƒæµ‹è¯•ã€‚

ä¸è¿‡ï¼ŒEmailReporterç±»ä¸­startDailyReport()è¿˜æ˜¯æ¶‰åŠå¤šçº¿ç¨‹ï¼Œé’ˆå¯¹è¿™ä¸ªå‡½æ•°è¯¥å¦‚ä½•å†™å•å…ƒæµ‹è¯•å‘¢ï¼Ÿæˆ‘çš„çœ‹æ³•æ˜¯ï¼Œè¿™ä¸ªå‡½æ•°ä¸éœ€è¦å†™å•å…ƒæµ‹è¯•ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å›åˆ°å†™å•å…ƒæµ‹è¯•çš„åˆè¡·æ¥åˆ†æè¿™ä¸ªé—®é¢˜ã€‚å•å…ƒæµ‹è¯•æ˜¯ä¸ºäº†æé«˜ä»£ç è´¨é‡ï¼Œå‡å°‘bugã€‚å¦‚æœä»£ç è¶³å¤Ÿç®€å•ï¼Œç®€å•åˆ°bugæ— å¤„éšè—ï¼Œé‚£æˆ‘ä»¬å°±æ²¡å¿…è¦ä¸ºäº†å†™å•å…ƒæµ‹è¯•è€Œå†™å•å…ƒæµ‹è¯•ï¼Œæˆ–è€…ä¸ºäº†è¿½æ±‚å•å…ƒæµ‹è¯•è¦†ç›–ç‡è€Œå†™å•å…ƒæµ‹è¯•ã€‚ç»è¿‡å¤šæ¬¡ä»£ç é‡æ„ä¹‹åï¼ŒstartDailyReport()å‡½æ•°é‡Œé¢å·²ç»æ²¡æœ‰å¤šå°‘ä»£ç é€»è¾‘äº†ï¼Œæ‰€ä»¥ï¼Œå®Œå…¨æ²¡å¿…è¦å¯¹å®ƒå†™å•å…ƒæµ‹è¯•äº†ã€‚

## åŠŸèƒ½éœ€æ±‚å®Œå–„

ç»è¿‡äº†å¤šä¸ªç‰ˆæœ¬çš„è¿­ä»£ã€é‡æ„ï¼Œæˆ‘ä»¬ç°åœ¨æ¥é‡æ–°Reviewä¸€ä¸‹ï¼Œç›®å‰çš„è®¾è®¡ä¸å®ç°æ˜¯å¦å·²ç»å®Œå…¨æ»¡è¶³ç¬¬25è®²ä¸­æœ€åˆçš„åŠŸèƒ½éœ€æ±‚äº†ã€‚

æœ€åˆçš„åŠŸèƒ½éœ€æ±‚æè¿°æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­çš„ï¼Œæˆ‘ä»¬æ¥é‡æ–°çœ‹ä¸€ä¸‹ã€‚

> æˆ‘ä»¬å¸Œæœ›è®¾è®¡å¼€å‘ä¸€ä¸ªå°çš„æ¡†æ¶ï¼Œèƒ½å¤Ÿè·å–æ¥å£è°ƒç”¨çš„å„ç§ç»Ÿè®¡ä¿¡æ¯ï¼Œæ¯”å¦‚å“åº”æ—¶é—´çš„æœ€å¤§å€¼ï¼ˆmaxï¼‰ã€æœ€å°å€¼ï¼ˆminï¼‰ã€å¹³å‡å€¼ï¼ˆavgï¼‰ã€ç™¾åˆ†ä½å€¼ï¼ˆpercentileï¼‰ï¼Œæ¥å£è°ƒç”¨æ¬¡æ•°ï¼ˆcountï¼‰ã€é¢‘ç‡ï¼ˆtpsï¼‰ ç­‰ï¼Œå¹¶ä¸”æ”¯æŒå°†ç»Ÿè®¡ç»“æœä»¥å„ç§æ˜¾ç¤ºæ ¼å¼ï¼ˆæ¯”å¦‚ï¼šJSONæ ¼å¼ã€ç½‘é¡µæ ¼å¼ã€è‡ªå®šä¹‰æ˜¾ç¤ºæ ¼å¼ç­‰ï¼‰è¾“å‡ºåˆ°å„ç§ç»ˆç«¯ï¼ˆConsoleå‘½ä»¤è¡Œã€HTTPç½‘é¡µã€Emailã€æ—¥å¿—æ–‡ä»¶ã€è‡ªå®šä¹‰è¾“å‡ºç»ˆç«¯ç­‰ï¼‰ï¼Œä»¥æ–¹ä¾¿æŸ¥çœ‹ã€‚

ç»è¿‡æ•´ç†æ‹†è§£ä¹‹åçš„éœ€æ±‚åˆ—è¡¨å¦‚ä¸‹æ‰€ç¤ºï¼š

> æ¥å£ç»Ÿè®¡ä¿¡æ¯ï¼šåŒ…æ‹¬æ¥å£å“åº”æ—¶é—´çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œä»¥åŠæ¥å£è°ƒç”¨æ¬¡æ•°çš„ç»Ÿè®¡ä¿¡æ¯ç­‰ã€‚  
> ç»Ÿè®¡ä¿¡æ¯çš„ç±»å‹ï¼šmaxã€minã€avgã€percentileã€countã€tpsç­‰ã€‚  
> ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºæ ¼å¼ï¼šJSONã€HTMLã€è‡ªå®šä¹‰æ˜¾ç¤ºæ ¼å¼ã€‚  
> ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºç»ˆç«¯ï¼šConsoleã€Emailã€HTTPç½‘é¡µã€æ—¥å¿—ã€è‡ªå®šä¹‰æ˜¾ç¤ºç»ˆç«¯ã€‚

ç»è¿‡æŒ–æ˜ï¼Œæˆ‘ä»¬è¿˜å¾—åˆ°ä¸€äº›éšè—çš„éœ€æ±‚ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

> ç»Ÿè®¡è§¦å‘æ–¹å¼ï¼šåŒ…æ‹¬ä¸»åŠ¨å’Œè¢«åŠ¨ä¸¤ç§ã€‚ä¸»åŠ¨è¡¨ç¤ºä»¥ä¸€å®šçš„é¢‘ç‡å®šæ—¶ç»Ÿè®¡æ•°æ®ï¼Œå¹¶ä¸»åŠ¨æ¨é€åˆ°æ˜¾ç¤ºç»ˆç«¯ï¼Œæ¯”å¦‚é‚®ä»¶æ¨é€ã€‚è¢«åŠ¨è¡¨ç¤ºç”¨æˆ·è§¦å‘ç»Ÿè®¡ï¼Œæ¯”å¦‚ç”¨æˆ·åœ¨ç½‘é¡µä¸­é€‰æ‹©è¦ç»Ÿè®¡çš„æ—¶é—´åŒºé—´ï¼Œè§¦å‘ç»Ÿè®¡ï¼Œå¹¶å°†ç»“æœæ˜¾ç¤ºç»™ç”¨æˆ·ã€‚

> ç»Ÿè®¡æ—¶é—´åŒºé—´ï¼šæ¡†æ¶éœ€è¦æ”¯æŒè‡ªå®šä¹‰ç»Ÿè®¡æ—¶é—´åŒºé—´ï¼Œæ¯”å¦‚ç»Ÿè®¡æœ€è¿‘10åˆ†é’Ÿçš„æŸæ¥å£çš„tpsã€è®¿é—®æ¬¡æ•°ï¼Œæˆ–è€…ç»Ÿè®¡12æœˆ11æ—¥00ç‚¹åˆ°12æœˆ12æ—¥00ç‚¹ä¹‹é—´æŸæ¥å£å“åº”æ—¶é—´çš„æœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ç­‰ã€‚

> ç»Ÿè®¡æ—¶é—´é—´éš”ï¼šå¯¹äºä¸»åŠ¨è§¦å‘ç»Ÿè®¡ï¼Œæˆ‘ä»¬è¿˜è¦æ”¯æŒæŒ‡å®šç»Ÿè®¡æ—¶é—´é—´éš”ï¼Œä¹Ÿå°±æ˜¯å¤šä¹…è§¦å‘ä¸€æ¬¡ç»Ÿè®¡æ˜¾ç¤ºã€‚æ¯”å¦‚ï¼Œæ¯é—´éš”10sç»Ÿè®¡ä¸€æ¬¡æ¥å£ä¿¡æ¯å¹¶æ˜¾ç¤ºåˆ°å‘½ä»¤è¡Œä¸­ï¼Œæ¯é—´éš”24å°æ—¶å‘é€ä¸€å°ç»Ÿè®¡ä¿¡æ¯é‚®ä»¶ã€‚

ç‰ˆæœ¬3å·²ç»å®ç°äº†å¤§éƒ¨åˆ†çš„åŠŸèƒ½ï¼Œè¿˜æœ‰ä»¥ä¸‹å‡ ä¸ªå°çš„åŠŸèƒ½ç‚¹æ²¡æœ‰å®ç°ã€‚ä½ å¯ä»¥å°†è¿™äº›è¿˜æ²¡æœ‰å®ç°çš„åŠŸèƒ½ï¼Œè‡ªå·±å®ç°ä¸€ä¸‹ï¼Œç»§ç»­è¿­ä»£å‡ºæ¡†æ¶çš„ç¬¬4ä¸ªç‰ˆæœ¬ã€‚

- è¢«åŠ¨è§¦å‘ç»Ÿè®¡çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯éœ€æ±‚ä¸­æåˆ°çš„é€šè¿‡ç½‘é¡µå±•ç¤ºç»Ÿè®¡ä¿¡æ¯ã€‚å®é™…ä¸Šï¼Œè¿™éƒ¨åˆ†ä»£ç çš„å®ç°ä¹Ÿå¹¶ä¸éš¾ã€‚æˆ‘ä»¬å¯ä»¥å¤ç”¨æ¡†æ¶ç°åœ¨çš„ä»£ç ï¼Œç¼–å†™ä¸€äº›å±•ç¤ºé¡µé¢å’Œæä¾›è·å–ç»Ÿè®¡æ•°æ®çš„æ¥å£å³å¯ã€‚
- å¯¹äºè‡ªå®šä¹‰æ˜¾ç¤ºç»ˆç«¯ï¼Œæ¯”å¦‚æ˜¾ç¤ºæ•°æ®åˆ°è‡ªå·±å¼€å‘çš„ç›‘æ§å¹³å°ï¼Œè¿™å°±æœ‰ç‚¹ç±»ä¼¼é€šè¿‡ç½‘é¡µæ¥æ˜¾ç¤ºæ•°æ®ï¼Œä¸è¿‡æ›´åŠ ç®€å•äº›ï¼Œåªéœ€è¦æä¾›ä¸€äº›è·å–ç»Ÿè®¡æ•°æ®çš„æ¥å£ï¼Œç›‘æ§å¹³å°é€šè¿‡è¿™äº›æ¥å£æ‹‰å–æ•°æ®æ¥æ˜¾ç¤ºå³å¯ã€‚
- è‡ªå®šä¹‰æ˜¾ç¤ºæ ¼å¼ã€‚åœ¨æ¡†æ¶ç°åœ¨çš„ä»£ç å®ç°ä¸­ï¼Œæ˜¾ç¤ºæ ¼å¼å’Œæ˜¾ç¤ºç»ˆç«¯ï¼ˆæ¯”å¦‚Consoleã€Emailï¼‰æ˜¯ç´§å¯†è€¦åˆåœ¨ä¸€èµ·çš„ï¼Œæ¯”å¦‚ï¼ŒConsoleåªèƒ½é€šè¿‡JSONæ ¼å¼æ¥æ˜¾ç¤ºç»Ÿè®¡æ•°æ®ï¼ŒEmailåªèƒ½é€šè¿‡æŸç§å›ºå®šçš„HTMLæ ¼å¼æ˜¾ç¤ºæ•°æ®ï¼Œè¿™æ ·çš„è®¾è®¡è¿˜ä¸å¤Ÿçµæ´»ã€‚æˆ‘ä»¬å¯ä»¥å°†æ˜¾ç¤ºæ ¼å¼è®¾è®¡æˆç‹¬ç«‹çš„ç±»ï¼Œå°†æ˜¾ç¤ºç»ˆç«¯å’Œæ˜¾ç¤ºæ ¼å¼çš„ä»£ç åˆ†ç¦»ï¼Œè®©æ˜¾ç¤ºç»ˆç«¯æ”¯æŒé…ç½®ä¸åŒçš„æ˜¾ç¤ºæ ¼å¼ã€‚å…·ä½“çš„ä»£ç å®ç°ç•™ç»™ä½ è‡ªå·±æ€è€ƒï¼Œæˆ‘è¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚

## éåŠŸèƒ½éœ€æ±‚å®Œå–„

Reviewå®Œäº†åŠŸèƒ½éœ€æ±‚çš„å®Œå–„ç¨‹åº¦ï¼Œç°åœ¨ï¼Œæˆ‘ä»¬å†æ¥çœ‹ï¼Œç‰ˆæœ¬3çš„éåŠŸèƒ½æ€§éœ€æ±‚çš„å®Œå–„ç¨‹åº¦ã€‚åœ¨ç¬¬25è®²ä¸­ï¼Œæˆ‘ä»¬æåˆ°ï¼Œé’ˆå¯¹è¿™ä¸ªæ¡†æ¶çš„å¼€å‘ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘çš„éåŠŸèƒ½æ€§éœ€æ±‚åŒ…æ‹¬ï¼šæ˜“ç”¨æ€§ã€æ€§èƒ½ã€æ‰©å±•æ€§ã€å®¹é”™æ€§ã€é€šç”¨æ€§ã€‚æˆ‘ä»¬ç°åœ¨å°±ä¾æ¬¡æ¥çœ‹ä¸€ä¸‹è¿™å‡ ä¸ªæ–¹é¢ã€‚

### 1.æ˜“ç”¨æ€§

æ‰€è°“çš„æ˜“ç”¨æ€§ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æ¡†æ¶æ˜¯å¦å¥½ç”¨ã€‚æ¡†æ¶çš„ä½¿ç”¨è€…å°†æ¡†æ¶é›†æˆåˆ°è‡ªå·±çš„ç³»ç»Ÿä¸­æ—¶ï¼Œä¸»è¦ç”¨åˆ°MetricsCollectorå’ŒEmailReporterã€ConsoleReporterè¿™å‡ ä¸ªç±»ã€‚é€šè¿‡MetricsCollectorç±»æ¥é‡‡é›†æ•°æ®ï¼Œé€šè¿‡EmailReporterã€ConsoleReporterç±»æ¥è§¦å‘ä¸»åŠ¨ç»Ÿè®¡æ•°æ®ã€æ˜¾ç¤ºç»Ÿè®¡ç»“æœã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```
public class PerfCounterTest {
  public static void main(String[] args) {
    MetricsStorage storage = new RedisMetricsStorage();
    Aggregator aggregator = new Aggregator();

    // å®šæ—¶è§¦å‘ç»Ÿè®¡å¹¶å°†ç»“æœæ˜¾ç¤ºåˆ°ç»ˆç«¯
    ConsoleViewer consoleViewer = new ConsoleViewer();
    ConsoleReporter consoleReporter = new ConsoleReporter(storage, aggregator, consoleViewer);
    consoleReporter.startRepeatedReport(60, 60);
    
    // å®šæ—¶è§¦å‘ç»Ÿè®¡å¹¶å°†ç»“æœè¾“å‡ºåˆ°é‚®ä»¶
    EmailViewer emailViewer = new EmailViewer();
    emailViewer.addToAddress("wangzheng@xzg.com");
    EmailReporter emailReporter = new EmailReporter(storage, aggregator, emailViewer);
    emailReporter.startDailyReport();

    // æ”¶é›†æ¥å£è®¿é—®æ•°æ®
    MetricsCollector collector = new MetricsCollector(storage);
    collector.recordRequest(new RequestInfo("register", 123, 10234));
    collector.recordRequest(new RequestInfo("register", 223, 11234));
    collector.recordRequest(new RequestInfo("register", 323, 12334));
    collector.recordRequest(new RequestInfo("login", 23, 12434));
    collector.recordRequest(new RequestInfo("login", 1223, 14234));

    try {
      Thread.sleep(100000);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
  }
}
```

ä»ä¸Šé¢çš„ä½¿ç”¨ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæ¡†æ¶ç”¨èµ·æ¥è¿˜æ˜¯ç¨å¾®æœ‰äº›å¤æ‚çš„ï¼Œéœ€è¦ç»„è£…å„ç§ç±»ï¼Œæ¯”å¦‚éœ€è¦åˆ›å»ºMetricsStorageå¯¹è±¡ã€Aggregatorå¯¹è±¡ã€ConsoleViewerå¯¹è±¡ï¼Œç„¶åæ³¨å…¥åˆ°ConsoleReporterä¸­ï¼Œæ‰èƒ½ä½¿ç”¨ConsoleReporterã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å¯èƒ½å­˜åœ¨è¯¯ç”¨çš„æƒ…å†µï¼Œæ¯”å¦‚æŠŠEmailViewerä¼ é€’è¿›äº†ConsoleReporterä¸­ã€‚æ€»ä½“ä¸Šæ¥è®²ï¼Œæ¡†æ¶çš„ä½¿ç”¨æ–¹å¼æš´éœ²äº†å¤ªå¤šç»†èŠ‚ç»™ç”¨æˆ·ï¼Œè¿‡äºçµæ´»ä¹Ÿå¸¦æ¥äº†æ˜“ç”¨æ€§çš„é™ä½ã€‚

ä¸ºäº†è®©æ¡†æ¶ç”¨èµ·æ¥æ›´åŠ ç®€å•ï¼ˆèƒ½å°†ç»„è£…çš„ç»†èŠ‚å°è£…åœ¨æ¡†æ¶ä¸­ï¼Œä¸æš´éœ²ç»™æ¡†æ¶ä½¿ç”¨è€…ï¼‰ï¼Œåˆä¸å¤±çµæ´»æ€§ï¼ˆå¯ä»¥è‡ªç”±ç»„è£…ä¸åŒçš„MetricsStorageå®ç°ç±»ã€StatViewerå®ç°ç±»åˆ°ConsoleReporteræˆ–EmailReporterï¼‰ï¼Œä¹Ÿä¸é™ä½ä»£ç çš„å¯æµ‹è¯•æ€§ï¼ˆé€šè¿‡ä¾èµ–æ³¨å…¥æ¥ç»„è£…ç±»ï¼Œæ–¹ä¾¿åœ¨å•å…ƒæµ‹è¯•ä¸­mockï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é¢å¤–åœ°æä¾›ä¸€äº›å°è£…äº†é»˜è®¤ä¾èµ–çš„æ„é€ å‡½æ•°ï¼Œè®©ä½¿ç”¨è€…è‡ªä¸»é€‰æ‹©ä½¿ç”¨å“ªç§æ„é€ å‡½æ•°æ¥æ„é€ å¯¹è±¡ã€‚è¿™æ®µè¯ç†è§£èµ·æ¥æœ‰ç‚¹å¤æ‚ï¼Œæˆ‘æŠŠæŒ‰ç…§è¿™ä¸ªæ€è·¯é‡æ„ä¹‹åçš„ä»£ç æ”¾åˆ°äº†ä¸‹é¢ï¼Œä½ å¯ä»¥ç»“åˆç€ä¸€å—çœ‹ä¸€ä¸‹ã€‚

```
public class MetricsCollector {
  private MetricsStorage metricsStorage;

  // å…¼é¡¾ä»£ç çš„æ˜“ç”¨æ€§ï¼Œæ–°å¢ä¸€ä¸ªå°è£…äº†é»˜è®¤ä¾èµ–çš„æ„é€ å‡½æ•°
  public MetricsCollectorB() {
    this(new RedisMetricsStorage());
  }

  // å…¼é¡¾çµæ´»æ€§å’Œä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œè¿™ä¸ªæ„é€ å‡½æ•°ç»§ç»­ä¿ç•™
  public MetricsCollectorB(MetricsStorage metricsStorage) {
    this.metricsStorage = metricsStorage;
  }
  // çœç•¥å…¶ä»–ä»£ç ...
}

public class ConsoleReporter extends ScheduledReporter {
  private ScheduledExecutorService executor;
  
  // å…¼é¡¾ä»£ç çš„æ˜“ç”¨æ€§ï¼Œæ–°å¢ä¸€ä¸ªå°è£…äº†é»˜è®¤ä¾èµ–çš„æ„é€ å‡½æ•°
  public ConsoleReporter() {
    this(new RedisMetricsStorage(), new Aggregator(), new ConsoleViewer());
  }

  // å…¼é¡¾çµæ´»æ€§å’Œä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œè¿™ä¸ªæ„é€ å‡½æ•°ç»§ç»­ä¿ç•™
  public ConsoleReporter(MetricsStorage metricsStorage, Aggregator aggregator, StatViewer viewer) {
    super(metricsStorage, aggregator, viewer);
    this.executor = Executors.newSingleThreadScheduledExecutor();
  }
  // çœç•¥å…¶ä»–ä»£ç ...
}

public class EmailReporter extends ScheduledReporter {
  private static final Long DAY_HOURS_IN_SECONDS = 86400L;

  // å…¼é¡¾ä»£ç çš„æ˜“ç”¨æ€§ï¼Œæ–°å¢ä¸€ä¸ªå°è£…äº†é»˜è®¤ä¾èµ–çš„æ„é€ å‡½æ•°
  public EmailReporter(List<String> emailToAddresses) {
    this(new RedisMetricsStorage(), new Aggregator(), new EmailViewer(emailToAddresses));
  }
  
  // å…¼é¡¾çµæ´»æ€§å’Œä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œè¿™ä¸ªæ„é€ å‡½æ•°ç»§ç»­ä¿ç•™
  public EmailReporter(MetricsStorage metricsStorage, Aggregator aggregator, StatViewer viewer) {
    super(metricsStorage, aggregator, viewer);
  }
  // çœç•¥å…¶ä»–ä»£ç ...
}
```

ç°åœ¨ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹æ¡†æ¶å¦‚ä½•æ¥ä½¿ç”¨ã€‚å…·ä½“ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºã€‚çœ‹èµ·æ¥æ˜¯ä¸æ˜¯ç®€å•å¤šäº†å‘¢ï¼Ÿ

```
public class PerfCounterTest {
  public static void main(String[] args) {
    ConsoleReporter consoleReporter = new ConsoleReporter();
    consoleReporter.startRepeatedReport(60, 60);

    List<String> emailToAddresses = new ArrayList<>();
    emailToAddresses.add("wangzheng@xzg.com");
    EmailReporter emailReporter = new EmailReporter(emailToAddresses);
    emailReporter.startDailyReport();

    MetricsCollector collector = new MetricsCollector();
    collector.recordRequest(new RequestInfo("register", 123, 10234));
    collector.recordRequest(new RequestInfo("register", 223, 11234));
    collector.recordRequest(new RequestInfo("register", 323, 12334));
    collector.recordRequest(new RequestInfo("login", 23, 12434));
    collector.recordRequest(new RequestInfo("login", 1223, 14234));

    try {
      Thread.sleep(100000);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
  }
}
```

å¦‚æœä½ è¶³å¤Ÿç»†å¿ƒï¼Œå¯èƒ½å·²ç»å‘ç°ï¼ŒRedisMeticsStorageå’ŒEmailViewerè¿˜éœ€è¦å¦å¤–ä¸€äº›é…ç½®ä¿¡æ¯æ‰èƒ½æ„å»ºæˆåŠŸï¼Œæ¯”å¦‚Redisçš„åœ°å€ï¼ŒEmailé‚®ç®±çš„POP3æœåŠ¡å™¨åœ°å€ã€å‘é€åœ°å€ã€‚è¿™äº›é…ç½®å¹¶æ²¡æœ‰åœ¨åˆšåˆšä»£ç ä¸­ä½“ç°åˆ°ï¼Œé‚£æˆ‘ä»¬è¯¥å¦‚ä½•è·å–å‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥å°†è¿™äº›é…ç½®ä¿¡æ¯æ”¾åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œåœ¨æ¡†æ¶å¯åŠ¨çš„æ—¶å€™ï¼Œè¯»å–é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®ä¿¡æ¯åˆ°ä¸€ä¸ªConfigurationå•ä¾‹ç±»ã€‚RedisMetricsStorageç±»å’ŒEmailViewerç±»éƒ½å¯ä»¥ä»è¿™ä¸ªConfigurationç±»ä¸­è·å–éœ€è¦çš„é…ç½®ä¿¡æ¯æ¥æ„å»ºè‡ªå·±ã€‚

### 2.æ€§èƒ½

å¯¹äºéœ€è¦é›†æˆåˆ°ä¸šåŠ¡ç³»ç»Ÿçš„æ¡†æ¶æ¥è¯´ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›æ¡†æ¶æœ¬èº«ä»£ç çš„æ‰§è¡Œæ•ˆç‡ï¼Œå¯¹ä¸šåŠ¡ç³»ç»Ÿæœ‰å¤ªå¤šæ€§èƒ½ä¸Šçš„å½±å“ã€‚å¯¹äºæ€§èƒ½è®¡æ•°å™¨è¿™ä¸ªæ¡†æ¶æ¥è¯´ï¼Œä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒæ˜¯ä½å»¶è¿Ÿçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç»Ÿè®¡ä»£ç ä¸å½±å“æˆ–å¾ˆå°‘å½±å“æ¥å£æœ¬èº«çš„å“åº”æ—¶é—´ï¼›å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å¸Œæœ›æ¡†æ¶æœ¬èº«å¯¹å†…å­˜çš„æ¶ˆè€—ä¸èƒ½å¤ªå¤§ã€‚

å¯¹äºæ€§èƒ½è¿™ä¸€ç‚¹ï¼Œè½å®åˆ°å…·ä½“çš„ä»£ç å±‚é¢ï¼Œéœ€è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡çš„ï¼Œä¸€ä¸ªæ˜¯é‡‡é›†å’Œå­˜å‚¨è¦å¼‚æ­¥æ¥æ‰§è¡Œï¼Œå› ä¸ºå­˜å‚¨åŸºäºå¤–éƒ¨å­˜å‚¨ï¼ˆæ¯”å¦‚Redisï¼‰ï¼Œä¼šæ¯”è¾ƒæ…¢ï¼Œå¼‚æ­¥å­˜å‚¨å¯ä»¥é™ä½å¯¹æ¥å£å“åº”æ—¶é—´çš„å½±å“ã€‚å¦ä¸€ä¸ªæ˜¯å½“éœ€è¦èšåˆç»Ÿè®¡çš„æ•°æ®é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œä¸€æ¬¡æ€§åŠ è½½å¤ªå¤šçš„æ•°æ®åˆ°å†…å­˜ï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´å†…å­˜åƒç´§ï¼Œç”šè‡³å†…å­˜æº¢å‡ºï¼Œè¿™æ ·æ•´ä¸ªç³»ç»Ÿéƒ½ä¼šç˜«ç—ªæ‰ã€‚

é’ˆå¯¹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é€šè¿‡åœ¨MetricsCollectorä¸­å¼•å…¥Google Guava EventBusæ¥è§£å†³ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æŠŠEventBusçœ‹ä½œä¸€ä¸ªâ€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€æ¨¡å‹æˆ–è€…â€œå‘å¸ƒ-è®¢é˜…â€æ¨¡å‹ï¼Œé‡‡é›†çš„æ•°æ®å…ˆæ”¾å…¥å†…å­˜å…±äº«é˜Ÿåˆ—ä¸­ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¯»å–å…±äº«é˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼Œå†™å…¥åˆ°å¤–éƒ¨å­˜å‚¨ï¼ˆæ¯”å¦‚Redisï¼‰ä¸­ã€‚å…·ä½“çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š

```
public class MetricsCollector {
  private static final int DEFAULT_STORAGE_THREAD_POOL_SIZE = 20;

  private MetricsStorage metricsStorage;
  private EventBus eventBus;

  public MetricsCollector(MetricsStorage metricsStorage) {
    this(metricsStorage, DEFAULT_STORAGE_THREAD_POOL_SIZE);
  }

  public MetricsCollector(MetricsStorage metricsStorage, int threadNumToSaveData) {
    this.metricsStorage = metricsStorage;
    this.eventBus = new AsyncEventBus(Executors.newFixedThreadPool(threadNumToSaveData));
    this.eventBus.register(new EventListener());
  }

  public void recordRequest(RequestInfo requestInfo) {
    if (requestInfo == null || StringUtils.isBlank(requestInfo.getApiName())) {
      return;
    }
    eventBus.post(requestInfo);
  }

  public class EventListener {
    @Subscribe
    public void saveRequestInfo(RequestInfo requestInfo) {
      metricsStorage.saveRequestInfo(requestInfo);
    }
  }
}
```

é’ˆå¯¹ç¬¬äºŒä¸ªé—®é¢˜ï¼Œè§£å†³çš„æ€è·¯æ¯”è¾ƒç®€å•ï¼Œä½†ä»£ç å®ç°ç¨å¾®æœ‰ç‚¹å¤æ‚ã€‚å½“ç»Ÿè®¡çš„æ—¶é—´é—´éš”è¾ƒå¤§çš„æ—¶å€™ï¼Œéœ€è¦ç»Ÿè®¡çš„æ•°æ®é‡å°±ä¼šæ¯”è¾ƒå¤§ã€‚æˆ‘ä»¬å¯ä»¥å°†å…¶åˆ’åˆ†ä¸ºä¸€äº›å°çš„æ—¶é—´åŒºé—´ï¼ˆæ¯”å¦‚10åˆ†é’Ÿä½œä¸ºä¸€ä¸ªç»Ÿè®¡å•å…ƒï¼‰ï¼Œé’ˆå¯¹æ¯ä¸ªå°çš„æ—¶é—´åŒºé—´åˆ†åˆ«è¿›è¡Œç»Ÿè®¡ï¼Œç„¶åå°†ç»Ÿè®¡å¾—åˆ°çš„ç»“æœå†è¿›è¡Œèšåˆï¼Œå¾—åˆ°æœ€ç»ˆæ•´ä¸ªæ—¶é—´åŒºé—´çš„ç»Ÿè®¡ç»“æœã€‚ä¸è¿‡ï¼Œè¿™ä¸ªæ€è·¯åªé€‚åˆå“åº”æ—¶é—´çš„maxã€minã€avgï¼ŒåŠå…¶æ¥å£è¯·æ±‚countã€tpsçš„ç»Ÿè®¡ï¼Œå¯¹äºå“åº”æ—¶é—´çš„percentileçš„ç»Ÿè®¡å¹¶ä¸é€‚ç”¨ã€‚

å¯¹äºpercentileçš„ç»Ÿè®¡è¦ç¨å¾®å¤æ‚ä¸€äº›ï¼Œå…·ä½“çš„è§£å†³æ€è·¯æ˜¯è¿™æ ·å­çš„ï¼šæˆ‘ä»¬åˆ†æ‰¹ä»Redisä¸­è¯»å–æ•°æ®ï¼Œç„¶åå­˜å‚¨åˆ°æ–‡ä»¶ä¸­ï¼Œå†æ ¹æ®å“åº”æ—¶é—´ä»å°åˆ°å¤§åˆ©ç”¨å¤–éƒ¨æ’åºç®—æ³•æ¥è¿›è¡Œæ’åºï¼ˆå…·ä½“çš„å®ç°æ–¹å¼å¯ä»¥çœ‹ä¸€ä¸‹ã€Šæ•°æ®ç»“æ„ä¸ç®—æ³•ä¹‹ç¾ã€‹ä¸“æ ï¼‰ã€‚æ’åºå®Œæˆä¹‹åï¼Œå†ä»æ–‡ä»¶ä¸­è¯»å–ç¬¬count\*percentileï¼ˆcountè¡¨ç¤ºæ€»çš„æ•°æ®ä¸ªæ•°ï¼Œpercentileå°±æ˜¯ç™¾åˆ†æ¯”ï¼Œ99ç™¾åˆ†ä½å°±æ˜¯0.99ï¼‰ä¸ªæ•°æ®ï¼Œå°±æ˜¯å¯¹åº”çš„percentileå“åº”æ—¶é—´ã€‚

è¿™é‡Œæˆ‘åªç»™å‡ºäº†é™¤äº†percentileä¹‹å¤–çš„ç»Ÿè®¡ä¿¡æ¯çš„è®¡ç®—ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚å¯¹äºpercentileçš„è®¡ç®—ï¼Œå› ä¸ºä»£ç é‡æ¯”è¾ƒå¤§ï¼Œç•™ç»™ä½ è‡ªå·±å®ç°ã€‚

```
public class ScheduleReporter {
  private static final long MAX_STAT_DURATION_IN_MILLIS = 10 * 60 * 1000; // 10minutes

  protected MetricsStorage metricsStorage;
  protected Aggregator aggregator;
  protected StatViewer viewer;

  public ScheduleReporter(MetricsStorage metricsStorage, Aggregator aggregator, StatViewer viewer) {
    this.metricsStorage = metricsStorage;
    this.aggregator = aggregator;
    this.viewer = viewer;
  }

  protected void doStatAndReport(long startTimeInMillis, long endTimeInMillis) {
    Map<String, RequestStat> stats = doStat(startTimeInMillis, endTimeInMillis);
    viewer.output(stats, startTimeInMillis, endTimeInMillis);
  }

  private Map<String, RequestStat> doStat(long startTimeInMillis, long endTimeInMillis) {
    Map<String, List<RequestStat>> segmentStats = new HashMap<>();
    long segmentStartTimeMillis = startTimeInMillis;
    while (segmentStartTimeMillis < endTimeInMillis) {
      long segmentEndTimeMillis = segmentStartTimeMillis + MAX_STAT_DURATION_IN_MILLIS;
      if (segmentEndTimeMillis > endTimeInMillis) {
        segmentEndTimeMillis = endTimeInMillis;
      }
      Map<String, List<RequestInfo>> requestInfos =
              metricsStorage.getRequestInfos(segmentStartTimeMillis, segmentEndTimeMillis);
      if (requestInfos == null || requestInfos.isEmpty()) {
        continue;
      }
      Map<String, RequestStat> segmentStat = aggregator.aggregate(
              requestInfos, segmentEndTimeMillis - segmentStartTimeMillis);
      addStat(segmentStats, segmentStat);
      segmentStartTimeMillis += MAX_STAT_DURATION_IN_MILLIS;
    }

    long durationInMillis = endTimeInMillis - startTimeInMillis;
    Map<String, RequestStat> aggregatedStats = aggregateStats(segmentStats, durationInMillis);
    return aggregatedStats;
  }

  private void addStat(Map<String, List<RequestStat>> segmentStats,
                       Map<String, RequestStat> segmentStat) {
    for (Map.Entry<String, RequestStat> entry : segmentStat.entrySet()) {
      String apiName = entry.getKey();
      RequestStat stat = entry.getValue();
      List<RequestStat> statList = segmentStats.putIfAbsent(apiName, new ArrayList<>());
      statList.add(stat);
    }
  }

  private Map<String, RequestStat> aggregateStats(Map<String, List<RequestStat>> segmentStats,
                                                  long durationInMillis) {
    Map<String, RequestStat> aggregatedStats = new HashMap<>();
    for (Map.Entry<String, List<RequestStat>> entry : segmentStats.entrySet()) {
      String apiName = entry.getKey();
      List<RequestStat> apiStats = entry.getValue();
      double maxRespTime = Double.MIN_VALUE;
      double minRespTime = Double.MAX_VALUE;
      long count = 0;
      double sumRespTime = 0;
      for (RequestStat stat : apiStats) {
        if (stat.getMaxResponseTime() > maxRespTime) maxRespTime = stat.getMaxResponseTime();
        if (stat.getMinResponseTime() < minRespTime) minRespTime = stat.getMinResponseTime();
        count += stat.getCount();
        sumRespTime += (stat.getCount() * stat.getAvgResponseTime());
      }
      RequestStat aggregatedStat = new RequestStat();
      aggregatedStat.setMaxResponseTime(maxRespTime);
      aggregatedStat.setMinResponseTime(minRespTime);
      aggregatedStat.setAvgResponseTime(sumRespTime / count);
      aggregatedStat.setCount(count);
      aggregatedStat.setTps(count / durationInMillis * 1000);
      aggregatedStats.put(apiName, aggregatedStat);
    }
    return aggregatedStats;
  }
}
```

### 3.æ‰©å±•æ€§

å‰é¢æˆ‘ä»¬æåˆ°ï¼Œæ¡†æ¶çš„æ‰©å±•æ€§æœ‰åˆ«äºä»£ç çš„æ‰©å±•æ€§ï¼Œæ˜¯ä»ä½¿ç”¨è€…çš„è§’åº¦æ¥è®²çš„ï¼Œç‰¹æŒ‡ä½¿ç”¨è€…å¯ä»¥åœ¨ä¸ä¿®æ”¹æ¡†æ¶æºç ï¼Œç”šè‡³ä¸æ‹¿åˆ°æ¡†æ¶æºç çš„æƒ…å†µä¸‹ï¼Œä¸ºæ¡†æ¶æ‰©å±•æ–°çš„åŠŸèƒ½ã€‚

åœ¨åˆšåˆšè®²åˆ°æ¡†æ¶çš„æ˜“ç”¨æ€§çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»™å‡ºäº†æ¡†æ¶å¦‚ä½•ä½¿ç”¨çš„ä»£ç ç¤ºä¾‹ã€‚ä»ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ¡†æ¶åœ¨å…¼é¡¾æ˜“ç”¨æ€§çš„åŒæ—¶ï¼Œä¹Ÿå¯ä»¥çµæ´»åœ°æ›¿æ¢å„ç§ç±»å¯¹è±¡ï¼Œæ¯”å¦‚MetricsStorageã€StatViewerã€‚ä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬è¦è®©æ¡†æ¶åŸºäºHBaseæ¥å­˜å‚¨åŸå§‹æ•°æ®è€ŒéRedisï¼Œé‚£æˆ‘ä»¬åªéœ€è¦è®¾è®¡ä¸€ä¸ªå®ç°MetricsStorageæ¥å£çš„HBaseMetricsStorageç±»ï¼Œä¼ é€’ç»™MetricsCollectorå’ŒConsoleReporterã€EmailReporterç±»å³å¯ã€‚

### 4.å®¹é”™æ€§

å®¹é”™æ€§è¿™ä¸€ç‚¹ä¹Ÿéå¸¸é‡è¦ã€‚å¯¹äºè¿™ä¸ªæ¡†æ¶æ¥è¯´ï¼Œä¸èƒ½å› ä¸ºæ¡†æ¶æœ¬èº«çš„å¼‚å¸¸å¯¼è‡´æ¥å£è¯·æ±‚å‡ºé”™ã€‚æ‰€ä»¥ï¼Œå¯¹æ¡†æ¶å¯èƒ½å­˜åœ¨çš„å„ç§å¼‚å¸¸æƒ…å†µï¼Œæˆ‘ä»¬éƒ½è¦è€ƒè™‘å…¨é¢ã€‚

åœ¨ç°åœ¨çš„æ¡†æ¶è®¾è®¡ä¸å®ç°ä¸­ï¼Œé‡‡é›†å’Œå­˜å‚¨æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œå³ä¾¿RedisæŒ‚æ‰æˆ–è€…å†™å…¥è¶…æ—¶ï¼Œä¹Ÿä¸ä¼šå½±å“åˆ°æ¥å£çš„æ­£å¸¸å“åº”ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒRediså¼‚å¸¸ï¼Œå¯èƒ½ä¼šå½±å“åˆ°æ•°æ®ç»Ÿè®¡æ˜¾ç¤ºï¼ˆä¹Ÿå°±æ˜¯ConsoleReporterã€EmailReporterè´Ÿè´£çš„å·¥ä½œï¼‰ï¼Œä½†å¹¶ä¸ä¼šå½±å“åˆ°æ¥å£çš„æ­£å¸¸å“åº”ã€‚

### 5.é€šç”¨æ€§

ä¸ºäº†æé«˜æ¡†æ¶çš„å¤ç”¨æ€§ï¼Œèƒ½å¤Ÿçµæ´»åº”ç”¨åˆ°å„ç§åœºæ™¯ä¸­ï¼Œæ¡†æ¶åœ¨è®¾è®¡çš„æ—¶å€™ï¼Œè¦å°½å¯èƒ½é€šç”¨ã€‚æˆ‘ä»¬è¦å¤šå»æ€è€ƒä¸€ä¸‹ï¼Œé™¤äº†æ¥å£ç»Ÿè®¡è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼Œè¿™ä¸ªæ¡†æ¶è¿˜å¯ä»¥é€‚ç”¨åˆ°å…¶ä»–å“ªäº›åœºæ™¯ä¸­ã€‚æ¯”å¦‚æ˜¯å¦è¿˜å¯ä»¥å¤„ç†å…¶ä»–äº‹ä»¶çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œæ¯”å¦‚SQLè¯·æ±‚æ—¶é—´çš„ç»Ÿè®¡ã€ä¸šåŠ¡ç»Ÿè®¡ï¼ˆæ¯”å¦‚æ”¯ä»˜æˆåŠŸç‡ï¼‰ç­‰ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åœ¨ç°åœ¨çš„ç‰ˆæœ¬3ä¸­æš‚æ—¶æ²¡æœ‰è€ƒè™‘åˆ°ï¼Œä½ å¯ä»¥è‡ªå·±æ€è€ƒä¸€ä¸‹ã€‚

## é‡ç‚¹å›é¡¾

å¥½äº†ï¼Œä»Šå¤©çš„å†…å®¹åˆ°æ­¤å°±è®²å®Œäº†ã€‚æˆ‘ä»¬ä¸€å—æ¥æ€»ç»“å›é¡¾ä¸€ä¸‹ï¼Œä½ éœ€è¦æŒæ¡çš„é‡ç‚¹å†…å®¹ã€‚

è¿˜è®°å¾—å—ï¼Ÿåœ¨ç¬¬25ã€26è®²ä¸­ï¼Œæˆ‘ä»¬æåˆ°ï¼Œé’ˆå¯¹æ€§èƒ½è®¡æ•°å™¨è¿™ä¸ªæ¡†æ¶çš„å¼€å‘ï¼Œè¦æƒ³ä¸€ä¸‹å­å®ç°æˆ‘ä»¬ç½—åˆ—çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå¯¹ä»»ä½•äººæ¥è¯´éƒ½æ˜¯æ¯”è¾ƒæœ‰æŒ‘æˆ˜çš„ã€‚è€Œç»è¿‡è¿™å‡ ä¸ªç‰ˆæœ¬çš„è¿­ä»£ä¹‹åï¼Œæˆ‘ä»¬ä¸çŸ¥ä¸è§‰åœ°å°±å®Œæˆäº†å‡ ä¹æ‰€æœ‰çš„éœ€æ±‚ï¼ŒåŒ…æ‹¬åŠŸèƒ½æ€§å’ŒéåŠŸèƒ½æ€§çš„éœ€æ±‚ã€‚

åœ¨ç¬¬25è®²ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªæœ€å°åŸå‹ï¼Œè™½ç„¶éå¸¸ç®€é™‹ï¼Œæ‰€æœ‰çš„ä»£ç éƒ½å¡åœ¨ä¸€ä¸ªç±»ä¸­ï¼Œä½†å®ƒå¸®æˆ‘ä»¬æ¢³ç†æ¸…æ¥šäº†éœ€æ±‚ã€‚åœ¨ç¬¬26è®²ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†æ¡†æ¶çš„ç¬¬1ä¸ªç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬åªåŒ…å«æœ€åŸºæœ¬çš„åŠŸèƒ½ï¼Œå¹¶ä¸”åˆæ­¥åˆ©ç”¨é¢å‘å¯¹è±¡çš„è®¾è®¡æ–¹æ³•ï¼ŒæŠŠä¸åŒåŠŸèƒ½çš„ä»£ç åˆ’åˆ†åˆ°äº†ä¸åŒçš„ç±»ä¸­ã€‚

åœ¨ç¬¬39è®²ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†æ¡†æ¶çš„ç¬¬2ä¸ªç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬å¯¹ç¬¬1ä¸ªç‰ˆæœ¬çš„ä»£ç ç»“æ„è¿›è¡Œäº†æ¯”è¾ƒå¤§çš„è°ƒæ•´ï¼Œè®©æ•´ä½“ä»£ç ç»“æ„æ›´åŠ åˆç†ã€æ¸…æ™°ã€æœ‰é€»è¾‘æ€§ã€‚

åœ¨ç¬¬40è®²ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†æ¡†æ¶çš„ç¬¬3ä¸ªç‰ˆæœ¬ï¼Œå¯¹ç¬¬2ä¸ªç‰ˆæœ¬é—ç•™çš„ç»†èŠ‚é—®é¢˜è¿›è¡Œäº†é‡æ„ï¼Œå¹¶ä¸”é‡ç‚¹è§£å†³äº†æ¡†æ¶çš„æ˜“ç”¨æ€§å’Œæ€§èƒ½é—®é¢˜ã€‚

ä»ä¸Šé¢çš„è¿­ä»£è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯é’ˆå¯¹é—®é¢˜è§£å†³é—®é¢˜ï¼Œæ¯ä¸ªç‰ˆæœ¬éƒ½èšç„¦ä¸€å°éƒ¨åˆ†é—®é¢˜ï¼Œæ‰€ä»¥æ•´ä¸ªè¿‡ç¨‹ä¹Ÿæ²¡æœ‰æ„Ÿè§‰åˆ°æœ‰å¤ªå¤§éš¾åº¦ã€‚å°½ç®¡æˆ‘ä»¬è¿­ä»£äº†3ä¸ªç‰ˆæœ¬ï¼Œä½†ç›®å‰çš„è®¾è®¡å’Œå®ç°è¿˜æœ‰å¾ˆå¤šå€¼å¾—è¿›ä¸€æ­¥ä¼˜åŒ–å’Œå®Œå–„çš„åœ°æ–¹ï¼Œä½†é™äºä¸“æ çš„ç¯‡å¹…ï¼Œç»§ç»­ä¼˜åŒ–çš„å·¥ä½œç•™ç»™ä½ è‡ªå·±æ¥å®Œæˆã€‚

æœ€åï¼Œæˆ‘å¸Œæœ›ä½ ä¸ä»…ä»…å…³æ³¨è¿™ä¸ªæ¡†æ¶æœ¬èº«çš„è®¾è®¡å’Œå®ç°ï¼Œæ›´é‡è¦çš„æ˜¯å­¦ä¼šè¿™ä¸ªé€æ­¥ä¼˜åŒ–çš„æ–¹æ³•ï¼Œä»¥åŠå…¶ä¸­æ¶‰åŠçš„ä¸€äº›ç¼–ç¨‹æŠ€å·§ã€è®¾è®¡æ€è·¯ï¼Œèƒ½å¤Ÿä¸¾ä¸€åä¸‰åœ°ç”¨åœ¨å…¶ä»–é¡¹ç›®ä¸­ã€‚

## è¯¾å ‚è®¨è®º

æœ€åï¼Œè¿˜æ˜¯ç»™ä½ ç•™ä¸€é“è¯¾å ‚è®¨è®ºé¢˜ã€‚

æ­£å¸¸æƒ…å†µä¸‹ï¼ŒConsoleReporterçš„startRepeatedReport()å‡½æ•°åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚ä½†æ˜¯ï¼Œå¦‚æœè¢«å¤šæ¬¡è°ƒç”¨ï¼Œé‚£å°±ä¼šå­˜åœ¨é—®é¢˜ã€‚å…·ä½“ä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿåˆè¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ

æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„ç­”æ¡ˆï¼Œå’ŒåŒå­¦ä¸€èµ·äº¤æµå’Œåˆ†äº«ã€‚å¦‚æœæœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚

[![](https://static001.geekbang.org/resource/image/8b/43/8b7e755ddb44e490848a052c5dc11043.jpg?wh=1142%2A640)](https://jinshuju.net/f/cZuRmd)
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>æå°å››</span> ğŸ‘ï¼ˆ94ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è®¾è®¡æ¨¡å¼_40:
# ä½œä¸š

å¯¼è‡´å¤šä¸ªçº¿ç¨‹çš„é‡å¤ç»Ÿè®¡ã€‚
åŠæ³•ï¼šåŠ å…¥è¿›ç¨‹å†…çš„å…¨å±€å˜é‡(æ³¨æ„å¤šçº¿ç¨‹åŒæ­¥é—®é¢˜)ã€‚

# æ„Ÿæƒ³

æˆ‘ä¸ªäººæ˜¯Androidå·¥ç¨‹å¸ˆï¼Œå®¢æˆ·ç«¯çš„å¼€å‘é»˜è®¤å°±è¦æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šæ–¹æ³•é‡å¤è°ƒç”¨æ—¶(å¦‚å¤šæ¬¡ç‚¹å‡»æŸä¸ªæŒ‰é’®ç­‰)é€»è¾‘æ˜¯å¦è¿˜æ­£å¸¸ã€‚

25ï¼Œ26ï¼Œ39ï¼Œ40è¿™å››èŠ‚è¯¾è¾¹å¬è¾¹è¯»åå¤äº†å¥½å‡ éäº†ï¼Œå› ä¸ºç›®çš„æ˜¯æŒæ¡è¯¥æŒæ¡çš„ä¸œè¥¿ï¼Œè€Œä¸æ˜¯ç®€å•åœ°æ‰“ä¸ªå¡ï¼Œæ‰€ä»¥æ•´ä¸ªæ˜¥èŠ‚æœŸé—´å°±å¡åœ¨è¿™å››èŠ‚è¯¾çš„é‡å¤ä¸­äº†ï¼Œä¸åœåœ°å¾ªç¯å¬ã€‚ã€‚ã€‚

ä¹Ÿæœ‰å¥½å¤„ï¼šæˆ‘åå€’å¯¹è¿™å‡ èŠ‚å†…å®¹éå¸¸ç†Ÿæ‚‰äº†ï¼Œæœ‰ä¸¤ç‚¹æ„Ÿå—è¾ƒæ·±ï¼š
1&gt; æ–¹æ³•è®ºï¼šåˆ†æ¸…æ¥š *åŠŸèƒ½æ€§éœ€æ±‚* ä¸ *éåŠŸèƒ½å‹éœ€æ±‚*
	ä¹‹å‰æ˜¯æƒ³åˆ°ä»€ä¹ˆæ³¨æ„ä»€ä¹ˆï¼Œå¾€å¾€åšä¸åˆ°ç©·ä¸¾ã€‚

2&gt; ä¸€æ­¥ä¸€æ­¥åœ°é‡æ„ï¼Œå…¶å®è§£å†³çš„æ˜¯è‡ªä¿¡é—®é¢˜ï¼š
	åšäº‹è¦å…ˆè§£å†³æ€æƒ³é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å¿ƒç†é—®é¢˜ï¼š
	- æ²¡æœ‰äººèƒ½å¤Ÿä¸€æ­¥åˆ°ä½åœ°å®Œç¾è§£å†³é—®é¢˜ï¼Œä¼˜ç§€çš„ä»£ç æ˜¯æ¼”è¿›çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»£ç ç»“æ„ä¸å®Œç¾çš„çŠ¶æ€æ˜¯è·³ä¸è¿‡å»çš„ã€‚
	- æˆ‘ä»¬å§‹ç»ˆèšç„¦åœ¨è§£å†³é—®é¢˜ä¸Šï¼Œä»£ç æœ‰é—®é¢˜éå¸¸æ­£å¸¸ã€‚
	- æˆ‘ä»¬è¦å¸¦ç€æˆå°±æ„Ÿä¸æ–­é‡æ„ä»£ç ï¼Œè€Œä¸æ˜¯å¸¦ç€å¯¹è‡ªå·±å¦å®šçš„æ„§ç–šæ„Ÿï¼Œè¿™éå¸¸é‡è¦ã€‚
	- æˆå°±æ„Ÿè®©ä½ è¿½æ±‚å“è¶Šï¼Œæ„§ç–šæ„Ÿåªæ˜¯è®©ä½ ä¸æƒ³çŠ¯é”™(è€Œè¿™æ˜¯åšä¸åˆ°çš„)ã€‚</p>2020-02-22</li><br/><li><span>è¾£ä¹ˆå¤§</span> ğŸ‘ï¼ˆ20ï¼‰ ğŸ’¬ï¼ˆ5ï¼‰<p>æ€è€ƒé¢˜ï¼šstartRepeatedReport()å¤šæ¬¡è°ƒç”¨ï¼Œä¼šå¯åŠ¨å¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæ‰§è¡Œç»Ÿè®¡å’Œè¾“å‡ºå·¥ä½œã€‚
æƒ³äº†ä¸€ç§ç®€å•çš„å®ç°æ–¹å¼ï¼Œå°†runnableåšä¸ºæˆå‘˜å˜é‡ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨startRepeatedReport()æ—¶åˆå§‹åŒ–ï¼Œè‹¥å¤šæ¬¡è°ƒç”¨ï¼Œåˆ¤ç©ºï¼Œè¿”å›ã€‚
  public void startRepeatedReport(long periodInSeconds, long durationInSeconds) {
    if (runnable != null) {
      System.out.println(&quot;duplicate calls!&quot;);
      return;
    }
    runnable = () -&gt; {
      long durationInMillis = durationInSeconds * 1000;
      long endTimeInMillis = System.currentTimeMillis();
      long startTimeInMillis = endTimeInMillis - durationInMillis;
      doReport(startTimeInMillis, endTimeInMillis);
    };
    executor.scheduleAtFixedRate(runnable, 0, periodInSeconds, TimeUnit.SECONDS);
  }
ä»£ç æ”¾åœ¨äº†ï¼šhttps:&#47;&#47;github.com&#47;gdhucoder&#47;Algorithms4&#47;tree&#47;master&#47;designpattern&#47;u40</p>2020-02-03</li><br/><li><span>Andy</span> ğŸ‘ï¼ˆ16ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è€å¸ˆèƒ½æä¾›è¯¾ç¨‹ä»£ç å—ï¼Ÿ</p>2020-02-04</li><br/><li><span>å¹³é£é€ é›¨</span> ğŸ‘ï¼ˆ15ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è°ƒç”¨å¤šæ¬¡å¯ä»¥é€šè¿‡å¤šçº¿ç¨‹å…±äº«çš„çŠ¶æ€å˜é‡æ¥è§£å†³ï¼ŒCASæˆ–è€…åŠ é”è¿›è¡ŒçŠ¶æ€çš„å˜æ›´ã€‚</p>2020-02-03</li><br/><li><span>6ç‚¹æ— ç—›æ—©èµ·å­¦ä¹ çš„å’Œå°š</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¿™ä¸¤ç¯‡å®æˆ˜å¯¹è‡ªå·±çš„æ„Ÿè§‰å°±æ˜¯è¶Šæ¥è¶Šæ‡µï¼Œå¯èƒ½è¿˜éœ€è¦å¤šè¯»è¯»ï¼Œä¹Ÿä¸çŸ¥é“æ˜¯ä¸æ˜¯è·Ÿè‡ªå·±çš„é¡¹ç›®åšçš„å¾ˆå°‘æœ‰åŸå› ï¼Œå‰é¢çš„ç†è®ºéƒ½è¿˜èƒ½æ¶ˆåŒ–</p>2020-03-04</li><br/><li><span>undefined</span> ğŸ‘ï¼ˆ7ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ·±å…¥æµ…å‡ºï¼Œè¿‡ç˜¾ã€‚</p>2020-02-03</li><br/><li><span>Jxin</span> ğŸ‘ï¼ˆ7ï¼‰ ğŸ’¬ï¼ˆ6ï¼‰<p>å…ˆå›ç­”é—®é¢˜ï¼š
1.ä¼šå¯¼è‡´å¤šä½™çº¿ç¨‹åšå¤šä½™çš„ç»Ÿè®¡å’Œå±•ç¤ºã€‚å› ä¸ºæ¯æ¬¡è°ƒç”¨éƒ½ä¼šèµ·ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹è¾“å‡ºç»Ÿè®¡æ•°æ®åˆ°æ§åˆ¶å°ã€‚è¿™æ ·æ—¢ä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½å¼€é”€ï¼Œåˆä¼šå¯¼è‡´ç»Ÿè®¡ä¿¡æ¯ä¸æ˜“é˜…è¯»ã€‚

2.åœ¨ConsoleReporterå†…éƒ¨ç»´æŠ¤ä¸€ä¸ªå¯è§†å­—æ®µ startedã€‚ç„¶ååœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œä¼˜å…ˆåˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦å·²ç»å˜ä¸ºtrueã€‚å¦‚æœæ˜¯åˆ™ä¸å†å¾€ä¸‹æ‰§è¡Œã€‚ä¹Ÿç®—æ˜¯ä¿è¯è¯¥å‡½æ•°çš„å¹‚ç­‰æ€§ã€‚

ä¸ªäººç–‘é—®ï¼š
1.æ€ä¹ˆåšåˆ°è¿™æ ·åˆ†æ­¥å±•ç¤ºé‡æ„è¿‡ç¨‹çš„ï¼Ÿæˆ‘ç°åœ¨å†™ï¼ŒåŸºæœ¬ä¸€è¾¹å†™å°±ä¸€è¾¹é‡æ„ï¼Œåœæ‰‹ä¹Ÿå°±å·®ä¸å¤šåˆ°åˆé€‚çš„è´¨é‡äº†ã€‚åˆ»æ„è¦å±•ç¤ºé‡æ„æ‰‹æ³•ï¼Œå±•ç¤ºçš„çŸ¥è¯†ç‚¹ä¼šæœ‰å¾ˆå¤šç–æ¼ï¼Œå¹¶æ— æ³•åšåˆ°è¿™æ ·ä¸€æ­¥ä¸€æ­¥çš„å±•ç¤ºï¼ˆä¸‹æ„è¯†ä¸€æ­¥åˆ°ä½ï¼Œå¹¶ä¸çŸ¥é“æ€ä¹ˆé€€åˆ°ä¸å¥½çš„ä»£ç ç»“æ„ï¼‰ã€‚

2.èƒ½ç†è§£æ ä¸»å°½é‡ä¸ä¾èµ–ä»»ä½•æ¡†æ¶çš„åˆè¡·ã€‚ä½†å¯¹äºjavaï¼Œspringå…¶å®æ‰æ˜¯æ ‡å‡†ï¼Œæ„Ÿè§‰æ˜¯ä¸æ˜¯åŸºäºspringæ¡†æ¶æ¥å†™demoè¿˜å¥½ç‚¹ï¼Ÿ æˆ‘ç°åœ¨æ¯”è¾ƒå–œæ¬¢è®©ä»£ç ä¾èµ–springæ¡†æ¶æ¥å®ç°ï¼Œæ„Ÿè§‰è¿™æ ·ä¼šæ˜¾å¾—ä¼˜é›…ä¸€äº›ã€‚æ ä¸»æ€ä¹ˆçœ‹ï¼Ÿ

</p>2020-02-03</li><br/><li><span>é«˜æº</span> ğŸ‘ï¼ˆ7ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è€å¸ˆ39,40è¯¾å®Œæ•´æºä»£ç å¯ä»¥æä¾›ä¸‹å—ï¼Œæˆ‘å‡†å¤‡å¥½å¥½ç ”ç©¶å­¦ä¹ ä¸‹</p>2020-02-03</li><br/><li><span>Qç½—</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ç»ˆäºè¿›å»åˆ°æœŸå¾…å·²ä¹…çš„è®¾è®¡æ¨¡å¼äº†</p>2020-03-18</li><br/><li><span>javaadu</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¯¾å ‚è®¨è®ºï¼Œä½¿ç”¨ä¸€ä¸ªæ ‡è®°flagä½œä¸ºè¯¥å‡½æ•°è¢«è°ƒç”¨å›½çš„æ ‡è®°ï¼Œå¹¶ç»™è¿™ä¸ªå‡½æ•°åŠ é”ï¼Œè§£å†³å¹¶å‘é—®é¢˜</p>2020-02-03</li><br/><li><span>å°æ™å­</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯¾åæ€è€ƒï¼šå¦‚æœ startRepeatedReport()è¢«å¤šæ¬¡è°ƒç”¨ï¼Œé‚£ä¹ˆä¼šç”Ÿæˆå¤šä¸ªçº¿ç¨‹ä»¥fixed rateå»è¯·æ±‚ç„¶åè¾“å‡ºç»“æœåˆ°consoleä¸Šï¼Œä¸€æ–¹é¢å¯¼è‡´è¾“å‡ºç»“æœæ··ä¹±ï¼Œå¦ä¸€æ–¹é¢å¢åŠ äº†ç³»ç»Ÿçš„è´Ÿæ‹…ã€‚
è¦è§£å†³è¯¥é—®é¢˜æœ‰ä¸ªåŠæ³•æ˜¯å†é‡æ„ä¸€ä¸‹ä»£ç ï¼Œç¤ºæ„å¦‚ä¸‹ï¼ˆæœªæµ‹è¯•ï¼‰ï¼Œ
```
private Future&lt;?&gt; future; 
&#47;&#47;é¿å…åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨å…¶ä»–åœ°æ–¹ï¼Œå¦‚æ„é€ å‡½æ•°é‡Œ
private Runnable runnable = new Runnable () {
       @Override      
       public void run() {        
           ....      
        } 
};

public void startRepeatedReport(long periodInSeconds, long durationInSeconds) { 
    future.cancel(true); &#47;&#47;æ¯æ¬¡è°ƒç”¨å°±å–æ¶ˆä¸Šä¸€æ¬¡çš„è°ƒç”¨
    future = service.scheduleAtFixedRate(runnable, 0L, periodInSeconds, TimeUnit.SECONDS); &#47;&#47;é‡æ–°å¼€å§‹
}
```</p>2020-02-03</li><br/><li><span>ç©ºç™½æ˜µç§°</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å…³äºå¤§é‡æ•°æ®è¯»å–åˆ°å†…å­˜å¯¼è‡´æ€§èƒ½ä¸‹é™ç­‰é—®é¢˜ï¼Œåº”è¯¥å°±æ˜¯ç®—æ³•ä¹‹ç¾é‚£é‡Œè®²çš„å †æ’å§â€¦â€¦ ä¸¤ä¸ªè¯¾ç¨‹ä¸¾ä¾‹æœ‰ç›¸å…³æ€§ï¼Œç‚¹ä¸ªèµğŸ‘</p>2020-03-15</li><br/><li><span>é¥­ç²’</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¿™ä¸ªæ¡ˆä¾‹å¾ˆèµï¼Œè¦æ‰¾æ—¶é—´æ‰‹æ•²ä¸€éã€‚</p>2020-03-08</li><br/><li><span>å®ˆæ‹™</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¯¾å ‚è®¨è®º:



æ­£å¸¸æƒ…å†µä¸‹ï¼ŒConsoleReporter çš„ startRepeatedReport() å‡½æ•°åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚ä½†æ˜¯ï¼Œå¦‚æœè¢«å¤šæ¬¡è°ƒç”¨ï¼Œé‚£å°±ä¼šå­˜åœ¨é—®é¢˜ã€‚å…·ä½“ä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿåˆè¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ



startRepeatedReport()å¤šæ¬¡è°ƒç”¨ä¼šå¯¼è‡´SingleThreadExecutoræ’é˜Ÿæ‰§è¡Œä»»åŠ¡.  ä»æ€§èƒ½ä¸Š, æµªè´¹ç³»ç»Ÿèµ„æº, ä»éœ€æ±‚ä¸Š, ä¸ç¬¦åˆæ–¹æ³•è®¾è®¡çš„åˆè¡·. è§£å†³æ–¹æ¡ˆä¹‹ä¸€æ˜¯ä½¿ç”¨å…é”å®¹å™¨å­˜å‚¨å”¯ä¸€å€¼, ä½œä¸ºä»»åŠ¡å·²å¼€å§‹è°ƒåº¦çš„flag, åœ¨startRepeatedReport()æ–¹æ³•åˆ¤æ–­: å¦‚æœä»»åŠ¡å·²å¼€å§‹è°ƒåº¦, åˆ™ç›´æ¥return.</p>2020-02-04</li><br/><li><span>J.Smile</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ²™å‘ï¼Œæ‰“å¡ï¼ä¸€è·¯è·Ÿè¿›ï¼</p>2020-02-03</li><br/>
</ul>