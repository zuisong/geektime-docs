ä½ å¥½ï¼Œæˆ‘æ˜¯Mike, ä»Šå¤©æˆ‘ä»¬æ¥è®²ä¸€è®²å¦‚ä½•ç”¨Axumæ¡†æ¶è¿›è¡ŒWebæœåŠ¡å™¨åç«¯å¼€å‘ã€‚

å…³äºRustæ˜¯å¦é€‚åˆåšWebåç«¯å¼€å‘ï¼Œå¾ˆå¤šäººæŒæ€€ç–‘æ€åº¦ã€‚è®¤ä¸ºWebå¼€å‘è®²ç©¶çš„æ˜¯æ•æ·ï¼Œä¸€ç§åŠ¨æ€çš„ã€å¸¦è¿è¡Œæ—¶çš„ã€æ–¹ä¾¿ä¿®æ”¹çš„è¯­è¨€å¯èƒ½æ›´é€‚åˆWebå¼€å‘ã€‚

ä½†æœ‰ä¸€äº›å› ç´ ï¼Œå…¶å®å†³å®šäº†Rustéå¸¸é€‚åˆWebå¼€å‘ã€‚

1. æ—¶ä»£å˜åŒ–ï¼šèŠ¯ç‰‡æ‘©å°”å®šå¾‹å·²å¤±æ•ˆï¼ŒæœåŠ¡å™¨æˆæœ¬é€æ¸å æ®ç›¸å½“å¤§çš„æ¯”ä¾‹ï¼Œæ— è„‘å †æœåŠ¡å™¨çš„æ—¶ä»£å·²ç»è¿‡å»ã€‚å½“å‰é˜¶æ®µï¼Œå¯¹äºè§„æ¨¡ç¨å¾®å¤§ä¸€äº›çš„å…¬å¸æ¥è¯´ï¼Œé™æœ¬å¢æ•ˆæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ä»»åŠ¡ã€‚è€ŒRustçš„é«˜æ€§èƒ½å’Œç¨³å®šå¯é çš„è¡¨ç°éå¸¸é€‚åˆå¸®åŠ©å…¬å¸èŠ‚çœæœåŠ¡å™¨æˆæœ¬ã€‚
2. éšç€ä¸šåŠ¡çš„æˆå‹ï¼Œä¸€äº›æ ¸å¿ƒä¸šåŠ¡ä¼šè¶‹äºç¨³å®šï¼Œæ¨¡å‹å’Œæµç¨‹æŠ½è±¡å·²ç»åŸºæœ¬ä¸ä¼šæœ‰å¤§çš„æ”¹åŠ¨ã€‚è¿™æ—¶ï¼Œä½¿ç”¨Rusté‡å†™æˆ–éƒ¨åˆ†é‡å†™è¿™äº›ä¸šåŠ¡ï¼Œä¼šå¸¦æ¥æ›´å¼ºçš„æ€§èƒ½å’Œæ›´å¯é ç¨³å®šçš„æœåŠ¡è¡¨ç°ã€‚
3. Rustéå¸¸é€‚åˆç”¨æ¥åšä¸€äº›é€šç”¨çš„ä¸­é—´ä»¶æœåŠ¡ï¼Œç›®å‰å¼€æºç¤¾åŒºå·²ç»å‡ºç°äº†ä¸€äº›ç›¸å½“ä¼˜ç§€çš„ä¸­é—´ä»¶äº§å“ã€‚
4. Rustçš„è¡¨è¾¾èƒ½åŠ›å…¶å®éå¸¸å¼ºï¼Œå…¶å¼ºå¤§çš„ç±»å‹ç³»ç»Ÿå¯å¸®åŠ©å¼€å‘è€…è½»æ¾åœ°å¯¹é—®é¢˜è¿›è¡Œå»ºæ¨¡ã€‚ä¸€ä¸ªä¸­ç­‰ç†Ÿç»ƒçš„Rustå¼€å‘è€…åšåŸå‹çš„é€Ÿåº¦ä¸ä¼šæ¯”Pythonæ…¢å¤šå°‘ï¼Œåœ¨å¤æ‚é—®é¢˜åœºæ™¯ä¸‹ï¼Œç”šè‡³æ›´å¿«ã€‚
5. Rustçš„è¯­è¨€å±‚é¢çš„è®¾è®¡ä½¿å®ƒç‰¹åˆ«é€‚åˆåšé‡æ„ã€‚é‡æ„Rustå·¥ç¨‹ç‰¹åˆ«å¿«ï¼Œé‡æ„å®Œåï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒå‡ºé”™çš„é—®é¢˜ã€‚ç›¸å¯¹äºåŠ¨æ€è¯­è¨€ï¼Œå¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹éƒ½å¯ä»¥å°‘å‡†å¤‡å¾ˆå¤šã€‚

## Rust Web Backend ç”Ÿæ€

Rust Webåç«¯å¼€å‘ç”Ÿæ€ç›®å‰å¤„äºä¸€ç§æ¬£æ¬£å‘è£çš„å±€é¢ã€‚å°±Webå¼€å‘æ¡†æ¶æ¥è¯´ï¼Œèƒ½å«å¾—ä¸Šåå­—çš„å°±æœ‰åå‡ ç§ï¼Œå…¶ä¸­æŒ‰ [crates.io](https://crates.io) æœ€æ–°ä¸‹è½½é‡æ’åï¼Œæ’åˆ—é å‰çš„æ˜¯è¿™å‡ ä½ã€‚

1. Axum
2. Actix-web
3. Rocket
4. Poem
5. Rouille
6. Salvo

ä»æœ€è¿‘ä¸‹è½½çš„ç»å¯¹æ•°é‡æ¥è¯´ï¼ŒAxum çš„ä¸‹è½½é‡æ˜¯ç¬¬äºŒå Actix-web çš„ 3 å€å¤šã€‚å› æ­¤ï¼Œæˆ‘ä»¬é€‰æ‹©äº†ä¸‹è½½é‡æœ€å¤šçš„æ¡†æ¶â€”â€”Axumã€‚

### TokioæŠ€æœ¯æ ˆä»‹ç»

Axumæœ‰è¿™ä¹ˆå¼ºåŠ²çš„è¡¨ç°ï¼Œå¾—ç›Šäºå…¶æœ¬èº«ä¼˜ç§€çš„è®¾è®¡ï¼Œè¿˜æœ‰å®ƒæ— ç¼ä¾èµ–çš„ Tokio æŠ€æœ¯æ ˆã€‚Tokioä» 2017 å¹´å‘å¸ƒ 0.1 ç‰ˆæœ¬å¼€å§‹åˆ°ç°åœ¨ï¼Œå·²ç»å½¢æˆä¸€å¥—å¼ºå¤§çš„æŠ€æœ¯æ ˆã€‚

![](https://static001.geekbang.org/resource/image/e1/40/e1e84b20997c3a99540c7559e6dc5b40.jpg?wh=1414x1594)

è¿™äº›å¯é çš„å·¥å…·é“¾ï¼Œä¸ºRuståœ¨æœåŠ¡å™¨ç«¯çš„å‘å±•æ‰“ä¸‹äº†åšå®çš„åŸºç¡€ï¼Œè¶Šæ¥è¶Šå¤šçš„é¡¹ç›®å¼€å§‹é‡‡ç”¨è¿™ä¸€å¥—æŠ€æœ¯æ ˆã€‚

## Axumæ¡†æ¶

> Axumæ˜¯ä¸€ä¸ªä¸“æ³¨äºäººä½“å·¥ç¨‹å­¦å’Œæ¨¡å—åŒ–çš„Webå¼€å‘æ¡†æ¶ã€‚â€”â€”å®˜æ–¹æ–‡æ¡£çš„Slogan

ä»ä¸Šå±‚è§†è§’æ¥çœ‹ï¼ŒAxumå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

1. å†™Routerå’ŒHandlerçš„æ—¶å€™ï¼Œä¸éœ€è¦ä½¿ç”¨å®ï¼ˆéæ ‡æ³¨é£æ ¼ï¼‰ã€‚
2. ä½¿ç”¨è§£åŒ…å™¨è¿›è¡Œå£°æ˜å¼çš„è¯·æ±‚è§£æã€‚
3. ç®€å•å’Œå¯é¢„æµ‹çš„é”™è¯¯å¤„ç†æ¨¡å‹ã€‚
4. ç”Ÿæˆå“åº”æ—¶åªéœ€ç”¨åˆ°æœ€å°çš„æ ·æ¿ä»£ç ã€‚
5. å……åˆ†åˆ©ç”¨ tower å’Œ tower-http çš„ä¸­é—´ä»¶ã€æœåŠ¡å’Œå·¥å…·çš„ç”Ÿæ€ç³»ç»Ÿã€‚

ç‰¹åˆ«æ˜¯æœ€åä¸€ç‚¹ï¼Œè®©Axumæ˜¾è‘—ä¸åŒäºå…¶ä»–æ¡†æ¶ã€‚Axumè‡ªå·±ä¸å¸¦ä¸­é—´ä»¶ç³»ç»Ÿï¼Œè€Œæ˜¯ä½¿ç”¨ tower ç³»çš„ä¸­é—´ä»¶ã€‚è¿™æ ·å°±èƒ½å’Œç”Ÿæ€é‡Œçš„å…¶ä»–é¡¹ç›®ï¼Œå¦‚ hyper æˆ– tonic å…±äº«ä¸­é—´ä»¶ç³»ç»Ÿã€‚ è¿™ç§è®¾è®¡å¤ªæ£’äº†ã€‚

### Towerä¸­é—´å±‚æœåŠ¡

Toweræ˜¯ä¸€ä¸ªæ¨¡å—åŒ–ã€å¯é‡ç”¨çš„ç»„ä»¶ç³»ç»Ÿï¼Œç”¨äºæ„å»ºç¨³å¥çš„ç½‘ç»œæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åº”ç”¨ã€‚å®ƒå¯¹**è¯·æ±‚/å“åº”æ¨¡å‹**åšäº†ä¸€ä¸ªç»Ÿä¸€çš„æœåŠ¡æŠ½è±¡ï¼Œå’Œå…·ä½“çš„å®ç°åè®®æ— å…³ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹Serviceçš„å®šä¹‰ã€‚

```plain
async fn(Request) -> Result<Response, Error>
```

ToweråŒ…å« Service å’Œ Layer ä¸¤ä¸ªæŠ½è±¡ã€‚ä¸€ä¸ªServiceæ˜¯ä¸€ä¸ªæ¥å—è¯·æ±‚ï¼Œåšå‡ºå“åº”çš„å¼‚æ­¥å‡½æ•°ï¼›è€Œä¸€ä¸ª Layer æ¥å—ä¸€ä¸ªServiceï¼Œå¤„ç†å¹¶è¿”å›å¦ä¸€ä¸ªServiceã€‚Serviceå’ŒLayerä¸€èµ·ï¼Œå°±å¯ä»¥æ–¹ä¾¿åœ°æ„å»ºä¸­é—´ä»¶æœåŠ¡ã€‚è€Œå®Œå…¨åŸºäºæµï¼ˆstreamï¼‰çš„æœåŠ¡ï¼Œå¹¶ä¸é€‚åˆä½¿ç”¨Towerã€‚

### Tower-httpä»‹ç»

[Tower-http](https://docs.rs/tower-http/latest/tower_http/) æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºæä¾›HTTPç›¸å…³çš„ä¸­é—´ä»¶å’Œè®¾æ–½çš„åº“ï¼Œé‡Œé¢ç½—åˆ—äº†äºŒåå¤šä¸ªä¸­é—´ä»¶ã€‚

åœ¨Axumä¸­ï¼Œæœ€å¸¸ç”¨çš„ä¸­é—´ä»¶æ˜¯ä¸‹é¢è¿™å‡ ä¸ªã€‚

- TracyLayer ä¸­é—´ä»¶ï¼Œç”¨äºæä¾›é«˜å±‚æ—¥å¿—æˆ–è·Ÿè¸ªã€‚
- CorsLayer ä¸­é—´ä»¶ï¼Œç”¨äºå¤„ç†CORSã€‚
- CompressionLayer ä¸­é—´ä»¶ï¼Œç”¨äºè‡ªåŠ¨å‹ç¼©å“åº”ã€‚
- RequestIdLayer å’Œ PropagateRequestIdLayerÂ ä¸­é—´ä»¶ï¼Œç”¨äºè®¾ç½®å’Œä¼ æ’­è¯·æ±‚IDã€‚
- TimeoutLayer ä¸­é—´ä»¶ï¼Œç”¨äºè®¾ç½®è¶…æ—¶ã€‚
- HandleErrorLayer ä¸­é—´ä»¶ï¼Œç”¨äºè½¬æ¢å„ç§é”™è¯¯ç±»å‹åˆ°å“åº”ã€‚

è€Œæ¯ä¸ªä¸­é—´ä»¶éƒ½å¯ä»¥ç”¨åœ¨å…¨å±€Routerã€æ¨¡å—Routerå’ŒHandlerä¸‰ä¸ªå±‚æ¬¡ã€‚

### Router

Routerç”¨æ¥å®šä¹‰URLåˆ°handlerçš„æ˜ å°„ï¼Œå¹¶ç”¨æ¥æ„å»ºæ¨¡å—åŒ–URLçš„å±‚çº§ï¼Œæ—¢èƒ½æ”¯æŒå…¨å±€æ€§è·¯ç”±ï¼Œä¹Ÿèƒ½æ”¯æŒæ¨¡å—å±‚çº§çš„è·¯ç”±ã€‚æ¯”å¦‚ï¼š

```rust
let user_routes = Router::new().route("/:id", get(|| async {}));
let team_routes = Router::new().route("/", post(|| async {}));
let api_routes = Router::new()
    .nest("/users", user_routes)
    .nest("/teams", team_routes);
let app = Router::new().nest("/api", api_routes);
```

### Handler

åœ¨Axumé‡Œï¼ŒHandleræ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œè¿™ä¸ªå¼‚æ­¥å‡½æ•°æ¥å—ä¸€ä¸ªæˆ–å¤šä¸ªè§£åŒ…å™¨ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªå¯ä»¥è½¬æ¢ä¸ºå“åº”ï¼ˆimpl IntoResponseï¼‰çš„ç±»å‹ã€‚

æœ€ç®€å•çš„ handler ç±»ä¼¼ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š

```plain
async fn string_handler() -> String {
    "Hello, World!".to_string()
}
```

## ä½¿ç”¨Axumè¿›è¡ŒWebåç«¯å¼€å‘

ç°åœ¨è¯ä¸å¤šè¯´ï¼Œè®©æˆ‘ä»¬å¼€å§‹Axumå®æˆ˜ç¯èŠ‚å§ï¼

æ³¨ï¼šç›®å‰ï¼ˆ2023å¹´12æœˆï¼‰Axumçš„æœ€æ–°ç‰ˆæœ¬æ˜¯ v0.7 ç‰ˆï¼Œæˆ‘ä»¬ä¸‹é¢ä¼šåŸºäºè¿™ä¸ªç‰ˆæœ¬æ¥ç¼–å†™ä»£ç ã€‚

### ç¬¬ä¸€æ­¥ï¼šHello world

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹Axumçš„Hello Worldæ˜¯ä»€ä¹ˆæ ·å­ã€‚

```plain
use axum::{response::Html, routing::get, Router};

#[tokio::main]
async fn main() {
    // build our application with a route
    let app = Router::new().route("/", get(handler));

    // run it
    let listener = tokio::net::TcpListener::bind("127.0.0.1:3000")
        .await
        .unwrap();
    println!("listening on {}", listener.local_addr().unwrap());
    axum::serve(listener, app).await.unwrap();
}

async fn handler() -> Html<&'static str> {
    Html("<h1>Hello, World!</h1>")
}
```

è¿™é‡Œæˆ‘ç»™å‡ºè¿™ä¸ªæ­¥éª¤çš„[åŸå§‹ä»£ç åœ°å€](https://github.com/miketang84/jikeshijian/tree/master/2122-axumapp_stepbystep/axumapp01_helloworld)ï¼Œä½ å¯ä»¥ç›´æ¥ä¸‹è½½åˆ°æœ¬åœ°è¿è¡Œã€‚

ä»è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä¸€çª¥Axumåº”ç”¨çš„åŸºæœ¬ç»“æ„ã€‚é¦–å…ˆï¼Œä¸€ä¸ªAxumåº”ç”¨å…¶å®å°±æ˜¯ä¸€ä¸ªTokioåº”ç”¨ï¼Œä»¥æ ‡å¿—æ€§çš„tokio::mainå±æ€§å®å¼€å¤´ã€‚

```plain
#[tokio::main]
async fn main() {
```

ç„¶åï¼Œåˆ›å»ºä¸€ä¸ªRouterå®ä¾‹ï¼Œä»£è¡¨Appã€‚åœ¨Routerä¸­ï¼Œç»‘å®šURLä¸handlerã€‚

ç„¶åä½¿ç”¨ `tokio::net::TcpListener::bind()` ç›‘å¬æœåŠ¡å™¨åœ°å€ï¼Œå¹¶å°†ç”Ÿæˆçš„ listener ä¼ å…¥ `axum::serve()` ä¸­ä½¿ç”¨ï¼Œå¯åŠ¨axumæœåŠ¡ã€‚è€Œè¿™ä¸ªåº”ç”¨çš„ handler å‚æ•°é‡Œæ²¡æœ‰è§£åŒ…å™¨ï¼ˆextractorï¼‰ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬æš‚æ—¶ä¸è§£æè¯·æ±‚å‚æ•°ï¼Œæ‰€ä»¥å‚æ•°éƒ¨åˆ†ç•™ç©ºã€‚

```plain
async fn handler() -> Html<&'static str> {
    Html("<h1>Hello, World!</h1>")
}
```

ç„¶åï¼Œè¿™ä¸ªhandlerçš„è¿”å›å€¼æ˜¯ `Html<&'static str>` ç±»å‹ï¼Œå®ƒå·²ç»å®ç°äº† IntoResponseï¼Œæ‰€ä»¥å¯ä»¥ä½œä¸º Response è¿”å›ç±»å‹ã€‚ä¸‹é¢æˆ‘ä»¬æ¥æµ‹è¯•ï¼Œæ‰“å¼€ç»ˆç«¯åœ¨ä»£ç ç›®å½•ä¸‹æ‰§è¡Œ `cargo run`ã€‚ç»ˆç«¯ä¸‹è¾“å‡º `listening on 127.0.0.1:3000`ã€‚

æ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å…¥ `127.0.0.1:3000`ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢è¿™æ ·çš„é¡µé¢æ•ˆæœã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/d7/cb/d757695525f1fd973f4532bf7475fdcb.png?wh=1920x499)

### ç¬¬äºŒæ­¥ï¼šå®ç°é™æ€æ–‡ä»¶æœåŠ¡

é™æ€æ–‡ä»¶æœåŠ¡éå¸¸æœ‰ç”¨ï¼Œç”¨äºå¯¹æœåŠ¡å™¨ä¸Šçš„é™æ€èµ„æºå¦‚å›¾ç‰‡ã€HTMLã€JSã€CSSç­‰æ–‡ä»¶æä¾›æœåŠ¡ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨Axumå®ç°ä¸€ä¸ªç®€å•çš„é™æ€æ–‡ä»¶æœåŠ¡ã€‚æˆ‘ä»¬åªéœ€è¦å¼•å…¥ServeDiræœåŠ¡ï¼Œç„¶ååœ¨Routerå®ä¾‹ä¸Šä½¿ç”¨ nest\_service æŒ‚è½½è¿™ä¸ªæœåŠ¡å°±å¯ä»¥äº†ã€‚

```rust
Â  Â  Router::new().nest_service("/assets", ServeDir::new("assets"))
```

`ServeDir::new()` çš„å‚æ•°æ˜¯èµ„æºç›®å½•çš„è·¯å¾„ï¼Œä¸Šé¢ä¸€å¥è¡¨ç¤ºæŠŠ `/assets/*` çš„URLæ˜ å°„åˆ° assets ç›®å½•ä¸‹çš„å“ªäº›æ–‡ä»¶ã€‚

è€Œå¦‚æœéœ€è¦é…ç½®è·å–é»˜è®¤æ–‡ä»¶ï¼Œå¯ä»¥æŒ‰ç…§ä¸‹é¢è¿™æ ·ï¼Œåœ¨ServeDiré‡Œé…ç½®not\_found\_serviceï¼Œä¼ ä¸€ä¸ªServeFileå®ä¾‹è¿›å»ï¼Œè¿™ä¸ªServeFileå®ä¾‹å°±æ˜¯é»˜è®¤è·å–çš„é‚£ä¸ªæ–‡ä»¶ã€‚ç„¶ååœ¨Routerå®ä¾‹é…ç½®æ—¶ï¼Œæ·»åŠ ä¸€ä¸ª fallback\_service æŒ‚è½½ serve\_dirã€‚

```rust
let serve_dir =
    ServeDir::new("assets2")
    .not_found_service(ServeFile::new("assets2/index.html"));
let app = Router::new()
    .route("/foo", get(handler))
    .nest_service("/assets", ServeDir::new("assets"))
    .nest_service("/assets2", serve_dir.clone())
    .fallback_service(serve_dir);
```

ä¸Šè¿°ç¤ºä¾‹é‡Œï¼Œå³ä½¿æˆ‘ä»¬è®¿é—®ä¸€äº›ä¸å­˜åœ¨çš„URLåœ°å€ï¼ŒæœåŠ¡å™¨ä¹Ÿä¼šè¿”å›assets2ç›®å½•ä¸‹çš„index.htmlæ–‡ä»¶ã€‚è¿™é€šå¸¸æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚ä½ å¯ä»¥æ ¹æ®[ç¤ºä¾‹æºç ](https://github.com/miketang84/jikeshijian/tree/master/2122-axumapp_stepbystep/axumapp02_staticfile)è‡ªè¡Œæµ‹è¯•ï¼ŒæŸ¥çœ‹æ•ˆæœã€‚

ä½ å¯ä»¥å°è¯•å¦‚ä¸‹URLåœ°å€ï¼š

```
http://127.0.0.1:3000/
http://127.0.0.1:3000/foo
http://127.0.0.1:3000/bar
http://127.0.0.1:3000/assets/index.html
http://127.0.0.1:3000/assets/ferris.png
http://127.0.0.1:3000/assets/script.js
http://127.0.0.1:3000/assets2/index.html
http://127.0.0.1:3000/assets2/ferris2.png
http://127.0.0.1:3000/assets2/script.js
...
```

### ç¬¬ä¸‰æ­¥ï¼šåŠ å…¥æ—¥å¿—è®°å½•

æ—¥å¿—ç³»ç»Ÿæ˜¯ä¸€ä¸ªæœåŠ¡å¿…ä¸å¯å°‘çš„ç»„ä»¶ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹å¦‚ä½•ä¸ºAxumåº”ç”¨æ·»åŠ æ—¥å¿—ã€‚åœ¨Axumä¸­æ·»åŠ æ—¥å¿—å¾ˆç®€å•ã€‚ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ  tracing å’Œ tracing-subscriber ä¸¤ä¸ªcratesã€‚

```rust
cargo add tracing
cargo add tracing-subscriber
```

ç„¶åå¼•å…¥TraceLayerã€‚

```rust
use tower_http::trace::TraceLayer;
```

åœ¨mainå‡½æ•°çš„å¼€å¤´æ·»åŠ ä»£ç ï¼š

```rust
Â  Â  tracing_subscriber::fmt::init();
```

å†åœ¨Routeré…ç½®çš„æ—¶å€™ï¼Œæ·»åŠ ä¸‹é¢è¿™è¡Œä»£ç é…ç½®æ—¥å¿—ä¸­é—´ä»¶æœåŠ¡å°±å¯ä»¥äº†ã€‚

```rust
let app = Router::new()
    .route("/foo", get(handler))
    .nest_service("/assets", serve_dir.clone())
    .fallback_service(serve_dir)
    .layer(TraceLayer::new_for_http());  // æ·»åŠ è¿™è¡Œ
```

ä½¿ç”¨æ—¶ï¼Œéœ€è¦æŒ‰ç…§ä¸‹é¢è¿™ä¸ªæ–¹å¼æ¥ä½¿ç”¨ã€‚

```rust
tracing::debug!("listening on {}", addr);
```

æˆ‘ä»¬ç”¨ä¸Šé¢ä¸€å¥æ›¿ä»£äº†ä¹‹å‰çš„ `println!`ï¼Œåœ¨ä¸€ä¸ªæ­£ç»ä¸€ç‚¹çš„åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬éƒ½ä¸ä¼šä½¿ç”¨ `println!` å»æ‰“å°æ—¥å¿—çš„ã€‚

è¿™é‡Œéœ€è¦è¡¥å……ä¸€ç‚¹çŸ¥è¯†ï¼šRustä¸­çš„æ—¥å¿—æ ‡å‡†ã€‚Rustæ ‡å‡†çš„logåè®®åœ¨[é“¾æ¥](https://docs.rs/log/latest/log/)é‡Œã€‚è¿™ä¸ªcrateä¸­å®šä¹‰äº†5ä¸ªçº§åˆ«çš„æ—¥å¿—æ‰“å°è¯­å¥ã€‚

- `error!`
- `warn!`
- `info!`
- `debug!`
- `trace!`

è¿™5ä¸ªçº§åˆ«ä»ä¸Šåˆ°ä¸‹è­¦ç¤ºç¨‹åº¦ä¸ºç”±é«˜åˆ°ä½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¶Šå¾€ä¸‹ä¼šè¶Šè¯¦ç»†ã€‚

ä½†æ˜¯è¿™åªæ˜¯ä¸€å¥—åè®®çš„å®šä¹‰ï¼Œè€Œä¸æ˜¯å…·ä½“å®ç°ã€‚å…·ä½“ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦ç”¨å¦å¤–çš„crateæ¥å®ç°ã€‚æˆ‘ä»¬å¸¸ç”¨çš„ env\_logger å°±æ˜¯å…¶ä¸­ä¸€ç§å®ç°ï¼Œå®ƒæŠŠæ—¥å¿—è¾“å‡ºåˆ°æ ‡å‡†ç»ˆç«¯é‡Œï¼Œç”¨ç¯å¢ƒå˜é‡æ¥æ§åˆ¶æ‰“å°çš„çº§åˆ«å¼€å…³ã€‚è€Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„ tracing åº“ä¹Ÿæ˜¯è¿™æ ·ä¸€ç§å®ç°ã€‚å®ƒæ˜¯ä¸ºtokioå¼‚æ­¥è¿è¡Œæ—¶ä¸“é—¨è®¾è®¡çš„ï¼Œé€‚åˆåœ¨å¼‚æ­¥å¹¶å‘ä»£ç ä¸­ä½¿ç”¨ã€‚

ä½ å¯ä»¥ä½¿ç”¨RUST\_LOGæ¥æ‰“å¼€æ—¥å¿—å¼€å…³ã€‚æ¯”å¦‚ï¼š

```rust
RUST_LOG=trace cargo run
```

è®¿é—® [http://127.0.0.1:3000/foo](http://127.0.0.1:3000/foo) ï¼Œå¯ä»¥çœ‹åˆ°ï¼ŒTRACEçº§åˆ«çš„å’ŒDEBUGçº§åˆ«çš„æ—¥å¿—éƒ½æ‰“å°å‡ºæ¥äº†ã€‚

```rust
2023-12-11T05:36:39.240674Z TRACE mio::poll: registering event source with poller: token=Token(0), interests=READABLE | WRITABLE
2023-12-11T05:36:39.240718Z DEBUG axumapp03: listening on 127.0.0.1:3000
2023-12-11T05:36:50.029388Z TRACE mio::poll: registering event source with poller: token=Token(1), interests=READABLE | WRITABLE
2023-12-11T05:36:50.029678Z TRACE mio::poll: registering event source with poller: token=Token(2), interests=READABLE | WRITABLE
2023-12-11T05:36:50.030011Z DEBUG request{method=GET uri=/foo version=HTTP/1.1}: tower_http::trace::on_request: started processing request
2023-12-11T05:36:50.030127Z DEBUG request{method=GET uri=/foo version=HTTP/1.1}: tower_http::trace::on_response: finished processing request
 latency=0 ms status=200
```

ç”¨debugæ¨¡å¼æ—¥å¿—ä¼šå°‘ä¸€äº›ã€‚

```rust
RUST_LOG=debug cargo run
```

è®¿é—® [http://127.0.0.1:3000/foo](http://127.0.0.1:3000/foo) ï¼Œ è¾“å‡ºï¼š

```rust
2023-12-11T05:43:45.223551Z DEBUG axumapp03: listening on 127.0.0.1:3000
2023-12-11T05:43:50.558174Z DEBUG request{method=GET uri=/foo version=HTTP/1.1}: tower_http::trace::on_request: started processing request
2023-12-11T05:43:50.558303Z DEBUG request{method=GET uri=/foo version=HTTP/1.1}: tower_http::trace::on_response: finished processing request
 latency=0 ms status=200
```

æˆ‘ä»¬è¿˜å¯ä»¥æŒ‡å®šåªæ‰“å°æŸäº›crateé‡Œçš„æ—¥å¿—ã€‚

```rust
RUST_LOG=tower_http=debug,axumapp03=debug cargo run
```

è®¿é—® [http://127.0.0.1:3000/foo](http://127.0.0.1:3000/foo) ï¼Œè¾“å‡ºï¼š

```rust
2023-12-11T05:45:03.578294Z DEBUG axumapp03: listening on 127.0.0.1:3000
2023-12-11T05:45:08.036568Z DEBUG request{method=GET uri=/foo version=HTTP/1.1}: tower_http::trace::on_request: started processing request
2023-12-11T05:45:08.036696Z DEBUG request{method=GET uri=/foo version=HTTP/1.1}: tower_http::trace::on_response: finished processing request
 latency=0 ms status=200
```

ä½ å¯ä»¥ä¸‹è½½[æºç ](https://github.com/miketang84/jikeshijian/tree/master/2122-axumapp_stepbystep/axumapp03_addlog)è‡ªè¡Œæµ‹è¯•æŸ¥çœ‹æ•ˆæœã€‚

### ç¬¬å››æ­¥ï¼šè§£æ Get è¯·æ±‚å‚æ•°

ä¸€èˆ¬ä¸€ä¸ªURLæ˜¯è¿™æ ·çš„ï¼š

```
https://rustcc.cn/article?id=8ba98036-e2fb-41cf-9dad-7cd874c397c4
```

æœ€åé¢ä¸€æ®µæ˜¯ queryï¼Œquery çš„æ ¼å¼ä¸ºé”®å€¼å¯¹åˆ—è¡¨ï¼Œæ¯”å¦‚ `x1=yyy&x2=zzz` ï¼Œé”®å€¼å¯¹ä¹‹é—´ä½¿ç”¨ &amp; ç¬¦å·éš”å¼€ã€‚

Axumé‡‡ç”¨ä¸€ç§è§£åŒ…å™¨ï¼ˆextractorï¼‰çš„æ–¹å¼ï¼Œç›´æ¥ä»HTTP Requesté‡Œæå–å‡ºå¼€å‘è€…å…³å¿ƒçš„å‚æ•°ä¿¡æ¯ã€‚è¿™ç§è®¾è®¡æœ‰ä¸€äº›å¥½å¤„ï¼š

1. å‡å°‘æ ·æ¿é‡å¤ä»£ç ï¼Œå¯ä»¥è®©ä»£ç æ›´ç´§å‡‘æ˜“è¯»ã€‚
2. ç±»å‹åŒ–ï¼Œå……åˆ†åˆ©ç”¨Rustå¼ºå¤§çš„ç±»å‹èƒ½åŠ›ã€‚
3. é…ç½®å¼å¼€å‘ï¼Œè½»æ¾æƒ¬æ„ã€‚

ä¸‹é¢æˆ‘ä»¬å…ˆæ¥çœ‹å¦‚ä½•ä»GETè¯·æ±‚çš„URLä¸­ï¼Œå–å‡ºQueryå‚æ•°ã€‚

åœ¨ Axumä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨Handlerä¸­è¿™æ ·é…ç½®è§£åŒ…å™¨å°±å¯ä»¥ã€‚

```plain
#[derive(Debug, Deserialize)]
struct InputParams {
Â  Â  foo: i32,
Â  Â  bar: String,
Â  Â  third: Option<i32>,
}

async fn query(Query(params): Query<InputParams>) -> impl IntoResponse {
Â  Â  tracing::debug!("query params {:?}", params);
Â  Â  Html("<h3>Test query</h3>")
}
```

è¿™é‡Œè¿™ä¸ª params å‚æ•°å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„queryè¯·æ±‚å‚æ•°ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒAxumæ¡†æ¶è‡ªåŠ¨å¸®æˆ‘ä»¬å¤„ç†äº†è§£æå·¥ä½œï¼Œè®©æˆ‘ä»¬ç›´æ¥å¾—åˆ°äº†Rust ç»“æ„ä½“å¯¹è±¡ã€‚å‡è½»äº†æˆ‘ä»¬å¤„ç†å…·ä½“åè®®çš„ç¹çåº¦ï¼Œä¸æ˜“å‡ºé”™ã€‚è¯·æ³¨æ„ç¤ºä¾‹ç¬¬8è¡Œçš„å‚æ•°ä¸­ä½¿ç”¨äº†æ¨¡å¼åŒ¹é…ï¼Œä½ å¯ä»¥å›é¡¾ä¸€ä¸‹[ç¬¬ 6 è®²](https://time.geekbang.org/column/article/720999)çš„æ¨¡å¼åŒ¹é…ç›¸å…³çŸ¥è¯†ç‚¹ã€‚

æˆ‘ä»¬å¯ä»¥ç»§ç»­æŠ˜è…¾ä¸€ä¸‹ï¼ŒInputParamsé‡Œå®šä¹‰äº†ä¸€ä¸ªthirdå­—æ®µï¼Œå®ƒæ˜¯ `Option<i32>` ç±»å‹ï¼Œè¯·ä½ å°è¯•åœ¨æµè§ˆå™¨URLåœ°å€æ æˆ–æ’ä»¶ä¸­å˜æ¢è¯·æ±‚å‚æ•°ï¼ŒæŸ¥çœ‹åŠæ—¥å¿—è¾“å‡ºè¿”å›æƒ…å†µã€‚å¯èƒ½çš„å‚æ•°ç»„åˆæœ‰ä¸‹é¢è¿™å‡ ç§ã€‚

```
http://127.0.0.1:3000/query?foo=1&bar=2&third=3
http://127.0.0.1:3000/query?foo=1&bar=2
http://127.0.0.1:3000/query?foo=1
http://127.0.0.1:3000/query?bar=2
http://127.0.0.1:3000/query?foo=1&bar=2&third=3&another=4
```

æœ¬ç¤ºä¾‹å®Œæ•´ä»£ç åœ¨[è¿™é‡Œ](https://github.com/miketang84/jikeshijian/tree/master/2122-axumapp_stepbystep/axumapp04_query)ã€‚

## å°ç»“

é€šè¿‡è¿™èŠ‚è¯¾çš„å±•ç¤ºï¼Œä½ æœ‰æ²¡æœ‰ä½“ä¼šåˆ°ä½¿ç”¨Rustè¿›è¡ŒWebå¼€å‘çš„æ„Ÿè§‰ï¼Ÿå…¶å®è·Ÿé‚£äº›åŠ¨æ€è¯­è¨€å¦‚Pythonã€JavaScriptç­‰å¼€å‘Webæ²¡å¤ªå¤§åŒºåˆ«ï¼ŒAxumçš„ä»£ç ä¹Ÿæ˜¯æ¯”è¾ƒç²¾ç»ƒçš„ã€‚è¯·ä½ ä¸€å®šè¦å‚è€ƒæˆ‘ç»™å‡ºçš„ä»£ç ç¤ºä¾‹ï¼Œå¯¹ç…§æºä»£ç åœ¨ä½ çš„æœ¬åœ°è·‘èµ·æ¥ã€‚Webå¼€å‘ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„åœ°æ–¹å°±æ˜¯æ–¹ä¾¿æµ‹è¯•ï¼Œæ˜“äºçœ‹åˆ°æ¸è¿›çš„æ•ˆæœæ­£åé¦ˆï¼Œæ‰€ä»¥åŠ¨æ‰‹æ˜¯éå¸¸é‡è¦è€Œä¸”é«˜æ•ˆçš„ã€‚

ç›¸æ¯”äºåŠ¨æ€è¯­è¨€æ¥è®²ï¼ŒRustçš„å¼ºç±»å‹æ›´åŠ èƒ½å¤Ÿä¿è¯Webåç«¯æœåŠ¡çš„æ­£ç¡®æ€§å’Œå¯é æ€§ã€‚æ€§èƒ½è‡ªä¸ç”¨è¯´ï¼Œä½ é€‰æ‹©äº†Rustï¼Œå°±æ˜¯é€‰æ‹©äº†é«˜èµ·ç‚¹ã€‚

åŒæ—¶ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¿™èŠ‚è¯¾å‡ºç°çš„Axumç¤ºä¾‹ä»£ç ï¼Œä¸€ç‚¹éƒ½ä¸å¤æ‚ï¼Œç”šè‡³éƒ½æ²¡æœ‰ç”¨åˆ°Rustçš„æ‰€è°“å„ç§é«˜çº§ç‰¹æ€§ã€‚å…¶å®å°±æ˜¯è¿™æ ·ï¼Œä½ ç”¨Ruståšæ—¥å¸¸å¼€å‘ï¼Œç‰¹åˆ«æ˜¯ä¸šåŠ¡å¼€å‘ï¼Œæ ¹æœ¬ä¸éš¾ï¼Œä¸è¦è¢«é‚£äº›æ‰€è°“çš„é«˜çº§ç‰¹æ€§å“åˆ°ï¼Œå…ˆç”¨ç°æˆçš„æ¡†æ¶ï¼Œå¿«é€Ÿæ£é¼“å‡ºè‡ªå·±çš„ä¸œè¥¿ï¼Œåé¢å†æ…¢æ…¢ä¸Šéš¾åº¦å°±å¥½äº†ã€‚

## æ€è€ƒé¢˜

è¯·ä½ è¯´ä¸€è¯´Request/Response æ¨¡å‹æ˜¯ä»€ä¹ˆï¼ŒAxumæ¡†æ¶å’Œå…¶ä»–gRPCæ¡†æ¶ï¼ˆæ¯”å¦‚Tonicï¼‰æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚æ¬¢è¿ä½ æŠŠè‡ªå·±çš„æ€è€ƒåˆ†äº«åˆ°è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ14ï¼‰</strong></div><ul>
<li><span>å°è™å­11ğŸ¯</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç‰ˆæœ¬å·²ç»æ›´æ–°åˆ° 0.7 å•¦</p>2023-12-11</li><br/><li><span>é¸ æ‘©æ™º</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>windows powershellä¸­çš„å¯åŠ¨å‘½ä»¤ï¼š$env:RUST_LOG=&quot;debug&quot; ; cargo run ã€‚ä¸è®¾ç½®çº§åˆ«çš„è¯ï¼Œé»˜è®¤çœ‹ä¸åˆ°debugçº§åˆ«çš„æ—¥å¿—</p>2023-12-11</li><br/><li><span>tan</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ—¶åŒºè®¾ç½®
â— cargo add time --features macros
â— cargo add tracing-subscriber --features time

```rust
use time::macros::{format_description, offset};
use tracing_subscriber::fmt::time::OffsetTime;

let time_fmt = format_description!(&quot;[year]-[month]-[day]T[hour]:[minute]:[second].[subsecond digits:3]&quot;);
let timer = OffsetTime::new(offset!(+8), time_fmt);


&#47;&#47; init 
tracing_subscriber::fmt().with_max_level(Level::TRACE).with_timer(timer).init();


&#47;&#47; use
tracing::info!(&quot;listening on {}&quot;, listener.local_addr().unwrap());
```
</p>2024-01-11</li><br/><li><span>ä¸€åª</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç¬¬ä¸€ä¸ªä¾‹å­ hello-world éœ€è¦ä½¿ç”¨é“¾æ¥ä¸­çš„ä¾èµ–ç‰ˆæœ¬æ‰èƒ½è¿è¡Œï¼Œåº”è¯¥æ˜¯åº“çš„æ¥å£å‘ç”Ÿå˜æ›´äº†ã€‚
æˆ–è€…ä½¿ç”¨ å®˜æ–¹æœ€æ–°ä¾‹å­
```rust
use axum::{response::Html, routing::get, Router};

#[tokio::main]
async fn main() {
    &#47;&#47; build our application with a route
    let app = Router::new().route(&quot;&#47;&quot;, get(handler));

    &#47;&#47; run it
    let listener = tokio::net::TcpListener::bind(&quot;127.0.0.1:3000&quot;)
        .await
        .unwrap();
    println!(&quot;listening on {}&quot;, listener.local_addr().unwrap());
    axum::serve(listener, app).await.unwrap();
}

async fn handler() -&gt; Html&lt;&amp;&#39;static str&gt; {
    Html(&quot;&lt;h1&gt;Hello, World!&lt;&#47;h1&gt;&quot;)
}
```</p>2023-12-11</li><br/><li><span>buoge</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ—¥å¿—éƒ¨åˆ†é…åˆè¿™ä¸ªçœ‹ä¼šæ›´ä½³
ä½¿ç”¨ tracing è®°å½•æ—¥å¿—ï¼šhttps:&#47;&#47;course.rs&#47;logs&#47;tracing.html</p>2023-12-20</li><br/><li><span>åœŸåœŸäºº</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>Axum ctrl cé€€å‡ºä¸ºå•¥ä¼šæŠ¥é”™ï¼Ÿè¿˜æœ‰å¯åŠ¨çº¿ç¨‹ä¸ä¼šæŒ‰æ ¸æ•°è‡ªåŠ¨åˆ†é…å—ï¼Ÿ</p>2024-02-28</li><br/><li><span>Geek_e72251</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>tracingè¾“å‡ºçš„æ—¥å¿—æ—¶åŒºä¸å¯¹ï¼Œæ€ä¹ˆè®¾ç½®æ—¶åŒºå•Šï¼Ÿ</p>2023-12-16</li><br/><li><span>Carlsama</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å†…å®¹å·²ç»è°ƒæ•´åˆ°0.7äº†å—ï¼Ÿçœ‹äº†è¯„è®ºæœ‰ç‚¹ä¸æ•¢è·Ÿç€æŠ„å†™ä»£ç ï¼Œç­‰éƒ½æ›´å®Œå†ä¸€å—çœ‹</p>2023-12-12</li><br/><li><span>My dream</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ€ä¹ˆç”¨è¿™ä¸ªæ¡†æ¶å®ç°è¯»å–ã€å¯¼å‡ºxlsæˆ–è€…pdfæ–‡ä»¶å•Šï¼Ÿ</p>2023-12-12</li><br/><li><span>é›å’Œ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œæ–‡ä¸­è¯´çš„evn_loggeræ˜¯ä¸æ˜¯ç¬”è¯¯äº†å‘¢ï¼Ÿå®é™…æ˜¯env_loggerï¼Ÿ</p>2023-12-11</li><br/><li><span>-</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>å’‹æ²¡æœ‰ç”¨æœ€æ–°ç‰ˆçš„0.7ç‰ˆæœ¬å•Šï¼Ÿ</p>2023-12-11</li><br/><li><span>åˆ˜ä¸¹</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é”™åˆ«å­—ï¼š 
carge add tracing-subscriber
</p>2023-12-11</li><br/><li><span>åˆ˜ä¸¹</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è€å¸ˆï¼Œè¯·é—®èƒ½å¦ä»‹ç»æœ€æ–°ç‰ˆæœ¬çš„ axum ?</p>2023-12-11</li><br/><li><span>å®‰çŸ³</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å¹¶å‘æ€§èƒ½å¥½åƒæ²¡æœ‰nodeçš„å¥½ã€‚ã€‚ã€‚ã€‚</p>2024-06-26</li><br/>
</ul>