ä½ å¥½ï¼Œæˆ‘æ˜¯Tony Baiã€‚

åœ¨ä¸Šä¸€è®²ä¸­ï¼Œæˆ‘ä»¬åˆæ­¥å®ç°äº†ä¸€ä¸ªåŸºäºTCPçš„è‡ªå®šä¹‰åº”ç”¨å±‚åè®®çš„é€šä¿¡æœåŠ¡ç«¯ã€‚å¯¹äºä¸€ä¸ªå¸¸é©»å†…å­˜çš„æœåŠ¡ç«¯è€Œè¨€ï¼Œæ›´é«˜çš„æ€§èƒ½ä»¥åŠæ›´ä½çš„èµ„æºæ¶ˆè€—ï¼Œå§‹ç»ˆæ˜¯åç«¯å¼€å‘äººå‘˜çš„è¿½æ±‚ã€‚åŒæ—¶ï¼Œæ›´é«˜æ€§èƒ½çš„æœåŠ¡ç¨‹åºï¼Œä¹Ÿæ„å‘³ç€åœ¨å¤„ç†ç›¸åŒæ•°é‡è®¿é—®è¯·æ±‚çš„å‰æä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æœºå™¨æ•°é‡æ›´å°‘ï¼Œè¿™å¯æ˜¯ä¸ºå…¬å¸èŠ‚çœçœŸé‡‘ç™½é“¶çš„æœ‰æ•ˆç­–ç•¥ã€‚

è€Œä¸”ï¼ŒGoè¯­è¨€æœ€åˆè®¾è®¡æ—¶å°±è¢«å®šä½ä¸ºâ€œç³»ç»Ÿçº§ç¼–ç¨‹è¯­è¨€â€ï¼Œè¿™è¯´æ˜é«˜æ€§èƒ½ä¹Ÿä¸€ç›´æ˜¯Goæ ¸å¿ƒå›¢é˜Ÿçš„ç›®æ ‡ä¹‹ä¸€ã€‚å¾ˆå¤šæ¥è‡ªåŠ¨æ€ç±»å‹è¯­è¨€çš„å¼€å‘è€…è½¬åˆ°Goè¯­è¨€ï¼Œå‡ ä¹éƒ½æœ‰ç€æ€§èƒ½æ–¹é¢çš„è€ƒé‡ã€‚

æ‰€ä»¥ï¼Œåœ¨å®æˆ˜ç¯‡çš„æœ€åä¸€è®²ï¼Œæˆ‘ä»¬å°±ç»“åˆä¸Šä¸€è®²å®ç°çš„è‡ªå®šä¹‰åº”ç”¨å±‚åè®®çš„é€šä¿¡æœåŠ¡ç«¯ï¼Œçœ‹çœ‹ä¼˜åŒ–Goç¨‹åºä½¿ç”¨çš„å¸¸ç”¨å·¥å…·ä¸å¥—è·¯ï¼Œç»™ä½ å¼•å¼•è·¯ã€‚

## Goç¨‹åºä¼˜åŒ–çš„åŸºæœ¬å¥—è·¯

Goç¨‹åºçš„ä¼˜åŒ–ï¼Œä¹Ÿæœ‰ç€å›ºå®šçš„å¥—è·¯å¯å¾ªï¼Œè¿™é‡Œæˆ‘å°†å®ƒæ•´ç†æˆäº†è¿™å¼ ç¤ºæ„å›¾ï¼š

![](https://static001.geekbang.org/resource/image/76/ce/767f360c71dece48b9c68dc46053yyce.jpg?wh=1980x1080)

è¿™å¼ å›¾ä¹Ÿä¸éš¾ç†è§£ï¼Œæˆ‘ç®€å•è§£é‡Šä¸€ä¸‹ã€‚

**é¦–å…ˆæˆ‘ä»¬è¦å»ºç«‹æ€§èƒ½åŸºå‡†ã€‚**è¦æƒ³å¯¹ç¨‹åºå®æ–½ä¼˜åŒ–ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æœ‰ä¸€ä¸ªåˆå§‹â€œå‚ç…§ç‰©â€ï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½åœ¨æ‰§è¡Œä¼˜åŒ–æªæ–½åï¼Œæ£€éªŒä¼˜åŒ–æªæ–½æ˜¯å¦æœ‰æ•ˆï¼Œæ‰€ä»¥è¿™æ˜¯ä¼˜åŒ–å¾ªç¯çš„ç¬¬ä¸€æ­¥ã€‚

**ç¬¬äºŒæ­¥æ˜¯æ€§èƒ½å‰–æã€‚**è¦æƒ³ä¼˜åŒ–ç¨‹åºï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ‰¾åˆ°å¯èƒ½å½±å“ç¨‹åºæ€§èƒ½çš„â€œç“¶é¢ˆç‚¹â€ï¼Œè¿™ä¸€æ­¥çš„ä»»åŠ¡ï¼Œå°±æ˜¯é€šè¿‡å„ç§å·¥å…·å’Œæ–¹æ³•æ‰¾åˆ°è¿™äº›â€œç“¶é¢ˆç‚¹â€ã€‚

**ç¬¬ä¸‰æ­¥æ˜¯ä»£ç ä¼˜åŒ–ã€‚**æˆ‘ä»¬è¦é’ˆå¯¹ä¸Šä¸€æ­¥æ‰¾åˆ°çš„â€œç“¶é¢ˆç‚¹â€è¿›è¡Œåˆ†æï¼Œæ‰¾å‡ºå®ƒä»¬æˆä¸ºç“¶é¢ˆçš„åŸå› ï¼Œå¹¶æœ‰é’ˆå¯¹æ€§åœ°å®æ–½ä¼˜åŒ–ã€‚

**ç¬¬å››æ­¥æ˜¯ä¸åŸºå‡†æ¯”è¾ƒï¼Œç¡®å®šä¼˜åŒ–æ•ˆæœã€‚**è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬ä¼šé‡‡é›†ä¼˜åŒ–åçš„ç¨‹åºçš„æ€§èƒ½æ•°æ®ï¼Œä¸ç¬¬ä¸€æ­¥çš„æ€§èƒ½åŸºå‡†è¿›è¡Œæ¯”è¾ƒï¼Œçœ‹æ‰§è¡Œä¸Šè¿°çš„ä¼˜åŒ–æªæ–½åï¼Œæ˜¯å¦æå‡äº†ç¨‹åºçš„æ€§èƒ½ã€‚

å¦‚æœæœ‰æå‡ï¼Œé‚£å°±è¯´æ˜è¿™ä¸€è½®çš„ä¼˜åŒ–æ˜¯æœ‰æ•ˆçš„ã€‚å¦‚æœä¼˜åŒ–åçš„æ€§èƒ½æŒ‡æ ‡ä»ç„¶æ²¡æœ‰è¾¾åˆ°é¢„æœŸï¼Œå¯ä»¥å†æ‰§è¡Œä¸€è½®ä¼˜åŒ–ï¼Œè¿™æ—¶æˆ‘ä»¬å°±è¦ç”¨æ–°çš„ç¨‹åºçš„æ€§èƒ½æŒ‡æ ‡ä½œä¸ºæ–°çš„æ€§èƒ½åŸºå‡†ï¼Œä½œä¸ºä¸‹ä¸€è½®æ€§èƒ½ä¼˜åŒ–å‚è€ƒã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±å›´ç»•è¿™ä¸ªä¼˜åŒ–å¾ªç¯ï¼Œçœ‹çœ‹æ€ä¹ˆå¯¹æˆ‘ä»¬ä¸Šä¸€è®²å®ç°çš„è‡ªå®šä¹‰åº”ç”¨å±‚åè®®çš„é€šä¿¡æœåŠ¡ç«¯è¿›è¡Œä¼˜åŒ–ã€‚é¦–å…ˆæˆ‘ä»¬è¦åšçš„æ˜¯**å»ºç«‹æ€§èƒ½åŸºå‡†**ï¼Œè¿™æ˜¯Goåº”ç”¨æ€§èƒ½ä¼˜åŒ–çš„åŸºç¡€ä¸å‰æã€‚

## å»ºç«‹æ€§èƒ½åŸºå‡†

ä¸Šä¸€è®²ï¼Œæˆ‘ä»¬å·²ç»åˆæ­¥å®ç°äº†è‡ªå®šä¹‰åº”ç”¨å±‚åè®®çš„é€šä¿¡æœåŠ¡ç«¯ï¼Œé‚£å®ƒçš„æ€§èƒ½å¦‚ä½•å‘¢ï¼Ÿ

æˆ‘ä»¬è‚¯å®šä¸èƒ½æ‹è„‘é—¨è¯´è¿™ä¸ªç¨‹åºæ€§èƒ½å¾ˆå¥½ã€ä¸€èˆ¬æˆ–å¾ˆå·®å§ï¼Ÿæˆ‘ä»¬éœ€è¦**ç”¨æ•°æ®è¯´è¯**ï¼Œä¹Ÿå°±æ˜¯ä¸ºæˆ‘ä»¬çš„Goç¨‹åºå»ºç«‹æ€§èƒ½åŸºå‡†ã€‚é€šè¿‡è¿™ä¸ªæ€§èƒ½åŸºå‡†ï¼Œæˆ‘ä»¬ä¸ä»…å¯ä»¥äº†è§£å½“å‰ç¨‹åºçš„æ€§èƒ½æ°´å¹³ï¼Œä¹Ÿå¯ä»¥æ®æ­¤åˆ¤æ–­åé¢çš„ä»£ç ä¼˜åŒ–æªæ–½æœ‰æ²¡æœ‰èµ·åˆ°æ•ˆæœã€‚

å»ºç«‹æ€§èƒ½åŸºå‡†çš„æ–¹å¼å¤§æ¦‚æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯é€šè¿‡**ç¼–å†™GoåŸç”Ÿæä¾›çš„æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆbenchmark testï¼‰ç”¨ä¾‹**æ¥å®ç°ï¼Œè¿™ç›¸å½“äºå¯¹ç¨‹åºçš„å±€éƒ¨çƒ­ç‚¹å»ºç«‹æ€§èƒ½åŸºå‡†ï¼Œå¸¸ç”¨äºä¸€äº›ç®—æ³•æˆ–æ•°æ®ç»“æ„çš„å®ç°ï¼Œæ¯”å¦‚åˆ†å¸ƒå¼å…¨å±€å”¯ä¸€IDç”Ÿæˆç®—æ³•ã€æ ‘çš„æ’å…¥/æŸ¥æ‰¾ç­‰ã€‚

å¦å¤–ä¸€ç§æ˜¯**åŸºäºåº¦é‡æŒ‡æ ‡ä¸ºç¨‹åºå»ºç«‹èµ·å›¾å½¢åŒ–çš„æ€§èƒ½åŸºå‡†**ï¼Œè¿™ç§æ–¹å¼é€‚åˆé’ˆå¯¹ç¨‹åºçš„æ•´ä½“å»ºç«‹æ€§èƒ½åŸºå‡†ã€‚è€Œæˆ‘ä»¬çš„è‡ªå®šä¹‰åè®®æœåŠ¡ç«¯ç¨‹åºå°±ååˆ†é€‚åˆç”¨è¿™ç§æ–¹å¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹åŸºäºåº¦é‡æŒ‡æ ‡å»ºç«‹åŸºå‡†çš„ä¸€ç§å¯è¡Œæ–¹æ¡ˆã€‚

### å»ºç«‹è§‚æµ‹è®¾æ–½

è¿™äº›å¹´ï¼ŒåŸºäºWebçš„å¯è§†åŒ–å·¥å…·ã€å¼€æºç›‘æ§ç³»ç»Ÿä»¥åŠæ—¶åºæ•°æ®åº“çš„å…´èµ·ï¼Œç»™æˆ‘ä»¬å»ºç«‹æ€§èƒ½åŸºå‡†å¸¦æ¥äº†å¾ˆå¤§çš„ä¾¿åˆ©ï¼Œä¸šç•Œæœ‰æ¯”è¾ƒå¤šæˆç†Ÿçš„å·¥å…·ç»„åˆå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚ä½†ä¸šç•Œæœ€å¸¸ç”¨çš„è¿˜æ˜¯Prometheus+Grafanaçš„ç»„åˆï¼Œè¿™ä¹Ÿæ˜¯æˆ‘æ—¥å¸¸ä½¿ç”¨æ¯”è¾ƒå¤šçš„ç»„åˆï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä¹Ÿä½¿ç”¨è¿™ä¸ªå·¥å…·ç»„åˆæ¥ä¸ºæˆ‘ä»¬çš„ç¨‹åºå»ºç«‹æ€§èƒ½æŒ‡æ ‡è§‚æµ‹è®¾æ–½ã€‚

ä»¥Dockerä¸ºä»£è¡¨çš„è½»é‡çº§å®¹å™¨ï¼ˆcontainerï¼‰çš„å…´èµ·ï¼Œè®©è¿™äº›å·¥å…·çš„éƒ¨ç½²ã€å®‰è£…éƒ½å˜å¾—ååˆ†ç®€å•ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä½¿ç”¨docker-composeå·¥å…·ï¼ŒåŸºäºå®¹å™¨å®‰è£…Prometheus+Grafanaçš„ç»„åˆã€‚

æˆ‘å»ºè®®ä½ ä½¿ç”¨ä¸€å°Linuxä¸»æœºæ¥å®‰è£…è¿™äº›å·¥å…·ï¼Œå› ä¸ºdockerä»¥åŠdocker-composeå·¥å…·ï¼Œåœ¨Linuxå¹³å°ä¸Šçš„è¡¨ç°æœ€ä¸ºæˆç†Ÿç¨³å®šã€‚æˆ‘è¿™é‡Œä¸å†è¯¦ç»†è¯´æ˜dockerä¸docker-composeå·¥å…·çš„å®‰è£…æ–¹æ³•äº†ï¼Œä½ å¯ä»¥å‚è€ƒ[dockerå®‰è£…æ•™ç¨‹](https://docs.docker.com/get-docker/)ä»¥åŠ[docker-composeå®‰è£…æ•™ç¨‹](https://docs.docker.com/compose/install/)è‡ªè¡Œåœ¨Linuxä¸Šå®‰è£…è¿™ä¸¤ä¸ªå·¥å…·ã€‚

è¿™é‡Œæˆ‘ç®€å•æè¿°ä¸€ä¸‹å®‰è£…Prometheus+Grafanaçš„ç»„åˆçš„æ­¥éª¤ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬è¦åœ¨Linuxä¸»æœºä¸Šå»ºç«‹ä¸€ä¸ªç›®å½•monitorï¼Œè¿™ä¸ªç›®å½•ä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºdocker-compose.ymlæ–‡ä»¶ï¼Œå®ƒçš„å†…å®¹æ˜¯è¿™æ ·çš„ï¼š

```plain
version: "3.2"
services:
  prometheus:
    container_name: prometheus
    image: prom/prometheus:latest
    network_mode: "host"
    volumes:
      - ./conf/tcp-server-prometheus.yml:/etc/prometheus/prometheus.yml
      - /etc/localtime:/etc/localtime
    restart: on-failure

  grafana:
    container_name: grafana
    image: grafana/grafana:latest
    network_mode: "host"
    restart: on-failure
    volumes:
      - /etc/localtime:/etc/localtime
      - ./data/grafana:/var/lib/grafana

  # linux node_exporter
  node_exporter:
    image: quay.io/prometheus/node-exporter:latest
    restart: always
    container_name: node_exporter
    command:
      - '--path.rootfs=/host'
    network_mode: host
    pid: host
    volumes:
      - '/:/host:ro,rslave'
```

docker-compose.ymlæ˜¯docker-composeå·¥å…·çš„é…ç½®æ–‡ä»¶ï¼ŒåŸºäºè¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œdocker-composeå·¥å…·ä¼šæ‹‰å–å¯¹åº”å®¹å™¨é•œåƒæ–‡ä»¶ï¼Œå¹¶åœ¨æœ¬åœ°å¯åŠ¨å¯¹åº”çš„å®¹å™¨ã€‚

æˆ‘ä»¬è¿™ä¸ªdocker-compose.ymlæ–‡ä»¶ä¸­åŒ…å«äº†ä¸‰ä¸ªå·¥å…·é•œåƒï¼Œåˆ†åˆ«æ˜¯Prometheusã€Grafanaä¸node-exporterã€‚å…¶ä¸­ï¼Œnode-exporteræ˜¯prometheuså¼€æºçš„ä¸»æœºåº¦é‡æ•°æ®çš„é‡‡é›†å·¥å…·ï¼Œé€šè¿‡node exporterï¼Œæˆ‘ä»¬å¯ä»¥é‡‡é›†åˆ°ä¸»æœºçš„CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œI/Oç­‰ä¸»æœºè¿è¡ŒçŠ¶æ€æ•°æ®ã€‚ç»“åˆè¿™äº›æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹æˆ‘ä»¬çš„åº”ç”¨åœ¨è¿è¡Œæ—¶çš„ç³»ç»Ÿèµ„æºå ç”¨æƒ…å†µã€‚

docker-compose.ymlä¸­Prometheuså®¹å™¨æŒ‚è½½çš„tcp-server-prometheus.ymlæ–‡ä»¶æ”¾åœ¨äº†monitor/confä¸‹é¢ï¼Œå®ƒçš„å†…å®¹æ˜¯è¿™æ ·ï¼š

```plain
global:
  scrape_interval: 5s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: "prometheus"
    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.
    static_configs:
      - targets: ["localhost:9090"]

  - job_name: "tcp-server"
    static_configs:
      - targets: ["localhost:8889"]

  - job_name: "node"
    static_configs:
      - targets: ["localhost:9100"]
```

æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨ä¸Šé¢Prometheusçš„é…ç½®æ–‡ä»¶çš„scrpae\_configsä¸‹é¢ï¼Œé…ç½®äº†ä¸‰ä¸ªé‡‡é›†jobï¼Œåˆ†åˆ«ç”¨äºé‡‡é›†Prometheusè‡ªèº«åº¦é‡æ•°æ®ã€æˆ‘ä»¬çš„tcp serverçš„åº¦é‡æ•°æ®ï¼Œä»¥åŠnode-exporterçš„åº¦é‡æ•°æ®ã€‚

grafanaå®¹å™¨ä¼šæŒ‚è½½æœ¬åœ°çš„data/grafanaè·¯å¾„åˆ°å®¹å™¨ä¸­ï¼Œä¸ºäº†é¿å…è®¿é—®æƒé™å¸¦æ¥çš„é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨åˆ›å»ºdata/grafanaç›®å½•åï¼Œæœ€å¥½å†ä¸ºè¿™ä¸ªç›®å½•èµ‹äºˆè¶³å¤Ÿçš„è®¿é—®æƒé™ï¼Œæ¯”å¦‚ï¼š

```plain
$chmod -R 777 data
```

è¿è¡Œä¸‹é¢å‘½ä»¤ï¼Œdocker-composeå°±ä¼šè‡ªåŠ¨æ‹‰å–é•œåƒï¼Œå¹¶å¯åŠ¨docker-compose.ymlä¸­çš„ä¸‰ä¸ªå®¹å™¨ï¼š

```plain
$docker-compose -f docker-compose.yml up -d
```

ç­‰å¾…ä¸€æ®µæ—¶é—´åï¼Œæ‰§è¡Œdocker pså‘½ä»¤ï¼Œå¦‚æœä½ èƒ½çœ‹åˆ°ä¸‹é¢ä¸‰ä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œå°±è¯´æ˜æˆ‘ä»¬çš„å®‰è£…å°±æˆåŠŸäº†ï¼š

```plain
$docker ps
CONTAINER ID   IMAGE                                     COMMAND                  CREATED        STATUS        PORTS     NAMES
563d655cdf90   grafana/grafana:latest                    "/run.sh"                26 hours ago   Up 26 hours             grafana
65616d1b6d1a   prom/prometheus:latest                    "/bin/prometheus --câ€¦"   26 hours ago   Up 26 hours             prometheus
b29d3fef8572   quay.io/prometheus/node-exporter:latest   "/bin/node_exporter â€¦"   26 hours ago   Up 26 hours             node_exporter
```

ä¸ºäº†æ›´ç›´è§‚åœ°äº†è§£åˆ°æ•´ä¸ªè§‚æµ‹è®¾æ–½ä¸­å„ä¸ªå·¥å…·ä¹‹é—´çš„å…³ç³»ï¼Œæˆ‘è¿™é‡Œç”»äº†ä¸€å¹…ç¤ºæ„å›¾ï¼Œå¯¹ç…§ç€è¿™å¹…å›¾ï¼Œä½ å†æ¥ç†è§£ä¸Šé¢çš„é…ç½®ä¸æ‰§è¡Œæ­¥éª¤ä¼šå®¹æ˜“è®¸å¤šï¼š

![](https://static001.geekbang.org/resource/image/2c/1d/2c1125e3629da1c12db3a29da523231d.jpg?wh=1366x526)

### é…ç½®Grafana

ä¸€æ—¦æˆåŠŸå¯åŠ¨ï¼ŒPrometheusä¾¿ä¼šå¯åŠ¨å„ä¸ªé‡‡é›†jobï¼Œä»tcp serverä»¥åŠnode-exporterä¸­æ‹‰å–åº¦é‡æ•°æ®ï¼Œå¹¶å­˜å‚¨åœ¨å…¶æ—¶åºæ•°æ®åº“ä¸­ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦å¯¹Grafanaè¿›è¡Œä¸€äº›ç®€å•é…ç½®ï¼Œæ‰èƒ½è®©è¿™äº›æ•°æ®ä»¥å›¾å½¢åŒ–çš„æ–¹å¼å±•ç°å‡ºæ¥ã€‚

æˆ‘ä»¬é¦–å…ˆéœ€è¦ä¸ºGrafanaé…ç½®ä¸€ä¸ªæ–°çš„æ•°æ®æºï¼ˆdata sourceï¼‰ï¼Œåœ¨æ•°æ®æºé€‰æ‹©é¡µé¢ï¼Œæˆ‘ä»¬é€‰æ‹©Prometheusï¼Œå°±åƒä¸‹å›¾è¿™æ ·ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/83/1f/83a422e1cf39e47a9600dc222f384a1f.png?wh=1920x454)

é€‰æ‹©åï¼Œåœ¨Prometheusæ•°æ®æºé…ç½®é¡µé¢ï¼Œé…ç½®è¿™ä¸ªæ•°æ®æºçš„HTTP URLå°±å¯ä»¥äº†ã€‚å¦‚æœä½ ç‚¹å‡»â€œSave &amp; testâ€æŒ‰é’®åæç¤ºæˆåŠŸï¼Œé‚£ä¹ˆæ•°æ®æºå°±é…ç½®å¥½äº†ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ·»åŠ ä¸€ä¸ªnode-exporterä»ªè¡¨æ¿ï¼ˆdashboardï¼‰ï¼ŒæŠŠä»node-exporteræ‹‰å–çš„åº¦é‡æ•°æ®ä»¥å›¾å½¢åŒ–æ–¹å¼å±•ç¤ºå‡ºæ¥ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¸éœ€è¦æ‰‹å·¥ä¸€ä¸ªä¸€ä¸ªè®¾ç½®ä»ªè¡¨æ¿ä¸Šçš„panelï¼ŒGrafanaå®˜æ–¹æœ‰ç°æˆçš„node-exporterä»ªè¡¨æ¿å¯ç”¨ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨grafanaçš„importé¡µé¢ä¸­è¾“å…¥ç›¸åº”çš„dashboard IDï¼Œå°±å¯ä»¥å¯¼å…¥ç›¸å…³ä»ªè¡¨æ¿çš„è®¾ç½®ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/e4/e8/e483fec0e2a3cfbc258cd92817d820e8.png?wh=1592x1178)

è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯IDä¸º1860çš„node-exporterä»ªè¡¨æ¿ï¼Œå¯¼å…¥æˆåŠŸåï¼Œè¿›å…¥è¿™ä¸ªä»ªè¡¨æ¿é¡µé¢ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„å¯è§†åŒ–ç»“æœï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/5a/5c/5a1583feb00585b93eebb0d9b7e8995c.png?wh=1920x1052)

å¥½äº†ï¼Œåˆ°è¿™é‡Œnode-exporterçš„åº¦é‡æ•°æ®ï¼Œå·²ç»å¯ä»¥ä»¥å›¾å½¢åŒ–çš„å½¢å¼å‘ˆç°åœ¨æˆ‘ä»¬é¢å‰äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„è‡ªå®šä¹‰åè®®çš„æœåŠ¡ç«¯çš„æ•°æ®åˆå¦‚ä½•é‡‡é›†ä¸å‘ˆç°å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­å‘ä¸‹çœ‹ã€‚

### åœ¨æœåŠ¡ç«¯åŸ‹å…¥åº¦é‡æ•°æ®é‡‡é›†ç‚¹

å‰é¢è¯´äº†ï¼Œæˆ‘ä»¬è¦å»ºç«‹æœåŠ¡ç«¯çš„æ€§èƒ½åŸºå‡†ï¼Œé‚£ä¹ˆå“ªäº›åº¦é‡æ•°æ®èƒ½åæ˜ å‡ºæœåŠ¡ç«¯çš„æ€§èƒ½æŒ‡æ ‡å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸‰ä¸ªåº¦é‡æ•°æ®é¡¹ï¼š

- å½“å‰å·²è¿æ¥çš„å®¢æˆ·ç«¯æ•°é‡ï¼ˆclient\_connectedï¼‰ï¼›
- æ¯ç§’æ¥æ”¶æ¶ˆæ¯è¯·æ±‚çš„æ•°é‡ï¼ˆreq\_recv\_rateï¼‰ï¼›
- æ¯ç§’å‘é€æ¶ˆæ¯å“åº”çš„æ•°é‡ï¼ˆrsp\_send\_rateï¼‰ã€‚

é‚£ä¹ˆå¦‚ä½•åœ¨æœåŠ¡ç«¯çš„ä»£ç ä¸­åŸ‹å…¥è¿™ä¸‰ä¸ªåº¦é‡æ•°æ®é¡¹å‘¢ï¼Ÿ

æˆ‘ä»¬å°†ä¸Šä¸€è®²çš„tcp-server-demo1é¡¹ç›®æ‹·è´ä¸€ä»½ï¼Œå½¢æˆtcp-server-demo2é¡¹ç›®ï¼Œæˆ‘ä»¬è¦åœ¨tcp-server-demo2é¡¹ç›®ä¸­å®ç°è¿™ä¸‰ä¸ªåº¦é‡æ•°æ®é¡¹çš„é‡‡é›†ã€‚

æˆ‘ä»¬åœ¨tcp-server-demo2ä¸‹ï¼Œåˆ›å»ºæ–°çš„metricsåŒ…è´Ÿè´£å®šä¹‰åº¦é‡æ•°æ®é¡¹ï¼ŒmetricsåŒ…çš„æºç å¦‚ä¸‹ï¼š

```plain
// tcp-server-demo2/metrics/metrics.go

package metrics

import (
    "fmt"
    "net/http"

    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promhttp"
)

var (
    ClientConnected prometheus.Gauge
    ReqRecvTotal    prometheus.Counter
    RspSendTotal    prometheus.Counter
)

func init() {
    ReqRecvTotal = prometheus.NewCounter(prometheus.CounterOpts{
        Name: "tcp_server_demo2_req_recv_total",
    })
    RspSendTotal = prometheus.NewCounter(prometheus.CounterOpts{
        Name: "tcp_server_demo2_rsp_send_total",
    })

    ClientConnected = prometheus.NewGauge(prometheus.GaugeOpts{
        Name: "tcp_server_demo2_client_connected",
    })

    prometheus.MustRegister(ReqRecvTotal, RspSendTotal, ClientConnected)

    // start the metrics server
    metricsServer := &http.Server{
        Addr: fmt.Sprintf(":%d", metricsHTTPPort),
    }

    mu := http.NewServeMux()
    mu.Handle("/metrics", promhttp.Handler())
    metricsServer.Handler = mu
    go func() {
        err := metricsServer.ListenAndServe()
        if err != nil {
            fmt.Println("prometheus-exporter http server start failed:", err)
        }
    }()
    fmt.Println("metrics server start ok(*:8889)")
}
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨prometheusæä¾›çš„go clientåŒ…ä¸­çš„ç±»å‹å®šä¹‰äº†ä¸‰ä¸ªåº¦é‡æ•°æ®é¡¹ã€‚å…¶ä¸­ClientConnectedçš„ç±»å‹ä¸ºprometheus.Gaugeï¼ŒGaugeæ˜¯å¯¹ä¸€ä¸ªæ•°å€¼çš„å³æ—¶æµ‹é‡å€¼ï¼Œå®ƒåæ˜ ä¸€ä¸ªå€¼çš„ç¬æ—¶å¿«ç…§ï¼›è€ŒReqRecvTotalå’ŒRspSendTotalçš„ç±»å‹éƒ½ä¸ºprometheus.Counterã€‚

Counteré¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¯ä»¥ç´¯åŠ ï¼Œä¹Ÿå¯ä»¥å‡å°‘ã€‚ä¸è¿‡è¦æƒ³åæ˜ æˆ‘ä»¬é¢„æœŸçš„æ¯ç§’å¤„ç†èƒ½åŠ›çš„æŒ‡æ ‡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†è¿™ä¸¤ä¸ªè®¡æ•°å™¨ä¸rateå‡½æ•°ä¸€èµ·ä½¿ç”¨æ‰è¡Œï¼Œè¿™ä¸ªæˆ‘ä»¬ç¨åå†è¯´ã€‚

æˆ‘ä»¬åœ¨metricsåŒ…çš„initå‡½æ•°ä¸­å¯åŠ¨äº†ä¸€ä¸ªhttp serverï¼Œè¿™ä¸ªserverç›‘å¬8889ç«¯å£ï¼Œè¿˜è®°å¾—æˆ‘ä»¬å‰é¢prometheusé…ç½®æ–‡ä»¶ä¸­tcp-server jobé‡‡é›†çš„ç›®æ ‡åœ°å€å—ï¼Ÿæ­£æ˜¯è¿™ä¸ª8889ç«¯å£ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒPrometheuså®šæœŸä»8889ç«¯å£æ‹‰å–æˆ‘ä»¬çš„åº¦é‡æ•°æ®é¡¹çš„å€¼ã€‚

æœ‰äº†metricsåŒ…ä»¥åŠåº¦é‡æ•°æ®é¡¹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†åº¦é‡æ•°æ®é¡¹åŸ‹åˆ°æœåŠ¡ç«¯çš„å¤„ç†æµç¨‹ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹å¯¹mainåŒ…çš„æ”¹é€ ï¼š

```plain
// tcp-server-demo2/cmd/server/main.go
func handleConn(c net.Conn) {
    metrics.ClientConnected.Inc() // è¿æ¥å»ºç«‹ï¼ŒClientConnectedåŠ 1
    defer func() {
        metrics.ClientConnected.Dec() // è¿æ¥æ–­å¼€ï¼ŒClientConnectedå‡1
        c.Close()
    }() 
    frameCodec := frame.NewMyFrameCodec()
    
    for {
        // read from the connection
        
        // decode the frame to get the payload
        // the payload is undecoded packet
        framePayload, err := frameCodec.Decode(c)
        if err != nil {
            fmt.Println("handleConn: frame decode error:", err)
            return
        }   
        metrics.ReqRecvTotal.Add(1) // æ”¶åˆ°å¹¶è§£ç ä¸€ä¸ªæ¶ˆæ¯è¯·æ±‚ï¼ŒReqRecvTotalæ¶ˆæ¯è®¡æ•°å™¨åŠ 1
        
        // do something with the packet
        ackFramePayload, err := handlePacket(framePayload)
        if err != nil {
            fmt.Println("handleConn: handle packet error:", err)
            return
        }   
        
        // write ack frame to the connection
        err = frameCodec.Encode(c, ackFramePayload)
        if err != nil {
            fmt.Println("handleConn: frame encode error:", err)
            return
        }   
        metrics.RspSendTotal.Add(1) // è¿”å›å“åº”åï¼ŒRspSendTotalæ¶ˆæ¯è®¡æ•°å™¨å‡1
    }   
} 
```

ä½ å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ªè¿æ¥çš„å¤„ç†ä¸»å‡½æ•°handleConnä¸­éƒ½åŸ‹å…¥äº†å„ä¸ªåº¦é‡æ•°æ®é¡¹ï¼Œå¹¶åœ¨ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶ä¿®æ”¹åº¦é‡æ•°æ®çš„å€¼ã€‚

æœåŠ¡ç«¯å»ºç«‹å®Œåº¦é‡æ•°æ®é¡¹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨Grafanaä¸­å»ºç«‹å¯¹åº”çš„ä»ªè¡¨æ¿æ¥å±•ç¤ºè¿™äº›åº¦é‡æ•°æ®é¡¹ï¼Œè¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬å°±éœ€è¦æ‰‹åŠ¨åˆ›å»ºä»ªè¡¨æ¿tcp-server-demoï¼Œå¹¶ä¸ºä»ªè¡¨æ¿æ‰‹åŠ¨æ·»åŠ paneläº†ã€‚

æˆ‘ä»¬å»ºç«‹ä¸‰ä¸ªpanelï¼šreq\_recv\_rateã€rsp\_send\_rateå’Œclient\_connectedï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/f1/25/f1e4bfd33a9499e82b00221ace8abc25.png?wh=1920x902)

client\_connected panelæ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥å–tcp\_server\_demo2\_client\_connectedè¿™ä¸ªæ³¨å†Œåˆ°prometheusä¸­çš„åº¦é‡é¡¹çš„å€¼å°±å¯ä»¥äº†ã€‚

è€Œreq\_recv\_rateå’Œrsp\_send\_rateå°±è¦ç»“åˆåº¦é‡é¡¹çš„å€¼ä¸ [rateå‡½æ•°](https://prometheus.io/docs/prometheus/latest/querying/functions/#rate)æ¥å®ç°ã€‚ä»¥req\_recv\_rateè¿™ä¸ªpanelä¸ºä¾‹ï¼Œå®ƒçš„panelé…ç½®æ˜¯è¿™æ ·ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/02/0f/02736fe21512ab8ac983caaa73cc550f.png?wh=1920x1437)

æˆ‘ä»¬çœ‹åˆ°å›¾ä¸­çš„Metrics Browseråé¢çš„è¡¨è¾¾å¼æ˜¯ï¼š`rate(tcp_server_demo2_req_recv_total[15s])`ï¼Œè¿™ä¸ªè¡¨è¾¾å¼è¿”å›çš„æ˜¯åœ¨15ç§’å†…æµ‹å¾—çš„req\_recv\_totalçš„æ¯ç§’é€Ÿç‡ï¼Œè¿™æ°æ°æ˜¯å¯ä»¥åæ˜ æˆ‘ä»¬çš„æœåŠ¡ç«¯å¤„ç†æ€§èƒ½çš„æŒ‡æ ‡ã€‚

å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼Œæ”¯æŒè¾“å‡ºåº¦é‡æ•°æ®æŒ‡æ ‡çš„æœåŠ¡ç«¯ä»¥åŠå¯¹åº”çš„grafanaä»ªè¡¨æ¿éƒ½å‡†å¤‡å¥½äº†ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥ä¸ºæœåŠ¡ç«¯å»ºç«‹ç¬¬ä¸€ç‰ˆçš„æ€§èƒ½åŸºå‡†ã€‚

### ç¬¬ä¸€ç‰ˆæ€§èƒ½åŸºå‡†

è¦å»ºç«‹æ€§èƒ½åŸºå‡†ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªå¯ä»¥å¯¹æœåŠ¡ç«¯ç¨‹åºâ€œæ–½åŠ å‹åŠ›â€çš„å®¢æˆ·ç«¯æ¨¡æ‹Ÿå™¨ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºtcp-server-demo1/cmd/clientå®ç°è¿™ä¸ªæ¨¡æ‹Ÿå™¨ã€‚

æ–°ç‰ˆæ¨¡æ‹Ÿå™¨çš„åŸç†ä¸tcp-server-demo1/cmd/clientåŸºæœ¬ä¸€è‡´ï¼Œæ‰€ä»¥å…·ä½“çš„æ”¹é€ è¿‡ç¨‹æˆ‘è¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œæ–°ç‰ˆæ¨¡æ‹Ÿå™¨çš„ä»£ç ï¼Œæˆ‘æ”¾åœ¨äº†tcp-server-demo2/cmd/clientä¸‹é¢ï¼Œä½ å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹æºç ã€‚

å»ºç«‹ä»¥åŠä½¿ç”¨æ€§èƒ½åŸºå‡†çš„å‰æï¼Œæ˜¯**æœåŠ¡ç«¯çš„å‹æµ‹çš„ç¡¬ä»¶æ¡ä»¶è¦å°½é‡ä¿æŒä¸€è‡´**ï¼Œä»¥ä¿è¯å¾—åˆ°çš„ç»“æœå—å¤–ç•Œå¹²æ‰°è¾ƒå°‘ï¼Œæ€§èƒ½åŸºå‡†æ‰æ›´æœ‰å‚è€ƒæ„ä¹‰ã€‚æˆ‘ä»¬åœ¨ä¸€ä¸ª4æ ¸8Gçš„Centos Linuxä¸»æœºä¸Šè·‘è¿™ä¸ªå‹åŠ›æµ‹è¯•ï¼Œåç»­çš„å‹æµ‹ä¹Ÿæ˜¯åœ¨åŒæ ·çš„æ¡ä»¶ä¸‹ã€‚

å‹æµ‹çš„æ­¥éª¤å¾ˆç®€å•ï¼Œé¦–å…ˆåœ¨tcp-server-demo2ä¸‹æ„å»ºå‡ºserverä¸clientä¸¤ä¸ªå¯æ‰§è¡Œç¨‹åºã€‚ç„¶åå…ˆå¯åŠ¨serverï¼Œå†å¯åŠ¨clientã€‚è¿è¡Œå‡ åˆ†é’Ÿåï¼Œåœæ‰ç¨‹åºå°±å¯ä»¥äº†ï¼Œè¿™æ—¶ï¼Œæˆ‘ä»¬åœ¨grafanaçš„tcp-serverçš„ä»ªè¡¨æ¿ä¸­ï¼Œå°±èƒ½çœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„å›¾å½¢åŒ–æ•°æ®å±•ç¤ºäº†ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/32/71/32596cd6cfe641330300bfe492f44771.png?wh=1920x929)

ä»è¿™å¼ å›¾ä¸­ï¼Œæˆ‘ä»¬å¤§çº¦çœ‹åˆ°æœåŠ¡ç«¯çš„å¤„ç†æ€§èƒ½å¤§çº¦åœ¨18.5w/ç§’å·¦å³ï¼Œæˆ‘ä»¬å°±å°†è¿™ä¸ªç»“æœä½œä¸ºæœåŠ¡ç«¯çš„ç¬¬ä¸€ä¸ªæ€§èƒ½åŸºå‡†ã€‚

## å°è¯•ç”¨pprofå‰–æ

æŒ‰ç…§è¿™ä¸€è®²å¼€å¤´çš„Goåº”ç”¨æ€§èƒ½ä¼˜åŒ–å¾ªç¯çš„æ€è·¯ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±åº”è¯¥å°è¯•å¯¹æˆ‘ä»¬çš„æœåŠ¡ç«¯åšæ€§èƒ½å‰–æï¼Œè¯†åˆ«å‡ºç“¶é¢ˆç‚¹ã€‚

Goæ˜¯â€œè‡ªå¸¦ç”µæ± â€ï¼ˆbattery includedï¼‰çš„è¯­è¨€ï¼Œæ‹¥æœ‰ç€è®©å…¶ä»–ä¸»æµè¯­è¨€ç¾¡æ…•çš„å·¥å…·é“¾ï¼ŒGoåŒæ ·ä¹Ÿå†…ç½®äº†å¯¹Goä»£ç è¿›è¡Œæ€§èƒ½å‰–æçš„å·¥å…·ï¼š**pprof**ã€‚

pprofæºè‡ª [Google Perf Toolså·¥å…·å¥—ä»¶](https://github.com/gperftools/gperftools)ï¼Œåœ¨Goå‘å¸ƒæ—©æœŸå°±è¢«é›†æˆåˆ°Goå·¥å…·é“¾ä¸­äº†ï¼Œæ‰€ä»¥pprofä¹Ÿæ˜¯Gopheræœ€å¸¸ç”¨çš„ã€å¯¹Goåº”ç”¨è¿›è¡Œæ€§èƒ½å‰–æçš„å·¥å…·ã€‚è¿™é‡Œæˆ‘ä»¬ä¹Ÿä½¿ç”¨è¿™ä¸€å·¥å…·å¯¹æˆ‘ä»¬çš„æœåŠ¡ç«¯ç¨‹åºè¿›è¡Œå‰–æã€‚

Goåº”ç”¨æ”¯æŒpprofæ€§èƒ½å‰–æçš„æ–¹å¼æœ‰å¤šç§ï¼Œæœ€å—Gopheré’ççš„æ˜¯é€šè¿‡å¯¼å…¥ `net/http/pprof` åŒ…çš„æ–¹å¼ã€‚æˆ‘ä»¬æ”¹é€ ä¸€ä¸‹tcp-server-demo2ï¼Œè®©å®ƒé€šè¿‡è¿™ç§æ–¹å¼æ”¯æŒpprofæ€§èƒ½å‰–æã€‚

æ”¹é€ åçš„ä»£ç æ”¾åœ¨tcp-server-demo2-with-pprofç›®å½•ä¸‹ï¼Œä¸‹é¢æ˜¯æ”¯æŒpprofçš„mainåŒ…çš„ä»£ç èŠ‚é€‰ï¼š

```plain
// tcp-server-demo2-with-pprof/cmd/server/main.go

import (
    ... ...
    "net/http"
    _ "net/http/pprof"
    ... ...
)

... ...

func main() {
    go func() {
        http.ListenAndServe(":6060", nil)
    }()
    ... ...
}
```

ä»è¿™ä¸ªä»£ç å˜æ›´å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åªéœ€è¦ä»¥ç©ºå¯¼å…¥çš„æ–¹å¼å¯¼å…¥net/http/pprofåŒ…ï¼Œå¹¶åœ¨ä¸€ä¸ªå•ç‹¬çš„goroutineä¸­å¯åŠ¨ä¸€ä¸ªæ ‡å‡†çš„httpæœåŠ¡ï¼Œå°±å¯ä»¥å®ç°å¯¹pprofæ€§èƒ½å‰–æçš„æ”¯æŒã€‚pprofå·¥å…·å¯ä»¥é€šè¿‡6060ç«¯å£é‡‡æ ·åˆ°æˆ‘ä»¬çš„Goç¨‹åºçš„è¿è¡Œæ—¶æ•°æ®ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥è¿›è¡Œæ€§èƒ½å‰–ææ•°æ®çš„é‡‡é›†ã€‚æˆ‘ä»¬ç¼–è¯‘tcp-server-demo2-with-pprofç›®å½•ä¸‹çš„serverä¸clientï¼Œå…ˆåå¯åŠ¨serverä¸clientï¼Œè®©clientå¯¹serverä¿æŒæŒç»­çš„å‹åŠ›ã€‚

ç„¶åæˆ‘ä»¬åœ¨è‡ªå·±çš„å¼€å‘æœºä¸Šæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š

```plain
// 192.168.10.18ä¸ºæœåŠ¡ç«¯çš„ä¸»æœºåœ°å€
$go tool pprof -http=:9090 http://192.168.10.18:6060/debug/pprof/profile
Fetching profile over HTTP from http://192.168.10.18:6060/debug/pprof/profile
Saved profile in /Users/tonybai/pprof/pprof.server.samples.cpu.004.pb.gz
Serving web UI on http://localhost:9090
```

go tool pprofå‘½ä»¤é»˜è®¤ä¼šä»http://192.168.10.18:6060/debug/pprof/profileæœåŠ¡ä¸Šï¼Œé‡‡é›†CPUç±»å‹çš„æ€§èƒ½å‰–ææ•°æ®ï¼Œç„¶åæ‰“å¼€æœ¬åœ°æµè§ˆå™¨ï¼Œé»˜è®¤æ˜¾ç¤ºå¦‚ä¸‹é¡µé¢ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/0d/a8/0d5160c2cfc8dfc620d6a5290c077ea8.png?wh=1920x1179)

debug/pprof/profileæä¾›çš„æ˜¯CPUçš„æ€§èƒ½é‡‡æ ·æ•°æ®ã€‚CPUç±»å‹é‡‡æ ·æ•°æ®æ˜¯æ€§èƒ½å‰–æä¸­æœ€å¸¸è§çš„é‡‡æ ·æ•°æ®ç±»å‹ã€‚

ä¸€æ—¦å¯ç”¨CPUæ•°æ®é‡‡æ ·ï¼ŒGoè¿è¡Œæ—¶ä¼šæ¯éš”ä¸€æ®µçŸ­æš‚çš„æ—¶é—´ï¼ˆ10msï¼‰å°±ä¸­æ–­ä¸€æ¬¡ï¼ˆç”±SIGPROFä¿¡å·å¼•å‘ï¼‰ï¼Œå¹¶è®°å½•å½“å‰æ‰€æœ‰goroutineçš„å‡½æ•°æ ˆä¿¡æ¯ã€‚å®ƒèƒ½å¸®åŠ©æˆ‘ä»¬è¯†åˆ«å‡ºä»£ç å…³é”®è·¯å¾„ä¸Šå‡ºç°æ¬¡æ•°æœ€å¤šçš„å‡½æ•°ï¼Œè€Œå¾€å¾€è¿™ä¸ªå‡½æ•°å°±æ˜¯ç¨‹åºçš„ä¸€ä¸ªç“¶é¢ˆã€‚ä¸Šå›¾æˆ‘ä»¬æ²¿ç€ç²—çº¢çº¿å‘ä¸‹çœ‹ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸‹é¢å›¾ä¸­çš„ä¿¡æ¯ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/b4/01/b47ffd738615a08595208a4e1afefa01.png?wh=1700x1634)

æˆ‘ä»¬çœ‹åˆ°å›¾ä¸­é—´çš„Syscallå‡½æ•°å æ®äº†ä¸€ä¸ªæœ€å¤§çš„æ–¹æ¡†ï¼Œå¹¶ç”¨é»‘ä½“æ ‡è®°äº†å‡ºæ¥ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ç¨‹åºçš„ç¬¬ä¸€ä¸ªç“¶é¢ˆï¼š**èŠ±è´¹å¤ªå¤šæ—¶é—´åœ¨ç³»ç»Ÿè°ƒç”¨ä¸Šäº†**ã€‚åœ¨å‘ä¸Šå¯»æ‰¾ï¼Œæˆ‘ä»¬å‘ç°Syscallçš„è°ƒç”¨è€…åŸºæœ¬éƒ½æ˜¯ç½‘ç»œreadå’Œwriteå¯¼è‡´çš„ã€‚

## ä»£ç ä¼˜åŒ–

å¥½äº†ï¼Œç¬¬ä¸€ä¸ªç“¶é¢ˆç‚¹å·²ç»æ‰¾åˆ°ï¼æˆ‘ä»¬è¯¥è¿›å…¥ä¼˜åŒ–å¾ªç¯çš„ç¬¬ä¸‰ä¸ªç¯èŠ‚ï¼šä»£ç ä¼˜åŒ–äº†ã€‚é‚£ä¹ˆè¯¥å¦‚ä½•ä¼˜åŒ–ä»£ç å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†æ¥çœ‹ã€‚

### å¸¦ç¼“å­˜çš„ç½‘ç»œI/O

ä¸ºä»€ä¹ˆç½‘ç»œreadå’Œwriteå¯¼è‡´çš„Syscallä¼šé‚£ä¹ˆå¤šå‘¢ï¼Ÿæˆ‘ä»¬å›é¡¾ä¸€ä¸‹ç¬¬ä¸€ç‰ˆæœåŠ¡ç«¯çš„å®ç°ã€‚

æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨handleConnå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥å°†net.Connå®ä¾‹ä¼ ç»™frame.Decodeä½œä¸ºio.Readerå‚æ•°çš„å®å‚ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬æ¯æ¬¡è°ƒç”¨Readæ–¹æ³•éƒ½æ˜¯ç›´æ¥ä»net.Connä¸­è¯»å–æ•°æ®ï¼Œè€ŒReadå°†è½¬å˜ä¸ºä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼ˆSyscallï¼‰ï¼Œå“ªæ€•æ˜¯ä»…ä»…è¯»å–ä¸€ä¸ªå­—èŠ‚ä¹Ÿæ˜¯å¦‚æ­¤ã€‚å› æ­¤ï¼Œæˆ‘ä»¬çš„ä¼˜åŒ–ç›®æ ‡æ˜¯**é™ä½net.Connçš„Writeå’ŒReadçš„é¢‘ç‡**ã€‚

é‚£ä¹ˆå¦‚ä½•é™ä½net.Connçš„è¯»å†™é¢‘ç‡å‘¢ï¼Ÿå¢åŠ ç¼“å­˜ä¸å¤±ä¸ºä¸€ä¸ªæœ‰æ•ˆçš„æ–¹æ³•ã€‚è€Œä¸”ï¼Œæˆ‘ä»¬çš„æœåŠ¡ç«¯é‡‡ç”¨çš„æ˜¯ä¸€ä¸ªgoroutineå¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥çš„æ–¹å¼ï¼Œç”±äºæ²¡æœ‰ç«æ€ï¼Œè¿™ä¸ªæ¨¡å‹æ›´é€‚åˆåœ¨è¯»å†™net.Connæ—¶ä½¿ç”¨å¸¦ç¼“å­˜çš„æ–¹å¼ã€‚

æ‰€ä»¥ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥ä¸ºtcp-server-demo2å¢åŠ net.Connçš„ç¼“å­˜è¯»ä¸ç¼“å­˜å†™ã€‚ä¼˜åŒ–åçš„ä»£ç æˆ‘æ”¾åœ¨äº†tcp-server-demo3ä¸‹ï¼š

```plain
// tcp-server-demo3/cmd/server/main.go

 func handleConn(c net.Conn) {
     metrics.ClientConnected.Inc()
     defer func() {
         metrics.ClientConnected.Dec()
         c.Close()
     }()
     frameCodec := frame.NewMyFrameCodec()
     rbuf := bufio.NewReader(c)
     wbuf := bufio.NewWriter(c)
 
     defer wbuf.Flush()
     for {
         // read from the connection
 
         // decode the frame to get the payload
         // the payload is undecoded packet
         framePayload, err := frameCodec.Decode(rbuf)
         if err != nil {
             fmt.Println("handleConn: frame decode error:", err)
             return
         }
         metrics.ReqRecvTotal.Add(1)
 
         // do something with the packet
         ackFramePayload, err := handlePacket(framePayload)
         if err != nil {
             fmt.Println("handleConn: handle packet error:", err)
             return
         }
  
         // write ack frame to the connection
         err = frameCodec.Encode(wbuf, ackFramePayload)
         if err != nil {
             fmt.Println("handleConn: frame encode error:", err)
             return
         }
         metrics.RspSendTotal.Add(1)
     }
 }
```

tcp-server-demo3å”¯ä¸€çš„æ”¹åŠ¨ï¼Œå°±æ˜¯mainåŒ…ä¸­çš„handleConnå‡½æ•°ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ªè¯»ç¼“å­˜å˜é‡ï¼ˆrbufï¼‰å’Œä¸€ä¸ªå†™ç¼“å­˜å˜é‡ï¼ˆwbufï¼‰ï¼Œæˆ‘ä»¬ç”¨è¿™ä¸¤ä¸ªå˜é‡æ›¿æ¢æ‰ä¼ ç»™frameCodec.Decodeå’ŒframeCodec.Encodeçš„net.Connå‚æ•°ã€‚

ä»¥rbufä¸ºä¾‹ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•èµ·åˆ°é™ä½syscallè°ƒç”¨é¢‘ç‡çš„ä½œç”¨çš„ã€‚

å°†net.Connæ”¹ä¸ºrbufåï¼ŒframeCodec.Decodeä¸­çš„æ¯æ¬¡ç½‘ç»œè¯»å–å®é™…è°ƒç”¨çš„éƒ½æ˜¯bufio.Readerçš„Readæ–¹æ³•ã€‚bufio.Reader.Readæ–¹æ³•å†…éƒ¨ï¼Œæ¯æ¬¡ä»net.Connå°è¯•è¯»å–å…¶å†…éƒ¨ç¼“å­˜å¤§å°çš„æ•°æ®ï¼Œè€Œä¸æ˜¯ç”¨æˆ·ä¼ å…¥çš„å¸Œæœ›è¯»å–çš„æ•°æ®å¤§å°ã€‚è¿™äº›æ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œè¿™æ ·ï¼Œåç»­çš„Readå°±å¯ä»¥ç›´æ¥ä»å†…å­˜ä¸­å¾—åˆ°æ•°æ®ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½è¦ä»net.Connè¯»å–ï¼Œä»è€Œé™ä½Syscallè°ƒç”¨çš„é¢‘ç‡ã€‚

æˆ‘ä»¬å¯¹ä¼˜åŒ–åçš„tcp-server-demo3åšä¸€æ¬¡å‹æµ‹ï¼Œçœ‹çœ‹å®ƒçš„å¤„ç†æ€§èƒ½åˆ°åº•æœ‰æ²¡æœ‰æå‡ï¼Œå‹æµ‹çš„æ­¥éª¤ä½ å¯ä»¥å‚è€ƒå‰é¢çš„å†…å®¹ã€‚å‹æµ‹åï¼Œæˆ‘ä»¬å¾—åˆ°ä¸‹é¢çš„ç»“æœï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/5d/09/5dc6496e4ce66a55e22404679b5a1409.png?wh=1920x950)

ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¼˜åŒ–åçš„æœåŠ¡ç«¯çš„å¤„ç†æ€§èƒ½æå‡åˆ°27w/så·¦å³ï¼Œç›¸æ¯”äºç¬¬ä¸€ç‰ˆæ€§èƒ½åŸºå‡†(18.5w/s)ï¼Œæ€§èƒ½æå‡äº†è¶³æœ‰45%ã€‚

### é‡ç”¨å†…å­˜å¯¹è±¡

å‰é¢è¿™ä¸ªå¸¦ç¼“å­˜çš„ç½‘ç»œI/Oï¼Œæ˜¯æˆ‘ä»¬ä»CPUæ€§èƒ½é‡‡æ ·æ•°æ®ä¸­æ‰¾åˆ°çš„â€œç“¶é¢ˆç‚¹â€ã€‚ä¸è¿‡ï¼Œåœ¨Goä¸­è¿˜æœ‰å¦å¤–ä¸€ä¸ªååˆ†é‡è¦çš„æ€§èƒ½æŒ‡æ ‡ï¼Œé‚£å°±æ˜¯å †å†…å­˜å¯¹è±¡çš„åˆ†é…ã€‚

å› ä¸ºGoæ˜¯å¸¦æœ‰åƒåœ¾å›æ”¶ï¼ˆGCï¼‰çš„è¯­è¨€ï¼Œé¢‘ç¹çš„å †å†…å­˜å¯¹è±¡åˆ†é…æˆ–åˆ†é…è¾ƒå¤šï¼Œéƒ½ä¼šç»™GCå¸¦å»è¾ƒå¤§å‹åŠ›ï¼Œè€ŒGCçš„å‹åŠ›æ˜¾ç„¶ä¼šè½¬åŒ–ä¸ºå¯¹CPUèµ„æºçš„æ¶ˆè€—ï¼Œä»è€ŒæŒ¤å‹å¤„ç†æ­£å¸¸ä¸šåŠ¡é€»è¾‘çš„goroutineçš„CPUæ—¶é—´ã€‚

ä¸‹é¢æˆ‘ä»¬å°±æ¥é‡‡é›†ä¸€ä¸‹tcp-server-demo2-with-pprofç›®å½•ä¸‹çš„serverçš„å†…å­˜åˆ†é…é‡‡æ ·æ•°æ®ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰å€¼å¾—ä¼˜åŒ–çš„ç‚¹ã€‚

è¿™æ¬¡æˆ‘ä»¬ç›´æ¥ä½¿ç”¨go tool pprofçš„å‘½ä»¤è¡Œé‡‡é›†ä¸äº¤äº’æ¨¡å¼ã€‚åœ¨å¯åŠ¨serverå’Œclientåï¼Œæˆ‘ä»¬æ‰‹å·¥æ‰§è¡Œä¸‹é¢å‘½ä»¤è¿›è¡Œå†…å­˜åˆ†é…é‡‡æ ·æ•°æ®çš„è·å–ï¼š

```plain
$ go tool pprof http://192.168.10.18:6060/debug/pprof/allocs
Fetching profile over HTTP from http://192.168.10.18:6060/debug/pprof/allocs
Saved profile in /root/pprof/pprof.server.alloc_objects.alloc_space.inuse_objects.inuse_space.001.pb.gz
File: server
Type: alloc_space
Time: Jan 23, 2022 at 6:05pm (CST)
Entering interactive mode (type "help" for commands, "o" for options)
```

æ•°æ®è·å–åˆ°åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨go tool pprofæä¾›çš„å‘½ä»¤è¡Œäº¤äº’æŒ‡ä»¤ï¼Œæ¥æŸ¥çœ‹å„ä¸ªå‡½æ•°çš„å †å†…å­˜å¯¹è±¡çš„åˆ†é…æƒ…å†µï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„ä¸€ä¸ªæŒ‡ä»¤å°±æ˜¯topï¼Œæ‰§è¡Œtopåï¼Œæˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š

```plain
(pprof) top
Showing nodes accounting for 119.27MB, 97.93% of 121.79MB total
Dropped 31 nodes (cum <= 0.61MB)
Showing top 10 nodes out of 30
      flat  flat%   sum%        cum   cum%
      38MB 31.20% 31.20%    43.50MB 35.72%  github.com/bigwhite/tcp-server-demo2/packet.Decode
   28.50MB 23.40% 54.61%    28.50MB 23.40%  github.com/bigwhite/tcp-server-demo2/frame.(*myFrameCodec).Decode
      18MB 14.78% 69.39%       79MB 64.87%  main.handlePacket
   17.50MB 14.37% 83.76%    17.50MB 14.37%  bytes.Join
       9MB  7.39% 91.15%        9MB  7.39%  encoding/binary.Write
    5.50MB  4.52% 95.66%     5.50MB  4.52%  github.com/bigwhite/tcp-server-demo2/packet.(*Submit).Decode (inline)
    1.76MB  1.45% 97.11%     1.76MB  1.45%  compress/flate.NewWriter
       1MB  0.82% 97.93%        1MB  0.82%  runtime.malg
         0     0% 97.93%     1.76MB  1.45%  bufio.(*Writer).Flush
         0     0% 97.93%     1.76MB  1.45%  compress/gzip.(*Writer).Write
```

topå‘½ä»¤çš„è¾“å‡ºç»“æœé»˜è®¤æŒ‰`flat(flat%)`åˆ—ä»å¤§åˆ°å°çš„é¡ºåºè¾“å‡ºã€‚`flat`åˆ—çš„å€¼åœ¨ä¸åŒé‡‡æ ·ç±»å‹ä¸‹è¡¨ç¤ºçš„å«ä¹‰ç•¥æœ‰ä¸åŒã€‚

åœ¨CPUç±»å‹é‡‡æ ·æ•°æ®ä¸‹ï¼Œå®ƒè¡¨ç¤ºå‡½æ•°è‡ªèº«ä»£ç åœ¨æ•°æ®é‡‡æ ·è¿‡ç¨‹çš„æ‰§è¡Œæ—¶é•¿ï¼›åœ¨ä¸Šé¢çš„å †å†…å­˜åˆ†é…ç±»å‹é‡‡æ ·æ•°æ®ä¸‹ï¼Œå®ƒè¡¨ç¤ºåœ¨é‡‡ç”¨è¿‡ç¨‹ä¸­ï¼ŒæŸä¸ªå‡½æ•°ä¸­å †å†…å­˜åˆ†é…å¤§å°çš„å’Œã€‚è€Œ`flat%`åˆ—çš„å€¼è¡¨ç¤ºè¿™ä¸ªå‡½æ•°å †å†…å­˜åˆ†é…å¤§å°å å †å†…å­˜æ€»åˆ†é…å¤§å°çš„æ¯”ä¾‹ã€‚

ä»ä¸Šé¢çš„è¾“å‡ºç»“æœæ¥çœ‹ï¼Œpacket.Decodeå‡½æ•°æ’åœ¨ç¬¬ä¸€ä½ã€‚é‚£ä¹ˆï¼Œç°åœ¨æˆ‘ä»¬å°±æ¥æ·±å…¥æ¢ç©¶ä¸€ä¸‹Decodeå‡½æ•°ä¸­ç©¶ç«Ÿå“ªä¸€è¡Œä»£ç åˆ†é…çš„å †å†…å­˜é‡æœ€å¤§ã€‚æˆ‘ä»¬ä½¿ç”¨listå‘½ä»¤å¯ä»¥è¿›ä¸€æ­¥è¿›å…¥Decodeå‡½æ•°çš„æºç ä¸­æŸ¥çœ‹ï¼š

```plain
(pprof) list packet.Decode
Total: 121.79MB
ROUTINE ======================== github.com/bigwhite/tcp-server-demo2/packet.Decode in /root/baim/tcp-server-demo2-with-pprof/packet/packet.go
      38MB    43.50MB (flat, cum) 35.72% of Total
         .          .     75:	case CommandConn:
         .          .     76:		return nil, nil
         .          .     77:	case CommandConnAck:
         .          .     78:		return nil, nil
         .          .     79:	case CommandSubmit:
      38MB       38MB     80:		s := Submit{}
         .     5.50MB     81:		err := s.Decode(pktBody)
         .          .     82:		if err != nil {
         .          .     83:			return nil, err
         .          .     84:		}
         .          .     85:		return &s, nil
         .          .     86:	case CommandSubmitAck:
(pprof) 
```

æˆ‘ä»¬çœ‹åˆ°ï¼Œ`s := Submit{}`è¿™ä¸€è¡Œæ˜¯åˆ†é…å†…å­˜çš„â€œå¤§æˆ·â€ï¼Œæ¯æ¬¡æœåŠ¡ç«¯æ”¶åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯submitè¯·æ±‚æ—¶ï¼Œéƒ½ä¼šåœ¨å †ä¸Šåˆ†é…ä¸€å—å†…å­˜è¡¨ç¤ºSubmitç±»å‹çš„å®ä¾‹ã€‚

è¿™ä¸ªåœ¨ç¨‹åºå…³é”®è·¯å¾„ä¸Šçš„å †å†…å­˜å¯¹è±¡åˆ†é…ä¼šç»™GCå¸¦å»å‹åŠ›ï¼Œæˆ‘ä»¬è¦å°½é‡é¿å…æˆ–å‡å°å®ƒçš„åˆ†é…é¢‘åº¦ï¼Œä¸€ä¸ªå¯è¡Œçš„åŠæ³•æ˜¯å°½é‡é‡ç”¨å¯¹è±¡ã€‚

åœ¨Goä¸­ï¼Œä¸€æåˆ°é‡ç”¨å†…å­˜å¯¹è±¡ï¼Œæˆ‘ä»¬å°±ä¼šæƒ³åˆ°äº† **sync.Pool**ã€‚ç®€å•æ¥è¯´ï¼Œsync.Poolå°±æ˜¯å®˜æ–¹å®ç°çš„ä¸€ä¸ªå¯å¤ç”¨çš„å†…å­˜å¯¹è±¡æ± ï¼Œä½¿ç”¨sync.Poolï¼Œæˆ‘ä»¬å¯ä»¥å‡å°‘å †å¯¹è±¡åˆ†é…çš„é¢‘åº¦ï¼Œè¿›è€Œé™ä½ç»™GCå¸¦å»çš„å‹åŠ›ã€‚

æˆ‘ä»¬ç»§ç»­åœ¨tcp-server-demo3çš„åŸºç¡€ä¸Šï¼Œä½¿ç”¨sync.Poolè¿›è¡Œå †å†…å­˜å¯¹è±¡åˆ†é…çš„ä¼˜åŒ–ï¼Œæ–°ç‰ˆçš„ä»£ç æ”¾åœ¨äº†tcp-server-demo3-with-syncpoolä¸­ã€‚

æ–°ç‰ˆä»£ç ç›¸å¯¹äºtcp-server-demo3æœ‰ä¸¤å¤„æ”¹åŠ¨ï¼Œç¬¬ä¸€å¤„æ˜¯åœ¨packet.goä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªSubmitPoolå˜é‡ï¼Œå®ƒçš„ç±»å‹ä¸ºsync.Poolï¼Œè¿™å°±æ˜¯æˆ‘ä»¬çš„å†…å­˜å¯¹è±¡æ± ï¼Œæ± ä¸­çš„å¯¹è±¡éƒ½æ˜¯Submitã€‚è¿™æ ·æˆ‘ä»¬åœ¨packet.Decodeä¸­æ”¶åˆ°Submitç±»å‹è¯·æ±‚æ—¶ï¼Œä¹Ÿä¸éœ€è¦æ–°åˆ†é…ä¸€ä¸ªSubmitå¯¹è±¡ï¼Œè€Œæ˜¯ç›´æ¥ä»SubmitPoolä»£è¡¨çš„Poolæ± ä¸­å–å‡ºä¸€ä¸ªå¤ç”¨ã€‚è¿™äº›ä»£ç å˜æ›´å¦‚ä¸‹ï¼š

```plain
// tcp-server-demo3-with-syncpool/packet/packet.go
var SubmitPool = sync.Pool{
    New: func() interface{} {
        return &Submit{}
    },
}

func Decode(packet []byte) (Packet, error) {
    commandID := packet[0]
    pktBody := packet[1:]

    switch commandID {
    case CommandConn:
        return nil, nil
    case CommandConnAck:
        return nil, nil
    case CommandSubmit:
        s := SubmitPool.Get().(*Submit) // ä»SubmitPoolæ± ä¸­è·å–ä¸€ä¸ªSubmitå†…å­˜å¯¹è±¡
        err := s.Decode(pktBody)
        if err != nil {
            return nil, err
        }
        return s, nil
    case CommandSubmitAck:
        s := SubmitAck{}
        err := s.Decode(pktBody)
        if err != nil {
            return nil, err
        }
        return &s, nil
    default:
        return nil, fmt.Errorf("unknown commandID [%d]", commandID)
    }
}
```

ç¬¬äºŒå¤„å˜æ›´æ˜¯åœ¨Submitå¯¹è±¡ç”¨å®Œåï¼Œå½’è¿˜å›Poolæ± ï¼Œæœ€ç†æƒ³çš„â€œå½’è¿˜åœ°ç‚¹â€æ˜¯åœ¨mainåŒ…çš„handlePacketå‡½æ•°ä¸­ï¼Œè¿™é‡Œå¤„ç†å®ŒSubmitæ¶ˆæ¯åï¼ŒSubmitå¯¹è±¡å°±æ²¡æœ‰ä»€ä¹ˆç”¨äº†ï¼Œäºæ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œå°†å…¶å½’è¿˜ç»™Poolæ± ï¼Œä»£ç å¦‚ä¸‹ï¼š

```plain
// tcp-server-demo3-with-syncpool/cmd/server/main.go

func handlePacket(framePayload []byte) (ackFramePayload []byte, err error) {
    var p packet.Packet
    p, err = packet.Decode(framePayload)
    if err != nil {
        fmt.Println("handleConn: packet decode error:", err)
        return
    }

    switch p.(type) {
    case *packet.Submit:
        submit := p.(*packet.Submit)
        submitAck := &packet.SubmitAck{
            ID:     submit.ID,
            Result: 0,
        }
        packet.SubmitPool.Put(submit) // å°†submitå¯¹è±¡å½’è¿˜ç»™Poolæ± 
        ackFramePayload, err = packet.Encode(submitAck)
        if err != nil {
            fmt.Println("handleConn: packet encode error:", err)
            return nil, err
        }
        return ackFramePayload, nil
    default:
        return nil, fmt.Errorf("unknown packet type")
    }
}
```

æ”¹å®Œè¿™ä¸¤å¤„åï¼Œæˆ‘ä»¬çš„å†…å­˜åˆ†é…ä¼˜åŒ–å°±å®Œæˆäº†ã€‚

å’Œå‰é¢ä¸€æ ·ï¼Œæˆ‘ä»¬æ„å»ºä¸€ä¸‹tcp-server-demo3-with-syncpoolç›®å½•ä¸‹çš„æœåŠ¡ç«¯ï¼Œå¹¶ä½¿ç”¨å®¢æˆ·ç«¯å¯¹å…¶è¿›è¡Œä¸€æ¬¡å‹æµ‹ï¼Œå‹æµ‹å‡ åˆ†é’Ÿåï¼Œæˆ‘ä»¬å°±èƒ½çœ‹åˆ°å¦‚ä¸‹çš„ç»“æœï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/35/5b/35de98199d21418f3f2182a67a2a8a5b.png?wh=1920x936)

ä»é‡‡é›†çš„æ€§èƒ½æŒ‡æ ‡æ¥çœ‹ï¼Œä¼˜åŒ–åçš„æœåŠ¡ç«¯çš„å¤„ç†èƒ½åŠ›å¹³å‡å¯ä»¥è¾¾åˆ°29.2w/sï¼Œè¿™ç›¸æ¯”äºä¸Šä¸€æ¬¡ä¼˜åŒ–åçš„27w/sï¼Œåˆå°å¹…æå‡äº†8%å·¦å³ã€‚

åˆ°è¿™é‡Œï¼ŒæŒ‰ç…§æˆ‘ä»¬åœ¨è¿™ä¸€è®²å¼€å¤´å¤„æ‰€è®²çš„æ€§èƒ½ä¼˜åŒ–å¾ªç¯ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†ä¸€è½®ä¼˜åŒ–äº†ï¼Œå¹¶ä¸”å–å¾—äº†ä¸é”™çš„æ•ˆæœï¼Œç°åœ¨å¯ä»¥å°†æœ€æ–°çš„æ€§èƒ½æŒ‡æ ‡ä½œä¸ºæ–°ä¸€ç‰ˆçš„æ€§èƒ½åŸºå‡†äº†ã€‚

è‡³äºæ˜¯å¦è¦ç»§ç»­æ–°ä¸€è½®çš„ä¼˜åŒ–ï¼Œè¿™å°±è¦çœ‹å½“å‰çš„æ€§èƒ½æ˜¯å¦èƒ½æ»¡è¶³ä½ çš„è¦æ±‚äº†ã€‚å¦‚æœæ»¡è¶³ï¼Œå°±ä¸éœ€å†è¿›è¡Œæ–°çš„ä¼˜åŒ–ï¼Œå¦åˆ™ä½ è¿˜éœ€è¦ç»§ç»­ä¸€è½®æˆ–å‡ è½®ä¼˜åŒ–æ´»åŠ¨ï¼Œç›´åˆ°æ€§èƒ½æ»¡è¶³ä½ çš„è¦æ±‚ã€‚

## å°ç»“

å¥½äº†ï¼Œä»Šå¤©çš„è¯¾è®²åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œç°åœ¨æˆ‘ä»¬ä¸€èµ·æ¥å›é¡¾ä¸€ä¸‹å§ã€‚

åœ¨è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬é‡ç‚¹è®²è§£äº†å¦‚ä½•é’ˆå¯¹ä¸Šä¸€è®²å®ç°çš„ç¬¬ä¸€ç‰ˆæœåŠ¡ç«¯è¿›è¡Œä¼˜åŒ–ã€‚æˆ‘ä»¬ç»™å‡ºäº†Goç¨‹åºä¼˜åŒ–çš„å››æ­¥å¾ªç¯æ–¹æ³•ï¼Œè¿™å››æ­¥ä¾æ¬¡æ˜¯å»ºç«‹æ€§èƒ½åŸºå‡†ã€æ€§èƒ½å‰–æã€ä»£ç ä¼˜åŒ–å’Œä¸æ€§èƒ½åŸºå‡†æ¯”è¾ƒï¼Œç¡®å®šä¼˜åŒ–æ•ˆæœã€‚å¦‚æœç»è¿‡ä¸€è½®ä¼˜åŒ–ï¼ŒGoåº”ç”¨çš„æ€§èƒ½ä»ç„¶æ— æ³•è¾¾åˆ°ä½ çš„è¦æ±‚ï¼Œé‚£ä¹ˆè¿˜å¯ä»¥æŒ‰è¿™ä¸ªå¾ªç¯ï¼Œè¿›è¡Œå¤šè½®ä¼˜åŒ–ã€‚

å»ºç«‹æ€§èƒ½åŸºå‡†æ˜¯æ•´ä¸ªä¼˜åŒ–è¿‡ç¨‹çš„å‰æï¼ŒåŸºå‡†æä¾›äº†æ€§èƒ½ä¼˜åŒ–çš„èµ·ç‚¹ä¸å‚ç…§ç‰©ã€‚è€Œå»ºç«‹æ€§èƒ½åŸºå‡†çš„å‰æåˆæ˜¯å»ºç«‹è§‚æµ‹è®¾æ–½ã€‚è§‚æµ‹è®¾æ–½çš„å»ºç«‹æ–¹æ³•æœ‰å¾ˆå¤šï¼Œè¿™é‡Œæˆ‘ä»¬åŸºäºPrometheus+Grafanaçš„ç»„åˆï¼Œå®ç°äº†ä¸€ä¸ªå¯è§†åŒ–çš„è§‚æµ‹å¹³å°ã€‚åŸºäºè¿™ä¸ªå¹³å°ï¼Œæˆ‘ä»¬ä¸ºç¬¬ä¸€ç‰ˆæœåŠ¡ç«¯å®ç°å»ºç«‹äº†æ€§èƒ½åŸºå‡†ã€‚

å¦å¤–ï¼Œå‰–æGoåº”ç”¨æ€§èƒ½æœ‰å¾ˆå¤šå·¥å…·ï¼Œè€ŒGopherçš„æœ€çˆ±ä¾ç„¶æ˜¯GoåŸç”Ÿæä¾›çš„pprofï¼Œæˆ‘ä»¬å¯ä»¥ä»¥å›¾å½¢åŒ–çš„å½¢å¼æˆ–å‘½ä»¤è¡Œçš„æ–¹å¼ï¼Œæ”¶é›†å’Œå±•ç¤ºè·å–åˆ°çš„é‡‡æ ·æ•°æ®ã€‚é’ˆå¯¹æˆ‘ä»¬çš„æœåŠ¡ç«¯ç¨‹åºï¼Œæˆ‘ä»¬è¿›è¡Œäº†å¸¦ç¼“å†²çš„ç½‘ç»œI/Oä»¥åŠé‡ç”¨å†…å­˜å¯¹è±¡çš„ä¼˜åŒ–ï¼Œå–å¾—äº†å¾ˆä¸é”™çš„æ•ˆæœã€‚

## æ€è€ƒé¢˜

è¿™ä¸€è®²ä¸­ï¼Œè™½ç„¶æˆ‘ä»¬å¯¹ç¬¬ä¸€ç‰ˆæœåŠ¡ç«¯å®ç°å®æ–½äº†ä¸¤ä¸ªæœ‰æ•ˆçš„ä¼˜åŒ–ï¼Œä½†è¿™ä¸ªç¨‹åºä¾ç„¶æœ‰å¯ä¼˜åŒ–çš„ç‚¹ï¼Œä½ ä¸å¦¨æ‰¾æ‰¾ï¼Œçœ‹çœ‹è¿˜èƒ½åœ¨å“ªäº›ç‚¹ä¸Šå°å¹…æå‡æœåŠ¡ç«¯çš„æ€§èƒ½ã€‚

æ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ„Ÿå…´è¶£çš„æœ‹å‹ã€‚æˆ‘æ˜¯Tony Baiï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚

[é¡¹ç›®æºä»£ç åœ¨è¿™é‡Œï¼](https://github.com/bigwhite/publication/tree/master/column/timegeek/go-first-course/38)
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>å¤šé€‰å‚æ•°</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>åŸæœ¬ä»¥ä¸ºæœ€åçš„å®æˆ˜è¯¾åªæ˜¯å†™ä¸€ä¸ªç¨å¾®å¤§ç‚¹çš„é¡¹ç›®ã€‚ç»“æœï¼Œæ°æ°ç›¸åï¼Œè€å¸ˆä½¿ç”¨ä¸€ä¸ªæå°çš„é¡¹ç›®ï¼Œå¸¦ç€èµ°äº†ä¸€é Go å¼€å‘å’Œè°ƒä¼˜çš„è¿‡ç¨‹ï¼Œè¿™ç§æ–¹æ³•è®ºæˆ–è€…æ€æƒ³çš„ä¼ æˆï¼ŒçœŸçš„æ¯”å•çº¯å†™ä»£ç å¯ä»¥å­¦åˆ°æ›´å¤šï¼Œæ˜¯åœ¨å…¶ä»–ä¹¦ç±æˆ–ä¸“æ æ‰€æ²¡æœ‰çš„ï¼Œå¾ˆå–œæ¬¢è¿™ç§æ–¹å¼ï¼æ„Ÿè°¢è€å¸ˆï¼

ç®€å•æ€»ç»“ä¸‹ï¼Œæœ€åå®æˆ˜è¯¾æ ¸å¿ƒçš„å†…å®¹ï¼š
1. Go å¼€å‘çš„æµç¨‹ç»“åˆè‡ªå·±çš„å‡ ä¸ªæœˆçš„ç»å†ï¼Œæ€»ç»“ä¸‹ï¼šï¼ˆ1ï¼‰é¦–å…ˆæ˜¯æ˜ç¡®é—®é¢˜æˆ–éœ€æ±‚ï¼Œä¹‹åæ ¹æ®é—®é¢˜æˆ–éœ€æ±‚ï¼Œæç‚¼å‡ºéœ€è¦ç”¨åˆ°çš„æŠ€æœ¯ç‚¹ï¼Œæ¯”å¦‚ socket æŠ€æœ¯ï¼›ï¼ˆ2ï¼‰ä¹‹åï¼Œå»è°ƒç ”ç›¸å…³çš„æŠ€æœ¯æˆ–ç›¸å…³é¡¹ç›®ï¼›ï¼ˆ3ï¼‰æœ€åå†™è®¾è®¡æ–¹æ¡ˆï¼›ï¼ˆ4ï¼‰æ ¹æ®è®¾è®¡æ–¹æ¡ˆï¼Œå®ç°ä»£ç ã€‚ï¼ˆPSï¼šè¿™ä¸ªè¿‡ç¨‹å¯ä»¥å¾ªç¯è¿­ä»£ï¼‰
2. Go ç¨‹åºä¼˜åŒ–çš„è¿‡ç¨‹ï¼šï¼ˆ1ï¼‰é¦–å…ˆæ˜¯æ˜ç¡®è¡¡é‡æŒ‡æ ‡ï¼Œæ¯”å¦‚æŸä¸ªå‡½æ•°çš„æ‰§è¡Œæ—¶é—´ã€ç¨‹åºåœ¨ä¸€å®šæ—¶é—´å†…å¯ä»¥å¤„ç†çš„è¯·æ±‚é‡ã€æ¥å—çš„æ•°æ®åŒ…æ•°é‡ç­‰ç­‰ï¼ˆå¹¶è·å–é¦–æ¬¡çš„æŒ‡æ ‡æƒ…å†µï¼‰ï¼›ï¼ˆ2ï¼‰ä¹‹åï¼Œä½¿ç”¨ pprof è·å– CPUã€å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œå¹¶åˆ†æä½¿ç”¨æƒ…å†µï¼Œå¾—åˆ°æ•´ä¸ªç¨‹åºçš„ç“¶é¢ˆæ‰€åœ¨ï¼›ï¼ˆ3ï¼‰æœ€åï¼Œæ ¹æ®åˆ†æå¾—åˆ°çš„ç»“æœï¼Œä¼˜åŒ–æºç ï¼›ï¼ˆ4ï¼‰ä¼˜åŒ–æºç åï¼Œå†æ¬¡æµ‹è¯•è¡¡é‡æŒ‡æ ‡ï¼Œæ ¹æ®æ–°è·å–çš„æŒ‡æ ‡æƒ…å†µï¼Œå†³å®šæ˜¯å¦ç»§ç»­åˆ†æå’Œä¼˜åŒ–ã€‚

å¦å¤–ï¼Œå¯ä»¥ç»§ç»­ä¼˜åŒ–ç‚¹çš„åº”è¯¥å°±æ˜¯ä¸ Submit ä½¿ç”¨ç›¸åŒçš„åœ°æ–¹ï¼Œæ¯”å¦‚ submitAckã€‚</p>2022-05-05</li><br/><li><span>ç½—æ°</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>ä»€ä¹ˆæ—¶å€™èƒ½å’Œè€å¸ˆä¸€æ ·æœ‰å¦‚æ­¤ä¸°å¯Œçš„ä¼˜åŒ–ç»éªŒå‘¢ï¼Œè®²çš„éå¸¸ç²¾å½©ã€‚</p>2022-01-28</li><br/><li><span>è èå¹é›ªâ€”Code</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç²¾å½©çš„ä¼˜åŒ–è¿‡ç¨‹ï¼æ„Ÿè°¢è€å¸ˆè¿™ä¸ªä¸“æ ï¼Œå¾ˆå–œæ¬¢è¿™ç§è®²è§£çŸ¥è¯†ç‚¹çš„æ–¹å¼ï¼ç¬¬ä¸€éç»“æŸï¼Œç¬¬äºŒéå¼€å§‹è®°ç¬”è®°åˆ†ææ¯ä¸€è¡Œä»£ç ï¼Œç¬¬ä¸‰éå†è¿‡ä¸‹è€å¸ˆçš„ä¸¤æœ¬ä¹¦ï¼Œåº”è¯¥ç®—æ˜¯å®Œå…¨å…¥é—¨goäº†</p>2022-09-14</li><br/><li><span>éªšåŠ¨</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>macä¸‹çš„é…ç½®å‚è€ƒï¼š
1. macä¸èƒ½ç”¨hostï¼Œéœ€è¦ç”¨portsç«¯å£æ˜ å°„
version: &quot;3.2&quot;
services:
  prometheus:
    container_name: prometheus
    image: prom&#47;prometheus:latest
    ports:
      - &quot;9090:9090&quot;
    volumes:
      - .&#47;conf&#47;tcp-server-prometheus.yml:&#47;etc&#47;prometheus&#47;prometheus.yml
      - &#47;etc&#47;localtime:&#47;etc&#47;localtime
    restart: on-failure

  grafana:
    container_name: grafana
    image: grafana&#47;grafana:latest
    restart: on-failure
    ports:
      - &quot;3000:3000&quot;
    volumes:
      - &#47;etc&#47;localtime:&#47;etc&#47;localtime
      - .&#47;data&#47;grafana:&#47;var&#47;lib&#47;grafana

  node_exporter:
    image: quay.io&#47;prometheus&#47;node-exporter:latest
    restart: always
    container_name: node_exporter
    command:
      - &#39;--path.rootfs=&#47;host&#39;
    ports:
      - &quot;9100:9100&quot;
    volumes:
      - &#47;Users&#47;zouqiang&#47;Documents&#47;docker&#47;monitor&#47;data&#47;node_exporter

2. grafanaä¸Šé…ç½®prometheusæ•°æ®æºæ—¶ï¼Œurl:  http:&#47;&#47;æœ¬æœºip:ç«¯å£ , ä¸è¦ç”¨http:&#47;&#47;localhost:9090è¿™ç§æ–¹å¼ï¼Œå› ä¸ºå®¹å™¨é—´çš„localhostä¸æ˜¯åŒä¸€ä¸ªlocalhost, ç”¨ä¸»æœºåç›´æ¥æŒ‡å®šå³å¯</p>2022-08-19</li><br/><li><span>è”«å·´çš„å°ç™½èœ</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œæœ‰ä¸ªé—®é¢˜ï¼Œsync.poolä¹Ÿå°±æ˜¯å†…å­˜æ± é‚£å—ï¼Œè¯·æ±‚è¿‡æ¥ä¹‹åï¼Œæˆ‘çœ‹åˆ°æ˜¯ç›´æ¥æ”¾åˆ°å†…å­˜æ± ï¼Œæ²¡æœ‰ç½®ç©ºæ•°æ®ï¼Œé‚£ä¹ˆåœ¨å†…å­˜æ± è·å–çš„æ—¶å€™ï¼Œä¼šä¸ä¼šå‡ºç°æ•°æ®é”™ä¹±çš„é—®é¢˜å‘¢ï¼Ÿ</p>2022-06-19</li><br/><li><span>é¡·</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>bufio.Reader.Read æ–¹æ³•å†…éƒ¨ï¼Œæ¯æ¬¡ä» net.Conn å°è¯•è¯»å–å…¶å†…éƒ¨ç¼“å­˜å¤§å°çš„æ•°æ®ï¼Œè€Œä¸æ˜¯ç”¨æˆ·ä¼ å…¥çš„å¸Œæœ›è¯»å–çš„æ•°æ®å¤§å° -----------è¿™é‡Œæœ‰ä¸ªç–‘é—®ï¼Œserverç«¯for å¾ªç¯é‡Œä¸æ˜¯æ¯æ¬¡éƒ½æ˜¯é‡æ–°è¯»å–åˆ°çš„connä¼ è¿‡æ¥çš„æ•°æ®å—ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡clientç«¯å‘é€è¿‡æ¥çš„payloadéƒ½æ˜¯è¦æœ‰ä¸€æ¬¡å¿…è¦çš„è¯»å–ï¼Œä¸ºä»€ä¹ˆä¼šå‡å°‘è¯»å–çš„æ¬¡æ•°å‘¢ï¼Ÿ</p>2022-04-14</li><br/><li><span>Geek_25f93f</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œçœ‹ç½‘ä¸Šæœ‰ç§è¯´æ³•ã€‚æ± åŒ–è¿™ç§äº‹æƒ…ï¼ŒJavaå¾ˆæ—©å¾ˆæ—©ä¹‹å‰ä¹Ÿåšè¿‡ ç°åœ¨éƒ½ä¸æ€ä¹ˆæäº†ï¼Œgoçš„ç¼–è¯‘å™¨å¤ªå¼±äº†ï¼Ÿ</p>2022-06-26</li><br/><li><span>Mew151</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è€å¸ˆï¼Œæƒ³é—®ä¸€ä¸‹ï¼Œ tcp-server-demo2-with-pprof çš„ä»£ç ï¼Œæˆ‘åœ¨æˆ‘çš„ Mac ä¸Šåˆ†åˆ«å¯åŠ¨ server å’Œ client ï¼Œè¿‡äº†ä¸€æ®µæ—¶é—´å server æŠ¥å¦‚ä¸‹é”™è¯¯ï¼ˆæ‰“å°æ˜¯æˆ‘åŠ äº†äº›è¯¦ç»†æ—¥å¿—ä¹‹åçš„ï¼‰ï¼š

metrics server start ok(*:8889)
server start ok(on *:8888)
[2022-10-13 13:41:54.562] io.ReadFull: read tcp 127.0.0.1:8888-&gt;127.0.0.1:49689: read: operation timed out  totalLen is 28, n is 20
[2022-10-13 13:41:54.562] handleConn: frame decode error: read tcp 127.0.0.1:8888-&gt;127.0.0.1:49689: read: operation timed out
[2022-10-13 13:41:55.545] io.ReadFull: read tcp 127.0.0.1:8888-&gt;127.0.0.1:49754: read: operation timed out  totalLen is 32, n is 15
[2022-10-13 13:41:55.545] handleConn: frame decode error: read tcp 127.0.0.1:8888-&gt;127.0.0.1:49754: read: operation timed out
[2022-10-13 13:41:55.590] io.ReadFull: read tcp 127.0.0.1:8888-&gt;127.0.0.1:49729: read: operation timed out  totalLen is 31, n is 26
...

è¯·é—®è¿™æ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿæˆ‘çœ‹ç¨‹åºé‡Œä¹Ÿæ²¡æœ‰è®¾ç½® SetReadDeadline çš„åœ°æ–¹ï¼Œä¸ºä»€ä¹ˆä¼šæŠ¥è¯»è¶…æ—¶å‘¢</p>2022-10-13</li><br/><li><span>Geek_25f93f</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è€å¸ˆï¼Œè¿™ä¸ªframe.decodeè§£åŒ…è¿‡ç¨‹ä¸ºä»€ä¹ˆä¸ä¼šå‡ºç°ç²˜åŒ…çš„ç°è±¡å•Šï¼ŸæŒ‰ç†è¯´æ”¶åˆ°è¿™ä¸ªframeéƒ¨åˆ†ä¹Ÿå¯èƒ½å‡ºç°åŠåŒ…çš„æƒ…å†µå•Šï¼Œä¸ºä»€ä¹ˆæˆ‘ä¸ç®¡æ€ä¹ˆè¯• åœ¨æœåŠ¡ç«¯åŠ sleepæ—¶é—´ æˆ–è€… åŠ clientçš„å‘é€åŒ…ä½“é•¿åº¦å’Œåç¨‹æ•°é‡ï¼Œä¹Ÿæ²¡åŠæ³•è¿›å…¥ if n != int(totalLen-4) è¿™ä¸ªåˆ¤æ–­åˆ†æ”¯å‘€</p>2022-06-27</li><br/><li><span>æœ¨æœ¨</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>æˆ‘è¿™é‡ŒFrameçš„Decodeå‡½æ•°åœ¨è¯»totalLençš„æ—¶å€™ä¼šæœ‰å°æ¦‚ç‡è¯»åˆ°ä¸€ä¸ªé”™è¯¯çš„æ•°å€¼ï¼Œè¯·é—®æœ‰äººçŸ¥é“è¿™æ˜¯ä¸ºä»€ä¹ˆå—ï¼Ÿ</p>2022-03-22</li><br/><li><span>Rayjun</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¯¹äºå·¥ç¨‹å¸ˆæ¥è¯´ï¼Œè¿™ç§é‡åŒ–çš„èƒ½åŠ›éå¸¸é‡è¦ï¼Œåªæœ‰é‡åŒ–äº†æ•°æ®ï¼Œæ‰èƒ½æ‰¾åˆ°ç“¶é¢ˆï¼Œè€Œä¸æ˜¯é€šè¿‡æ„Ÿè§‰å»åˆ¤æ–­ï¼Œç™½è€å¸ˆèƒ½åˆ©ç”¨è¿™äº›å·¥å…·å°†é‡åŒ–çš„è¿‡ç¨‹è®²çš„è¿™ä¹ˆæ¸…æ™°ï¼Œå¤ªå¼ºäº†</p>2022-02-20</li><br/><li><span>$ä¾¯</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆæœ‰æ—¶é—´çš„è¯ï¼Œè¿˜èƒ½è®²è®²contextç›¸å…³çš„å†…å®¹å—ï¼Ÿ</p>2022-01-29</li><br/><li><span>Geek_0d5d37</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è€å¸ˆï¼Œæ‚¨å¥½ã€‚åœ¨docker-compose.yml æ–‡ä»¶çš„å®¹å™¨éƒ½æ²¡æœ‰çœ‹åˆ°æœ‰æ˜ å°„å®¿ä¸»æœºçš„ç«¯å£ï¼Œä¸ºä»€ä¹ˆå¯ä»¥è®¿é—®å¯¹åº”å‡ ä¸ªç«¯å£çš„å®¹å™¨äº†ã€‚  PORTS éƒ½æ˜¯ç©ºç™½çš„

$docker ps 
CONTAINER ID   IMAGE                                     COMMAND                  CREATED        STATUS        PORTS     NAMES
563d655cdf90   grafana&#47;grafana:latest                    &quot;&#47;run.sh&quot;                26 hours ago   Up 26 hours             grafana
65616d1b6d1a   prom&#47;prometheus:latest                    &quot;&#47;bin&#47;prometheus --câ€¦&quot;   26 hours ago   Up 26 hours             prometheus
b29d3fef8572   quay.io&#47;prometheus&#47;node-exporter:latest   &quot;&#47;bin&#47;node_exporter â€¦&quot;   26 hours ago   Up 26 hours             node_exporter</p>2023-05-05</li><br/><li><span>Geek_xbye50</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆè®²çš„å¤ªç²¾å½©ï¼å¾ˆå–œæ¬¢è€å¸ˆè®²è¯¾ï¼æœŸå¾…åç»­çš„è¯¾ç¨‹</p>2023-02-23</li><br/><li><span>å†›</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>network_mode: hoståœ¨macä¸ç”Ÿæ•ˆï¼Œæ”¹äº†portsæ˜ å°„çš„æ–¹å¼

The host networking driver only works on Linux hosts, and is not supported on Docker Desktop for Mac, Docker Desktop for Windows, or Docker EE for Windows Server.</p>2022-07-04</li><br/>
</ul>