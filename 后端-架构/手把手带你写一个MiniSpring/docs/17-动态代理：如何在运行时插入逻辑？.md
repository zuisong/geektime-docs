ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ­å±¹ã€‚ä»Šå¤©æˆ‘ä»¬ç»§ç»­æ‰‹å†™MiniSpringã€‚

ä»è¿™èŠ‚è¯¾å¼€å§‹ï¼Œæˆ‘ä»¬å°±è¦è¿›å…¥AOPç¯èŠ‚äº†ã€‚åœ¨å­¦ä¹ ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹æ˜¯AOPæ€ä¹ˆå›äº‹ã€‚

AOPï¼Œå°±æ˜¯é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAspect Orient Programmingï¼‰ï¼Œè¿™æ˜¯ä¸€ç§æ€æƒ³ï¼Œä¹Ÿæ˜¯å¯¹OOPé¢å‘å¯¹è±¡ç¼–ç¨‹çš„ä¸€ç§è¡¥å……ã€‚ä½ å¯èƒ½ä¼šæƒ³ï¼šæ—¢ç„¶å·²ç»å­˜åœ¨OOPé¢å‘å¯¹è±¡ç¼–ç¨‹äº†ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦AOPé¢å‘åˆ‡é¢ç¼–ç¨‹å‘¢ï¼Ÿ

è¿™æ˜¯å› ä¸ºåœ¨è®¸å¤šåœºæ™¯ä¸‹ï¼Œä¸€ä¸ªç±»çš„æ–¹æ³•ä¸­ï¼Œé™¤äº†ä¸šåŠ¡é€»è¾‘ï¼Œé€šå¸¸è¿˜ä¼šåŒ…æ‹¬å…¶ä»–æ¯”è¾ƒé‡è¦ä½†åˆä¸ç®—ä¸»ä¸šåŠ¡é€»è¾‘çš„ä¾‹è¡Œæ€§é€»è¾‘ä»£ç ï¼Œæ¯”å¦‚å¸¸è§çš„æ—¥å¿—åŠŸèƒ½ï¼Œå®ƒä¸å½±å“æˆ‘ä»¬çš„ä¸»ä¸šåŠ¡é€»è¾‘ï¼Œä½†åˆèƒ½åœ¨å¿…è¦æ—¶å®šä½é—®é¢˜ï¼Œå‡ ä¹æ¯ä¸€ä¸ªä¸šåŠ¡æ–¹æ³•ä¸­éƒ½éœ€è¦ã€‚åˆæ¯”å¦‚æƒé™æ£€æŸ¥ã€äº‹åŠ¡å¤„ç†ï¼Œè¿˜æœ‰æ€§èƒ½ç›‘æ§ç­‰ç­‰ï¼Œéƒ½æ˜¯è¿™ç§æƒ…å†µã€‚

æ˜¾è€Œæ˜“è§ï¼Œæ—¥å¿—è¿™ç±»ä¾‹è¡Œæ€§é€»è¾‘ï¼Œåœ¨ä»»ä½•ä¸€ä¸ªä¸šåŠ¡æ–¹æ³•å®ç°ä¸­éƒ½æ˜¯éœ€è¦çš„ã€‚å¦‚æœç®€å•åœ°å°†è¿™äº›ä»£ç å†™åœ¨ä¸šåŠ¡æ–¹æ³•ä¸­ï¼Œä¼šå‡ºç°ä¸¤ä¸ªåæœï¼Œç¬¬ä¸€ï¼Œæˆ‘ä»¬å°±ä¼šå°†æ—¥å¿—ä¹‹ç±»çš„ä»£ç é‡å¤åœ°ç¼–å†™å¤šæ¬¡ï¼›ç¬¬äºŒï¼Œä¸€ä¸ªä¸šåŠ¡æ–¹æ³•ä¸­ä¼šåŒ…å«å¾ˆå¤šè¡Œä¾‹è¡Œä»£ç ï¼Œå»çœ‹æºä»£ç ä¼šå‘ç°æ–¹æ³•ä¸­å¤šæ•°è¯­å¥ä¸æ˜¯åœ¨åšä¸šåŠ¡å¤„ç†ã€‚

æœ‰ä¸“ä¸šè¿›å–å¿ƒçš„ç¨‹åºå‘˜å°±ä¼šæ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œ**æœ‰æ²¡æœ‰åŠæ³•å°†è¿™äº›ä¾‹è¡Œæ€§é€»è¾‘å•ç‹¬æŠ½å–å‡ºæ¥ï¼Œç„¶ååœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™åŠ¨æ€æ’å…¥åˆ°ä¸šåŠ¡é€»è¾‘ä¸­å‘¢ï¼Ÿ**æ­£æ˜¯å› ä¸ºè¿™ä¸ªç–‘é—®ï¼ŒAOPåº”è¿è€Œç”Ÿäº†ã€‚è¿™ä¸ªé—®é¢˜å¬èµ·æ¥ä¼¼ä¹æ— è§£ï¼Œç¨‹åºåœ¨è¿è¡Œæ—¶æ”¹å˜ç¨‹åºæœ¬èº«ï¼Œä¼¼ä¹æœ‰ç‚¹ä¸å¯æ€è®®ã€‚æˆ‘ä»¬ç ”ç©¶ä¸€ä¸‹Javaï¼Œå°±ä¼šæƒŠå¥‡åœ°å‘ç°ï¼ŒJavaé‡Œé¢æ—©å°±ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ‰‹æ®µï¼š**åŠ¨æ€ä»£ç†**ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒæ¥å¼€å±•æˆ‘ä»¬çš„å·¥ä½œã€‚

## ä»£ç†æ¨¡å¼

æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥ï¼Œå…ˆä»ä»£ç†è®²èµ·ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/5e/4c/5e31827e2dec92103754abfc45f67a4c.png?wh=1920x1062 "GoFçš„ã€Šè®¾è®¡æ¨¡å¼ã€‹ä¸€ä¹¦ä¸­çš„ä»£ç†æ¨¡å¼ç±»å›¾")

çœ‹å›¾ï¼Œæˆ‘ä»¬çŸ¥é“çœŸæ­£å¹²æ´»å„¿çš„ç±»æ˜¯RealSubjectï¼Œå…·ä½“åˆ™æ˜¯ç”±DoAction()æ‰§è¡Œä»»åŠ¡ã€‚Proxyä½œä¸ºä»£ç†æä¾›ä¸€ä¸ªåŒæ ·çš„DoAction()ï¼Œç„¶åè°ƒç”¨RealSubjectçš„DoAction()ã€‚å®ƒä»¬éƒ½å®ç°Subjectæ¥å£ï¼Œè€ŒClientåº”ç”¨ç¨‹åºæ“ä½œçš„æ˜¯Subject æ¥å£ã€‚

ç®€å•è¯´æ¥ï¼Œå°±æ˜¯åœ¨Clientåº”ç”¨ç¨‹åºä¸çœŸæ­£çš„æœåŠ¡ç¨‹åºRealSubjectä¹‹é—´å¢åŠ äº†ä¸€ä¸ªProxyã€‚

æˆ‘ä»¬ä¸¾ä¾‹è¯´æ˜ï¼Œå…ˆå®šä¹‰ä¸€ä¸ªæœåŠ¡ç±»æ¥å£ã€‚

```plain
public interface Subject {
	String doAction(String name);
}
```

å†å®šä¹‰å…·ä½“çš„æœåŠ¡ç±»ã€‚

```plain
public class RealSubject implements Subject {
	public String doAction(String name) {
		System.out.println("real subject do action "+name);
		return "SUCCESS";
	}
}
```

æœ€åå†å®šä¹‰ä¸€ä¸ªä»£ç†ç±»ã€‚

```plain
public class ProxySubject implements Subject {
	Subject realsubject;
	public ProxySubject() {
		this.realsubject = new RealSubject();
	}
	public String doAction(String name) {
		System.out.println("proxy control");
		String rtnValue = realsubject.doAction(name);
		return "SUCCESS";
	}
}
```

é€šè¿‡ä»£ç æˆ‘ä»¬çœ‹åˆ°ï¼Œä»£ç†ç±»å†…éƒ¨åŒ…å«äº†ä¸€ä¸ªçœŸæ­£çš„æœåŠ¡ç±»ï¼Œè€Œä»£ç†ç±»ç»™å¤–éƒ¨ç¨‹åºæä¾›äº†å’ŒçœŸæ­£çš„æœåŠ¡ç±»åŒæ ·çš„æ¥å£ã€‚å½“å¤–éƒ¨åº”ç”¨ç¨‹åºè°ƒç”¨ä»£ç†ç±»çš„æ–¹æ³•æ—¶ï¼Œä»£ç†ç±»å†…éƒ¨å®é™…ä¸Šä¼šè½¬å¤´è°ƒç”¨çœŸæ­£çš„æœåŠ¡ç±»çš„ç›¸åº”æ–¹æ³•ï¼Œç„¶åæŠŠçœŸæ­£çš„æœåŠ¡ç±»çš„è¿”å›å€¼ç›´æ¥è¿”å›ç»™å¤–éƒ¨ç¨‹åºã€‚è¿™æ ·åšå°±éšè—äº†çœŸæ­£çš„æœåŠ¡ç±»çš„å®ç°ç»†èŠ‚ã€‚

åŒæ—¶ï¼Œåœ¨è°ƒç”¨çœŸæ­£çš„æœåŠ¡æ–¹æ³•ä¹‹å‰å’Œä¹‹åï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨ä»£ç†ç±»é‡Œé¢åšä¸€ç‚¹æ‰‹è„šï¼ŒåŠ ä¸Šé¢å¤–çš„é€»è¾‘ï¼Œæ¯”å¦‚ä¸Šé¢ç¨‹åºä¸­çš„ `System.out.println("proxy control");`ï¼Œè¿™äº›é¢å¤–çš„ä»£ç ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯ä¸€äº›ä¾‹è¡Œæ€§çš„é€»è¾‘ï¼Œå¦‚æƒé™å’Œæ—¥å¿—ç­‰ã€‚

æœ€åæˆ‘ä»¬æä¾›ä¸€ä¸ªå®¢æˆ·ç¨‹åºä½¿ç”¨è¿™ä¸ªä»£ç†ç±»ã€‚

```plain
public class Client {
	public static void main(String[] args) {
		Subject subject = new ProxySubject();
		subject.doAction("Test");
	}
}
```

æ€»ç»“ä¸€ä¸‹ï¼Œä»£ç†æ¨¡å¼èƒ½å¤Ÿè®©æˆ‘ä»¬åœ¨ä¸šåŠ¡å¤„ç†ä¹‹å¤–æ·»åŠ ä¾‹è¡Œæ€§é€»è¾‘ã€‚ä½†æ˜¯è¿™ä¸ªç»å…¸çš„æ¨¡å¼åœ¨æˆ‘ä»¬è¿™é‡Œä¸èƒ½ç›´æ¥ç…§æ¬ï¼Œå› ä¸ºè¿™ä¸ªä»£ç†æ˜¯é™æ€çš„ï¼Œè¦äº‹å…ˆå‡†å¤‡å¥½ã€‚è€Œæˆ‘ä»¬éœ€è¦çš„æ˜¯åœ¨ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘æ‰§è¡Œçš„æ—¶å€™ï¼ŒåŠ¨æ€æ’å…¥ä¾‹è¡Œæ€§é€»è¾‘ï¼Œä¸éœ€è¦äº‹å…ˆæ‰‹å·¥é™æ€åœ°å‡†å¤‡è¿™äº›ä»£ç†ç±»ã€‚è§£å†³æ–¹æ¡ˆå°±æ˜¯**Javaä¸­çš„åŠ¨æ€ä»£ç†æŠ€æœ¯ã€‚**

## åŠ¨æ€ä»£ç†

Javaæä¾›çš„åŠ¨æ€ä»£ç†å¯ä»¥å¯¹æ¥å£è¿›è¡Œä»£ç†ï¼Œåœ¨ä»£ç†çš„è¿‡ç¨‹ä¸­ä¸»è¦åšä¸‰ä»¶äº‹ã€‚

1. å®ç°InvocationHandleræ¥å£ï¼Œé‡å†™æ¥å£å†…éƒ¨å”¯ä¸€çš„æ–¹æ³•invokeã€‚
2. ä½¿ç”¨Proxyç±»ï¼Œé€šè¿‡newProxyInstanceï¼Œåˆå§‹åŒ–ä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚
3. é€šè¿‡ä»£ç†å¯¹è±¡ï¼Œä»£ç†å…¶ä»–ç±»ï¼Œå¯¹è¯¥ç±»è¿›è¡Œå¢å¼ºå¤„ç†ã€‚

è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä¸¾ä¾‹è¯´æ˜ã€‚é¦–å…ˆå®šä¹‰ä¸€ä¸ªIActionæ¥å£ã€‚

```java
package com.test.service;
public interface IAction {
   void doAction();
}
```

æä¾›ä¸€ä¸ªå…·ä½“å®ç°ç±»ã€‚

```java
package com.test.service;
public class Action1 implements IAction {
   @Override
   public void doAction() {
      System.out.println("really do action");
   }
}
```

æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªDynamicProxyç±»ï¼Œç”¨æ¥å……å½“ä»£ç†å¯¹è±¡çš„ç±»ã€‚

```java
package com.test.service;
public class DynamicProxy {
   private Object subject = null; 
   
   public DynamicProxy(Object subject) {
         this.subject = subject;
   }
   
   public Object getProxy() {
      return Proxy.newProxyInstance(DynamicProxy.class
            .getClassLoader(), subject.getClass().getInterfaces(),
            new InvocationHandler() {
         public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
            if (method.getName().equals("doAction")) {
                System.out.println("before call real object........");
                return method.invoke(subject, args); 
            }
            return null;
         }
      });
   }
}
```

é€šè¿‡è¿™ä¸ªç±»çš„å®ç°ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Proxyç±»ï¼Œè°ƒç”¨newProxyInstanceæ–¹æ³•æ„å»ºIActionæ¥å£çš„ä»£ç†å¯¹è±¡ï¼Œè€Œä¸”é‡å†™äº†InvocationHandleræ¥å£ä¸­çš„invokeæ–¹æ³•ã€‚åœ¨é‡å†™çš„æ–¹æ³•ä¸­æˆ‘ä»¬åˆ¤æ–­æ–¹æ³•åç§°æ˜¯å¦ä¸æ¥å£ä¸­çš„doActionæ–¹æ³•ä¿æŒä¸€è‡´ï¼ŒéšååŠ ä¸Šä¾‹è¡Œæ€§é€»è¾‘ï¼ˆprintè¯­å¥ï¼‰ï¼Œæœ€åé€šè¿‡åå°„è°ƒç”¨æ¥å£IActionä¸­çš„doActionæ–¹æ³•ã€‚

é€šè¿‡è¿™ä¸ªæ“ä½œï¼Œä¾‹è¡Œæ€§é€»è¾‘å°±åœ¨ä¸šåŠ¡ç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼ŒåŠ¨æ€åœ°æ·»åŠ ä¸Šå»äº†ã€‚

æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•ç¨‹åºï¼Œå°±èƒ½ç›´è§‚æ„Ÿå—åˆ°ä»£ç†çš„æ•ˆæœäº†ã€‚

```java
package com.test.controller;
public class HelloWorldBean {
    @Autowired
    IAction action;
  
    @RequestMapping("/testaop")
    public void doTestAop(HttpServletRequest request, HttpServletResponse response) {
     DynamicProxy proxy = new DynamicProxy(action);
     IAction p = (IAction)proxy.getProxy();
     p.doAction();
     
     String str = "test aop, hello world!";
     try {
        response.getWriter().write(str);
     } catch (IOException e) {
        e.printStackTrace();
     }
  }
}
```

è¿è¡Œè¿™ä¸ªç¨‹åºï¼Œè¿”å›å†…å®¹æ˜¯â€œtest aopï¼Œhello worldï¼â€ã€‚è¿™ä¸ªæ—¶å€™æŸ¥çœ‹å‘½ä»¤è¡Œé‡Œçš„å†…å®¹ï¼Œä½ å°±ä¼šå‘ç°è¿˜æœ‰ä¸¤è¡Œè¾“å‡ºã€‚

```java
before call real object........
really do action
```

ç¬¬ä¸€è¡Œæ˜¯ä»£ç†å¯¹è±¡ä¸­çš„è¾“å‡ºï¼Œç¬¬äºŒè¡Œæ˜¯Action1ä¸­doActionæ–¹æ³•çš„å®ç°ã€‚  
æ ¹æ®è¿™ä¸ªè¾“å‡ºé¡ºåºæˆ‘ä»¬å‘ç°ï¼Œè¿™ä¸ªä»£ç†å¯¹è±¡è¾¾åˆ°äº†ä»£ç†çš„æ•ˆæœï¼Œåœ¨è°ƒç”¨IActionçš„å…·ä½“å®ç°ç±»ä¹‹å‰è¿›è¡Œäº†é¢å¤–çš„æ“ä½œï¼Œä»è€Œå¢å¼ºäº†ä»£ç†ç±»ã€‚è€Œè¿™ä¸ªä»£ç†æ˜¯æˆ‘ä»¬åŠ¨æ€å¢åŠ çš„ï¼Œè€Œä¸æ˜¯äº‹å…ˆé™æ€åœ°æ‰‹å·¥ç¼–å†™ä¸€ä¸ªä»£ç†ç±»ã€‚

ä½†æ˜¯è¯»ä»£ç ï¼Œè¿™ç§æ–¹å¼æ˜¾ç„¶æ˜¯ä¸ç¾è§‚çš„ï¼Œéœ€è¦åœ¨ä¸šåŠ¡é€»è¾‘ç¨‹åºä¸­å†™ä¸Šï¼Œå¯¹ä»£ç çš„ä¾µå…¥æ€§å¤ªå¼ºäº†ã€‚

```java
DynamicProxy proxy = new DynamicProxy(action);
IAction p = (IAction)proxy.getProxy();
```

è¿™ä¸ªå†™æ³•è·Ÿæˆ‘ä»¬æ‰‹å·¥å†™ä¸€ä¸ªä»£ç†ç±»å®é™…ä¸Šç›¸å·®ä¸å¤šã€‚è¿™ç§ä¾µå…¥å¼çš„åšæ³•ä¸æ˜¯æˆ‘ä»¬æ¨å´‡çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç»§ç»­å‰è¿›ã€‚

## å¼•å…¥FactoryBean

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯**éä¾µå…¥å¼ç¼–ç¨‹ï¼Œ**ä¹Ÿå°±æ˜¯åº”ç”¨ç¨‹åºåœ¨ç¼–ç¨‹çš„æ—¶å€™ï¼Œå®ƒä¸åº”è¯¥æ‰‹å·¥å»åˆ›å»ºä¸€ä¸ªä»£ç†ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬æ¥çš„ä¸šåŠ¡æ¥å£ï¼ŒçœŸæ­£çš„å®ç°ç±»é…ç½®åœ¨å¤–éƒ¨ï¼Œä»£ç†ç±»ä¹Ÿæ˜¯é…ç½®åœ¨å¤–éƒ¨ã€‚

```java
@Autowired
IAction action;
   
@RequestMapping("/testaop")
public void doTestAop(HttpServletRequest request, HttpServletResponse response) {
    action.doAction();
}
```

é…ç½®å¦‚ä¸‹ï¼š

```xml
<bean id="realaction" class="com.test.service.Action1" />
<bean id="action" class="com.minis.aop.ProxyFactoryBean" >
    <property type="java.lang.Object" name="target" ref="realaction"/>
</bean>
```

ä¸šåŠ¡ç±»ä¸­è‡ªåŠ¨æ³¨å…¥çš„æ˜¯ä¸€ä¸ªactionï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢ä»£ç é‡Œçš„ProxyFactoryBeanç±»ï¼Œè¿™ä¸ªç±»å†…éƒ¨åŒ…å«äº†çœŸæ­£å¹²æ´»å„¿çš„ç±»realactionã€‚

è¿™é‡Œå°±æœ‰ä¸€ä¸ªåˆçœ‹èµ·æ¥éå¸¸å¥‡æ€ªçš„éœ€æ±‚ï¼šæ³¨å†Œçš„action beanæ˜¯ProxyFactoryBeanç±»ï¼Œè€Œä¸šåŠ¡ç¨‹åºä½¿ç”¨getBean(â€œactionâ€)çš„æ—¶å€™ï¼ŒæœŸå¾…è¿”å›çš„åˆä¸æ˜¯è¿™ä¸ªBeanæœ¬èº«ï¼Œè€Œæ˜¯å†…éƒ¨é‚£ä¸ªtargetã€‚å› ä¸ºåªæœ‰è¿™æ ·æ‰èƒ½è®©ä¸šåŠ¡ç¨‹åºå®é™…è°ƒç”¨targetä¸­çš„æ–¹æ³•ï¼Œå¤–é¢çš„è¿™ä¸ªProxyFactoryBeanå¯¹æˆ‘ä»¬æ¥è®²æ˜¯ä¸€ä¸ªå…¥å£ï¼Œè€Œä¸æ˜¯ç›®æ ‡ã€‚è¿™ä¹Ÿå°±è¦æ±‚ï¼Œå½“ä¸šåŠ¡ç¨‹åºä½¿ç”¨getBean(â€œactionâ€)æ–¹æ³•çš„æ—¶å€™ï¼Œè¿™ä¸ªProxyFactoryBeanåº”è¯¥åœ¨å†…éƒ¨è¿›è¡Œè¿›ä¸€æ­¥åœ°å¤„ç†ï¼Œæ ¹æ®targetå†åŠ¨æ€ç”Ÿæˆä¸€ä¸ªä»£ç†è¿”å›ï¼Œè¾¾åˆ°ä¾µå…¥å¼ç¼–ç¨‹ä¸­ä¸‹é¢è¿™ä¸¤å¥è¯çš„æ•ˆæœã€‚

```java
DynamicProxy proxy = new DynamicProxy(action);
IAction p = (IAction)proxy.getProxy();
```

ä¸Šé¢çš„æ–¹æ¡ˆï¼Œçœ‹èµ·æ¥å¥‡æ€ªï¼Œä½†æ˜¯ç¡®å®èƒ½è§£å†³åŠ¨æ€ä»£ç†çš„é—®é¢˜ã€‚

å¥½ï¼Œç°åœ¨æˆ‘ä»¬å°±æŒ‰ç…§è¿™ä¸ªæ€è·¯åŠ¨æ‰‹å»å®ç°ã€‚é¦–å…ˆæˆ‘ä»¬å‚è€ƒSpringæ¡†æ¶ï¼Œå®šä¹‰FactoryBeanæ¥å£ã€‚

ç›¸å…³ä»£ç å‚è€ƒï¼š

```java
package com.minis.beans.factory;
public interface FactoryBean<T> {
    T getObject() throws Exception;
    Class<?> getObjectType();
    default boolean isSingleton() {
        return true;
    }
}
```

ä¸»è¦çš„æ–¹æ³•å°±æ˜¯getObject()ï¼Œä»Factory Beanä¸­è·å–å†…éƒ¨åŒ…å«çš„å¯¹è±¡ã€‚  
æ¥ç€å®šä¹‰FactoryBeanRegistrySupportï¼Œæä¾›ä¸€éƒ¨åˆ†é€šç”¨çš„æ–¹æ³•ã€‚

```java
package com.minis.beans.factory.support;
public abstract class FactoryBeanRegistrySupport extends DefaultSingletonBeanRegistry{
    protected Class<?> getTypeForFactoryBean(final FactoryBean<?> factoryBean) {
        return factoryBean.getObjectType();
    }
    protected Object getObjectFromFactoryBean(FactoryBean<?> factory, String beanName) {
        Object object = doGetObjectFromFactoryBean(factory, beanName);
        try {
            object = postProcessObjectFromFactoryBean(object, beanName);
        } catch (BeansException e) {
            e.printStackTrace();
        }
        return object;
    }
    //ä»factory beanä¸­è·å–å†…éƒ¨åŒ…å«çš„å¯¹è±¡
    private Object doGetObjectFromFactoryBean(final FactoryBean<?> factory, final String beanName) {
        Object object = null;
        try {
            object = factory.getObject();
        } catch (Exception e) {
            e.printStackTrace();
        }
        return object;
    }
}
```

æœ€é‡è¦çš„æ˜¯è¿™ä¸ªæ–¹æ³•ï¼šdoGetObjectFromFactoryBean()ï¼Œä»ä¸€ä¸ªFactory Beané‡Œé¢è·å–å†…éƒ¨åŒ…å«çš„é‚£ä¸ªtargetå¯¹è±¡ã€‚

å› ä¸ºFactoryBeanRegistrySupportç»§æ‰¿äº†DefaultSingletonBeanRegistryï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥å¯ä»¥æ”¹å†™AbstractBeanFactoryï¼Œç”±åŸæœ¬ç»§æ‰¿DefaultSingletonBeanRegistryæ”¹æˆç»§æ‰¿FactoryBeanRegistrySupportï¼Œä¿ç•™åŸæœ‰åŠŸèƒ½çš„åŒæ—¶å¢åŠ äº†åŠŸèƒ½æ‰©å±•ã€‚

æˆ‘ä»¬é‡ç‚¹è¦ä¿®æ”¹æ ¸å¿ƒçš„getBean()æ–¹æ³•ã€‚

```java
package com.minis.beans.factory.support;
public abstract class AbstractBeanFactory extends FactoryBeanRegistrySupport implements ConfigurableBeanFactory,BeanDefinitionRegistry{
   public Object getBean(String beanName) throws BeansException{
      Object singleton = this.getSingleton(beanName);
      if (singleton == null) {
         singleton = this.earlySingletonObjects.get(beanName);
         if (singleton == null) {
            System.out.println("get bean null -------------- " + beanName);
            BeanDefinition bd = beanDefinitionMap.get(beanName);
            if (bd != null) {
               singleton=createBean(bd);
               this.registerBean(beanName, singleton);
               //beanpostprocessor
               //step 1 : postProcessBeforeInitialization
               applyBeanPostProcessorsBeforeInitialization(singleton, beanName);
               //step 2 : init-method
               if (bd.getInitMethodName() != null && !bd.getInitMethodName().equals("")) {
                  invokeInitMethod(bd, singleton);
               }
               //step 3 : postProcessAfterInitialization
               applyBeanPostProcessorsAfterInitialization(singleton, beanName);
            }
            else {
               return null;
            }
         }
      }
      else {
      }
      //å¤„ç†factorybean
      if (singleton instanceof FactoryBean) {
         return this.getObjectForBeanInstance(singleton, beanName);
      }
      else {
      }
      return singleton;
   }

```

æˆ‘ä»¬çœ‹åˆ°åœ¨getBean()è¿™ä¸€æ ¸å¿ƒæ–¹æ³•ä¸­ï¼ŒåŸæœ‰çš„é€»è¾‘å¤„ç†å®Œæ¯•åï¼Œæˆ‘ä»¬æ–°å¢ä¸‹é¢è¿™ä¸€æ®µã€‚

```java
//process Factory Bean
if (singleton instanceof FactoryBean) {
   return this.getObjectForBeanInstance(singleton, beanName);
}
```

æ ¹æ®ä»£ç å®ç°å¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œå¢åŠ äº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœBeanå¯¹è±¡æ˜¯FactoryBeanç±»å‹æ—¶ï¼Œåˆ™è°ƒç”¨getObjectForBeanInstanceæ–¹æ³•ã€‚

```java
protected Object getObjectForBeanInstance(Object beanInstance, String beanName) {
    // Now we have the bean instance, which may be a normal bean or a FactoryBean.
    if (!(beanInstance instanceof FactoryBean)) {
         return beanInstance;
    }
    Object object = null;
    FactoryBean<?> factory = (FactoryBean<?>) beanInstance;
    object = getObjectFromFactoryBean(factory, beanName);
    return object;
}
```

ä»£ç æ˜¾ç¤ºï¼ŒgetObjectForBeanInstanceåˆä¼šè°ƒç”¨doGetObjectFromFactoryBeanæ–¹æ³•ã€‚

```java
private Object doGetObjectFromFactoryBean(final FactoryBean<?> factory, final String beanName) {
    Object object = null;
    try {
        object = factory.getObject();
    } catch (Exception e) {
        e.printStackTrace();
    }
    return object;
}
```

æœ€åè½å®åˆ°äº†factory.getObject()é‡Œã€‚ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬é€šè¿‡AbstractBeanFactoryè·å–Beançš„æ—¶å€™ï¼Œå¯¹FactoryBeanè¿›è¡Œäº†ç‰¹æ®Šå¤„ç†ï¼Œè·å–åˆ°çš„å·²ç»ä¸æ˜¯FactoryBeanæœ¬èº«äº†ï¼Œè€Œæ˜¯å®ƒå†…éƒ¨åŒ…å«çš„é‚£ä¸€ä¸ªå¯¹è±¡ã€‚è€Œè¿™ä¸ªå¯¹è±¡ï¼Œä¹Ÿä¸æ˜¯çœŸæ­£åº•å±‚å¯¹åº”çš„Beanã€‚å®ƒä»ç„¶åªæ˜¯ä¸€ä¸ªä»£ç†çš„å¯¹è±¡ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚

æˆ‘ä»¬è¿™ä¸ªgetObject()åªæ˜¯FactoryBeané‡Œçš„ä¸€ä¸ªæ¥å£ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æä¾›ä¸€ä¸‹å®ƒçš„æ¥å£å®ç°â€”â€”ProxyFactoryBeanã€‚

```java
package com.minis.aop;
public class ProxyFactoryBean implements FactoryBean<Object> {
    private AopProxyFactory aopProxyFactory;
    private String[] interceptorNames;
    private String targetName;
    private Object target;
    private ClassLoader proxyClassLoader = ClassUtils.getDefaultClassLoader();
    private Object singletonInstance;
    public ProxyFactoryBean() {
        this.aopProxyFactory = new DefaultAopProxyFactory();
    }
    public void setAopProxyFactory(AopProxyFactory aopProxyFactory) {
        this.aopProxyFactory = aopProxyFactory;
    }
    public AopProxyFactory getAopProxyFactory() {
        return this.aopProxyFactory;
    }
    protected AopProxy createAopProxy() {
        return getAopProxyFactory().createAopProxy(target);
    }
    public void setInterceptorNames(String... interceptorNames) {
        this.interceptorNames = interceptorNames;
    }
    public void setTargetName(String targetName) {
        this.targetName = targetName;
    }
    public Object getTarget() {
        return target;
    }
    public void setTarget(Object target) {
        this.target = target;
    }
    @Override
    public Object getObject() throws Exception {//è·å–å†…éƒ¨å¯¹è±¡
        return getSingletonInstance();
    }
    private synchronized Object getSingletonInstance() {//è·å–ä»£ç†
        if (this.singletonInstance == null) {
            this.singletonInstance = getProxy(createAopProxy());
        }
        return this.singletonInstance;
    }
    protected Object getProxy(AopProxy aopProxy) {//ç”Ÿæˆä»£ç†å¯¹è±¡
        return aopProxy.getProxy();
    }
    @Override
    public Class<?> getObjectType() {
        return null;
    }
}
```

è¿™æ®µä»£ç çš„æ ¸å¿ƒåœ¨äºï¼ŒProxyFactoryBeanåœ¨getObject()æ–¹æ³•ä¸­ç”Ÿæˆäº†ä¸€ä¸ªä»£ç†getProxy(createAopProxy())ï¼ŒåŒæ ·ä¹Ÿæ˜¯é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ‹¿åˆ°äº†è¦ä»£ç†çš„ç›®æ ‡å¯¹è±¡ã€‚è¿™é‡Œçš„å·¥ä½œå°±æ˜¯**åˆ›å»ºåŠ¨æ€ä»£ç†**ã€‚

## åŸºäºJDKçš„å®ç°

Springä½œä¸ºä¸€ä¸ªé›„å¿ƒå‹ƒå‹ƒçš„æ¡†æ¶ï¼Œè‡ªç„¶ä¸ä¼šæŠŠè‡ªå·±å±€é™äºJDKæä¾›çš„åŠ¨æ€ä»£ç†ä¸€ä¸ªæŠ€æœ¯ä¸Šï¼Œæ‰€ä»¥ï¼Œå®ƒå†æ¬¡è¿›è¡Œäº†åŒ…è£…ï¼Œæä¾›äº†AopProxyçš„æ¦‚å¿µï¼ŒJDKåªæ˜¯å…¶ä¸­çš„ä¸€ç§å®ç°ã€‚

```java
package com.minis.aop;
public interface AopProxy {
    Object getProxy();
}
```

è¿˜å®šä¹‰äº†factoryã€‚

```java
package com.minis.aop;
public interface AopProxyFactory {
    AopProxy createAopProxy(Object target);
}
```

ç„¶åç»™å‡ºäº†åŸºäºJDKçš„å®ç°ã€‚

```java
package com.minis.aop;
public class JdkDynamicAopProxy implements AopProxy, InvocationHandler {
    Object target;
    public JdkDynamicAopProxy(Object target) {
        this.target = target;
    }
    @Override
    public Object getProxy() {
        Object obj = Proxy.newProxyInstance(JdkDynamicAopProxy.class.getClassLoader(), target.getClass().getInterfaces(), this);
        return obj;
    }
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        if (method.getName().equals("doAction")) {
            System.out.println("-----before call real object, dynamic proxy........");
            return method.invoke(target, args);
        }
        return null;
    }
}
```

```java
package com.minis.aop;
public class DefaultAopProxyFactory implements AopProxyFactory{
    @Override
    public AopProxy createAopProxy(Object target) {
		return new JdkDynamicAopProxy(target); 
    }
}
```

åœ¨è¿™ä¸ªå®ç°é‡Œï¼Œæˆ‘ä»¬ç»ˆäºçœ‹åˆ°äº†æˆ‘ä»¬æ›¾ç»ç†Ÿæ‚‰çš„Proxy.newProxyInstance()å’Œinvoke()ã€‚åˆ©ç”¨Javaçš„åŠ¨æ€ä»£ç†æŠ€æœ¯ä»£ç†äº†ç›®æ ‡å¯¹è±¡ï¼Œè€Œè¿™ä¹Ÿæ˜¯ProxyFactoryBeané‡ŒçœŸæ­£è¦è¿”å›çš„Objectã€‚

è¿™å°±æ˜¯Spring AOPçš„å®ç°åŸç†ã€‚

## æµ‹è¯•

æœ‰äº†ä¸Šé¢çš„å·¥å…·ï¼Œæˆ‘ä»¬çš„æµ‹è¯•ç¨‹åºå°±ä¸éœ€è¦å†æ‰‹åŠ¨æ„å»ºä»£ç†å¯¹è±¡äº†ï¼Œè€Œæ˜¯äº¤ç»™æ¡†æ¶æœ¬èº«å¤„ç†ã€‚è€Œæ³¨å…¥çš„å¯¹è±¡ï¼Œåˆ™é€šè¿‡é…ç½®æ–‡ä»¶æ³¨å…¥å±æ€§å€¼ã€‚

applicationContext.xmlé…ç½®ä¸­æ–°å¢ä¸€æ®µå†…å®¹ã€‚

```xml
<bean id="realaction" class="com.test.service.Action1" />
<bean id="action" class="com.minis.aop.ProxyFactoryBean" >
    <property type="java.lang.Object" name="target" ref="realaction"/>
</bean>
```

é€šè¿‡é…ç½®ï¼Œæˆ‘ä»¬åœ¨HelloWorldBeané‡Œæ³¨å…¥çš„IActionå¯¹è±¡å°±çº³å…¥äº†å®¹å™¨ç®¡ç†ä¹‹ä¸­ï¼Œå› æ­¤åç»­æµ‹è¯•çš„æ—¶å€™ï¼Œç›´æ¥ä½¿ç”¨action.doAction()ï¼Œå°±èƒ½å®ç°æ‰‹åŠ¨åˆå§‹åŒ–JDKä»£ç†å¯¹è±¡çš„æ•ˆæœã€‚

```java
package com.test.controller;
public class HelloWorldBean {
   @Autowired
   IAction action;
   
   @RequestMapping("/testaop")
   public void doTestAop(HttpServletRequest request, HttpServletResponse response) {
      action.doAction();
      
      String str = "test aop, hello world!";
      try {
         response.getWriter().write(str);
      } catch (IOException e) {
         e.printStackTrace();
      }
   }
}
```

æˆ‘ä»¬ç»ˆäºçœ‹åˆ°äº†åŠ¨æ€ä»£ç†çš„ç»“æœã€‚

## å°ç»“

è¿™èŠ‚è¯¾æˆ‘ä»¬**åˆ©ç”¨JDKåŠ¨æ€ä»£ç†æŠ€æœ¯å®ç°äº†AOPè¿™ä¸ªæ¦‚å¿µ**ã€‚

æˆ‘ä»¬ä»‹ç»äº†ä»£ç†æ¨¡å¼å®ç°çš„é™æ€ä»£ç†ï¼Œç„¶åä½¿ç”¨äº†JDKçš„åŠ¨æ€ä»£ç†æŠ€æœ¯ã€‚åœ¨ä½¿ç”¨åŠ¨æ€ä»£ç†æŠ€æœ¯çš„ç¨‹åºä»£ç ä¸­ï¼Œæˆ‘ä»¬å‘ç°å®ƒæ˜¯ä¾µå…¥å¼çš„ï¼Œä¸ç†æƒ³ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æƒ³åŠæ³•æŠŠä»£ç†é…ç½®åœ¨XMLæ–‡ä»¶é‡Œäº†ã€‚ä½†æ˜¯å¦‚æœæŒ‰ç…§åŸæœ‰çš„Beançš„å®šä¹‰ï¼Œè¿™ä¸ªé…ç½®åœ¨å¤–éƒ¨æ–‡ä»¶é‡Œçš„ä»£ç†Beanæœ¬èº«ä¸èƒ½ä»£ç†ä¸šåŠ¡ç±»ï¼Œæˆ‘ä»¬çœŸæ­£éœ€è¦çš„æ˜¯é€šè¿‡è¿™ä¸ªä»£ç†Beanæ¥åˆ›å»ºä¸€ä¸ªåŠ¨æ€ä»£ç†ï¼Œäºæ˜¯å¼•å…¥äº†FactoryBeançš„æ¦‚å¿µï¼Œä¸æ˜¯ç›´æ¥è·å–è¿™ä¸ªBeanæœ¬èº«ï¼Œè€Œæ˜¯é€šè¿‡é‡Œé¢çš„getObject()è·å–åˆ°Factory Beané‡Œé¢åŒ…å«çš„å¯¹è±¡ã€‚

è¿™æ ·å°†IoCå®¹å™¨é‡Œçš„Beanåˆ†æˆäº†ä¸¤ç±»ï¼šä¸€æ˜¯æ™®é€šçš„Beanï¼ŒäºŒæ˜¯Factory Beanã€‚åœ¨getObject()çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨JDKçš„åŠ¨æ€ä»£ç†æŠ€æœ¯åˆ›å»ºäº†ä¸€ä¸ªä»£ç†ã€‚è¿™æ ·å°±å®ç°äº†AOPã€‚

å¦å¤–ï¼ŒSpringä¸­çš„ä»£ç†æ”¯æŒJDKä»£ç†ä¸Cglibä»£ç†ä¸¤ç§ï¼Œç›®å‰MiniSpringå®šä¹‰çš„DefaultAopProxyFactoryåªæ”¯æŒJDKä»£ç†ã€‚å¦ä¸€ç§æ–¹å¼æˆ‘ç•™ä½œæ€è€ƒé¢˜ï¼Œä½ å¯ä»¥å…ˆæƒ³ä¸€æƒ³è¦æ€ä¹ˆå®ç°ã€‚

AOPè¿˜æœ‰åˆ«çš„å®ç°æ–¹æ¡ˆï¼Œæ¯”å¦‚AspectJï¼Œä¹Ÿæ¯”è¾ƒå¸¸ç”¨ï¼Œåœ¨å®é™…å·¥ç¨‹å®è·µä¸­ï¼Œä¸€èˆ¬é‡‡ç”¨çš„å°±æ˜¯AspectJï¼Œè€Œä¸æ˜¯Spring AOPï¼Œå› ä¸ºAspectJæ›´åŠ é«˜æ•ˆï¼ŒåŠŸèƒ½æ›´å¼ºã€‚æ¯”å¦‚ï¼ŒAspectJæ˜¯ç¼–è¯‘æ—¶åˆ›å»ºçš„ä»£ç†ï¼Œæ€§èƒ½é«˜åå€ä»¥ä¸Šï¼Œè€Œä¸”åˆ‡å…¥ç‚¹ä¸ä»…ä»…åœ¨æ–¹æ³•ä¸Šï¼Œè€Œæ˜¯å¯ä»¥åœ¨ç±»çš„ä»»ä½•éƒ¨åˆ†ã€‚æ‰€ä»¥AspectJæ‰æ˜¯å®Œæ•´çš„AOPè§£å†³æ–¹æ¡ˆï¼ŒSpring AOPä¸æ˜¯æˆåŠŸçš„å·¥ä¸šçº§æ–¹æ¡ˆã€‚ä¹‹æ‰€ä»¥ä¿ç•™Spring AOPï¼Œä¸€ä¸ªåŸå› æ˜¯åŸç†ç®€å•ã€åˆ©äºç†è§£ï¼Œå¦ä¸€ä¸ªæ˜¯Rod Johnsonä¸å¿æŠ›å¼ƒè‡ªå·±çš„å¿ƒè¡€ã€‚

å®Œæ•´æºä»£ç å‚è§ [https://github.com/YaleGuo/minis](https://github.com/YaleGuo/minis)

## è¯¾åé¢˜

å­¦å®Œè¿™èŠ‚è¯¾ï¼Œæˆ‘ä¹Ÿç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜ã€‚å¦‚æœMiniSpringæƒ³æ‰©å±•åˆ°æ”¯æŒCglibï¼Œç¨‹åºåº”è¯¥ä»å“ªé‡Œä¸‹æ‰‹æ”¹é€ ï¼Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ4ï¼‰</strong></div><ul>
<li><span>peter</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>Springä¸AspectJæ˜¯ä»€ä¹ˆå…³ç³»ï¼ŸAspectJæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å·¥å…·è½¯ä»¶ï¼ŒSpringä½¿ç”¨è¯¥è½¯ä»¶å®ŒæˆAOPï¼Œè¿™æ ·ç†è§£å¯¹å—ï¼Ÿ</p>2023-04-20</li><br/><li><span>é£è½»æ‰¬</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¯ä»¥åœ¨DefaultAopProxyFactoryç±»ä¸­ï¼Œè·å–AopProxyæ—¶æ”¹é€ ã€‚æ–°å¢ä¸€ä¸ªå…¥å‚ï¼ŒåŒºåˆ†æ˜¯jdkçš„æ¥å£ä»£ç†è¿˜æ˜¯cglibä»£ç†ï¼Œè¿›è€Œè¿”å›ä¸åŒçš„ä»£ç†</p>2023-05-29</li><br/><li><span>ä¸æ˜¯æ—©æ™¨ï¼Œå°±æ˜¯é»„æ˜</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>DynamicProxy proxy = new DynamicProxy(action);
 IAction p = (IAction)proxy.getProxy(); 
action.doAction();
è¿™é‡Œæ˜¯ä¸æ˜¯è¦å†™æˆp.doAction();</p>2023-04-19</li><br/><li><span>èµµæ¬£</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¿™ä¸€ç« ä¸­ï¼Œæˆ‘ä¸ªäººç†è§£åº”è¯¥æ˜¯getObjectForBeanInstance,getObjectFromFactoryBean,doGetObjectFromFactoryBean,postProcessObjectFromFactoryBeanè¿™å››ä¸ªæ–¹æ³•åº”è¯¥å†™åœ¨AbstractBeanFactory.javaé‡Œé¢</p>2024-08-06</li><br/>
</ul>