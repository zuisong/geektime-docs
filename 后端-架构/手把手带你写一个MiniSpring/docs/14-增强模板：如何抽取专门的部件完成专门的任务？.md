ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ­å±¹ï¼Œä»Šå¤©æˆ‘ä»¬ç»§ç»­æ‰‹å†™MiniSpringã€‚

ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬ä»JDBCè¿™äº›å¥—è·¯æ€§çš„ç¨‹åºæµç¨‹ä¸­æŠ½å–å‡ºäº†ä¸€ä¸ªé€šç”¨æ¨¡æ¿ã€‚ç„¶åè¿›è¡Œäº†æ‹†è§£ï¼Œå°†SQLè¯­å¥å½“ä½œå‚æ•°ä¼ å…¥ï¼Œè€ŒSQLè¯­å¥æ‰§è¡Œä¹‹åçš„ç»“æœå¤„ç†é€»è¾‘ä¹Ÿä½œä¸ºä¸€ä¸ªåŒ¿åç±»ä¼ å…¥ï¼ŒåˆæŠ½å–å‡ºäº†æ•°æ®æºçš„æ¦‚å¿µã€‚ä¸‹é¢æˆ‘ä»¬æ¥ç€ä¸ŠèŠ‚è¯¾çš„æ€è·¯ï¼Œç»§ç»­æ‹†è§£JDBCç¨‹åºã€‚

æˆ‘ä»¬ç°åœ¨è§‚å¯Ÿåº”ç”¨ç¨‹åºæ€ä¹ˆä½¿ç”¨çš„JdbcTemplateï¼Œçœ‹è¿™äº›ä»£ç ï¼Œè¿˜æ˜¯ä¼šå‘ç°å‡ ä¸ªé—®é¢˜ã€‚

1. SQLè¯­å¥å‚æ•°çš„ä¼ å…¥è¿˜æ˜¯ä¸€ä¸ªä¸ªå†™è¿›å»çš„ï¼Œæ²¡æœ‰æŠ½å–å‡ºä¸€ä¸ªç‹¬ç«‹çš„éƒ¨ä»¶è¿›è¡Œç»Ÿä¸€å¤„ç†ã€‚
2. è¿”å›çš„è®°å½•æ˜¯å•è¡Œçš„ï¼Œä¸æ”¯æŒå¤šè¡Œçš„æ•°æ®é›†ï¼Œæ‰€ä»¥èƒ½å¯¹ä¸Šå±‚åº”ç”¨ç¨‹åºæä¾›çš„APIéå¸¸æœ‰é™ã€‚
3. å¦å¤–æ¯æ¬¡æ‰§è¡ŒSQLè¯­å¥éƒ½ä¼šå»ºç«‹è¿æ¥ã€å…³é—­è¿æ¥ï¼Œæ€§èƒ½ä¼šå—åˆ°å¾ˆå¤§å½±å“ã€‚

è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬éƒ½éœ€è¦åœ¨è¿™èŠ‚è¯¾ä¸Šä¸€ä¸ªä¸ªè§£å†³ã€‚

## å‚æ•°ä¼ å…¥

å…ˆçœ‹SQLè¯­å¥å‚æ•°çš„ä¼ å…¥é—®é¢˜ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ç°åœ¨å¾€PreparedStatementä¸­ä¼ å…¥å‚æ•°æ˜¯è¿™æ ·å®ç°çš„ã€‚

```plain
	for (int i = 0; i < args.length; i++) {
		Object arg = args[i];
		if (arg instanceof String) {
			pstmt.setString(i+1, (String)arg);
		}
		else if (arg instanceof Integer) {
			pstmt.setInt(i+1, (int)arg);
		}
		else if (arg instanceof java.util.Date) {
			pstmt.setDate(i+1, new java.sql.Date(((java.util.Date)arg).getTime()));
		}
	}
```

ç®€å•åœ°è¯´ï¼Œè¿™äº›å‚æ•°éƒ½æ˜¯ä¸€ä¸ªä¸ªæ‰‹å·¥ä¼ å…¥è¿›å»çš„ã€‚ä½†æˆ‘ä»¬æƒ³è®©å‚æ•°ä¼ å…¥çš„è¿‡ç¨‹è‡ªåŠ¨åŒ–ä¸€ç‚¹ï¼Œæ‰€ä»¥ç°åœ¨æˆ‘ä»¬æ¥ä¿®æ”¹ä¸€ä¸‹ï¼ŒæŠŠJDBCé‡Œä¼ å‚æ•°çš„ä»£ç è¿›è¡ŒåŒ…è£…ï¼Œç”¨ä¸€ä¸ªä¸“é—¨çš„éƒ¨ä»¶ä¸“é—¨åšè¿™ä»¶äº‹æƒ…ï¼Œäºæ˜¯æˆ‘ä»¬å¼•å…¥**ArgumentPreparedStatementSetter**ï¼Œé€šè¿‡é‡Œé¢çš„setValues()æ–¹æ³•æŠŠå‚æ•°ä¼ è¿›PreparedStatementã€‚

```plain
package com.minis.jdbc.core;

import java.sql.PreparedStatement;
import java.sql.SQLException;

public class ArgumentPreparedStatementSetter {
	private final Object[] args; //å‚æ•°æ•°ç»„

	public ArgumentPreparedStatementSetter(Object[] args) {
		this.args = args;
	}
    //è®¾ç½®SQLå‚æ•°
	public void setValues(PreparedStatement pstmt) throws SQLException {
		if (this.args != null) {
			for (int i = 0; i < this.args.length; i++) {
				Object arg = this.args[i];
				doSetValue(pstmt, i + 1, arg);
			}
		}
	}
    //å¯¹æŸä¸ªå‚æ•°ï¼Œè®¾ç½®å‚æ•°å€¼
	protected void doSetValue(PreparedStatement pstmt, int parameterPosition, Object argValue) throws SQLException {
		Object arg = argValue;
        //åˆ¤æ–­å‚æ•°ç±»å‹ï¼Œè°ƒç”¨ç›¸åº”çš„JDBC setæ–¹æ³•   
		if (arg instanceof String) {
			pstmt.setString(parameterPosition, (String)arg);
		}
		else if (arg instanceof Integer) {
			pstmt.setInt(parameterPosition, (int)arg);
		}
		else if (arg instanceof java.util.Date) {
			pstmt.setDate(parameterPosition, new java.sql.Date(((java.util.Date)arg).getTime()));	
		}
	}
}
```

ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ ¸å¿ƒä»ç„¶æ˜¯JDBCçš„setæ–¹æ³•ï¼Œä½†æ˜¯åŒ…è£…æˆäº†ä¸€ä¸ªç‹¬ç«‹éƒ¨ä»¶ã€‚ç°åœ¨çš„ç¤ºä¾‹ç¨‹åºåªæ˜¯é’ˆå¯¹äº†Stringã€Intå’ŒDateä¸‰ç§æ•°æ®ç±»å‹ï¼Œæ›´å¤šçš„æ•°æ®ç±»å‹æˆ‘ä»¬ç•™åˆ°åé¢å†æ‰©å±•ã€‚

æœ‰äº†è¿™ä¸ªä¸“é—¨è´Ÿè´£å‚æ•°ä¼ å…¥çš„setterä¹‹åï¼Œquery()å°±ä¿®æ”¹æˆè¿™ä¸ªæ ·å­ã€‚

```plain
	public Object query(String sql, Object[] args, PreparedStatementCallback pstmtcallback) {
		Connection con = null;
		PreparedStatement pstmt = null;
		
		try {
            //é€šè¿‡data sourceæ‹¿æ•°æ®åº“è¿æ¥
			con = dataSource.getConnection();

			pstmt = con.prepareStatement(sql);
            //é€šè¿‡argumentSetterç»Ÿä¸€è®¾ç½®å‚æ•°å€¼
			ArgumentPreparedStatementSetter argumentSetter = new ArgumentPreparedStatementSetter(args);	
			argumentSetter.setValues(pstmt);
			
			return pstmtcallback.doInPreparedStatement(pstmt);
		}
		catch (Exception e) {
				e.printStackTrace();
		}
		finally {
			try {
				pstmt.close();
				con.close();
			} catch (Exception e) {		
			}
		}
		return null;
	}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä»£ç ç®€åŒ–äº†å¾ˆå¤šï¼Œæ‰‹å·¥å†™çš„ä¸€å¤§å †è®¾ç½®å‚æ•°çš„ä»£ç ä¸è§äº†ï¼Œè¿™å°±ä½“ç°äº†ä¸“é—¨çš„éƒ¨ä»¶åšä¸“é—¨çš„äº‹æƒ…çš„ä¼˜ç‚¹ã€‚

## å¯¹è¿”å›ç»“æœçš„å¤„ç†

JDBCæ¥æ‰§è¡ŒSQLè¯­å¥ï¼Œè¯´èµ·æ¥å¾ˆç®€å•ï¼Œå°±ä¸‰æ­¥ï¼Œä¸€å‡†å¤‡å‚æ•°ï¼ŒäºŒæ‰§è¡Œè¯­å¥ï¼Œä¸‰å¤„ç†è¿”å›ç»“æœã€‚å‡†å¤‡å‚æ•°å’Œæ‰§è¡Œè¯­å¥è¿™ä¸¤æ­¥æˆ‘ä»¬ä¸Šé¢éƒ½å·²ç»æŠ½å–äº†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å†ä¼˜åŒ–ä¸€ä¸‹å¤„ç†è¿”å›å€¼çš„ä»£ç ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æä¾›æ›´å¤šä¾¿æ·çš„æ–¹æ³•ã€‚

æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ç°åœ¨æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Œç¨‹åºä½“ç°åœ¨pstmtcallback.doInPreparedStatement(pstmt)è¿™ä¸ªæ–¹æ³•é‡Œï¼Œè¿™æ˜¯ä¸€ä¸ªcallbackç±»ï¼Œç”±ç”¨æˆ·ç¨‹åºè‡ªå·±ç»™å®šï¼Œä¸€èˆ¬ä¼šè¿™ä¹ˆåšã€‚

```plain
	return (User)jdbcTemplate.query(sql, new Object[]{new Integer(userid)},
		(pstmt)->{			
			ResultSet rs = pstmt.executeQuery();
			User rtnUser = null;
			if (rs.next()) {
				rtnUser = new User();
				rtnUser.setId(userid);
				rtnUser.setName(rs.getString("name"));
				rtnUser.setBirthday(new java.util.Date(rs.getDate("birthday").getTime()));
			} else {
			}
			return rtnUser;
		}
	);
```

è¿™ä¸ªæœ¬èº«æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œè¿™éƒ¨åˆ†é€»è¾‘å®é™…ä¸Šå·²ç»å‰¥ç¦»å‡ºå»äº†ã€‚åªä¸è¿‡ï¼Œå®ƒé™å®šäº†ç”¨æˆ·åªèƒ½ç”¨è¿™ä¹ˆä¸€ç§æ–¹å¼è¿›è¡Œã€‚æœ‰æ—¶å€™å¾ˆä¸ä¾¿åˆ©ï¼Œæˆ‘ä»¬è¿˜åº”è¯¥è€ƒè™‘ç»™ç”¨æˆ·ç¨‹åºæä¾›å¤šç§æ–¹å¼ã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬æƒ³è¿”å›çš„ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ˆå¯¹åº”æ•°æ®åº“ä¸­ä¸€æ¡è®°å½•ï¼‰ï¼Œè€Œæ˜¯å¯¹è±¡åˆ—è¡¨ï¼ˆå¯¹åº”æ•°æ®åº“ä¸­å¤šæ¡è®°å½•ï¼‰ã€‚è¿™ç§åœºæ™¯å¾ˆå¸¸è§ï¼Œéœ€è¦æˆ‘ä»¬å†å•ç‹¬æä¾›ä¸€ä¸ªä¾¿åˆ©çš„å·¥å…·ã€‚

æ‰€ä»¥æˆ‘ä»¬è®¾è®¡ä¸€ä¸ªæ¥å£RowMapperï¼ŒæŠŠJDBCè¿”å›çš„ResultSeté‡Œçš„æŸä¸€è¡Œæ•°æ®æ˜ å°„æˆä¸€ä¸ªå¯¹è±¡ã€‚

```plain
package com.minis.jdbc.core;

import java.sql.ResultSet;
import java.sql.SQLException;

public interface RowMapper<T> {
	T mapRow(ResultSet rs, int rowNum) throws SQLException;
}
```

å†æä¾›ä¸€ä¸ªæ¥å£ResultSetExtractorï¼ŒæŠŠJDBCè¿”å›çš„ResultSetæ•°æ®é›†æ˜ å°„ä¸ºä¸€ä¸ªé›†åˆå¯¹è±¡ã€‚

```plain
package com.minis.jdbc.core;

import java.sql.ResultSet;
import java.sql.SQLException;

public interface ResultSetExtractor<T> {
	T extractData(ResultSet rs) throws SQLException;
}
```

åˆ©ç”¨ä¸Šé¢çš„ä¸¤ä¸ªæ¥å£ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªRowMapperResultSetExtractorã€‚

```plain
package com.minis.jdbc.core;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

public class RowMapperResultSetExtractor<T> implements ResultSetExtractor<List<T>> {
	private final RowMapper<T> rowMapper;

	public RowMapperResultSetExtractor(RowMapper<T> rowMapper) {
		this.rowMapper = rowMapper;
	}

	@Override
	public List<T> extractData(ResultSet rs) throws SQLException {
		List<T> results = new ArrayList<>();
		int rowNum = 0;
        //å¯¹ç»“æœé›†ï¼Œå¾ªç¯è°ƒç”¨mapRowè¿›è¡Œæ•°æ®è®°å½•æ˜ å°„
		while (rs.next()) {
			results.add(this.rowMapper.mapRow(rs, rowNum++));
		}
		return results;
	}
}
```

è¿™æ ·ï¼ŒSQLè¯­å¥è¿”å›çš„æ•°æ®é›†å°±è‡ªåŠ¨æ˜ å°„æˆå¯¹è±¡åˆ—è¡¨äº†ã€‚æˆ‘ä»¬çœ‹åˆ°ï¼Œå®é™…çš„æ•°æ®æ˜ å°„å·¥ä½œå…¶å®ä¸æ˜¯æˆ‘ä»¬å®ç°çš„ï¼Œè€Œæ˜¯ç”±RowMapperå®ç°çš„ï¼Œè¿™ä¸ªRowMapperæ—¢æ˜¯ä½œä¸ºä¸€ä¸ªå‚æ•°åˆæ˜¯ä½œä¸ºä¸€ä¸ªç”¨æˆ·ç¨‹åºä¼ è¿›å»çš„ã€‚è¿™å¾ˆåˆç†ï¼Œå› ä¸ºç¡®å®åªæœ‰ç”¨æˆ·ç¨‹åºè‡ªå·±çŸ¥é“è‡ªå·±çš„æ•°æ®è¦å¦‚ä½•æ˜ å°„ã€‚

å¥½ï¼Œæœ‰äº†è¿™ä¸ªå·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥æä¾›ä¸€ä¸ªæ–°çš„query()æ–¹æ³•æ¥è¿”å›SQLè¯­å¥çš„ç»“æœé›†ï¼Œä»£ç å¦‚ä¸‹ï¼š

```plain
	public <T> List<T> query(String sql, Object[] args, RowMapper<T> rowMapper) {
		RowMapperResultSetExtractor<T> resultExtractor = new RowMapperResultSetExtractor<>(rowMapper);
		Connection con = null;
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		
		try {
            //å»ºç«‹æ•°æ®åº“è¿æ¥
			con = dataSource.getConnection();

            //å‡†å¤‡SQLå‘½ä»¤è¯­å¥
			pstmt = con.prepareStatement(sql);
            //è®¾ç½®å‚æ•°
			ArgumentPreparedStatementSetter argumentSetter = new ArgumentPreparedStatementSetter(args);	
			argumentSetter.setValues(pstmt);
            //æ‰§è¡Œè¯­å¥
			rs = pstmt.executeQuery();
			
            //æ•°æ®åº“ç»“æœé›†æ˜ å°„ä¸ºå¯¹è±¡åˆ—è¡¨ï¼Œè¿”å›
			return resultExtractor.extractData(rs);
		}
		catch (Exception e) {
				e.printStackTrace();
		}
		finally {
			try {
				pstmt.close();
				con.close();
			} catch (Exception e) {		
			}
		}
		return null;
	}
```

é‚£ä¹ˆä¸Šå±‚åº”ç”¨ç¨‹åºçš„serviceå±‚è¦æ”¹æˆè¿™æ ·ï¼š

```plain
	public List<User> getUsers(int userid) {
		final String sql = "select id, name,birthday from users where id>?";
		return (List<User>)jdbcTemplate.query(sql, new Object[]{new Integer(userid)},
				new RowMapper<User>(){
					public User mapRow(ResultSet rs, int i) throws SQLException {
						User rtnUser = new User();
						rtnUser.setId(rs.getInt("id"));
						rtnUser.setName(rs.getString("name"));
						rtnUser.setBirthday(new java.util.Date(rs.getDate("birthday").getTime()));
		
						return rtnUser;
					}
				}
		);
	}
```

serviceç¨‹åºé‡Œé¢æ‰§è¡ŒSQLè¯­å¥ï¼Œç›´æ¥æŒ‰ç…§æ•°æ®è®°å½•çš„å­—æ®µçš„mappingå…³ç³»ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡åˆ—è¡¨ã€‚è¿™æ ·ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼ŒMiniSpringçš„JdbcTemplateå°±å¯ä»¥æä¾›3ç§query()æ–¹æ³•äº†ã€‚

1. public Object query(StatementCallback stmtcallback) {}
2. public Object query(String sql, Object\[] args, PreparedStatementCallback pstmtcallback) {}
3. public List query(String sql, Object\[] args, RowMapper rowMapper){}

å®é™…ä¸Šæˆ‘ä»¬è¿˜å¯ä»¥æä¾›æ›´å¤šçš„å·¥å…·ï¼Œä½ å¯ä»¥ä¸¾ä¸€åä¸‰æ€è€ƒä¸€ä¸‹åº”è¯¥æ€ä¹ˆåšï¼Œè¿™é‡Œæˆ‘å°±ä¸å¤šè¯´äº†ã€‚

## æ•°æ®åº“è¿æ¥æ± 

åˆ°ç°åœ¨è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬çš„MiniSpringä»ç„¶æ˜¯åœ¨æ‰§è¡ŒSQLè¯­å¥çš„æ—¶å€™ï¼Œå»æ–°å»ºæ•°æ®åº“è¿æ¥ï¼Œä½¿ç”¨å®Œä¹‹åå°±é‡Šæ”¾æ‰äº†ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œæ•°æ®åº“è¿æ¥çš„å»ºç«‹å’Œé‡Šæ”¾ï¼Œæ˜¯å¾ˆè´¹èµ„æºå’Œæ—¶é—´çš„ã€‚æ‰€ä»¥è¿™ä¸ªæ–¹æ¡ˆä¸æ˜¯æœ€ä¼˜çš„ï¼Œé‚£æ€æ ·æ‰èƒ½è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæœ‰ä¸€ä¸ªæ–¹æ¡ˆå¯ä»¥è¯•ä¸€è¯•ï¼Œé‚£å°±æ˜¯**æ± åŒ–æŠ€æœ¯**ã€‚æå‰åœ¨ä¸€ä¸ªæ± å­é‡Œé¢„åˆ¶å¤šä¸ªæ•°æ®åº“è¿æ¥ï¼Œåœ¨åº”ç”¨ç¨‹åºæ¥è®¿é—®çš„æ—¶å€™ï¼Œå°±ç»™å®ƒä¸€ä¸ªï¼Œç”¨å®Œä¹‹åå†æ”¶å›åˆ°æ± å­ä¸­ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­æ•°æ®åº“è¿æ¥ä¸€ç›´ä¿æŒä¸å…³é—­ï¼Œè¿™æ ·å°±å¤§å¤§æå‡äº†æ€§èƒ½ã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ”¹é€ ä¸€ä¸‹åŸæœ‰çš„æ•°æ®åº“è¿æ¥ï¼Œä¸æŠŠå®ƒçœŸæ­£å…³é—­ï¼Œè€Œæ˜¯è®¾ç½®ä¸€ä¸ªå¯ç”¨ä¸å¯ç”¨çš„æ ‡å¿—ã€‚æˆ‘ä»¬ç”¨ä¸€ä¸ªæ–°çš„ç±»ï¼Œå«PooledConnectionï¼Œæ¥å®ç°Connetionæ¥å£ï¼Œé‡Œé¢åŒ…å«äº†ä¸€ä¸ªæ™®é€šçš„Connectionï¼Œç„¶åç”¨ä¸€ä¸ªæ ‡å¿—Activeè¡¨ç¤ºæ˜¯å¦å¯ç”¨ï¼Œå¹¶ä¸”æ°¸ä¸å…³é—­ã€‚

```plain
package com.minis.jdbc.pool;
public class PooledConnection implements Connection{
	private Connection connection;
	private boolean active;
	
	public PooledConnection() {	
	}
	public PooledConnection(Connection connection, boolean active) {
		this.connection = connection;
		this.active = active;
	}
	
	public Connection getConnection() {
		return connection;
	}
	public void setConnection(Connection connection) {
		this.connection = connection;
	}
	public boolean isActive() {
		return active;
	}
	public void setActive(boolean active) {
		this.active = active;
	}
	public void close() throws SQLException {
		this.active = false;
	}
	@Override
	public PreparedStatement prepareStatement(String sql) throws SQLException {
		return this.connection.prepareStatement(sql);
	}
}	
```

å®é™…ä»£ç å¾ˆé•¿ï¼Œå› ä¸ºè¦å®ç°JDBC Connectionæ¥å£é‡Œæ‰€æœ‰çš„æ–¹æ³•ï¼Œä½ å¯ä»¥å‚è€ƒä¸Šé¢çš„ç¤ºä¾‹ä»£ç ï¼Œåˆ«çš„å¯ä»¥éƒ½ç•™ç©ºã€‚

æœ€ä¸»è¦çš„ï¼Œæˆ‘ä»¬è¦æ³¨æ„close()æ–¹æ³•ï¼Œå®ƒå…¶å®ä¸ä¼šå…³é—­è¿æ¥ï¼Œåªæ˜¯æŠŠè¿™ä¸ªæ ‡å¿—è®¾ç½®ä¸ºfalseã€‚

åŸºäºä¸Šé¢çš„PooledConnectionï¼Œæˆ‘ä»¬æŠŠåŸæœ‰çš„DataSourceæ”¹æˆPooledDataSourceã€‚é¦–å…ˆåœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå°±æ¿€æ´»æ‰€æœ‰çš„æ•°æ®åº“è¿æ¥ã€‚

```plain
package com.minis.jdbc.pool;

public class PooledDataSource implements DataSource{
	private List<PooledConnection> connections = null;
	private String driverClassName;
	private String url;
	private String username;
	private String password;
	private int initialSize = 2;
	private Properties connectionProperties;	
		
	private void initPool() {
		this.connections = new ArrayList<>(initialSize);
		for(int i = 0; i < initialSize; i++){
			Connection connect = DriverManager.getConnection(url, username, password);
			PooledConnection pooledConnection = new PooledConnection(connect, false);
			this.connections.add(pooledConnection);
		}
	}
}
```

è·å–æ•°æ®åº“è¿æ¥çš„ä»£ç å¦‚ä¸‹ï¼š

```plain
	PooledConnection pooledConnection= getAvailableConnection();
	while(pooledConnection == null){
		pooledConnection = getAvailableConnection();
		if(pooledConnection == null){
			try {
				TimeUnit.MILLISECONDS.sleep(30);
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
		}
	}		
  Â  return pooledConnection;
```

å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬çš„ç­–ç•¥æ˜¯æ­»ç­‰è¿™ä¸€ä¸ªæœ‰æ•ˆçš„è¿æ¥ã€‚è€Œè·å–æœ‰æ•ˆè¿æ¥çš„ä»£ç å¦‚ä¸‹ï¼š

```plain
	private PooledConnection getAvailableConnection() throws SQLException{
		for(PooledConnection pooledConnection : this.connections){
			if (!pooledConnection.isActive()){
				pooledConnection.setActive(true);
				return pooledConnection;
			}
		}

		return null;
	}
```

é€šè¿‡ä»£ç å¯ä»¥çŸ¥é“ï¼Œå…¶å®å®ƒå°±æ˜¯æ‹¿ä¸€ä¸ªç©ºé—²æ ‡å¿—çš„æ•°æ®åº“è¿æ¥æ¥è¿”å›ã€‚é€»è¾‘ä¸Šè¿™æ ·æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯ï¼Œè¿™æ®µä»£ç å°±ä¼šæœ‰ä¸€ä¸ªå¹¶å‘é—®é¢˜ï¼Œå¤šçº¿ç¨‹çš„æ—¶å€™ä¸å¥½ç”¨ï¼Œéœ€è¦æ”¹é€ ä¸€ä¸‹æ‰èƒ½é€‚åº”å¤šçº¿ç¨‹ç¯å¢ƒã€‚æˆ‘ä»¬æ³¨æ„åˆ°è¿™ä¸ªæ± å­ç”¨çš„æ˜¯ä¸€ä¸ªç®€å•çš„ArrayListï¼Œè¿™ä¸ªé»˜è®¤æ˜¯ä¸åŒæ­¥çš„ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹å·¥æ¥åšåŒæ­¥ï¼Œæ¯”å¦‚ä½¿ç”¨Collections.synchronizedList()ï¼Œæˆ–è€…ç”¨ä¸¤ä¸ªLinkedBlockingQueueï¼Œä¸€ä¸ªç”¨äºactiveè¿æ¥ï¼Œä¸€ä¸ªç”¨äºinactiveè¿æ¥ã€‚

åŒæ ·ï¼Œå¯¹DataSourceé‡Œæ•°æ®åº“çš„ç›¸å…³ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ¥æ³¨å…¥çš„ã€‚

```plain
<bean id="dataSource" class="com.minis.jdbc.pool.PooledDataSource">Â Â 
Â  Â  <property name="url" value="jdbc:sqlserver://localhost:1433;databasename=DEMO"/>Â Â 
Â  Â  <property name="driverClassName" value="com.microsoft.sqlserver.jdbc.SQLServerDriver"/>Â Â 
Â  Â  <property name="username" value="sa"/>Â Â 
Â  Â  <property name="password" value="Sql2016"/>Â Â 
Â  Â  <property type="int" name="initialSize" value="3"/>Â Â 
</bean>
```

æ•´ä¸ªç¨‹åºçš„ç»“æ„å®é™…ä¸Šæ²¡æœ‰ä»€ä¹ˆæ”¹åŠ¨ï¼Œåªæ˜¯å°†DataSourceçš„å®ç°å˜æˆäº†æ”¯æŒè¿æ¥æ± çš„å®ç°ã€‚ä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œç‹¬ç«‹æŠ½å–éƒ¨ä»¶ã€è§£è€¦è¿™äº›æ‰‹æ®µç»™ç¨‹åºç»“æ„å¸¦æ¥äº†æå¤§çš„çµæ´»æ€§ã€‚

## å°ç»“

æˆ‘ä»¬è¿™èŠ‚è¯¾ï¼Œåœ¨å·²æœ‰çš„JdbcTemplateåŸºç¡€ä¹‹ä¸Šï¼Œä»ç„¶æŒ‰ç…§ä¸“é—¨çš„äº‹æƒ…äº¤ç»™ä¸“é—¨çš„éƒ¨ä»¶æ¥åšçš„æ€è·¯ï¼Œä¸€æ­¥æ­¥æ‹†è§£ã€‚

æˆ‘ä»¬æŠŠSQLè¯­å¥å‚æ•°çš„å¤„ç†ç‹¬ç«‹æˆä¸€ä¸ªArgumentPreparedStatementSetterï¼Œç”±å®ƒæ¥è´Ÿè´£å‚æ•°çš„ä¼ å…¥ã€‚ä¹‹åå¯¹è¿”å›ç»“æœï¼Œæˆ‘ä»¬æä¾›äº†RowMapperå’ŒRowMapperResultSetExtractorï¼Œå°†æ•°æ®åº“è®°å½•é›†è½¬æ¢æˆä¸€ä¸ªå¯¹è±¡çš„åˆ—è¡¨ï¼Œä¾¿åˆ©äº†ä¸Šå±‚åº”ç”¨ç¨‹åºã€‚æœ€åè€ƒè™‘åˆ°æ€§èƒ½ï¼Œæˆ‘ä»¬è¿˜å¼•å…¥äº†ä¸€ä¸ªç®€å•çš„æ•°æ®åº“è¿æ¥æ± ã€‚åœ¨è¿™ä¸€æ­¥æ­¥åœ°æ‹†è§£è¿‡ç¨‹ä¸­ï¼ŒJdbcTemplateè¿™ä¸ªå·¥å…·è¶Šæ¥è¶Šå®Œæ•´ã€ä¾¿åˆ©äº†ã€‚

å®Œæ•´æºä»£ç å‚è§ [https://github.com/YaleGuo/minis](https://github.com/YaleGuo/minis)ã€‚

## è¯¾åé¢˜

å­¦å®Œè¿™èŠ‚è¯¾çš„å†…å®¹ï¼Œæˆ‘ä¹Ÿç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜ã€‚ä½ æƒ³ä¸€æƒ³æˆ‘ä»¬åº”è¯¥æ€ä¹ˆæ”¹é€ æ•°æ®åº“è¿æ¥æ± ï¼Œä¿è¯å¤šçº¿ç¨‹å®‰å…¨ï¼Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ3ï¼‰</strong></div><ul>
<li><span>é©¬å„¿</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>1. initialPoolåœ¨ç¬¬ä¸€æ¬¡getConnectionçš„æ—¶å€™åˆå§‹åŒ–ï¼Œé‚£ä¹ˆå°±ä¼šå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¯ä»¥åœ¨æ–¹æ³•ä¸Šç²—æš´çš„åŠ ä¸€ä¸ªsynchronizedå¹¶åœ¨æ–¹æ³•ä¸­åˆå§‹åŒ–å‰æå‰åˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œè¿™æ ·å°±å¯ä»¥é˜²æ­¢è¿æ¥æ± ä¸­çš„connectionsè¢«å¤šæ¬¡åˆå§‹åŒ–ã€‚
2. è·å–è¿æ¥çš„æ—¶å€™åœ¨æ²¡æœ‰è®¾ç½®activeä¸ºtrueä¹‹å‰ä¸¤ä¸ªè·å–è¿æ¥çš„çº¿ç¨‹åŒæ—¶é€šè¿‡äº†isActiveçš„åˆ¤æ–­å¯¼è‡´ä¸¤ä¸ªçº¿ç¨‹è·å–åˆ°äº†åŒä¸€ä¸ªé“¾æ¥ã€‚è¿™é‡Œä¹Ÿå¯ä»¥ç”¨synchronizedæ¥ä¿®é¥°isActiveå’ŒsetActiveä¸¤ä¸ªæ–¹æ³•ï¼Œä¿è¯ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®å…¶ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œä¸ä¼šæœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ã€‚å¹¶ä¸”ï¼Œå¯¹äºå¤šæ ¸æœºå™¨æ¥è¯´çº¿ç¨‹Aå¯èƒ½æ›´æ–°å®Œactiveå­—æ®µå°±é‡Šæ”¾é”äº†ï¼Œä½†æ˜¯æ›´æ–°åçš„å€¼è¿˜å­˜åœ¨è‡ªå·±çº¿ç¨‹æ‰€åœ¨çš„cpué«˜é€Ÿç¼“å­˜ä¸­è¿˜æ²¡æœ‰å†™å›åˆ°å†…å­˜ï¼Œå¯¼è‡´çº¿ç¨‹Bè¯»åˆ°çš„è¿˜æ˜¯å†…å­˜ä¸­æ—§çš„activeå€¼ï¼Œæ‰€ä»¥å¯ä»¥å†ç”¨volatileä¿è¯activeå€¼ä¿®æ”¹åé©¬ä¸Šå†™å›å†…å­˜å¹¶ä¸”åˆ«çš„çº¿ç¨‹ä¹Ÿåªèƒ½ä»å†…å­˜è¯»å–ã€‚

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥activeå­—æ®µæ¢æˆçº¿ç¨‹å®‰å…¨çš„AtomicBooleanç±»ã€‚

ä»¥ä¸Šæ˜¯è‡ªå·±çš„ä¸€äº›æ€è€ƒï¼Œè¯·è€å¸ˆæŒ‡æ­£ä¸€ä¸‹~</p>2023-04-13</li><br/><li><span>é£è½»æ‰¬</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸ªé—®é¢˜ã€‚queryæ–¹æ³•ä¸­ï¼Œå®ä¾‹åŒ–äº†ä¸€ä¸ªRowMapperResultSetExtractorï¼Œç›´æ¥ç”¨çš„å®ç°ç±»ï¼Œæ²¡æœ‰ç”¨æ¥å£ã€‚è€Œä¸”ï¼Œæˆ‘æƒ³äº†ä¸€ä¸‹ï¼Œä¹Ÿä¸èƒ½ç”¨æ¥å£ï¼Œå› ä¸ºExtractoræ¥å£é‡Œçš„æ–¹æ³•extractDataï¼Œè¿”å›å€¼æ³›å‹æ˜¯Objectç±»å‹ï¼Œæ²¡åŠæ³•å¤„ç†Listç±»å‹ã€‚æ‰€ä»¥åªèƒ½æ˜¯è¿”å›listæ—¶ï¼Œnewå‡ºå¤„ç†Listçš„Extractorï¼Œè¿”å›objectæ—¶ï¼Œnewå‡ºå¤„ç†å•å¯¹è±¡çš„Extractorã€‚æœ‰ç‚¹ä¸æ˜ç™½ï¼Œå®šä¹‰Extractoræ¥å£çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</p>2023-05-16</li><br/><li><span>peter</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯·æ•™è€å¸ˆå‡ ä¸ªé—®é¢˜ï¼š
Q1ï¼šæ•°æ®åº“è¿æ¥æ± ä¸€èˆ¬è®¾ç½®å¤šå¤§ï¼Ÿè¿æ¥æ± å¤§å°ä¸€èˆ¬æ˜¯æ€ä¹ˆè®¡ç®—çš„ï¼Ÿ
Q2ï¼šæ•°æ®åº“è¿æ¥æ± ä¸ç‰¹å®šçš„æ•°æ®åº“ç»‘å®šå—ï¼Ÿ æ¯”å¦‚æŸä¸ªè¿æ¥æ± å¯ä»¥è¿æ¥mysqlï¼Œèƒ½è¿æ¥å…¶ä»–æ•°æ®åº“å—ï¼Ÿ
Q3ï¼šå¸¸è§çš„æ•°æ®åº“è¿æ¥æ± æœ‰å“ªäº›ï¼Ÿ
Q4ï¼šæ•°æ®åº“è¿æ¥æ± ä¸é«˜å¹¶å‘æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</p>2023-04-13</li><br/>
</ul>