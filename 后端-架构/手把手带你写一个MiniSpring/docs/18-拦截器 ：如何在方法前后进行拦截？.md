ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ­å±¹ï¼Œä»Šå¤©æˆ‘ä»¬ç»§ç»­æ‰‹å†™MiniSpringã€‚

å‰é¢ï¼Œæˆ‘ä»¬ç”¨JDKåŠ¨æ€ä»£ç†æŠ€æœ¯å®ç°äº†AOPï¼Œå¹¶ä¸”è¿›è¡Œäº†è§£è€¦ï¼Œé‡‡ç”¨IoCå®¹å™¨æ¥ç®¡ç†ä»£ç†å¯¹è±¡ï¼Œå®ç°äº†éä¾µå…¥å¼ç¼–ç¨‹ã€‚æˆ‘ä»¬ç°åœ¨èƒ½åœ¨ä¸å½±å“ä¸šåŠ¡ä»£ç çš„å‰æä¸‹ï¼Œè¿›è¡Œé€»è¾‘çš„å¢å¼ºå·¥ä½œï¼Œæ¯”å¦‚æ‰“å°æ—¥å¿—ã€äº‹åŠ¡å¤„ç†ã€ç»Ÿè®¡æ¥å£è€—æ—¶ç­‰ç­‰ï¼Œå°†è¿™äº›ä¾‹è¡Œæ€§é€»è¾‘ä½œä¸ºä¸€ç§å¢å¼ºæ”¾åœ¨ä»£ç†ä¸­ï¼Œè¿è¡Œæ—¶åŠ¨æ€æ’å…¥ï¼ˆç¼–ç»‡ï¼‰è¿›å»ã€‚

æœ‰äº†è¿™ä¸ªé›å½¢ï¼Œæˆ‘ä»¬è‡ªç„¶å°±ä¼šè¿›ä¸€æ­¥è€ƒè™‘ï¼Œåœ¨è¿™ä¸ªä»£ç†ç»“æ„çš„åŸºç¡€ä¸Šï¼Œå°†åŠ¨æ€æ·»åŠ é€»è¾‘è¿™ä»¶äº‹æƒ…åšå¾—æ›´åŠ ç»“æ„åŒ–ä¸€ç‚¹ï¼Œè€Œä¸æ˜¯å…¨éƒ¨ç®€å•åœ°å †åœ¨invoke()æ–¹æ³•é‡Œã€‚

## å¼•å…¥ä¸‰ä¸ªæ¦‚å¿µ

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹invoke()è¿™ä¸ªæ–¹æ³•çš„ä»£ç åœ¨ç»“æ„æ–¹é¢æœ‰ä»€ä¹ˆé—®é¢˜ã€‚

```plain
public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
	if (method.getName().equals("doAction")) {
		 System.out.println("-----before call real object, dynamic proxy........");
		 return method.invoke(target, args);Â 
	}
	return null;
}
```

æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨å®é™…è°ƒç”¨æŸä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œæ˜¯ç”¨çš„åå°„ç›´æ¥è°ƒç”¨methodï¼Œå¯¹åº”åœ¨ä»£ç é‡Œä¹Ÿå°±æ˜¯ `method.invoke(target,args);` è¿™ä¸€å¥ã€‚è€Œå¢å¼ºçš„ä¾‹è¡Œæ€§ä»£ç æ˜¯ç›´æ¥å†™åœ¨method.invoke()è¿™ä¸ªæ–¹æ³•å‰é¢çš„ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢ä»£ç é‡Œçš„ `System.out.println())`ã€‚è¿™ä¹ˆåšå½“ç„¶æ²¡æœ‰é”™ï¼Œä¸è¿‡æ‰©å±•æ€§ä¸å¥½ã€‚è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨é‚£ä¸ªè€åŠæ³•ï¼Œ**ä¸åŒçš„åŠŸèƒ½ç”±ä¸åŒçš„éƒ¨ä»¶æ¥åš**ï¼Œæ‰€ä»¥è¿™ä¸ªå¢å¼ºé€»è¾‘æˆ‘ä»¬å¯ä»¥è€ƒè™‘æŠ½å–å‡ºä¸€ä¸ªä¸“é—¨çš„éƒ¨ä»¶æ¥åšï¼Œå®é™…ä¸šåŠ¡æ–¹æ³•çš„è°ƒç”¨ä¹Ÿå¯ä»¥åŒ…è£…ä¸€ä¸‹ã€‚

æ‰€ä»¥è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å¼•å…¥ä»¥ä¸‹å‡ ä¸ªæ¦‚å¿µã€‚

- Adviceï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¢å¼ºæ“ä½œã€‚
- Interceptorï¼šæ‹¦æˆªå™¨ï¼Œå®ƒå®ç°çš„æ˜¯çœŸæ­£çš„å¢å¼ºé€»è¾‘ã€‚
- MethodInterceptorï¼šè°ƒç”¨æ–¹æ³•ä¸Šçš„æ‹¦æˆªå™¨ï¼Œä¹Ÿå°±æ˜¯å®ƒå®ç°åœ¨æŸä¸ªæ–¹æ³•ä¸Šçš„å¢å¼ºã€‚

é€šè¿‡è¿™å‡ ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠä¾‹è¡Œæ€§é€»è¾‘å•ç‹¬å‰¥ç¦»å‡ºæ¥äº†ã€‚ç°åœ¨æˆ‘ä»¬è¦åšä¸€ä¸ªåˆ‡é¢ï¼Œåªéœ€è¦å®ç°æŸä¸ªInterceptorå°±å¯ä»¥äº†ã€‚

å¯¹åº”åœ°ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸‹Adviceã€Interceptorã€MethodInterceptorè¿™å‡ ä¸ªæ¥å£ã€‚

```java
package com.minis.aop;
public interface Advice {
}
```

```java
package com.minis.aop;
public interface Interceptor extends Advice{
}
```

```java
package com.minis.aop;
public interface MethodInterceptor extends Interceptor{
    Object invoke(MethodInvocation invocation) throws Throwable;
}
```

MethodInterceptorå°±æ˜¯æ–¹æ³•ä¸Šçš„æ‹¦æˆªå™¨ï¼Œå¯¹å¤–å°±æ˜¯ä¸€ä¸ªinvoke()æ–¹æ³•ã€‚æ‹¦æˆªå™¨ä¸ä»…ä»…ä¼šå¢å¼ºé€»è¾‘ï¼Œå®ƒå†…éƒ¨ä¹Ÿä¼šè°ƒç”¨ä¸šåŠ¡é€»è¾‘æ–¹æ³•ã€‚å› æ­¤ï¼Œå¯¹å¤–éƒ¨ç¨‹åºè€Œè¨€ï¼Œåªéœ€è¦ä½¿ç”¨è¿™ä¸ªMethodInterceptorå°±å¯ä»¥äº†ã€‚

å®ƒéœ€è¦ä¼ å…¥ä¸€ä¸ªMethodInvocationï¼Œç„¶åè°ƒç”¨method invocationçš„proceed()æ–¹æ³•ï¼ŒMethodInvocationå®é™…ä¸Šå°±æ˜¯ä»¥å‰é€šè¿‡åå°„æ–¹æ³•è°ƒç”¨ä¸šåŠ¡é€»è¾‘çš„é‚£ä¸€æ®µä»£ç çš„åŒ…è£…ã€‚ã€‚

```java
public interface MethodInvocation {
   Method getMethod();
   Object[] getArguments();
   Object getThis();
   Object proceed() throws Throwable;
}
```

æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹åº”ç”¨ç¨‹åºå‘˜çš„å·¥ä½œï¼Œä¸ºäº†æ’å…¥åˆ‡é¢ï¼Œéœ€è¦åœ¨invoke()ä¸­å®ç°è‡ªå·±çš„ä¸šåŠ¡å¢å¼ºä»£ç ã€‚

```plain
public class TracingInterceptor implements MethodInterceptor {
	public Object invoke(MethodInvocation i) throws Throwable {
		System.out.println("method "+i.getMethod()+" is called on "+
	Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  i.getThis()+" with args "+i.getArguments());
		Object ret=i.proceed();
		System.out.println("method "+i.getMethod()+" returns "+ret);
		return ret;
Â  Â }
}
```

ä¸­é—´çš„i.proceed()æ‰æ˜¯çœŸæ­£çš„ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨ã€‚

```plain
public Object proceed() throws Throwable {
	return this.method.invoke(this.target, this.arguments);
}
```

## æ”¹é€ ä»£ç†ç±»

æœ‰äº†ä¸Šé¢å‡†å¤‡å¥½çš„è¿™äº›éƒ¨ä»¶ï¼Œæˆ‘ä»¬åœ¨åŠ¨æ€ä»£ç†ä¸­å¦‚ä½•ä½¿ç”¨å®ƒä»¬å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬å†å¼•å…¥ä¸€ä¸ªAdvisoræ¥å£ã€‚

```plain
	public interface Advisor {
		MethodInterceptor getMethodInterceptor();
		void setMethodInterceptor(MethodInterceptor methodInterceptor);
	}
```

åœ¨ä»£ç†ç±»ProxyFactoryBeané‡Œå¢åŠ Advisorå±æ€§å’Œæ‹¦æˆªå™¨ã€‚

```plain
    private String interceptorName;	
    private Advisor advisor;
```

è¿™æ ·ï¼Œæˆ‘ä»¬çš„ä»£ç†ç±»é‡Œå°±æœ‰è·Ÿæ‹¦æˆªå™¨å…³è”çš„ç‚¹äº†ã€‚

æ¥ä¸‹æ¥ï¼Œä¸ºäº†åœ¨ç›®æ ‡å¯¹è±¡è°ƒç”¨å‰è¿›è¡Œæ‹¦æˆªï¼Œæˆ‘ä»¬å°±éœ€è¦è°ƒæ•´è¿™ä¸ªProxyFactoryBeanï¼Œå¹¶è®¾ç½®å…¶Advisorå±æ€§ï¼ŒåŒæ—¶å®šä¹‰è¿™ä¸ªinitializeAdvisoræ–¹æ³•æ¥è¿›è¡Œå…³è”ã€‚

```java
package com.minis.aop;
public class ProxyFactoryBean implements FactoryBean<Object> {
    private BeanFactory beanFactory;
    private String interceptorName;
    private Advisor advisor;
    
    private synchronized void initializeAdvisor() {
        Object advice = null;
        MethodInterceptor mi = null;
        try {
            advice = (MethodInterceptor) this.beanFactory.getBean(this.interceptorName);
        } catch (BeansException e) {
            e.printStackTrace();
        }
        advisor = new DefaultAdvisor();
        advisor.setMethodInterceptor((MethodInterceptor)advice);
    }
}
```

é€šè¿‡ProxyFactoryBeanä»£ç å®ç°å¯ä»¥çœ‹å‡ºï¼Œé‡Œé¢æ–°å¢äº†initializeAdvisorå¤„ç†ï¼Œå°†åº”ç”¨ç¨‹åºè‡ªå®šä¹‰çš„æ‹¦æˆªå™¨è·å–åˆ°Advisoré‡Œã€‚å¹¶ä¸”ï¼Œå¯ä»¥åœ¨IoCå®¹å™¨ä¸­é…ç½®è¿™ä¸ªInterceptoråå­—ã€‚

åœ¨initializeAdvisoré‡Œï¼Œæˆ‘ä»¬æŠŠAdvisoråˆå§‹åŒ–å·¥ä½œäº¤ç»™äº†DefaultAdvisorã€‚

```java
package com.minis.aop;
public class DefaultAdvisor implements Advisor{
    private MethodInterceptor methodInterceptor;
    public DefaultAdvisor() {
    }
    public void setMethodInterceptor(MethodInterceptor methodInterceptor) {
        this.methodInterceptor = methodInterceptor;
    }
    public MethodInterceptor getMethodInterceptor() {
        return this.methodInterceptor;
    }
}
```

éšåï¼Œæˆ‘ä»¬ä¿®æ”¹AopProxyFactoryä¸­createAopProxyæ¥å£çš„æ–¹æ³•ç­¾åï¼Œæ–°å¢Advisorå‚æ•°ã€‚

```java
package com.minis.aop;
public interface AopProxyFactory {
    AopProxy createAopProxy(Object target, Advisor advisor);
}
```

ä¿®æ”¹æ¥å£åï¼Œæˆ‘ä»¬éœ€è¦ç›¸åº”åœ°ä¿®æ”¹å…¶å®ç°æ–¹æ³•ã€‚åœ¨ProxyFactoryBeanä¸­ï¼Œå”¯ä¸€çš„å®ç°æ–¹æ³•å°±æ˜¯createAopProxy()ã€‚

```java
protected AopProxy createAopProxy() {
    return getAopProxyFactory().createAopProxy(target);
}
```

åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯¹å‰é¢å¼•å…¥çš„Advisorè¿›è¡Œäº†èµ‹å€¼ã€‚ä¿®æ”¹ä¹‹åï¼Œä»£ç å˜æˆäº†è¿™æ ·ã€‚

```java
protected AopProxy createAopProxy() {
    return getAopProxyFactory().createAopProxy(targetï¼Œthis.advisor);
}
```

é»˜è®¤å®ç°æ˜¯DefaultAopProxyFactoryä¸JdkDynamicAopProxyï¼Œè¿™é‡Œè¦ä¸€å¹¶ä¿®æ”¹ã€‚

```java
package com.minis.aop;
public class DefaultAopProxyFactory implements AopProxyFactory{
    @Override
    public AopProxy createAopProxy(Object target, Advisor advisor) {
        return new JdkDynamicAopProxy(target, advisor);
    }
}
```

```java
package com.minis.aop;
public class JdkDynamicAopProxy implements AopProxy, InvocationHandler {
    Object target;
    Advisor advisor;
    public JdkDynamicAopProxy(Object target, Advisor advisor) {
        this.target = target;
        this.advisor = advisor;
    }
    @Override
    public Object getProxy() {
        Object obj = Proxy.newProxyInstance(JdkDynamicAopProxy.class.getClassLoader(), target.getClass().getInterfaces(), this);
        return obj;
    }
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        if (method.getName().equals("doAction")) {
            Class<?> targetClass = (target != null ? target.getClass() : null);
            MethodInterceptor interceptor = this.advisor.getMethodInterceptor();
            MethodInvocation invocation =
                    new ReflectiveMethodInvocation(proxy, target, method, args, targetClass);
            return interceptor.invoke(invocation);
        }
        return null;
    }
}

```

åœ¨JdkDynamicAopProxyé‡Œæˆ‘ä»¬å‘ç°ï¼Œinvokeæ–¹æ³•å’Œä¹‹å‰ç›¸æ¯”æœ‰äº†ä¸å°çš„å˜åŒ–ï¼Œåœ¨è°ƒç”¨æŸä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œä¸å†æ˜¯ç›´æ¥ç”¨åå°„è°ƒç”¨æ–¹æ³•äº†ï¼Œè€Œæ˜¯å…ˆæ‹¿åˆ°Advisoré‡Œé¢çš„Interceptorï¼Œç„¶åæŠŠæ­£å¸¸çš„methodè°ƒç”¨åŒ…è£…æˆReflectiveMethodInvocationï¼Œæœ€åè°ƒç”¨interceptor.invoke(invocation)ï¼Œå¯¹éœ€è¦è°ƒç”¨çš„æ–¹æ³•è¿›è¡Œäº†å¢å¼ºå¤„ç†ã€‚

ä½ æŠŠè¿™ä¸€æ®µå’Œä¹‹å‰çš„invoke()è¿›è¡Œæ¯”å¯¹ï¼Œå¯ä»¥çœ‹å‡ºï¼Œé€šè¿‡Interceptorè¿™ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬å°±æŠŠå¢å¼ºé€»è¾‘å•ç‹¬å‰¥ç¦»å‡ºæ¥äº†ã€‚

ä½ å¯ä»¥çœ‹ä¸€ä¸‹å®é™…çš„ReflectiveMethodInvocationç±»ï¼Œå…¶å®å°±æ˜¯å¯¹åå°„è°ƒç”¨æ–¹æ³•è¿›è¡Œäº†ä¸€æ¬¡åŒ…è£…ã€‚

```java
package com.minis.aop;
public class ReflectiveMethodInvocation implements MethodInvocation{
    protected final Object proxy;
    protected final Object target;
    protected final Method method;
    protected Object[] arguments;
    private Class<?> targetClass;
    protected ReflectiveMethodInvocation(
            Object proxy,  Object target, Method method,  Object[] arguments,
            Class<?> targetClass) {
        this.proxy = proxy;
        this.target = target;
        this.targetClass = targetClass;
        this.method = method;
        this.arguments = arguments;
    }
    
    //çœç•¥getter/setter
    
    public Object proceed() throws Throwable {
        return this.method.invoke(this.target, this.arguments);
    }
}
```

## æµ‹è¯•

æˆ‘ä»¬ç°åœ¨å¯ä»¥æ¥ç¼–å†™ä¸€ä¸‹æµ‹è¯•ä»£ç ï¼Œå®šä¹‰TracingInterceptorç±»æ¨¡æ‹Ÿä¸šåŠ¡æ‹¦æˆªä»£ç ã€‚

```java
package com.test.service;
import com.minis.aop.MethodInterceptor;
import com.minis.aop.MethodInvocation;
public class TracingInterceptor implements MethodInterceptor {
    @Override
    public Object invoke(MethodInvocation i) throws Throwable {
        System.out.println("method "+i.getMethod()+" is called on "+
                i.getThis()+" with args "+i.getArguments());
        Object ret=i.proceed();
        System.out.println("method "+i.getMethod()+" returns "+ret);
        return ret;
    }
}
```

applicationContext.xmlé…ç½®æ–‡ä»¶ï¼š

```xml
   <bean id="myInterceptor" class="com.test.service.TracingInterceptor" />
   <bean id="realaction" class="com.test.service.Action1" />
   <bean id="action" class="com.minis.aop.ProxyFactoryBean" >
      <property type="java.lang.Object" name="target" ref="realaction"/>
      <property type="String" name="interceptorName" value="myInterceptor"/>
   </bean>
```

é…ç½®æ–‡ä»¶é‡Œï¼Œé™¤äº†åŸæœ‰çš„targetï¼Œæˆ‘ä»¬è¿˜å¢åŠ äº†ä¸€ä¸ªinterceptorNameå±æ€§ï¼Œè®©ç¨‹åºå‘˜æŒ‡å®šéœ€è¦å¯ç”¨ä»€ä¹ˆæ ·çš„å¢å¼ºã€‚

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å®ç°äº†MethodInterceptorã€‚

## åœ¨æ–¹æ³•å‰åæ‹¦æˆª

æˆ‘ä»¬ç°åœ¨å®ç°çš„æ–¹æ³•æ‹¦æˆªï¼Œå…è®¸ç¨‹åºå‘˜è‡ªè¡Œç¼–å†™invoke()æ–¹æ³•ï¼Œè¿›è¡Œä»»æ„æ“ä½œã€‚ä½†æ˜¯åœ¨è®¸å¤šåœºæ™¯ä¸‹ï¼Œè°ƒç”¨æ–¹å¼å®é™…ä¸Šæ˜¯æ¯”è¾ƒå›ºå®šçš„ï¼Œå³åœ¨æŸä¸ªæ–¹æ³•è°ƒç”¨ä¹‹å‰æˆ–ä¹‹åï¼Œå…è®¸ç¨‹åºå‘˜æ’å…¥ä¸šåŠ¡ä¸Šéœ€è¦çš„å¢å¼ºã€‚ä¸ºäº†æ»¡è¶³è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æä¾›ç‰¹å®šçš„æ–¹æ³•æ‹¦æˆªï¼Œå¹¶å…è®¸ç¨‹åºå‘˜åœ¨è¿™äº›æ‹¦æˆªç‚¹ä¹‹å‰å’Œä¹‹åè¿›è¡Œä¸šåŠ¡å¢å¼ºçš„æ“ä½œã€‚è¿™ç§æ–¹å¼å°±å¤§å¤§ç®€åŒ–äº†ç¨‹åºå‘˜çš„å·¥ä½œã€‚

æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æ–°å¢ä¸¤ç§adviceï¼šMethodBeforeAdviceå’ŒAfterReturningAdviceã€‚æ ¹æ®åå­—ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº”æ–¹æ³•è°ƒç”¨å‰å¤„ç†å’Œè¿”å›åçš„å¤„ç†ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹å®ƒä»¬çš„å®šä¹‰ã€‚

```java
package com.minis.aop;
public interface BeforeAdvice extends Advice{
}
```

```java
package com.minis.aop;
public interface AfterAdvice extends Advice{
}
```

```java
package com.minis.aop;
import java.lang.reflect.Method;
public interface MethodBeforeAdvice extends BeforeAdvice {
    void before(Method method, Object[] args, Object target) throws Throwable;
}
```

```java
package com.minis.aop;
import java.lang.reflect.Method;
public interface AfterReturningAdvice extends AfterAdvice{
    void afterReturning(Object returnValue, Method method, Object[] args, Object target) throws Throwable;
}
```

é¦–å…ˆæˆ‘ä»¬å®šä¹‰é€šç”¨æ¥å£BeforeAdviceä¸AfterAdviceï¼Œéšåå®šä¹‰æ ¸å¿ƒçš„MethodBeforeAdviceä¸AfterReturningAdviceæ¥å£ï¼Œå®ƒä»¬åˆ†åˆ«å†…ç½®äº†beforeæ–¹æ³•å’ŒafterReturningæ–¹æ³•ã€‚ç”±æ–¹æ³•ç­¾åå¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸¤è€…çš„åŒºåˆ«åœ¨äºafterReturningå®ƒå†…éƒ¨ä¼ å…¥äº†è¿”å›å‚æ•°ï¼Œè¯´æ˜æ˜¯ç›®æ ‡æ–¹æ³•æ‰§è¡Œè¿”å›åï¼Œå†è°ƒç”¨è¯¥æ–¹æ³•ï¼Œåœ¨æ–¹æ³•é‡Œé¢å¯ä»¥æ‹¿åˆ°è¿”å›çš„å‚æ•°ã€‚

æœ‰äº†æ–°çš„Adviceçš„å®šä¹‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°æ–°çš„Interceptoräº†ã€‚ä½ å¯ä»¥çœ‹ä¸‹å®ç°çš„ä»£ç ã€‚

```xml
package com.minis.aop;
public class MethodBeforeAdviceInterceptor implements MethodInterceptor, BeforeAdvice {
    private final MethodBeforeAdvice advice;
    public MethodBeforeAdviceInterceptor(MethodBeforeAdvice advice) {
        this.advice = advice;
    }
    @Override
    public Object invoke(MethodInvocation mi) throws Throwable {
        this.advice.before(mi.getMethod(), mi.getArguments(), mi.getThis());
        return mi.proceed();
    }
}
```

åœ¨è¿™ä¸ªInterceptoré‡Œï¼Œinvoke()æ–¹æ³•çš„å®ç°å®é™…ä¸Šå°±æ˜¯é™åˆ¶æ€§åœ°ä½¿ç”¨advice.before()æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œç›®æ ‡æ–¹æ³•çš„è°ƒç”¨ï¼Œä¹Ÿæ„å‘³ç€è¿™æ˜¯åœ¨æ–¹æ³•è°ƒç”¨ä¹‹å‰æ’å…¥çš„é€»è¾‘ã€‚ç”±äºè¿™æ˜¯é’ˆå¯¹beforeè¿™ç§è¡Œä¸ºçš„ç‰¹å®šInterceptorï¼Œå› æ­¤ä¸Šå±‚åº”ç”¨ç¨‹åºå‘˜æ— éœ€è‡ªå·±å†è¿›è¡Œå®ç°ï¼Œè€Œæ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªInterceptorã€‚

```xml
package com.minis.aop;
public class AfterReturningAdviceInterceptor implements MethodInterceptor, AfterAdvice{
    private final AfterReturningAdvice advice;
    public AfterReturningAdviceInterceptor(AfterReturningAdvice advice) {
        this.advice = advice;
    }
    @Override
    public Object invoke(MethodInvocation mi) throws Throwable {
        Object retVal = mi.proceed();
        this.advice.afterReturning(retVal, mi.getMethod(), mi.getArguments(), mi.getThis());
        return retVal;
    }
}

```

åŒæ ·ï¼Œç”±AfterReturningAdviceInterceptorç±»ä¸­å¯¹invokeæ–¹æ³•çš„å®ç°å¯ä»¥çœ‹å‡ºï¼Œæ˜¯å…ˆè°ƒç”¨mi.proceed()æ–¹æ³•è·å–åˆ°äº†è¿”å›å€¼retValï¼Œå†è°ƒç”¨afterReturningæ–¹æ³•ï¼Œå®ç°çš„æ˜¯æ–¹æ³•è°ƒç”¨ä¹‹åçš„é€»è¾‘å¢å¼ºï¼Œè¿™ä¸ªæ—¶åºä¹Ÿæ˜¯å›ºå®šçš„ã€‚æ‰€ä»¥æ³¨æ„äº†ï¼Œåœ¨advice.afterReturing()æ–¹æ³•ä¸­ï¼Œæ˜¯å¯ä»¥æ‹¿åˆ°ç›®æ ‡æ–¹æ³•çš„è¿”å›å€¼çš„ã€‚

åœ¨æ‹¦æˆªå™¨çš„ä½¿ç”¨ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªæœ‰æ„æ€çš„é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªæœ‰ç€å¹¿æ³›äº‰è®®çš„è¯é¢˜ï¼šæ‹¦æˆªå™¨æ˜¯å¦åº”è¯¥å½±å“ä¸šåŠ¡ç¨‹åºçš„æµç¨‹ï¼Ÿæ¯”å¦‚ï¼Œåœ¨before()æ‹¦æˆªå™¨ä¸­åŠ å…¥ä¸€ä¸ªè¿”å›æ ‡å¿—ï¼ˆtrue/falseï¼‰ï¼Œå½“å…¶ä¸ºfalseæ—¶ï¼Œæˆ‘ä»¬å°±ä¸­æ­¢ä¸šåŠ¡æµç¨‹å¹¶ä¸”ä¸å†è°ƒç”¨ç›®æ ‡æ–¹æ³•ã€‚

ä¸åŒçš„å¼€å‘è€…å¯¹äºè¿™ä¸ªé—®é¢˜æœ‰ç€ä¸åŒçš„ä¸»å¼ ã€‚ä¸€æ–¹é¢ï¼Œè¿™ç§æœºåˆ¶ä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿæ ¹æ®éœ€è¦å¯¹ä¸šåŠ¡é€»è¾‘è¿›è¡Œç²¾ç»†æ§åˆ¶ï¼›å¦ä¸€æ–¹é¢ï¼Œè¿‡åº¦ä½¿ç”¨è¿™ç§æœºåˆ¶ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´ä»£ç éš¾åº¦å¢åŠ ã€å¯ç»´æŠ¤æ€§é™ä½ç­‰é—®é¢˜ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨æ‹¦æˆªå™¨çš„æ—¶å€™ï¼Œéœ€è¦åœ¨å¼€å‘æ•ˆç‡å’Œç¨‹åºå¯ç»´æŠ¤æ€§ä¹‹é—´åšå‡ºä¸€ä¸ªå¹³è¡¡ï¼Œå¹¶æ ¹æ®å®é™…æƒ…å†µåšå‡ºç›¸åº”çš„é€‰æ‹©ã€‚

ç°åœ¨æˆ‘ä»¬æ‰‹ä¸Šæœ‰ä¸‰ç§Adviceç±»å‹äº†ï¼Œæ™®é€šçš„MethodInterceptorï¼Œè¿˜æœ‰ç‰¹å®šçš„MethodBeforeAdviceInterceptorå’ŒAfterReturningAdviceInterceptorï¼Œè‡ªç„¶åœ¨ProxyFactoryBeanä¸­ä¹Ÿè¦å¯¹è¿™ä¸ªinitializeAdvisoræ–¹æ³•è¿›è¡Œæ”¹é€ ï¼Œåˆ†åˆ«æ”¯æŒä¸‰ç§ä¸åŒç±»å‹çš„Adviceã€‚

```java
package com.minis.aop;
public class ProxyFactoryBean implements FactoryBean<Object>, BeanFactoryAware {
    private synchronized void initializeAdvisor() {
        Object advice = null;
        MethodInterceptor mi = null;
        try {
            advice = this.beanFactory.getBean(this.interceptorName);
        } catch (BeansException e) {
            e.printStackTrace();
        }
        if (advice instanceof BeforeAdvice) {
            mi = new MethodBeforeAdviceInterceptor((MethodBeforeAdvice)advice);
        }
        else if (advice instanceof AfterAdvice) {
            mi = new AfterReturningAdviceInterceptor((AfterReturningAdvice)advice);
        }
        else if (advice instanceof MethodInterceptor) {
            mi = (MethodInterceptor)advice;
        }
        advisor = new DefaultAdvisor();
        advisor.setMethodInterceptor(mi);
    }
}
```

ä¸Šè¿°å®ç°æ¯”è¾ƒç®€å•ï¼Œæ ¹æ®ä¸åŒçš„Adviceç±»å‹è¿›è¡Œåˆ¤æ–­ï¼Œæœ€åç»Ÿä¸€ç”¨MethodInterceptoræ¥å°è£…ã€‚

## æµ‹è¯•

åœ¨è¿™ä¸€æ­¥æ”¹é€ å®Œæ¯•åï¼Œæˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼Œè¿™é‡Œæˆ‘ä»¬æä¾›çš„æ˜¯æ¯”è¾ƒç®€å•çš„å®ç°ï¼Œå®é™…å¼€å‘è¿‡ç¨‹ä¸­ä½ å¯ä»¥è·Ÿæ®è‡ªå·±çš„éœ€æ±‚å®šåˆ¶å¼€å‘ã€‚

æˆ‘ä»¬å…ˆæä¾›ä¸¤ä¸ªAdviceã€‚

```java
package com.test.service;
public class MyAfterAdvice implements AfterReturningAdvice {
    @Override
    public void afterReturning(Object returnValue, Method method, Object[] args, Object target) throws Throwable {
        System.out.println("----------my interceptor after method call----------");
    }
}
```

```java
package com.test.service;
public class MyBeforeAdvice implements MethodBeforeAdvice {
    @Override
    public void before(Method method, Object[] args, Object target) throws Throwable {
        System.out.println("----------my interceptor before method call----------");
    }
}
```

ä¸Šè¿°çš„æµ‹è¯•ä»£ç éƒ½å¾ˆç®€å•ï¼Œåœ¨æ­¤ä¸å¤šèµ˜è¿°ã€‚ç›¸åº”çš„applicationContext.xmlè¿™ä¸ªé…ç½®æ–‡ä»¶é‡Œé¢çš„å†…å®¹ä¹Ÿè¦å‘ç”Ÿå˜åŒ–ã€‚

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans>
   <bean id="myBeforeAdvice" class="com.test.service.MyBeforeAdvice" />
   <bean id="realaction" class="com.test.service.Action1" />
   <bean id="action" class="com.minis.aop.ProxyFactoryBean" >
      <property type="java.lang.Object" name="target" ref="realaction"/>
      <property type="String" name="interceptorName" value="myBeforeAdvice"/>
   </bean>
</beans>
```

å°†beforeAdviceæˆ–è€…afterAdviceæ”¾åœ¨é…ç½®æ–‡ä»¶é‡Œï¼Œé™¤äº†æ³¨å†Œçš„Beanç±»åæœ‰ä¸€äº›ä¿®æ”¹ï¼Œå…¶é…ç½®æ˜¯æ²¡æœ‰å‘ç”Ÿä»»ä½•åˆ«çš„å˜åŒ–çš„ï¼Œä½†ç»è¿‡è¿™æ ·ä¸€ç•ªæ”¹é€ ï¼Œæˆ‘ä»¬å°±èƒ½ä½¿ç”¨ä¸Šè¿°ä¸‰ç±»Adviceï¼Œæ¥å¯¹æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç è¿›è¡Œæ‹¦æˆªå¢å¼ºå¤„ç†äº†ã€‚

## å°ç»“

è¿™èŠ‚è¯¾æˆ‘ä»¬åœ¨ç®€å•åŠ¨æ€ä»£ç†ç»“æ„çš„åŸºç¡€ä¸Šï¼Œ**å°†åŠ¨æ€æ·»åŠ çš„é€»è¾‘è®¾è®¡å¾—æ›´åŠ ç»“æ„åŒ–ä¸€ç‚¹ï¼Œè€Œä¸æ˜¯å…¨éƒ¨ç®€å•åœ°å †åœ¨invoke()ä¸€ä¸ªæ–¹æ³•ä¸­**ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬æå‡ºäº†Adviceçš„æ¦‚å¿µï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¢å¼ºæ“ä½œã€‚ç„¶åæå‡ºInterceptoræ‹¦æˆªå™¨çš„æ¦‚å¿µï¼Œå®ƒå®ç°äº†çœŸæ­£çš„å¢å¼ºé€»è¾‘å¹¶åŒ…è£…äº†ç›®æ ‡æ–¹æ³•çš„è°ƒç”¨ï¼Œåº”ç”¨ç¨‹åºä¸­å®é™…ä½¿ç”¨çš„å°±æ˜¯è¿™ä¸ªInterceptorã€‚æˆ‘ä»¬å®é™…å®ç°çš„æ˜¯MethodInterceptorï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯è°ƒç”¨æ–¹æ³•ä¸Šçš„æ‹¦æˆªå™¨ã€‚

æˆ‘ä»¬æ³¨æ„åˆ°å¤§éƒ¨åˆ†æ‹¦æˆªçš„è¡Œä¸ºéƒ½æ˜¯æ¯”è¾ƒå›ºå®šçš„ï¼Œæˆ–è€…åœ¨æ–¹æ³•è°ƒç”¨ä¹‹å‰ï¼Œæˆ–è€…åœ¨ä¹‹åï¼Œä¸ºäº†æ–¹ä¾¿å¤„ç†è¿™äº›å¸¸è§çš„åœºæ™¯ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥åˆ†ç¦»å‡ºäº†beforeAdviceå’ŒafterAdviceã€‚é€šè¿‡è¿™äº›å·¥ä½œï¼Œç”¨æˆ·å¸Œæœ›æ’å…¥çš„ä¾‹è¡Œæ€§é€»è¾‘ç°åœ¨éƒ½å•ç‹¬æŠ½å–æˆä¸€ä¸ªéƒ¨ä»¶äº†ï¼Œåº”ç”¨ç¨‹åºå‘˜åªè¦ç®€å•åœ°å®ç°MethodBeforeAdviceå’ŒAfterReturningAdviceå³å¯ã€‚æ•´ä¸ªè½¯ä»¶ç»“æ„åŒ–å¾ˆå¥½ï¼Œå®Œå…¨è§£è€¦ã€‚

å®Œæ•´æºä»£ç å‚è§ [https://github.com/YaleGuo/minis](https://github.com/YaleGuo/minis)

## è¯¾åé¢˜

å­¦å®Œè¿™èŠ‚è¯¾çš„å†…å®¹ï¼Œæˆ‘ä¹Ÿç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›beforeAdviceèƒ½åœ¨æŸç§æƒ…å†µä¸‹é˜»æ­¢ç›®æ ‡æ–¹æ³•çš„è°ƒç”¨ï¼Œåº”è¯¥ä»å“ªé‡Œä¸‹æ‰‹æ”¹é€ ï¼Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ5ï¼‰</strong></div><ul>
<li><span>Geek_5c6106</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è€å¸ˆï¼Œè¯·é—®ä¸€ä¸‹ ProxyFactoryBean beanä¸­çš„BeanFactory beanFactoryå±æ€§æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™çš„è®¾ç½®å€¼çš„ï¼Ÿ
è¿™ä¸ªæ˜¯è¦åœ¨AbstractBeanFactoryä¸­è®¾ç½®å€¼çš„å—ï¼Ÿ
if (singleton instanceof FactoryBean) {
            return this.getObjectForBeanInstance(singleton, beanName);
        }
getObjectForBeanInstance æ–¹æ³•ä¸­å°†thisï¼Œå°†å€¼è®¾ç½®åˆ°ProxyFactoryBean ä¸­å—ï¼Ÿ</p>2023-05-19</li><br/><li><span>é£è½»æ‰¬</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼ŒMethodBeforeAdviceInterceptorä¸ºä»€ä¹ˆä¹Ÿè¦å®ç°BeforeAdviceæ¥å£å‘¢ï¼Ÿ</p>2023-06-03</li><br/><li><span>é©¬ä»¥</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ€è€ƒé¢˜ï¼šå› ä¸ºä»£ç†å¯¹è±¡æ‰§è¡Œçš„å…¥å£å…¨éƒ¨éƒ½åœ¨interceptor.invoke(invocation)è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå¦‚æœæƒ³è¦æˆªæ–­ï¼Œå°±åœ¨å…·ä½“çš„XXXInterceptorä¸­å¤„ç†å°±å¯ä»¥äº†</p>2023-12-27</li><br/><li><span>Geek_149cde</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¿™å„¿æµ‹è¯•çš„æ—¶å€™è°ƒç”¨çš„æ˜¯ doAction() æ–¹æ³•ï¼Œä½†æ˜¯ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆè°ƒç”¨ doAction() æ–¹æ³•ä¼šè‡ªåŠ¨è°ƒç”¨ JdkDynamicAopProxy ç±»ä¸­çš„ invoke() </p>2023-07-19</li><br/><li><span>é£è½»æ‰¬</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ€è€ƒé¢˜ï¼šå¯ä»¥åœ¨MethodBeforeAdviceInterceptorä¸­åˆ¤æ–­æ˜¯å¦å¯¹è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œä¸šåŠ¡æ„ä¹‰æ˜ç¡®</p>2023-06-03</li><br/>
</ul>