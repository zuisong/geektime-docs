ä½ å¥½ï¼Œæˆ‘æ˜¯Barryã€‚

åœ¨ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬é€šè¿‡ç”¨æˆ·æ³¨å†Œæ¥å£çš„å®ç°ï¼Œç³»ç»Ÿå­¦ä¹ äº†å¦‚ä½•å®ç°åŠŸèƒ½æ¥å£çš„å¼€å‘ã€‚è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬ç»§ç»­æ¥å­¦ä¹ å¦‚ä½•å®ç°è§†é¢‘ç›¸å…³ã€æ•°æ®ç›¸å…³çš„åŠŸèƒ½æ¥å£ã€‚

åœ¨çº¿è§†é¢‘å¹³å°çš„æ ¸å¿ƒå°±æ˜¯è§†é¢‘ï¼Œè€Œæ•°æ®æ¨¡å—åˆ™æ˜¯ç”¨æˆ·ä»¥åŠåˆ›ä½œè€…çš„â€œæƒ…æŠ¥éƒ¨é—¨â€ï¼Œå› æ­¤è¿™ä¸¤éƒ¨åˆ†åœ¨ç³»ç»Ÿä¸­ç›¸å½“å…³é”®ã€‚ç›¸ä¿¡æœ‰äº†å‰é¢çš„å­¦ä¹ ç§¯ç´¯ï¼Œåªè¦ä½ è€å¿ƒè·Ÿç€æˆ‘çš„æ€è·¯èµ°ï¼Œè¿™ä¸¤éƒ¨åˆ†çš„æ¥å£å¼€å‘å®æˆ˜ä½ ä¹Ÿèƒ½è½»æ¾è·Ÿä¸Šã€‚æˆ‘ä»¬å…ˆä»è§†é¢‘æ¨¡å—çš„æ¥å£åˆ†ç±»å¼€å§‹è¯´èµ·ã€‚

## è§†é¢‘æ¨¡å—æ¥å£åˆ†ç±»

è§†é¢‘æ¨¡å—æ•´ä½“çš„åŠŸèƒ½ç»†åˆ†éå¸¸å…¨é¢ã€‚ä¸è¿‡å½’çº³èµ·æ¥ä¸»è¦å°±æ˜¯ä¸¤ä¸ªç±»åˆ«ã€‚

é¦–å…ˆæ˜¯å±•ç¤ºå‹æ¥å£ï¼Œåœ¨è§†é¢‘åˆ—è¡¨é¡µä¸­ï¼Œæˆ‘ä»¬è¦æ ¹æ®ä¸åŒç±»åˆ«æ¥è·å–è§†é¢‘æ•°æ®ï¼Œåœ¨ç”¨æˆ·ç‚¹å‡»è§†é¢‘æŸ¥çœ‹è¯¦æƒ…æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æŸ¥è¯¢è§†é¢‘ç›¸å…³æ•°æ®å¹¶åœ¨å‰ç«¯å‘ˆç°ã€‚å…¶æ¬¡å°±æ˜¯**æ“ä½œå‹æ¥å£**ï¼Œæ¯”å¦‚è§†é¢‘æ¨¡å—ç›¸å…³æ“ä½œæ¥å£çš„å®ç°ï¼Œä¾‹å¦‚ç‚¹èµã€æ”¶è—ã€å…³æ³¨ç­‰æ“ä½œã€‚

æ¥å£ç±»å‹ä¸åŒï¼Œå®ç°æ€è·¯ä¹Ÿæœ‰å·®å¼‚ï¼Œéœ€è¦æˆ‘ä»¬åˆ†ç±»å¤„ç†ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¦‚ä½•å®ç°è§†é¢‘åˆ—è¡¨çš„æ¥å£ã€‚

### è§†é¢‘è“å›¾æ¨¡å—æ³¨å†Œ

ç¬¬ä¸€æ­¥å°±æ˜¯æ¨¡å—æ³¨å†Œã€‚å› ä¸ºä¸ŠèŠ‚è¯¾å·²ç»å®Œæˆäº†ç³»ç»Ÿç›¸å…³é…ç½®ï¼Œä¹‹åçš„æ¥å£å¼€å‘é‡Œæˆ‘ä»¬å°±ä¸éœ€è¦å•ç‹¬é…ç½®äº†ã€‚è¿™é‡Œæˆ‘ä»¬åªéœ€è¦åœ¨åˆ›å»ºæ¥å£apiåŒ…ç›®å½•çš„\_\_init\_\_.pyä¸­ï¼Œå®Œæˆè§†é¢‘æ¨¡å—çš„è“å›¾æ³¨å†Œï¼Œåœ¨åŸæœ‰çš„ä»£ç å—ä¸‹ç›´æ¥å†™å…¥å³å¯ã€‚

```plain
from api.modules.video import video_blu
    app.register_blueprint(video_blu)
```

### åˆ›å»ºè§†é¢‘æ•°æ®åº“è¡¨

å®Œæˆè“å›¾çš„æ³¨å†Œåï¼Œç¬¬äºŒæ­¥æ˜¯å®ç°è§†é¢‘ç›¸å…³çš„æ•°æ®åº“è¡¨ã€‚æˆ‘ä»¬ä»ç„¶åœ¨é¡¹ç›®modelsæ–‡ä»¶ä¸‹æ“ä½œï¼Œåˆ›å»ºvideo.pyæ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­çš„VideoInfoç±»çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºã€‚

```plain
class VideoInfo(db.Model):
    __tablename__ = "video_data"
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    imdb_id = db.Column(db.String(16), unique=True)  # IMDBæ•°æ®åº“ä¸­ç”µå½±çš„å”¯ä¸€ID
    movie_id = db.Column(db.String(16))  # ç”µå½±ID
    tmdb_id = db.Column(db.String(16))  # TMDBæ•°æ®åº“ä¸­ç”µå½±çš„å”¯ä¸€ID
    title = db.Column(db.String(255))  # æ ‡é¢˜
    little_img_src = db.Column(db.String(255))  # æ’è¡Œå°å›¾ç‰‡è·¯å¾„  45*67
    detail_url = db.Column(db.String(255))  # è¯¦æƒ…é¡µé¢url
    rating = db.Column(db.String(255))  # æ’è¡Œå¾—åˆ†
    time = db.Column(db.String(255))  # æ—¶é•¿
    catogery = db.Column(db.String(255))  # åˆ†ç±»
    show_info = db.Column(db.String(255))  # ä¸Šæ˜ ä¿¡æ¯
    summary_text = db.Column(db.String(255))  # æ‘˜è¦æè¿°
    director = db.Column(db.String(255))  # æ‘˜è¦æè¿°
    writers = db.Column(db.String(255))  # ä½œè€…
    stars = db.Column(db.String(255))  # æ˜æ˜Ÿ
    storyline = db.Column(db.String(255))  # æƒ…èŠ‚æè¿°
    img_src = db.Column(db.String(255))  # 182-268
    video_img_src = db.Column(db.String(255))  # 477-268
    video_href = db.Column(db.String(255))  # è§†é¢‘è¯¦æƒ…url
    true_video_url = db.Column(db.String(1024))  # çœŸå®è§†é¢‘url
    local_video_src = db.Column(db.String(255))  # æœ¬åœ°è§†é¢‘è·¯å¾„
    new_video_url = db.Column(db.String(255))  # æœåŠ¡å™¨è§†é¢‘url
    local_img_src = db.Column(db.String(255))  # æœåŠ¡å™¨æœ¬åœ°imgurl
    new_img_url = db.Column(db.String(255))  # æœåŠ¡å™¨å¤–ç½‘imgurl
    local_video_img_src = db.Column(db.String(255))  # æœåŠ¡å™¨æœ¬åœ°videoimgurl
    new_video_img_url = db.Column(db.String(255))  # æœåŠ¡å™¨å¤–ç½‘vi
    download_timeout = db.Column(db.String(16))
    download_slot = db.Column(db.String(16))
    download_latency = db.Column(db.String(32))
    depth = db.Column(db.String(16))
```

ä»¥ä¸Šå°±æ˜¯ä¸è§†é¢‘ä¿¡æ¯ç›¸å…³çš„è¡¨å­—æ®µã€‚æ²¡é”™ï¼Œè¿™äº›å­—æ®µéœ€è¦æˆ‘ä»¬åœ¨åŠŸèƒ½å¼€å‘å‰ï¼Œç»“åˆéœ€æ±‚äº‹å…ˆæ¢³ç†å‡ºæ¥çš„ã€‚ä¼°è®¡çœ‹åˆ°è¿™ä¹ˆå¤šå­—æ®µï¼Œä½ ä¼šæœ‰ç‚¹ç–‘æƒ‘ï¼Œåˆ«æ‹…å¿ƒï¼Œè¿™é‡Œä½ å…ˆæ•´ä½“çœ‹çœ‹æœ‰ä¸ªå°è±¡å°±è¡Œï¼Œåé¢çš„æ¥å£å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç”¨åˆ°å“ªéƒ¨åˆ†å­—æ®µè¿˜ä¼šç›¸åº”å»è®²è§£å®ƒä»¬çš„ç”¨é€”ã€‚

### çƒ­åº¦è§†é¢‘æ¥å£å®ç°

å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œæ¥å£å¯ä»¥åˆ†æˆå±•ç¤ºå‹æ¥å£å’Œæ“ä½œå‹æ¥å£ã€‚

å±•ç¤ºå‹æ¥å£çš„å®ç°é€»è¾‘æ˜¯ç›¸ä¼¼çš„ï¼Œæ— è®ºæ˜¯æ¨èè§†é¢‘åˆ—è¡¨ã€çƒ­é—¨è§†é¢‘åˆ—è¡¨ã€ç”µå½±ç±»åˆ«ã€æ¸¸æˆç±»åˆ«ç­‰ç­‰ï¼Œåªæ˜¯è§†é¢‘æŸ¥è¯¢çš„æ–¹å¼æœ‰æ‰€ä¸åŒã€‚æˆ‘ä»¬è¿™å°±ç»“åˆçƒ­é—¨è§†é¢‘çš„æ¥å£å®ç°ä»£ç æ¥çœ‹çœ‹ã€‚

```plain
@video_blu.route("/hot")
@youke_identify
def hot():
    """
    # è·å–çƒ­ç‚¹è§†é¢‘ä¿¡æ¯
    # è¯·æ±‚è·¯å¾„: /video/hot
    # è¯·æ±‚æ–¹å¼: GET
    :return:
    """
    if g.user:
        user_action_log.warning({
            'user_id': g.user.id,
            'url': f'/video/hot',
            'method': 'get',
            'msg': 'video hot',
            'event': 'hot',
        })
    videos = ContentMain.query.filter_by(audit_status=0).all()
    choice_videos = random.sample(videos, 8)
    detail_info = []
    for i in choice_videos:
        detail_info.append(i.json())
    return success(msg='è·å–çƒ­ç‚¹è§†é¢‘æˆåŠŸ', data=detail_info)

```

è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬è¦é‡ç‚¹å…³æ³¨ä¸‰ä¸ªéƒ¨åˆ†ã€‚

ç¬¬ä¸€éƒ¨åˆ†æ˜¯ç¬¬10è¡Œä»£ç å¼€å§‹åˆ°ç¬¬17è¡Œä»£ç ï¼Œä½œç”¨æ˜¯è®°å½•æ—¥å¿—çš„è¡Œä¸ºæ—¥å¿—ã€‚å¦‚æœg.userå­˜åœ¨ï¼Œå°±è¡¨ç¤ºå½“å‰ç”¨æˆ·æ˜¯å·²ç»ç™»å½•çš„çŠ¶æ€ï¼Œå…¶ä¸­gæ˜¯ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œç”¨æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ã€‚user\_action\_logæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„æ—¥å¿—è®°å½•å™¨å¯¹è±¡ï¼Œå®ƒåœ¨è¿™é‡Œå……å½“warningæ–¹æ³•çš„å‚æ•°ï¼Œè¡¨ç¤ºå°†æ—¥å¿—è®°å½•ä¸ºè­¦å‘Šçº§åˆ«ã€‚å…¶ä¸­çš„å‚æ•°ä½ å¯ä»¥å‚è€ƒåé¢çš„è¡¨æ ¼ã€‚

![](https://static001.geekbang.org/resource/image/03/9d/0378352146c24d8b7a94b8650824e89d.jpg?wh=3213x1515)

gè¿™ä¸ªå…¨å±€å¯¹è±¡ä¸»è¦ç”¨äºæŸ¥è¯¢ç”¨æˆ·çŠ¶æ€ï¼Œæˆ‘ä»¬æ”¾åœ¨é¡¹ç›®çš„apiæ–‡ä»¶ä¸‹çš„utilsä¸‹çš„common.pyæ–‡ä»¶å†…ï¼Œå…·ä½“çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºã€‚

```plain
def youke_identify(view_func):
    @wraps(view_func)
    def wrapper(*args, **kwargs):
        response = Auth().identify(request)
        if response.get('code') == 200:
            user_id = response.get('data')['user_id']
            # æŸ¥è¯¢ç”¨æˆ·å¯¹è±¡
            user = None
            if user_id:
                try:
                    from api.models.user import UserInfo
                    user = UserInfo.query.get(user_id)
                except Exception as e:
                    current_app.logger.error(e)
            # ä½¿ç”¨gå¯¹è±¡ä¿å­˜
            g.user = user

            return view_func(*args, **kwargs)

        else:
            g.user = None
            return view_func(*args, **kwargs)

    return wrapper
    
```

ç¬¬äºŒå—ä»£ç æˆ‘ä»¬æ¥çœ‹ç¬¬18è¡Œï¼Œä»ContentMainè¡¨ä¸­æŸ¥è¯¢8æ¡æ•°æ®ã€‚è¿™é‡Œç”¨åˆ°äº†queryè¿‡æ»¤å™¨æŸ¥è¯¢audit\_statusä¸º0çš„æ‰€æœ‰è§†é¢‘ï¼Œç„¶åä»ä¸­éšæœºé€‰æ‹©8æ¡ï¼Œå­˜å‚¨åœ¨choice\_videosã€‚audit\_statuså°±æ˜¯æˆ‘ä»¬æ ‡æ³¨çš„è§†é¢‘çŠ¶æ€ï¼Œè¡¨ç¤ºå·²ç»æŠ•å…¥å¹³å°ã€å¯ä»¥ç›´æ¥è§‚çœ‹çš„çŠ¶æ€ã€‚

æ¥ä¸‹æ¥å°±æ˜¯æ¯”è¾ƒæ ¸å¿ƒçš„ç¬¬ä¸‰å—ä»£ç ï¼Œä¹Ÿæ˜¯å°±æ˜¯ä»£ç ä¸­çš„19è¡Œï¼Œè¿™æ®µä»£ç çš„é€»è¾‘æ˜¯æŸ¥è¯¢å®Œæ•°æ®åï¼Œæˆ‘ä»¬è¦å°†æ•°æ®ä»¥JSONçš„æ ¼å¼æ·»åŠ åˆ°detail\_infoåˆ—è¡¨ä¸­ï¼Œæœ€åå°è£…è¿”å›detail\_Infoã€‚åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å®Œæˆäº†å¸¸è§„æ•°æ®æŸ¥è¯¢ç±»æ¥å£åŠŸèƒ½çš„å¼€å‘ã€‚

### è§†é¢‘æ’è¡Œæ¦œæ¥å£å®ç°

é™¤äº†å¸¸è§„æŸ¥è¯¢ï¼Œæ¡ä»¶æŸ¥è¯¢æ¥å£ä¹Ÿå¾ˆå¸¸ç”¨ã€‚å½“ç„¶è¿™ç§æ–¹å¼ä¹Ÿé€‚ç”¨äºæŒ‰è§†é¢‘ç±»åˆ«æŸ¥è¯¢ã€‚æˆ‘ä»¬ä»¥è§†é¢‘æ’è¡Œæ¦œæ¥å£ä¸ºæ¡ˆä¾‹ï¼Œæ¥ä¸€èµ·å­¦ä¹ å®è·µä¸€ä¸‹ã€‚

æˆ‘ä»¬è¿˜æ˜¯å…ˆçœ‹ä¸€ä¸‹æ•´ä½“ä»£ç ï¼Œå†é€æ­¥åˆ†æã€‚

```plain
@video_blu.route('/rank')
def rank():
    """
    è·å–é¦–é¡µæ’è¡Œæ¦œä¿¡æ¯
    # è¯·æ±‚è·¯å¾„: /video/rank
    # è¯·æ±‚æ–¹å¼: GET
    :return:  jsonæ•°æ®
        code: 0
        data:[{"id": id,"title": title},{}...,{"id": id,"title": title}]  len=10
    """
    rank_video = []
    # æŸ¥è¯¢å‰10æ¡çƒ­é—¨
    try:
        rank_video = ContentMain.query.filter(ContentMain.status == 0).order_by(ContentMain.clicks.desc()).limit(
            constants.CLICK_RANK_MAX_NEWS).all()
    except Exception as e:
        current_app.logger.error(e)
    if rank_video:
        # å°†è§†é¢‘å†…å®¹å¯¹è±¡åˆ—è¡¨è½¬æˆå­—å…¸åˆ—è¡¨
        rank_video_list = []
        for video in rank_video:
            rank_video_list.append(video.to_rank_dict())

        data = {
            "data": rank_video_list,
        }
        return success(msg='è·å–æ’è¡Œæ¦œä¿¡æ¯æˆåŠŸ', data=data)
    else:
        return error(code=HttpCode.db_error, msg='æœªè·å–top10è§†é¢‘ï¼ŒæŸ¥è¯¢æœ‰è¯¯')

```

ä½ ä¼šå‘ç°æ•´ä¸ªå®ç°è¿‡ç¨‹ä¸­ï¼Œé‡ç‚¹å°±æ˜¯**æ•°æ®æŸ¥è¯¢è¯­å¥è¯¥å¦‚ä½•è®¾è®¡**ã€‚

æˆ‘ä»¬éœ€è¦è·å–rank\_videoä»¥åŠæŸ¥è¯¢è§†é¢‘å†…å®¹è¡¨ContentMainã€‚ContentMainä¸­æœ‰ä¸¤ä¸ªæ¡ä»¶ï¼Œç¬¬ä¸€ä¸ªæ˜¯ContentMain.status == 0ï¼Œè¡¨ç¤ºå¯ç”¨äºå¹³å°ä½¿ç”¨çš„è§†é¢‘ï¼Œç´§æ¥ç€æ˜¯order\_by(ContentMain.clicks.desc())ï¼Œæ ¹æ®è§†é¢‘ç‚¹å‡»è¿›è¡Œæ’åºï¼Œè¿”å›æ•°æ®é›†å³å¯ã€‚

### ç‚¹èµæ¥å£çš„å®ç°

å±•ç¤ºå‹æ¥å£çš„å®ç°æˆ‘ä»¬å·²ç»æ¸…æ¥šäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ“ä½œå‹æ¥å£çš„å®ç°ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥ç‚¹èµæ¥å£ä¸ºä¾‹ï¼Œå› ä¸ºå®ƒåœ¨åŠŸèƒ½æ“ä½œæ¥å£ä¸­å…·å¤‡ä¸€å®šçš„ä»£è¡¨æ€§ã€‚ä½ å¯ä»¥å…ˆçœ‹çœ‹ä»£ç ï¼Œå†å¬æˆ‘åˆ†å—å„¿è®²è§£ã€‚

```plain
@video_blu.route('/like/<int:video_id>', methods=['GET', 'POST'])
@auth_identify
def like(video_id):
    """
    ç‚¹èµ
    :param video_id:
    :return:
    """
    if request.method == 'GET':
        user_id = g.user.id
        # ç‚¹èµ
        like = ContentLike.query.filter_by(content_id=video_id, user_id=user_id, status=1).first()
        return success(msg='è·å–ç‚¹èµä¿¡æ¯æˆåŠŸ', data={'like': 1 if like else 0})

    data_dict = request.form
    user_id = g.user.id
    like = data_dict.get('like')
    try:
        like_event = ContentLike.query.filter_by(content_id=video_id, user_id=user_id).first()
    except Exception as e:
        current_app.logger.error(e)
        return error(code=HttpCode.db_error, msg='æŸ¥è¯¢ç‚¹èµå‡ºé”™')
    if like_event:
        like_event.status = 1 if like == '1' else 0
        like_event.update()
        if like_event.status == 0:
            user_action_log.warning({
                'user_id': user_id,
                'url': f'/video/like/{video_id}',
                'method': 'post',
                'msg': 'video cancel like',
                'event': 'no_like',
            })
            return success(msg='å–æ¶ˆç‚¹èµæˆåŠŸ')
        else:
            user_action_log.warning({
                'user_id': user_id,
                'url': f'/video/like/{video_id}',
                'method': 'post',
                'msg': 'video like',
                'event': 'like',
            })
            return success(msg='ç‚¹èµæˆåŠŸ')
    like_event = ContentLike()
    like_event.user_id = user_id
    like_event.content_id = video_id
    like_event.status = 1 if like == '1' else 0
    like_event.add(like_event)
    if like_event.status == 0:
        user_action_log.warning({
            'user_id': user_id,
            'url': f'/video/like/{video_id}',
            'method': 'post',
            'msg': 'video cancel like',
            'event': 'no_like',
        })
        return success(msg='å–æ¶ˆç‚¹èµæˆåŠŸ')
    else:
        user_action_log.warning({
            'user_id': user_id,
            'url': f'/video/like/{video_id}',
            'method': 'post',
            'msg': 'video like',
            'event': 'like',
        })
        return success(msg='ç‚¹èµæˆåŠŸ')
```

è§†é¢‘ç‚¹èµçš„åº”ç”¨åœºæ™¯å°±æ˜¯åœ¨ç”¨æˆ·è¿›å…¥åˆ°è§†é¢‘è¯¦æƒ…é¡µä¹‹åï¼Œå¦‚æœå¯¹è§†é¢‘å†…å®¹æ¯”è¾ƒå–œæ¬¢ï¼Œå¯ä»¥ç›´æ¥ç‚¹å‡»ç‚¹èµæŒ‰é’®æ¥å®Œæˆç‚¹èµçš„æ“ä½œã€‚åœ¨æ•´ä¸ªæ¥å£å®ç°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæŸ¥è¯¢å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµè¿‡è¯¥è§†é¢‘ã€‚å¦‚æœå·²ç»ç‚¹èµï¼Œåˆ™ç”¨æˆ·è¿›å…¥ç•Œé¢æ—¶ï¼Œç‚¹èµå›¾æ ‡å°±æ˜¯çº¢è‰²ï¼Œå¦åˆ™å›¾æ ‡é¢œè‰²ä¸ºç°è‰²ã€‚

æˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹ä»£ç é€»è¾‘ã€‚ç¬¬ä¸€æ­¥æ˜¯æŸ¥è¯¢çŠ¶æ€ï¼Œä»£ç ç¬¬14è¡Œå«ä¹‰æ˜¯æŸ¥è¯¢ContentLikeå†…å®¹è¡¨ï¼Œå°†ç»“æœå­˜å‚¨åœ¨likeä¸­ï¼Œ1è¡¨ç¤ºç‚¹èµï¼Œ0è¡¨ç¤ºæœªç‚¹èµã€‚

ç¬¬äºŒæ­¥æ˜¯ä¿¡æ¯è·å–ï¼Œé€šè¿‡request.formè·å–è¡¨å•æ•°æ®ï¼ŒåŒæ—¶è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„IDï¼Œè¿™é‡Œç›´æ¥é€šè¿‡g.user.idè·å–ã€‚

ç¬¬ä¸‰æ­¥æ˜¯æŸ¥è¯¢éªŒè¯ã€‚ä»ä»£ç çš„19è¡Œå¼€å§‹ï¼Œæˆ‘ä»¬è¦æŸ¥è¯¢æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨è¯¥ç”¨æˆ·å¯¹è¯¥è§†é¢‘çš„ç‚¹èµè®°å½•ï¼ˆå³ContentLikeè¡¨ä¸­content\_idå’Œuser\_idä¸è§†é¢‘IDå’Œç”¨æˆ·IDåŒ¹é…çš„è®°å½•ï¼‰ã€‚å¦‚æœæŸ¥è¯¢å‡ºç°å¼‚å¸¸ï¼Œå°†é”™è¯¯ä¿¡æ¯è®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œå¹¶è¿”å›ä¸€ä¸ªé”™è¯¯å“åº”ã€‚

ä»ä»£ç ç¬¬23è¡Œå¼€å§‹ï¼Œå¦‚æœå­˜åœ¨ç‚¹èµè®°å½•ï¼Œæˆ‘ä»¬å°±æ ¹æ®ç”¨æˆ·ç‚¹å‡»çš„æŒ‰é’®ï¼ˆlikeå­—æ®µï¼‰æ¥æ›´æ–°ç‚¹èµçŠ¶æ€ï¼Œç„¶åæ›´æ–°æ•°æ®åº“ä¸­çš„è®°å½•ã€‚ä»ä»£ç çš„47è¡Œå¼€å§‹ï¼Œå¦‚æœç‚¹èµçŠ¶æ€ä¸º0ï¼ˆå–æ¶ˆç‚¹èµï¼‰ï¼Œåˆ™è®°å½•ä¸€ä¸ªè­¦å‘Šæ—¥å¿—ï¼Œå¹¶è¿”å›ä¸€ä¸ªæˆåŠŸå“åº”ï¼Œæç¤ºç”¨æˆ·å–æ¶ˆç‚¹èµæˆåŠŸã€‚æ•´ä½“å®ç°é€»è¾‘å°±æ˜¯æ ¹æ®ç”¨æˆ·æ“ä½œï¼Œæ›´æ–°æ•°æ®åº“ä¸­çš„ç‚¹èµçŠ¶æ€ï¼ŒåŒæ—¶è¦è®°å½•ç›¸åº”çš„ç”¨æˆ·è¡Œä¸ºæ—¥å¿—ã€‚

## æ•°æ®æ¨¡å—æ¥å£å®æˆ˜

æ•°æ®æ¨¡å—ä¸­ä¸»è¦æ¶‰åŠä¸è§†é¢‘ç›¸å…³çš„æ•°æ®ï¼Œæˆ‘ä»¬æ ¹æ®ä¸åŒç»´åº¦ç»Ÿè®¡æ•°æ®å¹¶å‘ˆç°åˆ°å‰ç«¯é¡µé¢ã€‚é‚£å¦‚ä½•å®ç°æ•°æ®æ¨¡å—æ¥å£ï¼Ÿ

æˆ‘ä»¬ç»“åˆæŸ¥è¯¢æ’­æ”¾æ—¶é•¿å‰10çš„è§†é¢‘çš„ä»£ç ä¸ºä¾‹ä¸€èµ·æ¥çœ‹çœ‹ã€‚

```plain
@video_blu.route('statistics')
def statistics():
    hap = HappyHbase(host='10.20.10.168', port=9090)
    play_counts_list, play_times_list = hap.scan_start_stop(b'video')
    hap.close()
    # å°è£…æ•°æ®
    # æ’­æ”¾æ—¶é•¿æ’è¡Œå‰10
    time_x_data = [i.get('content_id') for i in play_times_list]
    time_y_data = [{
        'value': v.get('play_time'),
        'name': ContentMain.query.get(v.get('content_id')).first().title,
        'itemStyle': {
            'color': color_list[k]
        }
    } for k, v in enumerate(play_times_list)]
    counts_x_data = [i.get('content_id') for i in play_counts_list]
    counts_y_data = [{
        'value': v.get('play_counts'),
        'name': ContentMain.query.get(v.get('content_id')).first().title,
        'itemStyle': {
            'color': color_list2[k]
        }
    } for k, v in enumerate(play_counts_list)]
    data = {
        'time_x_data': time_x_data,
        'time_y_data': time_y_data,
        'counts_x_data': counts_x_data,
        'counts_y_data': counts_y_data,
    }

    return success('ok', data=data)
```

é¦–å…ˆï¼Œä»HappyHbaseæ•°æ®åº“ä¸­æ‰«æå‡ºè§†é¢‘çš„æ’­æ”¾æ¬¡æ•°å’Œæ’­æ”¾æ—¶é•¿çš„ä¿¡æ¯ã€‚è¿™é‡Œè°ƒç”¨äº†hap.scan\_start\_stop(bâ€™videoâ€™)æ–¹æ³•ï¼Œä»æ•°æ®åº“ä¸­æ‰«æå‡ºæ‰€æœ‰è§†é¢‘çš„æ’­æ”¾æ¬¡æ•°å’Œæ’­æ”¾æ—¶é•¿çš„ä¿¡æ¯ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨play\_counts\_listå’Œplay\_times\_liståˆ—è¡¨ä¸­ã€‚æ•°æ®å¤„ç†ä¹‹åå°±ä¼šå…³é—­HappyHbaseè¿æ¥ã€‚

ç„¶åï¼Œå°†æ’­æ”¾æ—¶é•¿å’Œæ’­æ”¾æ¬¡æ•°æ•°æ®å°è£…æˆç‰¹å®šçš„æ•°æ®ç»“æ„ã€‚

æ¥ä¸‹æ¥æ˜¯åˆ—è¡¨åˆ›å»ºç¯èŠ‚ã€‚æˆ‘ä»¬åˆ›å»ºäº†åä¸ºtime\_x\_dataå’Œtime\_y\_dataçš„åˆ—è¡¨ï¼Œåˆ†åˆ«ç”¨æ¥å­˜å‚¨æ’­æ”¾æ—¶é•¿æ’è¡Œå‰10çš„content\_idå’Œå¯¹åº”çš„æ’­æ”¾æ—¶é•¿ã€æ ‡é¢˜ç­‰ä¿¡æ¯ã€‚å†æŠŠå°è£…å¥½çš„æ•°æ®å­˜å‚¨åœ¨dataå­—å…¸ä¸­ã€‚  
æœ€åï¼Œæ¥å£è¿”å›ä¸€ä¸ªæˆåŠŸçš„å“åº”ï¼ŒçŠ¶æ€ç ä¸ºokï¼Œå¹¶å°†å°è£…å¥½çš„æ•°æ®ä½œä¸ºå“åº”çš„dataå‚æ•°è¿”å›ç»™å®¢æˆ·ç«¯ã€‚æœ€ç»ˆå‰ç«¯åœ¨ç³»ç»Ÿå†…å‘ˆç°æ•°æ®ç»“æœå³å¯ã€‚

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å®Œæˆäº†ç”¨æˆ·ç»´åº¦æ’­æ”¾é‡å‰åè§†é¢‘å±•ç¤ºçš„æ¥å£å¼€å‘ï¼Œç›¸ä¿¡é€šè¿‡è¯¥æ¥å£æ¡ˆä¾‹ï¼Œä½ å®ç°å…¶ä»–æ•°æ®æ¨¡å—æ¥å£ä¹Ÿä¼šéå¸¸è½»æ¾ã€‚

ä¿—è¯è¯´ï¼Œç£¨åˆ€ä¸è¯¯ç æŸ´å·¥ã€‚å®æ“ç¯èŠ‚ä¹‹åï¼Œæˆ‘è¿˜å¸®ä½ æ•´ç†äº†æ¥å£å¼€å‘è¿‡ç¨‹ä¸­çš„ä¸€äº›æ³¨æ„äº‹é¡¹ã€‚å¸Œæœ›èƒ½è®©ä½ åœ¨å¼€å‘è¿‡ç¨‹ä¸­å°‘èµ°å¼¯è·¯ï¼Œå…¨é¢æå‡ä½ çš„æ¥å£å¼€å‘èƒ½åŠ›ï¼Œé¿å…å› ä¸ºæ“ä½œä¸å½“é€ æˆä¸€äº›ä¸å¿…è¦çš„ç³»ç»Ÿé”™è¯¯ã€‚

![](https://static001.geekbang.org/resource/image/b0/62/b05eb2eb0103eedb04baeab24084c362.jpg?wh=3213x1570)

## æ€»ç»“

åˆåˆ°äº†è¯¾ç¨‹çš„å°¾å£°ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·å›é¡¾æ€»ç»“ä¸€ä¸‹ã€‚

è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬èšç„¦è§†é¢‘æ¨¡å—å’Œæ•°æ®æ¨¡å—çš„æ¥å£å¼€å‘ã€‚ä¸éš¾å‘ç°ï¼Œè¯¾ç¨‹æŠŠé‡å¿ƒæ”¾åœ¨äº†å®ç°åŠŸèƒ½é€»è¾‘ä¸Šã€‚æˆ‘ä»¬æŠŠæ¥å£åˆ†ä¸ºä¸¤å¤§ç±»ï¼Œåˆ†åˆ«æ˜¯å±•ç¤ºå‹æ¥å£å’Œæ“ä½œå‹æ¥å£ã€‚å±•ç¤ºå‹æ¥å£çš„æ ¸å¿ƒæ˜¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€šè¿‡è¿‡æ»¤å™¨queryï¼Œç»“åˆæŸ¥è¯¢æ¡ä»¶ä»è€Œè·å–æ•°æ®ã€‚åœ¨è·å–åˆ°æ•°æ®ä¹‹åï¼Œä¸€å®šè¦å¯¹æ•°æ®è¿›è¡Œå°è£…å¤„ç†ï¼Œè¿™æ ·æ›´æœ‰åˆ©äºå‰ç«¯æ•°æ®å‘ˆç°ã€‚

åœ¨æ•´ä¸ªå¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬ç”¨åˆ°å¾ˆå¤šçš„å¼‚å¸¸å¤„ç†ï¼Œå¸Œæœ›ä½ æ³¨æ„åŸ¹å…»è‡ªå·±çš„å¼‚å¸¸å¤„ç†æ„è¯†ï¼Œå°½å¯èƒ½è€ƒè™‘å‘¨å…¨ï¼Œåœ¨ä¿è¯ç¨‹åºç¨³å®šè¿è¡Œçš„åŒæ—¶ï¼Œä¹Ÿè¦ä¿è¯ç”¨æˆ·çš„ä¼˜è´¨ä½“éªŒã€‚

æˆ‘ä»¬é€‰æ‹©äº†ç‚¹èµæ“ä½œï¼Œä½œä¸ºæ“ä½œå‹æ¥å£çš„å…¸å‹ä»£è¡¨ã€‚å¯¹äºæ“ä½œå‹æ¥å£ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å¯¹æ“ä½œçŠ¶æ€è¿›è¡ŒæŸ¥è¯¢ï¼Œåœ¨é¡µé¢åŠ è½½æ—¶ï¼Œæˆ‘ä»¬å°±è¦åœ¨å‰ç«¯å‘ˆç°æ“ä½œçŠ¶æ€ã€‚

å¯¹äºæ•°æ®æ¨¡å—çš„æ¥å£ï¼Œå› ä¸ºæˆ‘ä»¬é¡¹ç›®å‰ç«¯ä¸»è¦ç”¨EChartsæ¥å‘ˆç°ç•Œé¢ï¼Œæ‰€ä»¥è¦å°è£…å¤„ç†å¥½è¿”å›å‰ç«¯çš„æ•°æ®ã€‚è‡³äºæŸ¥è¯¢è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯é€šè¿‡å¯¹åº”çš„éœ€æ±‚æ¡ä»¶æ¥å®Œæˆå³å¯ã€‚æœ€åï¼Œæˆ‘è¿˜æ•´ç†äº†ä¸€äº›å¼€å‘è¿‡ç¨‹ä¸­çš„æ³¨æ„äº‹é¡¹ï¼Œè®©ä½ èƒ½å¤Ÿæ›´å…¨é¢åœ°æŒæ¡æ¥å£å¼€å‘å®è·µã€‚

## æ€è€ƒé¢˜

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œç”¨æˆ·åœ¨ç‚¹èµå’Œæ”¶è—ç­‰æ“ä½œä¹‹åï¼Œå¯¹åº”æ“ä½œçš„è§†é¢‘ä½œå“ä¼šåœ¨â€œæˆ‘çš„å…³æ³¨â€åˆ—è¡¨ä¸­å±•ç¤ºã€‚é‚£ä½ è§‰å¾—åœ¨â€œæˆ‘çš„å…³æ³¨â€åˆ—è¡¨ä¸­æ˜¯å¦‚ä½•å®ç°æŸ¥è¯¢çš„å‘¢ï¼Ÿ

æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºå’Œæˆ‘äº¤æµäº’åŠ¨ï¼Œä¹Ÿæ¨èä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™èº«è¾¹æ›´å¤šæœ‹å‹ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ1ï¼‰</strong></div><ul>
<li><span>peter</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯·æ•™è€å¸ˆä¸¤ä¸ªé—®é¢˜ï¼š
Q1ï¼šæ¥å£å¼€å‘ï¼Œæœ‰è¾…åŠ©å¼€å‘çš„å·¥å…·å—ï¼Ÿ
Q2ï¼šè§†é¢‘ç½‘ç«™ä¸»è¦çš„æˆæœ¬æ˜¯å¸¦å®½å—ï¼Ÿç°åœ¨å¸¦å®½ä»·æ ¼å¤§çº¦æ˜¯å¤šå°‘ï¼Ÿæ¯”å¦‚1Gå¸¦å®½ä¸€ä¸ªæœˆçš„è´¹ç”¨å¤§è‡´å¤šå°‘ï¼Ÿ</p>2023-06-30</li><br/>
</ul>