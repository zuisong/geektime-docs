ä½ å¥½ï¼Œæˆ‘æ˜¯äºèˆªã€‚

åœ¨ [23 è®²](https://time.geekbang.org/column/article/486342) ä¸­ï¼Œæˆ‘å¯¹æœ¬æ¬¡å®æˆ˜é¡¹ç›®å°†è¦æ„å»ºçš„ç¨‹åº FibServ çš„åŠŸèƒ½åšäº†åŸºæœ¬ä»‹ç»ï¼Œå¹¶ä»ç†è®ºçš„è§’åº¦ï¼Œå¸¦ä½ å¯¹å®ƒçš„åŸºæœ¬å®ç°æ–¹æ¡ˆæœ‰äº†ä¸€ä¸ªåˆæ­¥è®¤è¯†ã€‚è€Œè¿™ä¸€è®²ï¼Œæˆ‘ä»¬å°†é€šè¿‡å®é™…ç¼–ç ï¼Œæ¥åº”ç”¨è¿™äº›ç†è®ºçŸ¥è¯†ã€‚

ä¸ºäº†ä¾¿äºä½ ç†è§£è¿™ä¸€è®²çš„å†…å®¹ï¼Œæˆ‘å·²ç»å°†æœ¬é¡¹ç›®çš„å®Œæ•´ä»£ç å®ç°æ”¾åˆ°äº† GitHub ä¸Šï¼Œä½ å¯ä»¥ç‚¹å‡»[è¿™ä¸ªé“¾æ¥](https://github.com/Becavalier/tiny-http-echo-server/tree/geektime)ï¼Œå…ˆå¤§è‡´æµè§ˆä¸€ä¸‹æ¯ä¸ªæºæ–‡ä»¶çš„å†…å®¹ã€‚è€Œåœ¨åç»­è®²è§£åˆ°ç›¸å…³ä»£ç æ—¶ï¼Œæˆ‘ä¹Ÿä¼šåœ¨æ•´æ®µä»£ç çš„ç¬¬ä¸€è¡Œï¼Œé€šè¿‡æ³¨é‡Šçš„æ–¹å¼å°†è¿™äº›ä»£ç çš„æ‰€åœ¨æºæ–‡ä»¶æ ‡æ³¨å‡ºæ¥ã€‚æ¯”å¦‚æ³¨é‡Š â€œlibs/structs.h#L9-L11â€ï¼Œä¾¿è¡¨ç¤ºå½“å‰æ‰€ç¤ºçš„ä»£ç æ®µå¯¹åº”äºé¡¹ç›® libs ç›®å½•ä¸‹ï¼Œstructs.h æ–‡ä»¶å†…çš„ç¬¬ 9 åˆ° 11 è¡Œã€‚å…¶ä»–æ³¨é‡Šçš„å«ä¹‰ä½ å¯ä»¥æ­¤ç±»æ¨ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šå¸¦ä½ ä»åŸºæœ¬çš„é¡¹ç›®ç›®å½•åˆ›å»ºï¼Œåˆ°æ¨¡å—åŠŸèƒ½ç¼–å†™ï¼Œå†åˆ°ä»£ç ç¼–è¯‘å’Œç¨‹åºè¿è¡Œï¼Œä¸€æ­¥æ­¥åœ°å®Œæˆæ•´ä¸ªé¡¹ç›®çš„å¼€å‘è¿‡ç¨‹ã€‚

## é¡¹ç›®åŸºæœ¬ç»“æ„

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹åº”è¯¥å¦‚ä½•ç»„ç»‡æ•´ä¸ªé¡¹ç›®çš„ç›®å½•ç»“æ„ã€‚æ ¹æ®é¢„ä¼°çš„é¡¹ç›®ä½“é‡ï¼Œæˆ‘ä½¿ç”¨äº†å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ç›®å½•ç»“æ„ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/f9/8c/f9fcf00722c6b785052f1yyd8d27aa8c.png?wh=760x616)

è¿™é‡Œï¼Œæ•´ä¸ªé¡¹ç›®åŒ…å«æœ‰ä¸‰ä¸ªç›®å½•ï¼šbuildã€libs ä»¥åŠ srcã€‚å…¶ä¸­ï¼Œbuild ç›®å½•ç”¨äºå­˜æ”¾ç¨‹åºåœ¨ CMake ä¸‹çš„ä¸´æ—¶ç¼–è¯‘ç»“æœã€‚å¦‚æœä½ å¯¹è¿™ä¸ªç›®å½•è¿˜ä¸å¤ªç†Ÿæ‚‰ï¼Œå¯ä»¥å‚è€ƒæˆ‘åœ¨ [22 è®²](https://time.geekbang.org/column/article/485191) ä¸­ä¸ºä½ ä»‹ç»çš„ä¾‹å­ã€‚libs ç›®å½•ä¸­ä¸»è¦å­˜æ”¾å¯ä»¥æ¨¡å—åŒ–çš„ç‹¬ç«‹åŠŸèƒ½å®ç°ï¼Œè¿™äº›åŠŸèƒ½ä¼šä»¥å¤´æ–‡ä»¶çš„å½¢å¼æ¥æä¾›å¤–éƒ¨å¯ç”¨æ¥å£ï¼Œä»¥ä¾›ä¸åŒçš„åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚è€Œæœ€åçš„ src ç›®å½•åˆ™å­˜æ”¾æœ‰ä¸åº”ç”¨ç¨‹åº FibServ å®ç°ç›¸å…³çš„æºä»£ç ã€‚

åœ¨æ­¤åŸºç¡€ä¹‹ä¸Šï¼Œä½ ä¼šå‘ç°æˆ‘ä»¬åˆ†åˆ«åœ¨ libs ç›®å½•ä¸é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼ŒåŒæ—¶åˆ›å»ºäº†ç”¨äºæ§åˆ¶ CMake ç¼–è¯‘æµç¨‹çš„ CMakeLists.txt æ–‡ä»¶ã€‚å…¶ä¸­ï¼Œå‰è€…ä¸»è¦ç”¨äºæ§åˆ¶ libs ç›®å½•å†… C æºä»£ç çš„ç¼–è¯‘æµç¨‹ï¼›è€Œåè€…åˆ™ç”¨äºæ§åˆ¶åº”ç”¨ç¨‹åº FibServ çš„ç¼–è¯‘æµç¨‹ã€‚æˆ‘åœ¨è¿™ä¸€è®²åé¢çš„â€œç¼–è¯‘ä¸è¿è¡Œâ€ä¸€èŠ‚ä¸­ï¼Œè¿˜ä¼šå†å…·ä½“ä»‹ç»è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­çš„é…ç½®é¡¹ã€‚

## å¤„ç†ç”¨æˆ·è¾“å…¥å‚æ•°

FibServ åœ¨å¯åŠ¨æ—¶å¯ä»¥æ¥æ”¶ä¸€ä¸ªç”±ç”¨æˆ·æŒ‡å®šçš„ï¼Œåä¸º â€œthread\_countâ€ çš„å‚æ•°ã€‚è¿™ä¸ªå‚æ•°è¢«ç”¨äºæ§åˆ¶ FibServ åº”å¯ç”¨å¤šå°‘çº¿ç¨‹æ¥å¤„ç†æ”¶åˆ°çš„ HTTP è¯·æ±‚ã€‚

è¿™é‡Œï¼Œæˆ‘ä¸“é—¨å°è£…äº†ä¸€ä¸ªç”¨äºæè¿°æœåŠ¡å™¨æ•´ä½“é…ç½®çŠ¶æ€çš„ç»“æ„ç±»å‹ serverSettingsï¼Œå…¶ä¸­ä»…æœ‰çš„ threadCount å­—æ®µä¾¿å¯¹åº”äºè¯¥å‚æ•°ï¼Œä»£ç å¦‚ä¸‹ï¼š

```c++
// libs/structs.h#L9-L11
typedef struct {
Â  int threadCount;
} serverSettings;
```

è€Œé€šè¿‡å¯¹ main å‡½æ•°çš„ä¸¤ä¸ªå‚æ•° argc ä¸ argv è¿›è¡Œè§£æï¼Œæˆ‘ä»¬èƒ½å¤Ÿå¾—åˆ°ç”¨æˆ·åœ¨è¿è¡Œç¨‹åºæ—¶ä¼ å…¥çš„æ‰€æœ‰å‚æ•°ã€‚åœ¨åä¸º setupServerSettings çš„å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸Šè¿°è¿™ç§æ–¹å¼ï¼Œå®Œæˆäº†å¯¹ç”¨æˆ·ä¼ å…¥å‚æ•°çš„è§£æä¸ä¿å­˜è¿‡ç¨‹ï¼Œè§£æå¾—åˆ°çš„æ‰€æœ‰åˆæ³•é€‰é¡¹å‡è¢«å­˜æ”¾åœ¨ä¸€ä¸ª serverSettings ç±»å‹çš„å¯¹è±¡ä¸­ã€‚è¯¥å‡½æ•°çš„å®ç°ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```c++
// libs/helpers.h#L67-L86
void setupServerSettings(int argc, const char** argv, serverSettings* ss) {
Â  while (argc-- > 1) {
Â  Â  // process key.
Â  Â  const char* keyHead = argv[argc];
Â  Â  const char* keyPos = strchr(keyHead, '=');
Â  Â  const size_t keyLen = keyPos - keyHead + 1;
Â  Â  char key[keyLen];
Â  Â  wrapStrFromPTR(key, keyLen, keyHead, keyPos);
Â  Â  // process value.
Â  Â  const char* valHead = keyHead + keyLen;
Â  Â  const char* valPos = strchr(valHead, '\0');
Â  Â  const size_t valLen = valPos - valHead + 1;
Â  Â  char val[valLen];
Â  Â  for (size_t i = 0; valHead <= valPos; valHead++)
Â  Â  Â  val[i++] = *valHead;
Â  Â  if (strcmp(key, "thread_count") == 0) {
Â  Â  Â  ss->threadCount = atoi(val);
Â  Â  }
Â  }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡åˆ¤æ–­ argc çš„å€¼æ˜¯å¦å¤§äº 1ï¼ˆç•¥è¿‡ argv çš„ç¬¬ä¸€ä¸ªâ€œç¨‹åºæ–‡ä»¶åâ€å‚æ•°ï¼‰ï¼Œæˆ‘ä»¬ä¾¿èƒ½å¤Ÿå¯¹ç»ç”± argv ä¼ é€’è¿‡æ¥çš„è¾“å…¥å‚æ•°è¿›è¡Œéå†ã€‚æ¯ä¸€æ¬¡çš„éå†è¿‡ç¨‹éƒ½åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼Œå³åˆ†åˆ«è·å–å½¢å¦‚ â€œkey=valueâ€ çš„è®¾ç½®é¡¹çš„ key ä¸ value ä¸¤éƒ¨åˆ†å†…å®¹ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ C æ ‡å‡†åº“ä¸­çš„ strchr å‡½æ•°ï¼Œæ¥å¾—åˆ°æ¯ä¸ªé€‰é¡¹ä¸­ â€œ=â€ ä¸å­—ç¬¦ä¸²ç»“å°¾ç©ºå­—ç¬¦ â€œ\\0â€ çš„ä½ç½®ï¼Œå¹¶ä»¥æ­¤å°†æ•´ä¸ªé€‰é¡¹åˆ†ä¸ºä¸¤æ®µã€‚åœ¨æ­¤åŸºç¡€ä¹‹ä¸Šï¼Œé€šè¿‡åˆ†åˆ«æ”¶é›†è¿™ä¸¤ä¸ªåŒºé—´ï¼ˆé¦–å­—ç¬¦è‡³ â€œ=â€ï¼Œä»¥åŠ â€œ=â€ è‡³ç»“å°¾ç©ºå­—ç¬¦ï¼‰å†…çš„å­—ç¬¦ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå°†ä¸€ä¸ªé€‰é¡¹çš„â€œé”®â€ä¸â€œå€¼â€è¿›è¡Œæ‹†åˆ†ã€‚æœ€åï¼Œä½¿ç”¨ strcmp å‡½æ•°æ¥æ¯”å¯¹æ‰€å¾—åˆ°çš„é”®æ˜¯å¦æœ‰æ•ˆï¼Œè‹¥æœ‰æ•ˆï¼Œåˆ™å°†ç›¸åº”çš„å€¼å­˜å‚¨åˆ°æŒ‡å®šçš„ serverSettings å¯¹è±¡ä¸­ã€‚

è‡³æ­¤ï¼ŒFibServ ä¾¿å®Œæˆäº†ç”¨æˆ·é…ç½®é¡¹çš„åˆå§‹åŒ–å·¥ä½œã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­ä¸ºå®ƒå®ç° TCP Server çš„æ ¸å¿ƒåŠŸèƒ½ã€‚

## å®ç° TCP Server

æ ¹æ®åœ¨ä¸Šä¸€è®²ä¸­å¾—åˆ°çš„ç»“è®ºï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ¥è‡ª POSIX.1 æ ‡å‡†çš„äº”ä¸ªæ¥å£ï¼Œsocketã€bindã€listenã€accept ä¸ closeï¼Œæ¥å®ç°åŸºæœ¬çš„ TCP è¯·æ±‚ç›‘å¬ä¸è¿æ¥åˆ›å»ºç­‰åŠŸèƒ½ã€‚

### ç›‘å¬è¯·æ±‚

ä¸ºäº†å°† FibServ æ¥å—å’Œå¤„ç† HTTP è¯·æ±‚çš„ä»£ç æŠ½ç¦»å‡ºæ¥ï¼Œä»¥æ–¹ä¾¿åç»­çš„å¤šçº¿ç¨‹æ”¹é€ ï¼Œè¿™é‡Œæˆ‘å°† TCP Server çš„å®ç°è¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†æ¥ä»‹ç»ã€‚

é¦–å…ˆæ¥çœ‹å¦‚ä½•è®©ç¨‹åºè¿›å…¥â€œç›‘å¬â€çŠ¶æ€ï¼Œå¹¶æŒç»­ç­‰å¾… TCP è¿æ¥è¯·æ±‚çš„åˆ°æ¥ã€‚è¿™éƒ¨åˆ†ä»£ç å°†ç”± main å‡½æ•°æ‰€åœ¨çº¿ç¨‹æ¥æ‰§è¡Œï¼Œå¯¹åº”çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```c++
// src/main.c#L70-95
int serverFd;Â 
sockaddr_in address;
int addrLen = sizeof(address);

// establish a socket.
if ((serverFd = socket(AF_INET, SOCK_STREAM, 0)) == 0) { ... }

bzero(&address, addrLen);Â 
address.sin_family = AF_INET;
address.sin_addr.s_addr = INADDR_ANY;Â  // -> 0.0.0.0.
address.sin_port = htons(PORT);
Â Â 
// assigns specified address to the socket.
if (bind(serverFd, (sockaddr*) &address, sizeof(address)) < 0) { ... }

// mark the socket as a passive socket.
if (listen(serverFd, MAX_LISTEN_CONN) < 0) { ... }
```

è§‚å¯Ÿä¸Šè¿°ä»£ç çš„ç¬¬ 7ã€15 ä¸ 18 è¡Œï¼Œä½ ä¼šå‘ç°ï¼Œæˆ‘ä»¬æŒ‰é¡ºåºåˆ†åˆ«è°ƒç”¨äº†æ¥å£ socketã€bind ä¸ listenã€‚å…¶ä¸­ï¼Œsocket æ¥å£å…±æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼šAF\_INET å®å¸¸é‡è¡¨æ˜ä½¿ç”¨ IPV4 å› ç‰¹ç½‘åŸŸï¼›SOCK\_STREAM å®å¸¸é‡è¡¨æ˜ä½¿ç”¨æœ‰åºã€å¯é ã€åŒå‘ï¼Œä¸”é¢å‘è¿æ¥çš„å­—èŠ‚æµï¼›æœ€åçš„å‚æ•° 0 è¡¨æ˜ï¼Œè®©æ¥å£æ ¹æ®å‰ä¸¤ä¸ªå‚æ•°è‡ªåŠ¨é€‰æ‹©ä½¿ç”¨çš„åè®®ã€‚å½“ç„¶ï¼Œåœ¨è¿™æ ·çš„é…ç½®ç»„åˆä¸‹ï¼Œå°†é»˜è®¤ä½¿ç”¨ TCP åè®®ã€‚

æ¥ä¸‹æ¥ï¼Œå€ŸåŠ© bind æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºå‰ä¸€æ­¥åˆ›å»ºçš„ socket å¯¹è±¡ç»‘å®šä¸€ä¸ªåœ°å€ã€‚åœ¨ IPV4 åŸŸä¸‹ï¼Œå¯¹åº”çš„åœ°å€ç”¨ sockaddr\_in ç±»å‹çš„ç»“æ„æ¥è¡¨ç¤ºã€‚åœ¨ä»£ç çš„ç¬¬ 10~12 è¡Œï¼Œæˆ‘ä»¬å¯¹è¯¥ç±»å‹çš„ä¸€ä¸ªå¯¹è±¡ address è¿›è¡Œäº†åˆå§‹åŒ–ã€‚å…¶ä¸­ï¼Œsin\_addr ç»“æ„å†…çš„ s\_addr å­—æ®µç”¨äºé…ç½®ç›¸åº”çš„åœ°å€ä¿¡æ¯ã€‚è¿™é‡Œï¼ŒINADDR\_ANY å®å¸¸é‡è¡¨ç¤ºå°† socket ç»‘å®šåˆ°åœ°å€ â€œ0.0.0.0â€ã€‚**é€šè¿‡è¿™ç§æ–¹å¼ï¼Œç¨‹åºå¯ä»¥ç›‘å¬å…¶è¿è¡Œæ‰€åœ¨çš„æœºå™¨ä¸Šå‘é€åˆ°æ‰€æœ‰ç½‘å¡ï¼ˆç½‘ç»œæ¥å£ï¼‰çš„ç½‘ç»œè¯·æ±‚ã€‚**

å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨ä¸º address å¯¹è±¡è®¾ç½®ç”¨äºè¡¨ç¤ºç½‘ç»œç«¯å£çš„ sin\_port å­—æ®µæ—¶ï¼Œä½¿ç”¨äº†åä¸º htons çš„æ–¹æ³•ï¼Œæ¥å°†ä¸€ä¸ª short ç±»å‹çš„ç«¯å£å€¼è½¬æ¢ä¸º**ç½‘ç»œåè®®æ‰€è¦æ±‚å­—èŠ‚åºï¼ˆé€šå¸¸ä¸ºå¤§ç«¯åºï¼‰ä¸‹çš„è¡¨ç¤ºå½¢å¼**ã€‚è€Œä¹‹æ‰€ä»¥è¿™æ ·åšï¼Œæ˜¯ä¸ºäº†è®©å¼‚æ„è®¡ç®—æœºåœ¨äº¤æ¢åè®®ä¿¡æ¯çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«ä¸åŒå¹³å°çš„ä¸åŒå­—èŠ‚åºæ··æ·†ã€‚

ç´§æ¥ç€ï¼Œé€šè¿‡è°ƒç”¨ listen æ¥å£ï¼Œç¨‹åºå¼€å§‹ç›‘å¬å³å°†åˆ°æ¥çš„ TCP è¿æ¥è¯·æ±‚ã€‚è¿™é‡Œï¼Œé€šè¿‡å®ƒçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œæˆ‘ä»¬æŒ‡å®šäº†æš‚å­˜é˜Ÿåˆ—æœ€å¤šèƒ½å¤Ÿå­˜æ”¾çš„å¾…è¿æ¥è¯·æ±‚ä¸ªæ•°ä¸º MAX\_LISTEN\_CONN ä¸ªã€‚

### ç®¡ç†è¿æ¥

åˆ°è¿™é‡Œï¼Œç¨‹åºä¾¿å¯ä»¥é€šè¿‡ accept æ¥å£æ¥ä¸æ–­åœ°æ¥å—è¿æ¥è¯·æ±‚ã€‚æ­¤æ—¶ï¼Œé…åˆä½¿ç”¨ read å’Œ write è¿™ä¸¤ä¸ª IO æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥è·å–å®¢æˆ·ç«¯å‘æ¥çš„æ•°æ®ï¼Œå¹¶åœ¨æ•°æ®å¤„ç†å®Œæ¯•åï¼Œå†å°†ç‰¹å®šå†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯ã€‚æœ€åï¼Œå½“è¿æ¥ä¸å†ä½¿ç”¨æ—¶ï¼Œè°ƒç”¨ close æ¥å£å³å¯å°†å®ƒå…³é—­ã€‚å…³äºè¿™éƒ¨åˆ†å®ç°ï¼Œä½ å¯ä»¥å‚è€ƒæ–‡ä»¶ â€œsrc/main.câ€ ä¸­ç¬¬ 36~39 è¡Œï¼Œä»¥åŠç¬¬ 60 è¡Œçš„ä»£ç ã€‚

## å¤„ç† HTTP è¯·æ±‚å’Œå“åº”

å½“ TCP è¿æ¥æˆåŠŸå»ºç«‹åï¼Œæˆ‘ä»¬ä¾¿å¯åœ¨æ­¤åŸºç¡€ä¹‹ä¸Šè¿›è¡Œä¸ HTTP åè®®ç›¸å…³çš„æ“ä½œï¼Œæ•´ä¸ªæµç¨‹ä¹Ÿååˆ†ç®€å•ï¼Œå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š

1. é€šè¿‡è§£ææ”¶åˆ°çš„ HTTP è¯·æ±‚æŠ¥æ–‡ï¼Œæˆ‘ä»¬å¯ä»¥è·å–ç”±å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„å‚æ•°å€¼ numï¼›
2. è°ƒç”¨æ–æ³¢é‚£å¥‘æ•°åˆ—è®¡ç®—å‡½æ•°ï¼Œç›¸åº”çš„ç»“æœé¡¹å¯ä»¥è¢«è®¡ç®—å‡ºæ¥ï¼›
3. é€šè¿‡æ„é€ ä¸€ä¸ªåˆæ³•çš„ HTTP å“åº”æŠ¥æ–‡ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªè®¡ç®—ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥ä¾æ¬¡çœ‹çœ‹è¿™å‡ ä¸ªæ­¥éª¤çš„å…·ä½“å®ç°ã€‚

### è§£æè¯·æ±‚

å…ˆæ¥çœ‹ç¬¬ä¸€æ­¥ï¼Œè§£æè¯·æ±‚ã€‚ä¸ºäº†ç®€åŒ–å®ç°ï¼Œè¿™é‡Œæˆ‘ä»¬å°† HTTP è¯·æ±‚æŠ¥æ–‡çš„è§£æè¿‡ç¨‹åˆ†ä¸ºäº†ç®€å•ã€ç›´æ¥çš„ä¸¤ä¸ªæ­¥éª¤ï¼Œå³**æå–è·¯å¾„ï¼ˆURIï¼‰å’Œè§£ææŸ¥è¯¢å‚æ•°å€¼**ã€‚

å½“ç„¶ï¼Œç°å®ä¸­çš„ HTTP æœåŠ¡å™¨åº”ç”¨é€šå¸¸ä¼šé¦–å…ˆå¯¹æŠ¥æ–‡çš„æ ¼å¼è¿›è¡Œå®Œæ•´æ€§æ ¡éªŒï¼Œç„¶åå†è¿›è¡Œç±»ä¼¼çš„åç»­å¤„ç†ã€‚ä¸è¿™éƒ¨åˆ†é€»è¾‘ç›¸å…³çš„å®ç°è¢«å°è£…åœ¨äº†åä¸º retrieveGETQueryIntValByKey çš„å‡½æ•°ä¸­ï¼Œå®ƒçš„å®ç°ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```c++
// libs/helpers.c#L37-L65
int retrieveGETQueryIntValByKey(char* req, const char* key) {
Â  int result = 0;

Â  // extract uri;
Â  const char* uriHead = strchr(req, ' ') + 1;
Â  const char* uriTail = strchr(uriHead, ' ');
Â  size_t uriLen = uriTail - uriHead + 1;
Â  char strUri[uriLen];
Â  wrapStrFromPTR(strUri, uriLen, uriHead, uriTail);

Â  // parse uri;
Â  UriUriA uri;
Â  UriQueryListA* queryList;
Â  int itemCount;
Â  const char* errorPos;
Â  if (uriParseSingleUriA(&uri, strUri, &errorPos) == URI_SUCCESS) {
Â  Â  if (uriDissectQueryMallocA(&queryList, &itemCount, uri.query.first, uri.query.afterLast) == URI_SUCCESS) {
Â  Â  Â  while (itemCount--) {
Â  Â  Â  Â  if (strcmp(queryList->key, key) == 0) {
Â  Â  Â  Â  Â  result = atoi(queryList->value);
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  Â  Â  queryList = queryList->next;
Â  Â  Â  }
Â  Â  Â  uriFreeQueryListA(queryList);
Â  Â  }
Â  }
Â  return result;
}
```

æˆ‘åœ¨ä¸Šä¸€è®²ä¸­æ›¾ä¸ºä½ ä»‹ç»è¿‡ HTTP è¯·æ±‚æŠ¥æ–‡çš„åŸºæœ¬æ ¼å¼ã€‚å…¶ä¸­ï¼Œè·¯å¾„ä¿¡æ¯ä½äºæŠ¥æ–‡çš„â€œèµ·å§‹è¡Œâ€éƒ¨åˆ†ï¼Œè€Œèµ·å§‹è¡Œä¸­çš„æ¯ä¸ªå…ƒç´ åˆ™å‡ä»¥ç©ºæ ¼è¿›è¡Œåˆ†å‰²ã€‚å› æ­¤ï¼Œè¿™é‡Œæˆ‘ä»¬çš„ç¬¬ä¸€æ­¥ä¾¿æ˜¯è¦**è·å–å½“æ•´ä¸ªæŠ¥æ–‡ä»å¤´å‘åé€å­—ç¬¦éå†æ—¶ï¼Œé‡åˆ°çš„å‰ä¸¤ä¸ªç©ºæ ¼ä¹‹é—´çš„é‚£æ®µæ–‡æœ¬**ã€‚ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæˆ‘ä»¬å†æ¬¡ä½¿ç”¨äº†åä¸º strchr çš„æ ‡å‡†åº“å‡½æ•°æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä¼šé‡åˆ°â€œå¦‚ä½•ä»è·¯å¾„æ–‡æœ¬ä¸­è§£æå‡ºç»™å®šæŸ¥è¯¢å‚æ•°çš„å€¼ï¼Ÿâ€è¿™ä¸ªæ£˜æ‰‹çš„é—®é¢˜ã€‚ç”±äºè·¯å¾„çš„å½¢å¼å¯èƒ½æœ‰å¤šç§å˜åŒ–ï¼Œæ¯”å¦‚æœªå¸¦æœ‰ç»™å®šå‚æ•°ï¼ˆ/?foo=1ï¼‰ã€å¸¦æœ‰é™¤ç»™å®šå‚æ•°å¤–çš„å…¶ä»–å‚æ•°ï¼ˆ/?foo=1&amp;num=10ï¼‰ã€å¸¦æœ‰å­è·¯å¾„çš„å‚æ•°ï¼ˆ/child/?num=10ï¼‰ï¼Œç­‰ç­‰ã€‚å› æ­¤ï¼Œä¸ºäº†å®Œå–„åœ°å¤„ç†è¿™ç±»æƒ…å†µï¼Œè¿™é‡Œæˆ‘ä»¬é€‰ç”¨äº†ä¸€ä¸ªå¼€æºçš„ç¬¬ä¸‰æ–¹ URI è§£æåº“ï¼Œuriparserã€‚

uriparser çš„ä½¿ç”¨æ–¹å¼ååˆ†ç®€å•ï¼Œé€šè¿‡é…åˆä½¿ç”¨ uriParseSingleUriA ä¸ uriDissectQueryMallocA è¿™ä¸¤ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ‰€ä¼ å…¥ URI çš„æŸ¥è¯¢å‚æ•°ä¸å€¼æå–æˆä¸€ä¸ªå•é“¾è¡¨ã€‚è€Œé€šè¿‡å¯¹å®ƒè¿›è¡Œéå†ï¼ˆitemCount è¡¨ç¤ºå‚æ•°ä¸ªæ•°ï¼‰ï¼Œæˆ‘ä»¬ä¾¿èƒ½å¤Ÿæ‰¾åˆ°ç›®æ ‡å‚æ•°çš„å€¼ã€‚ä½ å¯ä»¥ç‚¹å‡»[è¿™ä¸ªé“¾æ¥](https://github.com/uriparser/uriparser)ï¼Œæ¥äº†è§£å…³äº uriparser çš„æ›´å¤šä¿¡æ¯ã€‚

### è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—

æ­¤æ—¶ï¼Œæˆ‘ä»¬å·²ç»å¾—åˆ°äº†ç”±å®¢æˆ·ç«¯é€šè¿‡ HTTP è¯·æ±‚ä¼ é€è¿‡æ¥çš„å‚æ•° numã€‚è€Œä¸‹ä¸€æ­¥è¦å®Œæˆçš„ï¼Œä¾¿æ˜¯ FibServ çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå³è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—ç¬¬ num é¡¹çš„å€¼ã€‚ä¸æ­¤ç›¸å…³çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š

```c++
// libs/helpers.c#L8-L20
int __calcFibTCO(int n, int x, int y) {
Â  if (n == 0)
Â  Â  return x;
Â  if (n == 1)
Â  Â  return y;
Â  return __calcFibTCO(n - 1, y, x + y);
}

int __calcFibRecursion(int n) {
Â  if (n <= 1)
Â  Â  return n;
Â  return __calcFibRecursion(n - 1) + __calcFibRecursion(n - 2);
}

int calcFibonacci(int n) {
  // return __calcFibTCO(n, 0, 1);  // TCO version. 
  return __calcFibRecursion(n);  // recursion version.
}
```

è¿™é‡Œï¼Œæˆ‘ä¸ºä½ æä¾›äº†ä¸¤ç§ä¸åŒçš„å‡½æ•°å®ç°ã€‚å…¶ä¸­ï¼Œå‡½æ•° \_\_calcFibRecursion ä¸ºæ­£å¸¸é€’å½’ç‰ˆæœ¬ï¼›è€Œå‡½æ•° \_\_calcFibTCO ä¸ºå¯¹åº”çš„å°¾é€’å½’ç‰ˆæœ¬ã€‚ç”±äºè¿™ä¸¤ä¸ªç‰ˆæœ¬å‡½æ•°éœ€è¦çš„å‚æ•°ä¸ªæ•°ä¸åŒï¼Œå› æ­¤ä¸ºäº†ç»Ÿä¸€å¯¹å¤–çš„è°ƒç”¨æ¥å£ï¼Œæˆ‘ä»¬ä¸ºå¤–éƒ¨ä»£ç åˆæä¾›äº†å¦ä¸€ä¸ªç¨³å®šæ¥å£ calcFibonacciï¼Œè€Œè¯¥æ¥å£åœ¨å†…éƒ¨åˆ™å¯æ ¹æ®éœ€è¦åŠ¨æ€è°ƒç”¨ä¸Šè¿°çš„ä¸¤ç§å‡½æ•°å®ç°ã€‚

### è¿”å›å“åº”

å½“è®¡ç®—è¿‡ç¨‹ç»“æŸåï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥æ„é€  HTTP å“åº”æŠ¥æ–‡ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚**è¡¨ç¤ºæ“ä½œæˆåŠŸçš„å“åº”æŠ¥æ–‡åº”ä½¿ç”¨å†…å®¹ä¸º â€œHTTP/1.1 200 OKâ€ çš„å“åº”å¤´ã€‚**åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰è¿”å›ä»»ä½•é¦–éƒ¨å­—æ®µï¼Œå› æ­¤ï¼Œå“åº”å¤´ä¸ä¸»ä½“ä¹‹é—´å¯ä»¥ç›´æ¥ä½¿ç”¨ä»¥ CRLF ç»“å°¾çš„ä¸€è¡Œç©ºè¡Œè¿›è¡Œåˆ†å‰²ã€‚å…³äºè¿™éƒ¨åˆ†å®ç°ï¼Œä½ å¯ä»¥å‚è€ƒæ–‡ä»¶ â€œsrc/main.câ€ ä¸­ç¬¬ 55~56 è¡Œçš„ä»£ç ã€‚

## æ•´åˆå¤šçº¿ç¨‹

ç»è¿‡ä¸Šé¢å‡ ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥è®© FibServ æ­£å¸¸åœ°æ¥æ”¶ä¸å¤„ç† HTTP è¯·æ±‚ï¼Œå¹¶è¿”å›åŒ…å«æœ‰æ­£ç¡®ç»“æœçš„ HTTP å“åº”ã€‚ä½†ä¸ºäº†è¿›ä¸€æ­¥æå‡ FibServ çš„è¯·æ±‚å¤„ç†æ•ˆç‡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å¤šçº¿ç¨‹æŠ€æœ¯æ¥å¯¹å®ƒè¿›è¡Œä¼˜åŒ–ã€‚

### åˆ†ç¦»å¤„ç†çº¿ç¨‹

é¦–å…ˆï¼Œæˆ‘ä»¬æŠŠè¯·æ±‚å¤„ç†ç›¸å…³çš„é€»è¾‘å…¨éƒ¨æå–å¹¶å°è£…åœ¨äº†åä¸º acceptConn çš„å‡½æ•°ä¸­ã€‚è¿™æ ·ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹ä¾¿èƒ½å¤Ÿå®Œå…¨ç‹¬ç«‹åœ°æ¥å¤„ç†ä¸€ä¸ªè¿æ¥ã€‚è¯¥å‡½æ•°çš„å®Œæ•´å®ç°ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```c++
noreturn void* acceptConn(void *arg) {
Â  acceptParams* ap = (acceptParams*) arg;
Â  int acceptedSocket;

Â  while (1) {
Â  Â  pthread_cleanup_push(renewThread, &acceptedSocket);
Â  Â  // extracts a request from the queue.
Â  Â  if ((acceptedSocket = accept(ap->serverFd, ap->addr, ap->addrLen)) < 0) {
Â  Â  Â  perror("In accept");
Â  Â  Â  pthread_exit(NULL);
Â  Â  }

Â  Â  // deal with HTTP request.
Â  Â  char reqBuf[HTTP_REQ_BUF];
Â  Â  bzero(reqBuf, HTTP_REQ_BUF);Â 
Â  Â  const size_t receivedBytes = read(acceptedSocket, reqBuf, HTTP_REQ_BUF);
Â  Â  if (receivedBytes > 0) {
Â  Â  Â  char resBuf[HTTP_RES_BUF];

Â  Â  Â  // retrieve number from query.
Â  Â  Â  pthread_mutex_lock(&mutex);
Â  Â  Â  const int num = retrieveGETQueryIntValByKey(reqBuf, "num");
Â  Â  Â  pthread_mutex_unlock(&mutex);

Â  Â  Â  int fibResult = calcFibonacci(num);
Â  Â  Â  // follow the format of the http response.
Â  Â  Â  sprintf(resBuf, "HTTP/1.1 200 OK\r\n\r\n%d", fibResult);
Â  Â  Â  write(acceptedSocket, resBuf, strlen(resBuf));
Â  Â  }
Â  Â  close(acceptedSocket);
Â  Â  pthread_cleanup_pop(0);
Â  }
}
```

ä¸ºäº†èƒ½å¤Ÿåœ¨çº¿ç¨‹å†…éƒ¨è·å–ä¸ socket ç›¸å…³çš„æ–‡ä»¶æè¿°ç¬¦ã€åœ°å€ï¼Œä»¥åŠåœ°å€é•¿åº¦ä¿¡æ¯ï¼Œä»¥ä¾¿äºåç»­ accept ç­‰æ¥å£çš„è°ƒç”¨ï¼Œè¿™é‡Œæˆ‘å°†è¿™ä¸‰ä¸ªå‚æ•°å°è£…åœ¨äº†åä¸º acceptParams çš„ç»“æ„ä¸­ã€‚è¯¥ç»“æ„çš„ä¸€ä¸ªå¯¹è±¡å°†åœ¨çº¿ç¨‹åˆ›å»ºæ—¶ä»¥æŒ‡é’ˆçš„å½¢å¼ä¼ é€’è¿›æ¥ï¼Œä¾›æ‰€æœ‰å¤„ç†çº¿ç¨‹ä½¿ç”¨ã€‚

åœ¨ä¸Šè¿°ä»£ç çš„ç¬¬ 5 è¡Œï¼Œé€šè¿‡ä¸€ä¸ªæ­»å¾ªç¯ç»“æ„ï¼Œçº¿ç¨‹ä¾¿å¯æŒç»­ä¸æ–­åœ°å¤„ç†æ”¶åˆ°çš„è¿æ¥è¯·æ±‚ã€‚æ¥ä¸‹æ¥ï¼Œé€šè¿‡ accept æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ä»æš‚å­˜é˜Ÿåˆ—ä¸­æ¥å—ä¸€ä¸ªè¿æ¥è¯·æ±‚ã€‚ä»£ç çš„ç¬¬ 16 è¡Œï¼Œå€ŸåŠ© read å‡½æ•°ï¼Œç¨‹åºè·å–åˆ°äº†ç”±å®¢æˆ·ç«¯å‘é€æ¥çš„æ•°æ®ã€‚è¿™äº›æ•°æ®å°†éšç€ç¬¬ 22 ä¸ 25 è¡Œçš„å¤„ç†ï¼Œæœ€ç»ˆå˜ä¸ºæˆ‘ä»¬éœ€è¦çš„è®¡ç®—ç»“æœã€‚æœ€åï¼Œåœ¨ä»£ç çš„ç¬¬ 27~28 è¡Œï¼Œæˆ‘ä»¬å°†è¯¥ç»“æœæ•´åˆåœ¨ä¸€ä¸ª HTTP å“åº”æŠ¥æ–‡ä¸­ï¼Œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

### ä¼˜é›…åœ°å¤„ç†å¼‚å¸¸

é™¤æ­¤ä¹‹å¤–ï¼Œä½ å¯èƒ½ä¼šå‘ç°ï¼Œæˆ‘ä»¬åœ¨ä»£ç çš„ç¬¬ 6 ä¸ 31 è¡Œï¼Œè¿˜è°ƒç”¨äº†åä¸º pthread\_cleanup\_push ä¸ pthread\_cleanup\_pop çš„ä¸¤ä¸ªå‡½æ•°ã€‚è¿™ä¸¤ä¸ªå‡½æ•°çš„ä¸»è¦ç›®çš„åœ¨äºä¸ºçº¿ç¨‹æ·»åŠ é€€å‡ºæ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œçš„å›è°ƒå‡½æ•°ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬ä¾¿èƒ½å¤Ÿåœ¨çº¿ç¨‹ç”±äº accept è°ƒç”¨å¤±è´¥è€Œé€€å‡ºæ—¶ï¼ŒåŠæ—¶åœ°é€šçŸ¥ä¸»çº¿ç¨‹é‡æ–°åˆ›å»ºæ–°çš„å¤„ç†çº¿ç¨‹ï¼Œä»¥ä¿è¯çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°é‡ç»´æŒåœ¨ä¸€ä¸ªç¨³å®šçŠ¶æ€ã€‚å…³äºè¿™ä¸¤ä¸ªå‡½æ•°çš„æ›´è¯¦ç»†ç”¨æ³•ï¼Œä½ å¯ä»¥ç‚¹å‡»[è¿™ä¸ªé“¾æ¥](https://man7.org/linux/man-pages/man3/pthread_cleanup_push.3.html)æ¥äº†è§£ã€‚

ä½†ä¹Ÿæ­£æ˜¯å› ä¸ºéœ€è¦å¯¹çº¿ç¨‹çš„çŠ¶æ€è¿›è¡Œæ›´ç»†è‡´çš„ç®¡ç†ï¼Œåœ¨æœ¬æ¬¡å®æˆ˜é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨ C æ ‡å‡†ä¸­çš„çº¿ç¨‹åº“ threads.hï¼Œè€Œæ˜¯é€‰ç”¨äº† POSIX æ ‡å‡†ä¸‹çš„ pthread æ¥å£ã€‚ä½†å¯¹äºå¤§å¤šæ•°çš„çº¿ç¨‹æ§åˆ¶æ¥å£æ¥è¯´ï¼Œä¸¤è€…åªæ˜¯åœ¨æ¥å£åç§°å’Œä½¿ç”¨æ–¹å¼ä¸Šç¨æœ‰å·®å¼‚ï¼Œè€ŒèƒŒåçš„è¿è¡ŒåŸç†æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚

å¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼Œåœ¨è¿™ä¸ªå›è°ƒå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå…³é—­äº†é€€å‡ºçº¿ç¨‹å½“å‰æ­£åœ¨ä½¿ç”¨çš„ TCP è¿æ¥ã€‚æ¥ç€ï¼Œåœ¨äº’æ–¥é”çš„ä¿æŠ¤ä¸‹ï¼Œæˆ‘ä»¬æ›´æ–°äº†ç”¨äºè®°å½•æ´»åŠ¨çº¿ç¨‹æ•°é‡çš„å…¨å±€å˜é‡ threadCounterï¼Œå¹¶é€šè¿‡ pthread\_cond\_signal æ¥é€šçŸ¥ main å‡½æ•°æ‰€åœ¨çº¿ç¨‹ï¼Œé‡æ–°åˆ›å»ºå¤„ç†çº¿ç¨‹ï¼ˆå¦‚æœä½ å¯¹è¿™é‡Œæ¡ä»¶å˜é‡ç›¸å…³æ¥å£çš„ä½¿ç”¨æ–¹å¼è¿˜ä¸å¤ªç†Ÿæ‚‰ï¼Œå¯ä»¥é‡æ–°å›é¡¾ [14 è®²](https://time.geekbang.org/column/article/478213) çš„ç›¸å…³å†…å®¹ï¼‰ã€‚

```c++
void renewThread(void *arg) {Â Â 
Â  int* acceptedSocket = (int*) arg;
Â  close(*acceptedSocket);
Â  pthread_mutex_lock(&mutex);
Â  threadCounter--;
Â  pthread_cond_signal(&cond);Â  // notify main thread.
Â  pthread_mutex_unlock(&mutex);
}Â 
```

åˆ°è¿™é‡Œï¼Œä¸€åˆ‡å‡†å¤‡å°±ç»ªã€‚æœ€åï¼Œè®©æˆ‘ä»¬å›åˆ° main å‡½æ•°å†…éƒ¨ï¼Œå°†â€œå‘½è¿çš„é½¿è½®â€è½¬åŠ¨èµ·æ¥ã€‚

### åˆ›å»ºçº¿ç¨‹

å¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼Œä½äº main å‡½æ•°å†…çš„æ­»å¾ªç¯ç»“æ„ä¸»è¦ç”¨äºä¸æ–­åœ°åˆ›å»ºæ–°çš„å¤„ç†çº¿ç¨‹ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä»£ç çš„ç¬¬ 11~12 è¡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ pthread\_create æ¥å£åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œå¹¶åŒæ—¶é€’å¢äº†å·¥ä½œçº¿ç¨‹è®¡æ•°å™¨ï¼Œå³å…¨å±€å˜é‡ threadCounter çš„å€¼ã€‚è€Œç›´åˆ°è¯¥å€¼å¤§äºç­‰äºç¨‹åºé…ç½®çŠ¶æ€å¯¹è±¡ serverSettings ä¸­ threadCount çš„å€¼æ—¶ï¼Œé€šè¿‡è°ƒç”¨ pthread\_cond\_wait æ¥å£ï¼Œmain çº¿ç¨‹è¿›å…¥åˆ°äº†é˜»å¡çŠ¶æ€ã€‚è¿™ä¸ªçŠ¶æ€å°†ä¼šä¸€ç›´ç»´æŒï¼Œç›´è‡³æœ‰å·¥ä½œçº¿ç¨‹å‘ç”Ÿå¼‚å¸¸é€€å‡ºã€‚

```c++
// src/main.c#L97-L109
while (1) {
Â  pthread_mutex_lock(&mutex);
Â  while (threadCounter >= ss.threadCount)
Â  Â  pthread_cond_wait(&cond, &mutex);
Â  pthread_mutex_unlock(&mutex);

Â  // create new thread to handle the request.
Â  pthread_t threadId;
Â  acceptParams ap = { serverFd, (sockaddr*) &address, (socklen_t*) &addrLen };
Â  pthread_create(&threadId, NULL, acceptConn, &ap);
Â  atomic_fetch_add(&threadCounter, 1);
Â  printf("[Info] Thread Created: No.%d\n", threadCounter);
}
```

åˆ°è¿™é‡Œï¼ŒFibServ åœ¨ C ä»£ç å±‚é¢çš„åŸºæœ¬å®ç°å°±ç»“æŸäº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ç¼–å†™ç”¨äºè¯¥é¡¹ç›®çš„ CMake é…ç½®æ–‡ä»¶ï¼Œå¹¶å°è¯•ä½¿ç”¨ cmake å‘½ä»¤å¯¹å®ƒè¿›è¡Œç¼–è¯‘ã€‚

## ç¼–è¯‘ä¸è¿è¡Œ

æˆ‘æ›¾åœ¨è¿™ä¸€è®²çš„ç¬¬ä¸€ä¸ªå°èŠ‚â€œé¡¹ç›®åŸºæœ¬ç»“æ„â€ä¸­æåˆ°ï¼Œåœ¨æœ¬é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸¤ä¸ª CMakeLists.txt æ–‡ä»¶ï¼Œæ¥åˆ†åˆ«æ§åˆ¶ libs ç›®å½•å†…çš„æºä»£ç ï¼Œä»¥åŠ FibServ åº”ç”¨ç¨‹åºçš„ç¼–è¯‘è¿‡ç¨‹ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒCMake ä¼šé¦–å…ˆå°†å‰è€…ç¼–è¯‘ä¸ºç‹¬ç«‹çš„ â€œ.aâ€ é™æ€åº“æ–‡ä»¶ï¼Œç„¶åå†å°†è¯¥æ–‡ä»¶ä¸ src ä¸‹çš„æºä»£ç ä¸€èµ·ç¼–è¯‘ï¼Œå¹¶ç”Ÿæˆæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

libs ç›®å½•ä¸‹çš„ CMakeLists.txt æ–‡ä»¶å†…åŒ…å«æœ‰ä»¥ä¸‹å†…å®¹ï¼š

```c++
# libs/CMakeLists.txt
aux_source_directory(. DIR_LIB_SRCS)
add_library(core STATIC ${DIR_LIB_SRCS})
```

å…¶ä¸­ï¼ŒæŒ‡ä»¤ aux\_source\_directory ç”¨äºæ”¶é›†å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æºæ–‡ä»¶çš„åç§°ï¼Œå¹¶å°†è¿™äº›åç§°å­˜å‚¨åˆ°å˜é‡ DIR\_LIB\_SRCS ä¸­ã€‚éšåï¼Œé€šè¿‡ add\_library å‘½ä»¤ï¼Œä»å‰ä¸€æ­¥æ”¶é›†è€Œæ¥çš„æºæ–‡ä»¶å°†è¢«ä¸€åŒç¼–è¯‘ï¼Œå¹¶ç”Ÿæˆåä¸º â€œcoreâ€ çš„é™æ€åº“ã€‚

è¿”å›é¡¹ç›®æ ¹ç›®å½•ï¼Œæˆ‘ä»¬å†æ¥çœ‹ç”¨äºæ§åˆ¶åº”ç”¨ç¨‹åº FibServ ç¼–è¯‘çš„ CMakeLists.txt æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œå…·ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š

```c++
cmake_minimum_required(VERSION 3.21)
project(mini-http-server)

set(TARGET_FILE "http-echo-server")
set(CMAKE_BUILD_TYPE Release)
set(CMAKE_C_STANDARD 17)

# a simple way to check non-standard C header files (includes the atomic-related one).
include(CheckIncludeFiles)
check_include_files("pthread.h;stdatomic.h;sys/socket.h;netinet/in.h;unistd.h" EDEPS)
if (EPTHREAD EQUAL 1)
Â  message(FATAL_ERROR "Necessary header files are not found!")
endif()

# for headers in "/libs" and other external installed packages.
include_directories(. /usr/local/include)

# load source files and sub-directories.
aux_source_directory(./src DIR_SRCS)
add_subdirectory(libs/)

# load packages.
find_package(uriparser 0.9.6 CONFIG REQUIRED char)

# for executable.
add_executable(${TARGET_FILE} ${DIR_SRCS})
target_link_libraries(${TARGET_FILE} PUBLIC core m pthread uriparser::uriparser)
```

å…¶ä¸­ï¼Œä½ éœ€è¦å…³æ³¨çš„æ˜¯ç¬¬ 9~13 è¡Œçš„é…ç½®ä»£ç ã€‚è¿™é‡Œï¼Œé€šè¿‡åä¸º check\_include\_files çš„å®å‡½æ•°ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè®© CMake åœ¨ç¼–è¯‘ä»£ç å‰ï¼Œæ£€æµ‹åº”ç”¨æ‰€éœ€çš„æŒ‡å®šå¤´æ–‡ä»¶æ˜¯å¦å¯ä»¥åœ¨å½“å‰ç¯å¢ƒä¸‹ä½¿ç”¨ã€‚è‹¥å¦ï¼Œåˆ™ç›´æ¥ç»ˆæ­¢é¡¹ç›®çš„ç¼–è¯‘é…ç½®è¿‡ç¨‹ã€‚

åœ¨æ¥ä¸‹æ¥çš„ç¬¬ 16 è¡Œä»£ç ä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šäº†ç¨‹åºç¼–è¯‘æ—¶çš„å¤´æ–‡ä»¶æŸ¥æ‰¾ç›®å½•ã€‚é€šè¿‡ç¬¬ 19~20 è¡Œä»£ç ï¼ŒFibServ å¯¹åº”å®ç°çš„æºæ–‡ä»¶ï¼Œä»¥åŠæ‰€éœ€è¦çš„å†…éƒ¨ä¾èµ–é¡¹ï¼ˆcore é™æ€åº“ï¼‰è¢«å¼•ç”¨è¿›æ¥ã€‚åœ¨ç¬¬ 23 è¡Œï¼Œé€šè¿‡ find\_package æŒ‡ä»¤ï¼ŒCMake å¯ä»¥å¸®åŠ©æˆ‘ä»¬æŸ¥æ‰¾ç¨‹åºéœ€è¦ä½¿ç”¨çš„å¤–éƒ¨ä¾èµ–åŒ…ï¼ˆè¿™é‡Œå³ uriparserï¼‰ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œuriparser åœ¨å¯ä»¥è¢« CMake æ­£å¸¸ä½¿ç”¨ä¹‹å‰ï¼Œå®ƒéœ€è¦è¢«æ­£ç¡®åœ°ç¼–è¯‘å’Œå®‰è£…ï¼Œä½ å¯ä»¥ç‚¹å‡»[è¿™ä¸ªé“¾æ¥](https://github.com/uriparser/uriparser)æ¥æŸ¥çœ‹æ›´è¯¦ç»†çš„è¯´æ˜ã€‚æœ€åï¼Œé€šè¿‡ add\_executable ä¸ target\_link\_libraries ä¸¤ä¸ªæŒ‡ä»¤ï¼Œæˆ‘ä»¬ä¾¿å¯å®Œæˆ FibServ äºŒè¿›åˆ¶æ–‡ä»¶çš„ç¼–è¯‘å’Œé“¾æ¥è¿‡ç¨‹ã€‚

å½“ç„¶ï¼ŒåŒæˆ‘ä»¬åœ¨ä¸Šä¸€è®²ä¸­ä»‹ç»çš„æ–¹æ³•ç±»ä¼¼ï¼Œä½¿ç”¨ä¸‹é¢è¿™è¡Œå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€æ¬¡æ€§å®Œæˆé¡¹ç›®çš„ç¼–è¯‘å‰é…ç½®ã€ä»£ç ç¼–è¯‘ä¸ç¨‹åºè¿è¡Œï¼š

```c++
mkdir build && cd build && cmake .. && cmake --build . && ./fibserv
```

## æ€»ç»“

å¥½äº†ï¼Œè®²åˆ°è¿™é‡Œï¼Œä»Šå¤©çš„å†…å®¹ä¹Ÿå°±åŸºæœ¬ç»“æŸäº†ã€‚æœ€åæˆ‘æ¥ç»™ä½ æ€»ç»“ä¸€ä¸‹ã€‚

åœ¨è¿™ä¸€è®²ä¸­ï¼Œæˆ‘å¸¦ä½ ä»åŸºæœ¬çš„é¡¹ç›®ç›®å½•åˆ›å»ºï¼Œåˆ°æ¨¡å—åŠŸèƒ½ç¼–å†™ï¼Œå†åˆ°ä»£ç ç¼–è¯‘å’Œç¨‹åºè¿è¡Œï¼Œä¸€æ­¥æ­¥åœ°å®Œæˆäº†æ•´ä¸ª FibServ é¡¹ç›®çš„å¼€å‘è¿‡ç¨‹ï¼Œå¹¶ä¸ºä½ è¯¦ç»†ä»‹ç»äº†è¿™ä¸ªé¡¹ç›®çš„å„ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†åœ¨ä»£ç å±‚é¢çš„å…·ä½“å®ç°æ–¹å¼ã€‚

åœ¨â€œC å·¥ç¨‹å®æˆ˜ç¯‡â€çš„æœ€åï¼Œæˆ‘ç”¨ä¸¤è®²çš„ç¯‡å¹…å¸¦ä½ å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„ C è¯­è¨€é¡¹ç›®ã€‚å¸Œæœ›é€šè¿‡è¿™äº›å†…å®¹ï¼Œä½ èƒ½å¤Ÿå¯¹ C è¯­è¨€åœ¨çœŸå®é¡¹ç›®ä¸­çš„åº”ç”¨æ–¹å¼æœ‰æ›´æ·±åˆ»çš„ç†è§£ã€‚åŒæ—¶ï¼Œä¹Ÿå¸Œæœ›ä½ èƒ½ä»¥æ­¤ä¸ºèµ·ç‚¹ï¼Œåœ¨å®è·µä¸­æŒç»­è¿ç”¨è¿™ä¸ªæ¨¡å—ä¸­ä»‹ç»åˆ°çš„å„ç§ C æ ‡å‡†åº“åŠŸèƒ½ä¸å·¥ç¨‹åŒ–å®è·µæŠ€å·§ï¼Œè¿›ä¸€æ­¥åŠ æ·±å¯¹æ•´ä¸ª C è¯­è¨€ï¼Œä¹ƒè‡³ç›¸å…³æŠ€æœ¯ã€å·¥å…·å’Œæ¡†æ¶çš„ç†è§£ã€‚

## æ€è€ƒé¢˜

ä½ çŸ¥é“å¦‚ä½•é€šè¿‡å¤ç”¨ TCP è¿æ¥æ¥è¿›ä¸€æ­¥ä¼˜åŒ– FibServ çš„æ€§èƒ½å—ï¼Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºå‘Šè¯‰æˆ‘ä½ çš„å®ç°æ–¹æ¡ˆï¼Œä¹Ÿæ¬¢è¿ä½ ç›´æ¥æäº¤ PRï¼

ä»Šå¤©çš„è¯¾ç¨‹åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©åˆ°ä½ ï¼Œä¹Ÿå¸Œæœ›ä½ åœ¨ä¸‹æ–¹çš„ç•™è¨€åŒºå’Œæˆ‘ä¸€èµ·è®¨è®ºã€‚åŒæ—¶ï¼Œæ¬¢è¿æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ5ï¼‰</strong></div><ul>
<li><span>fee1in</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>èŠ±äº†ä¸¤ä¸ªå°æ—¶ ç»ˆäºå°†ç¤ºä¾‹è·‘é€š åé¢çš„åŒå­¦doxygené—®é¢˜ å¯ä»¥å‚è€ƒè€å¸ˆåœ¨uriparserçš„issue https:&#47;&#47;github.com&#47;uriparser&#47;uriparser&#47;issues&#47;137</p>2022-02-16</li><br/><li><span>å¶å…°</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>äºè€å¸ˆè®²çš„å¤ªå¥½äº†ï¼Œå—ç›ŠåŒªæµ…</p>2022-02-16</li><br/><li><span>æ ¡æ­Œ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆä½ å¥½ï¼Œæˆ‘æ²¡å†™è¿‡Cé¡¹ç›®ï¼ŒåŒ…ç®¡ç†æ„Ÿè§‰è¿˜æ˜¯goçš„é¡¹ç›®çˆ½ğŸ˜ï¼›è¿è¡ŒæŠ¥é”™å¦‚ä¸‹
# cmake ..  
...
Could not find a package configuration file provided by &quot;uriparser&quot;
... 

ä¸ºäº†è·‘è€å¸ˆçš„é¡¹ç›®ï¼Œæœ¬åœ°å®‰è£…äº†libgtest-devå’Œæºç ç¼–è¯‘å®‰è£… uriparserï¼Œé¡¹ç›®æ‰è·‘èµ·æ¥ã€‚ä¸çŸ¥æœ‰æ²¡æœ‰ç®€å•çš„åŠæ³•ï¼Œç±»ä¼¼go mod tidy æˆ–è€…go get xxx è·å–goé¡¹ç›®çš„ä¾èµ–å‘¢ï¼Ÿ</p>2022-06-18</li><br/><li><span>brian</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è€å¸ˆå•Šï¼Œepollå’Œå¼‚æ­¥ioéƒ½æ²¡æœ‰ç”¨ä¸Šï¼Œä¸èƒ½ç®—é«˜æ€§èƒ½å§</p>2023-04-28</li><br/><li><span>lunar</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ç¬¬ä¸€æ¬¡è·‘Cé¡¹ç›® è¿˜è¦è‡ªå·±è£…ä¸€ä¸‹ç¬¬ä¸‰æ–¹åº“,å­¦ä¹ çš„è·¯ä¸Šåˆè¸å‡ºäº†ä¸€æ­¥ -DURIPARSER_BUILD_DOCS=OFF</p>2022-03-20</li><br/>
</ul>