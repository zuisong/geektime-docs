ä½ å¥½ï¼Œæˆ‘æœ±æ™”ï¼Œæ˜¯[ã€ŠJavaä¸šåŠ¡å¼€å‘å¸¸è§é”™è¯¯100ä¾‹ã€‹](https://time.geekbang.org/column/intro/294)ä¸“æ è¯¾ç¨‹çš„ä½œè€…ã€‚

ã€ŠOAuth 2.0å®æˆ˜è¯¾ã€‹ä¸Šçº¿ä¹‹åï¼Œæˆ‘ä¹Ÿç¬¬ä¸€æ—¶é—´å…³æ³¨äº†è¿™é—¨è¯¾ã€‚åœ¨å¼€ç¯‡è¯ä¸­ï¼Œæˆ‘çœ‹åˆ°æœ‰ä¸€äº›åŒå­¦ç•™è¨€é—®é“ï¼šâ€œå¦‚ä½•ä½¿ç”¨Spring Securityæ¥å®ç°OAuth 2.0ï¼Ÿâ€è¿™æ—¶ï¼Œæˆ‘æƒ³åˆ°ä¹‹å‰è‡ªå·±å†™è¿‡ä¸€ç¯‡ç›¸å…³çš„æ–‡ç« ï¼Œäºæ˜¯å°±ç›´æ¥åœ¨å¼€ç¯‡è¯ä¸‹ç•™äº†è¨€ã€‚åé¢æˆ‘å¾ˆå¿«æ”¶åˆ°äº†ä¸å°‘ç”¨æˆ·çš„ç‚¹èµå’Œè‚¯å®šï¼Œç´§æ¥ç€æå®¢æ—¶é—´ç¼–è¾‘ä¹Ÿé‚€è¯·æˆ‘ä»è‡ªå·±çš„è§’åº¦ä¸ºä¸“æ å†™ç¯‡åŠ é¤ã€‚å¥½å§ï¼ŒåŠŸä¸å”æï¼Œäºæ˜¯æˆ‘å°±å°†ä¹‹å‰æˆ‘å†™çš„é‚£ç¯‡è€æ–‡ç« å†æ¬¡è¿­ä»£ã€æ•´ç†ä¸ºä»Šå¤©çš„è¿™ä¸€è®²å†…å®¹ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©ä½ æŒæ¡OAuth 2.0ã€‚

å¦‚æœä½ ç†Ÿæ‚‰Spring Securityçš„è¯ï¼Œè‚¯å®šçŸ¥é“å®ƒå› ä¸ºåŠŸèƒ½å¤šã€ç»„ä»¶æŠ½è±¡ç¨‹åº¦é«˜ã€é…ç½®æ–¹å¼å¤šæ ·ï¼Œå¯¼è‡´äº†å¼ºå¤§ä¸”å¤æ‚çš„ç‰¹æ€§ã€‚ä¹Ÿå› æ­¤ï¼ŒSpring Securityçš„å­¦ä¹ æˆæœ¬å‡ ä¹æ˜¯Springå®¶æ—ä¸­æœ€é«˜çš„ã€‚ä½†ä¸ä»…äºæ­¤ï¼Œåœ¨ç»“åˆå®é™…çš„å¤æ‚ä¸šåŠ¡åœºæ™¯ä½¿ç”¨Spring Securityæ—¶ï¼Œæˆ‘ä»¬è¿˜è¦å»ç†è§£ä¸€äº›ç»„ä»¶çš„å·¥ä½œåŸç†å’Œæµç¨‹ï¼Œä¸ç„¶éœ€è¦è‡ªå®šä¹‰å’Œæ‰©å±•æ¡†æ¶çš„æ—¶å€™å°±ä¼šæ‰‹è¶³æ— æªã€‚è¿™å°±è®©ä½¿ç”¨Spring Securityçš„é—¨æ§›æ›´é«˜äº†ã€‚

å› æ­¤ï¼Œåœ¨å†³å®šä½¿ç”¨Spring Securityæ­å»ºæ•´å¥—å®‰å…¨ä½“ç³»ï¼ˆæˆæƒã€è®¤è¯ã€æƒé™ã€å®¡è®¡ï¼‰ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘çš„æ˜¯ï¼šå°†æ¥æˆ‘ä»¬çš„ä¸šåŠ¡ä¼šå¤šå¤æ‚ï¼Œå¾’æ‰‹å†™ä¸€å¥—å®‰å…¨ä½“ç³»æ¥å¾—åˆ’ç®—ï¼Œè¿˜æ˜¯ä½¿ç”¨Spring Securityæ›´å¥½ï¼Ÿæˆ‘ç›¸ä¿¡ï¼Œè¿™ä¹Ÿæ˜¯ç‹è€å¸ˆç»™å‡ºè¯¾ç¨‹é…å¥—ä»£ç ä¸­ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨Spring Securityæ¥æ¼”ç¤ºOAuth 2.0æµç¨‹çš„åŸå› ä¹‹ä¸€ã€‚

åè¿‡æ¥è¯´ï¼Œå¦‚æœä½ çš„åº”ç”¨å·²ç»ä½¿ç”¨äº†Spring Securityæ¥åšé‰´æƒã€è®¤è¯å’Œæƒé™ç®¡ç†çš„è¯ï¼Œé‚£ä¹ˆä»ç„¶ä½¿ç”¨Spring Securityæ¥å®ç°OAuthçš„æˆæœ¬æ˜¯å¾ˆä½çš„ã€‚è€Œä¸”ï¼Œåœ¨å­¦ä¹ äº†OAuth 2.0çš„æµç¨‹æ‰“ä¸‹æ‰å®çš„åŸºç¡€ä¹‹åï¼Œæˆ‘ä»¬å†ä½¿ç”¨Spring Securityæ¥é…ç½®OAuth 2.0å°±ä¸ä¼šé‚£ä¹ˆè¿·èŒ«äº†ã€‚è¿™ä¹Ÿæ˜¯æˆ‘åœ¨å·¥ä½œä¸­ä½¿ç”¨Spring Securityæ¥å®ç°OAuth 2.0çš„ç›´è§‚æ„Ÿå—ã€‚

æ‰€ä»¥ï¼Œæˆ‘å°±ç»“åˆè‡ªå·±çš„å®è·µå’Œç§¯ç´¯ï¼Œå¸¦ä½ ä½¿ç”¨Spring Securityæ¥ä¸€æ­¥ä¸€æ­¥åœ°æ­å»ºä¸€å¥—åŸºäºJWTçš„OAuth 2.0æˆæƒä½“ç³»ã€‚è¿™äº›å†…å®¹ä¼šæ¶‰åŠOAuth 2.0çš„ä¸‰è§’è‰²ï¼ˆå®¢æˆ·ç«¯ã€æˆæƒæœåŠ¡ã€å—ä¿æŠ¤èµ„æºï¼‰ï¼Œä»¥åŠèµ„æºæ‹¥æœ‰è€…å‡­æ®è®¸å¯ã€å®¢æˆ·ç«¯å‡­æ®è®¸å¯å’Œæˆæƒç è®¸å¯è¿™ä¸‰ç§å¸¸ç”¨çš„æˆæƒè®¸å¯ç±»å‹ï¼ˆéšå¼è®¸å¯ç±»å‹ï¼Œä¸å¤ªå®‰å…¨ä¹Ÿä¸å¤ªå¸¸ç”¨ï¼‰ã€‚åŒæ—¶ï¼Œæˆ‘è¿˜ä¼šæ¼”ç¤ºOAuth 2.0çš„æƒé™æ§åˆ¶ï¼Œä»¥åŠä½¿ç”¨OAuth 2.0å®ç°SSOå•ç‚¹ç™»å½•ä½“ç³»ã€‚

è¿™æ ·ä¸€æ¥ï¼Œä»Šå¤©è¿™ä¸€è®²æ¶‰åŠåˆ°çš„æµç¨‹å°±ä¼šæ¯”è¾ƒå¤šï¼Œå†…å®¹ä¹Ÿä¼šå¾ˆé•¿ã€‚ä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘ä¼šæ‰‹æŠŠæ‰‹å¸¦ä½ ä»é›¶å¼€å§‹ï¼Œå®Œæˆæ•´ä¸ªç¨‹åºçš„æ­å»ºï¼Œå¹¶ç»™å‡ºæ‰€æœ‰æµç¨‹çš„æ¼”ç¤ºã€‚

## é¡¹ç›®å‡†å¤‡å·¥ä½œ

å®æˆ˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥æ­å»ºé¡¹ç›®çˆ¶ä¾èµ–å’Œåˆå§‹åŒ–æ•°æ®åº“ç»“æ„ï¼Œä¸ºåé¢å…·ä½“çš„ç¼–ç åšå‡†å¤‡ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªçˆ¶POMï¼Œå†…å«ä¸‰ä¸ªæ¨¡å—ï¼š

- springsecurity101-cloud-oauth2-clientï¼Œç”¨æ¥æ‰®æ¼”å®¢æˆ·ç«¯è§’è‰²ï¼›
- springsecurity101-cloud-oauth2-serverï¼Œç”¨æ¥æ‰®æ¼”æˆæƒæœåŠ¡å™¨è§’è‰²ï¼›
- springsecurity101-cloud-oauth2-userserviceï¼Œæ˜¯ç”¨æˆ·æœåŠ¡ï¼Œç”¨æ¥æ‰®æ¼”èµ„æºæä¾›è€…è§’è‰²ã€‚

```
<project xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns="http://maven.apache.org/POM/4.0.0"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>me.josephzhu</groupId>
    <artifactId>springsecurity101</artifactId>
    <packaging>pom</packaging>
    <version>1.0-SNAPSHOT</version>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.2.1.RELEASE</version>
        <relativePath/>
    </parent>

    <modules>
        <module>springsecurity101-cloud-oauth2-client</module>
        <module>springsecurity101-cloud-oauth2-server</module>
        <module>springsecurity101-cloud-oauth2-userservice</module>
    </modules>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
        <java.version>1.8</java.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
    </dependencies>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>Greenwich.SR4</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```

ç„¶åï¼Œæˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªoauthæ•°æ®åº“ï¼Œåˆå§‹åŒ–å°†æ¥ä¼šç”¨åˆ°çš„5ä¸ªè¡¨ã€‚

- authoritiesè¡¨ï¼šè®°å½•è´¦å·çš„æƒé™ï¼Œéœ€è¦æˆ‘ä»¬åœ¨åé¢é…ç½®ã€‚
- oauth\_approvalsè¡¨ï¼šè®°å½•æˆæƒæ‰¹å‡†çš„çŠ¶æ€ã€‚
- oauth\_client\_detailsè¡¨ï¼šè®°å½•OAuthçš„å®¢æˆ·ç«¯ï¼Œéœ€è¦æˆ‘ä»¬åœ¨åé¢åšé…ç½®ã€‚
- oauth\_codeè¡¨ï¼šè®°å½•æˆæƒç ã€‚
- usersè¡¨ï¼šè®°å½•è´¦å·ï¼Œéœ€è¦æˆ‘ä»¬åœ¨åé¢åšåˆå§‹åŒ–ã€‚

```
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for authorities
-- ----------------------------
DROP TABLE IF EXISTS `authorities`;
CREATE TABLE `authorities` (
  `username` varchar(50) NOT NULL,
  `authority` varchar(50) NOT NULL,
  UNIQUE KEY `ix_auth_username` (`username`,`authority`),
  CONSTRAINT `fk_authorities_users` FOREIGN KEY (`username`) REFERENCES `users` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ----------------------------
-- Table structure for oauth_approvals
-- ----------------------------
DROP TABLE IF EXISTS `oauth_approvals`;
CREATE TABLE `oauth_approvals` (
  `userId` varchar(256) DEFAULT NULL,
  `clientId` varchar(256) DEFAULT NULL,
  `partnerKey` varchar(32) DEFAULT NULL,
  `scope` varchar(256) DEFAULT NULL,
  `status` varchar(10) DEFAULT NULL,
  `expiresAt` datetime DEFAULT NULL,
  `lastModifiedAt` datetime DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- ----------------------------
-- Table structure for oauth_client_details
-- ----------------------------
DROP TABLE IF EXISTS `oauth_client_details`;
CREATE TABLE `oauth_client_details` (
  `client_id` varchar(255) NOT NULL,
  `resource_ids` varchar(255) DEFAULT NULL,
  `client_secret` varchar(255) DEFAULT NULL,
  `scope` varchar(255) DEFAULT NULL,
  `authorized_grant_types` varchar(255) DEFAULT NULL,
  `web_server_redirect_uri` varchar(255) DEFAULT NULL,
  `authorities` varchar(255) DEFAULT NULL,
  `access_token_validity` int(11) DEFAULT NULL,
  `refresh_token_validity` int(11) DEFAULT NULL,
  `additional_information` varchar(4096) DEFAULT NULL,
  `autoapprove` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`client_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ----------------------------
-- Table structure for oauth_code
-- ----------------------------
DROP TABLE IF EXISTS `oauth_code`;
CREATE TABLE `oauth_code` (
  `code` varchar(255) DEFAULT NULL,
  `authentication` blob
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ----------------------------
-- Table structure for users
-- ----------------------------
DROP TABLE IF EXISTS `users`;
CREATE TABLE `users` (
  `username` varchar(50) NOT NULL,
  `password` varchar(100) NOT NULL,
  `enabled` tinyint(1) NOT NULL,
  PRIMARY KEY (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

SET FOREIGN_KEY_CHECKS = 1;
```

è¿™5ä¸ªè¡¨æ˜¯Spring Security OAuthéœ€è¦ç”¨åˆ°çš„å­˜å‚¨è¡¨ï¼Œæˆ‘ä»¬ä¸è¦å»ä¿®æ”¹æ—¢æœ‰çš„è¡¨ç»“æ„ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰åœ¨æ•°æ®åº“ä¸­åˆ›å»ºç›¸åº”çš„è¡¨ï¼Œæ¥å­˜æ”¾è®¿é—®ä»¤ç‰Œå’Œåˆ·æ–°ä»¤ç‰Œã€‚è¿™æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬ä¹‹åçš„å®ç°ä¼šä½¿ç”¨JWTæ¥ä¼ è¾“ä»¤ç‰Œä¿¡æ¯ï¼Œä»¥ä¾¿è¿›è¡Œæœ¬åœ°æ ¡éªŒï¼Œæ‰€ä»¥å¹¶ä¸ä¸€å®šè¦å°†å…¶å­˜æ”¾åˆ°æ•°æ®åº“ä¸­ã€‚åŸºæœ¬ä¸Šæ‰€æœ‰çš„è¿™äº›è¡¨éƒ½æ˜¯å¯ä»¥è‡ªå·±æ‰©å±•çš„ï¼Œåªéœ€è¦ç»§æ‰¿å®ç°Springçš„ä¸€äº›æ—¢æœ‰ç±»å³å¯ï¼Œè¿™é‡Œä¸åšå±•å¼€ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¼€å§‹æ­å»ºæˆæƒæœåŠ¡å™¨å’Œå—ä¿æŠ¤èµ„æºæœåŠ¡å™¨ã€‚

## æ­å»ºæˆæƒæœåŠ¡å™¨

æˆ‘ä»¬å…ˆåˆ›å»ºç¬¬ä¸€ä¸ªæ¨¡å—ï¼Œä¹Ÿå°±æ˜¯æˆæƒæœåŠ¡å™¨ã€‚é¦–å…ˆåˆ›å»ºPOMï¼Œé…ç½®ä¾èµ–ï¼š

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns="http://maven.apache.org/POM/4.0.0"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>springsecurity101</artifactId>
        <groupId>me.josephzhu</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>springsecurity101-cloud-oauth2-server</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-oauth2</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-jdbc</artifactId>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>
    </dependencies>
</project>
```

è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Spring Cloudçš„spring-cloud-starter-oauth2ç»„ä»¶ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨çš„Spring Securityï¼Œå› ä¸ºå‰è€…åšäº†ä¸€äº›è‡ªåŠ¨åŒ–é…ç½®çš„å·¥ä½œï¼Œä½¿ç”¨èµ·æ¥ä¼šæ›´æ–¹ä¾¿ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜åœ¨POMä¸­åŠ å…¥äº†æ•°æ®è®¿é—®ã€Webç­‰ä¾èµ–ï¼Œå› ä¸ºæˆ‘ä»¬çš„å—ä¿æŠ¤èµ„æºæœåŠ¡å™¨éœ€è¦ä½¿ç”¨æ•°æ®åº“æ¥ä¿å­˜å®¢æˆ·ç«¯çš„ä¿¡æ¯ã€ç”¨æˆ·ä¿¡æ¯ç­‰æ•°æ®ï¼ŒåŒæ—¶ä¹Ÿä¼šå¼•å…¥thymeleafæ¨¡æ¿å¼•æ“ä¾èµ–ï¼Œæ¥ç¨ç¨ç¾åŒ–ä¸€ä¸‹ç™»å½•é¡µé¢ã€‚

ç„¶ååˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶application.ymlå®ç°ç¨‹åºé…ç½®ï¼š

```
server:
  port: 8080

spring:
  application:
    name: oauth2-server
  datasource:
    url: jdbc:mysql://localhost:6657/oauth?useSSL=false
    username: root
    password: kIo9u7Oi0eg
    driver-class-name: com.mysql.jdbc.Driver
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é…ç½®äº†oauthæ•°æ®åº“çš„è¿æ¥å­—ç¬¦ä¸²ï¼Œå®šä¹‰äº†æˆæƒæœåŠ¡å™¨çš„ç›‘å¬ç«¯å£æ˜¯8080ã€‚

æœ€åï¼Œä½¿ç”¨keytoolå·¥å…·ç”Ÿæˆå¯†é’¥å¯¹ï¼ŒæŠŠå¯†é’¥æ–‡ä»¶jksä¿å­˜åˆ°èµ„æºç›®å½•ä¸‹ï¼Œå¹¶è¦å¯¼å‡ºä¸€ä¸ªå…¬é’¥ç•™ä½œä»¥åä½¿ç”¨ã€‚

ä»¥ä¸Šå®Œæˆäº†é¡¹ç›®æ¡†æ¶æ­å»ºå·¥ä½œï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ­£å¼å¼€å§‹ç¼–ç ã€‚

ç¬¬ä¸€æ­¥ï¼Œåˆ›å»ºä¸€ä¸ªæœ€æ ¸å¿ƒçš„ç±»ç”¨äºé…ç½®æˆæƒæœåŠ¡å™¨ã€‚æˆ‘æŠŠæ¯æ®µä»£ç çš„ä½œç”¨æ”¾åœ¨äº†æ³¨é‡Šé‡Œï¼Œä½ å¯ä»¥ç›´æ¥çœ‹ä¸‹ã€‚

```
@Configuration
@EnableAuthorizationServer //å¼€å¯æˆæƒæœåŠ¡å™¨
public class OAuth2ServerConfiguration extends AuthorizationServerConfigurerAdapter {
    @Autowired
    private DataSource dataSource;
    @Autowired
    private AuthenticationManager authenticationManager;

    /**
     * æˆ‘ä»¬é…ç½®äº†ä½¿ç”¨æ•°æ®åº“æ¥ç»´æŠ¤å®¢æˆ·ç«¯ä¿¡æ¯ã€‚è™½ç„¶åœ¨å„ç§Demoä¸­æˆ‘ä»¬ç»å¸¸çœ‹åˆ°çš„æ˜¯åœ¨å†…å­˜ä¸­ç»´æŠ¤å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œé€šè¿‡é…ç½®ç›´æ¥å†™æ­»åœ¨è¿™é‡Œã€‚
     * ä½†æ˜¯ï¼Œå¯¹äºå®é™…çš„åº”ç”¨æˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šç”¨æ•°æ®åº“æ¥ç»´æŠ¤è¿™ä¸ªä¿¡æ¯ï¼Œç”šè‡³è¿˜ä¼šå»ºç«‹ä¸€å¥—å·¥ä½œæµæ¥å…è®¸å®¢æˆ·ç«¯è‡ªå·±ç”³è¯·ClientIDï¼Œå®ç°OAuthå®¢æˆ·ç«¯æ¥å…¥çš„å®¡æ‰¹ã€‚
     * @param clients
     * @throws Exception
     */
    @Override
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
        clients.jdbc(dataSource);
    }

    /**
     * è¿™é‡Œå¹²äº†ä¸¤ä»¶äº‹å„¿ã€‚é¦–å…ˆï¼Œæ‰“å¼€äº†éªŒè¯Tokençš„è®¿é—®æƒé™ï¼ˆä»¥ä¾¿ä¹‹åæˆ‘ä»¬æ¼”ç¤ºï¼‰ã€‚
     * ç„¶åï¼Œå…è®¸ClientSecretæ˜æ–‡æ–¹å¼ä¿å­˜ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡è¡¨å•æäº¤ï¼ˆè€Œä¸ä»…ä»…æ˜¯Basic Authæ–¹å¼æäº¤ï¼‰ï¼Œä¹‹åä¼šæ¼”ç¤ºåˆ°è¿™ä¸ªã€‚
     * @param security
     * @throws Exception
     */
    @Override
    public void configure(AuthorizationServerSecurityConfigurer security) throws Exception {
        security.checkTokenAccess("permitAll()")
                .allowFormAuthenticationForClients().passwordEncoder(NoOpPasswordEncoder.getInstance());
    }

    /**
     * å¹²äº†ä»¥ä¸‹4ä»¶äº‹å„¿ï¼š
     * 1. é…ç½®æˆ‘ä»¬çš„ä»¤ç‰Œå­˜æ”¾æ–¹å¼ä¸ºJWTæ–¹å¼ï¼Œè€Œä¸æ˜¯å†…å­˜ã€æ•°æ®åº“æˆ–Redisæ–¹å¼ã€‚
     * JWTæ˜¯Json Web Tokençš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨JSONæ•°æ®æ ¼å¼åŒ…è£…çš„ä»¤ç‰Œï¼Œç”±.å·æŠŠæ•´ä¸ªJWTåˆ†éš”ä¸ºå¤´ã€æ•°æ®ä½“ã€ç­¾åä¸‰éƒ¨åˆ†ã€‚
     * JWTä¿å­˜Tokenè™½ç„¶æ˜“äºä½¿ç”¨ä½†æ˜¯ä¸æ˜¯é‚£ä¹ˆå®‰å…¨ï¼Œä¸€èˆ¬ç”¨äºå†…éƒ¨ï¼Œä¸”éœ€è¦èµ°HTTPSå¹¶é…ç½®æ¯”è¾ƒçŸ­çš„å¤±æ•ˆæ—¶é—´ã€‚
     * 2. é…ç½®JWT Tokençš„éå¯¹ç§°åŠ å¯†æ¥è¿›è¡Œç­¾å
     * 3. é…ç½®ä¸€ä¸ªè‡ªå®šä¹‰çš„Tokenå¢å¼ºå™¨ï¼ŒæŠŠæ›´å¤šä¿¡æ¯æ”¾å…¥Tokenä¸­
     * 4. é…ç½®ä½¿ç”¨JDBCæ•°æ®åº“æ–¹å¼æ¥ä¿å­˜ç”¨æˆ·çš„æˆæƒæ‰¹å‡†è®°å½•
     * @param endpoints
     * @throws Exception
     */
    @Override
    public void configure(AuthorizationServerEndpointsConfigurer endpoints) {
        TokenEnhancerChain tokenEnhancerChain = new TokenEnhancerChain();
        tokenEnhancerChain.setTokenEnhancers(
                Arrays.asList(tokenEnhancer(), jwtTokenEnhancer()));

        endpoints.approvalStore(approvalStore())
                .authorizationCodeServices(authorizationCodeServices())
                .tokenStore(tokenStore())
                .tokenEnhancer(tokenEnhancerChain)
                .authenticationManager(authenticationManager);
    }

    /**
     * ä½¿ç”¨JDBCæ•°æ®åº“æ–¹å¼æ¥ä¿å­˜æˆæƒç 
     * @return
     */
    @Bean
    public AuthorizationCodeServices authorizationCodeServices() {
        return new JdbcAuthorizationCodeServices(dataSource);
    }

    /**
     * ä½¿ç”¨JWTå­˜å‚¨
     * @return
     */
    @Bean
    public TokenStore tokenStore() {
        return new JwtTokenStore(jwtTokenEnhancer());
    }

    /**
     * ä½¿ç”¨JDBCæ•°æ®åº“æ–¹å¼æ¥ä¿å­˜ç”¨æˆ·çš„æˆæƒæ‰¹å‡†è®°å½•
     * @return
     */
    @Bean
    public JdbcApprovalStore approvalStore() {
        return new JdbcApprovalStore(dataSource);
    }

    /**
     * è‡ªå®šä¹‰çš„Tokenå¢å¼ºå™¨ï¼ŒæŠŠæ›´å¤šä¿¡æ¯æ”¾å…¥Tokenä¸­
     * @return
     */
    @Bean
    public TokenEnhancer tokenEnhancer() {
        return new CustomTokenEnhancer();
    }

    /**
     * é…ç½®JWTä½¿ç”¨éå¯¹ç§°åŠ å¯†æ–¹å¼æ¥éªŒè¯
     * @return
     */
    @Bean
    protected JwtAccessTokenConverter jwtTokenEnhancer() {
        KeyStoreKeyFactory keyStoreKeyFactory = new KeyStoreKeyFactory(new ClassPathResource("jwt.jks"), "mySecretKey".toCharArray());
        JwtAccessTokenConverter converter = new JwtAccessTokenConverter();
        converter.setKeyPair(keyStoreKeyFactory.getKeyPair("jwt"));
        return converter;
    }

    /**
     * é…ç½®ç™»å½•é¡µé¢çš„è§†å›¾ä¿¡æ¯ï¼ˆå…¶å®å¯ä»¥ç‹¬ç«‹ä¸€ä¸ªé…ç½®ç±»ï¼Œè¿™æ ·ä¼šæ›´è§„èŒƒï¼‰
     */
    @Configuration
    static class MvcConfig implements WebMvcConfigurer {
        @Override
        public void addViewControllers(ViewControllerRegistry registry) {
            registry.addViewController("login").setViewName("login");
        }
    }
}
```

ç¬¬äºŒæ­¥ï¼Œè¿˜è®°å¾—å—ï¼Œåˆšæ‰åœ¨ç¬¬ä¸€æ­¥çš„ä»£ç ä¸­æˆ‘ä»¬è¿˜ç”¨åˆ°äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„Tokenå¢å¼ºå™¨ï¼ŒæŠŠç”¨æˆ·ä¿¡æ¯åµŒå…¥åˆ°JWT Tokenä¸­å»ï¼ˆå¦‚æœä½¿ç”¨çš„æ˜¯å®¢æˆ·ç«¯å‡­æ®è®¸å¯ç±»å‹ï¼Œè¿™æ®µä»£ç æ— æ•ˆï¼Œå› ä¸ºå’Œç”¨æˆ·æ²¡å…³ç³»ï¼‰ã€‚

è¿™æ˜¯ä¸€ä¸ªå¸¸è§éœ€æ±‚ã€‚å› ä¸ºï¼Œé»˜è®¤æƒ…å†µä¸‹Tokenä¸­åªä¼šæœ‰ç”¨æˆ·åè¿™æ ·çš„åŸºæœ¬ä¿¡æ¯ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦æŠŠå…³äºç”¨æˆ·çš„æ›´å¤šä¿¡æ¯è¿”å›ç»™å®¢æˆ·ç«¯ï¼ˆåœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ å¯èƒ½ä¼šä»æ•°æ®åº“æˆ–å¤–éƒ¨æœåŠ¡æŸ¥è¯¢æ›´å¤šçš„ç”¨æˆ·ä¿¡æ¯åŠ å…¥åˆ°JWT Tokenä¸­å»ï¼‰ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è‡ªå®šä¹‰å¢å¼ºå™¨æ¥ä¸°å¯ŒTokençš„å†…å®¹ï¼š

```
public class CustomTokenEnhancer implements TokenEnhancer {

    @Override
    public OAuth2AccessToken enhance(OAuth2AccessToken accessToken, OAuth2Authentication authentication) {
        Authentication userAuthentication = authentication.getUserAuthentication();
        if (userAuthentication != null) {
            Object principal = authentication.getUserAuthentication().getPrincipal();
            //æŠŠç”¨æˆ·æ ‡è¯†åµŒå…¥JWT Tokenä¸­å»(Keyæ˜¯userDetails)
            Map<String, Object> additionalInfo = new HashMap<>();
            additionalInfo.put("userDetails", principal);
            ((DefaultOAuth2AccessToken) accessToken).setAdditionalInformation(additionalInfo);
        }
        return accessToken;
    }
}
```

ç¬¬ä¸‰æ­¥ï¼Œå®ç°å®‰å…¨æ–¹é¢çš„é…ç½®ã€‚ä½ å¯ä»¥ç›´æ¥çœ‹ä¸‹ä»£ç æ³¨é‡Šï¼Œæ¥äº†è§£å…³é”®ä»£ç çš„ä½œç”¨ã€‚

```
@Configuration
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
    @Autowired
    private DataSource dataSource;

    @Override
    @Bean
    public AuthenticationManager authenticationManagerBean() throws Exception {
        return super.authenticationManagerBean();
    }

    /**
     * é…ç½®ç”¨æˆ·è´¦æˆ·çš„è®¤è¯æ–¹å¼ã€‚æ˜¾ç„¶ï¼Œæˆ‘ä»¬æŠŠç”¨æˆ·å­˜åœ¨äº†æ•°æ®åº“ä¸­å¸Œæœ›é…ç½®JDBCçš„æ–¹å¼ã€‚
     * æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜é…ç½®äº†ä½¿ç”¨BCryptPasswordEncoderå“ˆå¸Œæ¥ä¿å­˜ç”¨æˆ·çš„å¯†ç ï¼ˆç”Ÿäº§ç¯å¢ƒä¸­ï¼Œç”¨æˆ·å¯†ç è‚¯å®šä¸èƒ½æ˜¯æ˜æ–‡ä¿å­˜çš„ï¼‰
     * @param auth
     * @throws Exception
     */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.jdbcAuthentication()
                .dataSource(dataSource)
                .passwordEncoder(new BCryptPasswordEncoder());
    }

    /**
     * å¼€æ”¾/loginå’Œ/oauth/authorizeä¸¤ä¸ªè·¯å¾„çš„åŒ¿åè®¿é—®ã€‚å‰è€…ç”¨äºç™»å½•ï¼Œåè€…ç”¨äºæ¢æˆæƒç ï¼Œè¿™ä¸¤ä¸ªç«¯ç‚¹è®¿é—®çš„æ—¶æœºéƒ½åœ¨ç™»å½•ä¹‹å‰ã€‚
     * è®¾ç½®/loginä½¿ç”¨è¡¨å•éªŒè¯è¿›è¡Œç™»å½•ã€‚
     * @param http
     * @throws Exception
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests()
                .antMatchers("/login", "/oauth/authorize")
                .permitAll()
                .anyRequest().authenticated()
                .and()
                .formLogin().loginPage("/login");
    }
}
```

ç¬¬å››æ­¥ï¼Œåœ¨èµ„æºç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªtemplatesæ–‡ä»¶å¤¹ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªlogin.htmlç™»å½•é¡µï¼š

```
<body class="uk-height-1-1">

<div class="uk-vertical-align uk-text-center uk-height-1-1">
    <div class="uk-vertical-align-middle" style="width: 250px;">
        <h1>Login Form</h1>

        <p class="uk-text-danger" th:if="${param.error}">
            ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯...
        </p>

        <form class="uk-panel uk-panel-box uk-form" method="post" th:action="@{/login}">
            <div class="uk-form-row">
                <input class="uk-width-1-1 uk-form-large" type="text" placeholder="Username" name="username"
                       value="reader"/>
            </div>
            <div class="uk-form-row">
                <input class="uk-width-1-1 uk-form-large" type="password" placeholder="Password" name="password"
                       value="reader"/>
            </div>
            <div class="uk-form-row">
                <button class="uk-width-1-1 uk-button uk-button-primary uk-button-large">Login</button>
            </div>
        </form>

    </div>
</div>
</body>
```

è‡³æ­¤ï¼ŒæˆæƒæœåŠ¡å™¨çš„ç¼–ç å·¥ä½œå°±å®Œæˆäº†ã€‚

## æ­å»ºå—ä¿æŠ¤èµ„æºæœåŠ¡å™¨

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ­å»ºä¸€ä¸ªç”¨æˆ·æœåŠ¡æ¨¡æ‹Ÿèµ„æºæä¾›è€…ï¼ˆå—ä¿æŠ¤èµ„æºæœåŠ¡å™¨ï¼‰ã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹é¡¹ç›®åˆå§‹åŒ–å·¥ä½œã€‚

è¿™æ¬¡åˆ›å»ºçš„POMæ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šï¼Œä¾èµ–äº†spring-cloud-starter-oauth2ï¼š

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns="http://maven.apache.org/POM/4.0.0"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>springsecurity101</artifactId>
        <groupId>me.josephzhu</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>springsecurity101-cloud-oauth2-userservice</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-oauth2</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
    </dependencies>
</project>
```

é…ç½®æ–‡ä»¶éå¸¸ç®€å•ï¼Œåªæ˜¯å£°æ˜äº†èµ„æºæœåŠ¡ç«¯å£ä¸º8081ï¼š

```
server:
  port: 8081
```

åŒæ—¶ï¼Œè¿˜è¦è®°å¾—æŠŠæˆ‘ä»¬ä¹‹å‰åœ¨é¡¹ç›®å‡†å¤‡å·¥ä½œæ—¶ç”Ÿæˆçš„å¯†é’¥å¯¹çš„å…¬é’¥å‘½åä¸ºpublic.certï¼Œå¹¶æ”¾åˆ°èµ„æºæ–‡ä»¶ä¸‹ã€‚è¿™æ ·ï¼Œèµ„æºæœåŠ¡å™¨å¯ä»¥æœ¬åœ°æ ¡éªŒJWTçš„åˆæ³•æ€§ã€‚å†…å®¹å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š

```
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwR84LFHwnK5GXErnwkmD
mPOJl4CSTtYXCqmCtlbF+5qVOosu0YsM2DsrC9O2gun6wVFKkWYiMoBSjsNMSI3Z
w5JYgh+ldHvA+MIex2QXfOZx920M1fPUiuUPgmnTFS+Z3lmK3/T6jJnmciUPY1pe
h4MXL6YzeI0q4W9xNBBeKT6FDGpduc0FC3OlXHfLbVOThKmAUpAWFDwf9/uUA//l
3PLchmV6VwTcUaaHp5W8Af/GU4lPGZbTAqOxzB9ukisPFuO1DikacPhrOQgdxtqk
LciRTa884uQnkFwSguOEUYf3ni8GNRJauIuW0rVXhMOs78pKvCKmo53M0tqeC6ul
+QIDAQAB
-----END PUBLIC KEY-----
```

å¥½äº†ï¼Œè®©æˆ‘ä»¬æ­£å¼å¼€å§‹ç¼–ç å§ã€‚

ç¬¬ä¸€æ­¥ï¼Œåˆ›å»ºä¸€ä¸ªå¯ä»¥åŒ¿åè®¿é—®çš„æ¥å£GET /helloï¼Œç”¨æ¥æµ‹è¯•æ— éœ€ç™»å½•å°±å¯ä»¥è®¿é—®çš„æœåŠ¡ç«¯èµ„æºï¼š

```
@RestController
public class HelloController {
    @GetMapping("hello")
    public String hello() {
        return "Hello";
    }
}
```

ç¬¬äºŒæ­¥ï¼Œåˆ›å»ºä¸‰ä¸ªéœ€è¦ç™»å½•+æˆæƒæ‰èƒ½è®¿é—®åˆ°çš„æ¥å£ã€‚æˆ‘ä»¬é€šè¿‡@PreAuthorizeåœ¨æ–¹æ³•æ‰§è¡Œå‰è¿›è¡Œæƒé™æ§åˆ¶ï¼š

- GET /user/nameæ¥å£ï¼Œè¯»æƒé™æˆ–å†™æƒé™å¯è®¿é—®ï¼Œè¿”å›ç™»å½•ç”¨æˆ·åï¼›
- GET /useræ¥å£ï¼Œè¯»æƒé™æˆ–å†™æƒé™å¯è®¿é—®ï¼Œè¿”å›ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼›
- POST /useræ¥å£ï¼Œåªæœ‰å†™æƒé™å¯ä»¥è®¿é—®ï¼Œè¿”å›è®¿é—®ä»¤ç‰Œä¸­çš„é¢å¤–ä¿¡æ¯ï¼ˆä¹Ÿå°±æ˜¯è‡ªå®šä¹‰çš„Tokenå¢å¼ºå™¨CustomTokenEnhanceråŠ å…¥åˆ°è®¿é—®ä»¤ç‰Œä¸­çš„é¢å¤–ä¿¡æ¯ï¼ŒKeyæ˜¯userDetailsï¼‰ï¼Œè¿™é‡Œä¹Ÿæ¼”ç¤ºäº†ä½¿ç”¨TokenStoreæ¥è§£æTokençš„æ–¹å¼ã€‚

```
@RestController
@RequestMapping("user")
public class UserController {

    @Autowired
    private TokenStore tokenStore;

    /***
     * è¯»æƒé™æˆ–å†™æƒé™å¯è®¿é—®ï¼Œè¿”å›ç™»å½•ç”¨æˆ·å
     * @param authentication
     * @return
     */
    @PreAuthorize("hasAuthority('READ') or hasAuthority('WRITE')")
    @GetMapping("name")
    public String name(OAuth2Authentication authentication) {
        return authentication.getName();
    }

    /**
     * è¯»æƒé™æˆ–å†™æƒé™å¯è®¿é—®ï¼Œè¿”å›ç™»å½•ç”¨æˆ·ä¿¡æ¯
     * @param authentication
     * @return
     */
    @PreAuthorize("hasAuthority('READ') or hasAuthority('WRITE')")
    @GetMapping
    public OAuth2Authentication read(OAuth2Authentication authentication) {
        return authentication;
    }

    /**
     * åªæœ‰å†™æƒé™å¯ä»¥è®¿é—®ï¼Œè¿”å›è®¿é—®ä»¤ç‰Œä¸­çš„é¢å¤–ä¿¡æ¯
     * @param authentication
     * @return
     */
    @PreAuthorize("hasAuthority('WRITE')")
    @PostMapping
    public Object write(OAuth2Authentication authentication) {
        OAuth2AuthenticationDetails details = (OAuth2AuthenticationDetails) authentication.getDetails();
        OAuth2AccessToken accessToken = tokenStore.readAccessToken(details.getTokenValue());
        return accessToken.getAdditionalInformation().getOrDefault("userDetails", null);
    }
}
```

ç¬¬ä¸‰æ­¥ï¼Œåˆ›å»ºæ ¸å¿ƒçš„èµ„æºæœåŠ¡å™¨é…ç½®ç±»ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸‹é¢ä¸¤ç‚¹ï¼š

- æˆ‘ä»¬ç¡¬ç¼–ç äº†èµ„æºæœåŠ¡å™¨çš„IDä¸ºuserserviceï¼›
- ç°åœ¨æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ä¸è½æ•°æ®åº“çš„JWTæ–¹å¼+éå¯¹ç§°åŠ å¯†ï¼Œéœ€è¦é€šè¿‡æœ¬åœ°å…¬é’¥è¿›è¡ŒéªŒè¯ï¼Œå› æ­¤åœ¨è¿™é‡Œæˆ‘ä»¬é…ç½®äº†å…¬é’¥çš„è·¯å¾„ã€‚

```
@Configuration
@EnableResourceServer //å¯ç”¨èµ„æºæœåŠ¡å™¨
@EnableGlobalMethodSecurity(prePostEnabled = true) //å¯ç”¨æ–¹æ³•æ³¨è§£æ–¹å¼æ¥è¿›è¡Œæƒé™æ§åˆ¶
public class ResourceServerConfiguration extends ResourceServerConfigurerAdapter {

    /**
     * å£°æ˜äº†èµ„æºæœåŠ¡å™¨çš„IDæ˜¯userserviceï¼Œå£°æ˜äº†èµ„æºæœåŠ¡å™¨çš„TokenStoreæ˜¯JWT
     * @param resources
     * @throws Exception
     */
    @Override
    public void configure(ResourceServerSecurityConfigurer resources) throws Exception {
        resources.resourceId("userservice").tokenStore(tokenStore());
    }

    /**
     * é…ç½®TokenStore
     * @return
     */
    @Bean
    public TokenStore tokenStore() {
        return new JwtTokenStore(jwtAccessTokenConverter());
    }

    /**
     * é…ç½®å…¬é’¥
     * @return
     */
    @Bean
    protected JwtAccessTokenConverter jwtAccessTokenConverter() {
        JwtAccessTokenConverter converter = new JwtAccessTokenConverter();
        Resource resource = new ClassPathResource("public.cert");
        String publicKey = null;
        try {
            publicKey = new String(FileCopyUtils.copyToByteArray(resource.getInputStream()));
        } catch (IOException e) {
            e.printStackTrace();
        }
        converter.setVerifierKey(publicKey);
        return converter;
    }

    /**
     * é…ç½®äº†é™¤äº†/userè·¯å¾„ä¹‹å¤–çš„è¯·æ±‚å¯ä»¥åŒ¿åè®¿é—®
     * @param http
     * @throws Exception
     */
    @Override
    public void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests()
                .antMatchers("/user/**").authenticated()
                .anyRequest().permitAll();
    }
}    
```

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æ¥æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæˆæƒæœåŠ¡å™¨äº§ç”ŸTokençš„è¯ï¼Œå—ä¿æŠ¤èµ„æºæœåŠ¡å™¨å¿…é¡»è¦æœ‰ä¸€ç§åŠæ³•æ¥éªŒè¯Tokenï¼Œé‚£å¦‚æœè¿™é‡Œçš„Tokenä¸æ˜¯JWTçš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

æˆ‘æ¥è¯´ä¸‹æˆ‘çš„æ–¹æ³•å§ï¼š

- é¦–å…ˆï¼ŒTokenå¯ä»¥ä¿å­˜åœ¨æ•°æ®åº“æˆ–Redisä¸­ï¼Œèµ„æºæœåŠ¡å™¨å’ŒæˆæƒæœåŠ¡å™¨å…±äº«åº•å±‚çš„TokenStoreæ¥éªŒè¯ï¼›
- ç„¶åï¼Œèµ„æºæœåŠ¡å™¨å¯ä»¥ä½¿ç”¨RemoteTokenServicesï¼Œæ¥ä»æˆæƒæœåŠ¡å™¨çš„/oauth/check\_tokenç«¯ç‚¹è¿›è¡ŒTokenæ ¡éªŒã€‚

åˆ°è¿™é‡Œï¼Œèµ„æºæœåŠ¡å™¨å°±é…ç½®å®Œæˆäº†ï¼Œæˆ‘ä»¬è¿˜åœ¨èµ„æºæœåŠ¡å™¨ä¸­åˆ†åˆ«åˆ›å»ºäº†ä¸¤ä¸ªæ§åˆ¶å™¨HelloControllerå’ŒUserControllerï¼Œç”¨äºåˆ†åˆ«æµ‹è¯•å¯ä»¥åŒ¿åè®¿é—®ä»¥åŠå—åˆ°æƒé™ä¿æŠ¤çš„èµ„æºã€‚

## åˆå§‹åŒ–æ•°æ®é…ç½®

åœ¨å®ç°äº†æˆæƒæœåŠ¡å™¨å’Œå—ä¿æŠ¤èµ„æºæœåŠ¡å™¨ä»£ç åï¼Œæˆ‘ä»¬å†æ¥åˆå§‹åŒ–oauthæ•°æ®åº“çš„æ•°æ®å°±éå¸¸å®¹æ˜“ç†è§£äº†ã€‚æ€»ç»“èµ·æ¥ï¼Œæˆ‘ä»¬éœ€è¦é…ç½®ç”¨æˆ·ã€æƒé™å’Œå®¢æˆ·ç«¯ä¸‰éƒ¨åˆ†ã€‚

1. é…ç½®ä¸¤ä¸ªç”¨æˆ·ã€‚å…¶ä¸­ï¼Œè¯»ç”¨æˆ·readerå…·æœ‰è¯»æƒé™ï¼Œå¯†ç ä¸ºreaderï¼›å†™ç”¨æˆ·writerå…·æœ‰è¯»å†™æƒé™ï¼Œå¯†ç ä¸ºwriterã€‚è¿˜è®°å¾—å—ï¼Œå¯†ç æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯BCryptPasswordEncoderåŠ å¯†ï¼ˆå‡†ç¡®è¯´æ˜¯å“ˆå¸Œï¼‰ï¼Ÿ

```
INSERT INTO `users` VALUES ('reader', '$2a$04$C6pPJvC1v6.enW6ZZxX.luTdpSI/1gcgTVN7LhvQV6l/AfmzNU/3i', 1);
INSERT INTO `users` VALUES ('writer', '$2a$04$M9t2oVs3/VIreBMocOujqOaB/oziWL0SnlWdt8hV4YnlhQrORA0fS', 1);
```

2. é…ç½®ä¸¤ä¸ªæƒé™ï¼Œä¹Ÿå°±æ˜¯é…ç½®readerç”¨æˆ·å…·æœ‰è¯»æƒé™ï¼Œwriterç”¨æˆ·å…·æœ‰å†™æƒé™ï¼š

```
INSERT INTO `authorities` VALUES ('reader', 'READ');
INSERT INTO `authorities` VALUES ('writer', 'READ,WRITE');
```

3. é…ç½®ä¸‰ä¸ªå®¢æˆ·ç«¯ï¼Œå…¶ä¸­å®¢æˆ·ç«¯userservice1ä½¿ç”¨èµ„æºæ‹¥æœ‰è€…å‡­æ®è®¸å¯ç±»å‹ï¼Œå®¢æˆ·ç«¯userservice2ä½¿ç”¨å®¢æˆ·ç«¯å‡­æ®è®¸å¯ç±»å‹ï¼Œå®¢æˆ·ç«¯userservice3ä½¿ç”¨æˆæƒç è®¸å¯ç±»å‹ã€‚

```
INSERT INTO `oauth_client_details` VALUES ('userservice1', 'userservice', '1234', 'FOO', 'password,refresh_token', '', 'READ,WRITE', 7200, NULL, NULL, 'true');
INSERT INTO `oauth_client_details` VALUES ('userservice2', 'userservice', '1234', 'FOO', 'client_credentials,refresh_token', '', 'READ,WRITE', 7200, NULL, NULL, 'true');
INSERT INTO `oauth_client_details` VALUES ('userservice3', 'userservice', '1234', 'FOO', 'authorization_code,refresh_token', 'https://baidu.com,http://localhost:8082/ui/login,http://localhost:8083/ui/login,http://localhost:8082/ui/remoteCall', 'READ,WRITE', 7200, NULL, NULL, 'false');
```

å€¼å¾—è¯´æ˜çš„æ˜¯ï¼š

- ä¸‰ä¸ªå®¢æˆ·ç«¯è´¦å·èƒ½ä½¿ç”¨çš„èµ„æºIDéƒ½æ˜¯userserviceï¼Œå¯¹åº”æˆ‘ä»¬å—ä¿æŠ¤èµ„æºæœåŠ¡å™¨åˆšæ‰é…ç½®çš„èµ„æºIDï¼Œä¹Ÿå°±æ˜¯userserviceï¼Œè¿™ä¸¤è€…éœ€è¦ä¸€è‡´ã€‚
- ä¸‰ä¸ªå®¢æˆ·ç«¯è´¦å·çš„å¯†ç éƒ½æ˜¯1234ã€‚
- ä¸‰ä¸ªå®¢æˆ·ç«¯è´¦å·çš„æˆæƒèŒƒå›´éƒ½æ˜¯FOOï¼ˆå¹¶ä¸æ˜¯å…³é”®ä¿¡æ¯ï¼‰ï¼Œå®ƒä»¬å¯ä»¥æ‹¿åˆ°çš„æƒé™æ˜¯è¯»å†™ã€‚ä¸è¿‡ï¼Œå¯¹äºå’Œç”¨æˆ·ç›¸å…³çš„æˆæƒè®¸å¯ç±»å‹ï¼ˆæ¯”å¦‚èµ„æºæ‹¥æœ‰è€…å‡­æ®è®¸å¯ã€æˆæƒç è®¸å¯ï¼‰ï¼Œæœ€ç»ˆæ‹¿åˆ°çš„æƒé™è¿˜å–å†³äºå®¢æˆ·ç«¯æƒé™å’Œç”¨æˆ·æƒé™çš„äº¤é›†ã€‚
- é€šè¿‡grant\_typeså­—æ®µé…ç½®æ”¯æŒä¸åŒçš„æˆæƒè®¸å¯ç±»å‹ã€‚è¿™é‡Œä¸ºäº†ä¾¿äºæµ‹è¯•è§‚å¯Ÿï¼Œæˆ‘ä»¬ç»™ä¸‰ä¸ªå®¢æˆ·ç«¯è´¦å·å„è‡ªé…ç½®äº†ä¸€ç§æˆæƒè®¸å¯ç±»å‹ï¼›åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œä½ å®Œå…¨å¯ä»¥ä¸ºåŒä¸€ä¸ªå®¢æˆ·ç«¯é…ç½®æ”¯æŒOAuth 2.0çš„å››ç§æˆæƒè®¸å¯ç±»å‹ã€‚
- userservice1å’Œuserservice2æˆ‘ä»¬é…ç½®äº†ç”¨æˆ·è‡ªåŠ¨æ‰¹å‡†æˆæƒï¼ˆä¸ä¼šå¼¹å‡ºä¸€ä¸ªé¡µé¢è¦æ±‚ç”¨æˆ·è¿›è¡Œæˆæƒï¼‰ã€‚

## æ¼”ç¤ºä¸‰ç§æˆæƒè®¸å¯ç±»å‹

åˆ°è¿™é‡Œï¼ŒæˆæƒæœåŠ¡å™¨å’Œå—ä¿æŠ¤èµ„æºæœåŠ¡å™¨ç¨‹åºéƒ½æ­å»ºå®Œæˆäº†ï¼Œæ•°æ®åº“ä¹Ÿé…ç½®äº†ç”¨äºæµ‹è¯•çš„ç”¨æˆ·ã€æƒé™å’Œå®¢æˆ·ç«¯ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨Postmanæ¥æ‰‹å·¥æµ‹è¯•ä¸€ä¸‹OAuth 2.0çš„æˆæƒç è®¸å¯ã€èµ„æºæ‹¥æœ‰è€…å‡­æ®è®¸å¯ã€å®¢æˆ·ç«¯å‡­æ®è®¸å¯è¿™ä¸‰ç§æˆæƒè®¸å¯ç±»å‹å§ã€‚

### èµ„æºæ‹¥æœ‰è€…å‡­æ®è®¸å¯ç±»å‹

é¦–å…ˆï¼Œæˆ‘ä»¬æµ‹è¯•çš„æ˜¯èµ„æºæ‹¥æœ‰è€…å‡­æ®è®¸å¯ï¼ŒPOSTè¯·æ±‚åœ°å€æ˜¯ï¼š

```
http://localhost:8080/oauth/token?grant_type=password&client_id=userservice1&client_secret=1234&username=writer&password=writer
```

å¾—åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºç»“æœï¼š

![](https://static001.geekbang.org/resource/image/18/e4/18cd7b24ff152e28806b1176b0a560e4.png?wh=2548%2A1794)

å†ä½¿ç”¨[JWTè§£æå·¥å…·](http://jwt.io/)çœ‹ä¸‹è¯·æ±‚Tokenä¸­çš„ä¿¡æ¯ï¼š

![](https://static001.geekbang.org/resource/image/8e/7e/8e4c2dd1931a31197df55cc251b2a07e.png?wh=3006%2A1482)

å¯ä»¥çœ‹åˆ°ï¼ŒTokenä¸­æœç„¶åŒ…å«äº†Tokenå¢å¼ºå™¨åŠ å…¥çš„userDetailsè‡ªå®šä¹‰ä¿¡æ¯ã€‚å¦‚æœæˆ‘ä»¬æŠŠå…¬é’¥ç²˜è´´åˆ°é¡µé¢çš„è¯ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªJWTæ ¡éªŒæˆåŠŸäº†ï¼š

![](https://static001.geekbang.org/resource/image/4d/ae/4d701319144d3de7c5d743f59e4991ae.png?wh=3054%2A1408)

é™¤äº†æœ¬åœ°æ ¡éªŒå¤–ï¼Œè¿˜å¯ä»¥è®¿é—®æˆæƒæœåŠ¡å™¨æ¥æ ¡éªŒJWTï¼š

```
http://localhost:8080/oauth/check_token?client_id=userservice1&client_secret=1234&token=...
```

å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š

![](https://static001.geekbang.org/resource/image/28/95/2835c0d2b49ac515c9f6c537dd2f7195.png?wh=2552%2A1730)

### å®¢æˆ·ç«¯æˆæƒè®¸å¯ç±»å‹

æˆ‘ä»¬å†æ¥æµ‹è¯•ä¸‹å®¢æˆ·ç«¯æˆæƒè®¸å¯ç±»å‹ã€‚POSTè¯·æ±‚åœ°å€ï¼š

```
http://localhost:8080/oauth/token?grant_type=client_credentials&client_id=userservice2&client_secret=1234
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥ç›´æ¥æ‹¿åˆ°Tokenï¼š

![](https://static001.geekbang.org/resource/image/81/e9/81722855fd6935aea594ec62b64bf0e9.png?wh=2546%2A1014)

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶æ²¡æœ‰æä¾›åˆ·æ–°ä»¤ç‰Œã€‚è¿™æ˜¯å› ä¸ºï¼Œåˆ·æ–°ä»¤ç‰Œç”¨äºé¿å…è®¿é—®ä»¤ç‰Œå¤±æ•ˆåéœ€è¦ç”¨æˆ·å†æ¬¡ç™»å½•çš„é—®é¢˜ï¼Œè€Œå®¢æˆ·ç«¯æˆæƒè®¸å¯ç±»å‹æ²¡æœ‰ç”¨æˆ·çš„æ¦‚å¿µï¼Œå› æ­¤æ²¡æœ‰åˆ·æ–°ä»¤ç‰Œï¼Œä¹Ÿæ— æ³•æ³¨å…¥é¢å¤–çš„userDetailsä¿¡æ¯ã€‚

![](https://static001.geekbang.org/resource/image/fc/da/fcf2b1c1a53ecc33d3a0abc72b6d83da.png?wh=3024%2A1636)

ä¹Ÿå¯ä»¥è¯•ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬çš„æˆæƒæœåŠ¡å™¨æ²¡æœ‰å¼€å¯allowFormAuthenticationForClientså‚æ•°ï¼ˆå…è®¸è¡¨å•æäº¤è®¤è¯ï¼‰çš„è¯ï¼Œå®¢æˆ·ç«¯çš„å‡­è¯éœ€è¦é€šè¿‡Basic Authä¼ è¿‡å»è€Œä¸æ˜¯é€šè¿‡Postï¼š

![](https://static001.geekbang.org/resource/image/ce/6f/ce391c3c93e2131e1cf8fb4e3324b66f.png?wh=2544%2A1330)

### æˆæƒç è®¸å¯ç±»å‹

æœ€åï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸‹æ¯”è¾ƒå¤æ‚çš„æˆæƒç è®¸å¯ã€‚

**ç¬¬ä¸€æ­¥**ï¼Œæ‰“å¼€æµè§ˆå™¨è®¿é—®åœ°å€ï¼š

```
http://localhost:8080/oauth/authorize?response_type=code&client_id=userservice3&redirect_uri=https://baidu.com
```

æ³¨æ„ï¼Œå®¢æˆ·ç«¯è·³è½¬åœ°å€éœ€è¦å’Œæ•°æ®åº“ä¸­é…ç½®çš„ä¸€è‡´ï¼ˆç™¾åº¦çš„URL [https://baidu.com](https://baidu.com)

æˆ‘ä»¬ä¹‹å‰å·²ç»åœ¨æ•°æ®åº“ä¸­æœ‰é…ç½®äº†ï¼‰ã€‚è®¿é—®åé¡µé¢ä¼šç›´æ¥è·³è½¬åˆ°ç™»å½•ç•Œé¢ï¼Œæˆ‘ä»¬ä½¿ç”¨ç”¨æˆ·åâ€œreaderâ€ã€å¯†ç â€œreaderâ€æ¥ç™»å½•ï¼š

![](https://static001.geekbang.org/resource/image/73/11/73c3bd926e4e350b220447cd8b97d811.png?wh=2212%2A1424)

ç”±äºæˆ‘ä»¬åœ¨æ•°æ®åº“ä¸­è®¾ç½®çš„æ˜¯ç¦ç”¨è‡ªåŠ¨æ‰¹å‡†æˆæƒçš„æ¨¡å¼ï¼Œæ‰€ä»¥ç™»å½•åæ¥åˆ°äº†æ‰¹å‡†ç•Œé¢ï¼š

![](https://static001.geekbang.org/resource/image/9c/01/9cac3b06b632220166d7e43607da4901.png?wh=2114%2A548)

ç‚¹å‡»åŒæ„åå¯ä»¥çœ‹åˆ°ï¼Œæ•°æ®åº“ä¸­ä¹Ÿä¼šäº§ç”Ÿæˆæƒé€šè¿‡è®°å½•ï¼š

![](https://static001.geekbang.org/resource/image/9e/6f/9e942cc7c22ff8b4540e9f6736d56b6f.png?wh=1370%2A302)

**ç¬¬äºŒæ­¥ï¼Œ**æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æµè§ˆå™¨è½¬åˆ°äº†ç™¾åº¦å¹¶ä¸”æä¾›ç»™äº†æˆ‘ä»¬æˆæƒç ï¼š

```
https://www.baidu.com/?code=XKkHGY
```

æ•°æ®åº“ä¸­ä¹Ÿè®°å½•äº†æˆæƒç ï¼š

![](https://static001.geekbang.org/resource/image/ef/3e/eff235ff90aafb559d6e45b07a4d173e.png?wh=1344%2A254)

ç„¶åPOSTè®¿é—®ä¸‹é¢çš„åœ°å€ï¼ˆcodeå‚æ•°æ›¿æ¢ä¸ºåˆšæ‰è·å¾—çš„æˆæƒç ï¼‰ï¼š

```
http://localhost:8080/oauth/token?grant_type=authorization_code&client_id=userservice3&client_secret=1234&code=XKkHGY&redirect_uri=https://baidu.com
```

å¯ä»¥é€šè¿‡æˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œï¼š

![](https://static001.geekbang.org/resource/image/ea/d7/ea401694bf55f83353f7db65d17ab6d7.png?wh=2544%2A1800)

è™½ç„¶userservice3å®¢æˆ·ç«¯å¯ä»¥æœ‰è¯»æƒé™å’Œå†™æƒé™ï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬ç™»å½•çš„ç”¨æˆ·readeråªæœ‰è¯»æƒé™ï¼Œæ‰€ä»¥æœ€åæ‹¿åˆ°ä¹Ÿåªæœ‰è¯»æƒé™ã€‚

## æ¼”ç¤ºæƒé™æ§åˆ¶

ç°åœ¨æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ä¹‹å‰å®šä¹‰çš„ä¸¤ä¸ªè´¦å·ï¼Œä¹Ÿå°±æ˜¯è¯»è´¦å·å’Œå†™è´¦å·ï¼Œçœ‹çœ‹å®ƒä»¬çš„æƒé™æ§åˆ¶æ˜¯å¦æœ‰æ•ˆã€‚

é¦–å…ˆï¼Œæµ‹è¯•ä¸€ä¸‹æˆ‘ä»¬çš„å®‰å…¨é…ç½®ï¼Œè®¿é—®/helloç«¯ç‚¹ä¸éœ€è¦è®¤è¯å¯ä»¥åŒ¿åè®¿é—®ï¼š

![](https://static001.geekbang.org/resource/image/76/59/7646fe1e6e4cc9914f79881576126459.png?wh=790%2A220)

è®¿é—®/useréœ€è¦èº«ä»½è®¤è¯ï¼š

![](https://static001.geekbang.org/resource/image/3b/f6/3b22a89392c92187960aecd4bc3cf8f6.png?wh=2302%2A436)

ä¸ç®¡ä»¥å“ªç§æ¨¡å¼æ‹¿åˆ°è®¿é—®ä»¤ç‰Œï¼Œæˆ‘ä»¬ç”¨å…·æœ‰è¯»æƒé™çš„è®¿é—®ä»¤ç‰Œè®¿é—®èµ„æºæœåŠ¡å™¨çš„å¦‚ä¸‹åœ°å€

ï¼ˆè¯·æ±‚å¤´åŠ å…¥Authorization: Bearer XXXXXXXXXXï¼Œå…¶ä¸­XXXXXXXXXXä»£è¡¨è®¿é—®ä»¤ç‰Œï¼‰ï¼š

```
http://localhost:8081/user/
```

å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š

![](https://static001.geekbang.org/resource/image/06/d5/0606fbb094de245d346ed17d9yycd6d5.png?wh=2504%2A1746)

ä»¥POSTæ–¹å¼è®¿é—®http://localhost:8081/user/ï¼Œæ˜¾ç„¶æ˜¯å¤±è´¥çš„ï¼š

![](https://static001.geekbang.org/resource/image/a7/88/a71bcef74da7577aa1529bf2d9546588.png?wh=2552%2A978)

å› ä¸ºè¿™ä¸ªæ¥å£è¦æ±‚æœ‰å†™æƒé™ï¼š

```
@PreAuthorize("hasAuthority('WRITE')")
@PostMapping
public Object write(OAuth2Authentication authentication) {
```

æˆ‘ä»¬æ¢ä¸€ä¸ªå…·æœ‰è¯»å†™æƒé™çš„è®¿é—®ä»¤ç‰Œæ¥è¯•è¯•ï¼š

![](https://static001.geekbang.org/resource/image/a7/fc/a754a6fdcb9666e07f1b820052a4e2fc.png?wh=2550%2A1230)

å¯ä»¥å‘ç°ï¼Œæœç„¶è®¿é—®æˆåŠŸäº†ã€‚è¿™é‡Œè¾“å‡ºçš„å†…å®¹æ˜¯Tokenä¸­çš„userDetailsé¢å¤–ä¿¡æ¯ï¼Œè¯´æ˜èµ„æºæœåŠ¡å™¨çš„æƒé™æ§åˆ¶æœ‰æ•ˆã€‚

## æ­å»ºå®¢æˆ·ç«¯ç¨‹åº

åœ¨ä¸Šé¢çš„æ¼”ç¤ºä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯Postmanï¼Œä¹Ÿå°±æ˜¯æ‰‹åŠ¨HTTPè¯·æ±‚çš„æ–¹å¼æ¥ç”³è¯·å’Œä½¿ç”¨Tokenã€‚æœ€åï¼Œæˆ‘ä»¬æ¥æ­å»ºä¸€ä¸ªOAuthå®¢æˆ·ç«¯ç¨‹åºè‡ªåŠ¨å®ç°è¿™ä¸ªè¿‡ç¨‹ã€‚

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns="http://maven.apache.org/POM/4.0.0"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">

    <parent>
        <artifactId>springsecurity101</artifactId>
        <groupId>me.josephzhu</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>

    <artifactId>springsecurity101-cloud-oauth2-client</artifactId>
    <modelVersion>4.0.0</modelVersion>

    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-oauth2</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>

    </dependencies>
</project>
```

é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š

```
server:
  port: 8083
  servlet:
    context-path: /ui
security:
  oauth2:
    client:
      clientId: userservice3
      clientSecret: 1234
      accessTokenUri: http://localhost:8080/oauth/token
      userAuthorizationUri: http://localhost:8080/oauth/authorize
      scope: FOO
    resource:
      jwt:
        key-value: |
          -----BEGIN PUBLIC KEY-----
          ***
          -----END PUBLIC KEY-----
spring:
  thymeleaf:
    cache: false

#logging:
#  level:
#    ROOT: DEBUG
```

å®¢æˆ·ç«¯é¡¹ç›®ç«¯å£8082ï¼Œå‡ ä¸ªéœ€è¦è¯´æ˜çš„åœ°æ–¹ï¼š

- æœ¬åœ°æµ‹è¯•çš„æ—¶å€™æœ‰ä¸€ä¸ªå‘ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦é…ç½®context-pathï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°å®¢æˆ·ç«¯å’ŒæˆæƒæœåŠ¡å™¨æœåŠ¡ç«¯Cookieå¹²æ‰°ï¼Œå¯¼è‡´CSRFé˜²å¾¡è§¦å‘çš„é—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜å‡ºç°åç¨‹åºæ²¡æœ‰ä»»ä½•é”™è¯¯æ—¥å¿—è¾“å‡ºï¼Œåªæœ‰å¼€å¯DEBUGæ¨¡å¼åæ‰èƒ½çœ‹åˆ°DEBUGæ—¥å¿—é‡Œæœ‰æç¤ºï¼Œå› æ­¤è¿™ä¸ªé—®é¢˜éå¸¸éš¾ä»¥æ’æŸ¥ã€‚è¯´å®è¯ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“Springä¸ºä»€ä¹ˆä¸æŠŠè¿™ä¸ªä¿¡æ¯ä½œä¸ºWARNçº§åˆ«çš„æ—¥å¿—è¾“å‡ºã€‚
- ä½œä¸ºOAuthå®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬éœ€è¦é…ç½®OAuthæœåŠ¡ç«¯è·å–Tokençš„åœ°å€ã€æˆæƒï¼ˆè·å–æˆæƒç ï¼‰çš„åœ°å€ï¼Œéœ€è¦é…ç½®å®¢æˆ·ç«¯çš„IDã€å¯†ç å’ŒæˆæƒèŒƒå›´ã€‚
- å› ä¸ºä½¿ç”¨çš„æ˜¯JWT Tokenï¼Œæˆ‘ä»¬éœ€è¦é…ç½®å…¬é’¥ï¼ˆå½“ç„¶ï¼Œå¦‚æœä¸åœ¨è¿™é‡Œç›´æ¥é…ç½®å…¬é’¥çš„è¯ï¼Œä¹Ÿå¯ä»¥é…ç½®ä»æˆæƒæœåŠ¡å™¨æœåŠ¡ç«¯è·å–å…¬é’¥ï¼‰ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹ç¼–ç äº†ã€‚

ç¬¬ä¸€æ­¥ï¼Œå®ç°MVCçš„é…ç½®ï¼š

```
@Configuration
@EnableWebMvc
public class WebMvcConfig implements WebMvcConfigurer {

    /**
     * é…ç½®RequestContextListenerç”¨äºå¯ç”¨session scopeçš„Bean
     * @return
     */
    @Bean
    public RequestContextListener requestContextListener() {
        return new RequestContextListener();
    }

    /**
     * é…ç½®indexè·¯å¾„çš„é¦–é¡µController
     * @param registry
     */
    @Override
    public void addViewControllers(ViewControllerRegistry registry) {
        registry.addViewController("/")
                .setViewName("forward:/index");
        registry.addViewController("/index");
    }
}
```

è¿™é‡Œåšäº†ä¸¤ä»¶äº‹æƒ…ï¼š

1. é…ç½®RequestContextListenerï¼Œç”¨äºå¯ç”¨session scopeçš„Beanï¼›
2. é…ç½®äº†indexè·¯å¾„çš„é¦–é¡µControllerã€‚

ç¬¬äºŒæ­¥ï¼Œå®ç°å®‰å…¨æ–¹é¢çš„é…ç½®ï¼š

```
@Configuration
@Order(200)
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
    /**
     * /è·¯å¾„å’Œ/loginè·¯å¾„å…è®¸è®¿é—®ï¼Œå…¶å®ƒè·¯å¾„éœ€è¦èº«ä»½è®¤è¯åæ‰èƒ½è®¿é—®
     * @param http
     * @throws Exception
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .authorizeRequests()
                .antMatchers("/", "/login**")
                .permitAll()
                .anyRequest()
                .authenticated();
    }
}
```

è¿™é‡Œæˆ‘ä»¬å®ç°çš„æ˜¯/è·¯å¾„å’Œ/loginè·¯å¾„å…è®¸è®¿é—®ï¼Œå…¶å®ƒè·¯å¾„éœ€è¦èº«ä»½è®¤è¯åæ‰èƒ½è®¿é—®ã€‚

ç¬¬ä¸‰æ­¥ï¼Œæˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªæ§åˆ¶å™¨ï¼š

```
@RestController
public class DemoController {
    @Autowired
    OAuth2RestTemplate restTemplate;
    //æ¼”ç¤ºç™»å½•åæ‰èƒ½è®¿é—®çš„å®‰å…¨é¡µé¢
    @GetMapping("/securedPage")
    public ModelAndView securedPage(OAuth2Authentication authentication) {
        return new ModelAndView("securedPage").addObject("authentication", authentication);
    }
    //æ¼”ç¤ºé€šè¿‡OAuth2RestTemplateè°ƒç”¨å—ä¿æŠ¤èµ„æº
    @GetMapping("/remoteCall")
    public String remoteCall() {
        ResponseEntity<String> responseEntity = restTemplate.getForEntity("http://localhost:8081/user/name", String.class);
        return responseEntity.getBody();
    }
}
```

è¿™é‡Œæˆ‘ä»¬å®ç°äº†ä¸¤ä¸ªåŠŸèƒ½ï¼š

1. securedPageé¡µé¢ï¼Œå®ç°çš„åŠŸèƒ½æ˜¯ï¼ŒæŠŠç”¨æˆ·ä¿¡æ¯ä½œä¸ºæ¨¡å‹ä¼ å…¥äº†è§†å›¾ï¼Œè¿™æ ·æ‰“å¼€é¡µé¢åå°±èƒ½æ˜¾ç¤ºç”¨æˆ·åå’Œæƒé™ã€‚
2. remoteCallæ¥å£ï¼Œå®ç°çš„åŠŸèƒ½æ˜¯ï¼Œé€šè¿‡å¼•å…¥OAuth2RestTemplateï¼Œåœ¨ç™»å½•åå°±å¯ä»¥ä½¿ç”¨å‡­æ®ç›´æ¥ä»å—ä¿æŠ¤èµ„æºæœåŠ¡å™¨æ‹¿èµ„æºï¼Œä¸éœ€è¦ç¹çåœ°å®ç°è·å¾—è®¿é—®ä»¤ç‰Œã€åœ¨è¯·æ±‚å¤´é‡ŒåŠ å…¥è®¿é—®ä»¤ç‰Œçš„è¿‡ç¨‹ã€‚

ç¬¬å››æ­¥ï¼Œé…ç½®ä¸€ä¸‹åˆšæ‰ç”¨åˆ°çš„OAuth2RestTemplate Beanï¼Œå¹¶å¯ç”¨OAuth2SsoåŠŸèƒ½ï¼š

```
@Configuration
@EnableOAuth2Sso //è¿™ä¸ªæ³¨è§£åŒ…å«äº†@EnableOAuth2Client
public class OAuthClientConfig {
    /**
     * å®šä¹‰äº†OAuth2RestTemplateï¼Œç½‘ä¸Šä¸€äº›æ¯”è¾ƒè€çš„èµ„æ–™ç»™å‡ºçš„æ˜¯æ‰‹åŠ¨è¯»å–é…ç½®æ–‡ä»¶æ¥å®ç°ï¼Œæœ€æ–°ç‰ˆæœ¬å·²ç»å¯ä»¥è‡ªåŠ¨æ³¨å…¥OAuth2ProtectedResourceDetails
     * @param oAuth2ClientContext
     * @param details
     * @return
     */
    @Bean
    public OAuth2RestTemplate oauth2RestTemplate(OAuth2ClientContext oAuth2ClientContext,
                                                 OAuth2ProtectedResourceDetails details) {
        return new OAuth2RestTemplate(details, oAuth2ClientContext);
    }
}
```

ç¬¬äº”æ­¥ï¼Œå®ç°é¦–é¡µï¼š

```
<body>
<div class="container">
    <div class="col-sm-12">
        <h1>Spring Security SSO Client</h1>
        <a class="btn btn-primary" href="securedPage">Login</a>
    </div>
</div>
</body>
```

ä»¥åŠç™»å½•åæ‰èƒ½è®¿é—®çš„securedPageé¡µé¢ï¼š

```
<body>
<div class="container">
    <div class="col-sm-12">
        <h1>Secured Page</h1>
        Welcome, <span th:text="${authentication.name}">Name</span>
        <br/>
        Your authorities are <span th:text="${authentication.authorities}">authorities</span>
    </div>
</div>
</body>
```

## æ¼”ç¤ºå•ç‚¹ç™»å½•

å¥½ï¼Œå®¢æˆ·ç«¯ç¨‹åºæ­å»ºå¥½ä¹‹åï¼Œæˆ‘ä»¬å…ˆæ¥æµ‹è¯•ä¸€ä¸‹å•ç‚¹ç™»å½•çš„åŠŸèƒ½ã€‚å¯åŠ¨å®¢æˆ·ç«¯é¡¹ç›®ï¼Œæ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š

```
http://localhost:8082/ui/securedPage
```

å¯ä»¥çœ‹åˆ°ï¼Œé¡µé¢è‡ªåŠ¨è½¬åˆ°äº†æˆæƒæœåŠ¡å™¨ï¼ˆ8080ç«¯å£ï¼‰çš„ç™»å½•é¡µé¢ï¼š

![](https://static001.geekbang.org/resource/image/05/81/05b76f316304e3ef2d1494bae501c381.png?wh=2074%2A1370)

ç™»å½•åæ˜¾ç¤ºäº†å½“å‰ç”¨æˆ·åå’Œæƒé™ï¼š

![](https://static001.geekbang.org/resource/image/7d/37/7d24bc73267506c15f9feyy546557237.png?wh=1162%2A454)

æˆ‘ä»¬å†å¯åŠ¨å¦ä¸€ä¸ªå®¢æˆ·ç«¯ç½‘ç«™ï¼Œç«¯å£æ”¹ä¸º8083ï¼Œç„¶åè®¿é—®åŒæ ·çš„åœ°å€ï¼š

![](https://static001.geekbang.org/resource/image/7a/46/7a50619ace3e40c8ff7c0aa860f11246.png?wh=1038%2A396)

å¯ä»¥çœ‹åˆ°ç›´æ¥æ˜¯ç™»å½•çŠ¶æ€ï¼Œå•ç‚¹ç™»å½•æµ‹è¯•æˆåŠŸã€‚æ˜¯ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Ÿå…¶å®ï¼Œä¸ºäº†è¾¾æˆå•ç‚¹ç™»å½•çš„æ•ˆæœï¼Œç¨‹åºåœ¨èƒŒåè‡ªåŠ¨å®ç°äº†å¤šæ¬¡302é‡å®šå‘ï¼Œæ•´ä¸ªæµç¨‹ä¸ºï¼š

```
http://localhost:8083/ui/securedPage ->
http://localhost:8083/ui/login ->
http://localhost:8080/oauth/authorize?client_id=userservice3&redirect_uri=http://localhost:8083/ui/login&response_type=code&scope=FOO&state=Sobjqe ->
http://localhost:8083/ui/login?code=CDdvHa&state=Sobjqe ->
http://localhost:8083/ui/securedPage
```

## æ¼”ç¤ºå®¢æˆ·ç«¯è¯·æ±‚èµ„æºæœåŠ¡å™¨èµ„æº

è¿˜è®°å¾—å—ï¼Œåœ¨ä¸Šä¸€èŠ‚â€œæ­å»ºå®¢æˆ·ç«¯ç¨‹åºâ€ä¸­ï¼Œæˆ‘ä»¬è¿˜å®šä¹‰äº†ä¸€ä¸ªremoteCallæ¥å£ï¼Œç›´æ¥ä½¿ç”¨OAuth2RestTemplateæ¥è®¿é—®è¿œç¨‹èµ„æºæœåŠ¡å™¨çš„èµ„æºã€‚ç°åœ¨ï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹è¿™ä¸ªæ¥å£æ˜¯å¦å¯ä»¥å®ç°è‡ªåŠ¨çš„OAuthæµç¨‹ã€‚è®¿é—®ï¼š

```
http://localhost:8082/ui/remoteCall
```

ä¼šå…ˆè½¬åˆ°æˆæƒæœåŠ¡å™¨ç™»å½•ï¼Œç™»å½•åè‡ªåŠ¨è·³è½¬å›æ¥ï¼š

![](https://static001.geekbang.org/resource/image/01/27/016f28b7161d2c600197aa2392b0de27.png?wh=832%2A220)

å¯ä»¥çœ‹åˆ°è¾“å‡ºäº†ç”¨æˆ·åï¼Œå¯¹åº”çš„èµ„æºæœåŠ¡å™¨æœåŠ¡ç«¯æ¥å£æ˜¯ï¼š

```
@PreAuthorize("hasAuthority('READ') or hasAuthority('WRITE')")
@GetMapping("name")
public String name(OAuth2Authentication authentication) {
    return authentication.getName();
}
```

æ¢ä¸€ä¸ªwriterç”¨æˆ·ç™»å½•è¯•è¯•ï¼Œä¹Ÿèƒ½å¾—åˆ°æ­£ç¡®çš„è¾“å‡ºï¼š

![](https://static001.geekbang.org/resource/image/yy/84/yy2bca66c45cefa56d2d727c3a136a84.png?wh=910%2A214)

## æ€»ç»“

ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬å®Œæ•´æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨Spring Cloudçš„OAuth 2.0ç»„ä»¶åŸºäºä¸‰ä¸ªç¨‹åºè§’è‰²ï¼ˆæˆæƒæœåŠ¡å™¨ã€å—ä¿æŠ¤èµ„æºæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ï¼‰å®ç°ä¸‰ç§OAuth 2.0çš„æˆæƒè®¸å¯ç±»å‹ï¼ˆèµ„æºæ‹¥æœ‰è€…å‡­æ®è®¸å¯ã€å®¢æˆ·ç«¯å‡­æ®è®¸å¯å’Œæˆæƒç è®¸å¯ï¼‰ã€‚

æˆ‘ä»¬å…ˆæ¼”ç¤ºäº†ä¸‰ç§æˆæƒè®¸å¯ç±»å‹çš„æ‰‹åŠ¨æµç¨‹ï¼Œç„¶åä¹Ÿæ¼”ç¤ºäº†å¦‚ä½•å®ç°æƒé™æ§åˆ¶å’Œå•ç‚¹ç™»å½•ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨å®¢æˆ·ç«¯ç¨‹åºæ¥å®ç°è‡ªåŠ¨çš„OAuth 2.0æµç¨‹ã€‚

æˆ‘æŠŠä»Šå¤©ç”¨åˆ°çš„æ‰€æœ‰ä»£ç éƒ½æ”¾åˆ°äº†GitHubä¸Šï¼Œä½ å¯ä»¥ç‚¹å‡»[è¿™ä¸ªé“¾æ¥](https://github.com/JosephZhu1983/SpringSecurity101)æŸ¥çœ‹ã€‚

æœ€åï¼Œæˆ‘å†æä¸€ä¸‹ï¼Œå°†æ¥Springå¯¹äºOAuth 2.0çš„æ”¯æŒå¯èƒ½ä¼šè½¬ç§»åˆ°[ç”±ç¤¾åŒºæ¨è¿›çš„Spring Authorization Serveré¡¹ç›®ä¸Šæ¥ç»§ç»­è¿ä½œ](https://spring.io/blog/2020/04/15/announcing-the-spring-authorization-server)ã€‚å¦‚æœä½ æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥åŠæ—¶å…³æ³¨è¿™ä¸ªé¡¹ç›®çš„è¿›å±•ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>benxiong</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>åˆ›å»ºè¡¨çš„æ—¶å€™æŠ¥é”™äº†ï¼š
CREATE TABLE `oauth_client_details` (
  `client_id` varchar(255) NOT NULL,
  `resource_ids` varchar(255) DEFAULT NULL,
  `client_secret` varchar(255) DEFAULT NULL,
  `scope` varchar(255) DEFAULT NULL,
  `authorized_grant_types` varchar(255) DEFAULT NULL,
  `web_server_redirect_uri` varchar(255) DEFAULT NULL,
  `authorities` varchar(255) DEFAULT NULL,
  `access_token_validity` int(11) DEFAULT NULL,
  `refresh_token_validity` int(11) DEFAULT NULL,
  `additional_information` varchar(255) DEFAULT NULL,
  `autoapprove` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`client_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
&gt; 1071 - Specified key was too long; max key length is 767 bytes
&gt; æ—¶é—´: 0s

ç½‘ä¸Šè¯´æ˜¯ mysql innodbå­˜å‚¨å¼•æ“ çš„ varchar ä¸»é”®åªæ”¯æŒä¸è¶…è¿‡767ä¸ªå­—èŠ‚ æˆ–è€… 768&#47;2=384ä¸ªåŒå­—èŠ‚ æˆ–è€…767&#47;3=255ä¸ªä¸‰å­—èŠ‚ æˆ–è€… 767&#47;4=191ä¸ªå››å­—èŠ‚çš„å­—æ®µï¼ŒGBKæ˜¯åŒå­—èŠ‚çš„ï¼ŒUTF8æ˜¯ä¸‰å­—èŠ‚çš„ï¼Œutf8mb4æ˜¯å››å­—èŠ‚çš„ï¼Œæˆ‘æŒ‰ç…§è¿™ä¸ªè¯´æ³•ï¼ŒæŠŠä¸»é”® client_id å­—æ®µé•¿åº¦æ”¹ä¸º VARCHAR(111)ï¼Œå°±åˆ›å»ºæˆåŠŸäº†ã€‚

ä½†æ˜¯æˆ‘æ˜¯å¾ˆä¿¡æœæœ±æ™”è€å¸ˆçš„ï¼Œä»–éå¸¸ä¸¥è°¨ï¼Œä»–è‚¯å®šæ˜¯æµ‹è¯•é€šè¿‡ä»¥åæ‰å‘è¡¨çš„æ–‡ç« ï¼Œæ‰€ä»¥æˆ‘è§‰å¾—åº”è¯¥è¿˜æœ‰åˆ«çš„åŸå› å¯¼è‡´ä»–å¯ä»¥åˆ›å»ºï¼Œè€Œæˆ‘å´æŠ¥é”™ã€‚

è¿™ä¸ªåŸå› æœŸå¾…è€å¸ˆå’Œåˆ«çš„å°ä¼™ä¼´å¸®å¿™è§£ç­”ã€‚</p>2020-09-10</li><br/><li><span>å¸ƒå‰å²›</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>csrfæ”»å‡»ä¸è®²å˜›ï¼Ÿ</p>2020-08-15</li><br/><li><span>Geek_fb74a8</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è¯·æ•™ä¸€ä¸‹è€å¸ˆï¼Œä½¿ç”¨jwtçš„è¯åº”è¯¥æ€ä¹ˆå¤„ç†è¿‡æœŸä»¥åŠç™»å‡ºç­‰å¤„ç†ï¼Ÿå¯å¦å°†jwtä»¤ç‰Œå­˜å…¥Redisï¼Ÿ</p>2020-08-06</li><br/><li><span>Tim Zhang</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æœ‰ä¸ªé—®é¢˜ï¼Œè¯·æŒ‡æ•™ï¼š
æˆ‘çš„éœ€æ±‚æ˜¯æƒ³å¼€å‘ä¸€ä¸ªç»Ÿä¸€è®¤è¯å¹³å°ï¼Œå…¬å¸å†…æ‰€æœ‰åº”ç”¨éœ€è¦è®¤è¯ï¼Œèµ„æºæƒé™ç®¡æ§çš„éƒ½èµ°è¿™ä¸ªåº”ç”¨

ç”¨æˆ·é¦–å…ˆè®¿é—®aåº”ç”¨çš„æŸä¸ªwebapi(å—ä¿æŠ¤åº”ç”¨)ï¼Œaåº”ç”¨å‘ç°tokenä¸å­˜åœ¨ï¼Œè·³è½¬åˆ°æˆ‘çš„ç»Ÿä¸€è®¤è¯æˆæƒä¸­å¿ƒçš„ç™»å½•ç•Œé¢ï¼Œé€‰æ‹©ä½¿ç”¨å¾®ä¿¡è¿›è¡Œè®¤è¯ï¼Œè®¤è¯æˆåŠŸåï¼Œæ ¹æ®æˆ‘çš„æ•°æ®åº“ä¸­çš„rbacè¡¨ï¼ŒæŸ¥è¯¢è¿™ä¸ªç”¨æˆ·åœ¨aåº”ç”¨çš„æƒé™ä¸è§’è‰²ï¼Œç”Ÿæˆtokenï¼Œå°†tokenè¿”å›ç»™å—ä¿æŠ¤èµ„æºçš„åº”ç”¨aï¼Œç„¶åaåº”ç”¨è¿›è¡ŒéªŒè¯ã€‚

æˆ‘çš„é—®é¢˜å¦‚ä¸‹ï¼š
1ã€é‚£äº›åˆ·æ–°accesstokenï¼Œrefrshtokenè¿‡æœŸçš„é‡æ–°è·³è½¬çš„é€»è¾‘ï¼Œæ˜¯å¦åªèƒ½å†™åœ¨ä¸åŒaã€bã€cã€dè¿™äº›å—ä¿æŠ¤èµ„æºåº”ç”¨çš„filteré€»è¾‘ä¸­

2ã€æ¯”å¦‚å…¬å¸æœ‰100ä¸ªåº”ç”¨éœ€è¦åšè®¤è¯æˆæƒï¼Œæ˜¯å¦è¿™äº›åº”ç”¨çš„(ç”¨æˆ·ï¼Œè§’è‰²ï¼Œèµ„æº)è¡¨ç»“æ„éƒ½ç»´æŠ¤åœ¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒæ‰€å¯¹åº”çš„dbä¸­ã€‚

3ã€æˆ‘çœ‹è€å¸ˆå¼•ç”¨äº†ç½‘å…³ï¼Œæ˜¯å¦ç½‘å…³å¯ä»¥åˆ‡é¢åšæ‰ç‚¹é€šç”¨é€»è¾‘

4ã€å—ä¿æŠ¤èµ„æºä¿æŠ¤çš„èµ„æº(webapi)ï¼Œå‡è®¾æ˜¯åŸºäºhttp restçš„spring mvcç¼–å†™çš„ï¼Œæ˜¯å¦å°±æ˜¯é‚£äº›control
lerä¸­çš„è·¯ç”±urlï¼Œåœ¨è¿™äº›urlä¹‹ä¸Šä½¿ç”¨åˆ‡é¢é€»è¾‘æ¥éªŒè¯tokenä¸­çš„èµ„æºæƒé™æ˜¯å¦ä¸å½“å‰è·¯ç”±åŒ¹é…ï¼ˆæ¯”å¦‚éªŒè¯httpæ–¹æ³•+urlè·¯å¾„ï¼‰

5ã€å—ä¿æŠ¤èµ„æºåº”ç”¨è‡ªå·±çš„æ•°æ®åº“ä¸­å‡è®¾å­˜æœ‰ç”¨æˆ·è¡¨ï¼Œæ˜¯å¦è¿˜è¦ä¸ç»Ÿä¸€è®¤è¯ä¸­çš„ç”¨æˆ·è¡¨è¿›è¡Œå®æ—¶å…³è”ï¼Œæ¯”å¦‚aåº”ç”¨çš„ç”¨æˆ·aaåˆ é™¤äº†ï¼Œè¿˜éœ€è¦å®æ—¶åˆ é™¤ç»Ÿä¸€è®¤è¯ä¸­çš„aaç”¨æˆ·åœ¨aåº”ç”¨ä¸­çš„æ•°æ®

é—®é¢˜è¾ƒå¤šï¼Œä¹±ï¼Œè¯·è€å¸ˆæŠ½ç©ºå›å¤ä¸‹ï¼Œè°¢è°¢äº†</p>2020-07-24</li><br/><li><span>è‹—</span> ğŸ‘ï¼ˆ10ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¯¼å‡ºå…¬é’¥è¯ä¹¦çš„å‘½ä»¤ï¼škeytool -list -rfc --keystore mytest.jks | openssl x509 -inform pem -pubkey</p>2021-05-11</li><br/><li><span>è€Œç«‹æ–‹</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>çˆ±äº†ï¼Œæˆ‘è¦å»æ‰‹æ’¸ä¸€éï¼ŒéªŒè¯ä¸€ä¸‹çœŸä¼ªã€‚å“ˆå“ˆ</p>2020-07-23</li><br/><li><span>Younger Ku</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>èƒ½æŠŠæºç å¸¦ç€çœ‹ä¸€éï¼Œå†æŠŠç»å¸¸éœ€è¦å®šåˆ¶åŒ–çš„åœ°æ–¹è®²ä¸€ä¸‹å°±å¥½äº†ã€‚æ— è®ºå¦‚ä½•åªåœç•™åœ¨demoä½¿ç”¨å±‚é¢æ€»æ„Ÿè§‰å¿ƒé‡Œä¸è¸å®ã€‚</p>2020-08-19</li><br/><li><span>è¡Œä¸€å–„</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p> ç”Ÿæˆjkså¯†é’¥åº“	ç”Ÿæˆ.jksæ–‡ä»¶
 keytool -genkey -alias tutorialspedia -keyalg RSA -keystore &quot;&#47;home&#47;yaoshenglu&#47;keytool&#47;tutorialspedia.jks&quot;
  keytool -genkey -alias jwt -keyalg RSA -keystore &quot;&#47;home&#47;yaoshenglu&#47;keytool&#47;jwt.jks&quot;

 å¯¼å‡ºå…¬å…±è¯ä¹¦ .ceræ–‡ä»¶
 keytool -export -alias tutorialspedia -file &quot;&#47;home&#47;yaoshenglu&#47;keytool&#47;tutorialspedia_public_cert.cer&quot; -keystore &quot;&#47;home&#47;yaoshenglu&#47;keytool&#47;tutorialspedia.jks&quot;
  keytool -export -alias jwt -file &quot;&#47;home&#47;yaoshenglu&#47;keytool&#47;public.cert&quot; -keystore &quot;&#47;home&#47;yaoshenglu&#47;keytool&#47;jwt.jks&quot;
 
 æŸ¥çœ‹å…¬é’¥
 keytool -list -rfc --keystore tutorialspedia.jks | openssl x509 -inform pem -pubkey
  keytool -list -rfc --keystore jwt.jks | openssl x509 -inform pem -pubkey</p>2022-08-05</li><br/><li><span>Geek_0d99c9</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>ä»£ç æœ‰ç‚¹é—®é¢˜.ç›´æ¥è®¿é—®8082&#47; è¿˜æ˜¯è¢«é‡å®šå‘åˆ°loginé¡µé¢.OAuth2ClientApplicationè¿™ä¸ªé‡Œé¢çš„EnableOAuth2Ssoæ³¨è§£ä¼šè¦†ç›–WebSecurityConfigé‡Œé¢çš„å…ç™»å½•é…ç½®.æ‰€ä»¥åº”è¯¥æŠŠä¸¤ä¸ªåˆå¹¶ä¸‹

package me.josephzhu.springsecurity101.cloud.auth.client;

import org.springframework.boot.autoconfigure.security.oauth2.client.EnableOAuth2Sso;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.annotation.Order;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.oauth2.client.OAuth2ClientContext;
import org.springframework.security.oauth2.client.OAuth2RestTemplate;
import org.springframework.security.oauth2.client.resource.OAuth2ProtectedResourceDetails;

@EnableOAuth2Sso
@Configuration
@Order(200)
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
    &#47;**
     * &#47;è·¯å¾„å’Œ&#47;loginè·¯å¾„å…è®¸è®¿é—®ï¼Œå…¶å®ƒè·¯å¾„éœ€è¦èº«ä»½è®¤è¯åæ‰èƒ½è®¿é—®
     *
     * @param http
     * @throws Exception
     *&#47;
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .authorizeRequests()
                .antMatchers(&quot;&#47;test&quot;,&quot;&#47;&quot;, &quot;&#47;login**&quot;,&quot;&#47;**&#47;test&quot;,&quot;&#47;ui&#47;test&quot;, &quot;&#47;logout&quot;)
                .permitAll()
                .anyRequest()
                .authenticated().and()
                .logout().logoutSuccessUrl(&quot;&#47;&quot;);;
    }

      @Bean
  public OAuth2RestTemplate oauth2RestTemplate(OAuth2ClientContext oAuth2ClientContext,
                                               OAuth2ProtectedResourceDetails details) {
  return new OAuth2RestTemplate(details, oAuth2ClientContext);
  }

}

</p>2020-12-18</li><br/><li><span>Anony</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å®¢æˆ·ç«¯ä½¿ç”¨äº†@EnableOAuth2Ssoï¼Œé‡Œé¢åŒ…å«è‡ªå·±çš„WebSecurityä¼šæ‹¦æˆªæ‰€æœ‰è¯·æ±‚ã€‚è€Œåè‡ªå·±å®šä¹‰çš„WebSecurityï¼ŒOrderæ˜¯200ï¼Œå®é™…ä¸Šæ˜¯ä¸èµ·ä½œç”¨çš„å§ï¼Œå³ä½¿è®©æŸäº›url permitAllï¼Œä¹Ÿä¼šç›´æ¥è·³è½¬åˆ°æˆæƒæœåŠ¡å™¨çš„ç™»å½•é¡µã€‚è¯·æ±‚éƒ½ä¼šç›´æ¥è¢«é å‰çš„EnableOAuth2Ssoé‡Œçš„è¿‡æ»¤é“¾å¤„ç† ã€‚</p>2020-12-02</li><br/><li><span>jiangb</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å®æ“äº†ä¸€éï¼Œè¿è¡ŒOKã€‚</p>2022-02-10</li><br/><li><span>å·¥èµ„ä¸äº¤ç¨</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>å¯¹äºssoçš„å®ç°è¿˜æ˜¯ä¸ç†è§£ã€‚çœ‹èµ·æ¥å…¨ç¨‹æ²¡æœ‰ç”¨åˆ°cookieï¼Œé‚£æˆæƒæœåŠ¡æ˜¯å¦‚ä½•çŸ¥é“æ¥è‡ªä¸¤ä¸ªåŸŸåçš„è¯·æ±‚æ˜¯åŒä¸€ä¸ªç”¨æˆ·ï¼Ÿ</p>2020-07-23</li><br/><li><span>BingoJ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ä¸€ç›´æŠ¥è¿™ä¸ªé”™ï¼Œ
ç”Ÿæˆjkså’Œå…¬é’¥çš„å‘½ä»¤å¦‚ä¸‹ï¼Œä¹Ÿä¸çŸ¥é“å“ªé‡Œä¸å¯¹
   keytool -genkeypair -alias jwt -keyalg RSA -keysize 2048 -validity 365 -keystore jwt.jks
    keytool -exportcert -alias jwt -file public.cert -keystore jwt.jks -rfc

Caused by: java.lang.IllegalStateException: For MAC signing you do not need to specify the verifier key separately, and if you do it must match the signing key
	at org.springframework.util.Assert.state(Assert.java:73) ~[spring-core-5.2.1.RELEASE.jar:5.2.1.RELEASE]
	at org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter.afterPropertiesSet(JwtAccessTokenConverter.java:318) ~[spring-security-oauth2-2.3.4.RELEASE.jar:na]
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1862) ~[spring-beans-5.2.1.RELEASE.jar:5.2.1.RELEASE]
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1799) ~[spring-beans-5.2.1.RELEASE.jar:5.2.1.RELEASE]
	... 53 common frames omitted
</p>2024-08-15</li><br/><li><span>Î¾ï¼</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å¯ä¸å¯ä»¥å‡ºä¸€æœŸåŠ é¤security6.0çš„ç‰ˆæœ¬å•Š</p>2024-06-19</li><br/><li><span>Geek_4b4d7b</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è€å¸ˆå¥½ï¼Œè¯·æ•™ä¸‹å•ç‚¹ç™»å½•ä¸ºå•¥ä¼šæœ‰http:&#47;&#47;localhost:8083&#47;ui&#47;loginçš„è®¿é—®åœ°å€ï¼Œç™»å½•é¡µé¢ä¸æ˜¯åœ¨è®¤è¯æœåŠ¡8080ä¸Šå—ï¼Ÿ</p>2022-03-26</li><br/>
</ul>