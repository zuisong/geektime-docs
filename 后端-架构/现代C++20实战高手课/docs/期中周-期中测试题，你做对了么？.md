ä½ å¥½ï¼Œæˆ‘æ˜¯å¢èª‰å£°ã€‚

ä¸ºäº†å¸®åŠ©ä½ å·©å›ºçŸ¥è¯†ï¼Œæå‡èƒ½åŠ›ï¼ŒæœŸä¸­å‘¨æˆ‘ç»™ä½ å‡ºäº†ä¸€é“å®æˆ˜é¢˜ç›®ï¼ŒåŸºäºè¯¾ç¨‹é‡Œçš„ä»£ç æ‰©å±•ç°æœ‰åç¨‹æ¡†æ¶ï¼Œå®ç°é«˜çº§ä»»åŠ¡è°ƒåº¦ã€‚é¢˜ç›®æè¿°ä½ å¯ä»¥é€šè¿‡[è¿™ä¸ªé“¾æ¥](https://time.geekbang.org/column/article/629373)å›é¡¾ã€‚

è¿™ä¸€è®²ï¼Œæˆ‘ä¼šæŠŠå‚è€ƒä»£ç å’Œè§£é¢˜æ€è·¯å…¬å¸ƒå‡ºæ¥ã€‚

## ç­”æ¡ˆè§£æ

æ—¢ç„¶è¦åœ¨ç°æœ‰ä»£ç ä¸Šå¢åŠ åŠŸèƒ½ï¼Œæˆ‘ä»¬å°±æœ‰å¿…è¦å…ˆç†Ÿæ‚‰åŸæœ‰æ¶æ„ï¼Œå†å†³å®šåœ¨å“ªä¸ªæ¨¡å—æˆ–å“ªä¸ªå±‚é¢ä¸Šè¿½åŠ åŠŸèƒ½ã€‚

é€šè¿‡åˆ†æï¼Œå¯ä»¥å‘ç°ä»»åŠ¡çš„æ‰§è¡Œä¸è°ƒåº¦æ˜¯é€šè¿‡asyncpp.taskæ¨¡å—å®ç°çš„ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬åˆæ˜¯åœ¨ä¸ºç°æœ‰æ¡†æ¶æä¾›é«˜ä¼˜å…ˆçº§è°ƒåº¦çš„èƒ½åŠ›ã€‚å› æ­¤ï¼Œæ–°å¢çš„æ¨¡å—åº”è¯¥æ˜¯ä¾›asyncpp.taskä½¿ç”¨çš„ã€‚

åŸºäºè¿™æ ·çš„è€ƒè™‘ï¼Œæˆ‘ä»¬åœ¨åŸæœ‰çš„æ¶æ„åŸºç¡€ä¸Šï¼Œè¿½åŠ äº†ä¸€ä¸ªhigh performanceï¼ˆasyncpp.hpï¼‰æ¨¡å—ï¼Œä¾›asyncpp.taskæ¨¡å—å®ç°é«˜æ€§èƒ½çš„çº¿ç¨‹è°ƒåº¦ã€‚è¡¥å……åçš„æ¶æ„å›¾æ˜¯åé¢è¿™æ ·ã€‚

![](https://static001.geekbang.org/resource/image/4e/95/4e0fbf132067b48443fa86edc915e195.jpg?wh=2900x1980)

ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œasyncpp.taskæ¨¡å—å¼•ç”¨äº†asyncpp.hpæ¨¡å—ã€‚æ–°çš„æ¨¡å—æä¾›äº†é«˜ä¼˜å…ˆçº§çº¿ç¨‹è°ƒåº¦å’Œç®¡ç†çš„èƒ½åŠ›ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“å®ç°ã€‚é¦–å…ˆæ˜¯:taskå­æ¨¡å—ã€‚

```c++
export module asyncpp.hp:task;

import asyncpp.core;
import <functional>;
import <vector>;
import <mutex>;

namespace asyncpp::hp {

export struct AsyncHpTask {
Â  Â  using ResumeHandler = std::function<void()>;
Â  Â  using TaskHandler = std::function<void()>;

Â  Â  // åç¨‹å”¤é†’å‡½æ•°
Â  Â  ResumeHandler resumeHandler;
Â  Â  // è®¡ç®—ä»»åŠ¡å‡½æ•°
Â  Â  TaskHandler taskHandler;
};

export class AsyncHpTaskQueue {
public:
Â  Â  static AsyncHpTaskQueue& getInstance();

Â  Â  void enqueue(const AsyncHpTask& item) {
Â  Â  Â  Â  std::lock_guard<std::mutex> guard(_queueMutex);

Â  Â  Â  Â  _queue.push_back(item);
Â  Â  }

Â  Â  bool dequeue(AsyncHpTask* item) {
Â  Â  Â  Â  std::lock_guard<std::mutex> guard(_queueMutex);

Â  Â  Â  Â  if (_queue.size() == 0) {
Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  }

Â  Â  Â  Â  *item = _queue.back();
Â  Â  Â  Â  _queue.pop_back();

Â  Â  Â  Â  return true;
Â  Â  }

Â  Â  size_t getSize() const {
Â  Â  Â  Â  return _queue.size();
Â  Â  }

private:
Â  Â  // é«˜æ€§èƒ½è®¡ç®—ä»»åŠ¡é˜Ÿåˆ—
Â  Â  std::vector<AsyncHpTask> _queue;
Â  Â  // é«˜æ€§èƒ½è®¡ç®—ä»»åŠ¡é˜Ÿåˆ—äº’æ–¥é”ï¼Œç”¨äºå®ç°çº¿ç¨‹åŒæ­¥ï¼Œç¡®ä¿é˜Ÿåˆ—æ“ä½œçš„çº¿ç¨‹å®‰å…¨
Â  Â  std::mutex _queueMutex;
};

AsyncHpTaskQueue& AsyncHpTaskQueue::getInstance() {
Â  Â  static AsyncHpTaskQueue queue;

Â  Â  return queue;
}

}
```
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ1ï¼‰</strong></div><ul>
<li><img src="https://static001.geekbang.org/account/avatar/00/29/5c/c9/f1b053f2.jpg" width="30px"><span>Family mission</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æ„Ÿè§‰asyncpp.task:asyncify æ¨¡å—ä¸­36è¡Œä½¿ç”¨å•ä¾‹æ¨¡å¼æ„é€ AsyncHpTaskQueueè€Œä¸æ˜¯AsyncTaskQueue::getInstance()ï¼Œå†™é”™äº†å§</div>2023-12-12</li><br/>
</ul>