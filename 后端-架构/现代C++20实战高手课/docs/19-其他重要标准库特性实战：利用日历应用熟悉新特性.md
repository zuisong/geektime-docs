ä½ å¥½ï¼Œæˆ‘æ˜¯å¢èª‰å£°ã€‚

æˆ‘ä»¬æƒ³è¦æå‡C++çš„ç¼–ç¨‹æ•ˆç‡ï¼Œå°±éœ€è¦å¯¹é‡è¦æ ‡å‡†åº“çš„å˜æ›´ä¿æŒå…³æ³¨ã€‚åœ¨ç¬¬18è®²å·²ç»æ¶µç›–äº†ç»å¤§å¤šæ•°C++20å¸¦æ¥çš„é‡è¦åº“å˜æ›´ã€‚ä¸è¿‡ï¼Œæˆ‘å½“æ—¶æœ‰æ„å¿½ç•¥äº†å…¶ä¸­ä¸€ä¸ªï¼Œå°±æ˜¯æˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’â€”â€”C++20 Calendarã€Timzoneã€‚

å®ƒä»¬æ˜¯å¯¹ç°æœ‰chronoåº“çš„é‡è¦è¡¥å……ã€‚Calendaræä¾›äº†æ—¥å†çš„è¡¨ç¤ºä¸è®¡ç®—å·¥å…·ã€‚è€ŒTimezoneæä¾›äº†æ ‡å‡†çš„æ—¶åŒºå®šä¹‰ï¼Œå¯ä»¥æ„å»ºåŒ…å«æ—¶åŒºä¿¡æ¯çš„zoned\_timeã€‚

ä»Šå¤©ï¼Œæˆ‘ä¼šå›´ç»•C++20 Calendarã€Timzoneå¸¦ä½ è¿›è¡Œç¼–ç¨‹å®æˆ˜ï¼Œå¹¶ç»“åˆä¸Šä¸€è®²æ¶µç›–çš„ç‰¹æ€§ï¼šjthreadã€source locationã€sync streamå’Œu8stringï¼Œå®ç°ä¸€ä¸ªä½¿ç”¨æ–°æ ‡å‡†å®ç°çš„æ—¥å†ç¨‹åºã€‚

å“¦ï¼Œå¯¹äº†ï¼Œæˆ‘ä»¬è¿˜ä¼šåœ¨è¿™ä¸€è®²ä¸­ä½¿ç”¨C++ 20 Formattingåº“ï¼Œå¸®ä½ è¿›ä¸€æ­¥åŠ æ·±å¯¹è¿™ä¸ªç‰¹æ€§çš„ç†è§£ã€‚å¥½ï¼Œè¯ä¸å¤šè¯´ï¼Œå°±è®©æˆ‘ä»¬ä»æ¨¡å—è®¾è®¡å¼€å§‹ä»Šå¤©çš„å†…å®¹ï¼ˆè¯¾ç¨‹é…å¥—ä»£ç å¯ä»¥ä»[è¿™é‡Œ](https://github.com/samblg/cpp20-plus-indepth)è·å–ï¼‰ã€‚

## æ¨¡å—è®¾è®¡

æˆ‘ä»¬å‡†å¤‡æ„å»ºçš„å‘½ä»¤è¡Œæ—¥å†åº”ç”¨ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹æ€§ã€‚

- ä½¿ç”¨C++20 chronoï¼šæ”¯æŒæ˜¾ç¤ºæœ¬æœˆæ—¥å†ï¼Œæ˜¾ç¤ºæ—¥æœŸå’Œæ˜ŸæœŸä¿¡æ¯ã€‚
- ä½¿ç”¨u8stringï¼šæ”¯æŒå¯¼å‡ºæœ¬å¹´çš„å…¨å¹´æ—¥å†åˆ°æ–‡æœ¬æ–‡ä»¶ï¼Œç¼–ç ä¸ºUTF-8ã€‚

æˆ‘ä»¬ä¾ç„¶é‡‡ç”¨ä¼ ç»ŸC++æ¨¡å—ç»“æ„è®¾è®¡ï¼Œæ•´ä½“æ¨¡å—è®¾è®¡å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚  
![](https://static001.geekbang.org/resource/image/78/25/78e7e0c75ed186253b7d5cbb3a60db25.jpg?wh=2900x1682)

è¯¥å·¥ç¨‹åŒ…å«ä¸¤ä¸ªå­é¡¹ç›®ï¼Œä¸€ä¸ªæ˜¯å¯æ‰§è¡Œæ–‡ä»¶calendarppï¼Œå¦ä¸€ä¸ªæ˜¯é™æ€é“¾æ¥åº“loggingã€‚ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œcalendarppçš„å…¥å£æ˜¯main.cppï¼Œå…¶ä»–å®ç°éƒ½åœ¨calendarppæ¨¡å—ä¸‹ï¼ŒåŒ…æ‹¬åé¢è¿™å‡ ä¸ªæ¨¡å—ã€‚

- menuï¼šä¸»èœå•å®ç°ï¼ŒåŒ…æ‹¬èœå•å®šä¹‰ä¸èœå•äº¤äº’ã€‚
- actionsï¼šå„ä¸ªèœå•é¡¹çš„å…·ä½“å®ç°ï¼Œå®Œæˆå…·ä½“çš„åŠŸèƒ½ã€‚
- utilsï¼šå…·ä½“çš„åº•å±‚å®ç°æ¨¡å—ï¼ŒåŒ…æ‹¬æ—¥å†è®¡ç®—æ¨¡å—calendarã€æ–‡æœ¬æ¸²æŸ“æ¨¡å—renderå’Œè¾“å…¥è¾“å‡ºæ¨¡å—ioã€‚

æˆ‘ä»¬æ²¿ç”¨äº†[ç¬¬15è®²](https://time.geekbang.org/column/article/631248)ä¸­çš„å®ç°ï¼Œå³æ—¥å¿—æ¡†æ¶æ¥æ„å»ºå¹¶åŒ…è£…æˆäº†loggingåº“ï¼Œå¹¶åˆ©ç”¨ç¬¬18è®²ä¸­è®²è¿‡çš„éƒ¨åˆ†ç‰¹æ€§è¿›è¡Œäº†æ”¹é€ ã€‚æ²¿ç€è¿™æ¡è·¯çº¿ï¼Œæˆ‘ä»¬å…ˆä»æ”¹é€ æ—¥å¿—æ¡†æ¶å¼€å§‹çœ‹ã€‚

## æ”¹é€ æ—¥å¿—æ¡†æ¶

æ—¥å¿—æ¡†æ¶çš„æ‰€æœ‰ä»£ç æ–‡ä»¶éƒ½åœ¨projects/loggingä¸‹ï¼Œä½ å¯ä»¥ç»“åˆä»£ç æ¥ç†è§£å¦‚ä½•é›†æˆæ—¥å¿—æ¡†æ¶ï¼Œå¹¶ç”¨å®ƒæ¥è®°å½•ç³»ç»Ÿè¿è¡Œæ—¥å¿—ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œä½¿ç”¨C++20çš„ç‰¹æ€§ï¼Œå¯ä»¥åœ¨åŸæœ‰çš„æ¡†æ¶åŸºç¡€ä¸Šåšå‡ºå“ªäº›æ”¹é€ ã€‚

ä¹‹å‰çš„Handleråœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹ä½¿ç”¨æ—¶ï¼Œå› ä¸ºæ²¡æœ‰é‡‡ç”¨çº¿ç¨‹åŒæ­¥æ–¹æ¡ˆï¼Œå¯¼è‡´è¾“å‡ºæ—¶å¯èƒ½ä¼šäº§ç”Ÿé”™ä¹±çš„é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬æ”¹é€ äº†Handlerã€‚

æ¯”å¦‚DefaultHandlerçš„å®ç°æ”¹é€ æ˜¯åé¢è¿™æ ·ã€‚

```c++
#pragma once
Â 
#include "logging/Handler.h"
#include <syncstream>
Â 
namespace logging::handlers {
Â Â Â  // é»˜è®¤æ—¥å¿—å¤„ç†å™¨
Â Â Â  template <Level HandlerLevel = Level::Warning>
Â Â Â  // ç»§æ‰¿BaseHandler
Â Â Â  class DefaultHandler : public BaseHandler<HandlerLevel> {
Â Â Â  public:
Â Â Â Â Â Â Â  // æ„é€ å‡½æ•°ï¼Œéœ€è¦æŒ‡å®šæ ¼å¼åŒ–å™¨ï¼Œé»˜è®¤æ ¼å¼åŒ–å™¨ä¸ºdefaultFormatter
Â Â Â Â Â Â Â  DefaultHandler(Formatter formatter = defaultFormatter) : BaseHandler<HandlerLevel>(formatter) {}
Â Â Â Â Â Â Â  // ç¦æ­¢æ‹·è´æ„é€ å‡½æ•°
Â Â Â Â Â Â Â  DefaultHandler(const DefaultHandler&) = delete;
Â Â Â Â Â Â Â  // å®šä¹‰ç§»åŠ¨æ„é€ å‡½æ•°
Â Â Â Â Â Â Â  DefaultHandler(const DefaultHandler&& rhs) noexcept : BaseHandler<HandlerLevel>(rhs.getForamtter()) {}
Â 
Â Â Â Â Â Â Â  // emitç”¨äºæäº¤æ—¥å¿—è®°å½•
Â Â Â Â Â Â Â  // emitLevel > HandlerLevelçš„æ—¥å¿—ä¼šè¢«ä¸¢å¼ƒ
Â Â Â Â Â Â Â  template <Level emitLevel>
Â Â Â Â Â Â Â Â Â Â Â  requires (emitLevel > HandlerLevel)
Â Â Â Â Â Â Â  void emit(const Record& record) {
Â Â Â Â Â Â Â  }
Â 
Â Â Â Â Â Â Â  // emitLevel <= HandlerLevelçš„æ—¥å¿—ä¼šè¢«è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºæµä¸­
Â Â Â Â Â Â Â  template <Level emitLevel>
Â Â Â Â Â Â Â Â Â Â Â  requires (emitLevel <= HandlerLevel)
Â Â Â Â Â Â Â  void emit(const Record& record) {
Â Â Â Â Â Â Â Â Â Â Â  // è°ƒç”¨formatå°†æ—¥å¿—è®°å½•å¯¹è±¡æ ¼å¼åŒ–æˆæ–‡æœ¬å­—ç¬¦ä¸²
Â Â Â Â Â Â Â Â Â Â Â  std::osyncstream(std::cout) << this->format(record) << std::endl;
Â Â Â Â Â Â Â  }
Â Â Â  };
}
```

ä»£ç ä¸­çš„æ”¹åŠ¨åœ¨ç¬¬31è¡Œï¼Œé€šè¿‡ **std::osyncstream** åŒ…è£…äº†std::coutï¼Œç„¶åé€šè¿‡åŒ…è£…åçš„è¾“å‡ºæµè¿›è¡Œè¾“å‡ºï¼Œè¿™æ ·å°±èƒ½å®Œæˆè¾“å‡ºçš„çº¿ç¨‹åŒæ­¥æ§åˆ¶ï¼ˆè¯¦ç»†è®²è§£ï¼Œä½ å¯ä»¥å›é¡¾ä¸Šä¸€è®² â€œsync streamâ€ è¿™éƒ¨åˆ†ï¼‰ã€‚

æ—¥å¿—æ¡†æ¶çš„ç¬¬äºŒä¸ªæ”¹åŠ¨åœ¨äºï¼Œå®ƒé€šè¿‡source locationè®°å½•äº†è¾“å‡ºæ—¥å¿—çš„æºä»£ç ä½ç½®ä¿¡æ¯ã€‚å®ç°åœ¨Record.hä¸‹ï¼Œåé¢å±•ç¤ºçš„æ˜¯é‡ç‚¹ä»£ç ã€‚

```c++
class Record {
public:
Â Â Â  // Loggeråç§°
Â Â Â  std::string name;
Â Â Â  // æ—¥å¿—ç­‰çº§
Â Â Â  Level level;
Â Â Â  // æ—¥å¿—æ—¶é—´
Â Â Â  TimePoint time;
Â Â Â  // æ—¥å¿—æ¶ˆæ¯
Â Â Â  std::string message;
Â Â Â  std::source_location sourceLocation;

Â Â Â  // getLevelNameï¼šè·å–æ—¥å¿—ç­‰çº§æ–‡æœ¬
Â Â Â  const std::string& getLevelName() const {
Â Â Â Â Â Â Â  // è°ƒç”¨toLevelNameè·å–æ—¥å¿—ç­‰çº§æ–‡æœ¬
Â Â Â Â Â Â Â  return toLevelName(level);
Â Â Â  }
};
```

é€šè¿‡ä»£ç å¯ä»¥çœ‹åˆ°ï¼ŒRecordå®šä¹‰å¢åŠ äº†sourceLocationç”¨äºè®°å½•æºä»£ç ä½ç½®ã€‚

æ¥ç€ï¼Œæˆ‘ä»¬è¿˜è¦ä¿®æ”¹Loggerå®šä¹‰ï¼Œå¢åŠ è®°å½•æºä»£ç ä½ç½®ä¿¡æ¯çš„åŠŸèƒ½ã€‚å…·ä½“å®ç°åœ¨Logger.hä¸‹ï¼Œæˆ‘ä»¬å°†logçš„å®šä¹‰æ”¹ä¸ºä»¥ä¸‹å½¢å¼ã€‚

```c++
template <Level level>
Â Â Â  requires (level > loggerLevel)
Logger& log(const std::string& message, std::source_location sourceLocation = std::source_location::current()) {
Â Â Â  return *this;
}

// é€šè¿‡requiresçº¦æŸæäº¤ç­‰çº§ä¸ºæ—¥å¿—è®°å½•å™¨è®¾å®šç­‰çº§åŠä»¥ä¸Šçš„æ—¥å¿—
template <Level level>
Â Â Â  requires (level <= loggerLevel)
Logger & log(const std::string& message, std::source_location sourceLocation = std::source_location::current()) {
Â Â Â  // æ„é€ Recordå¯¹è±¡
Â Â Â  Record record{
Â Â Â Â Â  Â Â .name = _name,
Â Â Â Â Â Â Â  .level = level,
Â Â Â Â Â Â Â  .time = std::chrono::system_clock::now(),
Â Â Â Â Â Â Â  .message = message,
Â Â Â Â Â Â Â  // è®°å½•æºä»£ç ä½ç½®
Â Â Â Â Â Â Â  .sourceLocation = sourceLocation
Â Â Â  };

Â Â Â  // è°ƒç”¨handleLogå®é™…å¤„ç†æ—¥å¿—è¾“å‡º
Â Â Â  handleLog<level, HandlerCount - 1>(record);

Â Â Â  return *this;
}
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘å¢åŠ äº†source\_locationå®šä¹‰ï¼Œå¹¶é€šè¿‡é»˜è®¤å‚æ•°è‡ªåŠ¨è®°å½•è°ƒç”¨è€…çš„æ‰€åœ¨ä½ç½®ï¼Œè°ƒç”¨è€…ä¹Ÿå¯ä»¥è‡ªå·±æŒ‡å®šéœ€è¦è®°å½•çš„source\_locationã€‚

æˆ‘ä»¬åŒæ—¶**ä¿®æ”¹äº†å‡ ä¸ªçº§åˆ«çš„ç›¸å…³æ¥å£**ï¼Œæ¯”å¦‚debugæˆå‘˜å‡½æ•°æ”¹é€ ã€‚

```c++
// æäº¤è°ƒè¯•ä¿¡æ¯ï¼ˆlogçš„åŒ…è£…ï¼‰
Logger& debug(const std::string& message, std::source_location sourceLocation = std::source_location::current()) {
Â Â Â  return log<Level::Debug>(message, sourceLocation);
}
```

å…¶ä»–çš„å‡ ä¸ªæˆå‘˜å‡½æ•°éƒ½å’Œdebugä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸å±•ç¤ºå‡ºæ¥äº†ã€‚

æœ€åï¼Œæˆ‘è¿˜ä¿®æ”¹äº†formatå‡½æ•°è¾“å‡ºsourceLocationä¸­çš„ä¿¡æ¯ã€‚å…·ä½“å®ç°ï¼Œæˆ‘ä»¬ä»¥ModernFormatter.cppçš„ä¿®æ”¹ä¸ºä¾‹æ¥çœ‹çœ‹ã€‚

```c++
#include "logging/formatters/ModernFormatter.h"
#include "logging/Record.h"
Â 
namespace logging::formatters::modern {
Â Â Â  // formatRecordï¼šå°†Recordå¯¹è±¡æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²
Â Â Â  std::string formatRecord(const Record& record) {
Â Â Â Â Â Â Â  const auto& sourceLocation = record.sourceLocation;
Â 
Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â  return std::format(
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  "{0:<16}| [{1}] {2:%Y-%m-%d}T{2:%H:%M:%OS}Z - <{3}:{4} [{5}]> - {6}",
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  record.name,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  record.getLevelName(),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  record.time,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sourceLocation.file_name(),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sourceLocation.line(),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sourceLocation.function_name(),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  record.message
Â Â Â Â Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  catch (std::exception& e) {
Â Â Â Â Â Â Â Â Â Â Â  std::cerr << "Error in format: " << e.what() << std::endl;
Â 
Â Â Â Â Â Â Â Â Â Â Â  return "";
Â Â Â Â Â Â Â  }
Â Â Â  }
}
```

ä»£ç ä¸­formatçš„éƒ¨åˆ†åŠ å…¥äº†sourceLocationä¿¡æ¯ï¼Œå…¶ä»–éƒ¨åˆ†ç›¸è¾ƒäºä¹‹å‰åˆ™æ²¡æœ‰å˜åŒ–ã€‚

## ä¸»ç¨‹åºä¸èœå•

åœ¨äº†è§£äº†æ—¥å¿—æ¡†æ¶çš„æ”¹é€ åï¼Œæˆ‘ä»¬ç»§ç»­çœ‹å¦‚ä½•é€šè¿‡C++20 Formattingåº“å®ç°ä¸»ç¨‹åºå’Œèœå•ã€‚

ä¸»ç¨‹åºå®šä¹‰éå¸¸ç®€å•ï¼Œåœ¨main.cppä¸­ï¼Œä»£ç æ˜¯åé¢è¿™æ ·ã€‚

```c++
#include "menu/Menu.h"
#include <iostream>
#include <format>
Â 
int main() {
Â Â Â  while (true) {
Â Â Â Â Â Â Â  // å±•ç¤ºèœå•
Â Â Â Â Â Â Â  calendarpp::menu::showMenu();
Â Â Â Â Â Â Â  // è¯»å–å¹¶æ‰§è¡Œèœå•é¡¹
Â Â Â Â Â Â Â  calendarpp::menu::readAction();
Â Â Â  }
Â 
Â Â Â  return 0;
}
```

ä»£ç æ•´ä½“æ˜¯ä¸€ä¸ªwhileå¾ªç¯ï¼Œé¦–å…ˆå±•ç¤ºèœå•ï¼Œç„¶åè¯»å–ç”¨æˆ·è¾“å…¥å¹¶æ‰§è¡Œèœå•é¡¹ã€‚æ‰€ä»¥åªæœ‰ç”¨æˆ·é€‰æ‹©é€€å‡ºç¨‹åºæ—¶ï¼Œæ•´ä¸ªç¨‹åºæ‰ä¼šé€€å‡ºã€‚

èœå•å®ç°åœ¨menu/Menu.cppä¸­ï¼Œä»£ç æ˜¯åé¢è¿™æ ·ã€‚

```c++
#include "menu/Menu.h"
#include "actions/ShowAction.h"
#include "actions/ExportAction.h"
#include "actions/ExitAction.h"
#include "utils/RenderUtils.h"
Â 
#include <iostream>
#include <string>
#include <vector>
#include <cstdint>
#include <format>
#include <algorithm>
Â 
namespace calendarpp::menu {
Â Â Â  // èœå•é¡¹ç±»å‹
Â Â Â  struct MenuItem {
Â Â Â Â Â Â Â  std::string title;
Â Â Â Â Â Â Â  Action action;
Â Â Â  };
Â 
Â Â Â  // æ‰€æœ‰èœå•
Â Â Â  static const std::vector<MenuItem> MenuItems = {
Â Â Â Â Â Â Â  std::vector<MenuItem> {
Â Â Â Â Â Â Â Â Â Â Â  {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  .title = "å±•ç¤ºæœ¬æœˆæ—¥å†",
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  .action = actions::showCurrentMonth
Â Â Â Â Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â Â Â Â Â  {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  .title = "å¯¼å‡ºæœ¬å¹´æ—¥å†",
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  .action = actions::exportCurrentYear
Â Â Â Â Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â Â Â Â Â  {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  .title = "é€€å‡ºç¨‹åº",
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  .action = actions::exitApp
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }
Â Â Â  };
Â 
Â Â Â  // èœå•é€‰é¡¹èŒƒå›´
Â Â Â  static const int32_t MinActionNumber = 1;
Â Â Â  static const int32_t MaxActionNumber = MenuItems.size();
Â 
Â Â Â  // å±•ç¤ºèœå•
Â Â Â  void showMenu() {
Â Â Â Â Â Â Â  // è¾“å‡ºç³»ç»Ÿæ ‡é¢˜
Â Â Â Â Â Â Â  std::cout << std::format("\n{:=^80}\n", " Calendar++ v1.0 ") << std::endl;
Â Â Â Â Â Â Â  // è¾“å‡ºå½“å‰æ—¶é—´ä¸æœ¬åœ°æ—¶åŒºä¿¡æ¯
Â Â Â Â Â Â Â  std::cout << utils::renderNow() << std::endl;
Â 
Â Â Â Â Â Â Â  // è¾“å‡ºæ‰€æœ‰èœå•
Â Â Â Â Â Â Â  std::cout << std::format("{:*^80}\n", " MENU ");
Â Â Â Â Â Â Â  std::cout << std::format("*{: ^78}*\n", "");
Â Â Â Â Â Â Â  std::int32_t menuIndex = 0;
Â Â Â Â Â Â Â  for (const auto& menuItem : MenuItems) {
Â Â Â Â Â Â Â Â Â Â Â  menuIndex += 1;
Â 
Â Â Â Â Â Â Â Â Â Â Â  // è¾“å‡ºèœå•åºå·ä¸èœå•åç§°
Â Â Â Â Â Â Â Â Â Â Â  std::string menuLine = std::format("({}) {}", menuIndex, menuItem.title);
Â Â Â Â Â Â Â Â Â Â Â  std::cout << std::format("* {: <76} *", menuLine) << std::endl;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  std::cout << std::format("*{: ^78}*\n", "");
Â Â Â Â Â Â Â  std::cout << std::format("{:*^80}\n", "");
Â 
Â Â Â Â Â Â Â  // æç¤ºç”¨æˆ·è¾“å…¥èœå•ç¼–å·
Â Â Â Â Â Â Â  std::cout << std::format("\nè¯·è¾“å…¥èœå•ç¼–å·({}-{}):", 1, menuIndex);
Â Â Â  }
Â 
Â Â Â  // è¯»å–ç”¨æˆ·è¾“å…¥å¹¶æ‰§è¡ŒåŠ¨ä½œ
Â Â Â  void readAction() {
Â Â Â Â Â Â Â  std::string actionNumberString;
Â Â Â Â Â Â Â  // è¯»å–ç”¨æˆ·è¾“å…¥
Â Â Â Â Â Â Â  std::getline(std::cin, actionNumberString);
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â  // è§£æç”¨æˆ·è¾“å…¥
Â Â Â Â Â Â Â Â Â Â Â  int32_t actionNumber = std::stoi(actionNumberString);
Â Â Â Â Â Â Â Â Â Â Â  if (actionNumber < MinActionNumber || actionNumber > MaxActionNumber) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  std::cerr << std::format("èœå•ç¼–å·è¶…å‡ºèŒƒå›´({}-{})\n", MinActionNumber, MaxActionNumber);
Â Â Â Â Â Â Â Â Â Â Â  }
Â 
Â Â Â Â Â Â Â Â Â Â Â  // æ‰§è¡Œç›¸åº”èœå•é¡¹çš„action
Â Â Â Â Â Â Â Â Â Â Â  int32_t actionIndex = std::max(actionNumber - 1, 0);
Â Â Â Â Â Â Â Â Â Â Â  const auto& action = MenuItems[actionIndex].action;
Â Â Â Â Â Â Â Â Â Â Â  action();
Â 
Â Â Â Â Â Â Â Â Â Â Â  return;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  catch (const std::exception& e) {
Â  Â Â Â Â Â Â Â Â Â Â std::cerr << e.what() << std::endl;
Â Â Â Â Â Â Â  }
Â 
Â Â Â Â Â Â Â  std::cerr << "æ— æ³•è¯†åˆ«ç”¨æˆ·è¾“å…¥" << std::endl;
Â Â Â  }
}
```

è¿™æ®µä»£ç ä¸­å€¼å¾—æ³¨æ„çš„éƒ¨åˆ†æ˜¯ **showMenuå‡½æ•°**ï¼Œå®ƒç”¨äºå±•ç¤ºèœå•ã€‚è¯¥å‡½æ•°è¾“å‡ºæ ‡é¢˜åï¼Œä¼šéå†æ‰€æœ‰çš„MenuItemså¹¶è¾“å‡ºèœå•å†…å®¹ã€‚å‘ç°äº†ä¹ˆï¼Ÿè¿™æ®µä»£ç é€šè¿‡formatå®Œæˆäº†å¤§é‡çš„æ–‡æœ¬æ ¼å¼åŒ–å·¥ä½œã€‚

æœ€åæˆ‘ä»¬è¿˜å®šä¹‰äº†readActionå‡½æ•°ï¼Œç”¨äºè¯»å–ç”¨æˆ·è¾“å…¥çš„èœå•ç¼–å·å¹¶æ‰§è¡Œå¯¹åº”çš„èœå•åŠ¨ä½œã€‚è¿™é‡Œä½¿ç”¨äº†C++11å¼•å…¥çš„std::stoiå‡½æ•°å°†å­—ç¬¦ä¸²è½¬æ¢æˆå¯¹åº”çš„æ•´å‹æ•°å­—ã€‚

èœå•çš„å±•ç¤ºæ•ˆæœæ˜¯åé¢è¿™æ ·ã€‚

![](https://static001.geekbang.org/resource/image/89/56/894d127e48f9d7566b4a7f742ea61b56.jpg?wh=1406x375)

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ¬é¡¹ç›®ä»£ç é‡‡ç”¨äº†UTF-8ç¼–ç ï¼Œå› æ­¤å¦‚æœä½ åœ¨Windowsä¸‹æ‰§è¡Œï¼Œéœ€è¦åœ¨æ”¯æŒUTF-8ç¼–ç è¾“å‡ºçš„æ§åˆ¶å°ä¸‹ä½¿ç”¨ï¼ˆæ¯”å¦‚MinGWçš„bashï¼‰ã€‚

## å±•ç¤ºæ—¥å†

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¯¥å¦‚ä½•å±•ç¤ºæœ¬æœˆæ—¥å†ã€‚åœ¨actionsä¸­å®šä¹‰äº†èœå•é¡¹çš„å‡½æ•°å®ç°ï¼Œä»£ç å®ç°åœ¨src/actions/ShowAction.cppä¸­ã€‚

```c++
#include "actions/ShowAction.h"
#include "utils/RenderUtils.h"
Â 
#include <chrono>
#include <iostream>
#include <format>
Â 
namespace chrono = std::chrono;
Â 
namespace calendarpp::actions {
Â Â Â  void showCurrentMonth() {
Â Â Â Â Â Â Â  // è·å–å½“å‰æ—¶é—´
Â Â Â Â Â Â Â  chrono::time_point now{ chrono::system_clock::now() };
Â Â Â Â Â Â Â  // å°†æ—¶é—´è½¬æ¢ä¸ºyear_month_day
Â Â Â Â Â Â Â  chrono::year_month_day ymd{ chrono::floor<chrono::days>(now) };
Â Â Â Â Â Â Â  // è·å–å½“å‰å¹´æœˆï¼ˆç±»å‹ä¸ºyear_monthï¼‰
Â Â Â Â Â Â Â  chrono::year_month currentYearMonth = ymd.year() / ymd.month();
Â 
Â Â Â Â Â Â Â  // è°ƒç”¨æ¸²æŸ“æ¨¡å—æ¸²æŸ“å½“æœˆæ—¥å†
Â Â Â Â Â Â Â  std::cout << std::endl;
Â Â Â Â Â Â Â  std::cout << utils::renderMonth(currentYearMonth);
Â Â Â  }
}
```

ä»£ç ä¸­å®šä¹‰äº†showCurrentMonthå‡½æ•°ï¼Œè¯¥å‡½æ•°é¦–å…ˆè°ƒç”¨äº†chronoçš„Calendarè·å–å½“æ—¥æ‰€åœ¨çš„æ—¥æœŸå’Œæœˆä»½ã€‚

Calendaræ˜¯C++20å¼•å…¥åˆ°chronoä¸­æ–°çš„åº“ç‰¹æ€§ï¼Œæä¾›äº†æ ‡å‡†çš„æ ¼é‡Œé«˜åˆ©å†ï¼ˆGregorian calendarï¼‰å®ç°ã€‚

è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹year\_month\_dayï¼Œç”¨äºæè¿°ä¸€ä¸ªå®Œæ•´æ—¥æœŸï¼ˆå¹´æœˆæ—¥ï¼‰ï¼Œè¯¥ç±»å‹æ”¯æŒå¤šç§æ„é€ æ–¹æ³•ï¼Œè¿™é‡Œä½¿ç”¨chrono::system\_clock::now()è·å–ç³»ç»Ÿæœ¬åœ°æ—¶é—´ï¼Œç„¶åé‡‡ç”¨chrono::floor&lt;chrono::days&gt;å°†æ—¶é—´è½¬æ¢ä¸ºä»¥æ—¥ä¸ºå•ä½çš„æ—¶é—´ï¼Œæœ€åè°ƒç”¨year\_month\_dayå¾—åˆ°å½“æ—¥çš„æ—¥æœŸã€‚

year\_month\_dayæ”¯æŒé€šè¿‡yearå’Œmonthæˆå‘˜å‡½æ•°è·å–å½“æ—¥çš„å¹´ä»½ä¸æœˆä»½ï¼Œä»£ç 17è¡Œå°±è°ƒç”¨äº†year / monthè¿™ç§å½¢å¼æ„é€ äº†ä¸€ä¸ªyear\_monthå¯¹è±¡ï¼Œè¡¨ç¤ºæŸå¹´çš„æŸä¸ªæœˆï¼Œè¿™é‡Œæœ€åå¾—åˆ°çš„å°±æ˜¯æœ¬æ—¥æ‰€åœ¨çš„å½“æœˆã€‚/æ˜¯Calendarçš„ä¸€ä¸ªæ“ä½œç¬¦é‡è½½ï¼Œæ˜¯åˆ›å»ºæ—¥æœŸç±»å‹å¯¹è±¡çš„ä¸€ä¸ªè¯­æ³•ç³–ã€‚

ä»£ç æœ€åè°ƒç”¨renderMonthæ¸²æŸ“äº†å½“æœˆæ—¥å†å¹¶å°†å…¶è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œè¯¥å‡½æ•°å®šä¹‰åœ¨src/utils/RenderUtils.cppä¸­ï¼Œå±äºæ¸²æŸ“æ¨¡å—ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹ç›¸å…³ä»£ç ã€‚

é¦–å…ˆå®šä¹‰äº†Weekdayså¸¸é‡ï¼ŒåŒ…å«äº†å‘¨ä¸€åˆ°å‘¨æ—¥çš„æ‰€æœ‰æ˜ŸæœŸå‡ çš„å®šä¹‰ã€‚

```c++
// å®šä¹‰ä¸€å‘¨ä¸ƒå¤©çš„weekdayå¸¸é‡
static std::vector<chrono::weekday> Weekdays = {
Â Â Â  chrono::Monday,
Â Â Â  chrono::Tuesday,
Â Â Â  chrono::Wednesday,
Â Â Â  chrono::Thursday,
Â Â Â  chrono::Friday,
Â Â Â  chrono::Saturday,
Â Â Â  chrono::Sunday,
};
```

è¯¥æ•°ç»„çš„å…ƒç´ ç±»å‹ä¸ºchrono::weekdayï¼Œè¿™æ˜¯chronoçš„æ ‡å‡†ç±»å‹ï¼Œç”¨æ¥è¡¨ç¤ºå‘¨å‡ ï¼Œå…¶ä¸­Mondayåˆ°Sundayéƒ½æ˜¯chronoå®šä¹‰çš„å¸¸é‡ï¼Œè¡¨ç¤ºå‘¨ä¸€åˆ°å‘¨æ—¥ã€‚

```c++
// æ¸²æŸ“æŸä¸ªæœˆä»½çš„æ—¥å†ï¼Œè¿”å›string
std::string renderMonth(chrono::year_month yearMonth) {
Â Â Â  std::ostringstream os;
Â 
Â Â Â  // è·å–å½“æœˆçš„æ‰€æœ‰å‘¨
Â Â Â  auto monthWeeks = utils::buildMonthWeeks(yearMonth);
Â 
Â Â Â  // è·å–å½“æœˆç¬¬ä¸€å¤©
Â Â Â  const auto firstDay = yearMonth / 1d;
Â Â Â  // è·å–å½“æœˆæœ€åä¸€å¤©
Â Â Â  const auto lastDay = chrono::year_month_day(yearMonth / chrono::last);
Â 
Â Â Â  // è¾“å‡ºæ ¼å¼åŒ–çš„æ ‡é¢˜ï¼ˆå¹´ä»½ä¸æœˆä»½ï¼‰
Â Â Â  std::string titleLine = std::format("** {:%Y-%m} **", yearMonth);
Â Â Â  os << std::format("{:^35}", titleLine) << std::endl;
Â Â Â  os << std::format("{:->35}", "") << std::endl;
Â 
Â Â Â  // è¾“å‡ºæ—¥å†è¡¨å¤´ï¼ˆä»å‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰
Â Â Â  std::vector<std::string> headerLineParts;
Â Â Â  for (const auto& weekday : Weekdays) {
Â Â Â Â Â Â Â  headerLineParts.push_back(std::format(ZhCNLocale, "{:L%a}", weekday));
Â Â Â  }
Â Â Â  // åˆ©ç”¨renderWeekLineç”Ÿæˆæ ¼å¼åŒ–çš„è¡¨å¤´ï¼ˆæ§åˆ¶7ä¸ªå…ƒç´ çš„ä½ç½®ä¸å®½åº¦ï¼‰
Â Â Â  std::string headerLine = renderWeekLine(headerLineParts);
Â Â Â  os << headerLine << std::endl;
Â Â Â  os << std::format("{:->35}", "") << std::endl;
Â 
Â Â Â  // éå†monthWeeksï¼Œè°ƒç”¨renderWeekç”Ÿæˆæ—¥å†ä¸­çš„æ¯ä¸€è¡Œ
Â Â Â  for (const auto& currentWeek : monthWeeks) {
Â Â Â Â Â Â Â  std::string weekLine = renderWeek(currentWeek, yearMonth);
Â Â Â Â Â Â Â  os << weekLine << std::endl;
Â Â Â  }
Â 
Â Â Â  // è¿”å›æ¸²æŸ“çš„å­—ç¬¦ä¸²
Â Â Â  return os.str();
}
Â 
// æ¸²æŸ“æ—¥å†ä¸­çš„æŸä¸€å‘¨
std::string renderWeek(const std::vector<chrono::year_month_day> week, chrono::year_month yearMonth) {
Â Â Â  // è·å–å½“æœˆç¬¬ä¸€å¤©
Â Â Â  const auto firstDay = yearMonth / 1d;
Â Â Â  // è·å–å½“æœˆæœ€åä¸€å¤©
Â Â Â  const auto lastDay = chrono::year_month_day(yearMonth / chrono::last);
Â 
Â Â Â  // ç”Ÿæˆæœ¬å‘¨çš„æ‰€æœ‰æ—¥æœŸ
Â Â Â  std::vector<std::string> weekLine;
Â Â Â  for (const auto& currentDay : week) {
Â Â Â Â Â Â Â  std::string inCurrentMonthFlag = currentDay >= firstDay && currentDay <= lastDay ? "*" : "";
Â 
Â Â Â Â Â Â Â  weekLine.push_back(std::format("{}{:>2}", inCurrentMonthFlag, currentDay.day()));
Â Â Â  }
Â 
Â Â Â  // åˆ©ç”¨renderWeekLineç”Ÿæˆæ ¼å¼åŒ–çš„æœ¬å‘¨æ—¥æœŸ
Â Â Â  return renderWeekLine(weekLine);
}
Â 
// ç”ŸæˆæŸä¸€å‘¨çš„æ ¼å¼åŒ–è¾“å‡º
std::string renderWeekLine(const std::vector<std::string>& weekLine) {
Â Â Â  std::string renderResult;
Â Â Â  for (const auto& weekLineItem : weekLine) {
Â Â Â Â Â Â Â  // æ‰€æœ‰å†…å®¹æŒ‰ç…§å®½åº¦ä¸º4å³å¯¹é½
Â Â Â Â Â Â Â  renderResult.append(std::format("{:>4} ", weekLineItem));
Â Â Â  }
Â 
Â Â Â  return renderResult;
}
```

ä»£ç ä¸­çš„æ³¨é‡Šå·²ç»æ¯”è¾ƒè¯¦ç»†äº†ï¼Œæ‰€ä»¥åé¢æˆ‘ä»¬åªè®¨è®ºä¸€äº›é‡ç‚¹å®ç°ã€‚

ä»£ç ç¬¬5è¡Œï¼Œä½œç”¨æ˜¯è·å–å½“æœˆçš„æ‰€æœ‰å‘¨çš„æ•°ç»„ï¼Œutils::buildMonthWeekså±äºæ—¥å†è®¡ç®—æ¨¡å—ï¼Œæˆ‘ä»¬åé¢è¯¦ç»†è§£é‡Šå…¶å®ç°ã€‚

åœ¨ä»£ç ç¬¬8è¡Œï¼Œç”¨yearMonth / 1dç”Ÿæˆå½“æœˆçš„ç¬¬ä¸€å¤©ï¼Œè¿”å›çš„ç±»å‹å°±æ˜¯year\_month\_dayã€‚å…¶ä¸­1dæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰æ–‡å­—é‡ï¼Œå®šä¹‰åœ¨åç§°ç©ºé—´std::literals::chrono\_literalsä¸­ï¼Œç›¸å½“äºchrono::days(1)çš„è¯­æ³•ç³–ï¼Œè¡¨ç¤ºæŸä¸ªæœˆ1å·ã€‚yearMonth / 1dä¸­çš„/æ˜¯yearMonthçš„æ“ä½œç¬¦é‡è½½ï¼Œè¡¨ç¤ºå½“æœˆç¬¬ä¸€å¤©ã€‚

åœ¨ä»£ç ç¬¬10è¡Œï¼Œç”¨yearMonth / chrono::lastè¡¨ç¤ºå½“æœˆæœ€åä¸€å¤©ã€‚å…¶ä¸­ï¼Œchrono::lastæ˜¯C++20ä¸­å¼•å…¥çš„ï¼Œç”¨æ¥è¡¨ç¤ºä¸€ä¸ªæ—¶é—´åºåˆ—æœ«å°¾çš„æ ‡è®°ã€‚æœ€åï¼Œæˆ‘ä»¬è°ƒç”¨chrono::year\_month\_dayè½¬æ¢æˆyear\_month\_dayã€‚

ä»£ç ç¬¬18åˆ°25è¡Œï¼Œè°ƒç”¨äº†renderWeekLineå¸®åŠ©æˆ‘ä»¬ç”Ÿæˆæ ¼å¼åŒ–çš„æ ‡é¢˜ï¼Œå› ä¸ºè¾“å‡ºçš„æ—¥å†éœ€è¦å°†ä¸€å‘¨ä¸ƒå¤©æŒ‰ç…§ä¸€å®šçš„å¸ƒå±€è¾“å‡ºåˆ°æ§åˆ¶å°ä¸Šï¼Œè¯¥å‡½æ•°å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®Œæˆæ¸²æŸ“å¸ƒå±€ã€‚ä»£ç ç¬¬20è¡Œåˆ©ç”¨äº†localeè¾“å‡ºä¸­æ–‡ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±çœ‹RenderUtils.cppä¸­çš„å®šä¹‰ä»¥åŠlocaleç›¸å…³å†…å®¹ã€‚

åœ¨ä»£ç ç¬¬28åˆ°31è¡Œï¼Œç”Ÿæˆæ—¥å†çš„å†…å®¹ã€‚ç”±äºæ—¥å†é‡Œæ¯å‘¨è¾“å‡ºåˆ°ä¸€è¡Œä¸­ï¼Œå› æ­¤è¿™é‡Œéå†å½“æœˆæ‰€æœ‰å‘¨ï¼Œè°ƒç”¨renderWeekå®Œæˆä¸€å‘¨çš„å¸ƒå±€è¾“å‡ºã€‚

renderWeekLineå‡½æ•°å®ç°ä¹Ÿä¼šæ¯”è¾ƒç®€å•ï¼Œè¾“å…¥å‚æ•°æ˜¯ä¸€ä¸ªåŒ…å«Nä¸ªå­—ç¬¦ä¸²çš„æ•°ç»„ï¼Œæ•°ç»„å…ƒç´ å°±æ˜¯åœ¨æ—¥å†ä¸­çš„æ¯ä¸€ä¸ªæ ¼å­ä¸­éœ€è¦è¾“å‡ºçš„å†…å®¹ï¼ˆæ¯”å¦‚è¡¨å¤´çš„å‘¨å‡ æˆ–è€…æ—¥æœŸï¼‰ï¼Œè¿™é‡Œä¸»è¦é€šè¿‡formatå°†æ¯ä¸€æ ¼å†…å®¹çš„è¾“å‡ºå®½åº¦é™åˆ¶åœ¨4ï¼Œç¡®ä¿å¸ƒå±€å·¥æ•´ã€‚

æ¸²æŸ“å‡ºæ¥çš„æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚  
![](https://static001.geekbang.org/resource/image/58/75/581e249fe9ff9eb69052ce33d496b275.jpg?wh=1990x1070)

æœ€åï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹utils::buildMonthWeeksçš„å®ç°ï¼Œä»£ç å®ç°åœ¨src/utils/CalendarUtils.cppä¸­ã€‚

```c++
#include "utils/CalendarUtils.h"
#include <format>
Â 
namespace chrono = std::chrono;
using namespace std::literals::chrono_literals;
Â 
static uint32_t MaxWeekdayIndex = 6;
Â 
namespace calendarpp::utils {
Â Â Â  std::vector<std::vector<std::chrono::year_month_day>> buildMonthWeeks(std::chrono::year_month yearMonth) {
Â Â Â Â Â Â Â  // è·å–å½“æœˆç¬¬ä¸€å¤©
Â Â Â Â Â Â Â  const auto firstDay = yearMonth / 1d;
Â Â Â Â Â Â Â  // è·å–å½“æœˆæœ€åä¸€å¤©
Â Â Â Â Â Â Â  const auto lastDay = chrono::year_month_day(yearMonth / chrono::last);
Â 
Â Â Â Â Â Â Â  std::vector<std::vector<chrono::year_month_day>> monthWeeks;
Â 
Â Â Â Â Â Â Â  // å°†å½“æœˆç¬¬ä¸€å¤©è®¾å®šä¸ºå½“æ—¥
Â Â Â Â Â Â Â  auto currentDay = firstDay;
Â Â Â Â Â Â Â  // å½“æ¯å‘¨å½“æ—¥è¶…å‡ºå½“æœˆæœ€åä¸€å¤©æ—¶ä¸­æ­¢å¾ªç¯
Â Â Â Â Â Â Â  while (currentDay <= lastDay) {
Â Â Â Â Â Â Â Â Â Â Â  // æ¯æ¬¡å¾ªç¯éƒ½è®¡ç®—å‡ºå½“æ—¥æ‰€åœ¨å‘¨çš„7å¤©ï¼ˆå‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰
Â Â Â Â Â Â Â Â Â Â Â  std::vector<chrono::year_month_day> currentMonthWeek;
Â 
Â Â Â Â Â Â Â Â Â Â Â  // é€šè¿‡weekdayè·å–æŸä¸€å¤©æ˜¯å‘¨å‡ 
Â Â Â Â Â Â Â Â Â Â Â  auto currentWeekday = chrono::weekday{ std::chrono::sys_days{ currentDay } };
Â Â Â Â Â Â Â Â Â Â Â  // é€šè¿‡iso_encodingè·å–å‘¨å‡ çš„ç¼–ç ï¼ˆ1-7ï¼‰
Â Â Â Â Â Â Â Â Â Â Â  auto currentWeekdayIndex = currentWeekday.iso_encoding() - 1;
Â 
Â Â Â Â Â Â Â Â Â Â Â  // è®¡ç®—æœ¬å‘¨ç¬¬ä¸€å¤©
Â Â Â Â Â Â Â Â Â Â Â  auto firstDayOfWeek = chrono::year_month_day{
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  std::chrono::sys_days{ currentDay } - chrono::days(currentWeekdayIndex)
Â Â Â Â Â Â Â Â Â Â Â  };
Â 
Â Â Â Â Â Â Â Â Â Â Â  currentDay = firstDayOfWeek;
Â Â Â Â Â Â Â Â Â Â Â  // è®¡ç®—å‡ºæœ¬å‘¨çš„æ‰€æœ‰æ—¥æœŸå¹¶æ·»åŠ åˆ°currentMonthWeekä¸­
Â Â Â Â Â Â Â Â Â Â Â  for (uint32_t weekdayIndex = 0; weekdayIndex <= MaxWeekdayIndex; ++weekdayIndex) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  currentMonthWeek.push_back(currentDay);
Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  currentDay = chrono::year_month_day{
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  std::chrono::sys_days{ currentDay } + chrono::days(1)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  // å°†è®¡ç®—å¥½çš„å½“å‰å‘¨æ·»åŠ åˆ°monthWeeksä¸­
Â Â Â Â Â Â Â Â Â Â Â  monthWeeks.push_back(currentMonthWeek);
Â Â Â Â Â Â Â  }
Â 
Â Â Â Â Â Â Â  return monthWeeks;
Â Â Â  }
}
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¼šç”Ÿæˆå½“æœˆçš„æ‰€æœ‰å‘¨ï¼Œé€šè¿‡Calendarå®Œæˆäº†å¤§é‡çš„æ—¥æœŸè®¡ç®—ï¼Œç›¸æ¯”è‡ªå·±å®ç°æ ¼é‡Œé«˜åˆ©å†è¦æ–¹ä¾¿ä¸å°‘ã€‚

## å¯¼å‡ºæ—¥å†

é™¤äº†å±•ç¤ºæ—¥å†ï¼Œæˆ‘ä»¬ç»§ç»­è®¨è®ºåºåˆ—åŒ–æ—¥å†çš„å®ç°ã€‚åœ¨src/actions/ExportAction.cppä¸­å®šä¹‰äº†å¯¼å‡ºèœå•é¡¹çš„ä»£ç å®ç°ã€‚

```c++
#include "actions/ExportAction.h"
#include "utils/RenderUtils.h"
#include "utils/IOUtils.h"
Â 
#include <chrono>
#include <iostream>
#include <string>
Â 
namespace chrono = std::chrono;
Â 
namespace calendarpp::actions {
Â Â Â  void exportCurrentYear() {
Â Â Â Â Â Â Â  // è·å–å½“å‰æ—¶é—´
Â Â Â Â Â Â Â  chrono::time_point now{ chrono::system_clock::now() };
Â Â Â Â Â Â Â  // å°†æ—¶é—´è½¬æ¢ä¸ºyear_month_day
Â Â Â Â Â Â Â  chrono::year_month_day ymd{ chrono::floor<chrono::days>(now) };
Â Â Â Â Â Â Â  // è·å–å½“å‰å¹´ä»½
Â Â Â Â Â Â Â  chrono::year currentYear = ymd.year();
Â 
Â Â Â Â Â Â Â  // æç¤ºå¹¶è¯»å–ç”¨æˆ·è¾“å…¥
Â Â Â Â Â Â Â  std::cout << "è¯·è¾“å…¥å¯¼å‡ºæ–‡ä»¶è·¯å¾„: ";
Â Â Â Â Â Â Â  std::string filePath;
Â Â Â Â Â Â Â  std::getline(std::cin, filePath);
Â 
Â Â Â Â Â Â Â  // è°ƒç”¨IOæ¨¡å—å°†renderYearçš„æ¸²æŸ“ç»“æœè¾“å‡ºåˆ°æ–‡ä»¶ä¸­
Â Â Â Â Â Â Â  utils::writeFile(filePath, utils::renderYear(currentYear));
Â 
Â Â Â Â Â Â Â  std::cout << std::format("å·²å°†æ—¥å†å¯¼å‡ºåˆ°æ–‡ä»¶ä¸­: {}", filePath) << std::endl;
Â Â Â Â Â Â Â  std::cout << std::endl;
Â Â Â  }
}
```

è¿™æ®µä»£ç éå¸¸ç®€å•ï¼Œæ ¸å¿ƒæ˜¯é€šè¿‡renderYearæ¸²æŸ“å½“å¹´çš„æ—¥å†ï¼Œç„¶åé€šè¿‡writeFileä»¥UTF-8ç¼–ç å†™å…¥åˆ°æ–‡ä»¶ä¸­ã€‚

å‡½æ•°renderYearå®ç°åœ¨src/utils/RenderUtils.cppä¸­ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

```c++
// å®šä¹‰ä¸€å¹´12ä¸ªæœˆçš„monthå¸¸é‡
static std::vector<chrono::month> Months = {
Â Â Â  chrono::January,
Â Â Â  chrono::February,
Â Â Â  chrono::March,
Â Â Â  chrono::April,
Â Â Â  chrono::May,
Â Â Â  chrono::June,
Â Â Â  chrono::July,
Â Â Â  chrono::August,
Â Â Â  chrono::September,
Â Â Â  chrono::October,
Â Â Â  chrono::November,
Â Â Â  chrono::December,
};
Â 
std::string renderYear(std::chrono::year year) {
Â Â Â  std::ostringstream os;
Â 
Â Â Â  // è¾“å‡ºæ ¼å¼åŒ–çš„æ ‡é¢˜ï¼ˆå¹´ä»½ï¼‰
Â Â Â  std::string titleLine = std::format("**** {:%Y}å¹´ ****", year);
Â Â Â  os << std::format("{:^35}", titleLine) << std::endl;
Â Â Â  os << std::format("{:=^35}\n", "") << std::endl;
Â 
Â Â Â  // è°ƒç”¨renderYearMonthså¹¶è¡Œç”Ÿæˆ12ä¸ªæœˆçš„æ—¥å†
Â Â Â  std::vector<std::string> renderedMonths(Months.size(), "");
Â Â Â  renderYearMonths(renderedMonths, year);
Â 
Â Â Â  // å°†12ä¸ªæœˆçš„æ—¥å†è¾“å…¥åˆ°è¾“å‡ºæµä¸­
Â Â Â  for (const std::string& renderedMonth : renderedMonths) {
Â Â Â Â Â Â Â  os << renderedMonth;
Â Â Â Â Â Â Â  os << std::endl;
Â Â Â  }
Â 
Â Â Â  // è¿”å›æ¸²æŸ“å¥½çš„å­—ç¬¦ä¸²
Â Â Â  return os.str();
}
Â 
static void renderYearMonths(std::vector<std::string>& renderedMonths, chrono::year year) {
Â Â Â  std::vector<std::jthread> renderThreads;
Â 
Â Â Â  int32_t monthIndex = 0;
Â Â Â  for (const auto& currentMonth : Months) {
Â Â Â Â Â Â Â  auto currentYearMonth = year / currentMonth;
Â Â Â Â Â Â Â  auto& renderedMonth = renderedMonths[monthIndex];
Â 
Â Â Â Â Â Â Â  // åˆ›å»ºjthreadå¯¹è±¡ï¼Œå¼€å¯è®¡ç®—çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹è´Ÿè´£ç”Ÿæˆä¸€ä¸ªæœˆçš„æ—¥å†
Â Â Â Â Â Â Â  renderThreads.push_back(std::jthread([currentYearMonth, &renderedMonth] {
Â Â Â Â Â Â Â Â Â Â Â  renderedMonth = renderMonth(currentYearMonth);
Â Â Â Â Â Â Â  }));
Â 
Â Â Â Â Â Â Â  ++monthIndex;
Â Â Â  }
Â 
Â Â Â  // é€€å‡ºå‡½æ•°æ—¶ï¼Œæ‰€æœ‰jthreadå¯¹è±¡ä¼šè‡ªåŠ¨ç­‰å¾…è®¡ç®—å®Œæˆç„¶åé€€å‡º
}
```

æˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹renderYearMonthså‡½æ•°çš„å®ç°ã€‚

è¯¥å‡½æ•°å®šä¹‰äº†ä¸€ä¸ªjthreadæ•°ç»„ï¼Œç„¶åå¾ªç¯åˆ›å»ºäº†12ä¸ªçº¿ç¨‹ï¼Œç”¨äºåˆ†åˆ«è°ƒç”¨renderMonthæ¸²æŸ“å„è‡ªæœˆä»½çš„æ—¥å†ã€‚ç”±äºjthreadä¼šåœ¨ææ„æ—¶è‡ªåŠ¨ç­‰å¾…æœ¬çº¿ç¨‹å®Œæˆã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦å»joinè¿™äº›çº¿ç¨‹ï¼Œåœ¨é€€å‡ºrenderYearMonthsä¹‹å‰ï¼Œæ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹è‚¯å®šèƒ½ç»“æŸä»»åŠ¡ã€‚

æœ€åçœ‹ä¸€ä¸‹writeFileçš„å®ç°ï¼Œä»£ç åœ¨src/utils/IOUtils.cppä¸­ã€‚

```c++
#include "utils/IOUtils.h"
#include "Logger.h"
Â 
#include <filesystem>
#include <format>
#include <iostream>
Â 
namespace fs = std::filesystem;
Â 
namespace calendarpp::utils {
Â Â Â  void writeFile(const std::string& filePath, const std::string& fileContent) {
Â Â Â Â Â Â Â  auto& logger = getLogger();
Â 
Â Â Â Â Â Â Â  // æ£€æµ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨
Â Â Â Â Â Â Â  if (fs::exists(filePath)) {
Â Â Â Â Â Â Â Â Â Â Â  logger.warning(std::format("Override existed file: {}", filePath));
Â Â Â Â Â Â Â  }
Â 
Â Â Â Â Â Â Â  // ç”±äºæºä»£ç ä½¿ç”¨UTF-8ï¼Œç”Ÿæˆçš„å­—ç¬¦ä¸²å°±æ˜¯UTF-8ï¼Œå› æ­¤å¯ä»¥ç›´æ¥å¼ºåˆ¶ç±»å‹è½¬æ¢æ„å»ºu8string
Â Â Â Â Â Â Â  std::u8string utf8FileContent(reinterpret_cast<const char8_t*>(fileContent.c_str()), fileContent.size());
Â 
Â Â Â Â Â Â Â  // å°†u8stringä»¥äºŒè¿›åˆ¶å½¢å¼å†™å…¥åˆ°æ–‡ä»¶ä¸­
Â Â Â Â Â Â Â  std::ofstream outputFile(filePath, std::ios::binary);
Â Â Â Â Â Â Â  outputFile.write(reinterpret_cast<char*>(utf8FileContent.data()), utf8FileContent.size());
Â Â Â  }
}
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œé¦–å…ˆé€šè¿‡æ–‡ä»¶ç³»ç»Ÿåº“ä¸­çš„std::filsystem::existsæ£€æµ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™æç¤ºç”¨æˆ·ä¼šè¦†ç›–åŸæœ‰æ–‡ä»¶ã€‚

æ¥ç€ï¼Œå°†å­—ç¬¦ä¸²è½¬æ¢æˆu8stringï¼Œç”±äºæºä»£ç ä½¿ç”¨UTF-8ï¼Œç”Ÿæˆçš„å­—ç¬¦ä¸²å°±æ˜¯UTF-8ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¼ºåˆ¶ç±»å‹è½¬æ¢æ„å»ºu8stringã€‚

æœ€åï¼Œå°†u8stringçš„dataå¼ºåˆ¶ç±»å‹è½¬æ¢ä¸ºchar\*ï¼Œå¹¶é€šè¿‡äºŒè¿›åˆ¶å½¢å¼å†™å…¥åˆ°æ–‡ä»¶ä¸­ã€‚

## æ€»ç»“

åœ¨è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå·¥ç¨‹ï¼Œä¸²è®²äº†ä¸€ç³»åˆ—C++20å¸¦æ¥çš„é‡è¦åº“å˜æ›´ã€‚æˆ‘ä»¬åœ¨åŸæœ‰çš„æ—¥å¿—æ¡†æ¶åŸºç¡€ä¸Šï¼Œè¿½åŠ äº†source\_locationï¼Œç”¨äºè®°å½•æ‰“å°æ—¥å¿—æ—¶ä»£ç çš„æ‰€åœ¨ä½ç½®ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå°†ä¼ ç»Ÿçš„è¾“å‡ºæµæ›¿æ¢æˆsync streamï¼Œå°±å¯ä»¥è½»æ¾å®ç°è¾“å‡ºçš„çº¿ç¨‹åŒæ­¥æ§åˆ¶ã€‚

åœ¨å®ç°çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨äº†TimeZoneè·å–å¸¦æ—¶åŒºçš„æœ¬åœ°æ—¶é—´ï¼Œå¹¶é€šè¿‡ä½¿ç”¨Calendarå®Œæˆæ—¥å†è®¡ç®—ã€‚è¿™äº›é’ˆå¯¹chronoçš„æ ‡å‡†åº“è¡¥å……ï¼Œå¤§å¤§é™ä½äº†æ—¶é—´å¤„ç†çš„å¤æ‚åº¦ã€‚

æœ€åï¼Œæˆ‘ä»¬åˆ©ç”¨u8stringï¼Œè½»æ¾å®ç°äº†UTF-8ç¼–ç çš„æ–‡æœ¬å¯¼å‡ºã€‚

é€šè¿‡è¿™äº›æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥æ„Ÿå—åˆ°ï¼Œ**ç°ä»£ C++çš„åº“å˜æ›´å»ºç«‹åœ¨æ–°çš„æ ¸å¿ƒè¯­è¨€ç‰¹æ€§åŸºç¡€ä¸Šï¼Œä¸ºæˆ‘ä»¬æ—¥å¸¸ç¼–ç¨‹å·¥ä½œæä¾›äº†æå¤§çš„ä¾¿åˆ©ã€‚é¿å…é€ è½®å­ï¼Œæå‡ç¼–ç¨‹æ•ˆç‡**â€”â€”è¿™äº›å¯¹äºåº“çš„æ ¸å¿ƒå˜æ›´æ¥è¯´æ˜¯æ ¸å¿ƒè®®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥ä¿æŒå¯¹æ ‡å‡†åº“æ¼”è¿›çš„æŒç»­å…³æ³¨ã€‚

## è¯¾åæ€è€ƒ

ç°åœ¨æ—¥å†ä¸­æ˜¾ç¤ºçš„æ—¶é—´æ˜¯åŒ…å«æ—¶åŒºä¿¡æ¯çš„æœ¬åœ°æ—¶é—´ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›æ—¥å†ä¸­æ˜¾ç¤ºçš„å½“å‰æ—¶é—´æ˜¯UTCæ—¶é—´ï¼ˆæ—¥å†æ˜¾ç¤ºä¾ç„¶æŒ‰ç…§æœ¬åœ°æ—¶é—´è®¡ç®—ï¼Œä¸éœ€è¦å˜åŒ–ï¼‰ï¼Œæˆ‘ä»¬è¦å¯¹ä»£ç åšä»€ä¹ˆæ”¹åŠ¨ï¼Ÿ

æ¬¢è¿ç»™å‡ºä½ çš„æ–¹æ¡ˆï¼Œä¸å¤§å®¶ä¸€èµ·åˆ†äº«ã€‚æˆ‘ä»¬ä¸€åŒäº¤æµã€‚ä¸‹ä¸€è®²è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ3ï¼‰</strong></div><ul>
<li><span>æäº‘é¾™</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æŠŠæœ¬åœ°æ—¶é—´çš„æ˜¾ç¤ºæ¢æˆUTCæ—¶é—´ï¼Œåªéœ€ä¿®æ”¹RenderUtils.cppä¸­çš„ renderNow() å‡½æ•°ï¼šæŠŠchrono::system_clock::now() æ›¿æ¢ä¸º auto utcNow = std::chrono::utc_clock::now(); åŒæ—¶æŠŠæ—¶åŒºä¿¡æ¯å»é™¤ã€‚</p>2024-01-28</li><br/><li><span>ä¸‰ç¬‘ä¸‰å¼•ä¼å…µ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>osyncstreamå¥½åƒæ˜¯åœ¨è°ƒç”¨emit()å’Œææ„æ—¶æ‰ä¼šå°†è‡ªèº«ç¼“å†²åŒºçš„å†…å®¹ä¼ è¾“ç»™è¢«åŒ…è£…çš„ç¼“å†²  åœ¨æ—¥å¿—æ¨¡å—ä¸­çš„è¯ä¸ä¼šå¯¼è‡´ç¼“å†²åŒºä¸€ç›´å¢é•¿å—
ä¸€èˆ¬æ€ä¹ˆè§£å†³å‘¢</p>2024-12-07</li><br/><li><span>peter</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>C++20ä¹‹å‰æ²¡æœ‰Calendarå—ï¼Ÿ
æ–‡ä¸­â€œCalendar æ˜¯ C++20 å¼•å…¥åˆ° chrono ä¸­æ–°çš„åº“ç‰¹æ€§â€ï¼Œä¹‹å‰æ²¡æœ‰Calendarå—ï¼Ÿæœ‰ç‚¹å°æ€€ç–‘ã€‚å¦‚æœæ²¡æœ‰ï¼Œä»¥å‰æ˜¯æ€ä¹ˆå¤„ç†æ—¥å†é—®é¢˜çš„ï¼Ÿ</p>2023-03-07</li><br/>
</ul>