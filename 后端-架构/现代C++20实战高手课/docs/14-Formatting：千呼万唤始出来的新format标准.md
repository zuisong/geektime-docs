ä½ å¥½ï¼Œæˆ‘æ˜¯å¢èª‰å£°ã€‚

åœ¨C++ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸è®¨è®ºä¸€ä¸ªçœ‹ä¼¼ç®€å•çš„é—®é¢˜â€”â€”**å¦‚ä½•å®ç°æ ¼å¼åŒ–å­—ç¬¦ä¸²å’Œæ ¼å¼åŒ–è¾“å‡ºï¼Ÿ**

è¿™ä¸ªé—®é¢˜æ ¸å¿ƒåœ¨äºå­—ç¬¦ä¸²æ ¼å¼åŒ–ï¼Œè€ƒè™‘åˆ°C++å‘ä¸‹å…¼å®¹çš„é—®é¢˜ï¼Œæƒ³åšå‡ºä¸€ä¸ªèƒ½è®©å¤§å®¶æ»¡æ„çš„å­—ç¬¦ä¸²æ ¼å¼åŒ–æ ‡å‡†æ–¹æ¡ˆï¼Œå…¶å®å¹¶ä¸å®¹æ˜“ã€‚åœ¨è¿‡å»çš„æ ‡å‡†ä¸­ï¼ŒC++æ ‡å‡†å§”å‘˜ä¼šä¸€ç›´é€šè¿‡å„ç§ä¿®ä¿®è¡¥è¡¥ï¼Œå°è¯•æä¾›ä¸€äº›æ ¼å¼åŒ–çš„è¾…åŠ©æ–¹æ¡ˆï¼Œä½†å§‹ç»ˆæ²¡æœ‰ä¸€ä¸ªé£æ ¼ä¸€è‡´çš„æ ‡å‡†åŒ–æ–¹æ¡ˆã€‚

å¥½åœ¨C++20åŠå…¶åç»­æ¼”è¿›ä¸­ï¼Œç»ˆäºå‡ºç°äº†æ»¡è¶³æˆ‘ä»¬è¦æ±‚çš„æ ¼å¼åŒ–æ–¹æ¡ˆã€‚å› æ­¤ï¼Œåœ¨è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬å°±èšç„¦äºè®²è§£è¿™ä¸ªæ–°çš„å­—ç¬¦ä¸²æ ¼å¼åŒ–æ–¹æ¡ˆã€‚

å¥½ï¼Œè¯ä¸å¤šè¯´ï¼Œå°±è®©æˆ‘ä»¬å¼€å§‹ä»Šå¤©çš„å†…å®¹å§(è¯¾ç¨‹é…å¥—ä»£ç å¯ä»¥ä»[è¿™é‡Œ](https://github.com/samblg/cpp20-plus-indepth)è·å–)ã€‚

## å¤æ‚çš„æ–‡æœ¬æ ¼å¼åŒ–æ–¹æ¡ˆ

é¦–å…ˆï¼Œæˆ‘ä»¬è¦å¼„æ˜ç™½ä»€ä¹ˆæ˜¯â€œæ–‡æœ¬æ ¼å¼åŒ–â€ã€‚

ä¸‹é¢ä¸€ä¸ªå¸¸è§çš„HTTPæœåŠ¡çš„æ—¥å¿—è¾“å‡ºï¼Œæˆ‘ä»¬ç»“åˆè¿™ä¸ªå…¸å‹ä¾‹å­æ¥è®²è§£ã€‚

```c++
wwwÂ Â Â Â  | [2023-01-16T19:04:19] [INFO] 127.0.0.1 - "GET /api/v1/info HTTP/1.0" 200 6934 "http://127.0.0.1/index.html" "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:108.0) Gecko/20100101 Firefox/108.0"
```

å¯ä»¥çœ‹åˆ°ï¼Œæ—¥å¿—è¾“å‡ºä¸­åŒ…å«äº†ä¸€äº›å›ºå®šå­—ç¬¦ã€éœ€è¦æ ¹æ®å®é™…æƒ…å†µæ›¿æ¢çš„å€¼ã€‚è¾“å‡ºç±»ä¼¼å†…å®¹çš„è¿™ç§éœ€æ±‚å°±è¢«ç§°ä¸ºâ€œæ–‡æœ¬æ ¼å¼åŒ–â€ã€‚

äº‹å®ä¸Šï¼Œè®¸å¤šç°ä»£ç¼–ç¨‹è¯­è¨€éƒ½æä¾›äº†ä¾¿åˆ©ã€å®‰å…¨çš„æ ¼å¼åŒ–æ–¹æ¡ˆã€‚

ä½†é—æ†¾çš„æ˜¯ï¼Œåœ¨C++20ä»¥å‰è™½ç„¶ä¹Ÿæœ‰æ–‡æœ¬åŒ–æ ¼å¼æ–¹æ¡ˆï¼Œä½†éƒ½å­˜åœ¨ç€è¿™æ ·é‚£æ ·çš„ç¼ºé™·ï¼Œè€Œä¸”ä¸å¤Ÿç°ä»£åŒ–ã€‚

ç”šè‡³å°±æ­¤å‡ºç°äº†ä¸€äº›ä¸´æ—¶æ‹¼å‡‘çš„æ–¹æ¡ˆï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªè¡¨æ ¼æ¥å›é¡¾ä¸€ä¸‹ï¼Œåœ¨C++20ä»¥å‰çš„æ–‡æœ¬æ ¼å¼åŒ–æ–¹æ¡ˆã€‚

![](https://static001.geekbang.org/resource/image/1c/fb/1c811111c6bbf173673e8580c7b131fb.jpg?wh=3500x2460)

çœ‹å®Œè¡¨æ ¼ï¼Œä½ åº”è¯¥ä¹Ÿå‘ç°äº†ã€‚åœ¨C++20å‡ºç°ä»¥å‰ï¼Œå„ç§æ–‡æœ¬æ ¼å¼åŒ–æ–¹æ¡ˆéƒ½å­˜åœ¨ä¸€äº›è¾ƒä¸ºæ˜æ˜¾çš„ç¼ºç‚¹ï¼Œæ— è®ºæ˜¯æœ¬èº«çš„å®‰å…¨æ€§é—®é¢˜ï¼Œè¿˜æ˜¯ç¼–ç å±‚é¢çš„æ˜“ç”¨æ€§æ–¹é¢ã€‚è¿™å¯¼è‡´äº†ï¼ŒC++å¼€å‘è€…åœ¨é€‰æ‹©æ–‡æœ¬æ ¼å¼åŒ–æ–¹æ¡ˆçš„æ—¶å€™éš¾ä»¥æŠ‰æ‹©ã€‚

å¹¸è¿çš„æ˜¯ï¼ŒC++20ç»ˆäºæå‡ºäº†æ ‡å‡†åŒ–çš„æ–‡æœ¬æ ¼å¼åŒ–æ–¹æ¡ˆâ€”â€”è¿™å°±æ˜¯Formattingåº“ã€‚

## Formatting

Formattingåº“æä¾›äº†ç±»ä¼¼äºå…¶ä»–ç°ä»£åŒ–ç¼–ç¨‹è¯­è¨€çš„æ–‡æœ¬æ ¼å¼åŒ–æ¥å£ï¼Œè€Œä¸”è¿™äº›æ¥å£è®¾è®¡è¶³å¤Ÿå®Œç¾ã€ä¾¿äºä½¿ç”¨ã€‚åŒæ—¶ï¼Œå®ƒè¿˜æä¾›äº†è¶³å¤Ÿçµæ´»çš„æ¡†æ¶ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å¯¹å…¶è¿›è¡Œæ‰©å±•ï¼Œæ”¯æŒæ›´å¤šçš„æ•°æ®ç±»å‹ä¸æ ¼å¼ã€‚

æƒ³è¦äº†è§£Formattingåº“ï¼Œæˆ‘ä»¬å¾ªåºæ¸è¿›ã€‚å…ˆä»æœ€åŸºç¡€çš„æ ¼å¼åŒ–å‡½æ•°formatå¼€å§‹ï¼Œå…¶å®šä¹‰æ˜¯åé¢è¿™æ ·ã€‚

```c++
template<class... Args>
std::string format(std::format_string<Args...> fmt, Args&&... args);
```

è¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œæè¿°æ–‡æœ¬æ ¼å¼ï¼Œåç»­å‚æ•°å°±æ˜¯éœ€è¦è¢«æ ¼å¼åŒ–çš„å…¶ä»–å‚æ•°ã€‚

å…³äºstd::format\_string&lt;Argsâ€¦&gt;è¿™ä¸ªç±»å‹ï¼Œæˆ‘ä»¬åœ¨åé¢æ·±å…¥ç†è§£Formattingä¸­å†å…·ä½“è®¨è®ºï¼Œç°åœ¨ä½ åªéœ€è¦çŸ¥é“ï¼Œè¿™æ˜¯ç”¨æ ¼å¼æè¿°çš„å­—ç¬¦ä¸²å³å¯ã€‚

ä¸‹é¢æ˜¯ä½¿ç”¨formatå‡½æ•°ç¼–å†™çš„æ—¥å¿—è¾“å‡ºä»£ç ã€‚

```c++
#include <iostream>
#include <format>
#include <string>
#include <cstdint>
#include <chrono>

// ä½¿ç”¨ std::chrono æ¥æ‰“å°æ—¥å¿—çš„æ—¶é—´
using TimePoint = std::chrono::time_point<std::chrono::system_clock>;

struct HttpLogParams {
Â Â Â  std::string user;
Â Â Â  TimePoint requestTime; // C++20 æä¾›äº†chronoå¯¹formatçš„æ”¯æŒ
Â Â Â  std::string level;
Â Â Â  std::string ip;
Â Â Â  std::string method;
Â Â Â  std::string path;
Â Â Â  std::string httpVersion;
Â Â Â  int32_t statusCode;
Â Â Â  int32_t bodySize;
Â Â Â  std::string refer;
Â Â Â  std::string agent;
};

void formatOutputParams(const HttpLogParams& params);

int main() {
Â Â Â  HttpLogParams logParams = {
Â Â Â Â Â Â Â  .user = "www",
Â Â Â Â Â Â Â  .requestTime = std::chrono::system_clock::now(),
Â Â Â Â Â Â Â  .level = "INFO",
Â Â Â Â Â Â Â  .ip = "127.0.0.1",
Â Â Â Â Â Â Â  .method = "GET",
Â Â Â Â Â Â Â  .path = "/api/v1/info",
Â Â Â Â Â Â Â  .httpVersion = "HTTP/1.0",
Â Â Â Â Â Â Â  .statusCode = 200,
Â Â Â Â Â Â Â  .bodySize = 6934,
Â Â Â Â Â Â Â  .refer = "http://127.0.0.1/index.hmtl",
Â Â Â Â Â Â Â  .agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:108.0) Gecko/20100101 Firefox/108.0",
Â Â Â  };

Â Â Â  formatOutputParams(logParams);

Â Â Â  return 0;
}

void formatOutputParams(const HttpLogParams& params) {
Â Â Â  std::string logLine = std::format("{0:<16}|{1:%Y-%m-%d}T{1:%H:%M:%OS}Z {2} {3} - \"{4} {5} {6}\" {7} {8} \"{9}\" \"{10}\"",
Â Â Â Â Â Â Â  params.user,
Â Â Â Â Â Â Â  params.requestTime,
Â Â Â Â Â Â Â  params.level,
Â Â Â Â Â Â Â  params.ip,
Â Â Â Â Â Â Â  params.method,
Â Â Â Â Â Â Â  params.path,
Â Â Â Â Â Â Â  params.httpVersion,
Â Â Â Â Â Â Â  params.statusCode,
Â Â Â Â Â Â Â  params.bodySize,
Â Â Â Â Â Â Â  params.refer,
Â Â Â Â Â Â Â  params.agent
Â Â Â  );

Â Â Â  std::cout << logLine << std::endl;
}
```

C++20åœ¨C++11çš„åŸºç¡€ä¸Šï¼Œä¸ºchronoåº“æä¾›äº†å®Œå–„çš„formatæ”¯æŒï¼Œæˆ‘ä»¬å†ä¹Ÿä¸éœ€è¦ä½¿ç”¨æ—§çš„Cé£æ ¼æ—¶é—´æ ¼å¼åŒ–å‡½æ•°äº†ï¼ˆè§ä»£ç ç¬¬12è¡Œï¼‰ã€‚

è¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹formatçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ ¼å¼ã€‚æ ¼å¼åŒ–å­—ç¬¦ä¸²ç”±ä»¥ä¸‹ä¸‰ç±»å…ƒç´ ç»„æˆã€‚

- æ™®é€šå­—ç¬¦ï¼ˆé™¤äº† { å’Œ } ä»¥å¤–ï¼‰ï¼Œè¿™äº›å­—ç¬¦ä¼šè¢«ç›´æ¥æ‹·è´åˆ°è¾“å‡ºä¸­ï¼Œä¸ä¼šåšä»»ä½•æ›´æ”¹ã€‚
- è½¬ä¹‰åºåˆ—ï¼ŒåŒ…æ‹¬ {{ å’Œ }}ï¼Œåœ¨è¾“å‡ºä¸­åˆ†åˆ«ä¼šè¢«æ›¿æ¢æˆ{å’Œ}ã€‚
- æ›¿æ¢å­—æ®µï¼Œç”± { â€¦ } æ„æˆï¼Œè¿™äº›æ›¿æ¢å­—æ®µä¼šæ›¿æ¢æˆformatåç»­å‚æ•°ä¸­å¯¹åº”çš„å‚æ•°ï¼Œå¹¶æ ¹æ®æ ¼å¼æ§åˆ¶æè¿°ç”Ÿæˆè¾“å‡ºã€‚

å¯¹äºæ›¿æ¢å­—æ®µçš„ä¸¤ç§å½¢å¼ï¼Œä½ å¯ä»¥å‚è€ƒåé¢è¿™å¼ è¡¨æ ¼ã€‚

![](https://static001.geekbang.org/resource/image/fb/bc/fbab4e74eaaeda085cf69b5d44yy85bc.jpg?wh=3500x1300)

å¦‚æœä½ äº†è§£è¿‡Pythonï¼Œå°±ä¼šå‘ç°formatå‡½æ•°çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ ¼å¼ï¼Œå…¶å®ç±»ä¼¼äºPythonçš„æ ¼å¼åŒ–è§„èŒƒã€‚ä¸å¾—ä¸æ‰¿è®¤çš„æ˜¯ï¼ŒC++20æ ‡å‡†å€Ÿé‰´äº†ç›¸åº”çš„è§„èŒƒã€‚

é™¤äº†æœ€ç®€å•çš„formatå‚æ•°ï¼ŒC++20è¿˜æä¾›äº†ä¸‰ä¸ªæœ‰ç”¨çš„å·¥å…·å‡½æ•°ï¼Œä½œä¸ºæ‰©å±•åŠŸèƒ½ã€‚

1. format\_to
2. format\_to\_n
3. formatted\_size

ä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼Œæ¥çœ‹çœ‹å®ƒä»¬çš„å…·ä½“ç”¨æ³•ã€‚

```c++
#include <iostream>
#include <format>
#include <string>

int main() {
    // format_to
    // å°†ç”Ÿæˆçš„æ–‡æœ¬è¾“å‡ºåˆ°ä¸€ä¸ªè¾“å‡ºè¿­ä»£å™¨ä¸­ï¼Œ
    // å…¶ä»–ä¸formatä¸€è‡´ï¼Œè¿™æ ·å¯ä»¥å…¼å®¹æ ‡å‡†STLç®—æ³•å‡½æ•°çš„é£æ ¼ï¼Œ
    // ä¹Ÿä¾¿äºå°†æ–‡æœ¬è¾“å‡ºåˆ°å…¶ä»–çš„æµä¸­æˆ–è€…è‡ªå»ºçš„å­—ç¬¦ä¸²ç±»ä¸­ã€‚
Â Â Â  std::string resultLine1;
Â Â Â  std::format_to(std::back_inserter(resultLine1), "{} + {} = {}", 1, 2, 1 + 2);
Â Â Â  std::cout << resultLine1 << std::endl;

    // format_to_n
    // å°†ç”Ÿæˆçš„æ–‡æœ¬è¾“å‡ºåˆ°ä¸€ä¸ªè¾“å‡ºè¿­ä»£å™¨ä¸­ï¼ŒåŒæ—¶æŒ‡å®šè¾“å‡ºçš„æœ€å¤§å­—ç¬¦æ•°é‡ã€‚
    // å…¶ä»–ä¸formatä¸€è‡´ï¼Œç›¸å½“äºformat_toçš„æ‰©å±•ç‰ˆæœ¬ï¼Œ
    // åœ¨è¾“å‡ºç›®æ ‡æœ‰å­—ç¬¦é™åˆ¶çš„æ—¶å€™éå¸¸æœ‰æ•ˆã€‚
Â Â Â  std::string resultLine2(5, ' ');
Â Â Â  std::format_to_n(resultLine2.begin(), 5, "{} + {} = {}", 1, 2, 1 + 2);
Â Â Â  std::cout << resultLine2 << std::endl;

    // formatted_sizes
    // è·å–ç”Ÿæˆæ–‡æœ¬çš„é•¿åº¦ï¼Œå‚æ•°ä¸formatå®Œå…¨ä¸€è‡´ã€‚
    // 
Â Â Â  auto resultSize = std::formatted_size("{} + {} = {}", 1, 2, 1 + 2);
Â Â Â  std::cout << resultSize << std::endl;

Â Â Â  std::string resultLine3(resultSize, ' ');
Â Â Â  std::format_to(resultLine3.begin(), "{} + {} = {}", 1, 2, 1 + 2);
Â Â Â  std::cout << resultLine3 << std::endl;
}
```

å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸‰ä¸ªå‡½æ•°ä½¿ç”¨æ–¹æ³•åŸºæœ¬å’Œformatæ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚

è¿™é‡Œæˆ‘ä»¬é‡ç‚¹ç•™æ„ä¸€ä¸‹formatted\_sizeã€‚å¦‚æœéƒ¨åˆ†åœºæ™¯éœ€è¦ç”Ÿæˆç‰¹å®šé•¿åº¦çš„è¾“å‡ºç¼“å†²åŒºï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å…ˆé€šè¿‡formatted\_sizeè·å–è¾“å‡ºé•¿åº¦ï¼Œç„¶ååˆ†é…ç‰¹å®šé•¿åº¦ç¼“å†²åŒºï¼Œæœ€åå†è¾“å‡ºã€‚é™¤æ­¤ä»¥å¤–ï¼Œåœ¨åªéœ€è¦è·å–å­—ç¬¦æ•°é‡çš„åœºæ™¯ä¸­ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªå‡½æ•°ã€‚

ä»ä¸Šé¢æ¡ˆä¾‹å¯ä»¥çœ‹åˆ°ï¼Œformatå‡½æ•°çš„åŸºæœ¬ç”¨æ³•ç®€å•æ˜“æ‡‚ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥è®¨è®ºæœ‰å…³formatçš„å…·ä½“ç»†èŠ‚ï¼Œå…ˆä»æ ¼å¼åŒ–å‚æ•°åŒ…å¼€å§‹ã€‚

## æ ¼å¼åŒ–å‚æ•°åŒ…

formatå‡½æ•°ï¼Œå¯ä»¥ç›´æ¥ä»¥å‡½æ•°å‚æ•°å½¢å¼è¿›è¡Œä¼ é€’ã€‚æ­¤å¤–ï¼ŒC++20è¿˜æä¾›äº†format\_argsç›¸å…³æ¥å£ï¼Œå¯ä»¥æŠŠâ€œå¾…æ ¼å¼åŒ–çš„å‚æ•°â€åˆå¹¶æˆä¸€ä¸ªé›†åˆï¼Œé€šè¿‡vformatå‡½æ•°è¿›è¡Œæ–‡æœ¬æ ¼å¼åŒ–ã€‚

ä½ å¯ä»¥ç»“åˆåé¢çš„ä»£ç æ¥ç†è§£ã€‚

```c++
#include <iostream>
#include <format>
#include <string>
#include <cstdint>

int main() {
Â Â Â  std::string resultLine1 = std::vformat("{} * {} = {}", std::make_format_args(
Â Â Â Â Â Â Â  3, 4, 3 * 4
Â Â Â  ));
Â Â Â  std::cout << resultLine1 << std::endl;

Â Â Â  std::format_args args = std::make_format_args(
Â Â Â Â Â Â Â  3, 4, 3 * 4
Â Â Â  );

Â Â Â  std::string resultLine2;
Â Â Â  std::vformat_to(std::back_inserter(resultLine2), "{} * {} = {}", args);
Â Â Â  std::cout << resultLine2 << std::endl;
}
```

é’ˆå¯¹ä¸Šè¿°ä»£ç ä¸­ç”¨åˆ°çš„ç±»å‹å’Œå‡½æ•°ï¼Œæˆ‘ä¾æ¬¡ä¸ºä½ è§£é‡Šä¸€ä¸‹ã€‚

**ç¬¬ä¸€ï¼Œformat\_argsç±»å‹**ï¼Œè¡¨ç¤ºä¸€ä¸ªå¾…æ ¼å¼åŒ–çš„å‚æ•°é›†åˆï¼Œå¯ä»¥åŒ…è£…ä»»æ„ç±»å‹çš„å¾…æ ¼å¼åŒ–å‚æ•°ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯format\_argsä¸­åŒ…è£…çš„å‚æ•°æ˜¯**å¼•ç”¨è¯­ä¹‰**ï¼Œä¹Ÿå°±æ˜¯å¹¶ä¸ä¼šæ‹·è´æˆ–è€…æ‰©å±•åŒ…è£…å‚æ•°çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ‰€ä»¥å¼€å‘è€…éœ€è¦ç¡®ä¿è¢«åŒ…è£…å‚æ•°çš„ç”Ÿå‘½å‘¨æœŸã€‚æ‰€ä»¥ä¸€èˆ¬æ¥è¯´ï¼Œformat\_argsä¹Ÿå°±ç”¨äºæ ¼å¼åŒ–å‡½æ•°çš„å‚æ•°ï¼Œä¸å»ºè®®ç”¨äºå…¶ä»–ç”¨é€”ã€‚

**ç¬¬äºŒï¼Œmake\_format\_argså‡½æ•°**ï¼Œç”¨äºé€šè¿‡ä¸€ç³»åˆ—å‚æ•°æ„å»ºä¸€ä¸ªformat\_argså¯¹è±¡ã€‚ç±»ä¼¼åœ°ï¼Œéœ€è¦æ³¨æ„è¿”å›çš„format\_argsçš„å¼•ç”¨è¯­ä¹‰ã€‚

**ç¬¬ä¸‰ï¼Œvformatå‡½æ•°**ã€‚åŒ…å«ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼ˆå…·ä½“è§„èŒƒä¸formatå‡½æ•°å®Œå…¨ä¸€è‡´ï¼‰å’Œformat\_argså¯¹è±¡ã€‚è¯¥å‡½æ•°ä¼šæ ¹æ®æ ¼å¼åŒ–å­—ç¬¦ä¸²å®šä¹‰å»format\_argså¯¹è±¡ä¸­è·å–ç›¸å…³å‚æ•°å¹¶è¿›è¡Œæ ¼å¼åŒ–è¾“å‡ºï¼Œå…¶ä»–ä¸formatå‡½æ•°æ²¡æœ‰å·®å¼‚ã€‚

**ç¬¬å››ï¼Œvformat\_toå‡½æ•°**ã€‚è¯¥å‡½æ•°ä¸format\_toç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡ä¸€ä¸ªè¾“å‡ºè¿­ä»£å™¨è¿›è¡Œè¾“å‡ºçš„ã€‚å·®å¼‚åœ¨äºï¼Œè¯¥å‡½æ•°æ¥æ”¶çš„â€œå¾…æ ¼å¼åŒ–å‚æ•°â€ï¼Œéœ€è¦é€šè¿‡format\_argså¯¹è±¡è¿›è¡ŒåŒ…è£…ã€‚å› æ­¤ï¼Œvformatå¯ä»¥åœ¨æŸäº›åœºæ™¯ä¸‹æ›¿ä»£formatã€‚è‡³äºå…·ä½“ä½¿ç”¨å“ªä¸ªï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½è¿›è¡Œé€‰æ‹©ã€‚

## æ·±å…¥ç†è§£Formatting

åœ¨äº†è§£äº†Formattingçš„åŸºæœ¬ç”¨æ³•åï¼Œæˆ‘ä»¬æœ‰å¿…è¦æ·±å…¥Formattingçš„ç»†èŠ‚ï¼Œäº†è§£å¦‚ä½•åŸºäºFormattingåº“è¿›è¡Œæ‰©å±•ï¼Œæ¥æ»¡è¶³æˆ‘ä»¬çš„å¤æ‚ä¸šåŠ¡éœ€æ±‚ã€‚

é¦–å…ˆï¼ŒFormattingåº“çš„æ ¸å¿ƒæ˜¯formatterç±»ï¼Œå¯¹äºæ‰€æœ‰å¸Œæœ›ä½¿ç”¨formatè¿›è¡Œæ ¼å¼åŒ–çš„å‚æ•°ç±»å‹æ¥è¯´ï¼Œéƒ½éœ€è¦æŒ‰ç…§çº¦å®šå®ç°formatterç±»çš„ç‰¹åŒ–ç‰ˆæœ¬ã€‚

formatterç±»ä¸»è¦å®Œæˆçš„å·¥ä½œå°±æ˜¯ï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²çš„è§£æã€æ•°æ®çš„å®é™…æ ¼å¼åŒ–è¾“å‡ºã€‚C++20ä¸ºåŸºç¡€ç±»å‹ä¸stringç±»å‹å®šä¹‰äº†æ ‡å‡†çš„formatterã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ç‰¹åŒ–çš„formatteræ¥å®ç°å…¶ä»–ç±»å‹ã€è‡ªå®šä¹‰ç±»å‹çš„æ ¼å¼åŒ–è¾“å‡ºã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æ ‡å‡†formatterçš„æ ¼å¼åŒ–æ ‡å‡†ï¼Œç„¶ååœ¨æ­¤åŸºç¡€ä¸Šå®ç°è‡ªå®šä¹‰formatterã€‚

### æ ‡å‡†æ ¼å¼åŒ–è§„èŒƒ

C++ Formattingçš„æ ‡å‡†æ ¼å¼åŒ–è§„èŒƒï¼Œæ˜¯ä»¥Pythonçš„æ ¼å¼åŒ–è§„èŒƒä¸ºåŸºç¡€çš„ã€‚åŸºæœ¬è¯­æ³•æ˜¯åé¢è¿™æ ·ã€‚

```c++
å¡«å……ä¸å¯¹é½   ç¬¦å·   #   0   å®½åº¦   ç²¾åº¦L   ç±»å‹
```

è¿™é‡Œçš„æ¯ä¸ªå‚æ•°**éƒ½æ˜¯å¯é€‰å‚æ•°**ï¼Œæˆ‘ä»¬è§£é‡Šä¸€ä¸‹è¿™äº›å‚æ•°ã€‚

ç¬¬ä¸€ï¼Œå¡«å……ä¸å¯¹é½ï¼Œç”¨äºè®¾ç½®å¡«å……å­—ç¬¦ä¸å¯¹é½è§„åˆ™ã€‚

è¯¥å‚æ•°åŒ…å«ä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†ä¸ºå¡«å……å­—ç¬¦ï¼Œå¦‚æœæ²¡æœ‰è®¾å®šï¼Œé»˜è®¤ä½¿ç”¨ç©ºæ ¼ä½œä¸ºå¡«å……ã€‚ç¬¬äºŒéƒ¨åˆ†ä¸ºå¡«å……æ•°é‡ä¸å¯¹é½æ–¹å¼ï¼Œå¡«å……æ•°é‡å°±æ˜¯æŒ‡å®šè¾“å‡ºçš„å¡«å……å­—ç¬¦æ•°é‡ï¼Œå¯¹é½æ–¹å¼æŒ‡çš„æ˜¯å¾…æ ¼å¼åŒ–å‚æ•°è¾“å‡ºæ—¶ç›¸å¯¹äºå¡«å……å­—ç¬¦çš„ä½ç½®ã€‚

ç›®å‰ C++ æ”¯æŒä¸‰ç§å¯¹é½æ–¹å¼ï¼Œä½ å¯ä»¥å‚è€ƒåé¢çš„è¡¨æ ¼ã€‚

![](https://static001.geekbang.org/resource/image/ee/7e/ee887f2yy08a36b1fe2fe11a8b56a07e.jpg?wh=3176x1108)

ç¬¬äºŒï¼Œâ€œç¬¦å·â€ â€œ#â€ å’Œâ€œ0â€ï¼Œç”¨äºè®¾å®šæ•°å€¼ç±»å‹çš„å‰ç¼€æ˜¾ç¤ºæ–¹å¼ã€‚æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹çœ‹ã€‚

**â€œç¬¦å·â€å¯ä»¥è®¾ç½®æ•°å­—å‰ç¼€çš„æ­£è´Ÿå·æ˜¾ç¤ºè§„åˆ™ã€‚**éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œâ€œç¬¦å·â€ä¹Ÿä¼šå½±å“infå’Œnançš„æ˜¾ç¤ºæ–¹å¼ã€‚åé¢çš„è¡¨æ ¼åŒ…å«äº†è¿™ä¸‰ç§æƒ…å†µã€‚

![](https://static001.geekbang.org/resource/image/d2/d6/d24728e02404f9bd2fafd91ac8cef7d6.jpg?wh=3184x1107)

**â€œ#â€ ä¼šå¯¹æ•´æ•°å’Œæµ®ç‚¹æ•°æœ‰ä¸åŒæ˜¾ç¤ºè¡Œä¸ºã€‚**

å¦‚æœè¢«æ ¼å¼åŒ–å‚æ•°ä¸ºæ•´æ•°ï¼Œå¹¶ä¸”å°†æ•´æ•°è¾“å‡ºè®¾å®šä¸ºäºŒè¿›åˆ¶ã€å…«è¿›åˆ¶æˆ–åå…­è¿›åˆ¶æ—¶ä¼šåœ¨æ•°å­—å‰æ·»åŠ è¿›åˆ¶å‰ç¼€ï¼Œä¹Ÿå°±æ˜¯0bã€0å’Œ0xã€‚ å¦‚æœè¢«æ ¼å¼åŒ–å‚æ•°ä¸ºæµ®ç‚¹æ•°ï¼Œé‚£ä¹ˆå³ä½¿æµ®ç‚¹æ•°æ²¡æœ‰å°æ•°ä½æ•°ï¼Œä¹Ÿä¼šå¼ºåˆ¶åœ¨æ•°å­—åé¢è¿½åŠ ä¸€ä¸ªå°æ•°ç‚¹ã€‚

**â€œ0â€ ç”¨äºä¸ºæ•°å€¼è¾“å‡ºå¡«å……0ï¼Œå¹¶æ”¯æŒè®¾ç½®å¡«å……ä½æ•°ã€‚**æ¯”å¦‚04å°±ä¼šå¡«å……4ä¸ª0ã€‚

ç¬¬ä¸‰ï¼Œå®½åº¦ä¸ç²¾åº¦ã€‚

å®½åº¦ç”¨äºè®¾ç½®å­—æ®µè¾“å‡ºçš„æœ€å°å®½åº¦ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªåè¿›åˆ¶æ•°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ {} å¼•ç”¨ä¸€ä¸ªå‚æ•°ã€‚

ç²¾åº¦æ˜¯ä¸€ä¸ªä»¥ .ç¬¦å·å¼€å¤´çš„éè´Ÿåè¿›åˆ¶æ•°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡{}å¼•ç”¨ä¸€ä¸ªå‚æ•°ã€‚å¯¹äºæµ®ç‚¹æ•°ï¼Œè¯¥å­—æ®µå¯ä»¥è®¾ç½®å°æ•°ç‚¹çš„æ˜¾ç¤ºä½æ•°ã€‚å¯¹äºå­—ç¬¦ä¸²ï¼Œå¯ä»¥é™åˆ¶å­—ç¬¦ä¸²çš„å­—ç¬¦è¾“å‡ºæ•°é‡ã€‚

å®½åº¦ä¸ç²¾åº¦éƒ½æ”¯æŒé€šè¿‡ {} å¼•ç”¨å‚æ•°ï¼Œæ­¤æ—¶å¦‚æœå‚æ•°ä¸æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼Œåœ¨æ‰§è¡Œformatæ—¶å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

ç¬¬å››ï¼ŒLä¸ç±»å‹ã€‚

Lç”¨äºæŒ‡å®šå‚æ•°ä»¥ç‰¹å®šè¯­è¨€ç¯å¢ƒï¼ˆlocaleï¼‰æ–¹å¼è¾“å‡ºå‚æ•°ã€‚å¦‚æœæ„Ÿå…´è¶£çš„è¯ï¼Œä½ å¯ä»¥å‚è€ƒæ ‡å‡†æ–‡æ¡£æ¥æŸ¥è¯¢æœ‰å…³è¯­è¨€ç¯å¢ƒçš„å…·ä½“è¯´æ˜ã€‚å‚è€ƒæ ‡å‡†æ–‡æ¡£è¶³ä»¥æ¶µç›–è¯­è¨€ç¯å¢ƒçš„é—®é¢˜ï¼Œå› æ­¤ä¸æ˜¯æˆ‘ä»¬è®¨è®ºçš„é‡ç‚¹ã€‚

ç±»å‹é€‰é¡¹ç”¨äºè®¾ç½®å‚æ•°çš„æ˜¾ç¤ºæ–¹å¼ï¼Œæˆ‘åŒæ ·å‡†å¤‡äº†è¡¨æ ¼ï¼Œä¸ºä½ æ¢³ç†äº†C++20æ”¯æŒçš„æ‰€æœ‰å‚æ•°ç±»å‹é€‰é¡¹ã€‚

![](https://static001.geekbang.org/resource/image/be/b7/be6eef92c193ac8339347fab8d2c16b7.jpg?wh=3435x4041)

### è‡ªå®šä¹‰formatter

Formattingåº“ä¸­çš„formatterç±»å‹å¯¹å„ç§ç±»å‹çš„æ ¼å¼åŒ–è¾“å‡ºæ¯•ç«Ÿæ˜¯æœ‰é™çš„â€”â€”å®ƒä¸å¯èƒ½è¦†ç›–æ‰€æœ‰çš„åœºæ™¯ï¼Œç‰¹åˆ«æ˜¯æˆ‘ä»¬çš„è‡ªå®šä¹‰ç±»å‹ã€‚

å› æ­¤ï¼Œå®ƒä¹Ÿæ”¯æŒå¼€å‘è€…å¯¹formatterè¿›è¡Œç‰¹åŒ–ï¼Œå®ç°è‡ªå®šä¹‰çš„æ ¼å¼åŒ–è¾“å‡ºã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•è‡ªå®šä¹‰formatterã€‚

æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªæœ€ç®€å•çš„è‡ªå®šä¹‰formatteræ¡ˆä¾‹ã€‚

```c++
#include <format>
#include <iostream>
#include <vector>
#include <cstdint>
Â 
template<class CharT>
struct std::formatter<std::vector<int32_t>, CharT> : std::formatter<int32_t, CharT> {
Â Â Â  template<class FormatContext>
Â Â Â  auto format(std::vector<int32_t> t, FormatContext& fc) const {
Â Â Â Â Â Â Â  auto it = std::formatter<int32_t, CharT>::format(t.size(), fc);
Â 
Â Â Â Â Â Â Â  for (int32_t v : t) {
Â Â Â Â Â Â Â Â Â Â Â  *it = ' ';
Â Â Â Â Â Â Â Â Â Â Â  it++;
Â 
Â Â Â Â Â Â Â Â Â Â Â  it = std::formatter<int32_t, CharT>::format(v, fc);
Â Â Â Â Â Â Â  }
Â 
Â Â Â Â Â Â Â  return it;
Â Â Â  }
};
Â 
int main() {
Â Â Â  std::vector<int32_t> v = { 1, 2, 3, 4 };
Â 
    // é¦–å…ˆï¼Œè°ƒç”¨formatè¾“å‡ºvectorçš„é•¿åº¦ï¼Œ
    // ç„¶åéå†vectorï¼Œæ¯æ¬¡è¾“å‡ºä¸€ä¸ªç©ºæ ¼åå†è°ƒç”¨formatè¾“å‡ºæ•°å­—ã€‚
Â Â Â  std::cout << std::format("{:#x}", v);
}
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œå®ç°äº†æ ¼å¼åŒ–æ˜¾ç¤ºvector&lt;int32\_t&gt;ç±»å‹çš„å¯¹è±¡çš„åŠŸèƒ½ã€‚æˆ‘ä»¬é‡ç‚¹å…³æ³¨çš„æ˜¯ç¬¬7è¡Œå®ç°çš„formatterç‰¹åŒ–â€”â€”std::formatter&lt;std::vector&lt;int32\_t&gt;, CharT&gt;ã€‚

å…¶ä¸­ï¼ŒCharTè¡¨ç¤ºå­—ç¬¦ç±»å‹ï¼Œå®ƒå¯ä»¥æ ¹æ®ç”¨æˆ·çš„å®é™…æƒ…å†µæ›¿æ¢æˆcharæˆ–è€…wchar\_tç­‰ã€‚

é€šè¿‡ä»£ç ä½ ä¼šå‘ç°ï¼Œæˆ‘ä»¬é‡è½½äº†formatæˆå‘˜å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºæ§åˆ¶æ ¼å¼åŒ–æ˜¾ç¤ºã€‚è¯¥å‡½æ•°åŒ…å«ä¸¤ä¸ªå‚æ•°ã€‚

1. t: std::vector&lt;int32\_t&gt;: è¢«ä¼ å…¥çš„å¾…æ ¼å¼åŒ–å‚æ•°ã€‚
2. fc: FormatContext&amp;: æè¿°æ ¼å¼åŒ–çš„ä¸Šä¸‹æ–‡ã€‚

ä½œä¸ºå»¶ä¼¸é˜…è¯»ï¼Œä½ å¯ä»¥å‚è€ƒstd::basic\_format\_contextè¿™ä¸ªç±»å‹çš„å®šä¹‰ï¼Œäº†è§£æ ¼å¼åŒ–çš„ä¸Šä¸‹æ–‡ä¸­å…·ä½“åŒ…å«çš„ä¿¡æ¯ã€‚å½“ç„¶äº†ï¼Œåœ¨ç¼–ç è¿‡ç¨‹ä¸­ï¼ŒIDEä¹Ÿä¼šåœ¨ä½¿ç”¨å®ƒæ—¶ç»™å‡ºæç¤ºã€‚

formatå‡½æ•°è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œè¡¨ç¤ºä¸‹ä¸€ä¸ªç”¨äºè¾“å‡ºçš„ä½ç½®ï¼Œæˆ‘ä»¬é€šè¿‡æ§åˆ¶è¿™ä¸ªè¿­ä»£å™¨ï¼Œå°±å¯ä»¥è¾“å‡ºè‡ªå·±æƒ³è¦çš„æ ¼å¼åŒ–å­—ç¬¦äº†ã€‚

ç¤ºä¾‹æ²¡æœ‰å®ç°parseæ¥è§£ææ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¦‚æœä½ æœ‰å…´è¶£çš„è¯ï¼Œè¯¾åå¯ä»¥è‡ªè¡Œäº†è§£ç›¸å…³ç»†èŠ‚ã€‚

## æ€»ç»“

ä¼ ç»Ÿçš„æ–‡æœ¬æ ¼å¼åŒ–æ–¹æ¡ˆåŒ…æ‹¬åŸºäºCæ¥å£çš„æ ¼å¼åŒ–è¾“å‡ºã€C++å­—ç¬¦ä¸²æ‹¼æ¥æˆ–C++æµè¿™å‡ ç§æ–¹å¼ã€‚å®ƒä»¬å„æœ‰ä¼˜åŠ£ï¼Œä½†å¾€å¾€éš¾ä»¥è§£å†³ç±»å‹å®‰å…¨ã€ç¼“å†²åŒºæº¢å‡ºã€çº¿ç¨‹å®‰å…¨ç­‰é—®é¢˜ã€‚

C++20çš„æ¨å‡ºæ”¹å˜äº†è¿™ä¸€å±€é¢ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨Formattingåº“å’Œformatterç±»å‹é«˜åº¦çµæ´»åœ°å®ç°æ ¼å¼åŒ–æ–‡æœ¬è¾“å‡ºã€‚å…¶ä¸­formatteræ”¯æŒç‰¹åŒ–ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªå…¨æ–°çš„æ–¹å¼ï¼Œè§£å†³é•¿ä¹…ä»¥æ¥ç¼ºä¹æ ‡å‡†åŒ–çš„æ–‡æœ¬æ ¼å¼åŒ–çš„é—®é¢˜ã€‚

å¯¹äºformatterçš„ç‰¹åŒ–å®ç°ï¼Œæˆ‘ä»¬è®°ä½ä¸¤ä¸ªé‡ç‚¹å³å¯ã€‚

1. é‡è½½formatå‡½æ•°ï¼Œå®ç°è¾“å‡ºè‡ªå·±æƒ³è¦çš„æ ¼å¼åŒ–æ–‡æœ¬ã€‚
2. é‡è½½parseå‡½æ•°ï¼Œå®ç°è‡ªå®šä¹‰æ ¼å¼åŒ–æ–‡æœ¬è§£æã€‚

## è¯¾åæ€è€ƒ

æˆ‘ä»¬åœ¨è¿™ä¸€è®²ä¸­å±•ç¤ºäº†å¦‚ä½•é€šè¿‡é‡è½½formatterä¸­çš„formatå‡½æ•°ï¼Œå®ç°äº†è‡ªå®šä¹‰è¾“å‡ºæ ¼å¼åŒ–æ–‡æœ¬ã€‚é‚£ä¹ˆï¼Œä½ èƒ½å¦è¿›ä¸€æ­¥æ‹“å±•è¿™ä¸€æ¡ˆä¾‹ï¼Œé€šè¿‡é‡è½½parseæ¥å®ç°è§£ææ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Ÿ

æ¬¢è¿ç»™å‡ºä½ çš„ä»£ç æ–¹æ¡ˆã€‚æˆ‘ä»¬ä¸€åŒäº¤æµã€‚ä¸‹ä¸€è®²è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ2ï¼‰</strong></div><ul>
<li><span>æäº‘é¾™</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<p>è¯·æ•™è€å¸ˆä¸€ä¸ªé—®é¢˜ï¼Œä¸‹é¢çš„ä»£ç ç¼–è¯‘ä¸è¿‡ï¼ŒæŠ¥é”™ä¿¡æ¯æ˜¯æ— æ³•æ¨å¯¼ std::formatterçš„æ¨¡ç‰ˆå‚æ•°ï¼Œè¿™æ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿ
#include &lt;format&gt;
#include &lt;iostream&gt;

&#47;&#47; éæ¨¡æ¿ç±»
struct Box1 {
	bool bool_value;
	int int_value;
	const char* str;
};
template &lt;typename _CharT&gt;
struct std::formatter&lt;Box1, _CharT&gt; : std::formatter&lt;bool, _CharT&gt;
{	
	template &lt;typename _FormatContext&gt;
	typename _FormatContext::iterator format(const Box1&amp; v, _FormatContext&amp; format_context)
	{	
		typename _FormatContext::iterator Ite
			= std::formatter&lt;bool, _CharT&gt;::format(v.bool_value, format_context);
		
		return Ite;
	}
};
int main()
{
	Box1 box1{
		.bool_value = false,
		.int_value = 1,
		.str = &quot;box1&quot;
	};
	std::cout &lt;&lt; std::format(&quot;box1 = {}&quot;, box1);

	return 0;
}</p>2024-01-15</li><br/><li><span>å¸¸æŒ¯å</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯´å®è¯ï¼Œè¶Šæ”¹çº¦éš¾ç”¨ï¼ŒC++è¶Šèµ°è¶Šåäº†ã€‚ã€‚ã€‚</p>2023-10-23</li><br/>
</ul>