ä½ å¥½ï¼Œæˆ‘æ˜¯å­”ä»¤é£ã€‚

åœ¨ [**08è®²**](https://time.geekbang.org/column/article/383390) å’Œ [**14è®²**](https://time.geekbang.org/column/article/388920) ï¼Œæˆ‘åˆ†åˆ«ä»‹ç»äº†å¦‚ä½•è®¾è®¡ç ”å‘æµç¨‹ï¼Œå’Œå¦‚ä½•åŸºäº Makefile é«˜æ•ˆåœ°ç®¡ç†é¡¹ç›®ã€‚é‚£ä¹ˆä»Šå¤©ï¼Œæˆ‘ä»¬å°±ä»¥ç ”å‘æµç¨‹ä¸ºä¸»çº¿ï¼Œæ¥çœ‹ä¸‹IAMé¡¹ç›®æ˜¯å¦‚ä½•é€šè¿‡Makefileæ¥é«˜æ•ˆç®¡ç†é¡¹ç›®çš„ã€‚å­¦å®Œè¿™ä¸€è®²ï¼Œä½ ä¸ä»…èƒ½æ›´åŠ æ·±åˆ»åœ°ç†è§£ **08è®²** å’Œ **14è®²** æ‰€ä»‹ç»çš„å†…å®¹ï¼Œè¿˜èƒ½å¾—åˆ°å¾ˆå¤šå¯ä»¥ç›´æ¥ç”¨åœ¨å®é™…æ“ä½œä¸­çš„ç»éªŒã€æŠ€å·§ã€‚

ç ”å‘æµç¨‹æœ‰å¾ˆå¤šé˜¶æ®µï¼Œå…¶ä¸­çš„å¼€å‘é˜¶æ®µå’Œæµ‹è¯•é˜¶æ®µæ˜¯éœ€è¦å¼€å‘è€…æ·±åº¦å‚ä¸çš„ã€‚æ‰€ä»¥åœ¨è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä¼šé‡ç‚¹ä»‹ç»è¿™ä¸¤ä¸ªé˜¶æ®µä¸­çš„Makefileé¡¹ç›®ç®¡ç†åŠŸèƒ½ï¼Œå¹¶ä¸”ç©¿æ’ä¸€äº›æˆ‘çš„Makefileçš„è®¾è®¡æ€è·¯ã€‚

ä¸ºäº†å‘ä½ æ¼”ç¤ºæµç¨‹ï¼Œè¿™é‡Œå…ˆå‡è®¾ä¸€ä¸ªåœºæ™¯ã€‚æˆ‘ä»¬æœ‰ä¸€ä¸ªéœ€æ±‚ï¼šç»™IAMå®¢æˆ·ç«¯å·¥å…·iamctlå¢åŠ ä¸€ä¸ªhelloworldå‘½ä»¤ï¼Œè¯¥å‘½ä»¤å‘ç»ˆç«¯æ‰“å°hello worldã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹å¦‚ä½•å…·ä½“å»æ‰§è¡Œç ”å‘æµç¨‹ä¸­çš„æ¯ä¸€æ­¥ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬è¿›å…¥å¼€å‘é˜¶æ®µã€‚

## å¼€å‘é˜¶æ®µ

å¼€å‘é˜¶æ®µæ˜¯å¼€å‘è€…çš„ä¸»æˆ˜åœºï¼Œå®Œå…¨ç”±å¼€å‘è€…æ¥ä¸»å¯¼ï¼Œå®ƒåˆå¯åˆ†ä¸ºä»£ç å¼€å‘å’Œä»£ç æäº¤ä¸¤ä¸ªå­é˜¶æ®µã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ä»£ç å¼€å‘é˜¶æ®µã€‚

### ä»£ç å¼€å‘

æ‹¿åˆ°éœ€æ±‚ä¹‹åï¼Œé¦–å…ˆéœ€è¦å¼€å‘ä»£ç ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦é€‰æ‹©ä¸€ä¸ªé€‚åˆå›¢é˜Ÿå’Œé¡¹ç›®çš„Gitå·¥ä½œæµã€‚å› ä¸ºGit Flowå·¥ä½œæµæ¯”è¾ƒé€‚åˆå¤§å‹çš„éå¼€æºé¡¹ç›®ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬é€‰æ‹©**Git** **Flowå·¥ä½œæµ**ã€‚ä»£ç å¼€å‘çš„å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

ç¬¬ä¸€æ­¥ï¼ŒåŸºäºdevelopåˆ†æ”¯ï¼Œæ–°å»ºä¸€ä¸ªåŠŸèƒ½åˆ†æ”¯ feature/helloworldã€‚

```
$ git checkout -b feature/helloworld develop
```

**è¿™é‡Œéœ€è¦æ³¨æ„**ï¼šæ–°å»ºçš„branchåè¦ç¬¦åˆGit Flowå·¥ä½œæµä¸­çš„åˆ†æ”¯å‘½åè§„åˆ™ã€‚å¦åˆ™ï¼Œåœ¨git commité˜¶æ®µï¼Œä¼šå› ä¸ºbranchä¸è§„èŒƒå¯¼è‡´commitå¤±è´¥ã€‚IAMé¡¹ç›®çš„åˆ†æ”¯å‘½ä»¤è§„åˆ™å…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://static001.geekbang.org/resource/image/15/79/15bb43219269273baf70a27ea94e1279.png?wh=2775x1250)

IAMé¡¹ç›®é€šè¿‡pre-commit githooksæ¥ç¡®ä¿åˆ†æ”¯åæ˜¯ç¬¦åˆè§„èŒƒçš„ã€‚åœ¨IAMé¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œgit commit å‘½ä»¤ï¼Œgitä¼šè‡ªåŠ¨æ‰§è¡Œ[pre-commit](https://github.com/marmotedu/iam/blob/master/githooks/pre-commit)è„šæœ¬ï¼Œè¯¥è„šæœ¬ä¼šæ£€æŸ¥å½“å‰branchçš„åå­—æ˜¯å¦ç¬¦åˆè§„èŒƒã€‚

è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªåœ°æ–¹éœ€è¦ä½ æ³¨æ„ï¼šgitä¸ä¼šæäº¤ `.git/hooks` ç›®å½•ä¸‹çš„githooksè„šæœ¬ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡ä»¥ä¸‹æ‰‹æ®µï¼Œç¡®ä¿å¼€å‘è€…cloneä»“åº“ä¹‹åï¼Œä»ç„¶èƒ½å®‰è£…æˆ‘ä»¬æŒ‡å®šçš„githooksè„šæœ¬åˆ° `.git/hooks` ç›®å½•ï¼š

```
# Copy githook scripts when execute makefile    
COPY_GITHOOK:=$(shell cp -f githooks/* .git/hooks/) 
```

ä¸Šè¿°ä»£ç æ”¾åœ¨[scripts/make-rules/common.mk](https://github.com/marmotedu/iam/blob/master/scripts/make-rules/common.mk#L74)æ–‡ä»¶ä¸­ï¼Œæ¯æ¬¡æ‰§è¡Œmakeå‘½ä»¤æ—¶éƒ½ä¼šæ‰§è¡Œï¼Œå¯ä»¥ç¡®ä¿githookséƒ½å®‰è£…åˆ° `.git/hooks` ç›®å½•ä¸‹ã€‚

ç¬¬äºŒæ­¥ï¼Œåœ¨feature/helloworldåˆ†æ”¯ä¸­ï¼Œå®Œæˆhelloworldå‘½ä»¤çš„æ·»åŠ ã€‚

é¦–å…ˆï¼Œé€šè¿‡ `iamctl new helloworld` å‘½ä»¤åˆ›å»ºhelloworldå‘½ä»¤æ¨¡æ¿ï¼š

```
$ iamctl new helloworld -d internal/iamctl/cmd/helloworld
Command file generated: internal/iamctl/cmd/helloworld/helloworld.go
```

æ¥ç€ï¼Œç¼–è¾‘`internal/iamctl/cmd/cmd.go`æ–‡ä»¶ï¼Œåœ¨æºç æ–‡ä»¶ä¸­æ·»åŠ `helloworld.NewCmdHelloworld(f, ioStreams),`ï¼ŒåŠ è½½helloworldå‘½ä»¤ã€‚è¿™é‡Œå°†helloworldå‘½ä»¤è®¾ç½®ä¸º`Troubleshooting and Debugging Commands`å‘½ä»¤åˆ†ç»„ï¼š

```
import (
    "github.com/marmotedu/iam/internal/iamctl/cmd/helloworld"
)
        ...
        {
            Message: "Troubleshooting and Debugging Commands:",
            Commands: []*cobra.Command{
                validate.NewCmdValidate(f, ioStreams),
                helloworld.NewCmdHelloworld(f, ioStreams),
            },
        },
```

è¿™äº›æ“ä½œä¸­åŒ…å«äº†low codeçš„æ€æƒ³ã€‚åœ¨ç¬¬ [**10è®²**](https://time.geekbang.org/column/article/384648) ä¸­æˆ‘å°±å¼ºè°ƒè¿‡ï¼Œè¦å°½å¯èƒ½ä½¿ç”¨ä»£ç è‡ªåŠ¨ç”Ÿæˆè¿™ä¸€æŠ€æœ¯ã€‚è¿™æ ·åšæœ‰ä¸¤ä¸ªå¥½å¤„ï¼šä¸€æ–¹é¢èƒ½å¤Ÿæé«˜æˆ‘ä»¬çš„ä»£ç å¼€å‘æ•ˆç‡ï¼›å¦ä¸€æ–¹é¢ä¹Ÿèƒ½å¤Ÿä¿è¯è§„èŒƒï¼Œå‡å°‘æ‰‹åŠ¨æ“ä½œå¯èƒ½å¸¦æ¥çš„é”™è¯¯ã€‚æ‰€ä»¥è¿™é‡Œï¼Œæˆ‘å°†iamctlçš„å‘½ä»¤ä¹Ÿæ¨¡æ¿åŒ–ï¼Œå¹¶é€šè¿‡ `iamctl new` è‡ªåŠ¨ç”Ÿæˆã€‚

ç¬¬ä¸‰æ­¥ï¼Œç”Ÿæˆä»£ç ã€‚

```
$ make gen
```

å¦‚æœæ”¹åŠ¨ä¸æ¶‰åŠä»£ç ç”Ÿæˆï¼Œå¯ä»¥ä¸æ‰§è¡Œ`make gen`æ“ä½œã€‚ `make gen` æ‰§è¡Œçš„å…¶å®æ˜¯gen.runä¼ªç›®æ ‡ï¼š

```
gen.run: gen.clean gen.errcode gen.docgo.doc
```

å¯ä»¥çœ‹åˆ°ï¼Œå½“æ‰§è¡Œ `make gen.run` æ—¶ï¼Œå…¶å®ä¼šå…ˆæ¸…ç†ä¹‹å‰ç”Ÿæˆçš„æ–‡ä»¶ï¼Œå†åˆ†åˆ«è‡ªåŠ¨ç”Ÿæˆerror codeå’Œdoc.goæ–‡ä»¶ã€‚

è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œé€šè¿‡`make gen` ç”Ÿæˆçš„å­˜é‡ä»£ç è¦å…·æœ‰å¹‚ç­‰æ€§ã€‚åªæœ‰è¿™æ ·ï¼Œæ‰èƒ½ç¡®ä¿æ¯æ¬¡ç”Ÿæˆçš„ä»£ç æ˜¯ä¸€æ ·çš„ï¼Œé¿å…ä¸ä¸€è‡´å¸¦æ¥çš„é—®é¢˜ã€‚

æˆ‘ä»¬å¯ä»¥å°†æ›´å¤šçš„ä¸è‡ªåŠ¨ç”Ÿæˆä»£ç ç›¸å…³çš„åŠŸèƒ½æ”¾åœ¨ gen.mk Makefile ä¸­ã€‚ä¾‹å¦‚ï¼š

- gen.docgo.docï¼Œä»£è¡¨è‡ªåŠ¨ç”Ÿæˆdoc.goæ–‡ä»¶ã€‚
- gen.ca.%ï¼Œä»£è¡¨è‡ªåŠ¨ç”Ÿæˆiamctlã€iam-apiserverã€iam-authz-serverè¯ä¹¦æ–‡ä»¶ã€‚

ç¬¬å››æ­¥ï¼Œç‰ˆæƒæ£€æŸ¥ã€‚

å¦‚æœæœ‰æ–°æ–‡ä»¶æ·»åŠ ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‰§è¡Œ `make verify-copyright` ï¼Œæ¥æ£€æŸ¥æ–°æ–‡ä»¶æœ‰æ²¡æœ‰æ·»åŠ ç‰ˆæƒå¤´ä¿¡æ¯ã€‚

```
$ make verify-copyright
```

å¦‚æœç‰ˆæƒæ£€æŸ¥å¤±è´¥ï¼Œå¯ä»¥æ‰§è¡Œ`make add-copyright`è‡ªåŠ¨æ·»åŠ ç‰ˆæƒå¤´ã€‚æ·»åŠ ç‰ˆæƒä¿¡æ¯åªé’ˆå¯¹å¼€æºè½¯ä»¶ï¼Œå¦‚æœä½ çš„è½¯ä»¶ä¸éœ€è¦æ·»åŠ ï¼Œå°±å¯ä»¥ç•¥è¿‡è¿™ä¸€æ­¥ã€‚

è¿™é‡Œè¿˜æœ‰ä¸ªMakefileç¼–å†™æŠ€å·§ï¼šå¦‚æœMakefileçš„commandéœ€è¦æŸä¸ªå‘½ä»¤ï¼Œå°±å¯ä»¥ä½¿è¯¥ç›®æ ‡ä¾èµ–ç±»ä¼¼tools.verify.addlicenseè¿™ç§ç›®æ ‡ï¼Œtools.verify.addlicenseä¼šæ£€æŸ¥è¯¥å·¥å…·æ˜¯å¦å·²å®‰è£…ï¼Œå¦‚æœæ²¡æœ‰å°±å…ˆå®‰è£…ã€‚

```
.PHONY: copyright.verify    
copyright.verify: tools.verify.addlicense 
  ...
tools.verify.%:          
  @if ! which $* &>/dev/null; then $(MAKE) tools.install.$*; fi
.PHONY: install.addlicense                              
install.addlicense:        
  @$(GO) get -u github.com/marmotedu/addlicense
```

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ä½¿ `make copyright.verify` å°½å¯èƒ½è‡ªåŠ¨åŒ–ï¼Œå‡å°‘æ‰‹åŠ¨ä»‹å…¥çš„æ¦‚ç‡ã€‚

ç¬¬äº”æ­¥ï¼Œä»£ç æ ¼å¼åŒ–ã€‚

```
$ make format
```

æ‰§è¡Œ`make format`ä¼šä¾æ¬¡æ‰§è¡Œä»¥ä¸‹æ ¼å¼åŒ–æ“ä½œï¼š

1. è°ƒç”¨gofmtæ ¼å¼åŒ–ä½ çš„ä»£ç ã€‚
2. è°ƒç”¨goimportså·¥å…·ï¼Œè‡ªåŠ¨å¢åˆ ä¾èµ–çš„åŒ…ï¼Œå¹¶å°†ä¾èµ–åŒ…æŒ‰å­—æ¯åºæ’åºå¹¶åˆ†ç±»ã€‚
3. è°ƒç”¨golineså·¥å…·ï¼ŒæŠŠè¶…è¿‡120è¡Œçš„ä»£ç æŒ‰golinesè§„åˆ™ï¼Œæ ¼å¼åŒ–æˆ&lt;120è¡Œçš„ä»£ç ã€‚
4. è°ƒç”¨ `go mod edit -fmt` æ ¼å¼åŒ–go.modæ–‡ä»¶ã€‚

ç¬¬å…­æ­¥ï¼Œé™æ€ä»£ç æ£€æŸ¥ã€‚

```
$ make lint
```

å…³äºé™æ€ä»£ç æ£€æŸ¥ï¼Œåœ¨è¿™é‡Œä½ å¯ä»¥å…ˆäº†è§£ä»£ç å¼€å‘é˜¶æ®µæœ‰è¿™ä¸ªæ­¥éª¤ï¼Œè‡³äºå¦‚ä½•æ“ä½œï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€è®²ç»™ä½ è¯¦ç»†ä»‹ç»ã€‚

ç¬¬ä¸ƒæ­¥ï¼Œå•å…ƒæµ‹è¯•ã€‚

```
$ make test
```

è¿™é‡Œè¦æ³¨æ„ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„åŒ…éƒ½éœ€è¦æ‰§è¡Œå•å…ƒæµ‹è¯•ã€‚ä½ å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤ï¼Œæ’é™¤æ‰ä¸éœ€è¦å•å…ƒæµ‹è¯•çš„åŒ…ï¼š

```
go test `go list ./...|egrep -v $(subst $(SPACE),'|',$(sort $(EXCLUDE_TESTS)))`
```

åœ¨go.testçš„commandä¸­ï¼Œæˆ‘ä»¬è¿˜è¿è¡Œäº†ä»¥ä¸‹å‘½ä»¤ï¼š

```
sed -i '/mock_.*.go/d' $(OUTPUT_DIR)/coverage.out
```

è¿è¡Œè¯¥å‘½ä»¤çš„ç›®çš„ï¼Œæ˜¯æŠŠmock\_.* .goæ–‡ä»¶ä¸­çš„å‡½æ•°å•å…ƒæµ‹è¯•ä¿¡æ¯ä»coverage.outä¸­åˆ é™¤ã€‚mock\_.\*.goæ–‡ä»¶ä¸­çš„å‡½æ•°æ˜¯ä¸éœ€è¦å•å…ƒæµ‹è¯•çš„ï¼Œå¦‚æœä¸åˆ é™¤ï¼Œå°±ä¼šå½±å“åé¢çš„å•å…ƒæµ‹è¯•è¦†ç›–ç‡çš„è®¡ç®—ã€‚

å¦‚æœæƒ³æ£€æŸ¥å•å…ƒæµ‹è¯•è¦†ç›–ç‡ï¼Œè¯·æ‰§è¡Œï¼š

```
$ make cover
```

é»˜è®¤æµ‹è¯•è¦†ç›–ç‡è‡³å°‘ä¸º60%ï¼Œä¹Ÿå¯ä»¥åœ¨å‘½ä»¤è¡ŒæŒ‡å®šè¦†ç›–ç‡é˜ˆå€¼ä¸ºå…¶ä»–å€¼ï¼Œä¾‹å¦‚ï¼š

```
$ make cover COVERAGE=90
```

å¦‚æœæµ‹è¯•è¦†ç›–ç‡ä¸æ»¡è¶³è¦æ±‚ï¼Œå°±ä¼šè¿”å›ä»¥ä¸‹é”™è¯¯ä¿¡æ¯ï¼š

```
test coverage is 62.1%
test coverage does not meet expectations: 90%, please add test cases!
make[1]: *** [go.test.cover] Error 1
make: *** [cover] Error 2
```

è¿™é‡Œmakeå‘½ä»¤çš„é€€å‡ºç ä¸º`1`ã€‚

å¦‚æœå•å…ƒæµ‹è¯•è¦†ç›–ç‡è¾¾ä¸åˆ°è®¾ç½®çš„é˜ˆå€¼ï¼Œå°±éœ€è¦è¡¥å……æµ‹è¯•ç”¨ä¾‹ï¼Œå¦åˆ™ç¦æ­¢åˆå¹¶åˆ°developå’Œmasteråˆ†æ”¯ã€‚IAMé¡¹ç›®é…ç½®äº†GitHub Actions CIè‡ªåŠ¨åŒ–æµæ°´çº¿ï¼ŒCIæµæ°´çº¿ä¼šè‡ªåŠ¨è¿è¡Œï¼Œæ£€æŸ¥å•å…ƒæµ‹è¯•è¦†ç›–ç‡æ˜¯å¦è¾¾åˆ°è¦æ±‚ã€‚

ç¬¬å…«æ­¥ï¼Œæ„å»ºã€‚

æœ€åï¼Œæˆ‘ä»¬æ‰§è¡Œ`make build`å‘½ä»¤ï¼Œæ„å»ºå‡º`cmd/`ç›®å½•ä¸‹æ‰€æœ‰çš„äºŒè¿›åˆ¶å®‰è£…æ–‡ä»¶ã€‚

```
$ make build
```

`make build` ä¼šè‡ªåŠ¨æ„å»º `cmd/` ç›®å½•ä¸‹çš„æ‰€æœ‰ç»„ä»¶ï¼Œå¦‚æœåªæƒ³æ„å»ºå…¶ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªç»„ä»¶ï¼Œå¯ä»¥ä¼ å…¥ `BINS`é€‰é¡¹ï¼Œç»„ä»¶ä¹‹é—´ç”¨ç©ºæ ¼éš”å¼€ï¼Œå¹¶ç”¨åŒå¼•å·å¼•èµ·æ¥ï¼š

```
$ make build BINS="iam-apiserver iamctl"
```

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å®Œæˆäº†ä»£ç å¼€å‘é˜¶æ®µçš„å…¨éƒ¨æ“ä½œã€‚

å¦‚æœä½ è§‰å¾—æ‰‹åŠ¨æ‰§è¡Œçš„makeå‘½ä»¤æ¯”è¾ƒå¤šï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œmakeå‘½ä»¤ï¼š

```
$ make
===========> Generating iam error code go source files
===========> Generating error code markdown documentation
===========> Generating missing doc.go for go packages
===========> Verifying the boilerplate headers for all files
===========> Formating codes
===========> Run golangci to lint source codes
===========> Run unit test
...
===========> Building binary iam-pump v0.7.2-24-g5814e7b for linux amd64
===========> Building binary iamctl v0.7.2-24-g5814e7b for linux amd64
...
```

ç›´æ¥æ‰§è¡Œ`make`ä¼šæ‰§è¡Œä¼ªç›®æ ‡`all`æ‰€ä¾èµ–çš„ä¼ªç›®æ ‡ `all: tidy gen add-copyright format lint cover build`ï¼Œä¹Ÿå³æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼šä¾èµ–åŒ…æ·»åŠ /åˆ é™¤ã€ç”Ÿæˆä»£ç ã€è‡ªåŠ¨æ·»åŠ ç‰ˆæƒå¤´ã€ä»£ç æ ¼å¼åŒ–ã€é™æ€ä»£ç æ£€æŸ¥ã€è¦†ç›–ç‡æµ‹è¯•ã€æ„å»ºã€‚

è¿™é‡Œä½ éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼šallä¸­ä¾èµ–coverï¼Œcoverå®é™…æ‰§è¡Œçš„æ˜¯ `go.test.cover` ï¼Œè€Œ `go.test.cover` åˆä¾èµ– `go.test` ï¼Œæ‰€ä»¥coverå®é™…ä¸Šæ˜¯å…ˆæ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œå†æ£€æŸ¥å•å…ƒæµ‹è¯•è¦†ç›–ç‡æ˜¯å¦æ»¡è¶³é¢„è®¾çš„é˜ˆå€¼ã€‚

æœ€åè¡¥å……ä¸€ç‚¹ï¼Œåœ¨å¼€å‘é˜¶æ®µæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦éšæ—¶æ‰§è¡Œ `make gen` ã€ `make format` ã€ `make lint` ã€ `make cover` ç­‰æ“ä½œï¼Œä¸ºçš„æ˜¯èƒ½å¤Ÿæå‰å‘ç°é—®é¢˜å¹¶æ”¹æ­£ã€‚

### ä»£ç æäº¤

ä»£ç å¼€å‘å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦å°†ä»£ç æäº¤åˆ°è¿œç¨‹ä»“åº“ï¼Œæ•´ä¸ªæµç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ã€‚

ç¬¬ä¸€æ­¥ï¼Œå¼€å‘å®Œåï¼Œå°†ä»£ç æäº¤åˆ°feature/helloworldåˆ†æ”¯ï¼Œå¹¶pushåˆ°è¿œç«¯ä»“åº“ã€‚

```
$ git add internal/iamctl/cmd/helloworld internal/iamctl/cmd/cmd.go
$ git commit -m "feat: add new iamctl command 'helloworld'"
$ git push origin feature/helloworld
```

è¿™é‡Œæˆ‘å»ºè®®ä½ åªæ·»åŠ è·Ÿ`feature/helloworld`ç›¸å…³çš„æ”¹åŠ¨ï¼Œè¿™æ ·å°±çŸ¥é“ä¸€ä¸ªcommitåšäº†å“ªäº›å˜æ›´ï¼Œæ–¹ä¾¿ä»¥åè¿½æº¯ã€‚æ‰€ä»¥ï¼Œæˆ‘ä¸å»ºè®®ç›´æ¥æ‰§è¡Œ`git add .`è¿™ç±»æ–¹å¼æäº¤æ”¹åŠ¨ã€‚

åœ¨æäº¤commitæ—¶ï¼Œcommit-msg githooksä¼šæ£€æŸ¥commit messageæ˜¯å¦ç¬¦åˆAngular Commit Messageè§„èŒƒï¼Œå¦‚æœä¸ç¬¦åˆä¼šæŠ¥é”™ã€‚commit-msageè°ƒç”¨äº†[go-gitlint](https://github.com/llorllale/go-gitlint)æ¥æ£€æŸ¥commit messageã€‚go-gitlintä¼šè¯»å– `.gitlint` ä¸­é…ç½®çš„commit messageæ ¼å¼ï¼š

```
--subject-regex=^((Merge branch.*of.*)|((revert: )?(feat|fix|perf|style|refactor|test|ci|docs|chore)(\(.+\))?: [^A-Z].*[^.]$))
--subject-maxlen=72
--body-regex=^([^\r\n]{0,72}(\r?\n|$))*$
```

IAMé¡¹ç›®é…ç½®äº†GitHub Actionsï¼Œå½“æœ‰ä»£ç è¢«pushåï¼Œä¼šè§¦å‘CIæµæ°´çº¿ï¼Œæµæ°´çº¿ä¼šæ‰§è¡Œ`make all`ç›®æ ‡ã€‚GitHub Actions CIæµç¨‹æ‰§è¡Œè®°å½•å¦‚ä¸‹å›¾ï¼š

![](https://static001.geekbang.org/resource/image/68/22/6819f96bda8dcb214c3b7eeba2f37022.png?wh=2061x435)

å¦‚æœCIä¸é€šè¿‡ï¼Œå°±éœ€è¦ä¿®æ”¹ä»£ç ï¼Œç›´åˆ°CIæµæ°´çº¿é€šè¿‡ä¸ºæ­¢ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹GitHub Actionsçš„é…ç½®ï¼š

```
name: IamCI

on: 
  push:
    branchs:
    - '*'
  pull_request:
    types: [opened, reopened]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.16

    - name: all
      run: make
```

å¯ä»¥çœ‹åˆ°ï¼ŒGitHub Actionså®é™…ä¸Šæ‰§è¡Œäº†3æ­¥ï¼šæ‹‰å–ä»£ç ã€è®¾ç½®Goç¼–è¯‘ç¯å¢ƒã€æ‰§è¡Œmakeå‘½ä»¤ï¼ˆä¹Ÿå°±æ˜¯æ‰§è¡Œ `make all` ç›®æ ‡ï¼‰ã€‚

GitHub Actionsä¹Ÿæ‰§è¡Œäº† `make all` ç›®æ ‡ï¼Œå’Œæ‰‹åŠ¨æ“ä½œæ‰§è¡Œçš„ `make all` ç›®æ ‡ä¿æŒä¸€è‡´ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†è®©çº¿ä¸Šçš„CIæµç¨‹å’Œæœ¬åœ°çš„CIæµç¨‹å®Œå…¨ä¿æŒä¸€è‡´ã€‚è¿™æ ·ï¼Œå½“æˆ‘ä»¬åœ¨æœ¬åœ°æ‰§è¡Œmakeå‘½ä»¤é€šè¿‡åï¼Œåœ¨çº¿ä¸Šä¹Ÿä¼šé€šè¿‡ã€‚ä¿æŒä¸€ä¸ªä¸€è‡´çš„æ‰§è¡Œæµç¨‹å’Œæ‰§è¡Œç»“æœå¾ˆé‡è¦ã€‚å¦åˆ™ï¼Œæœ¬åœ°æ‰§è¡Œmakeé€šè¿‡ï¼Œä½†æ˜¯çº¿ä¸Šå´ä¸é€šè¿‡ï¼Œå²‚ä¸å¾ˆè®©äººå¤´ç–¼ï¼Ÿ

ç¬¬äºŒæ­¥ï¼Œæäº¤pull requestã€‚

ç™»é™†GitHubï¼ŒåŸºäºfeature/helloworldåˆ›å»ºpull requestï¼Œå¹¶æŒ‡å®šReviewersè¿›è¡Œcode reviewã€‚å…·ä½“æ“ä½œå¦‚ä¸‹å›¾ï¼š

![](https://static001.geekbang.org/resource/image/53/ab/53f4103f5c8cabb76ef2fddaec3a54ab.png?wh=1694x733)

å½“æœ‰æ–°çš„pull requestè¢«åˆ›å»ºåï¼Œä¹Ÿä¼šè§¦å‘CIæµæ°´çº¿ã€‚

ç¬¬ä¸‰æ­¥ï¼Œåˆ›å»ºå®Œpull requeståï¼Œå°±å¯ä»¥é€šçŸ¥reviewers æ¥ reviewä»£ç ï¼ŒGitHubä¹Ÿä¼šå‘ç«™å†…ä¿¡ã€‚

ç¬¬å››æ­¥ï¼ŒReviewers å¯¹ä»£ç è¿›è¡Œreviewã€‚

Revieweré€šè¿‡review github diffåçš„å†…å®¹ï¼Œå¹¶ç»“åˆCIæµç¨‹æ˜¯å¦é€šè¿‡æ·»åŠ è¯„è®ºï¼Œå¹¶é€‰æ‹©Commentï¼ˆä»…è¯„è®ºï¼‰ã€Approveï¼ˆé€šè¿‡ï¼‰ã€Request Changesï¼ˆä¸é€šè¿‡ï¼Œéœ€è¦ä¿®æ”¹ï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://static001.geekbang.org/resource/image/39/ce/39d992c7bdb35848706bce792877e8ce.png?wh=2473x1001)

å¦‚æœreviewä¸é€šè¿‡ï¼Œfeatureå¼€å‘è€…å¯ä»¥ç›´æ¥åœ¨feature/helloworldåˆ†æ”¯ä¿®æ­£ä»£ç ï¼Œå¹¶pushåˆ°è¿œç«¯çš„feature/helloworldåˆ†æ”¯ï¼Œç„¶åé€šçŸ¥reviewerså†æ¬¡reviewã€‚å› ä¸ºæœ‰pushäº‹ä»¶å‘ç”Ÿï¼Œæ‰€ä»¥ä¼šè§¦å‘GitHub Actions CIæµæ°´çº¿ã€‚

ç¬¬äº”æ­¥ï¼Œcode reviewé€šè¿‡åï¼Œmaintainerå°±å¯ä»¥å°†æ–°çš„ä»£ç åˆå¹¶åˆ°developåˆ†æ”¯ã€‚

ä½¿ç”¨**Create a merge commit**çš„æ–¹å¼ï¼Œå°†pull requeståˆå¹¶åˆ°developåˆ†æ”¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://static001.geekbang.org/resource/image/30/7d/30de6bb6c8ff431ec56debbc0f5b667d.png?wh=1247x366)

**Create a merge commit**çš„å®é™…æ“ä½œæ˜¯ `git merge --no-ff`ï¼Œfeature/helloworldåˆ†æ”¯ä¸Šæ‰€æœ‰çš„ commit éƒ½ä¼šåŠ åˆ° develop åˆ†æ”¯ä¸Šï¼Œå¹¶ä¸”ä¼šç”Ÿæˆä¸€ä¸ª merge commitã€‚ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå¯ä»¥æ¸…æ™°åœ°çŸ¥é“æ˜¯è°åšäº†å“ªäº›æäº¤ï¼Œå›æº¯å†å²çš„æ—¶å€™ä¹Ÿä¼šæ›´åŠ æ–¹ä¾¿ã€‚

ç¬¬å…­æ­¥ï¼Œåˆå¹¶åˆ°developåˆ†æ”¯åï¼Œè§¦å‘CIæµç¨‹ã€‚

åˆ°è¿™é‡Œï¼Œå¼€å‘é˜¶æ®µçš„æ“ä½œå°±å…¨éƒ¨å®Œæˆäº†ï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/44/73/444b0701f8866b50a49bd0138488c873.png?wh=1697x1028)

åˆå¹¶åˆ°developåˆ†æ”¯ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›å…¥å¼€å‘é˜¶æ®µçš„ä¸‹ä¸€é˜¶æ®µï¼Œä¹Ÿå°±æ˜¯æµ‹è¯•é˜¶æ®µäº†ã€‚

## æµ‹è¯•é˜¶æ®µ

åœ¨æµ‹è¯•é˜¶æ®µï¼Œå¼€å‘äººå‘˜ä¸»è¦è´Ÿè´£æä¾›æµ‹è¯•åŒ…å’Œä¿®å¤æµ‹è¯•æœŸé—´å‘ç°çš„bugï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿå¯èƒ½ä¼šå‘ç°ä¸€äº›æ–°çš„éœ€æ±‚æˆ–å˜åŠ¨ç‚¹ï¼Œæ‰€ä»¥éœ€è¦åˆç†è¯„ä¼°è¿™äº›æ–°çš„éœ€æ±‚æˆ–å˜åŠ¨ç‚¹æ˜¯å¦è¦æ”¾åœ¨å½“å‰è¿­ä»£ä¿®æ”¹ã€‚

æµ‹è¯•é˜¶æ®µçš„æ“ä½œæµç¨‹å¦‚ä¸‹ã€‚

ç¬¬ä¸€æ­¥ï¼ŒåŸºäºdevelopåˆ†æ”¯ï¼Œåˆ›å»ºreleaseåˆ†æ”¯ï¼Œæµ‹è¯•ä»£ç ã€‚

```
$ git checkout -b release/1.0.0 develop
$ make
```

ç¬¬äºŒæ­¥ï¼Œæäº¤æµ‹è¯•ã€‚

å°†release/1.0.0åˆ†æ”¯çš„ä»£ç æäº¤ç»™æµ‹è¯•åŒå­¦è¿›è¡Œæµ‹è¯•ã€‚è¿™é‡Œå‡è®¾ä¸€ä¸ªæµ‹è¯•å¤±è´¥çš„åœºæ™¯ï¼šæˆ‘ä»¬è¦æ±‚æ‰“å°â€œhello worldâ€ï¼Œä½†æ‰“å°çš„æ˜¯â€œHello Worldâ€ï¼Œéœ€è¦ä¿®å¤ã€‚é‚£å…·ä½“åº”è¯¥æ€ä¹ˆæ“ä½œå‘¢ï¼Ÿ

ä½ å¯ä»¥ç›´æ¥åœ¨release/1.0.0åˆ†æ”¯ä¿®æ”¹ä»£ç ï¼Œä¿®æ”¹å®Œæˆåï¼Œæœ¬åœ°æ„å»ºå¹¶æäº¤ä»£ç ï¼š

```
$ make
$ git add internal/iamctl/cmd/helloworld/
$ git commit -m "fix: fix helloworld print bug"
$ git push origin release/1.0.0
```

pushåˆ°release/1.0.0åï¼ŒGitHub Actionsä¼šæ‰§è¡ŒCIæµæ°´çº¿ã€‚å¦‚æœæµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼Œå°±å°†ä»£ç æä¾›ç»™æµ‹è¯•ï¼›å¦‚æœæµ‹è¯•ä¸æˆåŠŸï¼Œå†é‡æ–°ä¿®æ”¹ï¼Œç›´åˆ°æµæ°´çº¿æ‰§è¡ŒæˆåŠŸã€‚

æµ‹è¯•åŒå­¦ä¼šå¯¹release/1.0.0åˆ†æ”¯çš„ä»£ç è¿›è¡Œå……åˆ†çš„æµ‹è¯•ï¼Œä¾‹å¦‚åŠŸèƒ½æµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€é›†æˆæµ‹è¯•ã€ç³»ç»Ÿæµ‹è¯•ç­‰ã€‚

ç¬¬ä¸‰æ­¥ï¼Œæµ‹è¯•é€šè¿‡åï¼Œå°†åŠŸèƒ½åˆ†æ”¯åˆå¹¶åˆ°masteråˆ†æ”¯å’Œdevelopåˆ†æ”¯ã€‚

```
$ git checkout develop
$ git merge --no-ff release/1.0.0
$ git checkout master
$ git merge --no-ff release/1.0.0
$ git tag -a v1.0.0 -m "add print hello world" # masteråˆ†æ”¯æ‰“tag
```

åˆ°è¿™é‡Œï¼Œæµ‹è¯•é˜¶æ®µçš„æ“ä½œå°±åŸºæœ¬å®Œæˆäº†ã€‚æµ‹è¯•é˜¶æ®µçš„äº§ç‰©æ˜¯master/developåˆ†æ”¯çš„ä»£ç ã€‚

ç¬¬å››æ­¥ï¼Œåˆ é™¤feature/helloworldåˆ†æ”¯ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©æ€§åˆ é™¤release/1.0.0åˆ†æ”¯ã€‚

æˆ‘ä»¬çš„ä»£ç éƒ½åˆå¹¶å…¥master/developåˆ†æ”¯åï¼Œfeatureå¼€å‘è€…å¯ä»¥é€‰æ‹©æ˜¯å¦è¦ä¿ç•™featureã€‚ä¸è¿‡ï¼Œå¦‚æœæ²¡æœ‰ç‰¹åˆ«çš„åŸå› ï¼Œæˆ‘å»ºè®®åˆ æ‰ï¼Œå› ä¸ºfeatureåˆ†æ”¯å¤ªå¤šçš„è¯ï¼Œä¸ä»…çœ‹èµ·æ¥å¾ˆä¹±ï¼Œè¿˜ä¼šå½±å“æ€§èƒ½ï¼Œåˆ é™¤æ“ä½œå¦‚ä¸‹ï¼š

```
$ git branch -d feature/helloworld
```

## IAMé¡¹ç›®çš„Makefileé¡¹ç›®ç®¡ç†æŠ€å·§

åœ¨ä¸Šé¢çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬ä»¥ç ”å‘æµç¨‹ä¸ºä¸»çº¿ï¼Œäº²èº«ä½“éªŒäº†IAMé¡¹ç›®çš„Makefileé¡¹ç›®ç®¡ç†åŠŸèƒ½ã€‚è¿™äº›æ˜¯ä½ æœ€åº”è¯¥æŒæ¡çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä½†IAMé¡¹ç›®çš„Makefileè¿˜æœ‰å¾ˆå¤šåŠŸèƒ½å’Œè®¾è®¡æŠ€å·§ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šç»™ä½ åˆ†äº«ä¸€äº›å¾ˆæœ‰ä»·å€¼çš„Makefileé¡¹ç›®ç®¡ç†æŠ€å·§ã€‚

### helpè‡ªåŠ¨è§£æ

å› ä¸ºéšç€é¡¹ç›®çš„æ‰©å±•ï¼ŒMakefileå¤§æ¦‚ç‡ä¼šä¸æ–­åŠ å…¥æ–°çš„ç®¡ç†åŠŸèƒ½ï¼Œè¿™äº›ç®¡ç†åŠŸèƒ½ä¹Ÿéœ€è¦åŠ å…¥åˆ° `make help` è¾“å‡ºä¸­ã€‚ä½†å¦‚æœæ¯æ·»åŠ ä¸€ä¸ªç›®æ ‡ï¼Œéƒ½è¦ä¿®æ”¹ `make help` å‘½ä»¤ï¼Œå°±æ¯”è¾ƒéº»çƒ¦ï¼Œè¿˜å®¹æ˜“å‡ºé”™ã€‚æ‰€ä»¥è¿™é‡Œï¼Œæˆ‘é€šè¿‡è‡ªåŠ¨è§£æçš„æ–¹å¼ï¼Œæ¥ç”Ÿæˆ`make help`è¾“å‡ºï¼š

```
## help: Show this help info.    
.PHONY: help           
help: Makefile               
  @echo -e "\nUsage: make <TARGETS> <OPTIONS> ...\n\nTargets:"                         
  @sed -n 's/^##//p' $< | column -t -s ':' | sed -e 's/^/ /'    
  @echo "$$USAGE_OPTIONS"    
```

ç›®æ ‡helpçš„å‘½ä»¤ä¸­ï¼Œé€šè¿‡ `sed -n 's/^##//p' $< | column -t -s ':' | sed -e 's/^/ /'` å‘½ä»¤ï¼Œè‡ªåŠ¨è§£æMakefileä¸­ `##` å¼€å¤´çš„æ³¨é‡Šè¡Œï¼Œä»è€Œè‡ªåŠ¨ç”Ÿæˆ `make help` è¾“å‡ºã€‚

### Optionsä¸­æŒ‡å®šå˜é‡å€¼

é€šè¿‡ä»¥ä¸‹èµ‹å€¼æ–¹å¼ï¼Œå˜é‡å¯ä»¥åœ¨Makefile optionsä¸­è¢«æŒ‡å®šï¼š

```
ifeq ($(origin COVERAGE),undefined)    
COVERAGE := 60    
endif   
```

ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æ‰§è¡Œ`make` ï¼Œåˆ™COVERAGEè®¾ç½®ä¸ºé»˜è®¤å€¼60ï¼›å¦‚æœæˆ‘ä»¬æ‰§è¡Œ`make COVERAGE=90` ï¼Œåˆ™COVERAGEå€¼ä¸º90ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ›´çµæ´»åœ°æ§åˆ¶Makefileçš„è¡Œä¸ºã€‚

### è‡ªåŠ¨ç”ŸæˆCHANGELOG

ä¸€ä¸ªé¡¹ç›®æœ€å¥½æœ‰CHANGELOGç”¨æ¥å±•ç¤ºæ¯ä¸ªç‰ˆæœ¬ä¹‹é—´çš„å˜æ›´å†…å®¹ï¼Œä½œä¸ºRelease Noteçš„ä¸€éƒ¨åˆ†ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ¯æ¬¡éƒ½è¦æ‰‹åŠ¨ç¼–å†™CHANGELOGï¼Œä¼šå¾ˆéº»çƒ¦ï¼Œä¹Ÿä¸å®¹æ˜“åšæŒï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©[git-chglog](https://github.com/git-chglog/git-chglog)å·¥å…·æ¥è‡ªåŠ¨ç”Ÿæˆã€‚

IAMé¡¹ç›®çš„git-chglogå·¥å…·çš„é…ç½®æ–‡ä»¶æ”¾åœ¨[.chglog](https://github.com/marmotedu/iam/tree/master/.chglog)ç›®å½•ä¸‹ï¼Œåœ¨å­¦ä¹ git-chglogå·¥å…·æ—¶ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹ã€‚

### è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·

ä¸€ä¸ªé¡¹ç›®ä¹Ÿéœ€è¦æœ‰ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œå½“å‰ç”¨å¾—æ¯”è¾ƒå¤šçš„æ˜¯è¯­ä¹‰åŒ–ç‰ˆæœ¬å·è§„èŒƒã€‚ä½†å¦‚æœé å¼€å‘è€…æ‰‹åŠ¨æ‰“ç‰ˆæœ¬å·ï¼Œå·¥ä½œæ•ˆç‡ä½ä¸è¯´ï¼Œç»å¸¸è¿˜ä¼šå‡ºç°æ¼æ‰“ã€æ‰“çš„ç‰ˆæœ¬å·ä¸è§„èŒƒç­‰é—®é¢˜ã€‚æ‰€ä»¥æœ€å¥½çš„åŠæ³•æ˜¯ï¼Œç‰ˆæœ¬å·ä¹Ÿé€šè¿‡å·¥å…·è‡ªåŠ¨ç”Ÿæˆã€‚åœ¨IAMé¡¹ç›®ä¸­ï¼Œé‡‡ç”¨äº†[gsemver](https://github.com/arnaud-deprez/gsemver)å·¥å…·æ¥è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·ã€‚

æ•´ä¸ªIAMé¡¹ç›®çš„ç‰ˆæœ¬å·ï¼Œéƒ½æ˜¯é€šè¿‡[scripts/ensure\_tag.sh](https://github.com/marmotedu/iam/blob/master/scripts/ensure_tag.sh)è„šæœ¬æ¥ç”Ÿæˆçš„ï¼š

```
version=v`gsemver bump`
if [ -z "`git tag -l $version`" ];then
  git tag -a -m "release version $version" $version
fi
```

åœ¨scripts/ensure\_tag.shè„šæœ¬ä¸­ï¼Œé€šè¿‡ `gsemver bump` å‘½ä»¤æ¥è‡ªåŠ¨åŒ–ç”Ÿæˆè¯­ä¹‰åŒ–çš„ç‰ˆæœ¬å·ï¼Œå¹¶æ‰§è¡Œ `git tag -a` ç»™ä»“åº“æ‰“ä¸Šç‰ˆæœ¬å·æ ‡ç­¾ï¼Œ`gsemver` å‘½ä»¤ä¼šæ ¹æ®Commit Messageè‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·ã€‚

ä¹‹åï¼ŒMakefileå’ŒShellè„šæœ¬ç”¨åˆ°çš„æ‰€æœ‰ç‰ˆæœ¬å·å‡ç»Ÿä¸€ä½¿ç”¨[scripts/make-rules/common.mk](https://github.com/marmotedu/iam/blob/v1.0.0/scripts/make-rules/common.mk#L28)æ–‡ä»¶ä¸­çš„VERSIONå˜é‡ï¼š

```
VERSION := $(shell git describe --tags --always --match='v*')
```

ä¸Šè¿°çš„Shellå‘½ä»¤é€šè¿‡ `git describe` æ¥è·å–ç¦»å½“å‰æäº¤æœ€è¿‘çš„tagï¼ˆç‰ˆæœ¬å·ï¼‰ã€‚

åœ¨æ‰§è¡Œ `git describe` æ—¶ï¼Œå¦‚æœç¬¦åˆæ¡ä»¶çš„tagæŒ‡å‘æœ€æ–°æäº¤ï¼Œåˆ™åªæ˜¾ç¤ºtagçš„åå­—ï¼Œå¦åˆ™ä¼šæœ‰ç›¸å…³çš„åç¼€ï¼Œæ¥æè¿°è¯¥tagä¹‹åæœ‰å¤šå°‘æ¬¡æäº¤ï¼Œä»¥åŠæœ€æ–°çš„æäº¤commit idã€‚ä¾‹å¦‚ï¼š

```
$ git describe --tags --always --match='v*'
v1.0.0-3-g1909e47
```

è¿™é‡Œè§£é‡Šä¸‹ç‰ˆæœ¬å·ä¸­å„å­—ç¬¦çš„å«ä¹‰ï¼š

- 3ï¼šè¡¨ç¤ºè‡ªæ‰“tag v1.0.0ä»¥æ¥æœ‰3æ¬¡æäº¤ã€‚
- g1909e47ï¼šg ä¸ºgitçš„ç¼©å†™ï¼Œåœ¨å¤šç§ç®¡ç†å·¥å…·å¹¶å­˜çš„ç¯å¢ƒä¸­å¾ˆæœ‰ç”¨å¤„ã€‚
- 1909e47ï¼š7ä½å­—ç¬¦è¡¨ç¤ºä¸ºæœ€æ–°æäº¤çš„commit id å‰7ä½ã€‚

æœ€åè§£é‡Šä¸‹å‚æ•°ï¼š

- â€“tagsï¼Œä½¿ç”¨æ‰€æœ‰çš„æ ‡ç­¾ï¼Œè€Œä¸æ˜¯åªä½¿ç”¨å¸¦æ³¨é‡Šçš„æ ‡ç­¾ï¼ˆannotated tagï¼‰ã€‚`git tag <tagname>`ç”Ÿæˆä¸€ä¸ª unannotated tagï¼Œ`git tag -a <tagname> -m '<message>'`ç”Ÿæˆä¸€ä¸ª annotated tagã€‚
- â€“alwaysï¼Œå¦‚æœä»“åº“æ²¡æœ‰å¯ç”¨çš„æ ‡ç­¾ï¼Œé‚£ä¹ˆä½¿ç”¨commitç¼©å†™æ¥æ›¿ä»£æ ‡ç­¾ã€‚
- â€“match ï¼Œåªè€ƒè™‘ä¸ç»™å®šæ¨¡å¼ç›¸åŒ¹é…çš„æ ‡ç­¾ã€‚

### ä¿æŒè¡Œä¸ºä¸€è‡´

ä¸Šé¢æˆ‘ä»¬ä»‹ç»äº†ä¸€äº›ç®¡ç†åŠŸèƒ½ï¼Œä¾‹å¦‚æ£€æŸ¥Commit Messageæ˜¯å¦ç¬¦åˆè§„èŒƒã€è‡ªåŠ¨ç”ŸæˆCHANGELOGã€è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·ã€‚è¿™äº›å¯ä»¥é€šè¿‡Makefileæ¥æ“ä½œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œæ£€æŸ¥IAMçš„æ‰€æœ‰Commitæ˜¯å¦ç¬¦åˆAngular Commit Messageè§„èŒƒï¼š

```
$ go-gitlint
b62db1f: subject does not match regex [^(revert: )?(feat|fix|perf|style|refactor|test|ci|docs|chore)(\(.+\))?: [^A-Z].*[^.]$]
```

ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œæ‰‹åŠ¨æ¥ç”ŸæˆCHANGELOGï¼š

```
$ git-chglog v1.0.0 CHANGELOG/CHANGELOG-1.0.0.md
```

è¿˜å¯ä»¥æ‰§è¡Œgsemveræ¥ç”Ÿæˆç‰ˆæœ¬å·ï¼š

```
$ gsemver bump
1.0.1
```

è¿™é‡Œè¦å¼ºè°ƒçš„æ˜¯ï¼Œæˆ‘ä»¬è¦ä¿è¯**ä¸ç®¡ä½¿ç”¨æ‰‹åŠ¨æ“ä½œï¼Œè¿˜æ˜¯é€šè¿‡Makefileæ“ä½œ**ï¼Œéƒ½è¦ç¡®ä¿git commit messageè§„èŒƒæ£€æŸ¥ç»“æœã€ç”Ÿæˆçš„CHANGELOGã€ç”Ÿæˆçš„ç‰ˆæœ¬å·æ˜¯ä¸€è‡´çš„ã€‚è¿™éœ€è¦æˆ‘ä»¬**é‡‡ç”¨åŒä¸€ç§æ“ä½œæ–¹å¼**ã€‚

## æ€»ç»“

åœ¨æ•´ä¸ªç ”å‘æµç¨‹ä¸­ï¼Œéœ€è¦å¼€å‘äººå‘˜æ·±åº¦å‚ä¸çš„é˜¶æ®µæœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯å¼€å‘é˜¶æ®µå’Œæµ‹è¯•é˜¶æ®µã€‚åœ¨å¼€å‘é˜¶æ®µï¼Œå¼€å‘è€…å®Œæˆä»£ç å¼€å‘ä¹‹åï¼Œé€šå¸¸éœ€è¦æ‰§è¡Œç”Ÿæˆä»£ç ã€ç‰ˆæƒæ£€æŸ¥ã€ä»£ç æ ¼å¼åŒ–ã€é™æ€ä»£ç æ£€æŸ¥ã€å•å…ƒæµ‹è¯•ã€æ„å»ºç­‰æ“ä½œã€‚æˆ‘ä»¬å¯ä»¥å°†è¿™äº›æ“ä½œé›†æˆåœ¨Makefileä¸­ï¼Œæ¥æé«˜æ•ˆç‡ï¼Œå¹¶å€Ÿæ­¤ç»Ÿä¸€æ“ä½œã€‚

å¦å¤–ï¼ŒIAMé¡¹ç›®åœ¨ç¼–å†™Makefileæ—¶ä¹Ÿé‡‡ç”¨äº†ä¸€äº›æŠ€å·§ï¼Œä¾‹å¦‚`make help` å‘½ä»¤ä¸­ï¼Œhelpä¿¡æ¯æ˜¯é€šè¿‡è§£æMakefileæ–‡ä»¶çš„æ³¨é‡Šæ¥å®Œæˆçš„ï¼›å¯ä»¥é€šè¿‡git-chglogè‡ªåŠ¨ç”ŸæˆCHANGELOGï¼›é€šè¿‡gsemverè‡ªåŠ¨ç”Ÿæˆè¯­ä¹‰åŒ–çš„ç‰ˆæœ¬å·ç­‰ã€‚

## è¯¾åç»ƒä¹ 

1. çœ‹ä¸‹IAMé¡¹ç›®çš„ `make dependencies` æ˜¯å¦‚ä½•å®ç°çš„ï¼Œè¿™æ ·å®ç°æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ
2. IAMé¡¹ç›®ä¸­ä½¿ç”¨ äº†`gofmt` ã€`goimports` ã€`golines` 3ç§æ ¼å¼åŒ–å·¥å…·ï¼Œæ€è€ƒä¸‹ï¼Œè¿˜æœ‰æ²¡æœ‰å…¶ä»–æ ¼å¼åŒ–å·¥å…·å€¼å¾—é›†æˆåœ¨ `make format` ç›®æ ‡çš„å‘½ä»¤ä¸­ï¼Ÿ

æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„è§è§£ï¼Œå’Œæˆ‘ä¸€èµ·äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>Alery</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>â€œå¦‚æœ review ä¸é€šè¿‡ï¼Œfeature å¼€å‘è€…å¯ä»¥ç›´æ¥åœ¨ feature&#47;helloworld åˆ†æ”¯ä¿®æ­£ä»£ç ï¼Œå¹¶ push åˆ°è¿œç«¯çš„ feature&#47;helloworld åˆ†æ”¯ï¼Œç„¶åé€šçŸ¥ reviewers å†æ¬¡ reviewã€‚å› ä¸ºæœ‰ push äº‹ä»¶å‘ç”Ÿï¼Œæ‰€ä»¥ä¼šè§¦å‘ GitHub Actions CI æµæ°´çº¿ã€‚â€

è¯·é—®ä¿®å¤åçš„ä»£ç æ˜¯ç›´æ¥æ‰§è¡Œgith commit --amendè¿˜æ˜¯é‡æ–°åˆ›å»ºä¸€ä¸ªcommit</p>2021-07-13</li><br/><li><span>daz2yy</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è€å¸ˆå¥½ï¼Œæƒ³é—®ä¸‹ï¼Œæµ‹è¯•é˜¶æ®µè¿‡äº†ä¹‹åï¼Œè¿™ä¸ªç‰¹æ€§å°±èƒ½ç›´æ¥ä¸Šçº¿å—ï¼Ÿè¿˜æ˜¯è¯´ç­‰å¤§å®¶ä¸€èµ·å¼€å‘å®Œè¿™ä¸ªè¿­ä»£å†…å®¹å†ä¸Šçº¿ï¼Ÿ
å¦å¤–ï¼Œåç«¯å¼€å‘è¿™é‡Œç»å¸¸ä¼šè®¾è®¡ SQL çš„å˜åŠ¨ï¼Œä¸€ç§æ˜¯æ•°æ®å˜åŠ¨ï¼Œä¸€ç§æ˜¯ç»“æ„å˜åŠ¨ï¼Œè€å¸ˆè¿™å—æ€ä¹ˆå»ç®¡ç†çš„å‘¢ï¼Ÿè¿˜æœ‰å¦‚ä½•é›†æˆåˆ°ç‰¹æ€§ç ”å‘æµç¨‹é‡Œçš„å‘¢ï¼Ÿ</p>2021-06-29</li><br/><li><span>helloworld</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>releaseåˆ†æ”¯æ˜¯ä»developåˆ†æ”¯æ¥çš„ï¼Œå¦‚æœæµ‹è¯•ç›´æ¥é€šè¿‡ï¼Œæ²¡æœ‰åšè¿›ä¸€æ­¥ä¿®æ”¹ï¼Œå°±ä¸ç”¨å†åˆå¹¶åˆ°developåˆ†æ”¯äº†å§ï¼Œç›´æ¥åˆå¹¶åˆ°masteråˆ†æ”¯å°±å¯ä»¥äº†å§ï¼Œè¿™æ ·ç†è§£å¯¹ä¸å¯¹å‘¢</p>2021-06-29</li><br/><li><span>Geek_6bdb4e</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>æˆ‘æ¥å›ç­”ä¸€ä¸‹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šmake dependenciesä¼šæ‰§è¡Œdependencies.runï¼Œè¿›è€Œæ‰§è¡Œ1. dependencies.packagesï¼Œè¿™ä¸ªæ˜¯å¯¹ä»£ç æœ¬èº«ä¾èµ–çš„packagesè¿›è¡Œç®¡ç†ï¼Œ2. dependencies.toolsï¼Œè¿™ä¸ªæ˜¯å¯¹é¡¹ç›®æœ¬èº«ä¾èµ–çš„ä¸€äº›å·¥å…·è¿›è¡Œæ£€æŸ¥å’Œç®¡ç†ï¼Œå…¶ä¸­åˆæ ¹æ®é‡è¦ç­‰çº§åŒºåˆ†ä¸ºblockerå’Œcriticalä»¥åŠtrivialï¼Œç¼ºå¤±blockerå¯èƒ½å¯¼è‡´CIæµç¨‹å¤±è´¥ï¼Œç¼ºå¤±criticalå¯èƒ½å¯¼è‡´makeçš„ä¸€äº›ç¯èŠ‚å¤±è´¥ï¼Œtiivialæ˜¯å¯é€‰çš„å·¥å…·ï¼Œç¼ºå¤±æ²¡æœ‰ä»»ä½•å½±å“ã€‚æˆ‘æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œè¿™ä¸ªmake dependenciesçš„è°ƒç”¨æ—¶æœºæ˜¯ä»€ä¹ˆæ—¶å€™ï¼Œå‘ç°åªæœ‰é€šè¿‡make dependenciesæ—¶å€™æ‰ä¼šè°ƒç”¨ï¼Œä¸ºä»€ä¹ˆä¸æŠŠè¿™æ¡æ”¾åˆ°make allçš„ä¾èµ–é¡¹é‡Œé¢å‘¢</p>2022-04-02</li><br/><li><span>å¾è•´</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æµ‹è¯•å®Œæˆçš„tagåº”è¯¥æ‰“åœ¨masterä¸Šï¼Œè¿˜æ˜¯releaseåˆ†æ”¯å¯¹åº”çš„commitä¸Šå‘¢ï¼Ÿmasterä¸Šåº”è¯¥è¿˜æœ‰å…¶å®ƒæ²¡æœ‰æµ‹è¯•çš„åŠŸèƒ½å§ï¼Ÿ</p>2021-08-05</li><br/><li><span>H.xu</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>[going@192 iam]$ make test
===========&gt; Run unit test
found packages example (doc.go) and main (example.go) in &#47;home&#47;going&#47;workspace&#47;golang&#47;src&#47;github.com&#47;marmotedu&#47;iam&#47;pkg&#47;rollinglog&#47;example
found packages example (doc.go) and main (example.go) in &#47;home&#47;going&#47;workspace&#47;golang&#47;src&#47;github.com&#47;marmotedu&#47;iam&#47;pkg&#47;validator&#47;example
no Go files in &#47;home&#47;going&#47;workspace&#47;golang&#47;src&#47;github.com&#47;marmotedu&#47;iam
make[1]: *** [scripts&#47;make-rules&#47;golang.mk:81: go.test] Error 1
make: *** [Makefile:108: test] Error 2
è¿™ä¸ªé”™è¯¯æ˜¯ä»€ä¹ˆåŸå› çš„å‘€</p>2022-05-02</li><br/><li><span>ğŸŒ¿å°æ¯’è‰</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¦‚ä½•ä¿è¯â€œé€šè¿‡make gen ç”Ÿæˆçš„å­˜é‡ä»£ç è¦å…·æœ‰å¹‚ç­‰æ€§â€ï¼Œ å¦‚ä½•æµ‹è¯•ï¼Ÿ</p>2022-04-27</li><br/><li><span>æ±Ÿå±±æœª</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ ¹æ®ç¬¦åˆè§„èŒƒçš„commit message ç”Ÿæˆç‰ˆæœ¬å·ï¼Œè¿™é‡Œæœ‰ä¸ªç–‘é—®
æ˜¯ä¸€æ¬¡commitä¼šæ»šåŠ¨ä¸€æ¬¡æ•°å­—å—ï¼Ÿå› ä¸ºä¸€ä¸ªç‰ˆæœ¬å¯èƒ½åŒ…å«å¤šä¸ªfeatureï¼Œfeature aæœ‰ä¸€æ¬¡commitï¼Œfeature bæœ‰ä¸€æ¬¡commitï¼Œä½†å®ƒä»¬éƒ½å±äºè¿™æ¬¡çš„ç‰ˆæœ¬æ›´æ–°ã€‚é‚£ä¼šé€ æˆ minor version +2 å—</p>2021-12-22</li><br/><li><span>yandongxiao</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ€»ç»“ï¼šè¿™äº›æ­¥éª¤åº”è¯¥æ˜¯å¼€å‘è€…ç»å¸¸é‡åˆ°çš„ã€‚
å¼€å‘é˜¶æ®µï¼šæ‰§è¡Œ make allï¼Œæœ¬åœ°èµ°ä¸€éCIæµç¨‹ã€‚åŒ…æ‹¬ï¼Œè‡ªåŠ¨ç”Ÿæˆéƒ¨åˆ†ä»£ç æˆ–æ–‡æ¡£ã€é™æ€ä»£ç æ£€æŸ¥ã€ä»£ç æ ¼å¼åŒ–ã€æ„å»ºç­‰ã€‚
æäº¤é˜¶æ®µï¼šæ£€æŸ¥ commit message æ˜¯å¦ç¬¦åˆ angular è§„èŒƒï¼›åœ¨ push commit &#47; pull request &#47; merge to develop ç‚¹ï¼Œè§¦å‘ CI æµç¨‹ã€‚æ‰€ä»¥ï¼Œå¼€å‘è€…è¦æœ‰åœ¨æœ¬åœ°è·‘CIçš„æ–¹æ³•ã€‚
æµ‹è¯•é˜¶æ®µï¼šæŒ‰ç…§ Git Flow çš„åŸåˆ™ï¼Œåˆ›å»ºå‡º release åˆ†æ”¯ï¼Œå¯¹ä»£ç è¿›è¡Œæµ‹è¯•ã€‚</p>2021-11-27</li><br/><li><span>lesserror</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>å­”è€æ¿ï¼Œèƒ½å¤§è‡´è¯´è¯´ï¼šIAM é¡¹ç›®çš„åˆ†æ”¯å‘½ä»¤è§„åˆ™å›¾æ€ä¹ˆè§£è¯»å—ï¼Ÿ

ä¸»è¦ç¡®è®¤ä¸€ä¸‹å’Œæˆ‘ç†è§£çš„æ˜¯å¦ç›¸åŒã€‚</p>2021-10-01</li><br/><li><span>é™ˆéº’æ–‡</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¿™ä¹ˆå¤šçš„çŸ¥è¯†ç‚¹ï¼Œä»å“ªå¼€å§‹å…¥æ‰‹æ¯”è¾ƒèƒ½è·Ÿä¸Šå¤§ä½¬çš„èŠ‚å¥ï¼Ÿ</p>2021-08-17</li><br/><li><span>ç‹éª¥</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>æ‰§è¡Œmake å¤±è´¥ï¼Œno such linter cyclop

[going@dev iam]$ make
===========&gt; Generating iam error code go source files
===========&gt; Generating error code markdown documentation
===========&gt; Generating missing doc.go for go packages
===========&gt; Formating codes
===========&gt; Run golangci to lint source codes
ERRO Running error: no such linter cyclop, run &#39;golangci-lint linters&#39; to see the list of supported linters
make[1]: *** [scripts&#47;make-rules&#47;golang.mk:76: go.lint] Error 3
make: *** [Makefile:101: lint] Error 2
[going@dev iam]$ go version
go version go1.16.2 linux&#47;amd64
[going@dev iam]$ golangci-lint version
golangci-lint has version v1.28.4-0.20200719134607-6a689074bf17 built from (unknown, mod sum: &quot;h1:LlCfXb0ozr7UL4sgH7UbR2Rt2eSjQE&#47;1zcIeWTu7ypk=&quot;) on (unknown)</p>2021-07-31</li><br/><li><span>Geek_4c902b</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œæ‚¨å¥½ï¼š
iamctl new helloworld  è¿™ä¸ªiamctl å‘½ä»¤å“ªæ¥çš„å‘€</p>2021-06-29</li><br/><li><span>å°è¾¾</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>iamctl new helloworld -d internal&#47;iamctl&#47;cmd&#47;helloworldè¿™ä¸ªåœ¨å“ªä¸ªç›®å½•ä¸‹æ‰§è¡Œå‘¢</p>2022-04-25</li><br/><li><span>CSB22</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>Markä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼šMaintainer å¤„ç† pull request å†²çªåˆå¹¶ã€‚https:&#47;&#47;blog.csdn.net&#47;danchenziDCZ&#47;article&#47;details&#47;81061989</p>2022-03-04</li><br/>
</ul>