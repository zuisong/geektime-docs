ä½ å¥½ï¼Œæˆ‘æ˜¯å­”ä»¤é£ï¼Œä»Šå¤©æˆ‘ä»¬æ¥èŠèŠGoé¡¹ç›®å¼€å‘ä¸­å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ã€‚

åœ¨è½¯ä»¶å¼€å‘ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°å„ç§å„æ ·çš„ç¼–ç åœºæ™¯ï¼Œè¿™äº›åœºæ™¯å¾€å¾€é‡å¤å‘ç”Ÿï¼Œå› æ­¤å…·æœ‰å…¸å‹æ€§ã€‚é’ˆå¯¹è¿™äº›å…¸å‹åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±ç¼–ç è§£å†³ï¼Œä¹Ÿå¯ä»¥é‡‡å–æ›´ä¸ºçœæ—¶çœåŠ›çš„æ–¹å¼ï¼šç›´æ¥é‡‡ç”¨è®¾è®¡æ¨¡å¼ã€‚

è®¾è®¡æ¨¡å¼æ˜¯å•¥å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œå°±æ˜¯å°†è½¯ä»¶å¼€å‘ä¸­éœ€è¦é‡å¤æ€§è§£å†³çš„ç¼–ç åœºæ™¯ï¼ŒæŒ‰æœ€ä½³å®è·µçš„æ–¹å¼æŠ½è±¡æˆä¸€ä¸ªæ¨¡å‹ï¼Œæ¨¡å‹æè¿°çš„è§£å†³æ–¹æ³•å°±æ˜¯è®¾è®¡æ¨¡å¼ã€‚ä½¿ç”¨è®¾è®¡æ¨¡å¼ï¼Œå¯ä»¥ä½¿ä»£ç æ›´æ˜“äºç†è§£ï¼Œä¿è¯ä»£ç çš„é‡ç”¨æ€§å’Œå¯é æ€§ã€‚

åœ¨è½¯ä»¶é¢†åŸŸï¼ŒGoFï¼ˆå››äººå¸®ï¼Œå…¨æ‹¼ Gang of Fourï¼‰é¦–æ¬¡ç³»ç»ŸåŒ–æå‡ºäº†3å¤§ç±»ã€å…±25ç§å¯å¤ç”¨çš„ç»å…¸è®¾è®¡æ–¹æ¡ˆï¼Œæ¥è§£å†³å¸¸è§çš„è½¯ä»¶è®¾è®¡é—®é¢˜ï¼Œä¸ºå¯å¤ç”¨è½¯ä»¶è®¾è®¡å¥ å®šäº†ä¸€å®šçš„ç†è®ºåŸºç¡€ã€‚

ä»æ€»ä½“ä¸Šè¯´ï¼Œè¿™äº›è®¾è®¡æ¨¡å¼å¯ä»¥åˆ†ä¸ºåˆ›å»ºå‹æ¨¡å¼ã€ç»“æ„å‹æ¨¡å¼ã€è¡Œä¸ºå‹æ¨¡å¼3å¤§ç±»ï¼Œç”¨æ¥å®Œæˆä¸åŒçš„åœºæ™¯ã€‚è¿™ä¸€è®²ï¼Œæˆ‘ä¼šä»‹ç»å‡ ä¸ªåœ¨Goé¡¹ç›®å¼€å‘ä¸­æ¯”è¾ƒå¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ï¼Œå¸®åŠ©ä½ ç”¨æ›´åŠ ç®€å•å¿«æ·çš„æ–¹æ³•åº”å¯¹ä¸åŒçš„ç¼–ç åœºæ™¯ã€‚å…¶ä¸­ï¼Œç®€å•å·¥å‚æ¨¡å¼ã€æŠ½è±¡å·¥å‚æ¨¡å¼å’Œå·¥å‚æ–¹æ³•æ¨¡å¼éƒ½å±äºå·¥å‚æ¨¡å¼ï¼Œæˆ‘ä¼šæŠŠå®ƒä»¬æ”¾åœ¨ä¸€èµ·è®²è§£ã€‚

![](https://static001.geekbang.org/resource/image/98/20/98fb0ecb8ba65bc83f25bb2504e51d20.png?wh=3142x1613)

## åˆ›å»ºå‹æ¨¡å¼

é¦–å…ˆæ¥çœ‹åˆ›å»ºå‹æ¨¡å¼ï¼ˆCreational Patternsï¼‰ï¼Œå®ƒæä¾›äº†ä¸€ç§**åœ¨åˆ›å»ºå¯¹è±¡çš„åŒæ—¶éšè—åˆ›å»ºé€»è¾‘**çš„æ–¹å¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ new è¿ç®—ç¬¦ç›´æ¥å®ä¾‹åŒ–å¯¹è±¡ã€‚

è¿™ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼é‡Œï¼Œå•ä¾‹æ¨¡å¼å’Œå·¥å‚æ¨¡å¼ï¼ˆå…·ä½“åŒ…æ‹¬ç®€å•å·¥å‚æ¨¡å¼ã€æŠ½è±¡å·¥å‚æ¨¡å¼å’Œå·¥å‚æ–¹æ³•æ¨¡å¼ä¸‰ç§ï¼‰åœ¨Goé¡¹ç›®å¼€å‘ä¸­æ¯”è¾ƒå¸¸ç”¨ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹å•ä¾‹æ¨¡å¼ã€‚

### å•ä¾‹æ¨¡å¼

å•ä¾‹æ¨¡å¼ï¼ˆSingleton Patternï¼‰ï¼Œæ˜¯**æœ€ç®€å•çš„ä¸€ä¸ªæ¨¡å¼**ã€‚åœ¨Goä¸­ï¼Œå•ä¾‹æ¨¡å¼æŒ‡çš„æ˜¯å…¨å±€åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶ä¸”å®ƒè´Ÿè´£åˆ›å»ºè‡ªå·±çš„å¯¹è±¡ã€‚å•ä¾‹æ¨¡å¼ä¸ä»…æœ‰åˆ©äºå‡å°‘å†…å­˜å¼€æ”¯ï¼Œè¿˜æœ‰å‡å°‘ç³»ç»Ÿæ€§èƒ½å¼€é”€ã€é˜²æ­¢å¤šä¸ªå®ä¾‹äº§ç”Ÿå†²çªç­‰ä¼˜ç‚¹ã€‚

å› ä¸ºå•ä¾‹æ¨¡å¼ä¿è¯äº†å®ä¾‹çš„å…¨å±€å”¯ä¸€æ€§ï¼Œè€Œä¸”åªè¢«åˆå§‹åŒ–ä¸€æ¬¡ï¼Œæ‰€ä»¥æ¯”è¾ƒé€‚åˆ**å…¨å±€å…±äº«ä¸€ä¸ªå®ä¾‹ï¼Œä¸”åªéœ€è¦è¢«åˆå§‹åŒ–ä¸€æ¬¡çš„åœºæ™¯**ï¼Œä¾‹å¦‚æ•°æ®åº“å®ä¾‹ã€å…¨å±€é…ç½®ã€å…¨å±€ä»»åŠ¡æ± ç­‰ã€‚

å•ä¾‹æ¨¡å¼åˆåˆ†ä¸º**é¥¿æ±‰æ–¹å¼**å’Œ**æ‡’æ±‰æ–¹å¼**ã€‚é¥¿æ±‰æ–¹å¼æŒ‡å…¨å±€çš„å•ä¾‹å®ä¾‹åœ¨åŒ…è¢«åŠ è½½æ—¶åˆ›å»ºï¼Œè€Œæ‡’æ±‰æ–¹å¼æŒ‡å…¨å±€çš„å•ä¾‹å®ä¾‹åœ¨ç¬¬ä¸€æ¬¡è¢«ä½¿ç”¨æ—¶åˆ›å»ºã€‚ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§å‘½åæ–¹å¼éå¸¸å½¢è±¡åœ°ä½“ç°äº†å®ƒä»¬ä¸åŒçš„ç‰¹ç‚¹ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘å°±æ¥åˆ†åˆ«ä»‹ç»ä¸‹è¿™ä¸¤ç§æ–¹å¼ã€‚å…ˆæ¥çœ‹**é¥¿æ±‰æ–¹å¼**ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªé¥¿æ±‰æ–¹å¼çš„å•ä¾‹æ¨¡å¼ä»£ç ï¼š

```
package singleton

type singleton struct {
}

var ins *singleton = &singleton{}

func GetInsOr() *singleton {
    return ins
}
```

ä½ éœ€è¦æ³¨æ„ï¼Œå› ä¸ºå®ä¾‹æ˜¯åœ¨åŒ…è¢«å¯¼å…¥æ—¶åˆå§‹åŒ–çš„ï¼Œæ‰€ä»¥å¦‚æœåˆå§‹åŒ–è€—æ—¶ï¼Œä¼šå¯¼è‡´ç¨‹åºåŠ è½½æ—¶é—´æ¯”è¾ƒé•¿ã€‚

**æ‡’æ±‰æ–¹å¼æ˜¯å¼€æºé¡¹ç›®ä¸­ä½¿ç”¨æœ€å¤šçš„**ï¼Œä½†å®ƒçš„ç¼ºç‚¹æ˜¯éå¹¶å‘å®‰å…¨ï¼Œåœ¨å®é™…ä½¿ç”¨æ—¶éœ€è¦åŠ é”ã€‚ä»¥ä¸‹æ˜¯æ‡’æ±‰æ–¹å¼ä¸åŠ é”çš„ä¸€ä¸ªå®ç°ï¼š

```
package singleton

type singleton struct {
}

var ins *singleton

func GetInsOr() *singleton {
    if ins == nil {
        ins = &singleton{}
    }
    
    return ins
}
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åˆ›å»ºinsæ—¶ï¼Œå¦‚æœ `ins==nil`ï¼Œå°±ä¼šå†åˆ›å»ºä¸€ä¸ªinså®ä¾‹ï¼Œè¿™æ—¶å€™å•ä¾‹å°±ä¼šæœ‰å¤šä¸ªå®ä¾‹ã€‚

ä¸ºäº†è§£å†³æ‡’æ±‰æ–¹å¼éå¹¶å‘å®‰å…¨çš„é—®é¢˜ï¼Œéœ€è¦å¯¹å®ä¾‹è¿›è¡ŒåŠ é”ï¼Œä¸‹é¢æ˜¯å¸¦æ£€æŸ¥é”çš„ä¸€ä¸ªå®ç°ï¼š

```
import "sync"

type singleton struct {
}

var ins *singleton
var mu sync.Mutex

func GetIns() *singleton {
	if ins == nil {
		mu.Lock()
		if ins == nil {
			ins = &singleton{}
		}
        mu.Unlock()
	}
	return ins
}
```

ä¸Šè¿°ä»£ç åªæœ‰åœ¨åˆ›å»ºæ—¶æ‰ä¼šåŠ é”ï¼Œæ—¢æé«˜äº†ä»£ç æ•ˆç‡ï¼Œåˆä¿è¯äº†å¹¶å‘å®‰å…¨ã€‚

é™¤äº†é¥¿æ±‰æ–¹å¼å’Œæ‡’æ±‰æ–¹å¼ï¼Œåœ¨Goå¼€å‘ä¸­ï¼Œè¿˜æœ‰ä¸€ç§æ›´ä¼˜é›…çš„å®ç°æ–¹å¼ï¼Œæˆ‘å»ºè®®ä½ é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
package singleton

import (
    "sync"
)

type singleton struct {
}

var ins *singleton
var once sync.Once

func GetInsOr() *singleton {
    once.Do(func() {
        ins = &singleton{}
    })
    return ins
}
```

ä½¿ç”¨`once.Do`å¯ä»¥ç¡®ä¿inså®ä¾‹å…¨å±€åªè¢«åˆ›å»ºä¸€æ¬¡ï¼Œonce.Doå‡½æ•°è¿˜å¯ä»¥ç¡®ä¿å½“åŒæ—¶æœ‰å¤šä¸ªåˆ›å»ºåŠ¨ä½œæ—¶ï¼Œåªæœ‰ä¸€ä¸ªåˆ›å»ºåŠ¨ä½œåœ¨è¢«æ‰§è¡Œã€‚

å¦å¤–ï¼ŒIAMåº”ç”¨ä¸­å¤§é‡ä½¿ç”¨äº†å•ä¾‹æ¨¡å¼ï¼Œå¦‚æœä½ æƒ³äº†è§£æ›´å¤šå•ä¾‹æ¨¡å¼çš„ä½¿ç”¨æ–¹å¼ï¼Œå¯ä»¥ç›´æ¥æŸ¥çœ‹IAMé¡¹ç›®ä»£ç ã€‚IAMä¸­å•ä¾‹æ¨¡å¼æœ‰ [GetStoreInsOr](https://github.com/colin404test/iam/blob/IAMTAG/internal/authzserver/store/store.go#L45)ã€[GetEtcdFactoryOr](https://github.com/colin404test/iam/blob/IAMTAG/internal/apiserver/store/etcd/etcd.go#L83)ã€[GetMySQLFactoryOr](https://github.com/colin404test/iam/blob/IAMTAG/internal/apiserver/store/mysql/mysql.go#L55)ã€[GetCacheInsOr](https://github.com/colin404test/iam/blob/IAMTAG/internal/apiserver/api/v1/cache/cache.go#L33)ç­‰ã€‚

### å·¥å‚æ¨¡å¼

å·¥å‚æ¨¡å¼ï¼ˆFactory Patternï¼‰æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„å¸¸ç”¨æ¨¡å¼ã€‚åœ¨Goé¡¹ç›®å¼€å‘ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ä½¿ç”¨å¤šç§ä¸åŒçš„å·¥å‚æ¨¡å¼ï¼Œæ¥ä½¿ä»£ç æ›´ç®€æ´æ˜äº†ã€‚Goä¸­çš„ç»“æ„ä½“ï¼Œå¯ä»¥ç†è§£ä¸ºé¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„ç±»ï¼Œä¾‹å¦‚ Personç»“æ„ä½“ï¼ˆç±»ï¼‰å®ç°äº†Greetæ–¹æ³•ã€‚

```
type Person struct {
  Name string
  Age int
}

func (p Person) Greet() {
  fmt.Printf("Hi! My name is %s", p.Name)
}
```

æœ‰äº†Personâ€œç±»â€ï¼Œå°±å¯ä»¥åˆ›å»ºPersonå®ä¾‹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®€å•å·¥å‚æ¨¡å¼ã€æŠ½è±¡å·¥å‚æ¨¡å¼ã€å·¥å‚æ–¹æ³•æ¨¡å¼è¿™ä¸‰ç§æ–¹å¼ï¼Œæ¥åˆ›å»ºä¸€ä¸ªPersonå®ä¾‹ã€‚

è¿™ä¸‰ç§å·¥å‚æ¨¡å¼ä¸­ï¼Œ**ç®€å•å·¥å‚æ¨¡å¼**æ˜¯æœ€å¸¸ç”¨ã€æœ€ç®€å•çš„ã€‚å®ƒå°±æ˜¯ä¸€ä¸ªæ¥å—ä¸€äº›å‚æ•°ï¼Œç„¶åè¿”å›Personå®ä¾‹çš„å‡½æ•°ï¼š

```
type Person struct {
  Name string
  Age int
}

func (p Person) Greet() {
  fmt.Printf("Hi! My name is %s", p.Name)
}

func NewPerson(name string, age int) *Person {
  return &Person{
    Name: name,
    Age: age,
  }
}
```

å’Œ`pï¼š=ï¼†Person {}`è¿™ç§åˆ›å»ºå®ä¾‹çš„æ–¹å¼ç›¸æ¯”ï¼Œç®€å•å·¥å‚æ¨¡å¼å¯ä»¥ç¡®ä¿æˆ‘ä»¬åˆ›å»ºçš„å®ä¾‹å…·æœ‰éœ€è¦çš„å‚æ•°ï¼Œè¿›è€Œä¿è¯å®ä¾‹çš„æ–¹æ³•å¯ä»¥æŒ‰é¢„æœŸæ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œé€šè¿‡`NewPerson`åˆ›å»ºPersonå®ä¾‹æ—¶ï¼Œå¯ä»¥ç¡®ä¿å®ä¾‹çš„nameå’Œageå±æ€§è¢«è®¾ç½®ã€‚

å†æ¥çœ‹**æŠ½è±¡å·¥å‚æ¨¡å¼ï¼Œ**å®ƒå’Œç®€å•å·¥å‚æ¨¡å¼çš„å”¯ä¸€åŒºåˆ«ï¼Œå°±æ˜¯å®ƒè¿”å›çš„æ˜¯æ¥å£è€Œä¸æ˜¯ç»“æ„ä½“ã€‚

é€šè¿‡è¿”å›æ¥å£ï¼Œå¯ä»¥**åœ¨ä½ ä¸å…¬å¼€å†…éƒ¨å®ç°çš„æƒ…å†µä¸‹ï¼Œè®©è°ƒç”¨è€…ä½¿ç”¨ä½ æä¾›çš„å„ç§åŠŸèƒ½**ï¼Œä¾‹å¦‚ï¼š

```
type Person interface {
  Greet()
}

type person struct {
  name string
  age int
}

func (p person) Greet() {
  fmt.Printf("Hi! My name is %s", p.name)
}

// Here, NewPerson returns an interface, and not the person struct itself
func NewPerson(name string, age int) Person {
  return person{
    name: name,
    age: age,
  }
}
```

ä¸Šé¢è¿™ä¸ªä»£ç ï¼Œå®šä¹‰äº†ä¸€ä¸ªä¸å¯å¯¼å‡ºçš„ç»“æ„ä½“`person`ï¼Œåœ¨é€šè¿‡NewPersonåˆ›å»ºå®ä¾‹çš„æ—¶å€™è¿”å›çš„æ˜¯æ¥å£ï¼Œè€Œä¸æ˜¯ç»“æ„ä½“ã€‚

é€šè¿‡è¿”å›æ¥å£ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥**å®ç°å¤šä¸ªå·¥å‚å‡½æ•°ï¼Œæ¥è¿”å›ä¸åŒçš„æ¥å£å®ç°**ï¼Œä¾‹å¦‚ï¼š

```
// We define a Doer interface, that has the method signature
// of the `http.Client` structs `Do` method
type Doer interface {
	Do(req *http.Request) (*http.Response, error)
}

// This gives us a regular HTTP client from the `net/http` package
func NewHTTPClient() Doer {
	return &http.Client{}
}

type mockHTTPClient struct{}

func (*mockHTTPClient) Do(req *http.Request) (*http.Response, error) {
	// The `NewRecorder` method of the httptest package gives us
	// a new mock request generator
	res := httptest.NewRecorder()

	// calling the `Result` method gives us
	// the default empty *http.Response object
	return res.Result(), nil
}

// This gives us a mock HTTP client, which returns
// an empty response for any request sent to it
func NewMockHTTPClient() Doer {
	return &mockHTTPClient{}
}
```

`NewHTTPClient`å’Œ`NewMockHTTPClient`éƒ½è¿”å›äº†åŒä¸€ä¸ªæ¥å£ç±»å‹Doerï¼Œè¿™ä½¿å¾—äºŒè€…å¯ä»¥äº’æ¢ä½¿ç”¨ã€‚å½“ä½ æƒ³æµ‹è¯•ä¸€æ®µè°ƒç”¨äº†Doeræ¥å£Doæ–¹æ³•çš„ä»£ç æ—¶ï¼Œè¿™ä¸€ç‚¹ç‰¹åˆ«æœ‰ç”¨ã€‚å› ä¸ºä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªMockçš„HTTPå®¢æˆ·ç«¯ï¼Œä»è€Œé¿å…äº†è°ƒç”¨çœŸå®å¤–éƒ¨æ¥å£å¯èƒ½å¸¦æ¥çš„å¤±è´¥ã€‚

æ¥çœ‹ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æƒ³æµ‹è¯•ä¸‹é¢è¿™æ®µä»£ç ï¼š

```
func QueryUser(doer Doer) error {
	req, err := http.NewRequest("Get", "http://iam.api.marmotedu.com:8080/v1/secrets", nil)
	if err != nil {
		return err
	}

	_, err := doer.Do(req)
	if err != nil {
		return err
	}

	return nil
}
```

å…¶æµ‹è¯•ç”¨ä¾‹ä¸ºï¼š

```
func TestQueryUser(t *testing.T) {
	doer := NewMockHTTPClient()
	if err := QueryUser(doer); err != nil {
		t.Errorf("QueryUser failed, err: %v", err)
	}
}
```

å¦å¤–ï¼Œåœ¨ä½¿ç”¨ç®€å•å·¥å‚æ¨¡å¼å’ŒæŠ½è±¡å·¥å‚æ¨¡å¼è¿”å›å®ä¾‹å¯¹è±¡æ—¶ï¼Œéƒ½å¯ä»¥è¿”å›æŒ‡é’ˆã€‚ä¾‹å¦‚ï¼Œç®€å•å·¥å‚æ¨¡å¼å¯ä»¥è¿™æ ·è¿”å›å®ä¾‹å¯¹è±¡ï¼š

```
return &Person{
  Name: name,
  Age: age
}
```

æŠ½è±¡å·¥å‚æ¨¡å¼å¯ä»¥è¿™æ ·è¿”å›å®ä¾‹å¯¹è±¡ï¼š

```
return &person{
  name: name,
  age: age
}
```

åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘å»ºè®®è¿”å›éæŒ‡é’ˆçš„å®ä¾‹ï¼Œå› ä¸ºæˆ‘ä»¬ä¸»è¦æ˜¯æƒ³é€šè¿‡åˆ›å»ºå®ä¾‹ï¼Œè°ƒç”¨å…¶æä¾›çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯å¯¹å®ä¾‹åšæ›´æ”¹ã€‚å¦‚æœéœ€è¦å¯¹å®ä¾‹åšæ›´æ”¹ï¼Œå¯ä»¥å®ç°`SetXXX`çš„æ–¹æ³•ã€‚é€šè¿‡è¿”å›éæŒ‡é’ˆçš„å®ä¾‹ï¼Œå¯ä»¥ç¡®ä¿å®ä¾‹çš„å±æ€§ï¼Œé¿å…å±æ€§è¢«æ„å¤–/ä»»æ„ä¿®æ”¹ã€‚

åœ¨**ç®€å•å·¥å‚æ¨¡å¼**ä¸­ï¼Œä¾èµ–äºå”¯ä¸€çš„å·¥å‚å¯¹è±¡ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªäº§å“ï¼Œå°±è¦å‘å·¥å‚ä¸­ä¼ å…¥ä¸€ä¸ªå‚æ•°ï¼Œè·å–å¯¹åº”çš„å¯¹è±¡ï¼›å¦‚æœè¦å¢åŠ ä¸€ç§äº§å“ï¼Œå°±è¦åœ¨å·¥å‚ä¸­ä¿®æ”¹åˆ›å»ºäº§å“çš„å‡½æ•°ã€‚è¿™ä¼šå¯¼è‡´è€¦åˆæ€§è¿‡é«˜ï¼Œè¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨**å·¥å‚æ–¹æ³•æ¨¡å¼**ã€‚

åœ¨**å·¥å‚æ–¹æ³•æ¨¡å¼**ä¸­ï¼Œä¾èµ–å·¥å‚å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç°å·¥å‚å‡½æ•°æ¥åˆ›å»ºå¤šç§å·¥å‚ï¼Œå°†å¯¹è±¡åˆ›å»ºä»ç”±ä¸€ä¸ªå¯¹è±¡è´Ÿè´£æ‰€æœ‰å…·ä½“ç±»çš„å®ä¾‹åŒ–ï¼Œå˜æˆç”±ä¸€ç¾¤å­ç±»æ¥è´Ÿè´£å¯¹å…·ä½“ç±»çš„å®ä¾‹åŒ–ï¼Œä»è€Œå°†è¿‡ç¨‹è§£è€¦ã€‚

ä¸‹é¢æ˜¯**å·¥å‚æ–¹æ³•æ¨¡å¼**çš„ä¸€ä¸ªä»£ç å®ç°ï¼š

```
type Person struct {
	name string
	age int
}

func NewPersonFactory(age int) func(name string) Person {
	return func(name string) Person {
		return Person{
			name: name,
			age: age,
		}
	}
}
```

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½æ¥åˆ›å»ºå…·æœ‰é»˜è®¤å¹´é¾„çš„å·¥å‚ï¼š

```
newBaby := NewPersonFactory(1)
baby := newBaby("john")

newTeenager := NewPersonFactory(16)
teen := newTeenager("jill")
```

## ç»“æ„å‹æ¨¡å¼

æˆ‘å·²ç»å‘ä½ ä»‹ç»äº†å•ä¾‹æ¨¡å¼ã€å·¥å‚æ¨¡å¼è¿™ä¸¤ç§åˆ›å»ºå‹æ¨¡å¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ç»“æ„å‹æ¨¡å¼ï¼ˆStructural Patternsï¼‰ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯**å…³æ³¨ç±»å’Œå¯¹è±¡çš„ç»„åˆ**ã€‚è¿™ä¸€ç±»å‹é‡Œï¼Œæˆ‘æƒ³è¯¦ç»†è®²è®²ç­–ç•¥æ¨¡å¼å’Œæ¨¡æ¿æ¨¡å¼ã€‚

### ç­–ç•¥æ¨¡å¼

ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰å®šä¹‰ä¸€ç»„ç®—æ³•ï¼Œå°†æ¯ä¸ªç®—æ³•éƒ½å°è£…èµ·æ¥ï¼Œå¹¶ä¸”ä½¿å®ƒä»¬ä¹‹é—´å¯ä»¥äº’æ¢ã€‚

åœ¨ä»€ä¹ˆæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°ç­–ç•¥æ¨¡å¼å‘¢ï¼Ÿ

åœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸è¦æ ¹æ®ä¸åŒçš„åœºæ™¯ï¼Œé‡‡å–ä¸åŒçš„æªæ–½ï¼Œä¹Ÿå°±æ˜¯ä¸åŒçš„**ç­–ç•¥**ã€‚æ¯”å¦‚ï¼Œå‡è®¾æˆ‘ä»¬éœ€è¦å¯¹aã€b è¿™ä¸¤ä¸ªæ•´æ•°è¿›è¡Œè®¡ç®—ï¼Œæ ¹æ®æ¡ä»¶çš„ä¸åŒï¼Œéœ€è¦æ‰§è¡Œä¸åŒçš„è®¡ç®—æ–¹å¼ã€‚æˆ‘ä»¬å¯ä»¥æŠŠæ‰€æœ‰çš„æ“ä½œéƒ½å°è£…åœ¨åŒä¸€ä¸ªå‡½æ•°ä¸­ï¼Œç„¶åé€šè¿‡ `if ... else ...` çš„å½¢å¼æ¥è°ƒç”¨ä¸åŒçš„è®¡ç®—æ–¹å¼ï¼Œè¿™ç§æ–¹å¼ç§°ä¹‹ä¸º**ç¡¬ç¼–ç **ã€‚

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œéšç€åŠŸèƒ½å’Œä½“éªŒçš„ä¸æ–­å¢é•¿ï¼Œæˆ‘ä»¬éœ€è¦ç»å¸¸æ·»åŠ /ä¿®æ”¹ç­–ç•¥ï¼Œè¿™æ ·å°±éœ€è¦ä¸æ–­ä¿®æ”¹å·²æœ‰ä»£ç ï¼Œä¸ä»…ä¼šè®©è¿™ä¸ªå‡½æ•°è¶Šæ¥è¶Šéš¾ç»´æŠ¤ï¼Œè¿˜å¯èƒ½å› ä¸ºä¿®æ”¹å¸¦æ¥ä¸€äº›bugã€‚æ‰€ä»¥ä¸ºäº†è§£è€¦ï¼Œéœ€è¦ä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼Œå®šä¹‰ä¸€äº›ç‹¬ç«‹çš„ç±»æ¥å°è£…ä¸åŒçš„ç®—æ³•ï¼Œæ¯ä¸€ä¸ªç±»å°è£…ä¸€ä¸ªå…·ä½“çš„ç®—æ³•ï¼ˆå³ç­–ç•¥ï¼‰ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå®ç°ç­–ç•¥æ¨¡å¼çš„ä»£ç ï¼š

```
package strategy

// ç­–ç•¥æ¨¡å¼

// å®šä¹‰ä¸€ä¸ªç­–ç•¥ç±»
type IStrategy interface {
	do(int, int) int
}

// ç­–ç•¥å®ç°ï¼šåŠ 
type add struct{}

func (*add) do(a, b int) int {
	return a + b
}

// ç­–ç•¥å®ç°ï¼šå‡
type reduce struct{}

func (*reduce) do(a, b int) int {
	return a - b
}

// å…·ä½“ç­–ç•¥çš„æ‰§è¡Œè€…
type Operator struct {
	strategy IStrategy
}

// è®¾ç½®ç­–ç•¥
func (operator *Operator) setStrategy(strategy IStrategy) {
	operator.strategy = strategy
}

// è°ƒç”¨ç­–ç•¥ä¸­çš„æ–¹æ³•
func (operator *Operator) calculate(a, b int) int {
	return operator.strategy.do(a, b)
}
```

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ç­–ç•¥æ¥å£ IStrategyï¼Œè¿˜å®šä¹‰äº† add å’Œ reduce ä¸¤ç§ç­–ç•¥ã€‚æœ€åå®šä¹‰äº†ä¸€ä¸ªç­–ç•¥æ‰§è¡Œè€…ï¼Œå¯ä»¥è®¾ç½®ä¸åŒçš„ç­–ç•¥ï¼Œå¹¶æ‰§è¡Œï¼Œä¾‹å¦‚ï¼š

```
func TestStrategy(t *testing.T) {
	operator := Operator{}

	operator.setStrategy(&add{})
	result := operator.calculate(1, 2)
	fmt.Println("add:", result)

	operator.setStrategy(&reduce{})
	result = operator.calculate(2, 1)
	fmt.Println("reduce:", result)
}
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥éšæ„æ›´æ¢ç­–ç•¥ï¼Œè€Œä¸å½±å“Operatorçš„æ‰€æœ‰å®ç°ã€‚

### æ¨¡æ¿æ¨¡å¼

æ¨¡æ¿æ¨¡å¼ (Template Pattern)å®šä¹‰ä¸€ä¸ªæ“ä½œä¸­ç®—æ³•çš„éª¨æ¶ï¼Œè€Œå°†ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ã€‚è¿™ç§æ–¹æ³•è®©å­ç±»åœ¨ä¸æ”¹å˜ä¸€ä¸ªç®—æ³•ç»“æ„çš„æƒ…å†µä¸‹ï¼Œå°±èƒ½é‡æ–°å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚

ç®€å•æ¥è¯´ï¼Œæ¨¡æ¿æ¨¡å¼å°±æ˜¯å°†ä¸€ä¸ªç±»ä¸­èƒ½å¤Ÿå…¬å…±ä½¿ç”¨çš„æ–¹æ³•æ”¾ç½®åœ¨æŠ½è±¡ç±»ä¸­å®ç°ï¼Œå°†ä¸èƒ½å…¬å…±ä½¿ç”¨çš„æ–¹æ³•ä½œä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå¼ºåˆ¶å­ç±»å»å®ç°ï¼Œè¿™æ ·å°±åšåˆ°äº†å°†ä¸€ä¸ªç±»ä½œä¸ºä¸€ä¸ªæ¨¡æ¿ï¼Œè®©å¼€å‘è€…å»å¡«å……éœ€è¦å¡«å……çš„åœ°æ–¹ã€‚

ä»¥ä¸‹æ˜¯æ¨¡æ¿æ¨¡å¼çš„ä¸€ä¸ªå®ç°ï¼š

```
package template

import "fmt"

type Cooker interface {
	fire()
	cooke()
	outfire()
}

// ç±»ä¼¼äºä¸€ä¸ªæŠ½è±¡ç±»
type CookMenu struct {
}

func (CookMenu) fire() {
	fmt.Println("å¼€ç«")
}

// åšèœï¼Œäº¤ç»™å…·ä½“çš„å­ç±»å®ç°
func (CookMenu) cooke() {
}

func (CookMenu) outfire() {
	fmt.Println("å…³ç«")
}

// å°è£…å…·ä½“æ­¥éª¤
func doCook(cook Cooker) {
	cook.fire()
	cook.cooke()
	cook.outfire()
}

type XiHongShi struct {
	CookMenu
}

func (*XiHongShi) cooke() {
	fmt.Println("åšè¥¿çº¢æŸ¿")
}

type ChaoJiDan struct {
	CookMenu
}

func (ChaoJiDan) cooke() {
	fmt.Println("åšç‚’é¸¡è›‹")
}
```

è¿™é‡Œæ¥çœ‹ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š

```
func TestTemplate(t *testing.T) {
	// åšè¥¿çº¢æŸ¿
	xihongshi := &XiHongShi{}
	doCook(xihongshi)

	fmt.Println("\n=====> åšå¦å¤–ä¸€é“èœ")
	// åšç‚’é¸¡è›‹
	chaojidan := &ChaoJiDan{}
	doCook(chaojidan)

}
```

## è¡Œä¸ºå‹æ¨¡å¼

ç„¶åï¼Œè®©æˆ‘ä»¬æ¥çœ‹æœ€åä¸€ä¸ªç±»åˆ«ï¼Œè¡Œä¸ºå‹æ¨¡å¼ï¼ˆBehavioral Patternsï¼‰ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å…³æ³¨**å¯¹è±¡ä¹‹é—´çš„é€šä¿¡**ã€‚è¿™ä¸€ç±»åˆ«çš„è®¾è®¡æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬ä¼šè®²åˆ°ä»£ç†æ¨¡å¼å’Œé€‰é¡¹æ¨¡å¼ã€‚

### ä»£ç†æ¨¡å¼

ä»£ç†æ¨¡å¼ (Proxy Pattern)ï¼Œå¯ä»¥ä¸ºå¦ä¸€ä¸ªå¯¹è±¡æä¾›ä¸€ä¸ªæ›¿èº«æˆ–è€…å ä½ç¬¦ï¼Œä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚

ä»¥ä¸‹ä»£ç æ˜¯ä¸€ä¸ªä»£ç†æ¨¡å¼çš„å®ç°ï¼š

```
package proxy

import "fmt"

type Seller interface {
	sell(name string)
}

// ç«è½¦ç«™
type Station struct {
	stock int //åº“å­˜
}

func (station *Station) sell(name string) {
	if station.stock > 0 {
		station.stock--
		fmt.Printf("ä»£ç†ç‚¹ä¸­ï¼š%sä¹°äº†ä¸€å¼ ç¥¨,å‰©ä½™ï¼š%d \n", name, station.stock)
	} else {
		fmt.Println("ç¥¨å·²å”®ç©º")
	}

}

// ç«è½¦ä»£ç†ç‚¹
type StationProxy struct {
	station *Station // æŒæœ‰ä¸€ä¸ªç«è½¦ç«™å¯¹è±¡
}

func (proxy *StationProxy) sell(name string) {
	if proxy.station.stock > 0 {
		proxy.station.stock--
		fmt.Printf("ä»£ç†ç‚¹ä¸­ï¼š%sä¹°äº†ä¸€å¼ ç¥¨,å‰©ä½™ï¼š%d \n", name, proxy.station.stock)
	} else {
		fmt.Println("ç¥¨å·²å”®ç©º")
	}
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼ŒStationProxyä»£ç†äº†Stationï¼Œä»£ç†ç±»ä¸­æŒæœ‰è¢«ä»£ç†ç±»å¯¹è±¡ï¼Œå¹¶ä¸”å’Œè¢«ä»£ç†ç±»å¯¹è±¡å®ç°äº†åŒä¸€æ¥å£ã€‚

### é€‰é¡¹æ¨¡å¼

é€‰é¡¹æ¨¡å¼ï¼ˆOptions Patternï¼‰ä¹Ÿæ˜¯Goé¡¹ç›®å¼€å‘ä¸­ç»å¸¸ä½¿ç”¨åˆ°çš„æ¨¡å¼ï¼Œä¾‹å¦‚ï¼Œgrpc/grpc-goçš„[NewServer](https://github.com/grpc/grpc-go/blob/v1.37.0/server.go#L514)å‡½æ•°ï¼Œuber-go/zapåŒ…çš„[New](https://github.com/uber-go/zap/blob/v1.16.0/logger.go#L65)å‡½æ•°éƒ½ç”¨åˆ°äº†é€‰é¡¹æ¨¡å¼ã€‚ä½¿ç”¨é€‰é¡¹æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå¸¦æœ‰é»˜è®¤å€¼çš„structå˜é‡ï¼Œå¹¶é€‰æ‹©æ€§åœ°ä¿®æ”¹å…¶ä¸­ä¸€äº›å‚æ•°çš„å€¼ã€‚

åœ¨Pythonè¯­è¨€ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¯ä»¥ç»™å‚æ•°è®¾ç½®é»˜è®¤å€¼ï¼Œè¿™æ ·åœ¨ä¸ä¼ å…¥ä»»ä½•å‚æ•°æ—¶ï¼Œå¯ä»¥è¿”å›æºå¸¦é»˜è®¤å€¼çš„å¯¹è±¡ï¼Œå¹¶åœ¨éœ€è¦æ—¶ä¿®æ”¹å¯¹è±¡çš„å±æ€§ã€‚è¿™ç§ç‰¹æ€§å¯ä»¥å¤§å¤§ç®€åŒ–å¼€å‘è€…åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„æˆæœ¬ï¼Œå°¤å…¶æ˜¯åœ¨å¯¹è±¡æ‹¥æœ‰ä¼—å¤šå±æ€§æ—¶ã€‚

è€Œåœ¨Goè¯­è¨€ä¸­ï¼Œå› ä¸ºä¸æ”¯æŒç»™å‚æ•°è®¾ç½®é»˜è®¤å€¼ï¼Œä¸ºäº†æ—¢èƒ½å¤Ÿåˆ›å»ºå¸¦é»˜è®¤å€¼çš„å®ä¾‹ï¼Œåˆèƒ½å¤Ÿåˆ›å»ºè‡ªå®šä¹‰å‚æ•°çš„å®ä¾‹ï¼Œä¸å°‘å¼€å‘è€…ä¼šé€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹æ³•æ¥å®ç°ï¼š

ç¬¬ä¸€ç§æ–¹æ³•ï¼Œæˆ‘ä»¬è¦åˆ†åˆ«å¼€å‘ä¸¤ä¸ªç”¨æ¥åˆ›å»ºå®ä¾‹çš„å‡½æ•°ï¼Œä¸€ä¸ªå¯ä»¥åˆ›å»ºå¸¦é»˜è®¤å€¼çš„å®ä¾‹ï¼Œä¸€ä¸ªå¯ä»¥å®šåˆ¶åŒ–åˆ›å»ºå®ä¾‹ã€‚

```
package options

import (
	"time"
)

const (
	defaultTimeout = 10
	defaultCaching = false
)

type Connection struct {
	addr    string
	cache   bool
	timeout time.Duration
}

// NewConnect creates a connection.
func NewConnect(addr string) (*Connection, error) {
	return &Connection{
		addr:    addr,
		cache:   defaultCaching,
		timeout: defaultTimeout,
	}, nil
}

// NewConnectWithOptions creates a connection with options.
func NewConnectWithOptions(addr string, cache bool, timeout time.Duration) (*Connection, error) {
	return &Connection{
		addr:    addr,
		cache:   cache,
		timeout: timeout,
	}, nil
}
```

ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œåˆ›å»ºåŒä¸€ä¸ªConnectionå®ä¾‹ï¼Œå´è¦å®ç°ä¸¤ä¸ªä¸åŒçš„å‡½æ•°ï¼Œå®ç°æ–¹å¼å¾ˆä¸ä¼˜é›…ã€‚

å¦å¤–ä¸€ç§æ–¹æ³•ç›¸å¯¹ä¼˜é›…äº›ã€‚æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå¸¦é»˜è®¤å€¼çš„é€‰é¡¹ï¼Œå¹¶ç”¨è¯¥é€‰é¡¹åˆ›å»ºå®ä¾‹ï¼š

```
package options

import (
	"time"
)

const (
	defaultTimeout = 10
	defaultCaching = false
)

type Connection struct {
	addr    string
	cache   bool
	timeout time.Duration
}

type ConnectionOptions struct {
	Caching bool
	Timeout time.Duration
}

func NewDefaultOptions() *ConnectionOptions {
	return &ConnectionOptions{
		Caching: defaultCaching,
		Timeout: defaultTimeout,
	}
}

// NewConnect creates a connection with options.
func NewConnect(addr string, opts *ConnectionOptions) (*Connection, error) {
	return &Connection{
		addr:    addr,
		cache:   opts.Caching,
		timeout: opts.Timeout,
	}, nil
}
```

ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œè™½ç„¶åªéœ€è¦å®ç°ä¸€ä¸ªå‡½æ•°æ¥åˆ›å»ºå®ä¾‹ï¼Œä½†æ˜¯ä¹Ÿæœ‰ç¼ºç‚¹ï¼šä¸ºäº†åˆ›å»ºConnectionå®ä¾‹ï¼Œæ¯æ¬¡æˆ‘ä»¬éƒ½è¦åˆ›å»ºConnectionOptionsï¼Œæ“ä½œèµ·æ¥æ¯”è¾ƒéº»çƒ¦ã€‚

é‚£ä¹ˆæœ‰æ²¡æœ‰æ›´ä¼˜é›…çš„è§£å†³æ–¹æ³•å‘¢ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯æœ‰çš„ï¼Œå°±æ˜¯ä½¿ç”¨é€‰é¡¹æ¨¡å¼æ¥åˆ›å»ºå®ä¾‹ã€‚ä»¥ä¸‹ä»£ç é€šè¿‡é€‰é¡¹æ¨¡å¼å®ç°ä¸Šè¿°åŠŸèƒ½ï¼š

```
package options

import (
	"time"
)

type Connection struct {
	addr    string
	cache   bool
	timeout time.Duration
}

const (
	defaultTimeout = 10
	defaultCaching = false
)

type options struct {
	timeout time.Duration
	caching bool
}

// Option overrides behavior of Connect.
type Option interface {
	apply(*options)
}

type optionFunc func(*options)

func (f optionFunc) apply(o *options) {
	f(o)
}

func WithTimeout(t time.Duration) Option {
	return optionFunc(func(o *options) {
		o.timeout = t
	})
}

func WithCaching(cache bool) Option {
	return optionFunc(func(o *options) {
		o.caching = cache
	})
}

// Connect creates a connection.
func NewConnect(addr string, opts ...Option) (*Connection, error) {
	options := options{
		timeout: defaultTimeout,
		caching: defaultCaching,
	}

	for _, o := range opts {
		o.apply(&options)
	}

	return &Connection{
		addr:    addr,
		cache:   options.caching,
		timeout: options.timeout,
	}, nil
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œé¦–å…ˆæˆ‘ä»¬å®šä¹‰äº†`options`ç»“æ„ä½“ï¼Œå®ƒæºå¸¦äº†timeoutã€cachingä¸¤ä¸ªå±æ€§ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡`NewConnect`åˆ›å»ºäº†ä¸€ä¸ªè¿æ¥ï¼Œ`NewConnect`å‡½æ•°ä¸­å…ˆåˆ›å»ºäº†ä¸€ä¸ªå¸¦æœ‰é»˜è®¤å€¼çš„`options`ç»“æ„ä½“å˜é‡ï¼Œå¹¶é€šè¿‡è°ƒç”¨

```
for _, o := range opts {
    o.apply(&options)
}
```

æ¥ä¿®æ”¹æ‰€åˆ›å»ºçš„`options`ç»“æ„ä½“å˜é‡ã€‚

éœ€è¦ä¿®æ”¹çš„å±æ€§ï¼Œæ˜¯åœ¨`NewConnect`æ—¶ï¼Œé€šè¿‡Optionç±»å‹çš„é€‰é¡¹å‚æ•°ä¼ é€’è¿›æ¥çš„ã€‚å¯ä»¥é€šè¿‡`WithXXX`å‡½æ•°æ¥åˆ›å»ºOptionç±»å‹çš„é€‰é¡¹å‚æ•°ï¼šWithTimeoutã€WithCachingã€‚

Optionç±»å‹çš„é€‰é¡¹å‚æ•°éœ€è¦å®ç°`apply(*options)`å‡½æ•°ï¼Œç»“åˆWithTimeoutã€WithCachingå‡½æ•°çš„è¿”å›å€¼å’ŒoptionFuncçš„applyæ–¹æ³•å®ç°ï¼Œå¯ä»¥çŸ¥é“`o.apply(&options)`å…¶å®å°±æ˜¯æŠŠWithTimeoutã€WithCachingä¼ å…¥çš„å‚æ•°èµ‹å€¼ç»™optionsç»“æ„ä½“å˜é‡ï¼Œä»¥æ­¤åŠ¨æ€åœ°è®¾ç½®optionsç»“æ„ä½“å˜é‡çš„å±æ€§ã€‚

è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå¥½å¤„ï¼šæˆ‘ä»¬å¯ä»¥åœ¨applyå‡½æ•°ä¸­è‡ªå®šä¹‰èµ‹å€¼é€»è¾‘ï¼Œä¾‹å¦‚`o.timeout = 100 * t`ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬ä¼šæœ‰æ›´å¤§çš„çµæ´»æ€§æ¥è®¾ç½®ç»“æ„ä½“çš„å±æ€§ã€‚

é€‰é¡¹æ¨¡å¼æœ‰å¾ˆå¤šä¼˜ç‚¹ï¼Œä¾‹å¦‚ï¼šæ”¯æŒä¼ é€’å¤šä¸ªå‚æ•°ï¼Œå¹¶ä¸”åœ¨å‚æ•°å‘ç”Ÿå˜åŒ–æ—¶ä¿æŒå…¼å®¹æ€§ï¼›æ”¯æŒä»»æ„é¡ºåºä¼ é€’å‚æ•°ï¼›æ”¯æŒé»˜è®¤å€¼ï¼›æ–¹ä¾¿æ‰©å±•ï¼›é€šè¿‡WithXXXçš„å‡½æ•°å‘½åï¼Œå¯ä»¥ä½¿å‚æ•°æ„ä¹‰æ›´åŠ æ˜ç¡®ï¼Œç­‰ç­‰ã€‚

ä¸è¿‡ï¼Œä¸ºäº†å®ç°é€‰é¡¹æ¨¡å¼ï¼Œæˆ‘ä»¬å¢åŠ äº†å¾ˆå¤šä»£ç ï¼Œæ‰€ä»¥åœ¨å¼€å‘ä¸­ï¼Œè¦æ ¹æ®å®é™…åœºæ™¯é€‰æ‹©æ˜¯å¦ä½¿ç”¨é€‰é¡¹æ¨¡å¼ã€‚é€‰é¡¹æ¨¡å¼é€šå¸¸é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š

- ç»“æ„ä½“å‚æ•°å¾ˆå¤šï¼Œåˆ›å»ºç»“æ„ä½“æ—¶ï¼Œæˆ‘ä»¬æœŸæœ›åˆ›å»ºä¸€ä¸ªæºå¸¦é»˜è®¤å€¼çš„ç»“æ„ä½“å˜é‡ï¼Œå¹¶é€‰æ‹©æ€§ä¿®æ”¹å…¶ä¸­ä¸€äº›å‚æ•°çš„å€¼ã€‚
- ç»“æ„ä½“å‚æ•°ç»å¸¸å˜åŠ¨ï¼Œå˜åŠ¨æ—¶æˆ‘ä»¬åˆä¸æƒ³ä¿®æ”¹åˆ›å»ºå®ä¾‹çš„å‡½æ•°ã€‚ä¾‹å¦‚ï¼šç»“æ„ä½“æ–°å¢ä¸€ä¸ªretryå‚æ•°ï¼Œä½†æ˜¯åˆä¸æƒ³åœ¨NewConnectå…¥å‚åˆ—è¡¨ä¸­æ·»åŠ `retry int`è¿™æ ·çš„å‚æ•°å£°æ˜ã€‚

å¦‚æœç»“æ„ä½“å‚æ•°æ¯”è¾ƒå°‘ï¼Œå¯ä»¥æ…é‡è€ƒè™‘è¦ä¸è¦é‡‡ç”¨é€‰é¡¹æ¨¡å¼ã€‚

## æ€»ç»“

è®¾è®¡æ¨¡å¼ï¼Œæ˜¯ä¸šç•Œæ²‰æ·€ä¸‹æ¥çš„é’ˆå¯¹ç‰¹å®šåœºæ™¯çš„æœ€ä½³è§£å†³æ–¹æ¡ˆã€‚åœ¨è½¯ä»¶é¢†åŸŸï¼ŒGoFé¦–æ¬¡ç³»ç»ŸåŒ–æå‡ºäº†3å¤§ç±»è®¾è®¡æ¨¡å¼ï¼šåˆ›å»ºå‹æ¨¡å¼ã€ç»“æ„å‹æ¨¡å¼ã€è¡Œä¸ºå‹æ¨¡å¼ã€‚

è¿™ä¸€è®²ï¼Œæˆ‘ä»‹ç»äº†Goé¡¹ç›®å¼€å‘ä¸­6ç§å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ã€‚æ¯ç§è®¾è®¡æ¨¡å¼è§£å†³æŸä¸€ç±»åœºæ™¯ï¼Œæˆ‘ç»™ä½ æ€»ç»“æˆäº†ä¸€å¼ è¡¨æ ¼ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦è¿›è¡Œé€‰æ‹©ã€‚

![](https://static001.geekbang.org/resource/image/1e/01/1e32f9d8318c8968b50e9ea7e89bbe01.png?wh=1455x1015)

## è¯¾åç»ƒä¹ 

1. ä½ å½“å‰å¼€å‘çš„é¡¹ç›®ä¸­ï¼Œå“ªäº›å¯ä»¥ç”¨å•ä¾‹æ¨¡å¼ã€å·¥å‚æ¨¡å¼ã€é€‰é¡¹æ¨¡å¼æ¥é‡æ–°å®ç°å‘¢ï¼Ÿå¦‚æœæœ‰çš„è¯ï¼Œæˆ‘å»ºè®®ä½ è¯•ç€é‡å†™ä¸‹è¿™éƒ¨åˆ†ä»£ç ã€‚
2. é™¤äº†è¿™ä¸€è®²æˆ‘ä»¬å­¦ä¹ çš„ 6 ç§è®¾è®¡æ¨¡å¼ä¹‹å¤–ï¼Œä½ è¿˜ç”¨è¿‡å…¶ä»–çš„è®¾è®¡æ¨¡å¼å—ï¼Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºå’Œæˆ‘åˆ†äº«ä¸‹ä½ çš„ç»éªŒï¼Œæˆ–è€…ä½ è¸©è¿‡çš„å‘ã€‚

æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>Geek_947b62</span> ğŸ‘ï¼ˆ25ï¼‰ ğŸ’¬ï¼ˆ5ï¼‰<p>func GetIns() *singleton { if ins == nil { mu.Lock() defer mu.Unlock() ins = &amp;singleton{} } return ins}   è¿™é‡Œæœ‰å¯èƒ½ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥åˆ°ifåˆ¤æ–­çš„ï¼Œä¼šå‡ºç°å¤šæ¬¡å®ä¾‹åŒ–çš„ã€‚æ‰€ä»¥åº”è¯¥åœ¨åŠ é”ä¹‹åå†åˆ¤æ–­ä¸€æ¬¡æ‰è¡Œã€‚
func GetIns() *singleton { 
	if ins == nil { 
		mu.Lock() 
		defer mu.Unlock()
		if ins == nil {
			ins = &amp;singleton{} 
		} 
		
	} 
	return ins
}</p>2021-06-19</li><br/><li><span>ppd0705</span> ğŸ‘ï¼ˆ18ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯·é—®`GetCacheInsOr`é‡Œé¢çš„ â€œOrâ€æ˜¯ä»€ä¹ˆçš„ç¼©å†™ï¼Ÿ</p>2021-07-07</li><br/><li><span>serverless</span> ğŸ‘ï¼ˆ13ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>func GetIns() *singleton {
	if ins == nil {
		mu.Lock()
		defer mu.Unlock()
		if ins == nil {
			ins = &amp;singleton{}
		}
	}
	return ins
}
æ»¥ç”¨ defer å«Œç–‘ï¼Œå»ºè®®æ”¹æˆ
func GetIns() *singleton {
	if ins == nil {
		mu.Lock()
		if ins == nil {
			ins = &amp;singleton{}
		}
		mu.Unlock()
	}
	return ins
}</p>2021-06-26</li><br/><li><span>Ryoma</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>å’±å°±æ˜¯è¯´ï¼Œè¡Œä¸ºå‹å’Œç»“æ„å‹æœ‰æ²¡æœ‰å¯èƒ½å¼„åäº†= =</p>2022-06-14</li><br/><li><span>Hector</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ7ï¼‰<p>è¯·é—®è€å¸ˆï¼Œåœ¨é€‰é¡¹æ¨¡å¼ä¸­ï¼Œä½¿ç”¨äº†Optionæ¥å£çš„æ„ä¹‰æ˜¯ä¸ºäº†ä»€ä¹ˆï¼Œè¿™æ ·åšå¢åŠ äº†ä»£ç çš„å¤æ‚åº¦ï¼Œä¸ºä»€ä¹ˆä¸åœ¨WithTimeoutå‡½æ•°ä¸­ç›´æ¥è¿”å›optionFuncï¼Ÿ</p>2021-08-11</li><br/><li><span>yandongxiao</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ€»ç»“ï¼š
    1. è®¾è®¡æ¨¡å¼å…±è®¡25ç§ï¼Œåˆ†ä¸ºä¸‰ç±»ï¼šåˆ›å»ºå‹æ¨¡å¼ã€ç»“æ„æ€§æ¨¡å¼ã€è¡Œä¸ºæ¨¡å¼
    2. åˆ›å»ºå‹æ¨¡å¼åŒ…æ‹¬ï¼šå•ä¾‹æ¨¡å¼ï¼ˆæ‡’æ±‰æ¨¡å¼ã€é¥¿æ±‰æ¨¡å¼ã€å¹¶å‘å®‰å…¨ï¼‰ã€å·¥å‚æ¨¡å¼ï¼ˆç®€å•å·¥å‚ã€æŠ½è±¡å·¥å‚ã€å·¥å‚æ–¹æ³•ï¼‰
    3. ç»“æ„æ€§æ¨¡å¼ï¼šç­–ç•¥æ¨¡å¼å’Œæ¨¡æ¿æ¨¡å¼ã€‚éšå«äº†å¯¹æ‰©å±•å¼€æ”¾ã€å¯¹ä¿®æ”¹å…³é—­çš„åŸåˆ™ã€‚
    4. è¡Œä¸ºæ¨¡å¼ï¼šä»£ç†æ¨¡å¼ã€é€‰é¡¹æ¨¡å¼ã€‚</p>2021-11-24</li><br/><li><span>Dppçš„å°è·Ÿç­å„¿</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç®€å•å·¥å‚æ¨¡å¼çš„ç¤ºä¾‹ä»£ç é‚£é‡Œï¼Œæœ€åè¿”å›åº”è¯¥æ˜¯ return &amp;Person{XXX,XXX,}ï¼ŒNewPersonæ–¹æ³•çš„è¿”å›å€¼ç±»å‹æ˜¯æŒ‡é’ˆ</p>2021-06-23</li><br/><li><span>Vackine</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å•ä¾‹æ¨¡å¼çš„å®ç°é‡Œé¢æ˜¯ä¸æ˜¯è¿˜è¦åŠ ä¸€ä¸ªåªè¯»çš„é€»è¾‘å•Šï¼Œä¸‡ä¸€è·å–äº†ä¹‹åï¼Œå¯¹å…¶ä¿®æ”¹äº†ä¸å°±ä¸ä¸€æ ·äº†ï¼Ÿ</p>2021-06-20</li><br/><li><span>jack</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å®é™…å·¥ä½œä¸­ï¼Œä¸ªäººè§‰å¾—é€‰é¡¹æ¨¡å¼çš„æ¥å£å¯ä»¥å–æ¶ˆæ‰ï¼Œè™½ç„¶æ‰©å±•æ€§ä¼šå¥½ä¸€äº›ï¼Œå°è£…èµ·æ¥å€’æ˜¯æ›´å¤æ‚äº†

type Connection struct {
	addr  string
	age   int
}

&#47;&#47; å®šä¹‰è¿”å›å½“å‰å¯¹è±¡ä¿®æ”¹çš„æŒ‡é’ˆæ–¹æ³•
type Option func(*Connection)

func withAge(age int) Option {
	return func(c *Connection) {
		c.age = age
	}
}

func newConnection(addr string, opts ...Option) *Connection {
	connection := &amp;Connection{
		addr:  addr,
		age:   666,
	}

	for _, apply := range opts {
		apply(connection)
	}

	return connection
}</p>2022-09-15</li><br/><li><span>aoe</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é€‚ç”¨é€‰é¡¹æ¨¡å¼çš„åœºæ™¯ä¹Ÿé€‚ç”¨äºå»ºé€ è€…æ¨¡å¼ï¼ˆBuilderï¼‰ï¼Œå¯¹æ¯”ä»£ç å¦‚ä¸‹

é€‰é¡¹æ¨¡å¼åˆ›å»ºå¯¹è±¡

```go
func main() {
	conn, err := options.NewConnect(&quot;http:&#47;&#47;localhost:8080&quot;,
		options.WithTimeout(time.Second*10),
		options.WithCaching(true))
	if err != nil {
		log.Fatal(err)
	}
	fmt.Println(&quot;conn:&quot;, conn)
}
```

å»ºé€ è€…æ¨¡å¼åˆ›å»ºå¯¹è±¡

```go
package main

import (
	&quot;fmt&quot;
	&quot;time&quot;
)

type Connection struct {
	addr    string
	cache   bool
	timeout time.Duration
}

type ConnectionBuilder struct {
	connection *Connection
}

func Builder() *ConnectionBuilder {
	return &amp;ConnectionBuilder{&amp;Connection{}}
}

func (c *ConnectionBuilder) WithAddr(addr string) *ConnectionBuilder {
	c.connection.addr = addr
	return c
}

func (c *ConnectionBuilder) WithCaching(cache bool) *ConnectionBuilder {
	c.connection.cache = cache
	return c
}

func (c *ConnectionBuilder) WithTimeout(t time.Duration) *ConnectionBuilder {
	c.connection.timeout = t
	return c
}

func (c *ConnectionBuilder) Build() Connection {
	return *c.connection
}

func main() {
	connBuilder := Builder()
	connBuilder.
		WithAddr(&quot;http:&#47;&#47;localhost:8080&quot;).
		WithCaching(true).
		WithTimeout(time.Second * 10)

	conn := connBuilder.Build()
	fmt.Println(&quot;conn:&quot;, conn)
}
```</p>2022-03-14</li><br/><li><span>Derek</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>æˆ‘æ„Ÿè§‰å·¥å‚æ–¹æ³•æ¨¡å¼é‚£å—æˆ‘çœ‹ä¸æ‡‚ã€‚ã€‚ã€‚æˆ‘å¥½èœ  = =ï¼</p>2021-10-28</li><br/><li><span>Geek8292</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æˆ‘çœ‹gofå®˜æ–¹æ˜¯23ç§è®¾è®¡æ¨¡å¼</p>2021-09-14</li><br/><li><span>å“ˆå“ˆ</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç»“æ„å‹æ¨¡å¼å’Œè¡Œä¸ºå‹æ¨¡å¼æ˜¯ä¸æ˜¯å¼„åäº†ï¼Ÿ</p>2021-07-23</li><br/><li><span>å§šåŠ›æ™“</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>æŠ½è±¡å·¥å‚æ¨¡å¼ï¼Œfuncï¼ˆp personï¼‰Greet()  ä¸ºä»€ä¹ˆæ²¡æœ‰ç”¨æŒ‡é’ˆå‘¢ï¼Ÿ</p>2021-07-20</li><br/><li><span>Geek_c9a012</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æŠ“Bugï¼š
1. ç®€å•å·¥å‚æ¨¡å¼çš„å®ä¾‹ä»£ç ï¼ˆ13è¡Œï¼‰å’ŒæŠ½è±¡å·¥å‚æ¨¡å¼çš„å®ä¾‹ä»£ç ï¼ˆ18è¡Œï¼‰è¡Œæœ«å‡å°‘äº†ä¸€ä¸ª &quot;,&quot; åœ¨Go 1.16.3 ä¸‹æç¤ºé”™è¯¯
2. é€‰é¡¹æ¨¡å¼çš„å®ä¾‹ä»£ç ä¸­ï¼Œ47è¡Œçš„å‡½æ•°åé”™äº†ï¼Œåº”è¯¥æ˜¯ NewConnect

è¿™å‡ ä¸ªç»“åˆGolangè‡ªèº«ç‰¹è‰²çš„è®¾è®¡æ¨¡å¼ä»‹ç»å¾ˆæœ‰ä»·å€¼ï¼Œæ„Ÿè°¢ä½œè€…æä¾›è¿™ä¹ˆå¥½çš„è¯¾ç¨‹</p>2021-06-28</li><br/>
</ul>