ä½ å¥½ï¼Œæˆ‘æ˜¯å­”ä»¤é£ã€‚

åœ¨Goé¡¹ç›®å¼€å‘ä¸­ï¼Œé”™è¯¯æ˜¯æˆ‘ä»¬å¿…é¡»è¦å¤„ç†çš„ä¸€ä¸ªäº‹é¡¹ã€‚é™¤äº†æˆ‘ä»¬ä¸Šä¸€è®²å­¦ä¹ è¿‡çš„é”™è¯¯ç ï¼Œå¤„ç†é”™è¯¯ä¹Ÿç¦»ä¸å¼€é”™è¯¯åŒ…ã€‚

ä¸šç•Œæœ‰å¾ˆå¤šä¼˜ç§€çš„ã€å¼€æºçš„é”™è¯¯åŒ…å¯ä¾›é€‰æ‹©ï¼Œä¾‹å¦‚Goæ ‡å‡†åº“è‡ªå¸¦çš„`errors`åŒ…ã€`github.com/pkg/errors`åŒ…ã€‚ä½†æ˜¯è¿™äº›åŒ…ç›®å‰è¿˜ä¸æ”¯æŒä¸šåŠ¡é”™è¯¯ç ï¼Œå¾ˆéš¾æ»¡è¶³ç”Ÿäº§çº§åº”ç”¨çš„éœ€æ±‚ã€‚æ‰€ä»¥ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å¼€å‘å‡ºé€‚åˆè‡ªå·±é”™è¯¯ç è®¾è®¡çš„é”™è¯¯åŒ…ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿæ²¡å¿…è¦è‡ªå·±ä»0å¼€å‘ï¼Œå¯ä»¥åŸºäºä¸€äº›ä¼˜ç§€çš„åŒ…æ¥è¿›è¡ŒäºŒæ¬¡å°è£…ã€‚

è¿™ä¸€è®²é‡Œï¼Œæˆ‘ä»¬å°±æ¥ä¸€èµ·çœ‹çœ‹ï¼Œå¦‚ä½•è®¾è®¡ä¸€ä¸ªé”™è¯¯åŒ…æ¥é€‚é…ä¸Šä¸€è®²æˆ‘ä»¬è®¾è®¡çš„é”™è¯¯ç ï¼Œä»¥åŠä¸€ä¸ªé”™è¯¯ç çš„å…·ä½“å®ç°ã€‚

## é”™è¯¯åŒ…éœ€è¦å…·æœ‰å“ªäº›åŠŸèƒ½ï¼Ÿ

è¦æƒ³è®¾è®¡ä¸€ä¸ªä¼˜ç§€çš„é”™è¯¯åŒ…ï¼Œæˆ‘ä»¬é¦–å…ˆå¾—çŸ¥é“ä¸€ä¸ªä¼˜ç§€çš„é”™è¯¯åŒ…éœ€è¦å…·å¤‡å“ªäº›åŠŸèƒ½ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œè‡³å°‘éœ€è¦æœ‰ä¸‹é¢è¿™å…­ä¸ªåŠŸèƒ½ï¼š

**é¦–å…ˆï¼Œåº”è¯¥èƒ½æ”¯æŒé”™è¯¯å †æ ˆã€‚**æˆ‘ä»¬æ¥çœ‹ä¸‹é¢ä¸€æ®µä»£ç ï¼Œå‡è®¾ä¿å­˜åœ¨[bad.go](https://github.com/marmotedu/gopractise-demo/blob/master/errors/bad.go)æ–‡ä»¶ä¸­ï¼š

```
package main

import (
	"fmt"
	"log"
)

func main() {
	if err := funcA(); err != nil {
		log.Fatalf("call func got failed: %v", err)
		return
	}

	log.Println("call func success")
}

func funcA() error {
	if err := funcB(); err != nil {
		return err
	}

	return fmt.Errorf("func called error")
}

func funcB() error {
	return fmt.Errorf("func called error")
}
```

æ‰§è¡Œä¸Šé¢çš„ä»£ç ï¼š

```
$ go run bad.go
2021/07/02 08:06:55 call func got failed: func called error
exit status 1
```

è¿™æ—¶æˆ‘ä»¬æƒ³å®šä½é—®é¢˜ï¼Œä½†ä¸çŸ¥é“å…·ä½“æ˜¯å“ªè¡Œä»£ç æŠ¥çš„é”™è¯¯ï¼Œåªèƒ½é çŒœï¼Œè¿˜ä¸ä¸€å®šèƒ½çŒœåˆ°ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åŠ ä¸€äº›Debugä¿¡æ¯ï¼Œæ¥ååŠ©æˆ‘ä»¬å®šä½é—®é¢˜ã€‚è¿™æ ·åšåœ¨æµ‹è¯•ç¯å¢ƒæ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨çº¿ä¸Šç¯å¢ƒï¼Œä¸€æ–¹é¢ä¿®æ”¹ã€å‘å¸ƒéƒ½æ¯”è¾ƒéº»çƒ¦ï¼Œå¦ä¸€æ–¹é¢é—®é¢˜å¯èƒ½æ¯”è¾ƒéš¾é‡ç°ã€‚è¿™æ—¶å€™æˆ‘ä»¬ä¼šæƒ³ï¼Œè¦æ˜¯èƒ½æ‰“å°é”™è¯¯çš„å †æ ˆå°±å¥½äº†ã€‚ä¾‹å¦‚ï¼š

```
2021/07/02 14:17:03 call func got failed: func called error
main.funcB
	/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/good.go:27
main.funcA
	/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/good.go:19
main.main
	/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/good.go:10
runtime.main
	/home/colin/go/go1.16.2/src/runtime/proc.go:225
runtime.goexit
	/home/colin/go/go1.16.2/src/runtime/asm_amd64.s:1371
exit status 1
```

é€šè¿‡ä¸Šé¢çš„é”™è¯¯è¾“å‡ºï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°çŸ¥é“æ˜¯å“ªè¡Œä»£ç æŠ¥çš„é”™ï¼Œä»è€Œæå¤§æé«˜é—®é¢˜å®šä½çš„æ•ˆç‡ï¼Œé™ä½å®šä½çš„éš¾åº¦ã€‚æ‰€ä»¥ï¼Œåœ¨æˆ‘çœ‹æ¥ï¼Œä¸€ä¸ªä¼˜ç§€çš„errorsåŒ…ï¼Œé¦–å…ˆéœ€è¦æ”¯æŒé”™è¯¯å †æ ˆã€‚

**å…¶æ¬¡ï¼Œèƒ½å¤Ÿæ”¯æŒä¸åŒçš„æ‰“å°æ ¼å¼ã€‚**ä¾‹å¦‚`%+v`ã€`%v`ã€`%s`ç­‰æ ¼å¼ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ‰“å°ä¸åŒä¸°å¯Œåº¦çš„é”™è¯¯ä¿¡æ¯ã€‚

**å†æ¬¡ï¼Œèƒ½æ”¯æŒWrap/UnwrapåŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯åœ¨å·²æœ‰çš„é”™è¯¯ä¸Šï¼Œè¿½åŠ ä¸€äº›æ–°çš„ä¿¡æ¯ã€‚**ä¾‹å¦‚`errors.Wrap(err, "open file failed")` ã€‚Wrapé€šå¸¸ç”¨åœ¨è°ƒç”¨å‡½æ•°ä¸­ï¼Œè°ƒç”¨å‡½æ•°å¯ä»¥åŸºäºè¢«è°ƒå‡½æ•°æŠ¥é”™æ—¶çš„é”™è¯¯Wrapä¸€äº›è‡ªå·±çš„ä¿¡æ¯ï¼Œä¸°å¯ŒæŠ¥é”™ä¿¡æ¯ï¼Œæ–¹ä¾¿åæœŸçš„é”™è¯¯å®šä½ï¼Œä¾‹å¦‚ï¼š

```
func funcA() error {
    if err := funcB(); err != nil {
        return errors.Wrap(err, "call funcB failed")
    }

    return errors.New("func called error")
}

func funcB() error {
    return errors.New("func called error")
}
```

è¿™é‡Œè¦æ³¨æ„ï¼Œä¸åŒçš„é”™è¯¯ç±»å‹ï¼ŒWrapå‡½æ•°çš„é€»è¾‘ä¹Ÿå¯ä»¥ä¸åŒã€‚å¦å¤–ï¼Œåœ¨è°ƒç”¨Wrapæ—¶ï¼Œä¹Ÿä¼šç”Ÿæˆä¸€ä¸ªé”™è¯¯å †æ ˆèŠ‚ç‚¹ã€‚æˆ‘ä»¬æ—¢ç„¶èƒ½å¤ŸåµŒå¥—errorï¼Œé‚£æœ‰æ—¶å€™è¿˜å¯èƒ½éœ€è¦è·å–è¢«åµŒå¥—çš„errorï¼Œè¿™æ—¶å°±éœ€è¦é”™è¯¯åŒ…æä¾›`Unwrap`å‡½æ•°ã€‚

**è¿˜æœ‰ï¼Œé”™è¯¯åŒ…åº”è¯¥æœ‰`Is`æ–¹æ³•**ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦åˆ¤æ–­æŸä¸ªerroræ˜¯å¦æ˜¯æŒ‡å®šçš„errorã€‚åœ¨Go 1.13ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰wrapping errorçš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦åˆ¤æ–­erroræ˜¯ä¸æ˜¯åŒä¸€ä¸ªï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•ï¼š

```
if err == os.ErrNotExist {
	// normal code
}
```

ä½†æ˜¯ç°åœ¨ï¼Œå› ä¸ºæœ‰äº†wrapping errorï¼Œè¿™æ ·åˆ¤æ–­å°±ä¼šæœ‰é—®é¢˜ã€‚å› ä¸ºä½ æ ¹æœ¬ä¸çŸ¥é“è¿”å›çš„erræ˜¯ä¸æ˜¯ä¸€ä¸ªåµŒå¥—çš„errorï¼ŒåµŒå¥—äº†å‡ å±‚ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„é”™è¯¯åŒ…å°±éœ€è¦æä¾›`Is`å‡½æ•°ï¼š

```
func Is(err, target error) bool
```

å½“errå’Œtargetæ˜¯åŒä¸€ä¸ªï¼Œæˆ–è€…erræ˜¯ä¸€ä¸ªwrapping errorçš„æ—¶å€™ï¼Œå¦‚æœtargetä¹ŸåŒ…å«åœ¨è¿™ä¸ªåµŒå¥—erroré“¾ä¸­ï¼Œè¿”å›trueï¼Œå¦åˆ™è¿”å›fasleã€‚

**å¦å¤–ï¼Œé”™è¯¯åŒ…åº”è¯¥æ”¯æŒ** `As` **å‡½æ•°ã€‚**

åœ¨Go 1.13ä¹‹å‰ï¼Œæ²¡æœ‰wrapping errorçš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦æŠŠerrorè½¬ä¸ºå¦å¤–ä¸€ä¸ªerrorï¼Œä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨type assertionæˆ–è€…type switchï¼Œä¹Ÿå°±æ˜¯ç±»å‹æ–­è¨€ã€‚ä¾‹å¦‚ï¼š

```
if perr, ok := err.(*os.PathError); ok {
	fmt.Println(perr.Path)
}
```

ä½†æ˜¯ç°åœ¨ï¼Œè¿”å›çš„errå¯èƒ½æ˜¯åµŒå¥—çš„errorï¼Œç”šè‡³å¥½å‡ å±‚åµŒå¥—ï¼Œè¿™ç§æ–¹å¼å°±ä¸èƒ½ç”¨äº†ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç° `As` å‡½æ•°æ¥å®Œæˆè¿™ç§åŠŸèƒ½ã€‚ç°åœ¨æˆ‘ä»¬æŠŠä¸Šé¢çš„ä¾‹å­ï¼Œç”¨ `As` å‡½æ•°å®ç°ä¸€ä¸‹ï¼š

```
var perr *os.PathError
if errors.As(err, &perr) {
	fmt.Println(perr.Path)
}
```

è¿™æ ·å°±å¯ä»¥å®Œå…¨å®ç°ç±»å‹æ–­è¨€çš„åŠŸèƒ½ï¼Œè€Œä¸”è¿˜æ›´å¼ºå¤§ï¼Œå› ä¸ºå®ƒå¯ä»¥å¤„ç†wrapping errorã€‚

**æœ€åï¼Œèƒ½å¤Ÿæ”¯æŒä¸¤ç§é”™è¯¯åˆ›å»ºæ–¹å¼ï¼šéæ ¼å¼åŒ–åˆ›å»ºå’Œæ ¼å¼åŒ–åˆ›å»ºã€‚**ä¾‹å¦‚ï¼š

```
errors.New("file not found")
errors.Errorf("file %s not found", "iam-apiserver")
```

ä¸Šé¢ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä¸€ä¸ªä¼˜ç§€çš„é”™è¯¯åŒ…åº”è¯¥å…·å¤‡çš„åŠŸèƒ½ã€‚ä¸€ä¸ªå¥½æ¶ˆæ¯æ˜¯ï¼ŒGithubä¸Šæœ‰ä¸å°‘å®ç°äº†è¿™äº›åŠŸèƒ½çš„é”™è¯¯åŒ…ï¼Œå…¶ä¸­`github.com/pkg/errors`åŒ…æœ€å—æ¬¢è¿ã€‚æ‰€ä»¥ï¼Œæˆ‘åŸºäº`github.com/pkg/errors`åŒ…è¿›è¡Œäº†äºŒæ¬¡å°è£…ï¼Œç”¨æ¥æ”¯æŒä¸Šä¸€è®²æ‰€ä»‹ç»çš„é”™è¯¯ç ã€‚

## é”™è¯¯åŒ…å®ç°

æ˜ç¡®ä¼˜ç§€çš„é”™è¯¯åŒ…åº”è¯¥å…·å¤‡çš„åŠŸèƒ½åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹é”™è¯¯åŒ…çš„å®ç°ã€‚å®ç°çš„æºç å­˜æ”¾åœ¨[github.com/marmotedu/errors](https://github.com/marmotedu/errors)ã€‚

æˆ‘é€šè¿‡åœ¨æ–‡ä»¶[github.com/pkg/errors/errors.go](https://github.com/marmotedu/errors/blob/master/errors.go#L299)ä¸­å¢åŠ æ–°çš„`withCode`ç»“æ„ä½“ï¼Œæ¥å¼•å…¥ä¸€ç§æ–°çš„é”™è¯¯ç±»å‹ï¼Œè¯¥é”™è¯¯ç±»å‹å¯ä»¥è®°å½•é”™è¯¯ç ã€stackã€causeå’Œå…·ä½“çš„é”™è¯¯ä¿¡æ¯ã€‚

```
type withCode struct {
    err   error // error é”™è¯¯
    code  int // ä¸šåŠ¡é”™è¯¯ç 
    cause error // cause error
    *stack // é”™è¯¯å †æ ˆ
}
```

ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç¤ºä¾‹ï¼Œæ¥äº†è§£ä¸‹`github.com/marmotedu/errors`æ‰€æä¾›çš„åŠŸèƒ½ã€‚å‡è®¾ä¸‹è¿°ä»£ç ä¿å­˜åœ¨`errors.go`æ–‡ä»¶ä¸­ï¼š

```
package main

import (
	"fmt"

	"github.com/marmotedu/errors"
	code "github.com/marmotedu/sample-code"
)

func main() {
	if err := bindUser(); err != nil {
		// %s: Returns the user-safe error string mapped to the error code or the error message if none is specified.
		fmt.Println("====================> %s <====================")
		fmt.Printf("%s\n\n", err)

		// %v: Alias for %s.
		fmt.Println("====================> %v <====================")
		fmt.Printf("%v\n\n", err)

		// %-v: Output caller details, useful for troubleshooting.
		fmt.Println("====================> %-v <====================")
		fmt.Printf("%-v\n\n", err)

		// %+v: Output full error stack details, useful for debugging.
		fmt.Println("====================> %+v <====================")
		fmt.Printf("%+v\n\n", err)

		// %#-v: Output caller details, useful for troubleshooting with JSON formatted output.
		fmt.Println("====================> %#-v <====================")
		fmt.Printf("%#-v\n\n", err)

		// %#+v: Output full error stack details, useful for debugging with JSON formatted output.
		fmt.Println("====================> %#+v <====================")
		fmt.Printf("%#+v\n\n", err)

		// do some business process based on the error type
		if errors.IsCode(err, code.ErrEncodingFailed) {
			fmt.Println("this is a ErrEncodingFailed error")
		}

		if errors.IsCode(err, code.ErrDatabase) {
			fmt.Println("this is a ErrDatabase error")
		}

		// we can also find the cause error
		fmt.Println(errors.Cause(err))
	}
}

func bindUser() error {
	if err := getUser(); err != nil {
		// Step3: Wrap the error with a new error message and a new error code if needed.
		return errors.WrapC(err, code.ErrEncodingFailed, "encoding user 'Lingfei Kong' failed.")
	}

	return nil
}

func getUser() error {
	if err := queryDatabase(); err != nil {
		// Step2: Wrap the error with a new error message.
		return errors.Wrap(err, "get user failed.")
	}

	return nil
}

func queryDatabase() error {
	// Step1. Create error with specified error code.
	return errors.WithCode(code.ErrDatabase, "user 'Lingfei Kong' not found.")
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œé€šè¿‡[WithCode](https://github.com/marmotedu/errors/blob/v1.0.2/errors.go#L306)å‡½æ•°æ¥åˆ›å»ºæ–°çš„withCodeç±»å‹çš„é”™è¯¯ï¼›é€šè¿‡[WrapC](https://github.com/marmotedu/errors/blob/v1.0.2/errors.go#L314)æ¥å°†ä¸€ä¸ªerrorå°è£…æˆä¸€ä¸ªwithCodeç±»å‹çš„é”™è¯¯ï¼›é€šè¿‡[IsCode](https://github.com/marmotedu/errors/blob/v1.0.2/code.go#L121)æ¥åˆ¤æ–­ä¸€ä¸ªerroré“¾ä¸­æ˜¯å¦åŒ…å«æŒ‡å®šçš„codeã€‚

withCodeé”™è¯¯å®ç°äº†ä¸€ä¸ª`func (w *withCode) Format(state fmt.State, verb rune)`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨æ¥æ‰“å°ä¸åŒæ ¼å¼çš„é”™è¯¯ä¿¡æ¯ï¼Œè§ä¸‹è¡¨ï¼š

![](https://static001.geekbang.org/resource/image/18/5c/18a93313e017d4f3b21370099d011c5c.png?wh=1755x1198)

ä¾‹å¦‚ï¼Œ`%+v`ä¼šæ‰“å°ä»¥ä¸‹é”™è¯¯ä¿¡æ¯ï¼š

```
get user failed. - #1 [/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/errortrack_errors.go:19 (main.getUser)] (100101) Database error; user 'Lingfei Kong' not found. - #0 [/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/errortrack_errors.go:26 (main.queryDatabase)] (100101) Database error
```

é‚£ä¹ˆä½ å¯èƒ½ä¼šé—®ï¼Œè¿™äº›é”™è¯¯ä¿¡æ¯ä¸­çš„`100101`é”™è¯¯ç ï¼Œè¿˜æœ‰`Database error`è¿™ç§å¯¹å¤–å±•ç¤ºçš„æŠ¥é”™ä¿¡æ¯ç­‰ç­‰ï¼Œæ˜¯ä»å“ªé‡Œè·å–çš„ï¼Ÿè¿™é‡Œæˆ‘ç®€å•è§£é‡Šä¸€ä¸‹ã€‚

é¦–å…ˆï¼Œ `withCode` ä¸­åŒ…å«äº†intç±»å‹çš„é”™è¯¯ç ï¼Œä¾‹å¦‚`100101`ã€‚

å…¶æ¬¡ï¼Œå½“ä½¿ç”¨`github.com/marmotedu/errors`åŒ…çš„æ—¶å€™ï¼Œéœ€è¦è°ƒç”¨`Register`æˆ–è€…`MustRegister`ï¼Œå°†ä¸€ä¸ªCoderæ³¨å†Œåˆ°`github.com/marmotedu/errors`å¼€è¾Ÿçš„å†…å­˜ä¸­ï¼Œæ•°æ®ç»“æ„ä¸ºï¼š

```
var codes = map[int]Coder{}
```

Coderæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰ä¸ºï¼š

```
type Coder interface {
    // HTTP status that should be used for the associated error code.
    HTTPStatus() int

    // External (user) facing error text.
    String() string

    // Reference returns the detail documents for user.
    Reference() string

    // Code returns the code of the coder
    Code() int
}
```

è¿™æ · `withCode` çš„`Format`æ–¹æ³•ï¼Œå°±èƒ½å¤Ÿé€šè¿‡ `withCode` ä¸­çš„codeå­—æ®µè·å–åˆ°å¯¹åº”çš„Coderï¼Œå¹¶é€šè¿‡Coderæä¾›çš„HTTPStatusã€Stringã€Referenceã€Codeå‡½æ•°ï¼Œæ¥è·å– `withCode` ä¸­codeçš„è¯¦ç»†ä¿¡æ¯ï¼Œæœ€åæ ¼å¼åŒ–æ‰“å°ã€‚

è¿™é‡Œè¦æ³¨æ„ï¼Œæˆ‘ä»¬å®ç°äº†ä¸¤ä¸ªæ³¨å†Œå‡½æ•°ï¼š`Register`å’Œ`MustRegister`ï¼ŒäºŒè€…å”¯ä¸€åŒºåˆ«æ˜¯ï¼šå½“é‡å¤å®šä¹‰åŒä¸€ä¸ªé”™è¯¯Codeæ—¶ï¼Œ`MustRegister`ä¼španicï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢åé¢æ³¨å†Œçš„é”™è¯¯è¦†ç›–æ‰ä¹‹å‰æ³¨å†Œçš„é”™è¯¯ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œå»ºè®®ä½¿ç”¨`MustRegister`ã€‚

`XXX()`å’Œ`MustXXX()`çš„å‡½æ•°å‘½åæ–¹å¼ï¼Œæ˜¯ä¸€ç§Goä»£ç è®¾è®¡æŠ€å·§ï¼Œåœ¨Goä»£ç ä¸­ç»å¸¸ä½¿ç”¨ï¼Œä¾‹å¦‚Goæ ‡å‡†åº“ä¸­`regexp`åŒ…æä¾›çš„`Compile`å’Œ`MustCompile`å‡½æ•°ã€‚å’Œ`XXX`ç›¸æ¯”ï¼Œ`MustXXX` ä¼šåœ¨æŸç§æƒ…å†µä¸æ»¡è¶³æ—¶panicã€‚å› æ­¤ä½¿ç”¨`MustXXX`çš„å¼€å‘è€…çœ‹åˆ°å‡½æ•°åå°±ä¼šæœ‰ä¸€ä¸ªå¿ƒç†é¢„æœŸï¼šä½¿ç”¨ä¸å½“ï¼Œä¼šé€ æˆç¨‹åºpanicã€‚

æœ€åï¼Œæˆ‘è¿˜æœ‰ä¸€ä¸ªå»ºè®®ï¼šåœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨JSONæ ¼å¼æ‰“å°æ—¥å¿—ï¼ŒJSONæ ¼å¼çš„æ—¥å¿—å¯ä»¥éå¸¸æ–¹ä¾¿çš„ä¾›æ—¥å¿—ç³»ç»Ÿè§£æã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦ï¼Œé€‰æ‹©`%#-v`æˆ–`%#+v`ä¸¤ç§æ ¼å¼ã€‚

é”™è¯¯åŒ…åœ¨ä»£ç ä¸­ï¼Œç»å¸¸è¢«è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä¿è¯é”™è¯¯åŒ…ä¸€å®šè¦æ˜¯é«˜æ€§èƒ½çš„ï¼Œå¦åˆ™å¾ˆå¯èƒ½ä¼šå½±å“æ¥å£çš„æ€§èƒ½ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹`github.com/marmotedu/errors`åŒ…çš„æ€§èƒ½ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªé”™è¯¯åŒ…è·Ÿgoæ ‡å‡†åº“çš„ `errors` åŒ…ï¼Œä»¥åŠ `github.com/pkg/errors` åŒ…è¿›è¡Œå¯¹æ¯”ï¼Œæ¥çœ‹çœ‹å®ƒä»¬çš„æ€§èƒ½ï¼š

```
$  go test -test.bench=BenchmarkErrors -benchtime="3s"
goos: linux
goarch: amd64
pkg: github.com/marmotedu/errors
BenchmarkErrors/errors-stack-10-8         	57658672	        61.8 ns/op	      16 B/op	       1 allocs/op
BenchmarkErrors/pkg/errors-stack-10-8     	 2265558	      1547 ns/op	     320 B/op	       3 allocs/op
BenchmarkErrors/marmot/errors-stack-10-8  	 1903532	      1772 ns/op	     360 B/op	       5 allocs/op
BenchmarkErrors/errors-stack-100-8        	 4883659	       734 ns/op	      16 B/op	       1 allocs/op
BenchmarkErrors/pkg/errors-stack-100-8    	 1202797	      2881 ns/op	     320 B/op	       3 allocs/op
BenchmarkErrors/marmot/errors-stack-100-8 	 1000000	      3116 ns/op	     360 B/op	       5 allocs/op
BenchmarkErrors/errors-stack-1000-8       	  505636	      7159 ns/op	      16 B/op	       1 allocs/op
BenchmarkErrors/pkg/errors-stack-1000-8   	  327681	     10646 ns/op	     320 B/op	       3 allocs/op
BenchmarkErrors/marmot/errors-stack-1000-8         	  304160	     11896 ns/op	     360 B/op	       5 allocs/op
PASS
ok  	github.com/marmotedu/errors	39.200s
```

å¯ä»¥çœ‹åˆ°`github.com/marmotedu/errors`å’Œ`github.com/pkg/errors`åŒ…çš„æ€§èƒ½åŸºæœ¬æŒå¹³ã€‚åœ¨å¯¹æ¯”æ€§èƒ½æ—¶ï¼Œé‡ç‚¹å…³æ³¨**ns/op**ï¼Œä¹Ÿå³æ¯æ¬¡erroræ“ä½œè€—è´¹çš„çº³ç§’æ•°ã€‚å¦å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æµ‹è¯•ä¸åŒerroråµŒå¥—æ·±åº¦ä¸‹çš„erroræ“ä½œæ€§èƒ½ï¼ŒåµŒå¥—è¶Šæ·±ï¼Œæ€§èƒ½è¶Šå·®ã€‚ä¾‹å¦‚ï¼šåœ¨åµŒå¥—æ·±åº¦ä¸º10çš„æ—¶å€™ï¼Œ `github.com/pkg/errors` åŒ…ns/opå€¼ä¸º1547ï¼Œ `github.com/marmotedu/errors` åŒ…ns/opå€¼ä¸º1772ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒäºŒè€…æ€§èƒ½åŸºæœ¬ä¿æŒä¸€è‡´ã€‚

å…·ä½“æ€§èƒ½æ•°æ®å¯¹æ¯”è§ä¸‹è¡¨ï¼š

![](https://static001.geekbang.org/resource/image/a6/5e/a6a794d7523bc1edfa459d3a49f9685e.png?wh=1737x1145)

æˆ‘ä»¬æ˜¯é€šè¿‡[BenchmarkErrors](https://github.com/marmotedu/errors/blob/v1.0.2/bench_test.go#L39)æµ‹è¯•å‡½æ•°æ¥æµ‹è¯•erroråŒ…æ€§èƒ½çš„ï¼Œä½ æ„Ÿå…´è¶£å¯ä»¥æ‰“å¼€é“¾æ¥çœ‹çœ‹ã€‚

## å¦‚ä½•è®°å½•é”™è¯¯ï¼Ÿ

ä¸Šé¢ï¼Œæˆ‘ä»¬ä¸€èµ·çœ‹äº†æ€ä¹ˆè®¾è®¡ä¸€ä¸ªä¼˜ç§€çš„é”™è¯¯åŒ…ï¼Œé‚£å¦‚ä½•ç”¨æˆ‘ä»¬è®¾è®¡çš„é”™è¯¯åŒ…æ¥è®°å½•é”™è¯¯å‘¢ï¼Ÿ

æ ¹æ®æˆ‘çš„å¼€å‘ç»éªŒï¼Œæˆ‘æ¨èä¸¤ç§è®°å½•é”™è¯¯çš„æ–¹å¼ï¼Œå¯ä»¥å¸®ä½ å¿«é€Ÿå®šä½é—®é¢˜ã€‚

æ–¹å¼ä¸€ï¼šé€šè¿‡`github.com/marmotedu/errors`åŒ…æä¾›çš„é”™è¯¯å †æ ˆèƒ½åŠ›ï¼Œæ¥è·Ÿè¸ªé”™è¯¯ã€‚

å…·ä½“ä½ å¯ä»¥çœ‹çœ‹ä¸‹é¢çš„ä»£ç ç¤ºä¾‹ã€‚ä»¥ä¸‹ä»£ç ä¿å­˜åœ¨[errortrack\_errors.go](https://github.com/marmotedu/gopractise-demo/blob/master/errors/errortrack_errors.go)ä¸­ã€‚

```
package main

import (
	"fmt"

	"github.com/marmotedu/errors"

	code "github.com/marmotedu/sample-code"
)

func main() {
	if err := getUser(); err != nil {
		fmt.Printf("%+v\n", err)
	}
}

func getUser() error {
	if err := queryDatabase(); err != nil {
		return errors.Wrap(err, "get user failed.")
	}

	return nil
}

func queryDatabase() error {
	return errors.WithCode(code.ErrDatabase, "user 'Lingfei Kong' not found.")
}
```

æ‰§è¡Œä¸Šè¿°çš„ä»£ç ï¼š

```
$ go run errortrack_errors.go
get user failed. - #1 [/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/errortrack_errors.go:19 (main.getUser)] (100101) Database error; user 'Lingfei Kong' not found. - #0 [/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/errortrack_errors.go:26 (main.queryDatabase)] (100101) Database error
```

å¯ä»¥çœ‹åˆ°ï¼Œæ‰“å°çš„æ—¥å¿—ä¸­æ‰“å°å‡ºäº†è¯¦ç»†çš„é”™è¯¯å †æ ˆï¼ŒåŒ…æ‹¬é”™è¯¯å‘ç”Ÿçš„å‡½æ•°ã€æ–‡ä»¶åã€è¡Œå·å’Œé”™è¯¯ä¿¡æ¯ï¼Œé€šè¿‡è¿™äº›é”™è¯¯å †æ ˆï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®šä½é—®é¢˜ã€‚

ä½ ä½¿ç”¨è¿™ç§æ–¹æ³•æ—¶ï¼Œæˆ‘æ¨èçš„ç”¨æ³•æ˜¯ï¼Œåœ¨é”™è¯¯æœ€å¼€å§‹å¤„ä½¿ç”¨ `errors.WithCode()` åˆ›å»ºä¸€ä¸ª withCodeç±»å‹çš„é”™è¯¯ã€‚ä¸Šå±‚åœ¨å¤„ç†åº•å±‚è¿”å›çš„é”™è¯¯æ—¶ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ï¼Œä½¿ç”¨Wrapå‡½æ•°åŸºäºè¯¥é”™è¯¯å°è£…æ–°çš„é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœè¦åŒ…è£…çš„errorä¸æ˜¯ç”¨`github.com/marmotedu/errors`åŒ…åˆ›å»ºçš„ï¼Œå»ºè®®ç”¨ `errors.WithCode()` æ–°å»ºä¸€ä¸ªerrorã€‚

æ–¹å¼äºŒï¼šåœ¨é”™è¯¯äº§ç”Ÿçš„æœ€åŸå§‹ä½ç½®è°ƒç”¨æ—¥å¿—åŒ…è®°å½•å‡½æ•°ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯ï¼Œå…¶ä»–ä½ç½®ç›´æ¥è¿”å›ï¼ˆå½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©æ€§çš„è¿½åŠ ä¸€äº›é”™è¯¯ä¿¡æ¯ï¼Œæ–¹ä¾¿æ•…éšœå®šä½ï¼‰ã€‚ç¤ºä¾‹ä»£ç ï¼ˆä¿å­˜åœ¨[errortrack\_log.go](https://github.com/marmotedu/gopractise-demo/blob/master/errors/errortrack_log.go)ï¼‰å¦‚ä¸‹ï¼š

```
package main

import (
	"fmt"

	"github.com/marmotedu/errors"
	"github.com/marmotedu/log"

	code "github.com/marmotedu/sample-code"
)

func main() {
	if err := getUser(); err != nil {
		fmt.Printf("%v\n", err)
	}
}

func getUser() error {
	if err := queryDatabase(); err != nil {
		return err
	}

	return nil
}

func queryDatabase() error {
	opts := &log.Options{
		Level:            "info",
		Format:           "console",
		EnableColor:      true,
		EnableCaller:     true,
		OutputPaths:      []string{"test.log", "stdout"},
		ErrorOutputPaths: []string{},
	}

	log.Init(opts)
	defer log.Flush()

	err := errors.WithCode(code.ErrDatabase, "user 'Lingfei Kong' not found.")
	if err != nil {
		log.Errorf("%v", err)
	}
	return err
}
```

æ‰§è¡Œä»¥ä¸Šä»£ç ï¼š

```
$ go run errortrack_log.go
2021-07-03 14:37:31.597	ERROR	errors/errortrack_log.go:41	Database error
Database error
```

å½“é”™è¯¯å‘ç”Ÿæ—¶ï¼Œè°ƒç”¨logåŒ…æ‰“å°é”™è¯¯ã€‚é€šè¿‡logåŒ…çš„calleråŠŸèƒ½ï¼Œå¯ä»¥å®šä½åˆ°logè¯­å¥çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯å®šä½åˆ°é”™è¯¯å‘ç”Ÿçš„ä½ç½®ã€‚ä½ ä½¿ç”¨è¿™ç§æ–¹å¼æ¥æ‰“å°æ—¥å¿—æ—¶ï¼Œæˆ‘æœ‰ä¸¤ä¸ªå»ºè®®ã€‚

- åªåœ¨é”™è¯¯äº§ç”Ÿçš„æœ€åˆä½ç½®æ‰“å°æ—¥å¿—ï¼Œå…¶ä»–åœ°æ–¹ç›´æ¥è¿”å›é”™è¯¯ï¼Œä¸€èˆ¬ä¸éœ€è¦å†å¯¹é”™è¯¯è¿›è¡Œå°è£…ã€‚
- å½“ä»£ç è°ƒç”¨ç¬¬ä¸‰æ–¹åŒ…çš„å‡½æ•°æ—¶ï¼Œç¬¬ä¸‰æ–¹åŒ…å‡½æ•°å‡ºé”™æ—¶æ‰“å°é”™è¯¯ä¿¡æ¯ã€‚æ¯”å¦‚ï¼š

```
if err := os.Chdir("/root"); err != nil {
    log.Errorf("change dir failed: %v", err)
}
```

## ä¸€ä¸ªé”™è¯¯ç çš„å…·ä½“å®ç°

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸ªä¾æ®ä¸Šä¸€è®²ä»‹ç»çš„é”™è¯¯ç è§„èŒƒçš„å…·ä½“é”™è¯¯ç å®ç°`github.com/marmotedu/sample-code`ã€‚

`sample-code`å®ç°äº†ä¸¤ç±»é”™è¯¯ç ï¼Œåˆ†åˆ«æ˜¯é€šç”¨é”™è¯¯ç ï¼ˆ[sample-code/base.go](https://github.com/marmotedu/sample-code/blob/master/base.go)ï¼‰å’Œä¸šåŠ¡æ¨¡å—ç›¸å…³çš„é”™è¯¯ç ï¼ˆ[sample-code/apiserver.go](https://github.com/marmotedu/sample-code/blob/master/apiserver.go)ï¼‰ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹é€šç”¨é”™è¯¯ç çš„å®šä¹‰ï¼š

```
// é€šç”¨: åŸºæœ¬é”™è¯¯
// Code must start with 1xxxxx
const (
    // ErrSuccess - 200: OK.
    ErrSuccess int = iota + 100001

    // ErrUnknown - 500: Internal server error.
    ErrUnknown

    // ErrBind - 400: Error occurred while binding the request body to the struct.
    ErrBind

    // ErrValidation - 400: Validation failed.
    ErrValidation

    // ErrTokenInvalid - 401: Token invalid.
    ErrTokenInvalid
)
```

åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨æ•´å‹å¸¸é‡ï¼ˆErrSuccessï¼‰æ¥ä»£æ›¿æ•´å‹é”™è¯¯ç ï¼ˆ100001ï¼‰ï¼Œå› ä¸ºä½¿ç”¨ErrSuccessæ—¶ï¼Œä¸€çœ‹å°±çŸ¥é“å®ƒä»£è¡¨çš„é”™è¯¯ç±»å‹ï¼Œå¯ä»¥æ–¹ä¾¿å¼€å‘è€…ä½¿ç”¨ã€‚

é”™è¯¯ç ç”¨æ¥æŒ‡ä»£ä¸€ä¸ªé”™è¯¯ç±»å‹ï¼Œè¯¥é”™è¯¯ç±»å‹éœ€è¦åŒ…å«ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ï¼Œä¾‹å¦‚å¯¹åº”çš„HTTP Status Codeã€å¯¹å¤–å±•ç¤ºçš„Messageï¼Œä»¥åŠè·Ÿè¯¥é”™è¯¯åŒ¹é…çš„å¸®åŠ©æ–‡æ¡£ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®ç°ä¸€ä¸ªCoderæ¥æ‰¿è½½è¿™äº›ä¿¡æ¯ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå®ç°äº†`github.com/marmotedu/errors.Coder`æ¥å£çš„`ErrCode`ç»“æ„ä½“ï¼š

```
// ErrCode implements `github.com/marmotedu/errors`.Coder interface.
type ErrCode struct {
    // C refers to the code of the ErrCode.
    C int

    // HTTP status that should be used for the associated error code.
    HTTP int

    // External (user) facing error text.
    Ext string

    // Ref specify the reference document.
    Ref string
}
```

å¯ä»¥çœ‹åˆ°`ErrCode`ç»“æ„ä½“åŒ…å«äº†ä»¥ä¸‹ä¿¡æ¯ï¼š

- intç±»å‹çš„ä¸šåŠ¡ç ã€‚
- å¯¹åº”çš„HTTP Status Codeã€‚
- æš´éœ²ç»™å¤–éƒ¨ç”¨æˆ·çš„æ¶ˆæ¯ã€‚
- é”™è¯¯çš„å‚è€ƒæ–‡æ¡£ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå…·ä½“çš„Coderç¤ºä¾‹ï¼š

```
coder := &ErrCode{
    C:    100001,
    HTTP: 200,
    Ext:  "OK",
    Ref:  "https://github.com/marmotedu/sample-code/blob/master/README.md",
}
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨`github.com/marmotedu/errors`åŒ…æä¾›çš„`Register`æˆ–è€…`MustRegister`å‡½æ•°ï¼Œå°†Coderæ³¨å†Œåˆ°`github.com/marmotedu/errors`åŒ…ç»´æŠ¤çš„å†…å­˜ä¸­ã€‚

ä¸€ä¸ªé¡¹ç›®æœ‰å¾ˆå¤šä¸ªé”™è¯¯ç ï¼Œå¦‚æœæ¯ä¸ªé”™è¯¯ç éƒ½æ‰‹åŠ¨è°ƒç”¨`MustRegister`å‡½æ•°ä¼šå¾ˆéº»çƒ¦ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡ä»£ç è‡ªåŠ¨ç”Ÿæˆçš„æ–¹æ³•ï¼Œæ¥ç”Ÿæˆregisterå‡½æ•°è°ƒç”¨ï¼š

```
//go:generate codegen -type=int
//go:generate codegen -type=int -doc -output ./error_code_generated.md
```

`//go:generate codegen -type=int` ä¼šè°ƒç”¨[codegen](https://github.com/marmotedu/iam/tree/master/tools/codegen)å·¥å…·ï¼Œç”Ÿæˆ[sample\_code\_generated.go](https://github.com/marmotedu/sample-code/blob/master/sample_code_generated.go)æºç æ–‡ä»¶ï¼š

```
func init() {
	register(ErrSuccess, 200, "OK")
	register(ErrUnknown, 500, "Internal server error")
	register(ErrBind, 400, "Error occurred while binding the request body to the struct")
	register(ErrValidation, 400, "Validation failed")
    // other register function call
}
```

è¿™äº›[register](https://github.com/marmotedu/iam/blob/v1.0.0/internal/pkg/code/code.go#L58)è°ƒç”¨æ”¾åœ¨initå‡½æ•°ä¸­ï¼Œåœ¨åŠ è½½ç¨‹åºçš„æ—¶å€™è¢«åˆå§‹åŒ–ã€‚

è¿™é‡Œè¦æ³¨æ„ï¼Œåœ¨æ³¨å†Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæ£€æŸ¥HTTP Status Codeï¼Œåªå…è®¸å®šä¹‰200ã€400ã€401ã€403ã€404ã€500è¿™6ä¸ªHTTPé”™è¯¯ç ã€‚è¿™é‡Œé€šè¿‡ç¨‹åºä¿è¯äº†é”™è¯¯ç æ˜¯ç¬¦åˆHTTP Status Codeä½¿ç”¨è¦æ±‚çš„ã€‚

`//go:generate codegen -type=int -doc -output ./error_code_generated.md`ä¼šç”Ÿæˆé”™è¯¯ç æè¿°æ–‡æ¡£ [error\_code\_generated.md](https://github.com/marmotedu/sample-code/blob/master/error_code_generated.md)ã€‚å½“æˆ‘ä»¬æä¾›APIæ–‡æ¡£æ—¶ï¼Œä¹Ÿéœ€è¦è®°ç€æä¾›ä¸€ä»½é”™è¯¯ç æè¿°æ–‡æ¡£ï¼Œè¿™æ ·å®¢æˆ·ç«¯æ‰å¯ä»¥æ ¹æ®é”™è¯¯ç ï¼ŒçŸ¥é“è¯·æ±‚æ˜¯å¦æˆåŠŸï¼Œä»¥åŠå…·ä½“å‘ç”Ÿå“ªç±»é”™è¯¯ï¼Œå¥½é’ˆå¯¹æ€§åœ°åšä¸€äº›é€»è¾‘å¤„ç†ã€‚

`codegen`å·¥å…·ä¼šæ ¹æ®é”™è¯¯ç æ³¨é‡Šç”Ÿæˆ`sample_code_generated.go`å’Œ`error_code_generated.md`æ–‡ä»¶ï¼š

```
// ErrSuccess - 200: OK.
 ErrSuccess int = iota + 100001
```

codegenå·¥å…·ä¹‹æ‰€ä»¥èƒ½å¤Ÿç”Ÿæˆ`sample_code_generated.go`å’Œ`error_code_generated.md`ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬çš„é”™è¯¯ç æ³¨é‡Šæ˜¯æœ‰è§„å®šæ ¼å¼çš„ï¼š`// <é”™è¯¯ç æ•´å‹å¸¸é‡> - <å¯¹åº”çš„HTTP Status Code>: <External Message>.`ã€‚

codegenå·¥å…·å¯ä»¥åœ¨IAMé¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…ï¼š

```
$ make tools.install.codegen
```

å®‰è£…å®Œ `codegen` å·¥å…·åï¼Œå¯ä»¥åœ¨ `github.com/marmotedu/sample-code` åŒ…æ ¹ç›®å½•ä¸‹æ‰§è¡Œ `go generate` å‘½ä»¤ï¼Œæ¥ç”Ÿæˆ`sample_code_generated.go`å’Œ`error_code_generated.md`ã€‚è¿™é‡Œæœ‰ä¸ªæŠ€å·§éœ€è¦ä½ æ³¨æ„ï¼šç”Ÿæˆçš„æ–‡ä»¶å»ºè®®ç»Ÿä¸€ç”¨ `xxxx_generated.xx` æ¥å‘½åï¼Œè¿™æ ·é€šè¿‡ `generated` ï¼Œæˆ‘ä»¬å°±çŸ¥é“è¿™ä¸ªæ–‡ä»¶æ˜¯ä»£ç è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæœ‰åŠ©äºæˆ‘ä»¬ç†è§£å’Œä½¿ç”¨ã€‚

åœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†é”™è¯¯ç ç‹¬ç«‹æˆä¸€ä¸ªåŒ…ï¼Œæ”¾åœ¨ `internal/pkg/code/`ç›®å½•ä¸‹ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿æ•´ä¸ªåº”ç”¨è°ƒç”¨ã€‚ä¾‹å¦‚IAMçš„é”™è¯¯ç å°±æ”¾åœ¨IAMé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„[internal/pkg/code/](https://github.com/marmotedu/iam/tree/master/internal/pkg/code)ç›®å½•ä¸‹ã€‚

æˆ‘ä»¬çš„é”™è¯¯ç æ˜¯åˆ†æœåŠ¡å’Œæ¨¡å—çš„ï¼Œæ‰€ä»¥è¿™é‡Œå»ºè®®ä½ æŠŠç›¸åŒçš„æœåŠ¡æ”¾åœ¨åŒä¸€ä¸ªGoæºæ–‡ä»¶ä¸­ï¼Œä¾‹å¦‚IAMçš„é”™è¯¯ç å­˜æ”¾æ–‡ä»¶ï¼š

```
$ ls base.go apiserver.go authzserver.go 
apiserver.go  authzserver.go  base.go
```

ä¸€ä¸ªåº”ç”¨ä¸­ä¼šæœ‰å¤šä¸ªæœåŠ¡ï¼Œä¾‹å¦‚IAMåº”ç”¨ä¸­ï¼Œå°±åŒ…å«äº†iam-apiserverã€iam-authz-serverã€iam-pumpä¸‰ä¸ªæœåŠ¡ã€‚è¿™äº›æœåŠ¡æœ‰ä¸€äº›é€šç”¨çš„é”™è¯¯ç ï¼Œä¸ºäº†ä¾¿äºç»´æŠ¤ï¼Œå¯ä»¥å°†è¿™äº›é€šç”¨çš„é”™è¯¯ç ç»Ÿä¸€æ”¾åœ¨base.goæºç æ–‡ä»¶ä¸­ã€‚å…¶ä»–çš„é”™è¯¯ç ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰æœåŠ¡åˆ†åˆ«æ”¾åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­ï¼šiam-apiserveræœåŠ¡çš„é”™è¯¯ç ç»Ÿä¸€æ”¾åœ¨apiserver.goæ–‡ä»¶ä¸­ï¼›iam-authz-serverçš„é”™è¯¯ç ç»Ÿä¸€å­˜æ”¾åœ¨authzserver.goæ–‡ä»¶ä¸­ã€‚å…¶ä»–æœåŠ¡ä»¥æ­¤ç±»æ¨ã€‚

å¦å¤–ï¼ŒåŒä¸€ä¸ªæœåŠ¡ä¸­ä¸åŒæ¨¡å—çš„é”™è¯¯ç ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ ¼å¼æ¥ç»„ç»‡ï¼šç›¸åŒæ¨¡å—çš„é”™è¯¯ç æ”¾åœ¨åŒä¸€ä¸ªconstä»£ç å—ä¸­ï¼Œä¸åŒæ¨¡å—çš„é”™è¯¯ç æ”¾åœ¨ä¸åŒçš„constä»£ç å—ä¸­ã€‚æ¯ä¸ªconstä»£ç å—çš„å¼€å¤´æ³¨é‡Šå°±æ˜¯è¯¥æ¨¡å—çš„é”™è¯¯ç å®šä¹‰ã€‚ä¾‹å¦‚ï¼š

```
// iam-apiserver: user errors.
const (
    // ErrUserNotFound - 404: User not found.
    ErrUserNotFound int = iota + 110001

    // ErrUserAlreadyExist - 400: User already exist.
    ErrUserAlreadyExist
)

// iam-apiserver: secret errors.
const (
    // ErrEncrypt - 400: Secret reach the max count.
    ErrReachMaxCount int = iota + 110101

    //  ErrSecretNotFound - 404: Secret not found.
    ErrSecretNotFound
)
```

æœ€åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†é”™è¯¯ç å®šä¹‰è®°å½•åœ¨é¡¹ç›®çš„æ–‡ä»¶ä¸­ï¼Œä¾›å¼€å‘è€…æŸ¥é˜…ã€éµå®ˆå’Œä½¿ç”¨ï¼Œä¾‹å¦‚IAMé¡¹ç›®çš„é”™è¯¯ç å®šä¹‰è®°å½•æ–‡æ¡£ä¸º[code\_specification.md](https://github.com/marmotedu/iam/blob/master/docs/guide/zh-CN/api/code_specification.md)ã€‚è¿™ä¸ªæ–‡æ¡£ä¸­è®°å½•äº†é”™è¯¯ç è¯´æ˜ã€é”™è¯¯æè¿°è§„èŒƒå’Œé”™è¯¯è®°å½•è§„èŒƒç­‰ã€‚

## é”™è¯¯ç å®é™…ä½¿ç”¨æ–¹æ³•ç¤ºä¾‹

ä¸Šé¢ï¼Œæˆ‘è®²è§£äº†é”™è¯¯åŒ…å’Œé”™è¯¯ç çš„å®ç°æ–¹å¼ï¼Œé‚£ä½ ä¸€å®šæƒ³çŸ¥é“åœ¨å®é™…å¼€å‘ä¸­æˆ‘ä»¬æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚è¿™é‡Œï¼Œæˆ‘å°±ä¸¾ä¸€ä¸ªåœ¨gin webæ¡†æ¶ä¸­ä½¿ç”¨è¯¥é”™è¯¯ç çš„ä¾‹å­ï¼š

```
// Response defines project response format which in marmotedu organization.
type Response struct {
    Code      errors.Code `json:"code,omitempty"`
    Message   string      `json:"message,omitempty"`
    Reference string      `json:"reference,omitempty"`
    Data      interface{} `json:"data,omitempty"`
}

// WriteResponse used to write an error and JSON data into response.
func WriteResponse(c *gin.Context, err error, data interface{}) {
    if err != nil {
        coder := errors.ParseCoder(err)

        c.JSON(coder.HTTPStatus(), Response{
            Code:      coder.Code(),
            Message:   coder.String(),
            Reference: coder.Reference(),
            Data:      data,
        })
    }

    c.JSON(http.StatusOK, Response{Data: data})
}

func GetUser(c *gin.Context) {
    log.Info("get user function called.", "X-Request-Id", requestid.Get(c))
    // Get the user by the `username` from the database.
    user, err := store.Client().Users().Get(c.Param("username"), metav1.GetOptions{})
    if err != nil {
        core.WriteResponse(c, errors.WithCode(code.ErrUserNotFound, err.Error()), nil)
        return
    }

    core.WriteResponse(c, nil, user)
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œé€šè¿‡`WriteResponse`ç»Ÿä¸€å¤„ç†é”™è¯¯ã€‚åœ¨ `WriteResponse` å‡½æ•°ä¸­ï¼Œå¦‚æœ`err != nil`ï¼Œåˆ™ä»errorä¸­è§£æå‡ºCoderï¼Œå¹¶è°ƒç”¨Coderæä¾›çš„æ–¹æ³•ï¼Œè·å–é”™è¯¯ç›¸å…³çš„Http Status Codeã€intç±»å‹çš„ä¸šåŠ¡ç ã€æš´éœ²ç»™ç”¨æˆ·çš„ä¿¡æ¯ã€é”™è¯¯çš„å‚è€ƒæ–‡æ¡£é“¾æ¥ï¼Œå¹¶è¿”å›JSONæ ¼å¼çš„ä¿¡æ¯ã€‚å¦‚æœ `err == nil` åˆ™è¿”å›200å’Œæ•°æ®ã€‚

## æ€»ç»“

è®°å½•é”™è¯¯æ˜¯åº”ç”¨ç¨‹åºå¿…é¡»è¦åšçš„ä¸€ä»¶äº‹æƒ…ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå°è£…è‡ªå·±çš„é”™è¯¯åŒ…ã€‚ä¸€ä¸ªä¼˜ç§€çš„é”™è¯¯åŒ…ï¼Œåº”è¯¥èƒ½å¤Ÿæ”¯æŒé”™è¯¯å †æ ˆã€ä¸åŒçš„æ‰“å°æ ¼å¼ã€Wrap/Unwrap/Is/Asç­‰å‡½æ•°ï¼Œå¹¶èƒ½å¤Ÿæ”¯æŒæ ¼å¼åŒ–åˆ›å»ºerrorã€‚

æ ¹æ®è¿™äº›é”™è¯¯åŒ…è®¾è®¡è¦ç‚¹ï¼Œæˆ‘åŸºäº `github.com/pkg/errors` åŒ…è®¾è®¡äº†IAMé¡¹ç›®çš„é”™è¯¯åŒ… `github.com/marmotedu/errors` ï¼Œè¯¥åŒ…ç¬¦åˆæˆ‘ä»¬ä¸Šä¸€è®²è®¾è®¡çš„é”™è¯¯ç è§„èŒƒã€‚

å¦å¤–ï¼Œæœ¬è®²ä¹Ÿç»™å‡ºäº†ä¸€ä¸ªå…·ä½“çš„é”™è¯¯ç å®ç° sample-code ï¼Œ sample-code æ”¯æŒä¸šåŠ¡Codeç ã€HTTP Status Codeã€é”™è¯¯å‚è€ƒæ–‡æ¡£ã€å¯ä»¥å¯¹å†…å¯¹å¤–å±•ç¤ºä¸åŒçš„é”™è¯¯ä¿¡æ¯ã€‚

æœ€åï¼Œå› ä¸ºé”™è¯¯ç æ³¨é‡Šæ˜¯æœ‰å›ºå®šæ ¼å¼çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡codegenå·¥å…·è§£æé”™è¯¯ç çš„æ³¨é‡Šï¼Œç”Ÿæˆregisterå‡½æ•°è°ƒç”¨å’Œé”™è¯¯ç æ–‡æ¡£ã€‚è¿™ç§åšæ³•ä¹Ÿä½“ç°äº†æˆ‘ä¸€ç›´å¼ºè°ƒçš„low codeæ€æƒ³ï¼Œå¯ä»¥æé«˜å¼€å‘æ•ˆç‡ï¼Œå‡å°‘äººä¸ºå¤±è¯¯ã€‚

## è¯¾åç»ƒä¹ 

1. åœ¨è¿™é—¨è¯¾é‡Œï¼Œæˆ‘ä»¬å®šä¹‰äº†baseã€iam-apiserveræœåŠ¡çš„é”™è¯¯ç ï¼Œè¯·è¯•ç€å®šä¹‰iam-authz-serveræœåŠ¡çš„é”™è¯¯ç ï¼Œå¹¶ç”Ÿæˆé”™è¯¯ç æ–‡æ¡£ã€‚
2. æ€è€ƒä¸‹ï¼Œè¿™é—¨è¯¾çš„é”™è¯¯åŒ…å’Œé”™è¯¯ç è®¾è®¡èƒ½å¦æ»¡è¶³ä½ å½“å‰çš„é¡¹ç›®éœ€æ±‚ï¼Œå¦‚æœè§‰å¾—ä¸èƒ½æ»¡è¶³ï¼Œå¯ä»¥åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„çœ‹æ³•ã€‚

æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>yandongxiao</span> ğŸ‘ï¼ˆ10ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ€»ç»“ï¼š
1. ä¸ºä»€ä¹ˆä¸šåŠ¡è¦å¼€å‘è‡ªå·±çš„é”™è¯¯åŒ…ï¼Ÿå› ä¸ºå¼€æºçš„erroråŒ…ä¸­ï¼Œæ²¡æœ‰ä¸šåŠ¡é”™è¯¯ç ï¼Œä¸æ–¹ä¾¿ä½¿ç”¨ã€‚
2. å¦‚ä½•åŒºåˆ†å†…éƒ¨é”™è¯¯å’Œå¤–éƒ¨é”™è¯¯ï¼Ÿ
    1. å°†é”™è¯¯åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å¥½çš„è®¾è®¡ï¼Œé€šè¿‡ error code è”ç³»åœ¨ä¸€èµ·
    2. å°† error code, response code, external error message æ³¨å†Œåˆ°ä¸€å¼ å¤§è¡¨ä¸Š
    3. github.com&#47;marmotedu&#47;errors åŒ…æä¾›çš„ WitheCode å’Œ Wrap æ–¹æ³•ï¼Œæ„å»ºé”™è¯¯é“¾ï¼ˆåµŒå¥—å…³ç³»ï¼‰
    4. é€šè¿‡ format çš„å„ç§å½¢å¼ï¼Œæ§åˆ¶ error çš„è¾“å‡ºä¿¡æ¯
3. å¦‚ä½•è‡ªåŠ¨ç”Ÿæˆå…¨å±€çš„é”™è¯¯ç æ–‡æ¡£ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜å’Œè”è°ƒï¼Ÿ ä½¿ç”¨ codegen å·¥å…·ã€‚
4. å¦‚ä½•æ‰“å°é”™è¯¯ï¼Ÿåªåœ¨é”™è¯¯æœ€åŸå§‹ä½ç½®æ‰“å°é”™è¯¯ã€‚</p>2021-11-27</li><br/><li><span>pedro</span> ğŸ‘ï¼ˆ9ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä»¥æ¨èè€å¸ˆçš„é¡¹ç›®ç»™ç»„é‡Œå…¶å®ƒå°ä¼™ä¼´ï¼Œä¸€èµ·å­¦ä¹ æ²‰æ·€æ‰“ç£¨ä¸ºè‡ªå·±çš„å®ç”¨æ ‡å‡†ï¼Œå¤šè°¢è€å¸ˆ</p>2021-07-08</li><br/><li><span>æ¼‚æ³Šçš„å°é£˜</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ„Ÿè§‰éœ€è¦çœ‹ç€æºç å†å­¦ä¸€éã€‚ã€‚ã€‚</p>2021-07-28</li><br/><li><span>æ ‘å»º</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>æ–‡ä¸­æåˆ°withCodeå®ç°äº†formatæ–¹æ³•ï¼Œä½†æ˜¯çœ‹äº†errors.goä¸­åªæŸ¥çœ‹withMessageå®ç°äº†format</p>2022-05-05</li><br/><li><span>å¹å£å“¨yu</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>withCode æ²¡æœ‰å®ç° Format() æ–¹æ³•å‘€ï¼Ÿ</p>2022-07-13</li><br/><li><span>.</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>çœ‹å®Œäº†gitä¸­withCodeé”™è¯¯çš„å®ç°é€»è¾‘å¯¹äº WitCodeéœ€è¦åˆ†å¼€causeå’Œerr ä¸¤ä¸ªerrorsï¼Œå¾ˆæ˜¯è¿·æƒ‘ã€‚èµ·åˆçœ‹å®Œä»£ç åœ¨çŒœæƒ³causeè¿™ä¸ªåº”è¯¥æ˜¯ä¸ºäº†é€’å½’æ‰“å°ï¼Œå®ç°ä¸Šä¸ªç« èŠ‚çš„â€ç§‘å­¦è®¾è®¡é”™è¯¯åŒ…â€œå†…å®¹â€œ é”™è¯¯ç 100101ï¼Œ 10: æœåŠ¡ã€‚01: æŸä¸ªæœåŠ¡ä¸‹çš„æŸä¸ªæ¨¡å—ã€‚01: æ¨¡å—ä¸‹çš„é”™è¯¯ç åºå·ï¼Œæ¯ä¸ªæ¨¡å—å¯ä»¥æ³¨å†Œ 100 ä¸ªé”™è¯¯ã€‚â€ çš„åŠŸèƒ½ï¼Œä½†æ˜¯çœ‹äº†å‡½æ•°IsCodeçš„é€»è¾‘ï¼Œå½»åº•æ‡µé€¼äº†ï¼Œcodeåªå¯¹æ¯”äº†ç¬¬ä¸€å±‚çš„codeå°±returnï¼Œæ˜¾ç„¶ä¸æ˜¯ä¸ºäº†å®ç°ä¸Šä¸€ç« èŠ‚çš„å†…å®¹ï¼Œæ‰€ä»¥å¤šä¸ªcause  errorsæ„Ÿè§‰æ˜¯ä¸€ä¸ªç‰¹åˆ«ç´¯èµ˜çš„è®¾è®¡ã€‚

å¦å¤–WithCodeå’ŒWithStack çš„å…¥å‚éƒ½æ˜¯error æ¥å£ã€‚ å¦‚æœä¸€ä¸ªerrorèµ·åˆæ˜¯goåŸç”Ÿåº“çš„errorï¼Œ å…ˆwithCodeå†WithMessgge, åœ¨æ‰§è¡Œerr. Error() ä¼šä¸¢å¤±æ‰“å°ä¸å‡ºå®Œæ•´çš„é”™è¯¯æ ˆã€‚è¿™å—æ˜¯åŸæœ¬iamçš„å°±æ˜¯ä¸šåŠ¡è®¾è®¡å°±æ˜¯å¦‚æ­¤å—ï¼ŸWithMessggeä¼šç›´æ¥å†³å®šäº†err. Error() å€¼ï¼Œä¸ç®¡å‰é¢è¢«Withäº†å¤šå°‘æ¬¡ï¼Ÿ</p>2022-06-11</li><br/><li><span>ä½ èµ–ä¸œä¸œä¸é”™å˜›</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è®°å½•é”™è¯¯æ–¹å¼äºŒï¼šåœ¨errå‘ç”Ÿå¤„æ‰“å°äº†logï¼Œå´ä¾æ—§æŠŠerrä¸ŠæŠ›ï¼Œè€Œæœ€å¤–å±‚åˆå¯¹errè¿›è¡Œäº†ä¸€æ¬¡å¤„ç†ï¼Œè¿™æ ·å¯èƒ½å¯¼è‡´æ—¥å¿—é‡Œå†™äº†ä¸¤ä»½é‡å¤çš„errä¿¡æ¯ã€‚æœ›è§£æƒ‘ï¼</p>2021-07-16</li><br/><li><span>Geek_25f93f</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¦å†™è¿™ä¹ˆä¸€ä¸ªcodegenå·¥å…·åº”è¯¥è¦åºŸå¾ˆå¤šæ—¶é—´</p>2022-07-09</li><br/><li><span>Geek_c2089d</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>func New(message string) error {
	return &amp;fundamental{
		msg:   message,
		stack: callers(),
	}
}
è€å¸ˆï¼Œæƒ³é—®ä¸€ä¸‹errors&#47;code.go çš„åŒ…é‡Œé¢çš„callers()å‡½æ•°ï¼Œå“ªé‡Œæ¥çš„</p>2022-04-19</li><br/><li><span>è«æ—</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆèƒ½ä»‹ç»ä¸€ä¸‹å¦‚ä½•é€‚é…gprc çš„ status å“åº”å—ï¼Ÿ</p>2021-12-07</li><br/><li><span>å€ªæ˜Š</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é”™è¯¯ç å®é™…ä½¿ç”¨æ–¹æ³•å®ä¾‹é‡Œçš„WriteResponseï¼Œå¦‚æœerr != nilï¼Œifåˆ†æ”¯æ‰§è¡Œå®Œï¼Œè¿˜æ˜¯ä¼šç»§ç»­æ‰§è¡Œä¸‹é¢çš„c.JSONï¼Œè¿™æ ·ä¸å°±è¿”å›ä¸¤ä¸ªResponseç»“æ„äº†å—ï¼Ÿ</p>2021-09-08</li><br/><li><span>Sch0ng</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æŠŠé”™è¯¯å¤„ç†è½åœ°æˆç®€å•å®ç”¨çš„é”™è¯¯å¤„ç†åŒ…ï¼Œæœ‰åŠ©äºé”™è¯¯ç çš„é•¿æœŸæ²»ç†ã€‚</p>2021-08-10</li><br/><li><span>å¤§åˆ˜</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é”™è¯¯ç å®é™…ä½¿ç”¨æ–¹æ³•ç¤ºä¾‹ä¸­
1.type Response struct { Code errors.Code `json:&quot;code,omitempty&quot;` Message string `json:&quot;message,omitempty&quot;` Reference string `json:&quot;reference,omitempty&quot;` Data interface{} `json:&quot;data,omitempty&quot;`}

Code errors.Code æ˜¯ä¸æ˜¯åº”è¯¥æ”¹ä¸ºCode int
2.if err != nil { core.WriteResponse(c, code.ErrUserNotFound.Error(), nil) return }
code.ErrUserNotFound.Error()  è¿™ä¸ªErroræ–¹æ³•æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿ ErrUserNotFoundæŒ‰ç…§ä¸Šé¢æ‰€è¯´åº”è¯¥åªæ˜¯ä¸€ä¸ªintå€¼å§ï¼Ÿ</p>2021-08-02</li><br/><li><span>ppd0705</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è¯·é—®ä¸€ä¸‹è€å¸ˆï¼Œå½“ä¸€ä¸ªæ¥å£æœ‰å¤šä¸ªç”¨æˆ·è¾“å…¥å‚æ•°ï¼Œå…¶ä¸­æŸä¸ªå‚æ•°é”™è¯¯, å¦‚æœéœ€è¦å‘Šè¯‰ç”¨æˆ·å…·ä½“å“ªä¸ªå‚æ•°æœ‰é—®é¢˜ï¼Œè¿™æ ·CODE.Extæ˜¯åŠ¨æ€çš„ï¼Œè¯¥æ€ä¹ˆå¤„ç†å¥½å‘¢ï¼Ÿ 


</p>2021-07-30</li><br/><li><span>Daiver</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¿˜æ˜¯ä¸æ¸…æ¥šï¼Œcodegenæ˜¯æ€ä¹ˆç”Ÿæˆæ³¨å†Œä»£ç çš„</p>2021-07-12</li><br/>
</ul>