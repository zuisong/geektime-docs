æˆ‘ä»¬çŸ¥é“ï¼ŒServletå®¹å™¨æœ€é‡è¦çš„ä»»åŠ¡å°±æ˜¯åˆ›å»ºServletçš„å®ä¾‹å¹¶ä¸”è°ƒç”¨Servletï¼Œåœ¨å‰é¢ä¸¤æœŸæˆ‘è°ˆåˆ°äº†Tomcatå¦‚ä½•å®šä¹‰è‡ªå·±çš„ç±»åŠ è½½å™¨æ¥åŠ è½½Servletï¼Œä½†åŠ è½½Servletçš„ç±»ä¸ç­‰äºåˆ›å»ºServletçš„å®ä¾‹ï¼Œç±»åŠ è½½åªæ˜¯ç¬¬ä¸€æ­¥ï¼Œç±»åŠ è½½å¥½äº†æ‰èƒ½åˆ›å»ºç±»çš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯è¯´Tomcatå…ˆåŠ è½½Servletçš„ç±»ï¼Œç„¶ååœ¨Javaå †ä¸Šåˆ›å»ºäº†ä¸€ä¸ªServletå®ä¾‹ã€‚

ä¸€ä¸ªWebåº”ç”¨é‡Œå¾€å¾€æœ‰å¤šä¸ªServletï¼Œè€Œåœ¨Tomcatä¸­ä¸€ä¸ªWebåº”ç”¨å¯¹åº”ä¸€ä¸ªContextå®¹å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªContextå®¹å™¨éœ€è¦ç®¡ç†å¤šä¸ªServletå®ä¾‹ã€‚ä½†Contextå®¹å™¨å¹¶ä¸ç›´æ¥æŒæœ‰Servletå®ä¾‹ï¼Œè€Œæ˜¯é€šè¿‡å­å®¹å™¨Wrapperæ¥ç®¡ç†Servletï¼Œä½ å¯ä»¥æŠŠWrapperå®¹å™¨çœ‹ä½œæ˜¯Servletçš„åŒ…è£…ã€‚

é‚£ä¸ºä»€ä¹ˆéœ€è¦Wrapperå‘¢ï¼ŸContextå®¹å™¨ç›´æ¥ç»´æŠ¤ä¸€ä¸ªServletæ•°ç»„ä¸å°±è¡Œäº†å—ï¼Ÿè¿™æ˜¯å› ä¸ºServletä¸ä»…ä»…æ˜¯ä¸€ä¸ªç±»å®ä¾‹ï¼Œå®ƒè¿˜æœ‰ç›¸å…³çš„é…ç½®ä¿¡æ¯ï¼Œæ¯”å¦‚å®ƒçš„URLæ˜ å°„ã€å®ƒçš„åˆå§‹åŒ–å‚æ•°ï¼Œå› æ­¤è®¾è®¡å‡ºäº†ä¸€ä¸ªåŒ…è£…å™¨ï¼ŒæŠŠServletæœ¬èº«å’Œå®ƒç›¸å…³çš„æ•°æ®åŒ…èµ·æ¥ï¼Œæ²¡é”™ï¼Œè¿™å°±æ˜¯é¢å‘å¯¹è±¡çš„æ€æƒ³ã€‚

é‚£ç®¡ç†å¥½Servletå°±å®Œäº‹å¤§å‰äº†å—ï¼Ÿåˆ«å¿˜äº†Servletè¿˜æœ‰ä¸¤ä¸ªå…„å¼Ÿï¼šListenerå’ŒFilterï¼Œå®ƒä»¬ä¹Ÿæ˜¯Servletè§„èŒƒä¸­çš„é‡è¦æˆå‘˜ï¼Œå› æ­¤Tomcatä¹Ÿéœ€è¦åˆ›å»ºå®ƒä»¬çš„å®ä¾‹ï¼Œä¹Ÿéœ€è¦åœ¨åˆé€‚çš„æ—¶æœºå»è°ƒç”¨å®ƒä»¬çš„æ–¹æ³•ã€‚

è¯´äº†é‚£ä¹ˆå¤šï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥èŠä¸€èŠTomcatæ˜¯å¦‚ä½•åšåˆ°ä¸Šé¢è¿™äº›äº‹çš„ã€‚

## Servletç®¡ç†

å‰é¢æåˆ°ï¼ŒTomcatæ˜¯ç”¨Wrapperå®¹å™¨æ¥ç®¡ç†Servletçš„ï¼Œé‚£Wrapperå®¹å™¨å…·ä½“é•¿ä»€ä¹ˆæ ·å­å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒé‡Œé¢æœ‰å“ªäº›å…³é”®çš„æˆå‘˜å˜é‡ï¼š

```
protected volatile Servlet instance = null;
```

æ¯«æ— æ‚¬å¿µï¼Œå®ƒæ‹¥æœ‰ä¸€ä¸ªServletå®ä¾‹ï¼Œå¹¶ä¸”Wrapperé€šè¿‡loadServletæ–¹æ³•æ¥å®ä¾‹åŒ–Servletã€‚ä¸ºäº†æ–¹ä¾¿ä½ é˜…è¯»ï¼Œæˆ‘ç®€åŒ–äº†ä»£ç ï¼š

```
public synchronized Servlet loadServlet() throws ServletException {
    Servlet servlet;
  
    //1. åˆ›å»ºä¸€ä¸ªServletå®ä¾‹
    servlet = (Servlet) instanceManager.newInstance(servletClass);    
    
    //2.è°ƒç”¨äº†Servletçš„initæ–¹æ³•ï¼Œè¿™æ˜¯Servletè§„èŒƒè¦æ±‚çš„
    initServlet(servlet);
    
    return servlet;
}
```

å…¶å®loadServletä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼šåˆ›å»ºServletçš„å®ä¾‹ï¼Œå¹¶ä¸”è°ƒç”¨Servletçš„initæ–¹æ³•ï¼Œå› ä¸ºè¿™æ˜¯Servletè§„èŒƒè¦æ±‚çš„ã€‚

é‚£æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯ï¼Œä»€ä¹ˆæ—¶å€™ä¼šè°ƒåˆ°è¿™ä¸ªloadServletæ–¹æ³•å‘¢ï¼Ÿä¸ºäº†åŠ å¿«ç³»ç»Ÿçš„å¯åŠ¨é€Ÿåº¦ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šé‡‡å–èµ„æºå»¶è¿ŸåŠ è½½çš„ç­–ç•¥ï¼ŒTomcatä¹Ÿä¸ä¾‹å¤–ï¼Œé»˜è®¤æƒ…å†µä¸‹Tomcatåœ¨å¯åŠ¨æ—¶ä¸ä¼šåŠ è½½ä½ çš„Servletï¼Œé™¤éä½ æŠŠServletçš„`loadOnStartup`å‚æ•°è®¾ç½®ä¸º`true`ã€‚

è¿™é‡Œè¿˜éœ€è¦ä½ æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶Tomcatåœ¨å¯åŠ¨æ—¶ä¸ä¼šåˆ›å»ºServletå®ä¾‹ï¼Œä½†æ˜¯ä¼šåˆ›å»ºWrapperå®¹å™¨ï¼Œå°±å¥½æ¯”å°½ç®¡æªé‡Œé¢è¿˜æ²¡æœ‰å­å¼¹ï¼Œå…ˆæŠŠæªé€ å‡ºæ¥ã€‚é‚£å­å¼¹ä»€ä¹ˆæ—¶å€™é€ å‘¢ï¼Ÿæ˜¯çœŸæ­£éœ€è¦å¼€æªçš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰è¯·æ±‚æ¥è®¿é—®æŸä¸ªServletæ—¶ï¼Œè¿™ä¸ªServletçš„å®ä¾‹æ‰ä¼šè¢«åˆ›å»ºã€‚

é‚£Servletæ˜¯è¢«è°è°ƒç”¨çš„å‘¢ï¼Ÿæˆ‘ä»¬å›å¿†ä¸€ä¸‹ä¸“æ å‰é¢æåˆ°è¿‡Tomcatçš„Pipeline-Valveæœºåˆ¶ï¼Œæ¯ä¸ªå®¹å™¨ç»„ä»¶éƒ½æœ‰è‡ªå·±çš„Pipelineï¼Œæ¯ä¸ªPipelineä¸­æœ‰ä¸€ä¸ªValveé“¾ï¼Œå¹¶ä¸”æ¯ä¸ªå®¹å™¨ç»„ä»¶æœ‰ä¸€ä¸ªBasicValveï¼ˆåŸºç¡€é˜€ï¼‰ã€‚Wrapperä½œä¸ºä¸€ä¸ªå®¹å™¨ç»„ä»¶ï¼Œå®ƒä¹Ÿæœ‰è‡ªå·±çš„Pipelineå’ŒBasicValveï¼ŒWrapperçš„BasicValveå«**StandardWrapperValve**ã€‚

ä½ å¯ä»¥æƒ³åˆ°ï¼Œå½“è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒContextå®¹å™¨çš„BasicValveä¼šè°ƒç”¨Wrapperå®¹å™¨ä¸­Pipelineä¸­çš„ç¬¬ä¸€ä¸ªValveï¼Œç„¶åä¼šè°ƒç”¨åˆ°StandardWrapperValveã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒçš„invokeæ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼ŒåŒæ ·ä¸ºäº†æ–¹ä¾¿ä½ é˜…è¯»ï¼Œæˆ‘ç®€åŒ–äº†ä»£ç ï¼š

```
public final void invoke(Request request, Response response) {

    //1.å®ä¾‹åŒ–Servlet
    servlet = wrapper.allocate();
   
    //2.ç»™å½“å‰è¯·æ±‚åˆ›å»ºä¸€ä¸ªFilteré“¾
    ApplicationFilterChain filterChain =
        ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);

   //3. è°ƒç”¨è¿™ä¸ªFilteré“¾ï¼ŒFilteré“¾ä¸­çš„æœ€åä¸€ä¸ªFilterä¼šè°ƒç”¨Servlet
   filterChain.doFilter(request.getRequest(), response.getResponse());

}
```

StandardWrapperValveçš„invokeæ–¹æ³•æ¯”è¾ƒå¤æ‚ï¼Œå»æ‰å…¶ä»–å¼‚å¸¸å¤„ç†çš„ä¸€äº›ç»†èŠ‚ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸‰æ­¥ï¼š

- ç¬¬ä¸€æ­¥ï¼Œåˆ›å»ºServletå®ä¾‹ï¼›
- ç¬¬äºŒæ­¥ï¼Œç»™å½“å‰è¯·æ±‚åˆ›å»ºä¸€ä¸ªFilteré“¾ï¼›
- ç¬¬ä¸‰æ­¥ï¼Œè°ƒç”¨è¿™ä¸ªFilteré“¾ã€‚

ä½ å¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆéœ€è¦ç»™æ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªFilteré“¾ï¼Ÿè¿™æ˜¯å› ä¸ºæ¯ä¸ªè¯·æ±‚çš„è¯·æ±‚è·¯å¾„éƒ½ä¸ä¸€æ ·ï¼Œè€ŒFilteréƒ½æœ‰ç›¸åº”çš„è·¯å¾„æ˜ å°„ï¼Œå› æ­¤ä¸æ˜¯æ‰€æœ‰çš„Filteréƒ½éœ€è¦æ¥å¤„ç†å½“å‰çš„è¯·æ±‚ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®è¯·æ±‚çš„è·¯å¾„æ¥é€‰æ‹©ç‰¹å®šçš„ä¸€äº›Filteræ¥å¤„ç†ã€‚

ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰çœ‹åˆ°è°ƒåˆ°Servletçš„serviceæ–¹æ³•ï¼Ÿè¿™æ˜¯å› ä¸ºFilteré“¾çš„doFilteræ–¹æ³•ä¼šè´Ÿè´£è°ƒç”¨Servletï¼Œå…·ä½“æ¥è¯´å°±æ˜¯Filteré“¾ä¸­çš„æœ€åä¸€ä¸ªFilterä¼šè´Ÿè´£è°ƒç”¨Servletã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹Filterçš„å®ç°åŸç†ã€‚

## Filterç®¡ç†

æˆ‘ä»¬çŸ¥é“ï¼Œè·ŸServletä¸€æ ·ï¼ŒFilterä¹Ÿå¯ä»¥åœ¨`web.xml`æ–‡ä»¶é‡Œè¿›è¡Œé…ç½®ï¼Œä¸åŒçš„æ˜¯ï¼ŒFilterçš„ä½œç”¨åŸŸæ˜¯æ•´ä¸ªWebåº”ç”¨ï¼Œå› æ­¤Filterçš„å®ä¾‹æ˜¯åœ¨Contextå®¹å™¨ä¸­è¿›è¡Œç®¡ç†çš„ï¼ŒContextå®¹å™¨ç”¨Mapé›†åˆæ¥ä¿å­˜Filterã€‚

```
private Map<String, FilterDef> filterDefs = new HashMap<>();
```

é‚£ä¸Šé¢æåˆ°çš„Filteré“¾åˆæ˜¯ä»€ä¹ˆå‘¢ï¼ŸFilteré“¾çš„å­˜æ´»æœŸå¾ˆçŸ­ï¼Œå®ƒæ˜¯è·Ÿæ¯ä¸ªè¯·æ±‚å¯¹åº”çš„ã€‚ä¸€ä¸ªæ–°çš„è¯·æ±‚æ¥äº†ï¼Œå°±åŠ¨æ€åˆ›å»ºä¸€ä¸ªFilteré“¾ï¼Œè¯·æ±‚å¤„ç†å®Œäº†ï¼ŒFilteré“¾ä¹Ÿå°±è¢«å›æ”¶äº†ã€‚ç†è§£å®ƒçš„åŸç†ä¹Ÿéå¸¸å…³é”®ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹çœ‹æºç ï¼š

```
public final class ApplicationFilterChain implements FilterChain {
  
  //Filteré“¾ä¸­æœ‰Filteræ•°ç»„ï¼Œè¿™ä¸ªå¥½ç†è§£
  private ApplicationFilterConfig[] filters = new ApplicationFilterConfig[0];
    
  //Filteré“¾ä¸­çš„å½“å‰çš„è°ƒç”¨ä½ç½®
  private int pos = 0;
    
  //æ€»å…±æœ‰å¤šå°‘äº†Filter
  private int n = 0;

  //æ¯ä¸ªFilteré“¾å¯¹åº”ä¸€ä¸ªServletï¼Œä¹Ÿå°±æ˜¯å®ƒè¦è°ƒç”¨çš„Servlet
  private Servlet servlet = null;
  
  public void doFilter(ServletRequest req, ServletResponse res) {
        internalDoFilter(request,response);
  }
   
  private void internalDoFilter(ServletRequest req,
                                ServletResponse res){

    // æ¯ä¸ªFilteré“¾åœ¨å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªFilteræ•°ç»„
    if (pos < n) {
        ApplicationFilterConfig filterConfig = filters[pos++];
        Filter filter = filterConfig.getFilter();

        filter.doFilter(request, response, this);
        return;
    }

    servlet.service(request, response);
   
}
```

ä»ApplicationFilterChainçš„æºç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‡ ä¸ªå…³é”®ä¿¡æ¯ï¼š

1. Filteré“¾ä¸­é™¤äº†æœ‰Filterå¯¹è±¡çš„æ•°ç»„ï¼Œè¿˜æœ‰ä¸€ä¸ªæ•´æ•°å˜é‡posï¼Œè¿™ä¸ªå˜é‡ç”¨æ¥è®°å½•å½“å‰è¢«è°ƒç”¨çš„Filteråœ¨æ•°ç»„ä¸­çš„ä½ç½®ã€‚
2. Filteré“¾ä¸­æœ‰ä¸ªServletå®ä¾‹ï¼Œè¿™ä¸ªå¥½ç†è§£ï¼Œå› ä¸ºä¸Šé¢æåˆ°äº†ï¼Œæ¯ä¸ªFilteré“¾æœ€åéƒ½ä¼šè°ƒåˆ°ä¸€ä¸ªServletã€‚
3. Filteré“¾æœ¬èº«ä¹Ÿå®ç°äº†doFilteræ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨äº†ä¸€ä¸ªå†…éƒ¨æ–¹æ³•internalDoFilterã€‚
4. internalDoFilteræ–¹æ³•çš„å®ç°æ¯”è¾ƒæœ‰æ„æ€ï¼Œå®ƒåšäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœå½“å‰Filterçš„ä½ç½®å°äºFilteræ•°ç»„çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´Filterè¿˜æ²¡è°ƒå®Œï¼Œå°±ä»Filteræ•°ç»„æ‹¿ä¸‹ä¸€ä¸ªFilterï¼Œè°ƒç”¨å®ƒçš„doFilteræ–¹æ³•ã€‚å¦åˆ™ï¼Œæ„å‘³ç€æ‰€æœ‰Filteréƒ½è°ƒåˆ°äº†ï¼Œå°±è°ƒç”¨Servletçš„serviceæ–¹æ³•ã€‚

ä½†é—®é¢˜æ˜¯ï¼Œæ–¹æ³•ä½“é‡Œæ²¡çœ‹åˆ°å¾ªç¯ï¼Œè°åœ¨ä¸åœåœ°è°ƒç”¨Filteré“¾çš„doFilteræ–¹æ³•å‘¢ï¼ŸFilteræ˜¯æ€ä¹ˆä¾æ¬¡è°ƒåˆ°çš„å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯**Filteræœ¬èº«çš„doFilteræ–¹æ³•ä¼šè°ƒç”¨Filteré“¾çš„doFilteræ–¹æ³•**ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹çœ‹ä»£ç å°±æ˜ç™½äº†ï¼š

```
public void doFilter(ServletRequest request, ServletResponse response,
        FilterChain chain){
        
          ...
          
          //è°ƒç”¨Filterçš„æ–¹æ³•
          chain.doFilter(request, response);
      
      }
```

æ³¨æ„Filterçš„doFilteræ–¹æ³•æœ‰ä¸ªå…³é”®å‚æ•°FilterChainï¼Œå°±æ˜¯Filteré“¾ã€‚å¹¶ä¸”æ¯ä¸ªFilteråœ¨å®ç°doFilteræ—¶ï¼Œå¿…é¡»è¦è°ƒç”¨Filteré“¾çš„doFilteræ–¹æ³•ï¼Œè€ŒFilteré“¾ä¸­ä¿å­˜å½“å‰Filterçš„ä½ç½®ï¼Œä¼šè°ƒç”¨ä¸‹ä¸€ä¸ªFilterçš„doFilteræ–¹æ³•ï¼Œè¿™æ ·é“¾å¼è°ƒç”¨å°±å®Œæˆäº†ã€‚

Filteré“¾è·ŸTomcatçš„Pipeline-Valveæœ¬è´¨éƒ½æ˜¯è´£ä»»é“¾æ¨¡å¼ï¼Œä½†æ˜¯åœ¨å…·ä½“å®ç°ä¸Šç¨æœ‰ä¸åŒï¼Œä½ å¯ä»¥ç»†ç»†ä½“ä¼šä¸€ä¸‹ã€‚

## Listenerç®¡ç†

æˆ‘ä»¬æ¥ç€èŠServletè§„èŒƒé‡ŒListenerã€‚è·ŸFilterä¸€æ ·ï¼ŒListenerä¹Ÿæ˜¯ä¸€ç§æ‰©å±•æœºåˆ¶ï¼Œä½ å¯ä»¥ç›‘å¬å®¹å™¨å†…éƒ¨å‘ç”Ÿçš„äº‹ä»¶ï¼Œä¸»è¦æœ‰ä¸¤ç±»äº‹ä»¶ï¼š

- ç¬¬ä¸€ç±»æ˜¯ç”Ÿå‘½çŠ¶æ€çš„å˜åŒ–ï¼Œæ¯”å¦‚Contextå®¹å™¨å¯åŠ¨å’Œåœæ­¢ã€Sessionçš„åˆ›å»ºå’Œé”€æ¯ã€‚
- ç¬¬äºŒç±»æ˜¯å±æ€§çš„å˜åŒ–ï¼Œæ¯”å¦‚Contextå®¹å™¨æŸä¸ªå±æ€§å€¼å˜äº†ã€Sessionçš„æŸä¸ªå±æ€§å€¼å˜äº†ä»¥åŠæ–°çš„è¯·æ±‚æ¥äº†ç­‰ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨`web.xml`é…ç½®æˆ–è€…é€šè¿‡æ³¨è§£çš„æ–¹å¼æ¥æ·»åŠ ç›‘å¬å™¨ï¼Œåœ¨ç›‘å¬å™¨é‡Œå®ç°æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ã€‚å¯¹äºTomcatæ¥è¯´ï¼Œå®ƒéœ€è¦è¯»å–é…ç½®æ–‡ä»¶ï¼Œæ‹¿åˆ°ç›‘å¬å™¨ç±»çš„åå­—ï¼Œå®ä¾‹åŒ–è¿™äº›ç±»ï¼Œå¹¶ä¸”åœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨è¿™äº›ç›‘å¬å™¨çš„æ–¹æ³•ã€‚

Tomcatæ˜¯é€šè¿‡Contextå®¹å™¨æ¥ç®¡ç†è¿™äº›ç›‘å¬å™¨çš„ã€‚Contextå®¹å™¨å°†ä¸¤ç±»äº‹ä»¶åˆ†å¼€æ¥ç®¡ç†ï¼Œåˆ†åˆ«ç”¨ä¸åŒçš„é›†åˆæ¥å­˜æ”¾ä¸åŒç±»å‹äº‹ä»¶çš„ç›‘å¬å™¨ï¼š

```
//ç›‘å¬å±æ€§å€¼å˜åŒ–çš„ç›‘å¬å™¨
private List<Object> applicationEventListenersList = new CopyOnWriteArrayList<>();

//ç›‘å¬ç”Ÿå‘½äº‹ä»¶çš„ç›‘å¬å™¨
private Object applicationLifecycleListenersObjects[] = new Object[0];
```

å‰©ä¸‹çš„äº‹æƒ…å°±æ˜¯è§¦å‘ç›‘å¬å™¨äº†ï¼Œæ¯”å¦‚åœ¨Contextå®¹å™¨çš„å¯åŠ¨æ–¹æ³•é‡Œï¼Œå°±è§¦å‘äº†æ‰€æœ‰çš„ServletContextListenerï¼š

```
//1.æ‹¿åˆ°æ‰€æœ‰çš„ç”Ÿå‘½å‘¨æœŸç›‘å¬å™¨
Object instances[] = getApplicationLifecycleListeners();

for (int i = 0; i < instances.length; i++) {
   //2. åˆ¤æ–­Listenerçš„ç±»å‹æ˜¯ä¸æ˜¯ServletContextListener
   if (!(instances[i] instanceof ServletContextListener))
      continue;

   //3.è§¦å‘Listenerçš„æ–¹æ³•
   ServletContextListener lr = (ServletContextListener) instances[i];
   lr.contextInitialized(event);
}
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ServletContextListeneræ¥å£æ˜¯ä¸€ç§ç•™ç»™ç”¨æˆ·çš„æ‰©å±•æœºåˆ¶ï¼Œç”¨æˆ·å¯ä»¥å®ç°è¿™ä¸ªæ¥å£æ¥å®šä¹‰è‡ªå·±çš„ç›‘å¬å™¨ï¼Œç›‘å¬Contextå®¹å™¨çš„å¯åœäº‹ä»¶ã€‚Springå°±æ˜¯è¿™ä¹ˆåšçš„ã€‚ServletContextListenerè·ŸTomcatè‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶LifecycleListeneræ˜¯ä¸åŒçš„ã€‚LifecycleListenerå®šä¹‰åœ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ç»„ä»¶ä¸­ï¼Œç”±åŸºç±»LifecycleBaseç»Ÿä¸€ç®¡ç†ã€‚

## æœ¬æœŸç²¾å

Servletè§„èŒƒä¸­æœ€é‡è¦çš„å°±æ˜¯Servletã€Filterå’ŒListenerâ€œä¸‰å…„å¼Ÿâ€ã€‚Webå®¹å™¨æœ€é‡è¦çš„èŒèƒ½å°±æ˜¯æŠŠå®ƒä»¬åˆ›å»ºå‡ºæ¥ï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶å€™è°ƒç”¨å®ƒä»¬çš„æ–¹æ³•ã€‚

Tomcaté€šè¿‡Wrapperå®¹å™¨æ¥ç®¡ç†Servletï¼ŒWrapperåŒ…è£…äº†Servletæœ¬èº«ä»¥åŠç›¸åº”çš„å‚æ•°ï¼Œè¿™ä½“ç°äº†é¢å‘å¯¹è±¡ä¸­â€œå°è£…â€çš„è®¾è®¡åŸåˆ™ã€‚

Tomcatä¼šç»™**æ¯ä¸ªè¯·æ±‚ç”Ÿæˆä¸€ä¸ªFilteré“¾**ï¼ŒFilteré“¾ä¸­çš„æœ€åä¸€ä¸ªFilterä¼šè´Ÿè´£è°ƒç”¨Servletçš„serviceæ–¹æ³•ã€‚

å¯¹äºListeneræ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶è‡ªå·±çš„ç›‘å¬å™¨æ¥ç›‘å¬Tomcatå†…éƒ¨å‘ç”Ÿçš„å„ç§äº‹ä»¶ï¼šåŒ…æ‹¬Webåº”ç”¨çº§åˆ«çš„ã€Sessionçº§åˆ«çš„å’Œè¯·æ±‚çº§åˆ«çš„ã€‚Tomcatä¸­çš„Contextå®¹å™¨ç»Ÿä¸€ç»´æŠ¤äº†è¿™äº›ç›‘å¬å™¨ï¼Œå¹¶è´Ÿè´£è§¦å‘ã€‚

æœ€åå°ç»“ä¸€ä¸‹è¿™3æœŸå†…å®¹ï¼ŒContextç»„ä»¶é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥åŠ è½½Webåº”ç”¨ï¼Œå¹¶å®ç°äº†Servletè§„èŒƒï¼Œç›´æ¥è·ŸWebåº”ç”¨æ‰“äº¤é“ï¼Œæ˜¯ä¸€ä¸ªæ ¸å¿ƒçš„å®¹å™¨ç»„ä»¶ã€‚ä¹Ÿå› æ­¤æˆ‘ç”¨äº†å¾ˆé‡çš„ç¯‡å¹…å»è®²è§£å®ƒï¼Œä¹Ÿéå¸¸å»ºè®®ä½ èŠ±ç‚¹æ—¶é—´é˜…è¯»ä¸€ä¸‹å®ƒçš„æºç ã€‚

## è¯¾åæ€è€ƒ

Contextå®¹å™¨åˆ†åˆ«ç”¨äº†CopyOnWriteArrayListå’Œå¯¹è±¡æ•°ç»„æ¥å­˜å‚¨ä¸¤ç§ä¸åŒçš„ç›‘å¬å™¨ï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Œä½ å¯ä»¥æ€è€ƒä¸€ä¸‹èƒŒåçš„åŸå› ã€‚

ä¸çŸ¥é“ä»Šå¤©çš„å†…å®¹ä½ æ¶ˆåŒ–å¾—å¦‚ä½•ï¼Ÿå¦‚æœè¿˜æœ‰ç–‘é—®ï¼Œè¯·å¤§èƒ†çš„åœ¨ç•™è¨€åŒºæé—®ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä½ çš„è¯¾åæ€è€ƒå’Œå¿ƒå¾—è®°å½•ä¸‹æ¥ï¼Œä¸æˆ‘å’Œå…¶ä»–åŒå­¦ä¸€èµ·è®¨è®ºã€‚å¦‚æœä½ è§‰å¾—ä»Šå¤©æœ‰æ‰€æ”¶è·ï¼Œæ¬¢è¿ä½ æŠŠå®ƒåˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>-W.LI-</span> ğŸ‘ï¼ˆ32ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>å±æ€§å€¼å˜åŒ–listenerèƒ½åŠ¨æ€é…ç½®ï¼Œæ‰€ä»¥ç”¨CopyOnWriteArrayã€‚ç”Ÿå‘½å‘¨æœŸäº‹ä»¶listenerï¼Œä¸èƒ½åŠ¨æ€æ”¹å˜æ²¡æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜?
</p>2019-07-09</li><br/><li><span>yang</span> ğŸ‘ï¼ˆ9ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>å•Šå•Šå•Š è€å¸ˆå†å†™ä¸€ä¸ªæ·±å…¥æ‹†è§£spring æˆ–è€…springboot çš„ä¸“æ å§ å’Œtomcatå½¢æˆå…„å¼Ÿä¸“æ  å®šä»·æ¯”è¿™ä¸ªè´µ2ï½3å€ æ‚¨è´Ÿè´£å†™ æˆ‘ä»¬å’Œæå®¢æ—¶é—´çš„å¹³å°è´Ÿè´£å¤§å–</p>2019-08-21</li><br/><li><span>é£ç¿”</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆæˆ‘éœ€è¦æ‰‹åŠ¨åŠ ä¸€ä¸ªfilterï¼Œä¸èƒ½ç”¨annotationæˆ–æ˜¯xmlã€æˆ‘æ˜¯ä¸æ˜¯éœ€è¦è°ƒç”¨standardcontexté‡Œè¾¹çš„addfilterdefå’Œaddfiltermapè¿™ä¸¤ä¸ªå‡½æ•°å°±è¡Œäº†ï¼Ÿ</p>2019-07-09</li><br/><li><span>calljson</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯·æ•™ä¸‹è€å¸ˆï¼Œserverletçš„serviceæ–¹æ³•ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿä»…ä»…æ˜¯åˆ†å‘è¯·æ±‚å—ï¼Ÿ</p>2019-07-16</li><br/><li><span>Nu11PointerEx</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆæˆ‘æƒ³é—®ä¸€ä¸‹ï¼Œå¯¹åº”çš„filteræ˜¯æ€ä¹ˆæ³¨å†Œåˆ°servletä¸­å»çš„</p>2019-07-19</li><br/><li><span>éæƒ³</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ5ï¼‰<p>è€å¸ˆæ‚¨å¥½ï¼Œçœ‹ä½ çš„æ–‡ç« servletå®¹å™¨ä¸­çš„ä¸‰ä¸ªç»„ä»¶servletï¼Œfilterï¼Œlinsteneréƒ½æ˜¯ç”±contextå®¹å™¨ç®¡ç†çš„å¯¹å—ï¼Ÿ</p>2019-07-09</li><br/><li><span>é£ç¿”</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>private Map&lt;String, FilterDef&gt; filterDefs = new HashMap&lt;&gt;();
è€å¸ˆ æ‚¨è¯´ filteræ”¾åœ¨mapé‡Œè¾¹ï¼Œç”±contextç®¡ç†ï¼Œç„¶åæˆ‘çœ‹ æ‚¨åè¾¹æ°¸ç¡• filteræ˜¯wrapperç®¡ç†çš„ è¿™ä¸ªä¸æ˜¯çŸ›ç›¾å˜›</p>2019-07-23</li><br/><li><span>é£ç¿”</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯è¯´ host engine å’Œcontext éƒ½æœ‰piplineå®ç°çš„è´£ä»»é“¾ï¼Œwrapperæ²¡æœ‰pipline è€Œæ˜¯ç”¨filter å®ç°çš„è´£ä»»é“¾æ˜¯å§</p>2019-07-23</li><br/><li><span>Monday</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ€è€ƒé¢˜ä¸¤ç§æ•°æ®ç»“æ„æˆ‘èƒ½åŒºåˆ†å¼€æ¥ï¼Œä½†æ˜¯è¿˜æ˜¯å›ç­”ä¸ä¸Šæ¥ã€‚ã€‚ã€‚</p>2019-07-11</li><br/><li><span>nightmare</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„ç±»æ¯”å¦‚sessionä¸€ä¸ªç”¨æˆ·åˆ†é…ä¸€ä¸ªï¼Œç”¨å®Œäº†å°±ä¼šé”€æ¯ï¼Œç”¨å¯¹è±¡æ•°ç»„ï¼Œå¯ä»¥é€‚åº”å¢åˆ æ”¹æ“ä½œï¼Œè€Œå±æ€§å˜åŒ–ï¼Œå†™ä¸ä¼šé‚£ä¹ˆé¢‘ç¹ï¼Œè¯»å–æ¯”è¾ƒé¢‘ç¹</p>2019-07-09</li><br/><li><span>ç¿æ–‡å½¬</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æœ€åä¸€ä¸ªé—®é¢˜, ä¸€å¼€å§‹ä¸¤ç§Listeneréƒ½æ˜¯ä½¿ç”¨Object[]è£…ç€çš„,
æˆ‘å»ç¿»äº†ä¸€ä¸‹githubçš„æäº¤è®°å½•, Sep 15, 2015, @markt-asfæäº¤äº†ä¸€æ¬¡ä¿®æ”¹, å°†applicationEventListenersListæ”¹æˆäº†CopyOnWriteArrayList

åŸå› æ˜¯ä¸‹é¢è¿™ä¸ªBug, https:&#47;&#47;bz.apache.org&#47;bugzilla&#47;show_bug.cgi?id=58373, è´´ä¸Šæ¥ä»¥ä¾›å¤§å®¶å‚è€ƒ

ApplicationContext#addListeneræ–¹æ³•ä¸­ä¹Ÿæœ‰ä¿®æ”¹applicationLifecycleListenersObjectsçš„ä»£ç , æ‰€ä»¥æˆ‘è®¤ä¸º&quot;ç”Ÿå‘½å‘¨æœŸäº‹ä»¶listenerä¸èƒ½åŠ¨æ€æ”¹å˜&quot;æ˜¯é”™è¯¯çš„, è¿™é‡Œä¿®æ”¹æˆCopyOnWriteArrayListæˆ–è®¸æ›´å¥½?</p>2023-02-24</li><br/><li><span>Standly</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>åå‘æ¨å¯¼çŒœä¸‹ï¼Œç”Ÿå‘½çŠ¶æ€å˜åŒ–éƒ½åœ¨å•çº¿ç¨‹ä¸­ï¼Œæ²¡æœ‰å¹¶å‘é—®é¢˜ã€‚å±æ€§å˜åŒ–æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä½†åˆä¸é¢‘ç¹ã€‚</p>2019-07-12</li><br/><li><span>James</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>é—®ç­”é¢˜çš„æ•°æ®ç»“æ„èƒ½åŒºåˆ†ã€‚ã€‚ä½†æ˜¯æœ€ç»ˆç­”æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿ</p>2021-03-21</li><br/><li><span>pj</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>FilterChainæ‰§è¡Œå®Œæ¯•ï¼Œæ‰€æœ‰çš„filteræ‰§è¡Œå®Œä»¥åæ‰æ‰§è¡Œserviceæ–¹æ³•ï¼Œè€ŒçœŸæ­£çš„responseåœ¨serviceè¿”å›åæ‰èƒ½æ‹¿åˆ°ã€‚filteræ²¡æœ‰èµ·åˆ°è¿‡æ»¤responseçš„ä½œç”¨å•Šã€‚æ²¡æœ‰æƒ³æ˜ç™½ã€‚</p>2020-06-11</li><br/><li><span>é äººå“å»èµ¢</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æƒ³é—®ä¸€ä¸‹Tomcatä¼šç»™æ¯ä¸€ä¸ªè¯·æ±‚éƒ½ç”Ÿæˆä¸€ä¸ªFilteré“¾ï¼Œæ¯”å¦‚è¯´å¾ˆå¤šè¯·æ±‚çš„Filteré“¾éƒ½å·®ä¸å¤šï¼ŒTomcatä¼šä¸ä¼šå¯¹è¿™äº›ä¸€æ ·çš„é“¾æœ‰ä¸€ä¸ªå¤„ç†ï¼Œè¿˜æ˜¯ä¸€ä¸ªè¯·æ±‚ä¸€æ¡é“¾è°ƒç”¨å®ŒServletå°±æŠŠè¿™ä¸ªé“¾ä¸Šçš„Filteréƒ½é‡Šæ”¾æ‰ï¼Ÿ</p>2019-11-05</li><br/>
</ul>