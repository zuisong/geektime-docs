ä½ å¥½ï¼Œæˆ‘æ˜¯ç››å»¶æ•ï¼Œè¿™é‡Œæ˜¯ç½‘ç»œç¼–ç¨‹å®æˆ˜çš„ç¬¬14è®²ï¼Œæ¬¢è¿å›æ¥ã€‚

åœ¨å‰é¢çš„åŸºç¡€ç¯‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ¥è§¦åˆ°äº†UDPæ•°æ®æŠ¥åè®®ç›¸å…³çš„çŸ¥è¯†ï¼Œåœ¨æˆ‘ä»¬çš„è„‘æµ·é‡Œï¼Œå·²ç»æ·±æ·±å°ä¸Šäº†â€œ**UDP ç­‰äºæ— è¿æ¥åè®®**â€çš„ç‰¹æ€§ã€‚é‚£ä¹ˆçœ‹åˆ°è¿™ä¸€è®²çš„é¢˜ç›®ï¼Œä½ æ˜¯ä¸æ˜¯è§‰å¾—æœ‰ç‚¹å›°æƒ‘ï¼Ÿæ²¡å…³ç³»ï¼Œå’Œæˆ‘ä¸€èµ·è¿›å…¥â€œå·²è¿æ¥â€çš„UDPçš„ä¸–ç•Œï¼Œå›å¤´å†çœ‹è¿™ä¸ªæ ‡é¢˜ï¼Œç›¸ä¿¡ä½ å°±ä¼šæç„¶å¤§æ‚Ÿã€‚

## ä»ä¸€ä¸ªä¾‹å­å¼€å§‹

æˆ‘ä»¬å…ˆä»ä¸€ä¸ªå®¢æˆ·ç«¯ä¾‹å­å¼€å§‹ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå®¢æˆ·ç«¯åœ¨UDPå¥—æ¥å­—ä¸Šè°ƒç”¨connectå‡½æ•°ï¼Œä¹‹åå°†æ ‡å‡†è¾“å…¥çš„å­—ç¬¦ä¸²å‘é€åˆ°æœåŠ¡å™¨ç«¯ï¼Œå¹¶ä»æœåŠ¡å™¨ç«¯æ¥æ”¶å¤„ç†åçš„æŠ¥æ–‡ã€‚å½“ç„¶ï¼Œå‘æœåŠ¡å™¨ç«¯å‘é€å’Œæ¥æ”¶æŠ¥æ–‡æ˜¯é€šè¿‡è°ƒç”¨å‡½æ•°sendtoå’Œrecvfromæ¥å®Œæˆçš„ã€‚

```
#include "lib/common.h"
# define    MAXLINE     4096

int main(int argc, char **argv) {
    if (argc != 2) {
        error(1, 0, "usage: udpclient1 <IPaddress>");
    }

    int socket_fd;
    socket_fd = socket(AF_INET, SOCK_DGRAM, 0);

    struct sockaddr_in server_addr;
    bzero(&server_addr, sizeof(server_addr));
    server_addr.sin_family = AF_INET;
    server_addr.sin_port = htons(SERV_PORT);
    inet_pton(AF_INET, argv[1], &server_addr.sin_addr);

    socklen_t server_len = sizeof(server_addr);

    if (connect(socket_fd, (struct sockaddr *) &server_addr, server_len)) {
        error(1, errno, "connect failed");
    }

    struct sockaddr *reply_addr;
    reply_addr = malloc(server_len);

    char send_line[MAXLINE], recv_line[MAXLINE + 1];
    socklen_t len;
    int n;

    while (fgets(send_line, MAXLINE, stdin) != NULL) {
        int i = strlen(send_line);
        if (send_line[i - 1] == '\n') {
            send_line[i - 1] = 0;
        }

        printf("now sending %s\n", send_line);
        size_t rt = sendto(socket_fd, send_line, strlen(send_line), 0, (struct sockaddr *) &server_addr, server_len);
        if (rt < 0) {
            error(1, errno, "sendto failed");
        }
        printf("send bytes: %zu \n", rt);
        
        len = 0;
        recv_line[0] = 0;
        n = recvfrom(socket_fd, recv_line, MAXLINE, 0, reply_addr, &len);
        if (n < 0)
            error(1, errno, "recvfrom failed");
        recv_line[n] = 0;
        fputs(recv_line, stdout);
        fputs("\n", stdout);
    }

    exit(0);
}
```

æˆ‘å¯¹è¿™ä¸ªç¨‹åºåšä¸€ä¸ªç®€å•çš„è§£é‡Šï¼š

- 9-10è¡Œåˆ›å»ºäº†ä¸€ä¸ªUDPå¥—æ¥å­—ï¼›
- 12-16è¡Œåˆ›å»ºäº†ä¸€ä¸ªIPv4åœ°å€ï¼Œç»‘å®šåˆ°æŒ‡å®šç«¯å£å’ŒIPï¼›
- **20-22è¡Œè°ƒç”¨connectå°†UDPå¥—æ¥å­—å’ŒIPv4åœ°å€è¿›è¡Œäº†â€œç»‘å®šâ€ï¼Œè¿™é‡Œconnectå‡½æ•°çš„åç§°æœ‰ç‚¹è®©äººè¯¯è§£ï¼Œå…¶å®å¯èƒ½æ›´å¥½çš„é€‰æ‹©æ˜¯å«åšsetpeername**ï¼›
- 31-55è¡Œæ˜¯ç¨‹åºçš„ä¸»ä½“ï¼Œè¯»å–æ ‡å‡†è¾“å…¥å­—ç¬¦ä¸²åï¼Œè°ƒç”¨sendtoå‘é€ç»™å¯¹ç«¯ï¼›ä¹‹åè°ƒç”¨recvfromç­‰å¾…å¯¹ç«¯çš„å“åº”ï¼Œå¹¶æŠŠå¯¹ç«¯å“åº”ä¿¡æ¯æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºã€‚

åœ¨æ²¡æœ‰å¼€å¯æœåŠ¡ç«¯çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿è¡Œä¸€ä¸‹è¿™ä¸ªç¨‹åºï¼š

```
$ ./udpconnectclient 127.0.0.1
g1
now sending g1
send bytes: 2
recvfrom failed: Connection refused (111)
```

çœ‹åˆ°è¿™é‡Œä½ ä¼šä¸ä¼šè§‰å¾—å¾ˆå¥‡æ€ªï¼Ÿä¸æ˜¯è¯´å¥½UDPæ˜¯â€œæ— è¿æ¥â€çš„åè®®å—ï¼Ÿä¸æ˜¯è¯´å¥½UDPå®¢æˆ·ç«¯åªä¼šé˜»å¡åœ¨recvfromè¿™æ ·çš„è°ƒç”¨ä¸Šå—ï¼Ÿæ€ä¹ˆè¿™é‡Œå†’å‡ºä¸€ä¸ªâ€œConnection refusedâ€çš„é”™è¯¯å‘¢ï¼Ÿ

åˆ«ç€æ€¥ï¼Œä¸‹é¢å°±è·Ÿç€æˆ‘çš„æ€è·¯æ…¢æ…¢å»è§£å¼€è¿™ä¸ªè°œå›¢ã€‚

## UDP connectçš„ä½œç”¨

ä»å‰é¢çš„ä¾‹å­ä¸­ï¼Œä½ ä¼šå‘ç°ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹UDPå¥—æ¥å­—è°ƒç”¨connectå‡½æ•°ï¼Œä½†æ˜¯å’ŒTCP connectè°ƒç”¨å¼•èµ·TCPä¸‰æ¬¡æ¡æ‰‹ï¼Œå»ºç«‹TCPæœ‰æ•ˆè¿æ¥ä¸åŒï¼ŒUDP connectå‡½æ•°çš„è°ƒç”¨ï¼Œå¹¶ä¸ä¼šå¼•èµ·å’ŒæœåŠ¡å™¨ç›®æ ‡ç«¯çš„ç½‘ç»œäº¤äº’ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¹¶ä¸ä¼šè§¦å‘æ‰€è°“çš„â€œæ¡æ‰‹â€æŠ¥æ–‡å‘é€å’Œåº”ç­”ã€‚

é‚£ä¹ˆå¯¹UDPå¥—æ¥å­—è¿›è¡Œconnectæ“ä½œåˆ°åº•æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ

å…¶å®ä¸Šé¢çš„ä¾‹å­å·²ç»ç»™å‡ºäº†ç­”æ¡ˆï¼Œè¿™ä¸»è¦æ˜¯ä¸ºäº†è®©åº”ç”¨ç¨‹åºèƒ½å¤Ÿæ¥æ”¶â€œå¼‚æ­¥é”™è¯¯â€çš„ä¿¡æ¯ã€‚

å¦‚æœæˆ‘ä»¬å›æƒ³ä¸€ä¸‹ç¬¬6ç¯‡ä¸è°ƒç”¨connectæ“ä½œçš„å®¢æˆ·ç«¯ç¨‹åºï¼Œåœ¨æœåŠ¡å™¨ç«¯ä¸å¼€å¯çš„æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯ç¨‹åºæ˜¯ä¸ä¼šæŠ¥é”™çš„ï¼Œç¨‹åºåªä¼šé˜»å¡åœ¨recvfromä¸Šï¼Œç­‰å¾…è¿”å›ï¼ˆæˆ–è€…è¶…æ—¶ï¼‰ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡å¯¹UDPå¥—æ¥å­—è¿›è¡Œconnectæ“ä½œï¼Œå°†UDPå¥—æ¥å­—å»ºç«‹äº†â€œä¸Šä¸‹æ–‡â€ï¼Œè¯¥å¥—æ¥å­—å’ŒæœåŠ¡å™¨ç«¯çš„åœ°å€å’Œç«¯å£äº§ç”Ÿäº†è”ç³»ï¼Œæ­£æ˜¯è¿™ç§ç»‘å®šå…³ç³»ç»™äº†æ“ä½œç³»ç»Ÿå†…æ ¸å¿…è¦çš„ä¿¡æ¯ï¼Œèƒ½å¤Ÿå°†æ“ä½œç³»ç»Ÿå†…æ ¸æ”¶åˆ°çš„ä¿¡æ¯å’Œå¯¹åº”çš„å¥—æ¥å­—è¿›è¡Œå…³è”ã€‚

æˆ‘ä»¬å¯ä»¥å±•å¼€è®¨è®ºä¸€ä¸‹ã€‚

äº‹å®ä¸Šï¼Œå½“æˆ‘ä»¬è°ƒç”¨sendtoæˆ–è€…sendæ“ä½œå‡½æ•°æ—¶ï¼Œåº”ç”¨ç¨‹åºæŠ¥æ–‡è¢«å‘é€ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè¿”å›ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸æ¥ç®¡äº†è¯¥æŠ¥æ–‡ï¼Œä¹‹åæ“ä½œç³»ç»Ÿå¼€å§‹å°è¯•å¾€å¯¹åº”çš„åœ°å€å’Œç«¯å£å‘é€ï¼Œå› ä¸ºå¯¹åº”çš„åœ°å€å’Œç«¯å£ä¸å¯è¾¾ï¼Œä¸€ä¸ªICMPæŠ¥æ–‡ä¼šè¿”å›ç»™æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œè¯¥ICMPæŠ¥æ–‡å«æœ‰ç›®çš„åœ°å€å’Œç«¯å£ç­‰ä¿¡æ¯ã€‚

å¦‚æœæˆ‘ä»¬ä¸è¿›è¡Œconnectæ“ä½œï¼Œå»ºç«‹ï¼ˆUDPå¥—æ¥å­—â€”â€”ç›®çš„åœ°å€+ç«¯å£ï¼‰ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸å°±æ²¡æœ‰åŠæ³•æŠŠICMPä¸å¯è¾¾çš„ä¿¡æ¯å’ŒUDPå¥—æ¥å­—è¿›è¡Œå…³è”ï¼Œä¹Ÿå°±æ²¡æœ‰åŠæ³•å°†ICMPä¿¡æ¯é€šçŸ¥ç»™åº”ç”¨ç¨‹åºã€‚

å¦‚æœæˆ‘ä»¬è¿›è¡Œäº†connectæ“ä½œï¼Œå¸®åŠ©æ“ä½œç³»ç»Ÿå†…æ ¸ä»å®¹å»ºç«‹äº†ï¼ˆUDPå¥—æ¥å­—â€”â€”ç›®çš„åœ°å€+ç«¯å£ï¼‰ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œå½“æ”¶åˆ°ä¸€ä¸ªICMPä¸å¯è¾¾æŠ¥æ–‡æ—¶ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸å¯ä»¥ä»æ˜ å°„è¡¨ä¸­æ‰¾å‡ºæ˜¯å“ªä¸ªUDPå¥—æ¥å­—æ‹¥æœ‰è¯¥ç›®çš„åœ°å€å’Œç«¯å£ï¼Œåˆ«å¿˜äº†å¥—æ¥å­—åœ¨æ“ä½œç³»ç»Ÿå†…éƒ¨æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå½“æˆ‘ä»¬åœ¨è¯¥å¥—æ¥å­—ä¸Šå†æ¬¡è°ƒç”¨recvfromæˆ–recvæ–¹æ³•æ—¶ï¼Œå°±å¯ä»¥æ”¶åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸è¿”å›çš„â€œConnection Refusedâ€çš„ä¿¡æ¯ã€‚

## æ”¶å‘å‡½æ•°

åœ¨å¯¹UDPè¿›è¡Œconnectä¹‹åï¼Œå…³äºæ”¶å‘å‡½æ•°çš„ä½¿ç”¨ï¼Œå¾ˆå¤šä¹¦ç±æ˜¯è¿™æ ·æ¨èçš„ï¼š

- ä½¿ç”¨sendæˆ–writeå‡½æ•°æ¥å‘é€ï¼Œå¦‚æœä½¿ç”¨sendtoéœ€è¦æŠŠç›¸å…³çš„toåœ°å€ä¿¡æ¯ç½®é›¶ï¼›
- ä½¿ç”¨recvæˆ–readå‡½æ•°æ¥æ¥æ”¶ï¼Œå¦‚æœä½¿ç”¨recvfroméœ€è¦æŠŠå¯¹åº”çš„fromåœ°å€ä¿¡æ¯ç½®é›¶ã€‚

å…¶å®ä¸åŒçš„UNIXå®ç°å¯¹æ­¤è¡¨ç°å‡ºæ¥çš„è¡Œä¸ºä¸å°½ç›¸åŒã€‚

åœ¨æˆ‘çš„Linux 4.4.0ç¯å¢ƒä¸­ï¼Œä½¿ç”¨sendtoå’Œrecvfromï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¿½ç•¥toå’Œfromä¿¡æ¯ã€‚åœ¨æˆ‘çš„macOS 10.13ä¸­ï¼Œç¡®å®éœ€è¦éµå®ˆè¿™æ ·çš„è§„å®šï¼Œä½¿ç”¨sendtoæˆ–recvfromä¼šå¾—åˆ°ä¸€äº›å¥‡æ€ªçš„ç»“æœï¼Œåˆ‡å›sendå’Œrecvåæ­£å¸¸ã€‚

è€ƒè™‘åˆ°å…¼å®¹æ€§ï¼Œæˆ‘ä»¬ä¹Ÿæ¨èè¿™äº›å¸¸è§„åšæ³•ã€‚æ‰€ä»¥åœ¨æ¥ä¸‹æ¥çš„ç¨‹åºä¸­ï¼Œæˆ‘ä¼šä½¿ç”¨è¿™æ ·çš„åšæ³•æ¥å®ç°ã€‚

## æœåŠ¡å™¨ç«¯connectçš„ä¾‹å­

ä¸€èˆ¬æ¥è¯´ï¼ŒæœåŠ¡å™¨ç«¯ä¸ä¼šä¸»åŠ¨å‘èµ·connectæ“ä½œï¼Œå› ä¸ºä¸€æ—¦å¦‚æ­¤ï¼ŒæœåŠ¡å™¨ç«¯å°±åªèƒ½å“åº”ä¸€ä¸ªå®¢æˆ·ç«¯äº†ã€‚ä¸è¿‡ï¼Œæœ‰æ—¶å€™ä¹Ÿä¸æ’é™¤è¿™æ ·çš„æƒ…å½¢ï¼Œä¸€æ—¦ä¸€ä¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯å‘é€UDPæŠ¥æ–‡ä¹‹åï¼Œè¯¥æœåŠ¡å™¨ç«¯å°±è¦æœåŠ¡äºè¿™ä¸ªå”¯ä¸€çš„å®¢æˆ·ç«¯ã€‚

ä¸€ä¸ªç±»ä¼¼çš„æœåŠ¡å™¨ç«¯ç¨‹åºå¦‚ä¸‹ï¼š

```
#include "lib/common.h"

static int count;

static void recvfrom_int(int signo) {
    printf("\nreceived %d datagrams\n", count);
    exit(0);
}

int main(int argc, char **argv) {
    int socket_fd;
    socket_fd = socket(AF_INET, SOCK_DGRAM, 0);

    struct sockaddr_in server_addr;
    bzero(&server_addr, sizeof(server_addr));
    server_addr.sin_family = AF_INET;
    server_addr.sin_addr.s_addr = htonl(INADDR_ANY);
    server_addr.sin_port = htons(SERV_PORT);

    bind(socket_fd, (struct sockaddr *) &server_addr, sizeof(server_addr));

    socklen_t client_len;
    char message[MAXLINE];
    message[0] = 0;
    count = 0;

    signal(SIGINT, recvfrom_int);

    struct sockaddr_in client_addr;
    client_len = sizeof(client_addr);

    int n = recvfrom(socket_fd, message, MAXLINE, 0, (struct sockaddr *) &client_addr, &client_len);
    if (n < 0) {
        error(1, errno, "recvfrom failed");
    }
    message[n] = 0;
    printf("received %d bytes: %s\n", n, message);

    if (connect(socket_fd, (struct sockaddr *) &client_addr, client_len)) {
        error(1, errno, "connect failed");
    }

    while (strncmp(message, "goodbye", 7) != 0) {
        char send_line[MAXLINE];
        sprintf(send_line, "Hi, %s", message);

        size_t rt = send(socket_fd, send_line, strlen(send_line), 0);
        if (rt < 0) {
            error(1, errno, "send failed ");
        }
        printf("send bytes: %zu \n", rt);

        size_t rc = recv(socket_fd, message, MAXLINE, 0);
        if (rc < 0) {
            error(1, errno, "recv failed");
        }
        
        count++;
    }

    exit(0);
}
```

æˆ‘å¯¹è¿™ä¸ªç¨‹åºåšä¸‹è§£é‡Šï¼š

- 11-12è¡Œåˆ›å»ºUDPå¥—æ¥å­—ï¼›
- 14-18è¡Œåˆ›å»ºIPv4åœ°å€ï¼Œç»‘å®šåˆ°ANYå’Œå¯¹åº”ç«¯å£ï¼›
- 20è¡Œç»‘å®šUDPå¥—æ¥å­—å’ŒIPv4åœ°å€ï¼›
- 27è¡Œä¸ºè¯¥ç¨‹åºæ³¨å†Œä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œä»¥å“åº”Ctrl+Cä¿¡å·é‡æ“ä½œï¼›
- 32-37è¡Œè°ƒç”¨recvfromç­‰å¾…å®¢æˆ·ç«¯æŠ¥æ–‡åˆ°è¾¾ï¼Œå¹¶å°†å®¢æˆ·ç«¯ä¿¡æ¯ä¿æŒåˆ°client\_addrä¸­ï¼›
- **39-41è¡Œè°ƒç”¨connectæ“ä½œï¼Œå°†UDPå¥—æ¥å­—å’Œå®¢æˆ·ç«¯client\_addrè¿›è¡Œç»‘å®š**ï¼›
- 43-59è¡Œæ˜¯ç¨‹åºçš„ä¸»ä½“ï¼Œå¯¹æ¥æ”¶çš„ä¿¡æ¯è¿›è¡Œé‡æ–°å¤„ç†ï¼ŒåŠ ä¸Šâ€Hiâ€œå‰ç¼€åå‘é€ç»™å®¢æˆ·ç«¯ï¼Œå¹¶æŒç»­ä¸æ–­åœ°ä»å®¢æˆ·ç«¯æ¥æ”¶æŠ¥æ–‡ï¼Œè¯¥è¿‡ç¨‹ä¸€ç›´æŒç»­ï¼Œç›´åˆ°å®¢æˆ·ç«¯å‘é€â€œgoodbyeâ€æŠ¥æ–‡ä¸ºæ­¢ã€‚

æ³¨æ„è¿™é‡Œæ‰€æœ‰æ”¶å‘å‡½æ•°éƒ½ä½¿ç”¨äº†sendå’Œrecvã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å®ç°ä¸€ä¸ªconnectçš„å®¢æˆ·ç«¯ç¨‹åºï¼š

```
#include "lib/common.h"
# define    MAXLINE     4096

int main(int argc, char **argv) {
    if (argc != 2) {
        error(1, 0, "usage: udpclient3 <IPaddress>");
    }

    int socket_fd;
    socket_fd = socket(AF_INET, SOCK_DGRAM, 0);

    struct sockaddr_in server_addr;
    bzero(&server_addr, sizeof(server_addr));
    server_addr.sin_family = AF_INET;
    server_addr.sin_port = htons(SERV_PORT);
    inet_pton(AF_INET, argv[1], &server_addr.sin_addr);

    socklen_t server_len = sizeof(server_addr);

    if (connect(socket_fd, (struct sockaddr *) &server_addr, server_len)) {
        error(1, errno, "connect failed");
    }

    char send_line[MAXLINE], recv_line[MAXLINE + 1];
    int n;

    while (fgets(send_line, MAXLINE, stdin) != NULL) {
        int i = strlen(send_line);
        if (send_line[i - 1] == '\n') {
            send_line[i - 1] = 0;
        }

        printf("now sending %s\n", send_line);
        size_t rt = send(socket_fd, send_line, strlen(send_line), 0);
        if (rt < 0) {
            error(1, errno, "send failed ");
        }
        printf("send bytes: %zu \n", rt);

        recv_line[0] = 0;
        n = recv(socket_fd, recv_line, MAXLINE, 0);
        if (n < 0)
            error(1, errno, "recv failed");
        recv_line[n] = 0;
        fputs(recv_line, stdout);
        fputs("\n", stdout);
    }

    exit(0);
}
```

æˆ‘å¯¹è¿™ä¸ªå®¢æˆ·ç«¯ç¨‹åºåšä¸€ä¸‹è§£è¯»ï¼š

- 9-10è¡Œåˆ›å»ºäº†ä¸€ä¸ªUDPå¥—æ¥å­—ï¼›
- 12-16è¡Œåˆ›å»ºäº†ä¸€ä¸ªIPv4åœ°å€ï¼Œç»‘å®šåˆ°æŒ‡å®šç«¯å£å’ŒIPï¼›
- **20-22è¡Œè°ƒç”¨connectå°†UDPå¥—æ¥å­—å’ŒIPv4åœ°å€è¿›è¡Œäº†â€œç»‘å®šâ€**ï¼›
- 27-46è¡Œæ˜¯ç¨‹åºçš„ä¸»ä½“ï¼Œè¯»å–æ ‡å‡†è¾“å…¥å­—ç¬¦ä¸²åï¼Œè°ƒç”¨sendå‘é€ç»™å¯¹ç«¯ï¼›ä¹‹åè°ƒç”¨recvç­‰å¾…å¯¹ç«¯çš„å“åº”ï¼Œå¹¶æŠŠå¯¹ç«¯å“åº”ä¿¡æ¯æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºã€‚

æ³¨æ„è¿™é‡Œæ‰€æœ‰æ”¶å‘å‡½æ•°ä¹Ÿéƒ½ä½¿ç”¨äº†sendå’Œrecvã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆå¯åŠ¨æœåŠ¡å™¨ç«¯ç¨‹åºï¼Œç„¶åä¾æ¬¡å¼€å¯ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼Œåˆ†åˆ«æ˜¯å®¢æˆ·ç«¯1ã€å®¢æˆ·ç«¯2ï¼Œå¹¶ä¸”è®©å®¢æˆ·ç«¯1å…ˆå‘é€UDPæŠ¥æ–‡ã€‚

æœåŠ¡å™¨ç«¯ï¼š

```
$ ./udpconnectserver
received 2 bytes: g1
send bytes: 6
```

å®¢æˆ·ç«¯1ï¼š

```
 ./udpconnectclient2 127.0.0.1
g1
now sending g1
send bytes: 2
Hi, g1
```

å®¢æˆ·ç«¯2ï¼š

```
./udpconnectclient2 127.0.0.1
g2
now sending g2
send bytes: 2
recv failed: Connection refused (111)
```

æˆ‘ä»¬çœ‹åˆ°ï¼Œå®¢æˆ·ç«¯1å…ˆå‘é€æŠ¥æ–‡ï¼ŒæœåŠ¡ç«¯éšä¹‹é€šè¿‡connectå’Œå®¢æˆ·ç«¯1è¿›è¡Œäº†â€œç»‘å®šâ€ï¼Œè¿™æ ·ï¼Œå®¢æˆ·ç«¯2ä»æ“ä½œç³»ç»Ÿå†…æ ¸å¾—åˆ°äº†ICMPçš„é”™è¯¯ï¼Œè¯¥é”™è¯¯åœ¨recvå‡½æ•°ä¸­è¿”å›ï¼Œæ˜¾ç¤ºäº†â€œConnection refusedâ€çš„é”™è¯¯ä¿¡æ¯ã€‚

## æ€§èƒ½è€ƒè™‘

ä¸€èˆ¬æ¥è¯´ï¼Œå®¢æˆ·ç«¯é€šè¿‡connectç»‘å®šæœåŠ¡ç«¯çš„åœ°å€å’Œç«¯å£ï¼Œå¯¹UDPè€Œè¨€ï¼Œå¯ä»¥æœ‰ä¸€å®šç¨‹åº¦çš„æ€§èƒ½æå‡ã€‚

è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

å› ä¸ºå¦‚æœä¸ä½¿ç”¨connectæ–¹å¼ï¼Œæ¯æ¬¡å‘é€æŠ¥æ–‡éƒ½ä¼šéœ€è¦è¿™æ ·çš„è¿‡ç¨‹ï¼š

è¿æ¥å¥—æ¥å­—â†’å‘é€æŠ¥æ–‡â†’æ–­å¼€å¥—æ¥å­—â†’è¿æ¥å¥—æ¥å­—â†’å‘é€æŠ¥æ–‡â†’æ–­å¼€å¥—æ¥å­— â†’â€¦â€¦â€¦

è€Œå¦‚æœä½¿ç”¨connectæ–¹å¼ï¼Œå°±ä¼šå˜æˆä¸‹é¢è¿™æ ·ï¼š

è¿æ¥å¥—æ¥å­—â†’å‘é€æŠ¥æ–‡â†’å‘é€æŠ¥æ–‡â†’â€¦â€¦â†’æœ€åæ–­å¼€å¥—æ¥å­—

æˆ‘ä»¬çŸ¥é“ï¼Œè¿æ¥å¥—æ¥å­—æ˜¯éœ€è¦ä¸€å®šå¼€é”€çš„ï¼Œæ¯”å¦‚éœ€è¦æŸ¥æ‰¾è·¯ç”±è¡¨ä¿¡æ¯ã€‚æ‰€ä»¥ï¼ŒUDPå®¢æˆ·ç«¯ç¨‹åºé€šè¿‡connectå¯ä»¥è·å¾—ä¸€å®šçš„æ€§èƒ½æå‡ã€‚

## æ€»ç»“

åœ¨ä»Šå¤©çš„å†…å®¹é‡Œï¼Œæˆ‘å¯¹UDPå¥—æ¥å­—è°ƒç”¨connectæ–¹æ³•è¿›è¡Œäº†æ·±å…¥çš„åˆ†æã€‚ä¹‹æ‰€ä»¥å¯¹UDPä½¿ç”¨connectï¼Œç»‘å®šæœ¬åœ°åœ°å€å’Œç«¯å£ï¼Œæ˜¯ä¸ºäº†è®©æˆ‘ä»¬çš„ç¨‹åºå¯ä»¥å¿«é€Ÿè·å–å¼‚æ­¥é”™è¯¯ä¿¡æ¯çš„é€šçŸ¥ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥è·å¾—ä¸€å®šæ€§èƒ½ä¸Šçš„æå‡ã€‚

## æ€è€ƒé¢˜

åœ¨æœ¬è®²çš„æœ€åï¼ŒæŒ‰ç…§æƒ¯ä¾‹ï¼Œç»™ä½ ç•™ä¸¤ä¸ªæ€è€ƒé¢˜ï¼š

1. å¯ä»¥å¯¹ä¸€ä¸ªUDP å¥—æ¥å­—è¿›è¡Œå¤šæ¬¡connectæ“ä½œå—? ä½ ä¸å¦¨åŠ¨æ‰‹è¯•è¯•ï¼Œçœ‹çœ‹ç»“æœã€‚
2. å¦‚æœæƒ³ä½¿ç”¨å¤šæ’­æˆ–å¹¿æ’­ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆå»ä½¿ç”¨connectå‘¢ï¼Ÿ

æ¬¢è¿ä½ åœ¨è¯„è®ºåŒºå†™ä¸‹ä½ çš„æ€è€ƒï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–è€…åŒäº‹ï¼Œä¸€èµ·äº¤æµä¸€ä¸‹ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>Geek_63bb29</span> ğŸ‘ï¼ˆ27ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>è€å¸ˆï¼Œé¢è¯•è¿‡ç¨‹ä¸­é—®é“udpå¦‚ä½•å®ç°å¯é æ€§ï¼Œè¿™ä¸ªæ€ä¹ˆç­”å‘€ã€‚è¦æ±‚å…·ä½“æ¯éƒ¨å®ç°</p>2020-08-21</li><br/><li><span>Sancho</span> ğŸ‘ï¼ˆ16ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œä½ å¥½ã€‚æˆ‘æœ‰ä¸¤ä¸ªç–‘é—®ï¼š
1.ä¸è¿›è¡Œconnectæ“ä½œï¼ŒUDPå¥—æ¥å­—ä¸æœåŠ¡ç«¯çš„åœ°å€å’Œç«¯å£å°±æ²¡æœ‰äº§ç”Ÿå…³ç³»ï¼Œé‚£recvfromæ˜¯æ€ä¹ˆæ”¶åˆ°å¯¹åº”çš„æŠ¥æ–‡å‘¢ï¼Ÿ
2.UDPçš„connectæ“ä½œï¼Œä¼šå¼•å‘å†…æ ¸çš„ICMPæŠ¥æ–‡å‘é€ï¼Ÿå¦‚æœä¸æ˜¯ï¼ŒICMPæ˜¯åœ¨ä»€ä¹ˆæ—¶æœºä¸‹å‘é€çš„ï¼Ÿ</p>2020-07-09</li><br/><li><span>GeekAmI</span> ğŸ‘ï¼ˆ10ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>é—®é¢˜1ï¼šäº²æµ‹å¯ä»¥ï¼›
é—®é¢˜2ï¼šå¯ä»¥å‚è€ƒhttps:&#47;&#47;yq.aliyun.com&#47;articles&#47;523036ã€‚</p>2019-10-22</li><br/><li><span>ğŸ—Jinx</span> ğŸ‘ï¼ˆ7ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¯¹äºå¹¿æ’­çš„è¯ï¼Œå…ˆæŠŠå¹¿æ’­çš„optionæ‰“å¼€ã€‚ç„¶åå† connect 255.255.255.255 å¯¹å—ï¼Ÿ</p>2020-12-20</li><br/><li><span>Liam</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<p>æŒ‰ç…§è€å¸ˆçš„è¯´æ³•ï¼Œåªæœ‰connectæ‰å»ºç«‹socketå’Œipåœ°å€çš„æ˜ å°„ï¼›é‚£ä¹ˆï¼Œå¦‚æœä¸è¿›è¡Œconnectï¼Œæ”¶åˆ°ä¿¡æ¯åå†…æ ¸åˆæ˜¯å¦‚ä½•æŠŠæ•°æ®äº¤ç»™å¯¹åº”çš„socketå‘¢</p>2019-09-02</li><br/><li><span>æ²‰æ·€çš„æ¢¦æƒ³</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¿˜æ˜¯ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆUDPçš„sendtoæ–¹æ³•ä¼šæœ‰ä¸€ä¸ª&quot;è¿æ¥&quot;è¿‡ç¨‹çš„æ€§èƒ½æŸè€—ï¼Œç›´æ¥æŒ‰ç…§ç›®æ ‡åœ°å€å‘è¿‡å»ä¸å°±å¯ä»¥äº†å—ï¼Ÿæˆ‘çš„ç†è§£æ˜¯æ“ä½œç³»ç»Ÿä¼šå…ˆç”¨ICMPåè®®æ¢ä¸€æ¢ç›®æ ‡åœ°å€æ˜¯å¦å­˜åœ¨ï¼Œç„¶åå†ç”¨UDPåè®®å‘é€å…·ä½“çš„æ•°æ®ï¼Œä¸çŸ¥é“ç†è§£çš„å¯¹ä¸ï¼Ÿ</p>2019-09-04</li><br/><li><span>duckman</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>connect å°†ä¸€ä¸ªsocketç»‘å®šåˆ°ä¸€ä¸ªudpçš„å®¢æˆ·ç«¯è¿›ç¨‹ï¼Œå…¶ä»–çš„udpå®¢æˆ·ç«¯è¿›ç¨‹æƒ³è¦å†æ¬¡ç»‘å®šè¯¥socket(4å…ƒç»„)å‘é€æ•°æ®çš„æ—¶å€™å°±ä¼šæŠ¥é”™ã€‚æ‰€ä»¥connectèµ·åˆ°äº† &quot;å£°æ˜å¼&quot;ç‹¬å çš„ä½œç”¨?</p>2020-12-07</li><br/><li><span>ä¼ è¯´ä¸­çš„æˆå¤§å¤§</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>udp è¿æ¥å¥—æ¥å­— è¿™ä¸ªæ˜¯ä»€ä¹ˆè¿‡ç¨‹ï¼Ÿ æ–­å¼€å¥—æ¥å­—è¿™åˆæ˜¯ä»€ä¹ˆè¿‡ç¨‹å‘¢ï¼Ÿ</p>2019-09-02</li><br/><li><span>å­™å‡</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å‘ç°åœ¨è¾“å…¥å®Œgoodbyeä¹‹åï¼ŒæœåŠ¡ç«¯æ‰§è¡Œexit,åé¢clientå†å»è¯·æ±‚çš„æ—¶å€™åˆä¼šè¢«é˜»å¡è€Œä¸æ˜¯è¿”å›é”™è¯¯ï¼Œæ˜¯å› connectæ˜¯å•æ¬¡æ“ä½œå—ï¼Ÿ</p>2021-12-16</li><br/><li><span>ä¸€ä¸ªæˆ’</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œè¯·é—®ç¬¬ä¸€ä¸ªç¨‹åºä¸­ï¼Œåœ¨æ²¡æœ‰å¼€å¯æœåŠ¡ç«¯çš„æƒ…å†µä¸‹å¼€å¯å®¢æˆ·ç«¯ï¼Œä¸ä¼šåœ¨ç¬¬20è¡Œconnectçš„æ—¶å€™å°±erroræŠ¥é”™äº†å—ï¼Ÿä¸ºä»€ä¹ˆè¿˜èƒ½æ¥æ”¶æ ‡å‡†è¾“å…¥å¹¶sendå‡ºå»ï¼Ÿ</p>2020-11-29</li><br/><li><span>n3bul2</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œæˆ‘æƒ³é—®ä¸€ä¸‹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå¤šæ¬¡ç»‘å®šconnectæ˜¯æ€ä¹ˆå¼„çš„å‘¢ï¼Ÿ</p>2020-05-29</li><br/><li><span>fhs</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯·é—®ä¸€ä¸‹ï¼Œåœ¨å®¢æˆ·ç«¯çš„ä»£ç ä¸­ï¼Œåœ¨sendä¹‹å‰è¿›è¡Œäº†connectã€‚æµ‹è¯•å‘ç°ï¼Œä¸å¯åŠ¨æœåŠ¡ç«¯çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ä½¿ç”¨å®¢æˆ·ç«¯sendçš„å‡½æ•°çš„è¿”å›å€¼æ˜¯è¾“å…¥çš„å­—èŠ‚æ•°ï¼Œæ—¢ç„¶æ–‡ç« è¯´åˆ°&quot;å› ä¸ºå¯¹åº”çš„åœ°å€å’Œç«¯å£ä¸å¯è¾¾ï¼Œä¸€ä¸ªICMPæŠ¥æ–‡ä¼šè¿”å›ç»™æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œè¯¥ICMPæŠ¥æ–‡å«æœ‰ç›®çš„åœ°å€å’Œç«¯å£ç­‰ä¿¡æ¯&quot;ï¼Œé‚£ä¸ºä»€ä¹ˆsendå‡½æ•°è¿”å›æ˜¯æˆåŠŸï¼Œè€Œrecvå°±è¿”å›å¤±è´¥å‘¢ï¼Ÿsendçš„æ—¶å€™ä¸åº”è¯¥ä¹Ÿèƒ½çŸ¥é“icmpæŠ¥æ–‡è¿”å›é”™è¯¯è€Œè¿”å›é”™è¯¯ä¹ˆï¼Ÿ</p>2020-05-10</li><br/><li><span>yang</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆ æ–‡ä¸­æåˆ°çš„icmpæŠ¥æ–‡ å‘æºåœ° æ˜¯æœ¬æœºçš„ç½‘å¡å—ï¼Ÿ</p>2019-09-02</li><br/><li><span>Frankey</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¿æ¥å¥—æ¥å­—æ˜¯éœ€è¦ä¸€å®šå¼€é”€çš„ï¼Œæ¯”å¦‚éœ€è¦æŸ¥æ‰¾è·¯ç”±è¡¨ä¿¡æ¯ã€‚
è¿™ä¸ªè·¯ç”±è¡¨ä¿¡æ¯æ˜¯ä»€ä¹ˆï¼Ÿ</p>2022-04-23</li><br/><li><span>MuteX</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æä¸€ä¸ªç»†èŠ‚ï¼Œsendto&#47;recvfromå’Œsend&#47;recvçš„è¿”å›å€¼ç±»å‹æ˜¯ssize_tï¼Œä¹Ÿå°±æ˜¯longï¼Œè€Œæ–‡ç« ä¾‹å­ä¸­å¾ˆå¤šåœ°æ–¹ç”¨çš„æ˜¯size_tï¼Œä¹Ÿå°±æ˜¯unsigned longï¼Œå¾ˆæ˜¾ç„¶ä¼šå¯¼è‡´é—®é¢˜ã€‚</p>2021-11-23</li><br/>
</ul>