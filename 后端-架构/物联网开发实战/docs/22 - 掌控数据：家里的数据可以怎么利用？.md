ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ­æœæ–Œã€‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆæ™ºèƒ½ç”µç¯ã€å…‰ç…§ä¼ æ„Ÿå™¨ã€æ™ºèƒ½éŸ³ç®±å’Œè‡ªåŠ¨æµ‡èŠ±å™¨çš„å®æˆ˜è®­ç»ƒï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨çš„æ˜¯è®¾å¤‡åŠŸèƒ½å’Œè¿œç¨‹æ§åˆ¶çš„å®ç°ã€‚

å…¶å®ï¼Œç‰©è”ç½‘è®¾å¤‡ä¼šç”Ÿæˆå¤§é‡çš„æ•°æ®ã€‚å¦‚æœæˆ‘ä»¬èƒ½æŠŠè¿™äº›æ•°æ®å­˜å‚¨åˆ°ç‰©è”ç½‘ç³»ç»Ÿçš„æ•°æ®åº“ä¸­ï¼Œå¹¶ä¸”å¥½å¥½åº”ç”¨è¿™äº›æ•°æ®ï¼Œæ¯”å¦‚æä¾›æŸ¥è¯¢å’Œåˆ†æåŠŸèƒ½ï¼Œå°±èƒ½å¤Ÿäº§å‡ºæ›´å¤§çš„ä»·å€¼ã€‚

è¿™ä¸€è®²ï¼Œæˆ‘å°±åŸºäºè‡ªåŠ¨æµ‡èŠ±å™¨æ¥è®²ä¸€è®²æ•°æ®çš„åº”ç”¨æ–¹æ³•ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ä¸¤ç§ï¼š

1. åŸºäºè…¾è®¯äº‘ç‰©è”ç½‘å¹³å°æä¾›çš„**æ•°æ®æµ**åŠŸèƒ½ï¼Œä»‹ç»ä¸€ä¸ª**è®¾å¤‡æ¶ˆæ¯æ¨é€åº”ç”¨**çš„é…ç½®æ–¹æ³•ã€‚
2. åŸºäºè…¾è®¯äº‘çš„**HTTPæ–¹å¼çš„æ•°æ®åŒæ­¥**åŠŸèƒ½ï¼Œå¼€å‘ä¸€ä¸ª**Webæ•°æ®åº”ç”¨ç³»ç»Ÿ**ã€‚å› ä¸ºéœ€è¦è´­ä¹°äº‘æœåŠ¡å™¨ï¼Œæ‰€ä»¥ä½ å¯ä»¥é…Œæƒ…é€‰æ‹©æ˜¯å¦å®é™…éƒ¨ç½²ã€‚

## æ–¹æ³•ä¸€ï¼šåŸºäºæ•°æ®æµçš„è®¾å¤‡æ¶ˆæ¯æ¨é€åº”ç”¨

è…¾è®¯äº‘ç‰©è”ç½‘å¹³å°å·²ç»ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§ç®€ä¾¿çš„æ•°æ®åº”ç”¨æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒçš„å¯è§†åŒ–ç¼–è¾‘ç•Œé¢æ¥å®Œæˆæ•°æ®æµçš„åˆ›å»ºå·¥ä½œã€‚

ä½ å¯ä»¥ç™»å½•è…¾è®¯äº‘ç‰©è”ç½‘å¹³å°çš„[æ§åˆ¶å°](https://console.cloud.tencent.com/iotexplorer)ï¼Œç„¶åè¿›å…¥æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„â€œæ™ºèƒ½å®¶å±…â€é¡¹ç›®ï¼Œç‚¹å‡»å·¦è¾¹èœå•æ ä¸­çš„â€œæ•°æ®å¼€å‘â€ã€‚

![](https://static001.geekbang.org/resource/image/13/3c/138e249c1d126a9b147f0e5e4068a43c.png?wh=1454%2A448)

ç„¶åï¼Œä½ éœ€è¦æ–°å»ºä¸€ä¸ªæ•°æ®æµï¼Œåç§°å¯ä»¥æ˜¯â€œè‡ªåŠ¨æµ‡èŠ±å™¨â€ã€‚ç‚¹å‡»æ•°æ®æµåˆ—è¡¨ä¸­çš„â€œè‡ªåŠ¨æµ‡èŠ±å™¨â€é¡¹ç›®ï¼Œä½ å°±å¯ä»¥è¿›å…¥å¯è§†åŒ–çš„ç¼–è¾‘ç•Œé¢ã€‚

![](https://static001.geekbang.org/resource/image/df/d0/dfffa9589666393a43a8b9fd6cebfed0.png?wh=2474%2A934)

åœ¨å¯è§†åŒ–ç¼–è¾‘ç•Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªæ•°æ®æµåŒ…æ‹¬â€œè¾“å…¥â€â€œå¤„ç†â€å’Œâ€œè¾“å‡ºâ€ä¸‰ä¸ªéƒ¨åˆ†ã€‚

1. è¾“å…¥ï¼ŒåŒ…æ‹¬è®¾å¤‡æ•°æ®ã€è®¾å¤‡äº‹ä»¶å’Œè®¾å¤‡çŠ¶æ€ä¸‰ç§ï¼Œå…¶ä¸­è®¾å¤‡æ•°æ®å’Œè®¾å¤‡äº‹ä»¶ä¸ç‰©æ¨¡å‹ä¸­çš„å®šä¹‰æ˜¯ä¸€è‡´çš„ã€‚è®¾å¤‡çŠ¶æ€æ˜¯è®¾å¤‡çš„ä¸Šçº¿ã€ä¸‹çº¿çš„çŠ¶æ€å˜åŒ–ã€‚
2. å¤„ç†ï¼Œå¯ä»¥ç¼–å†™åŸºæœ¬çš„åˆ¤æ–­é€»è¾‘æ¥è¿‡æ»¤è¾“å…¥æ•°æ®ã€‚
3. è¾“å‡ºï¼Œå¯ä»¥ä½œä¸ºæ¶ˆæ¯å°†æ•°æ®æ¨é€åˆ°Appæˆ–è€…å°ç¨‹åºä¸­ã€‚ä½ å¯ä»¥å¯¹æ¶ˆæ¯çš„å†…å®¹æ¨¡æ¿è¿›è¡Œå®šä¹‰ã€‚

è‡ªåŠ¨æµ‡èŠ±å™¨è®¾å¤‡ä¼šä¸ŠæŠ¥ç¯å¢ƒçš„æ¸©åº¦ã€æ¹¿åº¦ä¿¡æ¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæ¸©æ¹¿åº¦ä¸é€‚å®œçš„æ¶ˆæ¯æé†’ã€‚

ä½ å¯ä»¥æ‹–æ‹½â€œè®¾å¤‡æ•°æ®â€åˆ°ç¼–è¾‘åŒºåŸŸï¼Œç„¶åç‚¹å‡»è¿™ä¸ªæ¨¡å—ï¼Œåœ¨å³è¾¹çš„é€‰é¡¹ä¸­å®šä¹‰è®¾å¤‡æ•°æ®ï¼Œäº§å“é€‰æ‹©â€œè‡ªåŠ¨æµ‡èŠ±å™¨â€ï¼Œå±æ€§é€‰æ‹©â€œç¯å¢ƒæ¸©åº¦â€å’Œâ€œç¯å¢ƒæ¹¿åº¦â€ã€‚

![](https://static001.geekbang.org/resource/image/20/f9/2033f1a7d6523523e9e53587c600e8f9.png?wh=2876%2A934)

æ¥ç€ï¼Œä½ å¯ä»¥æ·»åŠ â€œæ•°æ®è¿‡æ»¤â€æ¨¡å—ï¼Œå¹¶ä¸”å°†è¿™ä¸ªæ¨¡å—ä¸â€œè®¾å¤‡æ•°æ®â€æ¨¡å—ç›¸è¿ï¼Œç„¶åç‚¹å‡»è¿™ä¸ªæ¨¡å—ï¼Œåœ¨å³è¾¹ç¼–è¾‘è¿‡æ»¤æ¡ä»¶ã€‚

![](https://static001.geekbang.org/resource/image/98/79/9818f8c65f3084e3888c6b8b32481079.png?wh=2872%2A930)

![](https://static001.geekbang.org/resource/image/32/a8/32e69cf67e0ce0afb0c890e2455572a8.png?wh=2874%2A926)

å®Œæˆæ•°æ®è¿‡æ»¤çš„å®šä¹‰åï¼Œä½ éœ€è¦ç»§ç»­æ·»åŠ â€œå…¬ä¼—å·æ¨é€â€æ¨¡å—ï¼Œå¹¶ä¸”ç¼–è¾‘æ¶ˆæ¯æ¨é€çš„æ¨¡æ¿ã€‚å…·ä½“çš„æ¶ˆæ¯æ¨¡æ¿å®šä¹‰ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢å†…å®¹ï¼š

```
ç¯å¢ƒæ¸©åº¦ã€æ¹¿åº¦ä¸é€‚å®œï¼š
å½“å‰æ¸©åº¦æ˜¯$env_temp 
å½“å‰æ¹¿åº¦æ˜¯$env_hum 
å½“å‰æ—¶é—´æ˜¯$timeStamp 
```

![](https://static001.geekbang.org/resource/image/00/47/00bc33c4f76f24627c74de0704009447.png?wh=2874%2A928)

æœ€åï¼Œç‚¹å‡»é¡µé¢ä¸Šæ–¹çš„â€œä¿å­˜â€å’Œâ€œå¯ç”¨â€ï¼Œä½ å°±å®Œæˆäº†æ•°æ®æµçš„å®šä¹‰ã€‚

å¦‚æœä½ çš„è‡ªåŠ¨æµ‡èŠ±å™¨è®¾å¤‡æ˜¯åœ¨çº¿çŠ¶æ€ï¼Œé‚£ä¹ˆå½“ç¯å¢ƒçš„æ¸©åº¦æˆ–è€…æ¹¿åº¦è¿‡é«˜ã€è¿‡ä½æ—¶ï¼Œä½ å°±ä¼šåœ¨è…¾è®¯è¿è¿å°ç¨‹åºçš„æ¶ˆæ¯åˆ—è¡¨ä¸­æ”¶åˆ°â€œå‘Šè­¦â€æ¶ˆæ¯ã€‚

![](https://static001.geekbang.org/resource/image/8b/7d/8b75bd0d379aae20bf5099f91106f77d.jpg?wh=1124%2A771)

## æ–¹æ³•äºŒï¼šåŸºäºHTTPæ•°æ®åŒæ­¥çš„Webæ•°æ®åº”ç”¨

ç‰©è”ç½‘å¹³å°é™¤äº†æä¾›æ•°æ®æµçš„æ–¹å¼ï¼Œè¿˜å¯ä»¥åŸºäºHTTPåè®®æŠŠæ•°æ®æ¨é€åˆ°ä½ æŒ‡å®šçš„ç½‘å€ï¼Œæ¯”å¦‚ä½ å¼€å‘çš„WebæœåŠ¡å™¨çš„ç½‘å€ã€‚æ‰€ä»¥ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œæ›´åŠ çµæ´»åœ°åˆ©ç”¨ç‰©è”ç½‘è®¾å¤‡çš„æ•°æ®ã€‚

### æ•°æ®åŒæ­¥ä½“éªŒ

æˆ‘ä»¬å€ŸåŠ©åœ¨çº¿çš„WebhookæœåŠ¡ï¼Œæµ‹è¯•ä¸€ä¸‹æ•°æ®åŒæ­¥åŠŸèƒ½ã€‚

é¦–å…ˆï¼Œæ‰“å¼€[webhook.site](https://webhook.site/)ç½‘ç«™ï¼Œå¹¶ä¸”è®°å½•é¡µé¢ä¸­æ˜¾ç¤ºçš„ä¸“å±URLåœ°å€ã€‚

ç„¶åï¼Œä½ éœ€è¦ç™»å½•è…¾è®¯äº‘ç‰©è”ç½‘å¹³å°ï¼Œè¿›å…¥æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„â€œæ™ºèƒ½å®¶å±…â€é¡¹ç›®ï¼Œå†ç‚¹å‡»å·¦è¾¹èœå•æ ä¸­çš„â€œæ•°æ®åŒæ­¥â€ï¼Œé€‰æ‹©â€œHTTPSâ€æ ‡ç­¾ã€‚

![](https://static001.geekbang.org/resource/image/bc/a7/bcd8b3bd706bfbb76f5f806e492438a7.png?wh=1254%2A982)

æ¥ç€ï¼Œç‚¹å‡»â€œè‡ªåŠ¨æµ‡èŠ±å™¨â€å¯¹åº”çš„â€œè®¾ç½®â€é“¾æ¥ï¼Œåœ¨è®¾ç½®çª—å£ï¼Œå°†webhookç½‘ç«™è·å–åˆ°çš„URLåœ°å€ï¼Œç²˜è´´åœ¨è¾“å…¥æ¡†ã€‚

![](https://static001.geekbang.org/resource/image/ee/e2/eefc65fb6c6825ea9825fa75fee8eee2.png?wh=1196%2A570)

å®Œæˆè®¾ç½®åï¼Œæ‰“å¼€â€œç”Ÿæ•ˆçŠ¶æ€â€ã€‚

![](https://static001.geekbang.org/resource/image/82/49/826161247a0456e3fb8f44e889d9d049.png?wh=1096%2A336)

åœ¨ä¿è¯è‡ªåŠ¨æµ‡èŠ±å™¨è®¾å¤‡æ­£å¸¸è¿è¡Œçš„æƒ…å†µä¸‹ï¼Œä½ å°±å¯ä»¥åœ¨webhookç½‘ç«™çš„é¡µé¢ä¸­çœ‹åˆ°è®¾å¤‡ä¸ŠæŠ¥çš„æ•°æ®äº†ã€‚

![](https://static001.geekbang.org/resource/image/a1/4b/a164cb71d5dd660b846511377ff9844b.png?wh=2392%2A1272)

ä¸‹é¢æˆ‘æ¥ä»‹ç»ä¸€ä¸‹ç”¨Pythonè¯­è¨€æ¥å¼€å‘WebæœåŠ¡å™¨çš„æ–¹æ³•ã€‚

å› ä¸ºè´­ä¹°äº‘æœåŠ¡å™¨éœ€è¦è´¹ç”¨ï¼Œæ‰€ä»¥è¿™ä¸ªå®æˆ˜ä»»åŠ¡æ˜¯é€‰å­¦å†…å®¹ï¼Œä½ å¯ä»¥åœ¨è‡ªå·±çš„ç”µè„‘ä¸Šå®è·µä¸€ä¸‹WebæœåŠ¡å™¨çš„å¼€å‘è¿‡ç¨‹ï¼Œç„¶åé…Œæƒ…è€ƒè™‘è¦ä¸è¦éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ä¸Šã€‚

### å‡†å¤‡Djangoå¼€å‘ç¯å¢ƒ

Djangoæ˜¯ä¸€ä¸ªæµè¡Œçš„åŸºäºPythonè¯­è¨€çš„Webå¼€å‘æ¡†æ¶ã€‚å®ƒæä¾›äº†å¼ºå¤§çš„åŠŸèƒ½ï¼ŒåŒæ—¶ä¹Ÿç®€å•æ˜“ç”¨ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±åŸºäºDjangoæ¥å®ç°ä¸€ä¸ªWebåº”ç”¨ç¨‹åºã€‚

é¦–å…ˆæ˜¯åœ¨ç”µè„‘ä¸Šé…ç½®Djangoçš„å¼€å‘ç¯å¢ƒï¼Œåœ¨ç»ˆç«¯ä¸Šè¿è¡Œä¸‹é¢çš„å‘½ä»¤å®‰è£…Djangoï¼Œå‡†å¤‡å¥½éœ€è¦ç”¨åˆ°çš„å·¥å…·ã€‚

```
$ pip3 install django
```

å®‰è£…å®Œæˆåï¼Œä½ å¯ä»¥åœ¨ç»ˆç«¯ä¸Šåˆ‡æ¢åˆ°ä¸€ä¸ªä»£ç å¼€å‘ç›®å½•ï¼Œæ¯”å¦‚ï¼š

```
$ cd ~/study/iot/geektime
```

ç„¶åï¼Œç›´æ¥ä½¿ç”¨Djangoæä¾›çš„è„šæ‰‹æ¶å·¥å…·django-adminæ¥åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼š

```
$ django-admin startproject watering_web
```

è¿™æ—¶ï¼Œå‘½ä»¤ä¼šåˆ›å»ºä¸€ä¸ªåç§°ä¸ºwatering\_webçš„ç›®å½•ã€‚ç›®å½•ä¸­åŒ…å«manage.pyã€settings.pyã€urls.pyã€wsgi.pyå’Œasgi.pyç­‰å‡ ä¸ªé¡¹ç›®â€œéª¨æ¶â€æ–‡ä»¶ï¼Œå…¶ä¸­ï¼š

- manage.pyæ˜¯é¡¹ç›®ç®¡ç†è„šæœ¬ï¼Œæ¯”å¦‚åˆ›å»ºå­åº”ç”¨ã€è¿è¡Œå¼€å‘æœåŠ¡å™¨ç­‰éƒ½å¯ä»¥é€šè¿‡å®ƒå®ç°ã€‚
- settings.pyæ˜¯é¡¹ç›®çš„æ•´ä½“é…ç½®æ–‡ä»¶ã€‚æ¯”å¦‚å­åº”ç”¨çš„é…ç½®ã€æ•°æ®åº“çš„é…ç½®ç­‰ã€‚
- urls.pyæ˜¯é¡¹ç›®çš„å…¨å±€è·¯ç”±å£°æ˜æ–‡ä»¶ã€‚
- wsgi.pyæ˜¯WSGIï¼ˆPython Web Server Gateway Interfaceçš„ç¼©å†™ï¼‰æœåŠ¡æ¥å£æ–‡ä»¶ï¼Œæ˜¯æ•´ä¸ªDjangoåº”ç”¨çš„è°ƒç”¨å…¥å£ã€‚
- asgi.pyæ˜¯ASGIï¼ˆAsynchronous Server Gateway Interfaceçš„ç¼©å†™ï¼‰æœåŠ¡æ¥å£æ–‡ä»¶ã€‚ASGIæ˜¯WSGIçš„æ›¿ä»£è€…ï¼Œå®ƒå¢åŠ äº†å¼‚æ­¥åº”ç”¨çš„èƒ½åŠ›ã€‚é™¤äº†æ”¯æŒWSGIåè®®ï¼ŒåŒæ—¶å¯¹Websocketå’ŒHTTP2.0è¿™äº›é•¿è¿æ¥æ–¹å¼çš„åè®®æä¾›äº†æ”¯æŒã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬è¿›å…¥watering\_webç›®å½•ï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå°±å¯ä»¥åœ¨ç”µè„‘ä¸Šå¯åŠ¨è¿™ä¸ªé¡¹ç›®çš„å¼€å‘æœåŠ¡å™¨äº†ã€‚

```
$ python manage.py runserver
```

![](https://static001.geekbang.org/resource/image/8d/de/8d177591115a109be9dfb4bdddcbcede.png?wh=1402%2A568)

è¿™éå¸¸æœ‰åˆ©äºä½ çš„å¼€å‘è°ƒè¯•å·¥ä½œã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥åœ¨æµè§ˆå™¨è¾“å…¥ `http://127.0.0.1:8000/` éšæ—¶è®¿é—®Webåº”ç”¨çš„å¼€å‘æ•ˆæœã€‚

![](https://static001.geekbang.org/resource/image/e6/0f/e61ab6ce1577c62fe7aaeb0b5923320f.png?wh=1604%2A1410)

å½“ä½ åœ¨æµè§ˆå™¨ä¸Šçœ‹åˆ°è¿™ä¸ªç•Œé¢æ—¶ï¼Œå°±è¯´æ˜Djangoåº”ç”¨çš„å¼€å‘ç¯å¢ƒå·²ç»å‡†å¤‡å¥½äº†ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥å¼€å‘Webåº”ç”¨ã€‚

### Djangoåº”ç”¨å¼€å‘

#### åˆ›å»ºå­åº”ç”¨watering

é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œåˆ›å»ºwatering\_webé¡¹ç›®çš„å­åº”ç”¨wateringï¼š

```
$ python manage.py startapp watering
```

è¿™æ—¶ï¼Œä½ åº”è¯¥å¯ä»¥çœ‹åˆ°é¡¹ç›®ç›®å½•ä¸‹ï¼Œæ–°å¢åŠ äº†wateringçš„ç›®å½•ã€‚ç›®å½•ä¸­åŒ…å«äº†wateringå­åº”ç”¨çš„åŸºæœ¬ä»£ç æ¨¡å—ã€‚

- admin.pyæ˜¯åå°ç®¡ç†åº”ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­å¢åŠ æ•°æ®åº“æ¨¡å‹å¯¹è±¡ï¼Œè®©Djangoåº”ç”¨ç®¡ç†å‘˜èƒ½é€šè¿‡åå°ç®¡ç†é¡µé¢è¿›è¡Œç¼–è¾‘ã€‚ä½ åœ¨æµè§ˆå™¨è¾“å…¥ `http://127.0.0.1:8000/admin/` å¯ä»¥è®¿é—®åˆ°åå°ç®¡ç†åº”ç”¨ã€‚
- apps.pyæ˜¯å­åº”ç”¨çš„é…ç½®æ–‡ä»¶ã€‚
- migrationsæ˜¯æ•°æ®åº“è¿ç§»çš„æ–‡ä»¶ç›®å½•ï¼Œå®ƒä¸‹é¢ä¼šä¿å­˜æ¯æ¬¡æ•°æ®åº“è¿ç§»çš„ä¸­é—´æ–‡ä»¶ã€‚
- models.pyæ˜¯å®šä¹‰å­åº”ç”¨çš„æ•°æ®åº“æ•°æ®æ¨¡å‹æ–‡ä»¶ã€‚
- tests.pyæ˜¯å­åº”ç”¨çš„å•å…ƒæµ‹è¯•ä»£ç æ–‡ä»¶ã€‚
- views.pyæ˜¯å­åº”ç”¨çš„è§†å›¾ä»£ç æ–‡ä»¶ã€‚

#### ç†è§£Djangoçš„è§†å›¾è°ƒç”¨

åœ¨Djangoé‡Œé¢ï¼Œç½‘é¡µæˆ–è€…è¯´HTTPçš„å“åº”éƒ½æ˜¯è§†å›¾ç”Ÿæˆçš„ï¼Œæ¯ä¸ªè§†å›¾å¯¹åº”views.pyä¸­çš„ä¸€ä¸ªå‡½æ•°ã€‚Djangoä¼šæ ¹æ®HTTPè¯·æ±‚çš„URLåŸŸååœ°å€æ¥é€‰æ‹©ç›¸åº”çš„è§†å›¾ï¼Œè€ŒURLå’Œè§†å›¾å‡½æ•°çš„æ˜ å°„å…³ç³»æ˜¯åœ¨urls.pyæ–‡ä»¶ä¸­å®šä¹‰çš„ã€‚

æ¯”å¦‚ï¼Œä½ å¯ä»¥æ‰“å¼€wateringç›®å½•ä¸‹çš„views.pyæ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢çš„å‡½æ•°ï¼š

```
from django.http import HttpResponse

def demo(request):
    return HttpResponse('Hello World!')
```

ç„¶åï¼Œåœ¨wateringç›®å½•ä¸‹ï¼Œæ–°å»ºä¸€ä¸ªurls.pyæ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```
from django.urls import path

from . import views

urlpatterns = [
    path('demo', views.demo, name='demo'),
]
```

æœ€åï¼Œåœ¨watering\_webç›®å½•ä¸‹çš„é¡¹ç›®å…¨å±€è·¯ç”±æ–‡ä»¶ä¸­ï¼Œå°†urlpatternsçš„å†…å®¹æ›¿æ¢ä¸ºä¸‹é¢çš„å†…å®¹ï¼š

```
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('watering.urls')),
]
```

ç°åœ¨ï¼Œä½ åœ¨æµè§ˆå™¨è¾“å…¥åœ°å€`http://127.0.0.1:8000/demo`ï¼Œå°±å¯ä»¥çœ‹çœ‹æˆ‘ä»¬åˆšåˆšå®šä¹‰çš„demoè§†å›¾çš„å†…å®¹ã€‚

![](https://static001.geekbang.org/resource/image/05/8d/05e33d8e7da78fd797c115255829508d.png?wh=1040%2A174)

#### åº”ç”¨ä»£ç å¼€å‘

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ­£å¼å¼€å§‹å­åº”ç”¨çš„å¼€å‘ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰æ•°æ®åº“çš„æ•°æ®æ¨¡å‹ã€‚Djangoæ¡†æ¶å®ç°äº†ORMï¼ˆObject-Relational Mappingï¼Œå¯¹è±¡å…³ç³»æ˜ å°„å™¨ï¼‰æŠ€æœ¯ã€‚ä½ å¯ä»¥ç›´æ¥åœ¨Pythonä»£ç ä¸­å®šä¹‰æ•°æ®åº“çš„è¡¨ç»“æ„ã€‚

åŸºäºè¿™ä¸ªå®šä¹‰ï¼ŒDjangoçš„migrationå·¥å…·èƒ½è‡ªåŠ¨åœ¨æ•°æ®åº“ä¸­åˆ›å»ºç›¸åº”çš„æ•°æ®åº“è¡¨ã€‚åœ¨åé¢çš„éƒ¨ç½²é˜¶æ®µï¼Œæˆ‘ä¼šè®²è§£åˆ°å…·ä½“çš„migrationå‘½ä»¤ã€‚

æˆ‘æŠŠmodels.pyçš„ä»£ç è´´åœ¨æ–‡ç¨¿ä¸­ï¼Œä¾›ä½ å‚è€ƒï¼š

```
from django.db import models

# Create your models here.
class Watering(models.Model):
    seq_no = models.IntegerField(blank=False, null=False)
    device_name = models.CharField(max_length=64, blank=False)
    product_id = models.CharField(max_length=64, blank=False)
    power_switch = models.IntegerField(default=0)
    humidity = models.IntegerField(default=0)
    env_temp = models.FloatField(default=0.0)
    env_hum = models.IntegerField(default=0)
    env_illum = models.IntegerField(default=0)
    timestamp = models.DateTimeField(auto_now=False)

    def __str__(self):
        return self.device_name + '_' + str(self.seq_no)
```

æœ‰äº†æ•°æ®æ¨¡å‹ä¹‹åï¼Œä½ å°±å¯ä»¥åœ¨views.pyæ–‡ä»¶ä¸­å¼€å‘è§†å›¾ï¼Œæ¥æ”¶è…¾è®¯äº‘ç‰©è”ç½‘å¹³å°æ¨é€çš„HTTPè¯·æ±‚ï¼Œå¹¶ä¸”å°†æ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ã€‚

æ–‡ç¨¿ä¸­æ˜¯æˆ‘çš„ç¤ºä¾‹ä»£ç ï¼Œä¾›ä½ å‚è€ƒï¼š

```
from django.shortcuts import render

# Create your views here.
from django.http import HttpResponse, HttpResponseBadRequest
from django.views.decorators.csrf import csrf_exempt
from django.forms.models import model_to_dict
import json
from datetime import datetime
from tencentcloud.common import credential
from tencentcloud.common.profile.client_profile import ClientProfile
from tencentcloud.common.profile.http_profile import HttpProfile
from tencentcloud.common.exception.tencent_cloud_sdk_exception import TencentCloudSDKException
from tencentcloud.iotexplorer.v20190423 import iotexplorer_client, models

SECRET_ID = "ä½ çš„Secret ID"
SECRET_KEY = "ä½ çš„Secret Key"
PRODUCT_ID = "ä½ çš„ProductID"

from .models import Watering

def build_response(resp, msg):
    dict = {
        "resp": resp,
        "msg": msg,
    }
    return HttpResponse(json.dumps(dict), content_type='application/json')

def demo(request):
    return HttpResponse('Hello World!')

@csrf_exempt
def data_sync(request):
    if request.method == 'POST':
        json_data = json.loads(request.body.decode())
    else:
        return HttpResponseBadRequest('Bad Request')
    
    if 'seq' in json_data:
        _seq = json_data['seq']
    if 'devicename' in json_data:
        _device_name = json_data['devicename']
    if 'productid' in json_data:
        _product_id = json_data['productid']
    if 'timestamp' in json_data:
        _timestamp = json_data['timestamp']
    if 'payload' in json_data:
        _payload = json_data['payload']
        if 'method' in _payload and 'report' == _payload['method']:
            _params = _payload['params']
            _env_temp = _params['env_temp']
            _env_hum = _params['env_hum']
            _env_illum = _params['env_illum']
            _humidity = _params['humidity']
            _power_status = _params['power_switch']
        
            try:
                Watering.objects.create(
                    seq_no=_seq, device_name=_device_name, product_id=_product_id,
                    power_switch=_power_status, humidity=_humidity,
                    env_temp = _env_temp, env_hum = _env_hum, env_illum = _env_illum,
                    timestamp=datetime.fromtimestamp(_timestamp) )
                
            except:
                return HttpResponse('Insert Failed!')

    return HttpResponse('OK')

@csrf_exempt
def latest_data(request):
    if request.method == 'POST':
        json_data = json.loads(request.body.decode())
    else:
        return HttpResponseBadRequest('Bad Request')
    
    if 'devicename' in json_data:
        _device_name = json_data['devicename']
    else:
        _device_name = None
    
    if _device_name is not None:
        try:
            data = Watering.objects.filter(device_name=_device_name).latest('timestamp')
            data_dict = model_to_dict(data, fields=['seq_no','device_name','product_id','power_switch','humidity','env_temp','env_hum','env_illum'])
            data_dict['timestamp'] = str(data.timestamp)
            dict = {
                "resp": 0,
                "msg": "OK",
                "data": data_dict
            }
            return HttpResponse(json.dumps(dict), content_type='application/json')
        except Exception as e:
            return build_response(1, str(e))
    else:
        return build_response(1, 'Parameter invalid.')
```

ä¸ºäº†èƒ½å¤Ÿæ§åˆ¶è‡ªåŠ¨æµ‡èŠ±å™¨çš„æ°´æ³µæ‰“å¼€å’Œå…³é—­ï¼Œä½ ä¹Ÿå¯ä»¥å¢åŠ å‘é€æ§åˆ¶å‘½ä»¤çš„è§†å›¾ã€‚åŒæ ·ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„ä»£ç ï¼š

```
@csrf_exempt
def control_device(request):
    if request.method == 'POST':
        json_data = json.loads(request.body.decode())
    else:
        return HttpResponseBadRequest('Bad Request')
    
    if 'devicename' in json_data:
        _device_name = json_data['devicename']
    else:
        _device_name = None
    if 'status' in json_data:
        _status = json_data['status']
    else:
        _status = None

    if _device_name is not None and _status is not None:
        try: 
            cred = credential.Credential(SECRET_ID, SECRET_KEY) 
            httpProfile = HttpProfile()
            httpProfile.endpoint = "iotexplorer.tencentcloudapi.com"

            clientProfile = ClientProfile()
            clientProfile.httpProfile = httpProfile
            client = iotexplorer_client.IotexplorerClient(cred, "ap-guangzhou", clientProfile) 

            req = models.ControlDeviceDataRequest()
            data = {
                "power_switch": _status
            }
            data_str = json.dumps(data)

            params = {
                "DeviceName": _device_name,
                "ProductId": PRODUCT_ID,
                "Data": data_str
            }
            req.from_json_string(json.dumps(params))

            resp = client.ControlDeviceData(req)

            return build_response(0, resp.to_json_string())

        except TencentCloudSDKException as err: 
            return build_response(1, str(err))

    else:
        return build_response(1, 'Parameter invalid.')
```

å®Œæˆè§†å›¾çš„å¼€å‘åï¼Œä½ éœ€è¦æ›´æ–°urls.pyæ–‡ä»¶ä¸­çš„urlpatternsï¼Œä¸ºæ–°å¢è§†å›¾æ·»åŠ æ˜ å°„å…³ç³»ã€‚

```
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('geektime/', include('watering.urls')),
]
```

åŒæ—¶ï¼Œåœ¨wateringå­åº”ç”¨çš„ç›®å½•å¢åŠ ä¸€ä¸ªurls.pyæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```
from django.urls import path

from . import views

urlpatterns = [
    path('demo', views.demo, name='demo'),
    path('data', views.data_sync, name='data_sync'),
    path('control', views.control_device, name='control_device'),
    path('fetch', views.latest_data, name='latest_data'),
]
```

ç„¶åï¼Œæˆ‘ä»¬æ¥å¼€å‘ä¸€ä¸ªç®€å•çš„ç½‘é¡µï¼Œå®ç°è®¾å¤‡ä¿¡æ¯çš„æ˜¾ç¤ºå’Œæ§åˆ¶ã€‚ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘è¿™é‡Œåªä½¿ç”¨æœ€åŸºç¡€çš„æ–¹æ³•ã€‚å½“ç†Ÿæ‚‰åŸºæœ¬åŸç†ä¹‹åï¼Œä½ å¯ä»¥å°è¯•ä½¿ç”¨VUEã€Reactç­‰å‰ç«¯åº”ç”¨æ¡†æ¶æ¥å¼€å‘åŠŸèƒ½æ›´ä¸°å¯Œçš„Webå‰ç«¯åº”ç”¨ã€‚

æˆ‘æŠŠä»£ç è´´åœ¨æ–‡ç¨¿ä¸­ï¼Œä¾›ä½ å‚è€ƒï¼š

```
<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta content="webkit" name="renderer">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="IE=Edge,chrome=1" http-equiv="X-UA-Compatible">
<style type="text/css">
    th {
    text-align: left;
    }
</style>

<title>Plant Watering</title>
<script src="jquery-3.1.1.min.js"></script>
</head>

<body>
    <h1>Plant Watering</h1>

    <table>
        <tr>
            <th>Device Name: </th><th id='devicename'></th>
        </tr>

        <tr>
            <th>Date: </th><th id='datetime'></th>
        </tr>

        <tr>
            <th>Soil Moisture (&#37;): </th><th id='moisture'></th>
        </tr>

        <tr>
            <th>Environment Temperature (â„ƒ): </th><th id='envtemp'></th>
        </tr>

        <tr>
            <th>Environment Humidity (&#37;): </th><th id='envhum'></th>
        </tr>

        <tr>
            <th>Environment Illumination (Lux): </th><th id='envillum'></th>
        </tr>

    </table>

    <button id='on'>Open</button>
    <button id='off'>Close</button>

    <script type='text/javascript'>
        var timer = false
        var interval = 5*1000   //5 seconds
        var device_name = 'Watering_1'

        $("#on").on('click',function(){
            control(1)
        })
        $("#off").on('click',function(){
            control(0)
        })

        function control(state){

            var payload = {
                "devicename":device_name,
                "status":state
            }

            $.ajax({
                url : "http://159.75.214.14/geektime/control",
                contentType: "application/json; charset=utf-8",
                method : 'POST',
                dataType: "json",
                data: JSON.stringify(payload),
                
                success:function (obj) {

                    if(obj.resp === 0){
                        console.log("pump on");
                    }
                    else{
                        console.log(obj.msg);
                    }
                },
                error:function(e){
                    console.log("control device post failed.");
                }
            })
        }

        function update_data(){
            var payload = {
                "devicename":device_name,
            }

            $.ajax({
                url : "http://159.75.214.14/geektime/fetch",
                contentType: "application/json; charset=utf-8",
                method : 'POST',
                dataType: "json",
                data: JSON.stringify(payload),
                
                success:function (obj) {

                    if(obj.resp === 0){
                        console.log("fetch success");
                        $("#devicename").text(device_name)
                        $("#datetime").text(obj.data.timestamp)
                        $("#moisture").text(obj.data.humidity)
                        $("#envtemp").text(obj.data.env_temp)
                        $("#envhum").text(obj.data.env_hum)
                        $("#envillum").text(obj.data.env_illum)
                    }
                    else{
                        console.log(obj.msg);
                    }
                },
                error:function(e){
                    console.log("fetch latest data failed.");
                }
            })
        }

        window.onload = function(){
            update_data()   //Fetch data to get devicename first.
            timer = setInterval(function(){
                update_data()
            }, interval)
        }
    </script>
</body>
</html>
```

å¯¹äºè¿™äº›å‰ç«¯ä»£ç æ–‡ä»¶ï¼Œä½ å¯ä»¥åœ¨watering\_webé¡¹ç›®çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªwebç›®å½•ï¼Œç„¶åæŠŠå®ƒä»¬æ”¾å…¥è¿™ä¸ªç›®å½•ä¸‹ã€‚

å…³äºDjangoé¡¹ç›®çš„settings.pyæ–‡ä»¶ï¼Œä½ éœ€è¦åœ¨ALLOWED\_HOSTSä¸­å¢åŠ è‡ªå·±æœåŠ¡å™¨çš„IPåœ°å€ã€‚

```
ALLOWED_HOSTS = [
    '159.75.214.14',    #æ›¿æ¢è‡ªå·±çš„äº‘æœåŠ¡å™¨IP
]
```

åŒæ—¶ï¼Œåœ¨æ•°æ®åº“çš„é…ç½®ä¸­ï¼Œä¿®æ”¹ä¸ºMySQLçš„é…ç½®å†…å®¹ï¼š

```
DATABASES = {
    # 'default': {
    #     'ENGINE': 'django.db.backends.sqlite3',
    #     'NAME': BASE_DIR / 'db.sqlite3',
    # }
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'geektime',
        'USER': 'root',
        'PASSWORD': 'geektime',
        'HOST': '127.0.0.1',
        'PORT': '3306',
    }
}
```

### Djangoåº”ç”¨éƒ¨ç½²

å®ŒæˆDjangoåº”ç”¨çš„å¼€å‘ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå®ƒéƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ä¸­ã€‚

é¦–å…ˆï¼Œä½ éœ€è¦å…ˆç™»å½•åˆ°[è…¾è®¯äº‘æ§åˆ¶å°](https://console.cloud.tencent.com/)ï¼Œä»â€œäº‘äº§å“â€ä¸­ç‚¹å‡»é€‰æ‹©â€œäº‘æœåŠ¡å™¨â€ï¼Œè¿›å…¥äº‘æœåŠ¡çš„é…ç½®é¡µé¢ã€‚

![](https://static001.geekbang.org/resource/image/02/ee/0273fa9e62c1b2a580b6fc21009a30ee.png?wh=1162%2A530)

åœ¨äº‘æœåŠ¡å™¨é¡µé¢ï¼Œç‚¹å‡»â€œæ–°å»ºâ€ï¼Œè´­ä¹°ä¸€å°æœåŠ¡å™¨ã€‚

![](https://static001.geekbang.org/resource/image/e8/d2/e8f883446d099f88e41feea1d690ddd2.png?wh=1672%2A426)

åœ¨æ–°å»ºçš„é¡µé¢ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚é€‰æ‹©æœåŠ¡å™¨çš„ç¡¬ä»¶é…ç½®ã€‚å¦‚æœåªæ˜¯ç”¨æ¥ç»ƒä¹ ï¼Œé€‰æ‹©æœ€ä½çš„é…ç½®å°±è¡Œäº†ã€‚

æœåŠ¡å™¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©â€œUbuntu Server 16.04.1â€ï¼Œå…¶ä»–é€‰é¡¹ä¿æŒé»˜è®¤å€¼ã€‚

![](https://static001.geekbang.org/resource/image/70/a9/70f1a0f88d97cede64172b8d4b2c87a9.png?wh=2414%2A1074)

![](https://static001.geekbang.org/resource/image/d2/e4/d296d31ae02a2f74f42b2a2333813ee4.png?wh=2438%2A966)

ç‚¹å‡»â€œç«‹å³è´­ä¹°â€ï¼Œå®Œæˆæ”¯ä»˜åï¼Œæˆ‘ä»¬é‡æ–°è¿›å…¥äº‘æœåŠ¡å™¨æ§åˆ¶å°ï¼Œå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„æœåŠ¡å™¨æ–°å®ä¾‹äº†ã€‚

![](https://static001.geekbang.org/resource/image/aa/f7/aa37acca629ca8fd28454bfe26a637f7.png?wh=1906%2A554)

å‡†å¤‡å¥½äº‘æœåŠ¡å™¨åï¼Œæˆ‘å†ä»‹ç»ä¸€ä¸‹Djangoåº”ç”¨åœ¨UbuntuæœåŠ¡å™¨ä¸Šçš„å…·ä½“éƒ¨ç½²æ“ä½œã€‚

ä»¥ä¸‹çš„ä»‹ç»éƒ½æ˜¯é’ˆå¯¹å•å°æœåŠ¡å™¨éƒ¨ç½²å±•å¼€çš„ã€‚å¦‚æœå¤šå°æœºå­éƒ¨ç½²ï¼Œä½ éœ€è¦åšç›¸åº”çš„è°ƒæ•´ï¼Œæ¯”å¦‚ä½¿ç”¨è…¾è®¯äº‘çš„CDBï¼ˆäº‘æ•°æ®åº“æœåŠ¡ï¼‰ï¼Œä½ å°±éœ€è¦å¯¹Djangoåº”ç”¨çš„è®¾ç½®æ–‡ä»¶ï¼ˆsettings.pyï¼‰ä¸­æ•°æ®åº“éƒ¨åˆ†ä½œä¿®æ”¹ã€‚

#### Ubuntuå‡†å¤‡

é¦–å…ˆï¼Œé€šè¿‡SSHç™»å½•åˆ°UbuntuæœåŠ¡å™¨ï¼Œåƒè¿æ¥æ ‘è“æ´¾ä¸€æ ·ï¼Œä½ ä»ç„¶å¯ä»¥ä½¿ç”¨Puttyæˆ–è€…SecureCRTè¿™æ ·çš„ç»ˆç«¯è½¯ä»¶ã€‚

æœåŠ¡å™¨çš„IPåœ°å€å¯ä»¥ä»è…¾è®¯äº‘çš„äº‘æœåŠ¡å™¨æ§åˆ¶å°è·å–ã€‚å…³äºç”¨æˆ·åå’Œå¯†ç ï¼Œâ€œè…¾è®¯äº‘åŠ©æ‰‹â€å…¬ä¼—å·ä¼šåœ¨è´­ä¹°äº‘æœåŠ¡å™¨æ—¶å‘é€æ¶ˆæ¯é€šçŸ¥ã€‚å¦‚æœæ²¡æœ‰æ”¶åˆ°ï¼Œä½ å¯ä»¥åœ¨æ§åˆ¶å°é‡ç½®å¯†ç ã€‚

ç™»å½•åï¼Œé¦–å…ˆéœ€è¦æ›´æ–°aptï¼Œä½ å¯ä»¥è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š

```
$ sudo apt-get update
```

#### ä»£ç ä¸Šä¼ 

æ¥ç€ï¼Œä½ éœ€è¦å°†Djangoåº”ç”¨çš„ä»£ç ä¸Šä¼ åˆ°æœåŠ¡å™¨æŸä¸ªç›®å½•ä¸‹ï¼Œæ¯”å¦‚ /home/ubuntu/iot/ è¿™ä¸ªç›®å½•ä¸‹ã€‚è¿™æ¶‰åŠåˆ°ä¸‹é¢ä»‹ç»çš„Nginxå’ŒuWSGIçš„é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„ï¼Œå› æ­¤ï¼Œ**å¦‚æœä»£ç çš„è·¯å¾„ä¸æ˜¯è¿™ä¸ªï¼Œä½ éœ€è¦ç›¸åº”åœ°ä¿®æ”¹è¿™äº›é…ç½®ä¸­çš„è·¯å¾„ã€‚**

ä¸Šä¼ çš„å·¥å…·ï¼Œä½ è¿˜æ˜¯å¯ä»¥ä½¿ç”¨ç¬¬19è®²ä¸­æåˆ°çš„FileZillaç­‰è½¯ä»¶ã€‚

#### æ•°æ®åº“

æˆ‘ä»¬ä½¿ç”¨çš„MySQLæ•°æ®åº“ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…ï¼š

```
$ sudo apt-get install mysql-server mysql-client libmysqlclient-dev
```

è¯´æ˜ä¸€ä¸‹ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…libmysqlclient-devçš„è¯ï¼Œæ¥ä¸‹æ¥å®‰è£…mysql-pythonçš„æ­¥éª¤å¯èƒ½ä¼šæŠ¥é”™ã€‚

å®‰è£…è¿‡ç¨‹ä¸­ï¼Œç»ˆç«¯ä¹Ÿæç¤ºä½ è¾“å…¥MySQLæ•°æ®åº“çš„å¯†ç ï¼Œä½ å¯ä»¥åƒæˆ‘ä¸€æ ·ï¼Œè¾“å…¥â€œgeektimeâ€ã€‚

![](https://static001.geekbang.org/resource/image/e8/7d/e83f9851db3064a202cf501b54676c7d.png?wh=1636%2A428)

å®‰è£…å®Œæˆåï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤ï¼Œè¿æ¥ä¸Šæ•°æ®åº“ã€‚

```
$ mysql -p -u root
```

ç„¶åï¼Œåœ¨æ•°æ®åº“çš„äº¤äº’å‘½ä»¤è¡Œä¸­ï¼Œä½ éœ€è¦è¾“å…¥ä¸‹é¢çš„å‘½ä»¤ï¼Œåˆ›å»º geektime æ•°æ®åº“ã€‚

```
create database geektime; 
exit;
```

#### Pythonç¯å¢ƒ

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦é…ç½®Pythonè¯­è¨€ç¯å¢ƒï¼Œå› ä¸ºåº”ç”¨ç¨‹åºå’ŒDjangoåº”ç”¨æ¡†æ¶éƒ½æ˜¯åŸºäºPythonçš„ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ç³»ç»Ÿçš„é»˜è®¤pythonï¼Œå°†å®ƒä¿®æ”¹ä¸ºpython3ç‰ˆæœ¬ã€‚è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š

```
$ vim ~/.bashrc
```

åœ¨æ–‡ä»¶ä¸­ï¼Œå¢åŠ ä¸‹é¢çš„å†…å®¹ï¼š

```
alias python='/usr/bin/python3'
```

æ·»åŠ å®Œæˆåï¼Œé€€å‡ºvimã€‚åœ¨ç»ˆç«¯è¾“å…¥ä¸‹é¢çš„å‘½ä»¤ï¼Œä½¿å…¶ç”Ÿæ•ˆï¼š

```
$ source ~/.bashrc
```

æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£… pip ï¼ŒPythonåŒ…ç®¡ç†å™¨ï¼ˆPython package managerï¼‰ã€‚ä½ å¯ä»¥è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š

```
$ sudo apt-get install python3-pip
$ sudo pip3 install --upgrade pip
```

æ¥ç€ï¼Œä½ è¿˜éœ€è¦å®‰è£… python-dev ï¼Œä¸€äº›è½¯ä»¶åŒ…çš„å®‰è£…éœ€è¦ä¾èµ–å®ƒã€‚å‘½ä»¤å¦‚ä¸‹ï¼š

```
$ sudo apt-get install python3-dev 
```

åé¢ï¼Œä½ éœ€è¦è¿›å…¥Djangoåº”ç”¨ç›®å½•ï¼ˆæˆ‘ä»¬è¿™é‡Œæ˜¯ /home/ubuntu/iot/watering\_webï¼‰ï¼Œç„¶åè¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå®‰è£…æ‰€æœ‰ä¾èµ–çš„è½¯ä»¶åŒ…ã€‚ï¼š

```
pip3 install -r requirements.txt 
```

å¦‚æœå‡ºç° locale.Error: unsupported locale setting çš„é”™è¯¯ï¼Œè¯·åœ¨å‘½ä»¤è¡Œè¾“å…¥ä¸‹é¢çš„å‘½ä»¤ï¼š

```
export LC_ALL="en_US.UTF-8"
```

requirements.txtæ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š

```
tencentcloud-sdk-python==3.0.313
mysqlclient
Django
```

ç°åœ¨ï¼Œç¯å¢ƒå·²ç»å‡†å¤‡å°±ç»ªï¼Œä¸‹é¢æˆ‘æ¥è®²è§£ä¸€ä¸‹æ•°æ®åº“å’ŒuWSGIã€Nginxçš„é…ç½®ã€‚

#### æ•°æ®åº“Migrate

åœ¨Djangoä¸­ï¼Œæ•°æ®åº“çš„åˆ›å»ºå·²ç»å¤„ç†å¾—éå¸¸ç®€å•ï¼Œæ¡†æ¶æœ¬èº«åšäº†å¾ˆå¤šçš„å·¥ä½œã€‚

é¦–å…ˆï¼Œåœ¨manage.pyæ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š

```
$ python manage.py makemigrations 
```

æ¥ç€ï¼Œåªéœ€è¦è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå°±å¯ä»¥å®Œæˆæ‰€æœ‰çš„æ•°æ®åº“è¡¨åˆ›å»ºå·¥ä½œã€‚

```
$ python manage.py migrate
```

#### ç¡®è®¤æµ‹è¯•

ç°åœ¨ï¼Œä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¯åŠ¨Djangoåº”ç”¨ã€‚ç„¶åï¼Œä½ å¯ä»¥é€šè¿‡æµè§ˆå™¨ç¡®è®¤Django åº”ç”¨æ˜¯å¦å¯ä»¥æ­£å¸¸è¿è¡Œã€‚

```
$ python manage.py runserver 0.0.0.0:8080
```

ä¸‹é¢ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®‰è£…uWSGIå’ŒNginxäº†ã€‚

#### uWSGIå®‰è£…

uWSGIç›¸å½“äºæ˜¯Djangoåº”ç”¨å’ŒNginxä¹‹é—´çš„æ¡¥æ¢ï¼Œå®ƒä½¿ç”¨æ ‡å‡†çš„WSGIæ¥å£ä¸åº”ç”¨é€šä¿¡ã€‚ä½ éœ€è¦è¿è¡Œå‘½ä»¤ï¼Œå®‰è£…uWSGIï¼š

```
$ sudo apt-get install -y uwsgi
$ sudo apt-get install uwsgi-plugin-python3
$ pip3 install uwsgi
```

ç„¶åï¼Œåœ¨ /home/ubuntu/iot/config ç›®å½•ä¸‹ä¸ºuWSGIå¢åŠ é…ç½®æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹:

```
[uwsgi]
socket = 127.0.0.1:3031 
chdir = /home/ubuntu/iot/watering_web
wsgi-file = watering_web/wsgi.py 
processes = 4
plugins = python3
threads = 2
stats = 127.0.0.1:9191
```

æ¥ç€ï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼ŒæŸ¥çœ‹uWSGIæ˜¯å¦å¯ä»¥æ­£å¸¸è¿è¡Œã€‚

```
$ sudo uwsgi --ini ./config/uwsgi.ini 
```

ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦é…ç½®åŸºäºsystemdçš„uWSGIçš„è‡ªå¯åŠ¨æµç¨‹ã€‚è¿™éœ€è¦åˆ›å»ºsystemdçš„unitæ–‡ä»¶ã€‚æˆ‘ä»¬è¿˜æ˜¯åœ¨ /home/ubuntu/config ç›®å½•ä¸‹å¢åŠ  uwsgi.serviceæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```
[Unit]
Description=uWSGI
After=syslog.target  

[Service]
User=ubuntu
ExecStart=/usr/bin/uwsgi --ini /home/ubuntu/iot/config/uwsgi.ini
Restart=always
KillSignal=SIGQUIT
Type=notify
StandardError=syslog
NotifyAccess=all

[Install]
WantedBy=multi-user.target
```

è¿™æ—¶ï¼Œä½ è¿˜ä¸éœ€è¦æ·»åŠ è¿™ä¸ªserviceï¼Œåœ¨åé¢æˆ‘ä»¬ä¼šé€šè¿‡å‘½ä»¤æ·»åŠ ã€æ‰§è¡Œè¿™ä¸ªé…ç½®æ–‡ä»¶ã€‚

#### å®‰è£…Nginx

é¦–å…ˆï¼Œä½ éœ€è¦æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå®‰è£…Nginxè½¯ä»¶ã€‚

```
$ sudo apt-get install nginx 
```

ç„¶åï¼Œæˆ‘ä»¬éœ€è¦é…ç½®å®ƒã€‚æˆ‘ä»¬é€šè¿‡æ–°æ·»åŠ æ–‡ä»¶ï¼Œæ¥é…ç½®æˆ‘ä»¬çš„æœåŠ¡ï¼Œåœ¨ /etc/nginx/conf.d/ ç›®å½•ä¸‹ï¼Œå¢åŠ  iot.conf æ–‡ä»¶ï¼Œæ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹:

```
server {
    listen 80;
    #listen [::]:80 default_server; 
    server_name 159.75.214.14; #æ›¿æ¢ä¸ºè‡ªå·±æœåŠ¡å™¨IPåœ°å€ 

    location / {
        root /home/ubuntu/iot/watering_web/web/;
        index index.html; 
    }

    location ^~ /geektime/ {
        include uwsgi_params;
        uwsgi_pass 127.0.0.1:3031; 
    }

    error_page 404 /404.html; 
    location = /40x.html {
    }

    error_page 500 502 503 504 /50x.html; 
    location = /50x.html {
    }
}
```

å¹¶ä¸”ï¼Œå°†/etc/nginx/nginx.confæ–‡ä»¶ä¸­çš„â€œuser www-data;â€ ä¿®æ”¹ä¸ºâ€œuser ubuntu;â€ã€‚

ç°åœ¨ï¼Œä½ éœ€è¦æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ£€æŸ¥Nginxé…ç½®æ–‡ä»¶çš„è¯­æ³•ï¼š

```
$ sudo nginx -t
```

å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œå°±å¯ä»¥é‡å¯Nginxï¼Œæ¥åŠ è½½æ–°çš„é…ç½®æ–‡ä»¶ï¼š

```
$ sudo service nginx restart 
```

ç„¶åï¼ŒæŠŠuWSGIçš„serviceé…ç½®æ–‡ä»¶æ‹·è´åˆ°systemdé…ç½®ç›®å½•ä¸‹ï¼š

```
$ sudo cp uwsgi.service /etc/systemd/system/ 
```

ç°åœ¨ï¼Œä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¯åŠ¨uWSGIæœåŠ¡ï¼š

```
$ sudo systemctl start uwsgi
```

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠuWSGIæ·»åŠ åˆ°å¼€æœºè‡ªå¯åŠ¨ä¸­ï¼š

```
$ sudo systemctl enable uwsgi
```

åˆ°è¿™é‡Œï¼ŒæœåŠ¡å°±éƒ¨ç½²å®Œæ¯•äº†ã€‚

### äº‘å¹³å°æ•°æ®åŒæ­¥URLæ›´æ–°

äº‘æœåŠ¡å™¨ä¸Šçš„Webåº”ç”¨è¿è¡Œæ­£å¸¸åï¼Œä½ å¯ä»¥å¯¹è…¾è®¯äº‘ç‰©è”ç½‘å¹³å°ä¸Šçš„HTTPæ•°æ®åŒæ­¥è¿›è¡Œæ›´æ–°ã€‚ä¿®æ”¹é…ç½®ä¸­çš„URLåœ°å€ä¸ºè‡ªå·±äº‘æœåŠ¡å™¨çš„è§†å›¾åœ°å€ã€‚

![](https://static001.geekbang.org/resource/image/49/28/49d7959887a67b4cdcb67db4951a6928.png?wh=1192%2A572)

æ›´æ–°å®Œæˆåï¼Œä½ å°±å¯ä»¥åœ¨æµè§ˆå™¨ä¸Šè®¿é—®è‡ªå·±çš„æœåŠ¡å™¨åœ°å€ï¼ŒæŸ¥çœ‹è‡ªåŠ¨æµ‡èŠ±å™¨çš„å®æ—¶æ•°æ®ï¼Œå¹¶ä¸”æ§åˆ¶å®ƒè¿›è¡Œæµ‡æ°´ã€‚

![](https://static001.geekbang.org/resource/image/fc/56/fc4e7e4b040b94b5fca091faf8b9f856.png?wh=1142%2A600)

## å°ç»“

æ€»ç»“ä¸€ä¸‹ï¼Œåœ¨è¿™ä¸€è®²ä¸­ï¼Œæˆ‘å›´ç»•è‡ªåŠ¨æµ‡èŠ±å™¨è®²è§£äº†æ™ºèƒ½å®¶å±…ç³»ç»Ÿä¸­è®¾å¤‡æ•°æ®çš„åº”ç”¨ç³»ç»Ÿå¼€å‘æ–¹æ³•ã€‚ä¸»è¦çš„å†…å®¹æœ‰ï¼š

1. è…¾è®¯äº‘ç‰©è”ç½‘å¹³å°ä¸ºæˆ‘ä»¬æä¾›äº†ç®€å•æ˜“ç”¨çš„æ•°æ®å¼€å‘æ–¹æ³•ã€‚åŸºäºå¯è§†åŒ–ç•Œé¢ï¼Œæˆ‘ä»¬ç¼–è¾‘â€œè¾“å…¥â€ï¼Œâ€œå¤„ç†â€å’Œâ€œè¾“å‡ºâ€å°±å¯ä»¥å®Œæˆä¸€ä¸ªæ•°æ®æµçš„åˆ›å»ºï¼Œå®ç°æ•°æ®çš„è¿‡æ»¤å’Œæ¶ˆæ¯æ¨é€ã€‚
2. æˆ‘ä»¬å¯ä»¥åŸºäºç‰©è”ç½‘å¹³å°çš„æ•°æ®åŒæ­¥èƒ½åŠ›ï¼Œæ¯”å¦‚HTTPæ¨é€ï¼Œå®ç°ç‰©è”ç½‘å¹³å°å’Œåº”ç”¨æœåŠ¡å™¨çš„å¯¹æ¥ã€‚åœ¨åº”ç”¨æœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çµæ´»åœ°å¼€å‘æ•°æ®åº”ç”¨ç³»ç»Ÿã€‚
3. Djangoæ˜¯éå¸¸æµè¡Œçš„ï¼ŒåŸºäºPythonè¯­è¨€çš„Webåº”ç”¨å¼€å‘æ¡†æ¶ã€‚å·¥ä½œä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨Djangoæ¯”è¾ƒå¿«é€Ÿåœ°å®ç°ä¸€ä¸ªWebåº”ç”¨ç³»ç»Ÿã€‚

åœ¨è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬çš„æ•°æ®åº”ç”¨ç³»ç»ŸåªåŒ…å«äº†è‡ªåŠ¨æµ‡èŠ±å™¨çš„æ•°æ®ï¼Œä½ åœ¨æ—¶é—´å…è®¸çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥å°è¯•åœ¨è¿™ä¸ªç³»ç»Ÿä¸­å¢åŠ ä¸€ä¸‹æ™ºèƒ½ç”µç¯å’Œå…‰ç…§ä¼ æ„Ÿå™¨çš„æ•°æ®ã€‚

å¦å¤–ï¼Œç‰©è”ç½‘å¹³å°çš„æ•°æ®åŒæ­¥ä¹Ÿæä¾›äº† CKafkaï¼ˆCloud Kafkaï¼‰çš„æ•°æ®è½¬å‘æ–¹å¼ã€‚é€šè¿‡è®¢é˜…Topicä¸»é¢˜æ¶ˆæ¯ï¼Œæˆ‘ä»¬å¯ä»¥æ¶ˆè´¹Kafkaçš„æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å°†Kafkaæ¶ˆæ¯è½¬å‚¨åˆ°MySQLäº‘æ•°æ®åº“ä¸­ã€‚

ä¸è¿‡ï¼ŒKafkaçš„è´¹ç”¨æ¯”äº‘æœåŠ¡å™¨è¦è´µä¸å°‘ï¼Œè¿™é‡Œå°±ä¸ä»‹ç»äº†ã€‚å¦‚æœä½ çš„æ¡ä»¶å…è®¸ï¼Œä¹Ÿå¯ä»¥åŠ¨æ‰‹å®è·µä¸€ä¸‹è¿™ç§æ–¹å¼ã€‚

è¿™é‡Œï¼Œæˆ‘æ•´ç†äº†ä¸€ä¸ªæ€ç»´å¯¼å›¾ï¼Œä¾›ä½ å‚è€ƒï¼š

![](https://static001.geekbang.org/resource/image/c1/cf/c1ca9362755ab00917f3969176a7fccf.png?wh=1806%2A1604)

## æ€è€ƒé¢˜

æœ€åï¼Œæˆ‘ç»™ä½ ç•™ä¸€ä¸ªæ€è€ƒé¢˜å§ã€‚

åœ¨Djangoåº”ç”¨å¼€å‘çš„ä»‹ç»éƒ¨åˆ†ï¼Œæˆ‘æåˆ°äº†admin.pyæ˜¯åå°ç®¡ç†åº”ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œè€Œä¸”è®¿é—®[http://127.0.0.1:8000/admin/](http://127.0.0.1:8000/admin/)åœ°å€ï¼Œå°±ä¼šå‡ºç°ç®¡ç†å‘˜ç™»å½•é¡µé¢ã€‚ä½ çŸ¥é“åœ¨Djangoé¡¹ç›®ä¸­å¦‚æœåˆ›å»ºç®¡ç†å‘˜è´¦å·å—ï¼Ÿå¦å¤–ï¼Œå¦‚ä½•åœ¨admin.pyæ–‡ä»¶ä¸­å¢åŠ Wateringæ•°æ®åº“æ¨¡å‹å¯¹è±¡ï¼Œå®ç°å¯¹è‡ªåŠ¨æµ‡èŠ±å™¨ç›‘æµ‹æ•°æ®çš„æŸ¥è¯¢å‘¢ï¼Ÿ

æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºå†™ä¸€å†™è‡ªå·±çš„æ€è€ƒï¼ŒåŒæ—¶ï¼Œä¹Ÿæ¬¢è¿ä½ å°†è¿™ä¸€è®²åˆ†äº«ç»™å¯¹Webåº”ç”¨å¼€å‘æ„Ÿå…´è¶£çš„æœ‹å‹ï¼Œå¤§å®¶ä¸€èµ·äº¤æµå­¦ä¹ ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ3ï¼‰</strong></div><ul>
<li><span>Dan</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä½ çŸ¥é“åœ¨ Django é¡¹ç›®ä¸­å¦‚heåˆ›å»ºç®¡ç†å‘˜è´¦å·å—ï¼Ÿ
python manage.py cratesuperuser

å¦‚ä½•åœ¨ admin.py æ–‡ä»¶ä¸­å¢åŠ  Watering æ•°æ®åº“æ¨¡å‹å¯¹è±¡ï¼Œå®ç°å¯¹è‡ªåŠ¨æµ‡èŠ±å™¨ç›‘æµ‹æ•°æ®çš„æŸ¥è¯¢å‘¢ï¼Ÿ
admin.site.register(Watering)</p>2021-01-04</li><br/><li><span>æŸ æª¬æ°´</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¶Šæ¥è¶Šä½©æœè€å¸ˆäº†ï¼ŒçœŸçš„æ˜¯å…¨æ ˆå•Šï¼Œä»ç¡¬ä»¶åˆ°è½¯ä»¶ï¼Œä»å‰ç«¯åˆ°åç«¯ã€‚</p>2021-01-06</li><br/><li><span>pgé»‘å‡¤å‡°</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å­¦ä¹ éš¾åº¦å‘ˆæŒ‡æ•°çº§ä¸Šå‡</p>2022-01-24</li><br/>
</ul>