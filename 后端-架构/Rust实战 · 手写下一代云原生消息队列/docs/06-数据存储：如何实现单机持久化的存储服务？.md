> æœ¬è¯¾ç¨‹ä¸ºç²¾å“å°è¯¾ï¼Œä¸æ ‡é…éŸ³é¢‘

ä½ å¥½ï¼Œæˆ‘æ˜¯æ–‡å¼ºã€‚

ä¸ŠèŠ‚è¯¾æˆ‘ä»¬å®Œæˆäº† Server æ¨¡å—çš„å¼€å‘ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®ç°å…ƒæ•°æ®å­˜å‚¨æœåŠ¡ä¸­çš„å•æœºå­˜å‚¨å±‚ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ¥çœ‹ä¸€ä¸‹å•æœºå­˜å‚¨å±‚çš„æŠ€æœ¯æ–¹æ¡ˆå¦‚ä½•é€‰å‹ã€‚

## å­˜å‚¨å±‚å®ç°è®¾è®¡è€ƒé‡

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬çŸ¥é“äº†å…ƒæ•°æ®å­˜å‚¨æœåŠ¡çš„æ ¸å¿ƒæ˜¯ KV æ¨¡å‹æ•°æ®çš„å­˜å‚¨ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/6c/6e/6c452105ff951bc5d1860bb21272b06e.png?wh=1139x641)  
é‚£å¦‚ä½•æ¥å®ç°è¿™ä¸ªå­˜å‚¨å±‚å‘¢ï¼Ÿä»æŠ€æœ¯ä¸Šæ¥çœ‹ï¼Œä¸€èˆ¬æœ‰ä¸‰ä¸ªæ€è·¯ï¼š

1. åŸºäºæ–‡ä»¶ç³»ç»Ÿä»å¤´å®ç°æ•°æ®å­˜å‚¨ã€‚
2. åŸºäºç°æœ‰æˆç†Ÿçš„åˆ†å¸ƒå¼å­˜å‚¨å¼•æ“å®Œæˆæ•°æ®çš„å­˜å‚¨ï¼Œæ¯”å¦‚ ZooKeeperã€etcdç­‰ã€‚
3. åŸºäºç°æœ‰æˆç†Ÿçš„åµŒå…¥å¼é”®å€¼æ•°æ®åº“å®ç°ï¼Œæ¯”å¦‚ RocksDBã€LevelDB ç­‰ã€‚

ç¬¬ä¸€ç§æ–¹æ¡ˆå¾ˆç›´è§‚ï¼Œå¯èƒ½ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨é€‰å‹æ—¶é¦–å…ˆæƒ³åˆ°çš„æ€è·¯ï¼Œä½†æ˜¯**è¿™ç§æ–¹æ¡ˆæ˜¯æœ€ä¸æ¨èçš„**ã€‚å› ä¸ºä»é›¶å¼€å§‹å†™ä¸€ä¸ªç”Ÿäº§çº§åˆ«çš„å­˜å‚¨å±‚æ˜¯éå¸¸å›°éš¾çš„ï¼Œå‘¨æœŸå¾ˆé•¿ï¼Œç¨³å®šæ€§å·®ã€‚æ¯”å¦‚éœ€è¦å¤„ç†ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿéšæ—¶éƒ½æœ‰å¯èƒ½ä¸¢å¤±æˆ–æŸåæ•°æ®çš„æƒ…å†µï¼Œå¦å¤–å†™å…¥æ€§èƒ½ä¼˜åŒ–éœ€è¦å¤§é‡æ—¶é—´æŠ•å…¥ï¼Œè¿˜å¾—å¤„ç†ä»£ç  Bug ç­‰æƒ…å†µã€‚

ç¬¬äºŒç§æ–¹æ¡ˆæ˜¯å¸¸ç”¨çš„æ–¹æ¡ˆï¼Œä¾èµ–æˆç†Ÿçš„åˆ†å¸ƒå¼å­˜å‚¨å¼•æ“å­˜å‚¨æ•°æ®ï¼Œæ˜¯æ¯”è¾ƒå¿«é€Ÿä¸”ç¨³å®šçš„æ–¹æ¡ˆã€‚ä½†æ˜¯è¿™ç§æ–¹æ¡ˆçš„ç¼ºç‚¹æ˜¯éœ€è¦ä¾èµ–å¤–éƒ¨ç³»ç»Ÿï¼Œä¼šå¯¼è‡´æ¶æ„å¤æ‚ï¼Œé•¿æœŸè¿ç»´æˆæœ¬é«˜ï¼Œå¦å¤–å¤–éƒ¨ä¾èµ–ç»„ä»¶çš„ç¨³å®šæ€§ä¹Ÿä¼šå½±å“ä¸»ç³»ç»Ÿçš„ç¨³å®šã€‚å› ä¸ºæˆ‘ä»¬è¦å®ç°çš„æ¶ˆæ¯é˜Ÿåˆ—å…¶ä¸­ä¸€ä¸ªè®¾è®¡ç›®æ ‡å°±æ˜¯ï¼š**é«˜å†…èšå’Œå¼±å¤–éƒ¨ä¾èµ–**ã€‚å¦‚æœé€‰æ‹©è¿™ç§æ–¹æ¡ˆï¼Œå°±ç ´åäº†è¿™ä¸ªç›®æ ‡ï¼Œé•¿æœŸæ¥çœ‹ï¼Œä¸å¤ªåˆç†ã€‚

ç¬¬ä¸‰ç§æ–¹æ¡ˆä»æŸç§è§’åº¦çœ‹å’Œç¬¬ä¸€ç§æ˜¯åŒä¸€ä¸ªæ€è·¯ã€‚åŒºåˆ«æ˜¯å­˜å‚¨å±‚ä¸æ˜¯è‡ªå·±å®ç°çš„ï¼Œè€Œæ˜¯ä¾èµ–ç°æœ‰çš„æˆç†Ÿã€å¯é ã€é«˜æ€§èƒ½çš„åµŒå…¥å¼é”®å€¼å­˜å‚¨æ¥å®ç°å­˜å‚¨å±‚ã€‚è¿™ç§æ–¹æ¡ˆçš„å¼€å‘æˆæœ¬ä½ï¼Œæ€§èƒ½å’Œå¯é æ€§ä¹Ÿæœ‰ä¿è¯ã€‚ç›®å‰ä¸šç•Œä¸»è¦çš„åµŒå…¥å¼é”®å€¼å­˜å‚¨æœ‰ RocksDBã€LevelDB ç­‰ã€‚ç›®å‰ä½¿ç”¨è¾ƒå¤šçš„æ˜¯ RocksDBï¼Œä¸šç•Œå¾ˆå¤šçŸ¥åå…¬å¸å’Œå¼€æºé¡¹ç›®éƒ½åœ¨ä½¿ç”¨å®ƒã€‚æ¯”å¦‚ TiKVã€CRDBéƒ½æ˜¯åŸºäº RocksDB æ¥å®ç°çš„ã€‚

æ‰€ä»¥ï¼Œä»å®ç°éš¾åº¦ã€ç¨³å®šæ€§ã€æ€§èƒ½ç­‰ä¸‰ä¸ªæ–¹é¢è€ƒè™‘ï¼Œæˆ‘ä»¬é€‰æ‹©äº†ç¬¬ä¸‰ç§æ–¹æ¡ˆã€‚ä»å…ƒæ•°æ®å­˜å‚¨æœåŠ¡(Placement Center) çš„åŠŸèƒ½éœ€æ±‚å’Œä¸šç•ŒåµŒå…¥å¼é”®å€¼æ•°æ®åº“çš„åŠŸèƒ½ã€ç¨³å®šæ€§ã€é¡¹ç›®æˆç†Ÿåº¦ã€ç¤¾åŒºæ´»è·ƒåº¦æ¥çœ‹ï¼Œæˆ‘è®¤ä¸º RocksDB éå¸¸é€‚åˆæ¥å½“å­˜å‚¨å±‚ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ä»åŠŸèƒ½å’Œæ¶æ„ä¸Šç®€å•ä»‹ç»ä¸€ä¸‹ RocksDBã€‚

## RocksDB ç®€ä»‹

ä»åŠŸèƒ½å±‚é¢æ¥çœ‹ï¼ŒRocksDB å®ƒæ˜¯ä¸€ä¸ªåµŒå…¥å¼çš„é”®å€¼å­˜å‚¨å¼•æ“ï¼Œå®ƒæä¾›äº†ä¸‹é¢å‡ ä¸ªä¸»è¦çš„åŠŸèƒ½å‡½æ•°è°ƒç”¨ï¼š

- **Put(Key, Value)**ï¼šæ’å…¥æ–°çš„Key-Valueå¯¹æˆ–æ›´æ–°ç°æœ‰ Key çš„å€¼ã€‚
- **Get(Key)**ï¼šè·å–ç‰¹å®š Key çš„å€¼ã€‚
- **Delete(Key)**ï¼šåˆ é™¤ç‰¹å®š Key çš„å€¼ã€‚
- **Merge(Key, Value)**ï¼šå°†æ–°å€¼ä¸ç»™å®š Key çš„ç°æœ‰å€¼åˆå¹¶ã€‚
- **Seek(key\_prefix)**ï¼šåŒ¹é…æŒ‡å®š Key çš„å‰ç¼€æˆ–å¤§äº Key çš„å‰ç¼€ã€‚

ä»è¿™å‡ ä¸ªå‡½æ•°æ¥çœ‹ï¼Œå®ƒæ˜¯æ ‡å‡† KV æ¨¡å‹çš„å­˜å‚¨ï¼Œå³ set/get/delete/search ç±»å‹çš„æ–¹æ³•ã€‚

ä»ä»£ç å±‚é¢æ¥çœ‹ï¼Œ**RocksDB å°±ä¸€ä¸ª Libï¼Œä¸æ˜¯ä¸€ä¸ª Server**ï¼Œæ˜¯ä¸€ä¸ªè¢«é¡¹ç›®å¼•ç”¨çš„åº“ã€‚ä¹Ÿå°±æ˜¯è¯´å®ƒæ²¡æœ‰ç‹¬ç«‹çš„è¿›ç¨‹è¿è¡Œï¼Œæ˜¯å’Œä¸»è¿›ç¨‹å…±äº«å†…å­˜ç©ºé—´ã€‚æ¯”å¦‚åœ¨ Java ä¸­å®ƒæ˜¯ Maven çš„ Packageï¼Œåœ¨ Rust ä¸­ï¼Œå®ƒæ˜¯ä¸€ä¸ª crate ä¸Šçš„ Libï¼Œåœ¨ Go ä¸­å®ƒæ˜¯ä¸€ä¸ª Moduleã€‚

ä»åº•å±‚å­˜å‚¨çš„è§’åº¦æ¥çœ‹ï¼ŒRocksDB çš„æ•°æ®æ˜¯**å­˜å‚¨åœ¨å•æœºæœ¬åœ°ç¡¬ç›˜çš„æ–‡ä»¶ä¸­çš„**ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæ˜¯æœ¬åœ°å­˜å‚¨çš„ã€‚å³é€šè¿‡ Put å‡½æ•°å†™å…¥çš„æ•°æ®ï¼Œéƒ½æ˜¯å­˜å‚¨åœ¨æœ¬æœºçš„æ–‡ä»¶ä¸­çš„ã€‚RocksDB çš„æœ¬åœ°æ–‡ä»¶å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼Œä¼šåŒ…å« sstã€log ç­‰ç­‰ä¿¡æ¯ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/19/7a/19492a9925df38f2f5b2c7acec7a437a.png?wh=1148x460)

ä»åº•å±‚åŸç†æ¥çœ‹ï¼Œå®ƒæ˜¯åŸºäº **LSM-Treeï¼ˆLog-Structured Merge Treeï¼‰**å®ç°çš„ä¸€ç§æœ¬åœ°å­˜å‚¨å¼•æ“ã€‚å¦‚æœå¯¹å­˜å‚¨ç³»ç»Ÿæœ‰äº†è§£çš„äººï¼Œå¯¹ LSM åº”è¯¥ä¸ä¼šé™Œç”Ÿã€‚å¦‚æœä½ å¸Œæœ›å¯¹å­˜å‚¨ç³»ç»Ÿäº†è§£æ›´å¤šï¼Œå»ºè®®ä½ å»ç ”ç©¶ä¸€ä¸‹ LSMï¼Œå®ƒæ˜¯ä¸€ç§åŸºäºæ—¥å¿—ç»“æ„çš„æ•°æ®ç»“æ„ï¼Œèƒ½å¤Ÿé«˜æ•ˆåœ°å­˜å‚¨å’Œæ›´æ–°é”®å€¼æ•°æ®ã€‚LSM è¿™å—çš„èµ„æ–™ç‰¹åˆ«å¤šï¼Œå°±ä¸å±•å¼€ç»†è®²äº†ã€‚

å› ä¸ºæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šç”¨åˆ° RocksDB ä¸­çš„åˆ—ç°‡ï¼ˆColumnFamilyï¼‰ çš„æ¦‚å¿µï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹å®ƒæ˜¯ä»€ä¹ˆã€‚

ColumnFamily æ˜¯ RocksDB ä¸­çš„ä¸€ä¸ªé€»è¾‘æ¦‚å¿µï¼Œå®ƒçš„åŠŸèƒ½æ˜¯**ç”¨äº Key çš„ç»„ç»‡ã€‚**æ¯”å¦‚ä¸€éƒ¨åˆ†çš„ key å­˜å‚¨åœ¨ A ColumnFamilyï¼Œå¦å¤–ä¸€éƒ¨åˆ† key å­˜å‚¨åœ¨ B ColumnFamilyã€‚ColumnFamily å’Œ key çš„å…³ç³»ï¼Œæœ‰ç‚¹åƒ MySQL ä¸­ Database å’Œ table çš„å…³ç³»ã€‚Database ç”¨äº table çš„é€»è¾‘ç»„ç»‡ï¼Œtable ä¸€å®šè¦å±äºæŸä¸ª Databaseã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒRocksDB ä¸­æ‰€æœ‰çš„ key éƒ½åœ¨ä¸€ä¸ªé»˜è®¤çš„ ColumnFamily ä¸­ã€‚

äº†è§£äº† RocksDBï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åœ¨å…ƒæ•°æ®å­˜å‚¨æœåŠ¡ä¸­ï¼Œå¦‚ä½•åŸºäº RocksDB å®ç°å­˜å‚¨å±‚ã€‚

## Rust Rocksdb å…¥é—¨

åœ¨ Rust ä¸­ï¼Œéœ€è¦é€šè¿‡ Rust åº“[ã€Šrocksdbã€‹](https://docs.rs/rocksdb/0.22.0/rocksdb/)æ¥ä½¿ç”¨ RocksDBã€‚ä»ä»£ç å®ç°çš„å±‚é¢çœ‹ï¼Œä¸»è¦åŒ…å«ä¸‹é¢ä¸ƒä¸ªéƒ¨åˆ†ï¼š

- æ„å»º RocksDB é…ç½®
- åˆå§‹åŒ– RocksDB å®ä¾‹
- å†™æ•°æ®ï¼ˆWriteï¼‰
- æ ¹æ® Key è¯»å–æ•°æ®ï¼ˆGetï¼‰
- æ ¹æ® Key åˆ é™¤æ•°æ®ï¼ˆDeleteï¼‰
- åˆ¤æ–­ Key æ˜¯å¦å­˜åœ¨ï¼ˆExistsï¼‰
- æ ¹æ®å‰ç¼€è¯»å–æ•°æ®ï¼ˆread\_prefixï¼‰

æ¥ä¸‹æ¥æˆ‘ä»¬ä¸»è¦è·Ÿéšä»£ç å®ç°æ¥ä¸€ä¸ªä¸€ä¸ªè®²è§£ã€‚

1. æ„å»º RocksDB é…ç½®

æ„å»ºé…ç½®çš„ä¸»è¦å·¥ä½œæ˜¯è®¾ç½® RocksDB å®ä¾‹çš„é…ç½®é€‰é¡¹ï¼ˆOptionsï¼‰ã€‚ä»£ç å®ç°å¾ˆç®€å•ï¼Œéš¾ç‚¹åœ¨äºï¼š**è¦ç†è§£ RocksDB çš„è¿è¡ŒåŸç†ï¼Œæ¯ä¸ªé…ç½®é¡¹çš„æ„ä¹‰ï¼Œç„¶åæ ¹æ®è‡ªå·±çš„åœºæ™¯å’Œè¦æ±‚è¿›è¡Œé…ç½®ä¼˜åŒ–**ï¼Œè¿™ä¸ªæ˜¯å’Œè¯­è¨€æ— å…³çš„ã€‚

é…ç½®åˆå§‹åŒ–ä»£ç å¦‚ä¸‹ï¼š

```plain
 fn open_db_opts(config: &PlacementCenterConfig) -> Options {
        let mut opts = Options::default();
        opts.create_if_missing(true);
        opts.create_missing_column_families(true);
        opts.set_max_open_files(1000);
        opts.set_use_fsync(false);
        opts.set_bytes_per_sync(8388608);
        opts.optimize_for_point_lookup(1024);
        opts.set_table_cache_num_shard_bits(6);
        opts.set_max_write_buffer_number(32);
        opts.set_write_buffer_size(536870912);
        opts.set_target_file_size_base(1073741824);
        opts.set_min_write_buffer_number_to_merge(4);
        opts.set_level_zero_stop_writes_trigger(2000);
        opts.set_level_zero_slowdown_writes_trigger(0);
        opts.set_compaction_style(DBCompactionStyle::Universal);
        opts.set_disable_auto_compactions(true);
        let transform = SliceTransform::create_fixed_prefix(10);
        opts.set_prefix_extractor(transform);
        opts.set_memtable_prefix_bloom_ratio(0.2);
        return opts;
    }


```

è¿™æ®µä»£ç å¾ˆç®€å•ï¼Œç›´æ¥çœ‹è¿™ä¸ª[ã€ŠRust RocksDB Optionsã€‹](https://docs.rs/rocksdb/0.22.0/rocksdb/struct.Options.html)æ–‡æ¡£å³å¯ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Options::default() å¯å¾—åˆ°é»˜è®¤é…ç½®ï¼Œè¿™äº›é…ç½®å¯ä»¥æ»¡è¶³å¤§éƒ¨åˆ†åœºæ™¯ã€‚

å› ä¸º RocksDB çš„é…ç½®ä¼˜åŒ–æ˜¯ä¸€ä¸ªå¾ˆå¤§å’Œå¾ˆå¤æ‚çš„è¯é¢˜ï¼Œå¦‚æœè¦è¿›è¡Œé’ˆå¯¹æ€§çš„é…ç½®è°ƒä¼˜ï¼Œä½ å°±éœ€è¦å»çœ‹ä¸€ä¸‹è¿™ä¸ªæ–‡æ¡£[ã€ŠRocksDB å®˜æ–¹ wikiã€‹](https://github.com/facebook/rocksdb/wiki/RocksDB-Overview)ï¼Œå»å¯¹ RocksDB çš„åº•å±‚è¿è¡ŒåŸç†ï¼ˆä¸»è¦æ˜¯LSM-Treeï¼‰ã€é…ç½®é¡¹æ‰€è¡¨è¾¾çš„æ„ä¹‰æœ‰æ›´å¤šçš„äº†è§£ï¼Œæ‰èƒ½æ‰¾åˆ°æœ€é€‚åˆè‡ªå·±åœºæ™¯çš„é…ç½®é¡¹ã€‚

2. åˆå§‹åŒ– RocksDB å®ä¾‹

è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯**åˆå§‹åŒ–ä¸€ä¸ªå¯ä»¥æ“ä½œ RocksDB çš„å¯¹è±¡å®ä¾‹**ã€‚ä¸»è¦æµç¨‹æ˜¯æ„å»ºé…ç½®ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡ RocksDBï¼Œå¦‚æœæ²¡æœ‰å°±åˆå§‹åŒ– DBï¼Œç„¶åæ‰“å¼€éœ€è¦æ“ä½œçš„åˆ—ç°‡ï¼ˆColumnFamilyï¼‰å³å¯ã€‚

```plain
// åˆå§‹åŒ–RocksDB é…ç½®
let opts: Options = Self::open_db_opts(config);


// é…ç½® RocksDB çš„æ•°æ®ç›®å½•
let db_path = format!("{}/{}", config.data_path, "_storage_rocksdb");


// åˆ¤æ–­ RocksDB æ˜¯å¦åˆå§‹åŒ–æˆåŠŸï¼Œå¦åˆ™è¿›è¡Œåˆå§‹åŒ–ã€‚
if !Path::new(&db_path).exists() {
  DB::open(&opts, db_path.clone()).unwrap();
}


// åˆå§‹åŒ– RocksDB ä¸­çš„åˆ—ç°‡ã€‚
let cf_list = rocksdb::DB::list_cf(&opts, &db_path).unwrap();
let mut instance = DB::open_cf(&opts, db_path.clone(), &cf_list).unwrap();
```

ä¸Šé¢è¿™æ®µä»£ç éœ€è¦å…³æ³¨çš„ç‚¹æ˜¯ï¼š**åˆå§‹åŒ–åçš„ instance å…¨å±€åªèƒ½æœ‰ä¸€ä¸ªã€‚å³ä¸€ä¸ª RocksDB ç›®å½•åªèƒ½åŒæ—¶è¢«ä¸€ä¸ªå®ä¾‹æŒæœ‰ï¼Œä¸èƒ½å¤šæ¬¡ Open ä¸€ä¸ª RocksDB ç›®å½•ï¼Œå¦åˆ™å°±ä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯**ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/3f/f2/3fc756d1b737bd6a66c530f0dyy209f2.png?wh=1580x292)

æ‰€ä»¥åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œéœ€è¦**é€šè¿‡ Arc åœ¨å¤šçº¿ç¨‹ä¹‹é—´å…±äº« RocksDB instance**ï¼Œå³ **Arc**ï¼Œä»£ç å¦‚ä¸‹ï¼š

```plain
let rocksdb_engine_handler: Arc<RocksDBEngine> = Arc::new(RocksDBEngine::new(&config));
```

åœ¨è¿™é‡Œï¼Œä½ å°±ä¼šç”¨åˆ°æ™ºèƒ½æŒ‡é’ˆçš„ Arc ï¼Œé€šè¿‡å®ƒå¯ä»¥è®©åŒä¸€ä¸ª RocksDBEngine åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«ã€‚

3. å†™æ•°æ®ï¼ˆWriteï¼‰

å†™æ•°æ®ä»£ç å®ç°æ¯”è¾ƒç®€å•ã€‚æµç¨‹æ˜¯å…ˆé€‰æ‹©ColumnFamilyï¼Œé€šè¿‡ serde\_json åºåˆ—åŒ–æ•°æ®ï¼Œæœ€åé€šè¿‡ put\_cf æ–¹æ³•å°†æ•°æ®å†™å…¥åˆ° RocksDB ä¸­ã€‚

```plain
  pub fn write<T: Serialize + std::fmt::Debug>(
        &self,
        cf: &ColumnFamily,
        key: &str,
        value: &T,
    ) -> Result<(), String> {
        match serde_json::to_string(&value) {
            Ok(serialized) => self
                .db
                .put_cf(cf, key, serialized.into_bytes())
                .map_err(|err| format!("Failed to put to ColumnFamily:{:?}", err)),
            Err(err) => Err(format!(
                "Failed to serialize to String. T: {:?}, err: {:?}",
                value, err
            )),
        }
    }


```

ä¸Šé¢è¿™æ®µä»£ç éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå†™å…¥æ•°æ®å¿…é¡»é€‰æ‹©ColumnFamilyï¼ŒåŸå› æ˜¯**ä½œä¸ºå…ƒæ•°æ®æœåŠ¡ï¼Œå®ƒéœ€è¦å­˜å‚¨ä¸åŒç±»å‹çš„æ•°æ®ï¼Œå¹¶ä¸”é•¿æœŸå¯èƒ½æœ‰è¾ƒå¤§çš„æ•°æ®é‡ã€‚ä¸ºäº†é•¿æœŸæ‰©å®¹ã€æ‹†åˆ†ã€éš”ç¦»çš„æ–¹ä¾¿ï¼Œå°±éœ€è¦å°†æ•°æ®è¿›è¡Œé€»è¾‘æ‹†åˆ†**ã€‚

4. è¯»ï¼ˆGetï¼‰/ åˆ é™¤ï¼ˆDeleteï¼‰æ•°æ®ï¼Œå¹¶åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ï¼ˆExistsï¼‰

è¯»æ•°æ®æ˜¯é€šè¿‡RocksDB çš„ get\_cf æ–¹æ³•æ¥è·å–åˆ°æ•°æ®ï¼ŒDecord åè¿”å›å³å¯ã€‚

åˆ é™¤å’Œåˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨æ˜¯é€šè¿‡ deleteã€key\_may\_exist\_cf å‡½æ•°æ¥å®ŒæˆåŠŸèƒ½ã€‚

```plain
// Read data from the RocksDB
pub fn read<T: DeserializeOwned>(
        &self,
        cf: &ColumnFamily,
        key: &str,
    ) -> Result<Option<T>, String> {
        match self.db.get_cf(cf, key) {
            Ok(opt) => match opt {
                Some(found) => match String::from_utf8(found) {
                    Ok(s) => match serde_json::from_str::<T>(&s) {
                        Ok(t) => Ok(Some(t)),
                        Err(err) => Err(format!("Failed to deserialize: {:?}", err)),
                    },
                    Err(err) => Err(format!("Failed to deserialize: {:?}", err)),
                },
                None => Ok(None),
            },
            Err(err) => Err(format!("Failed to get from ColumnFamily: {:?}", err)),
        }
    }
   
// æ ¹æ® key åˆ é™¤æ•°æ®
pub fn delete(&self, cf: &ColumnFamily, key: &str) -> Result<(), RobustMQError> {
     return Ok(self.db.delete_cf(cf, key)?);
}


// åˆ¤æ–­ key æ˜¯å¦å­˜åœ¨
pub fn exist(&self, cf: &ColumnFamily, key: &str) -> bool {
    self.db.key_may_exist_cf(cf, key)
}


```

5. æ ¹æ®å‰ç¼€è¯»å–æ•°æ®ï¼ˆread\_prefixï¼‰

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œé™¤äº† Set å’Œ Get çš„éœ€æ±‚ï¼Œè¿˜æœ‰ä¸€ä¸ªéœ€æ±‚ä½ ç»å¸¸ä¼šç”¨åˆ°ï¼Œå°±æ˜¯**å‰ç¼€æœç´¢**ã€‚å³æ ¹æ®æŸä¸ª Key çš„å‰ç¼€æ¥è·å–è¿™ä¸ª Key å¯¹åº”çš„æ‰€æœ‰æ•°æ®ã€‚

æ¯”å¦‚æˆ‘ä»¬éœ€è¦å­˜å‚¨é›†ç¾¤ä¸­çš„ Userï¼Œæ¯ä¸ª User çš„ key å¦‚ä¸‹ï¼š

```plain
pub fn storage_key_mqtt_user(cluster_name: &String, user_name: &String) -> String {
    return format!("/mqtt/user/{}/{}", cluster_name, user_name);
}
```

å¦‚æœè¦è·å–é›†ç¾¤ä¸­æ‰€æœ‰çš„ç”¨æˆ·åˆ—è¡¨ï¼Œè‚¯å®šä¸èƒ½æ‰¾ä¸€ä¸ªåœ°æ–¹å­˜å‚¨æ‰€æœ‰çš„å®¢æˆ·ä¿¡æ¯ï¼Œç„¶å foreach å¾ªç¯ä¸€ä¸ªä¸€ä¸ªå»è·å–ã€‚æ­¤æ—¶å°±å¯ä»¥ç”¨å‰ç¼€æœç´¢ï¼Œå‰ç¼€æœç´¢çš„ key å¦‚ä¸‹ï¼š

```plain
pub fn storage_key_mqtt_user_cluster_prefix(cluster_name: &String) -> String {
    return format!("/mqtt/user/{}", cluster_name);
}


```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•å®ç°å‰ç¼€æœç´¢ã€‚

RocksDB ä¸­æä¾›äº†å‰ç¼€æœç´¢çš„åŠŸèƒ½ã€‚å› ä¸º RocksDB åº•å±‚å­˜å‚¨æ•°æ®æ—¶æ˜¯æ ¹æ® Key æ’åºå­˜å‚¨çš„ï¼Œæ‰€ä»¥å‰ç¼€æœç´¢çš„åº•å±‚é€»è¾‘æ˜¯ï¼š**å…ˆé€šè¿‡ seek æ–¹æ³•æ‰¾åˆ°è¯¥å‰ç¼€å¯¹åº”çš„ç¬¬ä¸€ä¸ª Keyï¼Œå†é€šè¿‡next æ–¹æ³•ä¸€ä¸ªä¸€ä¸ªå¾€åè·å–æ•°æ®ï¼Œä»è€Œå¾—åˆ°è¯¥å‰ç¼€å¯¹åº”çš„æ‰€æœ‰Key**ã€‚

```plain
   // Search data by prefix
    pub fn read_prefix(
        &self,
        cf: &ColumnFamily,
        search_key: &str,
    ) -> Vec<HashMap<String, Vec<u8>>> {
        // è·å– ColumnFamily çš„è¿­ä»£å™¨
        let mut iter = self.db.raw_iterator_cf(cf);
        
        // æœç´¢åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…è¿™ä¸ªå‰ç¼€çš„ key
        iter.seek(search_key);


        let mut result = Vec::new();


        // è·å–ä¸‹ä¸€ä¸ª key çš„å€¼
        while iter.valid() {
            let key = iter.key();
            let value = iter.value();


            let mut raw = HashMap::new();
            
            // å¦‚æœ key å’Œ value éƒ½ä¸ºç©ºï¼Œåˆ™é€€å‡ºå¾ªç¯
            if key == None || value == None {
                 break;
            }
            
            let result_key = match String::from_utf8(key.unwrap().to_vec()) {
                Ok(s) => s,
                Err(_) => continue,
            };


            // å¦‚æœkey ä¸åŒ¹é…å‰ç¼€ï¼Œè¯´æ˜å·²ç»è·å–åˆ°æ‰€æœ‰è¿™ä¸ªå‰ç¼€çš„ keyï¼Œåˆ™é€€å‡ºå¾ªç¯ã€‚
            if !result_key.starts_with(search_key) {
                break;
            }
            raw.insert(result_key, value.unwrap().to_vec());
            result.push(raw);
            iter.next();
        }
        return result;
    }


```

è¿™é‡Œï¼Œä¸çŸ¥é“ä½ æ˜¯å¦æ³¨æ„åˆ°ä¸‹é¢è¿™å‡ è¡Œä»£ç ï¼Œä»£ç çš„è¯­æ„æ˜¯ï¼š**åˆ¤æ–­è·å–åˆ°çš„æ•°æ®çš„Key æ˜¯å¦æ˜¯æœç´¢çš„å‰ç¼€ï¼Œå¦åˆ™ï¼Œé€€å‡ºå¾ªç¯**ã€‚

```plain
 if !result_key.starts_with(search_key) {
    break;
}
```

è¿™æ®µä»£ç éå¸¸é‡è¦ï¼Œä¹Ÿæ˜¯å‰ç¼€æœç´¢çš„æ ¸å¿ƒã€‚å‰é¢è¯´åˆ° RocksDB çš„åº•å±‚æ•°æ®æ˜¯æ ¹æ® Key é¡ºåºå­˜å‚¨çš„ï¼Œæ‰€ä»¥å…ˆé€šè¿‡ seek å®šä½åˆ°åŒ¹é…å‰ç¼€çš„ç¬¬ä¸€ä¸ª keyï¼Œç„¶åå¾€åé€ä¸ªè·å–ã€‚

ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼š**next æ–¹æ³•ä¸ä¼šåˆ¤æ–­æ•°æ®çš„ Key æ˜¯å¦åŒ¹é…è¿™ä¸ªå‰ç¼€**ã€‚å¦‚æœä¸åŠ è¿™ä¸ªåˆ¤æ–­ï¼Œåˆ™ä¼šä» seek åˆ°çš„ key å¼€å§‹ä¸€ç›´å¾€åè·å–åˆ°æ•´ä¸ª RocksDB çš„æ‰€æœ‰æ•°æ®ã€‚

æ‰€ä»¥æ¯ä¸€æ¬¡æ‹¿åˆ°æ•°æ®åï¼Œå°±éœ€è¦åˆ¤æ–­ Key æ˜¯å¦åŒ¹é…æˆ‘ä»¬éœ€è¦çš„å‰ç¼€ï¼Œå¦‚æœä¸åŒ¹é…ï¼Œå°±è¯´æ˜å·²ç»è·å–åˆ°åŒä¸€ä¸ªå‰ç¼€çš„æ‰€æœ‰æ•°æ®äº†ï¼Œå°±å¯ä»¥é€€å‡ºå¾ªç¯ã€‚

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å®Œæˆäº† RocksDB åŸºç¡€åº“çš„é›†æˆä½¿ç”¨ã€‚ä»æŸç§æ„ä¹‰ä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬ä¹Ÿå°±å®Œæˆäº†å•æœºå­˜å‚¨å±‚çš„å¼€å‘ã€‚

æ¯”æƒ³è±¡ä¸­ç®€å•éå¸¸å¤šæ˜¯å§ï¼Œ**è¿™å°±æ˜¯ä½¿ç”¨ç°æˆçš„åµŒå…¥å¼é”®å€¼åº“çš„å¥½å¤„**ï¼Œä¹Ÿæ˜¯å¼€æºé¡¹ç›® RocksDBã€LevelDB è®¾è®¡çš„åˆè¡·ï¼Œå¤§å¤§åœ°ç®€åŒ–é«˜æ€§èƒ½é«˜å¯é å•æœºå­˜å‚¨å±‚çš„å¼€å‘ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®Œæˆæˆ‘ä»¬éœ€è¦çš„åŠŸèƒ½ï¼š**KV å‹çš„æ•°æ®å­˜å‚¨**ã€‚

## ä½¿ç”¨ RocksDB å­˜å‚¨ KV æ•°æ®

æˆ‘å…ˆæ¥é—®ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¦å­˜å‚¨ä¸€ä¸ª KV æ•°æ®ï¼Œå³ name= â€œmqâ€ï¼Œæ­¤æ—¶åº•å±‚åº”è¯¥æ€ä¹ˆå­˜å‚¨æ•°æ®å‘¢ï¼Ÿ

ç›´è§‚æ¥è®²ï¼Œä»¥ name ä¸º Keyï¼Œmq ä¸º Value å­˜å‚¨å°±å¯ä»¥äº†ã€‚ä½†æ˜¯æ‰©å±•ä¸€ä¸‹ï¼š**æˆ‘ä»¬æ˜¯ä¸æ˜¯éœ€è¦çŸ¥é“æ•°æ®çš„å†™å…¥æ—¶é—´ã€æ•°æ®æ¥æºï¼ˆå³æ¥æº IPï¼‰ç­‰ç­‰ä¿¡æ¯**ã€‚å› æ­¤æˆ‘ä»¬åœ¨åº•å±‚å­˜å‚¨æ•°æ®æ—¶ï¼Œå°±éœ€è¦å¯¹æ•°æ®è¿›è¡ŒåŒ…è£…ï¼Œå­˜å‚¨ä¸€äº›é€šç”¨çš„æ•°æ®ï¼Œæ¯”å¦‚åˆ›å»ºæ—¶é—´ã€‚

æ‰€ä»¥æˆ‘ä»¬åœ¨åº•å±‚å­˜å‚¨æ•°æ®çš„æ—¶å€™ï¼Œæ˜¯é€šè¿‡æ•°æ®ç»“æ„ StorageDataWrap æ¥åŒ…è£…ä¿å­˜æ•°æ®çš„ã€‚

```plain
#[derive(Serialize, Deserialize, Debug)]
pub struct StorageDataWrap {
    pub data: Vec<u8>,
    pub create_time: u64,
}


impl StorageDataWrap {
    pub fn new(data: Vec<u8>) -> Self {
        return StorageDataWrap {
            data,
            create_time: now_second(),
        };
    }
}
```

æ¥ä¸‹æ¥æˆ‘ä»¬ä»¥ä¿å­˜æ•°æ®ä¸ºä¾‹ï¼Œæ¥çœ‹ä¸€ä¸‹æˆ‘ä»¬æ˜¯å¦‚ä½•å®Œæˆ KV æ¨¡å‹æ•°æ®å­˜å‚¨çš„ã€‚æ¥çœ‹ä¸‹é¢çš„ä»£ç ï¼š

```plain
fn engine_save<T>(
    rocksdb_engine_handler: Arc<RocksDBEngine>,
    rocksdb_cluster: &str,
    key_name: String,
    value: T,
) -> Result<(), RobustMQError>
where
    T: Serialize,
{
    let cf = if rocksdb_cluster.to_string() == DB_COLUMN_FAMILY_CLUSTER.to_string() {
        rocksdb_engine_handler.cf_cluster()
    } else {
        return Err(RobustMQError::ClusterNoAvailableNode);
    };


    let content = match serde_json::to_vec(&value) {
        Ok(data) => data,
        Err(e) => return Err(RobustMQError::CommmonError(e.to_string())),
    };


    let data = StorageDataWrap::new(content);
    match rocksdb_engine_handler.write(cf, &key_name, &data) {
        Ok(_) => {
            return Ok(());
        }
        Err(e) => {
            return Err(RobustMQError::CommmonError(e));
        }
    }
}


```

è¿™é‡Œæœ‰ 4 ä¸ªå…³æ³¨ç‚¹ï¼š

1. RocksDBEngine æ˜¯å°è£…äº† RocksDB è¯»å†™çš„ä¸€ä¸ªStructï¼Œé‡Œé¢å°è£…äº†å¯¹RocksDBçš„æ‰“å¼€ã€è¯»ã€å†™ç­‰æ“ä½œã€‚
2. rocksdb\_engine\_handler: Arcï¼šä½ ä¼šå‘ç°è¿™æ˜¯é€šè¿‡æ™ºèƒ½æŒ‡é’ˆ Arc åœ¨å¤šçº¿ç¨‹ä¹‹é—´å…±äº« RocksDBEngineã€‚åŸå› å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æåˆ°çš„ï¼Œä¸€ä¸ª RocksDB åªèƒ½ç”±ä¸€ä¸ªRocksDBå¯¹è±¡æŒæœ‰ï¼Œæ•…éœ€è¦åœ¨è¿›ç¨‹å¯åŠ¨æ—¶ï¼Œé€šè¿‡RocksDB æä¾›çš„DB::open\_cfæ‰“å¼€ RocksDBï¼Œç„¶åé€šè¿‡æ™ºèƒ½æŒ‡é’ˆ Arc åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«ä½¿ç”¨ RocksDBEngineã€‚
3. ä¸ºäº†åç»­çš„æ‹†åˆ†éš”ç¦»æ–¹ä¾¿ï¼Œæ•°æ®é»˜è®¤æ˜¯å†™å…¥åˆ°åä¸º cluster çš„ ColumnFamilyã€‚
4. æ•°æ®å€¼ Value æ˜¯ä¸€ä¸ªæ³›å‹ï¼Œå®ƒå¯ä»¥æ¥æ”¶ä»»ä½•ç±»å‹çš„æ•°æ®ï¼Œç„¶åæŒä¹…åŒ–å­˜å‚¨ã€‚æ³›å‹ T éœ€è¦é€šè¿‡ Where å…³é”®å­—é™åˆ¶ Value å¿…é¡»å®ç° Serialize Traitã€‚å› ä¸ºåªæœ‰å®ç° Traitï¼Œå®ƒæ‰èƒ½è¿›è¡Œåºåˆ—åŒ–ã€‚

> tipsï¼šåœ¨è¿™éƒ¨åˆ†ï¼Œä½ å°±éœ€è¦å»å¤ä¹ æ³›å‹ã€Arcã€Where çš„è¯­æ³•ï¼Œä»å®é™…ç¼–ç è§’åº¦æ¥çœ‹ï¼Œè¿™ä¸‰ç§è¯­æ³•çš„åº”ç”¨éå¸¸å¹¿æ³›ã€‚

è¿™é‡Œç•™ä¸€ä¸ªæ€è€ƒé¢˜ï¼š **æˆ‘ä»¬åœ¨** **engine\_save** **å’Œ write æ–¹æ³•ä¸­éƒ½æœ‰ä½¿ç”¨** **serde\_json** **æ‰§è¡Œåºåˆ—åŒ–ï¼Œæ˜¯ä¸æ˜¯é‡å¤äº†ï¼Ÿæ˜¯ä¸æ˜¯å¯ä»¥ç®€åŒ–ä»£ç ï¼Ÿ**

æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥å°è£…ä¸€ä¸ª Struct æ¥æ ¹æ® Key ä¿å­˜æ•°æ®ã€‚æ¥çœ‹ä¸‹é¢çš„ä»£ç ï¼š

```plain
pub struct KvStorage {
    rocksdb_engine_handler: Arc<RocksDBEngine>,
}


impl KvStorage {
    pub fn new(rocksdb_engine_handler: Arc<RocksDBEngine>) -> Self {
        KvStorage {
            rocksdb_engine_handler,
        }
    }


    pub fn set(&self, key: String, value: String) -> Result<(), RobustMQError> {
        return engine_save_by_cluster(self.rocksdb_engine_handler.clone(), key, value);
    }
}
```

è¿™æ®µä»£ç æ¯”è¾ƒç®€å•ï¼ŒKey å’Œ Value éƒ½æ˜¯ String ç±»å‹ï¼Œç›´æ¥è°ƒç”¨engine\_save\_by\_clusterä¿å­˜å³å¯ã€‚

åœ¨ä¸šåŠ¡é€»è¾‘ä¸Šï¼Œä¿å­˜æ•°æ®ç›´æ¥ç”¨ KvStorage å³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```plain
pub fn set(&self, value: Vec<u8>) -> Result<(), CommonError> {
    let req: SetRequest = SetRequest::decode(value.as_ref())?;
    let kv_storage = KvStorage::new(rocksdb_engine_handler.clone());
    return kv_storage.set(req.key, req.value);
}
```

å…¶ä»– Getã€Deleteã€Listã€Exists æ–¹æ³•ï¼Œæ€è·¯éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œå°±ä¸å±•å¼€äº†ï¼Œä½ å¯ä»¥æŸ¥çœ‹ Demo ä¸­çš„ä»£ç ï¼Œäº†è§£æ›´å¤šã€‚

## æ€»ç»“

> tipsï¼šæ¯èŠ‚è¯¾çš„ä»£ç éƒ½èƒ½åœ¨é¡¹ç›® [https://github.com/robustmq/robustmq-geek](https://github.com/robustmq/robustmq-geek) ä¸­æ‰¾åˆ°æºç ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ä¸‹è½½æºç æ¥çœ‹ã€‚

è¿™èŠ‚è¯¾æˆ‘ä»¬ä»é€‰å‹è€ƒé‡å¼€å§‹è®²èµ·ï¼Œè®¨è®ºäº†ä¸ºä»€ä¹ˆè¦é€‰æ‹© RocksDBï¼ŒRust RocksDB çš„ä½¿ç”¨ç»†èŠ‚ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ RocksDB æ¥å­˜å‚¨ KV å‹æ•°æ®ï¼Œè¿›è€Œå®ç°äº†å…ƒæ•°æ®å­˜å‚¨æœåŠ¡çš„å•æœºå­˜å‚¨å±‚ã€‚

ä»æŠ€æœ¯ä¸Šæ¥çœ‹ï¼Œæˆ‘ä»¬éœ€è¦å»é‡ç‚¹ç†è§£ä¸ºä»€ä¹ˆè¦ç”¨ RocksDBï¼Œæœ‰æ²¡æœ‰å…¶ä»–çš„é€‰é¡¹ã€‚å› ä¸ºè¿™ä¸ªæ€è·¯æ˜¯é€šç”¨çš„ï¼Œæˆ‘ä»¬å®ç°å…¶ä»–å­˜å‚¨ç³»ç»Ÿçš„æ—¶å€™éƒ½å¯ä»¥å€Ÿé‰´ã€‚

åœ¨ä¸šç•Œï¼Œä½¿ç”¨ RocksDB æ¥å®ç°å•æœºå­˜å‚¨å±‚ï¼Œæ˜¯ä¸€ä¸ªåº”ç”¨éå¸¸å¹¿æ³›çš„æ–¹æ¡ˆï¼Œå¦‚æœä½ æœ‰ç±»ä¼¼çš„éœ€æ±‚ï¼Œå»ºè®®ä¼˜å…ˆè€ƒè™‘ RocksDBã€‚

ä» Rust è¯­æ³•æ–¹é¢ï¼Œæ³›å‹ã€åºåˆ—åŒ–ã€æ™ºèƒ½æŒ‡é’ˆç­‰è¯­æ³•éƒ½ä¼šç”¨åˆ°ï¼Œéœ€è¦ä½ ç»§ç»­åŠ æ·±å¯¹è¿™äº›è¯­æ³•çš„ç†è§£ã€‚

## æ€è€ƒé¢˜

è¿™é‡Œæ˜¯æœ¬èŠ‚è¯¾æ¨èçš„ç›¸å…³ issue çš„ä»»åŠ¡åˆ—è¡¨ï¼Œè¯·ç‚¹å‡»æŸ¥çœ‹[ã€ŠGood First Issueã€‹](http://www.robustmq.com/docs/robustmq-tutorial-cn/%e8%b4%a1%e7%8c%ae%e6%8c%87%e5%8d%97/good-first-issue/)ï¼Œä»»åŠ¡åˆ—è¡¨ä¼šä¸é—´æ–­åœ°æ›´æ–°ã€‚æ¬¢è¿ç»™æˆ‘çš„é¡¹ç›® [https://github.com/robustmq/robustmq](https://github.com/robustmq/robustmq) ç‚¹ä¸ª Star å•Šï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ1ï¼‰</strong></div><ul>
<li><span>Joe Black</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è¯»å†™rocksdbä¸éœ€è¦mutexä¿æŠ¤å—ï¼Ÿåªç”¨äº†Arc</p>2024-10-10</li><br/>
</ul>