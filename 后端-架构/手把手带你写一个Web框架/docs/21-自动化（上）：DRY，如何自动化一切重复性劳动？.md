ä½ å¥½ï¼Œæˆ‘æ˜¯è½©è„‰åˆƒã€‚

ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰å¬è¿‡è¿™ç§è¯´æ³•ï¼Œä¼˜ç§€ç¨‹åºå‘˜åº”è¯¥æœ‰ä¸‰å¤§ç¾å¾·ï¼šæ‡’æƒ°ã€æ€¥èºå’Œå‚²æ…¢ï¼Œè¿™å¥è¯æ˜¯Perlè¯­è¨€çš„å‘æ˜è€…Larry Wallè¯´çš„ã€‚å…¶ä¸­æ‡’æƒ°è¿™ä¸€ç‚¹æŒ‡çš„å°±æ˜¯ï¼Œç¨‹åºå‘˜ä¸ºäº†æ‡’æƒ°ï¼Œä¸é‡å¤åšåŒæ ·çš„äº‹æƒ…ï¼Œä¼šæ€è€ƒæ˜¯å¦èƒ½æŠŠä¸€åˆ‡é‡å¤æ€§çš„åŠ³åŠ¨è‡ªåŠ¨åŒ–ï¼ˆdonâ€™t repeat yourselfï¼‰ã€‚

è€Œæ¡†æ¶å¼€å‘åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦æ€è€ƒï¼Œæœ‰å“ªäº›é‡å¤æ€§åŠ³åŠ¨å¯ä»¥è‡ªåŠ¨åŒ–ä¹ˆï¼Ÿ

ä»ç¬¬åç« åˆ°ç°åœ¨æˆ‘ä»¬ä¸€ç›´åœ¨è¯´ï¼Œæ¡†æ¶æ ¸å¿ƒæ˜¯æœåŠ¡æä¾›è€…ï¼Œåœ¨å¼€å‘å…·ä½“åº”ç”¨æ—¶ï¼Œä¸€å®šä¼šæœ‰å¾ˆå¤šéœ€æ±‚è¦åˆ›å»ºå„ç§å„æ ·çš„æœåŠ¡ï¼Œæ¯•ç«Ÿâ€œä¸€åˆ‡çš†æœåŠ¡â€ï¼›è€Œæ¯æ¬¡åˆ›å»ºæœåŠ¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½éœ€è¦è‡³å°‘ç¼–å†™ä¸‰ä¸ªæ–‡ä»¶ï¼ŒæœåŠ¡æ¥å£ã€æœåŠ¡æä¾›è€…ã€æœåŠ¡å®ä¾‹ã€‚**å¦‚æœèƒ½è‡ªåŠ¨ç”Ÿæˆä¸‰ä¸ªæ–‡ä»¶ï¼Œæä¾›ä¸€ä¸ªâ€œè‡ªåŠ¨åŒ–åˆ›å»ºæœåŠ¡çš„å·¥å…·â€ï¼Œåº”è¯¥èƒ½èŠ‚çœä¸å°‘çš„æ“ä½œ**ã€‚

è¯´åˆ°åˆ›å»ºå·¥å…·ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦ä¸ºäº†ä¸€ä¸ªäº‹æƒ…è€Œåˆ›å»ºä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œè€Œæ¯æ¬¡åˆ›å»ºå‘½ä»¤è¡Œå·¥å…·ï¼Œä¹Ÿéƒ½éœ€è¦åˆ›å»ºå›ºå®šçš„Command.goæ–‡ä»¶ï¼Œå…¶ä¸­æœ‰å›ºå®šçš„Commandç»“æ„ï¼Œè¿™äº›ä»£ç æˆ‘ä»¬èƒ½ä¸èƒ½å·ä¸ªæ‡’ï¼Œâ€œ**è‡ªåŠ¨åŒ–åˆ›å»ºå‘½ä»¤è¡Œå·¥å…·**â€å‘¢ï¼Ÿ

å¦å¤–ä¹‹å‰æˆ‘ä»¬åšè¿‡å‡ æ¬¡ä¸­é—´ä»¶çš„è¿ç§»ï¼Œå…ˆå°†æºç æ‹·è´å¤åˆ¶ï¼Œå†ä¿®æ”¹å¯¹åº”çš„Ginè·¯å¾„ï¼Œè¿™ä¸ªæ“ä½œä¹Ÿæ˜¯é¢‡ä¸ºç¹ççš„ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥å†™ä¸€ä¸ªâ€œ**è‡ªåŠ¨åŒ–ä¸­é—´ä»¶è¿ç§»å·¥å…·**â€ï¼Œä¸€ä¸ªå‘½ä»¤è‡ªåŠ¨å¤åˆ¶å’Œæ›¿æ¢å‘¢ï¼Ÿ

è¿™äº›å‘½ä»¤éƒ½æ˜¯å¯ä»¥å®ç°çš„ï¼Œè¿™èŠ‚è¯¾æˆ‘ä»¬å°±æ¥å°è¯•å®Œæˆè¿™ä¸‰é¡¹è‡ªåŠ¨åŒ–ï¼Œâ€œè‡ªåŠ¨åŒ–åˆ›å»ºæœåŠ¡å·¥å…·â€ï¼Œ â€œè‡ªåŠ¨åŒ–åˆ›å»ºå‘½ä»¤è¡Œå·¥å…·â€ï¼Œä»¥åŠâ€œè‡ªåŠ¨åŒ–ä¸­é—´ä»¶è¿ç§»å·¥å…·â€ã€‚

## è‡ªåŠ¨åŒ–åˆ›å»ºæœåŠ¡å·¥å…·

åœ¨åˆ›å»ºå„ç§å„æ ·çš„æœåŠ¡æ—¶ï¼Œâ€œè‡ªåŠ¨åŒ–åˆ›å»ºæœåŠ¡å·¥å…·â€èƒ½å¸®æˆ‘ä»¬èŠ‚çœä¸å°‘å¼€å‘æ—¶é—´ã€‚æˆ‘ä»¬å…ˆæ€è€ƒä¸‹è¿™ä¸ªå·¥å…·åº”è¯¥å¦‚ä½•å®ç°ã€‚

æ—¢ç„¶ä¹‹å‰å·²ç»å¼•å…¥cobraï¼Œå°†æ¡†æ¶ä¿®æ”¹ä¸ºå¯ä»¥æ”¯æŒå‘½ä»¤è¡Œå·¥å…·ï¼Œåˆ›å»ºå‘½ä»¤å¹¶ä¸æ˜¯ä¸€ä¸ªéš¾äº‹ï¼Œæˆ‘ä»¬æ¥å®šä¹‰ä¸€å¥—åˆ›å»ºæœåŠ¡çš„provider å‘½ä»¤å³å¯ã€‚ç…§æ—§å…ˆè®¾è®¡å¥½è¦åˆ›å»ºçš„å‘½ä»¤ï¼Œå†ä¸€ä¸€å®ç°ã€‚

### å‘½ä»¤åˆ›å»º

â€œè‡ªåŠ¨åŒ–åˆ›å»ºæœåŠ¡å·¥å…·â€å¦‚ä½•è®¾è®¡å‘½ä»¤å±‚çº§å‘¢ï¼Ÿæˆ‘ä»¬è®¾è®¡ä¸€ä¸ªä¸€çº§å‘½ä»¤å’Œä¸¤ä¸ªäºŒçº§å‘½ä»¤ï¼š

- `./hade provider` ä¸€çº§å‘½ä»¤ï¼Œproviderï¼Œæ‰“å°å¸®åŠ©ä¿¡æ¯ï¼›
- `./hade provider new` äºŒçº§å‘½ä»¤ï¼Œåˆ›å»ºä¸€ä¸ªæœåŠ¡ï¼›
- `./hade provider list` äºŒçº§å‘½ä»¤ï¼Œåˆ—å‡ºå®¹å™¨å†…çš„æ‰€æœ‰æœåŠ¡ï¼Œåˆ—å‡ºå®ƒä»¬çš„å­—ç¬¦ä¸²å‡­è¯ã€‚

é¦–å…ˆå°†providerçš„è¿™ä¸¤ä¸ªäºŒçº§å‘½ä»¤ï¼Œéƒ½å­˜æ”¾åœ¨command/provider.goä¸­ã€‚è€Œå¯¹åº”çš„ä¸€çº§å‘½ä»¤ providerCommand æ˜¯ä¸€ä¸ªæ‰“å°å¸®åŠ©ä¿¡æ¯çš„ç©ºå®ç°ã€‚

```go
// providerCommand ä¸€çº§å‘½ä»¤
var providerCommand = &cobra.Command{
   Use:   "provider",
   Short: "æœåŠ¡æä¾›ç›¸å…³å‘½ä»¤",
   RunE: func(c *cobra.Command, args []string) error {
      if len(args) == 0 {
         c.Help()
      }
      return nil
   },
}
```

é¢„å…ˆå°†ä¸¤ä¸ªäºŒçº§å‘½ä»¤æŒ‚è½½åˆ°è¿™ä¸ªä¸€çº§å‘½ä»¤ä¸­ï¼Œåœ¨ framework/command/provider.goï¼š

```go
// åˆå§‹åŒ–providerç›¸å…³æœåŠ¡
func initProviderCommand() *cobra.Command {
   providerCommand.AddCommand(providerCreateCommand)
   providerCommand.AddCommand(providerListCommand)
   return providerCommand
}
```

å¹¶ä¸”åœ¨ framework/command/kernel.goï¼Œå°†è¿™ä¸ªä¸€çº§å‘½ä»¤æŒ‚è½½åˆ°ä¸€çº§å‘½ä»¤rootCommandä¸­ï¼š

```go
func AddKernelCommands(root *cobra.Command) {
   // providerä¸€çº§å‘½ä»¤
   root.AddCommand(initProviderCommand()
}
```

ä¸‹é¢æ¥å®ç°è¿™ä¸¤ä¸ªäºŒçº§å‘½ä»¤newå’Œlistã€‚

### Listå‘½ä»¤çš„å®ç°

å…ˆè¯´ `./hade provider list` è¿™ä¸ªå‘½ä»¤ï¼Œå› ä¸ºåˆ—å‡ºå®¹å™¨å†…çš„æ‰€æœ‰æœåŠ¡æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚è¿˜è®°å¾—å—ï¼Œåœ¨åä¸€ç« å®ç°æœåŠ¡å®¹å™¨çš„æ—¶å€™ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªprovidersï¼Œå®ƒå­˜å‚¨æ‰€æœ‰çš„æœåŠ¡å®¹å™¨æä¾›è€…ï¼Œæ”¾åœ¨æ–‡ä»¶ framework/container.go ä¸­ï¼š

```go
// HadeContainer æ˜¯æœåŠ¡å®¹å™¨çš„å…·ä½“å®ç°
type HadeContainer struct {
	...
	// providers å­˜å‚¨æ³¨å†Œçš„æœåŠ¡æä¾›è€…ï¼Œkey ä¸ºå­—ç¬¦ä¸²å‡­è¯
	providers map[string]ServiceProvider
    ...
}
```

æˆ‘ä»¬åªéœ€è¦å°†è¿™ä¸ªprovidersè¿›è¡Œéå†ï¼Œæ ¹æ®å…¶ä¸­æ¯ä¸ªServiceProviderçš„Name() æ–¹æ³•ï¼Œè·å–å­—ç¬¦ä¸²å‡­è¯åˆ—è¡¨å³å¯ã€‚

æ‰€ä»¥ï¼Œåœ¨framework/container.go çš„HadeContainerä¸­ï¼Œå¢åŠ ä¸€ä¸ªNameListæ–¹æ³•ï¼Œè¿”å›æ‰€æœ‰æä¾›æœåŠ¡è€…çš„å­—ç¬¦ä¸²å‡­è¯ï¼Œæ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥éå†è¿™ä¸ªproviders å­—æ®µã€‚

```go
// NameList åˆ—å‡ºå®¹å™¨ä¸­æ‰€æœ‰æœåŠ¡æä¾›è€…çš„å­—ç¬¦ä¸²å‡­è¯
func (hade *HadeContainer) NameList() []string {
   ret := []string{}
   for _, provider := range hade.providers {
      name := provider.Name()
      ret = append(ret, name)
   }
   return ret
}
```

è€Œåœ¨ framework/command/provider.go ä¸­çš„providerListCommand å‘½ä»¤ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨è¿™ä¸ªå‘½ä»¤å¹¶ä¸”æ‰“å°å‡ºæ¥ã€‚

```go
// providerListCommand åˆ—å‡ºå®¹å™¨å†…çš„æ‰€æœ‰æœåŠ¡
var providerListCommand = &cobra.Command{
   Use:   "list",
   Short: "åˆ—å‡ºå®¹å™¨å†…çš„æ‰€æœ‰æœåŠ¡",
   RunE: func(c *cobra.Command, args []string) error {
      container := c.GetContainer()
      hadeContainer := container.(*framework.HadeContainer)
      // è·å–å­—ç¬¦ä¸²å‡­è¯
      list := hadeContainer.NameList()
      // æ‰“å°
      for _, line := range list {
         println(line)
      }
      return nil
   },
}
```

å¯ä»¥éªŒè¯ä¸€ä¸‹ã€‚ç¼–è¯‘ `./hade build self` å¹¶ä¸”æ‰§è¡Œ `./hade provider list` ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š  
![](https://static001.geekbang.org/resource/image/0c/35/0c4d1fb73cd17aabc02fe7c3b5f2f335.png?wh=481x215)

ä½ å¯ä»¥å¾ˆæ¸…æ™°çœ‹åˆ°å®¹å™¨ä¸­ç»‘å®šäº†å“ªäº›æœåŠ¡æä¾›è€…ï¼Œå®ƒä»¬çš„å­—ç¬¦ä¸²å‡­è¯æ˜¯ä»€ä¹ˆã€‚è¿™æ ·æˆ‘ä»¬åœ¨å®šä¹‰ä¸€ä¸ªæ–°çš„æœåŠ¡çš„æ—¶å€™ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çœ‹åˆ°å“ªäº›æœåŠ¡æä¾›è€…çš„å…³é”®å­—å·²ç»è¢«ä½¿ç”¨äº†ï¼Œé¿å…ä½¿ç”¨å·²æœ‰çš„æœåŠ¡å…³é”®å­—ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥è¯´ç¨å¾®å¤æ‚ä¸€ç‚¹çš„åˆ›å»ºæœåŠ¡çš„å‘½ä»¤ `./hade provider new` ã€‚

### newå‘½ä»¤çš„å®ç°

åœ¨å®é™…ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€æƒ³åˆ°ä¸€ä¸ªæœåŠ¡ï¼Œæ¯”å¦‚å»æŸä¸ªç”¨æˆ·ç³»ç»Ÿè·å–ä¿¡æ¯ï¼Œä¸€å®šä¼šæƒ³åˆ°åˆ›å»ºæœåŠ¡çš„ä¸‰æ­¥éª¤ï¼šåˆ›å»ºä¸€ä¸ªç”¨æˆ·ç³»ç»Ÿçš„äº¤äº’åè®®contract.goã€å†åˆ›å»ºä¸€ä¸ªæä¾›åè®®çš„ç”¨æˆ·æœåŠ¡æä¾›è€… provider.goã€æœ€åæ‰å®ç°å…·ä½“çš„ç”¨æˆ·æœåŠ¡å®ä¾‹ service.goã€‚

æ¯æ¬¡éƒ½éœ€è¦åˆ›å»ºè¿™ä¸‰ä¸ªæ–‡ä»¶ï¼Œä¸”è¿™ä¸‰ä¸ªæ–‡ä»¶çš„æ–‡ä»¶å¤§æ¡†æ¶éƒ½æœ‰å¥—è·¯å¯è¨€ã€‚é‚£æˆ‘ä»¬å¦‚ä½•å°†è¿™äº›é‡å¤çš„å¥—è·¯æ€§çš„ä»£ç è‡ªåŠ¨åŒ–ç”Ÿæˆå‘¢ï¼Ÿ

é¦–å…ˆè¿™é‡Œæœ‰ä¸€ä¸ªå¢åŠ å‚æ•°çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“è¦åˆ›å»ºæœåŠ¡çš„æœåŠ¡åæ˜¯ä»€ä¹ˆï¼Ÿåˆ›å»ºè¿™ä¸ªæœåŠ¡çš„æ–‡ä»¶å¤¹åå­—æ˜¯ä»€ä¹ˆï¼Ÿå½“ç„¶äº†ï¼Œè¿™äº›å‚æ•°ä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨å‘½ä»¤åé¢å¢åŠ flagå‚æ•°çš„æ–¹å¼æ¥è¡¨ç¤ºã€‚ä½†æ˜¯å…¶å®è¿˜æœ‰ä¸€ç§æ›´ä¾¿æ·çš„æ–¹å¼ï¼šäº¤äº’ã€‚

äº¤äº’çš„è¡¨ç°å½¢å¼å¦‚ï¼š

```go
è¾“å…¥ï¼š./hade provider new (æˆ‘æƒ³åˆ›å»ºä¸€ä¸ªæœåŠ¡)
è¾“å‡ºï¼šè¯·è¾“å…¥æœåŠ¡åç§°(æœåŠ¡å‡­è¯):
è¾“å…¥ï¼šdemo
è¾“å‡ºï¼šè¯·æ±‚è¾“å…¥æœåŠ¡ç›®å½•åç§°(é»˜è®¤å’ŒæœåŠ¡åç§°ç›¸åŒ)ï¼š
è¾“å…¥ï¼šdemo
è¾“å‡ºï¼šåˆ›å»ºæœåŠ¡æˆåŠŸ, æ–‡ä»¶å¤¹åœ°å€ï¼šxxxxx
è¾“å‡ºï¼šè¯·ä¸è¦å¿˜è®°æŒ‚è½½æ–°åˆ›å»ºçš„æœåŠ¡
```

è¿™ç§å‘½ä»¤è¡Œäº¤äº’çš„æ–¹å¼æ˜¯ä¸æ˜¯æ›´æ™ºèƒ½åŒ–ï¼Ÿä½†æ˜¯å¦‚ä½•å®ç°å‘¢ï¼Ÿ

è¿™é‡Œæˆ‘ä»¬å€ŸåŠ©ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ [survey](https://github.com/AlecAivazis/survey)ã€‚è¿™ä¸ªåº“ç›®å‰åœ¨GitHubä¸Šå·²ç»æœ‰2.7kä¸ªstarï¼Œæœ€æ–°ç‰ˆæœ¬æ˜¯v2ç‰ˆæœ¬ï¼Œä½¿ç”¨çš„æ˜¯MIT Licenseåè®®ï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨ã€‚è¿™ä¸ªsurveyåº“æ”¯æŒå¤šç§äº¤äº’æ¨¡å¼ï¼šå•è¡Œè¾“å…¥ã€å¤šè¡Œè¾“å…¥ã€å•é€‰ã€å¤šé€‰ã€y/n ç¡®è®¤é€‰æ‹©ï¼Œåœ¨[é¡¹ç›®GitHubé¦–é¡µ](https://github.com/AlecAivazis/survey)ä¸Šå°±èƒ½å¾ˆæ¸…æ™°çœ‹åˆ°è¿™ä¸ªåº“çš„ä½¿ç”¨æ–¹å¼ã€‚

```go
name := false
// ä½¿ç”¨survey.XXX çš„æ–¹å¼æ¥é€‰æ‹©äº¤äº’å½¢å¼
prompt := &survey.Confirm{
    Message: "Do you like pie?",
}
// ä½¿ç”¨&å°†æœ€ç»ˆçš„é€‰æ‹©å­˜å‚¨è¿›å…¥å˜é‡
survey.AskOne(prompt, &name)
```

åœ¨provider newå‘½ä»¤ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨survey æ¥å¢åŠ äº¤äº’æ€§ã€‚é€šè¿‡äº¤äº’ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®è®¤ç”¨æˆ·æƒ³åˆ›å»ºçš„æœåŠ¡å‡­è¯ï¼Œä»¥åŠæƒ³æŠŠè¿™ä¸ªæœåŠ¡åˆ›å»ºåœ¨ app/provider/ ä¸‹çš„å“ªä¸ªç›®å½•ä¸­ã€‚

å½“ç„¶ï¼Œ**åœ¨ç”¨æˆ·é€šè¿‡äº¤äº’è¾“å…¥äº†æœåŠ¡å‡­è¯å’ŒæœåŠ¡ç›®å½•ä¹‹åï¼Œæ˜¯éœ€è¦è¿›è¡Œå‚æ•°åˆ¤æ–­çš„**ã€‚æœåŠ¡å‡­è¯éœ€è¦å’Œå®¹å™¨ä¸­å·²æ³¨å†ŒæœåŠ¡çš„å­—ç¬¦ä¸²å‡­è¯è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå·²ç»å­˜åœ¨äº†ï¼Œåº”è¯¥æŠ¥é”™ï¼›è€ŒæœåŠ¡ç›®å½•å¦‚æœå·²ç»å­˜åœ¨ï¼Œä¹Ÿåº”è¯¥ç›´æ¥æŠ¥é”™ã€‚

å¦‚æœéƒ½éªŒè¯okäº†ï¼Œæœ€åä¸€æ­¥å°±æ˜¯åœ¨ app/provider/ ä¸‹åˆ›å»ºå¯¹åº”çš„æœåŠ¡ç›®å½•ï¼Œåœ¨ç›®å½•ä¸‹åˆ›å»ºcontract.goã€provider.goã€service.go ä¸‰ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨ä¸‰ä¸ªæ–‡ä»¶ä¸­æ ¹æ®é¢„å…ˆå®šä¹‰å¥½çš„æ¨¡ç‰ˆå¡«å……å†…å®¹ã€‚è¿™é‡Œæˆ‘ä»¬å¦‚ä½•å®ç°å‘¢ï¼Ÿä½¿ç”¨æ¨¡ç‰ˆã€å˜æ›´æ¨¡ç‰ˆä¸­çš„æŸäº›å­—æ®µã€å½¢æˆæ–°çš„æ–‡æœ¬ï¼Œè¿™ä¸ªä½ åº”è¯¥èƒ½è”æƒ³åˆ° Golang æ ‡å‡†åº“ä¸­çš„ [text/template](https://pkg.go.dev/text/template) åº“ã€‚

è¿™ä¸ªåº“çš„ä½¿ç”¨æ–¹æ³•æ¯”è¾ƒå¤šï¼Œæˆ‘è¿™é‡ŒæŠŠæˆ‘ä»¬ç”¨å¾—åˆ°çš„æ–¹æ³•è§£è¯´ä¸€ä¸‹ï¼Œè§£æcontract.goæ–‡ä»¶çš„ç”Ÿæˆè¿‡ç¨‹ï¼Œå°±å¯ä»¥äº†è§£å…¶ä½¿ç”¨æ–¹æ³•äº†ã€‚

```go
// åˆ›å»ºtitleè¿™ä¸ªæ¨¡ç‰ˆæ–¹æ³•
funcs := template.FuncMap{"title": strings.Title}
{
   //  åˆ›å»ºcontract.go
   file := filepath.Join(pFolder, folder, "contract.go")
   f, err := os.Create(file)
   if err != nil {
      return errors.Cause(err)
   }
   // ä½¿ç”¨contractTmpæ¨¡ç‰ˆæ¥åˆå§‹åŒ–templateï¼Œå¹¶ä¸”è®©è¿™ä¸ªæ¨¡ç‰ˆæ”¯æŒtitleæ–¹æ³•ï¼Œå³æ”¯æŒ{{.|title}}
   t := template.Must(template.New("contract").Funcs(funcs).Parse(contractTmp))
   // å°†nameä¼ é€’è¿›å…¥åˆ°templateä¸­æ¸²æŸ“ï¼Œå¹¶ä¸”è¾“å‡ºåˆ°contract.go ä¸­
   if err := t.Execute(f, name); err != nil {
      return errors.Cause(err)
   }
}
```

ä¸Šé¢ä»£ç çš„é€»è¾‘æœ€æ ¸å¿ƒçš„å°±æ˜¯åˆ›å»ºæ¨¡ç‰ˆçš„template.Must å’Œæ¸²æŸ“æ¨¡ç‰ˆçš„t.Executeæ–¹æ³•ã€‚

ä½†æ˜¯åœ¨åˆ›å»ºæ¨¡ç‰ˆä¹‹å‰ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª**template.FuncMapæ–¹æ³•ï¼Œå®ƒæ¯”è¾ƒä¸å¥½ç†è§£ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯åœ¨æ¨¡ç‰ˆä¸­ï¼Œè®©æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®šä¹‰çš„æ¨¡ç‰ˆæ–¹æ³•æ¥æ§åˆ¶æ¸²æŸ“æ•ˆæœ**ã€‚è¿™ä¸ªFuncMapç»“æ„å®šä¹‰äº†æ¨¡ç‰ˆä¸­æ”¯æŒçš„æ¨¡ç‰ˆæ–¹æ³•ï¼Œæ¯”å¦‚æˆ‘æ”¯æŒtitleè¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å®é™…è°ƒç”¨çš„æ˜¯string.Title å‡½æ•°ï¼ŒæŠŠå­—ç¬¦ä¸²é¦–å­—æ¯å¤§å†™ã€‚

åœ¨åˆšæ‰çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨contractTmpæ¥åˆ›å»ºæ¨¡ç‰ˆï¼Œåœ¨æ¸²æŸ“contractTmpçš„æ—¶å€™ï¼Œä¼ é€’äº†ä¸€ä¸ªnameå˜é‡ã€‚å‡è®¾è¿™ä¸ªnameå˜é‡ä»£è¡¨çš„æ˜¯å­—ç¬¦ä¸²userï¼Œè€Œæˆ‘å¸Œæœ›åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²â€œNameKeyâ€çš„å˜é‡ï¼Œå¯ä»¥è¿™ä¹ˆå®šä¹‰contractTmpï¼š

```go
var contractTmp string = `package {{.}}

const {{.|title}}Key = "{{.}}"

type Service interface {
   // è¯·åœ¨è¿™é‡Œå®šä¹‰ä½ çš„æ–¹æ³•
    Foo() string
}
`
```

æ³¨æ„åˆ°äº†ä¹ˆï¼Œå…¶ä¸­çš„{{.|title}} å®é™…ä¸Šæ˜¯ç›¸å½“äºè°ƒç”¨äº†strings.Title(name) çš„æ–¹æ³•å¡«å……ï¼Œèƒ½å°†å­—ç¬¦ä¸²nameæ›¿æ¢ä¸ºå­—ç¬¦ä¸²Nameã€‚

è€Œå®šä¹‰å¥½äº†FuncMapä¹‹åï¼Œæˆ‘ä»¬éšåä½¿ç”¨äº†os.Createåˆ›å»ºcontract.goæ–‡ä»¶ï¼Œç„¶ååˆå§‹åŒ–templateï¼š

```plain
t := template.Must(template.New("contract").Funcs(funcs).Parse(contractTmp))
```

è¿™è¡Œä»£ç çš„å‡ ä¸ªå‡½æ•°æˆ‘ä»¬æ¥çœ‹çœ‹ã€‚

**template.Must è¡¨ç¤ºåé¢çš„templateåˆ›å»ºå¿…é¡»æˆåŠŸï¼Œå¦åˆ™ä¼španic**ã€‚è¿™ç§Mustçš„æ–¹æ³•æ¥ç®€åŒ–ä»£ç çš„errorå¤„ç†é€»è¾‘ï¼Œåœ¨æ ‡å‡†åº“ä¸­ç»å¸¸ä½¿ç”¨ã€‚æˆ‘ä»¬çš„hadeæ¡†æ¶çš„MustMakeä¹Ÿæ˜¯åŒæ ·çš„åŸç†ã€‚

template.New() æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ªtext/template çš„ Templateç»“æ„ï¼Œå…¶ä¸­çš„å‚æ•°contractå­—ç¬¦ä¸²æ˜¯ä¸ºè¿™ä¸ªTemplateç»“æ„å‘½åçš„ï¼Œåé¢çš„Funcs() æ–¹æ³•æ˜¯å°†ç­¾åå®šä¹‰çš„æ¨¡ç‰ˆå‡½æ•°æ³¨å†Œåˆ°è¿™ä¸ªTemplateç»“æ„ä¸­ï¼Œæœ€åçš„Parse()æ˜¯ä½¿ç”¨è¿™ä¸ªTemplateç»“æ„è§£æå…·ä½“çš„æ¨¡ç‰ˆæ–‡æœ¬ã€‚

å®šä¹‰å¥½äº†æ¨¡ç‰ˆtä¹‹åï¼Œä½¿ç”¨ä»£ç ï¼š

```go
t.Execute(f, name)
```

æ¥å°†å˜é‡name æ³¨å†Œè¿›å…¥æ¨¡ç‰ˆtï¼Œå¹¶ä¸”è¾“å‡ºåˆ°fã€‚è¿™é‡Œçš„fï¼Œæ˜¯æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„contract.goæ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯ä½¿ç”¨å˜é‡nameè§£ææ¨¡ç‰ˆtï¼Œè¾“å‡ºåˆ°contract.goæ–‡ä»¶ä¸­ã€‚

è¿™é‡Œçš„å˜é‡å¯ä»¥æ˜¯ä¸€ä¸ªstructç»“æ„ï¼Œä¹Ÿå¯ä»¥æ˜¯åŸºç¡€å˜é‡ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œå®šä¹‰çš„å­—ç¬¦ä¸²ã€‚åœ¨æ¨¡ç‰ˆä¸­{{.}} å°±ä»£è¡¨è¿™ä¸ªç»“æ„ã€‚æ‰€ä»¥å†å›é¡¾å‰é¢å®šä¹‰çš„contractTmpæ¨¡ç‰ˆï¼Œä½ ä¼šçœ‹å‡ºå…¶ä¸­å˜é‡nameä¸ºå­—ç¬¦ä¸²userçš„æ—¶å€™ï¼Œæœ€ç»ˆçš„æ˜¾ç¤ºæ˜¯ä»€ä¹ˆå—ï¼Ÿ

å¥½ï¼Œåˆ›å»ºæœåŠ¡å‘½ä»¤çš„æ‰€æœ‰æ€è·¯æˆ‘ä»¬å°±æ¢³ç†æ¸…æ¥šäº†ï¼Œæœ€åä¹Ÿè´´å‡ºå®Œæ•´çš„ä»£ç ä¾›ä½ å‚è€ƒï¼Œå…³é”®æ­¥éª¤éƒ½åœ¨æ³¨é‡Šä¸­è¯¦ç»†è¯´æ˜äº†ï¼Œå®ç°å¹¶ä¸éš¾ï¼š

```go
// providerCreateCommand åˆ›å»ºä¸€ä¸ªæ–°çš„æœåŠ¡ï¼ŒåŒ…æ‹¬æœåŠ¡æä¾›è€…ï¼ŒæœåŠ¡æ¥å£åè®®ï¼ŒæœåŠ¡å®ä¾‹
var providerCreateCommand = &cobra.Command{
   Use:     "new",
   Aliases: []string{"create", "init"},
   Short:   "åˆ›å»ºä¸€ä¸ªæœåŠ¡",
   RunE: func(c *cobra.Command, args []string) error {
      container := c.GetContainer()
      fmt.Println("åˆ›å»ºä¸€ä¸ªæœåŠ¡")
      var name string
      var folder string
      {
         prompt := &survey.Input{
            Message: "è¯·è¾“å…¥æœåŠ¡åç§°(æœåŠ¡å‡­è¯)ï¼š",
         }
         err := survey.AskOne(prompt, &name)
         if err != nil {
            return err
         }
      }
      {
         prompt := &survey.Input{
            Message: "è¯·è¾“å…¥æœåŠ¡æ‰€åœ¨ç›®å½•åç§°(é»˜è®¤: åŒæœåŠ¡åç§°):",
         }
         err := survey.AskOne(prompt, &folder)
         if err != nil {
            return err
         }
      }
      // æ£€æŸ¥æœåŠ¡æ˜¯å¦å­˜åœ¨
      providers := container.(*framework.HadeContainer).NameList()
      providerColl := collection.NewStrCollection(providers)
      if providerColl.Contains(name) {
         fmt.Println("æœåŠ¡åç§°å·²ç»å­˜åœ¨")
         return nil
      }
      if folder == "" {
         folder = name
      }
      app := container.MustMake(contract.AppKey).(contract.App)
      pFolder := app.ProviderFolder()
      subFolders, err := util.SubDir(pFolder)
      if err != nil {
         return err
      }
      subColl := collection.NewStrCollection(subFolders)
      if subColl.Contains(folder) {
         fmt.Println("ç›®å½•åç§°å·²ç»å­˜åœ¨")
         return nil
      }
      // å¼€å§‹åˆ›å»ºæ–‡ä»¶
      if err := os.Mkdir(filepath.Join(pFolder, folder), 0700); err != nil {
         return err
      }
      // åˆ›å»ºtitleè¿™ä¸ªæ¨¡ç‰ˆæ–¹æ³•
      funcs := template.FuncMap{"title": strings.Title}
      {
         //  åˆ›å»ºcontract.go
         file := filepath.Join(pFolder, folder, "contract.go")
         f, err := os.Create(file)
         if err != nil {
            return errors.Cause(err)
         }
         // ä½¿ç”¨contractTmpæ¨¡ç‰ˆæ¥åˆå§‹åŒ–templateï¼Œå¹¶ä¸”è®©è¿™ä¸ªæ¨¡ç‰ˆæ”¯æŒtitleæ–¹æ³•ï¼Œå³æ”¯æŒ{{.|title}}
         t := template.Must(template.New("contract").Funcs(funcs).Parse(contractTmp))
         // å°†nameä¼ é€’è¿›å…¥åˆ°templateä¸­æ¸²æŸ“ï¼Œå¹¶ä¸”è¾“å‡ºåˆ°contract.go ä¸­
         if err := t.Execute(f, name); err != nil {
            return errors.Cause(err)
         }
      }
      {
         // åˆ›å»ºprovider.go
         file := filepath.Join(pFolder, folder, "provider.go")
         f, err := os.Create(file)
         if err != nil {
            return err
         }
         t := template.Must(template.New("provider").Funcs(funcs).Parse(providerTmp))
         if err := t.Execute(f, name); err != nil {
            return err
         }
      }
      {
         //  åˆ›å»ºservice.go
         file := filepath.Join(pFolder, folder, "service.go")
         f, err := os.Create(file)
         if err != nil {
            return err
         }
         t := template.Must(template.New("service").Funcs(funcs).Parse(serviceTmp))
         if err := t.Execute(f, name); err != nil {
            return err
         }
      }
      fmt.Println("åˆ›å»ºæœåŠ¡æˆåŠŸ, æ–‡ä»¶å¤¹åœ°å€:", filepath.Join(pFolder, folder))
      fmt.Println("è¯·ä¸è¦å¿˜è®°æŒ‚è½½æ–°åˆ›å»ºçš„æœåŠ¡")
      return nil
   },
}
var contractTmp string = `package {{.}}
const {{.|title}}Key = "{{.}}"
type Service interface {
   // è¯·åœ¨è¿™é‡Œå®šä¹‰ä½ çš„æ–¹æ³•
    Foo() string
}
`
var providerTmp string = `package {{.}}
import (
   "github.com/gohade/hade/framework"
)
type {{.|title}}Provider struct {
   framework.ServiceProvider
   c framework.Container
}
func (sp *{{.|title}}Provider) Name() string {
   return {{.|title}}Key
}
func (sp *{{.|title}}Provider) Register(c framework.Container) framework.NewInstance {
   return New{{.|title}}Service
}
func (sp *{{.|title}}Provider) IsDefer() bool {
   return false
}
func (sp *{{.|title}}Provider) Params(c framework.Container) []interface{} {
   return []interface{}{c}
}
func (sp *{{.|title}}Provider) Boot(c framework.Container) error {
   return nil
}
`
var serviceTmp string = `package {{.}}
import "github.com/gohade/hade/framework"
type {{.|title}}Service struct {
   container framework.Container
}
func New{{.|title}}Service(params ...interface{}) (interface{}, error) {
   container := params[0].(framework.Container)
   return &{{.|title}}Service{container: container}, nil
}
func (s *{{.|title}}Service) Foo() string {
    return ""
}
`

```

æœ€åæˆ‘ä»¬éªŒè¯ä¸€ä¸‹è¿™ä¸ªåˆ›å»ºæœåŠ¡å‘½ä»¤ã€‚åŒæ ·ç¼–è¯‘./hade å‘½ä»¤ä¹‹åï¼Œæ‰§è¡Œ `./hade provider new` , å®šä¹‰æœåŠ¡å‡­è¯ä¸ºuserï¼Œç›®å½•åç§°åŒæ ·ä¸ºuserã€‚  
![](https://static001.geekbang.org/resource/image/b7/3c/b7ae3ba7edee1ce7a216e891d1b8e23c.png?wh=620x193)

èƒ½çœ‹åˆ° app/provider/ ç›®å½•ä¸‹åˆ›å»ºäº†useræ–‡ä»¶å¤¹ï¼Œå…¶ä¸­æœ‰contract.goã€provider.goã€service.goä¸‰ä¸ªæ–‡ä»¶ï¼š  
![](https://static001.geekbang.org/resource/image/46/e6/46900bb2ea53135b890763687f4cc0e6.png?wh=376x276)

å…¶ä¸­æ¯ä¸ªæ–‡ä»¶çš„å®šä¹‰éƒ½å®Œæ•´ï¼Œä¸”å¯ä»¥ç›´æ¥å†æ¬¡ç¼–è¯‘é€šè¿‡ï¼ŒéªŒè¯å®Œæˆï¼

## è‡ªåŠ¨åŒ–åˆ›å»ºå‘½ä»¤è¡Œå·¥å…·

åˆ°è¿™é‡Œæˆ‘ä»¬å°±å®Œæˆäº†åˆ›å»ºæœåŠ¡å·¥å…·çš„è‡ªåŠ¨åŒ–ã€‚å¼€å¤´æåˆ°å…·ä½“è¿è¥ä¸€ä¸ªåº”ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿä¼šç»å¸¸éœ€è¦åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„å‘½ä»¤è¡Œã€‚æ¯”å¦‚è¿è¥ä¸€ä¸ªç½‘ç«™ï¼Œå¯èƒ½ä¼šåˆ›å»ºä¸€ä¸ªå‘½ä»¤æ¥ç»Ÿè®¡ç½‘ç«™æ³¨å†Œäººæ•°ï¼Œä¹Ÿå¯èƒ½è¦åˆ›å»ºä¸€ä¸ªå‘½ä»¤æ¥å®šæœŸæ£€æŸ¥æ˜¯å¦æœ‰è¿ç¦çš„æ–‡ç« éœ€è¦å°ç¦ç­‰ã€‚æ‰€ä»¥è‡ªåŠ¨åˆ›å»ºå‘½ä»¤è¡Œå·¥å…·åœ¨å®é™…å·¥ä½œä¸­æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚

åŒæœåŠ¡å‘½ä»¤ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥æœ‰ä¸€å¥—åˆ›å»ºå‘½ä»¤è¡Œå·¥å…·çš„å‘½ä»¤ã€‚

- `./hade command` ä¸€çº§å‘½ä»¤ï¼Œæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
- `./hade command list` äºŒçº§å‘½ä»¤ï¼Œåˆ—å‡ºæ‰€æœ‰æ§åˆ¶å°å‘½ä»¤
- `./hade command new` äºŒçº§å‘½ä»¤ï¼Œåˆ›å»ºä¸€ä¸ªæ§åˆ¶å°å‘½ä»¤

commandç›¸å…³çš„å‘½ä»¤å’Œproviderçš„å‘½ä»¤çš„å®ç°åŸºæœ¬æ˜¯ä¸€è‡´çš„ã€‚è¿™é‡Œæˆ‘ä»¬ç®€è¦è§£è¯´ä¸‹é‡ç‚¹ï¼Œå…·ä½“å¯¹åº”çš„ä»£ç è¯¦æƒ…å¯ä»¥å‚è€ƒGitHubä¸Šçš„[framework/command/cmd.go](https://github.com/gohade/coredemo/blob/geekbang/21/framework/command/cmd.go) æ–‡ä»¶ã€‚

ä¸€çº§å‘½ä»¤./hade command æˆ‘ä»¬å°±ä¸è¯´äº†ï¼Œæ˜¯ç®€å•åœ°æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ã€‚

äºŒçº§å‘½ä»¤ ./hade command listã€‚åŠŸèƒ½æ˜¯åˆ—å‡ºæ‰€æœ‰çš„æ§åˆ¶å°å‘½ä»¤ã€‚è¿™ä¸ªåŠŸèƒ½å®é™…ä¸Šå’Œç›´æ¥è°ƒç”¨ ./hade æ˜¾ç¤ºçš„å¸®åŠ©ä¿¡æ¯å·®ä¸å¤šï¼ŒæŠŠä¸€çº§æ ¹å‘½ä»¤å…¨éƒ¨åˆ—äº†å‡ºæ¥ï¼Œåªä¸è¿‡æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªæ›´ä¸ºè¯­ä¹‰åŒ–çš„ ./hade command list æ¥æ˜¾ç¤ºã€‚  
![](https://static001.geekbang.org/resource/image/85/9e/85fd992ca12552e3d5fef51994b1079e.png?wh=946x722)

å®ƒçš„å®ç°ä¹Ÿå¹¶ä¸å¤æ‚ï¼Œå…·ä½“å°±æ˜¯ä½¿ç”¨Root().Commands() æ–¹æ³•éå†ä¸€çº§è·Ÿå‘½ä»¤çš„æ‰€æœ‰ä¸€çº§å‘½ä»¤ã€‚

```go
// cmdListCommand åˆ—å‡ºæ‰€æœ‰çš„æ§åˆ¶å°å‘½ä»¤
var cmdListCommand = &cobra.Command{
   Use:   "list",
   Short: "åˆ—å‡ºæ‰€æœ‰æ§åˆ¶å°å‘½ä»¤",
   RunE: func(c *cobra.Command, args []string) error {
      cmds := c.Root().Commands()
      ps := [][]string{}
      for _, cmd := range cmds {
         line := []string{cmd.Name(), cmd.Short}
         ps = append(ps, line)
      }
      util.PrettyPrint(ps)
      return nil
   },
}
```

äºŒçº§å‘½ä»¤ ./hade command newåˆ›å»ºå‘½ä»¤è¡Œå·¥å…·ï¼Œå°±æ˜¯åœ¨app/console/command/ æ–‡ä»¶å¤¹ä¸‹å¢åŠ ä¸€ä¸ªç›®å½•ï¼Œç„¶ååœ¨è¿™ä¸ªç›®å½•ä¸­å­˜æ”¾å‘½ä»¤çš„ç›¸å…³ä»£ç ã€‚

æ¯”å¦‚è¦åˆ›å»ºä¸€ä¸ªfooå‘½ä»¤ï¼Œå°±æ˜¯è¦åœ¨app/console/command/ ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªfooç›®å½•ï¼Œå…¶ä¸­åˆ›å»ºä¸€ä¸ªfoo.go æ–‡ä»¶åï¼Œè¿™ä¸ªæ–‡ä»¶åå¯ä»¥éšæ„èµ·ï¼Œè¿™é‡Œæˆ‘ä»¬å°±å’Œç›®å½•åä¿æŒä¸€è‡´ã€‚ç„¶ååœ¨ app/console/command/foo.go æ–‡ä»¶ä¸­è¾“å…¥æ¨¡ç‰ˆï¼š

```go
// å‘½ä»¤è¡Œå·¥å…·æ¨¡ç‰ˆ
var cmdTmpl string = `package {{.}}

import (
   "fmt"

   "github.com/gohade/hade/framework/cobra"
)

var {{.|title}}Command = &cobra.Command{
   Use:   "{{.}}",
   Short: "{{.}}",
   RunE: func(c *cobra.Command, args []string) error {
        container := c.GetContainer()
      fmt.Println(container)
      return nil
   },
}
```

å®ç°æ­¥éª¤ä¹Ÿå¾ˆç®€å•ï¼šsurvery äº¤äº’å…ˆè¦æ±‚ç”¨æˆ·è¾“å…¥å‘½ä»¤åç§°ï¼›ç„¶åè¦æ±‚ç”¨æˆ·è¾“å…¥æ–‡ä»¶å¤¹åç§°ï¼Œè®°å¾—æ£€æŸ¥å‘½ä»¤åç§°å’Œæ–‡ä»¶å¤¹åç§°æ˜¯å¦åˆç†ï¼›ä¹‹ååˆ›å»ºæ–‡ä»¶å¤¹ app/console/command/xxx å’Œæ–‡ä»¶ app/console/command/xxx/xxx.goï¼›æœ€åä½¿ç”¨templateå°†æ¨¡ç‰ˆå†™å…¥æ–‡ä»¶ä¸­ã€‚

## è‡ªåŠ¨åŒ–ä¸­é—´ä»¶è¿ç§»å·¥å…·

é™¤äº†æœåŠ¡å·¥å…·å’Œå‘½ä»¤è¡Œå·¥å…·çš„åˆ›å»ºï¼Œå¯¹äºä¸­é—´ä»¶ï¼Œæˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¹Ÿæ˜¯ç»å¸¸ä¼šä½¿ç”¨åˆ›å»ºçš„ï¼ŒåŒæ ·çš„ï¼Œå¯ä»¥ä¸ºä¸­é—´ä»¶å®šä¹‰ä¸€ç³»åˆ—çš„å‘½ä»¤æ¥è‡ªåŠ¨åŒ–ã€‚

- `./hade middleware` ä¸€çº§å‘½ä»¤ï¼Œæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
- `./hade middleware list` äºŒçº§å‘½ä»¤ï¼Œåˆ—å‡ºæ‰€æœ‰çš„ä¸šåŠ¡ä¸­é—´ä»¶
- `./hade middleware new` äºŒçº§å‘½ä»¤ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ä¸šåŠ¡ä¸­é—´ä»¶
- `./hade middleware migrate` äºŒçº§å‘½ä»¤ï¼Œè¿ç§»Ginå·²æœ‰çš„ä¸­é—´ä»¶

å…¶ä¸­çš„å‰é¢ä¸‰ä¸ªå‘½ä»¤åŸºæœ¬ä¸Šå’Œproviderã€command å‘½ä»¤å¦‚å‡ºä¸€è¾™ï¼Œæˆ‘ä»¬å°±ä¸èµ˜è¿°äº†ï¼ŒåŒæ ·ä½ å¯ä»¥é€šè¿‡GitHub ä¸Šçš„[framework/command/middleware.go æ–‡ä»¶](https://github.com/gohade/coredemo/blob/geekbang/21/framework/command/middleware.go)å‚è€ƒå…¶å…·ä½“å®ç°ï¼Œç›¸ä¿¡ä½ å¯ä»¥é¡ºåˆ©å†™å‡ºæ¥ã€‚

è¿™é‡Œé‡ç‚¹è¯´ä¸€ä¸‹ `./hade middleware migrate` å‘½ä»¤ã€‚

ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰å¥½å¥‡ï¼Œä¸ºä»€ä¹ˆè¿ç§»ä¹Ÿè¦å†™ä¸€ä¸ªå‘½ä»¤ï¼Ÿå½“æ—¶åœ¨å°†Ginè¿ç§»è¿›å…¥hadeæ¡†æ¶çš„æ—¶å€™æˆ‘ä»¬è¯´ï¼ŒGinä½œä¸ºä¸€ä¸ªæˆç†Ÿçš„å¼€æºä½œå“ï¼Œæœ‰ä¸°å¯Œçš„ä¸­é—´ä»¶åº“ï¼Œå­˜æ”¾GitHubçš„ä¸€ä¸ªé¡¹ç›® [gin-contrib](https://github.com/gin-contrib/) ä¸­ã€‚é‚£ä¹ˆåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€å®šä¼šç»å¸¸éœ€è¦ä½¿ç”¨åˆ°è¿™äº›ä¸­é—´ä»¶ã€‚

ä½†æ˜¯ç”±äºè¿™äº›ä¸­é—´ä»¶ä½¿ç”¨åˆ°çš„Ginæ¡†æ¶çš„åœ°å€ä¸º ï¼š

```plain
github.com/gin-gonic/gin
```

è€Œæˆ‘ä»¬çš„Ginæ¡†æ¶åœ°å€ä¸ºï¼š

```plain
github.com/gohade/hade/framework/gin
```

æ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨importç›´æ¥ä½¿ç”¨è¿™äº›ä¸­é—´ä»¶ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ä¸ªåŠæ³•ï¼Œèƒ½ç›´æ¥ä¸€é”®è¿ç§»gin-contribä¸‹çš„æŸä¸ªä¸­é—´ä»¶å‘¢ï¼Ÿæ¯”å¦‚ `git@github.com:gin-contrib/cors.git` ï¼Œç›´æ¥æ‹·è´å¹¶ä¸”è‡ªåŠ¨ä¿®æ”¹å¥½Ginæ¡†æ¶å¼•ç”¨åœ°å€ï¼Œæ”¾åˆ°æˆ‘ä»¬çš„ app/http/middleware/ ç›®å½•ä¸­ã€‚

äºæ˜¯å°±æœ‰äº†è¿™ä¸ª `./hade middleware migragte` å‘½ä»¤ã€‚ä¸‹é¢å°±æ¢³ç†ä¸€ä¸‹è¿™ä¸ªå‘½ä»¤çš„é€»è¾‘æ­¥éª¤ã€‚ä»¥ä¸‹è½½corsä¸­é—´ä»¶ä¸ºä¾‹ï¼Œæˆ‘ä»¬çš„æ€è·¯æ˜¯ä»GitHubä¸Šå°†è¿™ä¸ª[corsé¡¹ç›®](https://github.com/gin-contrib/cors)å¤åˆ¶ä¸‹æ¥ï¼Œ**å¹¶ä¸”åˆ é™¤è¿™ä¸ªé¡¹ç›®çš„ä¸€äº›ä¸å¿…è¦çš„æ–‡ä»¶**ã€‚

ä»€ä¹ˆæ˜¯ä¸å¿…è¦çš„æ–‡ä»¶å‘¢ï¼Ÿ.gitç›®å½•ã€go.modã€go.sumï¼Œè¿™äº›éƒ½æ˜¯ä½œä¸ºä¸€ä¸ªâ€œé¡¹ç›®â€æ‰ä¼šéœ€è¦çš„ï¼Œè€Œæˆ‘ä»¬è¦æŠŠé¡¹ç›®ä¸­çš„è¿™äº›åˆ æ‰ï¼Œè®©å®ƒæˆä¸ºä¸€ä¸ªæ–‡ä»¶ï¼Œå­˜æ”¾åœ¨æˆ‘ä»¬çš„app/http/middleware/corsç›®å½•ä¸‹ã€‚æœ€åå†éå†è¿™ä¸ªç›®å½•çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå°†æ‰€æœ‰å‡ºç°â€œgithub.com/gin-gonic/ginâ€ çš„åœ°æ–¹æ›¿æ¢ä¸ºâ€œgithub.com/gohade/hade/framework/ginâ€å°±å¯ä»¥äº†ã€‚

ä»gitä¸Šå¤åˆ¶ä¸€ä¸ªé¡¹ç›®ï¼Œåœ¨Golangä¸­å¯ä»¥ä½¿ç”¨ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ [go-git](https://github.com/go-git/go-git)ï¼Œè¿™ä¸ªç¬¬ä¸‰æ–¹åº“å·²ç»æœ‰2.7k ä¸ªstarï¼Œä¸”åŸºäºApache çš„Licenceï¼Œæ˜¯å¯ä»¥ç›´æ¥importä½¿ç”¨çš„ã€‚ç›®å‰è¿™ä¸ªåº“æœ€æ–°çš„ç‰ˆæœ¬ä¸ºv5ã€‚

å®ƒçš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```go
_, err := git.PlainClone("/tmp/foo", false, &git.CloneOptions{
    URL:      "https://github.com/go-git/go-git",
    Progress: os.Stdout,
})
```

å°†æŸä¸ªGitçš„URLåœ°å€ä½¿ç”¨gitcloneï¼Œä¸‹è½½åˆ°/tmp/fooç›®å½•ï¼Œå¹¶ä¸”æŠŠè¾“å‡ºä¹Ÿè¾“å‡ºåˆ°æ§åˆ¶å°ã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™æ ·çš„æ–¹å¼è¿›è¡Œå¤åˆ¶ã€‚å…·ä½“çš„ä»£ç é€»è¾‘ä¹Ÿä¸éš¾ï¼Œå½’çº³ä¸€ä¸‹ï¼Œmigrateçš„å®ç°æ­¥éª¤å¦‚ä¸‹ï¼š

1. å‚æ•°ä¸­è·å–ä¸­é—´ä»¶åç§°ï¼›
2. ä½¿ç”¨go-gitï¼Œå°†å¯¹åº”çš„gin-contribçš„é¡¹ç›®cloneåˆ°ç›®å½•/app/http/middlewareï¼›
3. åˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶go.modã€go.sumã€.gitï¼›
4. æ›¿æ¢å…³é”®å­— â€œgithub.com/gin-gonic/ginâ€ã€‚

åœ¨framework/command/middleware.goä¸­ï¼Œå¯¹åº”çš„ä»£ç å¦‚ä¸‹ï¼š

```go
// ä»gin-contribä¸­è¿ç§»ä¸­é—´ä»¶
var middlewareMigrateCommand = &cobra.Command{
   Use:   "migrate",
   Short: "è¿ç§»gin-contribä¸­é—´ä»¶, è¿ç§»åœ°å€ï¼šhttps://github.com/gin-contrib/[middleware].git",
   RunE: func(c *cobra.Command, args []string) error {
      container := c.GetContainer()
      fmt.Println("è¿ç§»ä¸€ä¸ªGinä¸­é—´ä»¶")
      // step1: è·å–å‚æ•°
      var repo string
      {
         prompt := &survey.Input{
            Message: "è¯·è¾“å…¥ä¸­é—´ä»¶åç§°ï¼š",
         }
         err := survey.AskOne(prompt, &repo)
         if err != nil {
            return err
         }
      }
      // step2 : ä¸‹è½½gitåˆ°ä¸€ä¸ªç›®å½•ä¸­
      appService := container.MustMake(contract.AppKey).(contract.App)

      middlewarePath := appService.MiddlewareFolder()
      url := "https://github.com/gin-contrib/" + repo + ".git"
      fmt.Println("ä¸‹è½½ä¸­é—´ä»¶ gin-contrib:")
      fmt.Println(url)
      _, err := git.PlainClone(path.Join(middlewarePath, repo), false, &git.CloneOptions{
         URL:      url,
         Progress: os.Stdout,
      })
      if err != nil {
         return err
      }

      // step3:åˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶ go.mod, go.sum, .git
      repoFolder := path.Join(middlewarePath, repo)
      fmt.Println("remove " + path.Join(repoFolder, "go.mod"))
      os.Remove(path.Join(repoFolder, "go.mod"))
      fmt.Println("remove " + path.Join(repoFolder, "go.sum"))
      os.Remove(path.Join(repoFolder, "go.sum"))
      fmt.Println("remove " + path.Join(repoFolder, ".git"))
      os.RemoveAll(path.Join(repoFolder, ".git"))

      // step4 : æ›¿æ¢å…³é”®è¯
      filepath.Walk(repoFolder, func(path string, info os.FileInfo, err error) error {
         if info.IsDir() {
            return nil
         }

         if filepath.Ext(path) != ".go" {
            return nil
         }

         c, err := ioutil.ReadFile(path)
         if err != nil {
            return err
         }
         isContain := bytes.Contains(c, []byte("github.com/gin-gonic/gin"))
         if isContain {
            fmt.Println("æ›´æ–°æ–‡ä»¶:" + path)
            c = bytes.ReplaceAll(c, []byte("github.com/gin-gonic/gin"), []byte("github.com/gohade/hade/framework/gin"))
            err = ioutil.WriteFile(path, c, 0644)
            if err != nil {
               return err
            }
         }

         return nil
      })
      return nil
   },
}
```

æˆ‘ä»¬å¯ä»¥ä¸‹è½½corsé¡¹ç›®åšä¸€ä¸‹éªŒè¯ï¼Œè¿è¡Œ `./hade middleware migrate` å‘½ä»¤ï¼Œå¹¶ä¸”è¾“å…¥corsã€‚ä½ ä¼šåœ¨æ§åˆ¶å°çœ‹åˆ°è¿™äº›ä¿¡æ¯ï¼š  
![](https://static001.geekbang.org/resource/image/6f/5f/6fd8197207c92b3b362a89cc4676015f.png?wh=682x384)

å¹¶ä¸”åœ¨ç›®å½•ä¸­çœ‹åˆ°corsä¸­é—´ä»¶å·²ç»å®Œæ•´ä¸‹è½½ä¸‹æ¥äº†ã€‚  
![](https://static001.geekbang.org/resource/image/70/09/709dbbc8c2140byy56459c202aa66909.png?wh=343x610)

ç„¶åï¼Œå¯ä»¥ç›´æ¥åœ¨app/http/route.goä¸­ç›´æ¥ä½¿ç”¨è¿™ä¸ªcorsä¸­é—´ä»¶ï¼š

```go
...

// Routes ç»‘å®šä¸šåŠ¡å±‚è·¯ç”±
func Routes(r *gin.Engine) {
   ...
   // ä½¿ç”¨corsä¸­é—´ä»¶
   r.Use(cors.Default())
   ...
 }
```

éªŒè¯å®Œæˆï¼

ä»Šå¤©æ‰€æœ‰ä»£ç éƒ½ä¿å­˜åœ¨GitHubä¸Šçš„[geekbang/21](https://github.com/gohade/coredemo/tree/geekbang/21)åˆ†æ”¯äº†ã€‚é™„ä¸Šç›®å½•ç»“æ„ä¾›ä½ å¯¹æ¯”æŸ¥çœ‹ï¼Œåªä¿®æ”¹äº†framework/command/ç›®å½•ä¸‹çš„cmd.goã€provider.goã€middleware.goæ–‡ä»¶ã€‚  
![](https://static001.geekbang.org/resource/image/78/89/7889877151dc4d4e306554a64c550c89.png?wh=476x936)

## å°ç»“

ä»Šå¤©å¢åŠ çš„å‘½ä»¤ä¸å°‘ï¼Œè‡ªåŠ¨åŒ–åˆ›å»ºæœåŠ¡å·¥å…·ã€å‘½ä»¤è¡Œå·¥å…·ï¼Œä»¥åŠä¸­é—´ä»¶è¿ç§»å·¥å…·ï¼Œè¿™äº›å‘½ä»¤éƒ½ä¸ºæˆ‘ä»¬åç»­å¼€å‘åº”ç”¨æä¾›äº†ä¸å°‘ä¾¿åˆ©ã€‚

å…¶å®æ¯ä¸ªè‡ªåŠ¨åŒ–å‘½ä»¤è¡Œå·¥å…·å®ç°çš„æ€è·¯éƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œå…ˆæ€è€ƒæ¸…æ¥šå¯¹äºè¿™ä¸ªå·¥å…·æˆ‘ä»¬è¦è‡ªåŠ¨åŒ–ç”Ÿæˆä»€ä¹ˆï¼Œç„¶åä½¿ç”¨ä»£ç å’Œå¯¹åº”çš„æ¨¡ç‰ˆç”Ÿæˆå¯¹åº”çš„æ–‡ä»¶ï¼Œå¹¶ä¸”æ›¿æ¢å…¶ä¸­ç‰¹æœ‰çš„å•è¯ã€‚åŸç†ä¸å¤æ‚ï¼Œä½†æ˜¯å¯¹äºå®é™…çš„å·¥ä½œï¼Œæ˜¯éå¸¸æœ‰å¸®åŠ©çš„ã€‚

è¿™ä¸€èŠ‚è¯¾ä½ åº”è¯¥å¯ä»¥æ„Ÿå—åˆ°ä¹‹å‰å°†cobraå¼•å…¥æˆ‘ä»¬çš„æ¡†æ¶æ˜¯ä¸€ä¸ªå¤šä¹ˆæ­£ç¡®çš„å†³å®šï¼Œåœ¨cobraä¹‹ä¸Šï¼Œæˆ‘ä»¬æ‰èƒ½å®ç°è¿™äº›æ–¹ä¾¿çš„è‡ªåŠ¨åŒ–å·¥å…·ã€‚

### æ€è€ƒé¢˜

æˆ‘ä»¬å®ç°çš„è‡ªåŠ¨åŒ–æœåŠ¡./hade command listå‘½ä»¤ï¼Œç›®å‰åªå±•ç¤ºäº†ä¸€çº§å‘½ä»¤ï¼Œåœ¨å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™æˆ‘åæ€äº†ä¸€ä¸‹ï¼Œå…¶å®å¯ä»¥æ‰©å±•æˆä¸ºæ ‘å½¢ç»“æ„å±•ç¤ºï¼ŒåŒæ—¶å±•ç¤ºä¸€çº§/äºŒçº§/ä¸‰çº§/å‘½ä»¤ã€‚ä½ å¯ä»¥æƒ³æƒ³å¦‚ä½•å®ç°ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼Œå¯ä»¥å»github.com/gohade/hade é¡¹ç›®ä¸­æäº¤ä¸€ä¸ªmerge request æ¥è¡¥å……è¿™ä¸ªåŠŸèƒ½å§ï¼

æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ4ï¼‰</strong></div><ul>
<li><span>zzq</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¤§ä½¬ï¼Œ åœ¨ framework&#47;command&#47;middleware.go æ–‡ä»¶ä¸­ç¼ºå°‘äº†    é»˜è®¤: åŒä¸­é—´ä»¶åç§°ã€‚ if folder == &quot;&quot; {folder = name}   </p>2021-12-01</li><br/><li><span>kkxue</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¯¾ç¨‹è®¾è®¡çš„å¥½æ£’</p>2021-11-05</li><br/><li><span>qinsi</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä¸­é—´ä»¶ä¹Ÿè¦æ‹·è´ä»£ç å—...æ˜¯å¦å¯ä»¥å®‰è£…ä»¥ååœ¨go.modé‡Œreplaceå‘¢ï¼Ÿ</p>2021-11-05</li><br/><li><span>taoist</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>go-git é…ç½®httpä»£ç†ï¼š
		res_url := &quot;https:&#47;&#47;github.com&#47;gin-contrib&#47;&quot; + repo + &quot;.git&quot;
		fmt.Println(&quot;ä¸‹è½½ä¸­é—´ä»¶ gin-contrib:&quot;, res_url)
	
		&#47;&#47;è‡ªå®šä¹‰ http proxy
		proxy_url, _ := url.Parse(&quot;http:&#47;&#47;127.0.0.1:7890&quot;)
		customHttp := &amp;http.Client{
			Transport: &amp;http.Transport{
				Proxy: http.ProxyURL(proxy_url),
			},
		}
		client.InstallProtocol(&quot;https&quot;, githttp.NewClient(customHttp))
		_, err := git.PlainClone(path.Join(middlewarePath, repo), false, &amp;git.CloneOptions{
			URL:      res_url,
			Progress: os.Stdout,
		})</p>2024-01-20</li><br/>
</ul>