ä½ å¥½ï¼Œæˆ‘æ˜¯è½©è„‰åˆƒã€‚

ä¸Šé¢ä¸¤èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°†ç¯å¢ƒå˜é‡å’Œé…ç½®æœåŠ¡ä½œä¸ºä¸€ä¸ªæœåŠ¡æ³¨å†Œåˆ°å®¹å™¨ä¸­äº†ã€‚è¿™æ ·ï¼Œåœ¨ä¸šåŠ¡ä¸­å°±èƒ½å¾ˆæ–¹ä¾¿è·å–ç¯å¢ƒå˜é‡å’Œé…ç½®äº†ã€‚ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰é€æ¸ä½“ä¼šåˆ°è¿™ç§â€œä¸€åˆ‡çš†æœåŠ¡â€æ€æƒ³çš„å¥½å¤„ã€‚

å°±åƒå †ç§¯ç§¯æœ¨ï¼Œåªè¦æƒ³å¥½äº†ä¸€ä¸ªæœåŠ¡çš„æ¥å£ï¼Œæˆ‘ä»¬é€æ­¥å®ç°æœåŠ¡ä¹‹åï¼Œè¿™ä¸€ä¸ªæœåŠ¡å°±æ˜¯ä¸€å—ç§¯æœ¨ï¼Œä¹‹åå¯ä»¥ç”¨ç›¸åŒçš„æ€è·¯å®ç°å„ç§æœåŠ¡çš„ç§¯æœ¨å—ï¼Œç”¨å®ƒä»¬æ¥æ‹¼å‡ºæˆ‘ä»¬éœ€è¦çš„ä¸šåŠ¡é€»è¾‘ã€‚è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±æ¥å®ç°å¦ä¸€ä¸ªæ¡†æ¶æœ€æ ¸å¿ƒçš„ç§¯æœ¨ï¼šæ—¥å¿—æœåŠ¡ã€‚

å®ç°ä¸€ä¸ªæ¡†æ¶çš„æœåŠ¡ï¼Œæˆ‘ä»¬ä¹ æƒ¯äº†è¦åˆ›å»ºä¸‰ä¸ªæ–‡ä»¶ï¼šæ¥å£åè®®æ–‡ä»¶ framework/contract/log.goã€æœåŠ¡æä¾›è€… framework/provider/log/provider.goã€æ¥å£å®ä¾‹framework/provider/log/service.goã€‚

## æ—¥å¿—æ¥å£åè®®

è¯´åˆ°æ—¥å¿—æœåŠ¡ï¼Œæœ€å…ˆå†’å‡ºæ¥çš„ä¸€å®šæ˜¯ä¸‰ä¸ªé—®é¢˜ï¼šä»€ä¹ˆæ ·çš„æ—¥å¿—éœ€è¦è¾“å‡ºï¼Ÿæ—¥å¿—è¾“å‡ºå“ªäº›å†…å®¹ï¼Ÿæ—¥å¿—è¾“å‡ºåˆ°å“ªé‡Œï¼Ÿä¸€ä¸ªä¸ªæ¥åˆ†æã€‚

### æ—¥å¿—çº§åˆ«

ä»€ä¹ˆæ ·çš„æ—¥å¿—éœ€è¦è¾“å‡ºï¼Œè¿™æ˜¯ä¸ªå…³äºæ—¥å¿—çº§åˆ«çš„é—®é¢˜ã€‚æˆ‘ä»¬æƒ³è¦æŠŠæ—¥å¿—åˆ†ä¸ºå‡ ä¸ªçº§åˆ«ï¼Ÿæ¯ä¸ªçº§åˆ«ä»£è¡¨ä»€ä¹ˆï¼Ÿè¿™ä¸ªæ—¥å¿—çº§åˆ«å…¶å®åœ¨ä¸åŒç³»ç»Ÿä¸­æœ‰ä¸åŒåˆ’åˆ†ï¼Œæ¯”å¦‚Linuxçš„[syslog](https://datatracker.ietf.org/doc/html/rfc5424)ä¸­å°†ç³»ç»Ÿåˆ’åˆ†ä¸ºä»¥ä¸‹å…«ç§æ—¥å¿—çº§åˆ«ï¼š  
![](https://static001.geekbang.org/resource/image/f5/ea/f5382bc685494efb2c024f31f25aa2ea.png?wh=912x438)  
è€ŒJavaçš„[log4j](https://zh.wikipedia.org/wiki/Log4j)å°†æ—¥å¿—åˆ†ä¸ºä»¥ä¸‹ä¸ƒç§æ—¥å¿—çº§åˆ«ï¼š  
![](https://static001.geekbang.org/resource/image/e0/78/e07a0aefb9039788d17921e192394f78.jpg?wh=1920x1080)

å…¶å®ä»”ç»†çœ‹ï¼Œå®ƒä»¬çš„æ—¥å¿—çº§åˆ«å·®åˆ«éƒ½ä¸å¤§ã€‚æ¯”å¦‚éƒ½åŒæ„ç”¨Errorçº§åˆ«ä»£è¡¨è¿è¡Œæ—¶çš„é”™è¯¯æƒ…å†µï¼Œè€ŒWarnçº§åˆ«ä»£è¡¨è¿è¡Œæ—¶å¯ä»¥å¼¥è¡¥çš„é”™è¯¯ã€Infoçº§åˆ«ä»£è¡¨è¿è¡Œæ—¶ä¿¡æ¯ã€debugä»£è¡¨è°ƒè¯•çš„æ—¶å€™éœ€è¦æ‰“å°çš„ä¿¡æ¯ã€‚

ä¸åŒç‚¹å°±åœ¨æ˜¯å¦æœ‰traceçº§åˆ«ä»¥åŠErrorçº§åˆ«å¾€ä¸Šçš„çº§åˆ«å®šä¹‰ã€‚syslogæ²¡æœ‰traceçº§åˆ«ï¼Œè€Œåœ¨Errorçº§åˆ«å¾€ä¸Šåˆ†åˆ«å®šä¹‰äº†Emergencyçº§åˆ«ã€Alertçº§åˆ«ã€Criticalçº§åˆ«ã€‚è€Œlog4jåœ¨ERRORä¸Šå®šä¹‰äº†ä¸¤ä¸ªçº§åˆ«FATALå’ŒOFFï¼Œä¹ŸåŒæ—¶ä¿ç•™äº†Traceçº§åˆ«ã€‚

åœ¨æˆ‘çœ‹æ¥ï¼Œsyslogå’Œlog4jçš„æ—¥å¿—åŒºåˆ†ä¸»è¦æ˜¯ç”±äºåœºæ™¯ä¸åŒã€‚syslogæ¯”è¾ƒåå‘äº**æ“ä½œç³»ç»Ÿçš„ä½¿ç”¨åœºæ™¯**ï¼Œå®ƒçš„åˆ†çº§è¯­ä¹‰æ›´å¤šæ˜¯å‘Šè¯‰æˆ‘ä»¬ç³»ç»Ÿçš„æƒ…å†µï¼Œæ¯”å¦‚Alertè¿™ä¸ªçº§åˆ«è¡¨ç¤ºâ€œç³»ç»Ÿæœ‰é—®é¢˜ï¼Œéœ€è¦ç«‹å³é‡‡å–è¡ŒåŠ¨â€ï¼›è€Œlog4jçš„æ—¥å¿—çº§åˆ«å®šä¹‰æ˜¯**ä»ä¸€ä¸ªåº”ç”¨å‡ºå‘çš„**ï¼Œå®ƒçš„å½±å“èŒƒå›´ç†è®ºä¸Šä¼šå°ä¸€äº›ï¼Œæ‰€ä»¥å®ƒå¾ˆéš¾å®šä¹‰æ¯”å¦‚åƒâ€œéœ€è¦ç«‹å³é‡‡å–è¡ŒåŠ¨â€è¿™æ ·çš„çº§åˆ«ã€‚

æ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦å‚è€ƒlog4jçš„æ—¥å¿—çº§åˆ«æ–¹æ³•ï¼Œå¹¶åšäº†ä¸€äº›å°è°ƒæ•´ï¼Œå½’å¹¶ä¸ºä¸‹åˆ—ä¸ƒç§æ—¥å¿—çº§åˆ«ï¼š

- panicï¼Œè¡¨ç¤ºä¼šå¯¼è‡´æ•´ä¸ªç¨‹åºå‡ºç°å´©æºƒçš„æ—¥å¿—ä¿¡æ¯
- fatalï¼Œè¡¨ç¤ºä¼šå¯¼è‡´å½“å‰è¿™ä¸ªè¯·æ±‚å‡ºç°æå‰ç»ˆæ­¢çš„é”™è¯¯ä¿¡æ¯
- errorï¼Œè¡¨ç¤ºå‡ºç°é”™è¯¯ï¼Œä½†æ˜¯ä¸ä¸€å®šå½±å“åç»­è¯·æ±‚é€»è¾‘çš„é”™è¯¯ä¿¡æ¯
- warnï¼Œè¡¨ç¤ºå‡ºç°é”™è¯¯ï¼Œä½†æ˜¯ä¸€å®šä¸å½±å“åç»­è¯·æ±‚é€»è¾‘çš„æŠ¥è­¦ä¿¡æ¯
- infoï¼Œè¡¨ç¤ºæ­£å¸¸çš„æ—¥å¿—ä¿¡æ¯è¾“å‡º
- debugï¼Œè¡¨ç¤ºåœ¨è°ƒè¯•çŠ¶æ€ä¸‹æ‰“å°å‡ºæ¥çš„æ—¥å¿—ä¿¡æ¯
- traceï¼Œè¡¨ç¤ºæœ€è¯¦ç»†çš„ä¿¡æ¯ï¼Œä¸€èˆ¬ä¿¡æ¯é‡æ¯”è¾ƒå¤§ï¼Œå¯èƒ½åŒ…å«è°ƒç”¨å †æ ˆç­‰ä¿¡æ¯

åœ¨errorçº§åˆ«ä¹‹ä¸Šï¼Œæˆ‘ä»¬æŠŠå¯¼è‡´ç¨‹åºå´©æºƒå’Œå¯¼è‡´è¯·æ±‚ç»“æŸçš„é”™è¯¯æ‹†åˆ†å‡ºæ¥ï¼Œåˆ†ä¸ºpanicå’Œfatalä¸¤ä¸ªç±»å‹æ¥å®šä¹‰çº§åˆ«ã€‚è€Œå…¶ä»–çš„errorã€warnã€infoã€debug éƒ½å’Œå…¶ä»–çš„æ—¥å¿—ç³»ç»Ÿä¸€è‡´ã€‚å¦å¤–ä¹Ÿå¢åŠ ä¸€ä¸ªtraceçº§åˆ«ï¼Œå½“éœ€è¦æ‰“å°è°ƒç”¨å †æ ˆç­‰è¿™äº›æ¯”è¾ƒè¯¦ç»†çš„ä¿¡æ¯çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§æ—¥å¿—çº§åˆ«ã€‚

**æ—¥å¿—çº§åˆ«æ˜¯æŒ‰ç…§ä¸¥é‡é¡ºåºä»ä¸‹å¾€ä¸Šæ’åˆ—çš„**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®äº†æ—¥å¿—è¾“å‡ºçº§åˆ«ä¸ºinfoï¼Œé‚£ä¹ˆinfoçº§åˆ«çš„æ—¥å¿—åŠinfoçº§åˆ«å¾€ä¸Šï¼Œæ—¥å¿—çº§åˆ«æ›´é«˜çš„warnã€errorã€fatalã€panicçš„æ—¥å¿—ï¼Œä¹Ÿéœ€è¦è¢«æ‰“å°å‡ºæ¥ã€‚

æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬åœ¨framework/contract/log.goä¸­å®šä¹‰çš„æ¥å£åè®®å¦‚ä¸‹ï¼š

```go
package contract
import (
   "context"
   "io"
   "time"
)

// åè®®å…³é”®å­—
const LogKey = "hade:log"

type LogLevel uint32

const (
   // UnknownLevel è¡¨ç¤ºæœªçŸ¥çš„æ—¥å¿—çº§åˆ«
   UnknownLevel LogLevel = iota
   // PanicLevel level, panic è¡¨ç¤ºä¼šå¯¼è‡´æ•´ä¸ªç¨‹åºå‡ºç°å´©æºƒçš„æ—¥å¿—ä¿¡æ¯
   PanicLevel
   // FatalLevel level. fatal è¡¨ç¤ºä¼šå¯¼è‡´å½“å‰è¿™ä¸ªè¯·æ±‚å‡ºç°æå‰ç»ˆæ­¢çš„é”™è¯¯ä¿¡æ¯
   FatalLevel
   // ErrorLevel level. error è¡¨ç¤ºå‡ºç°é”™è¯¯ï¼Œä½†æ˜¯ä¸ä¸€å®šå½±å“åç»­è¯·æ±‚é€»è¾‘çš„é”™è¯¯ä¿¡æ¯
   ErrorLevel
   // WarnLevel level. warn è¡¨ç¤ºå‡ºç°é”™è¯¯ï¼Œä½†æ˜¯ä¸€å®šä¸å½±å“åç»­è¯·æ±‚é€»è¾‘çš„æŠ¥è­¦ä¿¡æ¯
   WarnLevel
   // InfoLevel level. info è¡¨ç¤ºæ­£å¸¸çš„æ—¥å¿—ä¿¡æ¯è¾“å‡º
   InfoLevel
   // DebugLevel level. debug è¡¨ç¤ºåœ¨è°ƒè¯•çŠ¶æ€ä¸‹æ‰“å°å‡ºæ¥çš„æ—¥å¿—ä¿¡æ¯
   DebugLevel
   // TraceLevel level. trace è¡¨ç¤ºæœ€è¯¦ç»†çš„ä¿¡æ¯ï¼Œä¸€èˆ¬ä¿¡æ¯é‡æ¯”è¾ƒå¤§ï¼Œå¯èƒ½åŒ…å«è°ƒç”¨å †æ ˆç­‰ä¿¡æ¯
   TraceLevel
)
...

// Log define interface for log
type Log interface {
   // Panic è¡¨ç¤ºä¼šå¯¼è‡´æ•´ä¸ªç¨‹åºå‡ºç°å´©æºƒçš„æ—¥å¿—ä¿¡æ¯
   Panic(ctx context.Context, msg string, fields map[string]interface{})
   // Fatal è¡¨ç¤ºä¼šå¯¼è‡´å½“å‰è¿™ä¸ªè¯·æ±‚å‡ºç°æå‰ç»ˆæ­¢çš„é”™è¯¯ä¿¡æ¯
   Fatal(ctx context.Context, msg string, fields map[string]interface{})
   // Error è¡¨ç¤ºå‡ºç°é”™è¯¯ï¼Œä½†æ˜¯ä¸ä¸€å®šå½±å“åç»­è¯·æ±‚é€»è¾‘çš„é”™è¯¯ä¿¡æ¯
   Error(ctx context.Context, msg string, fields map[string]interface{})
   // Warn è¡¨ç¤ºå‡ºç°é”™è¯¯ï¼Œä½†æ˜¯ä¸€å®šä¸å½±å“åç»­è¯·æ±‚é€»è¾‘çš„æŠ¥è­¦ä¿¡æ¯
   Warn(ctx context.Context, msg string, fields map[string]interface{})
   // Info è¡¨ç¤ºæ­£å¸¸çš„æ—¥å¿—ä¿¡æ¯è¾“å‡º
   Info(ctx context.Context, msg string, fields map[string]interface{})
   // Debug è¡¨ç¤ºåœ¨è°ƒè¯•çŠ¶æ€ä¸‹æ‰“å°å‡ºæ¥çš„æ—¥å¿—ä¿¡æ¯
   Debug(ctx context.Context, msg string, fields map[string]interface{})
   // Trace è¡¨ç¤ºæœ€è¯¦ç»†çš„ä¿¡æ¯ï¼Œä¸€èˆ¬ä¿¡æ¯é‡æ¯”è¾ƒå¤§ï¼Œå¯èƒ½åŒ…å«è°ƒç”¨å †æ ˆç­‰ä¿¡æ¯
   Trace(ctx context.Context, msg string, fields map[string]interface{})
   // SetLevel è®¾ç½®æ—¥å¿—çº§åˆ«
   SetLevel(level LogLevel)
   ...
}
```

åœ¨æ¥å£ä¸­ï¼Œæˆ‘ä»¬é’ˆå¯¹ä¸ƒç§æ—¥å¿—çº§åˆ«è®¾ç½®äº†ä¸ƒä¸ªä¸åŒçš„æ–¹æ³•ï¼Œå¹¶ä¸”æä¾›SetLevelæ–¹æ³•ï¼Œæ¥è®¾ç½®å½“å‰è¿™ä¸ªæ—¥å¿—æœåŠ¡éœ€è¦è¾“å‡ºçš„æ—¥å¿—çº§åˆ«ã€‚

### æ—¥å¿—æ ¼å¼

å®šä¹‰å¥½äº†æ—¥å¿—çº§åˆ«ï¼Œä¸‹é¢è¯¥å®šä¹‰æ—¥å¿—æ ¼å¼äº†ã€‚æ—¥å¿—æ ¼å¼åŒ…æ‹¬è¾“å‡ºå“ªäº›å†…å®¹ã€å¦‚ä½•è¾“å‡ºï¼Ÿ

é¦–å…ˆæ˜ç¡®ä¸‹éœ€è¦è¾“å‡ºçš„æ—¥å¿—ä¿¡æ¯ï¼Œä¸å¤–ä¹æœ‰ä¸‹é¢å››ä¸ªéƒ¨åˆ†ï¼š

- æ—¥å¿—çº§åˆ«ï¼Œè¾“å‡ºå½“å‰æ—¥å¿—çš„çº§åˆ«ä¿¡æ¯ã€‚
- æ—¥å¿—æ—¶é—´ï¼Œè¾“å‡ºå½“å‰æ—¥å¿—çš„æ‰“å°æ—¶é—´ã€‚
- æ—¥å¿—ç®€è¦ä¿¡æ¯ï¼Œè¾“å‡ºå½“å‰æ—¥å¿—çš„ç®€è¦æè¿°ä¿¡æ¯ï¼Œä¸€å¥è¯è¯´æ˜æ—¥å¿—é”™è¯¯ã€‚
- æ—¥å¿—ä¸Šä¸‹æ–‡å­—æ®µï¼Œè¾“å‡ºå½“å‰æ—¥å¿—çš„é™„å¸¦ä¿¡æ¯ã€‚è¿™äº›å­—æ®µä»£è¡¨æ—¥å¿—æ‰“å°çš„ä¸Šä¸‹æ–‡ã€‚

æ¯”å¦‚è¿™å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ—¥å¿—ä¿¡æ¯ï¼š

```plain
[Info]Â  2021-09-22T00:04:21+08:00Â  Â  Â  Â "demo test error"Â  Â  Â  Â map[api:demo/demo cspan_id: parent_id: span_id:c55051d94815vbl56i2g trace_id:c55051d94815vbl56i20 user:jianfengye]
```

ä¸Šé¢é‚£æ¡æ—¥å¿—ï¼Œæ—¥å¿—çº§åˆ«ä¸ºInfoï¼Œæ—¶é—´ä¸º2021-09-21å¹´15:40:03ï¼Œæ—¶åŒºä¸º+08:00ã€‚ç®€è¦ä¿¡æ¯demo test error è¡¨ç¤ºè¿™ä¸ªæ—¥å¿—å¸Œæœ›æ‰“å°çš„ä¿¡æ¯ï¼Œå‰©ä¸‹çš„mapè¡¨ç¤ºçš„keyã€valueä¸ºè¡¥å……çš„æ—¥å¿—ä¸Šä¸‹æ–‡å­—æ®µã€‚

å®ƒå¯¹åº”çš„è°ƒç”¨å‡½æ•°å¦‚ä¸‹ï¼š

```go
logger.Info(c, "demo test error", map[string]interface{}{
   "api":  "demo/demo",
   "user": "jianfengye",
})
```

è¿™é‡Œæˆ‘é¢å¤–è¯´ä¸€ä¸‹æ—¥å¿—ä¸Šä¸‹æ–‡å­—æ®µã€‚å®ƒæ˜¯ä¸€ä¸ªmapå€¼ï¼Œæ¥æºå¯èƒ½æœ‰ä¸¤ä¸ªï¼šä¸€ä¸ªæ˜¯ç”¨æˆ·åœ¨æ‰“å°æ—¥å¿—çš„æ—¶å€™ä¼ é€’çš„mapï¼Œæ¯”å¦‚ä¸Šé¢ä»£ç ä¸­çš„apiå’Œuserï¼›è€Œå¦å¤–ä¸€éƒ¨åˆ†æ•°æ®æ˜¯å¯èƒ½æ¥è‡ªcontextï¼Œå› ä¸ºåœ¨å…·ä½“ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¾ˆæœ‰å¯èƒ½æŠŠä¸€äº›é€šç”¨ä¿¡æ¯ï¼Œæ¯”å¦‚trace\_idç­‰æ”¾åœ¨contexté‡Œï¼Œè¿™ä¸€éƒ¨åˆ†ä¿¡æ¯ä¹Ÿä¼šå¸Œæœ›å–å‡ºæ”¾åœ¨æ—¥å¿—çš„ä¸Šä¸‹æ–‡å­—æ®µä¸­ã€‚

æ‰€ä»¥è¿™é‡Œæœ‰ä¸€ä¸ªä»contextä¸­è·å–æ—¥å¿—ä¸Šä¸‹æ–‡å­—æ®µçš„æ–¹æ³•ã€‚åœ¨framework/contract/log.goä¸­å®šä¹‰å…¶ä¸ºCtxFielderã€‚

```go
// CtxFielder å®šä¹‰äº†ä»contextä¸­è·å–ä¿¡æ¯çš„æ–¹æ³•
type CtxFielder func(ctx context.Context) map[string]interface{}
```

æ˜ç¡®äº†æ‰“å°å“ªäº›ä¿¡æ¯ï¼Œæ›´è¦æ˜ç¡®è¿™äº›ä¿¡æ¯æŒ‰ç…§ä»€ä¹ˆè¾“å‡ºæ ¼å¼è¾“å‡ºã€‚è¿™ä¸ªè¾“å‡ºæ ¼å¼ä¹Ÿæ˜¯ä¸€ä¸ªé€šç”¨æ–¹æ³•Fomatterï¼Œå®ƒçš„ä¼ å…¥å‚æ•°å°±æ˜¯åˆšæ‰çš„å››ä¸ªæ—¥å¿—ä¿¡æ¯ã€‚

```go
// Formatter å®šä¹‰äº†å°†æ—¥å¿—ä¿¡æ¯ç»„ç»‡æˆå­—ç¬¦ä¸²çš„é€šç”¨æ–¹æ³•
type Formatter func(level LogLevel, t time.Time, msg string, fields map[string]interface{}) ([]byte, error)
```

åŒæ—¶åœ¨logæœåŠ¡åè®®ä¸­å¢åŠ äº†SetFormatter å’Œ SetCtxFielderçš„æ–¹æ³•ã€‚

```go
// Log å®šä¹‰äº†æ—¥å¿—æœåŠ¡åè®®
type Log interface {
   ...
   // SetCtxFielder ä»contextä¸­è·å–ä¸Šä¸‹æ–‡å­—æ®µfield
   SetCtxFielder(handler CtxFielder)
   // SetFormatter è®¾ç½®è¾“å‡ºæ ¼å¼
   SetFormatter(formatter Formatter)
   ...
}
```

### æ—¥å¿—è¾“å‡º

å·²ç»è§£å†³äº†å‰ä¸¤ä¸ªé—®é¢˜ï¼Œæ˜ç¡®äº†æ—¥å¿—çš„çº§åˆ«å’Œè¾“å‡ºæ ¼å¼ï¼Œé‚£æ—¥å¿—å¯ä»¥è¾“å‡ºåœ¨å“ªäº›åœ°æ–¹ï¼Ÿ

å…¶å®æˆ‘ä»¬åœ¨å®šä¹‰æ¥å£çš„æ—¶å€™ï¼Œå¹¶ä¸çŸ¥é“å®ƒä¼šè¾“å‡ºåˆ°å“ªé‡Œã€‚ä½†æ˜¯åªéœ€è¦çŸ¥é“ä¸€å®šä¼šè¾“å‡ºåˆ°æŸä¸ªè¾“å‡ºç®¡é“å°±å¯ä»¥äº†ï¼Œä¹‹ååœ¨æ¯ä¸ªåº”ç”¨ä¸­ä½¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å†æ ¹æ®æ¯ä¸ªåº”ç”¨çš„é…ç½®ï¼Œæ¥ç¡®è®¤å…·ä½“çš„è¾“å‡ºç®¡é“å®ç°ã€‚

ç›®å‰è¿™ä¸ªè¾“å‡ºç®¡é“æˆ‘ä»¬ä½¿ç”¨io.Writeræ¥è¿›è¡Œè®¾ç½®ï¼š

```go
// Log å®šä¹‰äº†æ—¥å¿—æœåŠ¡åè®®
type Log interface {
   ...
   // SetOutput è®¾ç½®è¾“å‡ºç®¡é“
   SetOutput(out io.Writer)
}
```

## æ—¥å¿—æœåŠ¡æä¾›è€…

æ—¥å¿—æ¥å£åè®®æ–‡ä»¶å°±å®Œæˆäº†ï¼Œä¸‹é¢æ¥å®ç°æ—¥å¿—çš„æœåŠ¡æä¾›è€…ï¼Œåœ¨framework/provider/log/provider.goä¸­ã€‚

åœ¨ç¼–å†™æœåŠ¡æä¾›è€…çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ˜ç¡®æœ€ç»ˆä¼šæä¾›å“ªäº›æœåŠ¡ã€‚å¯¹äºæ—¥å¿—æœåŠ¡ï¼ŒæŒ‰ç…§æˆ‘ä»¬å¹³æ—¶çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥åˆ†ä¸ºå››ç±»ï¼š

- æ§åˆ¶å°è¾“å‡º
- æœ¬åœ°å•ä¸ªæ—¥å¿—æ–‡ä»¶è¾“å‡º
- æœ¬åœ°å•ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œè‡ªåŠ¨è¿›è¡Œåˆ‡å‰²è¾“å‡º
- è‡ªå®šä¹‰è¾“å‡º

è¿™å››ç§è¾“å‡ºæˆ‘ä»¬éƒ½å„è‡ªå®šä¹‰ä¸€ä¸ªæœåŠ¡ï¼Œåˆ†åˆ«æ”¾åœ¨framework/provider/log/service/ ç›®å½•ä¸‹çš„å››ä¸ªæ–‡ä»¶é‡Œï¼š

- console.go è¡¨ç¤ºæ§åˆ¶å°è¾“å‡ºï¼Œå®šä¹‰åˆå§‹åŒ–å®ä¾‹æ–¹æ³•NewHadeConsoleLogï¼›
- single.go è¡¨è¿°å•ä¸ªæ—¥å¿—æ–‡ä»¶è¾“å‡ºï¼Œå®šä¹‰åˆå§‹åŒ–å®ä¾‹æ–¹æ³•NewHadeSingleLogï¼›
- rotate.go è¡¨ç¤ºå•ä¸ªæ–‡ä»¶è¾“å‡ºï¼Œä½†æ˜¯è‡ªåŠ¨è¿›è¡Œåˆ‡å‰²ï¼Œå®šä¹‰åˆå§‹åŒ–å®ä¾‹æ–¹æ³•NewHadeRotateLogï¼›
- custom.go è¡¨ç¤ºè‡ªå®šä¹‰è¾“å‡ºï¼Œå®šä¹‰å®ä¾‹åŒ–æ–¹æ³•NewHadeCustomLogã€‚

é‚£åœ¨æœåŠ¡æä¾›è€…çš„Registeræ³¨å†ŒæœåŠ¡å®ä¾‹æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è®¾è®¡æˆæ ¹æ®é…ç½®é¡¹â€œlog.driverâ€ ï¼Œæ¥é€‰æ‹©ä¸åŒçš„å®ä¾‹åŒ–æ–¹æ³•ï¼Œé»˜è®¤ä¸ºNewHadeConsoleLog æ–¹æ³•ã€‚

```go
// Register æ³¨å†Œä¸€ä¸ªæœåŠ¡å®ä¾‹
func (l *HadeLogServiceProvider) Register(c framework.Container) framework.NewInstance {
   if l.Driver == "" {
      tcs, err := c.Make(contract.ConfigKey)
      if err != nil {
         // é»˜è®¤ä½¿ç”¨console
         return services.NewHadeConsoleLog
      }
      cs := tcs.(contract.Config)
      l.Driver = strings.ToLower(cs.GetString("log.Driver"))
   }
   // æ ¹æ®driverçš„é…ç½®é¡¹ç¡®å®š
   switch l.Driver {
   case "single":
      return services.NewHadeSingleLog
   case "rotate":
      return services.NewHadeRotateLog
   case "console":
      return services.NewHadeConsoleLog
   case "custom":
      return services.NewHadeCustomLog
   default:
      return services.NewHadeConsoleLog
   }
}
```

è€Œä¸Šä¸€èŠ‚é‡Œé¢åˆ†æçš„ï¼Œæ—¥å¿—çš„å‡ ä¸ªé…ç½®ï¼šæ—¥å¿—çº§åˆ«ã€è¾“å‡ºæ ¼å¼æ–¹æ³•ã€contextå†…å®¹è·å–æ–¹æ³•ã€è¾“å‡ºæ–¹æ³•ï¼Œéƒ½ä»¥æœåŠ¡æä¾›è€…provider.go ä¸­å‚æ•°çš„æ–¹å¼æä¾›ã€‚

```go
// HadeLogServiceProvider æœåŠ¡æä¾›è€…
type HadeLogServiceProvider struct {
   ...

   // æ—¥å¿—çº§åˆ«
   Level contract.LogLevel
   // æ—¥å¿—è¾“å‡ºæ ¼å¼æ–¹æ³•
   Formatter contract.Formatter
   // æ—¥å¿—contextä¸Šä¸‹æ–‡ä¿¡æ¯è·å–å‡½æ•°
   CtxFielder contract.CtxFielder
   // æ—¥å¿—è¾“å‡ºä¿¡æ¯
   Output io.Writer
}
```

é»˜è®¤æä¾›ä¸¤ç§è¾“å‡ºæ ¼å¼ï¼Œä¸€ç§æ˜¯æ–‡æœ¬è¾“å‡ºå½¢å¼ï¼Œæ¯”å¦‚ä¸Šé¢ä¸¾çš„é‚£ä¸ªä¾‹å­ï¼Œ

```plain
[Info]Â  2021-09-22T00:04:21+08:00Â  Â  Â  Â "demo test error"Â  Â  Â  Â map[api:demo/demo cspan_id: parent_id: span_id:c55051d94815vbl56i2g trace_id:c55051d94815vbl56i20 user:jianfengye]
```

å¦å¤–ä¸€ç§æ˜¯JSONè¾“å‡ºå½¢å¼ï¼Œå¦‚ä¸‹ï¼š

```plain
{"api":"demo/demo","cspan_id":"","level":5,"msg":"demo1","parent_id":"","span_id":"c54v0tt9481537jasreg","timestamp":"2021-09-21T22:47:19+08:00","trace_id":"c54v0tt9481537jasre0","user":"jianfengye"}
```

è¿™ä¸¤ç§è¾“å‡ºé™¤äº†æ ¼å¼ä¸åŒï¼Œå…¶ä¸­çš„å†…å®¹åº”è¯¥æ˜¯ç›¸åŒçš„ã€‚å…·ä½“ä½¿ç”¨èµ·æ¥ï¼Œæ–‡æœ¬è¾“å‡ºæ›´ä¾¿äºæˆ‘ä»¬é˜…è¯»ï¼Œè€ŒJSONè¾“å‡ºæ›´ä¾¿äºæœºå™¨æˆ–è€…ç¨‹åºé˜…è¯»ã€‚

åœ¨å®ç°æ–‡ä»¶å¤¹framework/provider/log/formatter/ é‡Œï¼Œæˆ‘ä»¬å¢åŠ ä¸¤ä¸ªæ–‡ä»¶json.goå’Œtext.goè¡¨ç¤ºä¸¤ç§æ ¼å¼è¾“å‡ºï¼Œå¯¹åº”çš„TextFormatterå’ŒJsonFormatteræ˜¯å¯¹åº”çš„æ–‡æœ¬æ ¼å¼è¾“å‡ºæ–¹æ³•ï¼Œ

è¿™é‡Œå°±è´´å‡ºtext.goçš„å…·ä½“å®ç°ï¼Œå¾ˆç®€å•ï¼Œå…¶ä»–çš„å·®åˆ«ä¸å¤§ï¼Œå¯ä»¥å‚è€ƒ[G](https://github.com/gohade/coredemo/blob/geekbang/17/framework/provider/log/formatter/text.go)[it](https://github.com/gohade/coredemo/blob/geekbang/17/framework/provider/log/formatter/text.go)[H](https://github.com/gohade/coredemo/blob/geekbang/17/framework/provider/log/formatter/text.go)[ub](https://github.com/gohade/coredemo/blob/geekbang/17/framework/provider/log/formatter/text.go)ã€‚

```go
// TextFormatter è¡¨ç¤ºæ–‡æœ¬æ ¼å¼è¾“å‡º
func TextFormatter(level contract.LogLevel, t time.Time, msg string, fields map[string]interface{}) ([]byte, error) {
   bf := bytes.NewBuffer([]byte{})
   Separator := "\t"

   // å…ˆè¾“å‡ºæ—¥å¿—çº§åˆ«
   prefix := Prefix(level)

   bf.WriteString(prefix)
   bf.WriteString(Separator)

   // è¾“å‡ºæ—¶é—´
   ts := t.Format(time.RFC3339)
   bf.WriteString(ts)
   bf.WriteString(Separator)

   // è¾“å‡ºmsg
   bf.WriteString("\"")
   bf.WriteString(msg)
   bf.WriteString("\"")
   bf.WriteString(Separator)

   // è¾“å‡ºmap
   bf.WriteString(fmt.Sprint(fields))
   return bf.Bytes(), nil
}
```

å†å›åˆ° framework/provider/log/provider.goï¼Œå®šä¹‰æœåŠ¡æä¾›è€…çš„Paramsæ–¹æ³•ã€‚æ¯”å¦‚è·å–æ ¼å¼åŒ–æ–¹æ³•Formatterï¼Œæˆ‘ä»¬å°±è®¾å®šæˆï¼Œå…ˆåˆ¤æ–­åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œæ˜¯å¦å®šä¹‰äº†æœåŠ¡æä¾›è€…ï¼›å¦‚æœæ²¡æœ‰ï¼Œå†åˆ¤æ–­é…ç½®é¡¹log.formatteræ˜¯å¦æŒ‡å®šäº†æ ¼å¼åŒ–æ–¹æ³• json/textï¼Œè®¾ç½®æœ€ç»ˆçš„Formatterï¼Œå¹¶ä¸”ä¼ é€’å®ä¾‹åŒ–çš„æ–¹æ³•ã€‚

```go
// Params å®šä¹‰è¦ä¼ é€’ç»™å®ä¾‹åŒ–æ–¹æ³•çš„å‚æ•°
func (l *HadeLogServiceProvider) Params(c framework.Container) []interface{} {
   // è·å–configService
   configService := c.MustMake(contract.ConfigKey).(contract.Config)

   // è®¾ç½®å‚æ•°formatter
   if l.Formatter == nil {
      l.Formatter = formatter.TextFormatter
      if configService.IsExist("log.formatter") {
         v := configService.GetString("log.formatter")
         if v == "json" {
            l.Formatter = formatter.JsonFormatter
         } else if v == "text" {
            l.Formatter = formatter.TextFormatter
         }
      }
   }

   if l.Level == contract.UnknownLevel {
      l.Level = contract.InfoLevel
      if configService.IsExist("log.level") {
         l.Level = logLevel(configService.GetString("log.level"))
      }
   }

   // å®šä¹‰5ä¸ªå‚æ•°
   return []interface{}{c, l.Level, l.CtxFielder, l.Formatter, l.Output}
}
```

è‡³äºæ—¥å¿—æœåŠ¡æä¾›è€…çš„å…¶ä»–å‡ ä¸ªæ–¹æ³•ï¼ˆRegisterã€Bootã€IsDeferã€Nameï¼‰ï¼Œå°±ä¸åœ¨è¿™é‡Œè¯´æ˜äº†ï¼Œå¯ä»¥å‚è€ƒ[GitHub](https://github.com/gohade/coredemo/blob/geekbang/17/framework/provider/log/provider.go)ä¸Šçš„ä»£ç ã€‚

## æ—¥å¿—æœåŠ¡çš„å…·ä½“å®ç°

æœ€åå°±åˆ°å…·ä½“çš„æ—¥å¿—æœåŠ¡çš„å®ç°äº†ã€‚ä¸Šé¢æˆ‘ä»¬è¯´ï¼Œé’ˆå¯¹å››ç§ä¸åŒçš„è¾“å‡ºæ–¹å¼ï¼Œå®šä¹‰äº†å››ä¸ªä¸åŒçš„æœåŠ¡å®ä¾‹ï¼Œ**è¿™å››ä¸ªä¸åŒçš„æœåŠ¡å®ä¾‹éƒ½éœ€è¦å®ç°å‰é¢å®šä¹‰çš„æ—¥å¿—æœåŠ¡åè®®ã€‚å¦‚æœæ¯ä¸ªå®ä¾‹éƒ½å®ç°ä¸€éï¼Œè¿˜æ˜¯éå¸¸éº»çƒ¦çš„ã€‚è¿™é‡Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªæŠ€å·§ï¼šç±»å‹åµŒå¥—**ã€‚

æˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªé€šç”¨çš„æœåŠ¡å®ä¾‹HadeLogï¼Œåœ¨HadeLogä¸­å­˜æ”¾é€šç”¨çš„å­—æ®µï¼Œæ¯”å¦‚ä¸Šè¿°æ—¥å¿—æœåŠ¡æä¾›è€…ä¼ é€’çš„äº”ä¸ªå‚æ•°ï¼šcontainerã€levelã€ctxFielderã€formatterã€outputã€‚

åœ¨ provider/log/services/log.goä¸­å®šä¹‰è¿™ä¸ªç»“æ„ï¼š

```go
// HadeLog çš„é€šç”¨å®ä¾‹
type HadeLog struct {
   // äº”ä¸ªå¿…è¦å‚æ•°
   level      contract.LogLevel   // æ—¥å¿—çº§åˆ«
   formatter  contract.Formatter  // æ—¥å¿—æ ¼å¼åŒ–æ–¹æ³•
   ctxFielder contract.CtxFielder // ctxè·å–ä¸Šä¸‹æ–‡å­—æ®µ
   output     io.Writer           // è¾“å‡º
   c          framework.Container // å®¹å™¨
}
```

æ¥ç€åœ¨é€šç”¨å®ä¾‹ä¸­ï¼Œä½¿ç”¨è¿™å‡ ä¸ªå¿…è¦çš„å‚æ•°ï¼Œå°±èƒ½å®ç°æ—¥å¿—åè®®çš„æ‰€æœ‰æ¥å£äº†ï¼Œè¿™é‡Œå±•ç¤ºäº†Infoæ–¹æ³•æ˜¯æ€ä¹ˆæ‰“å°ä¿¡æ¯çš„ï¼š

```go
// Info ä¼šæ‰“å°å‡ºæ™®é€šçš„æ—¥å¿—ä¿¡æ¯
func (log *HadeLog) Info(ctx context.Context, msg string, fields map[string]interface{}) {
   log.logf(contract.InfoLevel, ctx, msg, fields)
}

// logf ä¸ºæ‰“å°æ—¥å¿—çš„æ ¸å¿ƒå‡½æ•°
func (log *HadeLog) logf(level contract.LogLevel, ctx context.Context, msg string, fields map[string]interface{}) error {
   // å…ˆåˆ¤æ–­æ—¥å¿—çº§åˆ«
   if !log.IsLevelEnable(level) {
      return nil
   }

   // ä½¿ç”¨ctxFielder è·å–contextä¸­çš„ä¿¡æ¯
   fs := fields
   if log.ctxFielder != nil {
      t := log.ctxFielder(ctx)
      if t != nil {
         for k, v := range t {
            fs[k] = v
         }
      }
   }

   ...

   // å°†æ—¥å¿—ä¿¡æ¯æŒ‰ç…§formatteråºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²
   if log.formatter == nil {
      log.formatter = formatter.TextFormatter
   }
   ct, err := log.formatter(level, time.Now(), msg, fs)
   if err != nil {
      return err
   }

   // å¦‚æœæ˜¯panicçº§åˆ«ï¼Œåˆ™ä½¿ç”¨logè¿›è¡Œpanic
   if level == contract.PanicLevel {
      pkgLog.Panicln(string(ct))
      return nil
   }

   // é€šè¿‡outputè¿›è¡Œè¾“å‡º
   log.output.Write(ct)
   log.output.Write([]byte("\r\n"))
   return nil
}
```

å¯ä»¥çœ‹åˆ°ï¼ŒInfoæ‰“å°æœ€ç»ˆè°ƒç”¨logf æ–¹æ³•ï¼Œè€Œlogfæ–¹æ³•çš„å®ç°æ­¥éª¤ä¹Ÿå¾ˆæ¸…æ™°ï¼Œç®€å•æ¢³ç†ä¸€ä¸‹ï¼š

- å…ˆåˆ¤æ–­æ—¥å¿—çº§åˆ«æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œå¦‚æœä¸ç¬¦åˆè¦æ±‚ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸è¿›è¡Œæ‰“å°ï¼›
- å†ä½¿ç”¨ctxFielderï¼Œä»contextä¸­è·å–ä¿¡æ¯æ”¾åœ¨ä¸Šä¸‹æ–‡å­—æ®µä¸­ï¼›
- æ¥ç€å°†æ—¥å¿—ä¿¡æ¯æŒ‰ç…§formatteråºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ï¼›
- æœ€åé€šè¿‡outputè¿›è¡Œè¾“å‡ºã€‚

HadeLogå…¶ä»–æ–¹æ³•çš„å®ç°å’ŒInfoå¤§åŒå°å¼‚ï¼Œè¿™é‡Œå°±ä¸å±•ç¤ºæ‰€æœ‰ä»£ç äº†ã€‚å®ç°äº†åŸºç¡€çš„HadeLogå®ä¾‹ï¼Œæ¥ä¸‹æ¥ï¼Œå°±å®ç°å¯¹åº”çš„å››ä¸ªä¸åŒè¾“å‡ºç±»å‹çš„å®ä¾‹HadeConsoleLogã€HadeSingleLogã€HadeRotateLogã€HadeCustomLogã€‚  
![](https://static001.geekbang.org/resource/image/f2/a5/f2a9c4d54dyy468f00ce97f8888049a5.jpg?wh=1920x1080)

è¿™é‡Œå››ä¸ªå…·ä½“å®ä¾‹ä½¿ç”¨ç±»å‹åµŒå¥—çš„æ–¹å¼ï¼Œå°±èƒ½è‡ªåŠ¨æ‹¥æœ‰HadeLogå·²ç»å®ç°äº†çš„é‚£äº›æ–¹æ³•ã€‚

æ¯”å¦‚åœ¨ framework/provider/log/service/console.log ä¸­ï¼Œä½¿ç”¨ç±»å‹åµŒå¥—å®ç° HadeConsoleLogï¼š

```go
// HadeConsoleLog ä»£è¡¨æ§åˆ¶å°è¾“å‡º
type HadeConsoleLog struct {
   // ç±»å‹åµŒå¥—HadeLog
   HadeLog
}
```

ç›¸å½“äº HadeConsoleLog å°±å·²ç»å®ç°äº†æ—¥å¿—æœåŠ¡åè®®äº†ã€‚æˆ‘ä»¬å”¯ä¸€è¦åšçš„å°±æ˜¯åœ¨å®ä¾‹åŒ–HadeConosoleLogçš„æ—¶å€™ï¼Œå°†åŸºç¡€HadeLogä¸­çš„é€šç”¨å­—æ®µè¿›è¡Œå¡«å……ã€‚æ¯”å¦‚ HadeConsoleLog æœ€é‡è¦å°±æ˜¯å°†è¾“å‡ºç±»å‹outputè®¾ç½®ä¸ºæ§åˆ¶å°os.stdoutï¼š

```go
// NewHadeConsoleLog å®ä¾‹åŒ–HadeConsoleLog
func NewHadeConsoleLog(params ...interface{}) (interface{}, error) {
   c := params[0].(framework.Container)
   level := params[1].(contract.LogLevel)
   ctxFielder := params[2].(contract.CtxFielder)
   formatter := params[3].(contract.Formatter)

   log := &HadeConsoleLog{}

   log.SetLevel(level)
   log.SetCtxFielder(ctxFielder)
   log.SetFormatter(formatter)

   // æœ€é‡è¦çš„å°†å†…å®¹è¾“å‡ºåˆ°æ§åˆ¶å°
   log.SetOutput(os.Stdout)
   log.c = c
   return log, nil
}
```

å››ç§è¾“å‡ºæ–‡ä»¶å…¶å®éƒ½å¤§åŒå°å¼‚ï¼Œè¿™é‡Œå°±æŒ‘é€‰ä¸€ä¸ªæœ€å¤æ‚çš„å¸¦æœ‰æ—¥å¿—åˆ‡å‰²çš„HadeRotateLogæ¥è®²è§£ã€‚

Golangä¸­æ—¥å¿—åˆ‡å‰²æœ‰ä¸ªéå¸¸å¥½ç”¨çš„ [file-rotatelogs](https://github.com/lestrrat-go/file-rotatelogs)ï¼Œè¿™ä¸ªåº“çš„ä½¿ç”¨æ–¹æ³•ä¹Ÿä¸å¤æ‚ï¼Œæœ€æ ¸å¿ƒçš„å°±æ˜¯ä¸€ä¸ªåˆå§‹åŒ–æ“ä½œNewï¼š

```go
func New(p string, options ...Option) (*RotateLogs, error) 
```

å®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°pæ˜¯å¸¦ç›®å½•çš„æ—¥å¿—åœ°å€ï¼Œå¯ä»¥å…è®¸æœ‰é€šé…ç¬¦ä»£è¡¨æ—¥æœŸçš„æ—¥å¿—æ–‡ä»¶åã€‚è¿™é‡Œçš„é€šé…ç¬¦ç¬¦åˆLinuxçš„strftimeçš„å®šä¹‰ï¼Œå…·ä½“å“ªä¸ªé€šé…ç¬¦ä»£è¡¨æ—¥æœŸã€å°æ—¶ã€åˆ†é’Ÿç­‰å¯ä»¥å‚è€ƒstrftimeçš„[æ–‡æ¡£è¯´æ˜](https://man7.org/linux/man-pages/man3/strftime.3.html)ã€‚è€Œç¬¬äºŒä¸ªå‚æ•°æ˜¯Optionæ•°ç»„ï¼Œè¡¨ç¤ºè¿™ä¸ªåˆ‡å‰²æ—¥å¿—çš„ä¸€äº›é…ç½®ï¼Œæ¯”å¦‚å¤šä¹…åˆ‡å‰²ä¸€æ¬¡æ—¥å¿—æ–‡ä»¶ã€åˆ‡å‰²åçš„æ—¥å¿—æ–‡ä»¶ä¿å­˜å¤šå°‘å¤©ç­‰ã€‚

ä½¿ç”¨å¾ˆç®€å•ï¼Œç›´æ¥çœ‹æˆ‘ä»¬å¯¹HadeRotateLogçš„å…·ä½“å®ç°ã€‚å¤§è‡´æ€è·¯å°±æ˜¯**å…ˆå®šä¹‰ç»“æ„ï¼Œå†å®ç°åˆå§‹åŒ–æ–¹æ³•ï¼Œåœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å®ä¾‹åŒ–file-rotatelogsçš„åˆå§‹åŒ–æ“ä½œNew**ã€‚

é¦–å…ˆå®šä¹‰äº† HadeRotateLog çš„ç»“æ„ï¼Œå…¶ä¸­åµŒå¥—äº†åŸºç¡€å®ä¾‹ç»“æ„HadeLogï¼ŒåŒæ—¶æœ‰è¿™ä¸ªç»“æ„ç‰¹å®šçš„å­—æ®µfolderå’Œfileï¼š

```go
// HadeRotateLog ä»£è¡¨ä¼šè¿›è¡Œåˆ‡å‰²çš„æ—¥å¿—æ–‡ä»¶å­˜å‚¨
type HadeRotateLog struct {
   HadeLog
   // æ—¥å¿—æ–‡ä»¶å­˜å‚¨ç›®å½•
   folder string
   // æ—¥å¿—æ–‡ä»¶å
   file string
}
```

å®ä¾‹åŒ–çš„NewHadeRotateLog å…ˆè·å–å‚æ•°ï¼Œç„¶åä»é…ç½®æ–‡ä»¶ä¸­è·å–å‚æ•°å±æ€§folderã€fileã€date\_formatã€rotate\_countã€rotate\_sizeã€max\_ageã€rotate\_timeï¼Œè¿™äº›å±æ€§éƒ½å’Œ file-rotatelogs åº“å®ä¾‹åŒ–çš„Optionå‚æ•°ä¸€ä¸€å¯¹åº”ã€‚

æ‰€ä»¥è¿™é‡Œä¹Ÿå±•ç¤ºä¸€ä¸‹æˆ‘ä»¬çš„log.yamlé…ç½®æ–‡ä»¶å¯é…ç½®çš„rotateï¼š

```yaml
driver: rotate # åˆ‡å‰²æ—¥å¿—
level: trace # æ—¥å¿—çº§åˆ«
file: coredemo.log # ä¿å­˜çš„æ—¥å¿—æ–‡ä»¶
rotate_count: 10  # æœ€å¤šæ—¥å¿—æ–‡ä»¶ä¸ªæ•°
rotate_size: 120000 # æ¯ä¸ªæ—¥å¿—å¤§å°
rotate_time: "1m" # åˆ‡å‰²æ—¶é—´
max_age: "10d" # æ–‡ä»¶ä¿å­˜æ—¶é—´
date_format: "%Y-%m-%d-%H-%M" # æ–‡ä»¶åç¼€æ ¼å¼
```

å†å›åˆ° NewHadeRotateLogï¼Œè®¾ç½®äº†è¿™äº›é…ç½®å±æ€§ä¹‹åï¼Œæˆ‘ä»¬å®ä¾‹åŒ– file-rotatelogsï¼Œå¾—åˆ°äº†ä¸€ä¸ªç¬¦åˆio.Writerçš„è¾“å‡ºï¼Œå°†è¿™ä¸ªè¾“å‡ºä½¿ç”¨ SetOutput è®¾ç½®åˆ°åµŒå¥—çš„ HadeLog ä¸­å³å¯ã€‚

```go
// NewHadeRotateLog å®ä¾‹åŒ–HadeRotateLog
func NewHadeRotateLog(params ...interface{}) (interface{}, error) {
   // å‚æ•°è§£æ
   c := params[0].(framework.Container)
   level := params[1].(contract.LogLevel)
   ctxFielder := params[2].(contract.CtxFielder)
   formatter := params[3].(contract.Formatter)

   appService := c.MustMake(contract.AppKey).(contract.App)
   configService := c.MustMake(contract.ConfigKey).(contract.Config)

   // ä»é…ç½®æ–‡ä»¶ä¸­è·å–folderä¿¡æ¯ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤çš„LogFolderæ–‡ä»¶å¤¹
   folder := appService.LogFolder()
   if configService.IsExist("log.folder") {
      folder = configService.GetString("log.folder")
   }
   // å¦‚æœfolderä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º
   if !util.Exists(folder) {
      os.MkdirAll(folder, os.ModePerm)
   }

   // ä»é…ç½®æ–‡ä»¶ä¸­è·å–fileä¿¡æ¯ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤çš„hade.log
   file := "hade.log"
   if configService.IsExist("log.file") {
      file = configService.GetString("log.file")
   }

   // ä»é…ç½®æ–‡ä»¶è·å–date_formatä¿¡æ¯
   dateFormat := "%Y%m%d%H"
   if configService.IsExist("log.date_format") {
      dateFormat = configService.GetString("log.date_format")
   }

   linkName := rotatelogs.WithLinkName(filepath.Join(folder, file))
   options := []rotatelogs.Option{linkName}

   // ä»é…ç½®æ–‡ä»¶è·å–rotate_countä¿¡æ¯
   if configService.IsExist("log.rotate_count") {
      rotateCount := configService.GetInt("log.rotate_count")
      options = append(options, rotatelogs.WithRotationCount(uint(rotateCount)))
   }

   // ä»é…ç½®æ–‡ä»¶è·å–rotate_sizeä¿¡æ¯
   if configService.IsExist("log.rotate_size") {
      rotateSize := configService.GetInt("log.rotate_size")
      options = append(options, rotatelogs.WithRotationSize(int64(rotateSize)))
   }

   // ä»é…ç½®æ–‡ä»¶è·å–max_ageä¿¡æ¯
   if configService.IsExist("log.max_age") {
      if maxAgeParse, err := time.ParseDuration(configService.GetString("log.max_age")); err == nil {
         options = append(options, rotatelogs.WithMaxAge(maxAgeParse))
      }
   }

   // ä»é…ç½®æ–‡ä»¶è·å–rotate_timeä¿¡æ¯
   if configService.IsExist("log.rotate_time") {
      if rotateTimeParse, err := time.ParseDuration(configService.GetString("log.rotate_time")); err == nil {
         options = append(options, rotatelogs.WithRotationTime(rotateTimeParse))
      }
   }

   // è®¾ç½®åŸºç¡€ä¿¡æ¯
   log := &HadeRotateLog{}
   log.SetLevel(level)
   log.SetCtxFielder(ctxFielder)
   log.SetFormatter(formatter)
   log.folder = folder
   log.file = file

   w, err := rotatelogs.New(fmt.Sprintf("%s.%s", filepath.Join(log.folder, log.file), dateFormat), options...)
   if err != nil {
      return nil, errors.Wrap(err, "new rotatelogs error")
   }
   log.SetOutput(w)
   log.c = c
   return log, nil
}
```

æœ¬èŠ‚è¯¾æˆ‘ä»¬åªæ˜¯ä¿®æ”¹äº†æ¡†æ¶ç›®å½•ä¸­çš„æ—¥å¿—æœåŠ¡ç›¸å…³çš„æ–‡ä»¶ã€‚æ–‡ä»¶ç›®å½•ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/8c/a8/8c305493bba44f8787efecdf1a8694a8.png?wh=404x512)

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/e7/2e/e78a3a67060e989616fa0440bd792d2e.png?wh=630x1122)

æ‰€æœ‰ä»£ç éƒ½æ”¾åœ¨GitHubä¸Šçš„ [geekbang/17](https://github.com/gohade/coredemo/tree/geekbang/17) åˆ†æ”¯ï¼Œæ¬¢è¿æ¯”å¯¹æŸ¥çœ‹ã€‚

## å°ç»“

æˆ‘ä»¬è¿™èŠ‚è¯¾é€šè¿‡å®šä¹‰äº†æ—¥å¿—çº§åˆ«ã€æ—¥å¿—æ ¼å¼ã€æ—¥å¿—è¾“å‡ºï¼Œæ¥å®ç°äº†æ—¥å¿—çš„çº§åˆ«ï¼Œå¹¶ä¸”ä½¿ç”¨ç±»å‹åµŒå¥—æ–¹æ³•å®ç°äº†å››ç§æœ¬åœ°æ—¥å¿—è¾“å‡ºæ–¹å¼ã€‚

å›é¡¾ä»Šå¤©å®ç°çš„æ—¥å¿—æœåŠ¡ï¼Œä½ ä¼šå‘ç°å’Œå…¶ä»–æœåŠ¡çš„å®ç°æ€è·¯æ˜¯å·®ä¸å¤šçš„ã€‚æˆ‘ä»¬**åœ¨ä¸€ä¸ªæœåŠ¡ä¸­ï¼Œå®ç°äº†å¤šä¸ªå®ç°ç±»ï¼Œä½†æ˜¯æ‰€æœ‰çš„å®ç°ç±»éƒ½å®ç°äº†åŒæ ·çš„æœåŠ¡æ¥å£**ï¼Œæœ€åèƒ½è®©æˆ‘ä»¬æ ¹æ®é…ç½®æ¥å†³å®šè¿™ä¸ªæœåŠ¡ä½¿ç”¨å“ªä¸ªå®ç°ç±»ï¼Œå…¶ä¸­è¿˜ä½¿ç”¨äº†åµŒå¥—æ–¹å¼ï¼Œèƒ½èŠ‚çœå¤§é‡é‡å¤æ€§çš„ä»£ç ã€‚

å¸Œæœ›ä½ èƒ½ç†Ÿç»ƒæŒæ¡è¿™ç§å®ç°æ–¹å¼ï¼Œå› ä¸ºæˆ‘ä»¬çš„æœåŠ¡ä¼šè¶Šæ¥è¶Šå¤šï¼Œè¶Šä¸Šå±‚çš„æœåŠ¡ï¼Œæ¯”å¦‚æ•°æ®åº“ã€ç¼“å­˜ï¼Œå®ƒçš„å…·ä½“å®ç°å°±è¶Šæ˜¯å¤šç§å¤šæ ·ï¼Œåˆ°æ—¶å€™æˆ‘ä»¬éƒ½å¯ä»¥ç”¨åŒæ ·çš„å¥—è·¯æ¥è¿›è¡Œã€‚

## æ€è€ƒé¢˜

åœ¨å¾®æœåŠ¡ç››è¡Œçš„ä»Šå¤©ï¼Œå…¨é“¾è·¯æ—¥å¿—æ˜¯éå¸¸é‡è¦çš„ä¸€ä¸ªéœ€æ±‚ã€‚å…¨é“¾è·¯æ—¥å¿—çš„éœ€æ±‚æœ¬è´¨å°±æ˜¯åœ¨æ—¥å¿—ä¸­å¢åŠ trace\_idã€span\_id è¿™æ ·çš„é“¾è·¯å­—æ®µã€‚å…·ä½“å®ç°æœ‰ä¸‰ç‚¹ï¼š

- åœ¨æ¥æ”¶è¯·æ±‚çš„æ—¶å€™ï¼Œä»è¯·æ±‚requestä¸­è§£æå…¨é“¾è·¯å­—æ®µï¼Œå­˜æ”¾è¿›å…¥contextä¸­
- åœ¨æ‰“å°æ—¥å¿—çš„æ—¶å€™ä»contextä¸­è·å–å…¨é“¾è·¯å­—æ®µåºåˆ—åŒ–è¿›å…¥æ—¥å¿—
- åœ¨å‘é€è¯·æ±‚çš„æ—¶å€™å°†å…¨é“¾è·¯å­—æ®µåŠ å…¥åˆ°requestä¸­

ä½ å¯ä»¥æ€è€ƒä¸‹è¿™ä¸ªåŠŸèƒ½åº”è¯¥æ€ä¹ˆå®ç°ï¼Ÿ

æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒã€‚æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œå¦‚æœè§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·å­¦ä¹ ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ5ï¼‰</strong></div><ul>
<li><span>qinsi</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>æ¥æ”¶ä¸‹æ¸¸è¯·æ±‚å’Œè¿”å›å“åº”æ—¶æ‰“å°æ—¥å¿—å¯ä»¥åœ¨ä¸­é—´ä»¶ä¸­è§£å†³ï¼Œå‘ä¸Šæ¸¸å‘é€è¯·æ±‚æ—¶æ‰“å°æ—¥å¿—å¯èƒ½éœ€è¦æ¡†æ¶æä¾›ä¸€ç§æ–¹æ³•æˆªè·è¯·æ±‚å¹¶å‘å…¶ä¸­æ³¨å…¥traceä¿¡æ¯ï¼Œæˆ–è€…æ˜¯è‡ªè¡Œå°è£…ä¸€ä¸ªhttpè¯·æ±‚æœåŠ¡</p>2021-10-25</li><br/><li><span>Charles</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ—¥å¿—è¾“å‡ºçš„åŸç†è®²çš„å¾ˆç»†ï¼Œå—ç›ŠåŒªæµ…ã€‚ç”¨ä½œè€…çš„æºç åˆ‡æ¢æ—¥å¿—è¾“å‡ºç±»å‹å’‹æ²¡æœ‰æ•ˆæœ</p>2022-04-10</li><br/><li><span>Geek_78dacc</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å°†log.SetOutputè®¾ç½®ä¸ºæ–‡ä»¶ï¼Œç¨‹åºä¸­æ­£å¸¸çš„infoï¼Œdebugæ—¥å¿—éƒ½å¯ä»¥è®°å½•è‡³è¯¥æ–‡ä»¶ä¸­ã€‚ä½†æ˜¯å½“ç¨‹åºå‡ºç°panicæ—¶ï¼Œå´ä¸èƒ½è®°å½•panicæ—¥å¿—ã€‚è¯·é—®è¿™ä¸ªæ˜¯ä¸ºä»€ä¹ˆå‘€ï¼Ÿé™¤äº†åœ¨æ¯æ¬¡go funcï¼ˆï¼‰æ—¶ï¼Œæ‰‹åŠ¨æ•æ‰panicå¹¶æ˜¾å¼æ‰“å°æ—¥å¿—å¤–ï¼Œè¿˜æœ‰ä»€ä¹ˆæ›´åŠ ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆå—ï¼Ÿ</p>2022-02-24</li><br/><li><span>chongsheng</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è¿™å—è²Œä¼¼æ²¡æœ‰å®ç°é…ç½®çƒ­æ›´æ–°ã€‚å¸¸è§çš„éœ€æ±‚æ˜¯æ—¥å¿—çº§åˆ«çš„çƒ­æ›´æ–°</p>2022-02-22</li><br/><li><span>ç‰›ç‰å¯Œ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å®šåˆ¶åŒ–çš„æ—¥å¿—åŠŸèƒ½å°±å¾—åƒè¿™æ ·ï¼ŒæŠŠæ¯ä¸ªç»†èŠ‚éƒ½å±•å¼€æ¢³ç†æ¸…äº†æ‰èƒ½åŠ¨æ‰‹ã€‚å¯¹æ—¥å¿—æ„Ÿè§¦æŒºæ·±çš„æ˜¯è°ƒç”¨äº†ä¸ªç¬¬ä¸‰æ–¹ç±»åº“ä¿®æ”¹éº»çƒ¦è‡³æã€‚ç´¢æ€§æœ€åè‡ªå·±å®ç°äº†ã€‚</p>2022-01-13</li><br/>
</ul>