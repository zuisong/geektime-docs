ä½ å¥½ï¼Œæˆ‘æ˜¯è½©è„‰åˆƒã€‚

ä¸Šä¸€è®²ï¼Œæˆ‘ä»¬å°è£…äº†æ¡†æ¶çš„Contextï¼Œ å°†è¯·æ±‚ç»“æ„ request å’Œè¿”å›ç»“æ„ responseWriter éƒ½å°è£…åœ¨ Context ä¸­ã€‚åˆ©ç”¨è¿™ä¸ª Contextï¼Œ æˆ‘ä»¬å°†æ§åˆ¶å™¨ç®€åŒ–ä¸ºå¸¦æœ‰ä¸€ä¸ªå‚æ•°çš„å‡½æ•°FooControllerHandlerï¼Œè¿™ä¸ªæ§åˆ¶å™¨å‡½æ•°çš„è¾“å…¥å’Œè¾“å‡ºéƒ½æ˜¯å›ºå®šçš„ã€‚åœ¨æ¡†æ¶å±‚é¢ï¼Œæˆ‘ä»¬ä¹Ÿå®šä¹‰äº†å¯¹åº”å…³äºæ§åˆ¶å™¨çš„æ–¹æ³•ç»“æ„ControllerHandleræ¥ä»£è¡¨è¿™ç±»æ§åˆ¶å™¨çš„å‡½æ•°ã€‚

æ¯ä¸€ä¸ªè¯·æ±‚é€»è¾‘ï¼Œéƒ½æœ‰ä¸€ä¸ªæ§åˆ¶å™¨ControllerHandlerä¸ä¹‹å¯¹åº”ã€‚é‚£ä¹ˆä¸€ä¸ªè¯·æ±‚ï¼Œå¦‚ä½•æŸ¥æ‰¾åˆ°æŒ‡å®šçš„æ§åˆ¶å™¨å‘¢ï¼Ÿè¿™å°±æ˜¯ä»Šå¤©è¦ç ”ç©¶çš„å†…å®¹ï¼šè·¯ç”±ï¼Œæˆ‘å°†å¸¦ä½ ç†è§£è·¯ç”±ï¼Œå¹¶ä¸”å®ç°ä¸€ä¸ªé«˜æ•ˆã€æ˜“ç”¨çš„è·¯ç”±æ¨¡å—ã€‚

## è·¯ç”±è®¾è®¡æ€è·¯

ç›¸ä¿¡ä½ å¯¹è·¯ç”±æ˜¯å¹²å•¥çš„å·²ç»æœ‰å¤§è‡´äº†è§£ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯è®© Web æœåŠ¡å™¨æ ¹æ®è§„åˆ™ï¼Œç†è§£ HTTP è¯·æ±‚ä¸­çš„ä¿¡æ¯ï¼ŒåŒ¹é…æŸ¥æ‰¾å‡ºå¯¹åº”çš„æ§åˆ¶å™¨ï¼Œå†å°†è¯·æ±‚ä¼ é€’ç»™æ§åˆ¶å™¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œ**ç®€å•æ¥è¯´å°±æ˜¯åˆ¶å®šåŒ¹é…è§„åˆ™**ã€‚

![](https://static001.geekbang.org/resource/image/11/7b/11dee96201a6f32358d8cceced0f137b.jpg?wh=1920x1080)

ä½†æ˜¯å°±æ˜¯è¿™ä¹ˆç®€å•çš„åŠŸèƒ½ï¼Œ**è·¯ç”±çš„è®¾è®¡æ„Ÿä¸åŒï¼Œå¯ç”¨æ€§æœ‰å¤©å£¤ä¹‹åˆ«**ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Œæˆ‘ä»¬å¸¦ç€è¿™ä¸ªé—®é¢˜ï¼Œå…ˆæ¥æ¢³ç†ä¸€ä¸‹åˆ¶å®šè·¯ç”±è§„åˆ™éœ€è¦çš„ä¿¡æ¯ã€‚

è·¯ç”±å¯ä»¥ä½¿ç”¨HTTPè¯·æ±‚ä½“ä¸­çš„å“ªäº›ä¿¡æ¯ï¼Œå¾—å›é¡¾æˆ‘ä»¬ç¬¬ä¸€èŠ‚è¯¾è®² HTTP çš„å†…å®¹ã€‚

ä¸€ä¸ª HTTP è¯·æ±‚åŒ…å«è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“ã€‚è¯·æ±‚ä½“å†…ä¸€èˆ¬å­˜æ”¾çš„æ˜¯è¯·æ±‚çš„ä¸šåŠ¡æ•°æ®ï¼Œæ˜¯åŸºäºå…·ä½“æ§åˆ¶ä¸šåŠ¡éœ€è¦çš„ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸ä¼šç”¨æ¥åšè·¯ç”±ã€‚

è€Œè¯·æ±‚å¤´ä¸­å­˜æ”¾çš„æ˜¯å’Œè¯·æ±‚çŠ¶æ€æœ‰å…³çš„ä¿¡æ¯ï¼Œæ¯”å¦‚User-Agent ä»£è¡¨çš„æ˜¯è¯·æ±‚çš„æµè§ˆå™¨ä¿¡æ¯ï¼ŒAcceptä»£è¡¨çš„æ˜¯æ”¯æŒè¿”å›çš„æ–‡æœ¬ç±»å‹ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ ‡å‡†è¯·æ±‚å¤´çš„ç¤ºä¾‹ï¼š

```xml
GET /home.html HTTP/1.1
Host: developer.mozilla.org
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:50.0) Gecko/20100101 Firefox/50.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Referer: https://developer.mozilla.org/testpage.html
```

æ¯ä¸€è¡Œçš„ä¿¡æ¯å’Œå«ä¹‰éƒ½æ˜¯éå¸¸å¤§çš„è¯¾é¢˜ï¼Œä¹Ÿä¸ä»Šå¤©è¦è®²çš„å†…å®¹æ— å…³ï¼Œæˆ‘ä»¬è¿™é‡Œè¦å…³æ³¨çš„æ˜¯ HTTP è¯·æ±‚çš„ç¬¬ä¸€è¡Œï¼Œå«åš Request Lineï¼Œç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š**Methodã€Request-URI å’Œ HTTP-Version**ï¼ˆ[RFC2616](https://datatracker.ietf.org/doc/html/rfc2616)ï¼‰ã€‚

![](https://static001.geekbang.org/resource/image/7b/d7/7bd9061513922ff9e748f4ed90422dd7.jpg?wh=1920x1080)

Method æ˜¯HTTPçš„æ–¹æ³•ï¼Œæ ‡è¯†å¯¹æœåŠ¡ç«¯èµ„æºçš„æ“ä½œå±æ€§ã€‚å®ƒåŒ…å«å¤šä¸ªæ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½ä»£è¡¨ä¸åŒçš„æ“ä½œå±æ€§ã€‚

```xml
       Method         = "OPTIONS"                ; Section 9.2
                      | "GET"                    ; Section 9.3
                      | "HEAD"                   ; Section 9.4
                      | "POST"                   ; Section 9.5
                      | "PUT"                    ; Section 9.6
                      | "DELETE"                 ; Section 9.7
                      | "TRACE"                  ; Section 9.8
                      | "CONNECT"                ; Section 9.9
                      | extension-method
       extension-method = token
```

Request-URIæ˜¯è¯·æ±‚è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯æµè§ˆå™¨è¯·æ±‚åœ°å€ä¸­åŸŸåå¤–çš„å‰©ä½™éƒ¨åˆ†ã€‚

![](https://static001.geekbang.org/resource/image/a8/ac/a8ca2560e0096b2e364f569079496eac.jpg?wh=1920x1080)

HTTP-Version æ˜¯ HTTP çš„åè®®ç‰ˆæœ¬ï¼Œç›®å‰å¸¸è§çš„æœ‰1.0ã€1.1ã€2.0ã€‚

Web Service åœ¨è·¯ç”±ä¸­ä½¿ç”¨çš„å°±æ˜¯Methodå’ŒRequest-URIè¿™ä¸¤ä¸ªéƒ¨åˆ†ã€‚äº†è§£åˆ¶å®šè·¯ç”±è§„åˆ™æ—¶ï¼Œè¯·æ±‚ä½“ä¸­å¯ä»¥ä½¿ç”¨çš„å…ƒç´ ä¹‹åï¼Œæˆ‘ä»¬å†å›ç­”åˆšæ‰çš„é—®é¢˜ï¼Œä»€ä¹ˆæ˜¯è·¯ç”±çš„è®¾è®¡æ„Ÿã€‚

è¿™é‡Œè¯´çš„è®¾è®¡æ„ŸæŒ‡çš„æ˜¯ï¼š**æ¡†æ¶è®¾è®¡è€…å¸Œæœ›ä½¿ç”¨è€…å¦‚ä½•ç”¨è·¯ç”±æ¨¡å—**ã€‚

å¦‚æœæ¡†æ¶æ”¯æŒRESTé£æ ¼çš„è·¯ç”±è®¾è®¡ï¼Œé‚£ä¹ˆä½¿ç”¨è€…åœ¨å†™ä¸šåŠ¡ä»£ç çš„æ—¶å€™ï¼Œå°±å€¾å‘äºè®¾è®¡RESTé£æ ¼çš„æ¥å£ï¼›å¦‚æœæ¡†æ¶æ”¯æŒå‰ç¼€åŒ¹é…ï¼Œé‚£ä¹ˆä½¿ç”¨è€…åœ¨å®šåˆ¶URIçš„æ—¶å€™ï¼Œä¹Ÿä¼šå€¾å‘äºæŠŠåŒç±»å‹çš„URIå½’ä¸ºä¸€ç±»ã€‚

è¿™äº›è®¾è®¡æƒ³æ³•é€šé€šä¼š**ä½“ç°åœ¨æ¡†æ¶çš„è·¯ç”±è§„åˆ™ä¸Šï¼Œæœ€ç»ˆå½±å“æ¡†æ¶ä½¿ç”¨è€…çš„ç ”å‘ä¹ æƒ¯**ï¼Œè¿™ä¸ªå°±æ˜¯è®¾è®¡æ„Ÿã€‚æ‰€ä»¥å…¶å®ï¼Œè®¾è®¡æ„Ÿå’Œæ¡†æ¶è®¾è®¡è€…åå¥½çš„ç ”å‘é£æ ¼ç›´æ¥ç›¸å…³ï¼Œä¹Ÿæ²¡æœ‰ç»å¯¹çš„ä¼˜åŠ£ã€‚

è¿™é‡Œä½ å¾ˆå®¹æ˜“èµ°å…¥è¯¯åŒºï¼Œæˆ‘è¦è¯´æ˜ä¸€ä¸‹ã€‚å¾ˆå¤šåŒå­¦è®¤ä¸ºè®¾è®¡æ„Ÿçš„å¥½åä½“ç°åœ¨è·¯ç”±è§„åˆ™çš„å¤šå°‘ä¸Šï¼Œå…¶å®ä¸æ˜¯ã€‚

è·¯ç”±è§„åˆ™ï¼Œæ˜¯æ ¹æ®è·¯ç”±æ¥æŸ¥æ‰¾æ§åˆ¶å™¨çš„é€»è¾‘ï¼Œå®ƒæœ¬èº«å°±æ˜¯ä¸€ä¸ªæ¡†æ¶éœ€æ±‚ã€‚æˆ‘ä»¬å¯ä»¥å¤©é©¬è¡Œç©ºè®¾æƒ³100æ¡è·¯ç”±è§„åˆ™ï¼Œå¹¶ä¸”å…¨éƒ¨å®ç°å®ƒï¼Œä¹Ÿå¯ä»¥åªè®¾è®¡1ã€2ä¸ªæœ€ç®€å•çš„è·¯ç”±è§„åˆ™ã€‚å¾ˆå¤šæˆ–è€…å¾ˆå°‘çš„è·¯ç”±è§„åˆ™ï¼Œéƒ½ä¸ä¼šæ ¹æœ¬æ€§å½±å“ä½¿ç”¨è€…ï¼Œæ‰€ä»¥ï¼Œå¹¶ä¸æ˜¯è¡¡é‡ä¸€ä¸ªæ¡†æ¶å¥½åçš„æ ‡å‡†ã€‚

## è·¯ç”±è§„åˆ™çš„éœ€æ±‚

å›åˆ°æˆ‘ä»¬çš„æ¡†æ¶ï¼Œå¼€å¤´æˆ‘ä»¬è¯´è¿‡å¸Œæœ›ä½¿ç”¨è€…é«˜æ•ˆã€æ˜“ç”¨åœ°ä½¿ç”¨è·¯ç”±æ¨¡å—ï¼Œé‚£å‡ºäºè¿™ä¸€ç‚¹è€ƒè™‘ï¼ŒåŸºæœ¬éœ€æ±‚å¯ä»¥æœ‰å“ªäº›å‘¢ï¼Ÿ

æŒ‰ç…§ä»ç®€å•åˆ°å¤æ‚æ’åºï¼Œè·¯ç”±éœ€æ±‚æˆ‘æ•´ç†æˆä¸‹é¢å››ç‚¹ï¼š

- **éœ€æ±‚1ï¼šHTTPæ–¹æ³•åŒ¹é…**

æ—©æœŸçš„ WebService æ¯”è¾ƒç®€å•ï¼ŒHTTP è¯·æ±‚ä½“ä¸­çš„ Request Line æˆ–è®¸åªä¼šä½¿ç”¨åˆ° Request-URI éƒ¨åˆ†ï¼Œä½†æ˜¯éšç€ REST é£æ ¼ WebService çš„æµè¡Œï¼Œä¸ºäº†è®© URI æ›´å…·å¯è¯»æ€§ï¼Œåœ¨ç°åœ¨çš„è·¯ç”±è¾“å…¥ä¸­ï¼ŒHTTP Method ä¹Ÿæ˜¯å¾ˆé‡è¦çš„ä¸€éƒ¨åˆ†äº†ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬æ¡†æ¶ä¹Ÿéœ€è¦æ”¯æŒå¤šç§ HTTP Methodï¼Œæ¯”å¦‚GETã€POSTã€PUTã€DELETEã€‚

- **éœ€æ±‚2ï¼šé™æ€è·¯ç”±åŒ¹é…**

é™æ€è·¯ç”±åŒ¹é…æ˜¯ä¸€ä¸ªè·¯ç”±çš„åŸºæœ¬åŠŸèƒ½ï¼ŒæŒ‡çš„æ˜¯è·¯ç”±è§„åˆ™ä¸­æ²¡æœ‰å¯å˜å‚æ•°ï¼Œå³è·¯ç”±è§„åˆ™åœ°å€æ˜¯å›ºå®šçš„ï¼Œä¸Request-URI å®Œå…¨åŒ¹é…ã€‚

æˆ‘ä»¬åœ¨ç¬¬ä¸€è®²ä¸­æåˆ°çš„DefaultServerMuxè¿™ä¸ªè·¯ç”±å™¨ï¼Œä»å†…éƒ¨çš„ map ä¸­ç›´æ¥æ ¹æ® key å¯»æ‰¾ value ï¼Œè¿™ç§æŸ¥æ‰¾è·¯ç”±çš„æ–¹å¼å°±æ˜¯é™æ€è·¯ç”±åŒ¹é…ã€‚

- **éœ€æ±‚3ï¼šæ‰¹é‡é€šç”¨å‰ç¼€**

å› ä¸ºä¸šåŠ¡æ¨¡å—çš„åˆ’åˆ†ï¼Œæˆ‘ä»¬ä¼šåŒæ—¶ä¸ºæŸä¸ªä¸šåŠ¡æ¨¡å—æ³¨å†Œä¸€æ‰¹è·¯ç”±ï¼Œæ‰€ä»¥åœ¨è·¯ç”±æ³¨å†Œè¿‡ç¨‹ä¸­ï¼Œä¸ºäº†è·¯ç”±çš„å¯è¯»æ€§ï¼Œä¸€èˆ¬ä¹ æƒ¯ç»Ÿä¸€å®šä¹‰è¿™æ‰¹è·¯ç”±çš„é€šç”¨å‰ç¼€ã€‚æ¯”å¦‚ /user/infoã€/user/login éƒ½æ˜¯ä»¥ /user å¼€å¤´ï¼Œå¾ˆæ–¹ä¾¿ä½¿ç”¨è€…äº†è§£é¡µé¢æ‰€å±æ¨¡å—ã€‚

æ‰€ä»¥å¦‚æœè·¯ç”±æœ‰èƒ½åŠ›ç»Ÿä¸€å®šä¹‰æ‰¹é‡çš„é€šç”¨å‰ç¼€ï¼Œé‚£ä¹ˆåœ¨æ³¨å†Œè·¯ç”±çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå¸¦æ¥å¾ˆå¤§çš„ä¾¿åˆ©ã€‚

- **éœ€æ±‚4ï¼šåŠ¨æ€è·¯ç”±åŒ¹é…**

è¿™ä¸ªéœ€æ±‚æ˜¯é’ˆå¯¹éœ€æ±‚2æ”¹è¿›çš„ï¼Œå› ä¸º URL ä¸­æŸä¸ªå­—æ®µæˆ–è€…æŸäº›å­—æ®µå¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œæ˜¯æŒ‰ç…§ä¸€å®šè§„åˆ™ï¼ˆæ¯”å¦‚æ˜¯æ•°å­—ï¼‰å˜åŒ–çš„ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¸Œæœ›è·¯ç”±ä¹Ÿèƒ½å¤Ÿæ”¯æŒè¿™ä¸ªè§„åˆ™ï¼Œå°†è¿™ä¸ªåŠ¨æ€å˜åŒ–çš„è·¯ç”±URLåŒ¹é…å‡ºæ¥ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ï¼Œä½¿ç”¨è‡ªå·±å®šä¹‰çš„è·¯ç”±æ¥è¡¥å……ï¼Œåªæ”¯æŒé™æ€åŒ¹é…çš„DefaultServerMuxé»˜è®¤è·¯ç”±ã€‚

ç°åœ¨å››ä¸ªæœ€åŸºæœ¬çš„éœ€æ±‚æˆ‘ä»¬å·²ç»æ•´ç†å‡ºæ¥äº†ï¼Œæ¥ä¸‹æ¥é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è§£é‡Šä¸‹ï¼Œæ¯”å¦‚æˆ‘ä»¬éœ€è¦èƒ½å¤Ÿæ”¯æŒä¸€ä¸ªæ—¥å¿—ç½‘ç«™çš„è¿™äº›åŠŸèƒ½ï¼š

![](https://static001.geekbang.org/resource/image/dc/62/dc6e322c49be2334954d85b9883d0862.jpg?wh=1920x1080)

æ¥ä¸‹æ¥å°±æ˜¯ä»Šå¤©çš„é‡å¤´æˆäº†ï¼Œè¦åŒ¹é…è¿™æ ·çš„è·¯ç”±åˆ—è¡¨ï¼Œè·¯ç”±è§„åˆ™å®šä¹‰ä»£ç æ€ä¹ˆå†™å‘¢ï¼Ÿæˆ‘æŠŠæœ€ç»ˆçš„ä½¿ç”¨ä»£ç è´´åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥å…ˆçœ‹çœ‹ï¼Œç„¶åæˆ‘ä»¬ä¸€æ­¥æ­¥å®ç°ï¼Œåˆ†ææ¸…æ¥šæ¯è¡Œä»£ç èƒŒåçš„æ–¹æ³•å¦‚ä½•å®šä¹‰ã€ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå®šä¹‰ã€‚

```go
// æ³¨å†Œè·¯ç”±è§„åˆ™
func registerRouter(core *framework.Core) {
    // éœ€æ±‚1+2:HTTPæ–¹æ³•+é™æ€è·¯ç”±åŒ¹é…
	core.Post("/user/login", UserLoginController)
    
    // éœ€æ±‚3:æ‰¹é‡é€šç”¨å‰ç¼€
  	subjectApi := core.Group("/subject")
	{
		subjectApi.Post("/add", SubjectAddController)
        // éœ€æ±‚4:åŠ¨æ€è·¯ç”±
		subjectApi.Delete("/:id", SubjectDelController)
		subjectApi.Put("/:id", SubjectUpdateController)
		subjectApi.Get("/:id", SubjectGetController)
        subjectApi.Get("/list/all", SubjectListController)
	}	
}
```

ï¼ˆè¿™æ®µä»£ç ä¼šåœ¨æœ€åè¡¥å……åˆ°ä¸ŠèŠ‚è¯¾ä¸­åˆ›å»ºçš„ä¸šåŠ¡ç›®å½•ä¸­çš„è·¯ç”±æ–‡ä»¶router.goã€‚ï¼‰

## å®ç°HTTPæ–¹æ³•å’Œé™æ€è·¯ç”±åŒ¹é…

æˆ‘ä»¬é¦–å…ˆçœ‹ç¬¬ä¸€ä¸ªéœ€æ±‚å’Œç¬¬äºŒä¸ªéœ€æ±‚ã€‚ç”±äºæœ‰ä¸¤ä¸ªå¾…åŒ¹é…çš„è§„åˆ™ï¼ŒRequest-URI å’Œ Methodï¼Œæ‰€ä»¥è‡ªç„¶è”æƒ³åˆ°å¯ä»¥ä½¿ç”¨ä¸¤çº§å“ˆå¸Œè¡¨æ¥åˆ›å»ºæ˜ å°„ã€‚

![](https://static001.geekbang.org/resource/image/13/dc/13377ea20d08bcf39b3f1b735eca83dc.jpg?wh=1920x1232)  
ç¬¬ä¸€çº§hashæ˜¯è¯·æ±‚Methodï¼Œç¬¬äºŒçº§hashæ˜¯Request-URIã€‚

è¿™ä¸ªè·¯ç”±mapæˆ‘ä»¬ä¼šå­˜æ”¾åœ¨ç¬¬ä¸€è®²å®šä¹‰çš„Coreç»“æ„é‡Œï¼ˆå¦‚ä¸‹ï¼‰ï¼Œå¹¶ä¸”åœ¨åˆå§‹åŒ– Core ç»“æ„çš„æ—¶å€™ï¼Œåˆå§‹åŒ–ç¬¬ä¸€å±‚mapã€‚æ‰€ä»¥è¿˜æ˜¯æ‹‰å‡º[geekbang/03åˆ†æ”¯](https://github.com/gohade/coredemo/blob/geekbang/03/framework/core.go)ï¼Œæ¥æ›´æ–°æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„core.go æ–‡ä»¶ï¼š

```go
// æ¡†æ¶æ ¸å¿ƒç»“æ„
type Core struct {
}

// åˆå§‹åŒ–æ¡†æ¶æ ¸å¿ƒç»“æ„
func NewCore() *Core {
	return &Core{}
}

// æ¡†æ¶æ ¸å¿ƒç»“æ„å®ç°Handleræ¥å£
func (c *Core) ServeHTTP(response http.ResponseWriter, request *http.Request) {
	// TODO
}
```

æ¥ä¸‹æ¥æˆ‘ä»¬æŒ‰æ¡†æ¶ä½¿ç”¨è€…ä½¿ç”¨è·¯ç”±çš„é¡ºåºåˆ†æˆå››æ­¥æ¥å®Œå–„è¿™ä¸ªç»“æ„ï¼š**å®šä¹‰è·¯ç”±mapã€æ³¨å†Œè·¯ç”±ã€åŒ¹é…è·¯ç”±ã€å¡«å……ServeHTTP æ–¹æ³•**ã€‚

é¦–å…ˆï¼Œç¬¬ä¸€å±‚map çš„æ¯ä¸ªkeyå€¼éƒ½ä»£è¡¨Methodï¼Œè€Œä¸”ä¸ºäº†é¿å…ä¹‹ååœ¨åŒ¹é…çš„æ—¶å€™ï¼Œè¦è½¬æ¢ä¸€æ¬¡å¤§å°å†™ï¼Œæˆ‘ä»¬å°†æ¯ä¸ªkeyéƒ½è®¾ç½®ä¸ºå¤§å†™ã€‚ç»§ç»­åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„core.go æ–‡ä»¶é‡Œå†™ï¼š

```go
// æ¡†æ¶æ ¸å¿ƒç»“æ„
type Core struct {
	router map[string]map[string]ControllerHandler // äºŒçº§map
}

// åˆå§‹åŒ–æ¡†æ¶æ ¸å¿ƒç»“æ„
func NewCore() *Core {
    // å®šä¹‰äºŒçº§map
	getRouter := map[string]ControllerHandler{}
	postRouter := map[string]ControllerHandler{}
	putRouter := map[string]ControllerHandler{}
	deleteRouter := map[string]ControllerHandler{}

    // å°†äºŒçº§mapå†™å…¥ä¸€çº§map
	router := map[string]map[string]ControllerHandler{}
	router["GET"] = getRouter
	router["POST"] = postRouter
	router["PUT"] = putRouter
	router["DELETE"] = deleteRouter

	return &Core{router: router}
}
```

ä¸‹ä¸€æ­¥å°±æ˜¯è·¯ç”±æ³¨å†Œï¼Œæˆ‘ä»¬å°†è·¯ç”±æ³¨å†Œå‡½æ•°æŒ‰ç…§Methodåæ‹†åˆ†ä¸º4ä¸ªæ–¹æ³•ï¼šGetã€Postã€Putå’ŒDeleteã€‚

```go
// å¯¹åº” Method = Get
func (c *Core) Get(url string, handler ControllerHandler) {
	upperUrl := strings.ToUpper(url)
	c.router["GET"][upperUrl] = handler
}

// å¯¹åº” Method = POST
func (c *Core) Post(url string, handler ControllerHandler) {
	upperUrl := strings.ToUpper(url)
	c.router["POST"][upperUrl] = handler
}

// å¯¹åº” Method = PUT
func (c *Core) Put(url string, handler ControllerHandler) {
	upperUrl := strings.ToUpper(url)
	c.router["PUT"][upperUrl] = handler
}

// å¯¹åº” Method = DELETE
func (c *Core) Delete(url string, handler ControllerHandler) {
	upperUrl := strings.ToUpper(url)
	c.router["DELETE"][upperUrl] = handler
}
```

æˆ‘ä»¬è¿™é‡Œå°†URLå…¨éƒ¨è½¬æ¢ä¸ºå¤§å†™äº†ï¼Œ**åœ¨åç»­åŒ¹é…è·¯ç”±çš„æ—¶å€™ï¼Œä¹Ÿè¦è®°å¾—æŠŠåŒ¹é…çš„URLè¿›è¡Œå¤§å†™è½¬æ¢**ï¼Œè¿™æ ·æˆ‘ä»¬çš„è·¯ç”±å°±ä¼šæ˜¯â€œå¤§å°å†™ä¸æ•æ„Ÿâ€çš„ï¼Œå¯¹ä½¿ç”¨è€…çš„å®¹é”™æ€§å°±å¤§å¤§å¢åŠ äº†ã€‚

æ³¨å†Œå®Œè·¯ç”±ä¹‹åï¼Œå¦‚ä½•åŒ¹é…è·¯ç”±å°±æ˜¯æˆ‘ä»¬ç¬¬ä¸‰æ­¥éœ€è¦åšçš„äº‹æƒ…äº†ã€‚é¦–å…ˆæˆ‘ä»¬å®ç°åŒ¹é…è·¯ç”±æ–¹æ³•ï¼Œè¿™ä¸ªåŒ¹é…è·¯ç”±çš„é€»è¾‘æˆ‘ç”¨æ³¨é‡Šå†™åœ¨ä»£ç ä¸­äº†ã€‚ç»§ç»­åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„core.go æ–‡ä»¶é‡Œå†™å…¥ï¼š

```go
// åŒ¹é…è·¯ç”±ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œè¿”å›nil
func (c *Core) FindRouteByRequest(request *http.Request) ControllerHandler {
	// uri å’Œ method å…¨éƒ¨è½¬æ¢ä¸ºå¤§å†™ï¼Œä¿è¯å¤§å°å†™ä¸æ•æ„Ÿ
	uri := request.URL.Path
	method := request.Method
	upperMethod := strings.ToUpper(method)
	upperUri := strings.ToUpper(uri)

	// æŸ¥æ‰¾ç¬¬ä¸€å±‚map
	if methodHandlers, ok := c.router[upperMethod]; ok {
		// æŸ¥æ‰¾ç¬¬äºŒå±‚map
		if handler, ok := methodHandlers[upperUri]; ok {
			return handler
		}
	}
	return nil
}
```

ä»£ç å¾ˆå®¹æ˜“çœ‹æ‡‚ï¼ŒåŒ¹é…é€»è¾‘å°±æ˜¯å»äºŒå±‚å“ˆå¸Œmapä¸­ä¸€å±‚å±‚åŒ¹é…ï¼Œå…ˆæŸ¥æ‰¾ç¬¬ä¸€å±‚åŒ¹é…Methodï¼Œå†æŸ¥ç¬¬äºŒå±‚åŒ¹é…Request-URIã€‚

æœ€åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¡«å……æœªå®ç°çš„ ServeHTTP æ–¹æ³•äº†ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¿›åˆ°è¿™ä¸ªå‡½æ•°ä¸­å¤„ç†ã€‚ï¼ˆå¦‚æœä½ æœ‰ç‚¹æ¨¡ç³Šäº†ï¼Œå¯ä»¥æ‹¿å‡ºç¬¬ä¸€èŠ‚è¯¾ä¸­çš„æ€ç»´å¯¼å›¾ï¼Œå†å·©å›ºä¸‹ net/http çš„æ ¸å¿ƒé€»è¾‘ã€‚ï¼‰ç»§ç»­åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„core.go æ–‡ä»¶é‡Œå†™ï¼š

```go
func (c *Core) ServeHTTP(response http.ResponseWriter, request *http.Request) {

	// å°è£…è‡ªå®šä¹‰context
	ctx := NewContext(request, response)

	// å¯»æ‰¾è·¯ç”±
	router := c.FindRouteByRequest(request)
	if router == nil {
		// å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè¿™é‡Œæ‰“å°æ—¥å¿—
		ctx.Json(404, "not found")
		return
	}

	// è°ƒç”¨è·¯ç”±å‡½æ•°ï¼Œå¦‚æœè¿”å›err ä»£è¡¨å­˜åœ¨å†…éƒ¨é”™è¯¯ï¼Œè¿”å›500çŠ¶æ€ç 
	if err := router(ctx); err != nil {
		ctx.Json(500, "inner error")
		return
	}
}
```

è¿™ä¸ªå‡½æ•°å°±æŠŠæˆ‘ä»¬å‰é¢ä¸‰è®²çš„å†…å®¹éƒ½ä¸²èµ·æ¥äº†ã€‚å…ˆå°è£…ç¬¬äºŒè®²åˆ›å»ºçš„è‡ªå®šä¹‰Contextï¼Œç„¶åä½¿ç”¨ FindRouteByRequest å‡½æ•°å¯»æ‰¾æˆ‘ä»¬éœ€è¦çš„è·¯ç”±ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°è·¯ç”±ï¼Œè¿”å›404çŠ¶æ€ç ï¼›å¦‚æœæ‰¾åˆ°äº†è·¯ç”±ï¼Œå°±è°ƒç”¨è·¯ç”±æ§åˆ¶å™¨ï¼Œå¦å¤–å¦‚æœè·¯ç”±æ§åˆ¶å™¨å‡ºç°å†…éƒ¨é”™è¯¯ï¼Œè¿”å›500çŠ¶æ€ç ã€‚

åˆ°è¿™é‡Œï¼Œç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªéœ€æ±‚å°±éƒ½å®Œæˆäº†ã€‚

## å®ç°æ‰¹é‡é€šç”¨å‰ç¼€

å¯¹äºç¬¬ä¸‰ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ª Group æ–¹æ³•å½’æ‹¢è·¯ç”±å‰ç¼€åœ°å€ã€‚ä¿®æ­£åœ¨ä¸šåŠ¡æ–‡ä»¶å¤¹ä¸‹çš„route.goæ–‡ä»¶ï¼Œä½¿ç”¨æ–¹æ³•æ”¹æˆè¿™æ ·ï¼š

```go
// æ³¨å†Œè·¯ç”±è§„åˆ™
func registerRouter(core *framework.Core) {
	// éœ€æ±‚1+2:HTTPæ–¹æ³•+é™æ€è·¯ç”±åŒ¹é…
	core.Get("/user/login", UserLoginController)

	// éœ€æ±‚3:æ‰¹é‡é€šç”¨å‰ç¼€
	subjectApi := core.Group("/subject")
	{
		subjectApi.Get("/list", SubjectListController)
	}
}
```

çœ‹ä¸‹è¿™ä¸ªGroupæ–¹æ³•ï¼Œå®ƒçš„å‚æ•°æ˜¯ä¸€ä¸ªå‰ç¼€å­—ç¬¦ä¸²ï¼Œè¿”å›å€¼åº”è¯¥æ˜¯åŒ…å«Getã€Postã€Putã€Delete æ–¹æ³•çš„ä¸€ä¸ªç»“æ„ï¼Œæˆ‘ä»¬ç»™è¿™ä¸ªç»“æ„å‘½åGroupï¼Œåœ¨å…¶ä¸­å®ç°å„ç§æ–¹æ³•ã€‚

åœ¨è¿™é‡Œæˆ‘ä»¬æš‚åœä¸€ä¸‹ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰ä¼˜åŒ–ç‚¹ã€‚

è¿™ä¹ˆè®¾è®¡ç›´æ¥è¿”å› Group ç»“æ„ï¼Œç¡®å®å¯ä»¥å®ç°åŠŸèƒ½ï¼Œä½†è¯•æƒ³ä¸€ä¸‹ï¼Œéšç€æ¡†æ¶å‘å±•ï¼Œå¦‚æœæˆ‘ä»¬å‘ç°Groupç»“æ„çš„å…·ä½“å®ç°å¹¶ä¸ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚äº†ï¼Œéœ€è¦å¼•å…¥å®ç°å¦ä¸€ä¸ªGroup2ç»“æ„ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿç›´æ¥ä¿®æ”¹Groupç»“æ„çš„å…·ä½“å®ç°ä¹ˆï¼Ÿ![](https://static001.geekbang.org/resource/image/b4/ef/b40828bd1dbc2651dc649ac5ecd29fef.jpg?wh=1920x1080)

**å…¶å®æ›´å¥½çš„åŠæ³•æ˜¯ä½¿ç”¨æ¥å£æ¥æ›¿ä»£ç»“æ„å®šä¹‰**ã€‚åœ¨æ¡†æ¶è®¾è®¡ä¹‹åˆï¼Œæˆ‘ä»¬è¦ä¿è¯æ¡†æ¶ä½¿ç”¨è€…ï¼Œåœ¨æœ€å°‘çš„æ”¹åŠ¨ä¸­ï¼Œå°±èƒ½æµç•…è¿ç§»åˆ°Group2ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœè¿”å›æ¥å£ IGroupï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å› Group ç»“æ„ï¼Œå°±ä¸éœ€è¦ä¿®æ”¹core.Groupçš„å®šä¹‰äº†ï¼Œåªéœ€è¦ä¿®æ”¹core.Groupçš„å…·ä½“å®ç°ï¼Œè¿”å›Group2å°±å¯ä»¥ã€‚  
![](https://static001.geekbang.org/resource/image/2a/9b/2a969d91845f3fe1f8afd0144273509b.jpg?wh=1920x1080)  
å°½é‡ä½¿ç”¨æ¥å£æ¥è§£è€¦åˆï¼Œæ˜¯ä¸€ç§æ¯”è¾ƒå¥½çš„è®¾è®¡æ€è·¯ã€‚

æ€ä¹ˆå®ç°å‘¢ï¼Œè¿™é‡Œæˆ‘ä»¬å®šä¹‰ IGroup æ¥å£æ¥ä½œä¸ºGroupæ–¹æ³•çš„è¿”å›å€¼ã€‚åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸‹åˆ›å»º[group.goæ–‡ä»¶](https://github.com/gohade/coredemo/blob/geekbang/03/framework/group.go)æ¥å­˜æ”¾åˆ†ç»„ç›¸å…³çš„ä¿¡æ¯ï¼š

```go
// IGroup ä»£è¡¨å‰ç¼€åˆ†ç»„
type IGroup interface {
	Get(string, ControllerHandler)
	Post(string, ControllerHandler)
	Put(string, ControllerHandler)
	Delete(string, ControllerHandler)
}
```

å¹¶ä¸”ç»§ç»­æ­å¥½Group ç»“æ„ä»£ç æ¥å®ç°è¿™ä¸ªæ¥å£ï¼š

```go
// Group struct å®ç°äº†IGroup
type Group struct {
	coreÂ  Â *Core
	prefix string
}

// åˆå§‹åŒ–Group
func NewGroup(core *Core, prefix string) *Group {
	return &Group{
		core:Â  Â core,
		prefix: prefix,
	}
}

// å®ç°Getæ–¹æ³•
func (g *Group) Get(uri string, handler ControllerHandler) {
	uri = g.prefix + uri
	g.core.Get(uri, handler)
}

....

// ä»coreä¸­åˆå§‹åŒ–è¿™ä¸ªGroup
func (c *Core) Group(prefix string) IGroup {
	return NewGroup(c, prefix)
}
```

è¿™ä¸ª Group ç»“æ„åŒ…å«è‡ªèº«çš„å‰ç¼€åœ°å€å’ŒCoreç»“æ„çš„æŒ‡é’ˆã€‚å®ƒçš„ Getã€Putã€Postã€Delete æ–¹æ³•å°±æ˜¯æŠŠè¿™ä¸ªGroupç»“æ„çš„å‰ç¼€åœ°å€å’Œç›®æ ‡åœ°å€ç»„åˆèµ·æ¥ï¼Œä½œä¸ºCoreçš„Request-URIåœ°å€ã€‚![](https://static001.geekbang.org/resource/image/b5/f8/b5f6f18b380db972600032dcc97dfff8.jpg?wh=1920x1080)

è®²åˆ°è¿™é‡Œï¼Œæœ‰çš„åŒå­¦å¯èƒ½ä¸ä»¥ä¸ºç„¶ï¼Œè§‰å¾—è¿™ä¸å°±æ˜¯ä¸ªäººä»£ç é£æ ¼çš„é—®é¢˜å—ã€‚å…¶å®å¹¶ä¸æ˜¯ï¼Œå¸Œæœ›ä½ èƒ½å¤Ÿæ„è¯†åˆ°ï¼Œè¿™ä¸ªé€‰æ‹©å¹¶ä¸ä»…ä»…æ˜¯ä»£ç é£æ ¼ï¼Œè€Œæ˜¯å…³äºæ¡†æ¶è®¾è®¡ã€å…³äºä»£ç æ‰©å±•æ€§ã€‚

æ¥å£æ˜¯ä¸€ç§åè®®ï¼Œå®ƒå¿½ç•¥å…·ä½“çš„å®ç°ï¼Œå®šä¹‰çš„æ˜¯ä¸¤ä¸ªé€»è¾‘ç»“æ„çš„äº¤äº’ï¼Œå› ä¸ºä¸¤ä¸ªå‡½æ•°ä¹‹é—´å®šä¹‰çš„æ˜¯ä¸€ç§çº¦å®šï¼Œä¸ä¾èµ–å…·ä½“çš„å®ç°ã€‚

ä½ å¯ä»¥è¿™ä¹ˆåˆ¤æ–­ï¼š**å¦‚æœä½ è§‰å¾—è¿™ä¸ªæ¨¡å—æ˜¯å®Œæ•´çš„ï¼Œè€Œä¸”åç»­å¸Œæœ›æœ‰æ‰©å±•çš„å¯èƒ½æ€§ï¼Œé‚£ä¹ˆå°±åº”è¯¥å°½é‡ä½¿ç”¨æ¥å£æ¥æ›¿ä»£å®ç°**ã€‚åœ¨ä»£ç ä¸­ï¼Œå¤šå¤§ç¨‹åº¦ä½¿ç”¨æ¥å£è¿›è¡Œé€»è¾‘ç»“æ„çš„äº¤äº’ï¼Œæ˜¯è¯„ä»·æ¡†æ¶ä»£ç å¯æ‰©å±•æ€§çš„ä¸€ä¸ªå¾ˆå¥½çš„æ ‡å‡†ã€‚è¿™ç§æ€ç»´ä¼šè´¯ç©¿åœ¨æˆ‘ä»¬æ•´ä¸ªæ¡†æ¶çš„è®¾è®¡ä¸­ï¼Œåç»­æˆ‘ä¼šæ—¶ä¸æ—¶å†æèµ·çš„ã€‚

æ‰€ä»¥å›åˆ°æˆ‘ä»¬çš„è·¯ç”±ï¼Œä½¿ç”¨IGroupæ¥å£åï¼Œcore.Group è¿™ä¸ªæ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªçº¦å®šï¼Œè€Œä¸ä¾èµ–å…·ä½“çš„Groupå®ç°ã€‚

## å®ç°åŠ¨æ€è·¯ç”±åŒ¹é…

ç°åœ¨å·²ç»å®Œæˆäº†å‰ä¸‰ä¸ªéœ€æ±‚ï¼Œä¸‹é¢æˆ‘ä»¬è€ƒè™‘ç¬¬å››ä¸ªéœ€æ±‚ï¼Œå¸Œæœ›åœ¨å†™ä¸šåŠ¡çš„æ—¶å€™èƒ½æ”¯æŒåƒä¸‹åˆ—è¿™ç§åŠ¨æ€è·¯ç”±ï¼š

```go
func registerRouter(core *framework.Core) {
	// éœ€æ±‚1+2:HTTPæ–¹æ³•+é™æ€è·¯ç”±åŒ¹é…
	core.Get("/user/login", UserLoginController)

	// éœ€æ±‚3:æ‰¹é‡é€šç”¨å‰ç¼€
	subjectApi := core.Group("/subject")
	{
		// éœ€æ±‚4:åŠ¨æ€è·¯ç”±
		subjectApi.Delete("/:id", SubjectDelController)
		subjectApi.Put("/:id", SubjectUpdateController)
		subjectApi.Get("/:id", SubjectGetController)
		subjectApi.Get("/list/all", SubjectListController)
	}
}
```

å¦‚ä½•å®ç°ï¼Ÿæˆ‘ä»¬ç»§ç»­çœ‹ã€‚

é¦–å…ˆï¼Œä½ è¦çŸ¥é“çš„æ˜¯ï¼Œ**ä¸€æ—¦å¼•å…¥äº†åŠ¨æ€è·¯ç”±åŒ¹é…çš„è§„åˆ™ï¼Œä¹‹å‰ä½¿ç”¨çš„å“ˆå¸Œè§„åˆ™å°±æ— æ³•ä½¿ç”¨äº†**ã€‚å› ä¸ºæœ‰é€šé…ç¬¦ï¼Œåœ¨åŒ¹é…Request-URIçš„æ—¶å€™ï¼Œè¯·æ±‚URIçš„æŸä¸ªå­—ç¬¦æˆ–è€…æŸäº›å­—ç¬¦æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ— æ³•ä½¿ç”¨URIåšä¸ºkeyæ¥åŒ¹é…ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±éœ€è¦å…¶ä»–çš„ç®—æ³•æ¥æ”¯æŒè·¯ç”±åŒ¹é…ã€‚

å¦‚æœä½ å¯¹ç®—æ³•æ¯”è¾ƒç†Ÿæ‚‰ï¼Œä¼šè”æƒ³åˆ°**è¿™ä¸ªé—®é¢˜æœ¬è´¨æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åŒ¹é…**ï¼Œè€Œå­—ç¬¦ä¸²åŒ¹é…ï¼Œæ¯”è¾ƒé€šç”¨çš„é«˜æ•ˆæ–¹æ³•å°±æ˜¯å­—å…¸æ ‘ï¼Œä¹Ÿå«trieæ ‘ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆç®€å•æ¢³ç†ä¸‹trieæ ‘çš„æ•°æ®ç»“æ„ã€‚trieæ ‘ä¸åŒäºäºŒå‰æ ‘ï¼Œå®ƒæ˜¯å¤šå‰çš„æ ‘å½¢ç»“æ„ï¼Œæ ¹èŠ‚ç‚¹ä¸€èˆ¬æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œè€Œå¶å­èŠ‚ç‚¹ä¿å­˜çš„é€šå¸¸æ˜¯å­—ç¬¦ä¸²ï¼Œä¸€ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­å­™èŠ‚ç‚¹éƒ½æœ‰ç›¸åŒçš„å­—ç¬¦ä¸²å‰ç¼€ã€‚

æ‰€ä»¥æ ¹æ®trieæ ‘çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬ç»“åˆå‰ä¸‰æ¡è·¯ç”±è§„åˆ™ï¼Œå¯ä»¥æ„å»ºå‡ºè¿™æ ·çš„ç»“æ„ï¼š

```go
1 /user/login
2 /user/logout
3 /subject/name
4 /subject/name/age
5 /subject/:id/name
```

ç”»æˆå›¾æ›´æ¸…æ™°ä¸€äº›ï¼š![](https://static001.geekbang.org/resource/image/68/98/6837822864392bbb5e7345518448b098.jpg?wh=1920x1080)

è¿™ä¸ªtrieæ ‘æ˜¯æŒ‰ç…§è·¯ç”±åœ°å€çš„æ¯ä¸ªæ®µ(segment)æ¥åˆ‡åˆ†çš„ï¼Œæ¯ä¸ªsegmentåœ¨trieæ ‘ä¸­éƒ½èƒ½æ‰¾åˆ°å¯¹åº”èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¿å­˜ä¸€ä¸ªsegmentã€‚æ ‘ä¸­ï¼Œæ¯ä¸ªå¶å­èŠ‚ç‚¹éƒ½ä»£è¡¨ä¸€ä¸ªURIï¼Œå¯¹äºä¸­é—´èŠ‚ç‚¹æ¥è¯´ï¼Œæœ‰çš„ä¸­é—´èŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªURIï¼ˆæ¯”å¦‚ä¸Šå›¾ä¸­çš„ /subject/nameï¼‰ï¼Œè€Œæœ‰çš„ä¸­é—´èŠ‚ç‚¹å¹¶ä¸æ˜¯ä¸€ä¸ªURIï¼ˆå› ä¸ºæ²¡æœ‰è·¯ç”±è§„åˆ™å¯¹åº”è¿™ä¸ªURIï¼‰ã€‚

ç°åœ¨åˆ†ææ¸…æ¥šäº†ï¼Œæˆ‘ä»¬å¼€å§‹åŠ¨æ‰‹å®ç°trieæ ‘ã€‚è¿˜æ˜¯ç…§æ—§å…ˆæ˜ç¡®ä¸‹å¯ä»¥åˆ†ä¸ºå‡ æ­¥ï¼š

1. å®šä¹‰æ ‘å’ŒèŠ‚ç‚¹çš„æ•°æ®ç»“æ„
2. ç¼–å†™å‡½æ•°ï¼šâ€œå¢åŠ è·¯ç”±è§„åˆ™â€
3. ç¼–å†™å‡½æ•°ï¼šâ€œæŸ¥æ‰¾è·¯ç”±â€
4. å°†â€œå¢åŠ è·¯ç”±è§„åˆ™â€å’Œâ€œæŸ¥æ‰¾è·¯ç”±â€æ·»åŠ åˆ°æ¡†æ¶ä¸­

æ­¥éª¤éå¸¸æ¸…æ™°ï¼Œå¥½ï¼ŒåºŸè¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥ï¼Œé¦–å…ˆå®šä¹‰å¯¹åº”çš„æ•°æ®ç»“æ„ï¼ˆnode å’Œ treeï¼‰ã€‚å…ˆåœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºtree.goæ–‡ä»¶ï¼Œå­˜å‚¨trieæ ‘ç›¸å…³é€»è¾‘ï¼š

```go
// ä»£è¡¨æ ‘ç»“æ„
type Tree struct {
	root *node // æ ¹èŠ‚ç‚¹
}

// ä»£è¡¨èŠ‚ç‚¹
type node struct {
	isLastÂ  boolÂ  Â  Â  Â  Â  Â  Â  // ä»£è¡¨è¿™ä¸ªèŠ‚ç‚¹æ˜¯å¦å¯ä»¥æˆä¸ºæœ€ç»ˆçš„è·¯ç”±è§„åˆ™ã€‚è¯¥èŠ‚ç‚¹æ˜¯å¦èƒ½æˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„uri, æ˜¯å¦è‡ªèº«å°±æ˜¯ä¸€ä¸ªç»ˆæèŠ‚ç‚¹
	segment stringÂ  Â  Â  Â  Â  Â  // uriä¸­çš„å­—ç¬¦ä¸²ï¼Œä»£è¡¨è¿™ä¸ªèŠ‚ç‚¹è¡¨ç¤ºçš„è·¯ç”±ä¸­æŸä¸ªæ®µçš„å­—ç¬¦ä¸²
	handler ControllerHandler // ä»£è¡¨è¿™ä¸ªèŠ‚ç‚¹ä¸­åŒ…å«çš„æ§åˆ¶å™¨ï¼Œç”¨äºæœ€ç»ˆåŠ è½½è°ƒç”¨
	childsÂ  []*nodeÂ  Â  Â  Â  Â  Â // ä»£è¡¨è¿™ä¸ªèŠ‚ç‚¹ä¸‹çš„å­èŠ‚ç‚¹
}
```

Treeç»“æ„ä¸­åŒ…å«ä¸€ä¸ªæ ¹èŠ‚ç‚¹ï¼Œåªæ˜¯è¿™ä¸ªæ ¹èŠ‚ç‚¹æ˜¯ä¸€ä¸ªæ²¡æœ‰segmentçš„ç©ºçš„æ ¹èŠ‚ç‚¹ã€‚

nodeçš„ç»“æ„å®šä¹‰äº†å››ä¸ªå­—æ®µã€‚childså­—æ®µè®©nodeç»„æˆäº†ä¸€ä¸ªæ ‘å½¢ç»“æ„ï¼Œhandleræ˜¯å…·ä½“çš„ä¸šåŠ¡æ§åˆ¶å™¨é€»è¾‘å­˜æ”¾ä½ç½®ï¼Œsegmentæ˜¯æ ‘ä¸­çš„è¿™ä¸ªèŠ‚ç‚¹å­˜æ”¾çš„å†…å®¹ï¼ŒisLastç”¨äºåŒºåˆ«è¿™ä¸ªæ ‘ä¸­çš„èŠ‚ç‚¹æ˜¯å¦æœ‰å®é™…çš„è·¯ç”±å«ä¹‰ã€‚

æœ‰äº†æ•°æ®ç»“æ„åï¼Œç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬å°±å¾€Treeè¿™ä¸ªtrieæ ‘ç»“æ„ä¸­æ·»åŠ â€œå¢åŠ è·¯ç”±è§„åˆ™â€çš„é€»è¾‘ã€‚å†™ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯æš‚åœä¸€ä¸‹æƒ³ä¸€æƒ³ï¼Œä¼šä¸ä¼šå‡ºç°é—®é¢˜ã€‚**ä¹‹å‰æè¿‡ä¼šå­˜åœ¨é€šé…ç¬¦ï¼Œé‚£ç›´æ¥åŠ è§„åˆ™å…¶å®æ˜¯æœ‰å¯èƒ½å†²çªçš„**ã€‚æ¯”å¦‚ï¼š

```go
/user/name
/user/:id
```

è¿™ä¸¤ä¸ªè·¯ç”±è§„åˆ™å®é™…ä¸Šå°±å†²çªäº†ï¼Œå¦‚æœè¯·æ±‚åœ°å€æ˜¯/user/nameï¼Œé‚£ä¹ˆä¸¤ä¸ªè§„åˆ™éƒ½åŒ¹é…ï¼Œæ— æ³•ç¡®å®šå“ªä¸ªè§„åˆ™ç”Ÿæ•ˆã€‚æ‰€ä»¥åœ¨å¢åŠ è·¯ç”±ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­è¿™ä¸ªè·¯ç”±è§„åˆ™æ˜¯å¦å·²ç»åœ¨trieæ ‘ä¸­å­˜åœ¨äº†ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ç”¨matchNodeæ–¹æ³•ï¼Œå¯»æ‰¾æŸä¸ªè·¯ç”±åœ¨trieæ ‘ä¸­åŒ¹é…çš„èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰åŒ¹é…èŠ‚ç‚¹ï¼Œè¿”å›èŠ‚ç‚¹æŒ‡é’ˆï¼Œå¦åˆ™è¿”å›nilã€‚**matchNodeæ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ªURIï¼Œè¿”å›å€¼æ˜¯æŒ‡å‘nodeçš„æŒ‡é’ˆï¼Œå®ƒçš„å®ç°æ€è·¯æ˜¯ä½¿ç”¨å‡½æ•°é€’å½’**ï¼Œæˆ‘ç®€å•è¯´æ˜ä¸€ä¸‹æ€è·¯ï¼š

é¦–å…ˆï¼Œå°†éœ€è¦åŒ¹é…çš„URIæ ¹æ®ç¬¬ä¸€ä¸ªåˆ†éš”ç¬¦/è¿›è¡Œåˆ†å‰²ï¼Œåªéœ€è¦æœ€å¤šåˆ†å‰²æˆä¸ºä¸¤ä¸ªæ®µã€‚

å¦‚æœåªèƒ½åˆ†å‰²æˆä¸€ä¸ªæ®µï¼Œè¯´æ˜URIä¸­æ²¡æœ‰åˆ†éš”ç¬¦äº†ï¼Œè¿™æ—¶å€™å†æ£€æŸ¥ä¸‹ä¸€çº§èŠ‚ç‚¹ä¸­æ˜¯å¦æœ‰åŒ¹é…è¿™ä¸ªæ®µçš„èŠ‚ç‚¹å°±è¡Œã€‚

å¦‚æœåˆ†å‰²æˆäº†ä¸¤ä¸ªæ®µï¼Œæˆ‘ä»¬ç”¨ç¬¬ä¸€ä¸ªæ®µæ¥æ£€æŸ¥ä¸‹ä¸€ä¸ªçº§èŠ‚ç‚¹ä¸­æ˜¯å¦æœ‰åŒ¹é…è¿™ä¸ªæ®µçš„èŠ‚ç‚¹ã€‚

- å¦‚æœæ²¡æœ‰ï¼Œè¯´æ˜è¿™ä¸ªè·¯ç”±è§„åˆ™åœ¨æ ‘ä¸­åŒ¹é…ä¸åˆ°ã€‚
- å¦‚æœä¸‹ä¸€çº§èŠ‚ç‚¹ä¸­æœ‰ç¬¦åˆç¬¬ä¸€ä¸ªåˆ†å‰²æ®µçš„ï¼ˆè¿™é‡Œéœ€è¦æ³¨æ„å¯èƒ½ä¸æ­¢ä¸€ä¸ªç¬¦åˆï¼‰ï¼Œæˆ‘ä»¬å°±å°†æ‰€æœ‰ç¬¦åˆçš„èŠ‚ç‚¹è¿›è¡Œå‡½æ•°é€’å½’ï¼Œé‡æ–°åº”ç”¨äºmatchNodeå‡½æ•°ä¸­ï¼Œåªä¸è¿‡è¿™æ—¶å€™matchNodeå‡½æ•°ä½œç”¨äºå­èŠ‚ç‚¹ï¼Œå‚æ•°å˜æˆäº†åˆ‡å‰²åçš„ç¬¬äºŒä¸ªæ®µã€‚

å¥½æ€è·¯å°±è®²å®Œäº†ï¼Œæ•´ä¸ªæµç¨‹é‡Œï¼Œä¼šé¢‘ç¹ä½¿ç”¨åˆ°â€œè¿‡æ»¤ä¸‹ä¸€å±‚æ»¡è¶³segmentè§„åˆ™çš„å­èŠ‚ç‚¹â€ ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿç”¨ä¸€ä¸ªå‡½æ•° filterChildNodes å°†å®ƒå°è£…èµ·æ¥ã€‚è¿™ä¸ªå‡½æ•°çš„é€»è¾‘å°±æ¯”è¾ƒç®€å•äº†ï¼šéå†ä¸‹ä¸€å±‚å­èŠ‚ç‚¹ï¼Œåˆ¤æ–­segmentæ˜¯å¦åŒ¹é…ä¼ å…¥çš„å‚æ•°segmentã€‚

åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„tree.goä¸­ï¼Œæˆ‘ä»¬å®ŒæˆmatchNode å’Œ filterChildNodeså®Œæ•´ä»£ç å®ç°ï¼Œæ”¾åœ¨è¿™é‡Œäº†ï¼Œå…·ä½“é€»è¾‘æˆ‘ä¹ŸåŠ äº†è¯¦ç»†çš„æ‰¹æ³¨å¸®ä½ ç†è§£ã€‚

```go
// åˆ¤æ–­ä¸€ä¸ªsegmentæ˜¯å¦æ˜¯é€šç”¨segmentï¼Œå³ä»¥:å¼€å¤´
func isWildSegment(segment string) bool {
	return strings.HasPrefix(segment, ":")
}

// è¿‡æ»¤ä¸‹ä¸€å±‚æ»¡è¶³segmentè§„åˆ™çš„å­èŠ‚ç‚¹
func (n *node) filterChildNodes(segment string) []*node {
	if len(n.childs) == 0 {
		return nil
	}

	// å¦‚æœsegmentæ˜¯é€šé…ç¬¦ï¼Œåˆ™æ‰€æœ‰ä¸‹ä¸€å±‚å­èŠ‚ç‚¹éƒ½æ»¡è¶³éœ€æ±‚
	if isWildSegment(segment) {
		return n.childs
	}

	nodes := make([]*node, 0, len(n.childs))
	// è¿‡æ»¤æ‰€æœ‰çš„ä¸‹ä¸€å±‚å­èŠ‚ç‚¹
	for _, cnode := range n.childs {
		if isWildSegment(cnode.segment) {
			// å¦‚æœä¸‹ä¸€å±‚å­èŠ‚ç‚¹æœ‰é€šé…ç¬¦ï¼Œåˆ™æ»¡è¶³éœ€æ±‚
			nodes = append(nodes, cnode)
		} else if cnode.segment == segment {
			// å¦‚æœä¸‹ä¸€å±‚å­èŠ‚ç‚¹æ²¡æœ‰é€šé…ç¬¦ï¼Œä½†æ˜¯æ–‡æœ¬å®Œå…¨åŒ¹é…ï¼Œåˆ™æ»¡è¶³éœ€æ±‚
			nodes = append(nodes, cnode)
		}
	}

	return nodes
}

// åˆ¤æ–­è·¯ç”±æ˜¯å¦å·²ç»åœ¨èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹æ ‘ä¸­å­˜åœ¨äº†
func (n *node) matchNode(uri string) *node {
	// ä½¿ç”¨åˆ†éš”ç¬¦å°†uriåˆ‡å‰²ä¸ºä¸¤ä¸ªéƒ¨åˆ†
	segments := strings.SplitN(uri, "/", 2)
	// ç¬¬ä¸€ä¸ªéƒ¨åˆ†ç”¨äºåŒ¹é…ä¸‹ä¸€å±‚å­èŠ‚ç‚¹
	segment := segments[0]
	if !isWildSegment(segment) {
		segment = strings.ToUpper(segment)
	}
	// åŒ¹é…ç¬¦åˆçš„ä¸‹ä¸€å±‚å­èŠ‚ç‚¹
	cnodes := n.filterChildNodes(segment)
	// å¦‚æœå½“å‰å­èŠ‚ç‚¹æ²¡æœ‰ä¸€ä¸ªç¬¦åˆï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªuriä¸€å®šæ˜¯ä¹‹å‰ä¸å­˜åœ¨, ç›´æ¥è¿”å›nil
	if cnodes == nil || len(cnodes) == 0 {
		return nil
	}

	// å¦‚æœåªæœ‰ä¸€ä¸ªsegmentï¼Œåˆ™æ˜¯æœ€åä¸€ä¸ªæ ‡è®°
	if len(segments) == 1 {
		// å¦‚æœsegmentå·²ç»æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ¤æ–­è¿™äº›cnodeæ˜¯å¦æœ‰isLastæ ‡å¿—
		for _, tn := range cnodes {
			if tn.isLast {
				return tn
			}
		}

		// éƒ½ä¸æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹
		return nil
	}

	// å¦‚æœæœ‰2ä¸ªsegment, é€’å½’æ¯ä¸ªå­èŠ‚ç‚¹ç»§ç»­è¿›è¡ŒæŸ¥æ‰¾
	for _, tn := range cnodes {
		tnMatch := tn.matchNode(segments[1])
		if tnMatch != nil {
			return tnMatch
		}
	}
	return nil
}
```

ç°åœ¨æœ‰äº†matchNode å’Œ filterChildNodes å‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å†™ç¬¬äºŒæ­¥é‡Œæœ€æ ¸å¿ƒçš„å¢åŠ è·¯ç”±çš„å‡½æ•°é€»è¾‘äº†ã€‚

**é¦–å…ˆï¼Œç¡®è®¤è·¯ç”±æ˜¯å¦å†²çª**ã€‚æˆ‘ä»¬å…ˆæ£€æŸ¥è¦å¢åŠ çš„è·¯ç”±è§„åˆ™æ˜¯å¦åœ¨æ ‘ä¸­å·²ç»æœ‰å¯ä»¥åŒ¹é…çš„èŠ‚ç‚¹äº†ã€‚å¦‚æœæœ‰çš„è¯ï¼Œä»£è¡¨å½“å‰å¾…å¢åŠ çš„è·¯ç”±å’Œå·²æœ‰è·¯ç”±å­˜åœ¨å†²çªï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨åˆ°äº†åˆšåˆšå®šä¹‰çš„matchNodeã€‚æ›´æ–°åˆšæ‰æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„tree.goæ–‡ä»¶ï¼š

```go
// å¢åŠ è·¯ç”±èŠ‚ç‚¹
func (tree *Tree) AddRouter(uri string, handler ControllerHandler) error {
	n := tree.root
    // ç¡®è®¤è·¯ç”±æ˜¯å¦å†²çª
	if n.matchNode(uri) != nil {
		return errors.New("route exist: " + uri)
	}

	...
}

```

**ç„¶åç»§ç»­å¢åŠ è·¯ç”±è§„åˆ™**ã€‚æˆ‘ä»¬å¢åŠ è·¯ç”±çš„æ¯ä¸ªæ®µæ—¶ï¼Œå…ˆå»æ ‘çš„æ¯ä¸€å±‚ä¸­åŒ¹é…æŸ¥æ‰¾ï¼Œå¦‚æœå·²ç»æœ‰äº†ç¬¦åˆè¿™ä¸ªæ®µçš„èŠ‚ç‚¹ï¼Œå°±ä¸éœ€è¦åˆ›å»ºèŠ‚ç‚¹ï¼Œç»§ç»­åŒ¹é…å¾…å¢åŠ è·¯ç”±çš„ä¸‹ä¸ªæ®µï¼›å¦åˆ™ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ç”¨æ¥ä»£è¡¨è¿™ä¸ªæ®µã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ç”¨åˆ°äº†å®šä¹‰çš„ filterChildNodesã€‚

```go
// å¢åŠ è·¯ç”±èŠ‚ç‚¹
/*
/book/list
/book/:id (å†²çª)
/book/:id/name
/book/:student/age
/:user/name
/:user/name/:age(å†²çª)
*/
func (tree *Tree) AddRouter(uri string, handler ControllerHandler) error {
	n := tree.root
	if n.matchNode(uri) != nil {
		return errors.New("route exist: " + uri)
	}

	segments := strings.Split(uri, "/")
	// å¯¹æ¯ä¸ªsegment
	for index, segment := range segments {

		// æœ€ç»ˆè¿›å…¥Node segmentçš„å­—æ®µ
		if !isWildSegment(segment) {
			segment = strings.ToUpper(segment)
		}
		isLast := index == len(segments)-1

		var objNode *node // æ ‡è®°æ˜¯å¦æœ‰åˆé€‚çš„å­èŠ‚ç‚¹

		childNodes := n.filterChildNodes(segment)
		// å¦‚æœæœ‰åŒ¹é…çš„å­èŠ‚ç‚¹
		if len(childNodes) > 0 {
			// å¦‚æœæœ‰segmentç›¸åŒçš„å­èŠ‚ç‚¹ï¼Œåˆ™é€‰æ‹©è¿™ä¸ªå­èŠ‚ç‚¹
			for _, cnode := range childNodes {
				if cnode.segment == segment {
					objNode = cnode
					break
				}
			}
		}

		if objNode == nil {
			// åˆ›å»ºä¸€ä¸ªå½“å‰nodeçš„èŠ‚ç‚¹
			cnode := newNode()
			cnode.segment = segment
			if isLast {
				cnode.isLast = true
				cnode.handler = handler
			}
			n.childs = append(n.childs, cnode)
			objNode = cnode
		}

		n = objNode
	}

	return nil
}
```

åˆ°è¿™é‡Œï¼Œç¬¬äºŒæ­¥å¢åŠ è·¯ç”±çš„è§„åˆ™é€»è¾‘å·²ç»æœ‰äº†ï¼Œ**æˆ‘ä»¬è¦å¼€å§‹ç¬¬ä¸‰æ­¥ï¼Œç¼–å†™â€œæŸ¥æ‰¾è·¯ç”±â€çš„é€»è¾‘**ã€‚è¿™é‡Œä½ ä¼šå‘ç°ï¼Œç”±äºæˆ‘ä»¬ä¹‹å‰å·²ç»å®šä¹‰è¿‡matchNodeï¼ˆåŒ¹é…è·¯ç”±èŠ‚ç‚¹ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œåªéœ€è¦å¤ç”¨è¿™ä¸ªå‡½æ•°å°±è¡Œäº†ã€‚

```go
// åŒ¹é…uri
func (tree *Tree) FindHandler(uri string) ControllerHandler {
    // ç›´æ¥å¤ç”¨matchNodeå‡½æ•°ï¼Œuriæ˜¯ä¸å¸¦é€šé…ç¬¦çš„åœ°å€
	matchNode := tree.root.matchNode(uri)
	if matchNode == nil {
		return nil
	}
	return matchNode.handler
}

```

å‰ä¸‰æ­¥å·²ç»å®Œæˆäº†ï¼Œ**æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬æŠŠâ€œå¢åŠ è·¯ç”±è§„åˆ™â€å’Œâ€œæŸ¥æ‰¾è·¯ç”±â€æ·»åŠ åˆ°æ¡†æ¶ä¸­**ã€‚è¿˜è®°å¾—å—ï¼Œåœ¨é™æ€è·¯ç”±åŒ¹é…çš„æ—¶å€™ï¼Œåœ¨Coreä¸­ä½¿ç”¨å“ˆå¸Œå®šä¹‰çš„è·¯ç”±ï¼Œè¿™é‡Œå°†å“ˆå¸Œæ›¿æ¢ä¸ºtrieæ ‘ã€‚è¿˜æ˜¯åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„core.goæ–‡ä»¶ï¼Œæ‰¾åˆ°å¯¹åº”ä½ç½®ä½œä¿®æ”¹ï¼š

```go
type Core struct {
	router map[string]*Tree // all routers
}
```

å¯¹åº”è·¯ç”±å¢åŠ çš„æ–¹æ³•ï¼Œä¹Ÿä»å“ˆå¸Œçš„å¢åŠ é€»è¾‘ï¼Œæ›¿æ¢ä¸ºtrieæ ‘çš„â€œå¢åŠ è·¯ç”±è§„åˆ™â€é€»è¾‘ã€‚åŒæ ·æ›´æ–°core.goæ–‡ä»¶ä¸­çš„ä¸‹åˆ—æ–¹æ³•ï¼š

```go
// åˆå§‹åŒ–Coreç»“æ„
func NewCore() *Core {
	// åˆå§‹åŒ–è·¯ç”±
	router := map[string]*Tree{}
	router["GET"] = NewTree()
	router["POST"] = NewTree()
	router["PUT"] = NewTree()
	router["DELETE"] = NewTree()
	return &Core{router: router}
}



// åŒ¹é…GET æ–¹æ³•, å¢åŠ è·¯ç”±è§„åˆ™
func (c *Core) Get(url string, handler ControllerHandler) {
	if err := c.router["GET"].AddRouter(url, handler); err != nil {
		log.Fatal("add router error: ", err)
	}
}

// åŒ¹é…POST æ–¹æ³•, å¢åŠ è·¯ç”±è§„åˆ™
func (c *Core) Post(url string, handler ControllerHandler) {
	if err := c.router["POST"].AddRouter(url, handler); err != nil {
		log.Fatal("add router error: ", err)
	}
}

// åŒ¹é…PUT æ–¹æ³•, å¢åŠ è·¯ç”±è§„åˆ™
func (c *Core) Put(url string, handler ControllerHandler) {
	if err := c.router["PUT"].AddRouter(url, handler); err != nil {
		log.Fatal("add router error: ", err)
	}
}

// åŒ¹é…DELETE æ–¹æ³•, å¢åŠ è·¯ç”±è§„åˆ™
func (c *Core) Delete(url string, handler ControllerHandler) {
	if err := c.router["DELETE"].AddRouter(url, handler); err != nil {
		log.Fatal("add router error: ", err)
	}
}
```

ä¹‹å‰åœ¨Coreä¸­å®šä¹‰çš„åŒ¹é…è·¯ç”±å‡½æ•°çš„å®ç°é€»è¾‘ï¼Œä»å“ˆå¸ŒåŒ¹é…ä¿®æ”¹ä¸ºtrieæ ‘åŒ¹é…å°±å¯ä»¥äº†ã€‚ç»§ç»­æ›´æ–°core.goæ–‡ä»¶ï¼š

```go
// åŒ¹é…è·¯ç”±ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œè¿”å›nil
func (c *Core) FindRouteByRequest(request *http.Request) ControllerHandler {
	// uri å’Œ method å…¨éƒ¨è½¬æ¢ä¸ºå¤§å†™ï¼Œä¿è¯å¤§å°å†™ä¸æ•æ„Ÿ
	uri := request.URL.Path
	method := request.Method
	upperMethod := strings.ToUpper(method)

	// æŸ¥æ‰¾ç¬¬ä¸€å±‚map
	if methodHandlers, ok := c.router[upperMethod]; ok {
		return methodHandlers.FindHandler(uri)
	}
	return nil
}

```

åŠ¨æ€åŒ¹é…è§„åˆ™å°±æ”¹é€ å®Œæˆäº†ã€‚

## éªŒè¯

ç°åœ¨ï¼Œå››ä¸ªéœ€æ±‚éƒ½å·²ç»å®ç°äº†ã€‚æˆ‘ä»¬éªŒè¯ä¸€ä¸‹ï¼šå®šä¹‰åŒ…å«æœ‰é™æ€è·¯ç”±ã€æ‰¹é‡é€šç”¨å‰ç¼€ã€åŠ¨æ€è·¯ç”±çš„è·¯ç”±è§„åˆ™ï¼Œæ¯ä¸ªæ§åˆ¶å™¨æˆ‘ä»¬å°±ç›´æ¥è¾“å‡ºæ§åˆ¶å™¨çš„åå­—ï¼Œç„¶åå¯åŠ¨æœåŠ¡ã€‚

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥å»ä¿®æ”¹ä¸šåŠ¡æ–‡ä»¶å¤¹ä¸‹çš„è·¯ç”±æ–‡ä»¶route.goï¼š

```go
// æ³¨å†Œè·¯ç”±è§„åˆ™
func registerRouter(core *framework.Core) {
	// éœ€æ±‚1+2:HTTPæ–¹æ³•+é™æ€è·¯ç”±åŒ¹é…
	core.Get("/user/login", UserLoginController)

	// éœ€æ±‚3:æ‰¹é‡é€šç”¨å‰ç¼€
	subjectApi := core.Group("/subject")
	{
		// éœ€æ±‚4:åŠ¨æ€è·¯ç”±
		subjectApi.Delete("/:id", SubjectDelController)
		subjectApi.Put("/:id", SubjectUpdateController)
		subjectApi.Get("/:id", SubjectGetController)
		subjectApi.Get("/list/all", SubjectListController)
	}
}
```

åŒæ—¶åœ¨ä¸šåŠ¡æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºå¯¹åº”çš„ä¸šåŠ¡æ§åˆ¶å™¨user\_controller.goå’Œsubject\_controller.goã€‚å…·ä½“é‡Œé¢çš„é€»è¾‘ä»£ç å°±æ˜¯æ‰“å°å‡ºå¯¹åº”çš„æ§åˆ¶å™¨åå­—ï¼Œæ¯”å¦‚

```go
func UserLoginController(c *framework.Context) error {
   // æ‰“å°æ§åˆ¶å™¨åå­—
   c.Json(200, "ok, UserLoginController")
   return nil
}
```

æ¥çœ‹æœåŠ¡å¯åŠ¨æƒ…å†µï¼šè®¿é—®åœ°å€/user/login åŒ¹é…è·¯ç”±UserLoginContorllerã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/df/52/df2cf7aaf2be03c6da8bb8e72a10fd52.png?wh=684x191)

è®¿é—®åœ°å€/subject/list/all åŒ¹é…è·¯ç”±SubjectListControllerã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/b5/0a/b5f4248d9ee478eed83b121c886c640a.png?wh=663x267)

è®¿é—®åœ°å€ /subject/100 åŒ¹é…åŠ¨æ€è·¯ç”± SubjectGetControllerã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/a6/f0/a6f095eb721b20dbeeb6952aa24df7f0.png?wh=655x227)

è·¯ç”±è§„åˆ™ç¬¦åˆè¦æ±‚ï¼

ä»Šå¤©çš„æ–‡ä»¶åŠä»£ç ç»“æ„å¦‚ä¸‹ï¼Œæ–°å»ºçš„æ–‡ä»¶å¤¹å¤šä¸€ç‚¹ä½ å¯ä»¥å¯¹ç…§ç€GitHubå†çœ‹çœ‹ï¼Œä»£ç åœ°å€åœ¨[geekbang/03](https://github.com/gohade/coredemo/tree/geekbang/03)åˆ†æ”¯ä¸Šï¼š  
![](https://static001.geekbang.org/resource/image/c2/3c/c2518fc8d20034aacb93b5e509375b3c.png?wh=726x942)

## å°ç»“

åœ¨è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥å®ç°äº†æ»¡è¶³å››ä¸ªéœ€æ±‚çš„è·¯ç”±ï¼šHTTPæ–¹æ³•åŒ¹é…ã€æ‰¹é‡é€šç”¨å‰ç¼€ã€é™æ€è·¯ç”±åŒ¹é…å’ŒåŠ¨æ€è·¯ç”±åŒ¹é…ã€‚

æˆ‘ä»¬ä½¿ç”¨IGroupç»“æ„å’Œåœ¨Coreä¸­å®šä¹‰keyä¸ºæ–¹æ³•çš„è·¯ç”±ï¼Œå®ç°äº†HTTPæ–¹æ³•åŒ¹é…ã€æ‰¹é‡é€šç”¨å‰ç¼€è¿™ä¸¤ä¸ªéœ€æ±‚ï¼Œå¹¶ä¸”ç”¨å“ˆå¸Œæ¥å®ç°é™æ€è·¯ç”±åŒ¹é…ï¼Œä¹‹åæˆ‘ä»¬ä½¿ç”¨trieæ ‘ç®—æ³•æ›¿ä»£å“ˆå¸Œç®—æ³•ï¼Œå®ç°äº†åŠ¨æ€è·¯ç”±åŒ¹é…çš„éœ€æ±‚ã€‚

æ‰€ä»¥ï¼Œä½ æœ‰æ²¡æœ‰å‘ç°ï¼Œ**å…¶å®æ‰€è°“çš„å®ç°åŠŸèƒ½ï¼Œå†™ä»£ç åªæ˜¯å…¶ä¸­ä¸€å°éƒ¨åˆ†ï¼Œå¦‚ä½•æ€è€ƒã€å¦‚ä½•è€ƒè™‘å®¹é”™æ€§ã€æ‰©å±•æ€§å’Œå¤ç”¨æ€§ï¼Œè¿™ä¸ªåè€Œæ˜¯æ›´å¤§çš„éƒ¨åˆ†**ã€‚

ä»¥ä»Šå¤©å®ç°çš„è·¯ç”±è¿™ä¸ªåŠŸèƒ½ä¸ºä¾‹ï¼Œä½ æ˜¯å¦è€ƒè™‘åˆ°äº†URIçš„å®¹é”™æ€§ï¼Œåœ¨Groupè¿”å›æ—¶å€™æ˜¯å¦ä½¿ç”¨æ¥å£å¢åŠ æ‰©å±•æ€§ï¼Œåœ¨å®ç°åŠ¨æ€åŒ¹é…çš„æ—¶å€™æ˜¯å¦è€ƒè™‘å‡½æ•°å¤ç”¨æ€§ã€‚æˆ‘ä»¬è¦è®°ä½çš„æ˜¯ï¼Œæ€è·¯æ¯”ä»£ç å®ç°æ›´é‡è¦ã€‚

# æ€è€ƒé¢˜

å…‰è¯´ä¸ç»ƒå‡æŠŠå¼ï¼Œæ¯•ç«Ÿæˆ‘ä»¬æ˜¯å®æˆ˜è¯¾ï¼Œé‚£é’ˆå¯¹ç¬¬ä¸‰ä¸ªéœ€æ±‚â€œæ‰¹é‡é€šç”¨å‰ç¼€â€ï¼Œæˆ‘ä»¬æ‰©å±•ä¸€ä¸‹å˜æˆï¼šéœ€è¦èƒ½å¤šå±‚åµŒå¥—é€šç”¨å‰ç¼€ï¼Œè¿™ä¹ˆå®šä¹‰è·¯ç”±ï¼š

```go
// æ³¨å†Œè·¯ç”±è§„åˆ™
func registerRouter(core *framework.Core) {
	// é™æ€è·¯ç”±+HTTPæ–¹æ³•åŒ¹é…
	core.Get("/user/login", UserLoginController)

	// æ‰¹é‡é€šç”¨å‰ç¼€
	subjectApi := core.Group("/subject")
	{
		subjectInnerApi := subjectApi.Group("/info")
		{
			subjectInnerApi.Get("/name", SubjectNameController)	
		}
    }
}
```

ç»“åˆåˆšæ‰è¯´çš„è€ƒè™‘ä»£ç çš„è®¾è®¡æ„Ÿï¼Œä½ æƒ³ä¸€æƒ³å¦‚ä½•å®ç°å‘¢ï¼Ÿ

æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒã€‚å¦‚æœä½ è§‰å¾—ä»Šå¤©çš„å†…å®¹å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œé‚€è¯·ä»–ä¸€èµ·å­¦ä¹ ï½
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>å¥½å®¶åº­</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä¸ºIGroupå®ç°å¦‚ä¸‹æ¥å£ï¼š
Group(string) IGroup

ç±»ä¼¼äºbuilderè®¾è®¡æ¨¡å¼ï¼Œå¯ä»¥é“¾å¼è°ƒç”¨</p>2021-09-17</li><br/><li><span>è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä¸¤ç§è·¯ç”±æ–¹å¼æ˜¯ä¸æ˜¯å¯ä»¥çœ‹æˆä¸€ç±»ï¼Œåº•å±‚å­˜å‚¨ä¸åŒï¼ŸåŠ¨æ€æ˜¯æŒ‡åŠ¨æ€æ ¹æ®uriæ·»åŠ å’Œè·å–handlerã€‚å¦å¤–è¿™ç§åŠ¨æ€æ˜¯å¦æœ‰å¿…è¦å»åšï¼Œæ¯•ç«Ÿmapæ˜¯O(1)</p>2021-12-07</li><br/><li><span>å‹</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>ä»”ç»†æ€è€ƒäº†ä¸‹è¿™ä¸ªtrieğŸŒ²ï¼Œè·¯ç”±å¦‚æœæ˜¯ &#47;user&#47;login åˆ‡å‰²ä¹‹å ä¼šå‡ºç°ä¸€å±‚segment ä¸º ç©ºå­—ç¬¦ä¸² è¿™æ ·ä¼šæµªè´¹ä¸€äº›ç©ºé—´ è¿™ç§ç©ºåº”è¯¥ç”¨ä¸åˆ°å§ æˆ‘è§‰å¾—å¯ä»¥å¤„ç†ä¸‹ ä¸çŸ¥é“è€å¸ˆæ€ä¹ˆçœ‹

å½“å‰ç¬¬0å±‚ segment=
å½“å‰ç¬¬1å±‚ segment=
å½“å‰ç¬¬2å±‚ segment= USER
è¯•ç€å†™äº†ä¸€ä¸ªå¤šå‰æ ‘çš„æ‰“å°ï¼Œç¬¬0å±‚æ˜¯ tree.root ç¡®å®ä¸ºç©º ä½†æ˜¯ç¬¬ä¸€å±‚ä¹Ÿä¸ºç©º</p>2021-11-30</li><br/><li><span>å°ç„¶</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>æ–‡ä¸­çš„æ ‘çš„å›¾ç»“æ„æ˜¯å¦é—®é¢˜å‘¢ï¼ŒæŒ‰ç…§ä»£ç å®é™…ç”Ÿæˆçš„æ¯ä¸€é¢—trieæ ‘rootèŠ‚ç‚¹ä¸‹é¢ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹å®é™…ä¸Šæ˜¯segmentä¸ºç©ºçš„èŠ‚ç‚¹ï¼Œç„¶ååœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸‹æ‰æ˜¯å„ä¸ªä¸€çº§è·¯åŠ²çš„å­èŠ‚ç‚¹ã€‚æ˜¯æˆ‘ç†è§£é”™è¯¯å—ï¼Ÿæˆ‘å¸¦ç€æ–‡ä¸­çš„æ ‘å›¾ç»“æ„å»çœ‹ä»£ç æ·»åŠ è·¯ç”±ç®—æ³•çœ‹èµ·æ¥æœ‰å¾ˆå¤§çš„åå·®ï¼Œè„‘è¢‹é‡Œæƒ³è±¡çº æ­£ï¼Œå…ˆåœ¨rootèŠ‚ç‚¹ä¸‹å…ˆåŠ ä¸€ä¸ªsegmentä¸ºç©ºçš„èŠ‚ç‚¹å°±å¥½ç†è§£äº†ã€‚</p>2021-09-17</li><br/><li><span>é‚¹å¿—é¹.Joey â·â·â·</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>child çš„å¤æ•°å½¢å¼æ˜¯ children, å¸Œæœ›å¯ä»¥æ”¹ä¸‹</p>2023-01-31</li><br/><li><span>æˆ‘æ˜¯ç†Šå¤§</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>çœ‹äº†ä¸‰ç« è§‰å¾—ä½œè€…å¯¹äºGOçš„ä½¿ç”¨ï¼Œæˆ–è€…è¯´æ˜¯æ¶æ„è®¾è®¡å·²ç»ç‚‰ç«çº¯é’ï¼Œç»†èŠ‚å¾ˆåˆ°ä½</p>2022-11-28</li><br/><li><span>å’¸é±¼</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>æœ‰ä¸ªå°é—®é¢˜æƒ³å’¨è¯¢ä¸€ä¸‹è€å¸ˆï¼ŒfilterChildNodesè¿™ä¸ªå‡½æ•°æ˜¯å¦å¯ä»¥åªè¿”å›ä¸€ä¸ª*nodeï¼Œåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¿”å›å¤šä¸ª*nodeï¼Ÿæ„Ÿè§‰æŒ‰ç…§çº¦æŸæ¡ä»¶æ¥çœ‹ï¼ŒfilterChildNodesåªæœ‰å¯èƒ½è¿”å›ä¸€ä¸ª*node</p>2021-12-11</li><br/><li><span>å‹</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆçš„å­—å…¸æ ‘æ€è·¯å·¨æ¸…æ™°ï¼Œä¹‹åé‡æ„çš„æ—¶å€™è‡ªå·±é‡æ–°æŠŠå­—å…¸æ ‘å†™äº† éƒ½æœ‰ç‚¹æ¨¡ç³Šäº† æœŸå¾…åç»­æ–‡ä»¶ æ„Ÿè°¢è€å¸ˆåˆ†äº«</p>2021-11-30</li><br/><li><span>å‹</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>åˆ·äº†ä¸€ä¸ªæœˆçš„leetcode è®©æˆ‘çš„ç¬¬ä¸€ååº”æ˜¯å­—å…¸æ ‘ åº”è¯¥æ²¡è¯´é”™</p>2021-11-30</li><br/><li><span>æœ¨å°æŸ’</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>&#47;user&#47;name
&#47;user&#47;:id

ä¸€å¼€å§‹çœ‹è¿™ä¸ªï¼Œæƒ³æ‰¾ä¸ªå†²çªæŒºå¥‡æ€ªçš„ï¼Œè¿™ä¸ªæ„Ÿè§‰è¿˜ç®—æ­£å¸¸ï¼Œæ‰å‘è§‰åŸæ¥è¿™é‡Œ :id ç±»ä¼¼ gin é‡Œé¢çš„ *id</p>2021-09-21</li><br/><li><span>åŠæ ¼å¼Hal</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è€å¸ˆå¥½ï¼Œä¸¤çº§æ˜ å°„å“ˆå¸Œï¼Œâ€œç¬¬ä¸€çº§ hash æ˜¯è¯·æ±‚ Methodï¼Œç¬¬äºŒçº§ hash æ˜¯ Requets-URIâ€ã€‚èƒ½ä¸èƒ½ç¬¬ä¸€çº§Request-URIï¼Œç¬¬äºŒçº§Methodçš„å‘¢ï¼Ÿä¼šæœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿé¡ºä¾¿è¯´ä¸‹è¿™é‡ŒRequestæ‰“é”™äº†ã€‚</p>2021-09-19</li><br/><li><span>qinsi</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>&#47;:user&#47;name(å†²çª)
&#47;:user&#47;name&#47;:age

è¿™ä¸¤ä¸ªæ˜¯ä¸æ˜¯å†™åäº†</p>2021-09-18</li><br/><li><span>èŒƒé£æ‰¬</span> ğŸ‘ï¼ˆ9ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¿™æ®µä»£ç 

if cnodes == nil || len(cnodes) == 0 { return nil }

åº”è¯¥æ”¹æˆè¿™æ ·

if len(cnodes) == 0 { return nil }

å› ä¸º
å‚è€ƒlen()çš„æ³¨é‡Šï¼š
Slice, or map: the number of elements in v; if v is nil, len(v) is zero.
æ‰€ä»¥ç›´æ¥ç”¨len(cnodes) å°±å¯ä»¥äº†</p>2022-10-31</li><br/><li><span>å‘¨å¯¿é•¿</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>(tree *Tree) AddRouteræ–¹æ³•ç”¨é€’å½’å®ç°æ›´å®¹æ˜“çœ‹æ‡‚</p>2021-09-30</li><br/><li><span>Geek_05d654</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>IGroup æ–°å¢æ¥å£ï¼š
Group(string) IGroup

type Group struct {
	core    *Core
	prefixs []string
}

&#47;&#47; åˆå§‹åŒ–Group
func NewGroup(core *Core, prefix string) *Group {
	prefixs := []string{prefix}
	return &amp;Group{
		core:    core,
		prefixs: prefixs,
	}
}

&#47;&#47; å®ç°Getæ–¹æ³•
func (g *Group) Get(uri string, handler ControllerHandler) {
	prefixs := &quot;&quot;
	for _, prefix := range g.prefixs {
		prefixs = prefixs + prefix
	}
	uri = prefixs + uri
	g.core.Get(uri, handler)
}

func (g *Group) Group(prefix string) IGroup {
	g.prefixs = append(g.prefixs, prefix)
	return g
}

&#47;&#47; ä»coreä¸­åˆå§‹åŒ–è¿™ä¸ªGroup
func (c *Core) Group(prefix string) IGroup {
	return NewGroup(c, prefix)
}</p>2022-05-18</li><br/>
</ul>