ä½ å¥½ï¼Œæˆ‘æ˜¯è½©è„‰åˆƒã€‚

åœ¨å‰é¢çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šå·²ç»å®Œæˆäº†ä¸€ä¸ªèƒ½åŒæ—¶ç”Ÿæˆå‰ç«¯å’Œåç«¯çš„æ¡†æ¶hadeï¼Œä¹Ÿèƒ½å¾ˆæ–¹ä¾¿å¯¹æ¡†æ¶è¿›è¡Œç®¡ç†æ§åˆ¶ã€‚ä¸‹é¢ä¸¤èŠ‚è¯¾ï¼Œæˆ‘ä»¬æ¥è€ƒè™‘æ¡†æ¶çš„ä¸€äº›å‘¨è¾¹åŠŸèƒ½ï¼Œæ¯”å¦‚éƒ¨ç½²è‡ªåŠ¨åŒ–ã€‚

éƒ¨ç½²è‡ªåŠ¨åŒ–å…¶å®ä¸æ˜¯ä¸€ä¸ªæ¡†æ¶çš„åˆšéœ€ï¼Œæœ‰å¾ˆå¤šæ–¹å¼å¯ä»¥å°†ä¸€ä¸ªæœåŠ¡è¿›è¡Œè‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œæ¯”å¦‚ç°åœ¨æ¯”è¾ƒæµè¡Œçš„DockeråŒ–æˆ–è€…CI/CDæµç¨‹ã€‚

ä½†æ˜¯ä¸€äº›æ¯”è¾ƒä¸ªäººæ¯”è¾ƒå°çš„é¡¹ç›®ï¼Œæ¯”å¦‚ä¸€ä¸ªåšå®¢ã€ä¸€ä¸ªå®˜ç½‘ç½‘ç«™ï¼Œ**è¿™äº›éƒ¨ç½²æµç¨‹å¾€å¾€éƒ½å¤ªåºå¤§äº†ï¼Œæ›´éœ€è¦ä¸€ä¸ªæœåŠ¡ï¼Œèƒ½å¿«é€Ÿå°†åœ¨å¼€å‘æœºå™¨ä¸Šå†™å¥½ã€è°ƒè¯•å¥½çš„ç¨‹åºä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼Œå¹¶ä¸”æ›´æ–°åº”ç”¨ç¨‹åº**ã€‚è¿™å°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦å®ç°çš„æ¡†æ¶å‘å¸ƒè‡ªåŠ¨åŒ–ã€‚

æ‰€æœ‰çš„éƒ¨ç½²è‡ªåŠ¨åŒ–å·¥å…·ï¼ŒåŸºæœ¬éƒ½ä¾èµ–æœ¬åœ°ä¸è¿œç«¯æœåŠ¡å™¨çš„è¿æ¥ï¼Œè¿™ä¸ªè¿æ¥å¯ä»¥æ˜¯FTPï¼Œå¯ä»¥æ˜¯HTTPï¼Œä½†æ˜¯æ›´ç»å¸¸çš„è¿æ¥æ˜¯SSHè¿æ¥ã€‚å› ä¸ºä¸€æ—¦æˆ‘ä»¬è´­ä¹°äº†ä¸€ä¸ªWebæœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æä¾›å•†å°±ä¼šæä¾›ä¸€ä¸ªæœ‰SSHç™»å½•è´¦å·çš„æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªè´¦å·ç™»å½•åˆ°æœåŠ¡å™¨ä¸Šï¼Œæ¥è¿›è¡Œå„ç§è½¯ä»¶çš„å®‰è£…ï¼Œæ¯”å¦‚FTPã€HTTPæœåŠ¡ç­‰ã€‚

åŸºæœ¬ä¸Šï¼ŒSSHè´¦å·æ˜¯æˆ‘ä»¬æ‹¿åˆ°WebæœåŠ¡å™¨çš„é¦–è¦å‡­è¯ï¼Œæ‰€ä»¥è¦è®¾è®¡çš„è‡ªåŠ¨åŒ–å‘å¸ƒç³»ç»Ÿä¹Ÿæ˜¯ä¾èµ–SSHçš„ã€‚

## SSHæœåŠ¡

é‚£ä¹ˆåœ¨Golangä¸­å¦‚ä½•SSHè¿æ¥è¿œç«¯çš„æœåŠ¡å™¨å‘¢ï¼Ÿæœ‰ä¸€ä¸ª[ssh](https://golang.org/x/crypto/ssh)åº“èƒ½å®ŒæˆSSHçš„è¿œç«¯è¿æ¥ã€‚

è¿™é‡Œä»‹ç»ä¸€ä¸ªå°çŸ¥è¯†ï¼Œä½ å¯ä»¥çœ‹ä¸‹è¿™ä¸ªsshåº“çš„gitï¼šgolang.org/x/crypto/sshã€‚å®ƒæ˜¯åœ¨å®˜ç½‘golang.org ä¸‹çš„ï¼Œä½†æ˜¯åˆä¸æ˜¯å®˜æ–¹çš„æ ‡å‡†åº“ï¼Œå› ä¸ºå­ç›®å½•æ˜¯xã€‚

è¿™ç§åº“å…¶å®ä¹Ÿæ˜¯ç»è¿‡å®˜æ–¹è®¤è¯çš„ï¼Œå±äºå®éªŒæ€§çš„åº“ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆç†è§£ï¼š**ä»¥golang.org/x/ å¼€å¤´çš„åº“ï¼Œéƒ½æ˜¯å®˜æ–¹è®¤ä¸ºè¿™äº›åº“åç»­æœ‰å¯èƒ½æˆä¸ºæ ‡å‡†åº“çš„ä¸€éƒ¨ä»½**ï¼Œä½†æ˜¯ç”±äºç§ç§åŸå› ï¼Œç°åœ¨è¿˜æ²¡æœ‰è®¡åˆ’æ”¾è¿›æ ‡å‡†åº“ä¸­ï¼Œéœ€è¦æ›´å¤šæ—¶é—´æ‰“ç£¨ã€‚ä½†æ˜¯è¿™ç§åº“çš„ç»´æŠ¤è€…å’Œå¼€å‘è€…ä¸€èˆ¬å·²ç»æ˜¯Golangå®˜æ–¹ç»„çš„äººå‘˜äº†ã€‚æ¯”å¦‚ç°åœ¨ä»Šå¹´è®¨è®ºçƒ­åº¦å¾ˆå¤§çš„Golangæ³›å‹ï¼Œæ®è¯´ä¹Ÿä¼šå…ˆä»¥å®éªŒåº“çš„å½¢å¼å‡ºç°ã€‚

ä¸ç®¡æ€ä¹ˆæ ·ï¼Œè¿™ç§ä»¥golang.org/x/å¼€å¤´çš„åº“ï¼Œæˆç†Ÿåº¦å·²ç»éå¸¸é«˜äº†ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥æ”¾å¿ƒä½¿ç”¨çš„ã€‚æ¥äº†è§£ä¸€ä¸‹è¿™ä¸ªsshåº“ï¼š

```go
package main

import (
	"bytes"
	"fmt"
	"log"

	"golang.org/x/crypto/ssh"
)

func main() {
	var hostKey ssh.PublicKey

	// sshç›¸å…³é…ç½®
	config := &ssh.ClientConfig{
		User: "username",
		Auth: []ssh.AuthMethod{
			ssh.Password("yourpassword"),
		},
		HostKeyCallback: ssh.FixedHostKey(hostKey),
	}
    // åˆ›å»ºclient
	client, err := ssh.Dial("tcp", "yourserver.com:22", config)
	if err != nil {
		log.Fatal("Failed to dial: ", err)
	}
	defer client.Close()

    // ä½¿ç”¨clientåšå„ç§æ“ä½œ
	
	session, err := client.NewSession()
	if err != nil {
		log.Fatal("Failed to create session: ", err)
	}
	defer session.Close()

	var b bytes.Buffer
	session.Stdout = &b
	if err := session.Run("/usr/bin/whoami"); err != nil {
		log.Fatal("Failed to run: " + err.Error())
	}
	fmt.Println(b.String())
}
```

åœ¨è¿™ä¸ªå®˜æ–¹ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°sshåº“ä½œä¸ºå®¢æˆ·ç«¯è¿æ¥ï¼Œæœ€é‡è¦çš„æ˜¯åˆ›å»ºssh.Clientè¿™ä¸ªæ•°æ®ç»“æ„ï¼Œè€Œè¿™ä¸ªæ•°æ®ç»“æ„ä½¿ç”¨ssh.Dailèƒ½è¿›è¡Œåˆ›å»ºï¼Œåˆ›å»ºçš„æ—¶å€™ä¾èµ–ssh.ClientConfigè¿™ä¹ˆä¸€ä¸ªé…ç½®ç»“æ„ã€‚

æ˜¯ä¸æ˜¯éå¸¸ç†Ÿæ‚‰ï¼Ÿå’Œå‰é¢çš„Gormã€Redisä¸€æ ·ï¼Œå°†SSHçš„è¿æ¥éƒ¨åˆ†å°è£…æˆä¸ºhadeæ¡†æ¶çš„SSHæœåŠ¡ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å¾ˆæ–¹ä¾¿åœ°åˆå§‹åŒ–ä¸€ä¸ªssh.Clientäº†ã€‚

ç»è¿‡å‰é¢å‡ èŠ‚è¯¾ï¼Œç›¸ä¿¡ä½ å·²ç»éå¸¸ç†Ÿæ‚‰è¿™ç§å¥—è·¯äº†ï¼Œæˆ‘ä»¬å°±ç®€è¦è¯´æ˜ä¸‹ssh serviceçš„å°è£…å’Œå®ç°æ€è·¯ã€‚è¿™èŠ‚è¯¾çš„é‡ç‚¹åœ¨åé¢å¯¹è‡ªåŠ¨åŒ–å‘å¸ƒç³»ç»Ÿçš„å®ç°ä¸Šã€‚

ssh serviceçš„å°è£…ä¸€æ ·æœ‰ä¸‰ä¸ªéƒ¨åˆ†ï¼ŒæœåŠ¡åè®®ã€æœåŠ¡æä¾›è€…ã€æœåŠ¡å®ç°ã€‚

æœåŠ¡åè®®æˆ‘ä»¬æä¾›GetClientæ–¹æ³•ï¼š

```go
// SSHService è¡¨ç¤ºä¸€ä¸ªsshæœåŠ¡
type SSHService interface {
   // GetClient è·å–sshè¿æ¥å®ä¾‹
   GetClient(option ...SSHOption) (*ssh.Client, error)
}
```

è€Œå…¶ä¸­çš„SSHOptionä½œä¸ºæ›´æ–°SSHConfigçš„å‡½æ•°ï¼š

```go
// SSHOption ä»£è¡¨åˆå§‹åŒ–çš„æ—¶å€™çš„é€‰é¡¹
type SSHOption func(container framework.Container, config *SSHConfig) error
```

æˆ‘ä»¬å°è£…é…ç½®ç»“æ„ä¸º SSHConfigï¼š

```go
// SSHConfig ä¸ºhadeå®šä¹‰çš„SSHé…ç½®ç»“æ„
type SSHConfig struct {
   NetWork string
   Host    string
   Port    string
   *ssh.ClientConfig
}
```

å¯¹åº”çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ config/testing/ssh.yamlï¼Œä½ å¯ä»¥çœ‹çœ‹æ¯ä¸ªé…ç½®çš„è¯´æ˜ï¼š

```yaml
timeout: 1s
network: tcp
web-01:
    host: 118.190.3.55 # ipåœ°å€
    port: 22 # ç«¯å£
    username: yejianfeng # ç”¨æˆ·å
    password: "123456" # å¯†ç 
web-02:
    network: tcp
    host: localhost # ipåœ°å€
    port: 3306 # ç«¯å£
    username: jianfengye # ç”¨æˆ·å
    rsa_key: "/Users/user/.ssh/id_rsa"
    known_hosts: "/Users/user/.ssh/known_hosts"
```

è¿™é‡Œæ³¨æ„ä¸‹ï¼ŒSSHçš„è¿æ¥æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ç›´æ¥ä½¿ç”¨ç”¨æˆ·åå¯†ç æ¥è¿æ¥è¿œç¨‹æœåŠ¡å™¨ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯ä½¿ç”¨rsa keyæ–‡ä»¶æ¥è¿æ¥è¿œç«¯æœåŠ¡å™¨ï¼Œæ‰€ä»¥è¿™é‡Œçš„é…ç½®éœ€è¦åŒæ—¶æ”¯æŒä¸¤ç§é…ç½®ã€‚**å¯¹äºä½¿ç”¨rsa keyæ–‡ä»¶çš„æ–¹å¼ï¼Œéœ€è¦è®¾ç½®rsk\_keyçš„ç§é’¥åœ°å€å’Œè´Ÿè´£å®‰å…¨éªŒè¯çš„known\_hosts**ã€‚

å®šä¹‰å¥½äº†SSHçš„æœåŠ¡åè®®ï¼ŒæœåŠ¡æä¾›è€…å’ŒæœåŠ¡å®ç°å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ï¼Œå°±ä¸å±•ç¤ºå…·ä½“ä»£ç äº†ï¼Œåœ¨GitHubä¸Šçš„[provider/ssh/provider.go](https://github.com/gohade/coredemo/blob/geekbang/28/framework/provider/ssh/provider.go) å’Œ[provider/ssh/service.go](https://github.com/gohade/coredemo/blob/geekbang/28/framework/provider/ssh/service.go)ä¸­ã€‚æˆ‘ä»¬ç®€å•è¯´ä¸€ä¸‹æ€è·¯ã€‚

å¯¹äºæœåŠ¡æä¾›è€…ï¼Œæˆ‘ä»¬å®ç°åŸºæœ¬çš„äº”ä¸ªå‡½æ•°Register/Boot/IsDefer/Param/Nameã€‚å¦å¤–è¿™ä¸ªsshæœåŠ¡å¹¶ä¸æ˜¯æ¡†æ¶å¯åŠ¨æ—¶å€™å¿…è¦åŠ è½½çš„ï¼Œæ‰€ä»¥è®¾ç½®IsDeferä¸ºtrueï¼Œè€ŒParamæˆ‘ä»¬å°±ç…§ä¾‹æŠŠæœåŠ¡å®¹å™¨containerä½œä¸ºå‚æ•°ï¼Œä¼ é€’ç»™Registerè®¾å®šçš„å®ä¾‹åŒ–æ–¹æ³•ã€‚

è€ŒSSHæœåŠ¡çš„å…·ä½“å®ç°ï¼ŒåŒæ ·ç±»ä¼¼Redisï¼Œå…ˆé…ç½®æ›´æ–°ï¼Œå†æŸ¥è¯¢æ˜¯å¦å·²ç»å®ä¾‹åŒ–ï¼Œè‹¥å·²ç»å®ä¾‹åŒ–ï¼Œè¿”å›å®ä¾‹åŒ–å¯¹è±¡ï¼›è‹¥æ²¡æœ‰å®ä¾‹åŒ–ï¼Œå®ä¾‹åŒ–clientï¼Œå¹¶ä¸”å­˜åœ¨mapä¸­ã€‚

å®Œæˆäº†SSHçš„æœåŠ¡åè®®ã€æœåŠ¡æä¾›è€…ã€æœåŠ¡å®ä¾‹ï¼Œæˆ‘ä»¬å°±é‡ç‚¹è®¨è®ºä¸‹å¦‚ä½•ä½¿ç”¨SSHçš„æœåŠ¡åè®®æ¥å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚

## è‡ªåŠ¨åŒ–éƒ¨ç½²

é¦–å…ˆè¿˜æ˜¯æ€è€ƒæ¸…æ¥šè‡ªåŠ¨åŒ–éƒ¨ç½²çš„å‘½ä»¤è®¾è®¡ã€‚æˆ‘ä»¬çš„hadeæ¡†æ¶æ˜¯åŒæ—¶æ”¯æŒå‰åç«¯çš„å¼€å‘æ¡†æ¶ï¼Œæ‰€ä»¥è‡ªåŠ¨åŒ–éƒ¨ç½²æ˜¯éœ€è¦åŒæ—¶æ”¯æŒå‰åç«¯éƒ¨ç½²çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒçš„å‘½ä»¤ä¹Ÿéœ€è¦æ”¯æŒå‰åç«¯çš„éƒ¨ç½²ï¼Œè¿™é‡Œæˆ‘ä»¬è®¾è®¡ä¸€ä¸ªæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯çš„ä¸€çº§å‘½ä»¤`./hade deploy` å’Œå››ä¸ªäºŒçº§å‘½ä»¤ï¼š

- `./hade deploy frontend` ï¼Œéƒ¨ç½²å‰ç«¯
- `./hade deploy backend` ï¼Œéƒ¨ç½²åç«¯
- `./hade deploy all` ï¼ŒåŒæ—¶éƒ¨ç½²å‰åç«¯
- `./hade deploy rollback` ï¼Œéƒ¨ç½²å›æ»š

åŒæ—¶ä¹Ÿè®¾è®¡ä¸€ä¸‹éƒ¨ç½²é…ç½®æ–‡ä»¶ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬æ˜¯éœ€è¦çŸ¥é“éƒ¨ç½²åœ¨å“ªä¸ªæˆ–è€…å“ªå‡ ä¸ªæœåŠ¡å™¨ä¸Šçš„ï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸€ä¸ªæ•°ç»„é…ç½®é¡¹connectionsæ¥å®šä¹‰éƒ¨ç½²æœåŠ¡å™¨ã€‚è€Œéƒ¨ç½²æœåŠ¡å™¨çš„å…·ä½“ç”¨æˆ·åå¯†ç é…ç½®ï¼Œåœ¨å‰é¢SSHçš„é…ç½®é‡Œæ˜¯å­˜åœ¨çš„ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥æŠŠSSHçš„é…ç½®è·¯å¾„æ”¾åœ¨æˆ‘ä»¬çš„connectionsä¸­å°±å¯ä»¥äº†ã€‚

å…¶æ¬¡ï¼Œè¿˜è¦çŸ¥é“æˆ‘ä»¬è¦éƒ¨ç½²çš„è¿œç«¯æœåŠ¡å™¨çš„ç›®æ ‡æ–‡ä»¶å¤¹æ˜¯ä»€ä¹ˆï¼Ÿæ‰€ä»¥è¿™é‡Œéœ€è¦æœ‰ä¸€ä¸ªremote\_folderé…ç½®é¡¹æ¥é…ç½®è¿œç«¯æ–‡ä»¶å¤¹ã€‚

ç„¶åå°±æ˜¯å‰ç«¯éƒ¨ç½²çš„é…ç½®frontendäº†ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨æœ¬åœ°ç¼–è¯‘ä¹‹åï¼Œä¼šç›´æ¥ç¼–è¯‘æˆäº†distç›®å½•ä¸‹çš„HTML/JS/CSSæ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶ç›´æ¥ä¸Šä¼ åˆ°è¿œç«¯æ–‡ä»¶å¤¹å°±æ˜¯å¯ä»¥ä½¿ç”¨çš„äº†ã€‚

ä½†æ˜¯ï¼Œåœ¨ä¸Šä¼ å‰ç«¯ç¼–è¯‘æ–‡ä»¶ä¹‹å‰å’Œåœ¨è¿œç«¯æœåŠ¡å™¨æ‰§è¡Œä¸€äº›å‘½ä»¤ä¹‹åï¼Œæ˜¯æœ‰å¯èƒ½è¦åšä¸€äº›æ“ä½œçš„ã€‚æ¯”å¦‚ä¸Šä¼ å‰å…ˆæ¸…ç©ºè¿œç«¯æ–‡ä»¶å¤¹ã€ä¸Šä¼ åæ›´æ–°nginxç­‰ã€‚æ‰€ä»¥è¿™é‡Œï¼Œ**æˆ‘ä»¬è®¾è®¡ä¸¤ä¸ªæ•°ç»„ç»“æ„pre\_actionå’Œpost\_actionæ¥åˆ†åˆ«å­˜æ”¾éƒ¨ç½²çš„å‰ç½®å‘½ä»¤å’Œéƒ¨ç½²çš„åç½®å‘½ä»¤**ã€‚

æœ€åå°±æ˜¯åç«¯éƒ¨ç½²çš„é…ç½®backendã€‚åŒå‰ç«¯éƒ¨ç½²ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿæœ‰éƒ¨ç½²çš„å‰ç½®å‘½ä»¤å’Œåç½®å‘½ä»¤ã€‚ä½†æ˜¯åç«¯ç¼–è¯‘è¿˜æœ‰ä¸€ä¸ªä¸åŒç‚¹ã€‚

å› ä¸ºåç«¯æ˜¯Golangç¼–è¯‘çš„ï¼Œè€Œå®ƒçš„ç¼–è¯‘å…¶å®æ˜¯åˆ†å¹³å°çš„ï¼ŒåŠ ä¸ŠGoæ”¯æŒâ€œäº¤å‰ç¼–è¯‘â€ã€‚å°±æ˜¯è¯´ï¼Œæ¯”å¦‚æˆ‘çš„å·¥ä½œæœºå™¨æ˜¯Macæ“ä½œç³»ç»Ÿï¼ŒWebæœåŠ¡å™¨æ˜¯Linuxæ“ä½œç³»ç»Ÿï¼Œé‚£ä¹ˆæˆ‘éœ€è¦ç¼–è¯‘Linuxæ“ä½œç³»ç»Ÿçš„åç«¯ç¨‹åºï¼Œä½†æ˜¯æˆ‘å¯ä»¥ç›´æ¥åœ¨Macæ“ä½œç³»ç»Ÿä¸Šä½¿ç”¨GOOS å’Œ GOARCH æ¥ç¼–è¯‘Linuxæ“ä½œç³»ç»Ÿçš„ç¨‹åºï¼š

```go
GOOS=linux GOARCH=amd64 go build ./
```

è¿™æ ·ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶å°±æ˜¯å¯ä»¥åœ¨Linuxè¿è¡Œçš„åç«¯è¿›ç¨‹äº†ã€‚æ‰€ä»¥åœ¨åç«¯éƒ¨ç½²çš„é…ç½®é¡¹é‡Œé¢ï¼Œæˆ‘ä»¬å¢åŠ GOOS å’Œ GOARCHåˆ†åˆ«è¡¨ç¤ºåç«¯çš„äº¤å‰ç¼–è¯‘å‚æ•°ã€‚

å®Œæ•´çš„é…ç½®æ–‡ä»¶åœ¨config/development/deploy.yamlä¸­ï¼š

```yaml
connections: # è¦è‡ªåŠ¨åŒ–éƒ¨ç½²çš„è¿æ¥
    - ssh.web-01

remote_folder: "/home/yejianfeng/coredemo/"  # è¿œç«¯çš„éƒ¨ç½²æ–‡ä»¶å¤¹

frontend: # å‰ç«¯éƒ¨ç½²é…ç½®
    pre_action: # éƒ¨ç½²å‰ç½®å‘½ä»¤
        - "pwd"
    post_action: # éƒ¨ç½²åç½®å‘½ä»¤
        - "pwd"

backend: # åç«¯éƒ¨ç½²é…ç½®
    goos: linux # éƒ¨ç½²ç›®æ ‡æ“ä½œç³»ç»Ÿ
    goarch: amd64 # éƒ¨ç½²ç›®æ ‡cpuæ¶æ„
    pre_action: # éƒ¨ç½²å‰ç½®å‘½ä»¤
        - "pwd"
    post_action: # éƒ¨ç½²åç½®å‘½ä»¤
        - "chmod 777 /home/yejianfeng/coredemo/hade"
        - "/home/yejianfeng/coredemo/hade app restart"
```

å¥½ï¼Œé…ç½®æ–‡ä»¶è®¾è®¡å¥½äº†ï¼Œä¸‹é¢æˆ‘ä»¬å¼€å§‹å®ç°å¯¹åº”çš„å‘½ä»¤ã€‚

å…¶å®ä¼°è®¡ä½ å¯¹å¦‚ä½•å®ç°ï¼Œå·²ç»å¤§è‡´å¿ƒä¸­æœ‰æ•°äº†ã€‚ä¸€çº§å‘½ä»¤ `./hade deploy` è¿˜æ˜¯å¹¶æ²¡æœ‰ä»€ä¹ˆå†…å®¹ï¼Œåªæ˜¯å°†å¸®åŠ©ä¿¡æ¯æ‰“å°å‡ºæ¥ï¼Œä¹‹å‰ä¹Ÿåšè¿‡å¾ˆå¤šæ¬¡ï¼Œå°±ä¸æè¿°äº†ã€‚äºŒçº§å‘½ä»¤æŒ‰ä¹‹å‰çš„å¥—è·¯ï¼Œä¸€èˆ¬æ˜¯å…ˆç¼–è¯‘ï¼Œå†éƒ¨ç½²ï¼Œæœ€åä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚

### éƒ¨ç½²å‰ç«¯

çœ‹äºŒçº§å‘½ä»¤ `./hade deploy frontend`ã€‚å¯¹äºéƒ¨ç½²å‰ç«¯ï¼Œæˆ‘ä»¬åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š

- åˆ›å»ºè¦éƒ¨ç½²çš„æ–‡ä»¶å¤¹ï¼›
- ç¼–è¯‘å‰ç«¯æ–‡ä»¶åˆ°éƒ¨ç½²æ–‡ä»¶å¤¹ä¸­ï¼›
- ä¸Šä¼ éƒ¨ç½²æ–‡ä»¶å¤¹ï¼Œå¹¶ä¸”æ‰§è¡Œå¯¹åº”çš„å‰ç½®å’Œåç½®çš„shellã€‚

åœ¨framework/command/deploy.goä¸­ï¼š

```go
// deployFrontendCommand éƒ¨ç½²å‰ç«¯
var deployFrontendCommand = &cobra.Command{
    Use:   "frontend",
    Short: "éƒ¨ç½²å‰ç«¯",
    RunE: func(c *cobra.Command, args []string) error {
        container := c.GetContainer()

        // åˆ›å»ºéƒ¨ç½²æ–‡ä»¶å¤¹
        deployFolder, err := createDeployFolder(container)
        if err != nil {
            return err
        }

        // ç¼–è¯‘å‰ç«¯åˆ°éƒ¨ç½²æ–‡ä»¶å¤¹
        if err := deployBuildFrontend(c, deployFolder); err != nil {
            return err
        }

        // ä¸Šä¼ éƒ¨ç½²æ–‡ä»¶å¤¹å¹¶æ‰§è¡Œå¯¹åº”çš„shell
        return deployUploadAction(deployFolder, container, "frontend")
    },
}
```

è¿™é‡Œå¯èƒ½ä½ ä¼šæœ‰ä¸ªç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆè¦åˆ›å»ºä¸€ä¸ªéƒ¨ç½²æ–‡ä»¶å¤¹ï¼Ÿæˆ‘ä»¬ç›´æ¥å°†å‰ç«¯ç¼–è¯‘çš„distç›®å½•ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ä¸å°±è¡Œäº†ä¹ˆï¼Ÿæ¥ä¸ºä½ è§£ç­”ä¸‹ã€‚

éƒ¨ç½²æœåŠ¡æ˜¯ä¸€ä¸ªå¾ˆå°å¿ƒçš„è¿‡ç¨‹ï¼Œå› ä¸ºå®ƒä¼šå½±å“ç°åœ¨çš„çº¿ä¸ŠæœåŠ¡ï¼Œè€Œæ¯æ¬¡éƒ¨ç½²éƒ½æ˜¯æœ‰å¯èƒ½å¤±è´¥çš„ï¼Œä¹Ÿå°±å¾ˆæœ‰å¯èƒ½éœ€è¦è¿›è¡Œå›æ»šæ“ä½œï¼Œå°±æ˜¯æˆ‘ä»¬å‰é¢å®šä¹‰çš„éƒ¨ç½²å›æ»šæ“ä½œå‘½ä»¤ `./hade deploy rollback` ã€‚**è€Œå›æ»šçš„æ—¶å€™ï¼Œéœ€è¦èƒ½æ‰¾åˆ°æŸä¸ªç‰¹å®šç‰ˆæœ¬çš„ç¼–è¯‘å†…å®¹ï¼Œè¿™é‡Œå°±éœ€è¦éƒ¨ç½²æ–‡ä»¶å¤¹**ã€‚

è¿™ä¸ªéƒ¨ç½²æ–‡ä»¶å¤¹æˆ‘ä»¬å®šä¹‰ä¸ºç›®å½• deploy/xxxxxxï¼Œå…¶ä¸­çš„xxxxç›´æ¥è®¾ç½®ä¸ºç»†åŒ–åˆ°ç§’çš„æ—¶é—´ã€‚å¯¹åº”çš„åˆ›å»ºéƒ¨ç½²æ–‡ä»¶å¤¹çš„å‡½æ•°å¦‚ä¸‹ï¼š

```go
// åˆ›å»ºéƒ¨ç½²çš„folder
func createDeployFolder(c framework.Container) (string, error) {
   appService := c.MustMake(contract.AppKey).(contract.App)
   deployFolder := appService.DeployFolder()

   // éƒ¨ç½²æ–‡ä»¶å¤¹çš„åç§°
   deployVersion := time.Now().Format("20060102150405")
   versionFolder := filepath.Join(deployFolder, deployVersion)
   if !util.Exists(versionFolder) {
      return versionFolder, os.Mkdir(versionFolder, os.ModePerm)
   }
   return versionFolder, nil
}
```

è¿™é‡Œçš„appService.DeployFolder() æ˜¯æˆ‘ä»¬åœ¨appServiceä¸‹åˆ›å»ºçš„ä¸€ä¸ªæ–°çš„ç›®å½•deployï¼Œåœ¨framework/contract/app.goä¸­ï¼š

```go
// App å®šä¹‰æ¥å£
type App interface {
   ...
   // DeployFolder å­˜æ”¾éƒ¨ç½²çš„æ—¶å€™åˆ›å»ºçš„æ–‡ä»¶å¤¹
   DeployFolder() string
   ...
}
```

æœ‰äº†è¿™ä¸ªéƒ¨ç½²æ–‡ä»¶å¤¹ï¼Œæ¯æ¬¡çš„å‘å¸ƒéƒ½æœ‰â€œæ¡£æ¡ˆâ€å­˜å‚¨äº†ï¼Œè¿™å°±ä¸ºå›æ»šå‘½ä»¤æä¾›äº†å¯èƒ½æ€§ã€‚æˆ‘ä»¬æ¯æ¬¡ç¼–è¯‘çš„æ–‡ä»¶ï¼Œä¹Ÿéƒ½ä¼šå…ˆç»è¿‡è¿™ä¸ªéƒ¨ç½²æ–‡ä»¶å¤¹ï¼Œå†ä¸­è½¬ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚

ç¬¬ä¸€æ­¥åˆ›å»ºéƒ¨ç½²æ–‡ä»¶å¤¹å®ç°äº†ï¼Œæˆ‘ä»¬å†å›å¤´çœ‹ä¸‹éƒ¨ç½²å‰ç«¯çš„ç¬¬äºŒä¸ªæ­¥éª¤ï¼Œç¼–è¯‘å‰ç«¯æ–‡ä»¶åˆ°éƒ¨ç½²æ–‡ä»¶å¤¹ã€‚å¯ä»¥ç›´æ¥ä½¿ç”¨ buildFrontendCommandçš„RunEæ–¹æ³•ï¼Œå®ƒä¼šå°†å‰ç«¯ç¼–è¯‘åˆ°distç›®å½•ä¸‹ï¼Œç„¶åæˆ‘ä»¬å†å°†distç›®å½•æ–‡ä»¶æ‹·è´åˆ°éƒ¨ç½²æ–‡ä»¶å¤¹ä¸­ï¼š

```go
func deployBuildFrontend(c *cobra.Command, deployFolder string) error {
   container := c.GetContainer()
   appService := container.MustMake(contract.AppKey).(contract.App)

   // ç¼–è¯‘å‰ç«¯
   if err := buildFrontendCommand.RunE(c, []string{}); err != nil {
      return err
   }

   // å¤åˆ¶å‰ç«¯æ–‡ä»¶åˆ°deployæ–‡ä»¶å¤¹
   frontendFolder := filepath.Join(deployFolder, "dist")
   if err := os.Mkdir(frontendFolder, os.ModePerm); err != nil {
      return err
   }

   buildFolder := filepath.Join(appService.BaseFolder(), "dist")
   if err := util.CopyFolder(buildFolder, frontendFolder); err != nil {
      return err
   }
   return nil
}
```

ç¬¬ä¸‰æ­¥ï¼Œä¸Šä¼ éƒ¨ç½²æ–‡ä»¶å¤¹ï¼Œå¹¶ä¸”æ‰§è¡Œå¯¹åº”çš„å‰ç½®å’Œåç½®çš„shellã€‚

è¿™ä¸ªæ­¥éª¤çš„å®ç°æ˜¯ä»Šå¤©è¿™èŠ‚è¯¾çš„é‡ç‚¹äº†ã€‚é¦–å…ˆéå†é…ç½®æ–‡ä»¶ä¸­çš„deploy.connectionsï¼Œæ˜ç¡®æˆ‘ä»¬è¦åœ¨å“ªå‡ ä¸ªè¿œç«¯èŠ‚ç‚¹ä¸­è¿›è¡Œéƒ¨ç½²ï¼›ç„¶åå¯¹æ¯ä¸ªè¿œç«¯æœåŠ¡åˆ›å»ºä¸€ä¸ªssh.Clientï¼Œç”±äºå‰é¢å·²ç»å†™å¥½äº†SSHæœåŠ¡ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨GetClientæ–¹æ³•å°±èƒ½ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªsshClientäº†ï¼š

```go
for _, node := range deployNodes {
   sshClient, err := sshService.GetClient(ssh.WithConfigPath(node))
   if err != nil {
      return err
   }
   ...
}
```

æ¥ä¸‹æ¥å°±è¦æ‰§è¡Œå‘½ä»¤äº†ï¼Œé‚£æ€ä¹ˆæ‰§è¡Œå‰ç½®æˆ–è€…åç½®å‘½ä»¤å‘¢ï¼Ÿ

æˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ªå‘½ä»¤åˆ›å»ºä¸€ä¸ªsessionï¼Œç„¶åä½¿ç”¨session.CombinedOutæ¥è¾“å‡ºè¿™ä¸ªå‘½ä»¤çš„ç»“æœï¼ŒæŠŠæ¯ä¸ªå‘½ä»¤çš„ç»“æœéƒ½è¾“å‡ºåœ¨æ§åˆ¶å°ä¸­ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š

```go
for _, action := range preActions {
   // åˆ›å»ºsession
   session, err := sshClient.NewSession()
   if err != nil {
      return err
   }
   // æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶ä¸”ç­‰å¾…è¿”å›
   bts, err := session.CombinedOutput(action)
   if err != nil {
      session.Close()
      return err
   }
   session.Close()
   
   // æ‰§è¡Œå‰ç½®å‘½ä»¤æˆåŠŸ
   logger.Info(context.Background(), "execute pre action", map[string]interface{}{
      "cmd":        action,
      "connection": node,
      "out":        strings.ReplaceAll(string(bts), "\n", ""),
   })
}
```

æ‰§è¡Œäº†å‰ç½®å‘½ä»¤ä¹‹åï¼Œä¸‹é¢å°±æ˜¯è¦æŠŠéƒ¨ç½²æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨äº†ã€‚å¦‚ä½•é€šè¿‡SSHæœåŠ¡å°†æ–‡ä»¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨å‘¢ï¼Ÿ

è¿™é‡Œéœ€è¦ä½¿ç”¨åˆ°ä¸€ä¸ªæˆç†Ÿçš„ç¬¬ä¸‰æ–¹åº“ [sftp](https://github.com/pkg/sftp) äº†ï¼Œç›®å‰å·²ç»æœ‰1.1k starï¼Œé‡‡ç”¨BSD-2çš„å¼€æºåè®®ï¼Œå…è®¸ä¿®æ”¹å•†ç”¨ï¼Œä½†æ˜¯è¦ä¿ç•™ç”³æ˜ã€‚è¿™ä¸ªåº“å°±æ˜¯å°è£…SSHçš„ï¼Œå°†SFTPæ–‡ä»¶ä¼ è¾“åè®®å°è£…äº†ä¸€ä¸‹ã€‚SFTPæ˜¯ä»€ä¹ˆï¼Ÿå®ƒæ˜¯åŸºäºSSHåè®®æ¥è¿›è¡Œæ–‡ä»¶ä¼ è¾“çš„ä¸€ä¸ªåè®®ï¼ŒåŠŸèƒ½ä¸FTPç›¸ä¼¼ï¼ŒåŒºåˆ«å°±æ˜¯å®ƒçš„è¿æ¥é€šé“ä½¿ç”¨SSHã€‚

SFTPçš„åº•å±‚è¿æ¥å®é™…ä¸Šå°±æ˜¯SSHï¼Œåªæ˜¯æŠŠä¼ è¾“çš„æ–‡ä»¶å†…å®¹è¿›è¡Œäº†ä¸€ä¸‹åŠ å¯†ç­‰å·¥ä½œï¼Œå¢åŠ äº†ä¼ è¾“çš„å®‰å…¨æ€§ã€‚æ‰€ä»¥**SFTPæœ¬è´¨å°±æ˜¯â€œä½¿ç”¨SSHè¿æ¥æ¥å®Œæˆæ–‡ä»¶ä¼ è¾“åŠŸèƒ½â€**ã€‚è¿™ç‚¹å¯ä»¥ä»å®ƒçš„å®ä¾‹åŒ–çœ‹å‡ºï¼Œsftp.Clientçš„å”¯ä¸€å‚æ•°å°±æ˜¯ssh.Clientã€‚

```go
client, err := sftp.NewClient(sshClient)
if err != nil {
   return err
}
```

SFTPè¿™ä¸ªåº“ï¼Œåœ¨åˆå§‹åŒ–sftp.Clientä¹‹åï¼Œä¼šå°†è¿™ä¸ªclientå°è£…åœ°å’Œå®˜æ–¹çš„æœ¬åœ°æ“ä½œæ–‡ä»¶OSåº“ä¸€æ ·ï¼Œä½ åœ¨ä½¿ç”¨sftp.Clientçš„æ—¶å€™å®Œå…¨æ²¡æœ‰éšœç¢ã€‚

æ¯”å¦‚ï¼ŒOSåº“åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æ˜¯os.Createï¼Œåœ¨SFTPä¸­å°±æ˜¯ä½¿ç”¨client.Createï¼›OSåº“è·å–ä¸€ä¸ªæ–‡ä»¶ä¿¡æ¯çš„å‡½æ•°æ˜¯os.Statï¼Œåœ¨SFTPä¸­å°±æ˜¯client.Statã€‚ä½†æ˜¯æ³¨æ„ä¸‹ï¼Œè¿™é‡Œå®Œå…¨æ˜¯SFTPåˆ»æ„å°†è¿™ä¸ªåº“å‡½æ•°è®¾è®¡çš„å’ŒOSåº“ä¸€æ ·çš„ï¼Œå®ƒä»¬ä¹‹é—´å¹¶æ²¡æœ‰ä»€ä¹ˆåµŒå¥—å…³ç³»ã€‚

æˆ‘ä»¬ä½¿ç”¨ssh.Clientåˆå§‹åŒ–ä¸€ä¸ªsftp.Clientä¹‹åï¼Œå†™ä¸€ä¸ªuploadFolderToSFTPçš„å‡½æ•°æ¥å®ç°å°†æœ¬åœ°æ–‡ä»¶å¤¹åŒæ­¥åˆ°è¿œç«¯æ–‡ä»¶å¤¹ï¼š

```go
// ä¸Šä¼ éƒ¨ç½²æ–‡ä»¶å¤¹
func uploadFolderToSFTP(container framework.Container, localFolder, remoteFolder string, client *sftp.Client) error {
    logger := container.MustMake(contract.LogKey).(contract.Log)
    // éå†æœ¬åœ°æ–‡ä»¶
    return filepath.Walk(localFolder, func(path string, info os.FileInfo, err error) error {
        // è·å–é™¤äº†folderå‰ç¼€çš„åç»­æ–‡ä»¶åç§°
        relPath := strings.Replace(path, localFolder, "", 1)
        if relPath == "" {
            return nil
        }
        // å¦‚æœæ˜¯éå†åˆ°äº†ä¸€ä¸ªç›®å½•
        if info.IsDir() {
            logger.Info(context.Background(), "mkdir: "+filepath.Join(remoteFolder, relPath), nil)
            // åˆ›å»ºè¿™ä¸ªç›®å½•
            return client.MkdirAll(filepath.Join(remoteFolder, relPath))
        }

        // æ‰“å¼€æœ¬åœ°çš„æ–‡ä»¶
        rf, err := os.Open(filepath.Join(localFolder, relPath))
        if err != nil {
            return errors.New("read file " + filepath.Join(localFolder, relPath) + " error:" + err.Error())
        }
        // æ£€æŸ¥æ–‡ä»¶å¤§å°
        rfStat, err := rf.Stat()
        if err != nil {
            return err
        }
        // æ‰“å¼€/åˆ›å»ºè¿œç«¯æ–‡ä»¶
        f, err := client.Create(filepath.Join(remoteFolder, relPath))
        if err != nil {
            return errors.New("create file " + filepath.Join(remoteFolder, relPath) + " error:" + err.Error())
        }

        // å¤§äº2Mçš„æ–‡ä»¶æ˜¾ç¤ºè¿›åº¦
        if rfStat.Size() > 2*1024*1024 {
            logger.Info(context.Background(), "upload local file: "+filepath.Join(localFolder, relPath)+
                " to remote file: "+filepath.Join(remoteFolder, relPath)+" start", nil)
            // å¼€å¯ä¸€ä¸ªgoroutineæ¥ä¸æ–­è®¡ç®—è¿›åº¦
            go func(localFile, remoteFile string) {
                // æ¯10sè®¡ç®—ä¸€æ¬¡
                ticker := time.NewTicker(2 * time.Second)
                for range ticker.C {
                    // è·å–è¿œç«¯æ–‡ä»¶ä¿¡æ¯
                    remoteFileInfo, err := client.Stat(remoteFile)
                    if err != nil {
                        logger.Error(context.Background(), "stat error", map[string]interface{}{
                            "err":         err,
                            "remote_file": remoteFile,
                        })
                        continue
                    }
                    // å¦‚æœè¿œç«¯æ–‡ä»¶å¤§å°ç­‰äºæœ¬åœ°æ–‡ä»¶å¤§å°ï¼Œè¯´æ˜å·²ç»ç»“æŸäº†
                    size := remoteFileInfo.Size()
                    if size >= rfStat.Size() {
                        break
                    }
                    // è®¡ç®—è¿›åº¦å¹¶ä¸”æ‰“å°è¿›åº¦
                    percent := int(size * 100 / rfStat.Size())
                    logger.Info(context.Background(), "upload local file: "+filepath.Join(localFolder, relPath)+
                        " to remote file: "+filepath.Join(remoteFolder, relPath)+fmt.Sprintf(" %v%% %v/%v", percent, size, rfStat.Size()), nil)
                }
            }(filepath.Join(localFolder, relPath), filepath.Join(remoteFolder, relPath))
        }

        // å°†æœ¬åœ°æ–‡ä»¶å¹¶å‘è¯»å–åˆ°è¿œç«¯æ–‡ä»¶
        if _, err := f.ReadFromWithConcurrency(rf, 10); err != nil {
            return errors.New("Write file " + filepath.Join(remoteFolder, relPath) + " error:" + err.Error())
        }
        // è®°å½•æˆåŠŸä¿¡æ¯
        logger.Info(context.Background(), "upload local file: "+filepath.Join(localFolder, relPath)+
            " to remote file: "+filepath.Join(remoteFolder, relPath)+" finish", nil)
        return nil
    })
}
```

è¿™æ®µä»£ç é•¿ä¸€ç‚¹ã€‚é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨åŠŸèƒ½filePath.Walkæ¥éå†æœ¬åœ°æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå¦‚æœéå†åˆ°çš„æ˜¯å­æ–‡ä»¶å¤¹ï¼Œå°±åˆ›å»ºå­æ–‡ä»¶å¤¹ï¼Œå¦åˆ™çš„è¯ï¼Œæˆ‘ä»¬å°±å°†æœ¬åœ°æ–‡ä»¶ä¸Šä¼ åˆ°è¿œç«¯ã€‚è€Œä¸Šä¼ è¿œç«¯çš„æ“ä½œå¤§è‡´å°±æ˜¯ä¸‰æ­¥ï¼šæ‰“å¼€æœ¬åœ°æ–‡ä»¶ã€æ‰“å¼€è¿œç«¯æ–‡ä»¶ã€å°†æœ¬åœ°æ–‡ä»¶ä¼ è¾“åˆ°è¿œç«¯æ–‡ä»¶ã€‚

åœ¨ä¸Šè¿°å‡½æ•°ä¸­å¤§è‡´æ˜¯è¿™å‡ å¥ä»£ç ï¼š

```go
// æ‰“å¼€æœ¬åœ°çš„æ–‡ä»¶
rf, err := os.Open(filepath.Join(localFolder, relPath))

// æ‰“å¼€/åˆ›å»ºè¿œç«¯æ–‡ä»¶
f, err := client.Create(filepath.Join(remoteFolder, relPath))

// å°†æœ¬åœ°æ–‡ä»¶å¹¶å‘è¯»å–åˆ°è¿œç«¯æ–‡ä»¶
if _, err := f.ReadFromWithConcurrency(rf, 10); err != nil 
```

SFTPæä¾›äº†å¹¶å‘è¯»å–åˆ°è¿œç«¯æ–‡ä»¶ReadFromWithConcurrencyçš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªå¹¶å‘è¯»çš„æ–¹æ³•æé«˜ä¸Šä¼ æ•ˆç‡ã€‚

ä½†æ˜¯å³ä½¿æ˜¯å¹¶å‘è¯»ï¼Œå¯¹äºæ¯”è¾ƒå¤§çš„æ–‡ä»¶ï¼Œè¿˜æ˜¯éœ€è¦ç­‰å€™æ¯”è¾ƒé•¿çš„æ—¶é—´ã€‚è€Œè¿™ä¸ªç­‰å¾…æ—¶é•¿ï¼Œå¯¹äºåœ¨æ§åˆ¶å°æ•²ä¸‹éƒ¨ç½²å‘½ä»¤çš„ä½¿ç”¨è€…æ¥è¯´æ˜¯éå¸¸ä¸å‹å¥½çš„ã€‚æˆ‘ä»¬å¸Œæœ›èƒ½**æ¯éš”ä¸€æ®µæ—¶é—´æ˜¾ç¤ºä¸€ä¸‹å½“å‰çš„éƒ¨ç½²è¿›åº¦**ï¼Œè¿™ä¸ªæ€ä¹ˆåšå‘¢ï¼Ÿ

è¿™é‡Œæˆ‘ä»¬è®¾è®¡å¤§äº2Mçš„æ–‡ä»¶ï¼Œæ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚2Mæ˜¯æˆ‘è‡ªå·±å®éªŒå‡ºæ¥ä½“éªŒæ¯”è¾ƒå·®çš„ä¸€ä¸ªé˜ˆå€¼ã€‚ç„¶åæ¯2så°±æ‰“å°ä¸€ä¸‹å½“å‰è¿›åº¦ï¼Œæ‰€ä»¥ä½¿ç”¨äº†ä¸€ä¸ªtickerï¼Œæ¥è®¡ç®—æ—¶é—´ã€‚æ¯æ¬¡è¿™ä¸ªtickerç»“æŸçš„æ—¶å€™ï¼Œè®¡ç®—ä¸€ä¸‹è¿œç«¯æ–‡ä»¶çš„å¤§å°ï¼Œå†è®¡ç®—ä¸€ä¸‹æœ¬åœ°æ–‡ä»¶çš„å¤§å°ã€‚ä¸¤è€…ç›¸é™¤å°±æ˜¯è¿™ä¸ªæ–‡ä»¶çš„ä¸Šä¼ è¿›åº¦ï¼Œå†ä½¿ç”¨æ—¥å¿—æ‰“å°å°±èƒ½æ‰“å°å‡ºå…·ä½“çš„è¿›åº¦äº†ã€‚

æœ€åçš„æ•ˆæœå¦‚ä¸‹ï¼š  
![](https://static001.geekbang.org/resource/image/08/4e/088379171caf4131231de7d635b6e34e.png?wh=1920x157)

åˆ°è¿™é‡Œéƒ¨ç½²å‰ç«¯çš„ä»£ç å°±å¼€å‘å®Œæˆäº†ã€‚

### éƒ¨ç½²åç«¯

ç†è§£äº†å¦‚ä½•éƒ¨ç½²å‰ç«¯ï¼Œéƒ¨ç½²åç«¯çš„å¯¹åº”æ–¹æ³•åŸºæœ¬å¦‚å‡ºä¸€è¾™ã€‚å”¯ä¸€ä¸åŒçš„åœ°æ–¹å°±æ˜¯ç¼–è¯‘ã€‚

ç¼–è¯‘Golangçš„åç«¯éœ€è¦æŒ‡å®šå¯¹åº”çš„ç¼–è¯‘å¹³å°å’Œç¼–è¯‘CPUæ¶æ„ï¼Œå°±æ˜¯å‰é¢è¯´çš„GOOSå’ŒGOARCHã€‚æ‰€ä»¥æˆ‘ä»¬å°±ä¸èƒ½ç›´æ¥ä½¿ç”¨buildå‘½ä»¤æ¥ç¼–è¯‘åç«¯äº†ã€‚æ”¹æˆå®šä½goç¨‹åºï¼Œæ¥æ‰§è¡Œgo buildï¼Œå¹¶ä¸”éœ€è¦ä¿®æ”¹è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼Œè¾“å‡ºåˆ°éƒ¨ç½²æ–‡ä»¶å¤¹ä¸­ã€‚

å½“ç„¶è¿™ä¸ªéƒ¨ç½²æ–‡ä»¶å¤¹è¿˜æ˜¯æŒ‰ç…§æˆ‘ä»¬ä¹‹å‰çš„è®¾è®¡ä¸º deploy/xxxxxxï¼Œå…¶ä¸­çš„xxxxç›´æ¥è®¾ç½®ä¸ºç»†åŒ–åˆ°ç§’çš„æ—¶é—´ï¼Œç»§ç»­åœ¨framework/command/deploy.goä¸­å†™å…¥ï¼š

```go
// ç¼–è¯‘åç«¯
path, err := exec.LookPath("go")
if err != nil {
   log.Fatalln("hade go: è¯·åœ¨Pathè·¯å¾„ä¸­å…ˆå®‰è£…go")
}
   // ç»„è£…å‘½ä»¤
deployBinFile := filepath.Join(deployFolder, binFile)
cmd := exec.Command(path, "build", "-o", deployBinFile, "./")
cmd.Env = os.Environ()
   // è®¾ç½®GOOSå’ŒGOARCH
if configService.GetString("deploy.backend.goos") != "" {
   cmd.Env = append(cmd.Env, "GOOS="+configService.GetString("deploy.backend.goos"))
}
if configService.GetString("deploy.backend.goarch") != "" {
   cmd.Env = append(cmd.Env, "GOARCH="+configService.GetString("deploy.backend.goarch"))
}
   // æ‰§è¡Œå‘½ä»¤
ctx := context.Background()
out, err := cmd.CombinedOutput()
if err != nil {
   logger.Error(ctx, "go build err", map[string]interface{}{
      "err": err,
      "out": string(out),
   })
   return err
}
logger.Info(ctx, "ç¼–è¯‘æˆåŠŸ", nil)
```

åŒæ—¶é™¤äº†ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿˜è¦è®°å¾—æŠŠ.envæ–‡ä»¶ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€configç›®æ ‡æ–‡ä»¶ä¼ é€’åˆ°æœ¬åœ°çš„éƒ¨ç½²ç›®å½•ï¼š

```go
// å¤åˆ¶.env
if util.Exists(filepath.Join(appService.BaseFolder(), ".env")) {
   if err := util.CopyFile(filepath.Join(appService.BaseFolder(), ".env"), filepath.Join(deployFolder, ".env")); err != nil {
      return err
   }
}

// å¤åˆ¶configæ–‡ä»¶
deployConfigFolder := filepath.Join(deployFolder, "config", env)
if !util.Exists(deployConfigFolder) {
   if err := os.MkdirAll(deployConfigFolder, os.ModePerm); err != nil {
      return err
   }
}
if err := util.CopyFolder(filepath.Join(appService.ConfigFolder(), env), deployConfigFolder); err != nil {
   return err
}
```

è‡ªåŠ¨åŒ–éƒ¨ç½²åç«¯çš„å‘½ä»¤ï¼Œé™¤äº†ä»¥ä¸Šçš„ç¼–è¯‘æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•ä¹‹å¤–ï¼Œå…¶ä»–éƒ¨åˆ†éƒ½å’Œè‡ªåŠ¨åŒ–éƒ¨ç½²å‰ç«¯çš„å‘½ä»¤ä¸€è‡´ï¼š

```go
// deployBackendCommand éƒ¨ç½²åç«¯
var deployBackendCommand = &cobra.Command{
   Use:   "backend",
   Short: "éƒ¨ç½²åç«¯",
   RunE: func(c *cobra.Command, args []string) error {
      container := c.GetContainer()

      // åˆ›å»ºéƒ¨ç½²æ–‡ä»¶å¤¹
      deployFolder, err := createDeployFolder(container)
      if err != nil {
         return err
      }

      // ç¼–è¯‘åç«¯åˆ°éƒ¨ç½²æ–‡ä»¶å¤¹
      if err := deployBuildBackend(c, deployFolder); err != nil {
         return err
      }

      // ä¸Šä¼ éƒ¨ç½²æ–‡ä»¶å¤¹å¹¶æ‰§è¡Œå¯¹åº”çš„shell
      return deployUploadAction(deployFolder, container, "backend")
   },
}
```

### éƒ¨ç½²å…¨éƒ¨

è€Œå¯¹äºåŒæ—¶éƒ¨ç½²å‰åç«¯å‘½ä»¤ï¼Œå…¶å®å°±æ˜¯åœ¨ç¼–è¯‘é˜¶æ®µï¼ŒæŠŠå‰ç«¯å’Œåç«¯åŒæ—¶è¿›è¡Œç¼–è¯‘ï¼Œå¹¶ä¸”æœ€ç»ˆä¸Šä¼ éƒ¨ç½²æ–‡ä»¶å¤¹ã€‚åŒæ ·æ”¾åœ¨framework/command/deploy.goï¼š

```go
var deployAllCommand = &cobra.Command{
   Use:   "all",
   Short: "å…¨éƒ¨éƒ¨ç½²",
   RunE: func(c *cobra.Command, args []string) error {
      container := c.GetContainer()

      deployFolder, err := createDeployFolder(container)
      if err != nil {
         return err
      }

      // ç¼–è¯‘å‰ç«¯
      if err := deployBuildFrontend(c, deployFolder); err != nil {
         return err
      }

      // ç¼–è¯‘åç«¯
      if err := deployBuildBackend(c, deployFolder); err != nil {
         return err
      }

      // ä¸Šä¼ å‰ç«¯+åç«¯ï¼Œå¹¶æ‰§è¡Œå¯¹åº”çš„shell
      return deployUploadAction(deployFolder, container, "all")
   },
}
```

### éƒ¨ç½²å›æ»š

æœ€åå°±æ˜¯éƒ¨ç½²å›æ»šæ“ä½œï¼Œä¸»è¦æ˜ç¡®ä¸€ä¸‹éœ€è¦ä¼ é€’çš„å‚æ•°ï¼š

ä¸€ä¸ªæ˜¯å›æ»šç‰ˆæœ¬å·ã€‚è¿™ä¸ªç‰ˆæœ¬å·å°±æ˜¯æˆ‘ä»¬çš„éƒ¨ç½²ç›®å½•çš„åç§°ï¼Œå‰é¢è¯´è¿‡éƒ¨ç½²ç›®å½•ä¸ºdeploy/xxxxxxï¼Œxxxxè®¾ç½®ä¸ºç»†åŒ–åˆ°ç§’çš„æ—¶é—´ã€‚æ¯”å¦‚20211110233354ï¼Œè¡¨ç¤ºæ˜¯æˆ‘ä»¬2021å¹´11æœˆ10æ—¥23ç‚¹33åˆ†54ç§’åˆ›å»ºçš„ç‰ˆæœ¬ã€‚

å¦å¤–ä¸€ä¸ªå°±æ˜¯æ ‡è®°å¸Œæœ›å›æ»šå‰ç«¯ï¼Œè¿˜æ˜¯åç«¯ï¼Œè¿˜æ˜¯å…¨éƒ¨å›æ»šã€‚è¿™é‡Œä¸»è¦æ¶‰åŠæ‰§è¡Œå‰ç«¯çš„å›æ»šå‘½ä»¤ï¼Œè¿˜æ˜¯æ‰§è¡Œåç«¯çš„å›æ»šå‘½ä»¤ã€‚

è¿™ä¸¤ä¸ªå‚æ•°æˆ‘ä»¬ç›´æ¥ä»¥å‚æ•°å½¢å¼ï¼Œè·Ÿåœ¨deploy rollbackå‘½ä»¤ä¹‹åï¼Œå¦‚ä¸‹ï¼š

```go
Â ./hade deploy rollback 20211110233354 backend
```

æ˜ç¡®äº†å‚æ•°ï¼Œå®ƒçš„å…·ä½“å®ç°å°±å¾ˆç®€å•äº†ï¼Œå› ä¸ºå®ƒæ²¡æœ‰ä»»ä½•çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠå›æ»šç‰ˆæœ¬æ‰€åœ¨ç›®å½•çš„ç¼–è¯‘ç»“æœï¼Œä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨å°±å¯ä»¥äº†ï¼ŒåŒæ ·ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªå‘½ä»¤æ”¾åœ¨framework/command/deploy.goä¸­ï¼š

```go
// deployRollbackCommand éƒ¨ç½²å›æ»š
var deployRollbackCommand = &cobra.Command{
   Use:   "rollback",
   Short: "éƒ¨ç½²å›æ»š",
   RunE: func(c *cobra.Command, args []string) error {
      container := c.GetContainer()

      if len(args) != 2 {
         return errors.New("å‚æ•°é”™è¯¯,è¯·æŒ‰ç…§å‚æ•°è¿›è¡Œå›æ»š ./hade deploy rollback [version] [frontend/backend/all]")
      }

      version := args[0]
      end := args[1]

      // è·å–ç‰ˆæœ¬ä¿¡æ¯
      appService := container.MustMake(contract.AppKey).(contract.App)
      deployFolder := filepath.Join(appService.DeployFolder(), version)

      // ä¸Šä¼ éƒ¨ç½²æ–‡ä»¶å¤¹å¹¶æ‰§è¡Œå¯¹åº”çš„shell
      return deployUploadAction(deployFolder, container, end)
   },
}
```

åˆ°è¿™é‡Œå››ä¸ªè‡ªåŠ¨åŒ–éƒ¨ç½²å‘½ä»¤å°±éƒ½å¼€å‘å®Œæˆã€‚æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ã€‚

## éªŒè¯

è¦éªŒè¯éƒ¨ç½²å‘½ä»¤ï¼Œæˆ‘ä»¬å½“ç„¶éœ€è¦æœ‰ä¸€ä¸ªç›®æ ‡éƒ¨ç½²æœåŠ¡å™¨ï¼Œè¿™æ˜¯æˆ‘è®¾ç½®çš„web-01æœåŠ¡å™¨é…ç½®ï¼Œåœ¨config/development/ssh.yamlä¸­ï¼š

```yaml
timeout: 3s
network: tcp
web-01:
    host: 111.222.333.444 # ipåœ°å€
    port: 22 # ç«¯å£
    username: yejianfeng # ç”¨æˆ·å
    password: "123456" # å¯†ç 
```

è€Œåœ¨config/development/deploy.yamlä¸­æˆ‘çš„é…ç½®å¦‚ä¸‹ï¼š

```yaml
connections: # è¦è‡ªåŠ¨åŒ–éƒ¨ç½²çš„è¿æ¥
    - ssh.web-01

remote_folder: "/home/yejianfeng/coredemo/"  # è¿œç«¯çš„éƒ¨ç½²æ–‡ä»¶å¤¹

frontend: # å‰ç«¯éƒ¨ç½²é…ç½®
    pre_action: # éƒ¨ç½²å‰ç½®å‘½ä»¤
        - "pwd"
    post_action: # éƒ¨ç½²åç½®å‘½ä»¤
        - "pwd"

backend: # åç«¯éƒ¨ç½²é…ç½®
    goos: linux # éƒ¨ç½²ç›®æ ‡æ“ä½œç³»ç»Ÿ
    goarch: amd64 # éƒ¨ç½²ç›®æ ‡cpuæ¶æ„
    pre_action: # éƒ¨ç½²å‰ç½®å‘½ä»¤
        - "rm /home/yejianfeng/coredemo/hade"
    post_action: # éƒ¨ç½²åç½®å‘½ä»¤
        - "chmod 777 /home/yejianfeng/coredemo/hade"
        - "/home/yejianfeng/coredemo/hade app restart"
```

é‡ç‚¹çœ‹åç«¯éƒ¨ç½²é…ç½®ã€‚åœ¨éƒ¨ç½²åç«¯ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¿è¡Œä¸€ä¸ªrm å‘½ä»¤æ¥å°†æ—§çš„hadeäºŒè¿›åˆ¶è¿›ç¨‹åˆ é™¤ï¼Œç„¶åéƒ¨ç½²åç«¯æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…æ‹¬è¿™ä¸ªäºŒè¿›åˆ¶è¿›ç¨‹ã€‚æœ€åæ‰§è¡Œäº†ä¸¤ä¸ªå‘½ä»¤ï¼Œä¸€ä¸ªæ˜¯chmodå‘½ä»¤ï¼Œä¿è¯ä¸Šä¼ ä¸Šå»çš„äºŒè¿›åˆ¶è¿›ç¨‹å‘½ä»¤å¯ä»¥æ‰§è¡Œï¼›ç¬¬äºŒä¸ªå°±æ˜¯./hade app restartå‘½ä»¤ï¼Œèƒ½å°†è¿œç«¯çš„å‘½ä»¤å¯åŠ¨ã€‚

è¿™é‡Œå°±æ¼”ç¤ºä¸‹éƒ¨ç½²åç«¯æœåŠ¡ `./hade deploy backend` ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š  
![](https://static001.geekbang.org/resource/image/14/ac/14915cb398646c747875c4860e01b6ac.png?wh=1920x440)  
![](https://static001.geekbang.org/resource/image/2e/bb/2e70470a5e55e864aeea7e920e1eaabb.png?wh=1920x283)

æˆ‘ä»¬çœ‹åˆ°ï¼Œå®ƒæˆåŠŸåœ°ç¼–è¯‘åç«¯æœåŠ¡ï¼Œåˆ°ç›®æ ‡æ–‡ä»¶å¤¹deploy/20211110233533ï¼Œ å¹¶ä¸”ä¸Šä¼ äº†ç¼–è¯‘çš„hadeå‘½ä»¤ï¼Œåœ¨è¿œç«¯å¯åŠ¨äº†è¿›ç¨‹ã€‚

æ¥ç€éªŒè¯ä¸‹å›æ»šå‘½ä»¤ã€‚åœ¨ä¹‹å‰å·²ç»å‘å¸ƒè¿‡ç‰ˆæœ¬ 20211110233354 äº†ã€‚æ‰€ä»¥è¿™é‡Œç›´æ¥è¿è¡Œå‘½ä»¤ `./hade deploy rollback 20211110233354 backend` å°†ç‰ˆæœ¬å›æ»šåˆ° 20211110233354ã€‚  
![](https://static001.geekbang.org/resource/image/fc/78/fc3280cfd8813169970f8d91c11f6578.png?wh=1920x403)  
![](https://static001.geekbang.org/resource/image/89/90/89390e826834862981bb94344dcfb090.png?wh=1920x297)

éªŒè¯æˆåŠŸï¼

æœ¬èŠ‚è¯¾æˆ‘ä»¬å¯¹frameworkä¸‹çš„providerã€contractã€commandç›®å½•éƒ½æœ‰ä¿®æ”¹ã€‚ç›®å½•æˆªå›¾å¦‚ä¸‹ï¼Œä¾›ä½ å¯¹æ¯”æŸ¥çœ‹ï¼Œæ‰€æœ‰ä»£ç éƒ½å·²ç»ä¸Šä¼ åˆ°[geekbang/28](https://github.com/gohade/coredemo/tree/geekbang/28)åˆ†æ”¯äº†ã€‚  
![](https://static001.geekbang.org/resource/image/d8/0b/d89d6aaf4f25fab54dec747ef0f4700b.jpg?wh=2187x1292)

## å°ç»“

ä»Šå¤©æˆ‘ä»¬å®ç°äº†å°†ä»£ç è‡ªåŠ¨åŒ–éƒ¨ç½²åˆ°WebæœåŠ¡å™¨çš„æœºåˆ¶ã€‚ä¸ºäº†å®ç°è¿™ä¸ªè‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œå…ˆå®ç°äº†ä¸€ä¸ªSSHæœåŠ¡ï¼Œç„¶åå®šåˆ¶äº†ä¸€å¥—è‡ªåŠ¨åŒ–éƒ¨ç½²å‘½ä»¤ï¼ŒåŒ…æ‹¬éƒ¨ç½²å‰ç«¯ã€éƒ¨ç½²åç«¯ã€éƒ¨ç½²å…¨éƒ¨å’Œéƒ¨ç½²å›æ»šã€‚

è™½ç„¶è¯´è¿™ä¸ªç”±æ¡†æ¶è´Ÿè´£çš„è‡ªåŠ¨åŒ–éƒ¨ç½²æœºåˆ¶åœ¨å¤§é¡¹ç›®ä¸­å¯èƒ½ç”¨ä¸ä¸Šï¼Œæ¯•ç«Ÿç°åœ¨å¤§é¡¹ç›®éƒ½é‡‡ç”¨DockeråŒ–å’Œk8séƒ¨ç½²äº†ã€‚ä¸è¿‡å¯¹äºå°å‹é¡¹ç›®ï¼Œè¿™ç§éƒ¨ç½²æœºåˆ¶è¿˜æ˜¯æœ‰å…¶ä¾¿åˆ©æ€§çš„ã€‚æ‰€ä»¥æˆ‘ä»¬çš„hadeæ¡†æ¶è¿˜æ˜¯å†³å®šæä¾›è¿™ä¸ªæœºåˆ¶ã€‚

åœ¨å®ç°è¿™ä¸ªæœºåˆ¶çš„è¿‡ç¨‹ä¸­ï¼Œè¦åšåˆ°ç†Ÿç»ƒæŒæ¡Golangå¯¹äºSSHã€SFTPç­‰åº“çš„æ“ä½œã€‚åŸºæœ¬ä¸Šè¿™ä¸¤ä¸ªåº“çš„æ“ä½œä½ ç†Ÿæ‚‰äº†ï¼Œå°±èƒ½åœ¨ä¸€ä¸ªç¨‹åºä¸­åŒæ—¶è‡ªåŠ¨åŒ–æ“ä½œå¤šä¸ªæœåŠ¡å™¨äº†ã€‚åœ¨å®é™…å·¥ä½œä¸­ï¼Œå¦‚æœé‡åˆ°ç±»ä¼¼çš„éœ€æ±‚ï¼Œå¯ä»¥æŒ‰ç…§è¿™èŠ‚è¯¾æ‰€å±•ç¤ºçš„æŠ€æœ¯æ¥è‡ªåŠ¨åŒ–ä½ çš„éœ€æ±‚ã€‚

### æ€è€ƒé¢˜

å…¶å®ä»Šå¤©çš„å†…å®¹æ¶‰åŠè‡ªåŠ¨åŒ–è¿ç»´çš„èŒƒç•´äº†ï¼Œæˆ‘ä»¬å°±å¸ƒç½®ä¸€ä¸ªè¯¾å¤–ç ”ç©¶å§ã€‚è‡ªåŠ¨åŒ–è¿ç»´èŒƒç•´ä¸­æœ‰ä¸€ä¸ªå¾ˆå‡ºåçš„è‡ªåŠ¨åŒ–è¿ç»´é…ç½®æ¡†æ¶ansibleï¼Œä½ å¯ä»¥å»æµè§ˆä¸‹[Ansibleä¸­æ–‡æƒå¨æŒ‡å—](https://ansible-tran.readthedocs.io/en/latest)ç½‘ç«™ï¼Œå­¦ä¹ ä¸€ä¸‹ansibleæœ‰å“ªäº›åŠŸèƒ½ï¼Œåˆ†äº«ä¸€ä¸‹ä½ çš„å­¦ä¹ å¿ƒå¾—ã€‚

æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒã€‚æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œå¦‚æœä½ è§‰å¾—ä»Šå¤©çš„å†…å®¹å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œé‚€è¯·ä»–ä¸€èµ·å­¦ä¹ ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ4ï¼‰</strong></div><ul>
<li><span>Vincent</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>ä¹‹å‰ç”¨åˆ°çš„makefileè¾ƒå¤šï¼Œæƒ³é—®è€å¸ˆå¦‚ä½•é€‰æ‹©å‘¢ï¼Œæ˜¯é›†æˆåˆ°hadeä¸­è¿˜æ˜¯åœ¨makefileä¸­å‘¢</p>2021-11-21</li><br/><li><span>taoist</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å¦‚æœåœ¨Windowsä¸‹è¿è¡Œéƒ¨ç½²åˆ°Linuxå¹³å°ï¼ŒuploadFolderToSFTPå‡½æ•°é‡Œè¿œç«¯è·¯å¾„çš„filepath.Joinéœ€è¦ç”¨filepath.ToSlashåŒ…ä¸€ä¸‹è½¬æ¢æˆUnixè·¯å¾„æ ¼å¼ã€‚</p>2024-01-30</li><br/><li><span>é™ˆäº¦å‡¡</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>Mac cc
https:&#47;&#47;github.com&#47;messense&#47;homebrew-macos-cross-toolchains</p>2022-09-05</li><br/><li><span>é™ˆäº¦å‡¡</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¿™é‡Œäº¤å‰ç¼–æ—¶ï¼Œgsptåº“ä½¿ç”¨äº†cï¼Œéœ€è¦äº¤å‰ç¼–è¯‘ï¼Œç½‘ä¸Šçœ‹äº†ä¸€ä¸‹ï¼Œå¦‚æœä½¿ç”¨muslçš„è¯ï¼Œè¿è¡Œç¯å¢ƒä¹Ÿè¦å®‰è£…ï¼Œè¯·æ•™ä¸‹é™¤äº†dockerã€muslè¿˜æœ‰åˆ«çš„æ–¹æ¡ˆå—ï¼Ÿ</p>2022-09-05</li><br/>
</ul>