ä½ å¥½ï¼Œæˆ‘æ˜¯è½©è„‰åˆƒã€‚

ä¸Šä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬å·²ç»å®šä¹‰å¥½äº†é…ç½®æ–‡ä»¶æœåŠ¡çš„æ¥å£ï¼Œè¿™èŠ‚è¯¾å°±æ¥å®ç°è¿™äº›æ¥å£ã€‚å…ˆæ¥è§„åˆ’é…ç½®æ–‡ä»¶æœåŠ¡ç›®å½•ï¼ŒæŒ‰ç…§ä¸Šä¸€èŠ‚è¯¾åˆ†æçš„ï¼Œå¤šä¸ªé…ç½®æ–‡ä»¶æŒ‰ç±»åˆ«æ”¾åœ¨ä¸åŒé…ç½®æ–‡ä»¶å¤¹ä¸­ï¼Œåœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­ï¼Œæˆ‘ä»¬å°†é…ç½®æ–‡ä»¶æ¥å£ä»£ç å†™åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸‹çš„contract/config.goæ–‡ä»¶ä¸­ï¼Œå°†å…·ä½“å®ç°æ”¾åœ¨provider/config/ç›®å½•ä¸­ã€‚

## é…ç½®æœåŠ¡çš„è®¾è®¡

ä¸è¿‡è®¾è®¡ä¼˜äºå®ç°ï¼ŒåŠ¨æ‰‹ä¹‹å‰æˆ‘ä»¬å…ˆæ€è€ƒä¸‹å®ç°è¿™ä¸ªæ¥å£è¦å¦‚ä½•è®¾è®¡ã€‚

é¦–å…ˆï¼Œè¦è¯»å–ä¸€ä¸‹é…ç½®æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ã€‚ä¸ŠèŠ‚è¯¾è¯´äº†ï¼Œæœ€ç»ˆçš„é…ç½®æ–‡ä»¶å¤¹åœ°å€ä¸ºï¼Œåº”ç”¨æœåŠ¡çš„ ConfigFolder ä¸‹çš„ç¯å¢ƒå˜é‡å¯¹åº”çš„æ–‡ä»¶å¤¹ï¼Œæ¯”å¦‚ ConfigFolder/developmentã€‚ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯é…ç½®æ–‡ä»¶çš„æ ¼å¼çš„é€‰æ‹©ã€‚

**ç›®å‰å¸‚é¢ä¸Šçš„é…ç½®æ–‡ä»¶æ ¼å¼éå¸¸å¤šï¼Œä½†æ˜¯å¾ˆéš¾è¯´å“ªç§é…ç½®æ–‡ä»¶æ¯”è¾ƒå¥½ï¼Œå®Œå…¨æ˜¯ä¸åŒå¹³å°ã€ä¸åŒæ—¶ä»£ä¸‹çš„äº§ç‰©**ã€‚æ¯”å¦‚Windowså¼€å‘çš„é…ç½®å¸¸ç”¨INIã€Javaå¼€å‘é…ç½®å¸¸ç”¨Propertiesï¼Œæˆ‘è¿™é‡Œé€‰æ‹©äº†ä½¿ç”¨YAMLæ ¼å¼ã€‚

### é…ç½®æ–‡ä»¶çš„è¯»å–

YAMLæ ¼å¼æ˜¯åœ¨Golangçš„é¡¹ç›®ä¸­æ¯”è¾ƒé€šç”¨çš„ä¸€ç§æ ¼å¼ï¼Œæ¯”å¦‚Kubernetesã€Dockerã€Swaggerç­‰é¡¹ç›®ï¼Œéƒ½æ˜¯ä½¿ç”¨YAMLä½œä¸ºå…¶é…ç½®æ–‡ä»¶çš„ã€‚YAMLé…ç½®æ–‡ä»¶é™¤äº†èƒ½è¡¨è¾¾åŸºç¡€ç±»å‹æ¯”å¦‚stringã€intã€float ä¹‹å¤–ï¼Œä¹Ÿèƒ½è¡¨è¾¾å¤æ‚çš„æ•°ç»„ã€ç»“æ„ç­‰æ•°æ®ç±»å‹ã€‚

ç›®å‰æœ€æ–°çš„YAMLç‰ˆæœ¬ä¸º1.2ç‰ˆæœ¬ï¼Œé…ç½®çš„è¯´æ˜æ–‡æ¡£åœ¨[å®˜ç½‘](https://yaml.org/)ä¸Šã€‚å®ƒæä¾›å¤šç§è¯­è¨€çš„è§£æåº“ï¼Œå…¶ä¸­[go-yaml](https://github.com/go-yaml/yaml) å°±æ˜¯éå¸¸é€šç”¨çš„ä¸€ä¸ªGoè§£æåº“ï¼Œè¿™ä¸ªåº“çš„å°è£…æ€§éå¸¸å¥½ã€‚

æˆ‘ä»¬é€šè¿‡ç¬¬ä¸€èŠ‚è¯¾è®²çš„å¿«é€Ÿé˜…è¯»ä¸€ä¸ªåº“çš„å‘½ä»¤ `go doc github.com/go-yaml/yaml |grep '^func'`ï¼Œå¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªåº“å¯¹å¤–æä¾›çš„æ–¹æ³•éå¸¸æ˜ç¡®ï¼Œä¸€å…±ä¸‰ä¸ªæ–¹æ³•ï¼š

- Marshal è¡¨ç¤ºåºåˆ—åŒ–ä¸€ä¸ªç»“æ„æˆä¸ºYAMLæ ¼å¼ï¼›
- Unmarshalè¡¨ç¤ºååºåˆ—åŒ–ä¸€ä¸ªYAMLæ ¼å¼æ–‡æœ¬æˆä¸ºä¸€ä¸ªç»“æ„ï¼›
- è¿˜æœ‰ä¸€ä¸ªUnmarshalStrict å‡½æ•°ï¼Œè¡¨ç¤ºä¸¥æ ¼ååºåˆ—åŒ–ï¼Œæ¯”å¦‚å¦‚æœYAMLæ ¼å¼æ–‡ä»¶ä¸­åŒ…å«é‡å¤keyçš„å­—æ®µï¼Œé‚£ä¹ˆä½¿ç”¨UnmarshalStrict å‡½æ•°ååºåˆ—åŒ–ä¼šå‡ºç°é”™è¯¯ã€‚

```plain
// åºåˆ—åŒ–
func Marshal(in interface{}) (out []byte, err error)
// ååºåˆ—åŒ–
func Unmarshal(in []byte, out interface{}) (err error)
// ä¸¥æ ¼ååºåˆ—åŒ–
func UnmarshalStrict(in []byte, out interface{}) (err error)
```

æˆ‘ä»¬é€‰æ‹©Unmarshalçš„å‡½æ•°è¿›è¡Œååºåˆ—åŒ–ï¼Œå› ä¸ºè¿™æ ·èƒ½æé«˜æ¡†æ¶å¯¹é…ç½®æ–‡ä»¶çš„å®¹é”™æ€§å’Œæ˜“ç”¨æ€§ã€‚å¥½ï¼Œè¯»å–é…ç½®æ–‡ä»¶çš„æ ¼å¼å’Œå¯¹åº”å·¥å…·æå®šï¼Œä¸‹ä¸€æ­¥å°±æ˜¯æƒ³æ¸…æ¥šæ€ä¹ˆæ›¿æ¢äº†ã€‚

### é…ç½®æ–‡ä»¶çš„æ›¿æ¢

åœ¨ä¸Šä¸€èŠ‚è¯¾è¯´çš„ç¯å¢ƒå˜é‡æœåŠ¡ä¸­ï¼Œå­˜æ”¾äº†åŒ…æ‹¬.envä¸­è®¾ç½®çš„ç¯å¢ƒå˜é‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªç„¶ä¼šå¸Œæœ›ä½¿ç”¨ä¸Šè¿™äº›ç¯å¢ƒå˜é‡ï¼ŒæŠŠé…ç½®æ–‡ä»¶ä¸­æœ‰çš„å­—æ®µä½¿ç”¨ç¯å¢ƒå˜é‡æ›¿æ¢æ‰ã€‚é‚£ä¹ˆè¿™é‡Œåœ¨é…ç½®æ–‡ä»¶ä¸­å°±éœ€è¦æœ‰ä¸€ä¸ªâ€œå ä½ç¬¦â€ã€‚è¿™ä¸ªå ä½ç¬¦è¡¨ç¤ºå½“å‰è¿™ä¸ªå­—æ®µå»ç¯å¢ƒå˜é‡ä¸­è¿›è¡Œé˜…è¯»ã€‚

è¿™ä¸ªå ä½ç¬¦çš„è®¾è®¡åªæœ‰ä¸€ä¸ªè¦æ±‚ï¼šå¤Ÿç‰¹åˆ«ã€‚åªè¦è¿™ä¸ªå ä½ç¬¦èƒ½å’Œå…¶ä»–é…ç½®æ–‡ä»¶å­—ç¬¦åŒºåˆ†å¼€å°±è¡Œï¼Œæ‰€ä»¥è¿™é‡Œè®¾è®¡å ä½ç¬¦ä¸ºæ¯”è¾ƒæœ‰è¯­ä¹‰çš„â€œenv(XXXX)â€ã€‚æ¯”å¦‚app/config/development/database.yaml æ–‡ä»¶ä¸­çš„æ•°æ®åº“å¯†ç ï¼Œä½¿ç”¨å ä½ç¬¦è¡¨ç¤ºå¦‚ä¸‹ï¼š

```yaml
mysql:
  hostname: 127.0.0.1
  username: yejianfeng
  password: env(DB_PASSWORD)
  timeout: 1
  readtime: 2.3
```

è¦å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œå¯ä»¥åœ¨è¯»å–YAMLé…ç½®æ–‡ä»¶å†…å®¹ä¹‹åï¼Œè¿›è¡Œå®Œæ•´çš„æ–‡æœ¬åŒ¹é…ï¼Œå°†æ‰€æœ‰ç¯å¢ƒå˜é‡env(xxx) çš„å­—ç¬¦æ›¿æ¢ä¸ºç¯å¢ƒå˜é‡ã€‚æˆ‘ä»¬åº”è¯¥èƒ½è®¾è®¡å‡ºæ›¿æ¢æ–‡æœ¬çš„å‡½æ•°ã€‚

åœ¨æ¡†æ¶ç›®å½•çš„provider/config/service.goä¸­ï¼Œå¯ä»¥å…ˆå®ç°è¿™ä¸ªæ–¹æ³•ã€‚

```go
// replace è¡¨ç¤ºä½¿ç”¨ç¯å¢ƒå˜é‡mapsæ›¿æ¢contextä¸­çš„env(xxx)çš„ç¯å¢ƒå˜é‡
func replace(content []byte, maps map[string]string) []byte {
   if maps == nil {
      return content
   }
   // ç›´æ¥ä½¿ç”¨ReplaceAllæ›¿æ¢ã€‚è¿™ä¸ªæ€§èƒ½å¯èƒ½ä¸æ˜¯æœ€ä¼˜ï¼Œä½†æ˜¯é…ç½®æ–‡ä»¶åŠ è½½ï¼Œé¢‘ç‡æ˜¯æ¯”è¾ƒä½çš„ï¼Œå¯ä»¥æ¥å—
   for key, val := range maps {
      reKey := "env(" + key + ")"
      content = bytes.ReplaceAll(content, []byte(reKey), []byte(val))
   }
   return content
}
```

### é…ç½®é¡¹çš„è§£æ

è¯»å–å¹¶è§£æå®Œé…ç½®æ–‡ä»¶å†…å®¹ï¼Œæ¥ä¸‹æ¥å°±è¦æ ¹æ®pathæ¥è§£ææŸä¸ªé…ç½®é¡¹äº†ã€‚ä¸Šä¸€èŠ‚è¯¾è¯´ï¼Œæˆ‘ä»¬ä½¿ç”¨ç‚¹å·åˆ†å‰²çš„è·¯å¾„è¯»å–æ–¹å¼ï¼Œæ¯”å¦‚database.mysql.password è¡¨ç¤ºåœ¨é…ç½®æ–‡ä»¶å¤¹ä¸­çš„database.yamlæ–‡ä»¶ï¼Œå…¶ä¸­çš„mysqlé…ç½®ï¼Œå¯¹åº”çš„æ˜¯æ•°æ®ç»“æ„ä¸­çš„passwordå­—æ®µã€‚

é‚£è¿™ç§æ ¹æ®pathæ¥è¯»å–å­—æ®µåº”è¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿ

åœ¨è·å–é…ç½®é¡¹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å·²ç»é€šè¿‡go-yamlåº“å°†é…ç½®æ–‡ä»¶è§£æåˆ°ä¸€ä¸ªmapæ•°æ®ç»“æ„ä¸­äº†ï¼Œè€Œè¿™ä¸ªmapæ•°æ®ç»“æ„çš„å­é¡¹ï¼Œæ˜æ˜¾ä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸€ä¸ªmapæ•°æ®ç»“æ„ã€‚æ‰€ä»¥æŒ‰ç…§pathè·¯å¾„æŸ¥æ‰¾ï¼Œè¿™æ˜æ˜¾åº”è¯¥æ˜¯ä¸€ä¸ª**å‡½æ•°é€’å½’é€»è¾‘**ã€‚

è¿˜æ˜¯ç”¨åˆšæ‰çš„database.mysql.passwordä¸¾ä¾‹ï¼Œå¯ä»¥æ‹†åˆ†ä¸º3ä¸ªç»“æ„ã€‚database å»æ ¹mapä¸­å¯»æ‰¾ï¼›å¦‚æœæœ‰è¿™ä¸ªkeyï¼Œå°±æ‹¿ç€mysql.passwordçš„pathï¼Œå» databaseè¿™ä¸ªkeyå¯¹åº”çš„valueä¸­è¿›è¡Œå¯»æ‰¾ï¼›è€Œé€’å½’å¯»æ‰¾åˆ°äº†æœ€åä¸€çº§pathä¸ºpasswordï¼Œå‘ç°è¿™ä¸ªpathæ²¡æœ‰ä¸‹ä¸€çº§äº†ï¼Œå°±åœæ­¢é€’å½’ã€‚

è¯¦ç»†çš„ä»£ç æ–¹æ³•å¦‚ä¸‹ï¼ŒåŒæ ·å­˜æ”¾åœ¨æ¡†æ¶ç›®å½•çš„provider/config/service.goä¸­ã€‚

```go
// æŸ¥æ‰¾æŸä¸ªè·¯å¾„çš„é…ç½®é¡¹
func searchMap(source map[string]interface{}, path []string) interface{} {
   if len(path) == 0 {
      return source
   }

   // åˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸ªè·¯å¾„
   next, ok := source[path[0]]
   if ok {
      // åˆ¤æ–­è¿™ä¸ªè·¯å¾„æ˜¯å¦ä¸º1
      if len(path) == 1 {
         return next
      }

      // åˆ¤æ–­ä¸‹ä¸€ä¸ªè·¯å¾„çš„ç±»å‹
      switch next.(type) {
      case map[interface{}]interface{}:
         // å¦‚æœæ˜¯interfaceçš„mapï¼Œä½¿ç”¨castè¿›è¡Œä¸‹valueè½¬æ¢
         return searchMap(cast.ToStringMap(next), path[1:])
      case map[string]interface{}:
         // å¦‚æœæ˜¯map[string]ï¼Œç›´æ¥å¾ªç¯è°ƒç”¨
         return searchMap(next.(map[string]interface{}), path[1:])
      default:
         // å¦åˆ™çš„è¯ï¼Œè¿”å›nil
         return nil
      }
   }
   return nil
}

// é€šè¿‡pathè·å–æŸä¸ªå…ƒç´ 
func (conf *HadeConfig) find(key string) interface{} {
   ...
   return searchMap(conf.confMaps, strings.Split(key, conf.keyDelim))
}

```

æƒ³é€šäº†ä»¥ä¸Šä¸‰ä¸ªæ ¸å¿ƒå®ç°éš¾ç‚¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç€æ‰‹æ•´ä½“ä»£ç å®ç°äº†ã€‚

## é…ç½®æœåŠ¡çš„ä»£ç å®ç°

é¦–å…ˆï¼Œåœ¨æ¡†æ¶æ–‡ä»¶å¤¹çš„provider/config/service.go ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶æœåŠ¡HadeConfigã€‚å®ƒæœ‰å‡ ä¸ªå±æ€§ï¼šfolderä»£è¡¨é…ç½®æœ¬åœ°é…ç½®æ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼›keyDelimä»£è¡¨è·¯å¾„ä¸­çš„åˆ†å‰²ç¬¦å·ï¼Œä¹Ÿå°±æ˜¯ç‚¹ï¼›envMapså­˜æ”¾æ‰€æœ‰çš„ç¯å¢ƒå˜é‡ï¼›è€ŒconfMapså­˜æ”¾æ¯ä¸ªé…ç½®è§£æåçš„ç»“æ„ï¼ŒconfRawså­˜æ”¾æ¯ä¸ªé…ç½®çš„åŸå§‹æ–‡ä»¶ä¿¡æ¯ã€‚

```go
// HadeConfig  è¡¨ç¤ºhadeæ¡†æ¶çš„é…ç½®æ–‡ä»¶æœåŠ¡
type HadeConfig struct {
   c        framework.Container    // å®¹å™¨
   folder   string                 // æ–‡ä»¶å¤¹
   keyDelim string                 // è·¯å¾„çš„åˆ†éš”ç¬¦ï¼Œé»˜è®¤ä¸ºç‚¹
   ...
   envMaps  map[string]string      // æ‰€æœ‰çš„ç¯å¢ƒå˜é‡
   confMaps map[string]interface{} // é…ç½®æ–‡ä»¶ç»“æ„ï¼Œkeyä¸ºæ–‡ä»¶å
   confRaws map[string][]byte      // é…ç½®æ–‡ä»¶çš„åŸå§‹ä¿¡æ¯
}
```

æˆ‘ä»¬åˆå§‹åŒ–è¿™ä¸ªHadeConfigçš„å‡½æ•°ï¼Œå®ƒä»æœåŠ¡æä¾›è€…provider/config/provider.goä¸­è·å–åˆ°ä¸‰ä¸ªå‚æ•°ï¼Œé™¤äº†å®¹å™¨ä¹‹å¤–ï¼Œå¦å¤–ä¸¤ä¸ªæ˜¯æ–‡ä»¶å¤¹åœ°å€å’Œæ‰€æœ‰çš„ç¯å¢ƒå˜é‡ã€‚

æˆ‘ä»¬è¿™é‡Œå¯¹provider.go åªåˆ—ä¸€ä¸‹å‚æ•°å‡½æ•°ï¼Œå…¶ä»–çš„å››ä¸ªæœåŠ¡æä¾›è€…å‡½æ•°(Registerã€Bootã€IsDeferã€Name) å¯ä»¥å‚è€ƒ[GitHubä¸Šçš„ä»£ç ](https://github.com/gohade/coredemo/blob/geekbang/16/framework/provider/config/provider.go)ã€‚

```go
// Paramas æœåŠ¡æä¾›è€…å®ä¾‹åŒ–çš„æ—¶å€™å‚æ•°
func (provider *HadeConfigProvider) Params(c framework.Container) []interface{} {
   appService := c.MustMake(contract.AppKey).(contract.App)
   envService := c.MustMake(contract.EnvKey).(contract.Env)
   env := envService.AppEnv()
   // é…ç½®æ–‡ä»¶å¤¹åœ°å€
   configFolder := appService.ConfigFolder()
   envFolder := filepath.Join(configFolder, env)
   // ä¼ é€’å®¹å™¨ï¼Œé…ç½®æ–‡ä»¶å¤¹åœ°å€ï¼Œæ‰€æœ‰ç¯å¢ƒå˜é‡
   return []interface{}{c, envFolder, envService.All()}
}
```

é‚£ä¹ˆåœ¨provider/config/service.goä¸­ï¼Œå®ä¾‹åŒ–çš„å‡½æ•°é€»è¾‘å¦‚ä¸‹ï¼š

```go
// NewHadeConfig åˆå§‹åŒ–Configæ–¹æ³•
func NewHadeConfig(params ...interface{}) (interface{}, error) {
   container := params[0].(framework.Container)
   envFolder := params[1].(string)
   envMaps := params[2].(map[string]string)
   
   // æ£€æŸ¥æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
   if _, err := os.Stat(envFolder); os.IsNotExist(err) {
      return nil, errors.New("folder " + envFolder + " not exist: " + err.Error())
   }
   // å®ä¾‹åŒ–
   hadeConf := &HadeConfig{
      c:        container,
      folder:   envFolder,
      envMaps:  envMaps,
      confMaps: map[string]interface{}{},
      confRaws: map[string][]byte{},
      keyDelim: ".",
      lock:     sync.RWMutex{},
   }
   // è¯»å–æ¯ä¸ªæ–‡ä»¶
   files, err := ioutil.ReadDir(envFolder)
   if err != nil {
      return nil, errors.WithStack(err)
   }
   for _, file := range files {
      fileName := file.Name()
      err := hadeConf.loadConfigFile(envFolder, fileName)
      if err != nil {
         log.Println(err)
         continue
      }
   }
   ...
   return hadeConf, nil
}

// è¯»å–æŸä¸ªé…ç½®æ–‡ä»¶
func (conf *HadeConfig) loadConfigFile(folder string, file string) error {
   conf.lock.Lock()
   defer conf.lock.Unlock()
   //  åˆ¤æ–­æ–‡ä»¶æ˜¯å¦ä»¥yamlæˆ–è€…ymlä½œä¸ºåç¼€
   s := strings.Split(file, ".")
   if len(s) == 2 && (s[1] == "yaml" || s[1] == "yml") {
      name := s[0]
      // è¯»å–æ–‡ä»¶å†…å®¹
      bf, err := ioutil.ReadFile(filepath.Join(folder, file))
      if err != nil {
         return err
      }
      // ç›´æ¥é’ˆå¯¹æ–‡æœ¬åšç¯å¢ƒå˜é‡çš„æ›¿æ¢
      bf = replace(bf, conf.envMaps)
      // è§£æå¯¹åº”çš„æ–‡ä»¶
      c := map[string]interface{}{}
      if err := yaml.Unmarshal(bf, &c); err != nil {
         return err
      }
      conf.confMaps[name] = c
      conf.confRaws[name] = bf
   }
   return nil
}
```

é€»è¾‘éå¸¸æ¸…æ™°ã€‚å…ˆæ£€æŸ¥é…ç½®æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨ï¼Œç„¶åè¯»å–æ–‡ä»¶å¤¹ä¸­çš„æ¯ä¸ªä»¥yamlæˆ–è€…ymlåç¼€çš„æ–‡ä»¶ï¼›è¯»å–ä¹‹åï¼Œå…ˆç”¨replaceå¯¹ç¯å¢ƒå˜é‡è¿›è¡Œä¸€æ¬¡æ›¿æ¢ï¼›æ›¿æ¢ä¹‹åä½¿ç”¨ go-yamlï¼Œå¯¹æ–‡ä»¶è¿›è¡Œè§£æã€‚

åˆå§‹åŒ–å®ä¾‹å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„ è§£ææ–‡ä»¶çš„è¿‡ç¨‹ï¼Œè§£æç»“æŸä¹‹åï¼ŒconfMapsé‡Œå­˜æ”¾çš„å°±æ˜¯è§£æä¹‹åçš„ç»“æœã€‚

é…ç½®æ–‡ä»¶çš„è·å–æ¥å£ä¸ŠèŠ‚è¯¾å·²ç»å†™å¥½äº†ï¼Œå®šä¹‰äº†æ¥å£çš„ç³»åˆ—æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬å°±è¯¦ç»†å®ç°Get/GetBool/GetIntï¼Œå…¶ä»–æ–¹æ³•å¤§åŒå°å¼‚ï¼Œå°±ä¸è´´å‡ºæ¥äº†ï¼Œä½ å¯ä»¥ç›´æ¥å‚è€ƒ[GitHubä¸Šçš„ä»£ç ](https://github.com/gohade/coredemo/blob/geekbang/16/framework/provider/config/service.go)ã€‚

å‰é¢å·²ç»æƒ³å¥½äº†ï¼Œç”¨æ–¹æ³•findï¼Œé€šè¿‡pathï¼Œä»ä¸€ä¸ªåµŒå¥—map confMapsä¸­è·å–æ•°æ®ã€‚æ‰€ä»¥Getæ–¹æ³•å°±æ˜¯è°ƒç”¨ä¸€ä¸‹findæ–¹æ³•è€Œå·²ï¼ŒåŒæ ·ä¹Ÿåœ¨service.goä¸­ï¼š

```go
// Get è·å–æŸä¸ªé…ç½®é¡¹
func (conf *HadeConfig) Get(key string) interface{} {
   return conf.find(key)
}
```

è€Œå¯¹åº”çš„Getç³»åˆ—çš„æ–¹æ³•æˆ‘ä»¬ä½¿ç”¨caståº“è¿›è¡Œç±»å‹è½¬æ¢ï¼Œæ¯”å¦‚ï¼š

```go
// GetBool è·å–boolç±»å‹é…ç½®
func (conf *HadeConfig) GetBool(key string) bool {
   return cast.ToBool(conf.find(key))
}
// GetInt è·å–intç±»å‹é…ç½®
func (conf *HadeConfig) GetInt(key string) int {
   return cast.ToInt(conf.find(key))
}
```

åˆ°è¿™é‡Œï¼Œé…ç½®æœåŠ¡çš„ä»£ç å·²ç»åŸºæœ¬æˆå‹äº†ã€‚ä½†æ˜¯å®é™…ä¸Šè¿˜æœ‰ä¸¤ä¸ªç»†èŠ‚æˆ‘ä»¬éœ€è¦è®¤çœŸæ€è€ƒã€‚

é¦–å…ˆï¼Œå› ä¸ºä¹‹å‰æˆ‘ä»¬è®¾ç½®è¿‡AppæœåŠ¡ï¼Œå°†ä¸€ä¸ªAppæœåŠ¡çš„ç›®å½•éƒ½å®‰æ’å¥½äº†ï¼Œä½†æ˜¯å¦‚æœä¹‹åæœ‰éœ€æ±‚è¦æ”¹å˜è¿™äº›ç›®å½•çš„é…ç½®å‘¢ï¼Ÿå¦‚æœæœ‰çš„è¯ï¼Œæ˜¯å¦å¯ä»¥é€šè¿‡é…ç½®æ¥è¿›è¡Œä¿®æ”¹å‘¢ï¼Ÿæ‰€ä»¥ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæˆ‘ä»¬è¦æ€è€ƒé…ç½®æ–‡ä»¶æ›´æ–°AppæœåŠ¡çš„æ“ä½œã€‚

å…¶æ¬¡ï¼Œå‡è®¾ç°åœ¨é…ç½®æœåŠ¡èƒ½ä»æ–‡ä»¶ä¸­è·å–é…ç½®äº†ï¼Œä½†æ˜¯å¦‚æœæ–‡ä»¶ä¿®æ”¹äº†ï¼Œæˆ‘ä»¬æ˜¯å¦éœ€è¦é‡æ–°å¯åŠ¨åº”ç”¨å‘¢ï¼Ÿæ˜¯å¦æœ‰èƒ½ä¸å¯åŠ¨åº”ç”¨çš„æ–¹æ³•å‘¢ï¼Ÿ

ä¸‹é¢æˆ‘ä»¬æ¥ä¸€ä¸€è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ã€‚

## é…ç½®æ–‡ä»¶æ›´æ–°AppæœåŠ¡

ç°åœ¨æœ‰äº†é…ç½®æ–‡ä»¶æœåŠ¡ï¼Œä½†åœ¨æ²¡æœ‰é…ç½®æ–‡ä»¶æœåŠ¡ä¹‹å‰ï¼Œæˆ‘ä»¬å¯åŠ¨æœåŠ¡çš„appServiceï¼Œä¹Ÿæ˜¯æœ‰å¯èƒ½è¦ä¿®æ”¹è¿™ä¸ªæœåŠ¡çš„é…ç½®çš„ã€‚å›å¿†[ç¬¬åäºŒ](https://time.geekbang.org/column/article/423982)[è¯¾](https://time.geekbang.org/column/article/423982)ï¼ŒappServiceä¸­å­˜æ”¾äº†å¯åŠ¨è¿™ä¸ªä¸šåŠ¡å®ä¾‹é»˜è®¤è®¾ç½®çš„æ–‡ä»¶å¤¹ç›®å½•å’Œåœ°å€ã€‚

```go
//BaseFolder å®šä¹‰é¡¹ç›®åŸºç¡€åœ°å€
BaseFolder() string
// ConfigFolder å®šä¹‰äº†é…ç½®æ–‡ä»¶çš„è·¯å¾„
ConfigFolder() string
// LogFolder å®šä¹‰äº†æ—¥å¿—æ‰€åœ¨è·¯å¾„
LogFolder() string
// ProviderFolder å®šä¹‰ä¸šåŠ¡è‡ªå·±çš„æœåŠ¡æä¾›è€…åœ°å€
ProviderFolder() string
// MiddlewareFolder å®šä¹‰ä¸šåŠ¡è‡ªå·±å®šä¹‰çš„ä¸­é—´ä»¶
MiddlewareFolder() string
// CommandFolder å®šä¹‰ä¸šåŠ¡å®šä¹‰çš„å‘½ä»¤
CommandFolder() string
// RuntimeFolder å®šä¹‰ä¸šåŠ¡çš„è¿è¡Œä¸­é—´æ€ä¿¡æ¯
RuntimeFolder() string
// TestFolder å­˜æ”¾æµ‹è¯•æ‰€éœ€è¦çš„ä¿¡æ¯
TestFolder() string
```

ç°åœ¨æœ‰éœ€æ±‚å°†è¿™äº›æ–‡ä»¶å¤¹ç›®å½•ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®å¹¶ä¿®æ”¹ã€‚æ‰€ä»¥åº”è¯¥åœ¨åŠ è½½åˆ°é…ç½®æœåŠ¡æ—¶ï¼Œå†æ›´æ–°ä¸‹appServiceã€‚åŠ è½½é€»è¾‘å¦‚ä¸‹ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/f5/ee/f5141333501ce140314fb985b75c6eee.jpg?wh=1920x1080)

å¯ä»¥æŠŠè®¾å®šAppçš„è¿™äº›é…ç½®æ–‡ä»¶ï¼Œå­˜æ”¾åœ¨é…ç½®æ–‡ä»¶å¤¹çš„app.yamlæ–‡ä»¶çš„pathè®¾ç½®é¡¹ä¸‹ï¼Œå…¶ä¸­æ¯ä¸ªé…ç½®é¡¹çš„keyï¼Œå¯¹åº”appServiceä¸­æ¯ä¸ªå¯¹åº”çš„æœåŠ¡ã€‚æ¯”å¦‚log\_folderå¯¹åº”LogFolderç›®å½•ï¼š

```go
path:
  log_folder: "/home/jianfengye/hade/log/"
  runtime_folder: "/home/jianfengye/hade/runtime/"
```

ç°åœ¨åŠ è½½é…ç½®æœåŠ¡çš„æ—¶å€™ï¼Œå½“è¯»å–åˆ°é…ç½®æœåŠ¡app.pathä¸‹æœ‰å†…å®¹ï¼Œå°±éœ€è¦æ›´æ–°appServiceçš„é…ç½®ã€‚é¦–å…ˆéœ€è¦ä¿®æ”¹appServiceï¼Œä¿®æ”¹æ¡†æ¶ç›®å½•ä¸‹çš„provider/app/service.goæ–‡ä»¶ã€‚

å°†HadeAppå¢åŠ ä¸€ä¸ªconfigMapå­—æ®µï¼š

```go
// HadeApp ä»£è¡¨hadeæ¡†æ¶çš„Appå®ç°
type HadeApp struct {
   ...
   configMap map[string]string // é…ç½®åŠ è½½
}
```

åŒæ—¶ä¸ºHadeAppå¢åŠ LoadAppConfigæ–¹æ³•ï¼Œç”¨äºè¯»å–é…ç½®æ–‡ä»¶ä¸­çš„ä¿¡æ¯ï¼š

```go
// LoadAppConfig åŠ è½½é…ç½®map
func (app *HadeApp) LoadAppConfig(kv map[string]string) {
   for key, val := range kv {
      app.configMap[key] = val
   }
}
```

å†ä¿®æ”¹å¯¹åº”çš„LogFolderç­‰ä¸€ç³»åˆ—XXXFolderçš„æ–¹æ³•ï¼Œå…ˆè¯»å–configMapä¸­çš„å€¼ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œå…ˆç”¨configMapä¸­çš„å€¼ï¼š

```go
// LogFolder è¡¨ç¤ºæ—¥å¿—å­˜æ”¾åœ°å€
func (app HadeApp) LogFolder() string {
   if val, ok := app.configMap["log_folder"]; ok {
      return val
   }
   return filepath.Join(app.StorageFolder(), "log")
}

```

è¿™æ ·ï¼Œå¯¹appServiceçš„ä¿®æ”¹å°±å®Œæˆäº†ã€‚

åœ¨configServiceï¼Œè¯»å–é…ç½®æ–‡ä»¶loadConfigFileçš„æ—¶å€™ï¼Œè¦æ³¨æ„ï¼Œå¦‚æœå½“å‰çš„é…ç½®æ–‡ä»¶æ˜¯app.yamlï¼Œ æˆ‘ä»¬éœ€è¦è°ƒç”¨appServiceçš„LoadAppConfigæ–¹æ³•ï¼š

```go
// è¯»å–æŸä¸ªé…ç½®æ–‡ä»¶
func (conf *HadeConfig) loadConfigFile(folder string, file string) error {
   ...

   //  åˆ¤æ–­æ–‡ä»¶æ˜¯å¦ä»¥yamlæˆ–è€…ymlä½œä¸ºåç¼€
   s := strings.Split(file, ".")
   if len(s) == 2 && (s[1] == "yaml" || s[1] == "yml") {
      name := s[0]

      ...

      // è¯»å–app.pathä¸­çš„ä¿¡æ¯ï¼Œæ›´æ–°appå¯¹åº”çš„folder
      if name == "app" && conf.c.IsBind(contract.AppKey) {
         if p, ok := c["path"]; ok {
            appService := conf.c.MustMake(contract.AppKey).(contract.App)
            appService.LoadAppConfig(cast.ToStringMapString(p))
         }
      }
   }
   return nil
}
```

è¿™æ ·åœ¨åŠ è½½app.yamlçš„é…ç½®æ–‡ä»¶çš„æ—¶å€™ï¼Œå°±åŒæ—¶æ›´æ–°äº†appService é‡Œé¢çš„é…ç½®ã€‚

## é…ç½®æ–‡ä»¶çƒ­æ›´æ–°

æ­£å¸¸æ¥è¯´ï¼Œåœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™ä¼šè¯»å–ä¸€æ¬¡é…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éš¾å…ä¼šé‡åˆ°éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶çš„æ“ä½œã€‚ä¹Ÿå°±æ˜¯ä¹‹å‰æ€è€ƒçš„ç¬¬äºŒä¸ªé—®é¢˜ã€‚

è¿™ä¸ªæ—¶å€™ï¼Œæ˜¯å¦éœ€è¦é‡æ–°å¯åŠ¨ä¸€æ¬¡ç¨‹åºå†åŠ è½½ä¸€æ¬¡é…ç½®æ–‡ä»¶å‘¢ï¼Ÿè¿™å½“ç„¶æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯æ›´ä¸ºå¼ºå¤§çš„æ˜¯ï¼Œ**æˆ‘ä»¬å¯ä»¥è‡ªåŠ¨ç›‘æ§é…ç½®æ–‡ä»¶ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå½“é…ç½®æ–‡ä»¶æœ‰ä¿®æ”¹å’Œæ›´æ–°çš„æ—¶å€™ï¼Œèƒ½è‡ªåŠ¨æ›´æ–°ç¨‹åºä¸­çš„é…ç½®æ–‡ä»¶ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯å®ç°é…ç½®æ–‡ä»¶çƒ­æ›´æ–°**ã€‚

è¿™ä¸ªçƒ­æ›´æ–°çœ‹èµ·æ¥å¾ˆéº»çƒ¦ï¼Œå…¶å®åœ¨Golangä¸­æ˜¯éå¸¸ç®€å•çš„äº‹æƒ…ã€‚æˆ‘ä»¬ä½¿ç”¨ [fsnotify](https://github.com/fsnotify/fsnotify) åº“èƒ½å¾ˆæ–¹ä¾¿å¯¹ä¸€ä¸ªæ–‡ä»¶å¤¹è¿›è¡Œç›‘æ§ï¼Œå½“æ–‡ä»¶å¤¹ä¸­æœ‰æ–‡ä»¶å¢/åˆ /æ”¹çš„æ—¶å€™ï¼Œä¼šé€šè¿‡channelè¿›è¡Œäº‹ä»¶å›è°ƒã€‚

è¿™ä¸ªåº“çš„ä½¿ç”¨æ–¹å¼å¾ˆç®€å•ã€‚å¤§è‡´æ€è·¯å°±æ˜¯å…ˆä½¿ç”¨NewWatcheråˆ›å»ºä¸€ä¸ªç›‘æ§å™¨watcherï¼Œç„¶åä½¿ç”¨Addæ¥ç›‘æ§æŸä¸ªæ–‡ä»¶å¤¹ï¼Œé€šè¿‡watcherè®¾ç½®çš„eventsæ¥åˆ¤æ–­æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–ï¼Œå¦‚æœæœ‰å˜åŒ–ï¼Œå°±è¿›è¡Œå¯¹åº”çš„æ“ä½œï¼Œæ¯”å¦‚æ›´æ–°å†…å­˜ä¸­é…ç½®æœåŠ¡å­˜å‚¨çš„mapç»“æ„ã€‚

```go
// NewHadeConfig åˆå§‹åŒ–Configæ–¹æ³•
func NewHadeConfig(params ...interface{}) (interface{}, error) {
   ...

   // ç›‘æ§æ–‡ä»¶å¤¹æ–‡ä»¶
   watch, err := fsnotify.NewWatcher()
   if err != nil {
      return nil, err
   }
   err = watch.Add(envFolder)
   if err != nil {
      return nil, err
   }
   go func() {
      defer func() {
         if err := recover(); err != nil {
            fmt.Println(err)
         }
      }()

      for {
         select {
         case ev := <-watch.Events:
            {
               //åˆ¤æ–­äº‹ä»¶å‘ç”Ÿçš„ç±»å‹ï¼Œå¦‚ä¸‹5ç§
               // Create åˆ›å»º
               // Write å†™å…¥
               // Remove åˆ é™¤
               path, _ := filepath.Abs(ev.Name)
               index := strings.LastIndex(path, string(os.PathSeparator))
               folder := path[:index]
               fileName := path[index+1:]

               if ev.Op&fsnotify.Create == fsnotify.Create {
                  log.Println("åˆ›å»ºæ–‡ä»¶ : ", ev.Name)
                  hadeConf.loadConfigFile(folder, fileName)
               }
               if ev.Op&fsnotify.Write == fsnotify.Write {
                  log.Println("å†™å…¥æ–‡ä»¶ : ", ev.Name)
                  hadeConf.loadConfigFile(folder, fileName)
               }
               if ev.Op&fsnotify.Remove == fsnotify.Remove {
                  log.Println("åˆ é™¤æ–‡ä»¶ : ", ev.Name)
                  hadeConf.removeConfigFile(folder, fileName)
               }
            }
         case err := <-watch.Errors:
            {
               log.Println("error : ", err)
               return
            }
         }
      }
   }()

   return hadeConf, nil
}
```

ä»£ç å¦‚ä¸Šï¼Œæˆ‘ä»¬ä½¿ç”¨NewWatcheråˆ›å»ºä¸€ä¸ªç›‘å¬å™¨ï¼Œç›‘å¬é…ç½®æ–‡ä»¶ç›®å½•ï¼Œæ¥ç€å¯åŠ¨ä¸€ä¸ªæ–°çš„Goroutineä½œä¸ºç›‘å¬åç¨‹ã€‚åœ¨ç›‘å¬åç¨‹ä¸­ï¼Œç›‘å¬é…ç½®æ–‡ä»¶çš„åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤æ“ä½œã€‚åˆ›å»ºå’Œæ›´æ–°å¯¹åº” LoadConfigFile æ“ä½œã€‚

è€Œåˆ é™¤ï¼Œå¯¹åº”çš„æ˜¯ removeConfigFileæ“ä½œï¼Œè¿™ä¸ªæ“ä½œçš„å†…å®¹å°±æ˜¯åˆ é™¤é…ç½®æœåŠ¡ä¸­çš„confMapsä¸­å¯¹åº”çš„keyã€‚

```go
// åˆ é™¤æ–‡ä»¶çš„æ“ä½œ
func (conf *HadeConfig) removeConfigFile(folder string, file string) error {
   conf.lock.Lock()
   defer conf.lock.Unlock()
   s := strings.Split(file, ".")
   // åªæœ‰yamlæˆ–è€…ymlåç¼€æ‰æ‰§è¡Œ
   if len(s) == 2 && (s[1] == "yaml" || s[1] == "yml") {
      name := s[0]
      // åˆ é™¤å†…å­˜ä¸­å¯¹åº”çš„key
      delete(conf.confRaws, name)
      delete(conf.confMaps, name)
   }
   return nil
}
```

è¿™é‡Œæ³¨æ„ä¸‹ï¼Œç”±äºåœ¨è¿è¡Œæ—¶å¢åŠ äº†å¯¹confMapsçš„å†™æ“ä½œï¼Œæ‰€ä»¥éœ€è¦å¯¹confMapsè¿›è¡Œé”è®¾ç½®ï¼Œä»¥é˜²æ­¢åœ¨å†™confMapsçš„æ—¶å€™ï¼Œè¯»æ“ä½œè¿›å…¥è¯»å–äº†é”™è¯¯ä¿¡æ¯ã€‚

åˆ†æç›®å‰çš„è¿™ä¸ªåœºæ™¯ï¼Œè¯»æ˜æ˜¾å¤šäºå†™ã€‚æ‰€ä»¥æˆ‘ä»¬çš„é”åº”è¯¥æ˜¯ä¸€ä¸ªè¯»å†™é”ï¼Œè¯»å†™é”å¯ä»¥è®©å¤šä¸ªè¯»å¹¶å‘è¯»ï¼Œä½†æ˜¯åªè¦æœ‰ä¸€ä¸ªå†™æ“ä½œï¼Œè¯»å’Œå†™éƒ½éœ€è¦ç­‰å¾…ã€‚è¿™ä¸ªå¾ˆç¬¦åˆå½“å‰è¿™ä¸ªåœºæ™¯ã€‚

æ‰€ä»¥åœ¨æ¡†æ¶ç›®å½•çš„provider/config/service.goä¸­çš„HadeConfigï¼Œæˆ‘ä»¬å¢åŠ äº†ä¸€ä¸ªè¯»å†™é”lockã€‚

```go
// HadeConfig  è¡¨ç¤ºhadeæ¡†æ¶çš„é…ç½®æ–‡ä»¶æœåŠ¡
type HadeConfig struct {
   ...
   lock     sync.RWMutex           // é…ç½®æ–‡ä»¶è¯»å†™é”
   ...
}
```

è€Œåœ¨loadConfigFileå’ŒremoveConfigFileè¿™ä¸¤ä¸ªå¯¹é…ç½®æœ‰ä¿®æ”¹çš„æƒ…å†µï¼Œä½¿ç”¨å†™é”é”ä½HadeConfigã€‚

```go
// è¯»å–æŸä¸ªé…ç½®æ–‡ä»¶
func (conf *HadeConfig) loadConfigFile(folder string, file string) error {
   conf.lock.Lock()
   defer conf.lock.Unlock()

   ...
}
```

åœ¨Getç³»åˆ—æ–¹æ³•è°ƒç”¨çš„findå‡½æ•°ä¸­ï¼Œä½¿ç”¨è¯»é”æ¥è¿›è¡Œè¯»æ“ä½œã€‚

```go
// é€šè¿‡pathæ¥è·å–æŸä¸ªé…ç½®é¡¹
func (conf *HadeConfig) find(key string) interface{} {
   conf.lock.RLock()
   defer conf.lock.RUnlock()
   ...
}
```

è¿™æ ·ï¼Œé…ç½®æœåŠ¡å°±å¼€å‘å®Œæˆäº†ã€‚

## éªŒè¯

æˆ‘ä»¬å…ˆæµ‹è¯•ç¯å¢ƒå˜é‡æ³¨å…¥é…ç½®æ–‡ä»¶çš„åŠŸèƒ½ã€‚å°†ä¸šåŠ¡ç›®å½•ä¸‹çš„config/development/database.yaml ä¸­çš„mysql.passwordï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡è¿›è¡Œæ›¿æ¢ã€‚

```yaml
mysql:
  hostname: 127.0.0.1
  username: yejianfeng
  password: env(DB_PASSWORD)
  timeout: 1
  readtime: 2.3
```

ç„¶åä¿®æ”¹ä¸šåŠ¡ç›®å½•ä¸‹çš„module/demo/api.goï¼Œæ›¿æ¢å…¶ä¸­/demo/demoå¯¹åº”çš„è·¯ç”±æ–¹æ³•ã€‚

```go
func (api *DemoApi) Demo(c *gin.Context) {
   // è·å–password
   configService := c.MustMake(contract.ConfigKey).(contract.Config)
   password := configService.GetString("database.mysql.password")
   // æ‰“å°å‡ºæ¥
   c.JSON(200, password)
}
```

æœ€åä½¿ç”¨å‘½ä»¤è¡Œ `./hade app start` å¯åŠ¨æœåŠ¡ã€‚æ‰“å¼€æµè§ˆå™¨ï¼Œçœ‹åˆ°è¾“å‡ºï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/27/f1/275ddfb18f04549dd62e6b45fc3cccf1.png?wh=478x86)

è¯´æ˜æ­¤æ—¶è¿˜æ²¡æ³¨å…¥ç¯å¢ƒå˜é‡ã€‚ä¸‹é¢ä½¿ç”¨å‘½ä»¤è¡Œï¼š

```plain
DB_PASSWORD=123 ./hade app start
```

å¯åŠ¨æœåŠ¡ã€‚è¿™ä¸ªå‘½ä»¤æ³¨å…¥äº†DB\_PASSWORDè¿™ä¸ªç¯å¢ƒå˜é‡ã€‚  
é‡å¯æ‰“å¼€æµè§ˆå™¨çœ‹åˆ°è¾“å‡ºã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/33/b6/33f14f5277ea8294458141d5393269b6.png?wh=405x90)

ç¯å¢ƒå˜é‡æ³¨å…¥æˆåŠŸï¼

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¸åœæ­¢è¿›ç¨‹ï¼Œç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶database.yamlä¸­çš„mysql.passwordï¼š

```yaml
mysql:
  hostname: 127.0.0.1
  username: yejianfeng
  password: 456789
  timeout: 1
  readtime: 2.3
```

æ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å‡ºå·²ç»å˜åŒ–äº†ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/6c/b7/6c86bf1f4f055d94fb17c756415a94b7.png?wh=377x82)

è¯´æ˜çƒ­æ›´æ–°å·²ç»ç”Ÿæ•ˆäº†ï¼Œæµ‹è¯•æˆåŠŸã€‚

ä»Šå¤©æ‰€æœ‰ä»£ç çš„ç›®å½•ç»“æ„æˆªå›¾ï¼Œä¹Ÿè´´åœ¨è¿™é‡Œä¾›ä½ å¯¹æ¯”æ£€æŸ¥ï¼Œä»£ç æ”¾åœ¨GitHubä¸Šçš„ [16åˆ†æ”¯](https://github.com/gohade/coredemo/tree/geekbang/16) é‡Œã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/6c/38/6c9b9046f41e4b5c0719fe205540c438.png?wh=351x1140)

## å°ç»“

é…ç½®æœåŠ¡åœ¨æ¡†æ¶ä¸­æ˜¯ä¸€ä¸ªéå¸¸åŸºç¡€ä¸”é‡è¦çš„æœåŠ¡ã€‚

æˆ‘ä»¬è€ƒè™‘äº†æ•´ä¸ªé…ç½®æœåŠ¡çš„å®ç°ï¼Œå…ˆè¯»å–é…ç½®æ–‡ä»¶ï¼Œå†æ›¿æ¢ç¯å¢ƒå˜é‡ï¼Œæœ€åå†æ ¹æ®è·¯å¾„è·å–é…ç½®é¡¹ï¼Œè¿™æ ·ä¸‰æ­¥èµ°å®Œæˆäº†åŸºæœ¬çš„é…ç½®æœåŠ¡ã€‚åœ¨é…ç½®æœåŠ¡çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬åˆè¡¥å……äº†é…ç½®æœåŠ¡åŠ è½½æ—¶å¯¹AppæœåŠ¡çš„æ›´æ–°ï¼Œå¹¶ä¸”ä¸ºé…ç½®æœåŠ¡å¢åŠ äº†çƒ­æ›´æ–°çš„æœºåˆ¶ã€‚

æˆ‘ä¸ªäººè®¤ä¸ºï¼Œé…ç½®æœåŠ¡æ˜¯ä¸€ä¸ªAppä¸­æœ€å¸¸ç”¨åˆ°çš„æœåŠ¡äº†ï¼Œæœ‰éå¸¸æ–¹ä¾¿çš„é…ç½®æœåŠ¡æ¥å£ï¼Œèƒ½ä¸ºä¸šåŠ¡ä»£ç èŠ‚çœä¸å°‘çš„ä»£ç é‡ã€‚**æä¾›å¤šç§è®¾ç½®é…ç½®çš„æ–¹å¼ï¼Œæ˜¯çœŸå®ä»ä¸šåŠ¡éœ€æ±‚å‡ºå‘çš„**ã€‚

æ¯”å¦‚åœ¨å®é™…å·¥ä½œä¸­ï¼Œæœ‰çš„éœ€æ±‚è¦æ±‚æ•°æ®åº“å¯†ç ä¸èƒ½è¿›å…¥gitåº“ï¼Œå¿…é¡»é€šè¿‡ç¯å¢ƒå˜é‡è·å–ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡è·å–é…ç½®ï¼›è€Œæœ‰çš„éœ€æ±‚è¦æ±‚åœ¨ä¸€ä¸ªæœåŠ¡å™¨ä¸Šè°ƒè¯•æµ‹è¯•å’Œé¢„å‘å¸ƒç¯å¢ƒï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡.envåˆ‡æ¢ä¸åŒç¯å¢ƒã€‚æ‰€ä»¥ï¼Œæœ‰ä¸ªå¤šå±‚æ¬¡çš„ç¯å¢ƒé…ç½®æœºåˆ¶ï¼Œå¯¹äºä¸€ä¸ªæ¡†æ¶æ¥è¯´æ˜¯éå¸¸å¿…è¦çš„ã€‚

## æ€è€ƒé¢˜

ç°åœ¨æœ‰é…ç½®æ–‡ä»¶æœåŠ¡äº†ï¼Œä½†æ˜¯æ ¹æ®è·¯å¾„ã€è·å–æŸä¸ªé…ç½®å´åªèƒ½åœ¨ä»£ç ä¸­è·å–ã€‚è¿™é‡Œæˆ‘ä»¬å¸Œæœ›æœ‰ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…· `./hade config get "database.mysql"` èƒ½è·å–åˆ°è¿™ä¸ªpathè·¯å¾„å¯¹åº”çš„é…ç½®ã€‚ä½ å¯ä»¥å°è¯•å®ç°ä¹ˆï¼Ÿ

æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒã€‚æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œå¦‚æœè§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·å­¦ä¹ ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï½
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ5ï¼‰</strong></div><ul>
<li><span>å‹</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é‚£å¿…é¡»æ˜¯å¯ä»¥å®ç°çš„ æˆ‘ç°åœ¨å°±å®ç°</p>2021-12-10</li><br/><li><span>qinsi</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é…ç½®æœåŠ¡å’ŒappæœåŠ¡å¼ºè€¦åˆäº†ï¼Œæˆ–è®¸å®ƒä»¬æœ¬æ¥å°±æ˜¯ä¸€ä½“çš„ï¼Ÿ</p>2021-10-23</li><br/><li><span>jack</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ„Ÿè§‰è¿™ä¸ª config æ–‡ä»¶å¤¹é‡Œé¢è¿‡äºå¤æ‚äº†ï¼Œ ä¸¤å±‚é…ç½®ç®€å•äº›ã€‚åŒºåˆ†å‡º development &#47; production &#47; testing æ²¡å¤ªå¤§å¿…è¦ï¼Œæ¯ä¸ªç¯å¢ƒä¸åŒï¼Œç”± .env æ–‡ä»¶å†³å®šå°±å¯ä»¥äº†</p>2022-08-27</li><br/><li><span>ç‰›ç‰å¯Œ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å—¯å—¯ï¼Œçƒ­åŠ è½½è¦çš„è¦çš„ã€‚
ç°åœ¨æ­£å¼æœ‰è‰¯å¥½çš„å®¹å™¨ã€ç›®å½•ç­‰è®¾è®¡æ‰èƒ½æœ‰åæ¥æ›´å¤æ‚çš„dddè®¾è®¡ã€‚</p>2022-01-13</li><br/><li><span>Panmax</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>password æ˜¯é€šè¿‡ç¯å¢ƒå˜é‡ä¼ å…¥çš„ï¼Œä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶ï¼Œæˆ‘è®¤ä¸ºä¸åº”è¯¥è¢«é…ç½®æ–‡ä»¶è¦†ç›–æ‰ã€‚</p>2021-10-22</li><br/>
</ul>