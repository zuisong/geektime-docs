ä½ å¥½ï¼Œæˆ‘æ˜¯è½©è„‰åˆƒã€‚

ä¸Šé¢ä¸¤èŠ‚è¯¾æŠŠæ•°æ®åº“æ“ä½œæ¥å…¥åˆ°hadeæ¡†æ¶ä¸­äº†ï¼Œç°åœ¨æˆ‘ä»¬èƒ½ä½¿ç”¨å®¹å™¨ä¸­çš„ORMæœåŠ¡æ¥æ“ä½œæ•°æ®åº“äº†ã€‚åœ¨å®é™…å·¥ä½œä¸­ï¼Œä¸€æ—¦æ•°æ®åº“å‡ºç°æ€§èƒ½ç“¶é¢ˆï¼Œé™¤äº†ä¼˜åŒ–æ•°æ®åº“æœ¬èº«ä¹‹å¤–ï¼Œå¦å¤–ä¸€ä¸ªå¸¸ç”¨çš„æ–¹æ³•æ˜¯ä½¿ç”¨ç¼“å­˜æ¥ä¼˜åŒ–ä¸šåŠ¡è¯·æ±‚ã€‚æ‰€ä»¥è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸‹ï¼Œhadeæ¡†æ¶å¦‚ä½•æä¾›ç¼“å­˜æ”¯æŒã€‚

ç°åœ¨çš„Webä¸šåŠ¡ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯ä½¿ç”¨Redisæ¥åšç¼“å­˜å®ç°ã€‚ä½†æ˜¯ï¼Œç¼“å­˜çš„å®ç°æ–¹å¼è¿œä¸æ­¢Redisä¸€ç§ï¼Œæ¯”å¦‚åœ¨Rediså‡ºç°ä¹‹å‰ï¼ŒMemcachedä¸€èˆ¬æ˜¯ç¼“å­˜é¦–é€‰ï¼›åœ¨å•æœºä¸Šï¼Œè¿˜å¯ä»¥ä½¿ç”¨æ–‡ä»¶æ¥å­˜å‚¨æ•°æ®ï¼Œåˆæˆ–è€…ç›´æ¥ä½¿ç”¨è¿›ç¨‹çš„å†…å­˜ä¹Ÿå¯ä»¥è¿›è¡Œç¼“å­˜å®ç°ã€‚

ç¼“å­˜æœåŠ¡çš„åº•å±‚ä½¿ç”¨å“ªä¸ªå­˜å‚¨æ–¹å¼ï¼Œå’Œå…·ä½“çš„ä¸šåŠ¡æ¶æ„åŸå‹ç›¸å…³ã€‚æˆ‘ä¸ªäººåœ¨ä¸åŒä¸šåŠ¡åœºæ™¯ä¸­ç”¨è¿‡ä¸å°‘çš„ç¼“å­˜å­˜å‚¨æ–¹æ¡ˆï¼Œä¸è¿‡ä¸šç•Œç”¨çš„æœ€å¤šçš„Redisï¼Œè¿˜æ˜¯ä¼˜ç‚¹æ¯”è¾ƒçªå‡ºã€‚ç›¸æ¯”æ–‡ä»¶å­˜å‚¨ï¼Œå®ƒèƒ½é›†ä¸­åˆ†å¸ƒå¼ç®¡ç†ï¼›è€Œç›¸æ¯”Memcachedï¼Œä¼˜åŠ¿åœ¨äºå¤šç»´åº¦çš„å­˜å‚¨æ•°æ®ç»“æ„ã€‚æ‰€ä»¥ï¼Œé¡ºåº”æ½®æµï¼Œæˆ‘ä»¬hadeæ¡†æ¶ä¸»è¦ä¹Ÿé’ˆå¯¹ä½¿ç”¨Redisæ¥å®ç°ç¼“å­˜æœåŠ¡ã€‚

æˆ‘ä»¬è¿™èŠ‚è¯¾ä¼šåˆ›å»ºä¸¤ä¸ªæœåŠ¡ï¼Œä¸€ä¸ªæ˜¯RedisæœåŠ¡ï¼Œæä¾›å¯¹Redisçš„å°è£…ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ç¼“å­˜æœåŠ¡ï¼Œæä¾›ä¸€ç³»åˆ—å¯¹â€œç¼“å­˜â€çš„ç»Ÿä¸€æ“ä½œã€‚è€Œè¿™äº›ç»Ÿä¸€æ“ä½œï¼Œå…·ä½“åº•å±‚æ˜¯ç”±Redisè¿˜æ˜¯å†…å­˜è¿›è¡Œé©±åŠ¨çš„ï¼Œè¿™ä¸ªå¯ä»¥æ ¹æ®é…ç½®å†³å®šã€‚

ä¸‹é¢æˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥è®¨è®ºå§ã€‚

## RedisæœåŠ¡

é¦–å…ˆå°è£…ä¸€ä¸ªå¯ä»¥å¯¹Redisè¿›è¡Œæ“ä½œçš„æœåŠ¡ã€‚å’Œå°è£…ORMä¸€æ ·ï¼Œæˆ‘ä»¬è‡ªå·±å¹¶ä¸å®ç°Redisçš„åº•å±‚ä¼ è¾“åè®®å’Œæ“ä½œå°è£…ï¼Œåªå°†Redisâ€œåˆ›å»ºè¿æ¥â€çš„è¿‡ç¨‹å°è£…åœ¨hadeä¸­å°±è¡Œäº†ã€‚

è¿™é‡Œæˆ‘ä»¬å°±é€‰æ‹©[go-redis](https://github.com/go-redis/redis)è¿™ä¸ªåº“æ¥å®ç°å¯¹Redisçš„è¿æ¥ã€‚è¿™ä¸ªåº“ç›®å‰ä¹Ÿæ˜¯Golangå¼€æºç¤¾åŒºæœ€å¸¸ç”¨çš„Redisåº“ï¼Œæœ‰12.8kçš„staræ•°ï¼Œä½¿ç”¨çš„æ˜¯BSD åè®®ï¼Œå¯ä»¥å¼•ç”¨ï¼Œå¯ä»¥ä¿®æ”¹ï¼Œä½†æ˜¯ä¿®æ”¹çš„åŒæ—¶è¦ä¿ç•™ç‰ˆæƒå£°æ˜ï¼Œè¿™é‡Œæˆ‘ä»¬å¹¶ä¸éœ€è¦ä¿®æ”¹ï¼Œæ‰€ä»¥BSDå·²ç»è¶³å¤Ÿäº†ã€‚è¿™ä¸ªåº“ç›®å‰æ˜¯v8ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ `go get github.com/go-redis/redis/v8` æ¥å¼•å…¥å®ƒã€‚

go-redisçš„è¿æ¥éå¸¸ç®€å•ï¼Œæˆ‘ä»¬çœ‹å®˜ç½‘çš„ä¾‹å­ï¼Œå°±çœ‹åˆ›å»ºè¿æ¥éƒ¨åˆ†ï¼š

```go
import (
Â  Â  "context"
Â  Â  "github.com/go-redis/redis/v8"
)

var ctx = context.Background()

func ExampleClient() {
    // åˆ›å»ºè¿æ¥
Â  Â  rdb := redis.NewClient(&redis.Options{
Â  Â  Â  Â  Addr:Â  Â  Â "localhost:6379",
Â  Â  Â  Â  Password: "", // no password set
Â  Â  Â  Â  DB:Â  Â  Â  Â 0,Â  // use default DB
Â  Â  })

Â  Â  ...
}
```

**æ ¸å¿ƒçš„redis.NewClientæ–¹æ³•ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ª\*redis.Clientç»“æ„ï¼Œå®ƒå°±ç›¸å½“äºGormä¸­çš„DBæ•°æ®ç»“æ„ï¼Œå°±æ˜¯æˆ‘ä»¬è¦å®ä¾‹åŒ–Redisçš„å®ä¾‹**ã€‚è¿™ä¸ªç»“æ„æ˜¯ä¸€ä¸ªå°è£…äº†300+ä¸ªRedisæ“ä½œçš„æ•°æ®ç»“æ„ï¼Œä½ å¯ä»¥ä½¿ç”¨ `go doc github.com/go-redis/redis/v8.Client` æ¥è§‚å¯Ÿå®ƒå°è£…çš„Redisæ“ä½œã€‚

### é…ç½®

redis.NewClientæ–¹æ³•è¿˜æœ‰ä¸€ä¸ªå‚æ•°ï¼š\*redis.Options æ•°æ®ç»“æ„ã€‚è¿™ä¸ªæ•°æ®ç»“æ„å°±ç›¸å½“äºGormä¸­çš„gorm.Configï¼Œé‡Œé¢å°è£…äº†å®ä¾‹åŒ–redis.Clientçš„å„ç§é…ç½®ä¿¡æ¯ï¼Œæ¥çœ‹ä¸€äº›é‡è¦çš„é…ç½®ï¼Œéƒ½åšäº†æ³¨é‡Šï¼š

```go
// redisçš„è¿æ¥é…ç½®
type Options struct {
   // ç½‘ç»œæƒ…å†µ
   // Default is tcp.
   Network string
   // host:port æ ¼å¼çš„åœ°å€
   Addr string
   
   // redisçš„ç”¨æˆ·å
   Username string
   // rediså¯†ç 
   Password string
   // redisçš„database
   DB int
   
   // è¿æ¥è¶…æ—¶
   // Default is 5 seconds.
   DialTimeout time.Duration
   // è¯»è¶…æ—¶
   // Default is 3 seconds.
   ReadTimeout time.Duration
   // å†™è¶…æ—¶
   // Default is ReadTimeout.
   WriteTimeout time.Duration
   
   // æœ€å°ç©ºé—²è¿æ¥æ•°
   MinIdleConns int
   // æœ€å¤§è¿æ¥æ—¶é•¿
   MaxConnAge time.Duration
   
   // ç©ºé—²è¿æ¥æ—¶é•¿
   // Default is 5 minutes. -1 disables idle timeout check.
   IdleTimeout time.Duration
   ...
}
```

è¿™äº›é…ç½®é¡¹ç›¸ä¿¡ä½ ä¹Ÿéå¸¸ç†Ÿæ‚‰äº†ï¼Œæ—¢æœ‰è¿æ¥è¯·æ±‚çš„é…ç½®é¡¹ï¼Œä¹Ÿæœ‰è¿æ¥æ± çš„é…ç½®é¡¹ã€‚

å’ŒGormçš„é…ç½®å°è£…ä¸€æ ·ï¼Œæˆ‘ä»¬æƒ³è¦ç»™ç”¨æˆ·æä¾›ä¸€ä¸ªé…ç½®å³ç”¨çš„ç¼“å­˜æœåŠ¡ï¼Œéœ€è¦åšå¦‚ä¸‹ä¸‰ä¸ªäº‹æƒ…ï¼š

- è‡ªå®šä¹‰ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå°è£…redis.Optionsç»“æ„
- è®©åˆšæ‰è‡ªå®šä¹‰çš„ç»“æ„èƒ½ç”Ÿæˆä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼ˆç±»ä¼¼Gormçš„DSNï¼‰
- æ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶åŠ è½½è¿™ä¸ªç»“æ„ï¼ŒåŒæ—¶ï¼Œæ”¯æŒé€šè¿‡Optionå¯å˜å‚æ•°æ¥ä¿®æ”¹å®ƒ

åœ¨framework/contract/redis.goä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰**RedisConfigæ•°æ®ç»“æ„**ï¼Œè¿™ä¸ªç»“æ„å•çº¯å°è£…redis.Optionså°±è¡Œäº†ï¼Œæ²¡æœ‰å…¶ä»–é¢å¤–çš„å‚æ•°éœ€è¦è®¾ç½®ï¼š

```go
// RedisConfig ä¸ºhadeå®šä¹‰çš„Redisé…ç½®ç»“æ„
type RedisConfig struct {
   *redis.Options
```

åŒæ—¶ä¸ºè¿™ä¸ªRedisConfigå®šä¹‰ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼Œæ¥æ ‡è¯†ä¸€ä¸ªredis.Clientã€‚è¿™é‡Œæˆ‘ä»¬é€‰ç”¨äº†Addrã€DBã€UserNameã€Network å››ä¸ªå­—æ®µå€¼æ¥æ ‡è¯†ã€‚**åŸºæœ¬ä¸Šè¿™å››ä¸ªå­—æ®µåŠ èµ·æ¥èƒ½æ ‡è¯†â€œç”¨ä»€ä¹ˆè´¦å·ç™»å½•å“ªä¸ªRedisåœ°å€çš„å“ªä¸ªdatabaseâ€äº†**ï¼š

```go
// UniqKey ç”¨æ¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ªRedisConfigé…ç½®
func (config *RedisConfig) UniqKey() string {
   return fmt.Sprintf("%v_%v_%v_%v", config.Addr, config.DB, config.Username, config.Network)
}
```

RedisConfigç»“æ„å®šä¹‰å®Œæˆï¼Œä¸‹é¢æƒ³è¦æŠŠå®ƒåŠ è½½å¹¶æ”¯æŒå¯ä¿®æ”¹ï¼Œæˆ‘ä»¬è¦ç»“åˆå®ä¾‹åŒ–redis.Clientå¯¹è±¡æ¥è¯´ã€‚

### åˆå§‹åŒ–è¿æ¥

å¦‚ä½•å°è£…Redisçš„è¿æ¥å®ä¾‹ï¼Œè¿™ä¸ªåŒGormçš„å°è£…ä¸€æ ·ï¼Œä½¿ç”¨Optionå¯å˜å‚æ•°çš„æ–¹å¼ã€‚è¿˜æ˜¯åœ¨ framework/contract/redis.goä¸­ç»§ç»­å†™å…¥ï¼š

```go
package contract

...

const RedisKey = "hade:redis"

// RedisOption ä»£è¡¨åˆå§‹åŒ–çš„æ—¶å€™çš„é€‰é¡¹
type RedisOption func(container framework.Container, config *RedisConfig) error

// RedisService è¡¨ç¤ºä¸€ä¸ªredisæœåŠ¡
type RedisService interface {
   // GetClient è·å–redisè¿æ¥å®ä¾‹
   GetClient(option ...RedisOption) (*redis.Client, error)
}
```

å®šä¹‰äº†ä¸€ä¸ªRedisServiceï¼Œè¡¨ç¤ºRedisæœåŠ¡å¯¹å¤–æä¾›çš„åè®®ï¼Œå®ƒåªæœ‰ä¸€ä¸ªGetClientæ–¹æ³•ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•èƒ½è·å–åˆ°Redisçš„ä¸€ä¸ªè¿æ¥å®ä¾‹redis.Clientã€‚

ä½ èƒ½çœ‹åˆ°GetClientæ–¹æ³•æœ‰ä¸€ä¸ªå¯å˜å‚æ•°RedisOptionï¼Œè¿™ä¸ªå¯å˜å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ç»“æ„ï¼Œå‚æ•°ä¸­å¸¦æœ‰ä¼ é€’è¿›å…¥äº†çš„RedisConfigæŒ‡é’ˆï¼Œæ‰€ä»¥**è¿™ä¸ªRedisOptionæ˜¯æœ‰ä¿®æ”¹RedisConfigç»“æ„çš„èƒ½åŠ›çš„**ã€‚

é‚£å…·ä½“æä¾›å“ªäº›RedisOptionå‡½æ•°å‘¢ï¼Ÿå’ŒORMä¸€æ ·ï¼Œæˆ‘ä»¬è¦æä¾›å¤šå±‚æ¬¡çš„ä¿®æ”¹æ–¹æ¡ˆï¼ŒåŒ…æ‹¬é»˜è®¤é…ç½®ã€æŒ‰ç…§é…ç½®é¡¹è¿›è¡Œé…ç½®ï¼Œä»¥åŠæ‰‹åŠ¨é…ç½®ï¼š

- GetBaseConfigè·å–redis.yamlæ ¹ç›®å½•ä¸‹çš„Redisé…ç½®ï¼Œä½œä¸ºé»˜è®¤é…ç½®
- GetConfigPath æ ¹æ®æŒ‡å®šé…ç½®è·¯å¾„è·å–Redisé…ç½®
- WithRedisConfig å¯ä»¥ç›´æ¥ä¿®æ”¹RedisConfigä¸­çš„redis.Optionsé…ç½®ä¿¡æ¯

åœ¨å®ç°è¿™ä¸‰ä¸ªå‡½æ•°ä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆçœ‹ä¸€ä¸‹æˆ‘ä»¬çš„Redisé…ç½®æ–‡ä»¶cofig/testing/redis.yamlï¼š

```yaml
timeout: 10s # è¿æ¥è¶…æ—¶
read_timeout: 2s # è¯»è¶…æ—¶
write_timeout: 2s # å†™è¶…æ—¶

write:
    host: localhost # ipåœ°å€
    port: 3306 # ç«¯å£
    db: 0 #db
    username: jianfengye # ç”¨æˆ·å
    password: "123456789" # å¯†ç 
    timeout: 10s # è¿æ¥è¶…æ—¶
    read_timeout: 2s # è¯»è¶…æ—¶
    write_timeout: 2s # å†™è¶…æ—¶
    conn_min_idle: 10 # è¿æ¥æ± æœ€å°ç©ºé—²è¿æ¥æ•°
    conn_max_open: 20 # è¿æ¥æ± æœ€å¤§è¿æ¥æ•°
    conn_max_lifetime: 1h # è¿æ¥æ•°æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
    conn_max_idletime: 1h # è¿æ¥æ•°ç©ºé—²æ—¶é•¿
```

å’Œdatabase.yamlçš„é…ç½®ä¸€æ ·ï¼Œæ ¹çº§åˆ«çš„ä½œä¸ºé»˜è®¤é…ç½®ï¼ŒäºŒçº§é…ç½®ä½œä¸ºå•ä¸ªRedisçš„é…ç½®ï¼Œå¹¶ä¸”äºŒçº§é…ç½®ä¼šè¦†ç›–é»˜è®¤é…ç½®ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå°å¿ƒæ€ï¼Œç‰¹æ„å°†è¿™äº›é…ç½®é¡¹éƒ½å’Œdatabase.yamlä¿æŒä¸€è‡´äº†ï¼Œè¿™æ ·ä½¿ç”¨è€…åœ¨é…ç½®çš„æ—¶å€™èƒ½å‡å°‘å­¦ä¹ æˆæœ¬ã€‚

è¿™ä¸‰ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°å’ŒGormæ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„åŒºåˆ«ã€‚åŸºæœ¬æ–¹æ³•å°±æ˜¯ä½¿ç”¨å®¹å™¨ä¸­çš„é…ç½®æœåŠ¡ã€è¯»å–é…ç½®ä¿¡æ¯ï¼Œç„¶åä¿®æ”¹å‚æ•°ä¸­çš„RedisConfigæŒ‡é’ˆï¼Œä½ å¯ä»¥å‚è€ƒåˆ†æ”¯ä¸­çš„ä»£ç æ–‡ä»¶[framework/provider/redis/config.go](https://github.com/gohade/coredemo/blob/geekbang/27/framework/provider/redis/config.go)ã€‚

æˆ‘ä»¬é‡ç‚¹æŠŠæ³¨æ„åŠ›æ”¾åœ¨**GetClientæ–¹æ³•çš„å®ç°**ä¸Šï¼Œå†™åœ¨framework/provider/redis/service.goä¸­ã€‚ç±»ä¼¼gormçš„GetDBæ–¹æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªå•ä¾‹æ¨¡å¼ï¼Œå°±æ˜¯ä¸€ä¸ªRedisConfigï¼Œåªäº§ç”Ÿä¸€ä¸ªredis.Clientï¼Œç”¨ä¸€ä¸ªmapåŠ ä¸Šä¸€ä¸ªlockæ¥åˆå§‹åŒ–Rediså®ä¾‹ï¼š

```go
// HadeRedis ä»£è¡¨hadeæ¡†æ¶çš„rediså®ç°
type HadeRedis struct {
    container framework.Container      // æœåŠ¡å®¹å™¨
    clients   map[string]*redis.Client // keyä¸ºuniqKey, valueä¸ºredis.Client (è¿æ¥æ± ï¼‰

    lock *sync.RWMutex
}
```

åœ¨GetClientå‡½æ•°ä¸­ï¼Œé¦–å…ˆè¿˜æ˜¯è·å–åŸºæœ¬Redisé…ç½® redisConfigï¼Œä½¿ç”¨å‚æ•°optså¯¹redisConfigè¿›è¡Œä¿®æ”¹ï¼Œæœ€ååˆ¤æ–­å½“å‰redisConfigæ˜¯å¦å·²ç»å®ä¾‹åŒ–äº†ï¼š

- å¦‚æœå·²ç»å®ä¾‹åŒ–ï¼Œè¿”å›å®ä¾‹åŒ–redis.Clientï¼›
- å¦‚æœæœªå®ä¾‹åŒ–ï¼Œå®ä¾‹åŒ–redis.Clientï¼Œè¿”å›å®ä¾‹åŒ–çš„redis.Clientã€‚

```go
// GetClient è·å–Clientå®ä¾‹
func (app *HadeRedis) GetClient(option ...contract.RedisOption) (*redis.Client, error) {
    // è¯»å–é»˜è®¤é…ç½®
    config := GetBaseConfig(app.container)

    // optionå¯¹optè¿›è¡Œä¿®æ”¹
    for _, opt := range option {
        if err := opt(app.container, config); err != nil {
            return nil, err
        }
    }

    // å¦‚æœæœ€ç»ˆçš„configæ²¡æœ‰è®¾ç½®dsn,å°±ç”Ÿæˆdsn
    key := config.UniqKey()

    // åˆ¤æ–­æ˜¯å¦å·²ç»å®ä¾‹åŒ–äº†redis.Client
    app.lock.RLock()
    if db, ok := app.clients[key]; ok {
        app.lock.RUnlock()
        return db, nil
    }
    app.lock.RUnlock()

    // æ²¡æœ‰å®ä¾‹åŒ–gorm.DBï¼Œé‚£ä¹ˆå°±è¦è¿›è¡Œå®ä¾‹åŒ–æ“ä½œ
    app.lock.Lock()
    defer app.lock.Unlock()

    // å®ä¾‹åŒ–gorm.DB
    client := redis.NewClient(config.Options)

    // æŒ‚è½½åˆ°mapä¸­ï¼Œç»“æŸé…ç½®
    app.clients[key] = client

    return client, nil
}
```

è¿™é‡Œåªè®²äº†RedisæœåŠ¡çš„æ¥å£å’ŒæœåŠ¡å®ç°çš„å…³é”®å‡½æ•°ï¼Œå…¶ä¸­providerçš„å®ç°åŸºæœ¬ä¸Šå’ŒORMçš„ä¸€è‡´ï¼Œæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ï¼Œå°±ä¸åœ¨è¿™é‡Œé‡å¤åˆ—å‡ºä»£ç äº†ã€‚

åˆ°è¿™é‡Œæˆ‘ä»¬å°±å°†Redisçš„æœåŠ¡èåˆè¿›å…¥hadeæ¡†æ¶äº†ã€‚ä½†Redisåªæ˜¯ç¼“å­˜æœåŠ¡çš„ä¸€ç§å®ç°ï¼Œæˆ‘ä»¬è¿™èŠ‚è¯¾æœ€ç»ˆç›®æ ‡æ˜¯æƒ³å®ç°ä¸€ä¸ªç¼“å­˜æœåŠ¡ã€‚

## ç¼“å­˜æœåŠ¡

ç¼“å­˜æœåŠ¡çš„ä½¿ç”¨æ–¹å¼å…¶å®éå¸¸å¤šï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®æœ‰è¶…æ—¶/æ— è¶…æ—¶çš„ç¼“å­˜ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è®¡æ•°å™¨ç¼“å­˜ï¼Œä¸€ä»½å¥½çš„ç¼“å­˜æ¥å£çš„è®¾è®¡ï¼Œèƒ½å¯¹åº”ç”¨çš„ç¼“å­˜ä½¿ç”¨å¸®åŠ©å¾ˆå¤§ã€‚

æ‰€ä»¥è¿™ä¸€éƒ¨åˆ†ï¼Œç›¸æ¯”ç¼“å­˜æœåŠ¡çš„å…·ä½“å®ç°ï¼Œ**ç¼“å­˜æœåŠ¡çš„åè®®è®¾è®¡ç›´æ¥å½±å“äº†è¿™ä¸ªæœåŠ¡çš„å¯ç”¨æ€§**ï¼Œæˆ‘ä»¬è¦é‡ç‚¹ç†è§£å¯¹ç¼“å­˜åè®®çš„è®¾è®¡ã€‚

### åè®®

å®ç°ä¸€ä¸ªæœåŠ¡çš„ä¸‰æ­¥éª¤ï¼ŒæœåŠ¡åè®®ã€æœåŠ¡æä¾›è€…ã€æœåŠ¡å®ä¾‹ã€‚å°±å…ˆä»åè®®å¼€å§‹ï¼Œæˆ‘ä»¬å¸Œæœ›è¿™ä¸ªç¼“å­˜æœåŠ¡æä¾›å“ªäº›èƒ½åŠ›å‘¢ï¼Ÿ

é¦–å…ˆï¼Œç¼“å­˜åè®®ä¸€å®šæ˜¯æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªè®¾ç½®ç¼“å­˜ã€ä¸€ä¸ªè·å–ç¼“å­˜ã€‚è®¾å®šä¸ºGetæ–¹æ³•ä¸ºè·å–ç¼“å­˜ï¼ŒSetæ–¹æ³•ä¸ºè®¾ç½®ç¼“å­˜ã€‚

```go
// Get è·å–æŸä¸ªkeyå¯¹åº”çš„å€¼
Get(ctx context.Context, key string) (string, error)
// Set è®¾ç½®æŸä¸ªkeyå’Œå€¼åˆ°ç¼“å­˜ï¼Œå¸¦è¶…æ—¶æ—¶é—´
Set(ctx context.Context, key string, val string, timeout time.Duration) error
```

åŒæ—¶ï¼Œæ³¨æ„è®¾ç½®ç¼“å­˜çš„æ—¶å€™ï¼ŒåˆåŒºåˆ†å‡ºä¸¤ç§éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®å¸¦è¶…æ—¶æ—¶é—´çš„ç¼“å­˜ï¼Œä¹Ÿéœ€è¦è®¾ç½®ä¸å¸¦è¶…æ—¶æ—¶é—´çš„ã€æ°¸ä¹…çš„ç¼“å­˜ã€‚æ‰€ä»¥ï¼ŒSetæ–¹æ³•è¡ç”Ÿå‡ºSetå’ŒSetForeverä¸¤ç§ã€‚

```go
// SetForever è®¾ç½®æŸä¸ªkeyå’Œå€¼åˆ°ç¼“å­˜ï¼Œä¸å¸¦è¶…æ—¶æ—¶é—´
SetForever(ctx context.Context, key string, val string) error
```

åœ¨è®¾ç½®äº†æŸä¸ªkeyä¹‹åï¼Œä¼šä¸ä¼šéœ€è¦ä¿®æ”¹è¿™ä¸ªç¼“å­˜keyçš„ç¼“å­˜æ—¶é•¿å‘¢ï¼Ÿå®Œå…¨æ˜¯æœ‰å¯èƒ½çš„ï¼Œæ¯”å¦‚å°†æŸä¸ªkeyçš„ç¼“å­˜æ—¶é•¿åŠ å¤§ï¼Œæˆ–è€…æƒ³è¦è·å–æŸä¸ªkeyçš„ç¼“å­˜æ—¶é•¿ï¼Œæ‰€ä»¥æˆ‘ä»¬å†æŠŠæ³¨æ„åŠ›æ”¾åœ¨ç¼“å­˜æ—¶é•¿çš„æ“ä½œä¸Šï¼Œæä¾›å¯¹ç¼“å­˜æ—¶é•¿çš„æ“ä½œå‡½æ•°SetTTLå’ŒGetTTLï¼š

```go
// SetTTL è®¾ç½®æŸä¸ªkeyçš„è¶…æ—¶æ—¶é—´
SetTTL(ctx context.Context, key string, timeout time.Duration) error
// GetTTL è·å–æŸä¸ªkeyçš„è¶…æ—¶æ—¶é—´
GetTTL(ctx context.Context, key string) (time.Duration, error)
```

å†æ¥ï¼ŒGetå’ŒSetç›®å‰å¯¹åº”çš„valueå€¼ä¸ºstringï¼Œä½†æ˜¯æˆ‘ä»¬å¸Œæœ›valueå€¼èƒ½ä¸ä»…ä»…æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒè¿˜å¯ä»¥ç›´æ¥æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™æ ·ç¼“å­˜æœåŠ¡å°±èƒ½å­˜å‚¨å’Œè·å–ä¸€ä¸ªå¯¹è±¡å‡ºæ¥ï¼Œèƒ½å¤§å¤§æ–¹ä¾¿ç¼“å­˜éœ€æ±‚ã€‚

æ‰€ä»¥æˆ‘ä»¬å®šä¹‰ä¸¤ä¸ªGetObjå’ŒSetObjæ–¹æ³•ï¼Œæ¥å®ç°å¯¹è±¡çš„ç¼“å­˜å­˜å‚¨å’Œè·å–ï¼Œä½†æ˜¯è¿™ä¸ªå¯¹è±¡åœ¨å®é™…å­˜å‚¨çš„æ—¶å€™ï¼ŒåˆåŠ¿å¿…è¦è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯¹å­˜å‚¨å’Œè·å–çš„å¯¹è±¡å†å¢åŠ ä¸€ä¸ªè¦æ±‚ï¼Œè®©å®ƒå®ç°å®˜æ–¹åº“çš„BinaryMarshalerå’ŒBinaryUnMarshaleræ¥å£ï¼š

```go
// GetObj è·å–æŸä¸ªkeyå¯¹åº”çš„å¯¹è±¡, å¯¹è±¡å¿…é¡»å®ç° https://pkg.go.dev/encoding#BinaryUnMarshaler
GetObj(ctx context.Context, key string, model interface{}) error
// SetObj è®¾ç½®æŸä¸ªkeyå’Œå¯¹è±¡åˆ°ç¼“å­˜, å¯¹è±¡å¿…é¡»å®ç° https://pkg.go.dev/encoding#BinaryMarshaler
SetObj(ctx context.Context, key string, val interface{}, timeout time.Duration) error
// SetForeverObj è®¾ç½®æŸä¸ªkeyå’Œå¯¹è±¡åˆ°ç¼“å­˜ï¼Œä¸å¸¦è¶…æ—¶æ—¶é—´ï¼Œå¯¹è±¡å¿…é¡»å®ç° https://pkg.go.dev/encoding#BinaryMarshaler
SetForeverObj(ctx context.Context, key string, val interface{}) error
```

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ä¸€ä¸ªkeyè¿›è¡Œç¼“å­˜è·å–å’Œè®¾ç½®äº†ï¼Œä½†æ˜¯æœ‰æ—¶å€™è¦åŒæ—¶å¯¹å¤šä¸ªkeyåšç¼“å­˜çš„è·å–å’Œè®¾ç½®ï¼Œæ¥è®¾ç½®å¯¹å¤šä¸ªkeyè¿›è¡Œæ“ä½œçš„æ–¹æ³•GetManyå’ŒSetManyï¼š

```go
// GetMany è·å–æŸäº›keyå¯¹åº”çš„å€¼
GetMany(ctx context.Context, keys []string) (map[string]string, error)
// SetMany è®¾ç½®å¤šä¸ªkeyå’Œå€¼åˆ°ç¼“å­˜
SetMany(ctx context.Context, data map[string]string, timeout time.Duration) error
```

åœ¨å®é™…ä¸šåŠ¡ä¸­ï¼Œæˆ‘ä»¬è¿˜ä¼šæœ‰ä¸€äº›è®¡æ•°å™¨çš„éœ€æ±‚ï¼Œéœ€è¦å°†è®¡æ•°å™¨å­˜å‚¨åˆ°ç¼“å­˜ï¼ŒåŒæ—¶ä¹Ÿè¦èƒ½å¯¹è¿™ä¸ªè®¡æ•°å™¨ç¼“å­˜è¿›è¡Œå¢åŠ å’Œå‡å°‘çš„æ“ä½œã€‚å¯ä»¥ä¸ºè®¡æ•°å™¨ç¼“å­˜è®¾è®¡Calcã€Incrementã€Decrementçš„æ¥å£ï¼š

```go
// Calc å¾€keyå¯¹åº”çš„å€¼ä¸­å¢åŠ stepè®¡æ•°
Calc(ctx context.Context, key string, step int64) (int64, error)
// Increment å¾€keyå¯¹åº”çš„å€¼ä¸­å¢åŠ 1
Increment(ctx context.Context, key string) (int64, error)
// Decrement å¾€keyå¯¹åº”çš„å€¼ä¸­å‡å»1
Decrement(ctx context.Context, key string) (int64, error)
```

ç¼“å­˜çš„ä½¿ç”¨æœ‰ä¸€ç§Cache-Asideæ¨¡å¼ï¼Œå¯ä»¥æå‡â€œè·å–æ•°æ®â€çš„æ€§èƒ½ã€‚å¯èƒ½ä½ æ²¡æœ‰å¬è¿‡è¿™ä¸ªåå­—ï¼Œä½†å…¶å®æˆ‘ä»¬éƒ½ç”¨è¿‡ï¼Œè¿™ä¸ªæ¨¡å¼æè¿°çš„å°±æ˜¯åœ¨å®é™…æ“ä½œä¹‹å‰ï¼Œå…ˆå»ç¼“å­˜ä¸­æŸ¥çœ‹æœ‰æ²¡æœ‰å¯¹åº”çš„æ•°æ®ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œä¸è¿›è¡Œæ“ä½œï¼Œå¦‚æœæ²¡æœ‰çš„è¯æ‰è¿›è¡Œå®é™…æ“ä½œç”Ÿæˆæ•°æ®ï¼Œå¹¶ä¸”æŠŠæ•°æ®å­˜å‚¨åœ¨ç¼“å­˜ä¸­ã€‚

æˆ‘ä»¬å¸Œæœ›ç¼“å­˜æœåŠ¡ä¹Ÿèƒ½æ”¯æŒè¿™ç§Cache-Asideæ¨¡å¼ã€‚å¦‚ä½•æ”¯æŒå‘¢ï¼Ÿ

é¦–å…ˆï¼Œè¦æœ‰ä¸€ä¸ªç”Ÿæˆæ•°æ®çš„é€šç”¨æ–¹æ³•ç»“æ„ï¼Œæˆ‘ä»¬å®šä¹‰ä¸ºRememberFuncï¼Œè®©è¿™ä¸ªå‡½æ•°å°†æœåŠ¡å®¹å™¨ä¼ é€’è¿›å»ï¼Œè¿™æ ·åœ¨å…·ä½“çš„å®ç°ä¸­ï¼Œä½¿ç”¨è€…å°±å¯ä»¥ä»æœåŠ¡å®¹å™¨ä¸­è·å–å„ç§å„æ ·çš„å…·ä½“æ³¨å†ŒæœåŠ¡äº†ï¼Œèƒ½å¤§å¤§å¢å¼ºè¿™ä¸ªRemeberFuncçš„å®ç°èƒ½åŠ›ï¼š

```go
// RememberFunc ç¼“å­˜çš„Rememberæ–¹æ³•ä½¿ç”¨ï¼ŒCache-Asideæ¨¡å¼å¯¹åº”çš„å¯¹è±¡ç”Ÿæˆæ–¹æ³•
type RememberFunc func(ctx context.Context, container framework.Container) (interface{}, error)
```

ç„¶åï¼Œæˆ‘ä»¬ä¸ºç¼“å­˜æœåŠ¡å®šä¹‰ä¸€ä¸ªRememberæ–¹æ³•ï¼Œæ¥å®ç°è¿™ä¸ªCache-Asideæ¨¡å¼ã€‚

```go
// Remember å®ç°ç¼“å­˜çš„Cache-Asideæ¨¡å¼, å…ˆå»ç¼“å­˜ä¸­æ ¹æ®keyè·å–å¯¹è±¡ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œè¿”å›ï¼Œå¦‚æœæ²¡æœ‰ï¼Œè°ƒç”¨RememberFunc ç”Ÿæˆ
Remember(ctx context.Context, key string, timeout time.Duration, rememberFunc RememberFunc, model interface{}) error
```

å®ƒçš„å‚æ•°æ¥ä»”ç»†çœ‹ä¸‹ã€‚é™¤äº†contextä¹‹å¤–ï¼Œæœ‰ä¸€ä¸ªkeyï¼Œä»£è¡¨è¿™ä¸ªç¼“å­˜ä½¿ç”¨çš„keyï¼Œå…¶æ¬¡æ˜¯timeout ä»£è¡¨ç¼“å­˜æ—¶é•¿ï¼Œæ¥ç€æ˜¯å‰é¢å®šä¹‰çš„ RememberFuncäº†ï¼Œä»£è¡¨å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰è¿™ä¸ªkeyï¼Œå°±è°ƒç”¨RememberFuncå‡½æ•°æ¥ç”Ÿæˆæ•°æ®å¯¹è±¡ã€‚

è¿™ä¸ªæ•°æ®å¯¹è±¡ä»å“ªé‡Œè¾“å‡ºå‘¢ï¼Ÿå°±æ˜¯è¿™é‡Œçš„æœ€åä¸€ä¸ªå‚æ•°modeläº†ï¼Œå½“ç„¶è¿™ä¸ªObjå¿…é¡»å®ç°BinaryMarshalerå’ŒBinaryUnmarshaleræ¥å£ã€‚è¿™æ ·å®šä¹‰ä¹‹åï¼ŒRememberçš„å…·ä½“å®ç°å°±ç®€å•äº†ã€‚

çœ‹è¿™ä¸ªæˆ‘åœ¨å•å…ƒæµ‹è¯•ä»£ç provider/cache/services/redis\_test.goä¸­å†™çš„æµ‹è¯•ï¼š

```go
type Bar struct {
   Name string
}
func (b *Bar) MarshalBinary() ([]byte, error) {
   return json.Marshal(b)
}
func (b *Bar) UnmarshalBinary(bt []byte) error {
   return json.Unmarshal(bt, b)
}

Convey("remember op", func() {
   objNew := Bar{}
   objNewFunc := func(ctx context.Context, container framework.Container) (interface{}, error) {
      obj := &Bar{
         Name: "bar",
      }
      return obj, nil
   }
   err = mc.Remember(ctx, "foo_remember", 1*time.Minute, objNewFunc, &objNew)
   So(err, ShouldBeNil)
   So(objNew.Name, ShouldEqual, "bar")
})
```

æˆ‘ä»¬å®šä¹‰äº†Barç»“æ„ï¼Œå®ƒå®ç°äº†BinaryMarshalerå’ŒBinaryUnmarshaleræ¥å£ï¼Œå¹¶ä¸”å®šä¹‰äº†ä¸€ä¸ªobjNewFuncæ–¹æ³•å®ç°äº†å‰é¢æˆ‘ä»¬å®šä¹‰çš„RememberFuncã€‚

ä¹‹åå¯ä»¥ä½¿ç”¨Rememberæ–¹æ³•æ¥ä¸ºè¿™ä¸ªæ–¹æ³•è®¾ç½®ä¸€ä¸ªCache-Asideç¼“å­˜ï¼Œå®ƒçš„keyä¸ºfoo\_rememberï¼Œç¼“å­˜æ—¶é•¿ä¸º1åˆ†é’Ÿã€‚

æœ€åå›çœ‹ä¸€ä¸‹æˆ‘ä»¬å¯¹ç¼“å­˜çš„åè®®å®šä¹‰ï¼Œå„ç§ç¼“å­˜çš„è®¾ç½®å’Œè·å–æ–¹æ³•éƒ½æœ‰äº†ï¼Œè¿˜å·®åˆ é™¤ç¼“å­˜çš„æ–¹æ³•å¯¹å§ã€‚æ‰€ä»¥æ¥å®šä¹‰åˆ é™¤å•ä¸ªkeyçš„ç¼“å­˜å’Œåˆ é™¤å¤šä¸ªkeyçš„ç¼“å­˜ï¼š

```go
// Del åˆ é™¤æŸä¸ªkey
Del(ctx context.Context, key string) error
// DelMany åˆ é™¤æŸäº›key
DelMany(ctx context.Context, keys []string) error
```

åˆ°è¿™é‡Œç¼“å­˜åè®®å°±å®šä¹‰å®Œæˆäº†ï¼Œä¸€å…±16ä¸ªæ–¹æ³•ï¼Œè¦å¥½å¥½ç†è§£ä¸‹è¿™äº›æ–¹æ³•çš„å®šä¹‰ï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼Œç†è§£å¦‚ä½•å®šä¹‰åè®®æ¯”å®ç°æ›´ä¸ºé‡è¦ã€‚  
![](https://static001.geekbang.org/resource/image/da/e5/da9b83e6856e5fd523bc270981846fe5.jpg?wh=2364x2273)

## å®ç°

ä¸‹é¢æ¥å®ç°è¿™ä¸ªç¼“å­˜æœåŠ¡ã€‚å‰é¢ä¸€å†å¼ºè°ƒäº†ï¼ŒRedisåªæ˜¯ç¼“å­˜çš„ä¸€ç§å®ç°ï¼ŒRedisä¹‹å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸åŒçš„å­˜å‚¨æ¥å®ç°ç¼“å­˜ï¼Œç”šè‡³ï¼Œå¯ä»¥ä½¿ç”¨å†…å­˜æ¥å®ç°ã€‚ç›®å‰hadeæ¡†æ¶æ”¯æŒå†…å­˜å’ŒRediså®ç°ç¼“å­˜ï¼Œè¿™é‡Œæˆ‘ä»¬å°±å…ˆçœ‹çœ‹å¦‚ä½•ç”¨Redisæ¥å®ç°ç¼“å­˜ã€‚

ç”±äºç¼“å­˜æœ‰ä¸åŒå®ç°ï¼Œæ‰€ä»¥å’Œæ—¥å¿—æœåŠ¡ä¸€æ ·ï¼Œ**è¦ä½¿ç”¨é…ç½®æ–‡ä»¶æ¥cache.yamlä¸­çš„driverå­—æ®µï¼Œæ¥åŒºåˆ«ä½¿ç”¨å“ªä¸ªç¼“å­˜**ã€‚å¦‚æœdriverä¸ºredisï¼Œè¡¨ç¤ºä½¿ç”¨Redisæ¥å®ç°ç¼“å­˜ï¼Œå¦‚æœä¸ºmemoryï¼Œè¡¨ç¤ºç”¨å†…å­˜æ¥å®ç°ç¼“å­˜ã€‚å½“ç„¶å¦‚æœä½¿ç”¨Redisçš„è¯ï¼Œå°±éœ€è¦åŒæ—¶å¸¦ä¸ŠRedisè¿æ¥çš„å„ç§å‚æ•°ï¼Œå‚æ•°å…³é”®å­—éƒ½ç±»ä¼¼å‰é¢è¯´çš„RedisæœåŠ¡çš„é…ç½®ã€‚

ä¸€ä¸ªå…¸å‹çš„cache.yamlçš„é…ç½®å¦‚ä¸‹ï¼š

```go
driver: redis # è¿æ¥é©±åŠ¨
host: 127.0.0.1 # ipåœ°å€
port: 6379 # ç«¯å£
db: 0 #db
timeout: 10s # è¿æ¥è¶…æ—¶
read_timeout: 2s # è¯»è¶…æ—¶
write_timeout: 2s # å†™è¶…æ—¶

#driver: memory # è¿æ¥é©±åŠ¨
```

é‚£å¯¹åº”åˆ°å…·ä½“å®ç°ä¸Šï¼ŒåŒºåˆ†ä½¿ç”¨å“ªä¸ªç¼“å­˜é©±åŠ¨ï¼Œæˆ‘ä»¬ä¼šåœ¨æœåŠ¡æä¾›è€…providerä¸­æ¥è¿›è¡Œã€‚åœ¨providerä¸­ï¼Œæ³¨æ„ä¸‹Registeræ–¹æ³•ï¼Œæ³¨å†Œå…·ä½“çš„æœåŠ¡å®ä¾‹æ–¹æ³•æ—¶ï¼Œè¦å…ˆè¯»å–é…ç½®ä¸­çš„cache.driverè·¯å¾„ï¼š

```go
// Register æ³¨å†Œä¸€ä¸ªæœåŠ¡å®ä¾‹
func (l *HadeCacheProvider) Register(c framework.Container) framework.NewInstance {
   if l.Driver == "" {
      tcs, err := c.Make(contract.ConfigKey)
      if err != nil {
         // é»˜è®¤ä½¿ç”¨console
         return services.NewMemoryCache
      }

      cs := tcs.(contract.Config)
      l.Driver = strings.ToLower(cs.GetString("cache.driver"))
   }

   // æ ¹æ®driverçš„é…ç½®é¡¹ç¡®å®š
   switch l.Driver {
   case "redis":
      return services.NewRedisCache
   case "memory":
      return services.NewMemoryCache
   default:
      return services.NewMemoryCache
   }
}
```

å¦‚æœæ˜¯Redisé©±åŠ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨service.NewRedisCacheæ¥åˆå§‹åŒ–ä¸€ä¸ªRedisè¿æ¥ï¼Œå®šä¹‰RedisCacheç»“æ„æ¥å­˜å‚¨redis.Clientã€‚

**åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå…ˆç¡®å®šä¸‹å®¹å™¨ä¸­æ˜¯å¦å·²ç»ç»‘å®šäº†RedisæœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œåšä¸€ä¸‹ç»‘å®šæ“ä½œ**ã€‚è¿™ä¸ªè¡Œä¸ºèƒ½è®©æˆ‘ä»¬çš„ç¼“å­˜å®¹å™¨æ›´ä¸ºå®‰å…¨ã€‚

æ¥ç€ä½¿ç”¨cache.yamlä¸­çš„é…ç½®ï¼Œæ¥åˆå§‹åŒ–ä¸€ä¸ªredis.Clientï¼Œè¿™é‡Œä½¿ç”¨çš„redisService.GetClientå’Œredis.WithConfigPathï¼Œéƒ½æ˜¯ä¸Šé¢è®¾è®¡RedisæœåŠ¡çš„æ—¶å€™åˆšè®¾è®¡å®ç°çš„æ–¹æ³•ã€‚æœ€åå°†redis.Client å°è£…åˆ°RedisCacheä¸­ï¼Œè¿”å›ï¼š

```go
import (
   "context"
   "errors"
   redisv8 "github.com/go-redis/redis/v8"
   "github.com/gohade/hade/framework"
   "github.com/gohade/hade/framework/contract"
   "github.com/gohade/hade/framework/provider/redis"
   "sync"
   "time"
)

// RedisCache ä»£è¡¨Redisç¼“å­˜
type RedisCache struct {
   container framework.Container
   client    *redisv8.Client
   lock      sync.RWMutex
}

// NewRedisCache åˆå§‹åŒ–redisæœåŠ¡
func NewRedisCache(params ...interface{}) (interface{}, error) {
   container := params[0].(framework.Container)
   if !container.IsBind(contract.RedisKey) {
      err := container.Bind(&redis.RedisProvider{})
      if err != nil {
         return nil, err
      }
   }

   // è·å–redisæœåŠ¡é…ç½®ï¼Œå¹¶ä¸”å®ä¾‹åŒ–redis.Client
   redisService := container.MustMake(contract.RedisKey).(contract.RedisService)
   client, err := redisService.GetClient(redis.WithConfigPath("cache"))
   if err != nil {
      return nil, err
   }

   // è¿”å›RedisCacheå®ä¾‹
   obj := &RedisCache{
      container: container,
      client:    client,
      lock:      sync.RWMutex{},
   }
   return obj, nil
}
```

å¥½ï¼Œæœ‰Redisç¼“å­˜çš„å®ä¾‹äº†ï¼Œä¸‹é¢æ¥çœ‹16ä¸ªæ–¹æ³•çš„å®ç°ã€‚

Setç³»åˆ—çš„æ–¹æ³•ä¸€å…±æœ‰Set/SetObj/SetMany/SetForever/SetForeverObj/SetTTL 6ä¸ªï¼Œå…¶ä»–5ä¸ªç›¸å¯¹ç®€å•ä¸€äº›ï¼Œåœ¨ç”Ÿæˆçš„redis.Clientç»“æ„ä¸­éƒ½æœ‰å¯¹åº”å®ç°ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨redis.Clientè°ƒç”¨å³å¯ï¼Œå°±ä¸èµ˜è¿°äº†ã€‚å…¶ä¸­SetManyæ–¹æ³•ç›¸å¯¹å¤æ‚äº›ï¼Œæˆ‘ä»¬ç€é‡è¯´æ˜ä¸‹ã€‚

åœ¨Redisä¸­ï¼ŒSetManyè¿™ç§ä¸ºå¤šä¸ªkeyè®¾ç½®ç¼“å­˜çš„æ–¹æ³•ï¼Œä¸€èˆ¬å¯ä»¥éå†keyï¼Œç„¶åä¸€ä¸ªä¸ªè°ƒç”¨Setæ–¹æ³•ï¼Œä½†æ˜¯è¿™æ ·æ•ˆç‡å°±ä½äº†ã€‚æ›´å¥½çš„å®ç°æ–¹å¼æ˜¯ä½¿ç”¨pipelineã€‚

ä»€ä¹ˆæ˜¯Redisçš„pipelineå‘¢ï¼ŸRedisçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„äº¤äº’ï¼Œé‡‡ç”¨çš„æ˜¯å®¢æˆ·ç«¯-æœåŠ¡ç«¯æ¨¡å¼ï¼Œå°±æ˜¯æ¯ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚å‘é€åˆ°RedisæœåŠ¡ç«¯ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªå®Œæ•´çš„å“åº”ã€‚æ‰€ä»¥ï¼Œå‘æœåŠ¡ç«¯å‘é€nä¸ªè¯·æ±‚ï¼Œå°±å¯¹åº”æœ‰næ¬¡å“åº”ã€‚é‚£ä¹ˆ**å¯¹äºè¿™ç§nä¸ªè¯·æ±‚ä¸”nä¸ªè¯·æ±‚æ²¡æœ‰ä¸Šä¸‹æ–‡é€»è¾‘å…³ç³»ï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½æ‰¹é‡å‘é€ï¼Œä½†æ˜¯åªå‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œç„¶ååªè·å–ä¸€æ¬¡å“åº”å‘¢**ï¼Ÿ

Redisçš„pipelineå°±æ˜¯è¿™ä¸ªåŸç†ï¼Œå®ƒå°†å¤šä¸ªè¯·æ±‚åˆæˆä¸ºä¸€ä¸ªè¯·æ±‚ï¼Œæ‰¹é‡å‘é€ç»™RedisæœåŠ¡ç«¯ï¼Œå¹¶ä¸”åªä»æœåŠ¡ç«¯è·å–ä¸€æ¬¡æ•°æ®ï¼Œæ‹¿åˆ°è¿™äº›è¯·æ±‚çš„æ‰€æœ‰ç»“æœã€‚

æˆ‘ä»¬çš„SetManyå°±å¾ˆç¬¦åˆè¿™ä¸ªåœºæ™¯ã€‚å…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š

```go
// SetMany è®¾ç½®å¤šä¸ªkeyå’Œå€¼åˆ°ç¼“å­˜
func (r *RedisCache) SetMany(ctx context.Context, data map[string]string, timeout time.Duration) error {
   pipline := r.client.Pipeline()
   cmds := make([]*redisv8.StatusCmd, 0, len(data))
   for k, v := range data {
      cmds = append(cmds, pipline.Set(ctx, k, v, timeout))
   }
   _, err := pipline.Exec(ctx)
   return err
}
```

å…ˆç”¨redis.Client.Pipeline() æ¥åˆ›å»ºä¸€ä¸ªpipelineç®¡é“ï¼Œç„¶åç”¨ä¸€ä¸ªredis.StatusCmdæ•°ç»„æ¥å­˜å‚¨è¦å‘é€çš„æ‰€æœ‰å‘½ä»¤ï¼Œæœ€åè°ƒç”¨ä¸€æ¬¡pipeline.Execæ¥ä¸€æ¬¡å‘é€å‘½ä»¤ã€‚

Setæ–¹æ³•å°±è®²åˆ°è¿™é‡Œï¼ŒGetç³»åˆ—çš„æ–¹æ³•ä¸€å…±æœ‰4ä¸ªï¼ŒGet/GetObj/GetMany/GetTTLã€‚

åœ¨å®ç°Getç³»åˆ—æ–¹æ³•çš„æ—¶å€™æœ‰åœ°æ–¹éœ€è¦æ³¨æ„ä¸‹ï¼Œå› ä¸º**Getæ˜¯æœ‰å¯èƒ½Getä¸€ä¸ªä¸å­˜åœ¨çš„keyçš„**ï¼Œå¯¹äºè¿™ç§ä¸å­˜åœ¨çš„keyæ˜¯å¦è¿”å›errorï¼Œæ˜¯ä¸€ä¸ªå¯ä»¥ç¨å¾®æ€è€ƒçš„è¯é¢˜ã€‚

æ¯”å¦‚Getè¿™ä¸ªæ–¹æ³•ï¼Œè¿”å›çš„æ˜¯stringå’Œerrorï¼Œå¦‚æœå¯¹äºä¸€ä¸ªä¸å­˜åœ¨çš„keyï¼Œè¿”å›äº†ç©ºå­—ç¬¦ä¸²+ç©ºerrorçš„ç»„åˆï¼Œè€Œå¯¹äºä¸€ä¸ªè®¾ç½®äº†ç©ºå­—ç¬¦ä¸²çš„keyï¼Œä¹Ÿè¿”å›ç©ºå­—ç¬¦ä¸²+ç©ºerrorçš„ç»„åˆï¼Œè¿™é‡Œå…¶å®æ˜¯ä¸¢å¤±äº†â€œæ˜¯å¦å­˜åœ¨keyâ€çš„ä¿¡æ¯çš„ã€‚

æ‰€ä»¥ï¼Œå¯¹äºè¿™äº›ä¸å­˜åœ¨çš„keyï¼Œæˆ‘ä»¬è®¾è®¡è¿”å›ä¸€ä¸ª ErrKeyNotFound çš„è‡ªå®šä¹‰errorã€‚åƒGetå‡½æ•°å°±å®ç°ä¸ºå¦‚ä¸‹ï¼š

```go
// Get è·å–æŸä¸ªkeyå¯¹åº”çš„å€¼
func (r *RedisCache) Get(ctx context.Context, key string) (string, error) {
   val, err := r.client.Get(ctx, key).Result()
   // è¿™é‡Œåˆ¤æ–­äº†keyæ˜¯å¦ä¸ºç©º
   if errors.Is(err, redisv8.Nil) {
      return val, ErrKeyNotFound
   }
   return val, err
}
```

å…¶ä»–Getç›¸å…³çš„å®ç°æ²¡æœ‰ä»€ä¹ˆéš¾ç‚¹ã€‚

é™¤äº†Getç³»åˆ—å’ŒSetç³»åˆ—ï¼Œå…¶ä»–çš„æ–¹æ³•æœ‰Calcã€Incrementã€Decrementã€Delã€DelMany éƒ½æ²¡æœ‰ä»€ä¹ˆå¤ªå¤æ‚çš„é€»è¾‘ï¼Œéƒ½æ˜¯redis.Clientçš„å…·ä½“å°è£…ã€‚

æœ€åçœ‹ä¸‹Rememberè¿™ä¸ªæ–¹æ³•ï¼š

```go
// Remember å®ç°ç¼“å­˜çš„Cache-Asideæ¨¡å¼, å…ˆå»ç¼“å­˜ä¸­æ ¹æ®keyè·å–å¯¹è±¡ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œè¿”å›ï¼Œå¦‚æœæ²¡æœ‰ï¼Œè°ƒç”¨RememberFunc ç”Ÿæˆ
func (r *RedisCache) Remember(ctx context.Context, key string, timeout time.Duration, rememberFunc contract.RememberFunc, obj interface{}) error {
   err := r.GetObj(ctx, key, obj)
   // å¦‚æœè¿”å›ä¸ºnilï¼Œè¯´æ˜æœ‰è¿™ä¸ªkeyï¼Œä¸”æœ‰æ•°æ®ï¼Œobjå·²ç»æ³¨å…¥äº†ï¼Œè¿”å›nil
   if err == nil {
      return nil
   }

   // æœ‰errï¼Œä½†æ˜¯å¹¶ä¸æ˜¯keyä¸å­˜åœ¨ï¼Œè¯´æ˜æ˜¯æœ‰å…·ä½“çš„errorçš„ï¼Œä¸èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œäº†ï¼Œè¿”å›err
   if !errors.Is(err, ErrKeyNotFound) {
      return err
   }

   // ä»¥ä¸‹æ˜¯keyä¸å­˜åœ¨çš„æƒ…å†µ, è°ƒç”¨rememberFunc
   objNew, err := rememberFunc(ctx, r.container)
   if err != nil {
      return err
   }

   // è®¾ç½®key
   if err := r.SetObj(ctx, key, objNew, timeout); err != nil {
      return err
   }
   // ç”¨GetObjå°†æ•°æ®æ³¨å…¥åˆ°objä¸­
   if err := r.GetObj(ctx, key, obj); err != nil {
      return err
   }
   return nil
}
```

å‰é¢è¯´è¿‡Rememberæ–¹æ³•æ˜¯Cache-Asideæ¨¡å¼çš„å®ç°ï¼Œå®ƒçš„é€»è¾‘æ˜¯å…ˆåˆ¤æ–­ç¼“å­˜ä¸­æ˜¯å¦æœ‰è¿™ä¸ªkeyï¼Œå¦‚æœæœ‰çš„è¯ï¼Œç›´æ¥è¿”å›å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œå°±è°ƒç”¨RememberFuncæ–¹æ³•æ¥å®ä¾‹åŒ–è¿™ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”è¿”å›è¿™ä¸ªå®ä¾‹åŒ–å¯¹è±¡ã€‚

å¥½äº†ï¼Œè¿™é‡Œçš„framework/provider/cache/redis.goæˆ‘ä»¬å®ç°å·®ä¸å¤šäº†ã€‚

## éªŒè¯

æ¥åšéªŒè¯ï¼Œæˆ‘ä»¬ä¸ºç¼“å­˜æœåŠ¡å†™ä¸€ä¸ªç®€å•çš„è·¯ç”±ï¼Œåœ¨è¿™ä¸ªè·¯ç”±ä¸­ï¼š

- è·å–ç¼“å­˜æœåŠ¡
- è®¾ç½®fooä¸ºkeyçš„ç¼“å­˜ï¼Œå€¼ä¸ºbar
- è·å–fooä¸ºkeyçš„ç¼“å­˜ï¼ŒæŠŠå€¼æ‰“å°åˆ°æ§åˆ¶å°
- åˆ é™¤fooä¸ºkeyçš„ç¼“å­˜

```go
// DemoCache cacheçš„ç®€å•ä¾‹å­
func (api *DemoApi) DemoCache(c *gin.Context) {
   logger := c.MustMakeLog()
   logger.Info(c, "request start", nil)
   // åˆå§‹åŒ–cacheæœåŠ¡
   cacheService := c.MustMake(contract.CacheKey).(contract.CacheService)
   // è®¾ç½®keyä¸ºfoo
   err := cacheService.Set(c, "foo", "bar", 1*time.Hour)
   if err != nil {
      c.AbortWithError(500, err)
      return
   }
   // è·å–keyä¸ºfoo
   val, err := cacheService.Get(c, "foo")
   if err != nil {
      c.AbortWithError(500, err)
      return
   }
   logger.Info(c, "cache get", map[string]interface{}{
      "val": val,
   })
   // åˆ é™¤keyä¸ºfoo
   if err := cacheService.Del(c, "foo"); err != nil {
      c.AbortWithError(500, err)
      return
   }
   c.JSON(200, "ok")
}
```

å¢åŠ å¯¹åº”çš„è·¯ç”±ï¼š

```go
r.GET("/demo/cache/redis", api.DemoRedis)
```

åœ¨æµè§ˆå™¨ä¸­è¯·æ±‚åœ°å€ï¼š [http://localhost:8888/demo/cache/redis](http://localhost:8888/demo/cache/redis)ï¼š  
![](https://static001.geekbang.org/resource/image/2a/50/2acd5f030ab6b4d5ce8e05ec0c961850.png?wh=583x174)

æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºçš„æ—¥å¿—ï¼š  
![](https://static001.geekbang.org/resource/image/6c/14/6cf8ba131ba431303f5f77560015f814.png?wh=617x130)

å¯ä»¥æ˜æ˜¾çœ‹åˆ°cacheService.Getçš„æ•°æ®ä¸ºbarï¼Œæ‰“å°äº†å‡ºæ¥ã€‚éªŒè¯æ­£ç¡®ï¼

æœ¬èŠ‚è¯¾æˆ‘ä»¬ä¸»è¦ä¿®æ”¹äº†frameworkç›®å½•ä¸‹Rediså’Œcacheç›¸å…³çš„ä»£ç ã€‚ç›®å½•æˆªå›¾ä¹Ÿæ”¾åœ¨è¿™é‡Œä¾›ä½ å¯¹æ¯”æŸ¥çœ‹ï¼Œæ‰€æœ‰ä»£ç éƒ½å·²ç»ä¸Šä¼ åˆ°[geekbang/27](https://github.com/gohade/coredemo/tree/geekbang/27)åˆ†æ”¯äº†ã€‚  
![](https://static001.geekbang.org/resource/image/04/03/04d8a0896596b62ab57848a882d82903.png?wh=355x1116)

## å°ç»“

é™¤DBä¹‹å¤–ï¼Œç¼“å­˜æ˜¯æˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„ä¸€ä¸ªå­˜å‚¨äº†ï¼Œä»Šå¤©æˆ‘ä»¬å…ˆæ˜¯å®ç°äº†Redisçš„æœåŠ¡ï¼Œå†ç”¨RedisæœåŠ¡å®ç°äº†ä¸€ä¸ªç¼“å­˜æœåŠ¡ã€‚

ç¬¬ä¸€éƒ¨åˆ†çš„RedisæœåŠ¡ï¼ŒåŒä¸Šä¸€èŠ‚è¯¾ORMçš„é€»è¾‘ä¸€æ ·ï¼Œæˆ‘ä»¬åªæ˜¯å°†go-redisåº“è¿›è¡Œäº†å°è£…ï¼Œå…·ä½“æ€ä¹ˆä½¿ç”¨ï¼Œè¿˜æ˜¯ä¾èµ–ä½ åœ¨å®é™…å·¥ä½œä¸­å¤šä½¿ç”¨ã€å¤šç¢ç£¨ï¼Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šgo-redisåº“çš„ç›¸å…³èµ„æ–™ã€‚  
![](https://static001.geekbang.org/resource/image/da/e5/da9b83e6856e5fd523bc270981846fe5.jpg?wh=2364x2273)  
åœ¨ç¬¬äºŒéƒ¨åˆ†å®ç°çš„è¿‡ç¨‹ä¸­ï¼Œç›¸ä¿¡ä½ ç°åœ¨èƒ½ç†è§£ï¼Œ**ä¸€ä¸ªæœåŠ¡çš„æ¥å£è®¾è®¡ï¼Œå°±æ˜¯ä¸€ä¸ªâ€œæˆ‘ä»¬æƒ³è¦ä»€ä¹ˆæœåŠ¡â€çš„æ€è€ƒè¿‡ç¨‹**ã€‚æ¯”å¦‚åœ¨ç¼“å­˜æœåŠ¡æ¥å£è®¾è®¡ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†16ä¸ªæ–¹æ³•ï¼Œå›Šæ‹¬äº†Get/Set/Del/Rememberç­‰ä¸€ç³»åˆ—æ–¹æ³•ï¼Œä½ å¯ä»¥å¯¹ç…§æ€ç»´å¯¼å›¾å¤ä¹ ä¸€ä¸‹ã€‚ä½†è¿™äº›æ–¹æ³•å¹¶ä¸æ˜¯éšä¾¿æ‹è„‘è¢‹å‡ºæ¥çš„ï¼Œæ˜¯å› ä¸ºæœ‰è®¾ç½®ç¼“å­˜ã€è·å–ç¼“å­˜ã€åˆ é™¤ç¼“å­˜ç­‰éœ€æ±‚ï¼Œæ‰è¿™æ ·è®¾è®¡çš„ã€‚

### æ€è€ƒé¢˜

ç›®å‰hadeæ¡†æ¶æ”¯æŒå†…å­˜å’ŒRediså®ç°ç¼“å­˜ï¼Œæˆ‘ä»¬ä»Šå¤©å±•ç¤ºäº†Redisçš„å®ç°ã€‚ç¼“å­˜æœåŠ¡çš„å†…å­˜ç¼“å­˜å¦‚ä½•å®ç°å‘¢ï¼Ÿå¯ä»¥å…ˆæ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœæ˜¯ä½ æ¥å®ç°ä¼šå¦‚ä½•è®¾è®¡å‘¢ï¼Ÿå¦‚æœæœ‰å…´è¶£ï¼Œä½ å¯ä»¥è‡ªå·±åŠ¨æ‰‹æ“ä½œä¸€ä¸‹ã€‚å®Œæˆä¹‹åï¼Œä½ å¯ä»¥æ¯”å¯¹GitHubåˆ†æ”¯ä¸Šæˆ‘å·²ç»å®ç°çš„ç‰ˆæœ¬ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ¡ˆã€‚

æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒã€‚æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œå¦‚æœä½ è§‰å¾—ä»Šå¤©çš„å†…å®¹å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œé‚€è¯·ä»–ä¸€èµ·å­¦ä¹ ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï½
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ6ï¼‰</strong></div><ul>
<li><span>Vincent</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ä»¥redisä¸ºåŸºç¡€ï¼Œæœ€å¤§é™åº¦æ‰©å±•cacheçš„æŠ½è±¡ï¼Œå­¦ä¹ äº†</p>2021-11-20</li><br/><li><span>Aaron</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>SetObjæ–¹æ³•çš„è¯´æ˜ã€GetObj è·å–æŸä¸ªkeyå¯¹åº”çš„å¯¹è±¡, å¯¹è±¡å¿…é¡»å®ç° https:&#47;&#47;pkg.go.dev&#47;encoding#BinaryUnMarshalerã€‘ï¼Œ æˆ‘å¹¶æ²¡æœ‰è¿™æ ·å®ç°ï¼Œ æˆ‘ç›´æ¥ä»¥json.Marshalï¼Œè½¬æˆå­—ç¬¦ä¸²çš„å½¢å¼è¿›è¡Œå­˜å‚¨ã€‚getçš„æ—¶å€™ï¼Œå†json.Unmarshalè¿›è¡Œè½¬æ¢ï¼Œè½¬æ¢æˆç»“æ„ä½“ã€‚å¦å¤–ï¼Œæˆ‘å®ç°çš„æ—¶å€™ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´çš„æ—¶å€™ï¼Œ 0ä»£è¡¨æ°¸ä¹…å­˜å‚¨ï¼Œ åœ¨V8(v8.11.4, GOæ˜¯1.17) çš„æºç é‡Œä¹Ÿèƒ½çœ‹åˆ°è¯´æ˜ã€‚ã€Zero expiration means the key has no expiration time.ã€‘</p>2021-12-08</li><br/><li><span>ç‰™å°æœ¨</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å±‚æ¬¡æè¿°æ¸…æ™°ï¼Œæ„Ÿè§‰ç¼ºäº†ç‚¹å±‚æ¬¡å›¾ã€‚å­—ä¸å¦‚å›¾å“¦</p>2021-12-02</li><br/><li><span>qinsi</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ6ï¼‰<p>çœ‹ä¸Šå»å°è£…çš„redisæœåŠ¡åªä¼šè¿”å›go-rediså®ç°çš„redis clientï¼Œé‚£ä¹ˆå®šä¹‰redisæœåŠ¡çš„æ¥å£ä¼¼ä¹å°±ä¸æ˜¯å¾ˆå¿…è¦ï¼Œå› ä¸ºä¸ä¼šå†æœ‰å…¶ä»–çš„redisæœåŠ¡çš„å®ç°äº†ã€‚æ–‡ä¸­ä½¿ç”¨redisæœåŠ¡æ˜¯ä¸ºäº†å®ç°ç¼“å­˜æœåŠ¡ï¼Œé‚£ä¹ˆç›´æ¥ç”¨go-rediså®ç°å°±å¥½äº†ã€‚</p>2021-11-21</li><br/><li><span>qiutian</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¿™ç¯‡æ„Ÿè§‰æœ‰ç‚¹ä¹±ï¼Œä¸€ä¼šæ˜¯Redisçš„ä»£ç ï¼Œä¸€ä¼šåˆæ’å…¥äº†Cacheçš„ä»£ç ï¼Œèƒ½çœ‹æ‡‚ï¼Œä½†ä¸æ˜¯å¾ˆæ¸…æ™°</p>2022-09-17</li><br/><li><span>Jussi Lee</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>redis å…³é—­é“¾æ¥çš„ç›¸å…³é€»è¾‘ï¼Œå¥½åƒæ²¡æœ‰çœ‹åˆ°</p>2022-06-28</li><br/>
</ul>