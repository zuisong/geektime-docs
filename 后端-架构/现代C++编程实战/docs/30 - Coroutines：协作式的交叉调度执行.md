ä½ å¥½ï¼Œæˆ‘æ˜¯å´å’ç‚œã€‚

ä»Šå¤©æ˜¯æˆ‘ä»¬æœªæ¥ç¯‡çš„æœ€åä¸€è®²ï¼Œä¹Ÿæ˜¯è¿™ä¸ªä¸“æ æ­£æ–‡å†…å®¹çš„æœ€åä¸€ç¯‡äº†ã€‚æˆ‘ä»¬è®¨è®º C++20 é‡Œçš„åˆä¸€ä¸ªéå¸¸é‡è¦çš„æ–°åŠŸèƒ½â€”â€”åç¨‹ Coroutinesã€‚

## ä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿ

åç¨‹æ˜¯ä¸€ä¸ªå¾ˆæ—©å°±è¢«æå‡ºçš„ç¼–ç¨‹æ¦‚å¿µã€‚æ ¹æ®é«˜å¾·çº³çš„æè¿°ï¼Œåç¨‹çš„æ¦‚å¿µåœ¨ 1958 å¹´å°±è¢«æå‡ºäº†ã€‚ä¸è¿‡ï¼Œå®ƒåœ¨ä¸»æµç¼–ç¨‹è¯­è¨€ä¸­å¾—åˆ°çš„æ”¯æŒä¸é‚£ä¹ˆå¥½ï¼Œå› è€Œä½ å¾ˆå¯èƒ½å¯¹å®ƒå¹¶ä¸ç†Ÿæ‚‰å§ã€‚

å¦‚æœæŸ¥é˜…ç»´åŸºç™¾ç§‘ï¼Œä½ å¯ä»¥çœ‹åˆ°ä¸‹é¢è¿™æ ·çš„å®šä¹‰ \[1]ï¼š

> åç¨‹æ˜¯è®¡ç®—æœºç¨‹åºçš„â¼€ç±»ç»„ä»¶ï¼Œæ¨â¼´äº†åä½œå¼å¤šä»»åŠ¡çš„â¼¦ç¨‹åºï¼Œå…è®¸æ‰§â¾è¢«æŒ‚èµ·ä¸è¢«æ¢å¤ã€‚ç›¸å¯¹â¼¦ä¾‹ç¨‹â½½â¾”ï¼Œåç¨‹æ›´ä¸ºâ¼€èˆ¬å’Œçµæ´»â€¦â€¦

ç­‰å­¦å®Œäº†è¿™ä¸€è®²ï¼Œä¹Ÿè®¸ä½ å¯ä»¥æ˜ç™½è¿™æ®µè¯çš„æ„æ€ã€‚ä½†å¯¹ä¸äº†è§£åç¨‹çš„äººæ¥è¯´ï¼Œä¼°è®¡åªèƒ½åæ§½ä¸€å¥äº†ï¼Œè¿™æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿ

![](https://static001.geekbang.org/resource/image/4d/f9/4d4fb4a1c16edb1087d934cd1bb7eef9.png?wh=1142%2A293 "å›¾ç‰‡æºè‡ªç½‘ç»œ")

å¾ˆé—æ†¾ï¼Œåœ¨ C++ é‡Œçš„æ ‡å‡†åç¨‹æœ‰ç‚¹å°å¤æ‚ã€‚æˆ‘ä»¬è¿˜æ˜¯ä»â€¦â€¦Python å¼€å§‹ã€‚

```python
def fibonacci():
    a = 0
    b = 1
    while True:
        yield b
        a, b = b, a + b
```

å³ä½¿ä½ æ²¡å­¦è¿‡ Pythonï¼Œä¸Šé¢è¿™ä¸ªç”Ÿæˆæ–æ³¢é‚£å¥‘æ•°åˆ—çš„ä»£ç åº”è¯¥ä¹Ÿä¸éš¾ç†è§£ã€‚å”¯ä¸€çœ‹èµ·æ¥è®©äººä¼šè§‰å¾—æœ‰ç‚¹å¥‡æ€ªçš„åº”è¯¥å°±æ˜¯é‚£ä¸ª `yield` äº†ã€‚è¿™ç§å†™æ³•åœ¨ Python é‡Œå«åšâ€œç”Ÿæˆå™¨â€ï¼ˆgeneratorï¼‰ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªå¯è¿­ä»£çš„å¯¹è±¡ï¼Œæ¯æ¬¡è¿­ä»£å°±èƒ½å¾—åˆ°ä¸€ä¸ª yield å‡ºæ¥çš„ç»“æœã€‚è¿™å°±æ˜¯ä¸€ç§å¾ˆå¸¸è§çš„åç¨‹å½¢å¼äº†ã€‚

å¦‚ä½•ä½¿ç”¨è¿™ä¸ªç”Ÿæˆå™¨ï¼Œè¯·çœ‹ä¸‹é¢çš„ä»£ç ï¼š

```python
# æ‰“å°å¤´ 20 é¡¹
for i in islice(fibonacci(), 20):
    print(i)

# æ‰“å°å°äº 10000 çš„æ•°åˆ—é¡¹
for i in takewhile(
        lambda x: x < 10000,
        fibonacci()):
    print(i)
```

è¿™äº›ä»£ç å¾ˆå®¹æ˜“ç†è§£ï¼š`islice` ç›¸å½“äº[\[ç¬¬ 29 è®²\]](https://time.geekbang.org/column/article/195553) ä¸­çš„ `take`ï¼Œå–ä¸€ä¸ªèŒƒå›´çš„å¤´è‹¥å¹²é¡¹ï¼›`takewhile` åˆ™åœ¨èŒƒå›´ä¸­é€é¡¹å–å‡ºå†…å®¹ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªå‚æ•°çš„æ¡ä»¶ä¸èƒ½è¢«æ»¡è¶³ã€‚ä¸¤ä¸ªå‡½æ•°çš„ç»“æœéƒ½å¯ä»¥è¢«çœ‹ä½œæ˜¯ C++ ä¸­çš„è§†å›¾ã€‚

æˆ‘ä»¬å”¯ä¸€éœ€è¦æçš„æ˜¯ï¼Œåœ¨ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ`fibonacci` å’Œå®ƒçš„è°ƒç”¨ä»£ç æ˜¯äº¤å‰æ‰§è¡Œçš„ã€‚ä¸‹é¢æˆ‘ä»¬ç”¨ä»£ç è¡ŒåŠ æ³¨é‡Šçš„æ–¹å¼æ ‡ä¸€ä¸‹ï¼š

```python
a = 0  # fibonacci()
b = 0  # fibonacci()
yield b  # fibonacci()
print(i)  # è°ƒç”¨è€…
a, b = 1, 0 + 1  # fibonacci()
yield b  # fibonacci()
print(i)  # è°ƒç”¨è€…
a, b = 1, 1 + 1  # fibonacci()
yield b  # fibonacci()
print(i)  # è°ƒç”¨è€…
a, b = 2, 1 + 2  # fibonacci()
yield b  # fibonacci()
print(i)  # è°ƒç”¨è€…
â€¦
```

å­¦åˆ°è¿™å„¿çš„åŒå­¦åº”è¯¥éƒ½çŸ¥é“æˆ‘ä»¬åœ¨ C++ é‡Œæ€ä¹ˆå®Œæˆç±»ä¼¼çš„åŠŸèƒ½å§ï¼Ÿæˆ‘å°±ä¸è®²è§£äº†ï¼Œç›´æ¥ç»™å‡ºå¯å·¥ä½œçš„ä»£ç ã€‚è¿™æ˜¯å¯¹åº”çš„ `fibonacci` çš„å®šä¹‰ï¼š

```c++
#include <iterator>
#include <stddef.h>
#include <stdint.h>

class fibonacci {
public:
  class sentinel;
  class iterator;
  iterator begin() noexcept;
  sentinel end() noexcept;
};

class fibonacci::sentinel {};

class fibonacci::iterator {
public:
  // Required to satisfy iterator
  // concept
  typedef ptrdiff_t difference_type;
  typedef uint64_t value_type;
  typedef const uint64_t* pointer;
  typedef const uint64_t& reference;
  typedef std::input_iterator_tag
    iterator_category;

  value_type operator*() const
  {
    return b_;
  }
  pointer operator->() const
  {
    return &b_;
  }
  iterator& operator++()
  {
    auto tmp = a_;
    a_ = b_;
    b_ += tmp;
    return *this;
  }
  iterator operator++(int)
  {
    auto tmp = *this;
    ++*this;
    return tmp;
  }
  bool
  operator==(const sentinel&) const
  {
    return false;
  }
  bool
  operator!=(const sentinel&) const
  {
    return true;
  }

private:
  uint64_t a_{0};
  uint64_t b_{1};
};

// sentinel needs to be
// equality_comparable_with iterator
bool operator==(
  const fibonacci::sentinel& lhs,
  const fibonacci::iterator& rhs)
{
  return rhs == lhs;
}
bool operator!=(
  const fibonacci::sentinel& lhs,
  const fibonacci::iterator& rhs)
{
  return rhs != lhs;
}

inline fibonacci::iterator
fibonacci::begin() noexcept
{
  return iterator();
}

inline fibonacci::sentinel
fibonacci::end() noexcept
{
  return sentinel();
}
```

è°ƒç”¨ä»£ç è·Ÿ Python çš„ç›¸ä¼¼ï¼š

```c++
// æ‰“å°å¤´ 20 é¡¹
for (auto i :
     fibonacci() | take(20)) {
  cout << i << endl;
}

// æ‰“å°å°äº 10000 çš„æ•°åˆ—é¡¹
for (auto i :
     fibonacci() |
       take_while([](uint64_t x) {
         return x < 10000;
       })) {
  cout << i << endl;
}
```

è¿™ä¼¼ä¹è¿˜è¡Œã€‚ä½† `fibonacci` çš„å®šä¹‰å·®å¼‚å°±å¤§äº†ï¼šåœ¨ Python é‡Œæ˜¯ 6 è¡Œæœ‰æ•ˆä»£ç ï¼Œåœ¨ C++ é‡Œæ˜¯ 53 è¡Œã€‚C++ çš„ç”Ÿäº§ç‡ä¼¼ä¹æœ‰ç‚¹ä½å•Šâ€¦â€¦

## C++20 åç¨‹

C++20 åç¨‹çš„åŸºç¡€æ˜¯å¾®è½¯æå‡ºçš„ Coroutines TSï¼ˆå¯æŸ¥çœ‹å·¥ä½œè‰æ¡ˆ \[2]ï¼‰ï¼Œå®ƒåœ¨ 2019 å¹´ 7 æœˆè¢«æ‰¹å‡†åŠ å…¥åˆ° C++20 è‰æ¡ˆä¸­ã€‚ç›®å‰ï¼ŒMSVC å’Œ Clang å·²ç»æ”¯æŒåç¨‹ã€‚ä¸è¿‡ï¼Œéœ€è¦æä¸€ä¸‹çš„æ˜¯ï¼Œç›®å‰è¢«æ ‡å‡†åŒ–çš„åªæ˜¯åç¨‹çš„åº•å±‚è¯­è¨€æ”¯æŒï¼Œè€Œä¸æ˜¯ä¸Šå±‚çš„é«˜çº§å°è£…ï¼›ç¨åï¼Œæˆ‘ä»¬ä¼šå›åˆ°è¿™ä¸ªè¯é¢˜ã€‚

åç¨‹å¯ä»¥æœ‰å¾ˆå¤šä¸åŒçš„ç”¨é€”ï¼Œä¸‹é¢åˆ—ä¸¾äº†å‡ ç§å¸¸è§æƒ…å†µï¼š

- ç”Ÿæˆå™¨
- å¼‚æ­¥ I/O
- æƒ°æ€§æ±‚å€¼
- äº‹ä»¶é©±åŠ¨åº”ç”¨

è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦è¿˜æ˜¯æ²¿ç”¨ç”Ÿæˆå™¨çš„ä¾‹å­ï¼Œå‘ä½ å±•ç¤ºåç¨‹çš„åŸºæœ¬ç”¨æ³•ã€‚å¼‚æ­¥ I/O åº”å½“åœ¨åç¨‹å¾—åˆ°å¹¿æ³›é‡‡ç”¨ä¹‹åï¼Œæˆä¸ºæœ€èƒ½æœ‰æ˜æ˜¾æ”¶ç›Šçš„ä½¿ç”¨åœºæ™¯ï¼›ä½†ç›®å‰ï¼Œå°±æˆ‘çœ‹åˆ°çš„ï¼Œåªæœ‰ Windows å¹³å°ä¸Šæœ‰è¾ƒå¥½çš„æ”¯æŒâ€”â€”å¾®è½¯ç›®å‰è¿˜æ˜¯åšäº†å¾ˆå¤šåŠªåŠ›çš„ã€‚

å›åˆ° Coroutinesã€‚æˆ‘ä»¬ä»Šå¤©é‡‡ç”¨ Coroutines TS ä¸­çš„å†™æ³•ï¼ŒåŒ…æ‹¬ `std::experimental` åç©ºé—´ï¼Œä»¥ç¡®ä¿ä½ å¯ä»¥åœ¨ MSVC å’Œ Clang ä¸‹ç¼–è¯‘ä»£ç ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹åç¨‹ç›¸å…³çš„æ–°å…³é”®å­—ï¼Œæœ‰ä¸‹é¢ä¸‰ä¸ªï¼š

- `co_await`
- `co_yield`
- `co_return`

è¿™ä¸‰ä¸ªå…³é”®å­—æœ€åˆæ˜¯æ²¡æœ‰ `co_` å‰ç¼€çš„ï¼Œä½†è€ƒè™‘åˆ° `await`ã€`yield` å·²ç»åœ¨å¾ˆå¤šä»£ç é‡Œå‡ºç°ï¼Œå°±æ”¹æˆäº†ç›®å‰è¿™ä¸ªæ ·å­ã€‚åŒæ—¶ï¼Œ`return` å’Œ `co_return` ä¹Ÿä½œå‡ºäº†æ˜ç¡®çš„åŒºåˆ†ï¼šä¸€ä¸ªåç¨‹é‡Œåªèƒ½ä½¿ç”¨ `co_return`ï¼Œä¸èƒ½ä½¿ç”¨ `return`ã€‚è¿™ä¸‰ä¸ªå…³é”®å­—åªè¦æœ‰ä¸€ä¸ªå‡ºç°åœ¨å‡½æ•°ä¸­ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯ä¸€ä¸ªåç¨‹äº†â€”â€”ä»å¤–éƒ¨åˆ™çœ‹ä¸å‡ºæ¥ï¼Œæ²¡æœ‰ç”¨å…¶ä»–è¯­è¨€å¸¸ç”¨çš„ `async` å…³é”®å­—æ¥æ ‡è®°ï¼ˆ`async` ä¹Ÿå·²ç»æœ‰å…¶ä»–ç”¨é€”äº†ï¼Œè§[\[ç¬¬ 19 è®²\]](https://time.geekbang.org/column/article/186689)ï¼‰ã€‚C++ è®¤ä¸ºä¸€ä¸ªå‡½æ•°æ˜¯å¦æ˜¯ä¸€ä¸ªåç¨‹æ˜¯ä¸€ä¸ªå®ç°ç»†èŠ‚ï¼Œä¸æ˜¯å¯¹å¤–æ¥å£çš„ä¸€éƒ¨åˆ†ã€‚

æˆ‘ä»¬çœ‹ä¸€ä¸‹ç”¨åç¨‹å®ç°çš„ `fibonacci` é•¿ä»€ä¹ˆæ ·å­ï¼š

```c++
uint64_resumable fibonacci()
{
  uint64_t a = 0;
  uint64_t b = 1;
  while (true) {
    co_yield b;
    auto tmp = a;
    a = b;
    b += tmp;
  }
}
```

è¿™ä¸ªå½¢å¼è·Ÿ Python çš„éå¸¸ç›¸ä¼¼äº†å§ï¼Œä¹Ÿéå¸¸ç®€æ´ã€‚æˆ‘ä»¬ç¨åå†è®¨è®º `uint64_resumable` çš„å®šä¹‰ï¼Œå…ˆçœ‹ä¸€ä¸‹è°ƒç”¨ä»£ç çš„æ ·å­ï¼š

```c++
auto res = fibonacci();
while (res.resume()) {
  auto i = res.get();
  if (i >= 10000) {
    break;
  }
  cout << i << endl;
}
```

è¿™ä¸ªä»£ç ä¹Ÿéå¸¸ç®€å•ï¼Œä½†æˆ‘ä»¬éœ€è¦ç•™æ„ `resume` å’Œ `get` ä¸¤ä¸ªå‡½æ•°è°ƒç”¨â€”â€”è¿™å°±æ˜¯æˆ‘ä»¬çš„ `uint64_resumable` ç±»å‹éœ€è¦æä¾›çš„æ¥å£äº†ã€‚

### co\_awaitã€co\_yieldã€co\_return å’Œåç¨‹æ§åˆ¶

åœ¨è®¨è®ºè¯¥å¦‚ä½•å®šä¹‰ `uint64_resumable` ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè®¨è®ºä¸€ä¸‹åç¨‹çš„è¿™ä¸‰ä¸ªæ–°å…³é”®å­—ã€‚

é¦–å…ˆæ˜¯ `co_await`ã€‚å¯¹äºä¸‹é¢è¿™æ ·ä¸€ä¸ªè¡¨è¾¾å¼ï¼š

```c++
auto result = co_await è¡¨è¾¾å¼;
```

ç¼–è¯‘å™¨ä¼šæŠŠå®ƒç†è§£ä¸ºï¼š

```c++
auto&& __a = è¡¨è¾¾å¼;
if (!__a.await_ready()) {
  __a.await_suspend(åç¨‹å¥æŸ„);
  // æŒ‚èµ·/æ¢å¤ç‚¹
}
auto result = __a.await_resume();
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œâ€œè¡¨è¾¾å¼â€éœ€è¦æ”¯æŒ `await_ready`ã€`await_suspend` å’Œ `await_resume` ä¸‰ä¸ªæ¥å£ã€‚å¦‚æœ `await_ready()` è¿”å›çœŸï¼Œå°±ä»£è¡¨ä¸éœ€è¦çœŸæ­£æŒ‚èµ·ï¼Œç›´æ¥è¿”å›åé¢çš„ç»“æœå°±å¯ä»¥ï¼›å¦åˆ™ï¼Œæ‰§è¡Œ `await_suspend` ä¹‹åå³æŒ‚èµ·åç¨‹ï¼Œç­‰å¾…åç¨‹è¢«å”¤é†’ä¹‹åå†è¿”å› `await_resume()` çš„ç»“æœã€‚è¿™æ ·ä¸€ä¸ªè¡¨è¾¾å¼è¢«ç§°ä½œæ˜¯ä¸ª awaitableã€‚

æ ‡å‡†é‡Œå®šä¹‰äº†ä¸¤ä¸ª awaitableï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```c++
struct suspend_always {
  bool await_ready() const noexcept
  {
    return false;
  }
  void await_suspend(
    coroutine_handle<>)
    const noexcept {}
  void await_resume()
    const noexcept {}
};

struct suspend_never {
  bool await_ready() const noexcept
  {
    return true;
  }
  void await_suspend(
    coroutine_handle<>)
    const noexcept {}
  void await_resume()
    const noexcept {}
};
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œ`suspend_always` æ°¸è¿œå‘Šè¯‰è°ƒç”¨è€…éœ€è¦æŒ‚èµ·ï¼Œè€Œ `suspend_never` åˆ™æ°¸è¿œå‘Šè¯‰è°ƒç”¨è€…ä¸éœ€è¦æŒ‚èµ·ã€‚ä¸¤è€…çš„ `await_suspend` å’Œ `await_resume` éƒ½æ˜¯å¹³å‡¡å®ç°ï¼Œä¸åšä»»ä½•å®é™…çš„äº‹æƒ…ã€‚ä¸€ä¸ª awaitable å¯ä»¥è‡ªè¡Œå®ç°è¿™äº›æ¥å£ï¼Œä»¥å®šåˆ¶æŒ‚èµ·ä¹‹å‰å’Œæ¢å¤ä¹‹åéœ€è¦æ‰§è¡Œçš„æ“ä½œã€‚

ä¸Šé¢çš„ `coroutine_handle` æ˜¯ C++ æ ‡å‡†åº“æä¾›çš„ç±»æ¨¡æ¿ã€‚è¿™ä¸ªç±»æ˜¯ç”¨æˆ·ä»£ç è·Ÿç³»ç»Ÿåç¨‹è°ƒåº¦çœŸæ­£äº¤äº’çš„åœ°æ–¹ï¼Œæœ‰ä¸‹é¢è¿™äº›æˆå‘˜å‡½æ•°æˆ‘ä»¬ç­‰ä¼šå°±ä¼šç”¨åˆ°ï¼š

- `destroy`ï¼šé”€æ¯åç¨‹
- `done`ï¼šåˆ¤æ–­åç¨‹æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆ
- `resume`ï¼šè®©åç¨‹æ¢å¤æ‰§è¡Œ
- `promise`ï¼šè·å¾—åç¨‹ç›¸å…³çš„ promise å¯¹è±¡ï¼ˆå’Œ[\[ç¬¬ 19 è®²\]](https://time.geekbang.org/column/article/186689) ä¸­çš„â€œæ‰¿è¯ºé‡â€æœ‰ç‚¹ç›¸ä¼¼ï¼Œæ˜¯åç¨‹å’Œè°ƒç”¨è€…çš„ä¸»è¦äº¤äº’å¯¹è±¡ï¼›ä¸€èˆ¬ç±»å‹åç§°ä¸º `promise_type`ï¼‰
- `from_promise`ï¼ˆé™æ€ï¼‰ï¼šé€šè¿‡ promise å¯¹è±¡çš„å¼•ç”¨æ¥ç”Ÿæˆä¸€ä¸ªåç¨‹å¥æŸ„

åç¨‹çš„æ‰§è¡Œè¿‡ç¨‹å¤§è‡´æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š

1. ä¸ºåç¨‹è°ƒç”¨åˆ†é…ä¸€ä¸ªåç¨‹å¸§ï¼Œå«åç¨‹è°ƒç”¨çš„å‚æ•°ã€å˜é‡ã€çŠ¶æ€ã€promise å¯¹è±¡ç­‰æ‰€éœ€çš„ç©ºé—´ã€‚
2. è°ƒç”¨ `promise.get_return_object()`ï¼Œè¿”å›å€¼ä¼šåœ¨åç¨‹ç¬¬ä¸€æ¬¡æŒ‚èµ·æ—¶è¿”å›ç»™åç¨‹çš„è°ƒç”¨è€…ã€‚
3. æ‰§è¡Œ `co_await promise.initial_suspsend()`ï¼›æ ¹æ®ä¸Šé¢å¯¹ `co_await` è¯­ä¹‰çš„æè¿°ï¼Œåç¨‹å¯èƒ½åœ¨æ­¤ç¬¬ä¸€æ¬¡æŒ‚èµ·ï¼ˆä½†ä¹Ÿå¯èƒ½æ­¤æ—¶ä¸æŒ‚èµ·ï¼Œåœ¨åé¢çš„åç¨‹ä½“æ‰§è¡Œè¿‡ç¨‹ä¸­æŒ‚èµ·ï¼‰ã€‚
4. æ‰§è¡Œåç¨‹ä½“ä¸­çš„è¯­å¥ï¼Œä¸­é—´å¯èƒ½æœ‰æŒ‚èµ·å’Œæ¢å¤ï¼›å¦‚æœæœŸé—´å‘ç”Ÿå¼‚å¸¸æ²¡æœ‰åœ¨åç¨‹ä½“ä¸­å¤„ç†ï¼Œåˆ™è°ƒç”¨ `promise.unhandled_exception()`ã€‚
5. å½“åç¨‹æ‰§è¡Œåˆ°åº•ï¼Œæˆ–è€…æ‰§è¡Œåˆ° `co_return` è¯­å¥æ—¶ï¼Œä¼šæ ¹æ®æ˜¯å¦æœ‰é void çš„è¿”å›å€¼ï¼Œè°ƒç”¨ `promise.return_value(â€¦)` æˆ– `promise.return_void()`ï¼Œç„¶åæ‰§è¡Œ `co_await promise.final_suspsend()`ã€‚

ç”¨ä»£ç å¯ä»¥å¤§è‡´è¡¨ç¤ºå¦‚ä¸‹ï¼š

```c++
  frame = operator new(â€¦);
  promise_type& promise =
    frame->promise;

  // åœ¨åˆæ¬¡æŒ‚èµ·æ—¶è¿”å›ç»™è°ƒç”¨è€…
  auto return_value =
    promise.get_return_object();

  co_await promise
    .initial_suspsend();
  try {
    æ‰§è¡Œåç¨‹ä½“;
    å¯èƒ½è¢« co_waitã€co_yield æŒ‚èµ·;
    æ¢å¤åç»§ç»­æ‰§è¡Œï¼Œç›´åˆ° co_return;
  }
  catch (...) {
    promise.unhandled_exception();
  }

final_suspend:
  co_await promise.final_suspsend();
```

ä¸Šé¢æè¿°äº† `co_await` å’Œ `co_return`ï¼Œé‚£ `co_yield` å‘¢ï¼Ÿä¹Ÿå¾ˆç®€å•ï¼Œ`co_yield è¡¨è¾¾å¼` ç­‰ä»·äºï¼š

```c++
co_await promise.yield_value(è¡¨è¾¾å¼);
```

### å®šä¹‰ `uint64_resumable`

äº†è§£äº†ä¸Šè¿°çŸ¥è¯†ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å±•ç¤ºä¸€ä¸‹ `uint64_resumable` çš„å®šä¹‰äº†ï¼š

```c++
class uint64_resumable {
public:
  struct promise_type {â€¦};

  using coro_handle =
    coroutine_handle<promise_type>;
  explicit uint64_resumable(
    coro_handle handle)
    : handle_(handle)
  {
  }
  ~uint64_resumable()
  {
    handle_.destroy();
  }
  uint64_resumable(
    const uint64_resumable&) =
    delete;
  uint64_resumable(
    uint64_resumable&&) = default;
  bool resume();
  uint64_t get();

private:
  coro_handle handle_;
};
```

è¿™ä¸ªä»£ç ç›¸å½“ç®€å•ï¼Œæˆ‘ä»¬çš„ç»“æ„å†…éƒ¨æœ‰ä¸ª `promise_type`ï¼ˆä¸‹é¢ä¼šå®šä¹‰ï¼‰ï¼Œè€Œç§æœ‰æˆå‘˜åªæœ‰ä¸€ä¸ªåç¨‹å¥æŸ„ã€‚åç¨‹æ„é€ éœ€è¦ä¸€ä¸ªåç¨‹å¥æŸ„ï¼Œææ„æ—¶å°†ä½¿ç”¨åç¨‹å¥æŸ„æ¥é”€æ¯åç¨‹ï¼›ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å…è®¸ç»“æ„è¢«ç§»åŠ¨ï¼Œä½†ä¸å¯å¤åˆ¶ï¼ˆä»¥å…é‡å¤è°ƒç”¨ `handle_.destroy()`ï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿™ä¸ªç»“æ„åªæä¾›äº†è°ƒç”¨è€…éœ€è¦çš„ `resume` å’Œ `get` æˆå‘˜å‡½æ•°ï¼Œåˆ†åˆ«å®šä¹‰å¦‚ä¸‹ï¼š

```c++
bool uint64_resumable::resume()
{
  if (!handle_.done()) {
    handle_.resume();
  }
  return !handle_.done();
}

uint64_t uint64_resumable::get()
{
  return handle_.promise().value_;
}
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œ`resume` ä¼šåˆ¤æ–­åç¨‹æ˜¯å¦å·²ç»ç»“æŸï¼Œæ²¡ç»“æŸå°±æ¢å¤åç¨‹çš„æ‰§è¡Œï¼›å½“åç¨‹å†æ¬¡æŒ‚èµ·æ—¶ï¼ˆè°ƒç”¨è€…æ¢å¤æ‰§è¡Œï¼‰ï¼Œè¿”å›åç¨‹æ˜¯å¦ä»åœ¨æ‰§è¡Œä¸­çš„çŠ¶æ€ã€‚è€Œ `get` ç®€å•åœ°è¿”å›å­˜å‚¨åœ¨ promise å¯¹è±¡ä¸­çš„æ•°å€¼ã€‚

ç°åœ¨æˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹ promise ç±»å‹äº†ï¼Œå®ƒé‡Œé¢æœ‰å¾ˆå¤šåç¨‹çš„å®šåˆ¶ç‚¹ï¼Œå¯ä»¥ä¿®æ”¹åç¨‹çš„è¡Œä¸ºï¼š

```c++
struct promise_type {
  uint64_t value_;
  using coro_handle =
    coroutine_handle<promise_type>;
  auto get_return_object()
  {
    return uint64_resumable{
      coro_handle::from_promise(
        *this)};
  }
  constexpr auto initial_suspend()
  {
    return suspend_always();
  }
  constexpr auto final_suspend()
  {
    return suspend_always();
  }
  auto yield_value(uint64_t value)
  {
    value_ = value;
    return suspend_always();
  }
  void return_void() {}
  void unhandled_exception()
  {
    std::terminate();
  }
};
```

ç®€å•è§£è¯´ä¸€ä¸‹ï¼š

- ç»“æ„é‡Œé¢åªæœ‰ä¸€ä¸ªæ•°æ®æˆå‘˜ `value_`ï¼Œå­˜æ”¾ä¾› `uint64_resumable::get` å–ç”¨çš„æ•°å€¼ã€‚
- `get_return_object` æ˜¯ç¬¬ä¸€ä¸ªå®šåˆ¶ç‚¹ã€‚æˆ‘ä»¬å‰é¢æåˆ°è¿‡ï¼Œè°ƒç”¨åç¨‹çš„è¿”å›å€¼å°±æ˜¯ `get_return_object()` çš„ç»“æœã€‚æˆ‘ä»¬è¿™å„¿å°±æ˜¯ä½¿ç”¨ promise å¯¹è±¡æ¥æ„é€ ä¸€ä¸ª `uint64_resumable`ã€‚
- `initial_suspend` æ˜¯ç¬¬äºŒä¸ªå®šåˆ¶ç‚¹ã€‚æˆ‘ä»¬æ­¤å¤„è¿”å› `suspend_always()`ï¼Œå³åç¨‹ç«‹å³æŒ‚èµ·ï¼Œè°ƒç”¨è€…é©¬ä¸Šå¾—åˆ° `get_return_object()` çš„ç»“æœã€‚
- `final_suspend` æ˜¯ç¬¬ä¸‰ä¸ªå®šåˆ¶ç‚¹ã€‚æˆ‘ä»¬æ­¤å¤„è¿”å› `suspend_always()`ï¼Œå³ä½¿æ‰§è¡Œåˆ°äº† `co_return` è¯­å¥ï¼Œåç¨‹ä»å¤„äºæŒ‚èµ·çŠ¶æ€ã€‚å¦‚æœæˆ‘ä»¬è¿”å› `suspend_never()` çš„è¯ï¼Œé‚£ä¸€æ—¦æ‰§è¡Œäº† `co_return` æˆ–æ‰§è¡Œåˆ°åç¨‹ç»“æŸï¼Œåç¨‹å°±ä¼šè¢«é”€æ¯ï¼Œè¿åŒå·²åˆå§‹åŒ–çš„æœ¬åœ°å˜é‡å’Œ promiseï¼Œå¹¶é‡Šæ”¾åç¨‹å¸§å†…å­˜ã€‚
- `yield_value` æ˜¯ç¬¬å››ä¸ªå®šåˆ¶ç‚¹ã€‚æˆ‘ä»¬è¿™å„¿ä»…å¯¹ `value_` è¿›è¡Œèµ‹å€¼ï¼Œç„¶åè®©åç¨‹æŒ‚èµ·ï¼ˆæ‰§è¡Œæ§åˆ¶å›åˆ°è°ƒç”¨è€…ï¼‰ã€‚
- `return_void` æ˜¯ç¬¬äº”ä¸ªå®šåˆ¶ç‚¹ã€‚æˆ‘ä»¬çš„ä»£ç æ°¸ä¸è¿”å›ï¼Œè¿™å„¿æ— äº‹å¯åšã€‚
- `unhandled_exception` æ˜¯ç¬¬å…­ä¸ªå®šåˆ¶ç‚¹ã€‚æˆ‘ä»¬è¿™å„¿ä¹Ÿä¸åº”è¯¥å‘ç”Ÿä»»ä½•å¼‚å¸¸ï¼Œæ‰€ä»¥æˆ‘ä»¬ç®€å•åœ°è°ƒç”¨ `terminate` æ¥ç»ˆç»“ç¨‹åºçš„æ‰§è¡Œã€‚

å¥½äº†ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†åç¨‹ç›¸å…³çš„æ‰€æœ‰å®šä¹‰ã€‚æœ‰æ²¡æœ‰è§‰å¾—è½»æ¾ç‚¹ï¼Ÿ

* * *

æ²¡æœ‰ï¼Ÿé‚£å°±å¯¹äº†ã€‚æ­£å¦‚æˆ‘åœ¨è¿™ä¸€èŠ‚å¼€å¤´è¯´çš„ï¼ŒC++20 æ ‡å‡†åŒ–çš„åªæ˜¯åç¨‹çš„åº•å±‚è¯­è¨€æ”¯æŒï¼ˆæˆ‘ä¸Šé¢è¿˜å¹¶ä¸æ˜¯ä¸€ä¸ªéå¸¸å®Œæ•´çš„æè¿°ï¼‰ã€‚è¦ç”¨è¿™äº›åº•å±‚ç›´æ¥å†™åº”ç”¨ä»£ç ï¼Œé‚£æ˜¯éå¸¸ç—›è‹¦çš„äº‹ã€‚è¿™äº›æ¥å£çš„ç›®æ ‡ç”¨æˆ·å®é™…ä¸Šä¹Ÿä¸æ˜¯æ™®é€šå¼€å‘è€…ï¼Œè€Œæ˜¯åº“çš„ä½œè€…ã€‚

å¹¸å¥½ï¼Œæˆ‘ä»¬å¹¶ä¸æ˜¯æ²¡æœ‰ä»»ä½•é«˜å±‚æŠ½è±¡ï¼Œè™½ç„¶è¿™äº›å®ç°ä¸â€œæ ‡å‡†â€ã€‚

## C++20 åç¨‹çš„é«˜å±‚æŠ½è±¡

### cppcoro

æˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹è·¨å¹³å°çš„ cppcoro åº“ \[3]ï¼Œå®ƒæä¾›çš„é«˜å±‚æ¥å£å°±åŒ…å«äº† `generator`ã€‚å¦‚æœä½¿ç”¨ cppcoroï¼Œæˆ‘ä»¬çš„ `fibonacci` åç¨‹å¯ä»¥è¿™æ ·å®ç°ï¼š

```c++
#include <cppcoro/generator.hpp>
using cppcoro::generator;

generator<uint64_t> fibonacci()
{
  uint64_t a = 0;
  uint64_t b = 1;
  while (true) {
    co_yield b;
    auto tmp = a;
    a = b;
    b += tmp;
  }
}
```

ä½¿ç”¨ `fibonacci` ä¹Ÿæ¯”åˆšæ‰çš„ä»£ç è¦æ–¹ä¾¿ï¼š

```c++
for (auto i : fibonacci()) {
  if (i >= 10000) {
    break;
  }
  cout << i << endl;
}
```

é™¤äº†ç”Ÿæˆå™¨ï¼Œcppcoro è¿˜æ”¯æŒå¼‚æ­¥ä»»åŠ¡å’Œå¼‚æ­¥ I/Oâ€”â€”é—æ†¾çš„æ˜¯ï¼Œå¼‚æ­¥ I/O ç›®å‰åªæœ‰ Windows å¹³å°ä¸Šæœ‰ï¼Œè¿˜æ²¡äººå®ç° Linux æˆ– macOS ä¸Šçš„æ”¯æŒã€‚

### MSVC

ä½œä¸ºåç¨‹çš„å…ˆè¡Œè€…å’Œ Coroutines TS çš„æå‡ºè€…ï¼Œå¾®è½¯åœ¨åç¨‹ä¸Šåšäº†å¾ˆå¤šå·¥ä½œã€‚ç”Ÿæˆå™¨å½“ç„¶ä¹Ÿåœ¨å…¶ä¸­ï¼š

```c++
#include <experimental/generator>
using std::experimental::generator;

generator<uint64_t> fibonacci()
{
  uint64_t a = 0;
  uint64_t b = 1;
  while (true) {
    co_yield b;
    auto tmp = a;
    a = b;
    b += tmp;
  }
}
```

å¾®è½¯è¿˜æœ‰ä¸€äº›æœ‰è¶£çš„ç§æœ‰æ‰©å±•ã€‚æ¯”å¦‚ï¼ŒMSVC æŠŠæ ‡å‡† C++ çš„ `future` æ”¹é€ æˆäº† awaitableã€‚ä¸‹é¢çš„ä»£ç åœ¨ MSVC ä¸‹å¯ä»¥ç¼–è¯‘é€šè¿‡ï¼Œç®€å•åœ°å±•ç¤ºäº†åŸºæœ¬ç”¨æ³•ï¼š

```c++
future<int> compute_value()
{
  int result = co_await async([] {
    this_thread::sleep_for(1s);
    return 42;
  });
  co_return result;
}

int main()
{
  auto value = compute_value();
  cout << value.get() << endl;
}
```

ä»£ç ä¸­æœ‰ä¸€ä¸ªåœ°æ–¹æˆ‘éœ€è¦æé†’ä¸€ä¸‹ï¼šè™½ç„¶ä¸Šé¢ `async` è¿”å›çš„æ˜¯ `future<int>`ï¼Œä½† `compute_value` çš„è°ƒç”¨è€…å¾—åˆ°çš„å¹¶ä¸æ˜¯è¿™ä¸ª `future`â€”â€”å®ƒå¾—åˆ°çš„æ˜¯å¦å¤–ä¸€ä¸ªç‹¬ç«‹çš„ `future`ï¼Œå¹¶æœ€ç»ˆç”± `co_return` æŠŠç»“æœæ•°å€¼å¡«å……äº†è¿›å»ã€‚

## æœ‰æ ˆåç¨‹å’Œæ— æ ˆåç¨‹

æˆ‘ä»¬æœ€åéœ€è¦è¯´ä¸€ä¸‹æœ‰æ ˆï¼ˆstackfulï¼‰åç¨‹å’Œæ— æ ˆï¼ˆstacklessï¼‰åç¨‹çš„åŒºåˆ«ã€‚C++ é‡Œå¾ˆæ—©å°±æœ‰äº†æœ‰æ ˆçš„åç¨‹ï¼Œæ¦‚å¿µä¸Šæ¥è®²ï¼Œæœ‰æ ˆçš„åç¨‹è·Ÿçº¤ç¨‹ã€goroutines åŸºæœ¬æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œéƒ½æ˜¯ç”±ç”¨æˆ·è‡ªè¡Œè°ƒåº¦çš„ã€æ“ä½œç³»ç»Ÿä¹‹å¤–çš„è¿è¡Œå•å…ƒã€‚æ¯ä¸ªè¿™æ ·çš„è¿è¡Œå•å…ƒéƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„æ ˆç©ºé—´ï¼Œç¼ºç‚¹å½“ç„¶å°±æ˜¯æ ˆçš„ç©ºé—´å ç”¨å’Œåˆ‡æ¢æ ˆçš„å¼€é”€äº†ã€‚è€Œæ— æ ˆçš„åç¨‹è‡ªå·±æ²¡æœ‰ç‹¬ç«‹çš„æ ˆç©ºé—´ï¼Œæ¯ä¸ªåç¨‹åªéœ€è¦ä¸€ä¸ªå¾ˆå°çš„æ ˆå¸§ï¼Œç©ºé—´å ç”¨å°ï¼Œä¹Ÿæ²¡æœ‰æ ˆçš„åˆ‡æ¢å¼€é”€ã€‚

C++20 çš„åç¨‹æ˜¯æ— æ ˆçš„ã€‚éƒ¨åˆ†åŸå› æ˜¯æœ‰æ ˆçš„åç¨‹å¯ä»¥ä½¿ç”¨çº¯åº“æ–¹å¼å®ç°ï¼Œè€Œæ— æ ˆçš„åç¨‹éœ€è¦ä¸€ç‚¹ç¼–è¯‘å™¨é­”æ³•å¸®å¿™ã€‚æ¯•ç«Ÿï¼Œåç¨‹é‡Œé¢çš„å˜é‡éƒ½æ˜¯è¦æ”¾åˆ°å †ä¸Šè€Œä¸æ˜¯æ ˆä¸Šçš„ã€‚

ä¸€ä¸ªç®€å•çš„æ— æ ˆåç¨‹è°ƒç”¨çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://static001.geekbang.org/resource/image/e3/66/e35d2b262c741acf40d69eedc6a5ad66.png?wh=1032%2A824)

å¯ä»¥çœ‹åˆ°ï¼Œåç¨‹ C æœ¬èº«çš„æœ¬åœ°å˜é‡ä¸å ç”¨æ ˆï¼Œä½†å½“å®ƒè°ƒç”¨å…¶ä»–å‡½æ•°æ—¶ï¼Œå®ƒä¼šä½¿ç”¨çº¿ç¨‹åŸå…ˆçš„æ ˆç©ºé—´ã€‚åœ¨ä¸Šé¢çš„å‡½æ•° D çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåç¨‹æ˜¯ä¸å¯ä»¥æŒ‚èµ·çš„â€”â€”å¦‚æœæ§åˆ¶å›åˆ° B ç»§ç»­ï¼ŒB å¯èƒ½ä¼šä½¿ç”¨ç›®å‰å·²ç»è¢« D ä½¿ç”¨çš„æ ˆç©ºé—´ï¼

å› æ­¤ï¼Œæ— æ ˆçš„åç¨‹ç‰ºç‰²äº†ä¸€å®šçš„çµæ´»æ€§ï¼Œæ¢æ¥äº†ç©ºé—´çš„èŠ‚çœå’Œæ€§èƒ½ã€‚æœ‰æ ˆçš„åç¨‹ä½ å¯èƒ½èµ·å‡ åƒä¸ªå°±å ç”¨ä¸å°‘å†…å­˜ç©ºé—´ï¼Œè€Œæ— æ ˆçš„åç¨‹å¯ä»¥è½»è½»æ¾æ¾èµ·åˆ°äº¿çº§â€”â€”æ¯•ç«Ÿï¼Œç»´æŒåŸºæœ¬çŠ¶æ€çš„å¼€é”€æˆ‘å®æµ‹ä¸‹æ¥åªæœ‰ä¸€ç™¾å­—èŠ‚å·¦å³ã€‚

åè¿‡æ¥ï¼Œå¦‚æœæ— æ ˆçš„åç¨‹ä¸æ»¡è¶³éœ€è¦â€”â€”æ¯”å¦‚ï¼Œä½ çš„åç¨‹é‡Œéœ€è¦æœ‰é€’å½’è°ƒç”¨ï¼Œå¹¶åœ¨æ·±å±‚æŒ‚èµ·â€”â€”ä½ å°±ä¸å¾—ä¸å¯»æ‰¾ä¸€ä¸ªæœ‰æ ˆçš„åç¨‹çš„è§£å†³æ–¹æ¡ˆã€‚ç›®å‰å·²ç»æœ‰ä¸€äº›æˆç†Ÿçš„æ–¹æ¡ˆï¼Œæ¯”å¦‚ Boost.Coroutine2 \[4]ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºå¦‚ä½•åœ¨ Boost.Coroutine2 é‡Œå®ç° `fibonacci`ï¼Œè®©ä½ æ„Ÿå—ä¸€ç‚¹ç‚¹å°åŒºåˆ«ï¼š

```c++
#include <iostream>
#include <stdint.h>
#include <boost/coroutine2/all.hpp>

typedef boost::coroutines2::
  coroutine<const uint64_t>
    coro_t;

void fibonacci(
  coro_t::push_type& yield)
{
  uint64_t a = 0;
  uint64_t b = 1;
  while (true) {
    yield(b);
    auto tmp = a;
    a = b;
    b += tmp;
  }
}

int main()
{
  for (auto i : coro_t::pull_type(
         boost::coroutines2::
           fixedsize_stack(),
         fibonacci)) {
    if (i >= 10000) {
      break;
    }
    std::cout << i << std::endl;
  }
}
```

## ç¼–è¯‘å™¨æ”¯æŒ

å‰é¢æåˆ°äº†ï¼ŒMSVC å’Œ Clang ç›®å‰æ”¯æŒåç¨‹ã€‚ä¸è¿‡ï¼Œå®ƒä»¬éƒ½éœ€è¦ç‰¹æ®Šçš„å‘½ä»¤è¡Œé€‰é¡¹æ¥å¼€å¯åç¨‹æ”¯æŒï¼š

- MSVC éœ€è¦ `/await` å‘½ä»¤è¡Œé€‰é¡¹
- Clang éœ€è¦ `-fcoroutines-ts` å‘½ä»¤è¡Œé€‰é¡¹

ä¸ºäº†æ»¡è¶³ä½¿ç”¨ CMake çš„åŒå­¦çš„è¦æ±‚ï¼Œä¹Ÿä¸ºäº†æ–¹ä¾¿å¤§å®¶ç¼–è¯‘ï¼Œæˆ‘æŠŠç¤ºä¾‹ä»£ç æ”¾åˆ°äº† GitHub ä¸Šï¼š[https://github.com/adah1972/geek\_time\_cpp](https://github.com/adah1972/geek_time_cpp)

## å†…å®¹å°ç»“

æœ¬è®²è®¨è®ºäº† C++20 é‡Œçš„ç¬¬ä¸‰ä¸ªé‡è¦ç‰¹æ€§ï¼šåç¨‹ã€‚åç¨‹ä»ç„¶å¾ˆæ–°ï¼Œä½†å®ƒçš„é‡è¦æ€§æ˜¯æ¯‹åº¸ç½®ç–‘çš„â€”â€”å°¤å…¶åœ¨ç”Ÿæˆå™¨å’Œå¼‚æ­¥ I/O ä¸Šã€‚

## è¯¾åæ€è€ƒ

è¯·ä»”ç»†æ¯”è¾ƒç¬¬ä¸€ä¸ª `fibonacci` çš„ C++ å®ç°å’Œæœ€åä½¿ç”¨ `generator` çš„ `fibonacci` çš„å®ç°ï¼Œä½“ä¼šåç¨‹ä»£ç å¦‚æœè‡ªè¡Œç”¨çŠ¶æ€æœºçš„æ–¹å¼æ¥å®ç°ï¼Œæ˜¯ä¸€ä»¶å¤šéº»çƒ¦çš„äº‹æƒ…ã€‚

å¦‚æœä½ å¯¹åç¨‹æœ‰å…´è¶£ï¼Œå¯ä»¥æŸ¥çœ‹å‚è€ƒèµ„æ–™ \[5]ï¼Œé‡Œé¢æä¾›äº†ä¸€äº›è¾ƒä¸ºæ·±å…¥çš„åŸç†ä»‹ç»ã€‚

## å‚è€ƒèµ„æ–™

\[1] ç»´åŸºç™¾ç§‘, â€œåç¨‹â€. [https://zh.wikipedia.org/zh-cn/åç¨‹](https://zh.wikipedia.org/zh-cn/%E5%8D%8F%E7%A8%8B)

\[2] Gor Nishanov, â€œWorking draft, C++ extensions for coroutinesâ€. [http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/n4775.pdf](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/n4775.pdf)

\[3] Lewis Baker, CppCoro. [https://github.com/lewissbaker/cppcoro](https://github.com/lewissbaker/cppcoro)

\[4] Oliver Kowalke, Boost.Coroutine2. [https://www.boost.org/doc/libs/release/libs/coroutine2/doc/html/index.html](https://www.boost.org/doc/libs/release/libs/coroutine2/doc/html/index.html)

\[5] Dawid Pilarski, â€œCoroutines introductionâ€. [https://blog.panicsoftware.com/coroutines-introduction/](https://blog.panicsoftware.com/coroutines-introduction/)
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ12ï¼‰</strong></div><ul>
<li><span>å´å’ç‚œ</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å‚è€ƒèµ„æ–™ [3] çš„ cppcoro ç›®å‰çœ‹èµ·æ¥å·²ç»ä¸å†ç»´æŠ¤äº†ï¼Œè·Ÿæ–°ç‰ˆç¼–è¯‘å™¨çš„å…¼å®¹æ€§é—®é¢˜ä¸€ç›´æ— äººè§£å†³ã€‚ç›®å‰æ¯”è¾ƒå¥½çš„å¤åˆ»åœ¨ä¸‹é¢è¿™ä¸ªé“¾æ¥ï¼š

https:&#47;&#47;github.com&#47;andreasbuhr&#47;cppcoro</p>2022-03-10</li><br/><li><span>æ˜“è½»å°˜</span> ğŸ‘ï¼ˆ7ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>ä¸ªäººå¯¹åç¨‹çš„ç†è§£ï¼Œå¯èƒ½ä¸å¤ªå‡†ç¡®ï¼š
ä¸å¯ä»¥æ··æ·†çº¿ç¨‹å’Œåç¨‹ä¸¤ä¸ªæ¦‚å¿µã€‚è®¡ç®—æœºçœ‹åˆ°çš„æ˜¯çº¿ç¨‹ï¼Œè°ƒåº¦çš„ä¹Ÿæ˜¯çº¿ç¨‹ã€‚ä¸€ä¸ªçº¿ç¨‹ä¸­å¯ä»¥æœ‰å¾ˆå¤šä¸ªåç¨‹ï¼Œè¿™äº›åç¨‹çš„æ‰§è¡Œé¡ºåºç”±ç¨‹åºå‘˜è‡ªå·±æ¥è°ƒåº¦ã€‚æ¯”è¾ƒæ˜æ˜¾çš„å¥½å¤„æ˜¯ï¼Œ1. åŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„åç¨‹ä¸éœ€è¦è€ƒè™‘æ•°æ®çš„ç«äº‰é—®é¢˜ï¼Œå› ä¸ºè¿™äº›åç¨‹çš„æ‰§è¡Œé¡ºåºæ˜¯å›ºå®šçš„ï¼›2. åç¨‹èƒ½å¤Ÿå¾ˆæ–¹ä¾¿çš„ä¿å­˜æ‰§è¡ŒçŠ¶æ€ï¼Œä½¿å¤æ‚çŠ¶æ€æœºçš„å®ç°å˜å¾—ç®€å•ï¼›</p>2020-06-28</li><br/><li><span>Fireplusplus</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ— æ ˆåç¨‹çš„å†…å­˜å¸ƒå±€å¯ä»¥æ˜ç™½å‡½æ•°Dè°ƒç”¨ç»“æŸåï¼Œåº”è¯¥æ˜¯é€šè¿‡ç¼–è¯‘å™¨å¤„ç†åçš„æ–¹å¼è¿”å›åˆ°åç¨‹Cçš„å †ä¸Šç©ºé—´ï¼Œåç¨‹cæŒ‚èµ·ä¹‹åå †ä»ç„¶æ˜¯ä¿ç•™çš„ï¼Œä½†æ˜¯ä¸€ä¸ªæœ‰æ ˆåç¨‹çš„å†…å­˜å¸ƒå±€åº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œåç¨‹æŒ‚èµ·ä¹‹åä¸æ˜¯è¦å‡ºæ ˆæ‰èƒ½å›åˆ°è°ƒç”¨è€…çš„æ ˆæ¡¢å—ï¼Ÿ</p>2021-05-15</li><br/><li><span>è°¦è°¦å›å­</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œ å›¾å·¦è¾¹â€œè°ƒç”¨Xçš„å‚æ•°â€åœ¨â€œè¿”å›Yçš„åœ°å€â€ä¸‹é¢ï¼Œ è€Œå³è¾¹â€œè°ƒç”¨Xçš„å‚æ•°â€åœ¨â€œè¿”å›Yçš„åœ°å€â€ä¸Šé¢ï¼Œ æ˜¯ç”»é”™äº†ä¹ˆï¼Œ è¿˜æ˜¯åæˆé‡Œé¢å°±æ˜¯è·Ÿæ ˆä¸Šå‡½æ•°è°ƒç”¨æ˜¯åçš„å‘¢ï¼Ÿ</p>2020-02-12</li><br/><li><span>æäº‘é¾™</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆä¸‹é¢çš„è¿™ä¸ªå‡½æ•°ä½“å†…æ²¡æœ‰å†™co_returnï¼Œä¸ºä»€ä¹ˆå‡½æ•°çš„è¿”å›å€¼å°±å¯ä»¥å†™uint64_resumable ? 
uint64_resumable fibonacci()
{
  uint64_t a = 0;
  uint64_t b = 1;
  while (true) {
    co_yield b;
    auto tmp = a;
    a = b;
    b += tmp;
  }
}</p>2023-11-06</li><br/><li><span>englefly</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å´è€å¸ˆï¼Œè¯·æ•™ä¸¤ä¸ªé—®é¢˜ï¼š
1ã€‚coroutineçš„èƒ½åŠ›æ˜¯ä¸æ˜¯æ¯”çº¿ç¨‹å¼±ï¼Ÿæˆ‘ä»¬å¯ä»¥ç”¨çº¿ç¨‹çš„ mutex+condition-variable æˆ– primise+future æ¨¡æ‹Ÿcoroutineã€‚ä½†coroutineç©¶ç«Ÿå“ªäº›æ–¹é¢å¼±äºçº¿ç¨‹å‘¢ï¼Ÿ
2ã€‚coroutineçš„åº•å±‚å®ç°ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Ÿå®ƒæœ‰cpuçš„ä¸Šä¸‹æ–‡åˆ‡æ¢å—ï¼Ÿè¿˜æ˜¯æ‰€æœ‰coroutineéƒ½è¿è¡Œåœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œï¼Œcoroutineåªæ˜¯fibonacci c++å®ç°é‚£æ ·çš„ä¸€ç§ä»£ç ç»„ç»‡å½¢å¼ï¼Ÿ
è°¢è°¢</p>2020-03-29</li><br/><li><span>Gallen</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>æ‚¨å¥½ï¼Œå´è€å¸ˆï¼Œä¹‹å‰åœ¨2018å¹´cppå¼€å‘è€…å¤§ä¼šä¸Šå¬è¿‡æ‚¨è®²string viewå’Œrangeï¼Œè¿˜å·§å¦™çš„ä½¿ç”¨|ç®¡é“ç¬¦è¿›è¡Œå‡½æ•°é—´å¯¹è±¡ä¼ é€’ï¼Œèƒ½å¦æœ‰å¹¸æ·»åŠ ä¸€ä¸‹æ‚¨çš„å¾®ä¿¡ï¼Ÿè°¢è°¢</p>2020-02-20</li><br/><li><span>æ™šé£Â·å’Œç…¦</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œmap&lt;int, int&gt;().swap(map1);
è¿™ä¸ªè¯­å¥ä¸ºä»€ä¹ˆä¸èƒ½è¾¾åˆ°çœŸæ­£é‡Šæ”¾map1å†…å­˜çš„æ•ˆæœå‘¢ï¼Ÿå¿…é¡»å¾—ç”¨malloc_trim</p>2020-02-11</li><br/><li><span>Vackine</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ„Ÿè§‰è·Ÿpythoné‡Œé¢çš„asyncçš„æ–°çš„æ ‡å‡†åº“å¥½åƒï¼Œæ˜¯çœŸçš„æœ‰æ€§èƒ½ä¸Šçš„æå‡ä¹ˆï¼Œè¿˜æ˜¯åªæ˜¯ç¼–ç¨‹é­”æ³•ï¼Ÿ</p>2020-02-10</li><br/><li><span>æ¢…ä¾¯</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>åœ¨ä¸Šé¢çš„å‡½æ•° D çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåç¨‹æ˜¯ä¸å¯ä»¥æŒ‚èµ·çš„â€”â€”å¦‚æœæ§åˆ¶å›åˆ° B ç»§ç»­ï¼ŒB å¯èƒ½ä¼šä½¿ç”¨ç›®å‰å·²ç»è¢« D ä½¿ç”¨çš„æ ˆç©ºé—´ï¼

è¯·æ•™ä¸€ä¸‹è€å¸ˆï¼Œåœ¨Dçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåç¨‹èƒ½æŒ‚èµ·å—ï¼Ÿåº”è¯¥æ˜¯Dè¿”å›åï¼Œåç¨‹æ‰èƒ½æŒ‚èµ·å§ï¼Ÿè€å¸ˆèƒ½è¯¦ç»†è§£è¯´ä¸€ä¸‹å—ï¼Ÿè°¢è°¢</p>2025-02-01</li><br/><li><span>å¾</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¾ˆæ—©äº†è§£è¿‡åç¨‹çš„æ¦‚å¿µï¼Œè¯´æ˜¯ç”¨æˆ·çº§çº¿ç¨‹ï¼Œåœ¨ç”¨æˆ·æ€è°ƒåº¦ï¼Œé¿å…çº¿ç¨‹çš„å†…æ ¸æ€åˆ‡æ¢ï¼Œæ€§èƒ½æ›´é«˜ï¼›
åæ¥åœ¨ä¸€ä¸ª C++ æœåŠ¡æ¡†æ¶ä¸Šä¹Ÿä½¿ç”¨è¿‡ï¼Œå†åæ¥åˆ‡åˆ° Goï¼Œç”¨èµ·äº† goroutineï¼›
ç®€å•æ¥è¯´ï¼Œåç¨‹ç”¨èµ·æ¥æ˜¯çœŸçˆ½ï¼Œé¿å…äº†æ¶å¿ƒçš„å¼‚æ­¥ IO çš„ callback å†™æ³•ï¼Œè‡ªæˆ‘æ„Ÿè§‰ä¹Ÿç®—æ˜¯ç†è§£å¹¶ç†Ÿç»ƒä½¿ç”¨åç¨‹äº†ã€‚

ç›´åˆ°çœ‹äº† C++ 20 çš„åç¨‹ï¼Œå®Œäº†æƒŠæ‰ä¸‹å·´ç©è„‘è¢‹é—®å·ï¼Œè¿™ä»€ä¹ˆç©æ„å„¿ï¼Œè¿™æ˜¯åç¨‹å—ï¼Ÿ
æŸ¥å„ç§èµ„æ–™å’Œä¹¦ï¼Œéƒ½è·Ÿä»¥å‰ç†è§£çš„ä¸ä¸€æ ·ï¼Œç‰¹åˆ«æ˜¯çœ‹åˆ°æœ‰äººæ‰€è°“çš„ç”¨å‡ è¡Œä»£ç å®ç°åç¨‹ï¼Œé‚£æ›´æ˜¯ä¸çŸ¥æ‰€ä»¥ã€‚

æœ€åç»ˆäºåœ¨è¿™é‡Œè§£å¼€äº†æˆ‘çš„ç–‘æƒ‘ï¼ŒåŸæ¥ä»¥å‰ç†è§£å’Œä½¿ç”¨çš„åç¨‹ï¼Œå’Œ C++ 20 é‡Œçš„åç¨‹ï¼Œä¸€ä¸ªæ˜¯æœ‰æ ˆåç¨‹ï¼Œä¸€ä¸ªæ˜¯æ— æ ˆåç¨‹ï¼Œæœ‰å·¨å¤§å·®å¼‚ï¼Œä¸ºå•¥åœ¨é‚£äº›è®²ç°ä»£ C++ çš„ä¹¦é‡Œï¼Œéƒ½ä¸æè¿™ä¸ªç‚¹ï¼Œè¿™ä¸ªå¾ˆå…³é”®å‘ï¼ŒçœŸæ˜¯å›°æ‰°æˆ‘å¾ˆä¹…ã€‚</p>2023-02-24</li><br/><li><span>ç™¾å¹´</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆç»“è¯¾æœ‰ä¸€å¹´å¤šäº†ï¼Œä»€ä¹ˆæ—¶å€™å¼€ä¸ªC++ä¸pythonè”åˆç¼–ç¨‹çš„è¯¾å•Šã€‚</p>2021-06-11</li><br/>
</ul>