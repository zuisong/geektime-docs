ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ‘å»ºå‹‹ã€‚

ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬ä»‹ç»äº† Kubernetes æ¶æ„å’Œç›¸å…³çš„åŸç†ã€‚è¿™èŠ‚è¯¾è®©æˆ‘ä»¬æ›´è¿›ä¸€æ­¥ï¼Œå°†çˆ¬è™«é¡¹ç›®ç›¸å…³çš„å¾®æœåŠ¡éƒ¨ç½²åˆ° Kubernetes ä¸­ã€‚

## å®‰è£… Kubernetes é›†ç¾¤

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å‡†å¤‡å¥½Kubernetesçš„é›†ç¾¤ã€‚éƒ¨ç½² Kubernetes é›†ç¾¤çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œå…¸å‹çš„æ–¹å¼æœ‰ä¸‹é¢å‡ ç§ï¼š

- Play with Kubernetes (PWK)
- Docker Desktop
- äº‘å‚å•†çš„k8sæœåŠ¡ï¼Œä¾‹å¦‚Google Kubernetes Engine (GKE)
- kops
- kubeadm
- k3s
- k3d

å…¶ä¸­ï¼Œ[PWK](https://labs.play-with-k8s.com/) æ˜¯è¯•éªŒæ€§è´¨çš„å…è´¹çš„Kubernetesé›†ç¾¤ï¼Œåªè¦æœ‰Dockeræˆ–è€…Githubè´¦å·å°±å¯ä»¥åœ¨æµè§ˆå™¨ä¸Šä¸€é”®ç”ŸæˆKubernetesé›†ç¾¤ã€‚ä½†æ˜¯å®ƒæœ‰è¯¸å¤šé™åˆ¶ï¼Œä¾‹å¦‚ä¸€æ¬¡åªèƒ½ä½¿ç”¨4ä¸ªå°æ—¶ï¼Œå¹¶ä¸”æœ‰æ‰©å±•æ€§å’Œæ€§èƒ½ç­‰é—®é¢˜ã€‚æ‰€ä»¥PWKä¸€èˆ¬åªç”¨äºæ•™å­¦æˆ–è€…è¯•éªŒã€‚

ä¹‹å‰ï¼Œæˆ‘ä»¬åœ¨Windowså’ŒMacä¸­ç”¨Docker Desktopå®‰è£…åŒ…æ¥å®‰è£…äº†Dockerï¼Œå…¶å®åˆ©ç”¨æœ€æ–°çš„Docker Desktopï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨æœ¬åœ°ç”ŸæˆKubernetesé›†ç¾¤ã€‚ä½¿ç”¨Docker Desktopç”ŸæˆKubernetesé›†ç¾¤éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ç‚¹å‡»Dockerçš„é²¸é±¼å›¾æ ‡ï¼Œå¹¶ä¸”åœ¨Preferencesä¸­å‹¾é€‰Enable Kubernetesï¼Œç„¶åç‚¹å‡»ä¸‹æ–¹çš„Apply &amp; restart å°±å¯ä»¥åˆ›å»ºæˆ‘ä»¬çš„ Kubernetes é›†ç¾¤äº†ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/dd/d8/dd6ea310014be369041fcb4ea7c120d8.png?wh=1920x1089)

æœ€åï¼ŒDocker Desktopè¿˜æä¾›äº†åˆ‡æ¢Kubernetes Contextçš„èƒ½åŠ›ï¼Œæˆ‘ä»¬ç‚¹å‡»docker-desktopï¼Œè¿™æ ·æˆ‘ä»¬é€šè¿‡kubectlå‘é€çš„å‘½ä»¤å°±ä¼šä¼ åˆ°Docker Desktopæ„å»ºçš„Kubernetesé›†ç¾¤ä¸­ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/23/a1/23f4e08849555a3963b14a3e2457d3a1.png?wh=1920x1925)

ä¸Šé¢çš„è¿™ä¸ªç•Œé¢æ“ä½œå’Œä¸‹é¢çš„å‘½ä»¤è¡Œæ“ä½œåœ¨åŠŸèƒ½ä¸Šæ˜¯ç›¸åŒçš„ã€‚

```plain
Â» kubectl config use-context docker-desktop                                                                     jackson@jacksondeMacBook-Pro
Switched to context "docker-desktop".
```

æ¥ç€ï¼Œæˆ‘ä»¬æ‰§è¡Œkubectl get nodeså¯ä»¥çœ‹åˆ°å½“å‰é›†ç¾¤ä¸ºå•èŠ‚ç‚¹çš„é›†ç¾¤ï¼Œç‰ˆæœ¬ä¸ºv1.25.2ã€‚

```plain
Â» kubectl get nodes                                                                                             jackson@jacksondeMacBook-Pro
NAME             STATUS   ROLES           AGE   VERSION
docker-desktop   Ready    control-plane   25d   v1.25.2
```

Docker Desktopç”Ÿæˆçš„Kubernetesé›†ç¾¤å¯ä»¥ç”¨äºå¼€å‘æµ‹è¯•ï¼Œä½†æ˜¯å®ƒä¸èƒ½æ¨¡æ‹Ÿå¤šèŠ‚ç‚¹çš„Kubernetesé›†ç¾¤ã€‚

åœ¨ä¸€äº›ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦æ‰‹åŠ¨éƒ¨ç½²å¤šèŠ‚ç‚¹çš„Kubernetesé›†ç¾¤ã€‚ä¾‹å¦‚æˆ‘ä»¬è¦ä»¥Kubernetesä¸ºåŸºåº§ä¸ºæŸä¼ä¸šéƒ¨ç½²ä¸€å¥—äººè„¸è¯†åˆ«ç³»ç»Ÿï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [kubeadm](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/) å·¥å…·æ¥å®‰è£…Kubernetesé›†ç¾¤ã€‚

kubeadmæ˜¯ Kubernetes 1.4ç‰ˆæœ¬å¼•å…¥çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒè‡´åŠ›äºç®€åŒ–é›†ç¾¤çš„å®‰è£…è¿‡ç¨‹ã€‚å¦‚æœè¦æ›´ç²¾ç»†åœ°è°ƒæ•´Kuberneteså„ç»„ä»¶æœåŠ¡çš„å‚æ•°å’Œå®‰å…¨è®¾ç½®ï¼Œè¿˜å¯ä»¥ç”¨KubernetesäºŒè¿›åˆ¶æ–‡ä»¶çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²ã€‚kubeadmå’ŒäºŒè¿›åˆ¶æ–‡ä»¶çš„å®‰è£…æ–¹å¼ä½ å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£å’Œã€Škubernetesæƒå¨æŒ‡å—ã€‹ã€‚

åœ¨å¦ä¸€äº›ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¾‹å¦‚åœ¨ç§æœ‰äº‘çš„åœºæ™¯ä¸‹ï¼Œå¦‚æœä¸ºäº†åº”å¯¹é«˜å³°æœŸè€Œè´­å…¥æœºå™¨ï¼Œå®¹æ˜“å¯¼è‡´æœºå™¨é—²ç½®ï¼Œå¸¦æ¥èµ„æºæµªè´¹ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥å€ŸåŠ©äº‘å‚å•†çš„KubernetesæœåŠ¡ï¼ˆGoogle GKEï¼ŒMicrosoft AKSï¼ŒAmazon EKSï¼Œè…¾è®¯äº‘ï¼Œé˜¿é‡Œäº‘ï¼‰æ­å»º Kubernetes é›†ç¾¤ã€‚ä»¥ [GKE](https://cloud.google.com/kubernetes-engine) ä¸ºä¾‹ï¼ŒGKEæ˜¯è¿è¡Œåœ¨è°·æ­Œäº‘å¹³å°ä¸Šçš„Kubernetesæ‰˜ç®¡æœåŠ¡ï¼Œå®ƒå¯ä»¥ä¸ºæˆ‘ä»¬å¿«é€Ÿéƒ¨ç½²å’Œç®¡ç†ç”Ÿäº§çº§çš„Kubernetes é›†ç¾¤ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œéƒ¨ç½²åœ¨äº‘å‚å•†çš„Kubernetesé›†ç¾¤ä¸€èˆ¬éƒ½æ˜¯éœ€è¦ä»˜è´¹çš„ã€‚

k3sæ˜¯è½»é‡çº§çš„Kubernetesé›†ç¾¤ï¼Œå®ƒé€šè¿‡åˆ é™¤Kubernetesä¸­ä¸å¿…è¦çš„ç¬¬ä¸‰æ–¹å­˜å‚¨é©±åŠ¨ï¼Œåˆ é™¤ä¸äº‘å‚å•†äº¤äº’çš„ä»£ç ï¼Œå°†Kubernetesç»„ä»¶åˆå¹¶åˆ°äº†ä¸åˆ°100 MBçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å»è¿è¡Œï¼Œè¿™å°±å‡å°‘äº†äºŒè¿›åˆ¶æ–‡ä»¶ä¸å†…å­˜å ç”¨çš„å¤§å°ã€‚è¿™ä¸ªæ–¹æ¡ˆé€‚ç”¨äºç‰©è”ç½‘ç­‰å¯¹èµ„æºåƒç´§çš„ç¯å¢ƒï¼Œä¹Ÿå¯ä»¥ç”¨äºCIåŠå¼€å‘ç¯å¢ƒã€‚

è€Œk3dæ˜¯ä¸€ä¸ªç¤¾åŒºé©±åŠ¨çš„é¡¹ç›®ï¼Œå®ƒå¯¹k3sè¿›è¡Œäº†å°è£…ï¼Œä»è€Œå¯ä»¥åœ¨Dockerä¸­åˆ›å»ºå•èŠ‚ç‚¹æˆ–å¤šèŠ‚ç‚¹çš„ Kubernetes é›†ç¾¤ã€‚ä½¿ç”¨k3dï¼Œæˆ‘ä»¬ç”¨ä¸€è¡ŒæŒ‡ä»¤å°±å¯ä»¥åˆ›å»ºKubernetes é›†ç¾¤ã€‚è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±ç”¨k3dæ­å»ºå¤šèŠ‚ç‚¹ã€è½»é‡çº§çš„Kubernetesé›†ç¾¤ï¼Œå®ç°å¼€å‘ä¸æµ‹è¯•çš„ç›®çš„ã€‚

## å®‰è£… k3d

k3dçš„å®‰è£…æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥æ‰§è¡Œå¦‚ä¸‹çš„è„šæœ¬å®Œæˆã€‚

```plain
curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
```

å¦‚æœæƒ³å®‰è£…k3dçš„æŒ‡å®šç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æŒ‡ä»¤ã€‚

```plain
curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | TAG=v5.4.6 bash
```

åœ¨Macä¸­ï¼Œè¿˜å¯ä»¥ä½¿ç”¨brewè¿›è¡Œå®‰è£…ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚å…¶ä»–çš„å®‰è£…æ–¹å¼ä½ å¯ä»¥æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://k3d.io/v5.4.6/)ã€‚

```plain
brew install k3d
```

å®‰è£…å®Œæˆåï¼Œæ‰§è¡Œ k3d version å¯ä»¥æŸ¥çœ‹k3dçš„ç‰ˆæœ¬ä¿¡æ¯å’Œk3dä¾èµ–çš„k3sçš„ç‰ˆæœ¬ã€‚

```plain
Â» k3d version                                                                                                                   jackson@bogon
k3d version v5.4.6
k3s version v1.24.4-k3s1 (default)
```

k3dçš„ä½¿ç”¨æ–¹æ³•æˆ‘æ¨èä½ é˜…è¯»å®ƒçš„[å®˜æ–¹æ–‡æ¡£](https://k3d.io/v5.4.6/)å’Œk3dç»´æŠ¤çš„ä¸€ä¸ªäº¤äº’å¼çš„[demoé¡¹ç›®](https://github.com/k3d-io/k3d-demo)ã€‚è¿™ä¸ªdemoé¡¹ç›®å¯ä»¥å®Œæˆä»é›†ç¾¤çš„åˆ›å»ºåˆ°é”€æ¯ï¼Œä»Podçš„åˆ›å»ºåˆ°é”€æ¯çš„å®Œæ•´é“¾è·¯ã€‚ä½ å¯ä»¥ä¸‹è½½k3d-demoé¡¹ç›®çš„ä»£ç ï¼Œç„¶åmake demoï¼Œè·Ÿç€å®ƒçš„æç¤ºä¸€æ­¥æ­¥å»å­¦ä¹ ã€‚

```plain
git clone https://github.com/k3d-io/k3d-demo
make demo
```

ä¸‹é¢è®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•å€ŸåŠ©k3dæ­å»ºKubernetesé›†ç¾¤ã€‚

é¦–å…ˆæ‰§è¡Œk3d cluster createå‘½ä»¤ï¼Œåˆ›å»ºKubernetesé›†ç¾¤ã€‚

```plain
Â» k3d cluster create demo --api-port 6550 --servers 1 --c 3 --port 8080:80@loadbalancer --wait
INFO[0000] portmapping '8080:80' targets the loadbalancer: defaulting to [servers:*:proxy agents:*:proxy]
INFO[0000] Prep: Network
INFO[0000] Created network 'k3d-demo'
INFO[0000] Created image volume k3d-demo-images
INFO[0000] Starting new tools node...
INFO[0000] Starting Node 'k3d-demo-tools'
INFO[0007] Creating node 'k3d-demo-server-0'
INFO[0007] Creating node 'k3d-demo-agent-0'
INFO[0007] Creating node 'k3d-demo-agent-1'
INFO[0007] Creating node 'k3d-demo-agent-2'
INFO[0007] Creating LoadBalancer 'k3d-demo-serverlb'
INFO[0007] Using the k3d-tools node to gather environment information
INFO[0007] Starting new tools node...
INFO[0007] Starting Node 'k3d-demo-tools'
INFO[0009] Starting cluster 'demo'
INFO[0009] Starting servers...
INFO[0009] Starting Node 'k3d-demo-server-0'
INFO[0013] Starting agents...
INFO[0014] Starting Node 'k3d-demo-agent-2'
INFO[0014] Starting Node 'k3d-demo-agent-1'
INFO[0014] Starting Node 'k3d-demo-agent-0'
INFO[0019] Starting helpers...
INFO[0019] Starting Node 'k3d-demo-serverlb'
INFO[0026] Injecting records for hostAliases (incl. host.k3d.internal) and for 6 network members into CoreDNS configmap...
INFO[0028] Cluster 'demo' created successfully!
```

å…¶ä¸­ï¼Œè¿è¡Œå‚æ•°api-portç”¨äºæŒ‡å®šKubernetes API serverå¯¹å¤–æš´éœ²çš„ç«¯å£ã€‚serversç”¨äºæŒ‡å®šmaster nodeçš„æ•°é‡ã€‚agentsç”¨äºæŒ‡å®šworker nodeçš„æ•°é‡ã€‚portç”¨äºæŒ‡å®šå®¿ä¸»æœºç«¯å£åˆ°Kubernetesé›†ç¾¤çš„æ˜ å°„ã€‚åé¢æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œå½“æˆ‘ä»¬è®¿é—®å®¿ä¸»æœº8080ç«¯å£æ—¶ï¼Œå®é™…ä¸Šä¼šè¢«è½¬å‘åˆ°é›†ç¾¤çš„80ç«¯å£ã€‚waitå‚æ•°è¡¨ç¤ºç­‰å¾…k3sé›†ç¾¤å‡†å¤‡å°±ç»ªåæŒ‡ä»¤æ‰ä¼šè¿”å›ã€‚

åˆ›å»ºå¥½ Kubernetes é›†ç¾¤åï¼Œæ‰§è¡Œ k3d cluster list å¯ä»¥çœ‹åˆ°å½“å‰åˆ›å»ºå¥½çš„demoé›†ç¾¤ä¿¡æ¯ã€‚

```plain
Â» k3d cluster list  
NAME   SERVERS   AGENTS   LOADBALANCER
demo   1/1       3/3      true
```

è¦è®©kubectlå®¢æˆ·ç«¯èƒ½å¤Ÿè®¿é—®åˆ°æˆ‘ä»¬åˆšåˆ›å»ºå¥½çš„Kubernetesé›†ç¾¤ï¼Œéœ€è¦ä½¿ç”¨ä¸‹é¢çš„æŒ‡ä»¤ï¼ŒæŠŠå½“å‰é›†ç¾¤çš„é…ç½®ä¿¡æ¯åˆå¹¶åˆ°kubeconfigæ–‡ä»¶ä¸­ï¼Œç„¶ååˆ‡æ¢Kubernetes Contextï¼Œä½¿kubectlèƒ½å¤Ÿè®¿é—®åˆ°æ–°å»ºçš„é›†ç¾¤ã€‚

```plain
k3d kubeconfig merge demo --kubeconfig-merge-default --kubeconfig-switch-context
```

æ¥ä¸‹æ¥ï¼Œè¾“å…¥kubectl get nodesï¼Œå¯ä»¥çœ‹åˆ°å½“å‰é›†ç¾¤çš„Master Nodeä¸Worker Nodeã€‚

```plain
Â» kubectl get nodes                                       jackson@localhost
NAME                STATUS   ROLES                  AGE     VERSION
k3d-demo-server-0   Ready    control-plane,master   2m36s   v1.24.4+k3s1
k3d-demo-agent-1    Ready    <none>                 2m31s   v1.24.4+k3s1
k3d-demo-agent-0    Ready    <none>                 2m31s   v1.24.4+k3s1
k3d-demo-agent-2    Ready    <none>                 2m31s   v1.24.4+k3s1
```

## éƒ¨ç½²Worker Deployment

åˆ›å»ºå¥½é›†ç¾¤ä¹‹åï¼Œæˆ‘ä»¬è¦æƒ³åŠæ³•å°†å½“å‰çš„çˆ¬è™«é¡¹ç›®éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ä¸­ã€‚é¦–å…ˆè®©æˆ‘ä»¬ä¹¦å†™ä¸€ä¸ªcrawl-worker.yamlæ–‡ä»¶ï¼Œç”¨å®ƒæ¥åˆ›å»ºDeploymentèµ„æºï¼Œç®¡ç†æˆ‘ä»¬çš„å®¹å™¨crawl-workerã€‚æè¿°æ–‡ä»¶å¦‚ä¸‹ã€‚

```plain
apiVersion: apps/v1
kind: Deployment
metadata:
  name: crawler-deployment
  labels:
    app: crawl-worker
spec:
  replicas: 3
  selector:
    matchLabels:
      app: crawl-worker
  template:
    metadata:
      labels:
        app: crawl-worker
    spec:
      containers:
      - name: crawl-worker
        image: crawler:local
        command:
          - sh
          - -c
          - "./crawler worker --podip=${MY_POD_IP}"
        ports:
        - containerPort: 8080
        env:
          - name: MY_POD_IP
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
```

ä¸‹é¢æˆ‘ä»¬æ¥æŒ¨ä¸ªè§£é‡Šä¸€ä¸‹æ–‡ä»¶ä¸­çš„ä¿¡æ¯ã€‚

- apiVersionï¼šå®šä¹‰åˆ›å»ºå¯¹è±¡æ—¶ä½¿ç”¨çš„ Kubernetes APIçš„ç‰ˆæœ¬ã€‚apiVersionçš„ä¸€èˆ¬å½¢å¼ä¸º `<GROUP_NAME>/<VERSION>`ã€‚åœ¨è¿™é‡Œï¼ŒDeploymentçš„API groupä¸ºappï¼Œç‰ˆæœ¬ä¸ºv1ã€‚è€ŒPodå¯¹è±¡ç”±äºä½äºç‰¹æ®Šçš„æ ¸å¿ƒç»„ï¼Œå¯ä»¥çœç•¥æ‰ `<GROUP_NAME>`ã€‚apiVersionçš„è®¾è®¡æœ‰åŠ©äºKuberneteså¯¹ä¸åŒçš„èµ„æºè¿›è¡Œå•ç‹¬çš„ç®¡ç†ï¼Œä¹Ÿæœ‰åŠ©äºå¼€å‘è€…åˆ›å»ºKubernetesä¸­å®éªŒæ€§è´¨çš„èµ„æºè¿›è¡Œæµ‹è¯•ã€‚
- kind è¡¨ç¤ºå½“å‰èµ„æºçš„ç±»å‹ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å®šä¹‰çš„æ˜¯Deploymentå¯¹è±¡ã€‚ä¹‹å‰æˆ‘ä»¬æåˆ°è¿‡ï¼ŒDeploymentåœ¨Podä¹‹ä¸Šå¢åŠ äº†è‡ªåŠ¨æ‰©å®¹ã€è‡ªåŠ¨ä¿®å¤å’Œæ»šåŠ¨æ›´æ–°ç­‰åŠŸèƒ½ã€‚
- [metadata.name](http://metadata.name)ï¼šå®šä¹‰deploymentçš„åå­—ã€‚
- metadata.labelsï¼šç»™ Deployment çš„æ ‡ç­¾ã€‚
- specï¼šä»£è¡¨å¯¹è±¡çš„æœŸæœ›çŠ¶æ€ã€‚
- spec.replicasï¼šä»£è¡¨åˆ›å»ºå’Œç®¡ç†çš„ Pod çš„æ•°é‡ã€‚
- spec.selectorï¼šå®šä¹‰äº† Deployment Controller è¦ç®¡ç†å“ªäº›Podã€‚è¿™é‡Œå®šä¹‰çš„é€šå¸¸æ˜¯æ ‡ç­¾åŒ¹é…çš„Podï¼Œæ»¡è¶³è¯¥æ ‡ç­¾çš„Podä¼šè¢«çº³å…¥åˆ°Deployment Controller ä¸­å»ç®¡ç†ã€‚
- spec.template.metadataï¼šå®šä¹‰äº†Podçš„å±æ€§ï¼Œåœ¨ä¸Šä¾‹ä¸­ï¼Œå®šä¹‰äº†æ ‡ç­¾å±æ€§crawl-workerã€‚
- spec.template.spec.containersï¼šå®šä¹‰äº†Podä¸­çš„å®¹å™¨å±æ€§ã€‚
- [spec.template.spec.containers.name](http://spec.template.spec.containers.name)ï¼šå®šä¹‰äº†å®¹å™¨çš„åå­—ã€‚
- spec.template.spec.containers.imageï¼šå®šä¹‰äº†å®¹å™¨çš„é•œåƒã€‚
- spec.template.spec.containers.commandï¼šå®šä¹‰äº†å®¹å™¨çš„å¯åŠ¨å‘½ä»¤ã€‚æ³¨æ„ï¼Œå¯åŠ¨å‚æ•°ä¸­çš„ `${MY_POD_IP}` æ˜¯ä»ç¯å¢ƒå˜é‡ä¸­è·å–çš„MY\_POD\_IPå¯¹åº”çš„å€¼ã€‚
- spec.template.spec.container.portsï¼šæè¿°æœåŠ¡æš´éœ²çš„ç«¯å£ä¿¡æ¯ï¼Œæ–¹ä¾¿å¼€å‘è€…æ›´å¥½åœ°ç†è§£æœåŠ¡ï¼Œæ²¡æœ‰å®é™…çš„ä½œç”¨ã€‚
- spec.template.spec.container.envï¼šå®šä¹‰å®¹å™¨çš„ç¯å¢ƒå˜é‡ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç¯å¢ƒå˜é‡MY\_POD\_IPï¼Œå¹¶ä¸”ä¼ é€’äº†ä¸€ä¸ªç‰¹æ®Šçš„å€¼ï¼Œå³Podçš„IPã€‚å¹¶å°†è¯¥ç¯å¢ƒå˜é‡çš„å€¼ä¼ é€’åˆ°äº†è¿è¡Œå‚æ•°å½“ä¸­ã€‚

è¿™é‡Œæˆ‘å°†Podçš„IPä¼ å…¥åˆ°ç¨‹åºä¸­æœ‰ä¸€ä¸ªå¦™å¤„ã€‚æˆ‘ä»¬ä¹‹å‰åœ¨ç¨‹åºè¿è¡Œæ—¶æ‰‹åŠ¨ä¼ å…¥äº†Workerçš„IDï¼Œè¿™åœ¨å¼€å‘ç¯å¢ƒä¸­æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ä½†æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›Workerèƒ½å¤ŸåŠ¨æ€æ‰©å®¹ï¼Œè¿™æ—¶å°±ä¸èƒ½æ‰‹åŠ¨åœ°æŒ‡å®šIDäº†ã€‚æˆ‘ä»¬éœ€è¦è®©ç¨‹åºåœ¨å¯åŠ¨åè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªIDï¼Œå¹¶ä¸”è¿™ä¸ªIDåœ¨åˆ†å¸ƒå¼èŠ‚ç‚¹ä¸­æ˜¯å”¯ä¸€çš„ã€‚

ä¸€äº›åŒå­¦å¯èƒ½ä¼šæƒ³åˆ°æŠŠæ—¶é—´å½“ä½œå”¯ä¸€çš„IDï¼Œä¾‹å¦‚ä½¿ç”¨ `time.Now().UnixNano()` æ¥è·å–Unixæ—¶é—´æˆ³ã€‚ä½†æ˜¯ï¼Œç¨‹åºè·å–åˆ°çš„æ—¶é—´ä»ç„¶å¯èƒ½æ˜¯é‡å¤çš„ï¼Œè™½ç„¶æ¦‚ç‡å¾ˆå°ã€‚å¦ä¸€äº›åŒå­¦å¯èƒ½ä¼šæƒ³åˆ°åˆ©ç”¨MySQLçš„è‡ªå¢ä¸»é”®æˆ–è€…å€ŸåŠ©etcdç­‰åˆ†å¸ƒå¼ç»„ä»¶æ¥å¾—åˆ°åˆ†å¸ƒå¼IDã€‚è¿™å½“ç„¶æ˜¯ä¸€ç§è§£å†³åŠæ³•ï¼Œä¸è¿‡å´ä¾èµ–äº†é¢å¤–çš„å¤–éƒ¨æœåŠ¡ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘é€‰æ‹©äº†ä¸€ç§æ›´ä¸ºå·§å¦™çš„æ–¹æ³•ï¼Œå³å€ŸåŠ©Kubernetesä¸­Podçš„IPä¸é‡å¤çš„ç‰¹æ€§ï¼Œå°†Podçš„IPä¼ é€’åˆ°ç¨‹åºä¸­ï¼Œå€ŸåŠ©å”¯ä¸€çš„Pod IPç”Ÿæˆå”¯ä¸€çš„IDã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

```plain
WorkerCmd.Flags().StringVar(
		&podIP, "podip", "", "set worker id")

WorkerCmd.Flags().StringVar(
		&workerID, "id", "", "set worker id")

var podIP string

if workerID == "" {
		if podIP != "" {
			ip := generator.GetIDbyIP(podIP)
			workerID = strconv.Itoa(int(ip))
		} else {
			workerID = fmt.Sprintf("%d", time.Now().UnixNano())
		}
	}

// generator/generator.go
func GetIDbyIP(ip string) uint32 {
	var id uint32
	binary.Read(bytes.NewBuffer(net.ParseIP(ip).To4()), binary.BigEndian, &id)
	return id
}
```

ç°åœ¨workerIDçš„é»˜è®¤å€¼ä¸ºç©ºï¼Œå¦‚æœæ²¡æœ‰ä¼ é€’id flagï¼Œä¹Ÿæ²¡æœ‰ä¼ é€’podip flagï¼Œè¿™ä¸€èˆ¬æ˜¯çº¿ä¸‹å¼€å‘åœºæ™¯ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨Unixæ—¶é—´æˆ³æ¥ç”ŸæˆIDã€‚å¦‚æœæ²¡æœ‰ä¼ é€’id flagï¼Œä½†ä¼ é€’äº†podip flagï¼Œæˆ‘ä»¬åˆ™è¦åˆ©ç”¨Pod IPçš„å”¯ä¸€æ€§ç”ŸæˆIDã€‚

å‡†å¤‡å¥½ç¨‹åºä»£ç ä¹‹åï¼Œè®©æˆ‘ä»¬ç”ŸæˆWorkerçš„é•œåƒï¼Œå¹¶æ‰“ä¸Šé•œåƒtagï¼šcrawler:localã€‚ è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæˆ‘ä»¬å¹¶æ²¡æœ‰å’Œä¹‹å‰ä¸€æ ·å°†é•œåƒå˜ä¸ºcrawler:latestã€‚ è¿™æ˜¯å› ä¸ºå¯¹äºcrawler:latestçš„é•œåƒï¼ŒKubernetesä¼šåœ¨DockerHubä¸­é»˜è®¤[æ‹‰å–æœ€æ–°çš„é•œåƒ](https://kubernetes.io/docs/concepts/containers/images/#imagepullpolicy-defaulting)ï¼Œè¿™ä¼šå¯¼è‡´é•œåƒæ‹‰å–å¤±è´¥ï¼Œè¿™é‡Œæˆ‘ä»¬å¸Œæœ› Kubernetes ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„é•œåƒã€‚

```plain
docker image build -t crawler:local .
```

æ¥ç€ï¼Œå°†é•œåƒå¯¼å…¥åˆ°k3dé›†ç¾¤ä¸­ã€‚

```plain
k3d image import crawler:local -c demo
```

å‡†å¤‡å¥½é•œåƒä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»º Kubernetes ä¸­çš„ Deployment èµ„æºï¼Œç”¨å®ƒç®¡ç†æˆ‘ä»¬çš„WorkerèŠ‚ç‚¹äº†ã€‚å…·ä½“æ­¥éª¤æ˜¯ï¼Œæ‰§è¡Œkubectl applyï¼Œå‘Šè¯‰ Kubernetes æˆ‘ä»¬å¸Œæœ›åˆ›å»ºçš„Deploymentèµ„æºçš„ä¿¡æ¯ã€‚

```plain
kubectl apply -f crawl-worker.yaml
```

æ¥ä¸‹æ¥ï¼Œè¾“å…¥kubectl get poï¼ŒæŸ¥çœ‹default namespaceä¸­Podçš„ä¿¡æ¯ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒKuberneteså·²ç»ä¸ºæˆ‘ä»¬åˆ›å»ºäº†3ä¸ªPodã€‚

```plain
Â» kubectl get po
NAME                                  READY   STATUS    RESTARTS   AGE
crawler-deployment-6744cc644b-2mm9r   1/1     Running   0          88s
crawler-deployment-6744cc644b-bgjqc   1/1     Running   0          88s
crawler-deployment-6744cc644b-84t9g   1/1     Running   0          88s
```

ä½¿ç”¨kubectl logs æ‰“å°å‡ºæŸä¸€ä¸ªPodçš„æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°WorkerèŠ‚ç‚¹å·²ç»æ­£å¸¸åœ°è¿è¡Œäº†ã€‚

è¿˜è¦æ³¨æ„çš„æ˜¯ï¼Œå½“å‰WorkerèŠ‚ç‚¹çš„å¯åŠ¨ä¾èµ–äºMySQLå’Œetcdè¿™ä¸¤ä¸ªç»„ä»¶ã€‚å’Œä¹‹å‰ä¸€æ ·ï¼Œæˆ‘ä»¬æ˜¯å…ˆå°†è¿™ä¸¤ä¸ªç»„ä»¶åœ¨å®¿ä¸»æœºä¸­Dockerå¯åŠ¨çš„ï¼Œåç»­è¿™ä¸¤ä¸ªç»„ä»¶å¯ä»¥éƒ¨ç½²åˆ°Kubernetesé›†ç¾¤ä¸­ã€‚

```plain
Â» kubectl logs -f crawler-deployment-6744cc644b-2mm9r  
{"level":"INFO","ts":"2022-12-24T07:50:09.301Z","caller":"worker/worker.go:101","msg":"log init end"}
{"level":"INFO","ts":"2022-12-24T07:50:09.301Z","caller":"worker/worker.go:109","msg":"proxy list: [<http://192.168.0.105:8888> <http://192.168.0.105:8888>] timeout: 3000"}
{"level":"DEBUG","ts":"2022-12-24T07:50:09.311Z","caller":"worker/worker.go:152","msg":"grpc server config,{RegistryAddress::2379 RegisterTTL:60 RegisterInterval:15 Name:go.micro.server.worker ClientTimeOut:10}"}
{"level":"DEBUG","ts":"2022-12-24T07:50:09.313Z","caller":"worker/worker.go:223","msg":"start http server listening on :8080 proxy to grpc server;:9090"}
2022-12-24 07:50:09  file=worker/worker.go:196 level=info Starting [service] go.micro.server.worker
2022-12-24 07:50:09  file=v4@v4.9.0/service.go:96 level=info Server [grpc] Listening on [::]:9090
2022-12-24 07:50:09  file=grpc@v1.2.0/grpc.go:913 level=info Registry [etcd] Registering node: go.micro.server.worker-1
```

ç°åœ¨è®©æˆ‘ä»¬æ¥å°è¯•ä»å¤–éƒ¨è®¿é—®ä¸€ä¸‹WorkerèŠ‚ç‚¹ã€‚  
ç”±äºç½‘ç»œå­˜åœ¨éš”ç¦»æ€§ï¼Œå½“å‰è¦æƒ³ä»å¤–éƒ¨è®¿é—®WorkerèŠ‚ç‚¹è¿˜æ²¡æœ‰é‚£ä¹ˆå®¹æ˜“ã€‚ä½†æ˜¯æˆ‘ä»¬ä¹‹å‰è®²è¿‡ï¼ŒPodä¹‹é—´æ˜¯å¯ä»¥é€šè¿‡IPç›¸äº’è¿æ¥çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰“ç®—é€šè¿‡ä¸€ä¸ª Pod å®¹å™¨è®¿é—®WorkerèŠ‚ç‚¹ã€‚ç”±äºå½“å‰æˆ‘ä»¬ç”Ÿæˆçš„crawlerå®¹å™¨å†…æ²¡æœ‰å†…ç½®ç½‘ç»œè¯·æ±‚å·¥å…·ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬ç”¨kubectl runå¯åŠ¨ä¸€ä¸ªå¸¦æœ‰curlå·¥å…·çš„é•œåƒcurlimages/curlï¼Œå¹¶å‘½åä¸ºmycurlpodã€‚

```plain
kubectl run mycurlpod --image=curlimages/curl -i --tty -- sh
```

å¦‚ä¸‹ï¼Œæˆ‘ä»¬ä»ç„¶ä½¿ç”¨kubectl get pod æŸ¥çœ‹å½“å‰Worker Pod çš„IPåœ°å€ï¼Œ-o wide å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¾—åˆ°æ›´è¯¦ç»†çš„Podä¿¡æ¯ã€‚

```plain
Â» kubectl get pod -o wide                                                                                                      jackson@bogon
NAME                                  READY   STATUS    RESTARTS   AGE   IP           NODE               NOMINATED NODE   READINESS GATES
crawler-deployment-6744cc644b-2mm9r   1/1     Running   0          40m   10.42.4.9    k3d-new-agent-1    <none>           <none>
crawler-deployment-6744cc644b-bgjqc   1/1     Running   0          40m   10.42.5.10   k3d-new-agent-0    <none>           <none>
crawler-deployment-6744cc644b-84t9g   1/1     Running   0          40m   10.42.3.6    k3d-demo-agent-2   <none>           <none>
mycurlpod                             1/1     Running   0          26m   10.42.4.10   k3d-new-agent-1    <none>           <none>
```

æ¥ç€è¿›å…¥åˆ°mycurlpodä¸­ï¼Œåˆ©ç”¨WorkerèŠ‚ç‚¹çš„Pod IPåœ°å€è¿›è¡Œè®¿é—®ï¼ŒæˆåŠŸè¿”å›é¢„æœŸæ•°æ®ã€‚

```plain

Â» curl -H "content-type: application/json" -d '{"name": "john"}' http://10.42.4.9:8080/greeter/hello
{"greeting":"Hello "}
```

## éƒ¨ç½²Worker Service

ä¸è¿‡åˆ°è¿™é‡Œè¿˜ä¸èƒ½æ”¾æ¾è­¦æƒ•ã€‚æˆ‘ä»¬ä¸ŠèŠ‚è¯¾è¯´è¿‡ï¼ŒPodçš„IPä¼šéšæ—¶å‘ç”Ÿå˜åŒ–ï¼Œä¸ºäº†æœ‰ç¨³å®šçš„IPæ¥è®¿é—®æˆ‘ä»¬çš„Workerä¸Masterï¼Œæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªæ–‡ä»¶crawl-worker-service.yamlï¼Œç”¨å®ƒæ¥æè¿°Serviceèµ„æºã€‚Serviceé»˜è®¤çš„ç±»å‹ä¸ºClusterIPï¼Œè¯¥ç±»å‹çš„Service IPåªèƒ½å¤Ÿåœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ã€‚

```plain
kind: Service
apiVersion: v1
metadata:
  name: crawl-worker
  labels:
    app: crawl-worker
spec:
  selector:
    app: crawl-worker
  ports:
  - port: 8080
    name: http
  - port: 9090
    name: grpc
```

æè¿°Serviceèµ„æºä¸ä¹‹å‰æè¿°Deploymentèµ„æºéå¸¸ç±»ä¼¼ã€‚

- kind: Serviceï¼šæŒ‡çš„æ˜¯å½“å‰çš„Kubernetesèµ„æºç±»å‹ä¸ºServiceã€‚
- apiVersion: v1ï¼šä»£è¡¨apiVersionçš„ç‰ˆæœ¬æ˜¯v1ï¼Œç”±äºServiceæ˜¯æ ¸å¿ƒç±»å‹ï¼Œå› æ­¤çœç•¥æ‰äº†API GROUPçš„å‘½åå‰ç¼€ã€‚
- [metadata.name](http://metadata.name)ï¼šå½“å‰Serviceçš„åå­—ã€‚
- metadata.labelsï¼šå½“å‰Serviceçš„æ ‡ç­¾ã€‚
- spec.selectorï¼šé€‰æ‹©å™¨ï¼Œè¡¨ç¤ºå½“å‰Serviceç®¡ç†å“ªäº›åå°æœåŠ¡ï¼Œåªæœ‰æ ‡ç­¾ä¸º app: crawl-workerçš„Podæ‰ä¼šå—åˆ°è¯¥Serviceçš„ç®¡ç†ï¼Œè¿™äº›Podå°±æ˜¯æˆ‘ä»¬çš„WorkerèŠ‚ç‚¹ã€‚
- spec.ports.portï¼šå½“å‰Serviceç›‘å¬çš„ç«¯å£å·ã€‚ä¾‹å¦‚ã€‚port: 8080æŒ‡çš„æ˜¯å½“å‰Serviceä¼šç›‘å¬8080ç«¯å£ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“å¤–éƒ¨è®¿é—®è¯¥Serviceçš„8080ç«¯å£æ—¶ï¼Œä¼šå°†è¯·æ±‚è½¬å‘ç»™åç«¯æœåŠ¡ç›¸åŒçš„ç«¯å£ã€‚
- spec.ports.port.nameï¼šæè¿°äº†å½“å‰Serviceç«¯å£è§„åˆ™çš„åå­—ã€‚

æ¥ä¸‹æ¥ä½¿ç”¨ kubectl apply åˆ›å»ºServiceèµ„æºï¼Œå¹¶ä½¿ç”¨kubectl get serviceå¾—åˆ°Serviceçš„Cluster-IPåœ°å€ã€‚

```plain
Â» kubectl  apply -f crawl-worker-service.yaml
Â» kubectl get service 
NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE
crawl-worker   ClusterIP   10.43.245.115    <none>        8080/TCP,9090/TCP   13m
```

åŒæ ·ï¼Œåœ¨åŒ…å«curlå·¥å…·çš„mycurlpodä¸­ï¼Œè®¿é—®Serviceæš´éœ²çš„ClusterIPï¼Œè¿™æ—¶è¯·æ±‚ä¼šè´Ÿè½½å‡è¡¡åˆ°åç«¯ä»»æ„ä¸€ä¸ªWorkerèŠ‚ç‚¹ä¸­ã€‚

```plain
$ curl -H "content-type: application/json" -d '{"name": "john"}' http://10.43.245.115:8080/greeter/hello
```

## éƒ¨ç½² Master Deployment

MasterèŠ‚ç‚¹çš„éƒ¨ç½²å’ŒWorkerèŠ‚ç‚¹çš„éƒ¨ç½²éå¸¸ç±»ä¼¼ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œåˆ›å»ºcrawler-master.yamlæ–‡ä»¶ï¼Œæè¿°Deploymentèµ„æºçš„ä¿¡æ¯ã€‚è¿™é‡Œå’ŒWorker Deploymentä¸åŒçš„ä¸»è¦æ˜¯ç›¸å…³çš„åå­—å’Œç¨‹åºå¯åŠ¨çš„å‘½ä»¤ã€‚

```plain
apiVersion: apps/v1
kind: Deployment
metadata:
  name: crawler-master-deployment
  labels:
    app: crawl-master
spec:
  replicas: 1
  selector:
    matchLabels:
      app: crawl-master
  template:
    metadata:
      labels:
        app: crawl-master
    spec:
      containers:
      - name: crawl-master
        image: crawler:local
        command:
          - sh
          - -c
          - "./crawler master --podip=${MY_POD_IP}"
        ports:
        - containerPort: 8081
        env:
        - name: MY_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
```

## éƒ¨ç½² Master Service

åŒæ ·åœ°ï¼Œä¸ºäº†èƒ½å¤Ÿç”¨å›ºå®šåœ°IPè®¿é—®Masterï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºMaster Serviceã€‚æ–°å»ºcrawl-master-service.yamlæ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼ŒportæŒ‡çš„æ˜¯Serviceç›‘å¬çš„ç«¯å£80ï¼Œè¿™æ˜¯é»˜è®¤çš„HTTPç«¯å£ï¼Œè€ŒtargetPortæŒ‡çš„æ˜¯è½¬å‘åˆ°åç«¯æœåŠ¡å™¨çš„ç«¯å£ï¼Œä¹Ÿå°±æ˜¯MasteræœåŠ¡çš„HTTPç«¯å£8081ã€‚

```plain
kind: Service
apiVersion: v1
metadata:
  name: crawl-master
  labels:
    app: crawl-master
spec:
  selector:
    app: crawl-master
  type: NodePort
  ports:
  - port: 80
    targetPort: 8081
    name: http
  - port: 9091
    name: grpc
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜æ˜¯åˆ©ç”¨kubectl applyåˆ›å»ºMaster Serviceã€‚

```plain
Â» kubectl  apply -f crawl-master-service.yaml
```

ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥å’ŒWorkerä¸€æ ·ï¼Œåˆ©ç”¨Serviceè®¿é—®Masreræš´éœ²çš„æ¥å£äº†ã€‚

## åˆ›å»º Ingress

ä¸‹é¢è®©æˆ‘ä»¬æ›´è¿›ä¸€æ­¥ï¼Œå°è¯•åœ¨å®¿ä¸»æœºä¸­è®¿é—®é›†ç¾¤çš„MasteræœåŠ¡ã€‚ç”±äºèµ„æºå…·æœ‰éš”ç¦»æ€§ï¼Œä¹‹å‰æˆ‘ä»¬ä¸€ç›´éƒ½æ˜¯åœ¨é›†ç¾¤å†…ä»ä¸€ä¸ªPodä¸­å»è®¿é—®å¦ä¸€ä¸ªPodã€‚ç°åœ¨æˆ‘ä»¬å¸Œæœ›åœ¨é›†ç¾¤å¤–éƒ¨ä½¿ç”¨HTTPè®¿é—®MasteræœåŠ¡ã€‚è¦å®ç°è¿™ä¸ªç›®æ ‡ï¼Œå¯ä»¥ä½¿ç”¨Ingressèµ„æºã€‚

å…·ä½“åšæ³•æ˜¯ï¼Œåˆ›å»ºingress.yamlï¼Œåœ¨ingress.yamlæ–‡ä»¶ä¸­ä¹¦å†™ç›¸å…³çš„HTTPè·¯ç”±è§„åˆ™ï¼Œæ ¹æ®ä¸åŒçš„åŸŸåå’ŒURLå°†è¯·æ±‚è·¯ç”±åˆ°åç«¯ä¸åŒçš„Serviceä¸­ã€‚

```plain
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: crawler-ingress
spec:
  rules:
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: crawl-master
                port:
                  number: 80
```

spec.http.pathsä¸­æè¿°äº†Ingressçš„è·¯ç”±è§„åˆ™ï¼Œæˆ‘ä»¬å¯¹åº”ä¸Šé¢è¿™ä¸ªä¾‹å­è§£è¯»ä¸€ä¸‹ã€‚

- spec.http.paths.path è¡¨ç¤ºURLåŒ¹é…çš„è·¯å¾„ã€‚
- spec.http.paths.pathType è¡¨ç¤ºURLåŒ¹é…çš„ç±»å‹ä¸ºå‰ç¼€åŒ¹é…ã€‚
- [spec.http.paths.backend.service.name](http://spec.http.paths.backend.service.name) è¡¨ç¤ºè·¯ç”±åˆ°åç«¯çš„Serviceçš„åå­—ã€‚
- spec.http.paths.backend.service.port è¡¨ç¤ºè·¯ç”±åˆ°åç«¯çš„Serviceçš„ç«¯å£ã€‚

å…¶å®è¦ä½¿ç”¨Ingressçš„åŠŸèƒ½ï¼Œå…‰æ˜¯å®šä¹‰ingress.yamlä¸­çš„è·¯ç”±è§„åˆ™æ˜¯ä¸è¡Œçš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦Ingress Controlleræ§åˆ¶å™¨æ¥å®ç°è¿™äº›è·¯ç”±è§„åˆ™çš„é€»è¾‘ã€‚ä½†æ˜¯å’ŒKubernetesä¸­å†…ç½®çš„Controllerä¸åŒï¼ŒIngress Controller æ˜¯å¯ä»¥çµæ´»é€‰æ‹©çš„ï¼Œæ¯”è¾ƒæœ‰åçš„Ingress ControlleråŒ…æ‹¬Nginxã€Kongç­‰ã€‚å¦‚æœä½ æƒ³ä½¿ç”¨è¿™äº›Ingress Controller ï¼Œéœ€è¦å•ç‹¬å®‰è£…ã€‚

å¥½åœ¨ï¼Œk3dé»˜è®¤ä¸ºæˆ‘ä»¬å†…ç½®äº†[traefik](https://github.com/containous/traefik) Ingress Controllerï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸éœ€è¦å†é¢å¤–å®‰è£…äº†ã€‚åªè¦åˆ›å»ºIngressèµ„æºï¼Œå°±å¯ä»¥ç›´æ¥è®¿é—®å®ƒäº†ã€‚

```plain
Â» kubectl  apply -f ingress.yaml
```

ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬åœ¨å®¿ä¸»æœºä¸­è®¿é—®é›†ç¾¤ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬è®¿é—®çš„æ˜¯8080ç«¯å£ï¼Œå› ä¸ºæˆ‘åœ¨åˆ›å»ºé›†ç¾¤æ—¶æŒ‡å®šäº†ç«¯å£çš„æ˜ å°„ï¼Œæ‰€ä»¥å½“å‰8080ç«¯å£çš„è¯·æ±‚ä¼šè½¬å‘åˆ°é›†ç¾¤çš„80ç«¯å£ä¸­ã€‚ç„¶åæ ¹æ®IngressæŒ‡å®šçš„è§„åˆ™ï¼Œè¯·æ±‚ä¼šè¢«è½¬å‘åˆ°åç«¯çš„Master Serviceå½“ä¸­ã€‚

```plain
Â» curl -H "content-type: application/json" -d '{"id":"zjx","name": "douban_book_list"}' http://127.0.0.1:8080/crawler/resource
```

æ­¤å¤–ï¼ŒIngressè¿˜å¯ä»¥è®¾ç½®è§„åˆ™ï¼Œè®©ä¸åŒçš„åŸŸåèµ°ä¸åŒçš„åŸŸåè§„åˆ™ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚

```plain
Â» curl -H "content-type: application/json" -d '{"id":"zjx","name": "douban_book_list"}' http://zjx.vx1131052403.com:8080/crawler/resource
```

## åˆ›å»º ConfigMap

åˆ°è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬çš„é…ç½®æ–‡ä»¶éƒ½æ˜¯æ‰“åŒ…åœ¨é•œåƒä¸­çš„ï¼Œå¦‚æœæƒ³è¦ä¿®æ”¹ç¨‹åºçš„å¯åŠ¨å‚æ•°ä¼šéå¸¸éº»çƒ¦ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©Kubernetesä¸­çš„ConfigMapèµ„æºï¼Œå°†é…ç½®æŒ‚è½½åˆ°å®¹å™¨å½“ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ›´çµæ´»åœ°ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œè€Œä¸å¿…æ¯ä¸€æ¬¡éƒ½æ‰“åŒ…æ–°çš„é•œåƒäº†ã€‚

å…·ä½“åšæ³•å¦‚ä¸‹ã€‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªConfigMapèµ„æºï¼ŒæŠŠå®ƒæ”¾åˆ°é»˜è®¤çš„namespaceä¸­ã€‚åœ¨Dataä¸‹ï¼Œå¯¹åº”åœ°è¾“å…¥æ–‡ä»¶åconfig.tomlå’Œæ–‡ä»¶å†…å®¹ã€‚

```plain
apiVersion: v1
kind: ConfigMap
metadata:
  name: crawler-config
  namespace: default
data:
  config.toml: |-
    logLevel = "debug"
    
    [fetcher]
    timeout = 3000
    proxy = ["http://192.168.0.105:8888", "http://192.168.0.105:8888"]
    
    
    [storage]
    sqlURL = "root:123456@tcp(192.168.0.105:3326)/crawler?charset=utf8"
    
    [GRPCServer]
    HTTPListenAddress = ":8080"
    GRPCListenAddress = ":9090"
    ID = "1"
    RegistryAddress = "192.168.0.105:2379"
    RegisterTTL = 60
    RegisterInterval = 15
    ClientTimeOut   = 10
    Name = "go.micro.server.worker"
    
    [MasterServer]
    RegistryAddress = "192.168.0.105:2379"
    RegisterTTL = 60
    RegisterInterval = 15
    ClientTimeOut   = 10
    Name = "go.micro.server.master"
```

ç„¶åï¼Œä¿®æ”¹crawler-master.yamlæ–‡ä»¶ï¼Œå°†ConfigMapæŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚

```plain
apiVersion: apps/v1
kind: Deployment
metadata:
  name: crawler-master-deployment
  labels:
    app: crawl-master
spec:
  replicas: 1
  selector:
    matchLabels:
      app: crawl-master
  template:
    metadata:
      labels:
        app: crawl-master
    spec:
      containers:
      - name: crawl-master
        image: crawler:local
        command:
          - sh
          - -c
          - "./crawler master --podip=${MY_POD_IP}  --config=/app/config/config.toml"
        ports:
        - containerPort: 8081
        env:
        - name: MY_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: crawler-config
          mountPath: /app/config/
      volumes:
      - name: crawler-config
        configMap:
          name: crawler-config
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œspec.template.spec.volumesåˆ›å»ºäº†ä¸€ä¸ªå­˜å‚¨å·crawler-configï¼Œå®ƒçš„å†…å®¹æ¥è‡ªäºåä¸ºcrawler-configçš„ConfigMapã€‚æ¥ç€ï¼Œspec.template.spec.containers.volumeMountsè¡¨ç¤ºå°†è¯¥å­˜å‚¨å·æŒ‚è½½åˆ°å®¹å™¨çš„/app/configç›®å½•ä¸‹ï¼Œè¿™æ ·ç¨‹åºå°±èƒ½å¤Ÿé¡ºåˆ©ä½¿ç”¨ConfigMapä¸­çš„é…ç½®æ–‡ä»¶äº†ã€‚

## æ€»ç»“

è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•å®‰è£…Kubernetesé›†ç¾¤ï¼Œç„¶åä½¿ç”¨k3då·¥å…·æ­å»ºèµ·äº†è½»é‡çº§çš„Kubernetesé›†ç¾¤ï¼Œä»è€Œåœ¨å¼€å‘ç¯å¢ƒä¸­æ¨¡æ‹Ÿäº†å¤šèŠ‚ç‚¹çš„Kubernetesé›†ç¾¤ã€‚

æˆ‘ä»¬è¿˜ä¹¦å†™äº†æ ¸å¿ƒçš„YAMLæè¿°æ–‡ä»¶ï¼Œåˆ›å»ºäº†Kubernetesä¸­çš„èµ„æºï¼ŒåŒ…æ‹¬Deploymentã€Podã€Serviceã€Ingressã€ConfigMapç­‰ï¼Œå°†æˆ‘ä»¬çš„çˆ¬è™«é¡¹ç›®éƒ¨ç½²åˆ°äº†Kubernetesä¸­ã€‚

å¦‚æœä½ æ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦è¿™äº› Kubernetes æè¿°æ–‡ä»¶ï¼Œå¯èƒ½ä¼šè§‰å¾—éå¸¸ç¹çï¼Œä½†æ˜¯ç†Ÿæ‚‰ä¹‹åå°±ä¼šå˜å¾—ç®€å•äº†ã€‚åˆ›å»ºäº†è¿™äº›èµ„æºä¹‹åï¼Œå‰©ä¸‹æœåŠ¡çš„æ‰©å®¹ã€ç»´æŠ¤å°±å¯ä»¥äº¤ç»™å¼ºå¤§çš„Kubernetesæ¥ç®¡ç†äº†ã€‚

ï¼ˆè¿™èŠ‚è¯¾ä¸­çš„ YAML æ–‡ä»¶åœ¨[æœ€æ–°ä»£ç åˆ†æ”¯](https://github.com/dreamerjackson/crawler)çš„Kubernetesæ–‡ä»¶å¤¹ä¸­ã€‚ ï¼‰

## è¯¾åé¢˜

å­¦å®Œè¿™èŠ‚è¯¾ï¼Œè¯·ä½ æ€è€ƒä¸‹é¢è¿™ä¸ªé—®é¢˜ã€‚

æˆ‘ä»¬è¿™èŠ‚è¯¾ä¹¦å†™çš„YAMLæ–‡ä»¶ä¸­çš„èµ„æºå¯¹è±¡ï¼Œéƒ½æ˜¯Kubernetesä¸­å®šä¹‰å¥½çš„èµ„æºç±»å‹ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä¸å¯ä»¥åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ç±»å‹ï¼Œè‡ªå·±å»æ§åˆ¶å®ƒçš„ç”Ÿå‘½å‘¨æœŸå‘¢ï¼Ÿ

æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºç•™ä¸‹è‡ªå·±æ€è€ƒçš„ç»“æœï¼Œä¹Ÿå¯ä»¥æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™å¯¹è¿™ä¸ªè¯é¢˜æ„Ÿå…´è¶£çš„åŒäº‹å’Œæœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ3ï¼‰</strong></div><ul>
<li><span>Geek_2c2c44</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¿™ä¸ªé›†ç¾¤é«˜åº¦ä¾èµ–etcdï¼Œ ä½†æ˜¯è¿™é‡Œéƒ¨ç½²çš„etcdæœ¬èº«ä¼¼ä¹å¥½åƒæ²¡æœ‰å¾ˆå¼ºçš„å¯ç”¨æ€§ä¿éšœï¼Ÿ</p>2024-01-31</li><br/><li><span>åŒ—åº­</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œåœ¨ä½¿ç”¨kubectl get nodeå‘½ä»¤åå‡ºç°äº†è¿™æ ·çš„é”™è¯¯ï¼šcouldn&#39;t get current server API group list: Get &quot;https:&#47;&#47;host.docker.internal:6550&#47;api?timeout=32s&quot;: dial tcp 10.0.0.35:6550: connectex: A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond.
è¿™æ˜¯ä»€ä¹ˆåŸå› å‘¢</p>2023-03-14</li><br/><li><span>Geek_7873ee</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>master åªéƒ¨ç½²äº†ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä»£ç ä¸­å¯¹masteråšçš„é«˜å¯ç”¨ï¼Œå°±ä¸æ˜¯çœ‹ä¸å‡ºæ¥æ•ˆæœäº†å˜›</p>2023-02-15</li><br/>
</ul>