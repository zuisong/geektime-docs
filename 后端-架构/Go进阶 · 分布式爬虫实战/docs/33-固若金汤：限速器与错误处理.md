ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ‘å»ºå‹‹ã€‚

æˆ‘ä»¬å‰é¢çš„è¯¾ç¨‹ï¼Œç”±äºä¸€ç›´éƒ½æ˜¯ä¸åŠ é™åˆ¶åœ°å¹¶å‘çˆ¬å–ç›®æ ‡ç½‘ç«™ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´è¢«æœåŠ¡å™¨å°ç¦ã€‚ä¸ºäº†èƒ½å¤Ÿæ­£å¸¸ç¨³å®šåœ°è®¿é—®æœåŠ¡å™¨ï¼Œæˆ‘ä»¬è¿™èŠ‚è¯¾è¦ç»™é¡¹ç›®å¢åŠ ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½ï¼šé™é€Ÿå™¨ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜ä¼šä»‹ç»åœ¨Goä¸­è¿›è¡Œé”™è¯¯å¤„ç†çš„æœ€ä½³å®è·µã€‚

## é™é€Ÿå™¨

å…ˆæ¥çœ‹é™é€Ÿå™¨ã€‚å¾ˆå¤šæƒ…å†µä¸‹ï¼Œä¸ç®¡ä½ æ˜¯æƒ³é˜²æ­¢é»‘å®¢çš„æ”»å‡»ï¼Œé˜²æ­¢å¯¹èµ„æºçš„è®¿é—®è¶…è¿‡æœåŠ¡å™¨çš„æ‰¿è½½èƒ½åŠ›ï¼Œäº¦æˆ–æ˜¯é˜²æ­¢åœ¨çˆ¬è™«é¡¹ç›®ä¸­è¢«æœåŠ¡å™¨å°æ€ï¼Œæˆ‘ä»¬éƒ½éœ€è¦å¯¹æœåŠ¡è¿›è¡Œé™é€Ÿã€‚

åœ¨çˆ¬è™«é¡¹ç›®ä¸­ï¼Œä¿æŒåˆé€‚çš„é€Ÿç‡ä¹Ÿæœ‰åˆ©äºæˆ‘ä»¬ç¨³å®šåœ°çˆ¬å–æ•°æ®ã€‚å¤§å¤šæ•°é™é€Ÿçš„æœºåˆ¶æ˜¯**ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆToken Bucketï¼‰**æ¥å®Œæˆçš„ã€‚

ä»¤ç‰Œæ¡¶ç®—æ³•çš„åŸç†å¾ˆç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œä½ å»æµ·åº•æåƒé¥­ï¼Œé‡Œé¢åªæœ‰10ä¸ªåº§ä½ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™10ä¸ªåº§ä½çœ‹ä½œæ˜¯æ¡¶çš„å®¹é‡ã€‚ç°åœ¨ï¼Œç”±äºåº§ä½å·²ç»æ»¡äº†ï¼ŒæœåŠ¡å‘˜å°±å¸®æˆ‘ä»¬å«äº†ä¸ªå·ï¼Œæˆ‘ä»¬éšå³è¿›å…¥åˆ°äº†ç­‰å¾…çš„çŠ¶æ€ã€‚

ä¸€æ¡Œå®¢äººåƒå®Œä¹‹åï¼Œä¸‹ä¸€ä½å¹¶ä¸èƒ½é©¬ä¸Šå°±åº§ï¼Œå› ä¸ºæœåŠ¡å‘˜è¿˜éœ€è¦æ”¶æ‹¾é¥­æ¡Œã€‚ç”±äºæœåŠ¡å‘˜çš„æ•°é‡æœ‰é™ï¼Œå› æ­¤å³ä¾¿å¾ˆå¤šæ¡Œå®¢äººåŒæ—¶åƒå®Œï¼Œä¹Ÿä¸èƒ½ç«‹å³é‡Šæ”¾å‡ºæ‰€æœ‰çš„åº§ä½ã€‚å¦‚æœæ¯5åˆ†é’Ÿæ”¶æ‹¾å¥½ä¸€æ¡Œï¼Œé‚£ä¹ˆâ€œ1æ¡Œ/5åˆ†é’Ÿâ€å°±å«åšä»¤ç‰Œæ”¾å…¥æ¡¶ä¸­çš„é€Ÿç‡ã€‚è½®åˆ°æˆ‘ä»¬å°±é¤æ—¶ï¼Œæˆ‘ä»¬å æ®äº†ä¸€ä¸ªåº§ä½ï¼Œä¹Ÿå°±æ˜¯å æ®äº†ä¸€ä¸ªä»¤ç‰Œï¼Œè¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥å¼€åƒäº†ã€‚

é€šè¿‡ä¸Šé¢ç®€åŒ–çš„æ¡ˆä¾‹èƒ½å¤Ÿçœ‹åˆ°ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•é€šè¿‡æ§åˆ¶æ¡¶çš„å®¹é‡å’Œä»¤ç‰Œæ”¾å…¥æ¡¶ä¸­çš„é€Ÿç‡ï¼Œä¿è¯äº†ç³»ç»Ÿèƒ½åœ¨æœ€å¤§çš„å¤„ç†å®¹é‡ä¸‹æ­£å¸¸å·¥ä½œã€‚åœ¨Goä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®˜æ–¹çš„é™é€Ÿå™¨å®ç°ï¼š[golang.org/x/time/rate](http://golang.org/x/time/rate)ï¼Œå®ƒæä¾›äº†ä¸€äº›ç®€å•å¥½ç”¨çš„APIã€‚

åœ¨ [golang.org/x/time/rate](http://golang.org/x/time/rate) åº“ä¸­ï¼Œç±»å‹Limitè¡¨ç¤ºé€Ÿç‡ï¼Œä»£è¡¨æ¯ç§’é’Ÿæ”¾å…¥åˆ°æ¡¶ä¸­çš„ä»¤ç‰Œä¸ªæ•°ã€‚NewLimiterå‡½æ•°ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’çš„æ˜¯Limité€Ÿç‡ï¼Œç¬¬äºŒä¸ªå‚æ•°bè¡¨ç¤ºæ¡¶çš„æ•°é‡ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåº“ä¸­è¿˜æœ‰Everyå‡½æ•°ï¼Œå®ƒçš„å‚æ•°æ˜¯ä¸¤ä¸ªä»¤ç‰Œä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œå®ƒä¼šè½¬åŒ–ä¸ºå¯¹åº”çš„Limité€Ÿç‡ã€‚

```plain
// Limit defines the maximum frequency of some events.  Limit is
// represented as number of events per second.  A zero Limit allows no
// events.
type Limit float64

// NewLimiter returns a new Limiter that allows events up to rate r
// and permits bursts of at most b tokens.
func NewLimiter(r Limit, b int) *Limiter

// Every converts a minimum time interval between events to a Limit.
func Every(interval time.Duration) Limit
```

ç”Ÿæˆäº†Limiterä¹‹åï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šè°ƒç”¨Limiterçš„Waitæ–¹æ³•ç­‰å¾…å¯ç”¨çš„ä»¤ç‰Œã€‚å…¶ä¸­ï¼Œå‚æ•°ctxå¯ä»¥è®¾ç½®è¶…æ—¶é€€å‡ºçš„æ—¶é—´ï¼Œå®ƒå¯ä»¥é¿å…åç¨‹ä¸€ç›´é™·åœ¨å µå¡çŠ¶æ€ä¸­ã€‚

```plain
func (lim *Limiter) Wait(ctx context.Context) (err error) {
	return lim.WaitN(ctx, 1)
}
```

å¦‚æœæ²¡æœ‰å¯ç”¨çš„ä»¤ç‰Œï¼Œå½“å‰åç¨‹ä¼šé™·å…¥åˆ°å µå¡çŠ¶æ€ã€‚æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ä¸€ä¸‹Limiterçš„ä½¿ç”¨æ–¹æ³•ã€‚  
åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œrate.NewLimiterç”Ÿæˆäº†ä¸€ä¸ªé™é€Ÿå™¨ï¼Œå…¶ä¸­æ¡¶çš„æœ€å¤§å®¹é‡ä¸º2ï¼Œrate.Limit(1)è¡¨ç¤ºæ¯éš”1ç§’é’Ÿå‘æ¡¶ä¸­æ”¾å…¥1ä¸ªä»¤ç‰Œã€‚

```plain
package main

import (
	"context"
	"fmt"
	"golang.org/x/time/rate"
	"time"
)

func main() {
	limit := rate.NewLimiter(rate.Limit(1), 2)
	for {
		if err := limit.Wait(context.Background()); err == nil {
			fmt.Println(time.Now().Format("2006-01-02 15:04:05"))
		}
	}
}
```

æˆ‘ä»¬ç”¨ä¸€ä¸ªforå¾ªç¯æ‰“å°å½“å‰æ—¶é—´ä¼šå‘ç°ï¼Œå‰ä¸¤æ¬¡æ‰“å°æ˜¯åœ¨åŒä¸€ç§’ï¼Œè¿™æ˜¯å› ä¸ºæ¡¶ä¸­ä¸€å¼€å§‹æœ‰ä¸¤ä¸ªä»¤ç‰Œå¯ä»¥ç”¨ã€‚ä¹‹åï¼Œæ¯ä¸€æ¬¡æ‰“å°éƒ½éœ€è¦é—´éš”ä¸€ç§’ï¼Œå› ä¸ºæ¯éš”ä¸€ç§’é’Ÿæ‰ä¼šå¾€æ¡¶ä¸­å¡«å……ä¸€ä¸ªä»¤ç‰Œã€‚

```plain
2022-11-22 22:31:51
2022-11-22 22:31:51
2022-11-22 22:31:52
2022-11-22 22:31:53
2022-11-22 22:31:54
```

æˆ‘ä»¬å†å°è¯•ä½¿ç”¨rate.Everyæ¥ç”ŸæˆLimité€Ÿç‡ï¼š

```plain
func main() {
	limit := rate.NewLimiter(rate.Every(500*time.Millisecond), 2)
	for {
		if err := limit.Wait(context.Background()); err == nil {
			fmt.Println(time.Now().Format("2006-01-02 15:04:05"))
		}
	}
}
```

å…¶ä¸­ï¼Œrate.Every(500\*time.Millisecond)è¡¨ç¤ºæ¯500æ¯«ç§’æ”¾å…¥ä¸€ä¸ªä»¤ç‰Œï¼Œæ¢ç®—è¿‡æ¥å°±æ˜¯æ¯ç§’é’Ÿæ”¾å…¥2ä¸ªä»¤ç‰Œã€‚

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç°åœ¨æ¯ç§’é’Ÿéƒ½ä¼šè¾“å‡ºä¸¤æ¡è®°å½•ï¼š

```plain
2022-11-22 22:39:28
2022-11-22 22:39:28
2022-11-22 22:39:29
2022-11-22 22:39:29
2022-11-22 22:39:30
2022-11-22 22:39:30
```

åˆšæ‰æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†é™é€Ÿå™¨Limiterçš„åŸºæœ¬ç”¨æ³•ã€‚ä½†æœ‰æ—¶å€™æˆ‘ä»¬è¿˜ä¼šæœ‰ä¸€äº›æ›´å¤æ‚çš„éœ€æ±‚ï¼Œä¾‹å¦‚æœ‰å¤šå±‚é™é€Ÿå™¨çš„éœ€æ±‚ï¼ˆç»†ç²’åº¦é™é€Ÿå™¨é™åˆ¶æ¯ç§’çš„è¯·æ±‚ï¼Œç²—ç²’åº¦é™é€Ÿå™¨é™åˆ¶æ¯åˆ†é’Ÿã€æ¯å°æ—¶æˆ–æ¯å¤©çš„è¯·æ±‚ï¼‰ã€‚

å‡è®¾æˆ‘ä»¬çš„çˆ¬è™«é¡¹ç›®å¸Œæœ›æ¯åˆ†é’Ÿåªèƒ½å¤Ÿè®¿é—®10æ¬¡ç›®æ ‡ç½‘ç«™ï¼Œä½†æ˜¯åªæœ‰æ¯åˆ†é’Ÿçš„é™åˆ¶æ˜¯ä¸å¤Ÿçš„ã€‚å› ä¸ºè¿™æ ·æˆ‘ä»¬å¯èƒ½ä¼šä¸€ç§’é’Ÿç›´æ¥è®¿é—®10æ¬¡ï¼Œè¿™æ ·æœåŠ¡å™¨å°±èƒ½ç›´æ¥æ£€æµ‹å‡ºæˆ‘ä»¬æ˜¯çˆ¬è™«æœºå™¨äººäº†ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ§åˆ¶ä¸€ä¸‹ç¬æ—¶çš„è¯·æ±‚é‡ï¼Œä¾‹å¦‚æ¯ç§’é’Ÿè®¿é—®çš„é¢‘ç‡ä¸è¶…è¿‡0.5æ¬¡ã€‚è¿™é‡Œæˆ‘ä¹Ÿå€Ÿé‰´äº†ã€ŠConcurrency in Goã€‹ä¸­å¤šå±‚é™é€Ÿå™¨çš„è®¾è®¡ï¼Œåœ¨æ–°çš„LimiteråŒ…ä¸­å°†é™é€Ÿå™¨æŠ½è±¡ä¸ºäº†RateLimiteræ¥å£ï¼Œ[golang.org/x/time/rate](http://golang.org/x/time/rate)å®ç°çš„Limiterè‡ªåŠ¨å°±å®ç°äº†è¯¥æ¥å£ï¼š

```plain
package limiter

type RateLimiter interface {
	Wait(context.Context) error
	Limit() rate.Limit
}
```

å¤šå±‚é™é€Ÿå™¨å¯¹åº”çš„multiLimiterå¦‚ä¸‹ï¼š

```plain

type multiLimiter struct {
	limiters []RateLimiter
}

func MultiLimiter(limiters ...RateLimiter) *multiLimiter {
	byLimit := func(i, j int) bool {
		return limiters[i].Limit() < limiters[j].Limit()
	}
	sort.Slice(limiters, byLimit)
	return &multiLimiter{limiters: limiters}
}

func (l *multiLimiter) Wait(ctx context.Context) error {
	for _, l := range l.limiters {
		if err := l.Wait(ctx); err != nil {
			return err
		}
	}
	return nil
}

func (l *multiLimiter) Limit() rate.Limit {
	return l.limiters[0].Limit()
}
```

å…¶ä¸­ï¼ŒMultiLimiterå‡½æ•°ç”¨äºèšåˆå¤šä¸ªRateLimiterï¼Œå¹¶å°†é€Ÿç‡ç”±å°åˆ°å¤§æ’åºã€‚Waitæ–¹æ³•ä¼šå¾ªç¯éå†å¤šå±‚é™é€Ÿå™¨multiLimiterä¸­æ‰€æœ‰çš„é™é€Ÿå™¨å¹¶ç´¢è¦ä»¤ç‰Œï¼Œåªæœ‰å½“æ‰€æœ‰çš„é™é€Ÿå™¨è§„åˆ™éƒ½æ»¡è¶³åï¼Œæ‰ä¼šæ­£å¸¸æ‰§è¡Œåç»­çš„æ“ä½œã€‚

æœ€åï¼Œæˆ‘ä»¬ç”Ÿæˆå¤šå±‚é™é€Ÿå™¨å¹¶æŠŠå®ƒæ”¾å…¥çˆ¬è™«ä»»åŠ¡Taskä¸­ï¼Œæ¯ä¸€ä¸ªçˆ¬è™«ä»»åŠ¡å¯èƒ½æœ‰ä¸åŒçš„é™é€Ÿã€‚è¿™é‡Œç”Ÿæˆé€Ÿç‡çš„å‡½æ•°ç”¨Perè¿›è¡Œäº†å°è£…ï¼Œä¾‹å¦‚limiter.Per(20, 1\*time.Minute)ä»£è¡¨é€Ÿç‡æ˜¯æ¯1åˆ†é’Ÿè¡¥å……20ä¸ªä»¤ç‰Œã€‚

```plain
func main(){
	//2ç§’é’Ÿ1ä¸ª
	secondLimit := rate.NewLimiter(limiter.Per(1, 2*time.Second), 1)
	//60ç§’20ä¸ª
	minuteLimit := rate.NewLimiter(limiter.Per(20, 1*time.Minute), 20)
	multiLimiter := limiter.MultiLimiter(secondLimit, minuteLimit)

	seeds := make([]*collect.Task, 0, 1000)
	seeds = append(seeds, &collect.Task{
		Property: collect.Property{
			Name: "douban_book_list",
		},
		Fetcher: f,
		Storage: storage,
		Limit:   multiLimiter,
	})
}

func Per(eventCount int, duration time.Duration) rate.Limit {
	return rate.Every(duration / time.Duration(eventCount))
}
```

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±ä¸å†éœ€è¦åœ¨çˆ¬å–æ•°æ®æ—¶å›ºå®šä¼‘çœ äº†ï¼Œåªè¦ä½¿ç”¨é™é€Ÿå™¨æ¥æ§åˆ¶é€Ÿåº¦çš„å°±å¯ä»¥äº†ã€‚

## éšæœºä¼‘çœ 

ä¸è¿‡ï¼Œå¦‚æœä½¿ç”¨å¤šå±‚é™é€Ÿå™¨ï¼Œæˆ‘ä»¬è®¿é—®æœåŠ¡å™¨çš„é¢‘ç‡ä¼šè¿‡äºç¨³å®šã€‚ä¸ºäº†æ¨¡æ‹Ÿäººç±»çš„è¡Œä¸ºï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨é™é€Ÿå™¨çš„åŸºç¡€ä¸Šï¼Œå¢åŠ éšæœºä¼‘çœ ã€‚

å¦‚ä¸‹æ‰€ç¤ºï¼Œå‡è®¾è®¾ç½®çš„r.Task.WaitTimeä¸º2ç§’ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨äº†éšæœºæ•°ï¼Œè·å–0-2000æ¯«ç§’ä¹‹é—´çš„ä»»ä½•ä¸€ä¸ªæ•´æ•°ä½œä¸ºä¼‘çœ æ—¶é—´ã€‚

```plain
func (r *Request) Fetch() ([]byte, error) {
	if err := r.Task.Limit.Wait(context.Background()); err != nil {
		return nil, err
	}
	// éšæœºä¼‘çœ ï¼Œæ¨¡æ‹Ÿäººç±»è¡Œä¸º
	sleeptime := rand.Int63n(r.Task.WaitTime * 1000)
	time.Sleep(time.Duration(sleeptime) * time.Millisecond)
	return r.Task.Fetcher.Get(r)
}
```

ä¸‹é¢æ˜¯æˆ‘é€šè¿‡å¤šå±‚é™é€Ÿå™¨å’Œéšæœºä¼‘çœ æœºåˆ¶æˆåŠŸçˆ¬å–åˆ°çš„å›¾ä¹¦æ•°æ®ï¼š  
![å›¾ç‰‡](https://static001.geekbang.org/resource/image/5b/e6/5b433923e28754f926da1681d07f8be6.png?wh=1680x936)

ä¸Šè¿°ä»£ç ä½äº[v0.2.8](https://github.com/dreamerjackson/crawler)ã€‚

## é”™è¯¯å¤„ç†

ä»‹ç»äº†é™é€Ÿå™¨ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€çœ‹Goé¡¹ç›®ä¸­å¦ä¸€ä¸ªé‡è¦çš„è¯é¢˜ï¼šé”™è¯¯å¤„ç†ã€‚åœ¨Goä¸­ï¼Œé”™è¯¯å¤„ç†ä¹Ÿæ˜¯è¢«äººåæ§½å¾—æ¯”è¾ƒå¤šçš„åœ°æ–¹ã€‚å¾ˆå¤šæ‰¹è¯„è€…æ ¹æ®è‡ªå·±è¿‡å»çš„ç¼–ç¨‹è¯­è¨€çš„ç»éªŒï¼Œè§‰å¾—åœ¨Goä¸­æœ‰å¾ˆå¤šä¸‹é¢è¿™æ ·çš„é”™è¯¯å¤„ç†è¯­æ³•ã€‚

```plain
if err != nil{
	return err
}
```

ç¡®å®ï¼Œåœ¨æ—¥å¸¸å®è·µä¸­ï¼Œä»£ç å¸¸å¸¸ä¼šå˜å¾—åƒä¸‹é¢è¿™æ ·ï¼Œè®©äººæ„Ÿè§‰ä¸å¤ªä¼˜é›…ã€‚

```plain
func doSomething() error {
	if err := foo(); err != nil {
		return err
	}
	if err := bar(); err != nil {
		return err
	}
	if err := baz(); err != nil {
		return err
	}
	return nil
}
```

ç„¶è€Œï¼ŒGoè¿™ç§é”™è¯¯å¤„ç†æ–¹å¼å®é™…ä¸Šæ˜¯æ·±æ€ç†Ÿè™‘çš„ç»“æœï¼Œå®ƒä¹Ÿæ˜¯æœ‰è½¯ä»¶å·¥ç¨‹çš„ç»éªŒä½œä¸ºæŒ‡å¯¼çš„ã€‚åƒJavaæˆ–C++ä¸­é”™è¯¯å¤„ç†çš„tryâ€¦catchè¯­å¥è¢«[å®è·µè¯æ˜](https://250bpm.com/blog:4/)é¢ä¸´å¯è¯»æ€§å·®ã€éš¾ä»¥ç²¾å‡†åœ°å¤„ç†é”™è¯¯ç­‰é—®é¢˜ã€‚è€Œåœ¨Goè¯­è¨€ä¸­ï¼Œé”™è¯¯å¤„ç†çš„å“²å­¦æ˜¯å¼ºåˆ¶è°ƒç”¨è€…æ£€æŸ¥é”™è¯¯ï¼Œè¿™å°±ä¿è¯äº†ä»£ç çš„å¯è¯»æ€§å’Œå¥å£®æ€§ã€‚

è™½ç„¶åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™ç¡®å®ä½¿ Go ä»£ç å˜å¾—å†—é•¿ï¼Œä½†å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›æŠ€æœ¯æ¥æœ€å¤§ç¨‹åº¦åœ°é™ä½é”™è¯¯å¤„ç†çš„é‡å¤æ€§ã€‚

### åŸºæœ¬çš„é”™è¯¯å¤„ç†æ–¹å¼

ç”±äºGoä¸­å…è®¸å¤šè¿”å›å€¼ï¼Œå› æ­¤æœ€å¸¸è§çš„é”™è¯¯å¤„ç†æ–¹å¼æ˜¯å°†å‡½æ•°çš„æœ€åä¸€ä¸ªè¿”å›å€¼ä½œä¸ºerroræ¥å£ï¼Œæ¥å£ä¸­çš„Erroræ–¹æ³•è¿”å›é”™è¯¯çš„ä¿¡æ¯ã€‚

```plain
type error interface {
    Error() string
}
```

è¿™ç§æ–¹å¼ä¼šç”¨errors.Newå‡½æ•°æ¥ç”Ÿæˆä¸€ä¸ªæ–°çš„é”™è¯¯ï¼Œå…¶ä¸­å‚æ•°ä¸ºæœ¬æ¬¡çš„é”™è¯¯ä¿¡æ¯ã€‚

```plain
func (r *Request) Check() error {
	if r.Depth > r.Task.MaxDepth {
		return errors.New("max depth limit reached")
	}
	return nil
}
```

é”™è¯¯çš„ä¿¡æ¯éœ€è¦æ¸…æ™°è¡¨æ˜é”™è¯¯ï¼Œæ–¹ä¾¿å®šä½é—®é¢˜ï¼Œä¾‹å¦‚é€šè¿‡ `open not_here.txt: no such file or directory` ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°çŸ¥é“æ‰“å¼€çš„æ–‡ä»¶ä¸å­˜åœ¨ã€‚  
errors.Newçš„å®ç°éå¸¸ç®€å•ï¼Œå®ƒç”Ÿæˆäº†ä¸€ä¸ªå†…ç½®çš„errorStringç»“æ„ä½“ï¼Œè€Œ errorString åˆ™å®ç°äº†Error()æ–¹æ³•ã€‚

```plain
func New(text string) error {
	return &errorString{text}
}

type errorString struct {
	s string
}

func (e *errorString) Error() string {
	return e.s
}
```

æˆ‘ä»¬ä¹Ÿå¯ä»¥é‡‡ç”¨fmt.Errorfæ¥åšä¸€äº›æ ¼å¼åŒ–çš„è¾“å‡ºï¼š

```plain
func (b BrowserFetch) Get(request *Request) ([]byte, error) {
	client := &http.Client{
		Timeout: b.Timeout,
	}
	if b.Proxy != nil {
		transport := http.DefaultTransport.(*http.Transport)
		transport.Proxy = b.Proxy
		client.Transport = transport
	}
	req, err := http.NewRequest("GET", request.Url, nil)
	if err != nil {
		return nil, fmt.Errorf("get url failed:%v", err)
	}
	...
}
```

fmt.Errorfçš„å¥½å¤„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¹‹å‰é”™è¯¯çš„åŸºç¡€ä¸Šï¼Œé™„åŠ ä¸€äº›é¢å¤–çš„é”™è¯¯ä¿¡æ¯ã€‚  
ç”±äºæ¥å£çš„é›¶å€¼ä¸ºnilï¼Œå› æ­¤åœ¨å¤„ç†å‡½æ•°è¿”å›çš„é”™è¯¯æ—¶ï¼Œæˆ‘ä»¬è¦é€šè¿‡error != nilæ¥åˆ¤æ–­æ˜¯å¦æœ‰é”™è¯¯äº§ç”Ÿï¼š

```plain
func (s *Crawler) CreateWork() {
	for {
		...
		body, err := req.Fetch()
		if err != nil {
			s.Logger.Error("can't fetch ",
				zap.Error(err),
				zap.String("url", req.Url),
			)
			s.SetFailure(req)
			continue
		}
}
```

æ­¤å¤–ï¼Œåœ¨è¿›è¡Œé”™è¯¯å¤„ç†æ—¶ï¼Œæˆ‘ä»¬è¿˜è¦è°¨æ…åœ°å¤„ç†è‡ªå®šä¹‰çš„é”™è¯¯ã€‚æˆ‘ä»¬ä¹‹å‰åœ¨ä»‹ç»æ¥å£æ—¶æåˆ°è¿‡ï¼Œå½“æ¥å£ä¸ºnilæ—¶ï¼Œæ„å‘³ç€æ¥å£å†…éƒ¨çš„åŠ¨æ€ç±»å‹å’ŒåŠ¨æ€æ•°æ®éƒ½ä¸ºnilã€‚æ‰€ä»¥ä¸‹é¢fooå‡½æ•°è¿”å›çš„errä¸ä¸ºnilï¼š

```plain
func foo() error {
	var err *os.PathError 
	return err
}
func main() {
	err := foo()
	fmt.Println(err != nil) // true
}
```

å¦ä¸€ä¸ªç±»ä¼¼çš„ä¾‹å­ä¹Ÿæ˜¯å¦‚æ­¤ï¼š

```plain
func GenerateError(flag bool) error {
    var genErr StatusErr
    if flag {
        genErr = StatusErr{
            Status: NotFound,
        }
    }
    return genErr
}

func main() {
    err := GenerateError(true) // **true**
    fmt.Println(err != nil)
    err = GenerateError(false) // **true**
    fmt.Println(err != nil)
}
```

é‚£æˆ‘ä»¬åº”è¯¥æ€ä¹ˆå¤„ç†è¿”å›çš„é”™è¯¯å‘¢ï¼Ÿåº”è¯¥ç›´æ¥return err è®©ä¸Šå±‚åŒºå¤„ç†ï¼Ÿè¿˜æ˜¯åº”è¯¥å…ˆå¯¹é”™è¯¯è¿›è¡Œä¸€äº›ç‰¹æ®Šçš„å¤„ç†?

åœ¨å®è·µä¸­æˆ‘ä»¬ç»å¸¸çœ‹åˆ°ä¸€äº›å¯¹é”™è¯¯åå¤ã€æ— æ„ä¹‰çš„å¤„ç†ï¼Œæœ€å…¸å‹çš„å°±æ˜¯æ—¥å¿—å¤„ç†ã€‚æˆ‘ä»¬å½“å‰çš„é¡¹ç›®ä¹Ÿå­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œå½“çˆ¬å–ç½‘ç«™è¶…æ—¶æ—¶ï¼Œä¼šåœ¨å¤šä¸ªåœ°æ–¹æ‰“å°é”™è¯¯ä¿¡æ¯ï¼Œè¿™æ—¶å¸¸æ˜¯å¤šä½™çš„ã€‚

```plain
{"level":"ERROR","ts":"2022-11-22T00:22:57.549+0800","caller":"collect/collect.go:74","msg":"fetch failed","error":"Get \\"<https://book.douban.com/subject/1008145/\\>": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"}
{"level":"ERROR","ts":"2022-11-22T00:22:57.549+0800","caller":"engine/schedule.go:263","msg":"can't fetch ","error":"Get \\"<https://book.douban.com/subject/1008145/\\>": context deadline exceeded (Client.Timeout exceeded while awaiting headers)","url":"<https://book.douban.com/subject/1008145/>"}
```

ä½†å¦‚æœæˆ‘ä»¬åªæ˜¯return errï¼Œåˆå®¹æ˜“å¤±å»ä¸€äº›å‡½æ•°å †æ ˆçš„å…³é”®ä¿¡æ¯ï¼Œå˜å¾—åªçŸ¥é“æœ€ç»ˆçš„é”™è¯¯ä¿¡æ¯ï¼Œä¸çŸ¥é“å‡½æ•°çš„è°ƒç”¨é“¾æ˜¯å¦‚ä½•è§¦å‘è¿™ä¸€é—®é¢˜çš„ã€‚å…¶å®ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨fmt.ErrorfåŒ…è£…é¢å¤–çš„é”™è¯¯ä¿¡æ¯æ¥è§£å†³è¿™ä¸€é—®é¢˜ã€‚

### é”™è¯¯é“¾å¤„ç†æ–¹å¼

åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜ä¼šé‡åˆ°ä¸‹é¢è¿™æ ·çš„ç‰¹æ®Šæƒ…å†µã€‚ä¾‹å¦‚tasksæ˜¯ä»»åŠ¡çš„åˆ—è¡¨ï¼Œæˆ‘ä»¬å¸Œæœ›æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œï¼Œå³ä¾¿å‰é¢ä»»åŠ¡æ‰§è¡Œå¤±è´¥ä¹Ÿä¸é€€å‡ºã€‚ä½†æ˜¯ä¸‹é¢è¿™æ ·çš„å†™æ³•å°±åªèƒ½å¾—åˆ°æœ€åä¸€ä¸ªé”™è¯¯çš„ä¿¡æ¯ï¼š

```plain
func doSomething() error {
	var reserr error
	for _, task := range tasks {
		if err = f(task);err != nil{
			reserr = err
		}
	}

	return reserr
}
```

è¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯å¸Œæœ›èƒ½å¤Ÿæ£€æµ‹åˆ°é”™è¯¯é“¾ä¸­çš„æŸä¸€ç±»ç‰¹å®šé”™è¯¯ã€‚ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œfooå‡½æ•°é€šè¿‡è¯»å–Readæ¥è¯»å–æ–‡ä»¶ä¸­çš„ä¿¡æ¯ï¼Œå½“è¯»å–åˆ°æœ€åï¼ŒReadå‡½æ•°ä¼šè¿”å›ç‰¹å®šçš„é”™è¯¯ç±»å‹ï¼šio.EOFã€‚è€Œåœ¨ä¸€äº›åœºæ™¯éœ€è¦æ£€æµ‹ç‰¹æ®Šçš„é”™è¯¯ç±»å‹æ¥è¿›è¡Œé¢å¤–çš„é€»è¾‘å¤„ç†ã€‚

```plain
func foo() error {
  f, _ := os.Open(file)
	if _, err = f.Read(b); err != nil {
		fmt.Println(err == io.EOF) // true
	}
}
```

è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆå¯èƒ½ä¼šæƒ³åˆ°åœ¨ foo å‡½æ•°ä¸­ä½¿ç”¨ fmt.Errorf åŒ…è£¹ä¿¡æ¯ï¼Œä½†æ˜¯å¾ˆå¿«ä¼šå‘ç°ï¼Œç°åœ¨å·²ç»å¤±å»äº†io.EOFè¿™ä¸ªåŸå§‹çš„é”™è¯¯ç±»å‹ã€‚

å…¶å®ï¼Œä¸ºäº†è§£å†³è¿™ç±»é—®é¢˜ï¼ŒGoæ ‡å‡†åº“ä¸ºæˆ‘ä»¬å®ç°äº†ç±»ä¼¼é”™è¯¯åŒ…è£…çš„æœºåˆ¶ï¼Œå®ƒå¯ä»¥å°†å¤šä¸ªé”™è¯¯ç»„æˆä¸€ä¸ªé”™è¯¯é“¾ã€‚è¦ä½¿ç”¨é”™è¯¯åŒ…è£…æœºåˆ¶æœ‰ä¸€ä¸ªéå¸¸ç®€å•çš„æ–¹æ³•ï¼Œé‚£å°±æ˜¯åœ¨ä½¿ç”¨fmt.Errorfçš„æ—¶å€™åŠ å…¥ä¸€ä¸ªç‰¹æ®Šçš„æ ¼å¼åŒ–ç¬¦å·%wï¼Œåœ¨ä¸‹é¢è¿™æ®µä»£ç ä¸­ï¼Œ `fmt.Errorf("read failed,%w", err)` å°†é”™è¯¯errè¿›è¡Œäº†åŒ…è£…ã€‚

è¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡errors.Isæ¥åˆ¤æ–­å½“å‰é”™è¯¯ä¸­æ˜¯å¦åŒ…å«äº†åŸå§‹çš„io.EOFé”™è¯¯ï¼Œerrors.Isä¼šéå†æ•´ä¸ªé”™è¯¯é“¾å¹¶æŸ¥æ‰¾æ˜¯å¦æœ‰ç›¸åŒçš„é”™è¯¯ã€‚

```plain
func foo() error {
  f, _ := os.Open(file)
	if _, err = f.Read(b); err != nil {
		warpErr := fmt.Errorf("read failed,%w", err)
		fmt.Println(errors.Is(warpErr, io.EOF)) // true
	}
}
```

å¦å¤–ï¼Œerrors.Unwrapè¿˜å¯ä»¥å¯¹é”™è¯¯è¿›è¡Œè§£åŒ…ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```plain
func foo() error {
  f, _ := os.Open(file)
	if _, err = f.Read(b); err != nil {
		warpErr := fmt.Errorf("read failed,%w", err)
		err = errors.Unwrap(warpErr)
		fmt.Println(err == io.EOF) //  true
	}
}
```

ä¸€èˆ¬æˆ‘ä»¬ä¼šä½¿ç”¨errors.Isæ¥åˆ¤æ–­é”™è¯¯é“¾ä¸­æ˜¯å¦åŒ…å«äº†æŒ‡å®šçš„é”™è¯¯ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ä¸‹é¢çš„`==` æ¥åˆ¤æ–­ã€‚

```plain
if err == ErrSomething { 
	...
}
```

è¦æ³¨æ„ï¼Œå°½é‡ä¸è¦åœ¨è‡ªå·±çš„APIä¸­è¿”å› `syscall.ENOENT` ä»¥åŠ `io.EOF` è¿™æ ·çš„ç‰¹æ®Šç±»å‹ã€‚å› ä¸ºè¿™é€šå¸¸æ„å‘³ç€è°ƒç”¨è€…éœ€è¦ä¾èµ–æˆ‘ä»¬ä»£ç åº“å½“ä¸­å®šä¹‰çš„ç‰¹å®šç±»å‹ã€‚è¿™åœ¨æ ‡å‡†åº“ä¸­æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœæ˜¯ç¬¬ä¸‰æ–¹åº“è¿”å›äº†ä¸€ä¸ªæ–°çš„é”™è¯¯ç±»å‹ï¼Œæˆ–è€…ä½¿ç”¨fmt.Errorfç­‰æ–¹å¼è¿›è¡Œäº†åŒ…è£¹ï¼Œè¿™ç§ç›¸ç­‰å…³ç³»åœ¨åç»­å°±ä¸å†æˆç«‹äº†ã€‚åŒæ—¶ï¼Œè¿™ç§æ–¹å¼è¿˜å¯èƒ½å¸¦æ¥ä¸å¿…è¦çš„åŒ…ä¹‹é—´çš„ä¾èµ–ã€‚

### å‡å°‘é”™è¯¯å¤„ç†çš„å®è·µ

ä¸ºäº†é¿å…å†—é•¿çš„é”™è¯¯å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›æœ€ä½³å®è·µã€‚

ä¾‹å¦‚ä¸‹é¢çš„HTTPæœåŠ¡å™¨ä¸­ï¼Œæ¯ä¸€ä¸ªè·¯ç”±å‡½æ•°éƒ½éœ€è¦å¤„ç†é”™è¯¯ï¼Œè¿™çœ‹èµ·æ¥å¾ˆç¹çã€‚

```plain
func main() {
    http.HandleFunc("/users", viewUsers)
    http.HandleFunc("/companies", viewCompanies)
}

func viewUsers(w http.ResponseWriter, r *http.Request) {
    ...
    if err := userTemplate.Execute(w, user); err != nil {
        http.Error(w, err.Error(), 500)
    }
}

func viewCompanies(w http.ResponseWriter, r *http.Request) {
    ...
    if err := companiesTemplate.Execute(w, companies); err != nil {
        http.Error(w, err.Error(), 500)
    }
}
```

è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªç±»ä¼¼ä¸­é—´ä»¶çš„å‡½æ•°appHandleræ¥ç»Ÿä¸€å¤„ç†é”™è¯¯ï¼Œæ”¹é€ å¦‚ä¸‹ï¼š

```plain
func main() {
    http.HandleFunc("/users", appHandler(viewUsers))
    http.HandleFunc("/companies", appHandler(viewCompanies))
}

func viewUsers(w http.ResponseWriter, r *http.Request) {
    return userTemplate.Execute(w, user)
}

func viewCompanies(w http.ResponseWriter, r *http.Request) {
    return companiesTemplate.Execute(w, companies)
}

type appHandler func(http.ResponseWriter, *http.Request) error

func (fn appHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) {
    if err := fn(w, r); err != nil {
        http.Error(w, err.Error(), 500)
    }
}
```

ç¬¬äºŒä¸ªæœ€ä½³å®è·µæ˜¯ä½¿ç”¨deferæ¥å‡å°‘é”™è¯¯å¤„ç†ã€‚

ä¾‹å¦‚ï¼Œä¸‹é¢çš„å‡½æ•°åœ¨é”™è¯¯è¿”å›æ—¶ï¼ŒåŒ…è£…å‡½æ•°çš„é€»è¾‘æ˜¯ç›¸åŒçš„ã€‚

```plain
func DoSomeThings(val1 int, val2 string) (string, error) {
    val3, err := doThing1(val1)
    if err != nil {
        return "", fmt.Errorf("in DoSomeThings: %w", err)
    }
    val4, err := doThing2(val2)
    if err != nil {
        return "", fmt.Errorf("in DoSomeThings: %w", err)
    }
    result, err := doThing3(val3, val4)
    if err != nil {
        return "", fmt.Errorf("in DoSomeThings: %w", err)
    }
    return result, nil
}
```

å¦‚æœæˆ‘ä»¬æŠŠè¿™é‡Œçš„å‡½æ•°æ”¹é€ ä¸ºä½¿ç”¨deferï¼Œä¼šæ›´ä¸ºç®€æ´ï¼š

```plain
func DoSomeThings(val1 int, val2 string) (_ string, err error) {
    defer func() {
        if err != nil {
            err = fmt.Errorf("in DoSomeThings: %w", err)
        }
    }()
    val3, err := doThing1(val1)
    if err != nil {
        return "", err
    }
    val4, err := doThing2(val2)
    if err != nil {
        return "", err
    }
    return doThing3(val3, val4)
}
```

## panic

æœ€åï¼Œæˆ‘ä»¬å†æ¥è®²è®²ä¸€ç±»ç‰¹æ®Šçš„é”™è¯¯ï¼španicã€‚å½“å‘ç”Ÿç®—æœ¯é™¤0é”™è¯¯ã€å†…å­˜æ— æ•ˆè®¿é—®ã€æ•°ç»„è¶Šç•Œç­‰é—®é¢˜æ—¶ï¼Œä¼šè§¦å‘ç¨‹åºpanicï¼Œå¯¼è‡´ç¨‹åºå¼‚å¸¸é€€å‡ºå¹¶æ‰“å°å‡ºå‡½æ•°çš„å †æ ˆä¿¡æ¯ã€‚

åœ¨Go è¯­è¨€ä¸­ï¼Œæœ‰ä»¥ä¸‹ä¸¤ä¸ªå†…ç½®å‡½æ•°å¯ä»¥å¤„ç†ç¨‹åºçš„å¼‚å¸¸æƒ…å†µï¼š

```plain
func panic(interface{})
func recover() interface{}
```

panic å‡½æ•°ä¼ é€’çš„å‚æ•°ä¸ºç©ºæ¥å£interface{}ï¼Œå®ƒå¯ä»¥å­˜å‚¨ä»»ä½•å½¢å¼çš„é”™è¯¯ä¿¡æ¯å¹¶è¿›è¡Œä¼ é€’ï¼Œç„¶ååœ¨å¼‚å¸¸é€€å‡ºæ—¶æ‰“å°å‡ºæ¥ã€‚

```plain
panic(42)
panic("unreachable")
panic(Error("cannot parse"))
```

Go ç¨‹åºåœ¨ panic æ—¶å¹¶ä¸ä¼šç›´æ¥å¯¼è‡´ç¨‹åºå¼‚å¸¸é€€å‡ºï¼Œå®ƒä¼šç»ˆæ­¢å½“å‰æ­£åœ¨æ­£å¸¸æ‰§è¡Œçš„å‡½æ•°ï¼Œæ‰§è¡Œdefer å‡½æ•°å¹¶é€çº§è¿”å›ã€‚  
ä¾‹å¦‚ï¼Œå¯¹äºå‡½æ•°è°ƒç”¨é“¾a()â†’b()â†’c()ï¼Œå½“å‡½æ•° c å‘ç”Ÿ panic åï¼Œä¼šè¿”å›å‡½æ•°bã€‚æ­¤æ—¶ï¼Œå‡½æ•° b ä¹Ÿåƒå‘ç”Ÿäº† panic ä¸€æ ·è¿”å›å‡½æ•°aã€‚å‡½æ•°cã€bã€a ä¸­çš„ defer å‡½æ•°éƒ½å°†æ­£å¸¸æ‰§è¡Œã€‚

```plain
func a() {
	defer fmt.Println("defer a")
	b()
	fmt.Println("after a")
}
func b() {
	defer fmt.Println("defer b")
	c()
	fmt.Println("after b")
}
func c() {
	defer fmt.Println("defer c")
	panic("this is panic")
	fmt.Println("after c")
}
func main() {
	a()
}
```

å¦‚ä¸‹æ‰€ç¤ºï¼Œå½“å‡½æ•° c è§¦å‘äº† panic åï¼Œæ‰€æœ‰å‡½æ•°ä¸­çš„ defer è¯­å¥éƒ½ä¼šè¢«æ­£å¸¸è°ƒç”¨ï¼Œå¹¶ä¸”åœ¨panicæ—¶æ‰“å°å‡ºå †æ ˆä¿¡æ¯ã€‚

```plain
defer c
defer b
defer a
panic: this is panic
goroutine 1 [running]:
main.c()
    bookcode/panic/panic_chain.go:19 +0x95
main.b()
    bookcode/panic/panic_chain.go:13 +0x96
main.a()
    bookcode/panic/panic_chain.go:7 +0x96
main.main()
    bookcode/panic/panic_chain.go:24 +0x20

```

é€šå¸¸ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿæ•è·è¿™æ ·çš„é”™è¯¯ï¼Œç„¶åè®©ç¨‹åºç»§ç»­æ­£å¸¸æ‰§è¡Œã€‚è¦æ•è·è¿™ç§å¼‚å¸¸ï¼Œæˆ‘ä»¬éœ€è¦å°† defer ä¸å†…ç½® recover å‡½æ•°ç»“åˆèµ·æ¥ä½¿ç”¨ã€‚

```plain
func executePanic() {
	defer func() {
		if errMsg := recover(); errMsg != nil {
			fmt.Println(errMsg)
		}
		fmt.Println("This is recovery function...")
	}()
	panic("This is Panic Situation")
	fmt.Println("The function executes Completely")
}
func main() {
	executePanic()
	fmt.Println("Main block is executed completely...")
}
```

ä»ä¸‹é¢è¿™æ®µè¾“å‡ºå¯ä»¥çœ‹å‡ºï¼Œå°½ç®¡æœ‰panicï¼Œmain å‡½æ•°ä»ç„¶åœ¨æ­£å¸¸æ‰§è¡Œåæ‰é€€å‡ºã€‚

```plain
This is Panic Situation
This is recovery function...
Main block is executed completely...
```

åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸çœ‹åˆ°ä¸€äº›å¼€å‘è€…ä¸ºäº†é¿å…å¼‚å¸¸é€€å‡ºåœ¨å„ä¸ªå‡½æ•°è°ƒç”¨çš„åœ°æ–¹éƒ½åŠ ä¸Šäº†recoveræ•è·ï¼Œä½†å…¶å®è¿™æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚å€ŸåŠ©ä¸Šé¢çš„è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æœ€ä¸Šå±‚å‡½æ•°æ•è·å¼‚å¸¸å°±å¯ä»¥äº†ã€‚

æœ‰äº›åŒå­¦å¯èƒ½ä¼šæƒ³ï¼Œé‚£æˆ‘ç›´æ¥åœ¨mainå‡½æ•°é‡ŒåŠ ä¸€ä¸ªrecoverå‡½æ•°ï¼Œè¿™æ ·æ•è·å¼‚å¸¸ä¸å°±å¯ä»¥äº†å—ï¼Ÿä½†è¿™æ˜¯ä¸å¯¹çš„ï¼Œå› ä¸ºæˆ‘ä»¬è®²çš„è¿™ä¸ªç‰¹æ€§åªé€‚ç”¨äºæŸä¸€ä¸ªå•ç‹¬çš„åç¨‹ã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å¯¹æ¯ä¸€ä¸ªé‡è¦çš„åç¨‹çš„æœ€ä¸Šå±‚å‡½æ•°è¿›è¡Œæ•è·ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…ç¨‹åºçš„å¼‚å¸¸é€€å‡ºäº†ã€‚

ä¸‹é¢è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨CreateWorkæ–¹æ³•ä¸­æ•è·åˆ°panicå¹¶æ‰“å°åˆ°äº†æ—¥å¿—ä¸­ã€‚ä¸€èˆ¬è¿™ç§æ—¥å¿—ä¼šè¢«é¢å¤–çš„ç›‘æ§ç³»ç»Ÿå‘ç°å¹¶æŠ¥è­¦ã€‚

```plain
func (s *Crawler) CreateWork() {
	defer func() {
		if err := recover(); err != nil {
			s.Logger.Error("worker panic",
				zap.Any("err", err),
				zap.String("stack", string(debug.Stack())))
		}
	}()
...
}
```

## æ€»ç»“

å¥½äº†ï¼Œ æ€»ç»“ä¸€ä¸‹ã€‚

è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä¸¤ä¸ªé‡è¦çš„ç‰¹æ€§é™é€Ÿå™¨ä¸é”™è¯¯å¤„ç†ã€‚é™é€Ÿå™¨é€šè¿‡ä»¤ç‰Œæ¡¶æœºåˆ¶ï¼Œå¸®åŠ©æˆ‘ä»¬å‡å°‘äº†çˆ¬è™«å¯¹ç›®æ ‡æœåŠ¡å™¨çš„å‹åŠ›ï¼Œå¹¶ä¸”ä½¿ç”¨äº†å¤šå±‚é™é€Ÿå™¨å¯¹çˆ¬è™«è¿›è¡Œç²¾ç»†åŒ–çš„ç®¡ç†ã€‚

è€Œå¯¹äºé”™è¯¯å¤„ç†ï¼ŒGoè¯­è¨€å¸æ”¶äº†å½“å‰è½¯ä»¶å¼€å‘ä¸­é‡åˆ°çš„ç»éªŒä¸æ•™è®­ï¼Œå…¶å“²å­¦æ˜¯å‡½æ•°çš„è°ƒç”¨è€…ç†åº”å¯¹é”™è¯¯è¿›è¡Œå¤„ç†ï¼Œä½†è¿™ä¸ªæ€è·¯ç¡®å®æœ‰æ—¶å€™ä¼šå¸¦æ¥é”™è¯¯å¤„ç†å†—é•¿çš„é—®é¢˜ã€‚é”™è¯¯å¤„ç†ç›®å‰æœ‰è®¸å¤šæœ€ä½³çš„å®è·µï¼Œå…¶ä¸­åŒ…æ‹¬äº†é”™è¯¯çš„åŒ…è£…ï¼Œé”™è¯¯ä¸­é—´ä»¶ä»¥åŠé€šè¿‡deferæ¥å‡å°‘é”™è¯¯çš„å¤„ç†ç­‰ã€‚

æœ€åæˆ‘ä»¬è¿˜ä»‹ç»äº†panicï¼Œåœ¨å…³é”®çš„åŠŸèƒ½æœ€ä¸Šå±‚ä½¿ç”¨defer+recoverå¯ä»¥é˜²æ­¢ç¨‹åºå¼‚å¸¸é€€å‡ºã€‚ä¸è¿‡è¦æ³¨æ„ï¼Œå¯¹å¼‚å¸¸è¿›è¡Œæ•è·æ—¶ï¼Œåªèƒ½å¯¹å•ä¸ªåç¨‹ç”Ÿæ•ˆã€‚

## è¯¾åé¢˜

å­¦å®Œè¿™èŠ‚è¯¾ï¼Œç»™ä½ ç•™ä¸€é“è¯¾åé¢˜ã€‚

é”™è¯¯å¤„ç†æ˜¯Goè¯­è¨€ä¸­è¢«åæ§½å¾ˆå¤šçš„è¯é¢˜ï¼Œä½†æ˜¯è¿™å…¶å®æ˜¯æ·±æ€ç†Ÿè™‘çš„è®¾è®¡ç»“æœã€‚ä½ å¯ä»¥æŸ¥é˜…ç›¸å…³èµ„æ–™ï¼Œè°ˆä¸€è°ˆåœ¨Goä¸­å¦‚ä½•æ›´å¥½åœ°è¿›è¡Œé”™è¯¯å¤„ç†ã€‚

æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ4ï¼‰</strong></div><ul>
<li><span>viclilei</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è€å¸ˆï¼Œä¸ºä»€ä¹ˆæˆ‘æŒ‰ç…§ä»£ç å†™å®Œåï¼Œè¯·æ±‚æ•°æ®è¿˜æ˜¯æœ‰1s20æ¡å·¦å³ã€‚å¯ä»¥å¸®å¿™åˆ¤æ–­æˆ‘å¤§æ¦‚æ˜¯ä»€ä¹ˆåœ°æ–¹å†™é”™äº†å—ï¼Ÿ</p>2023-01-09</li><br/><li><span>Realm</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>åœ¨ç¨‹åºä¸­åº”è¯¥é¿å…ä½¿ç”¨é‡ç”Ÿçš„goroutineå¸¦æ¥çš„panicï¼Œå¯ä»¥æ”¾åœ¨ä¸€ä¸ªæœ‰ä¸ªå¼‚å¸¸æ•è·çš„Goå‡½æ•°ä¸­æ¥æ‰§è¡Œgoroutineã€‚å§¿åŠ¿å¦‚ä¸‹ï¼š
```
func Go(f func()) {
	go func() {
		&#47;&#47; defer recover æ•è·panic
		defer func() {
			if err := recover(); err != nil {
				log.Printf(&quot;panic: %+v&quot;, err)
			}
		}()

		f()
	}()
}

func main() {
	f := func() {
		panic(&quot;xxx&quot;)
	}
	Go(f)

	time.Sleep(1 * time.Second)
}

```</p>2022-12-24</li><br/><li><span>å¤§æ¯›</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>1 - å®˜æ–¹çš„ golang.org&#47;x&#47;time&#47;rate å®ç°é™æµæ˜¯é€šè¿‡è®°å½•æœ€åæ“ä½œçš„æ—¶é—´+è®¡ç®—å®Œæˆçš„ï¼Œæ„Ÿè§‰è¿™ç§å¤„ç†æ–¹å¼è®©äººè€³ç›®ä¸€æ–°ã€‚ä»¥å‰æˆ‘ä¸€ç›´è§‰å¾—è¿™ç§ä»¤ç‰Œé™æµçš„ç®—æ³•å°±æ˜¯ä½¿ç”¨ ticker å®šæ—¶å‘ä¸€ä¸ª chan ä¸­æ”¾å…¥ä»¤ç‰Œï¼Œç„¶åè®©è·å–ä»¤ç‰Œçš„äººé˜»å¡ç„¶åè‡ªè¡Œäº‰æŠ¢ï¼Œè®¡ç®—çš„æ–¹å¼æ¯«æ— ç–‘é—®æ¯” ticker çš„æ–¹å¼æ›´ä¼˜ã€‚å¦å¤–è¿™ç§è®¡ç®—çš„å®ç°è®©è¿™ä¸ªlimiter æœ‰äº†ä¸€ä¸ªæœ‰è¶£çš„ç‰¹ç‚¹ï¼Œå°±æ˜¯å½“è°ƒç”¨ Wait(ctx context.Context) çš„æ—¶å€™ï¼Œå¦‚æœ ctx è®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œlimiter å¯ä»¥ç«‹å³è®¡ç®—å‡ºè¿™ä¸ªè°ƒç”¨è€…æ˜¯å¦æœ‰æœºä¼šè·å–åˆ°ä»¤ç‰Œï¼ˆå¦‚æœä¸‹ä¸€ä¸ªä»¤ç‰Œç”Ÿæˆæ—¶é—´æ˜¯ 3 ç§’åï¼Œè€Œ ctx çš„è¿‡æœŸæ—¶é—´æ˜¯ 1 ç§’ï¼Œlimiter ä¼šç«‹å³è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œè¡¨ç¤ºè¿™ä¸ªè°ƒç”¨è€…ä¸å¯èƒ½åœ¨è¿‡æœŸæ—¶é—´å†…è·å–ä»¤ç‰Œï¼‰ï¼Œè¿™ä¸ä¼šè®©è°ƒç”¨è€…ä¸€ç›´åœ¨ Wait æ–¹æ³•ä¸Šé˜»å¡ï¼Œä¹Ÿç®—æ˜¯æå‡æ€§èƒ½çš„ä¸€ä¸ªå°æŠ€å·§

2 - è¯¾ç¨‹ä¸­è‡ªè¡Œå®ç°çš„å¤šä¸ªçº§åˆ«çš„ limiter æ„Ÿè§‰æ˜¯æœ‰ä¸€ä¸ª bugï¼Ÿå³å¦‚æœè®¾ç½®äº† 5 ä¸ªçº§åˆ«çš„ limiterï¼Œç”¨æˆ·å·²ç»è·å¾—äº†å‰ 3 ä¸ª limiter çš„ä»¤ç‰Œï¼Œä½†æ˜¯åœ¨å°è¯•è·å–ç¬¬ 4 ä¸ªä»¤ç‰Œçš„æ—¶å€™å‡ºé”™ï¼Œé‚£æ˜¯å¦åº”è¯¥å°†å‰ä¸‰ä¸ªä»¤ç‰Œæ”¾å›å»ï¼Ÿ

3 - error æ¨èä½¿ç”¨ github.com&#47;pkg&#47;errors

4 - ä¸€ä¸ª goroutine å¦‚æœæ²¡æœ‰ä½¿ç”¨ defer + recover çš„æ–¹å¼æ¥æ•è· panicï¼Œè¿™ä¸ª goroutine å°†å¯¼è‡´æ•´ä¸ªç¨‹åºç›´æ¥å´©æºƒï¼Œå¦‚æœä½ ä¸æƒ³è¿™æ ·ï¼Œè¦è®°å¾—æ·»åŠ  defer + recover
</p>2024-01-29</li><br/><li><span>å¢æ‰¿ç</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è€å¸ˆï¼ŒappHandler è®²è§£é‚£é‡Œï¼ŒviewUsersè¿˜æœ‰ä¸‹é¢é‚£ä¸ªæ–¹æ³•æ˜¯ä¸æ˜¯æ¼äº†error è¿”å›</p>2022-12-26</li><br/>
</ul>