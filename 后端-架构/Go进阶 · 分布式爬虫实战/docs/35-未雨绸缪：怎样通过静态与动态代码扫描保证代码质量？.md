ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ‘å»ºå‹‹ã€‚

è¿™èŠ‚è¯¾è®©æˆ‘ä»¬ç»§ç»­ä¼˜åŒ–ä»£ç ï¼Œè®©ç¨‹åºå¯é…ç½®åŒ–ã€‚ç„¶åé€šè¿‡é™æ€ä¸åŠ¨æ€çš„ä»£ç æ‰«æå‘ç°ç¨‹åºä¸­å­˜åœ¨çš„é—®é¢˜ï¼Œè®©ä»£ç å˜å¾—æ›´åŠ ä¼˜é›…ã€‚

## microä¸­é—´ä»¶

é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç´§æ¥ä¸ŠèŠ‚è¯¾çš„go-microæ¡†æ¶ï¼Œå¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œè®¾ç½®go-microçš„ä¸­é—´ä»¶ã€‚å¦‚ä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Goå‡½æ•°é—­åŒ…çš„ç‰¹æ€§ï¼Œå¯¹è¯·æ±‚è¿›è¡Œäº†ä¸€å±‚åŒ…è£…ã€‚ä¸­é—´ä»¶å‡½æ•°åœ¨æ¥æ”¶åˆ°GRPCè¯·æ±‚æ—¶ï¼Œå¯ä»¥æ‰“å°å‡ºè¯·æ±‚çš„å…·ä½“å‚æ•°ï¼Œæ–¹ä¾¿æˆ‘ä»¬æ’æŸ¥é—®é¢˜ã€‚

```plain
func logWrapper(log *zap.Logger) server.HandlerWrapper {
	return func(fn server.HandlerFunc) server.HandlerFunc {
		return func(ctx context.Context, req server.Request, rsp interface{}) error {
			log.Info("recieve request",
				zap.String("method", req.Method()),
				zap.String("Service", req.Service()),
				zap.Reflect("request param:", req.Body()),
			)
			err := fn(ctx, req, rsp)
			return err
		}
	}
}
```

æ¥ä¸‹æ¥ï¼Œä½¿ç”¨micro.WrapHandlerå°†ä¸­é—´ä»¶æ³¨å…¥åˆ°micro.NewServiceä¸­ï¼Œè¿™æ ·å°±å¤§åŠŸå‘Šæˆäº†ã€‚

```plain
service := micro.NewService(
		...
		micro.WrapHandler(logWrapper(logger)),
	)
```

å½“GRPCæœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œä¼šæ‰“å°å‡ºä¸‹é¢è¿™æ ·çš„è¯·æ±‚ä¿¡æ¯ã€‚

```plain
{"level":"INFO","ts":"2022-11-28T00:29:28.287+0800","caller":"crawler/main.go:148","msg":"recieve request","method":"Greeter.Hello","Service":"go.micro.server.worker","request param:":{}}
```

## é™æ€æ‰«æ

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ç”¨é™æ€æ‰«ææŠŠä»£ç å˜å¾—æ›´ä¼˜é›…ä¸€äº›ã€‚

å½“å‰å¤§å¤šæ•°å…¬å¸é‡‡ç”¨çš„é™æ€ä»£ç åˆ†æå·¥å…·éƒ½æ˜¯golangci-lint ã€‚Linter æœ¬æ¥æŒ‡çš„æ˜¯ä¸€ç§åˆ†ææºä»£ç ä»¥æ­¤æ ‡è®°ç¼–ç¨‹é”™è¯¯ã€ä»£ç ç¼ºé™·å’Œé£æ ¼é”™è¯¯çš„å·¥å…·ï¼Œè€Œgolangci-lintå°±æ˜¯é›†åˆå¤šç§Linterçš„å·¥å…·ã€‚è¦æŸ¥çœ‹golangci-lintæ”¯æŒçš„ Linter åˆ—è¡¨ï¼Œä»¥åŠå®ƒå¯ç”¨/ç¦ç”¨äº†å“ªäº›Linterï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š

```plain
> golangci-lint help linters
```

Goè¯­è¨€å®šä¹‰äº†å®ç°Linterçš„APIï¼Œå®ƒè¿˜æä¾›äº†golintå·¥å…·ï¼Œgolinté›†æˆäº†å‡ ç§å¸¸è§çš„Linterã€‚åœ¨[æºç ](https://cs.opensource.google/go/x/tools/+/refs/tags/v0.1.11:go/analysis/passes/unreachable/unreachable.go)ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹åœ¨æ ‡å‡†åº“ä¸­å¦‚ä½•å®ç°å…¸å‹çš„Linterã€‚

Linterçš„å®ç°åŸç†æ˜¯é™æ€æ‰«æä»£ç çš„ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ï¼ŒLinterçš„æ ‡å‡†åŒ–æ„å‘³ç€æˆ‘ä»¬å¯ä»¥çµæ´»å®ç°è‡ªå·±çš„Lintersã€‚ä¸è¿‡ï¼Œgolangci-linté‡Œé¢å…¶å®å·²ç»é›†æˆäº†åŒ…æ‹¬golintåœ¨å†…çš„ä¼—å¤šLinterï¼Œå¹¶ä¸”å…·æœ‰çµæ´»çš„é…ç½®èƒ½åŠ›ã€‚æ‰€ä»¥å¦‚æœä½ æƒ³è‡ªå·±å†™Linterï¼Œæˆ‘ä¹Ÿå»ºè®®ä½ å…ˆäº†è§£ä¸€ä¸‹golangci-lintç°æœ‰çš„èƒ½åŠ›ã€‚

ä½¿ç”¨golangci-lintçš„ç¬¬ä¸€æ­¥å°±æ˜¯å®‰è£…ï¼Œä¸åŒç¯å¢ƒä¸‹çš„å®‰è£…æ–¹å¼ä½ å¯ä»¥æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://golangci-lint.run/usage/install/)ã€‚ä¸‹é¢æˆ‘æ¥æ¼”ç¤ºä¸€ä¸‹å¦‚ä½•åœ¨æœ¬åœ°ä½¿ç”¨golangci-lintã€‚æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š

```plain
golangci-lint run
```

å®ƒç­‰ä»·äºï¼š

```plain
golangci-lint run ./...
```

æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‡å®šè¦åˆ†æçš„ç›®å½•å’Œæ–‡ä»¶ï¼š

```plain
golangci-lint run dir1 dir2/... dir3/file1.go
```

å°±åƒå‰é¢æ‰€è¯´ï¼Œgolangci-lintæ˜¯ä¼—å¤šlintçš„é›†åˆï¼Œè¦æŸ¥çœ‹golangci-linté»˜è®¤å¯åŠ¨çš„lintï¼Œå¯ä»¥è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š

```plain
golangci-lint help linters
```

å¯ä»¥çœ‹åˆ°ï¼Œgolangci-lintå†…ç½®äº†æ•°åä¸ªlintï¼š  
![å›¾ç‰‡](https://static001.geekbang.org/resource/image/4a/fe/4a2d4399725f4875f70af14156eb33fe.png?wh=1920x905)

ä¸ºäº†èƒ½å¤Ÿçµæ´»åœ°é…ç½®golangci-lintçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦æ–°å»ºå¯¹åº”çš„é…ç½®æ–‡ä»¶ã€‚golangci-lintä¼šä¾æ¬¡æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œå®ç°å¯ç”¨æˆ–ç¦ç”¨æŒ‡å®šçš„Linterï¼Œå¹¶æŒ‡å®šä¸åŒLinterçš„è¡Œä¸ºã€‚å…·ä½“çš„é…ç½®è¯´æ˜ä½ ä¹Ÿå¯ä»¥æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://golangci-lint.run/usage/configuration/)ã€‚

- .golangci.yml
- .golangci.yaml
- .golangci.toml
- .golangci.json

ç°åœ¨è®©æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­åˆ›å»º.golangci.ymlæ–‡ä»¶ï¼Œå…·ä½“çš„é…ç½®å¦‚ä¸‹ï¼š

```plain
run:
    tests: false
    skip-dirs:
        - vendor

linters-settings:
    funlen:
        # Checks the number of lines in a function.
        # If lower than 0, disable the check.
        # Default: 60
        lines: 120
        # Checks the number of statements in a function.
        # If lower than 0, disable the check.
        # Default: 40
        statements: -1

# list all linters by run `golangci-lint help linters`
linters:
    enable-all: true
    disable:
        # gochecknoglobals: Checks that no globals are present in Go code
        - gochecknoglobals
        # gochecknoinits: Checks that no init functions are present in Go code
        - gochecknoinits
        # Checks that errors returned from external packages are wrapped
        - wrapcheck
        # checks that the length of a variable's name matches its scope
        - varnamelen
        # Checks the struct tags.
        - tagliatelle
        # An analyzer to detect magic numbers.
        - gomnd
				...
```

å…¶ä¸­ï¼Œrun.testsé€‰é¡¹è¡¨æ˜æˆ‘ä»¬ä¸æ‰«ææµ‹è¯•æ–‡ä»¶ï¼Œrun.skip-dirsè¡¨ç¤ºæ‰«æç‰¹å®šçš„æ–‡ä»¶å¤¹ï¼Œlinters-settingsé€‰é¡¹ç”¨äºè®¾ç½®ç‰¹å®šLinterçš„å…·ä½“è¡Œä¸ºã€‚funlen linter ç”¨äºé™åˆ¶å‡½æ•°çš„è¡Œæ•°ï¼Œé»˜è®¤çš„é™åˆ¶æ˜¯60è¡Œï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æ ¹æ®é¡¹ç›®çš„è§„èŒƒï¼Œå°†å…¶é…ç½®ä¸ºäº†120è¡Œã€‚Linterçš„ç‰¹æ€§ä½ å¯ä»¥æ ¹æ®è‡ªå·±é¡¹ç›®å’Œå›¢é˜Ÿçš„è¦æ±‚åŠ¨æ€é…ç½®ã€‚

å¦å¤–ï¼Œlinters.enable-allè¡¨ç¤ºé»˜è®¤å¼€å¯æ‰€æœ‰çš„Linterï¼Œlinters.disableè¡¨ç¤ºç¦ç”¨æŒ‡å®šçš„Linterã€‚å­˜åœ¨è¿™ä¸ªè®¾å®šæ˜¯å› ä¸ºåœ¨golangci-lintä¸­æœ‰ä¼—å¤šçš„Linterï¼Œä½†æ˜¯æœ‰äº›Linterç›¸äº’å†²çªï¼Œæœ‰äº›å·²ç»è¿‡æ—¶ï¼Œè¿˜æœ‰äº›å¹¶ä¸é€‚åˆä½ å½“å‰çš„é¡¹ç›®ã€‚ä¾‹å¦‚ï¼Œgochecknoglobalsç¦æ­¢ä½¿ç”¨å…¨å±€å˜é‡ï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ç¡®å®éœ€è¦å…¨å±€å˜é‡ï¼Œè¿™æ—¶å€™å°±è¦æ ¹æ®å®é™…éœ€æ±‚æ¥è°ƒæ•´äº†ã€‚

æ·»åŠ å®Œé…ç½®æ–‡ä»¶ä¹‹åï¼Œæ‰§è¡Œ golangci-lint run å¯ä»¥çœ‹åˆ°é™æ€æ‰«æä¹‹åçš„ä¼—å¤šè­¦å‘Šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/7f/47/7f05d0042b6db85d342cf8bba7573447.png?wh=1920x1181)

æœ‰å¾ˆå¤šLinterå¯¹æé«˜ä»£ç çš„è´¨é‡æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ã€‚ä¾‹å¦‚åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œgolangci-lintä¼šæ‰“å°å‡ºæ–‡ä»¶ã€è¡Œå·ã€ä¸ç¬¦åˆè§„èŒƒçš„ä½ç½®ä»¥åŠåŸå› ã€‚å…¶ä¸­ï¼Œç¬¬ä¸€è¡Œæœ€åçš„(golint)è¡¨æ˜é—®é¢˜æ˜¯ç”±golintè¿™ä¸ªlinté™æ€æ‰«æå‡ºæ¥çš„ã€‚è¿™é‡Œå®ƒæç¤ºæˆ‘ä»¬åº”è¯¥å°†sqlUrlçš„å‘½åä¿®æ”¹ä¸ºsqlURLã€‚

```plain
sqldb/option.go:9:2: struct field `sqlUrl` should be `sqlURL` (golint)
        sqlUrl string
```

å†ä¸¾ä¸ªä¾‹å­ï¼Œè¿™é‡Œï¼Œwsl linterè¦æ±‚æˆ‘ä»¬åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹åœ¨continueå‰æ–¹ç©ºä¸€è¡Œï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿é˜…è¯»ã€‚

```plain
engine/schedule.go:242:4: branch statements should not be cuddled if block has more than two lines (wsl)
                        continue
```

æˆ‘å°†é¡¹ç›®ä¸­æ‰€æœ‰çš„ä»£ç éƒ½æ ¹æ®Linterçš„æç¤ºè¿›è¡Œäº†ä¿®æ”¹ï¼Œå®Œæ•´çš„ä»£ç è§[v0.3.1](https://github.com/dreamerjackson/crawler)ã€‚

## åŠ¨æ€æ‰«æ

ä¸è¿‡ï¼Œæœ‰ä¸€äº›é—®é¢˜æ˜¯å¾ˆéš¾é€šè¿‡é™æ€æ‰«æå‘ç°çš„ï¼Œä¾‹å¦‚æ•°æ®äº‰ç”¨é—®é¢˜ã€‚æ•°æ®äº‰ç”¨æ˜¯å¹¶å‘ç³»ç»Ÿä¸­æœ€å¸¸è§ä¸”æœ€éš¾è°ƒè¯•çš„é”™è¯¯ç±»å‹ä¹‹ä¸€ã€‚åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸¤ä¸ªåç¨‹å…±åŒè®¿é—®äº†å…¨å±€å˜é‡countï¼Œä¹çœ‹ä¹‹ä¸‹å¯èƒ½æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯è¿™ä¸ªç¨‹åºå…¶å®æ˜¯å­˜åœ¨æ•°æ®äº‰ç”¨çš„ï¼Œcount çš„ç»“æœä¹Ÿæ˜¯ä¸æ˜ç¡®çš„ã€‚

```plain
// race.go
var count = 0
func add() {
	count++
}
func main() {
	go add()
	go add()
}
```

count++æ“ä½œçœ‹èµ·æ¥æ˜¯ä¸€æ¡æŒ‡ä»¤ï¼Œä½†æ˜¯å¯¹ CPU æ¥è¯´ï¼Œéœ€è¦å…ˆè¯»å– count çš„å€¼ï¼Œæ‰§è¡Œ+1 æ“ä½œï¼Œ å†å°†count çš„å€¼å†™å›å†…å­˜ã€‚å¤§éƒ¨åˆ†äººæœŸæœ›çš„æ“ä½œå¯èƒ½æ˜¯ä¸‹é¢è¿™æ ·ï¼š Râ†0 ä»£è¡¨è¯»å–åˆ°0ï¼Œwâ†’1 ä»£è¡¨å†™å…¥count ä¸º1ï¼›åç¨‹1å†™å…¥æ•°æ®1åï¼Œåç¨‹2å†å†™å…¥ï¼Œcount æœ€åçš„å€¼ä¸º2ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/e6/d4/e69e024bebe16a417a7817fcb5b651d4.jpg?wh=1920x595)

ä½†æ˜¯ç”±äºcount++å¹¶ä¸æ˜¯ä¸€æ¡åŸå­æŒ‡ä»¤ï¼Œæƒ…å†µå¼€å§‹å˜å¾—å¤æ‚ã€‚å¦‚æœæ‰§è¡Œçš„æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼Œé‚£ä¹ˆcount æœ€åçš„å€¼ä¸º1ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/30/e2/30cc86069967126404058449e966f2e2.jpg?wh=1920x595)

è¿™ä¸¤ç§æƒ…å†µå‘Šè¯‰æˆ‘ä»¬ï¼Œå½“ä¸¤ä¸ªåç¨‹å‘ç”Ÿæ•°æ®äº‰ç”¨æ—¶ï¼Œç»“æœæ˜¯ä¸å¯é¢„æµ‹çš„ï¼Œè¿™ä¼šå¯¼è‡´å¾ˆå¤šå¥‡æ€ªçš„é”™è¯¯ã€‚

å†ä¸¾ä¸€ä¸ª Go è¯­è¨€ä¸­ç»å…¸çš„æ•°æ®äº‰ç”¨é”™è¯¯ã€‚å¦‚ä¸‹ä¼ªä»£ç æ‰€ç¤ºï¼Œåœ¨Hash è¡¨ä¸­ï¼Œå­˜å‚¨äº†æˆ‘ä»¬å¸Œæœ›å­˜å‚¨åˆ° Redis æ•°æ®åº“ä¸­çš„dataæ•°æ®ã€‚ä½†æ˜¯åœ¨ Go è¯­è¨€ä¸­ä½¿ç”¨Rangeæ—¶ï¼Œå˜é‡kæ˜¯ä¸€ä¸ªå †ä¸Šåœ°å€ä¸å˜çš„å¯¹è±¡ï¼Œè¯¥åœ°å€å­˜å‚¨çš„å€¼ä¼šéšç€ Range éå†è€Œå‘ç”Ÿå˜åŒ–ã€‚

å¦‚æœæ­¤æ—¶æˆ‘ä»¬å°†å˜é‡ k çš„åœ°å€æ”¾å…¥åç¨‹saveï¼Œä»¥æ­¤æä¾›å¹¶å‘å­˜å‚¨è€Œä¸å µå¡ç¨‹åºï¼Œé‚£ä¹ˆæœ€åçš„ç»“æœå¯èƒ½æ˜¯ï¼Œåé¢çš„æ•°æ®ä¼šè¦†ç›–å‰é¢çš„æ•°æ®ï¼ŒåŒæ—¶å¯¼è‡´ä¸€äº›æ•°æ®æ²¡æœ‰è¢«å­˜å‚¨ï¼Œå¹¶ä¸”æ¯ä¸€æ¬¡å®Œæˆå­˜å‚¨çš„æ•°æ®ä¹Ÿæ˜¯ä¸æ˜ç¡®çš„ã€‚

```plain
func save(g *data){
	saveToRedis(g)
}
func main() {
	var a map[int]data
	for _, k := range a{
		go save(&k)
	}
}
```

æ•°æ®äº‰ç”¨å¯ä»¥è¯´æ˜¯é«˜å¹¶å‘ç¨‹åºä¸­æœ€éš¾æ’æŸ¥çš„é—®é¢˜ï¼ŒåŸå› åœ¨äºå®ƒçš„ç»“æœæ˜¯ä¸æ˜ç¡®çš„ï¼Œè€Œä¸”å¯èƒ½åªåœ¨åœ¨ç‰¹å®šçš„æ¡ä»¶ä¸‹å‡ºé”™ï¼Œè¿™å¯¼è‡´å¾ˆéš¾å¤ç°ç›¸åŒçš„é”™è¯¯ï¼Œåœ¨æµ‹è¯•é˜¶æ®µä¹Ÿä¸ä¸€å®šèƒ½æµ‹è¯•å‡ºé—®é¢˜ã€‚

Go 1.1 åæä¾›äº†å¼ºå¤§çš„æ£€æŸ¥å·¥å…· race æ¥æ’æŸ¥æ•°æ®äº‰ç”¨é—®é¢˜ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œrace å¯ä»¥ç”¨åœ¨å¤šä¸ªGo æŒ‡ä»¤ä¸­ã€‚å½“æ£€æµ‹å™¨åœ¨ç¨‹åºä¸­æ‰¾åˆ°æ•°æ®äº‰ç”¨æ—¶ï¼Œå°†æ‰“å°æŠ¥å‘Šã€‚è¿™ä¸ªæŠ¥å‘ŠåŒ…å«å‘ç”Ÿ race å†²çªçš„åç¨‹æ ˆï¼Œä»¥åŠæ­¤æ—¶æ­£åœ¨è¿è¡Œçš„åç¨‹æ ˆã€‚

```plain
$ go test -race mypkg
$ go run -race mysrc.go
$ go build -race mycmd
$ go install -race mypkg
```

å¦‚æœå¯¹ä¸Šé¢è¿™ä¸ªä¾‹å­çš„ race.go æ–‡ä»¶æ‰§è¡Œgo run -race ï¼Œç¨‹åºåœ¨è¿è¡Œæ—¶ä¼šç›´æ¥æŠ¥é”™ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ä»æŠ¥é”™åè¾“å‡ºçš„æ ˆå¸§ä¿¡æ¯ä¸­å¯ä»¥çœ‹å‡ºå‘ç”Ÿå†²çªçš„å…·ä½“ä½ç½®ã€‚

```plain
Â» go run -race race.go
==================
WARNING: DATA RACE
Read at 0x00000115c1f8 by goroutine 7:
main.add()
bookcode/concurrence_control/race.go:5 +0x3a
Previous write at 0x00000115c1f8 by goroutine 6:
main.add()
bookcode/concurrence_control/race.go:5 +0x56
```

Read at è¡¨æ˜è¯»å–å‘ç”Ÿåœ¨race.go æ–‡ä»¶çš„ç¬¬ 5 è¡Œï¼Œè€ŒPrevious write è¡¨æ˜å‰ä¸€ä¸ªå†™å…¥ä¹Ÿå‘ç”Ÿåœ¨race.go æ–‡ä»¶çš„ç¬¬ 5 è¡Œï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥éå¸¸å¿«é€Ÿåœ°å‘ç°å¹¶å®šä½æ•°æ®äº‰ç”¨é—®é¢˜äº†ã€‚

ä¸è¿‡ï¼Œç«äº‰æ£€æµ‹ä¹Ÿæœ‰ä¸€å®šæˆæœ¬ï¼Œå®ƒå› ç¨‹åºçš„ä¸åŒè€Œæœ‰æ‰€å·®å¼‚ã€‚å¯¹äºå…¸å‹çš„ç¨‹åºæ¥è¯´ï¼Œå†…å­˜ä½¿ç”¨é‡å¯èƒ½å¢åŠ 5~10 å€ï¼Œæ‰§è¡Œæ—¶é—´ä¼šå¢åŠ  2~20 å€ã€‚åŒæ—¶ï¼Œç«äº‰æ£€æµ‹å™¨è¿˜ä¼šä¸ºå½“å‰æ¯ä¸ª defer å’Œ recover è¯­å¥é¢å¤–åˆ†é… 8 å­—èŠ‚ï¼Œåœ¨Goroutineé€€å‡ºå‰ï¼Œè¿™äº›é¢å¤–åˆ†é…çš„å­—èŠ‚ä¸ä¼šè¢«å›æ”¶ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæœ‰ä¸€ä¸ªé•¿æœŸè¿è¡Œçš„ Goroutineï¼Œè€Œä¸”å®šæœŸæœ‰ defer å’Œ recover è°ƒç”¨ï¼Œé‚£ä¹ˆç¨‹åºçš„å†…å­˜ä½¿ç”¨é‡å¯èƒ½æ— é™å¢é•¿ï¼ˆæœ‰å…³raceå·¥å…·çš„åŸç†ä½ å¯ä»¥å‚è€ƒã€ŠGoåº•å±‚åŸç†å‰–æã€‹ï¼‰ã€‚

## é…ç½®æ–‡ä»¶

çœ‹å®Œé™æ€å’ŒåŠ¨æ€çš„ä»£ç æ‰«æï¼Œæˆ‘ä»¬æ¥ç€æ¥è®©ä»£ç å¯é…ç½®åŒ–ï¼Œè¿™æ˜¯æˆ‘ä»¬é¡¹ç›®ä¸€ç›´æ²¡æœ‰å®ç°çš„åŠŸèƒ½ã€‚å¾ˆå¤šäººå¯èƒ½ç›´æ¥ä¼šä¹¦å†™JSONã€TOMLç­‰é…ç½®æ–‡ä»¶å¹¶åœ¨ç¨‹åºå¯åŠ¨æ—¶è¯»å–é…ç½®æ–‡ä»¶ã€‚ä¸è¿‡ä¸€ä¸ªä¼˜ç§€çš„å¤„ç†é…ç½®çš„åº“è¦è€ƒè™‘æ›´å¤šå†…å®¹ã€‚go-microçš„é…ç½®åº“æä¾›äº†ä¸‹é¢è¿™å‡ ç§èƒ½åŠ›ã€‚

- **åŠ¨æ€é…ç½®**  
  å¤§å¤šæ•°ç¨‹åºåœ¨åˆå§‹åŒ–æ—¶ä¼šè¯»å–åº”ç”¨ç¨‹åºé…ç½®ï¼Œä¹‹åå°±ä¸€ç›´ä¿æŒé™æ€çŠ¶æ€ã€‚ å¦‚æœéœ€è¦æ›´æ”¹é…ç½®ï¼Œåˆ™éœ€è¦é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œè¿™æœ‰æ—¶å€™ä¼šæ˜¾å¾—æ¯”è¾ƒç¹çã€‚è€ŒåŠ¨æ€é…ç½®é€šè¿‡ç›‘å¬é…ç½®çš„å˜åŒ–ï¼Œå®ç°äº†åŠ¨æ€åŒ–çš„é…ç½®ã€‚
- **æ”¯æŒå¤šç§åç«¯æ•°æ®æº**  
  å®ƒå¯ä»¥æ”¯æŒæ–‡ä»¶ã€flagsã€ç¯å¢ƒå˜é‡ã€ç”šè‡³etcdç­‰æ•°æ®æºè·å–æºæ•°æ®ã€‚
- **æ”¯æŒå¤šç§æ•°æ®æ ¼å¼çš„è§£æ**  
  å®ƒå¯ä»¥è§£æåŒ…æ‹¬JSONã€TOMLã€YMLåœ¨å†…çš„å¤šç§æ•°æ®æºæ ¼å¼ã€‚
- **å¯åˆå¹¶**  
  å®ƒæ”¯æŒå°†å¤šä¸ªåç«¯æ•°æ®æºè¯»å–åˆ°çš„æ•°æ®åˆå¹¶åˆ°ä¸€èµ·è¿›è¡Œå¤„ç†ã€‚
- **å®‰å…¨æ€§**  
  å½“é…ç½®æ–‡ä»¶ä¸å­˜åœ¨æ—¶ï¼Œgo-microçš„é…ç½®åº“æ”¯æŒè¿”å›é»˜è®¤çš„æ•°æ®ã€‚

å…³äºgo-microä»£ç çš„è®¾è®¡ä½ å¯ä»¥å‚è€ƒ[è¿™ç¯‡æ–‡ç« ](https://micro.dev/blog/2018/07/04/go-config.html)ã€‚

æˆ‘ä»¬ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è¯´æ˜go-microé…ç½®åº“çš„ä½¿ç”¨æ–¹å¼ã€‚å‡è®¾æˆ‘ä»¬æœ‰é…ç½®æ–‡ä»¶config.jsonï¼š

```plain
{
  "hosts": {
    "database": {
      "address": "10.0.0.2",
      "port": 3306
    },
    "cache": {
      "address": "10.0.0.2",
      "port": 6379
    }
  }
}
```

è·å–é…ç½®æ–‡ä»¶çš„å®ä¾‹ä»£ç å¦‚ä¸‹ï¼š

```plain
package main

import (
	...
	"go-micro.dev/v4/config"
	"go-micro.dev/v4/config/source/file"
)
func main() {

	// å¯¼å…¥æ•°æ®
	err := config.Load(file.NewSource(
		file.WithPath("config.json"),
	))
	if err != nil {
		fmt.Println(err)
	}
	type Host struct {
		Address string `json:"address"`
		Port    int    `json:"port"`
	}

	var host Host
	// è·å–hosts.databaseä¸‹çš„æ•°æ®ï¼Œå¹¶è§£æä¸ºhostç»“æ„
	config.Get("hosts", "database").Scan(&host)

	fmt.Println(host)

	w, err := config.Watch("hosts", "database")
	if err != nil {
		fmt.Println(err)
	}

	// ç­‰å¾…é…ç½®æ–‡ä»¶æ›´æ–°
	v, err := w.Next()
	if err != nil {
		fmt.Println(err)
	}

	v.Scan(&host)
	fmt.Println(host)
}
```

åœ¨è¿™é‡Œï¼Œconfig.Loadç”¨äºå¯¼å…¥æŸä¸€ä¸ªæ•°æ®æºä¸­çš„config.jsonæ–‡ä»¶ï¼Œconfig.Getç”¨äºè·å¾—æŸä¸€ä¸ªå±‚çº§ä¸‹çš„æ•°æ®ï¼ŒScanå‡½æ•°ç”¨äºå°†æ•°æ®è§£æåˆ°ç»“æ„ä½“ä¸­ã€‚config.Watchå‡½æ•°ç”¨äºç›‘å¬æŒ‡å®šçš„é…ç½®æ–‡ä»¶æ›´æ–°ã€‚

åœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨[TOML](https://toml.io/en/)æ¥ä½œä¸ºé…ç½®æ–‡ä»¶ã€‚TOMLç›¸æ¯”JSONæ–‡ä»¶çš„ä¼˜åŠ¿åœ¨äºï¼Œèƒ½å¤Ÿä¹¦å†™æ³¨é‡Šï¼Œé˜…è¯»èµ·æ¥ç›¸å¯¹æ¸…æ™°ï¼Œä½†æ˜¯å®ƒä¸é€‚åˆè¡¨ç¤ºä¸€äº›å¤æ‚çš„å±‚æ¬¡ç»“æ„ã€‚è¦æƒ³åœ¨é¡¹ç›®ä¸­è¯»å–TOMLæ•°æ®å¹¶å°†å…¶è½¬åŒ–ä¸ºç±»ä¼¼JSONçš„å±‚æ¬¡ç»“æ„ï¼Œéœ€è¦å¯¼å…¥[TOMLæ’ä»¶åº“](https://github.com/go-micro/plugins/v4/config/encoder/toml)å¹¶åšé¢å¤–çš„å¤„ç†ï¼š

```plain
enc := toml.NewEncoder()
cfg, err := config.NewConfig(config.WithReader(json.NewReader(reader.WithEncoder(enc))))
err = cfg.Load(file.NewSource(
   file.WithPath("config.toml"),
   source.WithEncoder(enc),
))
```

ä¹‹å‰æˆ‘ä»¬æœ‰è®¸å¤šé¡¹ç›®çš„é…ç½®æ˜¯å†™æ­»åœ¨ä»£ç ä¸­çš„ï¼Œä¾‹å¦‚æ•°æ®åº“çš„åœ°å€ã€etcdçš„åœ°å€ã€GRPCæœåŠ¡å™¨çš„ç›‘å¬åœ°å€ï¼Œä»¥åŠè¶…æ—¶æ—¶é—´ã€æ—¥å¿—çº§åˆ«ç­‰ç­‰ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦å°†è¿™äº›é…ç½®è¿ç§»åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œå®ç°å¯é…ç½®åŒ–ã€‚

é¡¹ç›®ä¸­é…ç½®æ–‡ä»¶çš„å¤„ç†æ–¹æ³•æˆ‘è¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ï¼Œå…·ä½“ä½ å¯ä»¥æŸ¥çœ‹[v0.3.2 åˆ†æ”¯](https://github.com/dreamerjackson/crawler)ã€‚

```plain
logLevel = "debug"

Tasks = [
    {Name = "douban_book_list",WaitTime = 2,Reload = true,MaxDepth = 5,Fetcher = "browser",Limits=[{EventCount = 1,EventDur=2,Bucket=1},{EventCount = 20,EventDur=60,Bucket=20}],Cookie = "xxx"},
    {Name = "xxx"},
]

[fetcher]
timeout = 3000
proxy = ["<http://127.0.0.1:8888>", "<http://127.0.0.1:8888>"]

[storage]
sqlURL = "root:123456@tcp(127.0.0.1:3326)/crawler?charset=utf8"

[GRPCServer]
HTTPListenAddress = ":8080"
GRPCListenAddress = ":9090"
ID = "1"
RegistryAddress = ":2379"
RegisterTTL = 60
RegisterInterval = 15
ClientTimeOut   = 10
Name = "go.micro.server.worker"
```

## Makefile

å°†é…ç½®æ–‡ä»¶å‡†å¤‡å¥½ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„å»ºå¹¶è¿è¡Œç¨‹åºäº†ã€‚åœ¨æ„å»ºç¨‹åºæ—¶ï¼Œè¾“å…¥ä¸€é•¿ä¸²çš„æ„å»ºå‘½ä»¤æ¯”è¾ƒç¹çã€‚ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸€äº›æ„å»ºçš„è„šæœ¬å†™å…¥Makefileæ–‡ä»¶ä¸­ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

```plain
VERSION := v1.0.0

LDFLAGS = -X "main.BuildTS=$(shell date -u '+%Y-%m-%d %I:%M:%S')"
LDFLAGS += -X "main.GitHash=$(shell git rev-parse HEAD)"
LDFLAGS += -X "main.GitBranch=$(shell git rev-parse --abbrev-ref HEAD)"
LDFLAGS += -X "main.Version=${VERSION}"

ifeq ($(gorace), 1)
	BUILD_FLAGS=-race
endif

build:
	go build -ldflags '$(LDFLAGS)' $(BUILD_FLAGS) main.go

lint:
	golangci-lint run ./...
```

å…¶ä¸­ï¼Œbuildä¸‹çš„å‘½ä»¤å°±æ˜¯æ„å»ºç¨‹åºçš„å‘½ä»¤ã€‚åœ¨è¿™æ®µå‘½ä»¤ä¸­ï¼ŒLDFLAGSä¸ºç¼–è¯‘æ—¶çš„ä¸€äº›é€‰é¡¹ï¼Œæˆ‘ä»¬åœ¨ç¼–è¯‘æ—¶æ³¨å…¥äº†ç¨‹åºçš„ç‰ˆæœ¬å·ã€åˆ†æ”¯ã€æ„å»ºæ—¶é—´ã€git commitå·ç­‰ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯ä¼šæ³¨å…¥åˆ°main.goä¸­çš„å…¨å±€å˜é‡ä¸­ã€‚åœ¨main.goä¸­ï¼Œæˆ‘ä»¬è¿˜è¦è¿›è¡Œä¸€äº›é…å¥—çš„å¤„ç†ï¼Œç”¨æ¥æ‰“å°ä¸€äº›ç¨‹åºçš„ç‰ˆæœ¬ä¿¡æ¯ã€‚

```plain
// Version information.
var (
	BuildTS   = "None"
	GitHash   = "None"
	GitBranch = "None"
	Version   = "None"
)

func GetVersion() string {
	if GitHash != "" {
		h := GitHash
		if len(h) > 7 {
			h = h[:7]
		}
		return fmt.Sprintf("%s-%s", Version, h)
	}
	return Version
}

// Printer print build version
func Printer() {
	fmt.Println("Version:          ", GetVersion())
	fmt.Println("Git Branch:       ", GitBranch)
	fmt.Println("Git Commit:       ", GitHash)
	fmt.Println("Build Time (UTC): ", BuildTS)
}

var (
	PrintVersion = flag.Bool("version", false, "print the version of this build")
)

func main(){
	flag.Parse()
	if *PrintVersion {
		Printer()
		os.Exit(0)
	}
}
```

å¦‚ä¸‹æ‰€ç¤ºã€‚å½“æˆ‘ä»¬æ‰§è¡Œmake build æ„å»ºå¯è¿è¡Œç¨‹åºï¼Œå¹¶ä¼ é€’ -versionè¿è¡Œå‚æ•°æ—¶ï¼Œå°±ä¼šæ‰“å°å‡ºç¨‹åºçš„ç‰ˆæœ¬ä¿¡æ¯äº†ï¼š

```plain
> make build
> ./main -version

Version:           v1.0.0-ed89d91
Git Branch:        master
Git Commit:        ed89d91d03834fe85b1ca7f74f0cca305b8e516a
Build Time (UTC):  2022-11-30 04:52:45
```

åŒæ—¶åœ¨Makefileä¸­ï¼ŒBUILD\_FLAGSè¡¨ç¤ºæ„å»ºå¯æ‰§è¡Œæ–‡ä»¶çš„å‚æ•°ã€‚å½“æˆ‘ä»¬è®¾ç½®ç¯å¢ƒå˜é‡gorace=1æ—¶ï¼Œgo buildä¼šå°† race å·¥å…·ç¼–è¯‘åˆ°ç¨‹åºä¸­ã€‚æœ€åæˆ‘ä»¬ä¼šçœ‹åˆ°å®Œæ•´çš„æ„å»ºå‘½ä»¤ï¼š

```plain
Â» export gorace=1
Â» make build
go build -ldflags '-X "main.BuildTS=2022-12-03 05:48:59" -X "main.GitHash=e73f1126031f56178ca86deda7fceb0a71b5314e" -X "main.GitBranch=master" -X "main.Version=v1.0.0"'  main.go
```

## æ€»ç»“

è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†é™æ€ä¸åŠ¨æ€çš„ä»£ç æ‰«ææ¥å‘ç°ä»£ç çš„Bugå’Œä¸å¤ªè§„èŒƒçš„ä»£ç ï¼Œè¿™å¯ä»¥å¸®åŠ©å¼€å‘è€…éµå¾ªå›¢é˜Ÿçš„ç¼–ç è§„èŒƒï¼Œä¹¦å†™å‡ºæ›´ä¼˜é›…çš„ç¨‹åºã€‚

åŒæ—¶æˆ‘ä»¬è¿˜çœ‹åˆ°äº†å¦‚ä½•ç”¨go-microçš„configåº“æ¥æ›´çµæ´»åœ°å¯¹é…ç½®æ–‡ä»¶è¿›è¡Œç®¡ç†ã€‚å®ƒä¸ä»…æä¾›äº†é…ç½®åŒ–çš„èƒ½åŠ›ï¼Œè¿˜å®ç°äº†åŠ¨æ€é…ç½®ã€é…ç½®åˆå¹¶çš„èƒ½åŠ›ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†åŠŸèƒ½å…¨é¢çš„é…ç½®ç®¡ç†éœ€è¦è€ƒè™‘çš„å› ç´ ã€‚

æœ€åï¼Œé€šè¿‡ä¹¦å†™Makefileæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œé¢„å…ˆå®šä¹‰å¥½çš„è„šæœ¬ï¼Œæ›´å¿«ã€æ›´ä¼˜é›…åœ°ä¹¦å†™é¡¹ç›®ä»£ç ã€‚

## è¯¾åé¢˜

1. golangci-lintä¸­åŒ…å«äº†ä¼—å¤šçš„lintï¼Œå…¶ä¸­æœ‰äº›lintçš„åŠŸèƒ½æ˜¯è¿‡æ—¶çš„ï¼Œé‡å¤çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­åº”è¯¥è®©å“ªäº›lintç”Ÿæ•ˆå‘¢ï¼Ÿ
2. é…ç½®æ–‡ä»¶ã€JSONæ ¼å¼ä¸TOMLæ ¼å¼åˆ†åˆ«é€‚ç”¨äºå“ªä¸€ç§åœºæ™¯ï¼Ÿ

æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ1ï¼‰</strong></div><ul>
<li><span>konyo</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è·¨åº¦å¥½å¤§å•Š</p>2023-02-03</li><br/>
</ul>