ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ‘å»ºå‹‹ã€‚

åœ¨ä¸Šä¸€èŠ‚è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å®æˆ˜äº†å¹¿åº¦ä¼˜å…ˆæœç´¢ç®—æ³•ï¼Œä¸è¿‡æˆ‘ä»¬å¯¹ç½‘ç«™çš„çˆ¬å–éƒ½æ˜¯åœ¨ä¸€ä¸ªåç¨‹ä¸­è¿›è¡Œçš„ã€‚åœ¨çœŸå®çš„å®è·µåœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸éœ€è¦çˆ¬å–å¤šä¸ªåˆå§‹ç½‘ç«™ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤ŸåŒæ—¶çˆ¬å–è¿™äº›ç½‘ç«™ã€‚è¿™å°±éœ€è¦åˆç†è°ƒåº¦å’Œç»„ç»‡çˆ¬è™«ä»»åŠ¡äº†ã€‚å› æ­¤ï¼Œè¿™èŠ‚è¯¾çš„é‡ç‚¹å°±æ˜¯å®æˆ˜ä»»åŠ¡è°ƒåº¦çš„é«˜å¹¶å‘æ¨¡å‹ï¼Œä½¿èµ„æºå¾—åˆ°å……åˆ†çš„åˆ©ç”¨ã€‚

## å®æˆ˜è°ƒåº¦å¼•æ“

é¦–å…ˆï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹engineç”¨äºå­˜å‚¨è°ƒåº¦å¼•æ“çš„ä»£ç ï¼Œæ ¸å¿ƒçš„è°ƒåº¦é€»è¾‘ä½äºScheduleEngine.Runä¸­ã€‚è¿™éƒ¨åˆ†çš„å®Œæ•´ä»£ç ä½äº [tag v0.1.4](https://github.com/dreamerjackson/crawler)ï¼Œä½ å¯ä»¥å¯¹ç…§ä»£ç è¿›è¡ŒæŸ¥çœ‹ã€‚

è°ƒåº¦å¼•æ“ä¸»è¦ç›®æ ‡æ˜¯å®Œæˆä¸‹é¢å‡ ä¸ªåŠŸèƒ½ï¼š

1. åˆ›å»ºè°ƒåº¦ç¨‹åºï¼Œæ¥æ”¶ä»»åŠ¡å¹¶å°†ä»»åŠ¡å­˜å‚¨èµ·æ¥ï¼›
2. æ‰§è¡Œè°ƒåº¦ä»»åŠ¡ï¼Œé€šè¿‡ä¸€å®šçš„è°ƒåº¦ç®—æ³•å°†ä»»åŠ¡è°ƒåº¦åˆ°åˆé€‚çš„workerä¸­æ‰§è¡Œï¼›
3. åˆ›å»ºæŒ‡å®šæ•°é‡çš„workerï¼Œå®Œæˆå®é™…ä»»åŠ¡çš„å¤„ç†ï¼›
4. åˆ›å»ºæ•°æ®å¤„ç†åç¨‹ï¼Œå¯¹çˆ¬å–åˆ°çš„æ•°æ®è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚

```plain
func (s *ScheduleEngine) Run() {
	requestCh := make(chan *collect.Request)
	workerCh := make(chan *collect.Request)
	out := make(chan collect.ParseResult)
	s.requestCh = requestCh
	s.workerCh = workerCh
	s.out = out
	go s.Schedule()
}
```
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ13ï¼‰</strong></div><ul>
<li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep075ibtmxMf3eOYlBJ96CE9TEelLUwePaLqp8M75gWHEcM3za0voylA0oe9y3NiaboPB891rypRt7w/132" width="30px"><span>shuff1e</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>bugåº”è¯¥æ˜¯ï¼Œä¼šä¸¢å¤±å‘ç»™workerçš„ä»»åŠ¡ã€‚

case r := &lt;-s.requestCh:çš„æƒ…å†µä¸‹ï¼Œå¦‚æœreqä¸æ˜¯nilï¼Œåº”è¯¥æŠŠreqå†æ·»åŠ åˆ°reqQueueå¤´éƒ¨</div>2022-12-15</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI8qibAw4lRCic1pbnA6yzQU3UqtQm3NqV1bUJ5EiaUnJ24V1yf4rtY7n2Wx7ZVvTemqq5a61ERWrrHA/132" width="30px"><span>Alex</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>æœ‰ä¸ªå°é—®é¢˜è¯·æ•™ä¸€ä¸‹è€å¸ˆï¼Œ è¿™ä¸ªSeeds æ˜¯sliceï¼Œ æˆ‘è§‰å¾—åœ¨å–å‡ºä»»åŠ¡çš„æ—¶å€™ä¼šæœ‰å¹¶å‘é—®é¢˜ å¦‚æœæ²¡æœ‰è¯·è€å¸ˆæŒ‡æ•™ä¸‹ </div>2023-02-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/32/fe/c2179924.jpg" width="30px"><span>mantra</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æœ¬æ–‡æ¡£ä¸­çš„ä»£ç é“¾æ¥ tag v0.1.4 ï¼ˆä¹‹å‰çš„æ–‡æ¡£ï¼Œä¹Ÿä¸€æ ·ï¼‰å¯¹åº”çš„ URL éƒ½æ˜¯ä¸»åº“çš„åœ°å€ï¼ˆhttps:&#47;&#47;github.com&#47;dreamerjackson&#47;crawlerï¼‰ï¼Œè¿™æ˜¯æ•…æ„çš„å—ï¼Ÿæ­£ç¡®çš„åº”è¯¥æ˜¯ https:&#47;&#47;github.com&#47;dreamerjackson&#47;crawler&#47;archive&#47;refs&#47;tags&#47;v0.1.4.tar.gz</div>2023-01-13</li><br/><li><img src="" width="30px"><span>7oty</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>å¦‚ä½•æ§åˆ¶æŸä¸ªçˆ¬è™«ä»»åŠ¡çš„å¯åŠ¨ï¼Œåœæ­¢å’Œä»»åŠ¡çš„å®æ—¶è¿è¡ŒçŠ¶æ€ï¼Ÿ</div>2022-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/18/4f/9e4d5591.jpg" width="30px"><span>ç¿¡ç¿ è™</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>å¦‚æœä»»åŠ¡æ¨é€åˆ°workerï¼Œä½†åˆè¿˜æ²¡å®æ–½ï¼Œè¿™æ—¶å€™é‚£å°æœåŠ¡å™¨åœæœºäº†ï¼Œæˆ–è€…è¿›ç¨‹é€€å‡ºäº†ï¼Œä»»åŠ¡ä¼šä¸ä¼šä¸¢ï¼Ÿæ€ä¹ˆå¤„ç†ä»»åŠ¡è¿˜æ²¡æ‰§è¡Œå°±ä¸¢äº†çš„è¿™ç§æƒ…å†µå‘¢ï¼Ÿ</div>2022-12-20</li><br/><li><img src="" width="30px"><span>Geek_a9ea01</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>for { var req *collect.Request var ch chan *collect.Request if len(reqQueue) &gt; 0 { req = reqQueue[0] reqQueue = reqQueue[1:] ch = s.workerCh } select { case r := &lt;-s.requestCh: reqQueue = append(reqQueue, r) case ch &lt;- req: } }
æœ‰ä¸ªé—®é¢˜ï¼š
å¦‚æœchå µå¡äº†  è¿™æ—¶å€™åˆæœ‰requestChè¯·æ±‚ä¸Šæ¥ï¼›ä¼šä¸ä¼šå¯¼è‡´chæ•°æ®ä¸¢å¤±ï¼Ÿ</div>2022-12-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/21/8c13a2b4.jpg" width="30px"><span>å‘¨é¾™äº­</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>func (s *Schedule) Schedule() {
	var reqQueue = s.Seeds
	go func() {
		for {
			var req *collect.Request
			var ch chan *collect.Request

			if len(reqQueue) &gt; 0 {
				req = reqQueue[0]
				ch = s.workerCh
			}
			select {
			case r := &lt;-s.requestCh:
				reqQueue = append(reqQueue, r)

			case ch &lt;- req:
				reqQueue = reqQueue[1:]
			}
		}
	}()
}</div>2023-01-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7f/d3/b5896293.jpg" width="30px"><span>Realm</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>                          
                       Seeds
                           |
                           |              req                     ParseFunc(req)      HandleResult()
requestCh----&gt; reqQueue -----&gt; workerCh ----------&gt; out-----------&gt; result:
^                                                                                                                - item ==&gt; å­˜å‚¨
|                                                                                                                 - req |
|---------------&lt;----------------------&lt;---------------------&lt;------|</div>2022-12-13</li><br/><li><img src="" width="30px"><span>Geek_38ea75</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>æˆ‘æœ‰å¥½å‡ ä¸ªé—®é¢˜
1.ä¸ºå•¥reqå’Œchæ”¾åœ¨forå¾ªç¯å†…éƒ¨å£°æ˜ï¼Œè¿™æ ·æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯workæ¥ä¸åŠæ‰§è¡Œçš„è¯ï¼Œä¼šä¸¢å¤±ã€‚
2.å¦‚æœrequestChä¸­çš„ä»»åŠ¡å¾ˆå¤šçš„è¯ï¼Œä¼šå¯¼è‡´worké˜Ÿåˆ—ä¸­æ²¡æœ‰èƒ½å¤Ÿè¿è¡Œçš„ä»»åŠ¡ã€‚</div>2024-03-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/54/21/8c13a2b4.jpg" width="30px"><span>å‘¨é¾™äº­</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>ä¿®å¤ä¸‹Scheduleæ–¹æ³•çš„bugï¼š

func (s *Schedule) schedule() {
	go func() {
		for r := range s.requestCh {
			s.reqQueueCond.L.Lock()
			s.reqQueue = append(s.reqQueue, r)
			s.reqQueueCond.Signal()
			s.reqQueueCond.L.Unlock()
		}
	}()

	go func() {
		for {
			s.reqQueueCond.L.Lock()
			for len(s.reqQueue) == 0 {
				s.reqQueueCond.Wait()
			}

			var movedReqQueue = s.reqQueue
			s.reqQueue = nil

			s.reqQueueCond.L.Unlock()

			for _, r := range movedReqQueue {
				s.workerCh &lt;- r
			}
		}

	}()
}</div>2023-01-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7f/d3/b5896293.jpg" width="30px"><span>Realm</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>```
func (s *ScheduleEngine) Schedule() {
	var reqQueue = s.Seeds
	go func() {
		for {
			var req *collect.Request
			&#47;&#47;var ch chan *collect.Request
			ch := make(chan *collect.Request)
```
ä½¿ç”¨makeåˆ›å»ºchï¼Œè¿™æ ·chå°±ä¸æ˜¯niläº†ï¼Œå³ä½¿reqQueueä¸ºç©ºçš„æ—¶å€™ï¼Œcase ch &lt;- req:å°±ä¸æ˜¯å¾€nilé€šé“ä¸­å†™æ•°æ®äº†ã€‚</div>2022-12-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/62/8e/985cbc25.jpg" width="30px"><span>è€çŒ«</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>&#47;&#47; s.requestCh = make(chan *collect.Request,100)
&#47;&#47; s.workerCh = make(chan *collect.Request,500)
func (s *ScheduleEngine) Schedule() {
	var reqQueue = s.Seeds
	go func() {
		for _, req := range reqQueue {
			s.workerCh &lt;- req
		}
		for {
			select {
			case r := &lt;-s.requestCh:
				s.workerCh &lt;- r
			}
		}
	}()
}</div>2022-12-13</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/0c/e1/f663213e.jpg" width="30px"><span>æ‹¾æ‡æ‹¾æ‡</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å¼€å¯go run çš„dataraceå‚æ•°å—ï¼Ÿ</div>2022-12-13</li><br/>
</ul>