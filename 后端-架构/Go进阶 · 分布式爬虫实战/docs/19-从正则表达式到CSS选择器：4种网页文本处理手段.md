ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ‘å»ºå‹‹ã€‚

åœ¨ä¸Šä¸€èŠ‚è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†Go Modulesä¾èµ–ç®¡ç†çš„ä½¿ç”¨æ–¹æ³•å’ŒåŸç†ï¼Œè¿™æœ‰åŠ©äºæˆ‘ä»¬åœ¨åæœŸç®¡ç†é¡¹ç›®çš„å¤æ‚ä¾èµ–ã€‚æˆ‘ä¹‹æ‰€ä»¥æå‰ä»‹ç»ä¾èµ–ç®¡ç†ï¼Œæ˜¯å› ä¸ºæ–°é¡¹ç›®ä¸€å¼€å§‹ä¸€èˆ¬å°±ä¼šé€šè¿‡go mod initåˆå§‹åŒ–å½“å‰é¡¹ç›®çš„moduleåã€‚

æˆ‘ä»¬ä¹‹å‰ä¹Ÿçœ‹åˆ°äº†å¦‚ä½•åœ¨Goä¸­é€šè¿‡ç®€å•çš„å‡½æ•°è°ƒç”¨è·å–ç½‘é¡µä¸­çš„æ•°æ®ã€‚ç„¶è€Œå•å•è·å–æœåŠ¡å™¨è¿”å›çš„æ–‡æœ¬æ•°æ®æ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼Œä¿¡æ¯å’ŒçŸ¥è¯†å°±éšè—åœ¨è¿™äº›æ‚ä¹±çš„æ•°æ®ä¹‹ä¸­ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æœ‰æ¯”è¾ƒå¼ºçš„æ–‡æœ¬è§£æèƒ½åŠ›ï¼Œå°†æœ‰ç”¨çš„ä¿¡æ¯æå–å‡ºæ¥ã€‚è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹å¦‚ä½•é€šè¿‡Goæ ‡å‡†åº“ã€æ­£åˆ™è¡¨è¾¾å¼ã€XPathä»¥åŠCSSé€‰æ‹©å™¨å¯¹å¤æ‚æ–‡æœ¬è¿›è¡Œè§£æã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨ä»»æ„ä½ç½®æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼š

```plain
>  mkdir crawler
```

å†æ–°å»ºä¸€ä¸ªå…¥å£æ–‡ä»¶ï¼š

```plain
> cd crawler
> touch main.go
```

## **åˆå§‹åŒ–Gitä»“åº“**

æˆ‘å…ˆåœ¨GitHubä¸Šåˆ›å»ºäº†ä¸€ä¸ªGitä»“åº“ï¼Œåå­—å«crawlerã€‚æ¥ç€ï¼Œæˆ‘åœ¨æœ¬åœ°æ–°å»ºäº†ä¸€ä¸ªREADMEæ–‡ä»¶ï¼Œå¹¶å»ºç«‹äº†æœ¬åœ°ä»“åº“å’Œè¿œç¨‹ä»“åº“ä¹‹é—´çš„å…³è”ï¼ˆä½ éœ€è¦å°†ä¸‹é¢çš„ä»“åº“åœ°å€æ›¿æ¢ä¸ºè‡ªå·±çš„ï¼‰ï¼š

```plain
echo "# crawler" >> README.md
git init
git add README.md
git commit -m "first commit"
git branch -M 'main'
git remote add origin git@github.com:dreamerjackson/crawler.git
git push -u origin 'main'
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦åˆå§‹åŒ–é¡¹ç›®çš„go.modæ–‡ä»¶ï¼Œmoduleåä¸€èˆ¬ä¸ºè¿œç¨‹Gitä»“åº“çš„åå­—ï¼š

```plain
go mod init  github.com/dreamerjackson/crawler
```

åç»­æˆ‘ä¼šå°†é¡¹ç›®çš„æºç æ”¾ç½®åˆ° [GitHub](https://github.com/dreamerjackson/crawler) ä¸­ï¼Œæ¬¢è¿ä½ ç§¯ææäº¤PRï¼Œå¤§å®¶ä¸€èµ·è¿›æ­¥ã€‚

ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª `.gitignore` æ–‡ä»¶ï¼Œ`.gitignore` æ–‡ä»¶çš„å†…å®¹ä¸ä¼šè¢«Gitè¿½è¸ªã€‚å½“æœ‰ä¸€äº›ç¼–è¾‘å™¨çš„é…ç½®æ–‡ä»¶æˆ–å…¶ä»–æ–‡ä»¶ä¸æƒ³æäº¤åˆ°Gitä»“åº“æ—¶ï¼Œå¯ä»¥å°†æ–‡ä»¶è·¯å¾„æ”¾å…¥ `.gitignore` æ–‡ä»¶ã€‚

```plain
echo .idea  >> .gitignore
```

## **æŠ“å–ä¸€ä¸ªç®€å•çš„ç½‘é¡µ**

å‡è®¾æˆ‘ä»¬å¸Œæœ›è·å–ä¸€äº›æœ€æ–°çš„æ–°é—»èµ„è®¯ï¼Œä½†æ˜¯æˆ‘ä»¬å´ä¸å¯èƒ½æ—¶åˆ»å®ˆåœ¨ç”µè„‘æ—åˆ·æ–°ç½‘é¡µï¼Œè¿™å°±æ˜¯çˆ¬è™«å¤§æ˜¾èº«æ‰‹çš„åœ°æ–¹äº†ã€‚æˆ‘ä»¬ä»¥çŸ¥åçš„[æ¾æ¹ƒæ–°é—»](https://www.thepaper.cn/)ä¸ºä¾‹ï¼Œè·å–å…¶é¦–é¡µçš„æ–°é—»å†…å®¹ã€‚

ä¸€å¼€å§‹æˆ‘é€‰å–æ¾æ¹ƒæ–°é—»è¿™ä¸ªç½‘ç«™ï¼Œæ˜¯å› ä¸ºæ¾æ¹ƒæ–°é—»çš„é¦–é¡µä¸éœ€è¦ç™»å½•ï¼Œä¹Ÿæ²¡æœ‰ä¸¥å‰çš„åæ‰’æœºåˆ¶ã€‚è¿™èƒ½å¤Ÿå‡è½»ä½ åˆšå¼€å§‹å­¦ä¹ çˆ¬è™«çš„å¿ƒç†è´Ÿæ‹…ï¼Œèšç„¦äºè¿™èŠ‚è¯¾ä¼ æˆçš„çŸ¥è¯†ã€‚

è·å–æ–°é—»é¦–é¡µHTMLæ–‡æœ¬çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

```plain
package main

import (
	"fmt"
	"io/ioutil"
	"net/http"
)

func main() {
	url := "https://www.thepaper.cn/"
	resp, err := http.Get(url)

	if err != nil {
		fmt.Println("fetch url error:%v", err)
		return
	}

	defer resp.Body.Close()

	if resp.StatusCode != http.StatusOK {
		fmt.Printf("Error status code:%v", resp.StatusCode)
	  return
	}

	body, err := ioutil.ReadAll(resp.Body)

	if err != nil {
		fmt.Println("read content failed:%v", err)
		return
	}

	fmt.Println("body:", string(body))
}
```

è¿™æ®µä»£ç åšäº†æ¯”è¾ƒå®Œå¤‡çš„é”™è¯¯æ£€æŸ¥ã€‚ä¸ç®¡æ˜¯http.Getè®¿é—®ç½‘ç«™æŠ¥é”™ã€æœåŠ¡å™¨è¿”å›çš„çŠ¶æ€ç ä¸æ˜¯200ï¼Œè¿˜æ˜¯è¯»å–è¿”å›çš„æ•°æ®æœ‰è¯¯ï¼Œéƒ½ä¼šæ‰“å°é”™è¯¯åˆ°æ§åˆ¶å°ï¼Œå¹¶ç«‹å³è¿”å›ã€‚ioutil.ReadAllä¼šè¯»å–è¿”å›æ•°æ®çš„å­—èŠ‚æ•°ç»„ã€‚ç„¶åå°†å­—èŠ‚æ•°ç»„å¼ºè½¬ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œæœ€åè¾“å‡ºç»“æœã€‚

åœ¨æˆ‘ä»¬å½“å‰è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œè¾“å‡ºçš„æ–‡æœ¬æ˜¯HTMLæ ¼å¼çš„ã€‚HTMLåˆè¢«ç§°ä¸ºè¶…æ–‡æœ¬æ ‡è®°è¯­è¨€ã€‚å…¶ä¸­ï¼Œè¶…æ–‡æœ¬æŒ‡çš„æ˜¯åŒ…å«å…·æœ‰æŒ‡å‘å…¶ä»–æ–‡æœ¬é“¾æ¥çš„æ–‡æœ¬ ã€‚é€šè¿‡é“¾æ¥ï¼Œå•ä¸ªç½‘ç«™å†…æˆ–ç½‘ç«™ä¹‹é—´å°±è¿æ¥äº†èµ·æ¥ã€‚

æ ‡è®°æŒ‡çš„æ˜¯é€šè¿‡é€šå¸¸æ˜¯æˆå¯¹å‡ºç°çš„æ ‡ç­¾æ¥æ ‡è¯†æ–‡æœ¬çš„å±æ€§å’Œç»“æ„ã€‚ä¾‹å¦‚ï¼Œ`<h1>xxx</h1>` æ ‡è¯†å…ƒç´ çš„æ ·å¼æ˜¯ä¸€çº§æ ‡é¢˜ï¼Œ`<h2>xxx</h2>` æ ‡è¯†å…ƒç´ çš„æ ·å¼æ˜¯äºŒçº§æ ‡é¢˜ ã€‚è€Œ `<img>` æ ‡è¯†å½“å‰å…ƒç´ æ˜¯ä¸€å¼ å›¾ç‰‡ã€‚å…¶ä»–çš„æ ‡ç­¾è¿˜æœ‰`<title>, <body>, <header>, <footer>, <article>, <section>, <p>, <div>, <span>` â€¦

HTMLå®šä¹‰äº†å…ƒç´ çš„å«ä¹‰å’Œç»“æ„ã€‚ä¸è¿‡éšç€CSSæ–‡ä»¶çš„å‡ºç°ï¼ŒHTMLåœ¨æ–‡æœ¬æ ·å¼ä¸Šçš„åŠŸèƒ½é€æ¸å¼±åŒ–äº†ã€‚æ ‡ç­¾å’Œæ ‡ç­¾é‡Œçš„å±æ€§ï¼ˆä¾‹å¦‚`<div class="news_li" id="cont19144401" >` ï¼‰ä¸€èˆ¬æ˜¯ä½œä¸ºCSSé€‰æ‹©å™¨çš„é’©å­å‡ºç°çš„ã€‚

æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸Šçœ‹åˆ°çš„ç½‘é¡µï¼Œå…¶å®æ˜¯å°†HTMLæ–‡ä»¶ã€CSSæ ·å¼æ–‡ä»¶è¿›è¡Œäº†æ¸²æŸ“ï¼ŒåŒæ—¶ï¼ŒJavaScriptæ–‡ä»¶è¿˜å¯ä»¥è®©ç½‘ç«™å®Œæˆä¸€äº›åŠ¨æ€çš„æ•ˆæœï¼Œä¾‹å¦‚å®æ—¶çš„å†…å®¹æ›´æ–°ï¼Œäº¤äº’å¼çš„å†…å®¹ç­‰ã€‚

æˆ‘ä»¬å…ˆé€šè¿‡Linuxç®¡é“çš„æ–¹å¼å°†è¾“å‡ºçš„æ–‡æœ¬ä¿å­˜åˆ°new.htmlæ–‡ä»¶ä¸­ï¼š

```plain
go run main.go > new.html
```

ç”¨æµè§ˆå™¨æ‰“å¼€ä¹‹åä¼šçœ‹åˆ°ï¼Œå½“å‰çš„é¡µé¢å’ŒçœŸå®çš„é¡µé¢ç›¸æ¯”ï¼Œè¿˜åŸåº¦æ˜¯æ¯”è¾ƒé«˜çš„ã€‚å½“ç„¶æˆ‘ä»¬æ— æ³•ç”¨è¿™ç§æ–¹å¼100%è¿˜åŸç½‘é¡µï¼Œå› ä¸ºç¼ºå¤±äº†å¿…è¦çš„æ–‡ä»¶ï¼Œè€Œä¸”æœ‰ä¸€äº›æ•°æ®æ˜¯é€šè¿‡JavaScriptåŠ¨æ€è·å–çš„ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/2b/8d/2ba3ffd626699df88186d81f0f1ffc8d.png?wh=1920x979)

ä¸è¿‡ï¼Œå°±æˆ‘ä»¬å½“ä¸‹çš„ç›®æ ‡è€Œè¨€ï¼Œè·å–åˆ°çš„ä¿¡æ¯å·²ç»è¶³å¤Ÿäº†ã€‚

åœ¨é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¼šç”¨Gitåœ¨å…³é”®çš„åœ°æ–¹æ‰“ä¸Štagï¼Œæ–¹ä¾¿ä½ ä¹‹åæŸ¥æ‰¾å½“å‰çš„ä»£ç ã€‚ä¸Šè¿°ä»£ç ä½äºv0.0.1åˆ†æ”¯ä¸­ã€‚

```plain
git commit -am "print resp"
git tag -a v0.0.1 -m "print resp"
git push origin v0.0.1
```

æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å¤„ç†æœåŠ¡å™¨è¿”å›çš„HTMLæ–‡æœ¬ã€‚

## **strings**

Goè¯­è¨€æä¾›äº†stringsæ ‡å‡†åº“ç”¨äºå­—ç¬¦å¤„ç†å‡½æ•°ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨æ ‡å‡†åº“stringsåŒ…ä¸­ï¼ŒåŒ…å«å­—ç¬¦æŸ¥æ‰¾ã€åˆ†å‰²ã€å¤§å°å†™è½¬æ¢ã€ä¿®å‰ªï¼ˆtrimï¼‰ã€è®¡ç®—å­—ç¬¦å‡ºç°æ¬¡æ•°ç­‰æ•°åä¸ªå‡½æ•°ã€‚

```plain
// åˆ¤æ–­å­—ç¬¦ä¸²s æ˜¯å¦åŒ…å«substr å­—ç¬¦ä¸²
func Contains(s, substr string) bool
// åˆ¤æ–­å­—ç¬¦ä¸²s æ˜¯å¦åŒ…å«chars å­—ç¬¦ä¸²ä¸­çš„ä»»ä¸€å­—ç¬¦
func ContainsAny(s, chars string) bool
// åˆ¤æ–­å­—ç¬¦ä¸²s æ˜¯å¦åŒ…å«ç¬¦æ–‡æ•°r
func ContainsRune(s string, r rune) bool
// å°†å­—ç¬¦ä¸²s ä»¥ç©ºç™½å­—ç¬¦åˆ†å‰²ï¼Œè¿”å›ä¸€ä¸ªåˆ‡ç‰‡
func Fields(s string) []string
// å°†å­—ç¬¦ä¸²s ä»¥æ»¡è¶³f(r)==true çš„å­—ç¬¦åˆ†å‰²ï¼Œè¿”å›ä¸€ä¸ªåˆ‡ç‰‡
func FieldsFunc(s string, f func(rune) bool) []string
// å°†å­—ç¬¦ä¸²s ä»¥sep ä¸ºåˆ†éš”ç¬¦è¿›è¡Œåˆ†å‰²ï¼Œåˆ†å‰²åå­—ç¬¦æœ«å°¾å»æ‰sep
func Split(s, sep string) []string
```

åœ¨æ ‡å‡†åº“strconvåŒ…ä¸­ï¼Œè¿˜åŒ…å«å¾ˆå¤šå­—ç¬¦ä¸²ä¸å…¶ä»–ç±»å‹è¿›è¡Œè½¬æ¢çš„å‡½æ•°ï¼š

```plain
// å­—ç¬¦ä¸²è½¬æ¢ä¸ºåè¿›åˆ¶æ•´æ•°
func Atoi(s string) (int, error)
// å­—ç¬¦ä¸²è½¬æ¢ä¸ºæŸä¸€è¿›åˆ¶çš„æ•´æ•°ï¼Œä¾‹å¦‚å…«è¿›åˆ¶ã€åå…­è¿›åˆ¶
func ParseInt(s string, base int, bitSize int) (i int64, err error)
// æ•´æ•°è½¬æ¢ä¸ºå­—ç¬¦ä¸²
func Itoa(i int) string
// æŸä¸€è¿›åˆ¶çš„æ•´æ•°è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œä¾‹å¦‚å…«è¿›åˆ¶æ•´æ•°è½¬æ¢ä¸ºå­—ç¬¦ä¸²
func FormatInt(i int64, base int) string
```

è®©æˆ‘ä»¬ç”¨stringsåŒ…å®æˆ˜ä¸€ä¸‹ã€‚

åœ¨HTMLæ–‡æœ¬ä¸­ï¼Œè¶…é“¾æ¥ä¸€èˆ¬æ”¾ç½®åœ¨ `<a>` æ ‡ç­¾ä¸­ï¼Œå› æ­¤ï¼Œç»Ÿè®¡ `<a>` æ ‡ç­¾çš„æ•°é‡å°±èƒ½å¤§è‡´äº†è§£å½“å‰é¡µé¢ä¸­é“¾æ¥çš„æ€»æ•°ï¼š

```plain
// tag v0.0.3
func main() {
	url := "https://www.thepaper.cn/"
	resp, err := http.Get(url)

	if err != nil {
		fmt.Println("fetch url error:%v", err)
		return
	}

	defer resp.Body.Close()

	if resp.StatusCode != http.StatusOK {
		fmt.Printf("Error status code:%v", resp.StatusCode)
	}

	body, err := ioutil.ReadAll(resp.Body)

	if err != nil {
		fmt.Println("read content failed:%v", err)
		return
	}

	numLinks := strings.Count(string(body), "<a")
	fmt.Printf("homepage has %d links!\n", numLinks)

}
```

è¿è¡Œä¸Šé¢è¿™æ®µä»£ç ï¼Œè¾“å‡ºçš„ç»“æœæ˜¾ç¤ºæœ‰300ä½™ä¸ªé“¾æ¥ã€‚

```plain
homepage has 303 links!
```

stringsåŒ…ä¸­å¦ä¸€ä¸ªæœ‰ç”¨çš„å‡½æ•°æ˜¯ `Contains`ã€‚å¦‚æœä½ æƒ³äº†è§£å½“å‰é¦–é¡µæ˜¯å¦å­˜åœ¨ç–«æƒ…ç›¸å…³çš„æ–°é—»ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™æ®µä»£ç ï¼š

```plain
	...
	exist := strings.Contains(string(body), "ç–«æƒ…")
	fmt.Printf("æ˜¯å¦å­˜åœ¨ç–«æƒ…:%v\n", exist)
```

æˆ‘ä»¬çŸ¥é“ï¼Œå­—ç¬¦ä¸²çš„æœ¬è´¨å…¶å®æ˜¯å­—èŠ‚æ•°ç»„ï¼Œbytesæ ‡å‡†åº“æä¾›çš„APIå…·æœ‰å’Œstringsåº“ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½ å¯ä»¥ç›´æ¥æŸ¥çœ‹[æ ‡å‡†åº“çš„æ–‡æ¡£](https://pkg.go.dev/bytes)ã€‚

```plain
func Compare(a, b []byte) int
func Contains(b, subslice []byte) bool
func Count(s, sep []byte) int
func Index(s, sep []byte) int
...
```

ä¸‹é¢è¿™æ®µä½¿ç”¨bytesæ ‡å‡†åº“çš„ä»£ç å’Œä¸Šé¢ä½¿ç”¨stringsåº“çš„ä»£ç åœ¨åŠŸèƒ½ä¸Šæ˜¯ç­‰ä»·çš„ï¼š

```plain
numLinks := bytes.Count(body, []byte("<a"))
fmt.Printf("homepage has %d links!\n", numLinks)

exist := bytes.Contains(body, []byte("ç–«æƒ…"))
fmt.Printf("æ˜¯å¦å­˜åœ¨ç–«æƒ…:%v\n", exist)
```

### å­—ç¬¦ç¼–ç 

æœåŠ¡å™¨åœ¨ç½‘ç»œä¸­å°†HTMLæ–‡æœ¬ä»¥äºŒè¿›åˆ¶çš„å½¢å¼ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚åœ¨ä¹‹å‰çš„ä¾‹å­ä¸­ï¼Œioutil.ReadAllå‡½æ•°å¾—åˆ°çš„ç»“æœæ˜¯å­—èŠ‚æ•°ç»„ï¼Œæˆ‘ä»¬å°†å®ƒå¼ºåˆ¶è½¬æ¢ä¸ºäº†äººç±»å¯è¯»çš„å­—ç¬¦ä¸²ã€‚åœ¨Goè¯­è¨€ä¸­ï¼Œå­—ç¬¦ä¸²æ˜¯é»˜è®¤é€šè¿‡UTF-8çš„å½¢å¼ç¼–ç çš„ã€‚

è™½ç„¶ç›®å‰å¤§å¤šæ•°ç½‘ç«™éƒ½ä½¿ç”¨UTF-8ç¼–ç ï¼Œä½†å…¶å®æœåŠ¡å™¨å‘é€è¿‡æ¥çš„HTMLæ–‡æœ¬å¯èƒ½æ‹¥æœ‰å¾ˆå¤šç¼–ç å½¢å¼ï¼Œä¾‹å¦‚ASCIIã€GB2312ã€UTF-8ã€UTF-16ã€‚ä¸€äº›å›½å†…çš„ç½‘ç«™å°±ä¼šé‡‡ç”¨GB2312çš„ç¼–ç æ–¹å¼ã€‚ä¸è¿‡ï¼Œå¦‚æœç¼–ç çš„å½¢å¼ä¸è§£ç çš„å½¢å¼ä¸åŒï¼Œå¯èƒ½ä¼šå‡ºç°ä¹±ç çš„æƒ…å†µã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/d4/fc/d44590a784edb522426676402e6d45fc.png?wh=1920x328)

ä¸ºäº†è®©è¯·æ±‚ç½‘é¡µçš„åŠŸèƒ½å…·å¤‡é€šç”¨æ€§ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘ç¼–ç é—®é¢˜ã€‚åœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å…ˆå°†è¯·æ±‚ç½‘é¡µçš„åŠŸèƒ½ç”¨Fetchå‡½æ•°å°è£…èµ·æ¥ï¼Œç”¨å‡½æ•°ç»™ä¸€è¿ä¸²çš„å¤åˆæ“ä½œå®šä¹‰ä¸€ä¸ªåå­—ï¼Œå°†å…¶ä½œä¸ºä¸€ä¸ªæ“ä½œå•å…ƒï¼Œå®ç°ä»£ç çš„å¤ç”¨å’ŒåŠŸèƒ½æŠ½è±¡ã€‚è¦å®ç°ç¼–ç çš„é€šç”¨æ€§ï¼Œæˆ‘ä»¬ä½¿ç”¨å®˜æ–¹å¤„ç†å­—ç¬¦é›†çš„åº“ï¼š

```plain
go get golang.org/x/net/html/charset
go get golang.org/x/text/encoding
```

Fetchå‡½æ•°çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶è·å–ç½‘é¡µçš„å†…å®¹ï¼Œæ£€æµ‹ç½‘é¡µçš„å­—ç¬¦ç¼–ç å¹¶å°†æ–‡æœ¬ç»Ÿä¸€è½¬æ¢ä¸ºUTF-8æ ¼å¼ã€‚

```plain
// tag v0.0.4
func Fetch(url string) ([]byte, error) {

	resp, err := http.Get(url)

	if err != nil {
		panic(err)
	}

	defer resp.Body.Close()

	if resp.StatusCode != http.StatusOK {
		fmt.Printf("Error status code:%d", resp.StatusCode)
	}
	bodyReader := bufio.NewReader(resp.Body)
	e := DeterminEncoding(bodyReader)
	utf8Reader := transform.NewReader(bodyReader, e.NewDecoder())
	return ioutil.ReadAll(utf8Reader)
}

func DeterminEncoding(r *bufio.Reader) encoding.Encoding {

	bytes, err := r.Peek(1024)

	if err != nil {
		fmt.Println("fetch error:%v", err)
		return unicode.UTF8
	}

	e, _, _ := charset.DetermineEncoding(bytes, "")
	return e
}
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å•ç‹¬å°è£…äº†DeterminEncodingå‡½æ•°æ¥æ£€æµ‹å¹¶è¿”å›å½“å‰HTMLæ–‡æœ¬çš„ç¼–ç æ ¼å¼ã€‚å¦‚æœè¿”å›çš„HTMLæ–‡æœ¬å°äº1024å­—èŠ‚ï¼Œæˆ‘ä»¬è®¤ä¸ºå½“å‰HTMLæ–‡æœ¬æœ‰é—®é¢˜ï¼Œç›´æ¥è¿”å›é»˜è®¤çš„UTF-8ç¼–ç å°±å¥½äº†ã€‚DeterminEncodingä¸­æ ¸å¿ƒçš„charset.DetermineEncodingå‡½æ•°ç”¨äºæ£€æµ‹å¹¶è¿”å›å¯¹åº”HTMLæ–‡æœ¬çš„ç¼–ç ã€‚å…³äºcharset.DetermineEncodingå‡½æ•°æ£€æµ‹å­—ç¬¦ç¼–ç çš„ç®—æ³•ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥æŸ¥çœ‹[è¿™ç¯‡æ–‡ç« ](https://html.spec.whatwg.org/multipage/parsing.html#determining-the-character-encoding)ã€‚

æœ€åï¼Œtransform.NewReader ç”¨äºå°†HTMLæ–‡æœ¬ä»ç‰¹å®šç¼–ç è½¬æ¢ä¸ºUTF-8ç¼–ç ï¼Œä»è€Œæ–¹ä¾¿åç»­çš„å¤„ç†ã€‚

ä¸è¿‡å‘¢ï¼Œstringsã€bytesæ ‡å‡†åº“é‡Œå¯¹å­—ç¬¦ä¸²çš„å¤„ç†éƒ½æ˜¯æ¯”è¾ƒå¸¸è§„çš„ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦å¯¹æ–‡æœ¬è¿›è¡Œæ›´å¤æ‚çš„å¤„ç†ã€‚ä¾‹å¦‚ï¼Œæƒ³çˆ¬å–ä¸€ä¸ªå›¾ä¹¦ç½‘ç«™ä¸åŒå›¾ä¹¦å¯¹åº”çš„ä½œè€…ã€å‡ºç‰ˆç¤¾ã€é¡µæ•°ã€å®šä»·ç­‰ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯éƒ½åŒ…å«åœ¨HTMLç‰¹æ®Šçš„æ ‡ç­¾ç»“æ„ä¸­ï¼Œå¹¶ä¸”ä¸åŒä¹¦ç±å¯¹åº”çš„è¿™äº›ä¿¡æ¯éƒ½ä¸å¤ªä¸€æ ·ã€‚

è¦å®ç°è¿™ç§çµæ´»çš„åŠŸèƒ½ï¼Œåˆ©ç”¨stringsã€bytesæ ‡å‡†åº“éƒ½æ˜¯å¾ˆéš¾åšåˆ°çš„ã€‚è¿™å°±è¦ç”¨åˆ°ä¸€ä¸ªæ›´å¼ºå¤§çš„æ–‡æœ¬å¤„ç†æ–¹æ³•äº†ï¼šæ­£åˆ™è¡¨è¾¾å¼ã€‚

## æ­£åˆ™è¡¨è¾¾å¼

**æ­£åˆ™è¡¨è¾¾å¼æ˜¯ä¸€ç§æè¿°æ–‡æœ¬å†…å®¹ç»„æˆè§„å¾‹çš„è¡¨ç¤ºæ–¹å¼ï¼Œå®ƒå¯ä»¥æè¿°æˆ–è€…åŒ¹é…ç¬¦åˆç›¸åº”è§„åˆ™çš„å­—ç¬¦ä¸²ã€‚**åœ¨æ–‡æœ¬ç¼–è¾‘å™¨ã€å‘½ä»¤è¡Œå·¥å…·ã€é«˜çº§ç¨‹åºè¯­è¨€ä¸­ï¼Œæ­£åˆ™è¡¨è¾¾å¼è¢«å¹¿æ³›åœ°ç”¨æ¥æ ¡éªŒæ•°æ®çš„æœ‰æ•ˆæ€§ã€æœç´¢æˆ–æ›¿æ¢ç‰¹å®šæ¨¡å¼çš„å­—ç¬¦ä¸²ã€‚

ç”±äºå†å²åŸå› ï¼Œæ­£åˆ™è¡¨è¾¾å¼åˆ†ä¸ºäº†ä¸¤ä¸ªæµæ´¾ï¼Œåˆ†åˆ«æ˜¯ POSIX æµæ´¾å’Œ PCRE æµæ´¾ã€‚å…¶ä¸­ï¼ŒPOSIX æµæ´¾æœ‰ä¸¤ä¸ªæ ‡å‡†ï¼Œåˆ†åˆ«æ˜¯ BRE æ ‡å‡†å’Œ ERE æ ‡å‡†ã€‚ä¸åŒçš„æµæ´¾å’Œæ ‡å‡†å¯¹åº”äº†ä¸åŒçš„ç‰¹æ€§ä¸å·¥å…·ï¼Œä¸€äº›å·¥å…·å¯èƒ½å¯¹æ ‡å‡†åšäº†ç›¸åº”çš„æ‰©å±•ã€‚è¿™å°±è®©ä¸€äº›æ²¡æœ‰ç³»ç»Ÿå­¦ä¹ è¿‡æ­£åˆ™è¡¨è¾¾å¼çš„åŒå­¦ï¼Œå¯¹ä¸€äº›æ­£åˆ™çš„ä½¿ç”¨å’Œç°è±¡æ„Ÿåˆ°å›°æƒ‘äº†ã€‚

ç›®å‰ï¼ŒLinuxå’ŒMacåœ¨åŸç”Ÿé›†æˆGUNå¥—ä»¶ï¼ˆä¾‹å¦‚grepå‘½ä»¤ï¼‰æ—¶ï¼Œéµå¾ªäº†POSIXæ ‡å‡†ï¼Œå¹¶å¼±åŒ–äº†GNU BRE å’Œ GNU EREä¹‹é—´çš„åŒºåˆ«ã€‚

**GNU BRE å’Œ GNU ERE çš„å·®åˆ«ä¸»è¦ä½“ç°åœ¨ä¸€äº›è¯­æ³•å­—ç¬¦æ˜¯å¦éœ€è¦è½¬ä¹‰ä¸Šã€‚**å¦‚ä¸‹æ‰€ç¤ºï¼Œgrep å±äºGNU BREæ ‡å‡†ï¼Œå¯¹äºå­—ç¬¦ä¸²"addf"ï¼Œè¦æƒ³èƒ½å¤ŸåŒ¹é…å­—æ¯d é‡å¤1-3æ¬¡çš„æƒ…å½¢ï¼Œéœ€è¦å¯¹"{"è¿›è¡Œè½¬ä¹‰ï¼š

```plain
> echo  "addf" | grep  'd\{1,3\}'
```

GNU EREæ ‡å‡†ä¸éœ€è¦å¯¹"{"è¿›è¡Œè½¬ä¹‰ã€‚è¦ä½¿ç”¨GNU EREæ ‡å‡†ï¼Œéœ€è¦åœ¨ Linux çš„ grep ä¸­æ·»åŠ  -E è¿è¡Œå‚æ•°ã€‚

```plain
> echo  "addf" | grep -E 'd{1,3}'
```

å¦ä¸€ç§å½“å‰æ›´åŠ æµè¡Œçš„æµæ´¾æˆ–æ ‡å‡†æ˜¯PCREã€‚

PCREæ ‡å‡†æ˜¯ç”±perlè¿™é—¨è¯­è¨€è¡ç”Ÿè€Œæ¥çš„ï¼Œç°é˜¶æ®µçš„å¤§éƒ¨åˆ†é«˜çº§ç¼–ç¨‹è¯­è¨€éƒ½ä½¿ç”¨äº†PCREæ ‡å‡†ã€‚åœ¨Goè¯­è¨€ä¸­ï¼Œæ­£åˆ™è¡¨è¾¾å¼æ ‡å‡†åº“ä¹Ÿæ˜¯é»˜è®¤ä½¿ç”¨äº†PCREæ ‡å‡†ï¼Œä¸è¿‡GoåŒæ—¶ä¹Ÿæ”¯æŒPOSIXæ ‡å‡†ã€‚

è¦ä½¿ç”¨PCREæ ‡å‡†ï¼Œå¯ä»¥åœ¨grepä¸­æ·»åŠ -P è¿è¡Œå‚æ•°ã€‚å¦‚ä¸‹æ‰€ç¤ºã€‚EREæ ‡å‡†ä¸æ”¯æŒç”¨ `\d` è¡¨ç¤ºæ•°å­—ï¼Œä½†æ˜¯PCREæ ‡å‡†æ˜¯æ”¯æŒçš„ã€‚

```plain
# ä½¿ç”¨ ERE æ ‡å‡†
> echo  "11d23a" | grep -E '[[:digit:]]+' 

# ä½¿ç”¨ PCRE æ ‡å‡†
> echo  "11d23a" | grep -P '\d+'
```

é™¤æ­¤ä¹‹å¤–ï¼ŒPCRE æ ‡å‡†è¿˜æœ‰ä¸€äº›å¼ºå¤§çš„åŠŸèƒ½ï¼Œä½ å¯ä»¥æœç´¢â€œPerl regular expressionsâ€æˆ–æŸ¥çœ‹[è¿™ç¯‡æ–‡æ¡£](https://perldoc.perl.org/perlretut)ã€‚

åœ¨è¿™é‡Œï¼Œè®©æˆ‘ä»¬ç”¨æ­£åˆ™è¡¨è¾¾å¼å®æˆ˜è·å–ä¸€ä¸‹æ¾æ¹ƒæ–°é—»é¦–é¡µå¡ç‰‡ä¸­çš„æ–°é—»ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/1e/37/1ec37cc7db001e68280e5bb322e26537.png?wh=1920x1407)

æˆ‘ä»¬åœ¨ä¹‹å‰å·²ç»é€šè¿‡v0.0.1ä¸­çš„ä»£ç è·å–åˆ°äº†é¦–é¡µçš„å†…å®¹ã€‚ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹HTMLä¸­è¿™äº›å¡ç‰‡åœ¨ç»“æ„ä¸Šçš„å…±æ€§ã€‚ä¸‹é¢æ˜¯æˆ‘åˆ—å‡ºçš„ä¸¤ä¸ªå¡ç‰‡çš„å†…å®¹ï¼Œæˆ‘çœå»äº†ä¸€äº›ä¸å¿…è¦çš„å†…å®¹ã€‚

```plain
    <div class="news_li" id="cont19144401" contType="0">
        ...
        <h2>
            <a href="newsDetail_forward_19144401" id="clk19144401" target="_blank">åœ¨å…»è€é™¢åœæ­¢æ¢è§†çš„æ—¥å­é‡Œï¼Œçˆ¶äº²ä¸è®¤è¯†æˆ‘äº†</a>
        </h2>
        ...
	</div>

    <div class="news_li" id="cont19145751" contType="0">
        ...
        <h2>
            <a href="newsDetail_forward_19145751" id="clk19145751" target="_blank">ç¾å›½è€ƒè™‘å‘ä¹Œå…‹å…°æä¾›æˆ˜æ–—æœºï¼Œç¾å‚ä¸ä¿„ä¹Œå†²çªç¨‹åº¦æˆ–å°†æ‰©å¤§</a>
        </h2>
        ...
	</div>

```

å¯ä»¥çœ‹åˆ°ï¼Œæ–‡ç« çš„æ ‡é¢˜ä½äº `<a>` æ ‡ç­¾ä¸­ï¼Œå¯ä»¥è·³è½¬ã€‚å¤–éƒ¨åŒ…è£¹äº† `<h2>` æ ‡ç­¾ä»¥åŠå±æ€§classä¸ºnews\_liçš„ `<div>` æ ‡ç­¾ã€‚çŸ¥é“è¿™äº›ä¿¡æ¯åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥è·å–å¡ç‰‡æ–°é—»ä¸­çš„æ ‡é¢˜äº†ï¼š

```plain
// tag v0.0.5
var headerRe = regexp.MustCompile(`<div class="news_li"[\s\S]*?<h2>[\s\S]*?<a.*?target="_blank">([\s\S]*?)</a>`)

func main() {
	url := "https://www.thepaper.cn/"
	body, err := Fetch(url)

	if err != nil {
		fmt.Println("read content failed:%v", err)
		return
	}
	matches := headerRe.FindAllSubmatch(body, -1)
	for _, m := range matches {
		fmt.Println("fetch card news:", string(m[1]))
	}
}
```

å€ŸåŠ© regexp æ ‡å‡†åº“ï¼Œregexp.MustCompileå‡½æ•°ä¼šåœ¨ç¼–è¯‘æ—¶æå‰è§£æå¥½PCREæ ‡å‡†çš„æ­£åˆ™è¡¨è¾¾å¼å†…å®¹ï¼Œè¿™å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸ŠåŠ é€Ÿç¨‹åºçš„è¿è¡Œã€‚headerRe.FindAllSubmatch åˆ™å¯ä»¥æŸ¥æ‰¾æ»¡è¶³æ­£åˆ™è¡¨è¾¾å¼æ¡ä»¶çš„æ‰€æœ‰å­—ç¬¦ä¸²ã€‚

æ¥ä¸‹æ¥è®©æˆ‘ä»¬åˆ†æä¸€ä¸‹è¿™ä¸²æ­£åˆ™è¡¨è¾¾å¼ï¼š

```plain
<div class="news_li"[\s\S]*?<h2>[\s\S]*?<a.*?target="_blank">([\s\S]*?)</a>
```

åœ¨è¿™ä¸ªè§„åˆ™ä¸­ï¼Œæˆ‘ä»¬è¦æ‰¾åˆ°ä»¥å­—ç¬¦ä¸² `<div class="news_li"` å¼€å¤´ï¼Œä¸”å†…éƒ¨åŒ…å« `<h2>` å’Œ `<a.*?target="_blank">` çš„å­—ç¬¦ä¸²ã€‚å…¶ä¸­ï¼Œ`[\s\S]*?` æ˜¯è¿™æ®µè¡¨è¾¾å¼çš„ç²¾é«“ï¼Œ`[\s\S]` æŒ‡ä»£çš„æ˜¯ä»»æ„å­—ç¬¦ä¸²ã€‚

æœ‰äº›åŒå­¦å¯èƒ½ä¼šå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆä¸ä½¿ç”¨ `.` é€šé…ç¬¦å‘¢? åŸå› åœ¨äºï¼Œ`.`é€šé…ç¬¦æ— æ³•åŒ¹é…æ¢è¡Œç¬¦ï¼Œè€ŒHTMLæ–‡æœ¬ä¸­ä¼šç»å¸¸å‡ºç°æ¢è¡Œç¬¦ã€‚`*` ä»£è¡¨å°†å‰é¢ä»»æ„å­—ç¬¦åŒ¹é…0æ¬¡æˆ–è€…æ— æ•°æ¬¡ã€‚`ï¼Ÿ`ä»£è¡¨éè´ªå©ªåŒ¹é…ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬çš„æ­£åˆ™è¡¨è¾¾å¼å¼•æ“åªè¦æ‰¾åˆ°ç¬¬ä¸€æ¬¡å‡ºç° `<h2>` æ ‡ç­¾çš„åœ°æ–¹ï¼Œå°±è®¤å®šåŒ¹é…æˆåŠŸã€‚å¦‚æœä¸æŒ‡å®š `ï¼Ÿ`ï¼Œè´ªå©ªåŒ¹é…ä¼šä¸€è·¯æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æœ€åä¸€ä¸ª `<h2>` æ ‡ç­¾ä¸ºæ­¢ï¼Œè¿™å½“ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚

åœ¨ `<a>` æ ‡ç­¾ä¸­ï¼Œæˆ‘ä»¬åŠ äº†ä¸€ä¸ªæ‹¬å· `()`ï¼Œè¿™æ˜¯ç”¨æ¥åˆ†ç»„çš„ï¼Œå› ä¸ºå½“æˆ‘ä»¬ç”¨æ­£åˆ™å®Œæ•´åŒ¹é…åˆ°è¿™ä¸€ä¸²å­—ç¬¦ä¸²åï¼Œå¸Œæœ›å°†æ‹¬å·ä¸­å¯¹åº”çš„å­—ç¬¦ä¸²æå–å‡ºæ¥ã€‚

headerRe.FindAllSubmatch æ˜¯ä¸€ä¸ªä¸‰ç»´å­—èŠ‚æ•°ç»„ `[][][]byte`ã€‚å®ƒçš„ç¬¬ä¸€å±‚åŒ…å«çš„æ˜¯æ‰€æœ‰æ»¡è¶³æ­£åˆ™æ¡ä»¶çš„å­—ç¬¦ä¸²ã€‚ç¬¬äºŒå±‚å¯¹æ¯ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„å­—ç¬¦ä¸²åšäº†åˆ†ç»„ã€‚å…¶ä¸­ï¼Œæ•°ç»„çš„ç¬¬0å·å…ƒç´ æ˜¯æ»¡è¶³å½“å‰æ­£åˆ™è¡¨è¾¾å¼çš„è¿™ä¸€ä¸²å®Œæ•´çš„å­—ç¬¦ä¸²ã€‚è€Œç¬¬1å·å…ƒç´ ä»£è¡¨æ‹¬å·ä¸­ç‰¹å®šçš„å­—ç¬¦ä¸²ï¼Œåœ¨æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­å¯¹åº”çš„æ˜¯ `<a>` æ ‡ç­¾æ‹¬å·ä¸­çš„æ–‡å­—ï¼Œå³æ–°é—»æ ‡é¢˜ã€‚ç¬¬ä¸‰å±‚å°±æ˜¯å­—ç¬¦ä¸²å®é™…å¯¹åº”çš„å­—èŠ‚æ•°ç»„ã€‚

è¿è¡Œä»£ç ï¼Œä¼šæ‰“å°å‡ºé¦–é¡µå¡ç‰‡ä¸­æ‰€æœ‰çš„æ–°é—»ï¼ˆæ³¨æ„ï¼Œæ–°é—»å†…å®¹åœ¨éšæ—¶å˜åŒ–ï¼‰ï¼š

```plain
fetch card news: C919å…­æ¶è¯•é£æœºå®Œæˆå…¨éƒ¨è¯•é£ä»»åŠ¡ï¼Œå–è¯å·¥ä½œæ­£å¼è¿›å…¥æ”¶å®˜é˜¶æ®µ
fetch card news: ä¸Šæµ·é«˜è€ƒæœ¬ç§‘å„æ‰¹æ¬¡å½•å–æ§åˆ¶åˆ†æ•°çº¿å…¬å¸ƒï¼Œæœ¬ç§‘æ§åˆ†çº¿400åˆ†
fetch card news: ç”˜è‚ƒä¸€ç…¤çŸ¿ä¼ä¸šå‘ç”Ÿå±±ä½“åå¡Œäº‹æ•…ï¼šå·²è‡´3æ­»13ä¼¤ï¼Œ1äººå¤±è”
fetch card news: æ¾æ¹ƒå…«å‘¨å¹´æ¢ç´¢æœªåœæ­‡ï¼š2022å¤–æ»©æ–°åª’ä½“å³°ä¼šæ±‡èšèåˆå‘å±•æ–°åŠ¨èƒ½
fetch card news: å¤®å¹¿ç½‘è¯„20å®¶å•ä½æ‹’æ”¶ç°é‡‘è¢«ç½šï¼šè´§å¸æ•°å­—åŒ–ä¸ç­‰äºæ‘’å¼ƒç°é‡‘
...
```

æ­£åˆ™è¡¨è¾¾å¼è™½ç„¶çµæ´»å¼ºå¤§ï¼Œä½†æ˜¯ä¹Ÿä¸æ˜¯æ²¡æœ‰æˆæœ¬çš„ã€‚æ­£å¦‚ä¸€å¥è€è¯è¯´çš„é‚£æ ·ï¼š

> å¦‚æœä½ æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä½ æƒ³åˆ°å¯ä»¥ç”¨æ­£åˆ™æ¥è§£å†³ï¼Œé‚£ä¹ˆä½ å°±æœ‰ä¸¤ä¸ªé—®é¢˜äº†ã€‚

> Some people, when confronted with a problem, think â€œI know, Iâ€™ll use regular expressions.â€ Now they have two problems.

ä¸ºäº†è§£å†³ä¸€ä¸ªå¤æ‚çš„é—®é¢˜ï¼Œæˆ‘ä»¬å…¶å®å¼•å…¥äº†æ­£åˆ™è¡¨è¾¾å¼è¿™ä¸ªåŒæ ·å¤æ‚çš„å·¥å…·ã€‚å¦å¤–ï¼Œç”±äºå›æº¯çš„åŸå› ï¼Œå¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼å¯èƒ½ä¼šæ¯”è¾ƒæ¶ˆè€—CPUèµ„æºã€‚å¹¸è¿çš„æ˜¯ï¼Œç”±äºHTMLæ˜¯ç»“æ„åŒ–çš„æ•°æ®ï¼Œæˆ‘ä»¬æœ‰äº†ä¸€äº›æ›´å¥½çš„è§£å†³åŠæ³•ã€‚è®©æˆ‘ä»¬æ›´è¿›ä¸€æ­¥ï¼Œæ¥çœ‹çœ‹æ›´åŠ é«˜æ•ˆåœ°æŸ¥æ‰¾HTMLä¸­æ•°æ®çš„æ–¹å¼ï¼š**XPath(XML Path Language.)ã€‚**

## Xpath

XPath å®šä¹‰äº†ä¸€ç§éå† XML æ–‡æ¡£ä¸­èŠ‚ç‚¹å±‚æ¬¡ç»“æ„ï¼Œå¹¶è¿”å›åŒ¹é…å…ƒç´ çš„çµæ´»æ–¹æ³•ã€‚è€ŒXMLæ˜¯ä¸€ç§å¯æ‰©å±•æ ‡è®°è¯­è¨€ï¼Œæ˜¯è¡¨ç¤ºç»“æ„åŒ–ä¿¡æ¯çš„ä¸€ç§è§„èŒƒã€‚ä¾‹å¦‚ï¼Œå¾®è½¯åŠå…¬è½¯ä»¶Wordsåœ¨2007ä¹‹åçš„ç‰ˆæœ¬çš„åº•å±‚æ•°æ®å°±æ˜¯é€šè¿‡XMLæ–‡ä»¶æè¿°çš„ã€‚HTMLè™½ç„¶ä¸æ˜¯ä¸¥æ ¼æ„ä¹‰çš„XMLï¼Œä½†æ˜¯å®ƒçš„ç»“æ„å’ŒXMLç±»ä¼¼ã€‚

Goæ ‡å‡†åº“æ²¡æœ‰æä¾›å¯¹XPathçš„æ”¯æŒï¼Œä½†æ˜¯[ç¬¬ä¸‰æ–¹åº“](https://github.com/antchfx/htmlquery)æä¾›äº†åœ¨HTMLä¸­é€šè¿‡XPathåŒ¹é…XMLèŠ‚ç‚¹çš„å¼•æ“ã€‚æˆ‘ä»¬ä¹‹å‰è·å–å¡ç‰‡æ–°é—»çš„ä»£ç å¯ä»¥ç”¨ [htmlquery](http://github.com/antchfx/htmlquery) æ”¹å†™æˆä¸‹é¢çš„æ ·å­ï¼š

```plain
// tag v0.0.6
func main() {
	url := "https://www.thepaper.cn/"
	body, err := Fetch(url)

	if err != nil {
		fmt.Println("read content failed:%v", err)
		return
	}
	doc, err := htmlquery.Parse(bytes.NewReader(body))
	if err != nil {
		fmt.Println("htmlquery.Parse failed:%v", err)
	}
	nodes := htmlquery.Find(doc, `//div[@class="news_li"]/h2/a[@target="_blank"]`)

	for _, node := range nodes {
		fmt.Println("fetch card ", node.FirstChild.Data)
	}
}
```

å…¶ä¸­ï¼Œhtmlquery.Parseç”¨äºè§£æHTMLæ–‡æœ¬ï¼Œhtmlquery.Findåˆ™ä¼šé€šè¿‡XPathè¯­æ³•æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒXPathè§„åˆ™ä¸ºï¼š

```plain
//div[@class="news_li"]/h2/a[@target="_blank"]
```

è¿™ä¸²è§„åˆ™ä»£è¡¨æŸ¥æ‰¾targetå±æ€§ä¸º\_blankçš„aæ ‡ç­¾ï¼Œå¹¶ä¸”aèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºh2æ ‡ç­¾ï¼Œh2æ ‡ç­¾çš„çˆ¶èŠ‚ç‚¹ä¸º classå±æ€§ä¸ºnews\_liçš„divæ ‡ç­¾ã€‚

å’Œæ­£åˆ™è¡¨è¾¾å¼ç›¸æ¯”ï¼Œç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€XPathçš„è¯­æ³•æ›´åŠ ç®€æ´æ˜äº†ï¼Œæ£€ç´¢å­—ç¬¦ä¸²å˜å¾—æ›´å®¹æ˜“äº†ã€‚ä½†æ˜¯XPathå¹¶ä¸æ˜¯ä¸“é—¨ä¸ºHTMLè®¾è®¡çš„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†ä»‹ç»ä¸€ä¸‹ä¸“é—¨ä¸ºHTMLè®¾è®¡ï¼Œä½¿ç”¨æ›´å¹¿æ³›ï¼Œæ›´ç®€å•çš„CSSé€‰æ‹©å™¨ã€‚

## CSSé€‰æ‹©å™¨

CSSï¼ˆå±‚å å¼æ ·å¼è¡¨ï¼‰æ˜¯ä¸€ç§å®šä¹‰HTML æ–‡æ¡£ä¸­å…ƒç´ æ ·å¼çš„è¯­è¨€ã€‚åœ¨ CSS æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªHTMLä¸­çš„æ ‡ç­¾çš„è·¯å¾„ï¼Œå¹¶æŒ‡å®šè¿™äº›æ ‡ç­¾çš„æ ·å¼ã€‚åœ¨CSSä¸­ï¼Œå®šä¹‰æ ‡ç­¾è·¯å¾„çš„æ–¹æ³•è¢«ç§°ä¸ºCSSé€‰æ‹©å™¨ã€‚

CSS é€‰æ‹©å™¨è€ƒè™‘åˆ°äº†æˆ‘ä»¬åœ¨æœç´¢ HTML æ–‡æ¡£æ—¶å¸¸ç”¨çš„å±æ€§ã€‚æˆ‘ä»¬å‰é¢åœ¨XPathä¾‹å­çš„ä¸­ä½¿ç”¨çš„ div\[@class=â€œnews\_liâ€]ï¼Œåœ¨CSSé€‰æ‹©å™¨ä¸­å¯ä»¥ç®€å•åœ°è¡¨ç¤ºä¸º div.news\_liã€‚è¿™æ˜¯ä¸€ç§æ›´åŠ ç®€å•çš„è¡¨ç¤ºæ–¹æ³•ã€‚å…³äºCSSé€‰æ‹©å™¨çš„è¯­æ³•å¯ä»¥æŸ¥çœ‹[è¿™ç¯‡æ–‡ç« ](https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_Selectors)ã€‚

å®˜æ–¹æ ‡å‡†åº“ä¸­å¹¶ä¸æ”¯æŒCSSé€‰æ‹©å™¨ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨ç¤¾åŒºä¸­çŸ¥åçš„ç¬¬ä¸‰æ–¹åº“(`github.com/PuerkitoBio/goquery` )ï¼Œè·å–å¡ç‰‡æ–°é—»çš„ä»£ç å¦‚ä¸‹ï¼š

```plain
// tag v0.0.9
func main() {
	url := "https://www.thepaper.cn/"
	body, err := Fetch(url)

	if err != nil {
		fmt.Println("read content failed:%v", err)
		return
	}

	// åŠ è½½HTMLæ–‡æ¡£
	doc, err := goquery.NewDocumentFromReader(bytes.NewReader(body))
	if err != nil {
		fmt.Println("read content failed:%v", err)
	}

	doc.Find("div.news_li h2 a[target=_blank]").Each(func(i int, s *goquery.Selection) {
		// è·å–åŒ¹é…æ ‡ç­¾ä¸­çš„æ–‡æœ¬
		title := s.Text()
		fmt.Printf("Review %d: %s\n", i, title)
	})
}
```

è¿™é‡Œï¼Œgoquery.NewDocumentFromReader ç”¨äºåŠ è½½HTMLæ–‡æ¡£ï¼Œdoc.Findå¯ä»¥æ ¹æ®CSSæ ‡ç­¾é€‰æ‹©å™¨çš„è¯­æ³•æŸ¥æ‰¾åŒ¹é…çš„æ ‡ç­¾ï¼Œå¹¶éå†æ‰“å°å‡ºaæ ‡ç­¾ä¸­çš„æ–‡æœ¬ã€‚

## æ€»ç»“

å¥½äº†ï¼Œè¿™èŠ‚è¯¾å°±è®²åˆ°è¿™é‡Œã€‚

è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å€ŸåŠ©ä¸€ä¸ªç®€å•çš„æ–°é—»ç½‘ç«™ï¼Œè®²è§£äº†å¦‚ä½•åº”å¯¹ç½‘é¡µçš„ä¸åŒç¼–ç é—®é¢˜ï¼Œæˆ‘ä»¬è¿˜äº†è§£äº†HTMLæ–‡æœ¬çš„å¤šç§å¤„ç†æ–¹å¼ã€‚HTMLæ–‡æœ¬çš„å¤„ç†å¯ä»¥å€ŸåŠ©æ ‡å‡†åº“çš„stringsã€strconvã€bytesç­‰åº“ï¼Œä¹Ÿå¯ä»¥å€ŸåŠ©æ›´é€šç”¨æ›´å¼ºå¤§çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚

ä¸è¿‡ï¼Œç”±äºæ­£åˆ™è¡¨è¾¾å¼é€šå¸¸æ¯”è¾ƒå¤æ‚è€Œä¸”æ€§èƒ½ä½ä¸‹ï¼Œåœ¨å®é™…è¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬é‡‡ç”¨XPathä¸CSSé€‰æ‹©å™¨è¿›è¡Œç»“æ„åŒ–æŸ¥è¯¢ã€‚æ¯”è¾ƒè¿™ä¸¤ç§æŸ¥è¯¢æ–¹æ³•ï¼Œä¼šå‘ç°XPathæ˜¯ä¸ºXMLæ–‡æ¡£è®¾è®¡çš„ï¼Œè€ŒCSSé€‰æ‹©å™¨æ˜¯ä¸ºHTMLæ–‡æ¡£ä¸“é—¨è®¾è®¡çš„ï¼Œæ›´åŠ ç®€å•ï¼Œä¹Ÿæ›´ä¸»æµã€‚æˆ‘ä»¬åœ¨åé¢çš„è¯¾ç¨‹ä¸­è¿˜å°†çµæ´»ä½¿ç”¨å„ç§æŠ€æœ¯æ¥æŸ¥æ‰¾æŒ‡å®šçš„å­—ç¬¦ä¸²ã€‚

## è¯¾åé¢˜

æœ€åï¼Œæˆ‘ä¹Ÿç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜ã€‚

åœ¨ç±»ä¼¼å¦‚ä¸‹çš„æ—¥å¿—æ–‡ä»¶ä¸­ï¼ŒåŒ…å«äº†å¾ˆå¤šè®¢å•å·çš„ä¿¡æ¯ï¼Œå³order\_idåé¢çš„ä¸€ä¸²æ•°å­—ã€‚

```plain
2022-11-22  name=versionReport||order_id=3732978217343693673||trace_id=XXX
2022-11-22  name=versionReport||order_id=3732978217343693674||trace_id=XXX
```

æˆ‘ä»¬å¯ä»¥ç”¨ä»€ä¹ˆæ–¹å¼ï¼Œå°†order\_idåé¢çš„è®¢å•IDéƒ½åƒä¸‹é¢è¿™æ ·æ‰“å°å‡ºæ¥ï¼Ÿï¼ˆæç¤ºï¼šç”¨grepå°±å¯ä»¥åšåˆ°ï¼‰

```plain
3732978217343693673
3732978217343693674
```

æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ13ï¼‰</strong></div><ul>
<li><span>0mfg</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>æ¾æ¹ƒæ–°é—»é¦–é¡µåº”è¯¥æ˜¯æ”¹ç‰ˆäº†ï¼ŒåŸæ¥çš„ä¾‹å­æŠ“ä¸åˆ°å†…å®¹ï¼ŒæŒ‰ç…§è€å¸ˆçš„æ€è·¯æŠ“åˆ°ç°åœ¨æ¨èå¡ç‰‡é‡Œçš„æ–°é—»æ ‡é¢˜ï¼Œäº¤ä½œä¸šäº†
package main

import (
	&quot;bufio&quot;
	&quot;fmt&quot;
	&quot;io&#47;ioutil&quot;
	&quot;net&#47;http&quot;
	&quot;regexp&quot;

	&quot;golang.org&#47;x&#47;net&#47;html&#47;charset&quot;
	&quot;golang.org&#47;x&#47;text&#47;encoding&quot;
	&quot;golang.org&#47;x&#47;text&#47;encoding&#47;unicode&quot;
	&quot;golang.org&#47;x&#47;text&#47;transform&quot;
)
var headerRe = regexp.MustCompile(`&lt;div class=&quot;small_cardcontent__BTALp&quot;[\s\S]*?&lt;h2&gt;([\s\S]*?)&lt;&#47;h2&gt;`)

func main() {
	url := &quot;https:&#47;&#47;www.thepaper.cn&#47;&quot;

	pageBytes, err:= Fetch(url)

	if err!= nil {
		fmt.Printf(&quot;read content failed %v&quot;, err)
		return
	}

	matches := headerRe.FindAllSubmatch(pageBytes, -1)

	for _, m := range matches {
		fmt.Println(&quot;fetch card news:&quot;, string(m[1]))
	}
}

func Fetch(url string) ([]byte, error) {
	resp, err := http.Get(url)
	if err != nil {
		panic(err)
	}
	defer resp.Body.Close()

	if resp.StatusCode != http.StatusOK {
		fmt.Printf(&quot;Error status code: %v&quot;, resp.StatusCode)
	}
	bodyReader := bufio.NewReader(resp.Body)
	e := DerterminEncoding(bodyReader)   &#47;&#47;utf-8
	utf8Reader := transform.NewReader(bodyReader, e.NewDecoder())
	return ioutil.ReadAll(utf8Reader)
}

func DerterminEncoding(r *bufio.Reader) encoding.Encoding {
	bytes, err := r.Peek(1024)

	if err != nil {
		fmt.Printf(&quot;fetch error: %v&quot;, err)
		return unicode.UTF8
	}

	e, _, _ := charset.DetermineEncoding(bytes, &quot;&quot;)
	return  e
}

è¿è¡Œç»“æœï¼Œfetch card news: é•¿äºŒä¸ç«ç®­70æ¬¡å‘å°„å‘å‘æˆåŠŸï¼Œå°†171é¢—å«æ˜Ÿé€å…¥é¢„å®šè½¨é“
fetch card news: æ—¥æœ¬ä¸»å¸…æ£®ä¿ä¸€é“æ­‰ï¼šå¯¹ä¸èµ·æ”¯æŒæˆ‘ä»¬çš„çƒè¿·ï¼Œå…¨åŠ›å¤‡æˆ˜è¥¿ç­ç‰™
fetch card news: è±ªå®…æ•°ä¸‡â€œå¤©ä»·ç”µè´¹â€ä½•æ¥ï¼Ÿå°æ¹¾åœ°åŒºç”µä»·è°ƒæ¶¨èƒŒåçš„èƒ½æºå›°å±€
fetch card news: å› ç™½ä¿„ç½—æ–¯å¤–é•¿é©¬å…‹ä¼Šå»ä¸–ï¼Œä¿„å¤–é•¿æ¨è¿Ÿè®¿é—®ç™½ä¿„ç½—æ–¯
</p>2022-11-27</li><br/><li><span>å¾æµ·æµª</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>grep -oP &#39;order_id=\d+&#39;|grep -oP &#39;\d+&#39;</p>2022-11-22</li><br/><li><span>0mfg</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ€è€ƒé¢˜ï¼Œmacä¸Šé€šè¿‡grep -oE &#39;order_id=\d+&#39; | grep -oE &#39;\d+&#39;  å¯ä»¥æå–orderid</p>2022-11-27</li><br/><li><span>å“ˆå“ˆå“ˆå“ˆå“ˆ</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>é¡¹ç›®ä»£ç æ”¾å“ªé‡Œäº†ï¼Ÿä¹‹å‰ç•™çš„æ‰¾ä¸ç€äº†</p>2022-11-26</li><br/><li><span>0mfg</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å‹˜è¯¯ï¼Œ fmt.Println(&quot;fetch url error:%v&quot;, err)  åº”è¯¥ä¸ºfmt.Printf(&quot;fetch url err:%v\n&quot;, err)å§</p>2022-11-27</li><br/><li><span>çƒŸæ¶ˆäº‘æ•£</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç›®å‰ï¼ŒLinux å’Œ Mac åœ¨åŸç”Ÿé›†æˆ GUN å¥—ä»¶ã€‚åº”è¯¥æ˜¯GNUå§</p>2022-11-22</li><br/><li><span>lesserror</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œæ¾æ¹ƒæ–°é—»çš„é¦–é¡µæ”¹ç‰ˆäº†ï¼Œä»£ç éœ€è¦è°ƒæ•´äº†ã€‚ä¸ç„¶è¿è¡Œåæ²¡ç»“æœã€‚</p>2022-11-28</li><br/><li><span>å…‰</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é—®ä¸‹æœ€åè¿™å•ä¸ª return å«ä¹‰æ˜¯å•¥ã€‚
if err != nil {   
 fmt.Println(&quot;fetch url error:%v&quot;, err)    
 return  
}</p>2022-11-25</li><br/><li><span>Geek_d09597</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ›´æ–°ä¹‹åçš„ï¼š

æ­£åˆ™ï¼švar headerRe = regexp.MustCompile(`&lt;div class=&quot;small_cardcontent__BTALp&quot;[\s\S]*?&lt;h2&gt;([\s\S]*?)&lt;&#47;h2&gt;`)

Xpath: nodes := htmlquery.Find(doc, `&#47;&#47;div[@class=&quot;small_cardcontent__BTALp&quot;]&#47;&#47;h2`)

CSSé€‰æ‹©å™¨:  doc.Find(&quot;div.small_cardcontent__BTALp h2&quot;)
</p>2022-12-17</li><br/><li><span>0mfg</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å‹˜è¯¯ï¼Œâ€œä¸‹é¢è¿™æ®µä½¿ç”¨ bytes æ ‡å‡†åº“çš„ä»£ç å’Œä¸Šé¢ä½¿ç”¨ strings åº“çš„ä»£ç åœ¨åŠŸèƒ½ä¸Šæ˜¯ç­‰ä»·çš„â€ï¼Œè¯¥å¤„å®ä¾‹ä»£ç åº”è¯¥æ˜¯è¿™æ ·å§
numLinks := bytes.Count(body, []byte(&quot;&lt;a&quot;))
fmt.Printf(&quot;homepage has %d links&quot;, numLinks)

exist := bytes.Contains(body, []byte(&quot;ç–«æƒ…&quot;))
fmt.Println(exist)</p>2022-11-27</li><br/><li><span>å¾çŸ³å¤´</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ç¬¬ä¸€ååº”æ˜¯
arr := strings.Split(data,&quot;||&quot;)
fmtPrintln(arr[1][9:])
</p>2022-11-22</li><br/><li><span>æ‹¾æ‡æ‹¾æ‡</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>wowï¼Œç­‰åˆ°äº†ä»£ç é˜¶æ®µäº†ã€‚ã€‚ã€‚å“ˆå“ˆ</p>2022-11-22</li><br/><li><span>Jack</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ­£åˆ™è¡¨è¾¾å¼å¯ä»¥å®‰æ’èµ·æ¥äº†</p>2022-11-22</li><br/>
</ul>