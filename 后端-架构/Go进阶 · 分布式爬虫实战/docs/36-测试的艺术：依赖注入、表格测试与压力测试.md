ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ‘å»ºå‹‹ã€‚

å¯¹ä»£ç çš„åŠŸèƒ½ä¸é€»è¾‘è¿›è¡Œæµ‹è¯•æ˜¯é¡¹ç›®å¼€å‘ä¸­éå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†ã€‚è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹å‡ ä¸ªåœ¨Goä¸­è¿›è¡Œä»£ç æµ‹è¯•çš„æ ¸å¿ƒæŠ€æœ¯ï¼šå•å…ƒæµ‹è¯•ã€å‹åŠ›æµ‹è¯•ä¸åŸºå‡†æµ‹è¯•ã€‚å®ƒä»¬å…±åŒä¿è¯äº†ä»£ç çš„å‡†ç¡®æ€§ã€å¯é æ€§ä¸é«˜æ•ˆæ€§ã€‚

## å•å…ƒæµ‹è¯•

å•å…ƒæµ‹è¯•åˆå«åšæ¨¡å—æµ‹è¯•ï¼Œå®ƒä¼šå¯¹ç¨‹åºæ¨¡å—ï¼ˆè½¯ä»¶è®¾è®¡çš„æœ€å°å•ä½ï¼‰è¿›è¡Œæ­£ç¡®æ€§æ£€éªŒï¼Œé€šå¸¸ï¼Œå•å…ƒæµ‹è¯•æ˜¯å¯¹ä¸€ä¸ªå‡½æ•°å°è£…èµ·æ¥çš„æœ€å°åŠŸèƒ½è¿›è¡Œæµ‹è¯•ã€‚

åœ¨Goä¸­ï¼ŒtestingåŒ…ä¸ºæˆ‘ä»¬æä¾›äº†æµ‹è¯•çš„æ”¯æŒã€‚è¿›è¡Œä»£ç æµ‹è¯•éœ€è¦å°†æµ‹è¯•å‡½æ•°æ”¾ç½®åˆ°xxx\_test.goæ–‡ä»¶ä¸­ï¼Œæµ‹è¯•å‡½æ•°ä»¥TestXxxå¼€å¤´ï¼Œå…¶ä¸­Xxxæ˜¯æµ‹è¯•å‡½æ•°çš„åç§°ï¼Œä»¥å¤§å†™å­—æ¯å¼€å¤´ã€‚æµ‹è¯•å‡½æ•°ä»¥ testing.T ç±»å‹çš„æŒ‡é’ˆä½œä¸ºå‚æ•°ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸€å‚æ•°åœ¨æµ‹è¯•ä¸­æ‰“å°æ—¥å¿—ã€æŠ¥å‘Šæµ‹è¯•ç»“æœï¼Œæˆ–è€…è·³è¿‡æŒ‡å®šæµ‹è¯•ã€‚

```plain
func TestXxx(t *testing.T)
```

æˆ‘ä»¬ç”¨ä¸‹é¢è¿™ä¸ªç®€å•çš„åŠ æ³•ä¾‹å­æ¥è¯´æ˜ä¸€ä¸‹ã€‚é¦–å…ˆï¼Œåœ¨add.goæ–‡ä»¶ä¸­ï¼Œå†™å…¥ä¸€ä¸ªAddå‡½æ•°å®ç°ç®€å•çš„åŠ æ³•åŠŸèƒ½ã€‚

```plain
// add.go
package add

func Add(a,b int) int{
	return a+b
}
```

æ¥ä¸‹æ¥åœ¨add\_test.goæ–‡ä»¶ä¸­ï¼Œä¹¦å†™TestAddæµ‹è¯•å‡½æ•°ï¼Œå¹¶å°†æ‰§è¡Œç»“æœä¸é¢„æœŸè¿›è¡Œå¯¹æ¯”ã€‚å¦‚æœæ‰§è¡Œç»“æœä¸é¢„æœŸç›¸ç¬¦ï¼Œt.Logæ‰“å°æ—¥å¿—ã€‚é»˜è®¤æƒ…å†µä¸‹æµ‹è¯•æ˜¯æ²¡é—®é¢˜çš„ã€‚ä½†æ˜¯å¦‚æœæ‰§è¡Œç»“æœä¸é¢„æœŸä¸ç¬¦ï¼Œt.Fatalä¼šæŠ¥å‘Šæµ‹è¯•å¤±è´¥ã€‚

```plain
// add_test.go
package add

import (
	"testing"
)
func TestAdd(t *testing.T) {
	sum := Add(1, 2)
	if sum == 3 {
		t.Log("the result is ok")
	} else {
		t.Fatal("the result is wrong")
	}
}
```

è¦æ‰§è¡Œæµ‹è¯•æ–‡ä»¶ï¼Œå¯ä»¥æ‰§è¡Œgo testï¼Œå¦‚æœæµ‹è¯•æˆåŠŸï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹ã€‚

```plain
Â» go test                                                                                                      jackson@bogon
PASS
ok      github.com/dreamerjackson/xxx/add    0.013s
```

å¦‚æœæµ‹è¯•ç»“æœä¸ç¬¦åˆé¢„æœŸï¼Œè¾“å‡ºå¦‚ä¸‹ã€‚

```plain
=== RUN   TestAdd
    add_test.go:13: the result is wrong
--- FAIL: TestAdd (0.00s)

FAIL
```

æ ¹æ®ä¸Šé¢çš„Addå‡½æ•°ï¼Œæˆ‘ä»¬å†å›é¡¾ä¸€ä¸‹æµ‹è¯•éœ€è¦éµå®ˆçš„è§„èŒƒã€‚

1. å«æœ‰å•å…ƒæµ‹è¯•ä»£ç çš„Goæ–‡ä»¶å¿…é¡»ä»¥\_test.goç»“å°¾ï¼ŒGoè¯­è¨€çš„æµ‹è¯•å·¥å…·åªè®¤ç¬¦åˆè¿™ä¸ªè§„åˆ™çš„æ–‡ä»¶ã€‚
2. å•å…ƒæµ‹è¯•æ–‡ä»¶å\_test.goå‰é¢çš„éƒ¨åˆ†ï¼Œæœ€å¥½æ˜¯è¢«æµ‹è¯•çš„æ–¹æ³•æ‰€åœ¨Goæ–‡ä»¶çš„æ–‡ä»¶åã€‚æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­ï¼Œå•å…ƒæµ‹è¯•æ–‡ä»¶åæ˜¯add\_test.goï¼Œè¿™æ˜¯å› ä¸ºæµ‹è¯•çš„Addå‡½æ•°åœ¨add.goæ–‡ä»¶é‡Œã€‚
3. å•å…ƒæµ‹è¯•çš„å‡½æ•°åå¿…é¡»ä»¥Testå¼€å¤´ï¼Œæ˜¯å¯å¯¼å‡ºå…¬å¼€çš„å‡½æ•°ã€‚
4. æµ‹è¯•å‡½æ•°çš„ç­¾åå¿…é¡»æ¥æ”¶ä¸€ä¸ªæŒ‡å‘testing.Tç±»å‹çš„æŒ‡é’ˆï¼Œå¹¶ä¸”ä¸èƒ½è¿”å›ä»»ä½•å€¼ã€‚
5. å‡½æ•°åæœ€å¥½æ˜¯Test + è¦æµ‹è¯•çš„æ–¹æ³•å‡½æ•°åï¼Œåœ¨æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­ï¼Œå‡½æ•°åæ˜¯TestAddï¼Œè¡¨ç¤ºæµ‹è¯•çš„æ˜¯Addè¿™ä¸ªå‡½æ•°ã€‚

ä¸‹é¢è®©æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­å¯¹æ•°æ®åº“æ“ä½œçš„ `sqldb` åšå•å…ƒæµ‹è¯•ï¼Œæµ‹è¯•ä¸€ä¸‹åˆ›å»ºè¡¨çš„åŠŸèƒ½æ˜¯å¦æ­£å¸¸ã€‚

```plain
func TestSqldb_CreateTable(t *testing.T) {
	sqldb, err := New(
		WithConnURL("root:123456@tcp(127.0.0.1:3326)/crawler?charset=utf8"),
	)
	assert.Nil(t, err)
	assert.NotNil(t, sqldb)
	// æµ‹è¯•å¯¹äºæ— æ•ˆçš„é…ç½®è¿”å›é”™è¯¯
	name := "test_create_table"
	var notValidTable = TableData{
		TableName: name,
		ColumnNames: []Field{
			{Title: "ä¹¦å", Type: "notValid"},
			{Title: "URL", Type: "VARCHAR(255)"},
		},
		AutoKey: true,
	}
 // å»¶è¿Ÿåˆ é™¤è¡¨
	defer func() {
		err := sqldb.DropTable(notValidTable)
		assert.Nil(t, err)
	}()
  // æµ‹è¯•å¯¹äºæœ‰æ•ˆçš„é…ç½®è¿”å›é”™è¯¯
	err = sqldb.CreateTable(notValidTable)
	assert.NotNil(t, err)
	// æµ‹è¯•å¯¹äºæ— æ•ˆçš„é…ç½®è¿”å›é”™è¯¯
	var validTable = TableData{
		TableName: name,
		ColumnNames: []Field{
			{Title: "ä¹¦å", Type: "MEDIUMTEXT"},
			{Title: "URL", Type: "VARCHAR(255)"},
		},
		AutoKey: true,
	}
	err = sqldb.CreateTable(validTable)
	assert.Nil(t, err)
}
```

åœ¨è¿™ä¸ªå•å…ƒæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦æµ‹è¯•äº†åˆ›å»ºè¡¨çš„ CreateTable å‡½æ•°çš„ä¸¤ä¸ªåŠŸèƒ½ï¼ŒåŒ…æ‹¬â€œåœ¨æ­£å¸¸æƒ…å†µä¸‹èƒ½å¤Ÿåˆ›å»ºè¡¨â€å’Œâ€œåœ¨å¼‚å¸¸æƒ…å†µä¸‹ä¸èƒ½å¤Ÿåˆ›å»ºè¡¨â€ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰ç›´æ¥ä½¿ç”¨t.Fatalæ¥æŠ¥å‘Šæµ‹è¯•å¤±è´¥ï¼Œè€Œæ˜¯å€ŸåŠ©ç¬¬ä¸‰æ–¹åŒ…github.com/stretchr/testify/assertæ¥å®Œæˆæµ‹è¯•ã€‚

`assert`åº“å¯¹testing.Tè¿›è¡Œäº†å°è£…ï¼Œä¾‹å¦‚å‡½æ•°assert.Nil é¢„æœŸä¼ å…¥çš„å‚æ•°ä¸ºnilï¼Œè€Œå‡½æ•°assert.NotNil é¢„æœŸä¼ å…¥çš„å‚æ•°ä¸ä¸ºnilã€‚å¦‚æœç»“æœä¸ç¬¦åˆé¢„æœŸï¼Œåˆ™ç«‹å³æŠ¥å‘Šæµ‹è¯•å¤±è´¥ã€‚

ä¸è¿‡ï¼Œè¿™æ ·çš„å•å…ƒæµ‹è¯•å…¶å®å¹¶ä¸å¤Ÿæ¸…æ™°ï¼Œç‰¹åˆ«æ˜¯å½“æµ‹è¯•çš„åŠŸèƒ½é€æ¸å˜å¤šçš„æ—¶å€™ï¼Œä»£ç è¿˜ä¼šå˜å¾—å†—ä½™ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æµ‹è¯•æ–¹æ³•å¯ä»¥ä¼˜é›…åœ°æµ‹è¯•å¤šç§åŠŸèƒ½å‘¢ï¼Ÿè¿™å°±ä¸å¾—ä¸æåˆ°è¡¨æ ¼é©±åŠ¨æµ‹è¯•äº†ã€‚

### è¡¨æ ¼é©±åŠ¨æµ‹è¯•

è¡¨æ ¼é©±åŠ¨æµ‹è¯•ä¹Ÿæ˜¯å•å…ƒæµ‹è¯•çš„ä¸€ç§ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜å®ƒã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬å†™çš„ä¸€ä¸ªå­—ç¬¦ä¸²åˆ†å‰²å‡½æ•°ï¼Œå®ƒçš„åŠŸèƒ½ç±»ä¼¼äºstrings.Splitå‡½æ•°ã€‚

```plain
// split.go
package split

import "strings"
func Split(s, sep string) []string {
	var result []string
	i := strings.Index(s, sep)
	for i > -1 {
		result = append(result, s[:i])
		s = s[i+len(sep):]
		i = strings.Index(s, sep)
	}
	return append(result, s)
}
```

æˆ‘ä»¬å¦‚æœè¦å¯¹è¿™ä¸ªå‡½æ•°è¿›è¡Œä¸Šè¿°æ‰€è®²çš„è¿™ç§å•å…ƒæµ‹è¯•ï¼Œæµ‹è¯•ä»£ç æ˜¯ä¸‹é¢çš„æ ·å­ã€‚  
reflect.DeepEqualæ˜¯Goæ ‡å‡†åº“æä¾›çš„æ·±åº¦å¯¹æ¯”å‡½æ•°ï¼Œå®ƒå¯ä»¥å¯¹æ¯”ä¸¤ä¸ªç»“æ„æ˜¯å¦ä¸€è‡´ã€‚è€Œå¦‚æœæœ‰å¤šä¸ªè¦æµ‹è¯•çš„ç”¨ä¾‹ï¼Œreflect.DeepEqualè¿™æ®µå¯¹æ¯”å‡½æ•°å°±ä¼šé‡å¤å¤šæ¬¡ã€‚

```plain
package split

import (
	"reflect"
	"testing"
)

//å•å…ƒæµ‹è¯•
func TestSplit(t *testing.T) {
	got := Split("a/b/c", "/")
	want := []string{"a", "b", "c"}
	if !reflect.DeepEqual(want, got) {
		t.Fatalf("expected: %v, got: %v", want, got)
	}
}
```

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¡¨æ ¼é©±åŠ¨æµ‹è¯•çš„åšæ³•ã€‚åœ¨è¡¨æ ¼é©±åŠ¨ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Mapæˆ–è€…æ•°ç»„æ¥ç»„ç»‡ç”¨ä¾‹ï¼Œæˆ‘ä»¬åªéœ€è¦è¾“å…¥å€¼å’ŒæœŸæœ›å€¼ï¼Œåœ¨ä¸‹é¢çš„forå¾ªç¯ä¸­å°±èƒ½å¤Ÿå¤ç”¨å¯¹æ¯”çš„å‡½æ•°ï¼Œè¿™å°±è®©è¡¨æ ¼é©±åŠ¨æµ‹è¯•åœ¨å®è·µä¸­éå¸¸å—æ¬¢è¿äº†ã€‚

```plain
// split_test.go
package split

import (
	"reflect"
	"testing"
)

func TestSplit(t *testing.T) {
	tests := map[string]struct {
		input string
		sep   string
		want  []string
	}{
		"simple":       {input: "a/b/c", sep: "/", want: []string{"a", "b", "c"}},
		"wrong sep":    {input: "a/b/c", sep: ",", want: []string{"a/b/c"}},
		"no sep":       {input: "abc", sep: "/",   want: []string{"abc"}},
		"trailing sep": {input: "a/b/c/", sep: "/", want: []string{"a", "b", "c"}},
	}

	for name, tc := range tests {
		got := Split(tc.input, tc.sep)
		if !reflect.DeepEqual(tc.want, got) {
			t.Fatalf("%s: expected: %v, got: %v", name, tc.want, got)
		}
	}
}
```

æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠä¹‹å‰æµ‹è¯•CreateTableçš„å‡½æ•°ä¿®æ”¹ä¸ºè¡¨æ ¼é©±åŠ¨æµ‹è¯•ã€‚

```plain
func TestSqldb_CreateTableDriver(t *testing.T) {
	type args struct {
		t TableData
	}
	name := "test_create_table"

	tests := []struct {
		name    string
		args    args
		wantErr bool
	}{
		{
			name: "create_not_valid_table",
			args: args{TableData{
				TableName: name,
				ColumnNames: []Field{
					{Title: "ä¹¦å", Type: "not_valid"},
					{Title: "URL", Type: "VARCHAR(255)"},
				},
			}},
			wantErr: true,
		},
		{
			name: "create_valid_table",
			args: args{TableData{
				TableName: name,
				ColumnNames: []Field{
					{Title: "ä¹¦å", Type: "MEDIUMTEXT"},
					{Title: "URL", Type: "VARCHAR(255)"},
				},
			}},
			wantErr: false,
		},
		{
			name: "create_valid_table_with_primary_key",
			args: args{TableData{
				TableName: name,
				ColumnNames: []Field{
					{Title: "ä¹¦å", Type: "MEDIUMTEXT"},
					{Title: "URL", Type: "VARCHAR(255)"},
				},
				AutoKey: true,
			}},
			wantErr: false,
		},
	}

	sqldb, err := New(
		WithConnURL("root:123456@tcp(127.0.0.1:3326)/crawler?charset=utf8"),
	)

	for _, tt := range tests {
		err = sqldb.CreateTable(tt.args.t)
		if tt.wantErr {
			assert.NotNil(t, err, tt.name)
		} else {
			assert.Nil(t, err, tt.name)
		}
		sqldb.DropTable(tt.args.t)
	}
}
```

ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä¼šç»™æ¯ä¸€ä¸ªæµ‹è¯•åŠ ä¸Šåå­—ï¼Œæ–¹ä¾¿æˆ‘ä»¬åœ¨æµ‹è¯•å‡ºé”™æ—¶æ‰“å°å‡ºå…·ä½“çš„ç”¨ä¾‹ã€‚åœ¨ä¸Šä¾‹ä¸­ï¼Œæˆ‘ä»¬åœ¨assert.NotNilçš„ç¬¬ä¸‰ä¸ªå‚æ•°ä¸­åŠ ä¸Šäº†æµ‹è¯•çš„åå­—ï¼Œå‡å¦‚æµ‹è¯•å‡ºé”™ï¼Œæ‰“å°çš„ç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚

```plain
=== RUN   TestSqldb_CreateTableDriver
    sqldb_test.go:98: 
        	Error Trace:	/Users/jackson/career/crawler/sqldb/sqldb_test.go:98
        	Error:      	Expected nil, but got: &mysql.MySQLError{Number:0x428, Message:"You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'not_valid,URL VARCHAR(255)) ENGINE=MyISAM DEFAULT CHARSET=utf8' at line 1"}
        	Test:       	TestSqldb_CreateTableDriver
        	Messages:   	create_not_valid_table
--- FAIL: TestSqldb_CreateTableDriver (0.06s)

FAIL
```

é”™è¯¯ä¿¡æ¯æ¸…æ™°å¯è§ï¼Œå…¶ä¸­çš„Messageså°±æ˜¯ç›¸å…³æµ‹è¯•ç”¨ä¾‹çš„åå­—ã€‚

### **å­æµ‹è¯•**

å‰é¢æˆ‘ä»¬çœ‹åˆ°çš„ä¾‹å­éƒ½æ˜¯ä¸²è¡Œè°ƒç”¨çš„ï¼ŒCreateTableçš„ä¾‹å­ä¹Ÿç¡®å®ä¸å¤ªé€‚åˆä½¿ç”¨å¹¶å‘è°ƒç”¨ã€‚ä½†æ˜¯åœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡å¹¶å‘è°ƒç”¨æ¥åŠ é€Ÿæµ‹è¯•ï¼Œè¿™å°±æ˜¯å­æµ‹è¯•ä¸ºæˆ‘ä»¬åšçš„äº‹æƒ…ã€‚

ä½¿ç”¨å­æµ‹è¯•å¯ä»¥è°ƒç”¨testing.T çš„Runå‡½æ•°ï¼Œå­æµ‹è¯•ä¼šæ–°å¼€ä¸€ä¸ªåç¨‹ï¼Œå®ç°å¹¶è¡Œã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå­æµ‹è¯•è¿˜æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯ä¼šè¿è¡Œæ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆå³ä½¿æŸä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹å¤±è´¥äº†ï¼‰ã€‚è¿™æ ·åœ¨å‡ºé”™æ—¶ï¼Œå°±å¯ä»¥å°†å¤šä¸ªé”™è¯¯éƒ½æ‰“å°å‡ºæ¥ã€‚

å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬ç”¨ t.Run å­æµ‹è¯•æ¥æµ‹è¯•ä¹‹å‰çš„Splitå‡½æ•°ï¼Œå¹¶å‘æµ‹è¯•æ‰€æœ‰ç”¨ä¾‹ã€‚

```plain
func TestSplit(t *testing.T) {
	tests := map[string]struct {
		input string
		sep   string
		want  []string
	}{
		"simple":       {input: "a/b/c", sep: "/", want: []string{"a", "b", "c"}},
		"wrong sep":    {input: "a/b/c", sep: ",", want: []string{"a/b/c"}},
		"no sep":       {input: "abc", sep: "/", want: []string{"abc"}},
		"trailing sep": {input: "a/b/c/", sep: "/", want: []string{"a", "b", "c"}},
	}

	for name, tc := range tests {
		t.Run(name, func(t *testing.T) {
			got := Split(tc.input, tc.sep)
			if !reflect.DeepEqual(tc.want, got) {
				t.Fatalf("expected: %#v, got: %#v", tc.want, got)
			}
		})
	}
}
```

ä¸‹é¢è®©æˆ‘ä»¬ç”¨å­æµ‹è¯•æ¥æµ‹è¯•æˆ‘ä»¬MySQLåº“çš„æ’å…¥åŠŸèƒ½ã€‚è¿™é‡Œæˆ‘å¹¶å‘æµ‹è¯•äº†å››ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œt.runçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæµ‹è¯•ç”¨ä¾‹çš„åå­—ã€‚

```plain
func TestSqldb_InsertTable(t *testing.T) {
	type args struct {
		t TableData
	}
	tableName := "test_create_table"
	columnNames := []Field{{Title: "ä¹¦å", Type: "MEDIUMTEXT"}, {Title: "price", Type: "TINYINT"}}
	tests := []struct {
		name    string
		args    args
		wantErr bool
	}{
		{
			name: "insert_data",
			args: args{TableData{
				TableName:   tableName,
				ColumnNames: columnNames,
				Args:        []interface{}{"book1", 2},
				DataCount:   1,
			}},
			wantErr: false,
		},
		{
			name: "insert_multi_data",
			args: args{TableData{
				TableName:   tableName,
				ColumnNames: columnNames,
				Args:        []interface{}{"book3", 88.88, "book4", 99.99},
				DataCount:   2,
			}},
			wantErr: false,
		},
		{
			name: "insert_multi_data_wrong_count",
			args: args{TableData{
				TableName:   tableName,
				ColumnNames: columnNames,
				Args:        []interface{}{"book3", 88.88, "book4", 99.99},
				DataCount:   1,
			}},
			wantErr: true,
		},
		{
			name: "insert_wrong_data_type",
			args: args{TableData{
				TableName:   tableName,
				ColumnNames: columnNames,
				Args:        []interface{}{"book2", "rrr"},
				DataCount:   1,
			}},
			wantErr: true,
		},
	}

	sqldb, err := New(
		WithConnURL("root:123456@tcp(127.0.0.1:3326)/crawler?charset=utf8"),
	)
	err = sqldb.CreateTable(tests[0].args.t)
	defer sqldb.DropTable(tests[0].args.t)
	assert.Nil(t, err)
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			err = sqldb.Insert(tt.args.t)
			if tt.wantErr {
				assert.NotNil(t, err, tt.name)
			} else {
				assert.Nil(t, err, tt.name)
			}
		})
	}
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚

```plain
Â» go test -run=TestSqldb_InsertTable                                                                                    jackson@bogon
--- FAIL: TestSqldb_InsertTable (0.07s)
    --- FAIL: TestSqldb_InsertTable/insert_wrong_data_type (0.01s)
        sqldb_test.go:171: 
                Error Trace:    /Users/jackson/career/crawler/sqldb/sqldb_test.go:171
                Error:          Expected nil, but got: &mysql.MySQLError{Number:0x556, Message:"Incorrect integer value: 'rrr' for column 'price' at row 1"}
                Test:           TestSqldb_InsertTable/insert_wrong_data_type
                Messages:       insert_wrong_data_type
FAIL
exit status 1
FAIL    github.com/dreamerjackson/crawler/sqldb 0.085s
```

å¯ä»¥çœ‹åˆ°ï¼Œå½“æ£€æµ‹åˆ°é”™è¯¯æ—¶ï¼Œèƒ½å¤Ÿæ¸…æ™°å±•ç¤ºå‡ºé”™è¯¯ç”¨ä¾‹çš„ä¿¡æ¯ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†go test -run xxxå‚æ•°æ¥æŒ‡å®šæˆ‘ä»¬è¦è¿è¡Œçš„ç¨‹åºã€‚-runåé¢è·Ÿçš„æ˜¯è¦æµ‹è¯•çš„å‡½æ•°åï¼Œæµ‹è¯•æ—¶ä¼šæ¨¡ç³ŠåŒ¹é…è¯¥å‡½æ•°åï¼Œç¬¦åˆæ¡ä»¶çš„å‡½æ•°éƒ½å°†è¢«æµ‹è¯•ã€‚æ‰€ä»¥åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œgo test -run=TestSqldb\_InsertTable ä¸go test -run=InsertTableçš„æ‰§è¡Œæ•ˆæœæ˜¯ä¸€è‡´çš„ã€‚

å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åŠ å…¥-vå‚æ•°æ‰“å°å‡ºè¯¦ç»†çš„ä¿¡æ¯ã€‚

```plain
Â» go test -run=InsertTable -v                                                                                           jackson@bogon
=== RUN   TestSqldb_InsertTable
=== RUN   TestSqldb_InsertTable/insert_data
=== RUN   TestSqldb_InsertTable/insert_multi_data
=== RUN   TestSqldb_InsertTable/insert_multi_data_wrong_count
=== RUN   TestSqldb_InsertTable/insert_wrong_data_type
    sqldb_test.go:171: 
                Error Trace:    /Users/jackson/career/crawler/sqldb/sqldb_test.go:171
                Error:          Expected nil, but got: &mysql.MySQLError{Number:0x556, Message:"Incorrect integer value: 'rrr' for column 'price' at row 1"}
                Test:           TestSqldb_InsertTable/insert_wrong_data_type
                Messages:       insert_wrong_data_type
--- FAIL: TestSqldb_InsertTable (0.07s)
    --- PASS: TestSqldb_InsertTable/insert_data (0.01s)
    --- PASS: TestSqldb_InsertTable/insert_multi_data (0.01s)
    --- PASS: TestSqldb_InsertTable/insert_multi_data_wrong_count (0.00s)
    --- FAIL: TestSqldb_InsertTable/insert_wrong_data_type (0.01s)
FAIL
exit status 1
FAIL    github.com/dreamerjackson/crawler/sqldb 0.084s
```

-runåè¿˜å¯ä»¥åªæŒ‡å®šè¿è¡ŒæŸä¸€ä¸ªç‰¹å®šçš„å­æµ‹è¯•ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åªè¿è¡ŒTestSqldb\_InsertTableæµ‹è¯•å‡½æ•°ä¸‹çš„insert\_multi\_data\_wrong\_countå­æµ‹è¯•ã€‚

```plain
Â» go test -run=TestSqldb_InsertTable/insert_multi_data_wrong_count  -v                                                  jackson@bogon
=== RUN   TestSqldb_InsertTable
=== RUN   TestSqldb_InsertTable/insert_multi_data_wrong_count
--- PASS: TestSqldb_InsertTable (0.04s)
    --- PASS: TestSqldb_InsertTable/insert_multi_data_wrong_count (0.00s)
PASS
ok      github.com/dreamerjackson/crawler/sqldb 0.055s
```

### ä¾èµ–æ³¨å…¥

å‰é¢æˆ‘ä»¬ä»‹ç»äº†å•å…ƒæµ‹è¯•çš„å‡ ç§æŠ€æœ¯ã€‚å½“æˆ‘ä»¬è¿›è¡Œå•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œå¯èƒ½è¿˜ä¼šé‡åˆ°ä¸€äº›æ£˜æ‰‹çš„ä¾èµ–é—®é¢˜ã€‚ä¾‹å¦‚ä¸€ä¸ªå‡½æ•°éœ€è¦ä»ä¸‹æ¸¸çš„å¤šä¸ªæœåŠ¡ä¸­è·å–ä¿¡æ¯å¹¶å®Œæˆåç»­çš„æ“ä½œã€‚åœ¨æµ‹è¯•æ—¶ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å¯åŠ¨è¿™äº›ä¾èµ–ï¼Œæ­¥éª¤ä¼šéå¸¸ç¹çï¼Œæœ‰æ—¶å€™ç”šè‡³æ— æ³•åœ¨æœ¬åœ°å®ç°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¾èµ–æ³¨å…¥çš„æ–¹å¼å¯¹è¿™äº›ä¾èµ–è¿›è¡ŒMockï¼Œè¿™ç§æ–¹å¼ä¹Ÿèƒ½å¤Ÿè®©æˆ‘ä»¬çµæ´»åœ°æ§åˆ¶ä¸‹æ¸¸è¿”å›çš„æ•°æ®ã€‚

æˆ‘ä»¬ä»¥é¡¹ç›®ä¸­çš„Flush()ä¸ºä¾‹ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæœ€åçš„ s.db.Insert éœ€è¦æˆ‘ä»¬æŠŠæ•°æ®æ’å…¥æ•°æ®åº“ã€‚

```plain
func (s *SQLStorage) Flush() error {
	if len(s.dataDocker) == 0 {
		return nil
	}

	defer func() {
		s.dataDocker = nil
	}()
	...
	return s.db.Insert(sqldb.TableData{
		TableName:   s.dataDocker[0].GetTableName(),
		ColumnNames: getFields(s.dataDocker[0]),
		Args:        args,
		DataCount:   len(s.dataDocker),
	})
}
```

ä½†æˆ‘ä»¬å…¶å®å¹¶ä¸æ˜¯çœŸçš„éœ€è¦ä¸€ä¸ªæ•°æ®åº“ã€‚è®©æˆ‘ä»¬æ–°å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶sqlstorage\_test.goï¼Œç„¶åå®ç°æ•°æ®åº“DBeræ¥å£ã€‚

```plain
// sqlstorage_test.go
type mysqldb struct {
}

func (m mysqldb) CreateTable(t sqldb.TableData) error {
	return nil
}

func (m mysqldb) Insert(t sqldb.TableData) error {
	return nil
}
```

æ¥ç€ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†mysqldbæ³¨å…¥åˆ°SQLStorageç»“æ„ä¸­ï¼Œå•å…ƒæµ‹è¯•å¦‚ä¸‹æ‰€ç¤ºã€‚

```plain
func TestSQLStorage_Flush(t *testing.T) {
	type fields struct {
		dataDocker []*spider.DataCell
		options    options
	}
	tests := []struct {
		name    string
		fields  fields
		wantErr bool
	}{
		{name: "empty", wantErr: false},
		{name: "no Rule filed", fields: fields{dataDocker: []*spider.DataCell{
			{Data: map[string]interface{}{"url": "<http://xxx.com>"}},
		}}, wantErr: true},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			s := &SQLStorage{
				dataDocker: tt.fields.dataDocker,
				db:         mysqldb{},
				options:    tt.fields.options,
			}
			if err := s.Flush(); (err != nil) != tt.wantErr {
				t.Errorf("Flush() error = %v, wantErr %v", err, tt.wantErr)
			}
			assert.Nil(t, s.dataDocker)
		})
	}
}
```

æµ‹è¯•ç”¨ä¾‹ä¸­æµ‹è¯•äº†æ²¡æœ‰Ruleå­—æ®µæ—¶çš„æƒ…å½¢ï¼Œä½†æ˜¯ç¨‹åºå´ç›´æ¥panicäº†ã€‚è¿™å°±æ˜¯å•å…ƒæµ‹è¯•çš„æ„ä¹‰æ‰€åœ¨ï¼Œå®ƒå¯ä»¥ä¸ºæˆ‘ä»¬æ‰¾åˆ°ä¸€äº›ç‰¹æ®Šçš„è¾“å…¥ï¼Œç¡®è®¤å®ƒä»¬æ˜¯å¦ä»ç„¶ç¬¦åˆé¢„æœŸã€‚

ç»è¿‡æµ‹è¯•æˆ‘ä»¬å‘ç°ï¼Œç”±äºæˆ‘ä»¬å°†æ¥å£å¼ºåˆ¶è½¬æ¢ä¸ºäº†stringï¼Œå½“æ¥å£ç±»å‹ä¸åŒ¹é…æ—¶å°±ä¼šç›´æ¥panicã€‚

```plain
ruleName := datacell.Data["Rule"].(string)
taskName := datacell.Data["Task"].(string)
```

è¦é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å¼‚å¸¸æƒ…å†µè¿›è¡Œåˆ¤æ–­ï¼Œå®Œæ•´çš„æµ‹è¯•ä½ å¯ä»¥æŸ¥çœ‹[æœ€æ–°çš„é¡¹ç›®ä»£ç ](https://github.com/dreamerjackson/crawler)ã€‚

```plain
if ruleName, ok = datacell.Data["Rule"].(string); !ok {
			return errors.New("no rule field")
		}

	if taskName, ok = datacell.Data["Task"].(string); !ok {
		return errors.New("no task field")
	}
```

## å‹åŠ›æµ‹è¯•

æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜å¸Œæœ›å¯¹ç¨‹åºè¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œå®ƒå¯ä»¥æµ‹è¯•éšæœºåœºæ™¯ã€æ’é™¤å¶ç„¶å› ç´ ã€æµ‹è¯•å‡½æ•°ç¨³å®šæ€§ç­‰ç­‰ã€‚

å®ç°å‹åŠ›æµ‹è¯•çš„æ–¹æ³•å’Œå·¥å…·æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚abã€wrkã€‚åˆç†çš„å‹åŠ›æµ‹è¯•é€šå¸¸éœ€è¦ç»“åˆå®é™…é¡¹ç›®æ¥è®¾è®¡ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¹¦å†™Shellè„šæœ¬æ¥è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œå¦‚ä¸‹è„šæœ¬ä¸­ï¼Œ æˆ‘ä»¬å¯ä»¥ç”¨go test -c ä¸ºæµ‹è¯•å‡½æ•°ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶å¾ªç¯è°ƒç”¨æµ‹è¯•å‡½æ•°ã€‚

```plain
# pressure.sh
go test -c # -cä¼šç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶

PKG=$(basename $(pwd))  # è·å–å½“å‰è·¯å¾„çš„æœ€åä¸€ä¸ªåå­—ï¼Œå³ä¸ºæ–‡ä»¶å¤¹çš„åå­—
echo $PKG
while true ; do
        export GOMAXPROCS=$[ 1 + $[ RANDOM % 128 ]] # éšæœºçš„GOMAXPROCS
        ./$PKG.test $@ 2>&1   # $@ä»£è¡¨å¯ä»¥åŠ å…¥å‚æ•°   2>&1ä»£è¡¨é”™è¯¯è¾“å‡ºåˆ°æ§åˆ¶å°
done
```

ä»¥ä¹‹å‰çš„åŠ æ³•å‡½æ•°ä¸ºä¾‹ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å³å¯å¯¹æµ‹è¯•å‡½æ•°è¿›è¡Œå‹åŠ›æµ‹è¯•ã€‚å…¶ä¸­ï¼Œ-test.v ä¸ºè¿è¡Œå‚æ•°ï¼Œç”¨äºè¾“å‡ºè¯¦ç»†ä¿¡æ¯ã€‚

```plain
> /pressure.sh -test.v

PASS
=== RUN   TestAdd
--- PASS: TestAdd (0.00s)
    add_test.go:17: the result is ok
PASS
=== RUN   TestAdd
--- PASS: TestAdd (0.00s)
    add_test.go:17: the result is ok
```

## åŸºå‡†æµ‹è¯•

Goæµ‹è¯•åŒ…ä¸­å†…ç½®äº†BenchmarksåŸºå‡†æµ‹è¯•ï¼Œå®ƒå¯ä»¥å¯¹æ¯”æ”¹è¿›åå’Œæ”¹è¿›å‰çš„å‡½æ•°ï¼ŒæŸ¥çœ‹æ€§èƒ½æå‡æ•ˆæœï¼Œä¹Ÿå¯ä»¥ä¾›æˆ‘ä»¬æ¢ç´¢ä¸€äº›Goçš„ç‰¹æ€§ã€‚

æˆ‘ä»¬å¯ä»¥ç”¨åŸºå‡†æµ‹è¯•æ¥å¯¹æ¯”ä¹‹å‰çš„æ¥å£è°ƒç”¨ä¸ç›´æ¥å‡½æ•°è°ƒç”¨ã€‚

```plain
package escape

import "testing"

type Sumifier interface{ Add(a, b int32) int32 }

type Sumer struct{ id int32 }

func (math Sumer) Add(a, b int32) int32 { return a + b }

type SumerPointer struct{ id int32 }

func (math *SumerPointer) Add(a, b int32) int32 { return a + b }

func BenchmarkDirect(b *testing.B) {
	adder := Sumer{id: 6754}
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		adder.Add(10, 12)
	}
}

func BenchmarkInterface(b *testing.B) {
	adder := Sumer{id: 6754}
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		Sumifier(adder).Add(10, 12)
	}
}

func BenchmarkInterfacePointer(b *testing.B) {
	adder := &SumerPointer{id: 6754}
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		Sumifier(adder).Add(10, 12)
	}
}
```

go test å¯ä»¥åŠ å…¥-gcflags æŒ‡å®šç¼–è¯‘å™¨çš„è¡Œä¸ºã€‚ä¾‹å¦‚è¿™é‡Œçš„-gcflags â€œ-N -lâ€ è¡¨ç¤ºç¦æ­¢ç¼–è¯‘å™¨çš„ä¼˜åŒ–ä¸å†…è”ï¼Œ-bench=. è¡¨ç¤ºæ‰§è¡ŒåŸºå‡†æµ‹è¯•ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¯¹æ¯”å‰åå‡ ä¸ªå‡½æ•°çš„æ€§èƒ½å·®å¼‚äº†ã€‚

```plain
Â» go test -gcflags "-N -l"   -bench=.
BenchmarkDirect-12                      535487740                1.95 ns/op
BenchmarkInterface-12                   76026812                 14.6 ns/op
BenchmarkInterfacePointer-12            517756519                2.37 ns/op
```

BenchMarkæµ‹è¯•æ—¶è¿˜å¯ä»¥æŒ‡å®šä¸€äº›å…¶ä»–è¿è¡Œå‚æ•°ï¼Œä¾‹å¦‚-benchmemå¯ä»¥æ‰“å°æ¯æ¬¡å‡½æ•°çš„å†…å­˜åˆ†é…æƒ…å†µï¼Œ-cpuprofileã€-memprofileè¿˜èƒ½æ”¶é›†ç¨‹åºçš„ CPU å’Œå†…å­˜çš„ profile æ–‡ä»¶ã€‚

```plain
go test ./fibonacci \\
  -bench BenchmarkSuite \\
  -benchmem \\
  -cpuprofile=cpu.out \\
  -memprofile=mem.out
```

è¿™äº›ç”Ÿæˆçš„æ ·æœ¬æ–‡ä»¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨pprofå·¥å…·è¿›è¡Œå¯è§†åŒ–åˆ†æã€‚å…³äºpprofå·¥å…·ï¼Œæˆ‘ä»¬åœ¨ä¹‹åè¿˜ä¼šåšè¯¦ç»†ä»‹ç»ã€‚

## æ€»ç»“

è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä»‹ç»äº†Goä¸­çš„å¤šç§æµ‹è¯•æŠ€æœ¯ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€è¡¨æ ¼é©±åŠ¨æµ‹è¯•ã€å­æµ‹è¯•ã€åŸºå‡†æµ‹è¯•ã€å‹åŠ›æµ‹è¯•ã€ä¾èµ–æ³¨å…¥ç­‰ã€‚çµæ´»åœ°ä½¿ç”¨è¿™äº›æµ‹è¯•æŠ€æœ¯å¯ä»¥æå‰å‘ç°ç³»ç»Ÿå­˜åœ¨çš„æ€§èƒ½é—®é¢˜ï¼Œåœ¨åé¢çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜ä¼šä»‹ç»ä»£ç è¦†ç›–ç‡å’Œæ¨¡ç³Šæµ‹è¯•ç­‰æ–°çš„æµ‹è¯•æŠ€æœ¯ã€‚

## è¯¾åé¢˜

ä½ è§‰å¾—reflect.DeepEqualçš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Œæœ‰å…¶ä»–çš„æ›¿ä»£æ–¹æ¡ˆå—ï¼Ÿå¯¹äºä¸€ä¸ªå¤æ‚çš„ç»“æ„ï¼Œå¦‚æœreflect.DeepEqualè¿”å›äº†fasleï¼Œæ€ä¹ˆçŸ¥é“æ˜¯å“ªä¸€ä¸ªå­—æ®µä¸ä¸€è‡´å‘¢ï¼Ÿ

æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ3ï¼‰</strong></div><ul>
<li><span>æ‹¾æ‡æ‹¾æ‡</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>goland ä¼šè‡ªåŠ¨å¸®ä½ å»ºå¥½è¡¨æ ¼æµ‹è¯•</p>2023-01-09</li><br/><li><span>Yaney</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æœ‰æ²¡æœ‰æ¨èçš„ä»£ç è‡ªåŠ¨ç”Ÿæˆå·¥å…·å‘€ï¼Œæ¯”å¦‚mockery</p>2023-03-10</li><br/><li><span>é‚£æ—¶åˆ»</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æˆ‘äº†è§£çš„ reflect.DeepEqual çš„ç¼ºç‚¹æ˜¯ä¸èƒ½æ¯”è¾ƒä¸å¯¼å‡ºçš„keyï¼ˆå°å†™keyï¼‰ã€‚å¯ä»¥ä½¿ç”¨ `github.com&#47;google&#47;go-cmp`ä»£æ›¿ï¼Œè¿™ä¸ªåº“å¯ä»¥è¾“å‡ºä¸ä¸€æ ·çš„å­—æ®µå€¼ï¼Œç¼ºç‚¹æ˜¯ä¸èƒ½ç”¨äºproductionï¼Œå¯ä»¥ç”¨äºæµ‹è¯•ç¯å¢ƒã€‚</p>2023-02-17</li><br/>
</ul>