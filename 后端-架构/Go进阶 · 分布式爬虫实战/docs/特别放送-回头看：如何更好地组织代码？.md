ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ‘å»ºå‹‹ã€‚

åœ¨åˆ©ç”¨Goè¯­è¨€è¿›è¡Œç³»ç»Ÿå¼€å‘æ—¶ï¼Œç›¸ä¿¡ä½ æˆ–æ—©æˆ–æ™šéƒ½ä¼šæ€è€ƒè¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šå¦‚ä½•æ›´å¥½åœ°ç»„ç»‡ä»£ç ï¼Ÿæˆ–è€…è¯´å¦‚ä½•æ›´å¥½åœ°æ„å»ºé¡¹ç›®çš„ç›®å½•ç»“æ„ï¼Ÿ

è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå®¹æ˜“å›ç­”çš„é—®é¢˜ï¼Œå› ä¸ºè¿™é€šå¸¸ä¸ä¼šæœ‰æ ‡å‡†çš„ç­”æ¡ˆã€‚å¼€å‘è€…å¯¹Goè¯­è¨€å’Œè½¯ä»¶å¼€å‘çš„ç†è§£ä¸åŒã€é¢ä¸´çš„ä¸šåŠ¡åœºæ™¯ä¸åŒï¼Œä»£ç çš„ç»„ç»‡æ–¹å¼ä¹Ÿä¼šæˆªç„¶ä¸åŒã€‚

ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬å¯¹è¿™ä¸ªé—®é¢˜ä¸ç®¡ä¸é¡¾ï¼Œä¼šå‘ç°ä»£ç ä¹¦å†™èµ·æ¥è¶Šæ¥è¶Šåˆ«æ‰­ã€‚ä»£ç è¶Šæ¥è¶Šéš¾åšå¤§çš„è°ƒæ•´äº†ã€‚å› æ­¤ï¼Œåœ¨å®Œæˆå¯¹çˆ¬è™«ç³»ç»Ÿçš„å¼€å‘åï¼Œè®©æˆ‘ä»¬é‡æ–°æ¥æ€è€ƒä¸€ä¸‹å¦‚ä½•æ›´å¥½åœ°ç»„ç»‡ä»£ç ã€‚

## æŒ‰ç…§åŠŸèƒ½åˆ’åˆ†ç»„ç»‡ä»£ç 

æˆ‘ä»¬ä¹‹å‰è®¾è®¡çš„çˆ¬è™«ç³»ç»Ÿæœ‰å¯¹ä»£ç è¿›è¡Œç»„ç»‡å—ï¼Ÿ

å½“ç„¶æ˜¯æœ‰çš„ï¼Œä¾é æˆ‘ä»¬è½¯ä»¶å¼€å‘çš„ç»éªŒï¼Œä»£ç ä¸­æœ‰å¾ˆå¤šå¢åŠ ä»£ç æ‰©å±•æ€§çš„è®¾è®¡ã€‚åŒ…æ‹¬Optionæ¨¡å¼ã€å¤§é‡ä½¿ç”¨æ¥å£è§£è€¦ä¾èµ–ã€åœ¨mainå‡½æ•°ä¸­ç»Ÿä¸€æ³¨å…¥ä¾èµ–ç­‰ç­‰ã€‚ä»æ•´ä½“ä¸Šæ¥çœ‹ï¼Œæˆ‘ä»¬ä¹Ÿä½¿ç”¨äº†æ‰å¹³åŒ–çš„ç›®å½•ç»“æ„ï¼Œæ²¡æœ‰åµŒå¥—å¤ªæ·±çš„å±‚æ¬¡ç»“æ„ã€‚åŒæ—¶ï¼Œä¸ºäº†ä¾¿äºå¯¹ä»£ç è¿›è¡Œç®¡ç†ï¼Œæˆ‘ä»¬æ ¹æ®åŠŸèƒ½å¯¹ä»£ç ç»“æ„è¿›è¡Œäº†åˆ’åˆ†ã€‚ä¾‹å¦‚ï¼Œauthè´Ÿè´£æƒé™éªŒè¯ï¼ŒcollectåŒ…ç”¨äºç½‘ç»œçˆ¬å–ï¼Œstorageç”¨äºæ•°æ®çš„å­˜å‚¨ã€‚ä¸Šé¢çš„è¿™äº›è®¾è®¡ä¿è¯äº†æˆ‘ä»¬å¯¹è¿™ä¸ªçˆ¬è™«ç³»ç»Ÿä»ç„¶æœ‰è¾ƒå¼ºçš„æ§åˆ¶åŠ›ã€‚

é€šè¿‡åŠŸèƒ½å¯¹ä»£ç ç»“æ„è¿›è¡Œåˆ’åˆ†æ˜¯ä¸€ç§æ¯”è¾ƒå¸¸è§çš„ä¹Ÿæ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„æ¨¡å¼ã€‚ä½†æ˜¯åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šé‡åˆ°ä¸å°‘çš„éš¾é¢˜ï¼Œè¿™äº›é—®é¢˜ä¹Ÿå­˜åœ¨äºæˆ‘ä»¬å¼€å‘çˆ¬è™«ç³»ç»Ÿçš„è¿‡ç¨‹ä¸­ï¼Œ**æ¯”è¾ƒä¸¥é‡çš„ä¸¤ä¸ªå°±æ˜¯å‘½åé—®é¢˜å’Œå¾ªç¯ä¾èµ–é—®é¢˜ã€‚**

å…ˆæ¥çœ‹å‘½åé—®é¢˜ã€‚

æˆ‘ä»¬ä¹‹å‰æŠ½è±¡å‡ºäº†ä¸€ä¸ªFetcheræ¥å£æ¥é‡‡é›†ç½‘ç«™ä¿¡æ¯ï¼Œå¹¶ä¸”å®ç°äº†ç›´æ¥çˆ¬å–ä¸æ¨¡æ‹Ÿæµè§ˆå™¨è®¿é—®ä¸¤ç§æ¨¡å¼ã€‚å¯¹äºç½‘ç«™ä¿¡æ¯é‡‡é›†è¿™ä¸€é‡è¦çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°è¦ä½¿ç”¨ä¸€ä¸ªpackageå•ç‹¬ç®¡ç†å®ƒï¼Œä¹Ÿå¾ˆå®¹æ˜“æƒ³åˆ°å°†packageå‘½åä¸ºfetchã€‚è¿™æ—¶é—®é¢˜å°±å‡ºç°äº†ï¼Œæˆ‘ä»¬è¦å¼•ç”¨fetchåŒ…æ—¶ï¼Œå‘½åå°±å˜æˆäº† `fetch.Fetcher, fetch.BrowserFetch`ï¼Œç±»ä¼¼çš„å‘½åè¿˜æœ‰ `task.Task` ç­‰ç­‰ã€‚è¿™äº›å‘½ååŒ…å«ç€é‡å¤è¯­ä¹‰ä»£ç ï¼Œè®©äººæ„Ÿåˆ°å¾ˆåˆ«æ‰­ã€‚

```plain
package fetch

import (
	"xxx/task"
	"net/http"
)

type Fetcher interface {
	Get(url *Request) ([]byte, error)
}

type Request struct {
	Task *task.Task
	URL  string
}

type BrowserFetch struct{}

func (b BrowserFetch) Get(request *Request) ([]byte, error) {
	req, _ := http.NewRequest("GET", request.URL, nil)
	if len(request.Task.Cookie) > 0 {
		req.Header.Set("Cookie", request.Task.Cookie)
	}
	// ...
	return nil, nil
}
```

æˆ‘ä»¬å†æ¥çœ‹çœ‹å¾ªç¯ä¾èµ–é—®é¢˜ã€‚å‡è®¾æˆ‘ä»¬åˆæ–°å»ºäº†ä¸€ä¸ªTaskçš„ package ç”¨äºå¤„ç†å’Œä»»åŠ¡ç›¸å…³çš„å·¥ä½œï¼Œå¾ˆå¿«æˆ‘ä»¬å°±ä¼šå‘ç°å‡ºç°äº†å¾ªç¯ä¾èµ–é—®é¢˜ã€‚åœ¨fetcheråŒ…ä¸­çš„Requestç»“æ„ä½“å¼•ç”¨äº†TaskåŒ…ä¸­çš„Taskç»“æ„ã€‚è€ŒTaskç»“æ„ä¸­åŒ…å«äº†è§„åˆ™æ ‘RuleTreeï¼ŒRuleTreeä¸­å¼•ç”¨äº†fetch.Requestã€‚è¿™å¯¼è‡´fetch packageä¸task packageç›¸äº’ä¾èµ–ã€‚

```plain
package task

import (
	"xxx/fetch"
	"sync"
)

type Task struct {
	Visited     map[string]bool
	VisitedLock sync.Mutex
	Cookie      string
	Rule        RuleTree
}

type RuleTree struct {
	Root func() ([]*fetch.Request, error) // æ ¹èŠ‚ç‚¹(æ‰§è¡Œå…¥å£)
}
```

å¯ä»¥çœ‹åˆ°ï¼Œç®€å•åœ°æŒ‰ç…§åŠŸèƒ½ç»„ç»‡ä»£ç ï¼Œå‘½åé—®é¢˜å’Œå¾ªç¯ä¾èµ–é—®é¢˜éƒ½æ˜¯éå¸¸è®©äººå¤´ç–¼çš„ã€‚

## æŒ‰ç…§å•ä½“åˆ’åˆ†ç»„ç»‡ä»£ç 

ä¸ºäº†è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œæˆ‘ä»¬èƒ½å¦æŠŠæ‰€æœ‰çš„ä»£ç éƒ½æ”¾å…¥åŒä¸€ä¸ªpackageä¸­å‘¢ï¼Ÿè¿™æ ·å°±ä¸å­˜åœ¨å‘½åçš„é—®é¢˜äº†ï¼ŒåŒæ—¶ä¹Ÿå°±æ²¡æœ‰äº†å¾ªç¯ä¾èµ–çš„é—®é¢˜ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼ä¸€èˆ¬åªé€‚åˆäºå°å‹çš„åº”ç”¨ç¨‹åºï¼Œä¸€æ—¦ä»£ç æ•°é‡è¶…è¿‡ä¸€å®šå¤§å°ï¼ˆä¾‹å¦‚1ä¸‡è¡Œä»£ç ï¼‰ï¼Œé˜…è¯»å’Œç®¡ç†ä»£ç éƒ½ä¼šè¶Šæ¥è¶Šå›°éš¾ã€‚

## æŒ‰ç…§å±‚çº§åˆ’åˆ†ç»„ç»‡ä»£ç 

åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬è¿˜ç»å¸¸çœ‹åˆ°åˆ†å±‚çš„ä»£ç ç»„ç»‡æ–¹å¼ã€‚æ¯”è¾ƒç»å…¸çš„åˆ†å±‚æ¨¡å¼æ˜¯MVCæ¨¡å¼ã€‚MVCæ¨¡å¼ä¸€èˆ¬ç”¨äºWebæœåŠ¡å’Œæ¡Œé¢ç«¯åº”ç”¨ç¨‹åºï¼Œåœ¨å…¸å‹çš„MVCæ¨¡å‹ä¸­ï¼Œä»£ç è¢«åˆ†ä¸ºäº†è§†å›¾å±‚ï¼ˆViewï¼‰ã€æ§åˆ¶å±‚ï¼ˆControllerï¼‰å’Œæ¨¡å‹å±‚ï¼ˆModelï¼‰ã€‚

å…¶ä¸­ï¼ŒViewå±‚ç”¨äºæ•°æ®æˆ–è€…é¡µé¢å±•ç¤ºï¼Œè€Œæ¯”è¾ƒå°‘è¿›è¡Œé€»è¾‘å¤„ç†ã€‚Controllerå±‚è´Ÿè´£åœ¨æ¨¡å‹å’Œè§†å›¾ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚Modelå±‚ç”¨äºç®¡ç†åº”ç”¨ç¨‹åºçš„æ•°æ®å’Œä¸šåŠ¡è§„åˆ™ï¼Œå¹¶è´Ÿè´£ä¸æ•°æ®åº“è¿›è¡Œäº¤äº’ã€‚å…¸å‹çš„MVCç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºã€‚

```plain
app/
  models/
    user.go
    course.go
  controllers/
    user.go
    course.go
  views/
    user.go
    course.go
```

åˆ†å±‚çš„æ¶æ„èƒ½å¤Ÿæä¾›ç»Ÿä¸€çš„å¼€å‘æ¨¡å¼ï¼Œè®©å¼€å‘è€…å®¹æ˜“ç†è§£ã€‚ä½†æ˜¯ä½¿ç”¨åˆ†å±‚æ¶æ„æ„å‘³ç€ï¼Œåªè¦æ·»åŠ æˆ–æ›´æ”¹ä¸šåŠ¡åŠŸèƒ½å°±å‡ ä¹è¦æ¶‰åŠåˆ°æ‰€æœ‰å±‚çº§ï¼Œè¿™æ ·ä¸€æ¥ï¼Œè¦ä¿®æ”¹å•ä¸ªåŠŸèƒ½å°±å˜å¾—éå¸¸éº»çƒ¦äº†ã€‚

åˆ†å±‚æ¶æ„è¿˜é¢ä¸´ç€å’ŒåŠŸèƒ½æ¶æ„ç›¸åŒçš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå‡ºç°controller.UserControllerè¿™æ ·ä¸å¤ªä¼˜é›…çš„å‘½åã€‚å¦‚æœå¤šä¸ªå±‚ä¹‹é—´å…±ç”¨äº†åŒä¸€ä¸ªç»“æ„ï¼Œè¿™ä¸ªç»“æ„åº”è¯¥æ”¾åœ¨å“ªé‡Œå‘¢ï¼Ÿéšç€ä»£ç é‡çš„ä¸Šæ¶¨ï¼Œå±‚ä¸å±‚ä¹‹é—´ï¼Œç”šè‡³æ˜¯åŒå±‚çš„ä¸åŒå­æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ä¼šéå¸¸æ··ä¹±ï¼Œä¾ç„¶å®¹æ˜“å‡ºç°å¾ªç¯ä¾èµ–çš„é—®é¢˜ã€‚

æˆ‘ä¸¾ä¸€ä¸ªä¾‹å­ï¼ŒModelå±‚æä¾›äº†ä¸€ä¸ªç”¨äºå­˜å‚¨æ•°æ®çš„Storageæ¥å£ï¼ŒNewStorageå‡½æ•°ä¼šæ ¹æ®storageTypeç±»å‹çš„ä¸åŒï¼Œå†³å®šæ˜¯ä½¿ç”¨æ•°æ®åº“å­˜å‚¨å¼•æ“è¿˜æ˜¯å†…å­˜å­˜å‚¨å¼•æ“ã€‚

```plain
package models
import "xxx/storage"

type Storage interface {
	SaveBeer(...Beer) error
	SaveReview(...Review) error
	FindBeer(Beer) ([]*Beer, error)
	FindReview(Review) ([]*Review, error)
	FindBeers() []Beer
	FindReviews() []Review
}

func NewStorage(storageType StorageType) error {
	var err error

	switch storageType {
	case Memory:
		DB = new(storage.Memory)

	case JSON:
		DB, err = storage.NewJSON("./data/")
		if err != nil {
			return err
		}
	}

	return nil
}
```

æ•°æ®åº“å¼•æ“çš„å…·ä½“å®ç°ä½äºstorageåŒ…ä¸­ã€‚åœ¨storageåŒ…ä¸­ï¼Œåˆå¼•ç”¨äº†modelåŒ…ä¸­å®šä¹‰çš„æ•°æ®ç±»å‹ï¼Œè¿™å°±å¯¼è‡´äº†å¾ªç¯ä¾èµ–é—®é¢˜ã€‚

```plain
package storage

import "xxx/models"

type Memory struct {
	cellar  []models.Beer
	reviews []models.Review
}

func (s *Memory) SaveBeer(beers ...models.Beer) error {
	for _, beer := range beers {
		var err error
}
```

è¿™è¯´æ˜åœ¨Goä¸­ï¼Œç®€å•åœ°æŒ‰ç…§åˆ†å±‚æ€æƒ³æ¥ç»„ç»‡ä»£ç ä»ç„¶ä¸è¶³ä»¥è®©äººæ»¡æ„ã€‚

## æŒ‰ç…§é¢†åŸŸé©±åŠ¨è®¾è®¡ç»„ç»‡ä»£ç 

ä¸ºäº†åº”å¯¹ä¸Šé¢è¿™äº›æŒ‘æˆ˜ï¼Œæˆ‘ä»¬æ¥ç»§ç»­æ¢ç´¢ä¸€ä¸‹ç”¨é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼ŒDomain-Driven Designï¼‰ç»„ç»‡ä»£ç ã€‚

DDDæ˜¯ Eric Evans äº 2004 å¹´æå‡ºçš„ä¸€ç§è½¯ä»¶è®¾è®¡æ–¹æ³•å’Œç†å¿µã€‚DDD çš„æ ¸å¿ƒæ€æƒ³æ˜¯å›´ç»•æ ¸å¿ƒçš„ä¸šåŠ¡æ¦‚å¿µï¼Œå®šä¹‰é¢†åŸŸæ¨¡å‹ï¼ŒæŒ‡å¯¼ä¸šåŠ¡ä¸åº”ç”¨çš„è®¾è®¡å’Œå®ç°ã€‚å®ƒä¸»å¼ å¼€å‘äººå‘˜ä¸ä¸šåŠ¡äººå‘˜æŒç»­åœ°æ²Ÿé€šå¹¶æŒç»­è¿­ä»£æ¨¡å‹ï¼Œä¿è¯ä¸šåŠ¡æ¨¡å‹ä¸ä»£ç å®ç°çš„ä¸€è‡´æ€§ï¼Œæœ€ç»ˆæœ‰æ•ˆç®¡ç†ä¸šåŠ¡å¤æ‚åº¦ï¼Œä¼˜åŒ–è½¯ä»¶è®¾è®¡ã€‚

DDDæ‹¥æœ‰æ¯”è¾ƒé™¡å³­çš„å­¦ä¹ æ›²çº¿ï¼Œå› ä¸ºå®ƒæœ‰è®¸å¤šæ–°çš„æœ¯è¯­ï¼Œä¾‹å¦‚é¢†åŸŸï¼ˆDomainï¼‰ã€é™ç•Œä¸Šä¸‹æ–‡ï¼ˆ Bounded Vontextï¼‰ã€å®ä½“ï¼ˆEntityï¼‰ã€å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰ã€èšåˆï¼ˆAggregateï¼‰ã€èšåˆæ ¹ï¼ˆ Aggregate Rootï¼‰ç­‰ç­‰ã€‚æˆ‘ä»¬éœ€è¦å¯¹è¿™äº›æ¦‚å¿µæœ‰æ·±å…¥çš„ç†è§£ï¼Œæ‰èƒ½å¤Ÿåœ¨ä¸åŒçš„åº”ç”¨åœºæ™¯ä¸­çµæ´»åœ°ä½¿ç”¨DDDè¿›è¡Œè®¾è®¡ã€‚

### å…­è¾¹å½¢æ¶æ„

DDDæ˜¯ä¸€ç§è½¯ä»¶å¼€å‘æ–¹æ³•è®ºï¼Œå®è·µä¸­æ¯”è¾ƒæµè¡Œçš„åšæ³•æ˜¯å°†DDDä¸å…­è¾¹å½¢æ¶æ„ï¼ˆHexagonalï¼‰ç»“åˆèµ·æ¥ï¼Œç”¨DDDæ¥æŒ‡å¯¼å…­è¾¹å½¢æ¶æ„çš„è®¾è®¡ã€‚é‚£ä»€ä¹ˆæ˜¯å…­è¾¹å½¢æ¶æ„å‘¢ï¼Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ**è¿™æ˜¯ä¸€ç§ç”±å†…è€Œå¤–çš„åˆ†å±‚æ¶æ„ï¼Œæ¯ä¸€å±‚éƒ½æœ‰ç‰¹å®šçš„èŒè´£ï¼Œå¹¶ä¸å…¶ä»–å±‚çº§è¿›è¡Œéš”ç¦»ã€‚**

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/25/dc/2530b1d15f06a0f0ce382891e502b9dc.jpg?wh=1920x1407)

å…­è¾¹å½¢æ¶æ„çš„æœ€å†…å±‚å³ä¸ºæ ¸å¿ƒçš„é¢†åŸŸæ¨¡å‹ï¼ˆDomain Modelï¼‰ï¼Œå®ƒå®šä¹‰åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„å®ä½“å’Œå…³ç³»ã€‚åº”ç”¨å±‚ï¼ˆApplicationï¼‰ä¾èµ–å†…å±‚çš„é¢†åŸŸæ¨¡å‹ï¼Œè´Ÿè´£å®ç°åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œä¾‹å¦‚éªŒè¯ç”¨æˆ·è¾“å…¥çš„æ•°æ®å¹¶å¤„ç†è¿™äº›æ•°æ®ã€‚

è€Œå¤–å±‚çš„é€‚é…å™¨ç”¨äºæ¥æ”¶ä¸åŒå½¢å¼çš„è¾“å…¥ä¸è¾“å‡ºã€‚ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥æœ‰HTTPæˆ–è€…GRPCç­‰å¤šç§é€‚é…å™¨æ¥æ¥æ”¶ä¸åŒçš„å¤–éƒ¨è¾“å…¥ï¼Œä½†æ˜¯å®ƒä»¬æœ€ç»ˆä¼šç”±ç›¸åŒçš„å†…éƒ¨å¤„ç†é€»è¾‘æ¥å¤„ç†ã€‚ä¸åŒå½¢å¼çš„è¾“å‡ºåŒ…æ‹¬äº†æœåŠ¡æ³¨å†Œã€å°†æ•°æ®å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€æŒä¹…åŒ–å­˜å‚¨ç­‰ã€‚è€Œæ¯ä¸€ç§è¾“å‡ºå½¢å¼éƒ½å¯èƒ½æœ‰å¤šä¸ªé€‚é…å™¨ï¼Œä¾‹å¦‚ï¼ŒæŒä¹…åŒ–å­˜å‚¨å¯ä»¥æœ‰å¤šç§å½¢å¼çš„é€‚é…å™¨ï¼Œæ§åˆ¶æŠŠæ•°æ®å­˜å‚¨åˆ°MySQLã€MongoDBè¿˜æ˜¯å†…å­˜ä¸­ã€‚è¿™æ ·ï¼Œç¨‹åºå°±æœ‰äº†æ¯”è¾ƒå¼ºçš„æ‰©å±•æ€§ï¼Œä¹Ÿæ–¹ä¾¿è¿›è¡ŒMockæµ‹è¯•ã€‚

åˆ°è¿™é‡Œä½ å¯èƒ½ä¼šé—®ï¼ŒDDDæŒ‡å¯¼å…­è¾¹å½¢æ¶æ„ä¸ºä»€ä¹ˆèƒ½å¤Ÿè§£å†³æˆ‘ä»¬ä¹‹å‰é¢ä¸´çš„é—®é¢˜å‘¢ï¼Ÿ

é¦–å…ˆï¼Œç°åœ¨åŒä¸€ä¸ªé¢†åŸŸä¸­çš„ç›¸å…³ç»“æ„ï¼ˆå®ä½“ã€å€¼å¯¹è±¡ï¼‰ç­‰éƒ½èšåˆåœ¨åŒä¸€ä¸ªpackageä¸­ã€‚ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥æŠŠçˆ¬è™«é¢†åŸŸçš„ç›¸å…³ä»£ç æ”¾ç½®åˆ°åä¸ºspiderçš„packageä¸­ï¼Œç°åœ¨è¦å¼•ç”¨è¯¥é¢†åŸŸä¸­çš„ç»“æ„å°±å˜ä¸ºäº† `spider.Task,spider.Request`ï¼Œè¿™å°±é¿å…äº†å‘½åé—®é¢˜ã€‚

åŒæ—¶ï¼Œè¯¥æ¶æ„è¿˜èƒ½å¤Ÿè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ã€‚å› ä¸ºåœ¨å…­è¾¹å½¢æ¶æ„ä¸­ï¼Œå¤–å±‚å¯ä»¥ä¾èµ–å†…å±‚çš„ç»“æ„ï¼Œä½†æ˜¯å†…å±‚ä¸èƒ½å¤Ÿä¾èµ–å¤–å±‚çš„ç»“æ„ï¼Œè¿™ä¿è¯äº†ä¾èµ–å…³ç³»çš„å•å‘æ€§ã€‚å±‚çº§ä¹‹é—´ä¸€èˆ¬æ˜¯é€šè¿‡Goæ¥å£æ¥äº¤æµçš„ï¼Œè¿™ä¸ä»…æé«˜äº†æ‰©å±•æ€§ï¼Œä¹Ÿå®ç°äº†ä¿¡æ¯çš„éšè—ã€‚

ä¸‹é¢å°±è®©æˆ‘ä»¬è¯•ç€ç”¨å…­è¾¹å½¢æ¶æ„é‡æ„ä¸€ä¸‹æˆ‘ä»¬çš„çˆ¬è™«ç³»ç»Ÿï¼Œä¸è¿‡åœ¨è¿™ä¹‹å‰ï¼Œæˆ‘è¿˜éœ€è¦ç®€å•è§£é‡Šä¸€ä¸‹DDDçš„æœ¯è¯­ã€‚

### é¢†åŸŸä¸å­åŸŸ

**é¢†åŸŸæŒ‡çš„æ˜¯ä»äº‹ä¸€ç§ä¸“é—¨æ´»åŠ¨æˆ–äº‹ä¸šçš„èŒƒå›´ã€‚**åœ¨DDDä¸­ï¼Œé¢†åŸŸå¯ä»¥æŒ‡ä¸šåŠ¡çš„æ•´ä¸ªèŒƒå›´ã€‚è€Œä¸šåŠ¡çš„æ•´ä¸ªèŒƒå›´åˆå¯ä»¥åˆ’åˆ†ä¸ºå¤šä¸ªå­é¢†åŸŸï¼Œæ ¸å¿ƒçš„å­é¢†åŸŸå¯ä»¥è¢«å«åšæ ¸å¿ƒåŸŸï¼Œæ ¸å¿ƒåŸŸæ˜¯ä¸šåŠ¡æˆåŠŸçš„å…³é”®ï¼Œæ˜¯å…¬å¸çš„æ ¸å¿ƒç«äº‰åŠ›ï¼Œä¹Ÿæ˜¯éœ€è¦é‡ç‚¹å…³æ³¨çš„é¢†åŸŸã€‚

è¢«å¤šä¸ªå­åŸŸä½¿ç”¨çš„é€šç”¨åŠŸèƒ½å­åŸŸå«åšé€šç”¨åŸŸï¼Œè€Œä¸æ˜¯æ ¸å¿ƒåŠŸèƒ½ä¹Ÿä¸æ˜¯é€šç”¨åŠŸèƒ½çš„é¢†åŸŸè¢«å«åšæ”¯æ’‘åŸŸï¼Œå­åŸŸè¿˜å¯ä»¥ç»†åˆ†ä¸ºæ›´å°çš„é—®é¢˜åŸŸã€‚

### ![å›¾ç‰‡](https://static001.geekbang.org/resource/image/c6/a7/c69107fd4f88870568255d56fd2004a7.jpg?wh=1920x1407)

### é™ç•Œä¸Šä¸‹æ–‡

å¦‚æœæˆ‘ä»¬çš„é¢†åŸŸåˆ’åˆ†å¾—è¶³å¤Ÿå¥½ï¼Œä¼šå‘ç°æŸäº›å­åŸŸä¹‹é—´å½¢æˆäº†å¤©ç„¶çš„è¾¹ç•Œï¼Œ**é™å®šåœ¨è¾¹ç•Œä¸­çš„ä¸Šä¸‹æ–‡è¢«ç§°ä¸ºé™ç•Œä¸Šä¸‹æ–‡ï¼ˆ Bounded contextï¼‰ã€‚**åœ¨é™ç•Œä¸Šä¸‹æ–‡ä¸­ï¼Œä¸šåŠ¡äººå‘˜å’Œå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨æ— æ­§ä¹‰çš„ç»Ÿä¸€è¯­è¨€æ¥å¯¹è¯ã€‚

ä¸¾ä¸€ä¸ªä¾‹å­ä½ å°±æ˜ç™½äº†ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡åœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå®ƒçš„å«ä¹‰ä¼šæœ‰å˜åŒ–ã€‚åœ¨Workerè¿›è¡Œç½‘ç«™é‡‡é›†çš„æ—¶å€™ï¼Œä»»åŠ¡æŒ‡çš„æ˜¯åŒ…å«äº†æŒ‡å®šè§„åˆ™çš„æè¿°çˆ¬è™«ä»»åŠ¡çš„å®ä¾‹ã€‚è€Œåœ¨Masteræ·»åŠ ä»»åŠ¡æ—¶ï¼Œä»»åŠ¡åªæ˜¯ä¸€ä¸ªèƒ½å¤Ÿå”¯ä¸€ç”¨åå­—æ ‡è¯†çš„èµ„æºã€‚å†ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œä¸€ä¸ªåˆ°é…’å§ä¹°é†‰çš„äººï¼Œåœ¨å¤–äººçš„çœ¼ä¸­å°±æ˜¯é…’é¬¼ï¼Œè€Œåœ¨é…’å§è€æ¿çš„çœ¼ä¸­ä»–å…¶å®æ˜¯ä¸€ä¸ªé¡¾å®¢ã€‚

æ‰€ä»¥ï¼Œç›¸åŒçš„äº‹ç‰©åœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡å½“ä¸­å…·æœ‰ä¸åŒçš„å†…æ¶µå’Œå¤–å»¶ã€‚é™ç•Œä¸Šä¸‹æ–‡å°†äº‹ç‰©é™åˆ¶åœ¨ä¸€å®šçš„ä¸Šä¸‹æ–‡å½“ä¸­è¿›è¡Œè®¨è®ºï¼Œè¿™å¯ä»¥è®©ä»£ç æ›´çœŸå®åœ°åæ˜ ä¸šåŠ¡ï¼Œè®©å¼€å‘äººå‘˜ä¸ä¸šåŠ¡äººå‘˜æœ‰å…±åŒçš„è¯­è¨€ã€‚åŒæ—¶ï¼Œé™ç•Œä¸Šä¸‹æ–‡çš„è¾¹ç•Œé€šå¸¸è¿˜æ˜¯è¿›è¡Œå¾®æœåŠ¡æ‹†åˆ†çš„åŸºç¡€ã€‚

æˆ‘ä»¬å½“å‰é¡¹ç›®çš„æ ¸å¿ƒå°±æ˜¯å¼€å‘çš„çˆ¬è™«ç³»ç»Ÿï¼Œæ ¸å¿ƒåŸŸæ˜¯çˆ¬è™«åŸŸã€‚æˆ‘ä»¬å°†çˆ¬è™«åŸŸçš„ç›¸å…³ä»£ç æ”¾ç½®åˆ°spider packageä¸­ï¼Œå¹¶å¼€å§‹åœ¨çˆ¬è™«åŸŸçš„é™ç•Œä¸Šä¸‹æ–‡ä¸­æ„å»ºä¸šåŠ¡æ¨¡å‹ã€‚æœ€ç»ˆæˆ‘ä»¬ä¼šæ„å»ºå‡ºå®ä½“ã€å€¼å¯¹è±¡ã€èšåˆç­‰å¯¹è±¡ã€‚è®©æˆ‘ä»¬æŒ¨ä¸ªæ¥çœ‹ä¸€çœ‹ã€‚

### å®ä½“

é¦–å…ˆæˆ‘ä»¬æ¥æ„å»ºå®ä½“ã€‚

**DDDä¸­çš„å®ä½“æ˜¯åœ¨ç›¸åŒé™ç•Œä¸Šä¸‹æ–‡ä¸­å…·æœ‰å”¯ä¸€æ ‡è¯†çš„é¢†åŸŸæ¨¡å‹ï¼Œå®ƒå†…éƒ¨çš„å±æ€§å¯èƒ½å‘ç”Ÿå˜åŒ–ã€‚**åœ¨çˆ¬è™«åŸŸä¸­ï¼Œä¸€ä¸ªçˆ¬è™«çš„è¯·æ±‚ä»¥åŠä¸€ä¸ªçˆ¬è™«ä»»åŠ¡å¯ä»¥ä½œä¸ºä¸€ä¸ªå®ä½“ï¼Œæˆ‘ä»¬å°†å…¶æŠ½è±¡ä¸ºRequestç»“æ„ä½“å’ŒTaskç»“æ„ä½“ã€‚ResourceSpecç»“æ„ä½“ä¹Ÿå¯ä»¥ä½œä¸ºä¸€ä¸ªå®ä½“ï¼Œå®ƒå¯ä»¥æè¿°è°ƒåº¦çš„èµ„æºå¯¹è±¡ï¼Œä½†æ˜¯å¦è¦æŠŠå®ƒæ”¾å…¥åˆ°çˆ¬è™«åŸŸä¸­æ˜¯å€¼å¾—æ¨æ•²çš„ï¼Œæˆ‘ä»¬ä¹Ÿè®¸å¯ä»¥å•ç‹¬å°†å…¶æ”¾å…¥åˆ°å«åšè°ƒåº¦åŸŸçš„é¢†åŸŸä¸­ã€‚

å¯¹å®ä½“è¿›è¡Œå»ºæ¨¡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡å–å¤´è„‘é£æš´çš„æ–¹å¼ï¼Œç”±å¼€å‘äººå‘˜ä¸ä¸šåŠ¡äººå‘˜åå¤æ€è€ƒã€æ¨æ•²ä¸è¿­ä»£ï¼Œæœ€åæ ¹æ®å…·ä½“çš„åœºæ™¯æ„å»ºæ¯”è¾ƒåˆé€‚çš„ä¸šåŠ¡æ¨¡å‹ã€‚

```plain
package spider

type Request struct {
	Task     *Task
	URL      string
	Method   string
	Depth    int64
	Priority int64
	RuleName string
	TmpData  *Temp
}

// è¯·æ±‚å”¯ä¸€æ ‡è¯†
func (r *Request) Unique() string {
	block := md5.Sum([]byte(r.URL + r.Method))
	return hex.EncodeToString(block[:])
}

func (r *Request) Check() error {
	if r.Depth > r.Task.MaxDepth {
		return errors.New("max depth limit reached")
	}

	if r.Task.Closed {
		return errors.New("task has Closed")
	}

	return nil
}

type Task struct {
	Visited     map[string]bool
	VisitedLock sync.Mutex
	//
	Closed bool
	Rule RuleTree
	Options
}

type ResourceSpec struct {
	ID           string
	Name         string
	AssignedNode string
	CreationTime int64
}
```

é™¤äº†æ·»åŠ å¯¹åº”å®ä½“çš„ç»“æ„ä½“ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ·»åŠ å®ä½“çš„æ–¹æ³•ï¼Œç”¨å®ƒæ¥å¤„ç†ä¸å®ä½“ç›¸å…³çš„ä¸šåŠ¡è¡Œä¸ºã€‚ä¾‹å¦‚ï¼ŒRequest.Checkæ–¹æ³•å¯ä»¥æ£€æŸ¥è¯·æ±‚çš„æœ‰æ•ˆæ€§ã€‚è¿™äº›æ–¹æ³•æˆ‘ä¹‹å‰ä¹Ÿå·²ç»å¼€å‘å¥½äº†ï¼Œåªæ˜¯è¿ç§»åˆ°äº†æŒ‡å®šçš„ç›®å½•ä¸­ï¼Œè¿™é‡Œæˆ‘å°±ä¸ä¸€ä¸€åˆ—å‡ºäº†ã€‚

### å€¼å¯¹è±¡

è¯´å®Œå®ä½“ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å€¼å¯¹è±¡ã€‚**å€¼å¯¹è±¡æ˜¯ä¸€ç§ç‰¹æ®Šçš„é¢†åŸŸæ¨¡å‹ï¼Œå®ƒå†…éƒ¨çš„å€¼æ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡å€¼åˆ¤æ–­åŒä¸€æ€§ã€‚**ä¾‹å¦‚ï¼ŒRequestç»“æ„ä½“ä¸­çš„ URL å­—æ®µä¸ Method å­—æ®µéƒ½æ˜¯ä¸€ä¸ªå€¼å¯¹è±¡ï¼Œå®ƒæè¿°äº†å®ä½“çš„ä¸€ç§å±æ€§ã€‚

è¦æ³¨æ„çš„æ˜¯ï¼Œå€¼å¯¹è±¡ä¸ä¸€å®šåªæ˜¯å­—ç¬¦ä¸²ã€æ•´æ•°è¿™æ ·çš„åŸºç¡€ç±»å‹ï¼Œå®ƒè¿˜å¯èƒ½æ˜¯ä¸€ä¸ªç»“æ„ä½“ã€‚å…³é”®åœ¨äºæˆ‘ä»¬éœ€è¦æŠŠå€¼å¯¹è±¡çœ‹åšä¸€ä¸ªæ•´ä½“ï¼Œå½“æˆ‘ä»¬éœ€è¦æ›¿æ¢å®ä½“ä¸­çš„å€¼å¯¹è±¡æ—¶ï¼Œéœ€è¦æŠŠå€¼å¯¹è±¡çš„æ•´ä½“éƒ½åŠ ä»¥æ›¿æ¢ã€‚æ‰€ä»¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠçˆ¬è™«è§„åˆ™æ ‘RuleTreeçœ‹åšä¸€ä¸ªå€¼å¯¹è±¡ï¼Œå› ä¸ºRuleTreeæ˜¯Taskçš„ä¸€ä¸ªå±æ€§ï¼Œå¹¶ä¸”ä¸èƒ½å•ç‹¬è¢«ä¿®æ”¹ã€‚

```plain
type RuleTree struct {
	Root  func() ([]*Request, error) // æ ¹èŠ‚ç‚¹(æ‰§è¡Œå…¥å£)
	Trunk map[string]*Rule           // è§„åˆ™å“ˆå¸Œè¡¨
}
```

### èšåˆ

æ¥ç€æˆ‘ä»¬æ¥çœ‹çœ‹èšåˆã€‚

**èšåˆæ˜¯ä¸€ç»„ç”Ÿå‘½å‘¨æœŸå¼ºä¸€è‡´ï¼ŒåŒæ—¶ä¿®æ”¹è§„åˆ™å¼ºå…³è”çš„å®ä½“å’Œå€¼å¯¹è±¡çš„é›†åˆï¼Œå®ƒè¡¨è¾¾çš„æ˜¯ç»Ÿä¸€çš„ä¸šåŠ¡æ„ä¹‰ã€‚**æ¯”å¦‚ï¼Œä¸€ä¸ªè®¢å•ä¸­æœ‰å¤šä¸ªè®¢å•é¡¹ï¼Œè®¢å•çš„æ€»ä»·æ˜¯æ ¹æ®è®¢å•é¡¹ç›®è®¡ç®—è€Œæ¥çš„ã€‚ç”±äºè¿™äº›è®¢å•é¡¹å’Œè®¢å•æ€»ä»·æ˜¯å¯†ä¸å¯åˆ†çš„ï¼Œå› æ­¤å¯ä»¥æŠŠå®ƒä»¬ç»„åˆèµ·æ¥ä½œä¸ºä¸€ä¸ªèšåˆã€‚

åœ¨æˆ‘ä»¬çš„çˆ¬è™«é¡¹ç›®ä¸­ï¼Œç”¨äºå­˜å‚¨çˆ¬è™«ä»»åŠ¡çš„å…¨å±€å˜é‡taskStoreå°±å¯ä»¥çœ‹ä½œä¸€ä¸ªèšåˆï¼Œè€Œæè¿°çˆ¬è™«å­˜å‚¨å•å…ƒçš„DataCellå’Œä¸Šä¸‹æ–‡Contextä¹Ÿæ˜¯ä¸€ä¸ªèšåˆã€‚èšåˆå’Œå®ä½“ä¸€æ ·å¯ä»¥æœ‰å¯¹åº”çš„æ–¹æ³•æ¥æè¿°ä¸šåŠ¡è¡Œä¸ºã€‚

```plain
type taskStore struct {
	List []*Task
	Hash map[string]*Task
}

type Context struct {
	Body []byte
	Req  *Request
}

type DataCell struct {
	Task *Task
	Data map[string]interface{}
}

func (d *DataCell) GetTableName() string {
	return d.Data["Task"].(string)
}

func (d *DataCell) GetTaskName() string {
	return d.Data["Task"].(string)
}
```

### **æœåŠ¡**

ä¸Šé¢æˆ‘ä»¬æ„å»ºäº†çˆ¬è™«åŸŸä¸­çš„å®ä½“ã€å€¼å¯¹è±¡ã€èšåˆä»¥åŠè¿™äº›å¯¹è±¡å¯¹åº”çš„æ–¹æ³•ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰çš„æ“ä½œéƒ½é€‚åˆæ”¾åœ¨è¿™äº›å¯¹è±¡çš„æ–¹æ³•ä¸­ã€‚ä¾‹å¦‚ï¼Œçˆ¬å–ç½‘ç«™æ•°æ®çš„è¡Œä¸ºå°±ä¸é€‚åˆæ”¾åœ¨spider.Requestçš„æ–¹æ³•ä¸­ï¼Œå› ä¸ºçˆ¬å–ç½‘ç«™æ•°æ®å±äºå¯¹spider.Requestçš„æ“ä½œï¼Œè€Œä¸æ˜¯spider.Requestå…·æœ‰çš„è¡Œä¸ºã€‚

å¦å¤–ï¼Œæˆ‘ä»¬è¿˜å¸Œæœ›èƒ½å¤Ÿçµæ´»åœ°ä½¿ç”¨ä¸åŒçš„é‡‡é›†æ–¹å¼ï¼Œä¾‹å¦‚ç›´æ¥è®¿é—®ã€ä»£ç†è®¿é—®æˆ–è€…æ¨¡æ‹Ÿæµè§ˆå™¨è®¿é—®ã€‚å› æ­¤æˆ‘ä»¬è¿˜éœ€è¦æ„å»ºä¸€ä¸ªDDDä¸­é‡è¦çš„å¯¹è±¡ï¼šæœåŠ¡ï¼ˆServiceï¼‰ã€‚**æœåŠ¡æ˜¯é¢†åŸŸæ¨¡å‹çš„æ“ä½œè€…ï¼Œè´Ÿè´£é¢†åŸŸå†…ä¸šåŠ¡è§„åˆ™çš„å®ç°ã€‚**

æœåŠ¡çš„ç»“æ„ä½“ä¸­ä¸€èˆ¬ä¸åµŒå¥—å…·ä½“çš„å®ä½“ã€å€¼å¯¹è±¡å’Œèšåˆï¼Œä½†æ˜¯ä¼šåœ¨æ–¹æ³•ä¸­ä¸²è”ä¸šåŠ¡é€»è¾‘ã€‚åŒæ—¶ï¼ŒæœåŠ¡ä¸€èˆ¬ä¼šæŠ½è±¡å‡ºæ¥å£ï¼Œè¿™æ ·å…¶ä»–çš„æœåŠ¡æˆ–è€…å¯¹è±¡å°±å¯ä»¥é€šè¿‡ä¾èµ–æ¥å£ä½¿ç”¨æœåŠ¡çš„æ–¹æ³•ï¼Œè€Œä¸ç”¨ç®¡æœåŠ¡å…·ä½“çš„å®ç°äº†ã€‚æˆ‘ä»¬å°†çˆ¬å–ç½‘ç«™æ•°æ®çš„è¡Œä¸ºè¿ç§»åˆ°fetchservice.goæ–‡ä»¶ä¸­ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

```plain
package spider

type Fetcher interface {
	Get(url *Request) ([]byte, error)
}

type BaseFetch struct{}

func (BaseFetch) Get(req *Request) ([]byte, error){
	...
}

type BrowserFetch struct {
	Timeout time.Duration
	Proxy   proxy.Func
	Logger  *zap.Logger
}

// æ¨¡æ‹Ÿæµè§ˆå™¨è®¿é—®
func (b BrowserFetch) Get(request *Request) ([]byte, error){
	...
}
```

æ ¹æ®æœåŠ¡çš„å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä¹‹å‰è®¾è®¡ä¸å¤ªåˆç†çš„åœ°æ–¹ã€‚ä¾‹å¦‚ï¼ŒBrowserFetchåŒ…å«äº†Timeoutä¸Proxyå­—æ®µç”¨äºä¿å­˜è¯·æ±‚ç›¸å…³å±æ€§ã€‚å…¶å®ï¼Œæ§åˆ¶HTTPè¶…æ—¶çš„Timeoutä»¥åŠæ§åˆ¶ä»£ç†çš„Proxyéƒ½å¯ä»¥æ”¾ç½®åˆ°æè¿°çˆ¬è™«ä»»åŠ¡çš„Taskå½“ä¸­ã€‚åŒæ—¶ï¼Œåœ¨serviceæ–‡ä»¶ä¸­ï¼Œä¸€èˆ¬è¿˜éœ€è¦æœ‰ä¸€ä¸ªå‡½æ•°NewXxxServiceæ¥è¿”å›åº”è¯¥ä½¿ç”¨å“ªä¸€ç§æ¥å£çš„å…·ä½“å®ç°ï¼Œåœ¨æˆ‘ä»¬çš„ä»£ç ä¸­å‡½æ•°NewFetchServiceç”¨äºè¿”å›å…·ä½“çš„é‡‡é›†å®ç°ã€‚æ”¹é€ åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

```plain
package spider

type FetchType int

const (
	BaseFetchType FetchType = iota
	BrowserFetchType
)

type Fetcher interface {
	Get(url *Request) ([]byte, error)
}

func NewFetchService(typ FetchType) Fetcher {
	switch typ {
	case BaseFetchType:
		return &baseFetch{}
	case BrowserFetchType:
		return &browserFetch{}
	default:
		return &browserFetch{}
	}
}

type baseFetch struct{}

func (*baseFetch) Get(req *Request) ([]byte, error) {
	...
}

type browserFetch struct{}

// æ¨¡æ‹Ÿæµè§ˆå™¨è®¿é—®
func (b *browserFetch) Get(request *Request) ([]byte, error) {
	...
}
```

åœ¨è¿™æ®µæ”¹é€ åçš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†å…·ä½“å®ç°çš„ç»“æ„ä½“å˜ä¸ºäº†å°å†™ï¼Œå¤–éƒ¨æœåŠ¡æˆ–å¯¹è±¡åªèƒ½å¤Ÿé€šè¿‡æš´éœ²çš„NewFetchServiceæ–¹æ³•ä¸é‡‡é›†æœåŠ¡äº¤äº’ã€‚

### **ä»“å‚¨**

æœåŠ¡æœ¬èº«å¯èƒ½ä¾èµ–å…¶ä»–çš„å¤šä¸ªæœåŠ¡å’Œä»“å‚¨ï¼Œå¹¶å®Œæˆæ›´é«˜ç»´åº¦çš„ä¸šåŠ¡ä¸²è”ï¼Œè¿™æ˜¯æˆ‘ä»¬å®ç°Workeré€»è¾‘çš„åŸºç¡€ã€‚å› ä¸ºæˆ‘ä»¬çš„çˆ¬è™«Workeréœ€è¦å®Œæˆæ¥æ”¶è¯·æ±‚ã€çˆ¬å–ã€å­˜å‚¨ç­‰ä¸šåŠ¡é€»è¾‘ã€‚é‚£é—®é¢˜æ¥äº†ï¼Œä»€ä¹ˆæ˜¯ä»“å‚¨å‘¢ï¼Ÿ

**ä»“å‚¨ï¼ˆRepositoryï¼‰æ˜¯ä»¥æŒä¹…åŒ–é¢†åŸŸæ¨¡å‹ä¸ºèŒè´£çš„å¯¹è±¡ã€‚**ä»“å‚¨çš„ç›®çš„æ˜¯å¢åŠ æŒä¹…åŒ–åŸºç¡€è®¾æ–½çš„å¯æ‰©å±•æ€§ã€‚åœ¨æ ¸å¿ƒåŸŸçš„datarepositoryæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†æŒä¹…åŒ–å­˜å‚¨çš„æ¥å£ã€‚

```plain
package spider

type DataRepository interface {
	Save(datas ...*DataCell) error
}

type DataCell struct {
	Task *Task
	Data map[string]interface{}
}

func (d *DataCell) GetTableName() string {
	return d.Data["Task"].(string)
}

func (d *DataCell) GetTaskName() string {
	return d.Data["Task"].(string)
}
```

DataRepositoryæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¯ä»¥æœ‰å¤šç§å®ç°äº†è¯¥æ¥å£çš„é€‚é…å™¨ï¼Œä½äºå…­è¾¹å½¢æ¶æ„çš„æœ€å¤–å±‚ã€‚å› æ­¤æˆ‘ä»¬çš„æŒä¹…åŒ–å®ç°ä¸èƒ½æ”¾ç½®åˆ°æ ¸å¿ƒåŸŸï¼Œè€Œéœ€è¦æ”¾ç½®åˆ°å¤–å±‚çš„ `sqlstorage` packageä¸­ã€‚

### æœåŠ¡ä¸²è”ä¸šåŠ¡é€»è¾‘

åœ¨å®Œæˆäº†fetch Service å’Œ data Repositoryçš„å»ºæ¨¡ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦æ›´é«˜ç»´åº¦çš„Serviceå®Œæˆå¤æ‚çš„ä¸šåŠ¡é€»è¾‘çš„ä¸²è”ã€‚æˆ‘ä»¬æŠŠä¸šåŠ¡ä¸²è”ä¸è¯·æ±‚è°ƒåº¦ç›¸å…³çš„ä»£ç æ”¾ç½®åˆ°æ ¸å¿ƒåŸŸçš„å­æ–‡ä»¶å¤¹ä¸­ï¼Œå‘½åä¸º `workerengine`ã€‚

ä¹‹å‰æˆ‘ä»¬ä¸²è”ä¸šåŠ¡é€»è¾‘æ—¶ï¼Œæ˜¯åœ¨ Crawler ç»“æ„ä½“çš„æ–¹æ³•ä¸­å®Œæˆçš„ã€‚é‚£æˆ‘ä»¬èƒ½å¤Ÿå¤ç”¨è¿™ä¸ªç»“æ„ä½“å—ï¼Ÿæˆ‘ä»¬ä¹‹å‰çš„Crawlerç»“æ„ä½“ä¸­è¿˜åŒ…å«äº†visitedã€failuresã€resourcesç­‰å­˜å‚¨èµ„æºçš„å®¹å™¨ã€‚

```plain
type Crawler struct {
	id          string
	out         chan spider.ParseResult
	Visited     map[string]bool
	VisitedLock sync.Mutex

	failures    map[string]*spider.Request // å¤±è´¥è¯·æ±‚id -> å¤±è´¥è¯·æ±‚
	failureLock sync.Mutex

	resources map[string]*master.ResourceSpec
	rlock     sync.Mutex

	etcdCli *clientv3.Client
	options
}
```

ä½†æ˜¯è¿™å¹¶ä¸ç¬¦åˆServiceçš„å®šä¹‰ã€‚Serviceåº”è¯¥åªè´Ÿè´£è°ƒåº¦ï¼Œä¸å…·æœ‰å­˜å‚¨ç­‰é€»è¾‘ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°æ€è€ƒä¸€ä¸‹è®¾è®¡æ–¹æ³•ã€‚æˆ‘ä»¬æŠ½è±¡å‡ºä¸¤ä¸ªRepositoryï¼Œå…¶ä¸­ReqHistoryRepositoryç”¨äºä¿å­˜Requestçš„å†å²è®°å½•ï¼Œä¿å­˜è®¿é—®è¿‡çš„ç½‘å€æˆ–è€…å¤±è´¥çš„ç½‘å€ã€‚

```plain
type ReqHistoryRepository interface {
	AddVisited(reqs ...*Request)
	DeleteVisited(req *Request)
	AddFailures(req *Request) bool
	DeleteFailures(req *Request)
	HasVisited(req *Request) bool
}

type reqHistory struct {
	Visited     map[string]bool
	VisitedLock sync.Mutex

	failures    map[string]*Request // å¤±è´¥è¯·æ±‚id -> å¤±è´¥è¯·æ±‚
	failureLock sync.Mutex
}
```

ResourceRepositoryç”¨äºå­˜å‚¨èµ„æºï¼ŒResourceæ˜¯æˆ‘ä»¬ç”¨äºè°ƒåº¦çš„å®ä¾‹ã€‚

```plain
type ResourceRepository interface {
	Set(req map[string]*ResourceSpec)
	Add(req *ResourceSpec)
	Delete(name string)
	HasResource(name string) bool
}

type resourceRepository struct {
	resources map[string]*ResourceSpec
	rlock     sync.Mutex
}
```

WorkerService æ˜¯æˆ‘ä»¬å¯¹ Worker æœåŠ¡çš„æŠ½è±¡ï¼Œè€ŒworkerServiceæ˜¯å…·ä½“çš„å®ç°ã€‚ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒworkerServiceå¤§é‡åœ°ä¾èµ–äº†å¤–éƒ¨çš„æœåŠ¡ä¾‹å¦‚spider.Fetcherã€Schedulerï¼›ä¹Ÿä¾èµ–äº†å¤–éƒ¨çš„Repositoryï¼Œä¾‹å¦‚spider.DataRepositoryã€spider.ReqHistoryRepositoryã€spider.ResourceRepositoryã€‚

```plain

type WorkerService interface {
	Run(cluster bool)
	LoadResource() error
	WatchResource()
}

type workerService struct {
	out     chan spider.ParseResult
	rlock   sync.Mutex
	etcdCli *clientv3.Client
	options
}

type options struct {
	Fetcher            spider.Fetcher
	Storage            spider.DataRepository
	Logger             *zap.Logger
	scheduler          Scheduler
	reqRepository      spider.ReqHistoryRepository
	resourceRepository spider.ResourceRepository
}

func (c *workerService) Run(cluster bool) {
	if !cluster {
		c.handleSeeds()
	}
	c.LoadResource()
	go c.WatchResource()
	go c.scheduler.Schedule()
	for i := 0; i < c.WorkCount; i++ {
		go c.CreateWork()
	}
	c.HandleResult()
}

func (c *workerService) CreateWork() {
	...
	for {
		// è°ƒåº¦å™¨ä¸­è·å–è¯·æ±‚
		req := c.scheduler.Pull()
		
		// æ£€æŸ¥
		if err := req.Check(); err != nil {
			c.Logger.Debug("check failed",
				zap.Error(err),
			)
			continue
		}
		if !req.Task.Reload && c.reqRepository.HasVisited(req) {
			c.Logger.Debug("request has visited",
				zap.String("url:", req.URL),
			)
			continue
		}
		
    // è¯·æ±‚æ”¾å…¥reqRepository
		c.reqRepository.AddVisited(req)
		
		// çˆ¬å–è¯·æ±‚
		body, err := req.Task.Fetcher.Get(req)
		rule := req.Task.Rule.Trunk[req.RuleName]
		ctx := &spider.Context{
			Body: body,
			Req:  req,
		}

		// è§„åˆ™è§£æ
		result, err := rule.ParseFunc(ctx)
		if err != nil {
			c.Logger.Error("ParseFunc failed ",
				zap.Error(err),
				zap.String("url", req.URL),
			)
			continue
		}
		
		// è¯·æ±‚æ”¾å…¥è°ƒåº¦å™¨ä¸­
		if len(result.Requesrts) > 0 {
			go c.scheduler.Push(result.Requesrts...)
		}
		
    // æ•°æ®å­˜å‚¨
		c.out <- result
	}
}
```

å®é™…ä¸Šï¼ŒworkerServiceè¿˜å¯ä»¥è¢«è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚å› ä¸ºæˆ‘ä»¬è¿™é‡Œæ˜¯ä¾èµ–etcd clientå®ç°èµ„æºçš„ç›‘å¬ä¸åŠ è½½ï¼Œä½†æ˜¯æˆ‘ä»¬å¾ˆå®¹æ˜“å†æŠ½è±¡å‡ºä¸€ä¸ªé€‚é…å™¨æ¥å¯¹æ¥ä¸åŒçš„æ³¨å†Œä¸­å¿ƒï¼Œæ‰€ä»¥æˆ‘å°†ä¸æ³¨å†Œä¸­å¿ƒç›¸å…³çš„ä»£ç æ”¾ç½®åˆ°äº†resourceregistry.go ä¸­ã€‚

å…¶å®å°† ResourceRegistry æ¥å£çš„å…·ä½“å®ç°æ”¾ç½®åˆ°å¤–å±‚çš„packageä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå¯ä»¥æŠŠå®ƒä½œä¸ºå…­è¾¹å½¢æ¶æ„çš„æœ€å¤–å±‚ã€‚

```plain
type EventType int

const (
	EventTypeDelete EventType = iota
	EventTypePut

	RESOURCEPATH = "/resources"
)

type ResourceRegistry interface {
	GetResources() ([]*ResourceSpec, error)
	WatchResources() WatchChan
}

type WatchResponse struct {
	Typ      EventType
	Res      *ResourceSpec
	Canceled bool
}

type WatchChan chan WatchResponse

type EtcdRegistry struct {
	etcdCli *clientv3.Client
}

func NewEtcdRegistry(endpoints []string) (ResourceRegistry, error) {
	cli, err := clientv3.New(clientv3.Config{Endpoints: endpoints})
	return &EtcdRegistry{cli}, err
}

func (e *EtcdRegistry) GetResources() ([]*ResourceSpec, error) {
	resp, err := e.etcdCli.Get(context.Background(), RESOURCEPATH, clientv3.WithPrefix(), clientv3.WithSerializable())
	if err != nil {
		return nil, err
	}
	resources := make([]*ResourceSpec, 0)
	for _, kv := range resp.Kvs {
		r, err := Decode(kv.Value)
		if err == nil && r != nil {
			resources = append(resources, r)
		}
	}
	return resources, nil
}

func (e *EtcdRegistry) WatchResources() WatchChan {
	ch := make(WatchChan)
	go func() {
			...
	}()

	return ch

}
```

æœ€åï¼Œæˆ‘ä»¬å°†æ‰€æœ‰çš„ä¾èµ–çš„æ˜¾å¼çš„æ³¨å…¥åˆ°mainå‡½æ•°ä¸­ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é¡¹ç›®ä¸­çš„cmd/worker.goæ–‡ä»¶çš„Runå‡½æ•°ä¸­ã€‚

```plain
func Run() {
	 ...
	// init log
	logText := cfg.Get("logLevel").String("INFO")
	logLevel, err := zapcore.ParseLevel(logText)
	if err != nil {
		panic(err)
	}
	plugin := log.NewStdoutPlugin(logLevel)
	logger = log.NewLogger(plugin)

	// init fetcher
	proxyURLs := cfg.Get("fetcher", "proxy").StringSlice([]string{})
	timeout := cfg.Get("fetcher", "timeout").Int(5000)
	logger.Sugar().Info("proxy list: ", proxyURLs, " timeout: ", timeout)
	if p, err = proxy.RoundRobinProxySwitcher(proxyURLs...); err != nil {
		logger.Error("RoundRobinProxySwitcher failed", zap.Error(err))
	}
	f := spider.NewFetchService(spider.BrowserFetchType)

	// init storage
	sqlURL := cfg.Get("storage", "sqlURL").String("")
	if storage, err = sqlstorage.New(
		sqlstorage.WithSQLURL(sqlURL),
		sqlstorage.WithLogger(logger.Named("sqlDB")),
		sqlstorage.WithBatchCount(2),
	); err != nil {
		logger.Error("create sqlstorage failed", zap.Error(err))
		panic(err)
		return
	}

	// init etcd registry
	reg, err := spider.NewEtcdRegistry([]string{sconfig.RegistryAddress})
	if err != nil {
		logger.Error("init EtcdRegistry failed", zap.Error(err))
	}

	s, err := engine.NewWorkerService(
		engine.WithFetcher(f),
		engine.WithLogger(logger),
		engine.WithWorkCount(5),
		engine.WithSeeds(seeds),
		engine.WithScheduler(engine.NewSchedule()),
		engine.WithStorage(storage),
		engine.WithID(id),
		engine.WithReqRepository(spider.NewReqHistoryRepository()),
		engine.WithResourceRepository(spider.NewResourceRepository()),
		engine.WithResourceRegistry(reg),
	)

	if err != nil {
		panic(err)
	}

	// worker start
	go s.Run(cluster)
}
```

è‡³æ­¤ï¼Œæˆ‘ä»¬å°±åŸºäºDDDå®ç°äº†çˆ¬è™«Workerçš„ä»£ç é‡æ„ï¼Œè™½ç„¶è¿™é‡Œä»ç„¶æœ‰è®¸å¤šå€¼å¾—æ¨æ•²ä¸ä¼˜åŒ–çš„åœ°æ–¹ï¼Œä½†ç°åœ¨ä»£ç ç¡®å®å˜å¾—æ›´åŠ æ¸…æ™°å’Œä¼˜é›…äº†ï¼Œæ‰©å±•æ€§ä¹Ÿæ›´å¼ºäº†ã€‚ç›¸å…³çš„ä»£ç æˆ‘æ”¾ç½®åˆ°äº†[v0.4.3 åˆ†æ”¯](https://github.com/dreamerjackson/crawler/tree/v0.4.3)ï¼Œä½ å¯ä»¥å¯¹ç…§å­¦ä¹ ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šï¼Œå°è¯•ç€å°†Masterä¹Ÿé‡æ„ä¸€ä¸‹ï¼Œç›¸ä¿¡é‡æ„çš„è¿‡ç¨‹ä¸€å®šä¼šéå¸¸æœ‰è¶£ã€‚

## æ€»ç»“

åœ¨Goè¯­è¨€ä¸­ï¼Œå¹¶æ²¡æœ‰ä¸€ç§ä»£ç ç»„ç»‡æ–¹å¼é€‚ç”¨äºæ‰€æœ‰çš„åº”ç”¨åœºæ™¯ã€‚è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬æ€»ç»“äº†æŒ‰ç…§å•ä½“ã€å±‚æ¬¡ã€æˆ–è€…åŠŸèƒ½æ¥ç»„ç»‡ä»£ç ä¼šé¢ä¸´çš„å›°éš¾ï¼Œå¹¶æœ€ç»ˆæ¢ç´¢å‡ºäº†ä½¿ç”¨é¢†åŸŸé©±åŠ¨è®¾è®¡å’Œå…­è¾¹å½¢æ¶æ„è¿™æ¡è·¯ã€‚å®ƒå¯ä»¥è§£å†³å‘½åå’Œå¾ªç¯ä¾èµ–é—®é¢˜ï¼Œä½¿æˆ‘ä»¬çš„ç¨‹åºå…·å¤‡æå¼ºçš„æ‰©å±•æ€§ã€‚

é¢†åŸŸé©±åŠ¨è®¾è®¡å…·æœ‰è¾ƒé™¡å³­çš„å­¦ä¹ æ›²çº¿ï¼Œä¸”éœ€è¦ä¸æ–­åœ°è¿­ä»£ä¸šåŠ¡ä¸é¢†åŸŸå»ºæ¨¡ã€‚ç›¸ä¿¡ä½ èƒ½å¤Ÿåœ¨ç†è®ºä¸å®è·µä¸­æ„Ÿå—åˆ°é¢†åŸŸé©±åŠ¨è®¾è®¡çš„å¥½å¤„ï¼Œæ”¹å–„è‡ªå·±çš„ä»£ç ï¼Œè®©ç¼–ç¨‹æ›´åŠ é«˜æ•ˆã€æœ‰è¶£ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ1ï¼‰</strong></div><ul>
<li><span>Realm</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ–‡ç« ä¸­æä¾›æœ¬é¡¹ç›®çš„ç³»ç»Ÿæ¶æ„å›¾ï¼Œä»¥åŠå„æ¨¡å—ä¹‹é—´çš„é€»è¾‘å…³è”å›¾ï¼Œä¼šè®©é˜…è¯»ä»£ç ä½“éªŒæ›´å¥½.</p>2023-02-14</li><br/>
</ul>