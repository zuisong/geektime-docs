ä½ å¥½ï¼Œæˆ‘æ˜¯æ™¯éœ„ã€‚

ä¸Šä¸€èŠ‚è¯¾çš„æœ€åï¼Œæˆ‘ä»¬ç•™ä¸‹ä¸€ä¸ªå°å°çš„æ‚¬å¿µï¼šç”Ÿæˆå™¨åœ¨ Python 2 ä¸­è¿˜æ‰®æ¼”äº†ä¸€ä¸ªé‡è¦è§’è‰²ï¼Œå°±æ˜¯ç”¨æ¥å®ç° Python åç¨‹ã€‚

é‚£ä¹ˆé¦–å…ˆä½ è¦æ˜ç™½ï¼Œä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿ

åç¨‹æ˜¯å®ç°å¹¶å‘ç¼–ç¨‹çš„ä¸€ç§æ–¹å¼ã€‚ä¸€è¯´å¹¶å‘ï¼Œä½ è‚¯å®šæƒ³åˆ°äº†å¤šçº¿ç¨‹/å¤šè¿›ç¨‹æ¨¡å‹ï¼Œæ²¡é”™ï¼Œå¤šçº¿ç¨‹/å¤šè¿›ç¨‹ï¼Œæ­£æ˜¯è§£å†³å¹¶å‘é—®é¢˜çš„ç»å…¸æ¨¡å‹ä¹‹ä¸€ã€‚æœ€åˆçš„äº’è”ç½‘ä¸–ç•Œï¼Œå¤šçº¿ç¨‹/å¤šè¿›ç¨‹åœ¨æœåŠ¡å™¨å¹¶å‘ä¸­ï¼Œèµ·åˆ°ä¸¾è¶³è½»é‡çš„ä½œç”¨ã€‚

éšç€äº’è”ç½‘çš„å¿«é€Ÿå‘å±•ï¼Œä½ é€æ¸é‡åˆ°äº† C10K ç“¶é¢ˆï¼Œä¹Ÿå°±æ˜¯åŒæ—¶è¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·è¾¾åˆ°äº†ä¸€ä¸‡ä¸ªã€‚äºæ˜¯å¾ˆå¤šä»£ç è·‘å´©äº†ï¼Œè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å ç”¨äº†å¤§é‡çš„èµ„æºï¼Œçº¿ç¨‹ä¹Ÿé¡¶ä¸ä½å¦‚æ­¤å·¨å¤§çš„å‹åŠ›ï¼Œè¿™æ—¶ï¼Œ NGINX å¸¦ç€äº‹ä»¶å¾ªç¯å‡ºæ¥æ‹¯æ•‘ä¸–ç•Œäº†ã€‚

å¦‚æœå°†å¤šè¿›ç¨‹/å¤šçº¿ç¨‹ç±»æ¯”ä¸ºèµ·æºäºå”æœçš„è—©é•‡å‰²æ®ï¼Œé‚£ä¹ˆäº‹ä»¶å¾ªç¯ï¼Œå°±æ˜¯å®‹æœåŠ å¼ºçš„ä¸­å¤®é›†æƒåˆ¶ã€‚äº‹ä»¶å¾ªç¯å¯åŠ¨ä¸€ä¸ªç»Ÿä¸€çš„è°ƒåº¦å™¨ï¼Œè®©è°ƒåº¦å™¨æ¥å†³å®šä¸€ä¸ªæ—¶åˆ»å»è¿è¡Œå“ªä¸ªä»»åŠ¡ï¼Œäºæ˜¯çœå´äº†å¤šçº¿ç¨‹ä¸­å¯åŠ¨çº¿ç¨‹ã€ç®¡ç†çº¿ç¨‹ã€åŒæ­¥é”ç­‰å„ç§å¼€é”€ã€‚åŒä¸€æ—¶æœŸçš„ NGINXï¼Œåœ¨é«˜å¹¶å‘ä¸‹èƒ½ä¿æŒä½èµ„æºä½æ¶ˆè€—é«˜æ€§èƒ½ï¼Œç›¸æ¯” Apache ä¹Ÿæ”¯æŒæ›´å¤šçš„å¹¶å‘è¿æ¥ã€‚

å†åˆ°åæ¥ï¼Œå‡ºç°äº†ä¸€ä¸ªå¾ˆæœ‰åçš„åè¯ï¼Œå«åšå›è°ƒåœ°ç‹±ï¼ˆcallback hellï¼‰ï¼Œæ‰‹æ’¸è¿‡ JavaScript çš„æœ‹å‹è‚¯å®šçŸ¥é“æˆ‘åœ¨è¯´ä»€ä¹ˆã€‚æˆ‘ä»¬å¤§å®¶æƒŠå–œåœ°å‘ç°ï¼Œè¿™ç§å·¥å…·å®Œç¾åœ°ç»§æ‰¿äº†äº‹ä»¶å¾ªç¯çš„ä¼˜è¶Šæ€§ï¼ŒåŒæ—¶è¿˜èƒ½æä¾› async / await è¯­æ³•ç³–ï¼Œè§£å†³äº†æ‰§è¡Œæ€§å’Œå¯è¯»æ€§å…±å­˜çš„éš¾é¢˜ã€‚äºæ˜¯ï¼Œåç¨‹é€æ¸è¢«æ›´å¤šäººå‘ç°å¹¶çœ‹å¥½ï¼Œä¹Ÿæœ‰è¶Šæ¥è¶Šå¤šçš„äººå°è¯•ç”¨ Node.js åšèµ·äº†åç«¯å¼€å‘ã€‚ï¼ˆè®²ä¸ªç¬‘è¯ï¼ŒJavaScript æ˜¯ä¸€é—¨ç¼–ç¨‹è¯­è¨€ã€‚ï¼‰
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ30ï¼‰</strong></div><ul>
<li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJJOlibibPFEWOib8ib7RtfAtxND5FUqCxxoeTuLAbBI9ic23xuwdXT4IyiaWq3Fic9RgEAYI0lBTbEp2rcg/132" width="30px"><span>Jingxiao</span> ğŸ‘ï¼ˆ45ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>æ€è€ƒé¢˜ç­”æ¡ˆï¼š

åœ¨ python 3.7 åŠä»¥ä¸Šçš„ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å¯¹ task å¯¹è±¡è°ƒç”¨ add_done_callback() å‡½æ•°ï¼Œå³å¯ç»‘å®šç‰¹å®šå›è°ƒå‡½æ•°ã€‚å›è°ƒå‡½æ•°æ¥å—ä¸€ä¸ª future å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡ future.result() æ¥è·å–åç¨‹å‡½æ•°çš„è¿”å›å€¼ã€‚

ç¤ºä¾‹å¦‚ä¸‹ï¼š

import asyncio

async def crawl_page(url):
    print(&#39;crawling {}&#39;.format(url))
    sleep_time = int(url.split(&#39;_&#39;)[-1])
    await asyncio.sleep(sleep_time)
    return &#39;OK {}&#39;.format(url)

async def main(urls):
    tasks = [asyncio.create_task(crawl_page(url)) for url in urls]
    for task in tasks:
        task.add_done_callback(lambda future: print(&#39;result: &#39;, future.result()))
    await asyncio.gather(*tasks)

%time asyncio.run(main([&#39;url_1&#39;, &#39;url_2&#39;, &#39;url_3&#39;, &#39;url_4&#39;]))

è¾“å‡ºï¼š

crawling url_1
crawling url_2
crawling url_3
crawling url_4
result:  OK url_1
result:  OK url_2
result:  OK url_3
result:  OK url_4
Wall time: 4 s</div>2019-07-01</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJJOlibibPFEWOib8ib7RtfAtxND5FUqCxxoeTuLAbBI9ic23xuwdXT4IyiaWq3Fic9RgEAYI0lBTbEp2rcg/132" width="30px"><span>Jingxiao</span> ğŸ‘ï¼ˆ77ï¼‰ ğŸ’¬ï¼ˆ10ï¼‰<div>å‘ç°è¯„è®ºåŒºå¥½å¤šæœ‹å‹è¯´æ— æ³•è¿è¡Œï¼Œåœ¨è¿™é‡Œç»Ÿä¸€è§£é‡Šä¸‹ï¼š
1. %time æ˜¯ jupyter notebook è‡ªå¸¦çš„è¯­æ³•ç³–ï¼Œç”¨æ¥ç»Ÿè®¡ä¸€è¡Œå‘½ä»¤çš„è¿è¡Œæ—¶é—´ï¼›å¦‚æœä½ çš„è¿è¡Œæ—¶æ˜¯çº¯ç²¹çš„å‘½ä»¤è¡Œ pythonï¼Œæˆ–è€… pycharmï¼Œé‚£ä¹ˆè¯·æŠŠ %time åˆ æ‰ï¼Œè‡ªå·±ç”¨ä¼ ç»Ÿçš„æ—¶é—´æˆ³æ–¹æ³•æ¥è®°å½•æ—¶é—´ä¹Ÿå¯ä»¥ï¼›æˆ–è€…ä½¿ç”¨ jupyter notebook
2. æˆ‘çš„æœ¬åœ°è§£é‡Šå™¨æ˜¯ Anaconda Python 3.7.3ï¼Œäº²æµ‹ windows &#47; ubuntu å‡å¯æ­£å¸¸è¿è¡Œï¼Œå¦‚æ— æ³•æ‰§è¡Œå¯ä»¥è¯•è¯• pip install nest-asyncioï¼Œä¾ç„¶æ— æ³•è§£å†³è¯·å°è¯•å®‰è£… Anaconda Python
3. è¿™æ¬¡ä»£ç å› ä¸ºä½¿ç”¨äº†è¾ƒæ–°çš„ APIï¼Œæ‰€ä»¥éœ€è¦è¾ƒæ–°çš„ç‰ˆæœ¬å·ï¼Œä½†æ˜¯æœ‹å‹ä»¬ä¾ç„¶å‡ºç°äº†ä¸€äº›è¿è¡Œæ—¶é—®é¢˜ï¼Œè¿™é‡Œå…ˆè¡¨ç¤ºä¸‹æ­‰æ„ï¼›åŒæ—¶ä¹Ÿæƒ³è¯´æ˜çš„æ˜¯ï¼Œåœ¨æé—®ä¹‹å‰è‡ªå·±ç»è¿‡å……åˆ†æœç´¢ï¼Œå°è¯•åè§£å†³é—®é¢˜ï¼Œå¸¦æ¥çš„å¿«æ„Ÿï¼Œå’Œèƒ½åŠ›çš„æå‡ï¼Œç›¸åº”ä¹Ÿæ˜¯å¾ˆå¤§çš„ï¼Œä¸€é—¨å·¥ç¨‹æœ€éœ€è¦çš„æ˜¯ hands on dirty workï¼ˆåŠ¨æ‰‹åšè„æ´»ï¼‰ï¼Œæ‰èƒ½è®©è‡ªå·±çš„èƒ½åŠ›å¾—åˆ°æœ¬è´¨çš„æå‡ï¼ŒåŠ æ²¹ï¼</div>2019-06-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/92/fb/4c06bcef.jpg" width="30px"><span>Airnm.æ¯</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>è±†ç“£é‚£ä¸ªå‘ç°requests.get(url).content&#47;textè¿”å›éƒ½ä¸ºç©ºï¼Œç„¶åæ‰“äº†ä¸‹status_codeå‘ç°æ˜¯418ï¼Œç½‘ä¸Šæ‰¾418çš„è§£é‡Šï¼Œä¸€èˆ¬æ˜¯ç½‘ç«™åçˆ¬è™«åŸºç¡€æœºåˆ¶ï¼Œéœ€è¦åŠ è¯·æ±‚å¤´æ¨¡ä»¿æµè§ˆå™¨å°±å¯è·³è¿‡ï¼Œæ”¹ä¸ºä¸‹é¢çš„æ ·å­å°±å¯é€šè¿‡ï¼šurl = &quot;https:&#47;&#47;movie.douban.com&#47;cinema&#47;later&#47;beijing&#47;&quot;
head={
    &#39;User-Agent&#39;:&#39;Mozilla&#47;5.0 (Windows NT 6.1; Win64; x64) AppleWebKit&#47;537.36 (KHTML, like Gecko) Chrome&#47;81.0.4044.113 Safari&#47;537.36&#39;,
    &#39;Referer&#39;:&#39;https:&#47;&#47;time.geekbang.org&#47;column&#47;article&#47;101855&#39;,
    &#39;Connection&#39;:&#39;keep-alive&#39;}
res = requests.get(url,headers=head)</div>2020-04-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/5a/37/8775d714.jpg" width="30px"><span>jackstraw</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>æœ‰ç‚¹æ²¡æ˜ç™½ï¼Œå‰é¢è¯´ä»»åŠ¡åˆ›å»ºåç«‹é©¬å°±å¼€å§‹æ‰§è¡Œäº†ä¹ˆï¼Ÿæ€ä¹ˆåé¢åœ¨è§£å¯†åº•å±‚è¿è¡Œè¿‡ç¨‹çš„æ—¶å€™ï¼Œè¯´ä»»åŠ¡åˆ›å»ºåç­‰å¾…æ‰§è¡Œï¼Ÿåˆ°åº•æ˜¯å“ªä¸€ä¸ªå‘€ï¼Ÿ</div>2020-01-14</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg" width="30px"><span>é•¿æœŸè§„åˆ’</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œåœ¨æœ€åé‚£ä¸ªåç¨‹ä¾‹å­ä¸­ä¸ºä½•æ²¡ç”¨requestsåº“å‘¢ï¼Ÿæ˜¯å› ä¸ºå®ƒä¸æ”¯æŒåç¨‹å—</div>2019-12-20</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1c/f3/b3/0ba7a760.jpg" width="30px"><span>ä¸€å‡¡</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>åç¨‹æ˜¯å•çº¿ç¨‹æ€ä¹ˆç†è§£ï¼Ÿæ‰€æœ‰çš„åç¨‹éƒ½æ˜¯å—</div>2020-06-18</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/e2/c4/25acaa38.jpg" width="30px"><span>è‹¹æœ</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>asyncio.run() cannot be called from a running event loop
è¿™ä¸ªé—®é¢˜æ˜¯å¦‚ä½•è§£å†³ï¼Œ
</div>2020-02-02</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/b8/78/2828195b.jpg" width="30px"><span>éš°æœ‰è·</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œåœ¨å¦‚ä¸‹ä»£ç ä¸­ï¼š
async def worker_2():
    print(&#39;worker_2 start&#39;)
    await asyncio.sleep(2)
    print(&#39;worker_2 done&#39;)

å…¶ä¸­çš„await asyncio.sleep(2)æ˜¯å¦å¯ä»¥ç†è§£ä¸ºåœ¨åˆ‡å‡ºå½“å‰ç¨‹åºï¼Œ2ç§’åå†ç»§ç»­æ‰§è¡Œprint(&#39;worker_2 done&#39;)ä»£ç ï¼Ÿ
é‚£ä¹ˆå¦‚æœæˆ‘æœ‰ä¸ªè€—æ—¶ä»»åŠ¡ def xxx(): ...ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•ç”¨await asyncioæ¥è®©è¿™ä¸ªxxxå‡½æ•°è¿è¡Œå¹¶åˆ‡å‡ºå½“å‰ç¨‹åºå‘¢ï¼Ÿ</div>2019-11-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/2e/74/88c613e0.jpg" width="30px"><span>æ‰¶å¹½</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è¯·é—®ä¸‹æœ‰æœ¨æœ‰ç›¸å…³çš„ä¹¦ç±ï¼Œæ¥è¿›è¡Œè¿™å—çš„å­¦ä¹ å‘¢ï¼æœ‰äº›åŸç†æ€§çš„ä¸œè¥¿è¿˜æ˜¯æ²¡åŠæ³•æ·±å…¥ç†è§£ï¼Œè°¢è°¢ã€‚</div>2019-10-12</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/41/19/30504ae1.jpg" width="30px"><span>cotter</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>å—æ•™äº†ï¼Œç¬¬ä¸€æ¬¡å¬è¯´è¿™ä¸ªé«˜çº§åŠŸèƒ½ï¼
æˆ‘åœ¨å·¥ä½œä¸­é‡åˆ°ä¸€ä¸ªéœ€è¦å¹¶å‘çš„é—®é¢˜ï¼Œç”¨pythonåœ¨åå°å¹¶å‘æ‰§è¡Œshell ,å¹¶å‘æ•°é‡ç”¨æ—¶é—´èŒƒå›´æ§åˆ¶ï¼Œè¦ä¸åœçš„æ”¹æ—¶é—´åˆ†å¤šæ¬¡ä¸²è¡Œï¼Œæ–¹æ³•æ¯”è¾ƒç¬¨æ‹™ã€‚åç¨‹å¯ä»¥ç®€åŒ–æˆ‘çš„ä»£ç ã€‚
è€å¸ˆï¼Œå¹¶å‘å¾ˆå¤šäº‹ä»¶åº”è¯¥ä¹Ÿæ˜¯éœ€è¦æ¶ˆè€—å¾ˆå¤šèµ„æºï¼Œåç¨‹æ”¹å¦‚ä½•æ§åˆ¶å¹¶å‘æ•°é‡ï¼Ÿ</div>2019-06-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/93/8c/cf41cf2b.jpg" width="30px"><span>SUN</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>Jupyter ä¸­è¿è¡Œ %time asyncio.run(main([&#39;url_1&#39;, &#39;url_2&#39;, &#39;url_3&#39;, &#39;url_4&#39;])) ä¼šæŠ¥é”™ï¼š
RuntimeError: asyncio.run() cannot be called from a running event loop
Pythonã€Anacondaã€Jupyteréƒ½å®‰è£…äº†ã€‚
è¯è¯´ï¼šJupyterä¸å°±æ˜¯ä¸ºäº†æ¶ˆé™¤ä¸ªäººæœ¬åœ°å¼€å‘ç¯å¢ƒå·®å¼‚æ€§è€Œè¯ç”Ÿçš„å—ï¼Ÿè¿™ä¸ªç»“æœæœ‰ç‚¹åè®½ã€‚
å„ä½å­¦å‘˜çš„ç•™è¨€éƒ½çœ‹äº†ï¼Œæ²¡äººè§£å†³äº†æ­¤é—®é¢˜â€¦â€¦
</div>2019-10-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/b3/b6/ac302d89.jpg" width="30px"><span>36åº¦é“</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆï¼Œè¯¾ç¨‹çš„ä»£ç æ˜¯åŸºäºpy3çš„å—ï¼Ÿ</div>2019-06-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg" width="30px"><span>helloworld</span> ğŸ‘ï¼ˆ72ï¼‰ ğŸ’¬ï¼ˆ7ï¼‰<div>è¯´ä¸€ä¸‹æˆ‘å¯¹awaitçš„ç†è§£ï¼š
å¼€å‘è€…è¦æå‰çŸ¥é“ä¸€ä¸ªä»»åŠ¡çš„å“ªä¸ªç¯èŠ‚ä¼šé€ æˆI&#47;Oé˜»å¡ï¼Œç„¶åæŠŠè¿™ä¸ªç¯èŠ‚çš„ä»£ç å¼‚æ­¥åŒ–å¤„ç†ï¼Œå¹¶ä¸”é€šè¿‡awaitæ¥æ ‡è¯†åœ¨ä»»åŠ¡çš„è¯¥ç¯èŠ‚ä¸­æ–­è¯¥ä»»åŠ¡æ‰§è¡Œï¼Œä»è€Œå»æ‰§è¡Œä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä»»åŠ¡ã€‚è¿™æ ·å¯ä»¥å……åˆ†åˆ©ç”¨CPUèµ„æºï¼Œé¿å…CPUç­‰å¾…I&#47;Oé€ æˆCPUèµ„æºç™½ç™½æµªè´¹ã€‚å½“ä¹‹å‰ä»»åŠ¡çš„é‚£ä¸ªç¯èŠ‚çš„I&#47;Oå®Œæˆåï¼Œçº¿ç¨‹å¯ä»¥ä»awaitè·å–è¿”å›å€¼ï¼Œç„¶åç»§ç»­æ‰§è¡Œæ²¡æœ‰å®Œæˆçš„å‰©ä½™ä»£ç ã€‚
ç”±ä¸Šé¢åˆ†æå¯çŸ¥ï¼Œå¦‚æœä¸€ä¸ªä»»åŠ¡ä¸æ¶‰åŠåˆ°ç½‘ç»œæˆ–ç£ç›˜I&#47;Oè¿™ç§è€—æ—¶çš„æ“ä½œï¼Œè€Œåªæœ‰CPUè®¡ç®—å’Œå†…å­˜I&#47;Oçš„æ“ä½œæ—¶ï¼Œåç¨‹å¹¶å‘çš„æ€§èƒ½è¿˜ä¸å¦‚å•çº¿ç¨‹loopå¾ªç¯çš„æ€§èƒ½é«˜ã€‚</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/4e/07/78441c2b.jpg" width="30px"><span>å¤§ä¾ 110</span> ğŸ‘ï¼ˆ45ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æ„Ÿè§‰è¿˜æ˜¯æœ‰å¾ˆå¤šäººçœ‹ä¸æ‡‚ï¼Œæˆ‘è¯•ç€ç”¨é€šä¿—çš„è¯­å¥è®²ä¸€ä¸‹ï¼šåæˆé‡Œé¢é‡è¦çš„æ˜¯ä¸€ä¸ªå…³é”®å­—awaitçš„ç†è§£ï¼Œasyncè¡¨ç¤ºå…¶ä¿®é¥°çš„æ˜¯åç¨‹ä»»åŠ¡å³taskï¼Œawaitè¡¨ç¤ºçš„æ˜¯å½“çº¿ç¨‹æ‰§è¡Œåˆ°è¿™ä¸€å¥ï¼Œæ­¤æ—¶è¯¥taskåœ¨æ­¤å¤„æŒ‚èµ·ï¼Œç„¶åè°ƒåº¦å™¨å»æ‰§è¡Œå…¶ä»–çš„taskï¼Œå½“è¿™ä¸ªæŒ‚èµ·çš„éƒ¨åˆ†å¤„ç†å®Œï¼Œä¼šè°ƒç”¨å›æ‰å‡½æ•°å‘Šè¯‰è°ƒåº¦å™¨æˆ‘å·²ç»æ‰§è¡Œå®Œäº†ï¼Œé‚£ä¹ˆè°ƒåº¦å™¨å°±è¿”å›æ¥å¤„ç†è¿™ä¸ªtaskçš„ä½™ä¸‹è¯­å¥ã€‚
      </div>2019-12-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/77/da/54c663f3.jpg" width="30px"><span>WingÂ·ä¸‰é‡‘</span> ğŸ‘ï¼ˆ36ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æ€è€ƒé¢˜ï¼šç®€å•çš„ç†è§£æ˜¯æ¯ä¸ªæ–°å»ºçš„åç¨‹å¯¹è±¡éƒ½ä¼šè‡ªåŠ¨è°ƒç”¨ add_done_callback() å‡½æ•°æ¥æ·»åŠ ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“åç¨‹å¯¹è±¡çš„ Future çŠ¶æ€å¯åŠ¨æ—¶å°±ä¼šè°ƒç”¨è¯¥å›è°ƒå‡½æ•°ï¼Œä»è€Œå®ç°å›è°ƒã€‚

ç»¼åˆä¸‹å‰é¢çš„ç•™è¨€å’Œä¸ªäººçš„å­¦ä¹ ï¼Œæ€»ç»“ä¸‹ py 3.6 ç‰ˆæœ¬ä¸‹ asyncio çš„ä¸»è¦ä¸åŒï¼š
1ã€æ²¡æœ‰ run(), create_task()ï¼Œå¯ä»¥ç”¨ asyncio.get_even_loop().run_until_complete() æ¥ä»£æ›¿ run()ï¼Œç”¨ ensure_future() æ¥ä»£æ›¿ create_task()ï¼›
2ã€å¯èƒ½ä¼šå‡ºç° RuntimeError: This event loop is already runningï¼Œè§£å†³æ–¹æ¡ˆä¸€ï¼špip install nest_asyncio; import nest_asyncio; nest_asyncio.apply()ï¼›è§£å†³æ–¹æ¡ˆäºŒï¼šæœ‰äº›å‹äººè¯´æ˜¯ tornado 5.x èµ·çš„ç‰ˆæœ¬æ‰æœ‰æ­¤é—®é¢˜ï¼Œå¯è€ƒè™‘å°†å…¶ç‰ˆæœ¬é™è‡³ 4.xï¼ˆä¸æ¨èï¼‰ï¼›
3ã€%time ä¸ %%time çš„ä¸»è¦åŒºåˆ«ï¼š%time func()ï¼ˆå¿…é¡»æ˜¯åŒä¸€è¡Œï¼‰ï¼›%%time å¿…é¡»æ”¾åœ¨å•å…ƒæ ¼çš„å¼€å¤´ï¼Œå¼ºçƒˆå»ºè®®å•ç‹¬ä¸€è¡Œ + ä¸è¦ä¸ importã€def ç›¸å…³çš„è¯­å¥æ”¾åœ¨åŒä¸ªå•å…ƒæ ¼ï¼›
4ã€çˆ¬è™«ä¸­çš„ aiohttp.ClientSession(headers=header, connector=aiohttp.TCPConnector(ssl=False)) æåŠæœªå£°æ˜çš„ headerï¼Œè¦ä¹ˆå°† headers=header éƒ¨åˆ†å»æ‰ä½¿ç”¨é»˜è®¤å‚æ•°ï¼Œè¦ä¹ˆç”¨è¯¸å¦‚ header={&quot;User-Agent&quot;: &quot;Mozilla&#47;5.0 (Windows NT 6.1; Win64; x64) AppleWebKit&#47;537.36 (KHTML, like Gecko) Chrome&#47;74.0.3729.157 Safari&#47;537.36&quot;} æ¥æ˜¾å¼å£°æ˜ï¼›
5ã€tasks = [asyncio.create_task(crawl_page(url)) for url in urls]; await asyncio.gather(*tasks); 
çº¦ç­‰äº
tasks = [crawl_page(url) for url in urls]; asyncio.get_even_loop().run_until_complete(asyncio.wait(tasks));
æˆ–
tasks = [asyncio.ensure_future(crawl_page(url)) for url in urls]; await asyncio.gather(*tasks);</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f6/4e/0066303c.jpg" width="30px"><span>cuikt</span> ğŸ‘ï¼ˆ20ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>åœ¨ä»£ç async with aiohttp.ClientSession(headers=header, connector=aiohttp.TCPConnector(ssl=False)) as session:ä¸­çš„headers=headeréœ€è¦å®šä¹‰headerä¸ºä¸€ä¸ªå­—å…¸å¯ä»¥åƒä¸‹é¢è¿™æ ·ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚
header={&quot;User-Agent&quot;: &quot;Mozilla&#47;5.0 (Windows NT 6.1; Win64; x64) AppleWebKit&#47;537.36 (KHTML, like Gecko) Chrome&#47;74.0.3729.157 Safari&#47;537.36&quot;}</div>2019-06-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/78/e8/b79240e8.jpg" width="30px"><span>rogerr</span> ğŸ‘ï¼ˆ16ï¼‰ ğŸ’¬ï¼ˆ8ï¼‰<div>ç›®å‰çœ‹åˆ°è¿›é˜¶ç¯‡å°±å¾ˆç—›è‹¦äº†ï¼Œå¯¹äºå°ç™½æ¥è¯´ï¼ŒåŸºç¡€ç¯‡è¿˜å¥½ç†è§£ï¼Œåˆ°è¿™å„¿å°±å¯¹æ·±å±‚æ¬¡çš„çŸ¥è¯†æ— æ³•æ·±å…¥ç†è§£å’Œå®è·µï¼Œæ„Ÿè§‰æ¸è¡Œæ¸è¿œï¼Œä¸çŸ¥é“å¦‚ä½•æ·±å…¥ä¸‹å»</div>2019-06-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg" width="30px"><span>tt</span> ğŸ‘ï¼ˆ10ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>å­¦ä¹ ç¬”è®°:å¼‚æ­¥å’Œé˜»å¡ã€‚

é˜»å¡ä¸»è¦æ˜¯åŒæ­¥ç¼–ç¨‹ä¸­çš„æ¦‚å¿µ:æ‰§è¡Œä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚æœæš‚æ—¶æ²¡æœ‰è¿”å›ç»“æœï¼Œè¿™ä¸ªè°ƒç”¨å°±ä¸ä¼šè¿”å›ï¼Œé‚£è¿™ä¸ªç³»ç»Ÿè°ƒç”¨åé¢çš„åº”ç”¨ä»£ç ä¹Ÿä¸ä¼šæ‰§è¡Œï¼Œæ•´ä¸ªåº”ç”¨è¢«â€œé˜»å¡â€äº†ã€‚

åŒæ­¥ç¼–ç¨‹ä¹Ÿå¯ä»¥æœ‰éé˜»å¡çš„æ–¹å¼ï¼Œåœ¨ç³»ç»Ÿè°ƒç”¨æ²¡æœ‰å®Œæˆæ—¶ç›´æ¥è¿”å›ä¸€ä¸ªé”™è¯¯ç ã€‚

å¼‚æ­¥è°ƒç”¨æ˜¯ç³»ç»Ÿè°ƒç”¨å®Œæˆåè¿”å›åº”ç”¨ä¸€ä¸ªæ¶ˆæ¯ï¼Œåº”ç”¨å“åº”æ¶ˆæ¯ï¼Œè·å–ç»“æœã€‚

ä¸Šé¢è¯´çš„ç³»ç»Ÿè°ƒç”¨ å¯¹åº”Pythonä¸­çš„å¼‚æ­¥å‡½æ•°â€”â€”ä¸€ä¸ªéœ€è¦æ‰§è¡Œè¾ƒé•¿æ—¶é—´çš„ä»»åŠ¡ã€‚å“åº”æ¶ˆæ¯åº”è¯¥å¯¹åº”å›è°ƒå‡½æ•°ï¼Œä½†æˆ‘è§‰å¾—awaitå¼‚æ­¥å‡½æ•°è¿”å›æœ¬èº«å°±ç›¸å½“äºç³»ç»Ÿå‘ŠçŸ¥åº”ç”¨ç³»ç»Ÿè°ƒç”¨å®Œæˆäº†ï¼Œåé¢çš„ä»£ç èµ·ç å¯ä»¥å®Œæˆéƒ¨åˆ†å›è°ƒå‡½æ•°åšçš„äº‹æƒ…ã€‚

é˜»å¡å’Œå¼‚æ­¥å¿…é¡»é…åˆæ‰èƒ½å®Œæˆå¼‚æ­¥ç¼–ç¨‹ã€‚

1ã€awaitå¼‚æ­¥å‡½æ•°ä¼šé€ æˆé˜»å¡;
2ã€awaitä¸€ä¸ªtaskä¸ä¼šé€ æˆé˜»å¡ï¼Œä½†æ˜¯taskå¯¹åº”çš„å¼‚æ­¥å‡½æ•°ä¸­å¿…å®šå‡ ä¹awaitä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œè¿™ä¸ªå¼‚æ­¥å‡½æ•°ä¼šé˜»å¡è¿™ä¸ªtaskçš„æ‰§è¡Œï¼Œè¿™æ ·å…¶ä½™taskæ‰èƒ½è¢«äº‹ä»¶è°ƒåº¦å™¨çš„è°ƒåº¦ä»è€Œè·å–æ‰§è¡Œæœºä¼šã€‚</div>2019-06-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/e0/d4/bdd3ed27.jpg" width="30px"><span>converseâœª</span> ğŸ‘ï¼ˆ9ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>#coding:utf-8
import asyncio
import time

async def corou1():
    print(&quot;corou 1, {}&quot;.format(time.perf_counter()))
    await asyncio.sleep(2) 
    print(&quot;corou 1, {}&quot;.format(time.perf_counter()))
    
async def corou2():
    print(&quot;corou 2, {}&quot;.format(time.perf_counter()))
    # await asyncio.sleep(2)
    time.sleep(5) 
    print(&quot;corou 2, {}&quot;.format(time.perf_counter()))

async def corou3():
    print(&quot;corou 3, {}&quot;.format(time.perf_counter()))
    await asyncio.sleep(2) 
    print(&quot;corou 3, {}&quot;.format(time.perf_counter()))

async def main():
    tasks = [asyncio.create_task(corou())for corou in [corou1,corou2,corou3] ]
    await asyncio.gather(*tasks)

if __name__ == &quot;__main__&quot;:
    asyncio.run(main())
###########æ‰§è¡Œç»“æœ############
func 1, 0.3864962
func 2, 0.3866095
func 2, 5.386688
func 3, 5.387335
func 1, 5.3877248
func 3, 7.3883411

é€šè¿‡ä¸Šè¿°ä¾‹å­å¯ä»¥çœ‹å‡ºï¼Œåç¨‹corou1ï¼Œcorou2ï¼Œcorou3çš„æ‰§è¡Œé¡ºåºæŒ‰ç…§åŠ å…¥å¾ªç¯äº‹ä»¶çš„é¡ºåºã€‚åç¨‹corou1 é€šè¿‡ await asyncio.sleep(2) è®©å‡ºæ§åˆ¶æƒï¼Œåç¨‹corou2ç”±äºæ²¡æœ‰awaitè®©å‡ºæ§åˆ¶æƒæ‰€ä»¥ä¸€ç›´åœ¨æ‰§è¡Œã€‚å½“corou2ç»“æŸåï¼Œå¾ˆæ˜¾ç„¶corou1ä¹Ÿå·²ç»æ‰§è¡Œå®Œï¼Œä½†è¿˜æ˜¯å…ˆæ‰§è¡Œåç¨‹corou3ï¼Œç­‰åç¨‹corou3é€šè¿‡awaitè®©å‡ºæ§åˆ¶æƒåï¼Œåç¨‹corou1æ‰æ‰§è¡Œã€‚

ä»ä¸Šå¯ä»¥çœ‹å‡ºï¼š
- åç¨‹æ˜¯æŒ‰ç…§äº‹ä»¶å¾ªç¯é¡ºåºæ‰§è¡Œã€‚å³ä½¿äº¤å‡ºæ§åˆ¶æƒçš„åç¨‹æ‰§è¡Œå®Œæ¯•ä»»åŠ¡åç­‰å¾…å†æ¬¡è·å–æ§åˆ¶æƒå®Œæˆå‰©ä½™ä»»åŠ¡ï¼Œä¹Ÿå¿…é¡»ç­‰åˆ°å¾ªç¯åˆ°è¯¥åç¨‹æ‰èƒ½è·å¾—CPUæ§åˆ¶æƒã€‚ä¸ä¼šç”±äºè¯¥åç¨‹å·²ç»å®Œæˆawaitçš„ä»»åŠ¡è€Œç›´æ¥ç»™å®ƒã€‚è¿™å°±æ˜¯è§£é‡Šï¼Œåç¨‹corou2æ‰§è¡Œå®Œä¼šç»§ç»­æ‰§è¡Œåç¨‹corou3ï¼Œè€Œå¹¶éç»§ç»­æ‰§è¡Œåç¨‹corou1ã€‚
- awaitæ˜¯äº¤å‡ºåç¨‹æ§åˆ¶æƒçš„åœ°æ–¹
- ä»ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡ºï¼Œåç¨‹ä¸­å½“æ‰§è¡Œè€—æ—¶IOæ“ä½œæ—¶ï¼Œåº”åŠæ—¶é‡Šæ”¾æ§åˆ¶æƒï¼Œå¦åˆ™å…¶ä»–åç¨‹å³ä¾¿å®Œæˆä»»åŠ¡ä¹Ÿç”±äºæ²¡æœ‰CPUæ§åˆ¶æƒè€Œæ— æ³•ç»§ç»­æ‰§è¡Œä»»åŠ¡ã€‚</div>2019-07-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/7c/8a/bdeb76ac.jpg" width="30px"><span>Fergus</span> ğŸ‘ï¼ˆ7ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div># -*- encoding: utf-8 -*-
&#39;&#39;&#39;
aiohttp + aysncioçˆ¬å–ç”µè±†ç“£ç”µå½±
py 3.6
sublime text3
&#39;&#39;&#39;


import time
import aiohttp
import asyncio
from bs4 import BeautifulSoup

now = lambda: time.perf_counter()

async def fetchHtmlText(url):
    async with aiohttp.ClientSession(
        headers={&#39;users-agent&#39;:&#39;Mozilla&#47;5.0&#39;}, 
        connector=aiohttp.TCPConnector(ssl=False)) as session:
        async with session.get(url) as response:
            return await response.text()

async def main():
    url = &quot;https:&#47;&#47;movie.douban.com&#47;cinema&#47;later&#47;beijing&#47;&quot;
    html = await fetchHtmlText(url)
    soup = BeautifulSoup(html, &quot;html.parser&quot;)

    divs = soup.find_all(&#39;div&#39;, class_=&#39;item mod&#39;)
    urls = list(map(lambda x: x.a.img[&#39;src&#39;], divs))
    names = list(map(lambda x: x.h3.a.string, divs))
    dats = list(map(lambda x: x.ul.li.string, divs))

    lis = zip(names, dats, urls)
    for i in lis:
        print(&quot;{0:{3}^25} \t {1:{3}^10} \t {2:{3}^}&quot;.format(i[0], i[1], i[2],chr(12288)))


start = now()
loop = asyncio.get_event_loop()
loop.run_until_complete(main())
print(&quot;Wall time: {}&quot;.format(now() - start))


# ä¹é¾™ä¸è´¥ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€    ã€€ã€€07æœˆ02æ—¥ã€€ã€€      https:&#47;&#47;img3.doubanio.com&#47;view&#47;photo&#47;s_ratio_poster&#47;public&#47;p2560169035.jpg
# åˆ«å²ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€    ã€€ã€€07æœˆ02æ—¥ã€€ã€€      https:&#47;&#47;img3.doubanio.com&#47;view&#47;photo&#47;s_ratio_poster&#47;public&#47;p2558138041.jpg
...
# åˆ€èƒŒè—èº«ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€    ã€€ã€€07æœˆ19æ—¥ã€€ã€€      https:&#47;&#47;img1.doubanio.com&#47;view&#47;photo&#47;s_ratio_poster&#47;public&#47;p2557644589.jpg
# Wall time: 1.994356926937086
# [Finished in 3.7s]
</div>2019-06-28</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1a/ee/4d/5d021e4c.jpg" width="30px"><span>å‘å·¦çœ‹é½</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>    for each_movie in all_movies.find_all(&#39;div&#39;, class_=&quot;item&quot;):

AttributeError: &#39;NoneType&#39; object has no attribute &#39;find_all&#39;
æ‰§è¡ŒæŠ¥é”™ï¼Œæœ‰æ²¡æœ‰äººå’Œæˆ‘ä¸€æ ·çš„é—®é¢˜ï¼Ÿè¯·æŒ‡æ•™</div>2020-04-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/63/cb/7c004188.jpg" width="30px"><span>å’Œä½ ä¸€èµ·æ¬ç –çš„èƒ¡å¤§çˆ·</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å¯¹äºç†Ÿæ‚‰çº¿ç¨‹æ¨¡å‹çš„ç¨‹åºå‘˜æ¥è®²ï¼Œå¦‚æœä¸æŠŠæ—¶é—´å¾ªç¯è§£é‡Šæ¸…æ¥šï¼Œåç¨‹ç¡®å®å¾ˆéš¾ç†è§£ã€‚
æˆ‘çš„ç†è§£åç¨‹åœ¨ç¼–ç¨‹è¯­è¨€å±‚é¢å®ç°aioï¼Œåªæœ‰ioç­‰å¾…æ‰åˆ‡æ¢ä¸Šä¸‹æ–‡è€Œä¸åƒçº¿ç¨‹æŒ‰scheduleråˆ†ç‰‡cpuåœ¨æ²¡å¿…è¦çš„æ—¶å€™ä¹Ÿåˆ‡æ¢ä¸Šä¸‹æ–‡ã€‚ä¸çŸ¥é“æˆ‘ç†è§£çš„å¯¹ä¸å¯¹ã€‚</div>2019-07-06</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/7c/8a/bdeb76ac.jpg" width="30px"><span>Fergus</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div># -*- coding:utf-8 -*-
&#39;&#39;&#39;
sublime
py -3.6
asyncio.gather(*args) å¹¶å‘
&#39;&#39;&#39;


import time
import asyncio

async def crawl_page(url):
    print(&#39;crawling {}&#39;.format(url))
    sleep_time = int(url.split(&#39;_&#39;)[-1])
    await asyncio.sleep(sleep_time)
    print(&#39;OK {}&#39;.format(url))
    
star = time.perf_counter()
loop = asyncio.get_event_loop()
tasks = (crawl_page(url) for url in [&#39;url_1&#39;, &#39;url_2&#39;, &#39;url_3&#39;, &#39;url_4&#39;])
loop.run_until_complete(asyncio.gather(*tasks))
loop.close()

print(&#39;Wall time: {:.2f}&#39;.format(time.perf_counter() - star))


crawling url_4
crawling url_1
crawling url_2
crawling url_3
OK url_1
OK url_2
OK url_3
OK url_4
Wall time: 4.00
[Finished in 4.5s]</div>2019-06-27</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1e/42/cd/09b568fc.jpg" width="30px"><span>JabariH</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å¯¹â€œè§£å¯†åç¨‹è¿è¡Œæ—¶â€é‚£éƒ¨åˆ†ä¸‹çš„ç¨‹åºæ‰§è¡Œåšä¸€ä¸ªè§£é‡Šï¼Œæ¬¢è¿å¤§å®¶æŒ‡æ­£ï¼š
1. asyncio.run(main())ç¨‹åºè¿›å…¥mainå‡½æ•°ï¼Œ**äº‹ä»¶å¾ªç¯**[main --&gt; task1 --&gt; task2 --&gt;tas3 --&gt; main]å¼€å¯ï¼›
2. task_1ã€task_2ã€task_3ä»»åŠ¡è¢«åˆ›å»ºï¼Œå¹¶è¿›å…¥äº‹ä»¶å¾ªç¯ç­‰å¾…è¿è¡Œï¼›
3. ä¸»ç¨‹åºè¿è¡Œåˆ°await asyncio.sleep(2)ï¼Œawait å¯¼è‡´ä¸»ç¨‹åºè¢«é˜»å¡2sï¼Œæ­¤æ—¶äº‹ä»¶è°ƒåº¦å™¨å°†æ§åˆ¶æƒä»ä¸»ä»»åŠ¡äº¤ç»™task_1(asyncioæ˜¯æ ¹æ®ä»»åŠ¡åˆ›å»ºé¡ºåºæ¥èµ‹äºˆä»»åŠ¡æ§åˆ¶æƒçš„ï¼Œç›¸å½“äºä¸€ä¸ªqueueï¼Œå…ˆè¿›å…ˆå‡º)ï¼Œå¹¶è®°å½•ä¸»ç¨‹åºè¿è¡Œåˆ°çš„ä½ç½®ï¼›
4. è¿›å…¥task1ï¼Œè¾“å‡ºâ€œasyncio in task1â€ï¼Œåè¿è¡Œåˆ°asyncio.sleep(1)ï¼Œç¨‹åºè¢«é˜»å¡ï¼Œäº‹ä»¶è°ƒåº¦å™¨å°†æ§åˆ¶æƒä»task1äº¤ç»™task2ï¼Œå¹¶è®°å½•task1ç¨‹åºè¿è¡Œåˆ°çš„ä½ç½®ï¼›
5. åŒæ ·ï¼Œtask2è¾“å‡ºâ€œasyncio in task2â€åè¿è¡Œåˆ°await asyncio.sleep(2)ï¼Œè¢«é˜»å¡ï¼Œè®°å½•task2ç¨‹åºè¿è¡Œåˆ°çš„ä½ç½®ï¼Œäº‹ä»¶è°ƒåº¦å™¨å¼€å§‹è°ƒåº¦task3ï¼›
6. åŒç†ï¼Œtask3è¾“å‡ºâ€œasyncio in task3â€åè¿è¡Œåˆ°await asyncio.sleep(3)ï¼Œè¢«é˜»å¡ï¼Œè®°å½•ç¨‹åºé˜»å¡çš„ä½ç½®ï¼Œäº‹ä»¶è°ƒåº¦å™¨æ§åˆ¶æƒåˆäº¤å›ç»™ä¸»ç¨‹åºï¼›
7. æ­¤æ—¶ï¼Œä¸»ç¨‹åºè¿˜åœ¨è¢«é˜»å¡å½“ä¸­ï¼Œäº‹ä»¶è°ƒåº¦å™¨åˆæŒ‰é¡ºåºå¼€å§‹è°ƒåº¦task1ï¼›
8. å½“æ—¶é—´æ¥è¿‘1sçš„æ—¶å€™ï¼Œtask1å¼€å§‹æ¥ç€ä¸Šæ¬¡è¿è¡Œåˆ°çš„ä½ç½®å¾€ä¸‹è¿è¡Œï¼Œè¿”å›1ï¼Œtask1ä»äº‹ä»¶å¾ªç¯ä¸­é€€å‡ºï¼›
9. å½“æ—¶é—´æ¥è¿‘2sçš„æ—¶å€™ï¼Œtask2å¼€å§‹æ¥ç€ä¸Šæ¬¡è¿è¡Œåˆ°çš„ä½ç½®å¾€ä¸‹è¿è¡Œï¼Œè¿”å›2ï¼Œtask2ä»äº‹ä»¶å¾ªç¯ä¸­é€€å‡ºï¼›
10. å½“æ—¶é—´æ¥è¿‘3sçš„æ—¶å€™ï¼Œç”±äºä¸»ç¨‹åºæ¯”task3æ—©å¼€å§‹é˜»å¡ï¼Œæ‰€ä»¥ä¸»ç¨‹åºæ¯”task3å…ˆä¸€æ­¥è§£é™¤é˜»å¡ï¼Œäº‹ä»¶è°ƒåº¦å™¨å°†æ§åˆ¶æƒäº¤ç»™ä¸»ç¨‹åºï¼Œä¸»ç¨‹åºä»ä¸Šæ¬¡è¿è¡Œåˆ°çš„ä½ç½®å¼€å§‹å¾€ä¸‹è¿è¡Œï¼Œå–æ¶ˆtask3ä»»åŠ¡ï¼Œtask3å°†ä¸ä¼šæœ‰è¿”å›å€¼ï¼Œä¸»ç¨‹åºä»äº‹ä»¶å¾ªç¯ä¸­é€€å‡ºï¼Œæ­¤æ—¶ç¨‹åºæ‰§è¡Œå®Œæ¯•ã€‚</div>2021-09-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/23/f9/3e/0d5f27c4.jpg" width="30px"><span>è‚¥çŒ«ä¸å¼€å¿ƒ</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>ç½‘é¡µæ”¹äº†ï¼Œæœ€æ–°åŒæ­¥çˆ¬è™«
import requests
from bs4 import BeautifulSoup

def main():
    url = &quot;https:&#47;&#47;movie.douban.com&#47;cinema&#47;later&#47;beijing&#47;&quot;
    headers = {&#39;User-Agent&#39;: r&#39;Mozilla&#47;5.0 (Windows NT 10.0; WOW64) AppleWebKit&#47;537.36 (KHTML, like Gecko) Chrome&#47;91.0.4472.164 Safari&#47;537.36&#39;}
    init_page = requests.get(url, headers=headers).content
    init_soup = BeautifulSoup(init_page, &#39;lxml&#39;)
    all_movies = init_soup.find(&#39;div&#39;, id=&quot;showing-soon&quot;)
    for each_movie in all_movies.find_all(&#39;div&#39;, class_=&quot;intro&quot;):
        all_a_tag = each_movie.find_all(&#39;a&#39;)
        all_li_tag = each_movie.find_all(&#39;li&#39;)

        movie_name = all_a_tag[0].text
        url_to_fetch = all_a_tag[0][&#39;href&#39;]
        movie_date = all_li_tag[0].text

        response_item = requests.get(url_to_fetch, headers=headers).content
        soup_item = BeautifulSoup(response_item, &#39;lxml&#39;)
        img_tag = soup_item.find(&#39;div&#39;, id=&#39;mainpic&#39;).find(&#39;img&#39;)

        print(&#39;{} {} {}&#39;.format(movie_name, movie_date, img_tag[&#39;src&#39;]))

main()</div>2021-08-19</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/gKnIR8mga02s9xdQoxyJBibmuxHGhfQ8WZicia3Ie4wBQKg4Zc1oVoS03mvaCD46je9xCza25qXc3w6KMckpS0BqQ/132" width="30px"><span>supakito</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<div>å¯¹äºè¿™æ®µä»£ç ï¼š

import asyncio

async def worker_1():
    print(&#39;worker_1 start&#39;)
    await asyncio.sleep(1)
    print(&#39;worker_1 done&#39;)

async def worker_2():
    print(&#39;worker_2 start&#39;)
    await asyncio.sleep(2)
    print(&#39;worker_2 done&#39;)

async def main():
    task1 = asyncio.create_task(worker_1())
    task2 = asyncio.create_task(worker_2())
    print(&#39;before await&#39;)
    await task1
    print(&#39;awaited worker_1&#39;)
    await task2
    print(&#39;awaited worker_2&#39;)

%time asyncio.run(main())

########## è¾“å‡º ##########

before await
worker_1 start
worker_2 start
worker_1 done
awaited worker_1
worker_2 done
awaited worker_2
Wall time: 2.01 s

æˆ‘å¯¹è€å¸ˆçš„è§£é‡Šæœ‰äº›ç–‘é—®ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯åªè¦åˆ›å»ºäº†ä»»åŠ¡ä»¥åï¼Œä¸ç”¨æ‰§è¡Œawaitï¼Œå°±ä¼šè¿è¡Œworker_1å’Œworker_2ä¸­çš„ä»£ç ï¼Œå› ä¸ºæˆ‘æ³¨é‡Šæ‰äº†awaitè¯­å¥åï¼Œå‘ç°ä»ç„¶ä¼šè¾“å‡ºworker_1 doneå’Œworker_2 doneã€‚æ‰€æœ‰è€å¸ˆçš„ç¬¬ä¸‰æ­¥åº”è¯¥ä¸æ˜¯è°ƒåº¦worker_1ï¼Œè€Œæ˜¯ç­‰å¾…worker_1æ‰§è¡Œå®Œæˆï¼Ÿ</div>2019-11-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/de/4c/a51ece16.jpg" width="30px"><span>åˆ˜æ¶¦æ£®</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div> asyncio.run() cannot be called from a running event loop</div>2019-10-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/15/03/c0fe1dbf.jpg" width="30px"><span>è€ƒä¼‘</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>ç¿»é˜…è¯„è®ºï¼Œå‘ç°å¤§å®¶ä¹Ÿæœ‰ç›¸ä¼¼çš„é—®é¢˜ï¼Œå°±æ˜¯åœ¨è€å¸ˆçš„ç¬¬äºŒä¸ªä»£ç å—ä¸­ï¼Œä»£ç ï¼š
%time asyncio.run(main([&#39;url_1&#39;, &#39;url_2&#39;, &#39;url_3&#39;, &#39;url_4&#39;]))
è¿™è¡Œä»£ç å› ä¸ºå‰é¢æœ‰%timeè¯­æ³•ç³–ï¼Œæ‰€ä»¥å¤§å®¶æƒ³å½“ç„¶å°±åœ¨jupyterä¸­æ‰§è¡Œäº†ï¼Œä½†æ˜¯å¾ˆå¤šäººéƒ½é‡åˆ°äº†ï¼š
RuntimeError: asyncio.run() cannot be called from a running event loop 
æŸ¥é˜…Stack Overflowçš„è§£é‡Šjupyterå·²ç»ä¸€ä¸ªevent loopï¼ˆhttps:&#47;&#47;stackoverflow.com&#47;questions&#47;55409641&#47;asyncio-run-cannot-be-called-from-a-running-event-loopï¼‰ï¼Œå› æ­¤éœ€è¦å°†ä»£ç æ”¹æˆï¼š
await main([&#39;url_1&#39;, &#39;url_2&#39;, &#39;url_3&#39;, &#39;url_4&#39;])ï¼Œè€Œä¸”ä¸èƒ½åœ¨awaitå‰é¢åŠ %timeï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼š
SyntaxError: &#39;await&#39; outside function
æ–°æ‰‹å­¦ä¹ åç¨‹æ„Ÿè§‰å„ç§æ‡µï¼ˆè‹¦ç¬‘è„¸ï¼‰</div>2019-09-23</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/f7/f8/3c0a6854.jpg" width="30px"><span>xavier</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆä½ å¥½ï¼Œè¯·æ•™ä¸ªé—®é¢˜ã€‚å¦‚ä¸‹ï¼š

æ–‡ä¸­ä»£ç ï¼š

async def main():
    task1 = asyncio.create_task(worker_1())
    task2 = asyncio.create_task(worker_2())
    print(&#39;before await&#39;)
    await task1
    print(&#39;awaited worker_1&#39;)
    await task2
    print(&#39;awaited worker_2&#39;)

è¯·é—®è°ƒåº¦å™¨ä»ä½•æ—¶å¼€å§‹å¯åŠ¨è°ƒåº¦ï¼Ÿæ˜¯ä¸€æœ‰ä»»åŠ¡åˆ›å»ºå°±æ‰§è¡Œè°ƒåº¦è¿˜æ˜¯æ‰§è¡Œawait task1æ—¶ï¼Ÿè€å¸ˆè¿™é‡Œè¯´çš„æ˜¯æ‰§è¡Œawait task1ï¼Œäº‹ä»¶è°ƒåº¦å™¨å¼€å§‹è°ƒåº¦ worker_1ã€‚ä½†åé¢çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œæ²¡æœ‰awaitæ“ä½œï¼Œä»»åŠ¡å·²å¼€å§‹è¿è¡Œã€‚</div>2019-07-19</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/7c/8a/bdeb76ac.jpg" width="30px"><span>Fergus</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div># ä¾‹1   3.7ä»¥å‰çš„ç‰ˆæœ¬å®ç°
import time
import asyncio

# &lt; py 3.7
async def crawl_page(url):
    print(&#39;crawling {}&#39;.format(url))
    sleep_time = int(url.split(&#39;_&#39;)[-1])
    r = await asyncio.sleep(sleep_time)
    print(&#39;OK {}&#39;.format(url))

async def main(urls):
    for url in urls:
        await crawl_page(url)
        
star = time.perf_counter()
loop = asyncio.get_event_loop()
loop.run_until_complete(main([&#39;url_1&#39;, &#39;url_2&#39;, &#39;url_3&#39;, &#39;url_4&#39;]))
loop.close()
# await main([&#39;url_1&#39;, &#39;url_2&#39;, &#39;url_3&#39;, &#39;url_4&#39;])
print(time.perf_counter() - star)


crawling url_1
OK url_1
crawling url_2
OK url_2
crawling url_3
OK url_3
crawling url_4
OK url_4
10.003888006104894</div>2019-06-26</li><br/>
</ul>