ä½ å¥½ï¼Œæˆ‘æ˜¯éƒæ—ï¼Œä»Šå¤©æˆ‘ä»¬ç»§ç»­åˆ†äº«ç¨‹åºæ€§èƒ½åˆ†æåŸºç¡€çš„å†…å®¹ã€‚

åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å›´ç»•ç€â€œæ€æ ·è®©ç¨‹åºå¯¹CPUæ¦‚è¦ä¿¡æ¯è¿›è¡Œé‡‡æ ·â€è¿™ä¸€é—®é¢˜è¿›è¡Œäº†æ¢è®¨ï¼Œä»Šå¤©ï¼Œæˆ‘ä»¬å†æ¥ä¸€èµ·çœ‹çœ‹å®ƒçš„æ‹“å±•é—®é¢˜ã€‚

## çŸ¥è¯†æ‰©å±•

### é—®é¢˜1ï¼šæ€æ ·è®¾å®šå†…å­˜æ¦‚è¦ä¿¡æ¯çš„é‡‡æ ·é¢‘ç‡ï¼Ÿ

é’ˆå¯¹å†…å­˜æ¦‚è¦ä¿¡æ¯çš„é‡‡æ ·ä¼šæŒ‰ç…§ä¸€å®šæ¯”ä¾‹æ”¶é›†Goç¨‹åºåœ¨è¿è¡ŒæœŸé—´çš„å †å†…å­˜ä½¿ç”¨æƒ…å†µã€‚è®¾å®šå†…å­˜æ¦‚è¦ä¿¡æ¯é‡‡æ ·é¢‘ç‡çš„æ–¹æ³•å¾ˆç®€å•ï¼Œåªè¦ä¸º`runtime.MemProfileRate`å˜é‡èµ‹å€¼å³å¯ã€‚

è¿™ä¸ªå˜é‡çš„å«ä¹‰æ˜¯ï¼Œå¹³å‡æ¯åˆ†é…å¤šå°‘ä¸ªå­—èŠ‚ï¼Œå°±å¯¹å †å†…å­˜çš„ä½¿ç”¨æƒ…å†µè¿›è¡Œä¸€æ¬¡é‡‡æ ·ã€‚å¦‚æœæŠŠè¯¥å˜é‡çš„å€¼è®¾ä¸º`0`ï¼Œé‚£ä¹ˆï¼ŒGoè¯­è¨€è¿è¡Œæ—¶ç³»ç»Ÿå°±ä¼šå®Œå…¨åœæ­¢å¯¹å†…å­˜æ¦‚è¦ä¿¡æ¯çš„é‡‡æ ·ã€‚è¯¥å˜é‡çš„ç¼ºçœå€¼æ˜¯`512 KB`ï¼Œä¹Ÿå°±æ˜¯`512`åƒå­—èŠ‚ã€‚

æ³¨æ„ï¼Œå¦‚æœä½ è¦è®¾å®šè¿™ä¸ªé‡‡æ ·é¢‘ç‡ï¼Œé‚£ä¹ˆè¶Šæ—©è®¾å®šè¶Šå¥½ï¼Œå¹¶ä¸”åªåº”è¯¥è®¾å®šä¸€æ¬¡ï¼Œå¦åˆ™å°±å¯èƒ½ä¼šå¯¹Goè¯­è¨€è¿è¡Œæ—¶ç³»ç»Ÿçš„é‡‡æ ·å·¥ä½œï¼Œé€ æˆä¸è‰¯å½±å“ã€‚æ¯”å¦‚ï¼Œåªåœ¨`main`å‡½æ•°çš„å¼€å§‹å¤„è®¾å®šä¸€æ¬¡ã€‚

åœ¨è¿™ä¹‹åï¼Œå½“æˆ‘ä»¬æƒ³è·å–å†…å­˜æ¦‚è¦ä¿¡æ¯çš„æ—¶å€™ï¼Œè¿˜éœ€è¦è°ƒç”¨`runtime/pprof`åŒ…ä¸­çš„`WriteHeapProfile`å‡½æ•°ã€‚è¯¥å‡½æ•°ä¼šæŠŠæ”¶é›†å¥½çš„å†…å­˜æ¦‚è¦ä¿¡æ¯ï¼Œå†™åˆ°æˆ‘ä»¬æŒ‡å®šçš„å†™å…¥å™¨ä¸­ã€‚

æ³¨æ„ï¼Œæˆ‘ä»¬é€šè¿‡`WriteHeapProfile`å‡½æ•°å¾—åˆ°çš„å†…å­˜æ¦‚è¦ä¿¡æ¯å¹¶ä¸æ˜¯å®æ—¶çš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¿«ç…§ï¼Œæ˜¯åœ¨æœ€è¿‘ä¸€æ¬¡çš„å†…å­˜åƒåœ¾æ”¶é›†å·¥ä½œå®Œæˆæ—¶äº§ç”Ÿçš„ã€‚å¦‚æœä½ æƒ³è¦å®æ—¶çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆå¯ä»¥è°ƒç”¨`runtime.ReadMemStats`å‡½æ•°ã€‚ä¸è¿‡è¦ç‰¹åˆ«æ³¨æ„ï¼Œè¯¥å‡½æ•°ä¼šå¼•èµ·Goè¯­è¨€è°ƒåº¦å™¨çš„çŸ­æš‚åœé¡¿ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ11ï¼‰</strong></div><ul>
<li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJSmAhbvPia1msvk91m5rQLTpicY85f2moFMCcAibictL3OeiaaVREadpHN2O3FwicmylwiclTUJJa1peS1Q/132" width="30px"><span>å¼ sir</span> ğŸ‘ï¼ˆ11ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è¯·é—®è€å¸ˆï¼Œæˆ‘å¦‚ä½•é€šè¿‡è¿™äº›åˆ†ææŒ‡æ ‡æ¥å®šä½å…·ä½“å“ªä¸ªä»£ç åŒ…æˆ–è€…å“ªä¸ªæ–¹æ³•æ‰§è¡Œä¼šæœ‰æ€§èƒ½é—®é¢˜ï¼Œæ¯”å¦‚pprof&#47;goroutineé‡‡æ ·ç»“æœï¼Œæˆ‘è¾“å…¥topNæˆ–è€…web,è¾“å‡º0     0%   100%         36 64.29%  github.com&#47;go-redis&#47;redis&#47;internal&#47;pool.(*ConnPool).reaperè¿™äº›å†…å®¹ï¼Œåº”è¯¥æ€ä¹ˆå»åˆ†æå‘¢</div>2019-12-01</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/97/07/7406fe30.jpg" width="30px"><span>nullptr</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆå¥½ï¼Œæˆ‘åœ¨ç”Ÿäº§ç¯å¢ƒé‡åˆ°gcæ—¶panicçš„é—®é¢˜ï¼Œä¸çŸ¥é“è€å¸ˆæœ‰æ²¡æœ‰å¥½çš„å»ºè®®æ¥å®šä½ä¸€ä¸‹</div>2020-07-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg" width="30px"><span>å®‰æ’</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>goè¯­è¨€å¯æ‰§è¡Œç¨‹åºåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå†…å­˜å¸ƒå±€å’Œ Cè¯­è¨€çš„ä¸€æ ·å—ï¼Ÿgoç¼–å‡ºæ¥çš„å¯æ‰§è¡Œç¨‹åºä¹Ÿæ˜¯elfæ ¼å¼å—ï¼Ÿç¼–è¯‘goç¨‹åºçš„æ­¥éª¤æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿé¢„å¤„ç†ï¼Œç¼–è¯‘æ±‡ç¼–è¿™äº›éƒ½æœ‰å—ï¼Ÿå¯ä¸å¯ä»¥åªæ‰§è¡Œé¢„å¤„ç†æˆ–è€…åªç¼–è¯‘ä¸é“¾æ¥ï¼Ÿ</div>2019-09-10</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/0f/5c/b5/0737c1f2.jpg" width="30px"><span>kuzan</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆå¥½ï¼Œgolangçš„gcä¼šæ ¹æ®ä»€ä¹ˆå°ºå¯¸åšå›æ”¶å‘¢ï¼Œæ¯”å¦‚javaé‡Œæœ‰xmxï¼Œé‚£goå‘¢ï¼Ÿ</div>2019-01-21</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/97/07/7406fe30.jpg" width="30px"><span>nullptr</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>æ²¡æ³•å›å¤è€å¸ˆçš„è¯„è®ºï¼Œæˆ‘å†è¯„è®ºä¸€ä¸ªæ–°çš„ã€‚
ä»£ç å·¥ç¨‹æ¯”è¾ƒå¤§ï¼Œè€Œä¸”ä¸»è¦ä»£ç æ²¡ç›´æ¥ç”¨åˆ°cgoï¼Œä½†æ˜¯åœ¨gcæ—¶å€™panicäº†ï¼Œä¿¡æ¯ä¹Ÿæç¤ºäº†cgoç›¸å…³ï¼Œä¸çŸ¥é“è€å¸ˆæœ‰æ²¡æœ‰å•¥å·¥å…·å¯ä»¥å®šä½ã€‚</div>2020-07-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/97/07/7406fe30.jpg" width="30px"><span>nullptr</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è€å¸ˆå¥½ï¼Œæˆ‘åœ¨ç”Ÿäº§ç¯å¢ƒé‡åˆ°äº†ä¸€ä¸ªgcæ—¶panicï¼Œä¸çŸ¥é“å¦‚ä½•å®šä½ï¼Œè€å¸ˆæœ‰æ²¡æœ‰å•¥å¥½çš„æ€è·¯ã€‚è¿™ä¸ªæ˜¯éƒ¨åˆ†æŠ¥é”™ä¿¡æ¯ï¼š

runtime: pointer 0xc011207d40 to unused region of span span.base()=0xc0009a2000 span.limit=0xc0009aa000 span.state=1
runtime: found in object at *(0xc005cd6420+0x28)
object=0xc005cd6420 s.base()=0xc005cd6000 s.limit=0xc005cd7fa0 s.spanclass=24 s.elemsize=176 s.state=mSpanInUse
 *(object+0) = 0x1010000000068
 *(object+8) = 0xc011206de0
 *(object+16) = 0x1a71b0e
 *(object+24) = 0x0
 *(object+32) = 0x0
 *(object+40) = 0xc011207d40 &lt;==
 *(object+48) = 0x20d8220
 *(object+56) = 0xc011206ef0
 *(object+64) = 0x1a71ae2
 *(object+72) = 0x0
 *(object+80) = 0x0
 *(object+88) = 0x0
 *(object+96) = 0x0
 *(object+104) = 0x0
 *(object+112) = 0x0
 *(object+120) = 0x0
 *(object+128) = 0x0
 *(object+136) = 0x0
 *(object+144) = 0x0
 *(object+152) = 0x0
 *(object+160) = 0x0
 *(object+168) = 0x0
fatal error: found bad pointer in Go heap (incorrect use of unsafe or cgo?)

runtime stack:
runtime.throw(0x2037360, 0x3e)
        &#47;usr&#47;local&#47;go&#47;src&#47;runtime&#47;panic.go:1112 +0x72 fp=0x7f427953ba28 sp=0x7f427953b9f8 pc=0x4460f2
runtime.badPointer(0x7f426b52ade0, 0xc011207d40, 0xc005cd6420, 0x28)
        &#47;usr&#47;local&#47;go&#47;src&#47;runtime&#47;mbitmap.go:380 +0x230 fp=0x7f427953ba70 sp=0x7f427953ba28 pc=0x426530
runtime.findObject(0xc011207d40, 0xc005cd6420, 0x28, 0x7f42a9710a78, 0xc000050e98, 0x2)
        &#47;usr&#47;local&#47;go&#47;src&#47;runtime&#47;mbitmap.go:416 +0x9b fp=0x7f427953baa8 sp=0x7f427953ba70 pc=0x4265db
runtime.scanobject(0xc005cd6420, 0xc000050e98)
        &#47;usr&#47;local&#47;go&#47;src&#47;runtime&#47;mgcmark.go:1274 +0x235 fp=0x7f427953bb38 sp=0x7f427953baa8 pc=0x431675
runtime.gcDrainN(0xc000050e98, 0x10000, 0xc002ee1800)
        &#47;usr&#47;local&#47;go&#47;src&#47;runtime&#47;mgcmark.go:1126 +0x12d fp=0x7f427953bb68 sp=0x7f427953bb38 pc=0x4311bd
runtime.gcAssistAlloc1(0xc002ee1800, 0x10000)
        &#47;usr&#47;local&#47;go&#47;src&#47;runtime&#47;mgcmark.go:531 +0xf3 fp=0x7f427953bbb8 sp=0x7f427953bb68 pc=0x42fc43
runtime.gcAssistAlloc.func1()
        &#47;usr&#47;local&#47;go&#47;src&#47;runtime&#47;mgcmark.go:442 +0x33 fp=0x7f427953bbd8 sp=0x7f</div>2020-07-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/5b/66/ad35bc68.jpg" width="30px"><span>å…š</span> ğŸ‘ï¼ˆ9ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>è‡³å°‘çœ‹å®Œäº†ï¼Œå¯èƒ½å› ä¸ºä¸€ç›´éƒ½ç”¨çš„goä¸­ç®€å•çš„&quot;æŠ€èƒ½&quot;å§ï¼Œå¯¹äºåè¾¹çš„ä¸€äº›æŠ€èƒ½æ„Ÿè§¦ä¸æ˜¯å¤ªæ·±ï¼Œä½†è‡³å°‘å¿ƒé‡Œæœ‰ä¸ªå¤§æ¦‚å°è±¡äº†ï¼Œç­‰åˆ°å·¥ä½œä¸­ç”¨ä¸Šäº†åœ¨æ¥ç¿»çœ‹è¿™äº›å†…å®¹ã€‚è¿™äº›çŸ¥è¯†çš„ç¡®ä¸åŒäºä¸€èˆ¬çš„goæ•™ç¨‹ï¼Œæ‰€æ¶‰åŠåˆ°çš„æ¯ä¸ªæŠ€æœ¯ç‚¹éƒ½å¾ˆæœ‰æ·±åº¦ï¼Œå¯¹æå‡goæŠ€èƒ½å¾ˆæœ‰å¸®åŠ©ï¼Œä½†åˆå­¦è€…ä¸å»ºè®®çœ‹ã€‚</div>2019-07-31</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/20/27/a6932fbe.jpg" width="30px"><span>è™¢åœ‹æŠ€é†¬</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>äºŒåˆ·ç†è§£æ›´åŠ æ·±åˆ»ğŸ˜Š</div>2019-08-24</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/b1/0f/e81a93ed.jpg" width="30px"><span>å˜å˜</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>runtime&#47;traceå¯ä»¥è·Ÿè¸ªä»£ç æ‰§è¡ŒæœŸé—´çš„æ¯ä¸€ä¸ªäº‹ä»¶ï¼Œâ€œThe trace contains events related to goroutine scheduling: a goroutine starts executing on a processor, a goroutine blocks on a synchronization primitive, a goroutine creates or unblocks another goroutine; network-related events: a goroutine blocks on network IO, a goroutine is unblocked on network IO; syscalls-related events: a goroutine enters into syscall, a goroutine returns from syscall; garbage-collector-related events: GC start&#47;stop, concurrent sweep start&#47;stop; and user events. Here and below by &quot;processor&quot; I mean a logical processor, unit of GOMAXPROCS. Each event contains event id, a precise timestamp, OS thread id, processor id, goroutine id, stack trace and other relevant informationâ€ -- https:&#47;&#47;docs.google.com&#47;document&#47;u&#47;1&#47;d&#47;1FP5apqzBgr7ahCCgFO-yoVhk4YZrNIDNf9RybngBc14&#47;pub</div>2019-04-08</li><br/><li><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/KZN2M9CPvWZtjfUblowkxaYdHCfhq6mUOFcKkOAzzR9PVJm4IYUsVP47rHbwZNQT6qxavazjJzn14wpiawKPTaA/132" width="30px"><span>Geek_4b9101</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>è€å¸ˆï¼Œè¿™ç§ç½‘ä¸Šéƒ½æœ‰ï¼Œæˆ‘ä»¬è¿™é‡Œèƒ½ä¸èƒ½æ¥ç‚¹æ–°çš„ï¼Œæ¯”å¦‚ æ€§èƒ½åˆ†ææ¡ˆä¾‹</div>2022-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/7c/e5/3dca2495.jpg" width="30px"><span>ä¸Šå±±çš„oç‰›</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å·¥ä½œä¸­ä¼šç”¨åˆ°çš„ï¼Œå†é‡å§</div>2019-10-12</li><br/>
</ul>