æˆ‘ä»¬åœ¨ä¸Šç¯‡æ–‡ç« ä¸­è®²åˆ°äº†`sync.WaitGroup`ç±»å‹ï¼šä¸€ä¸ªå¯ä»¥å¸®æˆ‘ä»¬å®ç°ä¸€å¯¹å¤šgoroutineåä½œæµç¨‹çš„åŒæ­¥å·¥å…·ã€‚

**åœ¨ä½¿ç”¨`WaitGroup`å€¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ€å¥½ç”¨â€œå…ˆç»Ÿä¸€`Add`ï¼Œå†å¹¶å‘`Done`ï¼Œæœ€å`Wait`â€çš„æ ‡å‡†æ¨¡å¼æ¥æ„å»ºåä½œæµç¨‹ã€‚**

å¦‚æœåœ¨è°ƒç”¨è¯¥å€¼çš„`Wait`æ–¹æ³•çš„åŒæ—¶ï¼Œä¸ºäº†å¢å¤§å…¶è®¡æ•°å™¨çš„å€¼ï¼Œè€Œå¹¶å‘åœ°è°ƒç”¨è¯¥å€¼çš„`Add`æ–¹æ³•ï¼Œé‚£ä¹ˆå°±å¾ˆå¯èƒ½ä¼šå¼•å‘panicã€‚

è¿™å°±å¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬ä¸èƒ½åœ¨ä¸€å¼€å§‹å°±ç¡®å®šæ‰§è¡Œå­ä»»åŠ¡çš„goroutineçš„æ•°é‡ï¼Œé‚£ä¹ˆä½¿ç”¨`WaitGroup`å€¼æ¥åè°ƒå®ƒä»¬å’Œåˆ†å‘å­ä»»åŠ¡çš„goroutineï¼Œå°±æ˜¯æœ‰ä¸€å®šé£é™©çš„ã€‚ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯ï¼šåˆ†æ‰¹åœ°å¯ç”¨æ‰§è¡Œå­ä»»åŠ¡çš„goroutineã€‚

## å‰å¯¼å†…å®¹ï¼šWaitGroupå€¼è¡¥å……çŸ¥è¯†

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œ`WaitGroup`å€¼æ˜¯å¯ä»¥è¢«å¤ç”¨çš„ï¼Œä½†éœ€è¦ä¿è¯å…¶è®¡æ•°å‘¨æœŸçš„å®Œæ•´æ€§ã€‚å°¤å…¶æ˜¯æ¶‰åŠå¯¹å…¶`Wait`æ–¹æ³•è°ƒç”¨çš„æ—¶å€™ï¼Œå®ƒçš„ä¸‹ä¸€ä¸ªè®¡æ•°å‘¨æœŸå¿…é¡»è¦ç­‰åˆ°ï¼Œä¸å½“å‰è®¡æ•°å‘¨æœŸå¯¹åº”çš„é‚£ä¸ª`Wait`æ–¹æ³•è°ƒç”¨å®Œæˆä¹‹åï¼Œæ‰èƒ½å¤Ÿå¼€å§‹ã€‚

æˆ‘åœ¨å‰é¢æåˆ°çš„å¯èƒ½ä¼šå¼•å‘panicçš„æƒ…å†µï¼Œå°±æ˜¯ç”±äºæ²¡æœ‰éµå¾ªè¿™æ¡è§„åˆ™è€Œå¯¼è‡´çš„ã€‚

åªè¦æˆ‘ä»¬åœ¨ä¸¥æ ¼éµå¾ªä¸Šè¿°è§„åˆ™çš„å‰æä¸‹ï¼Œåˆ†æ‰¹åœ°å¯ç”¨æ‰§è¡Œå­ä»»åŠ¡çš„goroutineï¼Œå°±è‚¯å®šä¸ä¼šæœ‰é—®é¢˜ã€‚å…·ä½“çš„å®ç°æ–¹å¼æœ‰ä¸å°‘ï¼Œå…¶ä¸­æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨`for`å¾ªç¯æ¥ä½œä¸ºè¾…åŠ©ã€‚è¿™é‡Œçš„ä»£ç å¦‚ä¸‹ï¼š

```
func coordinateWithWaitGroup() {
 total := 12
 stride := 3
 var num int32
 fmt.Printf("The number: %d [with sync.WaitGroup]\n", num)
 var wg sync.WaitGroup
 for i := 1; i <= total; i = i + stride {
  wg.Add(stride)
  for j := 0; j < stride; j++ {
   go addNum(&num, i+j, wg.Done)
  }
  wg.Wait()
 }
 fmt.Println("End.")
}
```

è¿™é‡Œå±•ç¤ºçš„`coordinateWithWaitGroup`å‡½æ•°ï¼Œå°±æ˜¯ä¸Šä¸€ç¯‡æ–‡ç« ä¸­åŒåå‡½æ•°çš„æ”¹é€ ç‰ˆæœ¬ã€‚è€Œå…¶ä¸­è°ƒç”¨çš„`addNum`å‡½æ•°ï¼Œåˆ™æ˜¯ä¸Šä¸€ç¯‡æ–‡ç« ä¸­åŒåå‡½æ•°çš„ç®€åŒ–ç‰ˆæœ¬ã€‚è¿™ä¸¤ä¸ªå‡½æ•°éƒ½å·²è¢«æ”¾ç½®åœ¨äº†demo67.goæ–‡ä»¶ä¸­ã€‚

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç»è¿‡æ”¹é€ åçš„`coordinateWithWaitGroup`å‡½æ•°ï¼Œå¾ªç¯åœ°ä½¿ç”¨äº†ç”±å˜é‡`wg`ä»£è¡¨çš„`WaitGroup`å€¼ã€‚å®ƒè¿ç”¨çš„ä¾ç„¶æ˜¯â€œå…ˆç»Ÿä¸€`Add`ï¼Œå†å¹¶å‘`Done`ï¼Œæœ€å`Wait`â€çš„è¿™ç§æ¨¡å¼ï¼Œåªä¸è¿‡å®ƒåˆ©ç”¨`for`è¯­å¥ï¼Œå¯¹æ­¤è¿›è¡Œäº†å¤ç”¨ã€‚

å¥½äº†ï¼Œè‡³æ­¤ä½ åº”è¯¥å·²ç»å¯¹`WaitGroup`å€¼çš„è¿ç”¨æœ‰æ‰€äº†è§£äº†ã€‚ä¸è¿‡ï¼Œæˆ‘ç°åœ¨æƒ³è®©ä½ ä½¿ç”¨å¦ä¸€ç§å·¥å…·æ¥å®ç°ä¸Šé¢çš„åä½œæµç¨‹ã€‚

**æˆ‘ä»¬ä»Šå¤©çš„é—®é¢˜å°±æ˜¯ï¼šæ€æ ·ä½¿ç”¨`context`åŒ…ä¸­çš„ç¨‹åºå®ä½“ï¼Œå®ç°ä¸€å¯¹å¤šçš„goroutineåä½œæµç¨‹ï¼Ÿ**

æ›´å…·ä½“åœ°è¯´ï¼Œæˆ‘éœ€è¦ä½ ç¼–å†™ä¸€ä¸ªåä¸º`coordinateWithContext`çš„å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°åº”è¯¥å…·æœ‰ä¸Šé¢`coordinateWithWaitGroup`å‡½æ•°ç›¸åŒçš„åŠŸèƒ½ã€‚

æ˜¾ç„¶ï¼Œä½ ä¸èƒ½å†ä½¿ç”¨`sync.WaitGroup`äº†ï¼Œè€Œè¦ç”¨`context`åŒ…ä¸­çš„å‡½æ•°å’Œ`Context`ç±»å‹ä½œä¸ºå®ç°å·¥å…·ã€‚è¿™é‡Œæ³¨æ„ä¸€ç‚¹ï¼Œæ˜¯å¦åˆ†æ‰¹å¯ç”¨æ‰§è¡Œå­ä»»åŠ¡çš„goroutineå…¶å®å¹¶ä¸é‡è¦ã€‚

æˆ‘åœ¨è¿™é‡Œç»™ä½ ä¸€ä¸ªå‚è€ƒç­”æ¡ˆã€‚

```
func coordinateWithContext() {
 total := 12
 var num int32
 fmt.Printf("The number: %d [with context.Context]\n", num)
 cxt, cancelFunc := context.WithCancel(context.Background())
 for i := 1; i <= total; i++ {
  go addNum(&num, i, func() {
   if atomic.LoadInt32(&num) == int32(total) {
    cancelFunc()
   }
  })
 }
 <-cxt.Done()
 fmt.Println("End.")
}
```

åœ¨è¿™ä¸ªå‡½æ•°ä½“ä¸­ï¼Œæˆ‘å…ˆåè°ƒç”¨äº†`context.Background`å‡½æ•°å’Œ`context.WithCancel`å‡½æ•°ï¼Œå¹¶å¾—åˆ°äº†ä¸€ä¸ªå¯æ’¤é”€çš„`context.Context`ç±»å‹çš„å€¼ï¼ˆç”±å˜é‡`cxt`ä»£è¡¨ï¼‰ï¼Œä»¥åŠä¸€ä¸ª`context.CancelFunc`ç±»å‹çš„æ’¤é”€å‡½æ•°ï¼ˆç”±å˜é‡`cancelFunc`ä»£è¡¨ï¼‰ã€‚

åœ¨åé¢é‚£æ¡å”¯ä¸€çš„`for`è¯­å¥ä¸­ï¼Œæˆ‘åœ¨æ¯æ¬¡è¿­ä»£ä¸­éƒ½é€šè¿‡ä¸€æ¡`go`è¯­å¥ï¼Œå¼‚æ­¥åœ°è°ƒç”¨`addNum`å‡½æ•°ï¼Œè°ƒç”¨çš„æ€»æ¬¡æ•°åªä¾æ®äº†`total`å˜é‡çš„å€¼ã€‚

è¯·æ³¨æ„æˆ‘ç»™äºˆ`addNum`å‡½æ•°çš„æœ€åä¸€ä¸ªå‚æ•°å€¼ã€‚å®ƒæ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œå…¶ä¸­åªåŒ…å«äº†ä¸€æ¡`if`è¯­å¥ã€‚è¿™æ¡`if`è¯­å¥ä¼šâ€œåŸå­åœ°â€åŠ è½½`num`å˜é‡çš„å€¼ï¼Œå¹¶åˆ¤æ–­å®ƒæ˜¯å¦ç­‰äº`total`å˜é‡çš„å€¼ã€‚

å¦‚æœä¸¤ä¸ªå€¼ç›¸ç­‰ï¼Œé‚£ä¹ˆå°±è°ƒç”¨`cancelFunc`å‡½æ•°ã€‚å…¶å«ä¹‰æ˜¯ï¼Œå¦‚æœæ‰€æœ‰çš„`addNum`å‡½æ•°éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œé‚£ä¹ˆå°±ç«‹å³é€šçŸ¥åˆ†å‘å­ä»»åŠ¡çš„goroutineã€‚

è¿™é‡Œåˆ†å‘å­ä»»åŠ¡çš„goroutineï¼Œå³ä¸ºæ‰§è¡Œ`coordinateWithContext`å‡½æ•°çš„goroutineã€‚å®ƒåœ¨æ‰§è¡Œå®Œ`for`è¯­å¥åï¼Œä¼šç«‹å³è°ƒç”¨`cxt`å˜é‡çš„`Done`å‡½æ•°ï¼Œå¹¶è¯•å›¾é’ˆå¯¹è¯¥å‡½æ•°è¿”å›çš„é€šé“ï¼Œè¿›è¡Œæ¥æ”¶æ“ä½œã€‚

ç”±äºä¸€æ—¦`cancelFunc`å‡½æ•°è¢«è°ƒç”¨ï¼Œé’ˆå¯¹è¯¥é€šé“çš„æ¥æ”¶æ“ä½œå°±ä¼šé©¬ä¸Šç»“æŸï¼Œæ‰€ä»¥ï¼Œè¿™æ ·åšå°±å¯ä»¥å®ç°â€œç­‰å¾…æ‰€æœ‰çš„`addNum`å‡½æ•°éƒ½æ‰§è¡Œå®Œæ¯•â€çš„åŠŸèƒ½ã€‚

## é—®é¢˜è§£æ

`context.Context`ç±»å‹ï¼ˆä»¥ä¸‹ç®€ç§°`Context`ç±»å‹ï¼‰æ˜¯åœ¨Go 1.7å‘å¸ƒæ—¶æ‰è¢«åŠ å…¥åˆ°æ ‡å‡†åº“çš„ã€‚è€Œåï¼Œæ ‡å‡†åº“ä¸­çš„å¾ˆå¤šå…¶ä»–ä»£ç åŒ…éƒ½ä¸ºäº†æ”¯æŒå®ƒè€Œè¿›è¡Œäº†æ‰©å±•ï¼ŒåŒ…æ‹¬ï¼š`os/exec`åŒ…ã€`net`åŒ…ã€`database/sql`åŒ…ï¼Œä»¥åŠ`runtime/pprof`åŒ…å’Œ`runtime/trace`åŒ…ï¼Œç­‰ç­‰ã€‚

`Context`ç±»å‹ä¹‹æ‰€ä»¥å—åˆ°äº†æ ‡å‡†åº“ä¸­ä¼—å¤šä»£ç åŒ…çš„ç§¯ææ”¯æŒï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒæ˜¯ä¸€ç§éå¸¸é€šç”¨çš„åŒæ­¥å·¥å…·ã€‚å®ƒçš„å€¼ä¸ä½†å¯ä»¥è¢«ä»»æ„åœ°æ‰©æ•£ï¼Œè€Œä¸”è¿˜å¯ä»¥è¢«ç”¨æ¥ä¼ é€’é¢å¤–çš„ä¿¡æ¯å’Œä¿¡å·ã€‚

æ›´å…·ä½“åœ°è¯´ï¼Œ`Context`ç±»å‹å¯ä»¥æä¾›ä¸€ç±»ä»£è¡¨ä¸Šä¸‹æ–‡çš„å€¼ã€‚æ­¤ç±»å€¼æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå¯ä»¥è¢«ä¼ æ’­ç»™å¤šä¸ªgoroutineã€‚

ç”±äº`Context`ç±»å‹å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œè€Œ`context`åŒ…ä¸­å®ç°è¯¥æ¥å£çš„æ‰€æœ‰ç§æœ‰ç±»å‹ï¼Œéƒ½æ˜¯åŸºäºæŸä¸ªæ•°æ®ç±»å‹çš„æŒ‡é’ˆç±»å‹ï¼Œæ‰€ä»¥ï¼Œå¦‚æ­¤ä¼ æ’­å¹¶ä¸ä¼šå½±å“è¯¥ç±»å‹å€¼çš„åŠŸèƒ½å’Œå®‰å…¨ã€‚

`Context`ç±»å‹çš„å€¼ï¼ˆä»¥ä¸‹ç®€ç§°`Context`å€¼ï¼‰æ˜¯å¯ä»¥ç¹è¡çš„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ª`Context`å€¼äº§ç”Ÿå‡ºä»»æ„ä¸ªå­å€¼ã€‚è¿™äº›å­å€¼å¯ä»¥æºå¸¦å…¶çˆ¶å€¼çš„å±æ€§å’Œæ•°æ®ï¼Œä¹Ÿå¯ä»¥å“åº”æˆ‘ä»¬é€šè¿‡å…¶çˆ¶å€¼ä¼ è¾¾çš„ä¿¡å·ã€‚

æ­£å› ä¸ºå¦‚æ­¤ï¼Œæ‰€æœ‰çš„`Context`å€¼å…±åŒæ„æˆäº†ä¸€é¢—ä»£è¡¨äº†ä¸Šä¸‹æ–‡å…¨è²Œçš„æ ‘å½¢ç»“æ„ã€‚è¿™æ£µæ ‘çš„æ ‘æ ¹ï¼ˆæˆ–è€…ç§°ä¸Šä¸‹æ–‡æ ¹èŠ‚ç‚¹ï¼‰æ˜¯ä¸€ä¸ªå·²ç»åœ¨`context`åŒ…ä¸­é¢„å®šä¹‰å¥½çš„`Context`å€¼ï¼Œå®ƒæ˜¯å…¨å±€å”¯ä¸€çš„ã€‚é€šè¿‡è°ƒç”¨`context.Background`å‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å–åˆ°å®ƒï¼ˆæˆ‘åœ¨`coordinateWithContext`å‡½æ•°ä¸­å°±æ˜¯è¿™ä¹ˆåšçš„ï¼‰ã€‚

è¿™é‡Œæ³¨æ„ä¸€ä¸‹ï¼Œè¿™ä¸ªä¸Šä¸‹æ–‡æ ¹èŠ‚ç‚¹ä»…ä»…æ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„æ”¯ç‚¹ï¼Œå®ƒä¸æä¾›ä»»ä½•é¢å¤–çš„åŠŸèƒ½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæ—¢ä¸å¯ä»¥è¢«æ’¤é”€ï¼ˆcancelï¼‰ï¼Œä¹Ÿä¸èƒ½æºå¸¦ä»»ä½•æ•°æ®ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œ`context`åŒ…ä¸­è¿˜åŒ…å«äº†å››ä¸ªç”¨äºç¹è¡`Context`å€¼çš„å‡½æ•°ï¼Œå³ï¼š`WithCancel`ã€`WithDeadline`ã€`WithTimeout`å’Œ`WithValue`ã€‚

è¿™äº›å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„ç±»å‹éƒ½æ˜¯`context.Context`ï¼Œè€Œåç§°éƒ½ä¸º`parent`ã€‚é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªä½ç½®ä¸Šçš„å‚æ•°å¯¹åº”çš„éƒ½æ˜¯å®ƒä»¬å°†ä¼šäº§ç”Ÿçš„`Context`å€¼çš„çˆ¶å€¼ã€‚

`WithCancel`å‡½æ•°ç”¨äºäº§ç”Ÿä¸€ä¸ªå¯æ’¤é”€çš„`parent`çš„å­å€¼ã€‚åœ¨`coordinateWithContext`å‡½æ•°ä¸­ï¼Œæˆ‘é€šè¿‡è°ƒç”¨è¯¥å‡½æ•°ï¼Œè·å¾—äº†ä¸€ä¸ªè¡ç”Ÿè‡ªä¸Šä¸‹æ–‡æ ¹èŠ‚ç‚¹çš„`Context`å€¼ï¼Œå’Œä¸€ä¸ªç”¨äºè§¦å‘æ’¤é”€ä¿¡å·çš„å‡½æ•°ã€‚

è€Œ`WithDeadline`å‡½æ•°å’Œ`WithTimeout`å‡½æ•°åˆ™éƒ½å¯ä»¥è¢«ç”¨æ¥äº§ç”Ÿä¸€ä¸ªä¼šå®šæ—¶æ’¤é”€çš„`parent`çš„å­å€¼ã€‚è‡³äº`WithValue`å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨å®ƒï¼Œäº§ç”Ÿä¸€ä¸ªä¼šæºå¸¦é¢å¤–æ•°æ®çš„`parent`çš„å­å€¼ã€‚

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å¯¹`context`åŒ…ä¸­çš„å‡½æ•°å’Œ`Context`ç±»å‹æœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„è®¤è¯†äº†ã€‚ä¸è¿‡è¿™è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬å†æ¥æ‰©å±•ä¸€ä¸‹ã€‚

## çŸ¥è¯†æ‰©å±•

### é—®é¢˜1ï¼šâ€œå¯æ’¤é”€çš„â€åœ¨`context`åŒ…ä¸­ä»£è¡¨ç€ä»€ä¹ˆï¼Ÿâ€œæ’¤é”€â€ä¸€ä¸ª`Context`å€¼åˆæ„å‘³ç€ä»€ä¹ˆï¼Ÿ

æˆ‘ç›¸ä¿¡å¾ˆå¤šåˆè¯†`context`åŒ…çš„Goç¨‹åºå¼€å‘è€…ï¼Œéƒ½ä¼šæœ‰è¿™æ ·çš„ç–‘é—®ã€‚ç¡®å®ï¼Œâ€œå¯æ’¤é”€çš„â€ï¼ˆcancelableï¼‰è¿™ä¸ªè¯åœ¨è¿™é‡Œæ˜¯æ¯”è¾ƒæŠ½è±¡çš„ï¼Œå¾ˆå®¹æ˜“è®©äººè¿·æƒ‘ã€‚æˆ‘è¿™é‡Œå†æ¥è§£é‡Šä¸€ä¸‹ã€‚

è¿™éœ€è¦ä»`Context`ç±»å‹çš„å£°æ˜è®²èµ·ã€‚è¿™ä¸ªæ¥å£ä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•ä¸â€œæ’¤é”€â€æ¯æ¯ç›¸å…³ã€‚`Done`æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªå…ƒç´ ç±»å‹ä¸º`struct{}`çš„æ¥æ”¶é€šé“ã€‚ä¸è¿‡ï¼Œè¿™ä¸ªæ¥æ”¶é€šé“çš„ç”¨é€”å¹¶ä¸æ˜¯ä¼ é€’å…ƒç´ å€¼ï¼Œè€Œæ˜¯è®©è°ƒç”¨æ–¹å»æ„ŸçŸ¥â€œæ’¤é”€â€å½“å‰`Context`å€¼çš„é‚£ä¸ªä¿¡å·ã€‚

ä¸€æ—¦å½“å‰çš„`Context`å€¼è¢«æ’¤é”€ï¼Œè¿™é‡Œçš„æ¥æ”¶é€šé“å°±ä¼šè¢«ç«‹å³å…³é—­ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå¯¹äºä¸€ä¸ªæœªåŒ…å«ä»»ä½•å…ƒç´ å€¼çš„é€šé“æ¥è¯´ï¼Œå®ƒçš„å…³é—­ä¼šä½¿ä»»ä½•é’ˆå¯¹å®ƒçš„æ¥æ”¶æ“ä½œç«‹å³ç»“æŸã€‚

æ­£å› ä¸ºå¦‚æ­¤ï¼Œåœ¨`coordinateWithContext`å‡½æ•°ä¸­ï¼ŒåŸºäºè°ƒç”¨è¡¨è¾¾å¼`cxt.Done()`çš„æ¥æ”¶æ“ä½œï¼Œæ‰èƒ½å¤Ÿèµ·åˆ°æ„ŸçŸ¥æ’¤é”€ä¿¡å·çš„ä½œç”¨ã€‚

é™¤äº†è®©`Context`å€¼çš„ä½¿ç”¨æ–¹æ„ŸçŸ¥åˆ°æ’¤é”€ä¿¡å·ï¼Œè®©å®ƒä»¬å¾—åˆ°â€œæ’¤é”€â€çš„å…·ä½“åŸå› ï¼Œæœ‰æ—¶ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚åè€…å³æ˜¯`Context`ç±»å‹çš„`Err`æ–¹æ³•çš„ä½œç”¨ã€‚è¯¥æ–¹æ³•çš„ç»“æœæ˜¯`error`ç±»å‹çš„ï¼Œå¹¶ä¸”å…¶å€¼åªå¯èƒ½ç­‰äº`context.Canceled`å˜é‡çš„å€¼ï¼Œæˆ–è€…`context.DeadlineExceeded`å˜é‡çš„å€¼ã€‚

å‰è€…ç”¨äºè¡¨ç¤ºæ‰‹åŠ¨æ’¤é”€ï¼Œè€Œåè€…åˆ™ä»£è¡¨ï¼šç”±äºæˆ‘ä»¬ç»™å®šçš„è¿‡æœŸæ—¶é—´å·²åˆ°ï¼Œè€Œå¯¼è‡´çš„æ’¤é”€ã€‚

ä½ å¯èƒ½å·²ç»æ„Ÿè§‰åˆ°äº†ï¼Œå¯¹äº`Context`å€¼æ¥è¯´ï¼Œâ€œæ’¤é”€â€è¿™ä¸ªè¯å¦‚æœå½“åè¯è®²ï¼ŒæŒ‡çš„å…¶å®å°±æ˜¯è¢«ç”¨æ¥è¡¨è¾¾â€œæ’¤é”€â€çŠ¶æ€çš„ä¿¡å·ï¼›å¦‚æœå½“åŠ¨è¯è®²ï¼ŒæŒ‡çš„å°±æ˜¯å¯¹æ’¤é”€ä¿¡å·çš„ä¼ è¾¾ï¼›è€Œâ€œå¯æ’¤é”€çš„â€æŒ‡çš„åˆ™æ˜¯å…·æœ‰ä¼ è¾¾è¿™ç§æ’¤é”€ä¿¡å·çš„èƒ½åŠ›ã€‚

æˆ‘åœ¨å‰é¢è®²è¿‡ï¼Œå½“æˆ‘ä»¬é€šè¿‡è°ƒç”¨`context.WithCancel`å‡½æ•°äº§ç”Ÿä¸€ä¸ªå¯æ’¤é”€çš„`Context`å€¼æ—¶ï¼Œè¿˜ä¼šè·å¾—ä¸€ä¸ªç”¨äºè§¦å‘æ’¤é”€ä¿¡å·çš„å‡½æ•°ã€‚

é€šè¿‡è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥è§¦å‘é’ˆå¯¹è¿™ä¸ª`Context`å€¼çš„æ’¤é”€ä¿¡å·ã€‚ä¸€æ—¦è§¦å‘ï¼Œæ’¤é”€ä¿¡å·å°±ä¼šç«‹å³è¢«ä¼ è¾¾ç»™è¿™ä¸ª`Context`å€¼ï¼Œå¹¶ç”±å®ƒçš„`Done`æ–¹æ³•çš„ç»“æœå€¼ï¼ˆä¸€ä¸ªæ¥æ”¶é€šé“ï¼‰è¡¨è¾¾å‡ºæ¥ã€‚

æ’¤é”€å‡½æ•°åªè´Ÿè´£è§¦å‘ä¿¡å·ï¼Œè€Œå¯¹åº”çš„å¯æ’¤é”€çš„`Context`å€¼ä¹Ÿåªè´Ÿè´£ä¼ è¾¾ä¿¡å·ï¼Œå®ƒä»¬éƒ½ä¸ä¼šå»ç®¡åè¾¹å…·ä½“çš„â€œæ’¤é”€â€æ“ä½œã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬çš„ä»£ç å¯ä»¥åœ¨æ„ŸçŸ¥åˆ°æ’¤é”€ä¿¡å·ä¹‹åï¼Œè¿›è¡Œä»»æ„çš„æ“ä½œï¼Œ`Context`å€¼å¯¹æ­¤å¹¶æ²¡æœ‰ä»»ä½•çš„çº¦æŸã€‚

æœ€åï¼Œè‹¥å†æ·±ç©¶çš„è¯ï¼Œè¿™é‡Œçš„â€œæ’¤é”€â€æœ€åŸå§‹çš„å«ä¹‰å…¶å®å°±æ˜¯ï¼Œç»ˆæ­¢ç¨‹åºé’ˆå¯¹æŸç§è¯·æ±‚ï¼ˆæ¯”å¦‚HTTPè¯·æ±‚ï¼‰çš„å“åº”ï¼Œæˆ–è€…å–æ¶ˆå¯¹æŸç§æŒ‡ä»¤ï¼ˆæ¯”å¦‚SQLæŒ‡ä»¤ï¼‰çš„å¤„ç†ã€‚è¿™ä¹Ÿæ˜¯Goè¯­è¨€å›¢é˜Ÿåœ¨åˆ›å»º`context`ä»£ç åŒ…ï¼Œå’Œ`Context`ç±»å‹æ—¶çš„åˆè¡·ã€‚

å¦‚æœæˆ‘ä»¬å»æŸ¥çœ‹`net`åŒ…å’Œ`database/sql`åŒ…çš„APIå’Œæºç çš„è¯ï¼Œå°±å¯ä»¥äº†è§£å®ƒä»¬åœ¨è¿™æ–¹é¢çš„å…¸å‹åº”ç”¨ã€‚

### é—®é¢˜2ï¼šæ’¤é”€ä¿¡å·æ˜¯å¦‚ä½•åœ¨ä¸Šä¸‹æ–‡æ ‘ä¸­ä¼ æ’­çš„ï¼Ÿ

æˆ‘åœ¨å‰é¢è®²äº†ï¼Œ`context`åŒ…ä¸­åŒ…å«äº†å››ä¸ªç”¨äºç¹è¡`Context`å€¼çš„å‡½æ•°ã€‚å…¶ä¸­çš„`WithCancel`ã€`WithDeadline`å’Œ`WithTimeout`éƒ½æ˜¯è¢«ç”¨æ¥åŸºäºç»™å®šçš„`Context`å€¼äº§ç”Ÿå¯æ’¤é”€çš„å­å€¼çš„ã€‚

`context`åŒ…çš„`WithCancel`å‡½æ•°åœ¨è¢«è°ƒç”¨åä¼šäº§ç”Ÿä¸¤ä¸ªç»“æœå€¼ã€‚ç¬¬ä¸€ä¸ªç»“æœå€¼å°±æ˜¯é‚£ä¸ªå¯æ’¤é”€çš„`Context`å€¼ï¼Œè€Œç¬¬äºŒä¸ªç»“æœå€¼åˆ™æ˜¯ç”¨äºè§¦å‘æ’¤é”€ä¿¡å·çš„å‡½æ•°ã€‚

åœ¨æ’¤é”€å‡½æ•°è¢«è°ƒç”¨ä¹‹åï¼Œå¯¹åº”çš„`Context`å€¼ä¼šå…ˆå…³é—­å®ƒå†…éƒ¨çš„æ¥æ”¶é€šé“ï¼Œä¹Ÿå°±æ˜¯å®ƒçš„`Done`æ–¹æ³•ä¼šè¿”å›çš„é‚£ä¸ªé€šé“ã€‚

ç„¶åï¼Œå®ƒä¼šå‘å®ƒçš„æ‰€æœ‰å­å€¼ï¼ˆæˆ–è€…è¯´å­èŠ‚ç‚¹ï¼‰ä¼ è¾¾æ’¤é”€ä¿¡å·ã€‚è¿™äº›å­å€¼ä¼šå¦‚æ³•ç‚®åˆ¶ï¼ŒæŠŠæ’¤é”€ä¿¡å·ç»§ç»­ä¼ æ’­ä¸‹å»ã€‚æœ€åï¼Œè¿™ä¸ª`Context`å€¼ä¼šæ–­å¼€å®ƒä¸å…¶çˆ¶å€¼ä¹‹é—´çš„å…³è”ã€‚

![](https://static001.geekbang.org/resource/image/a8/9e/a801f8f2b5e89017ec2857bc1815fc9e.png?wh=1112%2A647)

ï¼ˆåœ¨ä¸Šä¸‹æ–‡æ ‘ä¸­ä¼ æ’­æ’¤é”€ä¿¡å·ï¼‰

æˆ‘ä»¬é€šè¿‡è°ƒç”¨`context`åŒ…çš„`WithDeadline`å‡½æ•°æˆ–è€…`WithTimeout`å‡½æ•°ç”Ÿæˆçš„`Context`å€¼ä¹Ÿæ˜¯å¯æ’¤é”€çš„ã€‚å®ƒä»¬ä¸ä½†å¯ä»¥è¢«æ‰‹åŠ¨æ’¤é”€ï¼Œè¿˜ä¼šä¾æ®åœ¨ç”Ÿæˆæ—¶è¢«ç»™å®šçš„è¿‡æœŸæ—¶é—´ï¼Œè‡ªåŠ¨åœ°è¿›è¡Œå®šæ—¶æ’¤é”€ã€‚è¿™é‡Œå®šæ—¶æ’¤é”€çš„åŠŸèƒ½æ˜¯å€ŸåŠ©å®ƒä»¬å†…éƒ¨çš„è®¡æ—¶å™¨æ¥å®ç°çš„ã€‚

å½“è¿‡æœŸæ—¶é—´åˆ°è¾¾æ—¶ï¼Œè¿™ä¸¤ç§`Context`å€¼çš„è¡Œä¸ºä¸`Context`å€¼è¢«æ‰‹åŠ¨æ’¤é”€æ—¶çš„è¡Œä¸ºæ˜¯å‡ ä¹ä¸€è‡´çš„ï¼Œåªä¸è¿‡å‰è€…ä¼šåœ¨æœ€ååœæ­¢å¹¶é‡Šæ”¾æ‰å…¶å†…éƒ¨çš„è®¡æ—¶å™¨ã€‚

æœ€åè¦æ³¨æ„ï¼Œé€šè¿‡è°ƒç”¨`context.WithValue`å‡½æ•°å¾—åˆ°çš„`Context`å€¼æ˜¯ä¸å¯æ’¤é”€çš„ã€‚æ’¤é”€ä¿¡å·åœ¨è¢«ä¼ æ’­æ—¶ï¼Œè‹¥é‡åˆ°å®ƒä»¬åˆ™ä¼šç›´æ¥è·¨è¿‡ï¼Œå¹¶è¯•å›¾å°†ä¿¡å·ç›´æ¥ä¼ ç»™å®ƒä»¬çš„å­å€¼ã€‚

### é—®é¢˜ 3ï¼šæ€æ ·é€šè¿‡`Context`å€¼æºå¸¦æ•°æ®ï¼Ÿæ€æ ·ä»ä¸­è·å–æ•°æ®ï¼Ÿ

æ—¢ç„¶è°ˆåˆ°äº†`context`åŒ…çš„`WithValue`å‡½æ•°ï¼Œæˆ‘ä»¬å°±æ¥è¯´è¯´`Context`å€¼æºå¸¦æ•°æ®çš„æ–¹å¼ã€‚

`WithValue`å‡½æ•°åœ¨äº§ç”Ÿæ–°çš„`Context`å€¼ï¼ˆä»¥ä¸‹ç®€ç§°å«æ•°æ®çš„`Context`å€¼ï¼‰çš„æ—¶å€™éœ€è¦ä¸‰ä¸ªå‚æ•°ï¼Œå³ï¼šçˆ¶å€¼ã€é”®å’Œå€¼ã€‚ä¸â€œå­—å…¸å¯¹äºé”®çš„çº¦æŸâ€ç±»ä¼¼ï¼Œè¿™é‡Œé”®çš„ç±»å‹å¿…é¡»æ˜¯å¯åˆ¤ç­‰çš„ã€‚

åŸå› å¾ˆç®€å•ï¼Œå½“æˆ‘ä»¬ä»ä¸­è·å–æ•°æ®çš„æ—¶å€™ï¼Œå®ƒéœ€è¦æ ¹æ®ç»™å®šçš„é”®æ¥æŸ¥æ‰¾å¯¹åº”çš„å€¼ã€‚ä¸è¿‡ï¼Œè¿™ç§`Context`å€¼å¹¶ä¸æ˜¯ç”¨å­—å…¸æ¥å­˜å‚¨é”®å’Œå€¼çš„ï¼Œåä¸¤è€…åªæ˜¯è¢«ç®€å•åœ°å­˜å‚¨åœ¨å‰è€…çš„ç›¸åº”å­—æ®µä¸­è€Œå·²ã€‚

`Context`ç±»å‹çš„`Value`æ–¹æ³•å°±æ˜¯è¢«ç”¨æ¥è·å–æ•°æ®çš„ã€‚åœ¨æˆ‘ä»¬è°ƒç”¨å«æ•°æ®çš„`Context`å€¼çš„`Value`æ–¹æ³•æ—¶ï¼Œå®ƒä¼šå…ˆåˆ¤æ–­ç»™å®šçš„é”®ï¼Œæ˜¯å¦ä¸å½“å‰å€¼ä¸­å­˜å‚¨çš„é”®ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰å°±æŠŠè¯¥å€¼ä¸­å­˜å‚¨çš„å€¼ç›´æ¥è¿”å›ï¼Œå¦åˆ™å°±åˆ°å…¶çˆ¶å€¼ä¸­ç»§ç»­æŸ¥æ‰¾ã€‚

å¦‚æœå…¶çˆ¶å€¼ä¸­ä»ç„¶æœªå­˜å‚¨ç›¸ç­‰çš„é”®ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•å°±ä¼šæ²¿ç€ä¸Šä¸‹æ–‡æ ¹èŠ‚ç‚¹çš„æ–¹å‘ä¸€è·¯æŸ¥æ‰¾ä¸‹å»ã€‚

æ³¨æ„ï¼Œé™¤äº†å«æ•°æ®çš„`Context`å€¼ä»¥å¤–ï¼Œå…¶ä»–å‡ ç§`Context`å€¼éƒ½æ˜¯æ— æ³•æºå¸¦æ•°æ®çš„ã€‚å› æ­¤ï¼Œ`Context`å€¼çš„`Value`æ–¹æ³•åœ¨æ²¿è·¯æŸ¥æ‰¾çš„æ—¶å€™ï¼Œä¼šç›´æ¥è·¨è¿‡é‚£å‡ ç§å€¼ã€‚

å¦‚æœæˆ‘ä»¬è°ƒç”¨çš„`Value`æ–¹æ³•çš„æ‰€å±å€¼æœ¬èº«å°±æ˜¯ä¸å«æ•°æ®çš„ï¼Œé‚£ä¹ˆå®é™…è°ƒç”¨çš„å°±å°†ä¼šæ˜¯å…¶çˆ¶è¾ˆæˆ–ç¥–è¾ˆçš„`Value`æ–¹æ³•ã€‚è¿™æ˜¯ç”±äºè¿™å‡ ç§`Context`å€¼çš„å®é™…ç±»å‹ï¼Œéƒ½å±äºç»“æ„ä½“ç±»å‹ï¼Œå¹¶ä¸”å®ƒä»¬éƒ½æ˜¯é€šè¿‡â€œå°†å…¶çˆ¶å€¼åµŒå…¥åˆ°è‡ªèº«â€ï¼Œæ¥è¡¨è¾¾çˆ¶å­å…³ç³»çš„ã€‚

æœ€åï¼Œæé†’ä¸€ä¸‹ï¼Œ`Context`æ¥å£å¹¶æ²¡æœ‰æä¾›æ”¹å˜æ•°æ®çš„æ–¹æ³•ã€‚å› æ­¤ï¼Œåœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡åœ¨ä¸Šä¸‹æ–‡æ ‘ä¸­æ·»åŠ å«æ•°æ®çš„`Context`å€¼æ¥å­˜å‚¨æ–°çš„æ•°æ®ï¼Œæˆ–è€…é€šè¿‡æ’¤é”€æ­¤ç§å€¼çš„çˆ¶å€¼ä¸¢å¼ƒæ‰ç›¸åº”çš„æ•°æ®ã€‚å¦‚æœä½ å­˜å‚¨åœ¨è¿™é‡Œçš„æ•°æ®å¯ä»¥ä»å¤–éƒ¨æ”¹å˜ï¼Œé‚£ä¹ˆå¿…é¡»è‡ªè¡Œä¿è¯å®‰å…¨ã€‚

## æ€»ç»“

æˆ‘ä»¬ä»Šå¤©ä¸»è¦è®¨è®ºçš„æ˜¯`context`åŒ…ä¸­çš„å‡½æ•°å’Œ`Context`ç±»å‹ã€‚è¯¥åŒ…ä¸­çš„å‡½æ•°éƒ½æ˜¯ç”¨äºäº§ç”Ÿæ–°çš„`Context`ç±»å‹å€¼çš„ã€‚`Context`ç±»å‹æ˜¯ä¸€ä¸ªå¯ä»¥å¸®åŠ©æˆ‘ä»¬å®ç°å¤šgoroutineåä½œæµç¨‹çš„åŒæ­¥å·¥å…·ã€‚ä¸ä½†å¦‚æ­¤ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æ­¤ç±»å‹çš„å€¼ä¼ è¾¾æ’¤é”€ä¿¡å·æˆ–ä¼ é€’æ•°æ®ã€‚

`Context`ç±»å‹çš„å®é™…å€¼å¤§ä½“ä¸Šåˆ†ä¸ºä¸‰ç§ï¼Œå³ï¼šæ ¹`Context`å€¼ã€å¯æ’¤é”€çš„`Context`å€¼å’Œå«æ•°æ®çš„`Context`å€¼ã€‚æ‰€æœ‰çš„`Context`å€¼å…±åŒæ„æˆäº†ä¸€é¢—ä¸Šä¸‹æ–‡æ ‘ã€‚è¿™æ£µæ ‘çš„ä½œç”¨åŸŸæ˜¯å…¨å±€çš„ï¼Œè€Œæ ¹`Context`å€¼å°±æ˜¯è¿™æ£µæ ‘çš„æ ¹ã€‚å®ƒæ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå¹¶ä¸”ä¸æä¾›ä»»ä½•é¢å¤–çš„åŠŸèƒ½ã€‚

å¯æ’¤é”€çš„`Context`å€¼åˆåˆ†ä¸ºï¼šåªå¯æ‰‹åŠ¨æ’¤é”€çš„`Context`å€¼ï¼Œå’Œå¯ä»¥å®šæ—¶æ’¤é”€çš„`Context`å€¼ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ç”Ÿæˆå®ƒä»¬æ—¶å¾—åˆ°çš„æ’¤é”€å‡½æ•°æ¥å¯¹å…¶è¿›è¡Œæ‰‹åŠ¨çš„æ’¤é”€ã€‚å¯¹äºåè€…ï¼Œå®šæ—¶æ’¤é”€çš„æ—¶é—´å¿…é¡»åœ¨ç”Ÿæˆæ—¶å°±å®Œå…¨ç¡®å®šï¼Œå¹¶ä¸”ä¸èƒ½æ›´æ”¹ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿‡æœŸæ—¶é—´è¾¾åˆ°ä¹‹å‰ï¼Œå¯¹å…¶è¿›è¡Œæ‰‹åŠ¨çš„æ’¤é”€ã€‚

ä¸€æ—¦æ’¤é”€å‡½æ•°è¢«è°ƒç”¨ï¼Œæ’¤é”€ä¿¡å·å°±ä¼šç«‹å³è¢«ä¼ è¾¾ç»™å¯¹åº”çš„`Context`å€¼ï¼Œå¹¶ç”±è¯¥å€¼çš„`Done`æ–¹æ³•è¿”å›çš„æ¥æ”¶é€šé“è¡¨è¾¾å‡ºæ¥ã€‚

â€œæ’¤é”€â€è¿™ä¸ªæ“ä½œæ˜¯`Context`å€¼èƒ½å¤Ÿåè°ƒå¤šä¸ªgoroutineçš„å…³é”®æ‰€åœ¨ã€‚æ’¤é”€ä¿¡å·æ€»æ˜¯ä¼šæ²¿ç€ä¸Šä¸‹æ–‡æ ‘å¶å­èŠ‚ç‚¹çš„æ–¹å‘ä¼ æ’­å¼€æ¥ã€‚

å«æ•°æ®çš„`Context`å€¼å¯ä»¥æºå¸¦æ•°æ®ã€‚æ¯ä¸ªå€¼éƒ½å¯ä»¥å­˜å‚¨ä¸€å¯¹é”®å’Œå€¼ã€‚åœ¨æˆ‘ä»¬è°ƒç”¨å®ƒçš„`Value`æ–¹æ³•çš„æ—¶å€™ï¼Œå®ƒä¼šæ²¿ç€ä¸Šä¸‹æ–‡æ ‘çš„æ ¹èŠ‚ç‚¹çš„æ–¹å‘é€ä¸ªå€¼çš„è¿›è¡ŒæŸ¥æ‰¾ã€‚å¦‚æœå‘ç°ç›¸ç­‰çš„é”®ï¼Œå®ƒå°±ä¼šç«‹å³è¿”å›å¯¹åº”çš„å€¼ï¼Œå¦åˆ™å°†åœ¨æœ€åè¿”å›`nil`ã€‚

å«æ•°æ®çš„`Context`å€¼ä¸èƒ½è¢«æ’¤é”€ï¼Œè€Œå¯æ’¤é”€çš„`Context`å€¼åˆæ— æ³•æºå¸¦æ•°æ®ã€‚ä½†æ˜¯ï¼Œç”±äºå®ƒä»¬å…±åŒç»„æˆäº†ä¸€ä¸ªæœ‰æœºçš„æ•´ä½“ï¼ˆå³ä¸Šä¸‹æ–‡æ ‘ï¼‰ï¼Œæ‰€ä»¥åœ¨åŠŸèƒ½ä¸Šè¦æ¯”`sync.WaitGroup`å¼ºå¤§å¾—å¤šã€‚

## æ€è€ƒé¢˜

ä»Šå¤©çš„æ€è€ƒé¢˜æ˜¯ï¼š`Context`å€¼åœ¨ä¼ è¾¾æ’¤é”€ä¿¡å·çš„æ—¶å€™æ˜¯å¹¿åº¦ä¼˜å…ˆçš„ï¼Œè¿˜æ˜¯æ·±åº¦ä¼˜å…ˆçš„ï¼Ÿå…¶ä¼˜åŠ¿å’ŒåŠ£åŠ¿éƒ½æ˜¯ä»€ä¹ˆï¼Ÿ

[æˆ³æ­¤æŸ¥çœ‹Goè¯­è¨€ä¸“æ æ–‡ç« é…å¥—è¯¦ç»†ä»£ç ã€‚](https://github.com/hyper0x/Golang_Puzzlers)
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>æ‹‚å°˜</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<p>@éƒè€å¸ˆ æœ‰å‡ ç‚¹ç–‘é—®çƒ¦åŠ³å›ç­”ä¸‹ï¼Œè°¢è°¢ï¼
1ã€åœ¨coordinateWithContextçš„ä¾‹å­ä¸­ï¼Œæ€»å…±æœ‰12ä¸ªå­goroutineè¢«åˆ›å»ºï¼Œç¬¬12ä¸ªå³æœ€åä¸€ä¸ªå­goroutineåœ¨è¿è¡Œç»“æŸæ—¶ï¼Œä¼šé€šè¿‡è®¡ç®—deferè¡¨è¾¾å¼ä»è€Œè§¦å‘cancelFuncçš„è°ƒç”¨ï¼Œä»è€Œé€šçŸ¥ä¸»goroutineç»“æŸåœ¨ctx.Doneä¸Šè·å–é€šé“çš„æ¥æ”¶ç­‰å¾…ã€‚æˆ‘çš„é—®é¢˜æ˜¯ï¼Œåœ¨ç¬¬12ä¸ªå­goroutineè®¡ç®—deferè¡¨è¾¾å¼çš„æ—¶å€™ï¼Œä¼šä¸ä¼šå­˜åœ¨ifæ¡ä»¶ä¸æ»¡è¶³ï¼Œæœªæ‰§è¡Œåˆ°cancelFuncçš„æƒ…å†µï¼Ÿæˆ–è€…è¯´ï¼Œåœ¨æ­¤æ—¶ï¼Œç¬¬1åˆ°ç¬¬11çš„å­goroutineä¸­ï¼Œä¼šå­˜åœ¨è‡ªæ—‹casæœªæ‰§è¡Œå®Œçš„æƒ…å†µå—ï¼Ÿå¦‚æœè¿™ç§æƒ…å†µæœ‰ï¼Œæ˜¯å¦ä¼šå¯¼è‡´ä¸»goroutineæ°¸è¿œé˜»å¡çš„æƒ…å†µï¼Ÿ
2ã€åœ¨æ’¤é”€å‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œåœ¨å½“å‰contextä¸Šï¼Œé€šè¿‡contex.Doneè·å–çš„é€šé“ä¼šé©¬ä¸Šæ„ŸçŸ¥åˆ°å—ï¼Ÿè¿˜æ˜¯ä¼šåŒæ­¥ç­‰å¾…ï¼Œä½¿æ’¤é”€ä¿¡å·åœ¨å½“å‰contextçš„æ‰€æœ‰subtreeä¸Šçš„æ‰€æœ‰contextä¼ æ’­å®Œæˆåï¼Œå†æ„ŸçŸ¥åˆ°ï¼Ÿè¿˜æ˜¯æœ‰å…¶ä»–æƒ…å†µï¼Ÿ
3ã€WithDeadlineå’ŒWithTimeoutçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿå…·ä½“è¯´ï¼Œdeadlineæ˜¯é’ˆå¯¹æŸä¸ªå…·ä½“æ—¶é—´ï¼Œè€Œtimeoutæ˜¯é’ˆå¯¹å½“å‰æ—¶é—´çš„å»¶æ—¶æ¥å®šä¹‰è‡ªåŠ¨æ’¤é”€æ—¶é—´å—ï¼Ÿ
æ„Ÿè°¢å›å¤ï¼</p>2020-09-05</li><br/><li><span>Shawn</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>çœ‹ä»£ç æ˜¯æ·±åº¦ä¼˜å…ˆï¼Œä½†æ˜¯æˆ‘è‡ªå·±å†™äº†demoï¼Œé¡ºåºæ˜¯ä¹±çš„ï¼Œæ±‚è€å¸ˆè®²è§£</p>2018-10-25</li><br/><li><span>mclee</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<p>
å®æµ‹äº†ä¸‹ï¼Œcontext.WithValue å¾—åˆ°çš„æ–°çš„ ctx å½“å…¶ parent context cancle æ—¶ä¹Ÿèƒ½æ”¶åˆ° done ä¿¡å·å•Šï¼Œå¹¶ä¸æ˜¯æ–‡ä¸­è¯´çš„é‚£æ ·ä¼šè·³è¿‡ï¼

package main

import (
	&quot;context&quot;
	&quot;fmt&quot;
	&quot;time&quot;
)

func main() {
	ctx1, cancelFun := context.WithCancel(context.Background())
	ctx2 := context.WithValue(ctx1, &quot;&quot;, &quot;&quot;)
	ctx3, _ := context.WithCancel(ctx1)

	go watch(ctx1, &quot;ctx1&quot;)
	go watch(ctx2, &quot;ctx2&quot;)
	go watch(ctx3, &quot;ctx3&quot;)

	time.Sleep(2 * time.Second)
	fmt.Println(&quot;å¯ä»¥äº†ï¼Œé€šçŸ¥ç›‘æ§åœæ­¢&quot;)
	cancelFun()

	&#47;&#47;ä¸ºäº†æ£€æµ‹ç›‘æ§è¿‡æ˜¯å¦åœæ­¢ï¼Œå¦‚æœæ²¡æœ‰ç›‘æ§è¾“å‡ºï¼Œå°±è¡¨ç¤ºåœæ­¢äº†
	time.Sleep(5 * time.Second)

}

func watch(ctx context.Context, name string) {
	for {
		select {
		case &lt;-ctx.Done():
			fmt.Println(name,&quot;ç›‘æ§é€€å‡ºï¼Œåœæ­¢äº†...&quot;)
			return
		default:
			fmt.Println(name,&quot;goroutineç›‘æ§ä¸­...&quot;)
			time.Sleep(2 * time.Second)
		}
	}
}
</p>2022-02-11</li><br/><li><span>èŒ´é¦™æ ¹</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç•™è¨€åŒºå¾ˆå¤šäººè¯´Context æ˜¯æ·±åº¦ä¼˜å…ˆï¼Œä½†æ˜¯æˆ‘åœ¨æƒ³æ¯ä¸ªgoroutine è¢«è°ƒç”¨çš„é¡ºåºéƒ½æ˜¯ä¸ç¡®å®šçš„ï¼Œå› æ­¤åœ¨ç¼–å†™goroutine ä»£ç æ—¶ï¼Œå®é™…çš„æ’¤é”€å“åº”ä¸èƒ½å‡å®šå…¶çˆ¶æˆ–å­context æ‰€åœ¨çš„goroutineä¸€å®šå…ˆæˆ–è€…åç»“æŸã€‚</p>2019-07-25</li><br/><li><span>Cutler</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>cotext.backround()å’Œcotext.todo()æœ‰ä»€ä¹ˆåŒºåˆ«</p>2019-04-09</li><br/><li><span>é²²é¹é£ä¹ä¸‡é‡Œ</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œæ‚¨è¿˜èƒ½çœ‹åˆ°æˆ‘çš„ç•™è¨€å—ï¼Œç°åœ¨å·²ç»æ˜¯2023å¹´äº†ã€‚æ‚¨çœ‹æˆ‘ä¸‹é¢çš„ä»£ç ï¼Œæ¯”æ‚¨çš„ä»£ç å°‘äº†ä¸€å¥time.Sleep(time.Millisecond * 200)ï¼Œ ä¹‹åï¼Œæ‰“å°çš„ç»“æœå°±æ˜¯é”™çš„ï¼Œåªæ‰“å°äº†12ä¸ªæ•°ï¼Œæ‚¨èƒ½ç»™è§£é‡Šä¸€ä¸‹å—ã€‚ï¼ˆæˆ‘è¿è¡Œç¯å¢ƒæ˜¯ï¼šgo version go1.18.3 darwin&#47;amd64ï¼Œ 2.3 GHz å››æ ¸Intel Core i5ï¼‰
func main() {
	&#47;&#47; coordinateWithWaitGroup()
	coordinateWithContext()
}

func coordinateWithContext() {
	total := 12
	var num int32
	fmt.Printf(&quot;The number: %d [with context.Context]\n&quot;, num)
	cxt, cancelFunc := context.WithCancel(context.Background())
	for i := 1; i &lt;= total; i++ {
		go addNum(&amp;num, i, func() {
			&#47;&#47; å¦‚æœæ‰€æœ‰çš„addNumå‡½æ•°éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œé‚£ä¹ˆå°±ç«‹å³åˆ†å‘å­ä»»åŠ¡çš„goroutine
			&#47;&#47; è¿™é‡Œåˆ†å‘å­ä»»åŠ¡çš„goroutineï¼Œå°±æ˜¯æ‰§è¡Œ coordinateWithContext å‡½æ•°çš„goroutine.
			if atomic.LoadInt32(&amp;num) == int32(total) {
				&#47;&#47; &lt;-cxt.Done() é’ˆå¯¹è¯¥å‡½æ•°è¿”å›çš„é€šé“è¿›è¡Œæ¥æ”¶æ“ä½œã€‚
				&#47;&#47; cancelFunc() å‡½æ•°è¢«è°ƒç”¨ï¼Œé’ˆå¯¹è¯¥é€šé“çš„æ¥æ”¶ä¼šé©¬ä¸Šç»“æŸã€‚
				&#47;&#47; æ‰€ä»¥ï¼Œè¿™æ ·åšå°±å¯ä»¥å®ç°â€œç­‰å¾…æ‰€æœ‰çš„addNumå‡½æ•°éƒ½æ‰§è¡Œå®Œæ¯•â€çš„åŠŸèƒ½
				cancelFunc()
			}
		})
	}
	&lt;-cxt.Done()
	fmt.Println(&quot;end.&quot;)
}

func addNum(numP *int32, id int, deferFunc func()) {
	defer func() {
		deferFunc()
	}()
	for i := 0; ; i++ {
		currNum := atomic.LoadInt32(numP)
		newNum := currNum + 1
		&#47;&#47; time.Sleep(time.Millisecond * 200)
		if atomic.CompareAndSwapInt32(numP, currNum, newNum) {
			fmt.Printf(&quot;The number: %d [%d-%d]\n&quot;, newNum, id, i)
			break
		} else {
			fmt.Printf(&quot;The CAS option failed. [%d-%d]\n&quot;, id, i)
		}
	}
}

è¿è¡Œçš„ç»“æœä¸ºï¼š
$ go run demo01.go
The number: 0 [with context.Context]
The number: 1 [12-0]
The number: 2 [1-0]
The number: 3 [2-0]
The number: 4 [3-0]
The number: 5 [4-0]
The number: 6 [9-0]
The number: 7 [10-0]
The number: 8 [11-0]
The number: 10 [6-0]
The number: 11 [5-0]
The number: 9 [8-0]
end.


</p>2023-01-09</li><br/><li><span>hunterlodge</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>â€œç”±äºContextç±»å‹å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œè€ŒcontextåŒ…ä¸­å®ç°è¯¥æ¥å£çš„æ‰€æœ‰ç§æœ‰ç±»å‹ï¼Œéƒ½æ˜¯åŸºäºæŸä¸ªæ•°æ®ç±»å‹çš„æŒ‡é’ˆç±»å‹ï¼Œæ‰€ä»¥ï¼Œå¦‚æ­¤ä¼ æ’­å¹¶ä¸ä¼šå½±å“è¯¥ç±»å‹å€¼çš„åŠŸèƒ½å’Œå®‰å…¨ã€‚â€
è¯·é—®è€å¸ˆï¼Œè¿™å¥è¯ä¸­çš„ã€Œæ‰€ä»¥ã€äºŒå­—æ€ä¹ˆç†è§£å‘¢ï¼ŸæŒ‡é’ˆä¸æ˜¯ä¼šå¯¼è‡´æ•°æ®å…±äº«å’Œç«äº‰å—ï¼Ÿä¸ºä»€ä¹ˆåè€Œæ˜¯å®‰å…¨çš„å‘¢ï¼Ÿè°¢è°¢ï¼</p>2021-05-05</li><br/><li><span>moooofly</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>â€œå®ƒä¼šå‘å®ƒçš„æ‰€æœ‰å­å€¼ï¼ˆæˆ–è€…è¯´å­èŠ‚ç‚¹ï¼‰ä¼ è¾¾æ’¤é”€ä¿¡å·ã€‚è¿™äº›å­å€¼ä¼šå¦‚æ³•ç‚®åˆ¶ï¼ŒæŠŠæ’¤é”€ä¿¡å·ç»§ç»­ä¼ æ’­ä¸‹å»ã€‚æœ€åï¼Œè¿™ä¸ª Context å€¼ä¼šæ–­å¼€å®ƒä¸å…¶çˆ¶å€¼ä¹‹é—´çš„å…³è”ã€‚â€--è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘èƒ½ç†è§£ï¼Œå½“åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡æ ‘ä¸Šçš„æŸä¸ª node ä¸Šè§¦å‘ cancel ä¿¡å·æ—¶ï¼Œä»¥è¯¥ node ä¸ºæ ¹çš„å­ä¸Šä¸‹æ–‡æ ‘ä¼šä»åŸæ¥çš„æ ‘ä¸Šæ–­å¼€ï¼›è€Œæ–‡ä¸­åˆæåˆ°â€œæ’¤é”€ä¿¡å·åœ¨è¢«ä¼ æ’­æ—¶ï¼Œè‹¥é‡åˆ°å®ƒä»¬ï¼ˆè°ƒç”¨ context.WithValue å‡½æ•°å¾—åˆ°çš„ Context å€¼ï¼‰åˆ™ä¼šç›´æ¥è·¨è¿‡â€ ï¼Œé‚£ä¹ˆï¼Œè¿™äº›è¢«â€œè·¨è¿‡â€çš„ node ï¼Œåœ¨ä¸Šé¢è¯´çš„å­ä¸Šä¸‹æ–‡æ ‘æ–­å¼€çš„è¿‡ç¨‹é‡Œï¼Œæ˜¯ä¸€èµ·æ–­å¼€äº†ï¼Ÿè¿˜æ˜¯ä»æ—§ä¼šå’Œæ›´ä¸Šå±‚çš„ node èŠ‚ç‚¹æœ‰å…³è”ï¼Ÿ</p>2019-09-30</li><br/><li><span>æµ·ç›—èˆ¹é•¿</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å®é™…ä½¿ç”¨ä¸­ http.ReverseProxyç»å¸¸ä¼šæŠ¥ proxy errorï¼šcontext canceled è¯·é—®è€å¸ˆæœ‰å“ªäº›åŸå› å¯èƒ½å¯¼è‡´è¿™ä¸ªé—®é¢˜</p>2019-09-02</li><br/><li><span>é—«é£</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç¹è¡ä¸€è¯çš„ç¿»è¯‘æœ‰äº›ç”Ÿç¡¬ï¼Œæ˜¯å¦èƒ½æ¢ä¸€ä¸ªå¥½ç†è§£ä¸€äº›çš„ä¸­æ–‡è¯æ±‡</p>2019-07-16</li><br/><li><span>å°šæ©</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œä½ çš„å›¾æ˜¯ç”¨ä»€ä¹ˆå·¥å…·ç”»çš„ï¼Ÿ
</p>2024-02-19</li><br/><li><span>å¯»é£</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>Contextå¯ä»¥çœ‹ä½œæ˜¯æŸä¸ªçˆ¶goroutineçš„ä¸€ä¸ªå˜é‡,å¹¶ä¸”è¿™ä¸ªå˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„, å½“è¿™ä¸ªå˜é‡ä¼ å…¥å­çš„goroutineå, å°±æ„å‘³ç€çˆ¶goroutineå’Œå­goroutineå¯ä»¥é€šè¿‡è¿™ä¸ªå˜é‡æ¥è¿›è¡Œä¿¡æ¯äº¤äº’?
æˆ–è€…Contextæ˜¯ä¸€ä¸ªç‹¬ç«‹ç”³è¯·çš„çš„å†…å­˜åŒºåŸŸ, çˆ¶goroutineå’Œå­goroutineéƒ½æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å®ƒ, è¿™æ ·å°±å¯ä»¥é€šè¿‡è¿™å—å…±äº«çš„å†…å­˜è¿›è¡Œä¿¡æ¯äº¤äº’äº†?
</p>2022-05-11</li><br/><li><span>jxs1211</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>coordinateWithContextä¸­ï¼Œå¦‚æœæ”¹æˆWithTimeoutåˆ›å»ºctxçš„è¯ï¼Œä¸»goroutineåªè¦&lt;-ctx.Done()æ¥æ”¶åˆ°æŒ‚å£é€šé“çš„ä¿¡å·åå°±ä¼šç«‹é©¬è§£é™¤é˜»å¡ï¼Œè€Œæ‰§è¡Œé€€å‡ºï¼Œè¿™ä¸ªæ—¶å€™å³ä½¿forä¸­çš„å­goroutineè¿˜æ²¡æœ‰æ‰§è¡Œå®Œæˆä¹Ÿä¼šè¢«å¼ºåˆ¶é€€å‡ºäº†ï¼Œè¿™æ ·æƒ…å†µä¸‹æŸä¸ªå­goroutineæ‰§è¡Œåˆ°ä¸€åŠçš„æ—¶å€™ï¼Œä¼šè¢«â€˜ä¸­æ–­â€™ï¼Œæ„Ÿè§‰ä¸Šæ²¡æœ‰å¾—åˆ°å…¬å¹³çš„å¯¹å¾…ï¼Œä¸ªäººç†è§£çš„cpuåœ¨goroutineä¸­è°ƒåº¦ï¼Œå¦‚æœè¶³å¤Ÿå…¬å¹³çš„è¯ï¼Œè‡³å°‘è¦åœ¨ç­‰åˆ°å½“å‰æ‰§è¡Œçš„goroutineé˜»å¡è€Œè®©å‡ºcpuï¼Œæ‰åˆ‡åˆ°å…¶ä»–goroutineæ‰§è¡Œï¼Œè¿˜æ˜¯æˆ‘ç†è§£é”™äº†ï¼Œcpuå°±æ˜¯ä¸åœçš„åœ¨å„ä¸ªgoroutineé—´åˆ‡æ¥æ¥å»çš„æ‰§è¡Œï¼Œè€Œä¸ç®¡æŸä¸ªgoroutineæœ‰æ²¡æœ‰é˜»å¡</p>2021-11-23</li><br/><li><span>jxs1211</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>waitgroupçš„æ”¹è¿›ç‰ˆä¸­ï¼Œæ¯æ‰¹å°±æ˜¯ä¸€ä¸ªwgçš„æŠ€æœ¯å‘¨æœŸï¼Œå½“å‰å¾ªç¯çš„è®¡æ•°å‘¨æœŸæ²¡æœ‰å®Œæˆï¼Œä¸‹ä¸€æ¬¡ä¸ä¼šå¼€å§‹ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯strideè¿™ä¹ˆå¤šä¸ªä¸ªgoroutineæ‰§è¡Œå®Œæˆä¹‹å‰ï¼Œæ˜¯ä¸ä¼šå¼€èµ·ä¸‹ä¸€æ‰¹goroutineçš„ï¼Œè¿™æ ·çš„è¯ï¼Œå…¶å®æ¯ä¸€æ‰¹ä¹‹é—´æ˜¯ä¸²è¡Œçš„ï¼Œå¹¶ä¸æ˜¯å¹¶å‘totalé‚£ä¹ˆå¤šgoroutineï¼Œè€Œæ˜¯åªå¹¶å‘äº†strideä¸ªgoroutineï¼Œå¯¹å—ï¼Ÿ</p>2021-11-20</li><br/><li><span>jxs1211</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>func defaultCompareAndSwapInt32(addr *int32, old, new int32) (swapped bool) {
	if old != *addr {
		return false
	}
	*addr = new
	return true
}
è¿™æ˜¯æˆ‘è‡ªå·±å†™çš„ä¸€ä¸ªæ²¡æœ‰åŸå­æ“ä½œçš„defaultCompareAndSwapInt32ï¼Œæ›¿æ¢atomic.CompareAndSwapInt32ï¼Œtotal := 120ï¼Œæµ‹è¯•çš„æ•°æ®å¥½åƒæ²¡æœ‰é”™ä¹±ï¼Œæ¯ä¸ªgoroutineçš„äº¤æ¢éƒ½æ˜¯éƒ½æ˜¯é€’å¢çš„ï¼Œæ˜¯æˆ‘ç†è§£é”™äº†å—
added from 0 to 1 --2 
added from 1 to 2 --4 
added from 2 to 3 --3 
added from 3 to 4 --5 
added from 4 to 5 --6 
added from 5 to 6 --7 
added from 6 to 7 --9 
added from 7 to 8 --8 
added from 8 to 9 --10 
added from 9 to 10 --11 
added from 10 to 11 --12 
added from 11 to 12 --13 
added from 12 to 13 --15 
added from 13 to 14 --14 
added from 14 to 15 --16 
added from 15 to 16 --18 
added from 16 to 17 --17 
added from 17 to 18 --19 
added from 18 to 19 --20 
added from 19 to 20 --22 
added from 20 to 21 --21 
added from 21 to 22 --23 
added from 22 to 23 --24 
added from 23 to 24 --25 
added from 24 to 25 --27 
added from 25 to 26 --28 
added from 26 to 27 --26 
ã€‚ã€‚ã€‚ã€‚
added from 83 to 84 --85 
added from 84 to 85 --87 
added from 85 to 86 --86 
added from 86 to 87 --88 
added from 87 to 88 --89 
added from 88 to 89 --91 
added from 89 to 90 --90 
added from 90 to 91 --93 
added from 91 to 92 --94 
added from 92 to 93 --92 
added from 93 to 94 --96 
added from 94 to 95 --97 
added from 95 to 96 --95 
added from 96 to 97 --98 
added from 97 to 98 --99 
added from 98 to 99 --100 
added from 99 to 100 --103 
added from 100 to 101 --101 
added from 101 to 102 --102 
added from 102 to 103 --104 
added from 103 to 104 --105 
added from 104 to 105 --106 
added from 105 to 106 --107 
added from 106 to 107 --108 
added from 107 to 108 --109 
added from 108 to 109 --112 
added from 109 to 110 --110 
added from 110 to 111 --111 
added from 111 to 112 --114 
added from 112 to 113 --113 
added from 113 to 114 --115 
added from 114 to 115 --117 
added from 115 to 116 --118 
added from 116 to 117 --116 
added from 117 to 118 --120 
added from 118 to 119 --119 
added from 119 to 120 --121 
</p>2021-10-26</li><br/>
</ul>