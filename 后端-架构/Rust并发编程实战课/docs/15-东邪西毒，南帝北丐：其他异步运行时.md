ä½ å¥½ï¼Œæˆ‘æ˜¯é¸Ÿçªã€‚

ä¸ŠèŠ‚è¯¾æˆ‘ä»¬é‡ç‚¹ä»‹ç»äº†Tokioè¿™ä¸ªå¼‚æ­¥è¿è¡Œæ—¶ã€‚è™½ç„¶å®ƒæ˜¯ä½¿ç”¨æœ€å¹¿æ³›çš„ä¸€ä¸ªå¼‚æ­¥è¿è¡Œæ—¶ï¼Œä½†æ˜¯ä¹Ÿå¹¶ä¸æ˜¯å®ƒä¸€å®¶ç‹¬å¤§ï¼Œè¿˜æœ‰å‡ ä¸ªä¼˜ç§€çš„è¿è¡Œæ—¶ï¼Œè¿™èŠ‚è¯¾æˆ‘ä¸€ä¸€ç»™ä½ é“æ¥ã€‚

## async-std

`async-std` å’Œå®ƒçš„ä¸€ç³»åˆ—é…å¥—åº“ï¼Œæ˜¯ä¸ºäº†è®©ä½ çš„å¼‚æ­¥ç¼–ç¨‹æ›´è½»æ¾è€Œç”Ÿçš„ã€‚å®ƒä¸ºå„ç§åº“å’Œåº”ç”¨éƒ½æä¾›äº†æœ€åŸºç¡€çš„å·¥å…·ã€‚å®ƒçš„åå­—ä¹Ÿè¯´æ˜äº†å®ƒçš„è®¾è®¡æ€è·¯ï¼š**å°½å¯èƒ½åœ°ç…§ç€ Rust æ ‡å‡†åº“æ¥åšï¼ŒæŠŠé‡Œé¢çš„ä¸œè¥¿éƒ½æ¢æˆå¼‚æ­¥çš„ç‰ˆæœ¬ã€‚**è¿™ä¹Ÿæ˜¯å®ƒçš„ç‰¹è‰²ï¼Œå’Œå…¶ä»–å¼‚æ­¥è¿è¡Œæ—¶ä¸å¤ªä¸€æ ·çš„åœ°æ–¹ã€‚

`async-std` æä¾›äº†å„ç§é‡è¦åŠŸèƒ½çš„æ¥å£ï¼šæ–‡ä»¶æ“ä½œã€ç½‘ç»œæ“ä½œï¼Œè¿˜æœ‰åƒå®šæ—¶å™¨è¿™æ ·çš„å¹¶å‘åŸºç¡€åŠŸèƒ½ã€‚å®ƒä¹Ÿæä¾›äº†ä¸€ä¸ªå«åš `task` çš„ä¸œè¥¿ï¼Œç”¨èµ·æ¥æœ‰ç‚¹åƒ Rust æ ‡å‡†åº“é‡Œçš„ `thread` æ¨¡å—ã€‚è€Œä¸”å®ƒä¸å…‰æœ‰ `I/O` ç›¸å…³çš„ï¼Œè¿˜æœ‰åƒ `Mutex` è¿™ç§ä¹Ÿèƒ½åœ¨ async/await ç¯å¢ƒä¸‹ç”¨çš„ç‰ˆæœ¬ã€‚

`async-std` å¼€å‘è€…çš„è®¾è®¡ç†å¿µå°±æ˜¯å¼‚æ­¥ Rust åº”è¯¥åƒåŒæ­¥ Rust ä¸€æ ·ç®€å•æ˜“å­¦ï¼Œæœ€å¥½çš„ API å°±æ˜¯ä½ å·²ç»ç”¨æƒ¯çš„é‚£äº›ã€‚ä»–ä»¬è®¤ä¸ºç»™æ ‡å‡†åº“é…ä¸Šå¼‚æ­¥çš„ç‰ˆæœ¬ï¼Œæ˜¯è®©å¤§å®¶æ—¢èƒ½ä¿è¯æ€§èƒ½åˆèƒ½æé«˜æ•ˆç‡çš„æœ€ä½³æ–¹æ¡ˆï¼Œå› ä¸ºæ ‡å‡†åº“æœ¬èº«å°±å¾ˆå¯é ã€‚

`async-std` å°±æ˜¯ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡è€Œç”Ÿçš„ã€‚å®ƒæŠŠå•æ¬¡å†…å­˜åˆ†é…çš„ä»»åŠ¡åˆ›å»ºæ–¹å¼ï¼Œè·Ÿä¸€ä¸ªèƒ½è‡ªåŠ¨è°ƒèŠ‚çš„æ— é”æ‰§è¡Œå™¨ã€çº¿ç¨‹æ± å’Œç½‘ç»œé©±åŠ¨ç»“åˆèµ·æ¥ï¼Œæ„æˆäº†ä¸€ä¸ªå¾ˆé¡ºç•…çš„ç³»ç»Ÿï¼Œç”¨å¤§å®¶ç†Ÿæ‚‰çš„ Rust æ ‡å‡†åº“ APIï¼Œå°±èƒ½é«˜é€Ÿã€ä½å»¶è¿Ÿåœ°å¤„ç†å„ç§ä»»åŠ¡ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/9f/ac/9f4008474e31774304ea7d3909fca3ac.png?wh=1920x839)

ä¸‹é¢æ˜¯ä¸€ä¸ªæç®€å•çš„ `async-std` ä¾‹å­ï¼š

```rust
use async_std::task;

async fn say_hello() {
    println!("Hello, world!");
}

fn main() {
    task::block_on(say_hello())
}
```

### async-std å…¥é—¨

`async-std` ä¹Ÿæä¾›äº†Tokioç±»ä¼¼çš„å±æ€§ï¼Œä»mainå‡½æ•°ä¸­å°±å¯ä»¥è°ƒç”¨å¼‚æ­¥å‡½æ•°ï¼š

```rust
async fn say_hello() {
    println!("Hello, world!");
}

#[async_std::main]
async fn main() {
    say_hello().await;
}
```

åŒ…æ‹¬æµ‹è¯•ï¼š

```rust
#[tokio::test]
async fn my_test() -> std::io::Result<()> {
    assert_eq!(2 * 2, 4);
    Ok(())
}
```

æœ‰å‡ ä¸ªç¯å¢ƒå˜é‡å¯ä»¥ç”¨æ¥é…ç½® async-std è¿è¡Œæ—¶ï¼š

- `ASYNC_STD_THREAD_COUNT`ï¼šæ§åˆ¶ async-std è¿è¡Œæ—¶å¯åŠ¨å¤šå°‘ä¸ªçº¿ç¨‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªé€»è¾‘ CPU ä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªæ•°é‡ç”± `async-global-executor` å†³å®šï¼Œå¯èƒ½è·Ÿå®é™…çš„ç‰©ç† CPU æ•°é‡ä¸ä¸€æ ·ã€‚å¦‚æœè¿™ä¸ªå˜é‡è®¾ç½®çš„ä¸æ˜¯æ­£æ•´æ•°ï¼Œasync-std å°±ä¼š panicã€‚
- `ASYNC_STD_THREAD_NAME`ï¼šè®¾ç½® async-std è¿è¡Œæ—¶çº¿ç¨‹åœ¨æ“ä½œç³»ç»Ÿé‡Œæ˜¾ç¤ºçš„åå­—ã€‚é»˜è®¤å€¼æ˜¯ `"async-std/runtime"`ã€‚

ä¹Ÿå¯ä»¥ä½¿ç”¨ `block_on` å¯åŠ¨ä¸€ä¸ªä»»åŠ¡ï¼Œç„¶åè®©å½“å‰çº¿ç¨‹ç­‰ç€ï¼Œç›´åˆ°ä»»åŠ¡è·‘å®Œæ‹¿åˆ°ç»“æœã€‚ç”¨ `block_on` è¿™ä¸ªå‡½æ•°å°±è·Ÿå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ç„¶åç«‹åˆ»ç­‰å®ƒç»“æŸå·®ä¸å¤šï¼Œåªä¸è¿‡å¯åŠ¨çš„æ˜¯å¼‚æ­¥çš„ä»»åŠ¡ã€‚

```rust
use async_std::task;

fn main() {
    task::block_on(async {
        println!("Hello, world!");
    })
}
```

### Task

ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„å¼‚æ­¥ Rust ç¨‹åºç”±ä¸€ç»„åŸç”Ÿæ“ä½œç³»ç»Ÿçº¿ç¨‹ç»„æˆï¼Œåœ¨å®ƒä¹‹ä¸Šå¤šè·¯å¤ç”¨å¤šä¸ªæ— æ ˆåç¨‹ã€‚æˆ‘ä»¬ç§°è¿™äº›ä¸ºâ€œä»»åŠ¡â€ï¼ˆTaskï¼‰ã€‚ä»»åŠ¡å¯ä»¥è¢«å‘½åï¼Œå¹¶æä¾›ä¸€äº›å†…ç½®çš„åŒæ­¥æ”¯æŒã€‚

ä»»åŠ¡ä¹‹é—´çš„é€šä¿¡å¯ä»¥é€šè¿‡é€šé“ï¼ˆRust çš„æ¶ˆæ¯ä¼ é€’ç±»å‹ï¼‰ä»¥åŠå…¶ä»–å½¢å¼çš„ä»»åŠ¡åŒæ­¥å’Œå…±äº«å†…å­˜æ•°æ®ç»“æ„æ¥å®Œæˆã€‚ç‰¹åˆ«æ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨çš„ç±»å‹å¯ä»¥ä½¿ç”¨åŸå­å¼•ç”¨è®¡æ•°å®¹å™¨ `Arc` è½»æ¾åœ°åœ¨ä»»åŠ¡ä¹‹é—´å…±äº«ã€‚

Rust ä¸­è‡´å‘½çš„é€»è¾‘é”™è¯¯ä¼šå¯¼è‡´çº¿ç¨‹ panicï¼Œåœ¨æ­¤æœŸé—´ï¼Œçº¿ç¨‹å°†å±•å¼€å †æ ˆï¼Œè¿è¡Œææ„å‡½æ•°å¹¶é‡Šæ”¾æ‹¥æœ‰çš„èµ„æºã€‚å¦‚æœ panic å‘ç”Ÿåœ¨ä»»åŠ¡å†…éƒ¨ï¼Œå°±æ²¡æœ‰æœ‰æ•ˆçš„æ–¹æ³•è¿›è¡Œæ¢å¤ï¼Œå› æ­¤ panic å°†é€šè¿‡ä»»ä½•çº¿ç¨‹è¾¹ç•Œä¸€ç›´ä¼ æ’­åˆ°æ ¹ä»»åŠ¡ã€‚è¿™ä¹Ÿå«åš **panic = abort æ¨¡å‹**ã€‚

`async-std` æä¾›äº† `async_std::task` æ¨¡å—å®ç°ä»»åŠ¡ç›¸å…³çš„åŠŸèƒ½ã€‚

#### ç”Ÿæˆä»»åŠ¡

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `task::spawn` å‡½æ•°ç”Ÿæˆä¸€ä¸ªæ–°ä»»åŠ¡ï¼š

```rust
use async_std::task;

task::spawn(async {
Â  Â  // è¿™é‡Œæ˜¯ä¸€äº›å·¥ä½œ
});
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç”Ÿæˆçš„ä»»åŠ¡ä¸å½“å‰ä»»åŠ¡â€œåˆ†ç¦»â€ã€‚è¿™æ„å‘³ç€å®ƒå¯ä»¥æ¯”å®ƒçš„çˆ¶ä»»åŠ¡ï¼ˆç”Ÿæˆå®ƒçš„ä»»åŠ¡ï¼‰æ´»å¾—æ›´ä¹…ï¼Œé™¤éæ­¤çˆ¶ä»»åŠ¡æ˜¯æ ¹ä»»åŠ¡ã€‚

æ ¹ä»»åŠ¡ä¹Ÿå¯ä»¥ç­‰å¾…å­ä»»åŠ¡å®Œæˆï¼›è°ƒç”¨ `spawn` ä¼šäº§ç”Ÿä¸€ä¸ª `JoinHandle`ï¼Œå®ƒå®ç°äº† `Future` å¹¶ä¸”å¯ä»¥è¢« `await`ï¼š

```rust
use async_std::task;

let child = task::spawn(async {
Â  Â  // è¿™é‡Œæ˜¯ä¸€äº›å·¥ä½œ
});

// è¿™é‡Œæ˜¯ä¸€äº›å·¥ä½œ

let res = child.await;
```

`await` è¿ç®—ç¬¦è¿”å›å­ä»»åŠ¡äº§ç”Ÿçš„æœ€ç»ˆå€¼ã€‚

`JoinHandle` çš„ `task` æ–¹æ³•è¿”å›å…³è”çš„Taskã€‚

`JoinHandle` çš„ `cancel` æ–¹æ³•å–æ¶ˆå…³è”çš„Taskã€‚

æœ‰ä¸‰ç§spawnå‡½æ•°ï¼š

- `spawn`ï¼šæ­¤å‡½æ•°ç±»ä¼¼äº `std::thread::spawn`ï¼Œä½†ç”¨äºç”Ÿæˆå¼‚æ­¥ä»»åŠ¡ã€‚
- `spawn_blocking`ï¼šç”Ÿæˆä¸€ä¸ªé˜»å¡ä»»åŠ¡ã€‚è¯¥ä»»åŠ¡å°†åœ¨ä¸€ä¸ªä¸“é—¨çš„é˜»å¡ä»»åŠ¡çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œä»¥é˜²æ­¢é•¿æ—¶é—´è¿è¡Œçš„åŒæ­¥æ“ä½œé˜»å¡ä¸» futures æ‰§è¡Œå™¨ã€‚
- `spawn_local`ï¼šåœ¨çº¿ç¨‹å±€éƒ¨æ‰§è¡Œå™¨ä¸Šç”Ÿæˆä»»åŠ¡ã€‚

ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº†è¿™ä¸‰ç§æ–¹æ³•çš„ç”¨æ³•ï¼š

```rust
use async_std::task;

#[async_std::main]
async fn main() {
    let v = task::spawn(async {
        1 + 2
    }).await;
    assert_eq!(v, 3);
    
    task::spawn_blocking(|| {
        println!("long-running task here");
    })
    .await;

    let v = task::spawn_local(async {
        1 + 2
    }).await;
    assert_eq!(v, 3);
}

```

#### é…ç½®ä»»åŠ¡

æˆ‘ä»¬å¯ä»¥åœ¨ç”Ÿæˆæ–°ä»»åŠ¡ä¹‹å‰é€šè¿‡ `Builder` ç±»å‹å¯¹å…¶è¿›è¡Œé…ç½®ï¼Œè¿™ä¸ªç±»å‹ç›®å‰å…è®¸ä½ è®¾ç½®å­ä»»åŠ¡çš„åç§°ï¼š

```rust
use async_std::task;

task::Builder::new().name("child1".to_string()).spawn(async {
Â  Â  println!("Hello, world!");
});
```

`Builder` ç±»å‹ä¸‰ä¸ªæ‰§è¡Œä»»åŠ¡çš„æ–¹æ³•ï¼š

- `blocking`ï¼šç”Ÿæˆä¸€ä¸ªé…ç½®å¥½çš„ä»»åŠ¡ï¼Œå¹¶åŒæ­¥ç­‰å¾…å…¶å®Œæˆã€‚
- `local`ï¼šä½¿ç”¨é…ç½®çš„è®¾ç½®åœ¨æœ¬åœ°ç”Ÿæˆä¸€ä¸ªä»»åŠ¡ã€‚
- `spawn`ï¼šä½¿ç”¨é…ç½®çš„è®¾ç½®ç”Ÿæˆä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ã€‚

#### Taskç±»å‹

ä»»åŠ¡é€šè¿‡ `Task` ç±»å‹è¡¨ç¤ºï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¹‹ä¸€è·å–å®ƒï¼š

- é€šè¿‡ç”Ÿæˆä¸€ä¸ªæ–°ä»»åŠ¡ï¼Œä¾‹å¦‚ä½¿ç”¨ `task::spawn` å‡½æ•°ï¼Œå¹¶åœ¨ `JoinHandle` ä¸Šè°ƒç”¨ `task`ã€‚
- é€šè¿‡ä½¿ç”¨ `task::current` å‡½æ•°è¯·æ±‚å½“å‰ä»»åŠ¡ï¼Œæˆ–è€…é€šè¿‡ `task::try_current` å‡½æ•°è¯·æ±‚å½“å‰çš„ä»»åŠ¡ã€‚`task::try_current` å‡½æ•°åªæœ‰åœ¨`block_on`ã€`spawn` å’ŒÂ `Builder::spawn` çš„ä¸Šä¸‹æ–‡ä¸­æ‰ä¼šè¿”å›ä»»åŠ¡ï¼Œå¦åˆ™è¿”å›Â `None`ã€‚

```rust
use async_std::task;

#[async_std::main]
async fn main() {
    task::spawn(async {
        println!("current task: {}", task::current().id());
    }).await;
    
    task::spawn_blocking(|| {
        let _ = task::Builder::new().name("child1".to_string()).spawn(async {
            println!("current task: {:?}", task::try_current());
        });
    })
    .await;
}
```

#### ä»»åŠ¡æœ¬åœ°å­˜å‚¨

`async::task` è¿˜ä¸º Rust ç¨‹åºæä¾›äº†ä¸€ä¸ªä»»åŠ¡æœ¬åœ°å­˜å‚¨çš„å®ç°ã€‚ä»»åŠ¡æœ¬åœ°å­˜å‚¨æ˜¯ä¸€ç§å°†æ•°æ®å­˜å‚¨åˆ°å…¨å±€å˜é‡çš„æ–¹æ³•ï¼Œç¨‹åºä¸­çš„æ¯ä¸ªä»»åŠ¡éƒ½å°†æ‹¥æœ‰è¯¥å˜é‡çš„å‰¯æœ¬ã€‚ä»»åŠ¡ä¸å…±äº«æ­¤æ•°æ®ï¼Œå› æ­¤è®¿é—®ä¸éœ€è¦åŒæ­¥ã€‚

LocalKeyï¼ˆä»»åŠ¡æœ¬åœ°é”®ï¼‰æ‹¥æœ‰å®ƒåŒ…å«çš„å€¼ï¼Œå¹¶åœ¨ä»»åŠ¡é€€å‡ºæ—¶é”€æ¯è¯¥å€¼ã€‚å®ƒä½¿ç”¨ `task_local!` å®åˆ›å»ºï¼Œå¹¶ä¸”å¯ä»¥åŒ…å«ä»»ä½• `'static`ï¼ˆæ— å€Ÿç”¨æŒ‡é’ˆï¼‰çš„å€¼ã€‚å®ƒæä¾›äº†ä¸€ä¸ªè®¿é—®å™¨å‡½æ•° `with`ï¼Œè¯¥å‡½æ•°å°†å¯¹è¯¥å€¼çš„å…±äº«å¼•ç”¨ä¼ é€’ç»™æŒ‡å®šçš„é—­åŒ…ã€‚LocalKeyåªå…è®¸å¯¹å€¼è¿›è¡Œå…±äº«è®¿é—®ï¼Œå› ä¸ºå¦‚æœå…è®¸å¯å˜å€Ÿç”¨ï¼Œåˆ™æ— æ³•ä¿è¯å”¯ä¸€æ€§ã€‚

LocalKeyè®¿é—®ä»»åŠ¡æœ¬åœ°å€¼çš„é”®ã€‚æ¯ä¸ªä»»åŠ¡æœ¬åœ°å€¼æ˜¯æŒ‰éœ€æƒ°æ€§åˆå§‹åŒ–çš„ï¼Œå¹¶åœ¨ä»»åŠ¡ç»“æŸåé”€æ¯ã€‚

> æŒ‰éœ€æƒ°æ€§åˆå§‹åŒ–ï¼ˆLazy Initialization on Demandï¼‰æŒ‡çš„æ˜¯èµ„æºæˆ–å¯¹è±¡çš„åˆå§‹åŒ–è¢«å»¶è¿Ÿåˆ°çœŸæ­£éœ€è¦ä½¿ç”¨å®ƒä»¬çš„æ—¶å€™æ‰è¿›è¡Œã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªLocalKeyçš„ä¾‹å­ã€‚å¦‚æœä½ å·²ç»å­¦ä¹ äº†å‰ä¸€è¯¾ï¼Œå¯¹è¿™ä¸ªLocalKeyä¸ä¼šæ„Ÿåˆ°é™Œç”Ÿã€‚äº‹å®ä¸ŠRustå„ä¸ªè¿è¡Œæ—¶åˆæœ‰å¾ˆå¤šæ¦‚å¿µéƒ½æ˜¯ç›¸é€šçš„ã€‚

```rust
use std::cell::Cell;

use async_std::task;
use async_std::prelude::*;

task_local! {
Â  Â  static VAL: Cell<u32> = Cell::new(5);
}

task::block_on(async {
Â  Â  let v = VAL.try_with(|c| c.get());
Â  Â  assert_eq!(v, Ok(5));
});

// è¿”å›error, å› ä¸ºä¸æ˜¯åœ¨ä¸€ä¸ªä»»åŠ¡ä¸­è°ƒç”¨çš„
assert!(VAL.try_with(|c| c.get()).is_err());
```

#### å‘½åä»»åŠ¡

ä»»åŠ¡å¯ä»¥æ˜¯å…·æœ‰å…³è”çš„åç§°ï¼Œç”¨æ¥è¯†åˆ«ç›®çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç”Ÿæˆçš„ä»»åŠ¡æ˜¯æœªå‘½åçš„ã€‚è¦ä¸ºä»»åŠ¡æŒ‡å®šåç§°ï¼Œéœ€è¦ä½¿ç”¨ `Builder` æ„å»ºä»»åŠ¡ï¼Œå¹¶å°†æ‰€éœ€çš„ä»»åŠ¡åç§°ä¼ é€’ç»™ `Builder::name`ã€‚ä½¿ç”¨ `Task::name` å¯ä»¥ä»ä»»åŠ¡å†…éƒ¨æ£€ç´¢ä»»åŠ¡åç§°ã€‚

#### yield\_now

ä¸»åŠ¨è®©å‡ºæ—¶é—´ç‰‡ç»™ä»»åŠ¡è°ƒåº¦å™¨ã€‚è°ƒç”¨æ­¤å‡½æ•°ä¼šå°†å½“å‰ future ç§»åˆ°æ‰§è¡Œé˜Ÿåˆ—æœ«å°¾ï¼Œè®©å…¶ä»– future æœ‰æœºä¼šæ‰§è¡Œã€‚è¿™åœ¨ future ä¸­æ‰§è¡Œ CPU å¯†é›†å‹æ“ä½œåå¾ˆæœ‰ç”¨ã€‚

```rust
use async_std::task;

#[async_std::main]
async fn main() {
    for i in 0..3 {
        task::spawn(async move{
            task::yield_now().await;
            println!("yielded in task {}", i);
        }).await;
    }

   
    task::yield_now().await;  
}
```

ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆåœ¨æ’é˜Ÿä¹°ä¸œè¥¿æ—¶ï¼Œä½ ä¸»åŠ¨è·Ÿåé¢çš„äººè¯´ï¼šâ€œä½ å…ˆæ¥å§ï¼Œæˆ‘ç­‰ç­‰æ²¡å…³ç³»ã€‚â€

#### sleep

sleep ä½¿å½“å‰å¼‚æ­¥ä»»åŠ¡æš‚åœæ‰§è¡ŒæŒ‡å®šçš„æ—¶é•¿ï¼Œè¿™ä¸ªå‡½æ•°ä¿è¯è‡³å°‘ä¼‘çœ æŒ‡å®šçš„æ—¶é•¿ï¼Œä½†å®é™…ä¼‘çœ æ—¶é—´å¯èƒ½ç•¥é•¿ã€‚è¿™ä¸ªå‡½æ•°ç›¸å½“äº `std::thread::sleep` çš„å¼‚æ­¥ç‰ˆæœ¬ï¼Œä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚

```rust
use std::time::Duration;
use async_std::task;

#[async_std::main]
async fn main() {
    task::sleep(Duration::from_secs(1)).await;

    // std::thread::sleep(Duration::from_secs(1));
}
```

æ³¨æ„åœ¨å¼‚æ­¥ä»£ç ä¸­ä¸è¦ä½¿ç”¨ `std::thread::sleep`ï¼Œå¦åˆ™ä¼šé˜»å¡è°ƒç”¨çš„çº¿ç¨‹å¯¼è‡´å…¶ä»–ä»»åŠ¡æ²¡æœ‰åŠæ³•è¢«æ‰§è¡Œï¼Œè¦ä½¿ç”¨æ­¤å¼‚æ­¥çš„ç‰ˆæœ¬ã€‚

### future

`async_std` æ¨¡å—æä¾›Futureçš„æ‰©å±•åŠŸèƒ½ã€‚

é€šå¸¸ï¼Œæˆ‘ä»¬å¸Œæœ›åƒæ“ä½œå•ä¸ª future ä¸€æ ·ç­‰å¾…å¤šä¸ª futureã€‚`join` æ“ä½œæ—å°†å¤šä¸ª future è½¬æ¢ä¸ºä¸€ä¸ªè¿”å›æ‰€æœ‰ future è¾“å‡ºçš„å•ä¸ª futureã€‚`race` æ“ä½œæ—å°†å¤šä¸ª future è½¬æ¢ä¸ºä¸€ä¸ªè¿”å›ç¬¬ä¸€ä¸ª future è¾“å‡ºçš„å•ä¸ª futureã€‚

ä»¥ä¸‹å‡½æ•°å¯ç”¨äºæ“ä½œ futureï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/a5/a2/a5154e2c846d1b4c3b4727365e4c39a2.png?wh=1920x501)

å¯¹äºè¿”å› `Result` çš„ futureï¼Œå¯ä»¥ä½¿ç”¨ä¸Šè¿°å‡½æ•°çš„é™„åŠ  `try_` å˜ä½“ã€‚è¿™äº›å‡½æ•°å¯ä»¥è¯†åˆ« `Result`ï¼Œå¹¶ä¸”å…¶è¡Œä¸ºä¸åŸºæœ¬å˜ä½“ç•¥æœ‰ä¸åŒã€‚å¯¹äº `try_join`ï¼Œå¦‚æœä»»ä½•ä¸€ä¸ª future è¿”å› `Err`ï¼Œåˆ™æ‰€æœ‰ future éƒ½å°†è¢«ä¸¢å¼ƒå¹¶è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚è¿™è¢«ç§°ä¸ºâ€œçŸ­è·¯â€ã€‚

å¯¹äº `try_race`ï¼Œå®ƒä¸ä¼šè¿”å›ç¬¬ä¸€ä¸ªå®Œæˆçš„ futureï¼Œè€Œæ˜¯è¿”å›ç¬¬ä¸€ä¸ªæˆåŠŸå®Œæˆçš„ futureã€‚è¿™æ„å‘³ç€ `try_race` å°†ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°å…¶ä¸­ä¸€ä¸ª future è¿”å› `Ok`ï¼Œæˆ–è€…æ‰€æœ‰ future éƒ½è¿”å› `Err`ã€‚

ç„¶è€Œï¼Œæœ‰æ—¶å³ä½¿å¯¹äºè¿”å› `Result` çš„ futureï¼Œä½¿ç”¨å‡½æ•°çš„åŸºæœ¬å˜ä½“ä¹Ÿå¯èƒ½å¾ˆæœ‰ç”¨ã€‚ä»¥ä¸‹æ˜¯é€‚ç”¨äº `Result` çš„æ“ä½œåŠå…¶å„è‡ªè¯­ä¹‰çš„æ¦‚è¿°ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/71/22/71ff4823b53a0c9e1dfc39fdf2617722.png?wh=1920x1055)

- `pending` å‡½æ•°è¿”å›ä¸€ä¸ªæ°¸ä¸ä¼šå®Œæˆçš„futureã€‚
- `ready` å‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡å®šå€¼çš„futureã€‚
- `timeout` å‡½æ•°ç­‰å¾…ä¸€ä¸ªfutureå®Œæˆï¼Œå¸¦è¶…æ—¶åŠŸèƒ½ï¼Œè¶…è¿‡ä¸€å®šçš„æ—¶é—´å°±ä¸å†ç­‰å¾…äº†ã€‚

æŠŠè¿™ä¸ªä¸‰ä¸ªå‡½æ•°æ”¾åœ¨ä¸€ä¸ªä¾‹å­ä¸­ï¼Œå¦‚ä¸‹ï¼š

```rust
use async_std::future;
use std::time::Duration;

#[async_std::main]
async fn main() {
    let never = future::pending::<()>();
    let dur = Duration::from_millis(5);
    assert!(future::timeout(dur, never).await.is_err());

    let val = future::ready(5);
    let dur = Duration::from_millis(5);
    assert!(future::timeout(dur, val).await.is_ok());
}
```

### io

`async_std::io` æ¨¡å—æä¾›æ ¸å¿ƒè¾“å…¥è¾“å‡ºåŠŸèƒ½çš„ traitã€è¾…åŠ©å‡½æ•°å’Œç±»å‹å®šä¹‰ã€‚å®ƒæ˜¯ç”¨äºå¼‚æ­¥ç¼–ç¨‹çš„ `std::io` æ¨¡å—çš„å¯¹åº”ç‰ˆæœ¬ã€‚è¿›è¡Œè¾“å…¥è¾“å‡ºæ“ä½œæ—¶ï¼Œè¯¥æ¨¡å—ä¼šç”¨åˆ°ä¸€äº›å¸¸ç”¨çš„ç±»å‹ã€‚

#### **Read å’Œ Write trait**

`Read` å’Œ `Write` æ˜¯ä¸¤ä¸ªæœ€ä¸ºæ ¸å¿ƒçš„ traitï¼Œç”¨äºæä¾›æœ€é€šç”¨çš„è¯»å†™æ“ä½œæ¥å£ã€‚ç”±äºå®ƒä»¬æ˜¯ traitï¼Œå› æ­¤å¾ˆå¤šå…¶ä»–ç±»å‹éƒ½å¯ä»¥å®ç°å®ƒä»¬ï¼Œä½ ä¹Ÿå¯ä»¥ä¸ºè‡ªå·±çš„ç±»å‹å®ç°è¿™ä¸¤ä¸ª traitã€‚å› æ­¤ä½ ä¼šçœ‹åˆ°å‡ ç§ä¸åŒçš„ I/O ç±»å‹ï¼ˆtypesï¼‰ï¼šæ–‡ä»¶ï¼ˆFilesï¼‰ã€`TcpStreams`ï¼ˆTCP æµï¼‰ã€æœ‰æ—¶ç”šè‡³æ˜¯ `Vec<T>`ã€‚ä¾‹å¦‚ï¼Œ`Read` trait ä¸º `File` ç±»å‹æ·»åŠ äº† `read` æ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥è¯»å–æ–‡ä»¶å†…å®¹ï¼š

```rust
use async_std::fs::File;
use async_std::prelude::*;

let mut f = File::open("foo.txt").await?;
let mut buffer = [0; 10];
// è¯»å–æœ€å¤š 10 ä¸ªå­—èŠ‚
let n = f.read(&mut buffer).await?;
println!("è¯»å–åˆ°çš„å­—èŠ‚: {:?}", &buffer[..n]);
```

`Read` å’Œ `Write` éå¸¸é‡è¦ï¼Œè¿™ä¸¤ä¸ªç‰¹æ€§ï¼ˆtraitsï¼‰çš„å®ç°è€…ï¼ˆimplementorsï¼‰æœ‰ä¸€ä¸ªæ˜µç§°ï¼š**è¯»å–å™¨ï¼ˆreaderï¼‰å’Œå†™å…¥å™¨ï¼ˆwriterï¼‰**ã€‚å› æ­¤ï¼Œä½ æœ‰æ—¶ä¼šçœ‹åˆ°â€œä¸€ä¸ªè¯»å–å™¨â€è€Œä¸æ˜¯â€œä¸€ä¸ªå®ç°äº† `Read` ç‰¹æ€§çš„ç±»å‹â€ã€‚è¿™æ ·æ›´ç®€æ´ï¼

#### Seek å’Œ BufRead

é™¤æ­¤ä¹‹å¤–ï¼Œ`async_std::io` æ¨¡å—è¿˜æä¾›äº†ä¸¤ä¸ªé‡è¦çš„ç‰¹æ€§ï¼š`Seek` å’Œ `BufRead`ã€‚å®ƒä»¬éƒ½åŸºäºè¯»å–å™¨å·¥ä½œï¼Œä»¥æ§åˆ¶è¯»å–çš„æ‰§è¡Œæ–¹å¼ã€‚`Seek` å…è®¸ä½ æ§åˆ¶ä¸‹ä¸€ä¸ªå­—èŠ‚çš„æ¥æºï¼š

```rust
use async_std::fs::File;
use async_std::io::SeekFrom;
use async_std::prelude::*;

let mut f = File::open("foo.txt").await?;
let mut buffer = [0; 10];
// è·³åˆ°æ–‡ä»¶çš„æœ€å 10 ä¸ªå­—èŠ‚
f.seek(SeekFrom::End(-10)).await?;
// è¯»å–æœ€å¤š 10 ä¸ªå­—èŠ‚
let n = f.read(&mut buffer).await?;
println!("è¯»å–åˆ°çš„å­—èŠ‚: {:?}", &buffer[..n]);
```

`BufRead` ä½¿ç”¨ä¸€ä¸ª**å†…éƒ¨ç¼“å†²åŒºï¼ˆbufferï¼‰**æ¥æä¾›è®¸å¤šå…¶ä»–è¯»å–æ–¹å¼ï¼Œä½†è¦å±•ç¤ºå®ƒï¼Œæˆ‘ä»¬éœ€è¦å…ˆè°ˆè®ºä¸€ä¸‹ç¼“å†²åŒºçš„ä¸€èˆ¬æ¦‚å¿µã€‚

#### BufReader å’Œ BufWriter

åŸºäºå­—èŠ‚çš„æ¥å£ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç¬¨æ‹™ä¸”æ•ˆç‡å¯èƒ½ä½ä¸‹ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ä¸æ–­åœ°è°ƒç”¨æ“ä½œç³»ç»Ÿã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ`std::io` æä¾›äº†ä¸¤ä¸ªç»“æ„ä½“ï¼š`BufReader` å’Œ `BufWriter`ï¼Œå®ƒä»¬åŒ…è£…äº†è¯»å–å™¨å’Œå†™å…¥å™¨ã€‚åŒ…è£…å™¨ä½¿ç”¨ç¼“å†²åŒºï¼Œå‡å°‘äº†è°ƒç”¨æ¬¡æ•°ï¼Œå¹¶æä¾›äº†æ›´å‹å¥½çš„æ–¹æ³•æ¥ç²¾ç¡®è®¿é—®ä½ æƒ³è¦çš„å†…å®¹ã€‚

ä¾‹å¦‚ï¼Œ`BufReader` ä¸ `BufRead` ç‰¹æ€§ååŒå·¥ä½œï¼Œä¸ºä»»ä½•è¯»å–å™¨æ·»åŠ é¢å¤–çš„æ–¹æ³•ã€‚

```rust
use async_std::fs::File;
use async_std::io::BufReader;
use async_std::prelude::*;

let f = File::open("foo.txt").await?;
let mut reader = BufReader::new(f);
let mut buffer = String::new();

// è¯»å–ä¸€è¡Œåˆ° buffer ä¸­
reader.read_line(&mut buffer).await?;
println!("{}", buffer);
```

`BufWriter` ä¸ä¼šæ·»åŠ ä»»ä½•æ–°çš„å†™å…¥æ–¹å¼ï¼Œå®ƒåªæ˜¯ä½¿ç”¨ç¼“å†²å¯¹ `write` çš„æ¯æ¬¡è°ƒç”¨è¿›è¡Œä¼˜åŒ–ï¼š

```rust
use async_std::fs::File;
use async_std::io::prelude::*;
use async_std::io::BufWriter;

let f = File::create("foo.txt").await?;

{
Â  Â  let mut writer = BufWriter::new(f);

Â  Â  // å‘ç¼“å†²åŒºå†™å…¥ä¸€ä¸ªå­—èŠ‚
Â  Â  writer.write(&[42]).await?;
} // å½“ writer è¶…å‡ºä½œç”¨åŸŸæ—¶ï¼Œç¼“å†²åŒºä¼šè¢«åˆ·æ–°
```

#### æ ‡å‡†è¾“å…¥å’Œè¾“å‡º

ä¸€ä¸ªéå¸¸å¸¸è§çš„è¾“å…¥æ¥æºæ˜¯æ ‡å‡†è¾“å…¥ï¼š

```rust
use async_std::io;

let mut input = String::new();

io::stdin().read_line(&mut input).await?;
println!("ä½ è¾“å…¥äº†ï¼š{}", input.trim());
```

æ³¨æ„ï¼Œä½ ä¸èƒ½åœ¨ä¸è¿”å› `Result<T, E>` çš„å‡½æ•°ä¸­ä½¿ç”¨ `?` è¿ç®—ç¬¦ã€‚è¿”å› `Result<T, E>` æ—¶ï¼Œä½ å¯ä»¥è°ƒç”¨ `.unwrap()` æˆ–ä½¿ç”¨ `match` åŒ¹é…è¿”å›å€¼ä»¥æ•è·ä»»ä½•å¯èƒ½çš„é”™è¯¯ï¼š

```rust
use async_std::io;

let mut input = String::new();

io::stdin().read_line(&mut input).await.unwrap();
```

ä¸€ä¸ªéå¸¸å¸¸è§çš„è¾“å‡ºæ¥æºæ˜¯æ ‡å‡†è¾“å‡ºï¼š

```rust
use async_std::io;
use async_std::io::prelude::*;

io::stdout().write(&[42]).await?;
```

å½“ç„¶ï¼Œç›´æ¥ä½¿ç”¨ `io::stdout` æ¯”ä½¿ç”¨ç±»ä¼¼ `println!` çš„å®è¦å°‘è§ã€‚

#### è¿­ä»£å™¨ç±»å‹

`std::io` æä¾›çš„è®¸å¤šç»“æ„ç”¨äºä»¥å„ç§æ–¹å¼è¿­ä»£ I/Oã€‚ä¾‹å¦‚ï¼Œ`Lines` ç”¨äºæŒ‰è¡Œåˆ†å‰²ï¼š

```rust
use async_std::fs::File;
use async_std::io::BufReader;
use async_std::prelude::*;

let f = File::open("foo.txt").await?;
let reader = BufReader::new(f);
let mut lines = reader.lines();
while let Some(line) = lines.next().await {
Â  Â  println!("{}", line?);
}
```

`async_std` æä¾›äº†å¼‚æ­¥çš„è®¿é—®æ–¹æ³•ï¼Œæ¯”å¦‚ä¸Šé¢çš„ `lines.next().await`ã€‚

**å‡½æ•°**

è¿˜æœ‰ä¸€äº›å‡½æ•°å¯ä»¥è®¿é—®å„ç§åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `io::copy` å°†æ ‡å‡†è¾“å…¥çš„å†…å®¹å…¨éƒ¨å¤åˆ¶åˆ°æ ‡å‡†è¾“å‡ºï¼š

```rust
use async_std::io;

io::copy(&mut io::stdin(), &mut io::stdout()).await?;
```

å…¶ä»–æœ‰ç”¨çš„å‡½æ•°ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/ed/f6/ed75a1e5d226555c27198d743d06e3f6.png?wh=1920x1137)

**io::Result ç±»å‹**

æœ€åä½†åŒæ ·é‡è¦çš„ï¼Œæ˜¯ `io::Result` ç±»å‹ã€‚å®ƒæ˜¯è®¸å¤š `std::io` å‡½æ•°çš„è¿”å›å€¼ç±»å‹ï¼Œè¿™äº›å‡½æ•°å¯èƒ½ä¼šå¼•å‘é”™è¯¯ã€‚ä½ ä¹Ÿå¯ä»¥å°†æ­¤ç±»å‹ä½œä¸ºè‡ªå·±å‡½æ•°çš„è¿”å›å€¼ã€‚æœ¬æ¨¡å—ä¸­çš„è®¸å¤šç¤ºä¾‹éƒ½ä½¿ç”¨äº† `?` æ“ä½œç¬¦ï¼š

```plain
#![allow(dead_code)]
use async_std::io;

async fn read_input() -> io::Result<()> {
Â  Â  let mut input = String::new();

Â  Â  io::stdin().read_line(&mut input).await?;

Â  Â  println!("ä½ è¾“å…¥çš„å†…å®¹: {}", input.trim());

Â  Â  Ok(())
}
```

`read_input` å‡½æ•°çš„è¿”å›å€¼ç±»å‹ `io::Result<()>` éå¸¸å¸¸è§ï¼Œé€‚ç”¨äºé‚£äº›æ²¡æœ‰â€œçœŸå®â€è¿”å›å€¼çš„å‡½æ•°ï¼Œä½†éœ€è¦åœ¨å‘ç”Ÿé”™è¯¯æ—¶è¿”å›é”™è¯¯ä¿¡æ¯ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ­¤å‡½æ•°çš„å”¯ä¸€ç›®çš„æ˜¯è¯»å–ä¸€è¡Œå†…å®¹å¹¶æ‰“å°å®ƒï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨ `()` è¡¨ç¤ºç©ºå€¼ã€‚

### os

osæ¨¡å—å®šä¹‰äº†å’Œç‰¹å®šæ“ä½œç³»ç»Ÿç›¸å…³çš„ä¸€äº›ç‰¹æ€§ï¼ŒåŒ…æ‹¬Unixå’ŒWindowsç›¸å…³çš„ã€‚

![](https://static001.geekbang.org/resource/image/10/31/105fb2e661a2451e94c8eb2cbeda8431.png?wh=2412x1162)

è¿™é‡Œæˆ‘å°±ä¸å…·ä½“å±•å¼€è®²äº†ï¼Œå¦‚æœä½ ç°å®é¡¹ç›®ä¸­é‡åˆ°å’Œæ“ä½œç³»ç»Ÿç›¸å…³çš„ç‰¹å®šçš„éœ€æ±‚ï¼Œä½ å¯ä»¥å†æ¥ç¿»é˜…ä¸€ä¸‹å®ƒçš„æ–‡æ¡£ã€‚

### path

æ­¤æ¨¡å—æä¾›äº†ä¸¤ç§ç±»å‹ `PathBuf` å’Œ `Path`ï¼ˆç±»ä¼¼äº `String` å’Œ `str`ï¼‰ï¼Œç”¨äºä»¥æŠ½è±¡çš„æ–¹å¼å¤„ç†è·¯å¾„ã€‚è¿™äº›ç±»å‹åˆ†åˆ«æ˜¯ `OsString` å’Œ `OsStr` çš„è½»é‡çº§åŒ…è£…å™¨ï¼Œè¿™æ„å‘³ç€å®ƒä»¬æ ¹æ®æœ¬åœ°å¹³å°çš„è·¯å¾„è¯­æ³•ç›´æ¥æ“ä½œå­—ç¬¦ä¸²ã€‚

é€šè¿‡è¿­ä»£ `Path` ä¸Šçš„ `components` æ–¹æ³•è¿”å›çš„ç»“æ„ï¼Œå¯ä»¥å°†è·¯å¾„è§£æä¸º `Components`ï¼ˆè·¯å¾„ç»„æˆéƒ¨åˆ†ï¼‰ã€‚`Components` å¤§è‡´å¯¹åº”äºè·¯å¾„åˆ†éš”ç¬¦ï¼ˆ`/` æˆ– `\`ï¼‰ä¹‹é—´çš„å­å­—ç¬¦ä¸²ã€‚ä½ å¯ä»¥ä½¿ç”¨ `PathBuf` ä¸Šçš„ `push` æ–¹æ³•ä»ç»„æˆéƒ¨åˆ†é‡å»ºç­‰æ•ˆçš„è·¯å¾„ã€‚æ³¨æ„ï¼Œè·¯å¾„åœ¨è¯­æ³•ä¸Šå¯èƒ½å›  `components` æ–¹æ³•çš„æ–‡æ¡£ä¸­æè¿°çš„è§„èŒƒåŒ–è€Œæœ‰æ‰€ä¸åŒã€‚

è·¯å¾„æ“ä½œåŒ…æ‹¬ä»åˆ‡ç‰‡è§£æç»„æˆéƒ¨åˆ†ä»¥åŠæ„å»ºæ–°çš„æ‹¥æœ‰æ‰€æœ‰æƒçš„è·¯å¾„ã€‚è¦è§£æè·¯å¾„ï¼Œä½ å¯ä»¥ä» `str` åˆ‡ç‰‡åˆ›å»ºä¸€ä¸ª `Path` åˆ‡ç‰‡ï¼Œç„¶åè¿›è¡ŒæŸ¥è¯¢ã€‚

```rust
use async_std::path::Path;
use std::ffi::OsStr;

let path = Path::new("/tmp/foo/bar.txt");

let parent = path.parent();
assert_eq!(parent, Some(Path::new("/tmp/foo")));

let file_stem = path.file_stem();
assert_eq!(file_stem, Some(OsStr::new("bar")));

let extension = path.extension();
assert_eq!(extension, Some(OsStr::new("txt")));
```

è¦æ„å»ºæˆ–ä¿®æ”¹è·¯å¾„ï¼Œè¯·ä½¿ç”¨ `PathBuf`ï¼š

```rust
use async_std::path::PathBuf;

// è¿™ç§æ–¹å¼å¯è¡Œâ€¦â€¦
let mut path = PathBuf::from("c:\\");

path.push("windows");
path.push("system32");

path.set_extension("dll");

// â€¦â€¦ä½†å¦‚æœä½ äº‹å…ˆä¸çŸ¥é“æ‰€æœ‰å†…å®¹ï¼Œæœ€å¥½ä½¿ç”¨ pushã€‚å¦‚æœçŸ¥é“ï¼Œè¿™ç§æ–¹å¼æ›´å¥½ï¼š
let path: PathBuf = ["c:\\", "windows", "system32.dll"].iter().collect();
```

MAIN\_SEPARATOR ä»£è¡¨æ­¤æ“ä½œç³»ç»Ÿä¸­çš„è·¯å¾„åˆ†éš”ç¬¦ï¼Œæ¯”å¦‚Unix/Linuxä¸­çš„"/", Windowsä¸­çš„â€œ\\â€ã€‚å‡½æ•°is\_separatoråˆ¤æ–­ä¸€ä¸ªå­—ç¬¦æ˜¯ä¸æ˜¯åˆ†éš”ç¬¦ã€‚

### process è¿›ç¨‹

process æ¨¡å—è´Ÿè´£è¿›ç¨‹ç›¸å…³çš„æ“ä½œã€‚å®ƒä¸»è¦ç”¨æ¥å¯åŠ¨å’Œæ§åˆ¶å­è¿›ç¨‹ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº† `abort` å’Œ `exit` ä¸¤ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥ç»“æŸå½“å‰è¿è¡Œçš„ç¨‹åºã€‚è¿™æ˜¯ `std::process` çš„å¼‚æ­¥ç‰ˆæœ¬ã€‚

ä»¥ä¸‹æ˜¯è¿™ä¸ªæ¨¡å—æä¾›çš„ç»“æ„ä½“ï¼š

![](https://static001.geekbang.org/resource/image/ed/43/ed7ce92c5fe36808d1ce38a8faa33843.png?wh=1726x1366)

ä¸‹é¢æ˜¯ä½¿ç”¨Commandçš„ä¾‹å­ï¼Œç”Ÿæˆä¸€ä¸ªCommandåè·å¾—å®ƒçš„è¾“å‡ºï¼š

```rust
use async_std::process::Command;

#[async_std::main]
async fn main() -> std::io::Result<()> {
    let output = Command::new("echo")
        .arg("hello")
        .output()
        .await?;

    println!("status: {}", output.status);
    println!("stdout: {}", String::from_utf8_lossy(&output.stdout));
    println!("stderr: {}", String::from_utf8_lossy(&output.stderr));

    Ok(())
}
```

ä½¿ç”¨å¤šä¸ªå‚æ•°çš„ä¾‹å­ï¼š

```rust
use async_std::process::Command;
use std::process::Stdio;

#[async_std::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
Â  Â  let output = Command::new("ls")
Â  Â  Â  Â  .arg("-l")
Â  Â  Â  Â  .arg("-a")
Â  Â  Â  Â  .stdout(Stdio::piped())
Â  Â  Â  Â  .output()
Â  Â  Â  Â  .await?;

Â  Â  println!("{}", String::from_utf8_lossy(&output.stdout));
Â  Â  Ok(())
}
```

æ”¯æŒbashå’Œç®¡é“ç¬¦ï¼š

```rust
#[async_std::test]
async fn test_bash() -> Result<(), Box<dyn std::error::Error>> {
    let output = Command::new("bash") // æˆ– Command::new("sh")
        .arg("-c")
        .arg("ls -l | grep txt") // è¿™é‡Œæ˜¯ä½ çš„ shell å‘½ä»¤
        .stdout(Stdio::piped())
        .stderr(Stdio::piped()) // æ•è·é”™è¯¯è¾“å‡º
        .output()
        .await?;

    if output.status.success() {
        println!("{}", String::from_utf8_lossy(&output.stdout));
    } else {
        eprintln!("{}", String::from_utf8_lossy(&output.stderr));
    }

    Ok(())
}
```

### stream

è¿™ä¸ªæ¨¡å—æ˜¯Â `std::iter` çš„å¼‚æ­¥ç‰ˆæœ¬ã€‚å¦‚æœä½ å‘ç°è‡ªå·±éœ€è¦å¤„ç†æŸç§å¼‚æ­¥é›†åˆï¼Œå¹¶éœ€è¦å¯¹è¯¥é›†åˆçš„å…ƒç´ æ‰§è¡Œæ“ä½œï¼Œä½ å¾ˆå¿«å°±ä¼šæ¥è§¦åˆ°â€œæµï¼ˆstreamsï¼‰â€ã€‚æµåœ¨ç¬¦åˆ Rust æƒ¯ä¾‹çš„å¼‚æ­¥ä»£ç ä¸­è¢«å¤§é‡ä½¿ç”¨ï¼Œå› æ­¤ç†Ÿæ‚‰å®ƒä»¬æ˜¯å¾ˆæœ‰ä»·å€¼çš„ã€‚

åœ¨è¿›ä¸€æ­¥è§£é‡Šä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹streamæ¨¡å—çš„ç»“æ„ï¼š

- **ç‰¹æ€§ï¼ˆTraitsï¼‰**æ˜¯æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®šä¹‰äº†å­˜åœ¨å“ªäº›ç±»å‹çš„æµä»¥åŠä½ å¯ä»¥ç”¨å®ƒä»¬åšä»€ä¹ˆã€‚è¿™äº›ç‰¹æ€§çš„æ–¹æ³•å€¼å¾—èŠ±ä¸€äº›é¢å¤–çš„æ—¶é—´å­¦ä¹ ã€‚
- **å‡½æ•°ï¼ˆFunctionsï¼‰**æä¾›äº†ä¸€äº›åˆ›å»ºåŸºæœ¬æµçš„æœ‰ç”¨æ–¹æ³•ã€‚
- **ç»“æ„ä½“ï¼ˆStructsï¼‰**é€šå¸¸æ˜¯æœ¬æ¨¡å—ç‰¹æ€§ä¸­å„ç§æ–¹æ³•çš„è¿”å›ç±»å‹ã€‚ä½ é€šå¸¸åº”è¯¥å…³æ³¨åˆ›å»ºç»“æ„ä½“çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯ç»“æ„ä½“æœ¬èº«ã€‚

æœ¬æ¨¡å—çš„æ ¸å¿ƒæ˜¯ `Stream` ç‰¹æ€§ï¼ˆtraitï¼‰ã€‚`Stream` çš„æ ¸å¿ƒå®šä¹‰å¦‚ä¸‹ï¼š

```rust
#![allow(dead_code)]
pub trait Stream {
    type Item;
    fn poll_next(self: Pin<&mut Self>, cx: &mut Context<'_>) -> Poll<Option<Self::Item>>;
}
```

ä¸€ä¸ªæµæœ‰ä¸€ä¸ª `next` æ–¹æ³•ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª `Poll<Option<Item>>`ã€‚åªè¦è¿˜æœ‰å…ƒç´ ï¼Œ`next` å°±ä¼šè¿”å› `Ready(Some(Item))`ï¼›ä¸€æ—¦æ‰€æœ‰å…ƒç´ éƒ½è¢«è€—å°½ï¼Œå®ƒå°†è¿”å› `None` ä»¥è¡¨æ˜è¿­ä»£å·²å®Œæˆã€‚å¦‚æœæˆ‘ä»¬æ­£åœ¨ç­‰å¾…æŸä¸ªå¼‚æ­¥æ“ä½œå®Œæˆï¼Œåˆ™ä¼šè¿”å› `Pending`ã€‚å„ä¸ªæµå¯ä»¥é€‰æ‹©æ¢å¤è¿­ä»£ï¼Œå› æ­¤å†æ¬¡è°ƒç”¨ `next` å¯èƒ½æœ€ç»ˆä¼šåœ¨æŸä¸ªæ—¶å€™å†æ¬¡å¼€å§‹è¿”å› `Ready(Some(Item))`ï¼Œä¹Ÿå¯èƒ½ä¸ä¼šã€‚

`Stream` çš„å®Œæ•´å®šä¹‰è¿˜åŒ…æ‹¬è®¸å¤šå…¶ä»–æ–¹æ³•ï¼Œä½†å®ƒä»¬éƒ½æ˜¯åŸºäº `next` æ„å»ºçš„é»˜è®¤æ–¹æ³•ï¼Œå› æ­¤ä½ å¯ä»¥å…è´¹è·å¾—å®ƒä»¬ã€‚

æµä¹Ÿæ˜¯å¯ç»„åˆçš„ï¼Œå¹¶ä¸”é€šå¸¸ä¼šå°†å®ƒä»¬é“¾æ¥åœ¨ä¸€èµ·ä»¥æ‰§è¡Œæ›´å¤æ‚çš„å¤„ç†å½¢å¼ã€‚æœ‰ä¸‰ç§å¸¸ç”¨çš„æ–¹æ³•å¯ä»¥ä»é›†åˆåˆ›å»ºæµï¼š

- `stream()`ï¼Œå®ƒè¿­ä»£ `&T`ã€‚
- `stream_mut()`ï¼Œå®ƒè¿­ä»£ `&mut T`ã€‚
- `into_stream()`ï¼Œå®ƒè¿­ä»£ `T`ã€‚

`async-std` ä¸­çš„å„ç§ç±»å‹å¯èƒ½ä¼šåœ¨é€‚å½“çš„æƒ…å†µä¸‹å®ç°è¿™ä¸‰ç§æ–¹æ³•ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªã€‚

åˆ›å»ºè‡ªå®šä¹‰æµæ¶‰åŠä¸¤ä¸ªæ­¥éª¤ï¼šåˆ›å»ºä¸€ä¸ªç”¨äºä¿å­˜æµçŠ¶æ€çš„ç»“æ„ä½“ï¼Œç„¶åä¸ºè¿™ä¸ªç»“æ„ä½“å®ç°`Stream`ç‰¹æ€§ã€‚è¿™å°±æ˜¯è¿™ä¸ªæ¨¡å—ä¸­å­˜åœ¨å¦‚æ­¤å¤šç»“æ„ä½“çš„åŸå› ï¼šæ¯ä¸ªæµå’Œè¿­ä»£å™¨é€‚é…å™¨éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ç»“æ„ä½“ã€‚

Rust çš„ `while let` å¾ªç¯è¯­æ³•æ˜¯ä¸€ç§è¿­ä»£æµçš„æƒ¯ç”¨æ–¹å¼ã€‚ä¸‹é¢æ˜¯ `while let` çš„ä¸€ä¸ªåŸºæœ¬ç¤ºä¾‹ï¼š

```rust
let mut values = stream::from_iter(1u8..6);
while let Some(x) = values.next().await {
Â  println!("{}", x);
}
```

è¿™å°†é€è¡Œæ‰“å°æ•°å­— 1 åˆ° 5ã€‚ä½†æ˜¯ä½ ä¼šæ³¨æ„åˆ°è¿™é‡Œæœ‰ä¸€ç‚¹ï¼šæˆ‘ä»¬ä»æ¥æ²¡æœ‰è°ƒç”¨å‘é‡ä¸Šçš„ä»»ä½•æ–¹æ³•æ¥ç”Ÿæˆæµã€‚è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ

æ ‡å‡†åº“ä¸­æœ‰ä¸€ä¸ªç”¨äºå°†æŸäº›ä¸œè¥¿è½¬æ¢ä¸ºæµçš„ç‰¹æ€§ï¼š`IntoStream`ã€‚æ­¤ç‰¹æ€§åªæœ‰ä¸€ä¸ªæ–¹æ³• `into_stream`ï¼Œå®ƒå°†å®ç° `IntoStream` çš„å¯¹è±¡è½¬æ¢ä¸ºæµã€‚

ä¸ `std::iter::IntoIterator` ä¸åŒçš„æ˜¯ï¼Œ`IntoStream` ç›®å‰è¿˜æ²¡æœ‰ç¼–è¯‘å™¨çš„æ”¯æŒã€‚è¿™æ„å‘³ç€åƒ `for` å¾ªç¯é‚£æ ·è‡ªåŠ¨è½¬æ¢è¿˜ä¸å­˜åœ¨ï¼Œå› æ­¤ `into_stream` æˆ–å¦‚ä¸Šæ‰€è¿°çš„ `from_iter` æ€»æ˜¯éœ€è¦æ‰‹åŠ¨è°ƒç”¨ã€‚

æ¥å—ä¸€ä¸ª `Stream` å¹¶è¿”å›å¦ä¸€ä¸ª `Stream` çš„å‡½æ•°é€šå¸¸è¢«ç§°ä¸º**æµé€‚é…å™¨ï¼ˆstream adaptersï¼‰**ï¼Œå› ä¸ºå®ƒä»¬æ˜¯é€‚é…å™¨æ¨¡å¼ ï¼ˆadapter patternï¼‰çš„ä¸€ç§å½¢å¼ã€‚å¸¸è§çš„æµé€‚é…å™¨åŒ…æ‹¬ `map`ã€`take` å’Œ `filter`ã€‚æ›´å¤šä¿¡æ¯è¯·å‚é˜…å®ƒä»¬çš„æ–‡æ¡£ã€‚

æµå’Œæµé€‚é…å™¨éƒ½æ˜¯æƒ°æ€§çš„ï¼ˆlazyï¼‰ã€‚è¿™æ„å‘³ç€ä»…ä»…åˆ›å»ºæµæœ¬èº«å¹¶ä¸ä¼šåšå¤ªå¤šäº‹æƒ…ã€‚åªæœ‰å½“ä½ è°ƒç”¨ `next` æ–¹æ³•æ—¶ï¼Œæµæ‰ä¼šçœŸæ­£å¼€å§‹è¿ä½œã€‚å½“å•ç‹¬ä¸ºäº†æµçš„å‰¯ä½œç”¨ï¼ˆside effectsï¼‰è€Œåˆ›å»ºæµæ—¶ï¼Œè¿™æœ‰æ—¶ä¼šå¯¼è‡´æ··æ·†ã€‚ä¾‹å¦‚ï¼Œ`map` æ–¹æ³•ä¼šå¯¹å®ƒè¿­ä»£åˆ°çš„æ¯ä¸ªå…ƒç´ è°ƒç”¨ä¸€ä¸ªé—­åŒ…å‡½æ•°ï¼š

```rust
let v = stream::repeat(1u8).take(5);
v.map(|x| println!("{}", x))
```

è¿™å°†ä¸ä¼šæ‰“å°ä»»ä½•å€¼ï¼Œå› ä¸ºæˆ‘ä»¬åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæµï¼Œå¹¶æ²¡æœ‰çœŸæ­£ä½¿ç”¨å®ƒã€‚ç¼–è¯‘å™¨ä¼šå¯¹è¿™ç§è¡Œä¸ºå‘å‡ºè­¦å‘Šï¼š

```rust
warning: unused result that must be used: streams are lazy and do nothing unless consumed
```

ä½¿ç”¨ `while let` å¾ªç¯æ¥å‘æŒ¥ `map` çš„å‰¯ä½œç”¨æ‰æ˜¯æƒ¯ç”¨çš„åšæ³•ï¼š

```rust
let mut v = stream::repeat(1u8).take(5);
while let Some(x) = &v.next().await {
Â  println!("{}", x);
}
```

è®©æµç”Ÿæ•ˆçš„ä¸¤ç§æœ€å¸¸è§æ–¹å¼æ˜¯ä½¿ç”¨åƒè¿™æ ·çš„ `while let` å¾ªç¯ï¼Œæˆ–è€…ä½¿ç”¨ `collect` æ–¹æ³•æ¥ç”Ÿæˆä¸€ä¸ªæ–°çš„é›†åˆã€‚

æ—¢ç„¶æˆ‘ä»¬æ›´éœ€è¦å…³æ³¨å®ƒçš„å‡½æ•°ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œæˆ‘åˆ—å‡ºäº†å®ƒçš„æ‰€æœ‰çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å¤§æ¦‚äº†è§£ä¸€ä¸‹å®ƒä»¬çš„åŠŸèƒ½ï¼š

![](https://static001.geekbang.org/resource/image/a4/14/a4f515226c36a5fa1ffcaa7c8eb6dd14.png?wh=1860x1546)

### net

`async_std` è¿˜æä¾›äº†ç½‘ç»œç›¸å…³çš„å¼‚æ­¥ç‰ˆæœ¬ã€‚æœ¬æ¥Tikioçš„ç½‘ç»œæ¨¡å—åœ¨å‰ä¸€è¯¾ä¸­æ²¡æœ‰ä»‹ç»ï¼Œè¿™ä¸€è¯¾ä¹Ÿä¸åº”è¯¥ä»‹ç» `async_std` çš„ç½‘ç»œç›¸å…³çš„å†…å®¹ï¼Œä½†æ˜¯è€ƒè™‘åˆ°åé¢æ²¡æœ‰ä¸“é—¨çš„è¯¾ç‹¬ç«‹ `async_std` äº†ï¼Œæ‰€ä»¥åœ¨è¿™ä¸€èŠ‚æˆ‘ä»¬ç®€å•ä»‹ç»ä¸‹ã€‚

netæ¨¡å—ç”¨äº TCP/UDP é€šä¿¡çš„ç½‘ç»œåŸè¯­ã€‚è¿™ä¸€æ¨¡å—æä¾›äº†ä¼ è¾“æ§åˆ¶åè®® (TCP) å’Œç”¨æˆ·æ•°æ®æŠ¥åè®® (UDP) çš„ç½‘ç»œåŠŸèƒ½ï¼Œä»¥åŠ IP å’Œå¥—æ¥å­—åœ°å€çš„ç±»å‹ã€‚å®ƒæ˜¯ `std::net` çš„å¼‚æ­¥ç‰ˆæœ¬ã€‚

![](https://static001.geekbang.org/resource/image/d0/yy/d03dc2e3245e492fe4ccfff9142cd0yy.png?wh=2490x1412)

ä¸‹é¢æ˜¯ä¸€ä¸ªudp serverçš„ä¾‹å­ï¼Œå®ç°äº†echoåè®®ï¼š

```rust
use async_std::net::UdpSocket;

#[async_std::main]
async fn main() -> std::io::Result<()> {
    let socket = UdpSocket::bind("127.0.0.1:8080").await?;
    let mut buf = vec![0u8; 1024];

    loop {
        let (n, peer) = socket.recv_from(&mut buf).await?;
        socket.send_to(&buf[..n], &peer).await?;
    }
}
```

ä¸‹é¢æ˜¯ udp client çš„ä¾‹å­ï¼š

```rust
use async_std::net::UdpSocket;

#[async_std::main]
async fn main() -> std::io::Result<()> {
    let socket = UdpSocket::bind("0.0.0.0:0").await?;
    let server_addr = "127.0.0.1:8080";
    let msg = b"Hello, world!";
    
    socket.send_to(msg, server_addr).await?;
    
    let mut buf = vec![0u8; 1024];
    let (n, _) = socket.recv_from(&mut buf).await?;
    
    println!("Received: {}", String::from_utf8_lossy(&buf[..n]));
    
    Ok(())
}
```

### sync

è¿™ä¸ªæ¨¡å—æ˜¯`std::sync`çš„å¼‚æ­¥ç‰ˆæœ¬ã€‚äº‹å®ä¸Šæˆ‘ä»¬è¿˜æ²¡æœ‰å¼€å§‹ä»‹ç»æ ‡å‡†åº“çš„åŒæ­¥åŸè¯­ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸å¦¨å…ˆäº†è§£ä¸€ä¸‹å®ƒçš„å¼‚æ­¥ç‰ˆæœ¬ï¼Œä¸ç†Ÿæ‚‰ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œå¤§æ¦‚äº†è§£ä¸‹ï¼Œåé¢å­¦ä¹ äº†ä¹‹åå†æ¥å›é¡¾ã€‚

`async-std` çš„åŒæ­¥åŸè¯­æ˜¯è°ƒåº¦å™¨æ„ŸçŸ¥çš„ï¼Œè¿™ä½¿å¾—å¯ä»¥ `await` å®ƒä»¬çš„æ“ä½œâ€”â€”ä¾‹å¦‚ `Mutex` çš„åŠ é”æ“ä½œã€‚

ä»æ¦‚å¿µä¸Šè®²ï¼Œä¸€ä¸ª Rust ç¨‹åºæ˜¯åœ¨è®¡ç®—æœºä¸Šæ‰§è¡Œçš„ä¸€ç³»åˆ—æ“ä½œã€‚ç¨‹åºä¸­å‘ç”Ÿçš„äº‹ä»¶æ—¶é—´çº¿ä¸ä»£ç ä¸­æ“ä½œçš„é¡ºåºä¸€è‡´ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸‹é¢æ“ä½œå…¨å±€é™æ€å˜é‡çš„ä»£ç ï¼š

```rust
static mut A: u32 = 0;
static mut B: u32 = 0;
static mut C: u32 = 0;

fn main() {
Â  Â  unsafe {
Â  Â  Â  Â  A = 3;
Â  Â  Â  Â  B = 4;
Â  Â  Â  Â  A = A + B;
Â  Â  Â  Â  C = B;
Â  Â  Â  Â  println!("{} {} {}", A, B, C);
Â  Â  Â  Â  C = A;
Â  Â  }
}
```

è¿™æ®µä»£ç çœ‹èµ·æ¥åƒæ˜¯ä¿®æ”¹äº†ä¸€äº›å­˜å‚¨åœ¨å†…å­˜ä¸­çš„å˜é‡ï¼Œæ‰§è¡Œäº†ä¸€ä¸ªåŠ æ³•è¿ç®—ï¼Œç»“æœå­˜å‚¨åœ¨ `A` ä¸­ï¼Œå¹¶ä¸”å˜é‡ `C` è¢«ä¿®æ”¹äº†ä¸¤æ¬¡ã€‚å½“åªæ¶‰åŠå•ä¸ªçº¿ç¨‹æ—¶ï¼Œç»“æœæ­£å¦‚é¢„æœŸï¼šè¾“å‡º `7 4 4`ã€‚

è‡³äºå¹•åå‘ç”Ÿçš„äº‹æƒ…ï¼Œå½“å¯ç”¨ä¼˜åŒ–æ—¶ï¼Œæœ€ç»ˆç”Ÿæˆçš„æœºå™¨ä»£ç å¯èƒ½ä¸æºä»£ç å¤§ç›¸å¾„åº­ï¼š

- å¯¹ `C` çš„ç¬¬ä¸€æ¬¡å­˜å‚¨å¯èƒ½ä¼šè¢«ç§»åˆ°å¯¹ `A` æˆ– `B` çš„å­˜å‚¨ä¹‹å‰ï¼Œå°±å¥½åƒæˆ‘ä»¬å†™äº† `C = 4; A = 3; B = 4` ä¸€æ ·ã€‚
- å°† `A + B` èµ‹å€¼ç»™ `A` çš„æ“ä½œå¯èƒ½ä¼šè¢«ç§»é™¤ï¼Œå› ä¸ºå¯ä»¥åœ¨æ‰“å°ä¹‹å‰å°†æ€»å’Œå­˜å‚¨åœ¨ä¸€ä¸ªä¸´æ—¶ä½ç½®ï¼Œè€Œå…¨å±€å˜é‡åˆ™æ°¸è¿œä¸ä¼šè¢«æ›´æ–°ã€‚
- æœ€ç»ˆç»“æœåªéœ€åœ¨ç¼–è¯‘æ—¶æŸ¥çœ‹ä»£ç å³å¯ç¡®å®šï¼Œå› æ­¤å¸¸é‡æŠ˜å ï¼ˆconstant foldingï¼‰å¯èƒ½ä¼šå°†æ•´ä¸ªä»£ç å—è½¬æ¢ä¸ºç®€å•çš„ `println!("7 4 4")`ã€‚

ç¼–è¯‘å™¨å¯ä»¥æ‰§è¡Œè¿™äº›ä¼˜åŒ–çš„ä»»æ„ç»„åˆï¼Œåªè¦æœ€ç»ˆä¼˜åŒ–çš„ä»£ç åœ¨æ‰§è¡Œæ—¶äº§ç”Ÿä¸æœªä¼˜åŒ–ä»£ç ç›¸åŒçš„ç»“æœå³å¯ã€‚

ç”±äºç°ä»£è®¡ç®—æœºä¸­æ¶‰åŠå¹¶å‘ï¼ˆconcurrencyï¼‰ï¼Œå› æ­¤å…³äºç¨‹åºæ‰§è¡Œé¡ºåºçš„å‡è®¾é€šå¸¸æ˜¯é”™è¯¯çš„ã€‚å³ä½¿ç¦ç”¨ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œè®¿é—®å…¨å±€å˜é‡ä¹Ÿå¯èƒ½å¯¼è‡´ä¸ç¡®å®šçš„ç»“æœï¼Œå¹¶ä¸”ä»ç„¶å¯èƒ½å¼•å…¥åŒæ­¥é”™è¯¯ã€‚

è¯·æ³¨æ„ï¼Œåœ¨ Rust ä¸­ï¼Œå¦‚æœä½ æƒ³ç›´æ¥è®¿é—®å…¨å±€ï¼ˆé™æ€ï¼‰å˜é‡ï¼Œè€Œä¸ä½¿ç”¨ä»»ä½•ä¸“é—¨ç”¨æ¥åŒæ­¥å¤šçº¿ç¨‹è®¿é—®çš„å·¥å…·ï¼ˆä¹Ÿå°±æ˜¯â€œåŒæ­¥åŸè¯­â€ï¼‰ï¼Œé‚£ä¹ˆä½ å°±å¿…é¡»ä½¿ç”¨ `unsafe` ä»£ç å—ã€‚

> ä¹±åºæ‰§è¡Œ  
> ç”±äºå„ç§åŸå› ï¼ŒæŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºå¯èƒ½ä¸æˆ‘ä»¬å®šä¹‰çš„é¡ºåºä¸åŒï¼š  
> 1. ç¼–è¯‘å™¨ï¼ˆcompilerï¼‰é‡æ–°æ’åºæŒ‡ä»¤ï¼šå¦‚æœç¼–è¯‘å™¨å¯ä»¥åœ¨æ›´æ—©çš„æ—¶é—´ç‚¹å‘å‡ºæŒ‡ä»¤ï¼Œå®ƒä¼šå°è¯•è¿™æ ·åšã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½ä¼šå°†å†…å­˜åŠ è½½ï¼ˆmemory loadsï¼‰æå‡åˆ°ä»£ç å—çš„é¡¶éƒ¨ï¼Œä»¥ä¾¿ CPU å¯ä»¥å¼€å§‹ä»å†…å­˜ä¸­é¢„å–ï¼ˆprefetchingï¼‰å€¼ã€‚åœ¨å•çº¿ç¨‹åœºæ™¯ä¸­ï¼Œè¿™ä¼šåœ¨ç¼–å†™ä¿¡å·å¤„ç†ç¨‹åºæˆ–æŸäº›ç±»å‹çš„åº•å±‚ä»£ç æ—¶å¯¼è‡´é—®é¢˜ã€‚ä½¿ç”¨ç¼–è¯‘å™¨å±éšœï¼ˆcompiler fencesï¼‰å¯ä»¥é˜²æ­¢è¿™ç§é‡æ–°æ’åºã€‚  
> 2. å•ä¸ªå¤„ç†å™¨ï¼ˆprocessorï¼‰ä¹±åºæ‰§è¡ŒæŒ‡ä»¤ï¼šç°ä»£ CPU èƒ½å¤Ÿè¿›è¡Œè¶…æ ‡é‡ï¼ˆsuperscalarï¼‰æ‰§è¡Œï¼Œå³ä½¿æœºå™¨ä»£ç æè¿°çš„æ˜¯ä¸€ä¸ªé¡ºåºè¿‡ç¨‹ï¼Œä¹Ÿå¯èƒ½æœ‰å¤šä¸ªæŒ‡ä»¤åŒæ—¶æ‰§è¡Œã€‚è¿™ç§é‡æ–°æ’åºç”± CPU é€æ˜åœ°å¤„ç†ã€‚  
> 3. å¤šå¤„ç†å™¨ï¼ˆmultiprocessorï¼‰ç³»ç»ŸåŒæ—¶æ‰§è¡Œå¤šä¸ªç¡¬ä»¶çº¿ç¨‹ï¼šåœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸¤ç§ç±»å‹çš„åŸè¯­æ¥å¤„ç†åŒæ­¥ï¼š  
> a. å†…å­˜å±éšœï¼ˆmemory fencesï¼‰ç¡®ä¿å†…å­˜è®¿é—®ä»¥æ­£ç¡®çš„é¡ºåºå¯¹å…¶ä»– CPU å¯è§ã€‚  
> b. åŸå­æ“ä½œï¼ˆatomic operationsï¼‰ç¡®ä¿åŒæ—¶è®¿é—®åŒä¸€å†…å­˜ä½ç½®ä¸ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚

**é«˜çº§åŒæ­¥å¯¹è±¡**

å¤§å¤šæ•°åº•å±‚åŒæ­¥åŸè¯­éƒ½ç›¸å½“å®¹æ˜“å‡ºé”™ä¸”ä½¿ç”¨ä¸ä¾¿ï¼Œå› æ­¤ `async-std` ä¹Ÿå…¬å¼€äº†ä¸€äº›é«˜çº§åŒæ­¥å¯¹è±¡ã€‚è¿™äº›æŠ½è±¡æ¦‚å¿µå¯ä»¥åŸºäºæ›´åº•å±‚çš„åŸè¯­æ„å»ºã€‚ä¸ºäº†æé«˜æ•ˆç‡ï¼Œ`async-std` ä¸­çš„åŒæ­¥å¯¹è±¡é€šå¸¸å€ŸåŠ©è°ƒåº¦å™¨æ¥å®ç°ï¼Œè°ƒåº¦å™¨èƒ½å¤Ÿåœ¨ä»»åŠ¡é˜»å¡äºè·å–é”æ—¶é‡æ–°è°ƒåº¦è¿™äº›ä»»åŠ¡ã€‚

ä»¥ä¸‹æ˜¯å¯ç”¨åŒæ­¥å¯¹è±¡çš„æ¦‚è¿°ï¼š

![](https://static001.geekbang.org/resource/image/e8/1e/e82b8d3f37200faac6399f2828a7ac1e.png?wh=2234x1450)

å¦‚æœä½ æ­£åœ¨å¯»æ‰¾é€šé“ï¼Œè¯·æŸ¥çœ‹ `async_std::channel`ã€‚

ä¸€ä¸ªä½¿ç”¨Arcã€Mutexçš„ä¾‹å­ï¼Œåœ¨ä¸€ä¸ªä»»åŠ¡å¯¹å—é”ä¿æŠ¤çš„å˜é‡èµ‹å€¼ä¸º1ï¼š

```rust
use async_std::sync::{Arc, Mutex};
use async_std::task;

let m1 = Arc::new(Mutex::new(0));
let m2 = m1.clone();

task::spawn(async move {
Â  Â  *m2.lock().await = 1;
})
.await;

assert_eq!(*m1.lock().await, 1);
```

### å’ŒTokioå…¼å®¹

`async-std` å’Œ Tokio æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ Rust å¼‚æ­¥è¿è¡Œæ—¶ã€‚å®ƒä»¬å„è‡ªæ‹¥æœ‰è‡ªå·±çš„è°ƒåº¦å™¨å’Œ APIï¼Œå› æ­¤é»˜è®¤æƒ…å†µä¸‹æ˜¯äº’ä¸å…¼å®¹çš„ã€‚ç„¶è€Œï¼Œä¸ºäº†æ–¹ä¾¿ç”¨æˆ·åœ¨æŸäº›åœºæ™¯ä¸‹åŒæ—¶ä½¿ç”¨è¿™ä¸¤ä¸ªè¿è¡Œæ—¶ï¼Œ`async-std` æä¾›äº† `tokio03` è¿™ä¸ª Cargo ç‰¹æ€§ã€‚

å¯ç”¨ `tokio03` ç‰¹æ€§åï¼Œ`async-std` ä¼šæä¾›ä¸€äº›é€‚é…å±‚ï¼Œä½¿å¾—éƒ¨åˆ† `async-std` çš„ç±»å‹å’Œå‡½æ•°å¯ä»¥ä¸ Tokio 0.3 çš„ç±»å‹å’Œå‡½æ•°è¿›è¡Œäº’æ“ä½œã€‚è¿™é€šå¸¸æ¶‰åŠç±»å‹è½¬æ¢æˆ–åŒ…è£…ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½éœ€è¦åœ¨ä¸€ä¸ªä½¿ç”¨ Tokio 0.3 çš„é¡¹ç›®ä¸­ï¼Œä½¿ç”¨ `async-std` æä¾›çš„ä¸€äº›ç‰¹å®šåŠŸèƒ½ã€‚é€šè¿‡å¯ç”¨ `tokio03` ç‰¹æ€§ï¼Œä½ å°±å¯ä»¥åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­åŒæ—¶ä½¿ç”¨è¿™ä¸¤ä¸ªè¿è¡Œæ—¶ï¼Œè€Œæ— éœ€å®Œå…¨è¿ç§»ä»£ç ã€‚

è¿˜å¯ä»¥å¼€å¯ç‰¹æ€§ï¼Œé€‰æ‹©å…¼å®¹tokio1ã€tokio02ã€‚

å¥½äº†ï¼Œ`async_std` çš„å†…å®¹è®²å®Œäº†ï¼Œè¿™ä¸ªåº“çš„å†…å®¹ä¹Ÿæ˜¯éå¸¸ä¸°å¯Œï¼Œæä¾›äº†å¾ˆå¤šæ ‡å‡†åº“çš„å¼‚æ­¥ç‰ˆæœ¬ï¼Œå°¤å…¶æ¶‰åŠåˆ°IOæ“ä½œï¼ˆåŒ…æ‹¬ç½‘ç»œæ“ä½œï¼‰ã€è¿›ç¨‹ã€æµã€åŒæ­¥åŸè¯­ç­‰æ–¹å‘ã€‚

ç½‘ä¸Šä¸€ç¯‡å…³äºasync-stdçš„çŠ¶æ€çš„æ–‡ç« æ€»ç»“ï¼Œä»¥åŠå¼€å‘è€…å¯¹async\_stdæœªæ¥å‘å±•çš„è´¨ç–‘ï¼Œä»¥åŠå†…éƒ¨çš„æ±Ÿæ¹–ï¼ŒåŒ…æ‹¬smolä½œè€…Stjepan, ä½ å¯ä»¥è®¿é—®è¿™ç¯‡æ–‡ç« ï¼š[async-std åˆ›å»ºè€…å¯¹äºæœ€è¿‘â€œé¡¹ç›®æ˜¯å¦å·²æ­»ï¼Ÿâ€ï¼Œç§»é™¤å¯¹å…¶æ”¯æŒç­‰çš„ç­”å¤](https://blog.irust.net/niqin/async-std-chuang-jian-zhe-dui-yu-zui-jin--xiang-mu-shi-fou-yi-si---,yi-chu-dui-qi-zhi-chi-de-da-fu)ã€‚

ä¸‹ä¸€èŠ‚æˆ‘ä»¬ä»‹ç»ä¸€ä¸ªå°è€Œç¾çš„å¼‚æ­¥è¿è¡Œæ—¶ smolã€‚

## smol

è¿™ä¸ª crate åªæ˜¯ç®€å•åœ°é‡æ–°å¯¼å‡ºäº†ä¸€äº›æ›´å°çš„å¼‚æ­¥ crateã€‚

å¦‚æœä½ æƒ³åœ¨ smol ä¸­ä½¿ç”¨åŸºäº tokio çš„åº“ï¼Œéœ€è¦ä½¿ç”¨ `async-compat` é€‚é…å™¨æ¥è½¬æ¢ future å’Œ I/O ç±»å‹ã€‚

`smol` çš„ä½œè€…stjepang æ˜¯ Rust å¼‚æ­¥ç”Ÿæ€ç³»ç»Ÿä¸­ä¸€ä½éå¸¸æ´»è·ƒä¸”æœ‰å½±å“åŠ›çš„äººç‰©ã€‚ä»–ä¸ä»…æ˜¯ smol çš„ä¸»è¦ä½œè€…ï¼Œè¿˜æ›¾å‚ä¸è¿‡ `tokio` å’Œ `async-std` çš„å¼€å‘ï¼Œæ›´æ˜¯å¤§åé¼é¼crossbeamçš„ä½œè€…ï¼Œä¹Ÿæ˜¯ä¸€å †å¼‚æ­¥åº“çš„å¼€å‘è€…ã€‚è¿™ä½¿å¾—ä»–å¯¹ Rust å¼‚æ­¥ç¼–ç¨‹çš„å„ç§æ–¹æ³•å’Œæƒè¡¡æœ‰ç€æ·±åˆ»çš„ç†è§£ã€‚

ä»ä¸€äº›ç¤¾åŒºçš„è®¨è®ºä¸­å¯ä»¥çœ‹å‡ºï¼Œå¼€å‘è€…ä»¬éå¸¸æ¬£èµ stjepang çš„æ€è€ƒæ–¹å¼å’Œè§£å†³é—®é¢˜çš„æ–¹æ³•ã€‚ä»–å€¾å‘äºç®€æ´ã€é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆï¼Œè¿™ä¹Ÿåœ¨ smol çš„è®¾è®¡ä¸­å¾—åˆ°äº†å……åˆ†ä½“ç°ã€‚

`smol` çš„å‡ºç°ï¼Œä¸€å®šç¨‹åº¦ä¸Šæ˜¯å¯¹å½“æ—¶ Rust å¼‚æ­¥ç”Ÿæ€ä¸­ä¸€äº›é—®é¢˜çš„å›åº”ã€‚åœ¨ smol è¯ç”Ÿä¹‹å‰ï¼Œ`tokio` å æ®äº†ä¸»å¯¼åœ°ä½ï¼Œè€Œ `async-std` åˆ™è¯•å›¾æä¾›ä¸€ä¸ªæ›´æ¥è¿‘æ ‡å‡†åº“çš„å¼‚æ­¥ä½“éªŒã€‚ç„¶è€Œï¼Œä¸€äº›å¼€å‘è€…è§‰å¾— `tokio` æœ‰äº›è¿‡äºåºå¤§å’Œå¤æ‚ï¼Œè€Œ `async-std` è™½ç„¶æ›´æ˜“ç”¨ï¼Œä½†åœ¨æŸäº›æ–¹é¢åˆä¸å¤Ÿçµæ´»ã€‚

> Rust éå¸¸æœ‰åçš„äººç‰©ï¼Œcrossbeamã€async-std å’Œ smol çš„æ ¸å¿ƒä½œè€… Stjepan Glavinaï¼Œåœ¨2021åˆç”±äºä¸æ˜åŸå› åˆ é™¤äº†æ‰€æœ‰åšå®¢å’Œä»–çš„ Rust é¡¹ç›®ï¼Œå¥½åƒé»˜é»˜åœ°é€€å‡ºäº† Rust ç¤¾åŒºã€‚æ‰€ä»¥ä»–çš„å¾ˆå¤šæœ‰ä»·å€¼çš„æ–‡ç« ç°åœ¨éƒ½çœ‹ä¸åˆ°äº†ã€‚ä¹Ÿè®¸è¢«Rustä¼¤å®³å¤ªæ·±ï¼Œä¸è¢«éƒ¨é—¨åŒè¡Œè®¤å¯ï¼Œä½¿ä»–èŒç”Ÿé€€æ„ï¼Œä¸€ä¸ªå¤§ç¥å°±æ­¤å‘Šåˆ«äº†Rustï¼ŒæŸå¤±å·¨å¤§ã€‚å“ªå„¿éƒ½æœ‰æ±Ÿæ¹–ï¼ŒåŒ…æ‹¬Goç”Ÿæ€åœˆã€‚è€ŒRustç”Ÿæ€åœˆæ±Ÿæ¹–æ°”æ›´ç››ã€‚

`smol` çš„ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªè½»é‡çº§ã€å¿«é€Ÿã€çµæ´»çš„å¼‚æ­¥è¿è¡Œæ—¶ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- **å°å·§ç²¾æ‚ï¼š**`smol` çš„ä»£ç åº“éå¸¸å°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤ã€‚è¿™ä½¿å¾—å¼€å‘è€…å¯ä»¥æ›´å¥½åœ°æ§åˆ¶å’Œå®šåˆ¶è‡ªå·±çš„å¼‚æ­¥ç¯å¢ƒã€‚
- **é«˜æ€§èƒ½ï¼š**`smol` æ³¨é‡æ€§èƒ½ï¼Œé€šè¿‡é«˜æ•ˆçš„è°ƒåº¦å™¨å’Œåº•å±‚å®ç°ï¼Œå°½å¯èƒ½åœ°å‡å°‘å¼€é”€ã€‚
- **çµæ´»æ€§ï¼š**`smol`ä¸åƒ `async-std` é‚£æ ·æä¾›å¤§é‡çš„å†…ç½®åŠŸèƒ½ï¼Œè€Œæ˜¯ä¸ `futures-rs` ç´§å¯†ç»“åˆï¼Œå…è®¸å¼€å‘è€…æ ¹æ®éœ€è¦é€‰æ‹©å’Œç»„åˆå…¶ä»–åº“ã€‚å®ƒä¹Ÿå…¼å®¹ `tokio` å’Œ `async-std`ï¼Œé€šè¿‡ `async-compat` é€‚é…å™¨ï¼Œå¯ä»¥åœ¨ smol ä¸­è¿è¡ŒåŸºäºå…¶ä»–è¿è¡Œæ—¶ç¼–å†™çš„ä»£ç ã€‚
- **å¼ºè°ƒç®€æ´å’Œæ§åˆ¶ï¼š**`smol` çš„è®¾è®¡å“²å­¦æ˜¯å°½å¯èƒ½åœ°å‡å°‘é»˜è®¤çº¦å®šï¼Œè®©å¼€å‘è€…å¯¹å¼‚æ­¥è¡Œä¸ºæœ‰æ›´å¤šçš„æ§åˆ¶æƒã€‚

smolæä¾›äº†ä¸‹é¢å„ä¸ªæ¨¡å—ï¼š

![](https://static001.geekbang.org/resource/image/64/ea/640229141c544203dc8f76cf805fdaea.png?wh=2316x1504)

æˆ‘ä»¬é‡ç‚¹äº†è§£ä¸€ä¸‹å®ƒæ˜¯å¦‚ä½•è¿è¡Œå¼‚æ­¥ä»£ç çš„ã€‚å› ä¸ºå¼‚æ­¥ç”Ÿæ€åœˆå‡ ä¹è¢« `tokio` éœ¸å äº†ï¼Œå†åŠ ä¸Š `async_std` ä¹Ÿæœ‰ä¸€éƒ¨åˆ†äººåœ¨ä½¿ç”¨ï¼Œè™½ç„¶ `smol` å°å·§å¯çˆ±ï¼Œä¹Ÿæ˜¯å¤§ç¥åœ¨æ·±åº¦æ€è€ƒå¦èµ·ç‚‰ç¶å¼€å‘çš„ä¸€ä¸ªå¼‚æ­¥è¿è¡Œæ—¶ï¼Œä½¿ç”¨çš„äººè¿˜æ˜¯ç›¸å¯¹è¾ƒå°‘ï¼Œæˆ‘ä¹Ÿæ˜¯åœ¨æµ‹è¯•å’ŒæŠ€æœ¯éªŒè¯çš„æ—¶å€™æ‰ä½¿ç”¨å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å»ä»‹ç»å®ƒçš„å„ä¸ªæ¨¡å—çš„ç»†èŠ‚äº†ï¼Œæš‚æ—¶å…ˆäº†è§£å®ƒçš„åŸºæœ¬è¿è¡Œå¼‚æ­¥ä»»åŠ¡å°±å¥½ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä»£ç ï¼Œå…¶ä¸­çš„ `spawn` å’Œ `block_on` æˆ‘ä»¬å·²ç»å¾ˆç†Ÿæ‚‰äº†ã€‚

```rust
fn main() {
    let task = smol::spawn(async {
        1 + 2
    });
    
    smol::block_on(async {
        assert_eq!(task.await, 3);
    });
}
```

`spawn` å°†ä¸€ä¸ªä»»åŠ¡æ´¾ç”Ÿåˆ°å…¨å±€æ‰§è¡Œå™¨ï¼ˆé»˜è®¤æƒ…å†µä¸‹æ˜¯å•çº¿ç¨‹çš„ï¼‰ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå…¨å±€æ‰§è¡Œå™¨ï¼Œå®ƒä¼šåœ¨é¦–æ¬¡ä½¿ç”¨æ—¶æƒ°æ€§åˆå§‹åŒ–ã€‚åœ¨ç¼–å†™å•å…ƒæµ‹è¯•å’Œå°å‹ç¨‹åºæ—¶ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæ­¤åº“åŒ…å«äº†å®ƒï¼Œä½†åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œæ›´å»ºè®®åˆ›å»ºä½ è‡ªå·±çš„ `Executor`ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå…¨å±€æ‰§è¡Œå™¨ç”±å•ä¸ªåå°çº¿ç¨‹è¿è¡Œï¼Œä½†ä½ ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½® `SMOL_THREADS` ç¯å¢ƒå˜é‡æ¥é…ç½®çº¿ç¨‹æ•°ã€‚

`unblock` åœ¨ä¸€ä¸ªçº¿ç¨‹æ± ä¸­æ‰§è¡Œé˜»å¡ä»£ç ï¼š

```rust
use std::io::Read;
use std::fs::File;

async fn read_file(path: &str) -> std::io::Result<String> {
    let path = path.to_string();
    smol::unblock(move || {
        let mut file = File::open(path)?;
        let mut contents = String::new();
        file.read_to_string(&mut contents)?;
        Ok(contents)
    })
    .await
}

fn main() {
    smol::block_on(async {
        match read_file("Cargo.toml").await {
            Ok(contents) => println!("æ–‡ä»¶å†…å®¹ï¼š{}", contents),
            Err(err) => eprintln!("è¯»å–æ–‡ä»¶å‡ºé”™ï¼š{}", err),
        }
    });
}
```

**smol::block\_on VS smol::unblock**

![](https://static001.geekbang.org/resource/image/07/2d/0741313f64c57501f68c059057e5332d.jpg?wh=2810x1320)

å¦å¤–è¿˜å­˜åœ¨ä¸‹é¢å‡ ä¸ªå¼‚æ­¥è¿è¡Œæ—¶ï¼š

- **embassyï¼š**ä¸€ä¸ªé¢å‘åµŒå…¥å¼ç³»ç»Ÿçš„å¼‚æ­¥è¿è¡Œæ—¶ã€‚
- **glommioï¼š**ä¸€ä¸ªé¢å‘ I/O å¯†é›†å‹å·¥ä½œè´Ÿè½½çš„å¼‚æ­¥è¿è¡Œæ—¶ï¼Œæ„å»ºäº `io_uring` ä¹‹ä¸Šï¼Œå¹¶ä½¿ç”¨ `thread-per-core` çš„æ¨¡å‹ã€‚
- **å­—èŠ‚è·³åŠ¨** **monoio**ï¼šå­—èŠ‚è·³åŠ¨æœåŠ¡æ¡†æ¶ç»„å¼€æºçš„åŸºäº `io-uring` çš„ `thread-per-core` æ¨¡å‹å¼‚æ­¥è¿è¡Œæ—¶ã€‚

## æ€»ç»“

å¥½äº†ï¼Œåœ¨è¿™ä¸€èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬é‡ç‚¹ä»‹ç»äº†å¦å¤–ä¸¤ä¸ªå¼‚æ­¥è¿è¡Œæ—¶ `async_std` å’Œ `smol`ï¼Œä¹Ÿæåˆ°äº†å…¶ä»–ä¸€äº›æœ‰ç‰¹è‰²çš„å¼‚æ­¥è¿è¡Œæ—¶ã€‚

2024å¹´æœ‰ä¸€ç¯‡æ–‡ç«  [Rustå¼‚æ­¥ç°çŠ¶ï¼šè¿è¡Œæ—¶](https://corrode.dev/blog/async/)ï¼Œå¯¹å½“å‰çš„å¼‚æ­¥è¿è¡Œæ—¶è¿›è¡Œäº†åˆ†æã€‚å¦‚æœæˆ‘ä»¬è§‚å¯Ÿasync\_stdä»£ç è´¡çŒ®æ´»è·ƒåº¦ï¼Œä¼šå‘ç°è‡ª2021å¹´åè¿™ä¸ªé¡¹ç›®å·²ç»ä¸æ´»è·ƒäº†ï¼Œè¿™ä¹Ÿå¯¼è‡´ä¸€äº›åº“å¼ƒç”¨å®ƒè€Œè½¬å‘tokioã€‚

![](https://static001.geekbang.org/resource/image/6b/df/6b11bb6e17e6424c6103de1c416e2fdf.png?wh=1666x660)

è€ŒTokioä¾ç„¶ä¿æŒæ´»è·ƒï¼š

![](https://static001.geekbang.org/resource/image/e9/2e/e9b29b1f0f8c4734d207ff02cyy4f72e.png?wh=1660x666)

smolè¿˜æ˜¯æœ‰è´¡çŒ®è€…æ—¶ä¸æ—¶åœ°æäº¤ï¼š

![](https://static001.geekbang.org/resource/image/52/3a/529446aaf7790d6fca8ccf4d4f22bd3a.png?wh=1660x666)

æœ‰å¤šä¸ªå¼‚æ­¥è¿è¡Œæ—¶ä¸ä¸€å®šæ˜¯å¥½äº‹ï¼Œè¿™å¯¼è‡´æˆ‘ä»¬åœ¨ç¼–ç çš„æ—¶å€™éš¾ä»¥æŠ‰æ‹©ã€‚å¯¹äºåº“çš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬ä¸å¾—ä¸é€‰æ‹©å…¶ä¸­ä¸€ä¸ªå¼‚æ­¥è¿è¡Œæ—¶æ¥æ”¯æŒå¼‚æ­¥ä»£ç ï¼Œå¦åˆ™æ”¯æŒæ‰€æœ‰çš„å¼‚æ­¥è¿è¡Œæ—¶å°±å¤ªå èµ„æºäº†ï¼Œä¸»è¦çš„åŸå› æ˜¯è¿™äº›å¼‚æ­¥è¿è¡Œæ—¶ä¸å…¼å®¹ï¼Œå³ä½¿æœ‰å…¼å®¹åº“ä¹Ÿä¸æ˜¯å¾ˆå®Œå¤‡ã€‚

å°±ç›®å‰æƒ…å½¢æ¥è¯´ï¼ŒTokioå¯èƒ½æ˜¯æœ€å¥½çš„é€‰æ‹©äº†ã€‚

## æ€è€ƒé¢˜

è¯·ä½ ä½¿ç”¨Tikioå®ç°ä¸€ä¸ªå‡»é¼“ä¼ èŠ±çš„æ¸¸æˆï¼Œå››ä¸ªä»»åŠ¡ï¼Œåç§°åˆ†åˆ«æ˜¯ä¸œå—è¥¿åŒ—ï¼ŒæŒ‰ç…§é¡ºåºä¾æ¬¡åœ¨ä»»åŠ¡é—´ä¼ é€’ğŸ’ï¼Œéšæœºåœ¨æŸæ¬¡åœæ­¢ä¼ ğŸ’ï¼Œç¨‹åºé€€å‡ºã€‚æ¯ä¸ªä»»åŠ¡æ‹¿åˆ°ğŸ’åæ‰“å°å‡ºè‡ªå·±çš„åç§°ï¼Œè¾“å‡ºç»“æœå¦‚â€œä¸œå—è¥¿åŒ—ä¸œå—è¥¿åŒ—ä¸œå—â€ã€‚

æ¬¢è¿ä½ æŠŠä½ å®ç°çš„ä»£ç åˆ†äº«åˆ°ç•™è¨€åŒºï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµè®¨è®ºï¼Œå¦‚æœä½ è§‰å¾—è¿™èŠ‚è¯¾çš„å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼