ä½ å¥½ï¼Œæˆ‘æ˜¯æœ±æ¶›ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬æ¥èŠèŠAndroidçš„Jetpackã€‚

åœ¨æˆ‘çœ‹æ¥ï¼ŒKotlinå’ŒJetpackï¼Œå®ƒä»¬ä¸¤ä¸ªç®€ç›´å°±æ˜¯å¤©ç”Ÿä¸€å¯¹ã€‚ä½œä¸ºAndroidå¼€å‘è€…ï¼Œå¦‚æœåªç”¨Kotlinä¸ç”¨Jetpackï¼Œæˆ‘ä»¬å…¶å®å¾ˆéš¾åœ¨Androidå¹³å°å……åˆ†å‘æŒ¥Kotlinçš„è¯­è¨€ä¼˜åŠ¿ã€‚è€Œå¦‚æœæˆ‘ä»¬åªç”¨Jetpackè€Œä¸ç”¨Kotlinï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å°†åªèƒ½ç”¨åˆ°Jetpackçš„å°éƒ¨åˆ†åŠŸèƒ½ã€‚æ¯•ç«Ÿï¼ŒJetpackå½“ä¸­æœ‰å¾ˆå¤šAPIå’Œåº“ï¼Œæ˜¯ä¸“é—¨ä¸ºKotlinæä¾›çš„ã€‚

ç»è¿‡å‰é¢è¯¾ç¨‹å†…å®¹çš„å­¦ä¹ ï¼Œç›¸ä¿¡ç°åœ¨ä½ å·²ç»å¯¹Kotlinååˆ†ç†Ÿæ‚‰äº†ï¼Œé‚£ä¹ˆï¼Œæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬æ¥çœ‹çœ‹Jetpackå§ï¼è¿™èŠ‚è¯¾é‡Œï¼Œæˆ‘ä¼šä¸ºä½ ä»‹ç»Jetpackæ ¸å¿ƒåº“çš„åŸºæœ¬æ¦‚å¿µã€ç®€å•ç”¨æ³•ï¼Œä»¥åŠå®ƒè·ŸKotlinä¹‹é—´çš„å…³ç³»ï¼Œä»è€Œä¹Ÿä¸ºæˆ‘ä»¬ä¸‹èŠ‚è¯¾çš„å®æˆ˜é¡¹ç›®æ‰“ä¸‹åŸºç¡€ã€‚

## Jetpackç®€ä»‹

Jetpackï¼Œå®ƒæœ‰â€œå–·æ°”å¼èƒŒåŒ…â€çš„æ„æ€ã€‚å¯¹äºæˆ‘ä»¬å¼€å‘è€…æ¥è¯´ï¼Œå®ƒå…¶å®å°±æ˜¯Googleå®˜æ–¹ä¸ºæˆ‘ä»¬æä¾›çš„ä¸€å¥—å¼€å‘å¥—ä»¶ï¼Œä¸“é—¨ç”¨æ¥å¸®åŠ©Androidå¼€å‘è€…æå‡å¼€å‘æ•ˆç‡ã€æå‡åº”ç”¨ç¨³å®šæ€§çš„ã€‚

[![](https://static001.geekbang.org/resource/image/ba/c2/ba1e45560e1e6510591d75ee6ee862c2.jpg?wh=600x600)](https://android-developers.googleblog.com/2019/05/whats-new-with-android-jetpack.html)

Android Jetpackï¼Œæœ€åˆçš„å®£ä¼ å›¾æ ‡ï¼Œå°±æ˜¯â€œç©¿ç€å–·æ°”å¼èƒŒåŒ…çš„Androidæœºå™¨äººâ€ã€‚å¤§æ¦‚æ„æ€å°±æ˜¯ï¼šæœ‰äº†Jetpackï¼ŒAndroidå°±èƒ½â€œèµ·é£äº†â€ã€‚è¿™å½“ç„¶åªæ˜¯ä¸€ç§å¤¸å¼ çš„æ¯”å–»ï¼Œä¸è¿‡ï¼Œä»æˆ‘å®é™…çš„å¼€å‘ä½“éªŒæ¥è¯´ï¼ŒJetpackç¡®å®å¯ä»¥ç»™Androidå¼€å‘è€…å¸¦æ¥æå¤§çš„å¥½å¤„ï¼Œå°¤å…¶æ˜¯å½“Jetpackä¸Kotlinç»“åˆåˆ°ä¸€èµ·çš„æƒ…å†µä¸‹ã€‚

æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹KTXã€‚

## KTX

KTXæ˜¯Jetpackå½“ä¸­æœ€ç‰¹æ®Šçš„ä¸€ç±»åº“ï¼Œå®ƒæ˜¯ç”±Kotlinç¼–å†™çš„ï¼ŒåŒæ—¶ä¹Ÿä»…ä¸ºKotlinå¼€å‘è€…æœåŠ¡ï¼Œä½¿ç”¨Javaè¯­è¨€çš„Androidå¼€å‘è€…æ˜¯ç”¨ä¸äº†çš„ã€‚KTXï¼Œå®ƒçš„ä½œç”¨å…¶å®æ˜¯å¯¹å½“å‰Androidç”Ÿæ€å½“ä¸­çš„APIè¿›è¡Œé¢å¤–è¡¥å……ã€‚å®ƒä¾æ‰˜Kotlinçš„æ‰©å±•èƒ½åŠ›ï¼Œä¸ºAndroidåŸæœ‰APIå¢åŠ æ–°çš„ï¼šæ‰©å±•å‡½æ•°ã€æ‰©å±•å±æ€§ã€é«˜é˜¶å‡½æ•°ã€å‘½åå‚æ•°ã€å‚æ•°é»˜è®¤å€¼ã€åç¨‹æ”¯æŒã€‚

å¦‚æœæˆ‘ä»¬æƒ³è¦ä½¿ç”¨KTXçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦å•ç‹¬è¿›è¡Œä¾èµ–ï¼š

```groovy
// ä»£ç æ®µ1

dependencies {
    implementation "androidx.core:core-ktx:1.7.0"
}
```

è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…³äºSharedPreferenceçš„ç®€å•ä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨Javaï¼Œæˆ‘ä»¬å¤§æ¦‚ç‡æ˜¯éœ€è¦å†™ä¸€å †æ¨¡æ¿ä»£ç çš„ï¼Œç±»ä¼¼è¿™æ ·ï¼š

```java
// ä»£ç æ®µ2

SharedPreferences sharedPreferences= getSharedPreferences("data",Context.MODE_PRIVATE);
SharedPreferences.Editor editor = sharedPreferences.edit();
editor.putString(SP_KEY_RESPONSE, response);

editor.commit();
editor.apply();
```

ä¸è¿‡ï¼Œå¦‚æœæˆ‘ä»¬æœ‰äº†KTXï¼Œé‚£ä¹ˆä»£ç å°±ä¼šå˜å¾—æå…¶ç®€å•ï¼š

```plain
// ä»£ç æ®µ3

preference.edit { putBoolean("key", value) }
```

ä¸Šé¢çš„è¿™ä¸ªedit()æ–¹æ³•ï¼Œå…¶å®æ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œå®ƒæ˜¯ç”±KTXæä¾›çš„ï¼Œå¦‚æœä½ å»çœ‹å®ƒçš„æºä»£ç ï¼Œä¼šå‘ç°ï¼Œå®ƒå…¶å®å°±æ˜¯ä¸€ä¸ªæ‰©å±•å‡ºæ¥çš„é«˜é˜¶å‡½æ•°ï¼š

```plain
// ä»£ç æ®µ4

inline fun SharedPreferences.edit(
        commit: Boolean = false,
        action: SharedPreferences.Editor.() -> Unit
) {
    val editor = edit()
    action(editor)
    if (commit) {
        editor.commit()
    } else {
        editor.apply()
    }
}
```

å¯ä»¥çœ‹åˆ°ï¼ŒKTXå…¶å®å°±æ˜¯å°†ä¸€äº›å¸¸è§çš„æ¨¡æ¿ä»£ç å°è£…äº†èµ·æ¥ï¼Œç„¶åä»¥æ‰©å±•å‡½æ•°çš„å½¢å¼æä¾›ç»™å¼€å‘è€…ã€‚è™½ç„¶å®ƒè‡ªèº«çš„åŸç†å¾ˆç®€å•ï¼Œä½†æ˜¯å´å¯ä»¥å¤§å¤§æå‡å¼€å‘è€…çš„æ•ˆç‡ã€‚

KTXé™¤äº†èƒ½å¤Ÿæ‰©å±•Android SDKçš„APIä»¥å¤–ï¼Œå®ƒè¿˜å¯ä»¥æ‰©å±•Jetpackå½“ä¸­å…¶ä»–çš„åº“ï¼Œæ¯”å¦‚è¯´LiveDataã€Roomç­‰ç­‰ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹Jetpackå½“ä¸­æ¯”è¾ƒæ ¸å¿ƒçš„åº“ï¼šLifecycleã€‚

## Lifecycle

Lifecycleï¼Œå…¶å®å°±æ˜¯Androidçš„ç”Ÿå‘½å‘¨æœŸç»„ä»¶ã€‚åœ¨æ•´ä¸ªJetpackç»„ä»¶å½“ä¸­çš„åœ°ä½éå¸¸ç‰¹æ®Šï¼Œæ˜¯å¿…å­¦çš„ç»„ä»¶ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå…¶ä»–çš„ç»„ä»¶æ¯”å¦‚WorkManagerï¼Œå¦‚æœæˆ‘ä»¬å®é™…å·¥ä½œä¸­ç”¨ä¸ä¸Šï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸å»å­¦å®ƒæ˜¯ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜çš„ã€‚Lifecycleä¸ä¸€æ ·ï¼Œåªè¦æˆ‘ä»¬æ˜¯åšAndroidå¼€å‘çš„ï¼Œæˆ‘ä»¬å°±ç»•ä¸å¼€Lifecycleã€‚Activityé‡Œé¢æœ‰Lifecycleï¼›Fragmenté‡Œé¢ä¹Ÿæœ‰ï¼›LiveDataé‡Œé¢ä¹Ÿæœ‰ï¼›

ViewModelåº•å±‚ä¹Ÿç”¨åˆ°äº†Lifecycleï¼›ä½¿ç”¨åç¨‹ä¹Ÿç¦»ä¸å¼€Lifecycleã€‚

é‚£ä¹ˆï¼ŒLifecycleåˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å¹³æ—¶æåˆ°ç”Ÿå‘½å‘¨æœŸï¼Œå¾€å¾€éƒ½æ˜¯è¯´çš„Activityã€Fragmentï¼Œè€Œå®ƒä»¬ä¸¤è€…ä¹‹é—´å´æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œ**ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸ä¸€è‡´**ã€‚

Activityçš„ç”Ÿå‘½å‘¨æœŸæˆ‘ä»¬è‚¯å®šå¿ƒé‡Œæœ‰æ•°ï¼Œä¸è¿‡Fragmentç”Ÿå‘½å‘¨æœŸå‡½æ•°æ¯”Activityå¤šäº†å‡ ä¸ªï¼šonCreateViewã€onViewCreatedã€onViewStateRestoreã€onDestoryViewã€‚æœ€é‡è¦çš„æ˜¯ï¼ŒFragmentç”Ÿå‘½å‘¨æœŸã€å›è°ƒå‡½æ•°ã€Fragmentå†…éƒ¨Viewçš„ç”Ÿå‘½å‘¨æœŸï¼Œå®ƒä»¬ä¸‰è€…ä¹‹é—´è¿˜æœ‰å¾ˆå¤æ‚çš„å¯¹åº”å…³ç³»ã€‚æ¢å¥è¯è¯´ï¼ŒFragmentçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°è¦æ¯”Activityå¤æ‚ä¸€äº›ã€‚

åŠ ä¹‹ï¼ŒActivityå’ŒFragmentç»“åˆçš„æƒ…å†µä¸‹ï¼Œå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸè¡Œä¸ºåœ¨ä¸åŒç‰ˆæœ¬çš„Androidç³»ç»Ÿä¸Šè¡Œä¸ºå¯èƒ½è¿˜ä¼šä¸ä¸€è‡´ã€‚è¿™åœ¨æŸäº›è¾¹ç•Œæ¡ä»¶ä¸‹ï¼Œè¿˜ä¼šå¼•å‘ä¸€äº›éš¾ä»¥æ’æŸ¥çš„bugï¼Œè¿›ä¸€æ­¥å¢åŠ æˆ‘ä»¬Androidç¨‹åºå‘˜çš„ç»´æŠ¤æˆæœ¬ã€‚

åœ¨è®¡ç®—æœºä¸–ç•Œé‡Œï¼Œå¤§éƒ¨åˆ†é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªæŠ½è±¡å±‚æ¥è§£å†³ã€‚Androidå›¢é˜Ÿçš„åšæ³•å°±æ˜¯æ¨å‡ºäº†Lifecycleè¿™ä¸ªæ¶æ„ç»„ä»¶ï¼Œç”¨å®ƒæ¥ç»Ÿä¸€Activityã€Fragmentçš„ç”Ÿå‘½å‘¨æœŸè¡Œä¸ºã€‚

![](https://static001.geekbang.org/resource/image/f0/a1/f03yy1b87813c58f5591aab720e432a1.jpg?wh=2000x904)

æœ‰äº†LifeCycleä»¥åï¼Œæˆ‘ä»¬å¼€å‘è€…å°±å¯ä»¥é¢å‘Lifecycleç¼–ç¨‹ã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›å®ç°ä¸€ä¸ªé€šç”¨çš„åœ°ç†ä½ç½®ç›‘å¬çš„Managerï¼Œå°±å¯ä»¥è¿™æ ·æ¥åšï¼š

```plain
// ä»£ç æ®µ5

// ä¸å…³å¿ƒè°ƒç”¨æ–¹æ˜¯Activityè¿˜æ˜¯Fragment
class LocationManager(
    private val context: Context,
    private val callback: (Location) -> Unit
): DefaultLifecycleObserver {

    override fun onStart(owner: LifecycleOwner) {
        start()
    }

    override fun onStop(owner: LifecycleOwner) {
        stop()
    }

    private fun start() {
        // ä½¿ç”¨é«˜å¾·ä¹‹ç±»çš„ SDK è¯·æ±‚åœ°ç†ä½ç½®
    }

    private fun stop() {
        // åœæ­¢
    }
}

class LifecycleExampleActivity : AppCompatActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_life_cycle_example)

        val locationManager = LocationManager(this) {
            // å±•ç¤ºåœ°ç†ä½ç½®ä¿¡æ¯
        }
        lifecycle.addObserver(locationManager)
    }
}
```

ä¸Šé¢ä»£ç çš„LocationManageråªéœ€è¦å®ç°DefaultLifecycleObserverè¿™ä¸ªæ¥å£å³å¯ï¼Œå¤–éƒ¨æ˜¯åœ¨Activityè¿˜æ˜¯åœ¨Fragmentå½“ä¸­ä½¿ç”¨ï¼Œæ ¹æœ¬ä¸å¿…å…³å¿ƒã€‚

### Lifecycleä¸åç¨‹

é€šè¿‡å‰é¢è¯¾ç¨‹çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œåç¨‹å…¶å®ä¹Ÿæ˜¯æœ‰ç”Ÿå‘½å‘¨æœŸçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒAndroidå’ŒKotlinåç¨‹éƒ½æ˜¯æœ‰ç”Ÿå‘½å‘¨æœŸçš„ã€‚è¿™å°±æ„å‘³ç€ï¼Œå½“æˆ‘ä»¬åœ¨Androidå½“ä¸­ä½¿ç”¨åç¨‹çš„æ—¶å€™ï¼Œå°±è¦æ ¼å¤–å°å¿ƒã€‚

ä½œä¸ºAndroidå¼€å‘è€…ï¼Œä½ ä¸€å®šçŸ¥é“å†…å­˜æ³„æ¼çš„æ¦‚å¿µï¼šå½“å†…å­˜å˜é‡çš„ç”Ÿå‘½å‘¨æœŸå¤§äºAndroidç”Ÿå‘½å‘¨æœŸçš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±è®¤ä¸ºå†…å­˜å‘ç”Ÿæ³„æ¼äº†ã€‚ç±»ä¼¼çš„ï¼Œå½“åç¨‹çš„ç”Ÿå‘½å‘¨æœŸå¤§äºAndroidç”Ÿå‘½å‘¨æœŸçš„æ—¶å€™ï¼Œ**åç¨‹ä¹Ÿå°±å‘ç”Ÿæ³„æ¼äº†**ã€‚

è¿™ä¸€ç‚¹ï¼ŒAndroidå®˜æ–¹æ—©å°±å¸®æˆ‘ä»¬è€ƒè™‘åˆ°äº†ã€‚Lifecycleè¿˜å¯ä»¥è·Ÿæˆ‘ä»¬å‰é¢æåˆ°çš„KTXç»“åˆåˆ°ä¸€èµ·ï¼Œè¿›ä¸€æ­¥ä¸ºKotlinåç¨‹æä¾›æ”¯æŒã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/ba/5c/ba1d19579cd0e6e6a8e4e004732c705c.png?wh=884x456)

åœ¨Activityã€Fragmentå½“ä¸­ï¼ŒKTXè¿˜æä¾›äº†å¯¹åº”çš„lifecycleScopeï¼Œå®ƒæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªï¼šä¸ç”Ÿå‘½å‘¨æœŸç»‘å®šçš„åç¨‹ä½œç”¨åŸŸã€‚

```plain
// ä»£ç æ®µ6

// 1
public val LifecycleOwner.lifecycleScope: LifecycleCoroutineScope
    // 2
    get() = lifecycle.coroutineScope

public abstract class LifecycleCoroutineScope internal constructor() : CoroutineScope {
    internal abstract val lifecycle: Lifecycle

    public fun launchWhenCreated(block: suspend CoroutineScope.() -> Unit): Job = launch {
        lifecycle.whenCreated(block)
    }

    public fun launchWhenStarted(block: suspend CoroutineScope.() -> Unit): Job = launch {
        lifecycle.whenStarted(block)
    }

    public fun launchWhenResumed(block: suspend CoroutineScope.() -> Unit): Job = launch {
        lifecycle.whenResumed(block)
    }
}
```

åœ¨Androidå½“ä¸­ï¼ŒActivityå’ŒFragmentéƒ½ä¼šå®ç°LifecycleOwnerè¿™ä¸ªæ¥å£ï¼Œä»£è¡¨å®ƒä»¬éƒ½æ˜¯æ‹¥æœ‰ç”Ÿå‘½å‘¨æœŸçš„ç»„ä»¶ã€‚æ³¨é‡Š1å¤„ï¼Œè¿™é‡Œä½¿ç”¨äº†Kotlinçš„æ‰©å±•å±æ€§ï¼Œä¸ºLifecycleOwneræ‰©å±•äº†lifecycleScopeã€‚å®ƒçš„ç±»å‹æ˜¯LifecycleCoroutineScopeï¼Œè€Œå®ƒå…¶å®å°±æ˜¯CoroutineScopeçš„å®ç°ç±»ã€‚

lifecycleScopeè¿™ä¸ªå±æ€§çš„å…·ä½“å®ç°ï¼Œå…¶å®æ˜¯é€šè¿‡æ³¨é‡Š2å¤„çš„è‡ªå®šä¹‰getter()å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯ï¼šLifecycle.coroutineScopeã€‚

```plain
// ä»£ç æ®µ7

public val Lifecycle.coroutineScope: LifecycleCoroutineScope
    get() {
        while (true) {
            // 1
            val existing = mInternalScopeRef.get() as LifecycleCoroutineScopeImpl?
            if (existing != null) {
                return existing
            }
            // 2
            val newScope = LifecycleCoroutineScopeImpl(
                this,
                SupervisorJob() + Dispatchers.Main.immediate
            )
            //3
            if (mInternalScopeRef.compareAndSet(null, newScope)) {
                newScope.register()
                return newScope
            }
        }
    }
```

å¯ä»¥çœ‹åˆ°ï¼ŒLifecycle.coroutineScopeä»ç„¶æ˜¯ä¸€ä¸ªæ‰©å±•å±æ€§ã€‚å®ƒçš„é€»è¾‘å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œä¸»è¦æ˜¯åˆ†ä¸ºäº†ä¸‰ä¸ªæ­¥éª¤ï¼š

- ç¬¬ä¸€æ­¥ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¼“å­˜çš„CoroutineScopeï¼Œå¦‚æœå­˜åœ¨ï¼Œé‚£å°±ç›´æ¥è¿”å›å³å¯ã€‚
- ç¬¬äºŒæ­¥ï¼Œå¦‚æœä¸å­˜åœ¨ç¼“å­˜ï¼Œé‚£å°±åˆ›å»ºä¸€ä¸ªæ–°çš„åç¨‹ä½œç”¨åŸŸã€‚åœ¨åˆ›å»ºçš„ä½œç”¨åŸŸçš„æ—¶å€™ï¼Œç”¨åˆ°äº†ä¸¤ä¸ªæˆ‘ä»¬ç†Ÿæ‚‰çš„æ¦‚å¿µï¼šSupervisorJobã€Dispatchers.Mainï¼Œå®ƒä»¬éƒ½æ˜¯åç¨‹ä¸Šä¸‹æ–‡çš„å…ƒç´ ï¼Œ**å‰è€…æ˜¯ç”¨æ¥éš”ç¦»åç¨‹å¼‚å¸¸ä¼ æ’­çš„ï¼Œåè€…æ˜¯æŒ‡å®šåç¨‹æ‰§è¡Œçº¿ç¨‹çš„**ã€‚
- ç¬¬ä¸‰æ­¥ï¼Œæ›´æ–°ç¼“å­˜ï¼Œå¹¶ä¸”è°ƒç”¨register()ç»‘å®šscopeä¸Lifecycleçš„å…³ç³»ï¼Œæœ€åè¿”å›ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ‰“ç ´ç ‚é”…é—®åˆ°åº•ï¼Œçœ‹çœ‹register()çš„å…·ä½“é€»è¾‘æ˜¯ä»€ä¹ˆï¼š

```plain
// ä»£ç æ®µ8

internal class LifecycleCoroutineScopeImpl(
    override val lifecycle: Lifecycle,
    override val coroutineContext: CoroutineContext
    // 2
) : LifecycleCoroutineScope(), LifecycleEventObserver {
    init {
        if (lifecycle.currentState == Lifecycle.State.DESTROYED) {
            coroutineContext.cancel()
        }
    }

    // 1
    fun register() {
        launch(Dispatchers.Main.immediate) {
            if (lifecycle.currentState >= Lifecycle.State.INITIALIZED) {
                lifecycle.addObserver(this@LifecycleCoroutineScopeImpl)
            } else {
                coroutineContext.cancel()
            }
        }
    }

    // 3
    override fun onStateChanged(source: LifecycleOwner, event: Lifecycle.Event) {
        if (lifecycle.currentState <= Lifecycle.State.DESTROYED) {
            lifecycle.removeObserver(this)
            coroutineContext.cancel()
        }
    }
}

public interface LifecycleEventObserver extends LifecycleObserver {
    void onStateChanged(@NonNull LifecycleOwner source, @NonNull Lifecycle.Event event);
}
```

ä¸Šé¢çš„ä»£ç ä¸€å…±æœ‰ä¸‰ä¸ªæ³¨é‡Šï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥çœ‹ï¼š

- æ³¨é‡Š1ï¼Œregister()ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå®ƒçš„é€»è¾‘å…¶å®å¾ˆç®€å•ï¼Œä¸»è¦å°±æ˜¯è°ƒç”¨äº†addObserver()ï¼Œå°†è‡ªèº«ä½œä¸ºè§‚å¯Ÿè€…ä¼ äº†è¿›å»ã€‚ä¹‹æ‰€ä»¥å¯ä»¥è¿™ä¹ˆåšï¼Œè¿˜æ˜¯å› ä¸ºæ³¨é‡Š2å¤„çš„LifecycleEventObserverã€‚
- æ³¨é‡Š2ï¼ŒLifecycleEventObserverï¼Œå®ƒå…¶å®å°±æ˜¯ä¸€ä¸ªSAMæ¥å£ï¼Œæ¯å½“LifeCycleOwnerçš„ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œè¿™ä¸ªonStateChanged()æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ã€‚è€Œè¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°åˆ™åœ¨æ³¨é‡Š3å¤„ã€‚
- æ³¨é‡Š3ï¼Œè¿™é‡Œçš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå½“LifeCycleOwnerå¯¹åº”çš„Activityã€Fragmentè¢«é”€æ¯ä»¥åï¼Œå°±ä¼šè°ƒç”¨removeObserver(this)ç§»é™¤è§‚å¯Ÿè€…ï¼Œæœ€åï¼Œå°±æ˜¯æœ€å…³é”®çš„coroutineContext.cancel()ï¼Œå–æ¶ˆæ•´ä¸ªä½œç”¨åŸŸé‡Œæ‰€æœ‰çš„åç¨‹ä»»åŠ¡ã€‚

è¿™æ ·ä¸€æ¥ï¼Œå°±èƒ½ä¿è¯LifeCycleä¸åç¨‹çš„ç”Ÿå‘½å‘¨æœŸå®Œå…¨ä¸€è‡´äº†ï¼Œä¹Ÿå°±ä¸ä¼šå‡ºç°åç¨‹æ³„æ¼çš„é—®é¢˜äº†ã€‚

## å°ç»“

è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä¸»è¦äº†è§£äº†Androidå½“ä¸­çš„Jetpackï¼Œå®ƒæ˜¯Androidå®˜æ–¹æä¾›ç»™å¼€å‘è€…çš„ä¸€ä¸ªå¼€å‘å¥—ä»¶ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¼€å‘è€…æå‡å¼€å‘æ•ˆç‡ã€‚Jetpackå½“ä¸­å…¶å®æœ‰[å‡ åä¸ªåº“](https://developer.android.com/jetpack)ï¼Œåœ¨è¿™èŠ‚è¯¾é‡Œï¼Œæˆ‘ä»¬æ˜¯ç€é‡è®²è§£äº†å…¶ä¸­çš„KTXä¸LifeCycleã€‚

- KTXï¼Œä¸»è¦æ˜¯ä¾æ‰˜Kotlinçš„æ‰©å±•èƒ½åŠ›ï¼Œä¸ºAndroidåŸæœ‰APIå¢åŠ æ–°çš„ï¼šæ‰©å±•å‡½æ•°ã€æ‰©å±•å±æ€§ã€é«˜é˜¶å‡½æ•°ã€å‘½åå‚æ•°ã€å‚æ•°é»˜è®¤å€¼ã€åç¨‹æ”¯æŒã€‚
- Lifecycleï¼Œå…¶å®å°±æ˜¯Androidçš„ç”Ÿå‘½å‘¨æœŸç»„ä»¶ã€‚å®ƒç»Ÿä¸€å°è£…äº†Activityã€Fragmentç­‰Androidç”Ÿå‘½å‘¨æœŸçš„ç»„ä»¶ã€‚è®©æˆ‘ä»¬å¼€å‘è€…å¯ä»¥åªå…³æ³¨LifeCycleçš„ç”Ÿå‘½å‘¨æœŸï¼Œè€Œä¸ç”¨åœ¨æ„å…¶ä»–ç»†èŠ‚ã€‚
- KTXè¿˜ä¸ºLifeCycleå¢åŠ äº†åç¨‹æ”¯æŒï¼Œä¹Ÿå°±æ˜¯lifecycleScopeã€‚åœ¨å®ƒçš„åº•å±‚ï¼Œè¿™ä¸ªåç¨‹ä½œç”¨åŸŸå’Œå®¿ä¸»çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œäº†ç»‘å®šã€‚å½“å®¿ä¸»è¢«é”€æ¯ä»¥åï¼Œå®ƒå¯ä»¥ç¡®ä¿lifecycleScopeå½“ä¸­çš„åç¨‹ä»»åŠ¡ï¼Œä¹Ÿè·Ÿç€è¢«å–æ¶ˆã€‚

æ‰€ä»¥ï¼Œå¯¹äºAndroidå¼€å‘è€…æ¥è¯´ï¼ŒKotlinå’ŒJetpackæ˜¯ä¸€ä¸ªâ€œä½ ä¸­æœ‰æˆ‘ï¼Œæˆ‘ä¸­æœ‰ä½ â€çš„å…³ç³»ï¼Œæˆ‘ä»¬æŠŠå®ƒä»¬ç§°ä¸ºâ€œå¤©ç”Ÿä¸€å¯¹â€ä¸€ç‚¹å„¿ä¹Ÿä¸ä¸ºè¿‡ã€‚

## æ€è€ƒé¢˜

åœ¨Androidä¸­ä½¿ç”¨åç¨‹çš„æ—¶å€™ï¼Œé™¤äº†lifecycleScopeä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜ç»å¸¸ä¼šä½¿ç”¨ViewModelçš„viewModelScopeã€‚ä½ èƒ½ç»“åˆå‰é¢åç¨‹ç¯‡ã€æºç ç¯‡çš„çŸ¥è¯†ç‚¹ï¼Œåˆ†æå‡ºviewModelScopeçš„å®ç°åŸç†å—ï¼Ÿ

```plain
class MyViewModel : ViewModel() {
    private val _persons: MutableLiveData<List<Person>> = MutableLiveData()
    val persons: LiveData<List<Person>> = _persons

    fun loadPersons() {
        viewModelScope.launch {
            delay(500L)
            _persons.value = listOf(Person("Tom"), Person("Jack"))
        }
    }
}

// æ‰©å±•å±æ€§
public val ViewModel.viewModelScope: CoroutineScope
    get() {
        val scope: CoroutineScope? = this.getTag(JOB_KEY)
        if (scope != null) {
            return scope
        }
        return setTagIfAbsent(
            JOB_KEY,
            // å®ç°ç±»
            CloseableCoroutineScope(SupervisorJob() + Dispatchers.Main.immediate)
        )
    }

// å®ç°äº†Closeableçš„CoroutineScope
internal class CloseableCoroutineScope(context: CoroutineContext) : Closeable, CoroutineScope {
    override val coroutineContext: CoroutineContext = context

    override fun close() {
        // å–æ¶ˆ
        coroutineContext.cancel()
    }
}

public abstract class ViewModel {

    @Nullable
    private final Map<String, Object> mBagOfTags = new HashMap<>();
    private volatile boolean mCleared = false;


    @SuppressWarnings("WeakerAccess")
    protected void onCleared() {
    }

    @MainThread
    final void clear() {
        mCleared = true;

        if (mBagOfTags != null) {
            synchronized (mBagOfTags) {
                for (Object value : mBagOfTags.values()) {
                    // è°ƒç”¨scopeçš„close()
                    closeWithRuntimeException(value);
                }
            }
        }
        onCleared();
    }

    // scopeæš‚å­˜èµ·æ¥
    @SuppressWarnings("unchecked")
    <T> T setTagIfAbsent(String key, T newValue) {
        T previous;
        synchronized (mBagOfTags) {
            previous = (T) mBagOfTags.get(key);
            if (previous == null) {
                mBagOfTags.put(key, newValue);
            }
        }
        T result = previous == null ? newValue : previous;
        if (mCleared) {

            closeWithRuntimeException(result);
        }
        return result;
    }

    private static void closeWithRuntimeException(Object obj) {
        if (obj instanceof Closeable) {
            try {
                ((Closeable) obj).close();
            } catch (IOException e) {
                throw new RuntimeException(e);
            }
        }
    }
}
```
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ2ï¼‰</strong></div><ul>
<li><span>Paul Shan</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>æ€è€ƒé¢˜:viewModelScopeæ˜¯ä¸€ä¸ªCloseableCoroutineScopeï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯æ‡’åŠ è½½çš„ï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™æ‰ä¼šåˆ›å»ºï¼Œä¸€æ—¦åˆ›å»ºä»¥åï¼Œè¿™ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªcloseå‡½æ•°ï¼Œä¼šåœ¨ViewModel clearçš„æ—¶å€™è°ƒç”¨ï¼Œç¡®ä¿äº†viewModelScopeçš„Coroutine scopeå’ŒviewModelç”Ÿå‘½å‘¨æœŸä¸€è‡´ã€‚äº†viewModelScopeæ€»ä½“ä¸Šå’Œlifecycleçš„scopeå®ç°ç±»ä¼¼ã€‚åŒºåˆ«æ˜¯åˆ›å»ºçš„æ—¶å€™ï¼Œlifecycleç”¨çš„æ˜¯æ— é”+ä¸æ–­å¾ªç¯+compareAndSetæ–¹å¼ï¼Œè€ŒviewModelScopeå®ç°çš„æ˜¯synchronizedå¸¦é”çš„æ–¹å¼ï¼Œè¯·é—®è€å¸ˆAndroidä¸ºä»€ä¹ˆä¼šåœ¨ä¸¤ç§ç±»ä¼¼çš„æƒ…å†µä¸‹é‡‡ç”¨ä¸åŒçš„çº¿ç¨‹åŒæ­¥ç­–ç•¥?</p>2022-04-11</li><br/><li><span>é¥è¿œçš„æ•‘ä¸–ä¸»</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ3ï¼‰<p>Android KTX å·²ç»å½’æ¡£ï¼Œä¸æ¨èä½¿ç”¨äº†</p>2022-09-15</li><br/>
</ul>