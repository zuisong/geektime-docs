ä½ å¥½ï¼Œæˆ‘æ˜¯æœ±æ¶›ã€‚

åœ¨ä¸Šä¸€è®²å½“ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥ç ”ç©¶äº†KotlinæŒ‚èµ·å‡½æ•°çš„åŸç†ï¼Œå®é™…æ›´å¤šçš„æ˜¯åœ¨äº†è§£åç¨‹çš„â€œåŸºç¡€å±‚â€ã€‚è€Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä¼šå¼€å§‹ç ”ç©¶åç¨‹å¯åŠ¨çš„åŸç†ï¼Œæ¢ç´¢åç¨‹çš„â€œä¸­é—´å±‚â€ã€‚

åœ¨[ç¬¬26è®²](https://time.geekbang.org/column/article/495862)é‡Œï¼Œæˆ‘æ›¾æåˆ°è¿‡ï¼ŒKotlinçš„åç¨‹æ¡†æ¶å…¶å®å°±æ˜¯åç¨‹åŸºç¡€å…ƒç´ ç»„åˆå‡ºæ¥çš„æ¡†æ¶ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦å¼„æ‡‚Kotlinåç¨‹ï¼Œé¦–å…ˆå°±è¦å°†å®ƒçš„â€œåŸºç¡€å±‚â€ç†è§£é€å½»ã€‚

æ‰€ä»¥ä»Šå¤©ï¼Œæˆ‘è¿˜æ˜¯å†³å®šæ¥ä¸€æ¬¡åŠ é¤ï¼Œå¸¦ä½ ç³»ç»Ÿæ·±å…¥åœ°è®¤è¯†ä¸€ä¸‹Kotlinåç¨‹å½“ä¸­çš„åŸºç¡€å…ƒç´ ã€‚ç­‰ä½ å¯¹åç¨‹çš„åŸºç¡€å±‚æœ‰äº†æ·±å…¥è®¤è¯†ä»¥åï¼Œä¸‹èŠ‚è¯¾ç ”ç©¶åç¨‹å¯åŠ¨åŸç†å°±ä¼šè½»æ¾ä¸€äº›äº†ã€‚

## åç¨‹åŸºç¡€å…ƒç´ 

é€šè¿‡ç¬¬26è®²æˆ‘ä»¬ç°åœ¨å·²ç»çŸ¥é“ï¼ŒKotlinåç¨‹çš„åŸºç¡€å…ƒç´ å¤§è‡´æœ‰è¿™äº›ï¼šContinuationã€SafeContinuationã€CoroutineContextã€CombinedContextã€CancellationExceptionã€intrinsicsã€‚

![](https://static001.geekbang.org/resource/image/c6/ae/c65bbb36321c7683ea6d17155d2ee2ae.jpg?wh=2000x1125)

å…¶ä¸­çš„CoroutineContextã€CancellationExceptionæˆ‘éƒ½å·²ç»ä»‹ç»è¿‡äº†ï¼Œå¦å¤–çš„CombinedContextï¼Œå…¶å®å°±æ˜¯CoroutineContextçš„ä¸€ä¸ªå®ç°ç±»ï¼Œè€ŒSafeContinuationåˆ™æ˜¯Continuationçš„å®ç°ç±»ã€‚

æ‰€ä»¥ï¼Œåœ¨æ•´ä¸ªåç¨‹åŸºç¡€å…ƒç´ å½“ä¸­ï¼Œæˆ‘ä»¬æœ€éœ€è¦å…³å¿ƒçš„ï¼Œå…¶å®å°±æ˜¯**Continuationå’Œintrinsics**ã€‚

åœ¨intrinsicsé‡Œï¼Œæœ‰ä¸€ä¸ªé‡è¦çš„é«˜é˜¶å‡½æ•°suspendCoroutineUninterceptedOrReturn{}ï¼Œæˆ‘ä»¬åé¢ä¼šè®²åˆ°å®ƒã€‚è‡³äºContinuationï¼Œè™½ç„¶æˆ‘ä»¬åœ¨å‰é¢å·²ç»ä»‹ç»è¿‡å®ƒæ˜¯ä»€ä¹ˆï¼Œä½†è¿˜æ²¡æœ‰ç³»ç»Ÿäº†è§£è¿‡å®ƒçš„ç”¨æ³•ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å…ˆç³»ç»Ÿäº†è§£ä¸€ä¸‹Continuationçš„ä¸¤ç§ç”¨æ³•ã€‚

## Continuationåˆ°åº•è¯¥æ€ä¹ˆç”¨ï¼Ÿ

å®é™…ä¸Šï¼Œåœ¨[ç¬¬18è®²](https://time.geekbang.org/column/article/488985)é‡Œï¼Œæˆ‘ä»¬å°±å·²ç»å­¦è¿‡Continuationçš„å…¶ä¸­ä¸€ç§ç”¨æ³•äº†ï¼š

```
// ä»£ç æ®µ1

suspend fun <T : Any> KtCall<T>.await(): T =
    suspendCancellableCoroutine { continuation ->
        val call = call(object : Callback<T> {
            override fun onSuccess(data: T) {
                // æ³¨æ„è¿™é‡Œ
                continuation.resume(data)
            }


            override fun onFail(throwable: Throwable) {
                // æ³¨æ„è¿™é‡Œ
                continuation.resumeWithException(throwable)
            }
        })

        continuation.invokeOnCancellation {
            println("Call cancelled!")
            call.cancel()
        }
    }
```

å½“æˆ‘ä»¬æƒ³è¦å®ç°æŒ‚èµ·å‡½æ•°çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨suspendCoroutine{}ã€suspendCancellableCoroutine{}è¿™ä¸¤ä¸ªé«˜é˜¶å‡½æ•°ï¼Œåœ¨å®ƒä»¬çš„Lambdaå½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæš´éœ²å‡ºæ¥çš„continuationå¯¹è±¡ï¼ŒæŠŠç¨‹åºçš„æ‰§è¡Œç»“æœæˆ–å¼‚å¸¸ä¼ åˆ°å¤–éƒ¨å»ã€‚

**è¿™ç§æ–¹å¼ï¼Œå¾€å¾€æ˜¯ç”¨äºå®ç°æŒ‚èµ·å‡½æ•°å†…éƒ¨é€»è¾‘çš„ã€‚**

æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨suspendCoroutine{}å†™ä¸€ä¸ªæ›´åŠ ç®€å•çš„ä¾‹å­ï¼š

```
// ä»£ç æ®µ2

fun main() = runBlocking {
    val result = getLengthSuspend("Kotlin")
    println(result)
}

suspend fun getLengthSuspend(text: String): Int = suspendCoroutine { continuation->
    thread {
        // æ¨¡æ‹Ÿè€—æ—¶
        Thread.sleep(1000L)
        continuation.resume(text.length)
    }
}

/*
è¾“å‡ºç»“æœï¼š
ç­‰å¾…1ç§’
6
*/
```

ä»¥ä¸Šä»£ç é‡Œï¼Œæˆ‘ä»¬æ˜¯ä½¿ç”¨suspendCoroutine{}å®ç°äº†æŒ‚èµ·å‡½æ•°ï¼Œç„¶ååœ¨å®ƒçš„å†…éƒ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨continuation.resume()çš„æ–¹å¼ï¼Œä¼ å‡ºäº†æŒ‚èµ·å‡½æ•°çš„è¿”å›å€¼ã€‚

å¯èƒ½ä½ ä¼šè§‰å¾—å¥‡æ€ªï¼Œä¸ºä»€ä¹ˆä»¥continuation.resume()è¿™æ ·å¼‚æ­¥çš„æ–¹å¼ä¼ å‡ºç»“æœä»¥åï¼ŒæŒ‚èµ·å‡½æ•°å°±èƒ½æ¥æ”¶åˆ°ç»“æœå‘¢ï¼Ÿå…¶å®ï¼Œå½“æˆ‘ä»¬æŠŠmain()å‡½æ•°å½“ä¸­çš„è°ƒç”¨é€»è¾‘æ”¹ä¸€ä¸‹ï¼Œè¿™ä¸€åˆ‡å°±ä¼šæ¸…æ™°æ˜äº†ã€‚

```
// ä»£ç æ®µ3

// å˜åŒ–åœ¨è¿™é‡Œ
fun main()  {
    val func = ::getLengthSuspend as (String, Continuation<Int>) -> Any?

    func("Kotlin", object: Continuation<Int>{
        override val context: CoroutineContext
            get() = EmptyCoroutineContext

        override fun resumeWith(result: Result<Int>) {
            println(result.getOrNull())
        }
    })

    // é˜²æ­¢ç¨‹åºæå‰ç»“æŸ
    Thread.sleep(2000L)
}

suspend fun getLengthSuspend(text: String): Int = suspendCoroutine { continuation->
    thread {
        // æ¨¡æ‹Ÿè€—æ—¶
        Thread.sleep(1000L)
        continuation.resume(text.length)
    }
}
/*
è¾“å‡ºç»“æœï¼š
ç­‰å¾…1ç§’
6
*/
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™æ®µä»£ç é‡Œï¼Œæˆ‘ä»¬å€ŸåŠ©ä¸ŠèŠ‚è¯¾çš„çŸ¥è¯†ï¼ŒæŠŠgetLengthSuspend()è¿™ä¸ªå‡½æ•°å¼ºè½¬æˆäº†å¸¦æœ‰Continuationçš„å‡½æ•°ç±»å‹ï¼Œç„¶åé€šè¿‡åŒ¿åå†…éƒ¨ç±»çš„æ–¹å¼ï¼Œåˆ›å»ºäº†ä¸€ä¸ªContinuationå¯¹è±¡ä¼ äº†è¿›å»ã€‚æœ€ç»ˆï¼Œç¨‹åºçš„æ‰§è¡Œç»“æœå’Œä»£ç æ®µ2æ˜¯ä¸€è‡´çš„ã€‚

ä½ è¿˜è®°å¾—æˆ‘åœ¨[ç¬¬15è®²](https://time.geekbang.org/column/article/487085)æåˆ°è¿‡çš„è§‚ç‚¹å—ï¼Ÿ

> æŒ‚èµ·å‡½æ•°çš„æœ¬è´¨ï¼Œå°±æ˜¯Callback!

é‚£ä¹ˆç°åœ¨ï¼Œå°±è®©æˆ‘ä»¬æŠŠContinuationæ”¹ä¸ºCallbackï¼Œçœ‹çœ‹ä»£ç ä¼šå˜æˆä»€ä¹ˆæ ·å­ã€‚

```
// ä»£ç æ®µ4

// å˜åŒ–åœ¨è¿™é‡Œ
fun main()  {
    func("Kotlin", object: Callback<Int>{
        override fun resume(result: Int) {
            println(result)
        }
    })

    // é˜²æ­¢ç¨‹åºæå‰ç»“æŸ
    Thread.sleep(2000L)
}

fun func(text: String, callback: Callback<Int>) {
    thread {
        // æ¨¡æ‹Ÿè€—æ—¶
        Thread.sleep(1000L)
        callback.resume(text.length)
    }
}

interface Callback<T> {
    fun resume(value: T)
}

/*
è¾“å‡ºç»“æœï¼š
ç­‰å¾…1ç§’
6
*/
```

å¯è§ï¼Œå½“æˆ‘ä»¬æŠŠContinuationæ”¹æˆCallbackä»¥åï¼Œæ•´ä¸ªä»£ç å°±å˜æˆäº†æˆ‘ä»¬æ›¾ç»æœ€ç†Ÿæ‚‰çš„å¼‚æ­¥å›è°ƒä»£ç äº†ã€‚è°ƒç”¨æ–¹ï¼Œå¯ä»¥ä½¿ç”¨åŒ¿åå†…éƒ¨ç±»åˆ›å»ºCallbackç”¨äºæ¥æ”¶å¼‚æ­¥ç»“æœï¼›å¼‚æ­¥å‡½æ•°å†…éƒ¨ï¼Œä½¿ç”¨callback.resume()å°†ç»“æœä¼ å‡ºå»ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼ŒKotlinåç¨‹å½“ä¸­çš„Continuationï¼Œä½œç”¨å…¶å®å°±ç›¸å½“äºCallbackï¼Œå®ƒæ—¢å¯ä»¥ç”¨äº**å®ç°æŒ‚èµ·å‡½æ•°**ï¼Œå¾€æŒ‚èµ·å‡½æ•°çš„å¤–éƒ¨ä¼ é€’ç»“æœï¼›ä¹Ÿå¯ä»¥ç”¨äº**è°ƒç”¨æŒ‚èµ·å‡½æ•°**ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºContinuationçš„åŒ¿åå†…éƒ¨ç±»ï¼Œæ¥æ¥æ”¶æŒ‚èµ·å‡½æ•°ä¼ é€’å‡ºæ¥çš„ç»“æœã€‚

æ‰€ä»¥åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¹Ÿå°±å¯ä»¥è½»æ¾å›ç­”ä¸ŠèŠ‚è¯¾çš„æ€è€ƒé¢˜äº†ï¼š

> æˆ‘ä»¬éƒ½çŸ¥é“æŒ‚èµ·å‡½æ•°æ˜¯Kotlinåç¨‹é‡Œæ‰æœ‰çš„æ¦‚å¿µï¼Œè¯·é—®ï¼ŒJavaä»£ç ä¸­å¯ä»¥è°ƒç”¨Kotlinçš„æŒ‚èµ·å‡½æ•°å—ï¼Ÿæ¯”å¦‚ï¼Œä¸‹é¢è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Javaå½“ä¸­è°ƒç”¨å—ï¼Ÿ

```
// ä»£ç æ®µ5

// éœ€è¦åœ¨Javaä¸­è°ƒç”¨çš„KotlinæŒ‚èµ·å‡½æ•°
object SuspendFromJavaExample {
    // åœ¨Javaå½“ä¸­å¦‚ä½•è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Ÿ
    suspend fun getUserInfo(id: Long):String {
        delay(1000L)
        return "Kotlin"
    }
}
```

ç­”æ¡ˆå½“ç„¶æ˜¯è‚¯å®šçš„ï¼ŒJavaå½“ä¸­è°ƒç”¨æŒ‚èµ·å‡½æ•°çš„æ–¹å¼ï¼Œå…¶å®è·Ÿå‰é¢çš„ä»£ç æ®µ3æ˜¯ä¸€æ ·çš„ï¼š

```
// ä»£ç æ®µ6

public static void main(String[] args) throws InterruptedException {
    SuspendFromJavaExample.INSTANCE.getUserInfo(100L, new Continuation<String>() {
        @NotNull
        @Override
        public CoroutineContext getContext() {
            return EmptyCoroutineContext.INSTANCE;
        }

        @Override
        public void resumeWith(@NotNull Object o) {
            System.out.println(o+"");
        }
    });

    // é˜²æ­¢ç¨‹åºæå‰ç»“æŸ
    Thread.sleep(2000L);
}

/*
è¾“å‡ºç»“æœ
Kotlin
*/
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯æŠŠä»£ç æ®µ3çš„æ€æƒ³åº”ç”¨åˆ°äº†Javaä»£ç ä¸­è€Œå·²ï¼Œå”¯ä¸€éœ€è¦**æ³¨æ„**çš„ï¼Œå°±æ˜¯ï¼šåœ¨Javaå½“ä¸­è®¿é—®Kotlinçš„objectå•ä¾‹ï¼Œæ˜¯éœ€è¦åŠ ä¸ŠINSTANCEåç¼€çš„ã€‚è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åœ¨[ç¬¬5è®²](https://time.geekbang.org/column/article/475058)å½“ä¸­å°±å·²ç»äº†è§£è¿‡ã€‚

çœ‹åˆ°è¿™é‡Œï¼Œå¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬åœ¨å®ç°æŒ‚èµ·å‡½æ•°é€»è¾‘çš„æ—¶å€™ï¼Œæ€»æ˜¯ç¦»ä¸å¼€**suspendCoroutine{}ã€suspendCancellableCoroutine{}**ã€‚å…¶å®ï¼Œè¿™ä¸¤ä¸ªé«˜é˜¶å‡½æ•°ä¹Ÿæ˜¯Kotlinåç¨‹çš„åŸºç¡€å…ƒç´ ï¼Œè®©æˆ‘ä»¬æ¥è¿›ä¸€æ­¥è®¤è¯†è¿™ä¸¤ä¸ªé«˜é˜¶å‡½æ•°ã€‚

## suspendCoroutineUninterceptedOrReturn

å®é™…ä¸Šï¼ŒsuspendCoroutine{}ã€suspendCancellableCoroutine{}è¿™ä¸¤ä¸ªé«˜é˜¶å‡½æ•°çš„å®ç°åŸç†æ˜¯ç±»ä¼¼çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±ä¸»è¦è§£é‡Šä¸‹suspendCoroutine{}ã€‚

å¦‚æœä½ å»çœ‹suspendCoroutine{}çš„æºä»£ç ï¼Œä¼šå‘ç°å®ƒå…¶å®ä¹Ÿåœ¨[Continuation.kt](https://github.com/JetBrains/kotlin/blob/master/libraries/stdlib/src/kotlin/coroutines/Continuation.kt)è¿™ä¸ªæ–‡ä»¶å½“ä¸­ã€‚

```
// ä»£ç æ®µ7

public interface Continuation<in T> {
    public val context: CoroutineContext    
    public fun resumeWith(result: Result<T>)
}

public suspend inline fun <T> suspendCoroutine(crossinline block: (Continuation<T>) -> Unit): T {

    // æ³¨æ„è¿™é‡Œ
    return suspendCoroutineUninterceptedOrReturn { c: Continuation<T> ->
        val safe = SafeContinuation(c.intercepted())
        block(safe)
        safe.getOrThrow()
    }
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç¬¬ä¸€çœ¼å°±èƒ½çœ‹åˆ°ä¸€ä¸ªåå­—ç‰¹åˆ«é•¿çš„é«˜é˜¶å‡½æ•°suspendCoroutineUninterceptedOrReturn{}ã€‚å®ƒå…¶å®å°±æ˜¯å®ç°suspendCoroutine{}çš„å…³é”®ã€‚é™¤äº†å®ƒä¹‹å¤–ï¼Œå…¶ä»–éƒ¨åˆ†çš„ä»£ç éƒ½å¾ˆå¥½ç†è§£ï¼š

- SafeContinuation(c.intercepted())è¿™è¡Œä»£ç çš„ä½œç”¨ï¼Œå°±æ˜¯æŠŠåŸæœ¬çš„ContinuationåŒ…è£¹ä¸€éã€‚
- block(safe)è¿™è¡Œä»£ç ï¼Œå…¶å®å°±æ˜¯åœ¨è°ƒç”¨Lambdaå½“ä¸­çš„é€»è¾‘ã€‚
- safe.getOrThrow()ï¼Œå°±æ˜¯åœ¨å–å‡ºblock(safe)çš„è¿è¡Œç»“æœï¼Œæˆ‘ä»¬åœ¨ä¸ŠèŠ‚è¯¾ä¹Ÿæåˆ°è¿‡ï¼ŒContinuationå½“ä¸­æ˜¯å¯ä»¥å­˜å‚¨resultçš„ã€‚è¿™ä¸ªResultå¯èƒ½æ˜¯æ­£ç¡®çš„ç»“æœï¼Œä¹Ÿå¯èƒ½æ˜¯å¼‚å¸¸ã€‚

ä¸‹é¢æˆ‘ä»¬é‡ç‚¹æ¥çœ‹çœ‹suspendCoroutineUninterceptedOrReturn{}è¿™ä¸ªé«˜é˜¶å‡½æ•°çš„ä½œç”¨ã€‚å¦‚æœä½ å»çœ‹å®ƒçš„æºä»£ç ï¼Œé‚£ä½ çœ‹åˆ°çš„å¤§æ¦‚ç‡ä¼šæ˜¯è¿™æ ·çš„ï¼š

```
// ä»£ç æ®µ8

public suspend inline fun <T> suspendCoroutineUninterceptedOrReturn(crossinline block: (Continuation<T>) -> Any?): T {
    contract { callsInPlace(block, InvocationKind.EXACTLY_ONCE) }
    throw NotImplementedError("Implementation of suspendCoroutineUninterceptedOrReturn is intrinsic")
}
```

å¤§éƒ¨åˆ†äººçœ‹åˆ°è¿™æ ·çš„ä»£ç å¯èƒ½éƒ½ä¼šè§‰å¾—å¥‡æ€ªï¼š**ä¸ºä»€ä¹ˆè¿™ä¸ªé«˜é˜¶å‡½æ•°çš„æºä»£ç ä¼šæ˜¯æŠ›å‡ºå¼‚å¸¸å‘¢ï¼Ÿ**

åœ¨å‰é¢çš„åŠ é¤äºŒâ€œè¡¨è¾¾å¼æ€ç»´â€é‡Œï¼Œæˆ‘å…¶å®æœ‰åšè¿‡è¯´æ˜ï¼Œå¦‚æœä½ è¿˜æœ‰å°è±¡çš„è¯ï¼Œåº”è¯¥å°±èƒ½ç†è§£è¿™æ ·çš„ä»£ç ä¹Ÿæ˜¯ç¬¦åˆå‡½æ•°è¿”å›å€¼çš„è§„èŒƒçš„ã€‚ä¸è¿‡ï¼Œå¦‚æœå®ƒæ€»æ˜¯æŠ›å¼‚å¸¸çš„è¯ï¼Œæˆ‘ä»¬ç”¨suspendCoroutine{}å†™ä»£ç çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆä¸ä¼šäº§ç”Ÿå´©æºƒå‘¢ï¼Ÿè¿™ä¸ªå¼‚å¸¸ä¿¡æ¯é‡Œçš„æç¤ºå†…å®¹åˆæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

> â€œImplementation of suspendCoroutineUninterceptedOrReturn is intrinsic.â€

å®é™…ä¸Šï¼Œç†è§£è¿™å¥è¯çš„å…³é”®åœ¨äºâ€œintrinsicâ€è¿™ä¸ªå•è¯ï¼Œå®ƒæœ‰â€œå›ºæœ‰â€â€œæœ¬è´¨â€çš„æ„æ€ï¼Œä¸è¿‡åœ¨ä¸Šé¢è¿™å¥è¯çš„è¯­å¢ƒä¸‹ï¼Œè¿™é‡Œçš„intrinsicå…¶å®æ˜¯æŒ‡ç¼–è¯‘å™¨é¢†åŸŸçš„ä¸€ä¸ªæœ¯è¯­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£ä¸ºâ€œå†…å»ºâ€ã€‚å› æ­¤ï¼Œä¸Šé¢æˆ‘ä»¬çœ‹åˆ°çš„å¼‚å¸¸æç¤ºä¿¡æ¯çš„æ„æ€å°±æ˜¯ï¼šsuspendCoroutineUninterceptedOrReturnæ˜¯ä¸€ä¸ªç¼–è¯‘å™¨å†…å»ºå‡½æ•°ï¼Œ**å®ƒæ˜¯ç”±Kotlinç¼–è¯‘å™¨æ¥å®ç°çš„**ã€‚

ä¸ºäº†ä¸åç¦»è¿™èŠ‚è¯¾çš„ä¸»é¢˜ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸å»æ·±ç©¶Kotlinç¼–è¯‘å™¨å½“ä¸­çš„é€»è¾‘äº†ï¼Œæ„Ÿå…´è¶£çš„è¯ä½ å¯ä»¥è‡ªè¡Œç ”ç©¶è¿™ä¸ª[é“¾æ¥](https://github.com/JetBrains/kotlin/blob/1.6.0/compiler/backend/src/org/jetbrains/kotlin/codegen/coroutines/coroutineCodegenUtil.kt)ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥æ¢ä¸€ä¸ªè§’åº¦ï¼Œå†™ä¸€äº›Demoä»£ç ï¼Œé€šè¿‡è¿è¡Œè°ƒè¯•æ¥çœ‹çœ‹è¿™ä¸ªå†…å»ºå‡½æ•°çš„åŠŸèƒ½å’Œä½œç”¨ã€‚

è®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹suspendCoroutineUninterceptedOrReturnè¿™ä¸ªé«˜é˜¶å‡½æ•°çš„å‚æ•°ï¼Œå®ƒä¼šæ¥æ”¶ä¸€ä¸ªLambdaï¼Œç±»å‹æ˜¯`(Continuation<T>) -> Any?`ï¼Œç»è¿‡ä¸ŠèŠ‚è¯¾çš„å­¦ä¹ ï¼Œä½ æ˜¯å¦è§‰å¾—è¿™ä¸ªç±»å‹æœ‰äº›çœ¼ç†Ÿå‘¢ï¼Ÿè¿™é‡Œçš„â€œAny?â€ç±»å‹ï¼Œå…¶å®å°±èƒ½ä»£è¡¨å½“å‰è¿™ä¸ªæŒ‚èµ·å‡½æ•°æ˜¯å¦çœŸæ­£æŒ‚èµ·ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºä¸‹é¢è¿™æ ·çš„ä»£ç ï¼š

```
// ä»£ç æ®µ9

fun main() = runBlocking {
    val result = testNoSuspendCoroutine()
    println(result)
}

private suspend fun testNoSuspendCoroutine() = suspendCoroutineUninterceptedOrReturn<String> {
        continuation ->
    return@suspendCoroutineUninterceptedOrReturn "Hello!"
}

/*
è¾“å‡ºç»“æœï¼š
Hello!
*/
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨suspendCoroutineUninterceptedOrReturnå®ç°äº†æŒ‚èµ·å‡½æ•°ï¼Œå¹¶ä¸”ï¼Œåœ¨å®ƒçš„Lambdaå½“ä¸­ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰è°ƒç”¨continuation.resume()ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›äº†ç»“æœâ€œHello!â€ã€‚æ ¹æ®ç¨‹åºçš„è¿è¡Œç»“æœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æŒ‚èµ·å‡½æ•°çš„å¤–éƒ¨ç¡®å®ä¹Ÿå¯ä»¥æ¥æ”¶åˆ°è¿™ä¸ªç»“æœã€‚

é‚£ä¹ˆè¿™æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬æŠŠä¸Šé¢çš„ä»£ç åç¼–è¯‘ä¸€ä¸‹ï¼Œä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š

```
    // ä»£ç æ®µ10

    private static final Object testNoSuspendCoroutine(Continuation $completion) {
      int var2 = false;
      if ("Hello!" == IntrinsicsKt.getCOROUTINE_SUSPENDED()) {
         DebugProbesKt.probeCoroutineSuspended($completion);
      }
    
      return "Hello!";
    }
```

æ‰€ä»¥ï¼Œä»åç¼–è¯‘çš„ç»“æœæ¥çœ‹ï¼ŒtestNoSuspendCoroutine()è¿™ä¸ªå‡½æ•°å…¶å®å°±æ˜¯ä¸€ä¸ª**ä¼ªæŒ‚èµ·å‡½æ•°**ï¼Œå®ƒçš„å†…éƒ¨å¹¶ä¸ä¼šçœŸæ­£æŒ‚èµ·ã€‚è¿™æ ·ï¼Œå½“æˆ‘ä»¬ä»å¤–éƒ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œè¿™ä¸ªå‡½æ•°ä¼šç«‹å³è¿”å›ç»“æœâ€œHello!â€ã€‚

è€Œè¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥å†å†™ä¸€ä¸ªçœŸæ­£çš„æŒ‚èµ·å‡½æ•°ï¼š

```
// ä»£ç æ®µ11

fun main() = runBlocking {
    val result = testSuspendCoroutine()
    println(result)
}

private suspend fun testSuspendCoroutine() = suspendCoroutineUninterceptedOrReturn<String> {
    continuation ->
    thread {
        Thread.sleep(1000L)
        continuation.resume("Hello!")


    }
    return@suspendCoroutineUninterceptedOrReturn kotlin.coroutines.intrinsics.COROUTINE_SUSPENDED
}

/*
è¾“å‡ºç»“æœï¼š
ç­‰å¾…1ç§’
Hello!
*/
```

è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨returnè¿”å›ç»“æœï¼Œè€Œæ˜¯ä½¿ç”¨äº†continuation.resume()ã€‚é€šè¿‡ç¨‹åºè¿è¡Œç»“æœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æŒ‚èµ·å‡½æ•°çš„å¤–éƒ¨ä¹Ÿèƒ½æ¥æ”¶åˆ°è¿™ä¸ªç»“æœã€‚ç„¶åæˆ‘ä»¬ä¹Ÿå†æ¥åç¼–è¯‘ä¸€ä¸‹ï¼Œçœ‹çœ‹å®ƒå¯¹åº”çš„Javaä»£ç ï¼š

```
// ä»£ç æ®µ12

private static final Object testSuspendCoroutine(Continuation $completion) {
    int var2 = false;
    // 1
    ThreadsKt.thread$default(false, false, (ClassLoader)null, (String)null, 0, (Function0)(new CoroutineBasicElementsKt$testSuspendCoroutine$2$1($completion)), 31, (Object)null);
    // 2
    Object var10000 = IntrinsicsKt.getCOROUTINE_SUSPENDED();
    if (var10000 == IntrinsicsKt.getCOROUTINE_SUSPENDED()) {
     DebugProbesKt.probeCoroutineSuspended($completion);
    }
    // 3
    return var10000;
}

final class CoroutineBasicElementsKt$testSuspendCoroutine$2$1 extends Lambda implements Function0 {

   final Continuation $it;

   public Object invoke() {
      this.invoke();
      return Unit.INSTANCE;
   }

   public final void invoke() {
      // 4
      Thread.sleep(1000L);
      Continuation var1 = this.$it;
      String var2 = "Hello!";
      Companion var3 = Result.Companion;
      var1.resumeWith(Result.constructor-impl(var2));
   }

   CoroutineBasicElementsKt$testSuspendCoroutine$2$1(Continuation var1) {
      super(0);
      this.$it = var1;
   }
}
```

ä»¥ä¸Šä»£ç ä¸­ä¸€å…±æœ‰4ä¸ªæ³¨é‡Šï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªçœ‹ï¼š

- æ³¨é‡Š1ã€4ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œæ‰§è¡Œäº†thread{}å½“ä¸­çš„ä»£ç ã€‚
- æ³¨é‡Š2ï¼Œå°†var10000èµ‹å€¼ä¸ºCOROUTINE\_SUSPENDEDè¿™ä¸ªæŒ‚èµ·æ ‡å¿—ä½ã€‚
- æ³¨é‡Š3ï¼Œè¿”å›æŒ‚èµ·æ ‡å¿—ä½ï¼Œä»£è¡¨testSuspendCoroutine()è¿™ä¸ªå‡½æ•°ä¼šçœŸæ­£æŒ‚èµ·ã€‚

æ‰€ä»¥ï¼Œè¿™ä¸¤ä¸ªä¾‹å­å…¶å®ä¹Ÿä»ä¾§é¢è¯æ˜äº†æˆ‘ä»¬åœ¨ä¸ŠèŠ‚è¯¾å½“ä¸­çš„ç»“è®ºï¼š

> ç”±äº suspend ä¿®é¥°çš„å‡½æ•°ï¼Œæ—¢å¯èƒ½è¿”å› CoroutineSingletons.COROUTINE\_SUSPENDEDï¼Œä¹Ÿå¯èƒ½è¿”å›å®é™…ç»“æœï¼Œç”šè‡³å¯èƒ½è¿”å› nullï¼Œä¸ºäº†é€‚é…æ‰€æœ‰çš„å¯èƒ½æ€§ï¼ŒCPSè½¬æ¢åçš„å‡½æ•°è¿”å›å€¼ç±»å‹å°±åªèƒ½æ˜¯Any?äº†ã€‚

é‚£ä¹ˆç°åœ¨ï¼Œæˆ‘ä»¬ä¹Ÿå°±å¯ä»¥æ€»ç»“å‡º**suspendCoroutineUninterceptedOrReturn{}è¿™ä¸ªé«˜é˜¶å‡½æ•°çš„ä½œç”¨**äº†ï¼šå®ƒå¯ä»¥å°†æŒ‚èµ·å‡½æ•°å½“ä¸­çš„Continuationä»¥å‚æ•°çš„å½¢å¼æš´éœ²å‡ºæ¥ï¼Œåœ¨å®ƒçš„Lambdaå½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è¿”å›ç»“æœï¼Œè¿™æ—¶å€™å®ƒå°±æ˜¯ä¸€ä¸ªâ€œä¼ªæŒ‚èµ·å‡½æ•°â€ï¼›æˆ–è€…ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¿”å›COROUTINE\_SUSPENDEDè¿™ä¸ªæŒ‚èµ·æ ‡å¿—ä½ï¼Œç„¶åä½¿ç”¨continuation.resume()ä¼ é€’ç»“æœã€‚

ç›¸åº”çš„ï¼ŒsuspendCoroutine{}ã€suspendCancellableCoroutine{}è¿™ä¸¤ä¸ªé«˜é˜¶å‡½æ•°ï¼Œåªæ˜¯å¯¹å®ƒçš„ä¸€ç§å°è£…è€Œå·²ã€‚

## å°ç»“

è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å­¦ä¹ äº†Kotlinåç¨‹å½“ä¸­ä¸æŒ‚èµ·å‡½æ•°å¯†åˆ‡ç›¸å…³çš„ä¸¤ä¸ªåŸºç¡€å…ƒç´ ï¼ŒContinuationã€suspendCoroutine{}ã€‚

Continuationæ˜¯æ•´ä¸ªåç¨‹å½“ä¸­æœ€é‡è¦çš„åŸºç¡€å…ƒç´ ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶çœ‹åšæ˜¯ä¸€ä¸ªCallbackã€‚å®ƒä¸»è¦æœ‰ä¸¤ä¸ªä½¿ç”¨åœºæ™¯ï¼Œä¸€ç§æ˜¯åœ¨å®ç°æŒ‚èµ·å‡½æ•°çš„æ—¶å€™ï¼Œç”¨äºä¼ é€’æŒ‚èµ·å‡½æ•°çš„æ‰§è¡Œç»“æœï¼›å¦ä¸€ç§æ˜¯åœ¨è°ƒç”¨æŒ‚èµ·å‡½æ•°çš„æ—¶å€™ï¼Œä»¥åŒ¿åå†…éƒ¨ç±»çš„æ–¹å¼ï¼Œç”¨äºæ¥æ”¶æŒ‚èµ·å‡½æ•°çš„æ‰§è¡Œç»“æœã€‚å€ŸåŠ©è¿™ç§æ€è·¯ï¼Œæˆ‘ä»¬ä¹Ÿå®Œå…¨å¯ä»¥åœ¨Javaå½“ä¸­è°ƒç”¨æŒ‚èµ·å‡½æ•°ã€‚

å½“æˆ‘ä»¬æƒ³è¦å®ç°æŒ‚èµ·å‡½æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦ä½¿ç”¨suspendCoroutine{}ã€suspendCancellableCoroutine{}è¿™ä¸¤ä¸ªé«˜é˜¶å‡½æ•°ã€‚å®ƒä»¬ä¸¤ä¸ªéƒ½æ˜¯å¯¹suspendCoroutineUninterceptedOrReturn{}çš„å°è£…ï¼Œè¿™ä¸ªé«˜é˜¶å‡½æ•°çš„ä½œç”¨å…¶å®å°±æ˜¯æš´éœ²æŒ‚èµ·å‡½æ•°çš„Continuationå¯¹è±¡ã€‚åœ¨å®ƒçš„Lambdaå½“ä¸­ï¼Œæˆ‘ä»¬æ—¢å¯ä»¥ç›´æ¥è¿”å›æ‰§è¡Œç»“æœï¼Œä¹Ÿå¯ä»¥è¿”å›COROUTINE\_SUSPENDEDè¿™ä¸ªæŒ‚èµ·æ ‡å¿—ä½ï¼Œç„¶åä½¿ç”¨continuation.resume()ä¼ é€’ç»“æœã€‚

## æ€è€ƒé¢˜

ä½ è§‰å¾—ï¼ŒsuspendCoroutine{}ã€suspendCancellableCoroutine{}è¿™ä¸¤ä¸ªé«˜é˜¶å‡½æ•°ï¼Œå®ƒå¯¹æ¯”suspendCoroutineUninterceptedOrReturn{}çš„ä¼˜åŠ¿åœ¨å“ªé‡Œï¼ŸKotlinå®˜æ–¹ä¸ºä»€ä¹ˆè¦è¿›è¡Œè¿™æ ·çš„å°è£…å‘¢ï¼Ÿ

æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„ç­”æ¡ˆï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ9ï¼‰</strong></div><ul>
<li><span>Allen</span> ğŸ‘ï¼ˆ15ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å…³äºæ€è€ƒé¢˜çš„æ€è€ƒï¼š

suspendCoroutine{} æˆ–è€… suspendCancellableCoroutine{} åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œåªéœ€è¦çŸ¥é“ Continuation æ¥å£ï¼Œè€Œæ¥å£ä¸­åªæœ‰ä¸€ä¸ªå‡½æ•° resumeWithï¼Œç›¸å¯¹è®©äººæ¯”è¾ƒå®¹æ˜“å’Œ Callback å›è°ƒå…³è”èµ·æ¥ï¼Œæ‰€ä»¥ï¼Œä½¿ç”¨è¿™ä¸¤ä¸ªå‡½æ•°çš„æˆæœ¬è¾ƒå°ï¼Œä¸éœ€è¦å¯¹ coroutine åç¨‹çš„åŸç†æœ‰å¤ªå¤šçš„ç†è§£ã€‚

è€Œ suspendCoroutineUninterceptedOrReturn{} å‡½æ•°é™¤äº†éœ€è¦å…³å¿ƒ Continuation æ¥å£å¤–ï¼Œè¿˜éœ€è¦å…³å¿ƒå¯¹åº”çš„è¿”å›å€¼ï¼Œè€Œè¿™ä¸ªè¿”å›å€¼ä¸­æœ‰å‡ ç§çŠ¶æ€ï¼Œæ¯ç§çŠ¶æ€ä»£è¡¨ä»€ä¹ˆæ„æ€ï¼Œå…¶å®åœ¨å¯¹ coroutine åŸç†ä¸å¤ªæ¸…æ¥šçš„æƒ…å†µä¸‹ï¼Œæ˜¯å®Œå…¨ä¸çŸ¥é“æ€ä¹ˆè°ƒç”¨çš„ã€‚

æ€»çš„æ¥è¯´ï¼ŒsuspendCoroutineUninterceptedOrReturn{} ä½¿ç”¨çš„å­¦ä¹ æˆæœ¬è¦é«˜å¾ˆå¤šã€‚</p>2022-03-24</li><br/><li><span>Paul Shan</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>suspendCoroutine ç”¨äº†SafeContinuationï¼Œé‡Œé¢æœ‰åŸå­è¯»å’Œä¸€äº›çŠ¶æ€åˆ¤æ–­ï¼Œåº”è¯¥æ˜¯å¤„ç†å¤šçº¿ç¨‹å’Œé‡å¤resumeçš„é—®é¢˜ã€‚</p>2022-03-25</li><br/><li><span>è¾‰å“¥</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>suspendCoroutine{}èƒ½ä¿è¯suspendCoroutineçš„æŒ‚èµ·ç‚¹ï¼ˆä¹Ÿå°±æ˜¯ä¼ å…¥lambdaçš„continuationå‚æ•°ï¼‰åªä¼šè¢«resumeä¸€æ¬¡.å› ä¸ºå®é™…ä¸Šä¼ å…¥çš„continuationä¸ºSafeContinuation,å¤šæ¬¡è°ƒç”¨ä¼šæŠ›å¼‚å¸¸,å¯ä»¥è§„èŒƒç”¨æˆ·çš„ä½¿ç”¨</p>2022-03-23</li><br/><li><span>ZircoN</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>suspendCoroutineUninterceptedOrReturn è¿™ä¸ªæ–¹æ³•åœ¨IDEé‡Œä¸ºå•¥æ²¡æ³•å¼•ç”¨åˆ°ï¼Ÿ</p>2022-04-18</li><br/><li><span>ACE_Killer09</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¯¹äº ä»£ç æ®µ 10 å’Œ 11 suspendCoroutineUninterceptedOrReturn å¿…é¡»è¦è€ƒè™‘è¿”å›å€¼ï¼Œå¦‚æœreturnçš„ä¸æ˜¯COROUTINE_SUSPENDEDï¼Œå°±ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„æŒ‚èµ·å‡½æ•°ã€‚è€Œå¦‚æœæ˜¯ä½¿ç”¨ suspendCoroutine suspendCancellableCoroutineï¼Œå°±ä¸ç”¨è€ƒè™‘è¿”å›å€¼ï¼Œä»–ä»¬ä¸€å®šæ˜¯æŒ‚èµ·çš„ï¼Œåªè¦æœ€åé€šè¿‡Continuation è¿”å›å€¼å³å¯ã€‚

å¦å¤–  Continuationä¸­ resume resumeWith resumeWithException çš„åŸç†éƒ½æ˜¯ resumewith è¿™ä¸‰ä¸ªå…·ä½“åº”ç”¨åœºæ™¯é™¤äº†ä¼ å…¥å€¼åŒºåˆ« è¿˜æœ‰ å…¶ä»–åŒºåˆ«å—ï¼Ÿ</p>2022-04-12</li><br/><li><span>æ¨å°å¦</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>Continuation çš„resumeWithå‡½æ•°åªæœ‰åœ¨ï¼Œå›è°ƒå‡½æ•°è½¬æŒ‚èµ·å‡½æ•°æˆ–è€…javaè°ƒç”¨æŒ‚èµ·å‡½æ•°çš„æ—¶å€™æ‰å‘æŒ¥ä½œç”¨å—ï¼Ÿ
åœ¨æŒ‚èµ·å‡½æ•°æ‰§è¡ŒæŒ‚èµ·å‡½æ•°çš„çŠ¶æ€æœºé‡Œé¢ï¼Œå¥½åƒæ²¡çœ‹åˆ°resumeWithçš„å½±å­</p>2022-03-29</li><br/><li><span>anmi</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<p>ç†è§£è¯¾ç¨‹çš„å…³é”®ï¼š
fun &lt;T&gt; Continuation&lt;T&gt;.resume(value: T) {
    this.resumeWith(Result.success(value))
}

fun &lt;T&gt; Continuation&lt;T&gt;.resumeWithException(exception: Throwable) {
    this.resumeWith(Result.failure(exception))
}</p>2024-04-13</li><br/><li><span>anmi</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å‰é¢çœ‹äº†é‚£ä¹ˆå¤šæ¬¡æ²¡æœ‰æ„Ÿè§‰ï¼Œç°åœ¨ååº”è¿‡æ¥äº†ï¼šå‡½æ•°ä¹Ÿèƒ½ç±»å‹å¼ºè½¬ï¼ï¼ï¼ï¼ï¼</p>2023-12-04</li><br/><li><span>Emmm</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>suspendCoroutineå¯ä»¥ç†è§£ä¸ºä¼šé˜»å¡å¤–å±‚åç¨‹å§ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°åŒæ­¥å¾—åˆ°è€—æ—¶ä»»åŠ¡å›è°ƒå‡ºæ¥çš„ç»“æœï¼Œç„¶åè¿›è¡Œåç»­çš„æ“ä½œï¼Œè¿™æ ·çš„è¯çœ‹å¤–å±‚åç¨‹ä½œç”¨åŸŸçš„ä»£ç å°±æ˜¯é¡ºåºåŒæ­¥æ‰§è¡Œ</p>2022-07-06</li><br/>
</ul>