> ä½ å¥½ï¼Œæˆ‘æ˜¯å¼ ç»æ–‡ï¼Œä»Šå¤©æˆ‘è¦è·Ÿä½ åˆ†äº«å”¯é¹¿åŒå­¦å®Œæˆä¸“æ è¯¾åç»ƒä¹ ä½œä¸šçš„â€œæ‰‹è®°â€ã€‚ä¸“æ æ‰¿è¯ºä¼šä¸ºåšæŒå®Œæˆç»ƒä¹ ä½œä¸šçš„åŒå­¦é€å‡ºGMTCå¤§ä¼šé—¨ç¥¨ï¼Œå”¯é¹¿åŒå­¦é€šè¿‡è‡ªå·±çš„åŠªåŠ›å’ŒåšæŒï¼Œä¸ºè‡ªå·±èµ¢å¾—äº†GMTCå¤§ä¼šçš„é—¨ç¥¨ã€‚
> 
> å¦‚æœä½ è¿˜æ²¡å¼€å§‹ç»ƒä¹ ï¼Œæˆ‘å¼ºçƒˆå»ºè®®ä½ èŠ±ä¸€äº›æ—¶é—´åœ¨ç»ƒä¹ ä¸Šï¼Œå› ä¸ºæ¯ä¸ªç»ƒä¹ çš„Sampleéƒ½æ˜¯æˆ‘å’Œå­¦ä¹ å§”å‘˜èŠ±è´¹å¾ˆå¤šç²¾åŠ›ç²¾å¿ƒå‡†å¤‡çš„ï¼Œä¸ºçš„æ˜¯è®©ä½ åœ¨å­¦ä¹ å®Œåå¯ä»¥æœ‰æœºä¼šä¸Šæ‰‹å®è·µï¼Œå¸®ä½ å°½å¿«æ¶ˆåŒ–ä¸“æ é‡Œçš„çŸ¥è¯†å¹¶ä¸ºè‡ªå·±æ‰€ç”¨ã€‚

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å”¯é¹¿ï¼Œæ¥è‡ªè¥¿å®‰ï¼Œä»äº‹Androidå¼€å‘ä¹Ÿæœ‰è¿‘5å¹´çš„æ—¶é—´äº†ï¼Œç›®å‰åœ¨åšæ™ºæ…§ç¤¾åŒºæ–¹é¢çš„ä¸šåŠ¡ã€‚æˆ‘è‡ªå·±åšæŒå†™åšå®¢å·²ç»æœ‰ä¸‰å¹´å¤šçš„æ—¶é—´äº†ï¼Œå¸Œæœ›åˆ†äº«è‡ªå·±åœ¨å·¥ä½œã€å­¦ä¹ ä¸­çš„æ”¶è·ã€‚

å…ˆè¯´è¯´æˆ‘å­¦ä¹ ä¸“æ çš„æ–¹æ³•ï¼Œä¸“æ æ›´æ–°å½“å¤©æˆ‘å°±ä¼šå»å­¦ä¹ ï¼Œä½†æ˜¯éš¾åº¦çœŸçš„ä¸å°ã€‚æˆ‘å¯¹è‡ªå·±çš„è¦æ±‚å¹¶ä¸æ˜¯çœ‹ä¸€éå°±è¦ææ˜ç™½ï¼Œè€Œæ˜¯é‡è§ä¸æ‡‚çš„åœ°æ–¹ç«‹é©¬æŸ¥é˜…èµ„æ–™ï¼Œè¦åšåˆ°å¤§ä½“äº†è§£æ•´ç¯‡å†…å®¹ã€‚ä¹‹ååœ¨å‘¨æœ«çš„æ—¶å€™æˆ‘ä¼šé›†ä¸­å»åšSampleç»ƒä¹ ï¼Œä¸€è¾¹å¤ä¹ æœ¬å‘¨å‘å¸ƒçš„å†…å®¹ï¼Œä¸€è¾¹ç”¨å†™åšå®¢çš„æ–¹å¼è®°å½•ç»ƒä¹ çš„ç»“æœã€‚

åé¢æˆ‘è®¡åˆ’ä¸“æ ç»“æŸåå†å¤šçœ‹ã€å¤šç»ƒä¹ å‡ éï¼Œä¸æ–­æŸ¥æ¼è¡¥ç¼ºã€‚è¯´çœŸçš„ï¼Œæˆ‘å¾ˆå–œæ¬¢ã€ŠAndroidå¼€å‘é«˜æ‰‹è¯¾ã€‹çš„éš¾åº¦ï¼Œè®©æˆ‘åœ¨å®Œæˆç»ƒä¹ ä½œä¸šæ—¶æœ‰ç§ç¿»è¶Šé«˜å±±çš„å¿«æ„Ÿã€‚æœ€åï¼Œå¸Œæœ›åŒå­¦ä»¬ä¸€èµ·åšæŒï¼Œäº«å—ç¿»è¶Šé«˜å±±å¸¦æ¥çš„æˆå°±æ„Ÿã€‚

* * *

æœ€è¿‘åœ¨å­¦ä¹ å¼ ç»æ–‡è€å¸ˆçš„ã€ŠAndroidå¼€å‘é«˜æ‰‹è¯¾ã€‹ã€‚è¯¾åä½œä¸šå¯ä¸æ˜¯ä¸€èˆ¬çš„éš¾ï¼Œæœ€è¿‘å‡ å¤©æŠ½ç©ºç»ƒä¹ äº†ä¸€ä¸‹ï¼Œç»“åˆè€å¸ˆç»™çš„æ­¥éª¤å’Œå…¶ä»–åŒå­¦çš„ç»éªŒï¼Œå®Œæˆäº†å‰5è¯¾çš„å†…å®¹ã€‚

æˆ‘æ•´ç†æ€»ç»“äº†ä¸€ä¸‹ï¼Œåˆ†äº«å‡ºæ¥ï¼Œå¸Œæœ›å¯ä»¥å¸®åˆ°ä¸€èµ·å­¦ä¹ çš„åŒå­¦ï¼ˆå½“ç„¶å¸Œæœ›å¤§å®¶å°½é‡é è‡ªå·±è§£å†³é—®é¢˜ï¼‰ã€‚

[**Chapter01**](https://github.com/AndroidAdvanceWithGeektime/Chapter01)

> ä¾‹å­é‡Œé›†æˆäº†Breakpadæ¥è·å–å‘ç”ŸNative Crashæ—¶å€™çš„ç³»ç»Ÿä¿¡æ¯å’Œçº¿ç¨‹å †æ ˆä¿¡æ¯ã€‚é€šè¿‡ä¸€ä¸ªç®€å•çš„Nativeå´©æºƒæ•è·è¿‡ç¨‹ï¼Œå®Œæˆminidumpæ–‡ä»¶çš„ç”Ÿæˆå’Œè§£æï¼Œåœ¨å®è·µä¸­åŠ æ·±å¯¹Breakpadå·¥ä½œæœºåˆ¶çš„è®¤è¯†ã€‚

ç›´æ¥è¿è¡Œé¡¹ç›®ï¼ŒæŒ‰ç…§README.mdçš„æ­¥éª¤æ“ä½œå°±è¡Œã€‚

ä¸­é—´æœ‰ä¸ªé—®é¢˜ï¼Œè€å¸ˆæä¾›çš„minidump\_stackwalkerå·¥å…·åœ¨macOS 10.14ä»¥ä¸Šæ— æ³•æˆåŠŸæ‰§è¡Œï¼Œå› ä¸ºæ²¡æœ‰libstdc++.6.dylibåº“ï¼Œæ‰€ä»¥æˆ‘å°±ä¸‹è½½Breakpadæºç é‡æ–°ç¼–è¯‘äº†ä¸€éã€‚

ä½¿ç”¨minidump\_stackwalkerå·¥å…·æ¥æ ¹æ®minidumpæ–‡ä»¶ç”Ÿæˆå †æ ˆè·Ÿè¸ªlogï¼Œå¾—åˆ°çš„crashLog.txtæ–‡ä»¶å¦‚ä¸‹ï¼š

```
Operating system: Android
                  0.0.0 Linux 4.9.112-perf-gb92eddd #1 SMP PREEMPT Tue Jan 1 21:35:06 CST 2019 aarch64
CPU: arm64  // æ³¨æ„ç‚¹1
     8 CPUs

GPU: UNKNOWN

Crash reason:  SIGSEGV /SEGV_MAPERR
Crash address: 0x0
Process uptime: not available

Thread 0 (crashed)
 0  libcrash-lib.so + 0x600 // æ³¨æ„ç‚¹2
     x0 = 0x00000078e0ce8460    x1 = 0x0000007fd4000314
     x2 = 0x0000007fd40003b0    x3 = 0x00000078e0237134
     x4 = 0x0000007fd40005d0    x5 = 0x00000078dca14200
     x6 = 0x0000007fd4000160    x7 = 0x00000078c8987e18
     x8 = 0x0000000000000000    x9 = 0x0000000000000001
    x10 = 0x0000000000430000   x11 = 0x00000078e05ef688
    x12 = 0x00000079664ab050   x13 = 0x0ad046ab5a65bfdf
    x14 = 0x000000796650c000   x15 = 0xffffffffffffffff
    x16 = 0x00000078c83defe8   x17 = 0x00000078c83ce5ec
    x18 = 0x0000000000000001   x19 = 0x00000078e0c14c00
    x20 = 0x0000000000000000   x21 = 0x00000078e0c14c00
    x22 = 0x0000007fd40005e0   x23 = 0x00000078c89fa661
    x24 = 0x0000000000000004   x25 = 0x00000079666cc5e0
    x26 = 0x00000078e0c14ca0   x27 = 0x0000000000000001
    x28 = 0x0000007fd4000310    fp = 0x0000007fd40002e0
     lr = 0x00000078c83ce624    sp = 0x0000007fd40002c0
     pc = 0x00000078c83ce600
    Found by: given as instruction pointer in context
 1  libcrash-lib.so + 0x620
     fp = 0x0000007fd4000310    lr = 0x00000078e051c7e4
     sp = 0x0000007fd40002f0    pc = 0x00000078c83ce624
    Found by: previous frame's frame pointer
 2  libart.so + 0x55f7e0
     fp = 0x130c0cf800000001    lr = 0x00000079666cc5e0
     sp = 0x0000007fd4000320    pc = 0x00000078e051c7e4
    Found by: previous frame's frame pointer
......
```

ä¸‹æ¥æ˜¯ç¬¦å·è§£æï¼Œå¯ä»¥ä½¿ç”¨NDKä¸­æä¾›çš„`addr2line`æ¥æ ¹æ®åœ°å€è¿›è¡Œä¸€ä¸ªç¬¦å·åè§£çš„è¿‡ç¨‹ï¼Œè¯¥å·¥å…·åœ¨`$NDK_HOME/toolchains/arm-linux-androideabi-4.9/prebuilt/darwin-x86_64/bin/arm-linux-androideabi-addr2line`ã€‚

æ³¨æ„ï¼šæ­¤å¤„è¦æ³¨æ„ä¸€ä¸‹å¹³å°ï¼Œå¦‚æœæ˜¯ARM 64ä½çš„soï¼Œè§£ææ˜¯éœ€è¦ä½¿ç”¨aarch64-linux-android-4.9ä¸‹çš„å·¥å…·é“¾ã€‚

å› ä¸ºæˆ‘çš„æ˜¯ARM 64ä½çš„soã€‚æ‰€ä»¥ä½¿ç”¨aarch64-linux-android-4.9ï¼Œlibcrash-lib.soåœ¨`app/build/intermediates/cmake/debug/obj/arm64-v8a`ä¸‹ï¼Œ`0x600`ä¸ºé”™è¯¯ä½ç½®ç¬¦å·ã€‚

```
aarch64-linux-android-addr2line -f -C -e libcrash-lib.so 0x600
```

è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```
Crash()
/Users/weilu/Downloads/Chapter01-master/sample/.externalNativeBuild/cmake/debug/arm64-v8a/../../../../src/main/cpp/crash.cpp:10
```

å¯ä»¥çœ‹åˆ°è¾“å‡ºç»“æœä¸ä¸‹å›¾é”™è¯¯ä½ç½®ä¸€è‡´ï¼ˆç¬¬10è¡Œï¼‰ã€‚

![](https://static001.geekbang.org/resource/image/ff/ab/ffbea53bc34d05c02055f1e348594dab.png?wh=767%2A350)

[**Chapter02**](https://github.com/AndroidAdvanceWithGeektime/Chapter02)

> è¯¥ä¾‹å­ä¸»è¦æ¼”ç¤ºäº†å¦‚ä½•é€šè¿‡å…³é—­FinalizerWatchdogDaemonæ¥å‡å°‘TimeoutExceptionçš„è§¦å‘ã€‚

åœ¨æˆ‘çš„ä¸Šä¸€ç¯‡åšå®¢ï¼š[å®‰å“å¼€å‘ä¸­é‡åˆ°çš„å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ï¼ˆä¸‰ï¼‰](https://blog.csdn.net/qq_17766199/article/details/84789495#t1)ä¸­æœ‰è¯´æ˜ï¼Œå°±ä¸é‡å¤èµ˜è¿°äº†ã€‚

[**Chapter03**](https://github.com/AndroidAdvanceWithGeektime/Chapter03)

> é¡¹ç›®ä½¿ç”¨äº†Inline Hookæ¥æ‹¦æˆªå†…å­˜å¯¹è±¡åˆ†é…æ—¶å€™çš„RecordAllocationå‡½æ•°ï¼Œé€šè¿‡æ‹¦æˆªè¯¥æ¥å£å¯ä»¥å¿«é€Ÿè·å–åˆ°å½“æ—¶åˆ†é…å¯¹è±¡çš„ç±»åå’Œåˆ†é…çš„å†…å­˜å¤§å°ã€‚
> 
> åœ¨åˆå§‹åŒ–çš„æ—¶å€™æˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªåˆ†é…å¯¹è±¡æ•°é‡çš„æœ€å¤§å€¼ï¼Œå¦‚æœä»startå¼€å§‹å¯¹è±¡åˆ†é…æ•°é‡è¶…è¿‡æœ€å¤§å€¼å°±ä¼šè§¦å‘å†…å­˜dumpï¼Œç„¶åæ¸…ç©ºallocå¯¹è±¡åˆ—è¡¨ï¼Œé‡æ–°è®¡ç®—ã€‚è¯¥åŠŸèƒ½å’ŒAndroid Studioé‡Œçš„Allocation Trackerç±»ä¼¼ï¼Œåªä¸è¿‡å¯ä»¥åœ¨ä»£ç çº§åˆ«æ›´ç»†ç²’åº¦çš„è¿›è¡Œæ§åˆ¶ã€‚å¯ä»¥ç²¾ç¡®åˆ°æ–¹æ³•çº§åˆ«ã€‚

é¡¹ç›®ç›´æ¥è·‘èµ·æ¥åï¼Œç‚¹å‡»å¼€å§‹è®°å½•ï¼Œç„¶åç‚¹å‡»5æ¬¡ç”Ÿæˆ1000å¯¹è±¡æŒ‰é’®ã€‚ç”Ÿæˆå¯¹è±¡ä»£ç å¦‚ä¸‹ï¼š

```
for (int i = 0; i < 1000; i++) {
     Message msg = new Message();
     msg.what = i;
}
```

å› ä¸ºä»£ç ä»ç‚¹å‡»å¼€å§‹è®°å½•å¼€å§‹ï¼Œè§¦å‘åˆ°5000çš„æ•°æ®å°±dumpåˆ°æ–‡ä»¶ä¸­ï¼Œç‚¹å‡»5æ¬¡åå°±ä¼šåœ¨`sdcard/crashDump`ä¸‹ç”Ÿæˆä¸€ä¸ªæ—¶é—´æˆ³å‘½åçš„æ–‡ä»¶ã€‚é¡¹ç›®æ ¹ç›®å½•ä¸‹è°ƒç”¨å‘½ä»¤ï¼š

```
java -jar tools/DumpPrinter-1.0.jar dumpæ–‡ä»¶è·¯å¾„ > dump_log.txt
```

ç„¶åå°±å¯ä»¥åœ¨dump\_log.txtä¸­çœ‹åˆ°è§£æå‡ºæ¥çš„æ•°æ®ï¼š

```
Found 5000 records:
....
tid=4509 android.graphics.drawable.RippleForeground (112 bytes)
    android.graphics.drawable.RippleDrawable.tryRippleEnter (RippleDrawable.java:569)
    android.graphics.drawable.RippleDrawable.setRippleActive (RippleDrawable.java:276)
    android.graphics.drawable.RippleDrawable.onStateChange (RippleDrawable.java:266)
    android.graphics.drawable.Drawable.setState (Drawable.java:778)
    android.view.View.drawableStateChanged (View.java:21137)
    android.widget.TextView.drawableStateChanged (TextView.java:5289)
    android.support.v7.widget.AppCompatButton.drawableStateChanged (AppCompatButton.java:155)
    android.view.View.refreshDrawableState (View.java:21214)
    android.view.View.setPressed (View.java:10583)
    android.view.View.setPressed (View.java:10561)
    android.view.View.onTouchEvent (View.java:13865)
    android.widget.TextView.onTouchEvent (TextView.java:10070)
    android.view.View.dispatchTouchEvent (View.java:12533)
    android.view.ViewGroup.dispatchTransformedTouchEvent (ViewGroup.java:3032)
    android.view.ViewGroup.dispatchTouchEvent (ViewGroup.java:2662)
    android.view.ViewGroup.dispatchTransformedTouchEvent (ViewGroup.java:3032)
tid=4515 int[] (104 bytes)
tid=4509 android.os.BaseLooper$MessageMonitorInfo (88 bytes)
    android.os.Message.<init> (Message.java:123)
    com.dodola.alloctrack.MainActivity$4.onClick (MainActivity.java:70)
    android.view.View.performClick (View.java:6614)
    android.view.View.performClickInternal (View.java:6591)
    android.view.View.access$3100 (View.java:786)
    android.view.View$PerformClick.run (View.java:25948)
    android.os.Handler.handleCallback (Handler.java:873)
    android.os.Handler.dispatchMessage (Handler.java:99)
    android.os.Looper.loop (Looper.java:201)
    android.app.ActivityThread.main (ActivityThread.java:6806)
    java.lang.reflect.Method.invoke (Native method)
    com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run (RuntimeInit.java:547)
    com.android.internal.os.ZygoteInit.main (ZygoteInit.java:873)
......
```

æˆ‘ä»¬ç”¨Android ProfileræŸ¥æ‰¾ä¸€ä¸ªMessageå¯¹è±¡å¯¹æ¯”ä¸€ä¸‹ï¼Œä¸€æ¨¡ä¸€æ ·ã€‚

![](https://static001.geekbang.org/resource/image/ea/10/ea9e03f90bc15a086d523958272fe410.png?wh=1612%2A764)

ç®€å•çœ‹ä¸€ä¸‹Hookä»£ç ï¼š

```
void hookFunc() {
    LOGI("start hookFunc");
    void *handle = ndk_dlopen("libart.so", RTLD_LAZY | RTLD_GLOBAL);

    if (!handle) {
        LOGE("libart.so open fail");
        return;
    }
    void *hookRecordAllocation26 = ndk_dlsym(handle,
                                             "_ZN3art2gc20AllocRecordObjectMap16RecordAllocationEPNS_6ThreadEPNS_6ObjPtrINS_6mirror6ObjectEEEj");

    void *hookRecordAllocation24 = ndk_dlsym(handle,
                                             "_ZN3art2gc20AllocRecordObjectMap16RecordAllocationEPNS_6ThreadEPPNS_6mirror6ObjectEj");

    void *hookRecordAllocation23 = ndk_dlsym(handle,
                                             "_ZN3art3Dbg16RecordAllocationEPNS_6ThreadEPNS_6mirror5ClassEj");

    void *hookRecordAllocation22 = ndk_dlsym(handle,
                                             "_ZN3art3Dbg16RecordAllocationEPNS_6mirror5ClassEj");

    if (hookRecordAllocation26 != nullptr) {
        LOGI("Finish get symbol26");
        MSHookFunction(hookRecordAllocation26, (void *) &newArtRecordAllocation26,
                       (void **) &oldArtRecordAllocation26);

    } else if (hookRecordAllocation24 != nullptr) {
        LOGI("Finish get symbol24");
        MSHookFunction(hookRecordAllocation26, (void *) &newArtRecordAllocation26,
                       (void **) &oldArtRecordAllocation26);

    } else if (hookRecordAllocation23 != NULL) {
        LOGI("Finish get symbol23");
        MSHookFunction(hookRecordAllocation23, (void *) &newArtRecordAllocation23,
                       (void **) &oldArtRecordAllocation23);
    } else {
        LOGI("Finish get symbol22");
        if (hookRecordAllocation22 == NULL) {
            LOGI("error find hookRecordAllocation22");
            return;
        } else {
            MSHookFunction(hookRecordAllocation22, (void *) &newArtRecordAllocation22,
                           (void **) &oldArtRecordAllocation22);
        }
    }
    dlclose(handle);
}
```

ä½¿ç”¨äº†Inline Hookæ–¹æ¡ˆSubstrateæ¥æ‹¦æˆªå†…å­˜å¯¹è±¡åˆ†é…æ—¶å€™libart.soçš„RecordAllocationå‡½æ•°ã€‚é¦–å…ˆå¦‚æœæˆ‘ä»¬è¦hookä¸€ä¸ªå‡½æ•°ï¼Œéœ€è¦çŸ¥é“è¿™ä¸ªå‡½æ•°çš„åœ°å€ã€‚æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†ä»£ç ä¸­è¿™ä¸ªåœ°å€åˆ¤æ–­äº†å››ç§ä¸åŒç³»ç»Ÿã€‚è¿™é‡Œæœ‰ä¸€ä¸ª[ç½‘é¡µç‰ˆçš„è§£æå·¥å…·](http://demangler.com/)å¯ä»¥å¿«é€Ÿè·å–ã€‚ä¸‹é¢ä»¥8.0ä¸ºä¾‹ã€‚

![](https://static001.geekbang.org/resource/image/89/08/89bc383aab02af0b71d243dc10273708.png?wh=748%2A176)

æˆ‘åœ¨8.0çš„æºç ä¸­æ‰¾åˆ°äº†å¯¹åº”çš„æ–¹æ³•ï¼š

![](https://static001.geekbang.org/resource/image/a1/26/a1655f62725d8ae28a14ed717860e726.jpeg?wh=1730%2A585)

7.0æ–¹æ³•å°±æ˜æ˜¾ä¸åŒï¼š

![](https://static001.geekbang.org/resource/image/3a/25/3a2e76c476c6a21e6036022793521925.jpeg?wh=1698%2A620)

æˆ‘ä¹ŸåŒæ—¶å‚çœ‹äº†9.0çš„ä»£ç ï¼Œå‘ç°æ²¡æœ‰å˜åŒ–ï¼Œæ‰€ä»¥æˆ‘çš„æµ‹è¯•æœºæ˜¯9.0çš„ä¹Ÿæ²¡æœ‰é—®é¢˜ã€‚

Hookæ–°å†…å­˜å¯¹è±¡åˆ†é…å¤„ç†ä»£ç ï¼š

```
static bool newArtRecordAllocationDoing24(Class *type, size_t byte_count) {

    allocObjectCount++;
	//æ ¹æ® class è·å–ç±»å
    char *typeName = GetDescriptor(type, &a);
    //è¾¾åˆ° max
    if (allocObjectCount > setAllocRecordMax) {
        CMyLock lock(g_Lock);//æ­¤å¤„éœ€è¦ loc å› ä¸ºå¯¹è±¡åˆ†é…çš„æ—¶å€™ä¸çŸ¥é“åœ¨å“ªä¸ªçº¿ç¨‹ï¼Œä¸ lock ä¼šå¯¼è‡´é‡å¤ dump
        allocObjectCount = 0;

        // dump alloc é‡Œçš„å¯¹è±¡è½¬æ¢æˆ byte æ•°æ®
        jbyteArray allocData = getARTAllocationData();
        // å°†allocæ•°æ®å†™å…¥æ–‡ä»¶
        SaveAllocationData saveData{allocData};
        saveARTAllocationData(saveData);
        resetARTAllocRecord();
        LOGI("===========CLEAR ALLOC MAPS=============");

        lock.Unlock();
    }
    return true;
}
```

[**Chapter04**](https://github.com/AndroidAdvanceWithGeektime/Chapter04)

> é€šè¿‡åˆ†æå†…å­˜æ–‡ä»¶hprofå¿«é€Ÿåˆ¤æ–­å†…å­˜ä¸­æ˜¯å¦å­˜åœ¨é‡å¤çš„å›¾ç‰‡ï¼Œå¹¶ä¸”å°†è¿™äº›é‡å¤å›¾ç‰‡çš„PNGã€å †æ ˆç­‰ä¿¡æ¯è¾“å‡ºã€‚

é¦–å…ˆæ˜¯è·å–æˆ‘ä»¬éœ€è¦åˆ†æçš„hprofæ–‡ä»¶ï¼Œæˆ‘ä»¬åŠ è½½ä¸¤å¼ ç›¸åŒçš„å›¾ç‰‡ï¼š

```
Bitmap bitmap1 = BitmapFactory.decodeResource(getResources(), R.mipmap.test);
 Bitmap bitmap2 = BitmapFactory.decodeResource(getResources(), R.mipmap.test);

 imageView1.setImageBitmap(bitmap1);
 imageView2.setImageBitmap(bitmap2);
```

ç”Ÿæˆhprofæ–‡ä»¶

```
// æ‰‹åŠ¨è§¦å‘GC
 Runtime.getRuntime().gc();
 System.runFinalization();
 Debug.dumpHprofData(file.getAbsolutePath());
```

æ¥ä¸‹æ¥å°±æ˜¯åˆ©ç”¨[HAHAåº“](https://github.com/square/haha)è¿›è¡Œæ–‡ä»¶åˆ†æçš„æ ¸å¿ƒä»£ç ï¼š

```
// æ‰“å¼€hprofæ–‡ä»¶
final HeapSnapshot heapSnapshot = new HeapSnapshot(hprofFile);
// è·å¾—snapshot
final Snapshot snapshot = heapSnapshot.getSnapshot();
// è·å¾—Bitmap Class
final ClassObj bitmapClass = snapshot.findClass("android.graphics.Bitmap");
// è·å¾—heap, åªéœ€è¦åˆ†æappå’Œdefault heapå³å¯
Collection<Heap> heaps = snapshot.getHeaps();

for (Heap heap : heaps) {
    // åªéœ€è¦åˆ†æappå’Œdefault heapå³å¯
    if (!heap.getName().equals("app") && !heap.getName().equals("default")) {
        continue;
    }
    for (ClassObj clazz : bitmapClasses) {
        //ä»heapä¸­è·å¾—æ‰€æœ‰çš„Bitmapå®ä¾‹
        List<Instance> bitmapInstances = clazz.getHeapInstances(heap.getId());
		//ä»Bitmapå®ä¾‹ä¸­è·å¾—bufferæ•°ç»„,å®½é«˜ä¿¡æ¯ç­‰ã€‚
        ArrayInstance buffer = HahaHelper.fieldValue(((ClassInstance) bitmapInstance).getValues(), "mBuffer");
        int bitmapHeight = fieldValue(bitmapInstance, "mHeight");
        int bitmapWidth = fieldValue(bitmapInstance, "mWidth");
        // å¼•ç”¨é“¾ä¿¡æ¯
        while (bitmapInstance.getNextInstanceToGcRoot() != null) {
            print(instance.getNextInstanceToGcRoot());
            instance = instance.getNextInstanceToGcRoot();
        }
        // æ ¹æ®hashcodeæ¥è¿›è¡Œé‡å¤åˆ¤æ–­
        
    }
}
```

æœ€ç»ˆçš„è¾“å‡ºç»“æœï¼š

![](https://static001.geekbang.org/resource/image/96/9c/963f4a3cabf8ef5aa4faa0a61c55bd9c.jpeg?wh=2022%2A1444)

æˆ‘ä»¬ç”¨Studioæ‰“å¼€hprofæ–‡ä»¶å¯¹æ¯”ä¸€ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/04/55/049c6beae610971175f7521bcf4f8b55.jpeg?wh=2414%2A1551)

å¯ä»¥çœ‹åˆ°ä¿¡æ¯æ˜¯ä¸€æ‘¸ä¸€æ ·çš„ã€‚å¯¹äºæ›´ä¼˜å¤„ç†å¼•ç”¨é“¾çš„ä¿¡æ¯ï¼Œå¯ä»¥å‚çœ‹[LeakCanary](https://github.com/square/leakcanary)æºç çš„å®ç°ã€‚

æˆ‘å·²ç»å°†ä¸Šé¢çš„ä»£ç æ‰“æˆJARåŒ…ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ï¼š

```
//è°ƒç”¨æ–¹æ³•ï¼š
java -jar tools/DuplicatedBitmapAnalyzer-1.0.jar hprofæ–‡ä»¶è·¯å¾„
```

è¯¦ç»†çš„ä»£ç æˆ‘æäº¤åˆ°äº†[Github](https://github.com/simplezhli/Chapter04)ï¼Œä¾›å¤§å®¶å‚è€ƒã€‚

[**Chapter05**](https://github.com/AndroidAdvanceWithGeektime/Chapter05)

> å°è¯•æ¨¡ä»¿[ProcessCpuTracker.java](http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/com/android/internal/os/ProcessCpuTracker.java)æ‹¿åˆ°ä¸€æ®µæ—¶é—´å†…å„ä¸ªçº¿ç¨‹çš„è€—æ—¶å æ¯”ã€‚

```
usage: CPU usage 5000ms(from 23:23:33.000 to 23:23:38.000):
 System TOTAL: 2.1% user + 16% kernel + 9.2% iowait + 0.2% irq + 0.1% softirq + 72% idle
 CPU Core: 8
 Load Average: 8.74 / 7.74 / 7.36

 Process:com.sample.app 
   50% 23468/com.sample.app(S): 11% user + 38% kernel faults:4965

 Threads:
   43% 23493/singleThread(R): 6.5% user + 36% kernel faultsï¼š3094
   3.2% 23485/RenderThread(S): 2.1% user + 1% kernel faultsï¼š329
   0.3% 23468/.sample.app(S): 0.3% user + 0% kernel faultsï¼š6
   0.3% 23479/HeapTaskDaemon(S): 0.3% user + 0% kernel faultsï¼š982
  ...
```

å› ä¸ºäº†è§£Linuxä¸å¤šï¼Œæ‰€ä»¥çœ‹è¿™ä¸ªæœ‰ç‚¹æ‡µé€¼ã€‚å¥½åœ¨è¯¾ä»£è¡¨å­™é¹é£åŒå­¦è§£ç­”äº†ç›¸å…³é—®é¢˜ï¼Œçœ‹æ‡‚äº†ä¸Šé¢ä¿¡æ¯ï¼ŒåŒæ—¶å­¦ä¹ åˆ°äº†ä¸€äº›LinuxçŸ¥è¯†ã€‚

```
private void testIO() {
        Thread thread = new Thread(new Runnable() {
            @Override
            public void run() {
                File f = new File(getFilesDir(), "aee.txt");
				FileOutputStream fos = new FileOutputStream(f);
				byte[] data = new byte[1024 * 4 * 3000];// æ­¤å¤„åˆ†é…ä¸€ä¸ª 12mb å¤§å°çš„ byte æ•°ç»„
	
				for (int i = 0; i < 30; i++) {// ç”±äº IO cache æœºåˆ¶çš„åŸå› æ‰€ä»¥æ­¤å¤„å†™å…¥å¤šæ¬¡ cacheï¼Œè§¦å‘ dirty writeback åˆ°ç£ç›˜ä¸­
    				Arrays.fill(data, (byte) i);// å½“æ‰§è¡Œåˆ°æ­¤å¤„çš„æ—¶å€™äº§ç”Ÿ minor faultï¼Œå¹¶ä¸”äº§ç”Ÿ User cpu useage
    				fos.write(data);
				}
				fos.flush();
				fos.close();

            }
        });
        thread.setName("SingleThread");
        thread.start();
    }
```

ä¸Šè¿°ä»£ç å°±æ˜¯å¯¼è‡´çš„é—®é¢˜ç½ªé­ç¥¸é¦–ï¼Œè¿™ç§å¯†é›†I/Oæ“ä½œé›†ä¸­åœ¨SingleThreadçº¿ç¨‹ä¸­å¤„ç†ï¼Œå¯¼è‡´å‘ç”Ÿäº†3094æ¬¡faultsã€36% kernelï¼Œå®Œå…¨æ²¡æœ‰å¾ˆå¥½åˆ©ç”¨åˆ°8æ ¸CPUã€‚

æœ€åï¼Œé€šè¿‡æ£€æµ‹CPUçš„ä½¿ç”¨ç‡ï¼Œå¯ä»¥æ›´å¥½åœ°é¿å…å¡é¡¿ç°è±¡ï¼Œé˜²æ­¢ANRçš„å‘ç”Ÿã€‚

å‰å‰ååç”¨äº†ä¸¤ä¸‰å¤©çš„æ—¶é—´ï¼Œè¿œè¿œæ²¡æœ‰å½“åˆæƒ³çš„é¡ºåˆ©ï¼Œæ„Ÿè§‰èº«ä½“è¢«æç©ºã€‚ä¸­é—´ä¹Ÿçˆ¬äº†ä¸å°‘å‘ï¼Œè™½ç„¶æ²¡æœ‰å¤ªæ·±å…¥å®ç°ä»£ç ï¼Œä½†æ˜¯ä¸­é—´çš„ä½“éªŒè¿‡ç¨‹ä¹Ÿæ˜¯æ”¶è·ä¸å°ã€‚æ‰€ä»¥æ€»ä¸èƒ½å› ä¸ºéš¾å°±æ”¾å¼ƒäº†ï¼Œå…ˆåšåˆ°åŠ›æ‰€èƒ½åŠçš„éƒ¨åˆ†ï¼Œè®©è‡ªå·±åŠ¨èµ·æ¥ï¼

**å‚è€ƒ**

- [ç»ƒä¹ Sampleè·‘èµ·æ¥ | çƒ­ç‚¹é—®é¢˜ç­”ç–‘ç¬¬1æœŸ](https://time.geekbang.org/column/article/73068)
- [ç»ƒä¹ Sampleè·‘èµ·æ¥ | çƒ­ç‚¹é—®é¢˜ç­”ç–‘ç¬¬2æœŸ](https://time.geekbang.org/column/article/75440)
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ10ï¼‰</strong></div><ul>
<li><span>æˆ´å¯…å</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>å¼ è€å¸ˆæ‚¨å¥½ï¼Œå…³äºchapter01ç»ƒä¹ ï¼Œæˆ‘æƒ³è‡ªå·±æ‰‹åŠ¨å»ç¼–è¯‘ä¸€ä¸‹breakpadæŒ‰ç…§æ‚¨çš„æ•™ç¨‹ï¼Œä¸è¿‡åœ¨clone depot_toolsçš„æ—¶å€™ï¼Œå‡ºç°äº†failed to connect 443ï¼Œæœç´¢åä½¿ç”¨äº†å¾ˆå¤šå¯èƒ½çš„åŠæ³•ï¼Œå¥½åƒéƒ½ä¸è¡Œï¼Œè¿˜æœ›æ‚¨æŒ‡æ•™ï¼Œè°¢è°¢</p>2019-03-02</li><br/><li><span>CathyChen</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ä¼˜ç§€ï¼Œè¦å‘ä½ å­¦ä¹ </p>2019-03-01</li><br/><li><span>LD</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ä¼˜ç§€</p>2019-03-01</li><br/><li><span>è‘£å°šæ–Œ</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ä¼˜ç§€</p>2019-02-28</li><br/><li><span>å°è™å“¥V</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>åŒå­¦å¤ªä¼˜ç§€å•¦ï¼Œèµ</p>2019-02-28</li><br/><li><span>å¤</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ä¼˜ç§€</p>2019-02-28</li><br/><li><span>zhuxiaohao</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>åŒå­¦ä¼˜ç§€ã€‚</p>2019-02-28</li><br/><li><span>GEEK_jahen</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ¨¡ä»¿ProcessCpuTrackerèƒ½å¦æ‰¾åˆ°æ­»å¾ªç¯çš„çº¿ç¨‹ï¼Œæ­»å¾ªç¯çº¿ç¨‹çš„ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</p>2022-10-27</li><br/><li><span>EchoSomeTH</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>ArrayInstanceå’‹å¼„å‡ºæ¥çš„ï¼Ÿè¯·é—®ï¼Ÿé‚£ä¸ªHahaHelperèƒ½å‘ä¸€ä¸ªå—ï¼Ÿ</p>2019-07-21</li><br/><li><span>ç¨‹åºå‘˜å°è·ƒ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ—¶é—´æ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†ï¼Œç»™åŠ›ç»™åŠ›</p>2019-06-20</li><br/>
</ul>