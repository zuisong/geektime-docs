ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆèˆªã€‚

åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¸ä½ åˆ†äº«äº†è°ƒè¯•Flutterä»£ç çš„3ç§åŸºæœ¬æ–¹å¼ï¼Œå³è¾“å‡ºæ—¥å¿—ã€æ–­ç‚¹è°ƒè¯•ä¸å¸ƒå±€è°ƒè¯•ã€‚

é€šè¿‡å¯å®šåˆ¶æ‰“å°è¡Œä¸ºçš„debugPrintå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ç”Ÿäº§ç¯å¢ƒä¸å¼€å‘ç¯å¢ƒä¸åŒçš„æ—¥å¿—è¾“å‡ºè¡Œä¸ºï¼Œä»è€Œä¿è¯åœ¨å¼€å‘æœŸæ‰“å°çš„è°ƒè¯•ä¿¡æ¯ä¸ä¼šè¢«å‘å¸ƒè‡³çº¿ä¸Šï¼›å€ŸåŠ©äºIDEï¼ˆAndroid Studioï¼‰æ‰€æä¾›çš„æ–­ç‚¹è°ƒè¯•é€‰é¡¹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸æ–­è°ƒæ•´ä»£ç æ‰§è¡Œæ­¥é•¿å’Œä»£ç æš‚åœæ¡ä»¶ï¼Œæ”¶æ•›é—®é¢˜å‘ç”ŸèŒƒå›´ï¼Œç›´è‡³æ‰¾åˆ°é—®é¢˜æ ¹æºï¼›è€Œå¦‚æœæˆ‘ä»¬æƒ³æ‰¾å‡ºä»£ç ä¸­çš„å¸ƒå±€æ¸²æŸ“ç±»Bugï¼Œåˆ™å¯ä»¥é€šè¿‡Debug Paintingå’ŒFlutter Inspectoræä¾›çš„è¾…åŠ©çº¿å’Œè§†å›¾å¯è§†åŒ–ä¿¡æ¯ï¼Œæ¥æ›´ä¸ºç²¾å‡†åœ°å®šä½è§†è§‰é—®é¢˜ã€‚

é™¤äº†ä»£ç é€»è¾‘Bugå’Œè§†è§‰å¼‚å¸¸è¿™äº›åŠŸèƒ½å±‚é¢çš„é—®é¢˜ä¹‹å¤–ï¼Œç§»åŠ¨åº”ç”¨å¦ä¸€ç±»å¸¸è§çš„é—®é¢˜æ˜¯æ€§èƒ½é—®é¢˜ï¼Œæ¯”å¦‚æ»‘åŠ¨æ“ä½œä¸æµç•…ã€é¡µé¢å‡ºç°å¡é¡¿ä¸¢å¸§ç°è±¡ç­‰ã€‚è¿™äº›é—®é¢˜è™½ç„¶ä¸è‡³äºè®©ç§»åŠ¨åº”ç”¨å®Œå…¨ä¸å¯ç”¨ï¼Œä½†ä¹Ÿå¾ˆå®¹æ˜“å¼•èµ·ç”¨æˆ·åæ„Ÿï¼Œä»è€Œå¯¹åº”ç”¨è´¨é‡äº§ç”Ÿè´¨ç–‘ï¼Œç”šè‡³å¤±å»è€å¿ƒã€‚

é‚£ä¹ˆï¼Œå¦‚æœåº”ç”¨æ¸²æŸ“å¹¶ä¸æµç•…ï¼Œå‡ºç°äº†æ€§èƒ½é—®é¢˜ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•æ£€æµ‹ï¼Œåˆè¯¥ä»å“ªé‡Œç€æ‰‹å¤„ç†å‘¢ï¼Ÿ

åœ¨Flutterä¸­ï¼Œæ€§èƒ½é—®é¢˜å¯ä»¥åˆ†ä¸ºGPUçº¿ç¨‹é—®é¢˜å’ŒUIçº¿ç¨‹ï¼ˆCPUï¼‰é—®é¢˜ä¸¤ç±»ã€‚è¿™äº›é—®é¢˜çš„ç¡®è®¤éƒ½éœ€è¦å…ˆé€šè¿‡æ€§èƒ½å›¾å±‚è¿›è¡Œåˆæ­¥åˆ†æï¼Œè€Œä¸€æ—¦ç¡®è®¤é—®é¢˜å­˜åœ¨ï¼Œæ¥ä¸‹æ¥å°±éœ€è¦åˆ©ç”¨Flutteræä¾›çš„å„ç±»åˆ†æå·¥å…·æ¥å®šä½é—®é¢˜äº†ã€‚

æ‰€ä»¥åœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¼šä¸ä½ ä¸€èµ·å­¦ä¹ åˆ†æFlutteråº”ç”¨æ€§èƒ½é—®é¢˜çš„åŸºæœ¬æ€è·¯å’Œå·¥å…·ï¼Œä»¥åŠå¸¸è§çš„ä¼˜åŒ–åŠæ³•ã€‚

## å¦‚ä½•ä½¿ç”¨æ€§èƒ½å›¾å±‚ï¼Ÿ

è¦è§£å†³é—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆå¾—äº†è§£å¦‚ä½•å»åº¦é‡é—®é¢˜ï¼Œæ€§èƒ½åˆ†æä¹Ÿä¸ä¾‹å¤–ã€‚Flutteræä¾›äº†åº¦é‡æ€§èƒ½é—®é¢˜çš„å·¥å…·å’Œæ‰‹æ®µï¼Œæ¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½ä»£ç ä¸­çš„æ€§èƒ½é—®é¢˜ï¼Œè€Œæ€§èƒ½å›¾å±‚å°±æ˜¯å¸®åŠ©æˆ‘ä»¬ç¡®è®¤é—®é¢˜å½±å“èŒƒå›´çš„åˆ©å™¨ã€‚

**ä¸ºäº†ä½¿ç”¨æ€§èƒ½å›¾å±‚ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ä»¥åˆ†æï¼ˆProfileï¼‰æ¨¡å¼å¯åŠ¨åº”ç”¨ã€‚**ä¸è°ƒè¯•ä»£ç å¯ä»¥é€šè¿‡æ¨¡æ‹Ÿå™¨åœ¨è°ƒè¯•æ¨¡å¼ä¸‹æ‰¾åˆ°ä»£ç é€»è¾‘Bugä¸åŒï¼Œæ€§èƒ½é—®é¢˜éœ€è¦åœ¨å‘å¸ƒæ¨¡å¼ä¸‹ä½¿ç”¨çœŸæœºè¿›è¡Œæ£€æµ‹ã€‚

è¿™æ˜¯å› ä¸ºï¼Œç›¸æ¯”å‘å¸ƒæ¨¡å¼è€Œè¨€ï¼Œè°ƒè¯•æ¨¡å¼å¢åŠ äº†å¾ˆå¤šé¢å¤–çš„æ£€æŸ¥ï¼ˆæ¯”å¦‚æ–­è¨€ï¼‰ï¼Œè¿™äº›æ£€æŸ¥å¯èƒ½ä¼šè€—è´¹å¾ˆå¤šèµ„æºï¼›æ›´é‡è¦çš„æ˜¯ï¼Œè°ƒè¯•æ¨¡å¼ä½¿ç”¨JITæ¨¡å¼è¿è¡Œåº”ç”¨ï¼Œä»£ç æ‰§è¡Œæ•ˆç‡è¾ƒä½ã€‚è¿™å°±ä½¿å¾—è°ƒè¯•æ¨¡å¼è¿è¡Œçš„åº”ç”¨ï¼Œæ— æ³•çœŸå®åæ˜ å‡ºå®ƒçš„æ€§èƒ½é—®é¢˜ã€‚

è€Œå¦ä¸€æ–¹é¢ï¼Œæ¨¡æ‹Ÿå™¨ä½¿ç”¨çš„æŒ‡ä»¤é›†ä¸ºx86ï¼Œè€ŒçœŸæœºä½¿ç”¨çš„æŒ‡ä»¤é›†æ˜¯ARMã€‚è¿™ä¸¤ç§æ–¹å¼çš„äºŒè¿›åˆ¶ä»£ç æ‰§è¡Œè¡Œä¸ºå®Œå…¨ä¸åŒï¼Œå› æ­¤æ¨¡æ‹Ÿå™¨ä¸çœŸæœºçš„æ€§èƒ½å·®å¼‚è¾ƒå¤§ï¼šä¸€äº›x86æŒ‡ä»¤é›†æ“…é•¿çš„æ“ä½œæ¨¡æ‹Ÿå™¨ä¼šæ¯”çœŸæœºå¿«ï¼Œè€Œå¦ä¸€äº›æ“ä½œåˆ™ä¼šæ¯”çœŸæœºæ…¢ã€‚è¿™ä¹Ÿä½¿å¾—æˆ‘ä»¬æ— æ³•ä½¿ç”¨æ¨¡æ‹Ÿå™¨æ¥è¯„ä¼°çœŸæœºæ‰èƒ½å‡ºç°çš„æ€§èƒ½é—®é¢˜ã€‚

**ä¸ºäº†è°ƒè¯•æ€§èƒ½é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å‘å¸ƒæ¨¡å¼çš„åŸºç¡€ä¹‹ä¸Šï¼Œä¸ºåˆ†æå·¥å…·æä¾›å°‘é‡å¿…è¦çš„åº”ç”¨è¿½è¸ªä¿¡æ¯ï¼Œè¿™å°±æ˜¯åˆ†ææ¨¡å¼**ã€‚é™¤äº†ä¸€äº›è°ƒè¯•æ€§èƒ½é—®é¢˜å¿…é¡»çš„è¿½è¸ªæ–¹æ³•ä¹‹å¤–ï¼ŒFlutteråº”ç”¨çš„åˆ†ææ¨¡å¼å’Œå‘å¸ƒæ¨¡å¼çš„ç¼–è¯‘å’Œè¿è¡Œæ˜¯ç±»ä¼¼çš„ï¼Œåªæ˜¯å¯åŠ¨å‚æ•°å˜æˆäº†profileè€Œå·²ï¼šæˆ‘ä»¬æ—¢å¯ä»¥åœ¨Android Studioä¸­é€šè¿‡èœå•æ ç‚¹å‡»Run-&gt;Profile â€˜main.dartâ€™ é€‰é¡¹å¯åŠ¨åº”ç”¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°flutter run --profileè¿è¡ŒFlutteråº”ç”¨ã€‚

## åˆ†ææ¸²æŸ“é—®é¢˜

åœ¨å®Œæˆäº†åº”ç”¨å¯åŠ¨ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨Flutteræä¾›çš„æ¸²æŸ“é—®é¢˜åˆ†æå·¥å…·ï¼Œå³æ€§èƒ½å›¾å±‚ï¼ˆPerformance Overlayï¼‰ï¼Œæ¥åˆ†ææ¸²æŸ“é—®é¢˜äº†ã€‚

æ€§èƒ½å›¾å±‚ä¼šåœ¨å½“å‰åº”ç”¨çš„æœ€ä¸Šå±‚ï¼Œä»¥Flutterå¼•æ“è‡ªç»˜çš„æ–¹å¼å±•ç¤ºGPUä¸UIçº¿ç¨‹çš„æ‰§è¡Œå›¾è¡¨ï¼Œè€Œå…¶ä¸­æ¯ä¸€å¼ å›¾è¡¨éƒ½ä»£è¡¨å½“å‰çº¿ç¨‹æœ€è¿‘ 300å¸§çš„è¡¨ç°ï¼Œå¦‚æœUIäº§ç”Ÿäº†å¡é¡¿ï¼ˆè·³å¸§ï¼‰ï¼Œè¿™äº›å›¾è¡¨å¯ä»¥å¸®åŠ©æˆ‘ä»¬åˆ†æå¹¶æ‰¾åˆ°åŸå› ã€‚

ä¸‹å›¾æ¼”ç¤ºäº†æ€§èƒ½å›¾å±‚çš„å±•ç°æ ·å¼ã€‚å…¶ä¸­ï¼ŒGPUçº¿ç¨‹çš„æ€§èƒ½æƒ…å†µåœ¨ä¸Šé¢ï¼ŒUIçº¿ç¨‹çš„æƒ…å†µæ˜¾ç¤ºåœ¨ä¸‹é¢ï¼Œè“è‰²å‚ç›´çš„çº¿æ¡è¡¨ç¤ºå·²æ‰§è¡Œçš„æ­£å¸¸å¸§ï¼Œç»¿è‰²çš„çº¿æ¡ä»£è¡¨çš„æ˜¯å½“å‰å¸§ï¼š

![](https://static001.geekbang.org/resource/image/91/8e/91eb7eff1c5c2326f2904044b950fe8e.png?wh=1125%2A522)

å›¾1 æ€§èƒ½å›¾å±‚

ä¸ºäº†ä¿æŒ60Hzçš„åˆ·æ–°é¢‘ç‡ï¼ŒGPUçº¿ç¨‹ä¸UIçº¿ç¨‹ä¸­æ‰§è¡Œæ¯ä¸€å¸§è€—è´¹çš„æ—¶é—´éƒ½åº”è¯¥å°äº16msï¼ˆ1/60ç§’ï¼‰ã€‚åœ¨è¿™å…¶ä¸­æœ‰ä¸€å¸§å¤„ç†æ—¶é—´è¿‡é•¿ï¼Œå°±ä¼šå¯¼è‡´ç•Œé¢å¡é¡¿ï¼Œå›¾è¡¨ä¸­å°±ä¼šå±•ç¤ºå‡ºä¸€ä¸ªçº¢è‰²ç«–æ¡ã€‚ä¸‹å›¾æ¼”ç¤ºäº†åº”ç”¨å‡ºç°æ¸²æŸ“å’Œç»˜åˆ¶è€—æ—¶çš„æƒ…å†µä¸‹ï¼Œæ€§èƒ½å›¾å±‚çš„å±•ç¤ºæ ·å¼ï¼š

![](https://static001.geekbang.org/resource/image/bf/c1/bfb5ec2b5dcf7a2c20b7ec3b946854c1.jpeg?wh=1125%2A561)

å›¾2 æ¸²æŸ“å’Œç»˜åˆ¶è€—æ—¶å¼‚å¸¸

å¦‚æœçº¢è‰²ç«–æ¡å‡ºç°åœ¨GPUçº¿ç¨‹å›¾è¡¨ï¼Œæ„å‘³ç€æ¸²æŸ“çš„å›¾å½¢å¤ªå¤æ‚ï¼Œå¯¼è‡´æ— æ³•å¿«é€Ÿæ¸²æŸ“ï¼›è€Œå¦‚æœæ˜¯å‡ºç°åœ¨äº†UIçº¿ç¨‹å›¾è¡¨ï¼Œåˆ™è¡¨ç¤ºDartä»£ç æ¶ˆè€—äº†å¤§é‡èµ„æºï¼Œéœ€è¦ä¼˜åŒ–ä»£ç æ‰§è¡Œæ—¶é—´ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å…ˆçœ‹çœ‹GPUé—®é¢˜å®šä½å§ã€‚

## GPUé—®é¢˜å®šä½

GPUé—®é¢˜ä¸»è¦é›†ä¸­åœ¨åº•å±‚æ¸²æŸ“è€—æ—¶ä¸Šã€‚æœ‰æ—¶å€™Widgetæ ‘è™½ç„¶æ„é€ èµ·æ¥å®¹æ˜“ï¼Œä½†åœ¨GPUçº¿ç¨‹ä¸‹çš„æ¸²æŸ“å´å¾ˆè€—æ—¶ã€‚æ¶‰åŠWidgetè£å‰ªã€è’™å±‚è¿™ç±»å¤šè§†å›¾å åŠ æ¸²æŸ“ï¼Œæˆ–æ˜¯ç”±äºç¼ºå°‘ç¼“å­˜å¯¼è‡´é™æ€å›¾åƒçš„åå¤ç»˜åˆ¶ï¼Œéƒ½ä¼šæ˜æ˜¾æ‹–æ…¢GPUçš„æ¸²æŸ“é€Ÿåº¦ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ€§èƒ½å›¾å±‚æä¾›çš„ä¸¤é¡¹å‚æ•°ï¼Œå³æ£€æŸ¥å¤šè§†å›¾å åŠ çš„è§†å›¾æ¸²æŸ“å¼€å…³checkerboardOffscreenLayersï¼Œå’Œæ£€æŸ¥ç¼“å­˜çš„å›¾åƒå¼€å…³checkerboardRasterCacheImagesï¼Œæ¥æ£€æŸ¥è¿™ä¸¤ç§æƒ…å†µã€‚

### checkerboardOffscreenLayers

å¤šè§†å›¾å åŠ é€šå¸¸ä¼šç”¨åˆ°Canvasé‡Œçš„savaLayeræ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨å®ç°ä¸€äº›ç‰¹å®šçš„æ•ˆæœï¼ˆæ¯”å¦‚åŠé€æ˜ï¼‰æ—¶éå¸¸æœ‰ç”¨ï¼Œä½†ç”±äºå…¶åº•å±‚å®ç°ä¼šåœ¨GPUæ¸²æŸ“ä¸Šæ¶‰åŠå¤šå›¾å±‚çš„åå¤ç»˜åˆ¶ï¼Œå› æ­¤ä¼šå¸¦æ¥è¾ƒå¤§çš„æ€§èƒ½é—®é¢˜ã€‚

å¯¹äºsaveLayeræ–¹æ³•ä½¿ç”¨æƒ…å†µçš„æ£€æŸ¥ï¼Œæˆ‘ä»¬åªè¦åœ¨MaterialAppçš„åˆå§‹åŒ–æ–¹æ³•ä¸­ï¼Œå°†checkerboardOffscreenLayerså¼€å…³è®¾ç½®ä¸ºtrueï¼Œåˆ†æå·¥å…·å°±ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æ£€æµ‹å¤šè§†å›¾å åŠ çš„æƒ…å†µäº†ï¼šä½¿ç”¨äº†saveLayerçš„Widgetä¼šè‡ªåŠ¨æ˜¾ç¤ºä¸ºæ£‹ç›˜æ ¼å¼ï¼Œå¹¶éšç€é¡µé¢åˆ·æ–°è€Œé—ªçƒã€‚

ä¸è¿‡ï¼ŒsaveLayeræ˜¯ä¸€ä¸ªè¾ƒä¸ºåº•å±‚çš„ç»˜åˆ¶æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šç›´æ¥ä½¿ç”¨å®ƒï¼Œè€Œæ˜¯ä¼šé€šè¿‡ä¸€äº›åŠŸèƒ½æ€§Widgetï¼Œåœ¨æ¶‰åŠéœ€è¦å‰ªåˆ‡æˆ–åŠé€æ˜è’™å±‚çš„åœºæ™¯ä¸­é—´æ¥åœ°ä½¿ç”¨ã€‚æ‰€ä»¥ä¸€æ—¦é‡åˆ°è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦æ€è€ƒä¸€ä¸‹æ˜¯å¦ä¸€å®šè¦è¿™ä¹ˆåšï¼Œèƒ½ä¸èƒ½é€šè¿‡å…¶ä»–æ–¹å¼æ¥å®ç°å‘¢ã€‚

æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨CupertinoPageScaffoldä¸CupertinoNavigationBarå®ç°äº†ä¸€ä¸ªåŠ¨æ€æ¨¡ç³Šçš„æ•ˆæœã€‚

```
CupertinoPageScaffold(
  navigationBar: CupertinoNavigationBar(),//åŠ¨æ€æ¨¡ç³Šå¯¼èˆªæ 
    child: ListView.builder(
      itemCount: 100,
      //ä¸ºåˆ—è¡¨åˆ›å»º100ä¸ªä¸åŒé¢œè‰²çš„RowItem
      itemBuilder: (context, index)=>TabRowItem(
            index: index,
            lastItem: index == 100 - 1,
            color: colorItems[index],//è®¾ç½®ä¸åŒçš„é¢œè‰²
            colorName: colorNameItems[index],
          )
    )
);
```

![](https://static001.geekbang.org/resource/image/19/11/1988216282ce60059462da7b9a2eda11.gif?wh=300%2A650)

å›¾3 åŠ¨æ€æ¨¡ç³Šæ•ˆæœ

ç”±äºè§†å›¾æ»šåŠ¨è¿‡ç¨‹ä¸­é¢‘ç¹æ¶‰åŠè§†å›¾è’™å±‚æ•ˆæœçš„æ›´æ–°ï¼Œå› æ­¤checkerboardOffscreenLayersæ£€æµ‹å›¾å±‚ä¹Ÿæ„Ÿå—åˆ°äº†å¯¹GPUçš„æ¸²æŸ“å‹åŠ›ï¼Œé¢‘ç¹çš„åˆ·æ–°é—ªçƒã€‚

![](https://static001.geekbang.org/resource/image/55/db/5585780bfd5dcae6a3498b7119a558db.gif?wh=300%2A650)

å›¾4 æ£€æµ‹saveLayerä½¿ç”¨

å¦‚æœæˆ‘ä»¬æ²¡æœ‰å¯¹åŠ¨æ€æ¨¡ç³Šæ•ˆæœçš„ç‰¹æ®Šéœ€æ±‚ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä¸å¸¦æ¨¡ç³Šæ•ˆæœçš„Scaffoldå’Œç™½è‰²çš„AppBarå®ç°åŒæ ·çš„äº§å“åŠŸèƒ½ï¼Œæ¥è§£å†³è¿™ä¸ªæ€§èƒ½é—®é¢˜ï¼š

```
Scaffold(
  //ä½¿ç”¨æ™®é€šçš„ç™½è‰²AppBar
  appBar: AppBar(title: Text('Home', style: TextStyle(color:Colors.black),),backgroundColor: Colors.white),
  body: ListView.builder(
      itemCount: 100,
      //ä¸ºåˆ—è¡¨åˆ›å»º100ä¸ªä¸åŒé¢œè‰²çš„RowItem
      itemBuilder: (context, index)=>TabRowItem(
        index: index,
        lastItem: index == 100 - 1,
        color: colorItems[index],//è®¾ç½®ä¸åŒçš„é¢œè‰²
        colorName: colorNameItems[index],
      )
  ),
);
```

è¿è¡Œä¸€ä¸‹ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œåœ¨å»æ‰äº†åŠ¨æ€æ¨¡ç³Šæ•ˆæœä¹‹åï¼ŒGPUçš„æ¸²æŸ“å‹åŠ›å¾—åˆ°äº†ç¼“è§£ï¼ŒcheckerboardOffscreenLayersæ£€æµ‹å›¾å±‚ä¹Ÿä¸å†é¢‘ç¹é—ªçƒäº†ã€‚

![](https://static001.geekbang.org/resource/image/8c/46/8c937383845cb306dade4ab9c374ed46.gif?wh=300%2A650)

å›¾5 å»æ‰åŠ¨æ€æ¨¡ç³Šæ•ˆæœ

### checkerboardRasterCacheImages

ä»èµ„æºçš„è§’åº¦çœ‹ï¼Œå¦ä¸€ç±»éå¸¸æ¶ˆè€—æ€§èƒ½çš„æ“ä½œæ˜¯ï¼Œæ¸²æŸ“å›¾åƒã€‚è¿™æ˜¯å› ä¸ºå›¾åƒçš„æ¸²æŸ“æ¶‰åŠI/Oã€GPUå­˜å‚¨ï¼Œä»¥åŠä¸åŒé€šé“çš„æ•°æ®æ ¼å¼è½¬æ¢ï¼Œå› æ­¤æ¸²æŸ“è¿‡ç¨‹çš„æ„å»ºéœ€è¦æ¶ˆè€—å¤§é‡èµ„æºã€‚ä¸ºäº†ç¼“è§£GPUçš„å‹åŠ›ï¼ŒFlutteræä¾›äº†å¤šå±‚æ¬¡çš„ç¼“å­˜å¿«ç…§ï¼Œè¿™æ ·Widgeté‡å»ºæ—¶å°±æ— éœ€é‡æ–°ç»˜åˆ¶é™æ€å›¾åƒäº†ã€‚

ä¸æ£€æŸ¥å¤šè§†å›¾å åŠ æ¸²æŸ“çš„checkerboardOffscreenLayerså‚æ•°ç±»ä¼¼ï¼ŒFlutterä¹Ÿæä¾›äº†æ£€æŸ¥ç¼“å­˜å›¾åƒçš„å¼€å…³checkerboardRasterCacheImagesï¼Œæ¥æ£€æµ‹åœ¨ç•Œé¢é‡ç»˜æ—¶é¢‘ç¹é—ªçƒçš„å›¾åƒï¼ˆå³æ²¡æœ‰é™æ€ç¼“å­˜ï¼‰ã€‚

æˆ‘ä»¬å¯ä»¥æŠŠéœ€è¦é™æ€ç¼“å­˜çš„å›¾åƒåŠ åˆ°RepaintBoundaryä¸­ï¼ŒRepaintBoundaryå¯ä»¥ç¡®å®šWidgetæ ‘çš„é‡ç»˜è¾¹ç•Œï¼Œå¦‚æœå›¾åƒè¶³å¤Ÿå¤æ‚ï¼ŒFlutterå¼•æ“ä¼šè‡ªåŠ¨å°†å…¶ç¼“å­˜ï¼Œé¿å…é‡å¤åˆ·æ–°ã€‚å½“ç„¶ï¼Œå› ä¸ºç¼“å­˜èµ„æºæœ‰é™ï¼Œå¦‚æœå¼•æ“è®¤ä¸ºå›¾åƒä¸å¤Ÿå¤æ‚ï¼Œä¹Ÿå¯èƒ½ä¼šå¿½ç•¥RepaintBoundaryã€‚

å¦‚ä¸‹ä»£ç å±•ç¤ºäº†é€šè¿‡RepaintBoundaryï¼Œå°†ä¸€ä¸ªé™æ€å¤åˆWidgetåŠ å…¥ç¼“å­˜çš„å…·ä½“ç”¨æ³•ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒRepaintBoundaryåœ¨ä½¿ç”¨ä¸Šä¸æ™®é€šWidgetå¹¶æ— åŒºåˆ«ï¼š

```
RepaintBoundary(//è®¾ç½®é™æ€ç¼“å­˜å›¾åƒ
  child: Center(
    child: Container(
      color: Colors.black,
      height: 10.0,
      width: 10.0,
    ),
));
```

## UIçº¿ç¨‹é—®é¢˜å®šä½

å¦‚æœè¯´GPUçº¿ç¨‹é—®é¢˜å®šä½çš„æ˜¯æ¸²æŸ“å¼•æ“åº•å±‚æ¸²æŸ“å¼‚å¸¸ï¼Œé‚£ä¹ˆUIçº¿ç¨‹é—®é¢˜å‘ç°çš„åˆ™æ˜¯åº”ç”¨çš„æ€§èƒ½ç“¶é¢ˆã€‚æ¯”å¦‚åœ¨è§†å›¾æ„å»ºæ—¶ï¼Œåœ¨buildæ–¹æ³•ä¸­ä½¿ç”¨äº†ä¸€äº›å¤æ‚çš„è¿ç®—ï¼Œæˆ–æ˜¯åœ¨ä¸»Isolateä¸­è¿›è¡Œäº†åŒæ­¥çš„I/Oæ“ä½œã€‚è¿™äº›é—®é¢˜ï¼Œéƒ½ä¼šæ˜æ˜¾å¢åŠ CPUçš„å¤„ç†æ—¶é—´ï¼Œæ‹–æ…¢åº”ç”¨çš„å“åº”é€Ÿåº¦ã€‚

è¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Flutteræä¾›çš„Performanceå·¥å…·ï¼Œæ¥è®°å½•åº”ç”¨çš„æ‰§è¡Œè½¨è¿¹ã€‚Performanceæ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œèƒ½å¤Ÿä»¥æ—¶é—´è½´çš„æ–¹å¼å±•ç¤ºCPUçš„è°ƒç”¨æ ˆå’Œæ‰§è¡Œæ—¶é—´ï¼Œå»æ£€æŸ¥ä»£ç ä¸­å¯ç–‘çš„æ–¹æ³•è°ƒç”¨ã€‚

åœ¨ç‚¹å‡»äº†Android Studioåº•éƒ¨å·¥å…·æ ä¸­çš„â€œOpen DevToolsâ€æŒ‰é’®ä¹‹åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ‰“å¼€Dart DevToolsçš„ç½‘é¡µï¼Œå°†é¡¶éƒ¨çš„tabåˆ‡æ¢åˆ°Performanceåï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹åˆ†æä»£ç ä¸­çš„æ€§èƒ½é—®é¢˜äº†ã€‚

![](https://static001.geekbang.org/resource/image/11/3a/11d8392713ed0ce8615eeb360662653a.png?wh=478%2A156)

å›¾6 æ‰“å¼€Performanceå·¥å…·

![](https://static001.geekbang.org/resource/image/86/87/867cbb2e87f5f18df0e1ac1a114bf687.png?wh=1978%2A1560)

å›¾7 Performanceä¸»ç•Œé¢

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªListViewä¸­è®¡ç®—MD5çš„ä¾‹å­ï¼Œæ¥æ¼”ç¤ºPerformanceçš„å…·ä½“åˆ†æè¿‡ç¨‹ã€‚

è€ƒè™‘åˆ°åœ¨buildå‡½æ•°ä¸­è¿›è¡Œæ¸²æŸ“ä¿¡æ¯çš„ç»„è£…æ˜¯ä¸€ä¸ªå¸¸è§çš„æ“ä½œï¼Œä¸ºäº†æ¼”ç¤ºè¿™ä¸ªçŸ¥è¯†ç‚¹ï¼Œæˆ‘ä»¬æ•…æ„æ”¾å¤§äº†è®¡ç®—MD5çš„è€—æ—¶ï¼Œå¾ªç¯è¿­ä»£è®¡ç®—äº†1ä¸‡æ¬¡ï¼š

```
class MyHomePage extends StatelessWidget {
  MyHomePage({Key key}) : super(key: key);

  String generateMd5(String data) {
    //MD5å›ºå®šç®—æ³•
    var content = new Utf8Encoder().convert(data);
    var digest = md5.convert(content);
    return hex.encode(digest.bytes);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('demo')),
      body: ListView.builder(
          itemCount: 30,// åˆ—è¡¨å…ƒç´ ä¸ªæ•°
          itemBuilder: (context, index) {
            //åå¤è¿­ä»£è®¡ç®—MD5
            String str = '1234567890abcdefghijklmnopqrstuvwxyz';
            for(int i = 0;i<10000;i++) {
              str = generateMd5(str);
            }
            return ListTile(title: Text("Index : $index"), subtitle: Text(str));
          }// åˆ—è¡¨é¡¹åˆ›å»ºæ–¹æ³•
      ),
    );
  }
}
```

ä¸æ€§èƒ½å›¾å±‚èƒ½å¤Ÿè‡ªåŠ¨è®°å½•åº”ç”¨æ‰§è¡Œæƒ…å†µä¸åŒï¼Œä½¿ç”¨Performanceæ¥åˆ†æä»£ç æ‰§è¡Œè½¨è¿¹ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ç‚¹å‡»â€œRecordâ€æŒ‰é’®å»ä¸»åŠ¨è§¦å‘ï¼Œåœ¨å®Œæˆä¿¡æ¯çš„æŠ½æ ·é‡‡é›†åï¼Œç‚¹å‡»â€œStopâ€æŒ‰é’®ç»“æŸå½•åˆ¶ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°åœ¨è¿™æœŸé—´åº”ç”¨çš„æ‰§è¡Œæƒ…å†µäº†ã€‚

Performanceè®°å½•çš„åº”ç”¨æ‰§è¡Œæƒ…å†µå«åšCPUå¸§å›¾ï¼Œåˆè¢«ç§°ä¸ºç«ç„°å›¾ã€‚ç«ç„°å›¾æ˜¯åŸºäºè®°å½•ä»£ç æ‰§è¡Œç»“æœæ‰€äº§ç”Ÿçš„å›¾ç‰‡ï¼Œç”¨æ¥å±•ç¤ºCPUçš„è°ƒç”¨æ ˆï¼Œè¡¨ç¤ºçš„æ˜¯CPU çš„ç¹å¿™ç¨‹åº¦ã€‚

å…¶ä¸­ï¼Œyè½´è¡¨ç¤ºè°ƒç”¨æ ˆï¼Œå…¶æ¯ä¸€å±‚éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚è°ƒç”¨æ ˆè¶Šæ·±ï¼Œç«ç„°å°±è¶Šé«˜ï¼Œåº•éƒ¨å°±æ˜¯æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°ï¼Œä¸Šæ–¹éƒ½æ˜¯å®ƒçš„çˆ¶å‡½æ•°ï¼›xè½´è¡¨ç¤ºå•ä½æ—¶é—´ï¼Œä¸€ä¸ªå‡½æ•°åœ¨xè½´å æ®çš„å®½åº¦è¶Šå®½ï¼Œå°±è¡¨ç¤ºå®ƒè¢«é‡‡æ ·åˆ°çš„æ¬¡æ•°è¶Šå¤šï¼Œå³æ‰§è¡Œæ—¶é—´è¶Šé•¿ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦æ£€æµ‹CPUè€—æ—¶é—®é¢˜ï¼Œçš†å¯ä»¥æŸ¥çœ‹ç«ç„°å›¾åº•éƒ¨çš„å“ªä¸ªå‡½æ•°å æ®çš„å®½åº¦æœ€å¤§ã€‚åªè¦æœ‰â€œå¹³é¡¶â€ï¼Œå°±è¡¨ç¤ºè¯¥å‡½æ•°å¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬è¿™ä¸ªæ¡ˆä¾‹çš„ç«ç„°å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://static001.geekbang.org/resource/image/12/02/1262ed91986a5e09646d56e5a2db3302.png?wh=2252%2A1218)

å›¾8 CPUå¸§å›¾/ç«ç„°å›¾

å¯ä»¥çœ‹åˆ°ï¼Œ\_MyHomePage.generateMd5å‡½æ•°çš„æ‰§è¡Œæ—¶é—´æœ€é•¿ï¼Œå‡ ä¹å æ»¡äº†æ•´ä¸ªç«ç„°å›¾çš„å®½ï¼Œè€Œè¿™ä¹Ÿä¸ä»£ç ä¸­å­˜åœ¨çš„é—®é¢˜æ˜¯ä¸€è‡´çš„ã€‚

åœ¨æ‰¾åˆ°äº†é—®é¢˜ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨Isolateï¼ˆæˆ–computeï¼‰å°†è¿™äº›è€—æ—¶çš„æ“ä½œæŒªåˆ°å¹¶å‘ä¸»Isolateä¹‹å¤–å»å®Œæˆäº†ã€‚

## æ€»ç»“

å¥½äº†ï¼Œä»Šå¤©çš„åˆ†äº«å°±åˆ°è¿™é‡Œã€‚æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä»Šå¤©çš„ä¸»è¦å†…å®¹å§ã€‚

åœ¨Flutterä¸­ï¼Œæ€§èƒ½åˆ†æè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºGPUçº¿ç¨‹é—®é¢˜å®šä½å’ŒUIçº¿ç¨‹ï¼ˆCPUï¼‰é—®é¢˜å®šä½ï¼Œè€Œå®ƒä»¬éƒ½éœ€è¦åœ¨çœŸæœºä¸Šä»¥åˆ†ææ¨¡å¼ï¼ˆProfileï¼‰å¯åŠ¨åº”ç”¨ï¼Œå¹¶é€šè¿‡æ€§èƒ½å›¾å±‚åˆ†æå¤§è‡´çš„æ¸²æŸ“é—®é¢˜èŒƒå›´ã€‚ä¸€æ—¦ç¡®è®¤é—®é¢˜å­˜åœ¨ï¼Œæ¥ä¸‹æ¥å°±éœ€è¦åˆ©ç”¨Flutteræ‰€æä¾›çš„åˆ†æå·¥å…·æ¥å®šä½é—®é¢˜åŸå› äº†ã€‚

å…³äºGPUçº¿ç¨‹æ¸²æŸ“é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é‡ç‚¹æ£€æŸ¥åº”ç”¨ä¸­æ˜¯å¦å­˜åœ¨å¤šè§†å›¾å åŠ æ¸²æŸ“ï¼Œæˆ–æ˜¯é™æ€å›¾åƒåå¤åˆ·æ–°çš„ç°è±¡ã€‚è€ŒUIçº¿ç¨‹æ¸²æŸ“é—®é¢˜ï¼Œæˆ‘ä»¬åˆ™æ˜¯é€šè¿‡Performanceå·¥å…·è®°å½•çš„ç«ç„°å›¾ï¼ˆCPUå¸§å›¾ï¼‰ï¼Œåˆ†æä»£ç è€—æ—¶ï¼Œæ‰¾å‡ºåº”ç”¨æ‰§è¡Œç“¶é¢ˆã€‚

é€šå¸¸æ¥è¯´ï¼Œç”±äºFlutteré‡‡ç”¨åŸºäºå£°æ˜å¼çš„UIè®¾è®¡ç†å¿µï¼Œä»¥æ•°æ®é©±åŠ¨æ¸²æŸ“ï¼Œå¹¶é‡‡ç”¨Widget-&gt;Element-&gt;RenderObjectä¸‰å±‚ç»“æ„ï¼Œå±è”½äº†æ— è°“çš„ç•Œé¢åˆ·æ–°ï¼Œèƒ½å¤Ÿä¿è¯ç»å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬æ„å»ºçš„åº”ç”¨éƒ½æ˜¯é«˜æ€§èƒ½çš„ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨åˆ†æå·¥å…·æ£€æµ‹å‡ºæ€§èƒ½é—®é¢˜ä¹‹åï¼Œé€šå¸¸æˆ‘ä»¬å¹¶ä¸éœ€è¦åšå¤ªå¤šçš„ç»†èŠ‚ä¼˜åŒ–å·¥ä½œï¼Œåªéœ€è¦åœ¨æ”¹é€ è¿‡ç¨‹ä¸­é¿å¼€ä¸€äº›å¸¸è§çš„å‘ï¼Œå°±å¯ä»¥è·å¾—ä¼˜å¼‚çš„æ€§èƒ½ã€‚æ¯”å¦‚ï¼š

- æ§åˆ¶buildæ–¹æ³•è€—æ—¶ï¼Œå°†Widgetæ‹†å°ï¼Œé¿å…ç›´æ¥è¿”å›ä¸€ä¸ªå·¨å¤§çš„Widgetï¼Œè¿™æ ·Widgetä¼šäº«æœ‰æ›´ç»†ç²’åº¦çš„é‡å»ºå’Œå¤ç”¨ï¼›
- å°½é‡ä¸è¦ä¸ºWidgetè®¾ç½®åŠé€æ˜æ•ˆæœï¼Œè€Œæ˜¯è€ƒè™‘ç”¨å›¾ç‰‡çš„å½¢å¼ä»£æ›¿ï¼Œè¿™æ ·è¢«é®æŒ¡çš„Widgetéƒ¨åˆ†åŒºåŸŸå°±ä¸éœ€è¦ç»˜åˆ¶äº†ï¼›
- å¯¹åˆ—è¡¨é‡‡ç”¨æ‡’åŠ è½½è€Œä¸æ˜¯ç›´æ¥ä¸€æ¬¡æ€§åˆ›å»ºæ‰€æœ‰çš„å­Widgetï¼Œè¿™æ ·è§†å›¾çš„åˆå§‹åŒ–æ—¶é—´å°±å‡å°‘äº†ã€‚

## æ€è€ƒé¢˜

æœ€åï¼Œæˆ‘ç»™ä½ ç•™ä¸‹ä¸€é“æ€è€ƒé¢˜å§ã€‚

è¯·ä½ æ”¹é€ ListViewè®¡ç®—MD5çš„ç¤ºä¾‹ï¼Œåœ¨ä¿è¯åŸæœ‰åŠŸèƒ½çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨å¹¶å‘Isolateï¼ˆæˆ–computeï¼‰å®ŒæˆMD5çš„è®¡ç®—ã€‚æç¤ºï¼šè®¡ç®—è¿‡ç¨‹å¯ä»¥ä½¿ç”¨CircularProgressIndicatoræ¥å±•ç¤ºåŠ è½½åŠ¨ç”»ã€‚

æ¬¢è¿ä½ åœ¨è¯„è®ºåŒºç»™æˆ‘ç•™è¨€åˆ†äº«ä½ çš„è§‚ç‚¹ï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ç­‰å¾…ä½ ï¼æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ3ï¼‰</strong></div><ul>
<li><span>èˆ’å¤§é£</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ4ï¼‰<p>î˜

æƒ³è¯·æ•™ä¸‹ï¼Œçœ‹äº†dartçš„å•çº¿ç¨‹æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œåƒfutureè¿™ç§æ‰§è¡Œç½‘ç»œè¯·æ±‚çš„è¯ï¼Œç›´æ¥æŠŠä»»åŠ¡æ”¾è¿›event queueåŒæ­¥æ‰§è¡Œï¼Œé‚£ä¹ˆthençš„ä»»åŠ¡å¦‚ä½•å¤„ç†ï¼Œç­‰ç½‘ç»œè¯·æ±‚è¿”å›å†æ”¾è¿›event queue?æ•´ä¸ªè¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Œè°¢è°¢

</p>2019-09-23</li><br/><li><span>ç«è…¿</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>dartæ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œä½†Isolateæ˜¯ç±»ä¼¼Unixçš„è¿›ç¨‹ï¼Œæ‰€ä»¥å¯ä»¥è¿™æ ·ç†è§£å§ï¼š dartæ˜¯å¤šè¿›ç¨‹(æ¯ä¸ªè¿›ç¨‹åªæœ‰å•çº¿ç¨‹ï¼‰çš„æ¨¡å‹ï¼Ÿ </p>2019-12-26</li><br/><li><span>è®¸ç«¥ç«¥</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ„Ÿè°¢è€å¸ˆåˆ†äº«ã€‚</p>2019-09-21</li><br/>
</ul>