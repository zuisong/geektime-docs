ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆèˆªã€‚

åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¸ä½ åˆ†äº«äº†å¦‚ä½•ä¸ºä¸€ä¸ªFlutterå·¥ç¨‹ç¼–å†™è‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹ã€‚è®¾è®¡ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹çš„åŸºæœ¬æ­¥éª¤å¯ä»¥åˆ†ä¸º3æ­¥ï¼Œå³å®šä¹‰ã€æ‰§è¡Œå’ŒéªŒè¯ï¼Œè€ŒFlutteræä¾›çš„å•å…ƒæµ‹è¯•å’ŒUIæµ‹è¯•æ¡†æ¶åˆ™å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç®€åŒ–è¿™äº›æ­¥éª¤ã€‚

å…¶ä¸­ï¼Œé€šè¿‡å•å…ƒæµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°éªŒè¯å•ä¸ªå‡½æ•°ã€æ–¹æ³•æˆ–ç±»çš„è¡Œä¸ºï¼Œè¿˜å¯ä»¥åˆ©ç”¨mockitoå®šåˆ¶å¤–éƒ¨ä¾èµ–è¿”å›ä»»æ„æ•°æ®ï¼Œä»è€Œè®©æµ‹è¯•æ›´å¯æ§ï¼›è€ŒUIæµ‹è¯•åˆ™æä¾›äº†ä¸Widgetäº¤äº’çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥æ¨¡ä»¿ç”¨æˆ·è¡Œä¸ºï¼Œå¯¹åº”ç”¨è¿›è¡Œç›¸åº”çš„äº¤äº’æ“ä½œï¼Œç¡®è®¤å…¶åŠŸèƒ½æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚

é€šè¿‡è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠé‡å¤çš„äººå·¥æ“ä½œå˜æˆè‡ªåŠ¨åŒ–çš„éªŒè¯æ­¥éª¤ï¼Œä»è€Œåœ¨å¼€å‘é˜¶æ®µæ›´åŠæ—¶åœ°å‘ç°é—®é¢˜ã€‚ä½†ç»ˆç«¯è®¾å¤‡çš„ç¢ç‰‡åŒ–ï¼Œä½¿å¾—æˆ‘ä»¬ç»ˆç©¶æ— æ³•åœ¨åº”ç”¨å¼€å‘æœŸå°±å®Œå…¨æ¨¡æ‹Ÿå‡ºçœŸå®ç”¨æˆ·çš„è¿è¡Œç¯å¢ƒã€‚æ‰€ä»¥ï¼Œæ— è®ºæˆ‘ä»¬çš„åº”ç”¨å†™å¾—å¤šä¹ˆå®Œç¾ã€æµ‹è¯•å¾—å¤šä¹ˆå…¨é¢ï¼Œæ€»æ˜¯æ— æ³•å®Œå…¨é¿å…çº¿ä¸Šçš„å¼‚å¸¸é—®é¢˜ã€‚

è¿™äº›å¼‚å¸¸ï¼Œå¯èƒ½æ˜¯å› ä¸ºä¸å……åˆ†çš„æœºå‹é€‚é…ã€ç”¨æˆ·ç³Ÿç³•çš„ç½‘ç»œçŠ¶å†µï¼›ä¹Ÿå¯èƒ½æ˜¯å› ä¸ºFlutteræ¡†æ¶è‡ªèº«çš„Bugï¼Œç”šè‡³æ˜¯æ“ä½œç³»ç»Ÿåº•å±‚çš„é—®é¢˜ã€‚è¿™äº›å¼‚å¸¸ä¸€æ—¦å‘ç”Ÿï¼ŒFlutteråº”ç”¨ä¼šæ— æ³•å“åº”ç”¨æˆ·çš„äº¤äº’äº‹ä»¶ï¼Œè½»åˆ™æŠ¥é”™ï¼Œé‡åˆ™åŠŸèƒ½æ— æ³•ä½¿ç”¨ç”šè‡³é—ªé€€ï¼Œè¿™å¯¹ç”¨æˆ·æ¥è¯´éƒ½ç›¸å½“ä¸å‹å¥½ï¼Œæ˜¯å¼€å‘è€…æœ€ä¸æ„¿æ„çœ‹åˆ°çš„ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦æƒ³åŠæ³•å»æ•è·ç”¨æˆ·çš„å¼‚å¸¸ä¿¡æ¯ï¼Œå°†å¼‚å¸¸ç°åœºä¿å­˜èµ·æ¥ï¼Œå¹¶ä¸Šä¼ è‡³æœåŠ¡å™¨ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åˆ†æå¼‚å¸¸ä¸Šä¸‹æ–‡ï¼Œå®šä½å¼•èµ·å¼‚å¸¸çš„åŸå› ï¼Œå»è§£å†³æ­¤ç±»é—®é¢˜äº†ã€‚é‚£ä¹ˆä»Šå¤©ï¼Œæˆ‘ä»¬å°±ä¸€èµ·æ¥å­¦ä¹ ä¸‹Flutterå¼‚å¸¸çš„æ•è·å’Œä¿¡æ¯é‡‡é›†ï¼Œä»¥åŠå¯¹åº”çš„æ•°æ®ä¸ŠæŠ¥å¤„ç†ã€‚

## Flutterå¼‚å¸¸

Flutterå¼‚å¸¸æŒ‡çš„æ˜¯ï¼ŒFlutterç¨‹åºä¸­Dartä»£ç è¿è¡Œæ—¶æ„å¤–å‘ç”Ÿçš„é”™è¯¯äº‹ä»¶ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸Javaç±»ä¼¼çš„try-catchæœºåˆ¶æ¥æ•è·å®ƒã€‚ä½†**ä¸Javaä¸åŒçš„æ˜¯ï¼ŒDartç¨‹åºä¸å¼ºåˆ¶è¦æ±‚æˆ‘ä»¬å¿…é¡»å¤„ç†å¼‚å¸¸**ã€‚

è¿™æ˜¯å› ä¸ºï¼ŒDarté‡‡ç”¨äº‹ä»¶å¾ªç¯çš„æœºåˆ¶æ¥è¿è¡Œä»»åŠ¡ï¼Œæ‰€ä»¥å„ä¸ªä»»åŠ¡çš„è¿è¡ŒçŠ¶æ€æ˜¯äº’ç›¸ç‹¬ç«‹çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä¾¿æŸä¸ªä»»åŠ¡å‡ºç°äº†å¼‚å¸¸æˆ‘ä»¬æ²¡æœ‰æ•è·å®ƒï¼ŒDartç¨‹åºä¹Ÿä¸ä¼šé€€å‡ºï¼Œåªä¼šå¯¼è‡´å½“å‰ä»»åŠ¡åç»­çš„ä»£ç ä¸ä¼šè¢«æ‰§è¡Œï¼Œç”¨æˆ·ä»å¯ä»¥ç»§ç»­ä½¿ç”¨å…¶ä»–åŠŸèƒ½ã€‚

Dartå¼‚å¸¸ï¼Œæ ¹æ®æ¥æºåˆå¯ä»¥ç»†åˆ†ä¸ºAppå¼‚å¸¸å’ŒFrameworkå¼‚å¸¸ã€‚Flutterä¸ºè¿™ä¸¤ç§å¼‚å¸¸æä¾›äº†ä¸åŒçš„æ•è·æ–¹å¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¸€èµ·çœ‹çœ‹å§ã€‚

## Appå¼‚å¸¸çš„æ•è·æ–¹å¼

Appå¼‚å¸¸ï¼Œå°±æ˜¯åº”ç”¨ä»£ç çš„å¼‚å¸¸ï¼Œé€šå¸¸ç”±æœªå¤„ç†åº”ç”¨å±‚å…¶ä»–æ¨¡å—æ‰€æŠ›å‡ºçš„å¼‚å¸¸å¼•èµ·ã€‚æ ¹æ®å¼‚å¸¸ä»£ç çš„æ‰§è¡Œæ—¶åºï¼ŒAppå¼‚å¸¸å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼Œå³åŒæ­¥å¼‚å¸¸å’Œå¼‚æ­¥å¼‚å¸¸ï¼šåŒæ­¥å¼‚å¸¸å¯ä»¥é€šè¿‡try-catchæœºåˆ¶æ•è·ï¼Œå¼‚æ­¥å¼‚å¸¸åˆ™éœ€è¦é‡‡ç”¨Futureæä¾›çš„catchErrorè¯­å¥æ•è·ã€‚

è¿™ä¸¤ç§å¼‚å¸¸çš„æ•è·æ–¹å¼ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```
//ä½¿ç”¨try-catchæ•è·åŒæ­¥å¼‚å¸¸
try {
  throw StateError('This is a Dart exception.');
}
catch(e) {
  print(e);
}

//ä½¿ç”¨catchErroræ•è·å¼‚æ­¥å¼‚å¸¸
Future.delayed(Duration(seconds: 1))
    .then((e) => throw StateError('This is a Dart exception in Future.'))
    .catchError((e)=>print(e));
    
//æ³¨æ„ï¼Œä»¥ä¸‹ä»£ç æ— æ³•æ•è·å¼‚æ­¥å¼‚å¸¸
try {
  Future.delayed(Duration(seconds: 1))
      .then((e) => throw StateError('This is a Dart exception in Future.'))
}
catch(e) {
  print("This line will never be executed. ");
}
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸¤ç§æ–¹å¼æ˜¯ä¸èƒ½æ··ç”¨çš„ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ˜¯æ— æ³•ä½¿ç”¨try-catchå»æ•è·ä¸€ä¸ªå¼‚æ­¥è°ƒç”¨æ‰€æŠ›å‡ºçš„å¼‚å¸¸çš„ã€‚

åŒæ­¥çš„try-catchå’Œå¼‚æ­¥çš„catchErrorï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ç›´æ¥æ•è·ç‰¹å®šå¼‚å¸¸çš„èƒ½åŠ›ï¼Œè€Œå¦‚æœæˆ‘ä»¬æƒ³é›†ä¸­ç®¡ç†ä»£ç ä¸­çš„æ‰€æœ‰å¼‚å¸¸ï¼ŒFlutterä¹Ÿæä¾›äº†Zone.runZonedæ–¹æ³•ã€‚

æˆ‘ä»¬å¯ä»¥ç»™ä»£ç æ‰§è¡Œå¯¹è±¡æŒ‡å®šä¸€ä¸ªZoneï¼Œåœ¨Dartä¸­ï¼ŒZoneè¡¨ç¤ºä¸€ä¸ªä»£ç æ‰§è¡Œçš„ç¯å¢ƒèŒƒå›´ï¼Œå…¶æ¦‚å¿µç±»ä¼¼æ²™ç›’ï¼Œä¸åŒæ²™ç›’ä¹‹é—´æ˜¯äº’ç›¸éš”ç¦»çš„ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦è§‚å¯Ÿæ²™ç›’ä¸­ä»£ç æ‰§è¡Œå‡ºç°çš„å¼‚å¸¸ï¼Œæ²™ç›’æä¾›äº†onErrorå›è°ƒå‡½æ•°ï¼Œæ‹¦æˆªé‚£äº›åœ¨ä»£ç æ‰§è¡Œå¯¹è±¡ä¸­çš„æœªæ•è·å¼‚å¸¸ã€‚

åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„è¯­å¥æ”¾ç½®åœ¨äº†Zoneé‡Œã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ²¡æœ‰ä½¿ç”¨try-catchå’ŒcatchErrorçš„æƒ…å†µä¸‹ï¼Œæ— è®ºæ˜¯åŒæ­¥å¼‚å¸¸è¿˜æ˜¯å¼‚æ­¥å¼‚å¸¸ï¼Œéƒ½å¯ä»¥é€šè¿‡Zoneç›´æ¥æ•è·åˆ°ï¼š

```
runZoned(() {
  //åŒæ­¥æŠ›å‡ºå¼‚å¸¸
  throw StateError('This is a Dart exception.');
}, onError: (dynamic e, StackTrace stack) {
  print('Sync error caught by zone');
});

runZoned(() {
  //å¼‚æ­¥æŠ›å‡ºå¼‚å¸¸
  Future.delayed(Duration(seconds: 1))
      .then((e) => throw StateError('This is a Dart exception in Future.'));
}, onError: (dynamic e, StackTrace stack) {
  print('Async error aught by zone');
});
```

å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦é›†ä¸­æ•è·Flutteråº”ç”¨ä¸­çš„æœªå¤„ç†å¼‚å¸¸ï¼Œå¯ä»¥æŠŠmainå‡½æ•°ä¸­çš„runAppè¯­å¥ä¹Ÿæ”¾ç½®åœ¨Zoneä¸­ã€‚è¿™æ ·åœ¨æ£€æµ‹åˆ°ä»£ç ä¸­è¿è¡Œå¼‚å¸¸æ—¶ï¼Œæˆ‘ä»¬å°±èƒ½æ ¹æ®è·å–åˆ°çš„å¼‚å¸¸ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè¿›è¡Œç»Ÿä¸€å¤„ç†äº†ï¼š

```
runZoned<Future<Null>>(() async {
  runApp(MyApp());
}, onError: (error, stackTrace) async {
 //Do sth for error
});
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†çœ‹çœ‹Frameworkå¼‚å¸¸åº”è¯¥å¦‚ä½•æ•è·å§ã€‚

## Frameworkå¼‚å¸¸çš„æ•è·æ–¹å¼

Frameworkå¼‚å¸¸ï¼Œå°±æ˜¯Flutteræ¡†æ¶å¼•å‘çš„å¼‚å¸¸ï¼Œé€šå¸¸æ˜¯ç”±åº”ç”¨ä»£ç è§¦å‘äº†Flutteræ¡†æ¶åº•å±‚çš„å¼‚å¸¸åˆ¤æ–­å¼•èµ·çš„ã€‚æ¯”å¦‚ï¼Œå½“å¸ƒå±€ä¸åˆè§„èŒƒæ—¶ï¼ŒFlutterå°±ä¼šè‡ªåŠ¨å¼¹å‡ºä¸€ä¸ªè§¦ç›®æƒŠå¿ƒçš„çº¢è‰²é”™è¯¯ç•Œé¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://static001.geekbang.org/resource/image/e1/04/e1169d19bd616705e035464020df5604.png?wh=1125%2A2436)

å›¾1 Flutterå¸ƒå±€é”™è¯¯æç¤º

è¿™å…¶å®æ˜¯å› ä¸ºï¼ŒFlutteræ¡†æ¶åœ¨è°ƒç”¨buildæ–¹æ³•æ„å»ºé¡µé¢æ—¶è¿›è¡Œäº†try-catch çš„å¤„ç†ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªErrorWidgetï¼Œç”¨äºåœ¨å‡ºç°å¼‚å¸¸æ—¶è¿›è¡Œä¿¡æ¯æç¤ºï¼š

```
@override
void performRebuild() {
  Widget built;
  try {
    //åˆ›å»ºé¡µé¢
    built = build();
  } catch (e, stack) {
    //ä½¿ç”¨ErrorWidgetåˆ›å»ºé¡µé¢
    built = ErrorWidget.builder(_debugReportException(ErrorDescription("building $this"), e, stack));
    ...
  } 
  ...
}
```

è¿™ä¸ªé¡µé¢åé¦ˆçš„ä¿¡æ¯æ¯”è¾ƒä¸°å¯Œï¼Œé€‚åˆå¼€å‘æœŸå®šä½é—®é¢˜ã€‚ä½†å¦‚æœè®©ç”¨æˆ·çœ‹åˆ°è¿™æ ·ä¸€ä¸ªé¡µé¢ï¼Œå°±å¾ˆç³Ÿç³•äº†ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šé‡å†™ErrorWidget.builderæ–¹æ³•ï¼Œå°†è¿™æ ·çš„é”™è¯¯æç¤ºé¡µé¢æ›¿æ¢æˆä¸€ä¸ªæ›´åŠ å‹å¥½çš„é¡µé¢ã€‚

ä¸‹é¢çš„ä»£ç æ¼”ç¤ºäº†è‡ªå®šä¹‰é”™è¯¯é¡µé¢çš„å…·ä½“æ–¹æ³•ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥è¿”å›äº†ä¸€ä¸ªå±…ä¸­çš„Textæ§ä»¶ï¼š

```
ErrorWidget.builder = (FlutterErrorDetails flutterErrorDetails){
  return Scaffold(
    body: Center(
      child: Text("Custom Error Widget"),
    )
  );
};
```

è¿è¡Œæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://static001.geekbang.org/resource/image/03/a8/032d9bda533fa00a4b8cb86ffd2310a8.png?wh=1125%2A2436)

å›¾2 è‡ªå®šä¹‰é”™è¯¯æç¤ºé¡µé¢

æ¯”èµ·ä¹‹å‰è§¦ç›®æƒŠå¿ƒçš„çº¢è‰²é”™è¯¯é¡µé¢ï¼Œç™½è‰²ä¸»é¢˜çš„è‡ªå®šä¹‰é¡µé¢çœ‹èµ·æ¥ç¨å¾®å‹å¥½äº›äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒErrorWidget.builderæ–¹æ³•æä¾›äº†ä¸€ä¸ªå‚æ•°detailsç”¨äºè¡¨ç¤ºå½“å‰çš„é”™è¯¯ä¸Šä¸‹æ–‡ï¼Œä¸ºé¿å…ç”¨æˆ·ç›´æ¥çœ‹åˆ°é”™è¯¯ä¿¡æ¯ï¼Œè¿™é‡Œæˆ‘ä»¬å¹¶æ²¡æœ‰å°†å®ƒå±•ç¤ºåˆ°ç•Œé¢ä¸Šã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸èƒ½ä¸¢å¼ƒæ‰è¿™æ ·çš„å¼‚å¸¸ä¿¡æ¯ï¼Œéœ€è¦æä¾›ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œç”¨äºåç»­åˆ†æå¼‚å¸¸åŸå› ã€‚

ä¸ºäº†é›†ä¸­å¤„ç†æ¡†æ¶å¼‚å¸¸ï¼Œ**Flutteræä¾›äº†FlutterErrorç±»ï¼Œè¿™ä¸ªç±»çš„onErrorå±æ€§ä¼šåœ¨æ¥æ”¶åˆ°æ¡†æ¶å¼‚å¸¸æ—¶æ‰§è¡Œç›¸åº”çš„å›è°ƒ**ã€‚å› æ­¤ï¼Œè¦å®ç°è‡ªå®šä¹‰æ•è·é€»è¾‘ï¼Œæˆ‘ä»¬åªè¦ä¸ºå®ƒæä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„é”™è¯¯å¤„ç†å›è°ƒå³å¯ã€‚

åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Zoneæä¾›çš„handleUncaughtErrorè¯­å¥ï¼Œå°†Flutteræ¡†æ¶çš„å¼‚å¸¸ç»Ÿä¸€è½¬å‘åˆ°å½“å‰çš„Zoneä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç»Ÿä¸€ä½¿ç”¨Zoneå»å¤„ç†åº”ç”¨å†…çš„æ‰€æœ‰å¼‚å¸¸äº†ï¼š

```
FlutterError.onError = (FlutterErrorDetails details) async {
  //è½¬å‘è‡³Zoneä¸­
  Zone.current.handleUncaughtError(details.exception, details.stack);
};

runZoned<Future<Null>>(() async {
  runApp(MyApp());
}, onError: (error, stackTrace) async {
 //Do sth for error
});
```

## å¼‚å¸¸ä¸ŠæŠ¥

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»æ•è·åˆ°äº†åº”ç”¨ä¸­æ‰€æœ‰çš„æœªå¤„ç†å¼‚å¸¸ã€‚ä½†å¦‚æœåªæ˜¯æŠŠè¿™äº›å¼‚å¸¸åœ¨æ§åˆ¶å°ä¸­æ‰“å°å‡ºæ¥è¿˜æ˜¯æ²¡åŠæ³•è§£å†³é—®é¢˜ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠå®ƒä»¬ä¸ŠæŠ¥åˆ°å¼€å‘è€…èƒ½çœ‹åˆ°çš„åœ°æ–¹ï¼Œç”¨äºåç»­åˆ†æå®šä½å¹¶è§£å†³é—®é¢˜ã€‚

å…³äºå¼€å‘è€…æ•°æ®ä¸ŠæŠ¥ï¼Œç›®å‰å¸‚é¢ä¸Šæœ‰å¾ˆå¤šä¼˜ç§€çš„ç¬¬ä¸‰æ–¹SDKæœåŠ¡å‚å•†ï¼Œæ¯”å¦‚å‹ç›Ÿã€Buglyï¼Œä»¥åŠå¼€æºçš„Sentryç­‰ï¼Œè€Œå®ƒä»¬æä¾›çš„åŠŸèƒ½å’Œæ¥å…¥æµç¨‹éƒ½æ˜¯ç±»ä¼¼çš„ã€‚è€ƒè™‘åˆ°Buglyçš„ç¤¾åŒºæ´»è·ƒåº¦æ¯”è¾ƒé«˜ï¼Œå› æ­¤æˆ‘å°±ä»¥å®ƒä¸ºä¾‹ï¼Œä¸ä½ æ¼”ç¤ºåœ¨æŠ“å–åˆ°å¼‚å¸¸åï¼Œå¦‚ä½•å®ç°è‡ªå®šä¹‰æ•°æ®ä¸ŠæŠ¥ã€‚

### Dartæ¥å£å®ç°

ç›®å‰Buglyä»…æä¾›äº†åŸç”ŸAndroid/iOSçš„SDKï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é‡‡ç”¨ä¸ç¬¬31ç¯‡æ–‡ç« â€œ[å¦‚ä½•å®ç°åŸç”Ÿæ¨é€èƒ½åŠ›](https://time.geekbang.org/column/article/132818)ï¼Ÿâ€ä¸­åŒæ ·çš„æ’ä»¶å·¥ç¨‹ï¼Œä¸ºBuglyçš„æ•°æ®ä¸ŠæŠ¥æä¾›Dartå±‚æ¥å£ã€‚

ä¸æ¥å…¥Pushèƒ½åŠ›ç›¸æ¯”ï¼Œæ¥å…¥æ•°æ®ä¸ŠæŠ¥è¦ç®€å•å¾—å¤šï¼Œæˆ‘ä»¬åªéœ€è¦å®Œæˆä¸€äº›å‰ç½®åº”ç”¨ä¿¡æ¯å…³è”ç»‘å®šå’ŒSDKåˆå§‹åŒ–å·¥ä½œï¼Œå°±å¯ä»¥ä½¿ç”¨Dartå±‚å°è£…å¥½çš„æ•°æ®ä¸ŠæŠ¥æ¥å£å»ä¸ŠæŠ¥å¼‚å¸¸äº†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºä¸€ä¸ªåº”ç”¨è€Œè¨€ï¼Œæ¥å…¥æ•°æ®ä¸ŠæŠ¥æœåŠ¡çš„è¿‡ç¨‹ï¼Œæ€»ä½“ä¸Šå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š

1. åˆå§‹åŒ–Bugly SDKï¼›
2. ä½¿ç”¨æ•°æ®ä¸ŠæŠ¥æ¥å£ã€‚

è¿™ä¸¤æ­¥å¯¹åº”ç€åœ¨Dartå±‚éœ€è¦å°è£…çš„2ä¸ªåŸç”Ÿæ¥å£è°ƒç”¨ï¼Œå³setupå’ŒpostExceptionï¼Œå®ƒä»¬éƒ½æ˜¯åœ¨æ–¹æ³•é€šé“ä¸Šè°ƒç”¨åŸç”Ÿä»£ç å®¿ä¸»æä¾›çš„æ–¹æ³•ã€‚è€ƒè™‘åˆ°æ•°æ®ä¸ŠæŠ¥æ˜¯æ•´ä¸ªåº”ç”¨å…±äº«çš„èƒ½åŠ›ï¼Œå› æ­¤æˆ‘ä»¬å°†æ•°æ®ä¸ŠæŠ¥ç±»FlutterCrashPluginçš„æ¥å£éƒ½å°è£…æˆäº†å•ä¾‹ï¼š

```
class FlutterCrashPlugin {
  //åˆå§‹åŒ–æ–¹æ³•é€šé“
  static const MethodChannel _channel =
      const MethodChannel('flutter_crash_plugin');

  static void setUp(appID) {
    //ä½¿ç”¨app_idè¿›è¡ŒSDKæ³¨å†Œ
    _channel.invokeMethod("setUp",{'app_id':appID});
  }
  static void postException(error, stack) {
    //å°†å¼‚å¸¸å’Œå †æ ˆä¸ŠæŠ¥è‡³Bugly
    _channel.invokeMethod("postException",{'crash_message':error.toString(),'crash_detail':stack.toString()});
  }
}
```

Dartå±‚æ˜¯åŸç”Ÿä»£ç å®¿ä¸»çš„ä»£ç†ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸€å±‚çš„æ¥å£è®¾è®¡è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†åˆ«å»æ¥ç®¡æ•°æ®ä¸ŠæŠ¥çš„Androidå’ŒiOSå¹³å°ä¸Šå®Œæˆç›¸åº”çš„å®ç°ã€‚

### iOSæ¥å£å®ç°

è€ƒè™‘åˆ°iOSå¹³å°çš„æ•°æ®ä¸ŠæŠ¥é…ç½®å·¥ä½œç›¸å¯¹è¾ƒå°‘ï¼Œå› æ­¤æˆ‘ä»¬å…ˆç”¨Xcodeæ‰“å¼€exampleä¸‹çš„iOSå·¥ç¨‹è¿›è¡Œæ’ä»¶å¼€å‘å·¥ä½œã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºiOSå­å·¥ç¨‹çš„è¿è¡Œä¾èµ–äºFlutterå·¥ç¨‹ç¼–è¯‘æ„å»ºäº§ç‰©ï¼Œæ‰€ä»¥åœ¨æ‰“å¼€iOSå·¥ç¨‹è¿›è¡Œå¼€å‘å‰ï¼Œä½ éœ€è¦ç¡®ä¿æ•´ä¸ªå·¥ç¨‹ä»£ç è‡³å°‘buildè¿‡ä¸€æ¬¡ï¼Œå¦åˆ™IDEä¼šæŠ¥é”™ã€‚

> å¤‡æ³¨ï¼šä»¥ä¸‹æ“ä½œæ­¥éª¤å‚è€ƒ[Buglyå¼‚å¸¸ä¸ŠæŠ¥iOS SDKæ¥å…¥æŒ‡å—](https://bugly.qq.com/docs/user-guide/instruction-manual-ios/?v=20190712210424)ã€‚

**é¦–å…ˆ**ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ’ä»¶å·¥ç¨‹ä¸‹çš„flutter\_crash\_plugin.podspecæ–‡ä»¶ä¸­å¼•å…¥Bugly SDKï¼Œå³Buglyï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨åŸç”Ÿå·¥ç¨‹ä¸­ä½¿ç”¨Buglyæä¾›çš„æ•°æ®ä¸ŠæŠ¥åŠŸèƒ½äº†ï¼š

```
Pod::Spec.new do |s|
  ...
  s.dependency 'Bugly'
end
```

**ç„¶å**ï¼Œåœ¨åŸç”Ÿæ¥å£FlutterCrashPluginç±»ä¸­ï¼Œä¾æ¬¡åˆå§‹åŒ–æ’ä»¶å®ä¾‹ã€ç»‘å®šæ–¹æ³•é€šé“ï¼Œå¹¶åœ¨æ–¹æ³•é€šé“ä¸­å…ˆåä¸ºsetupä¸postExceptionæä¾›Bugly iOS SDKçš„å®ç°ç‰ˆæœ¬ï¼š

```
@implementation FlutterCrashPlugin
+ (void)registerWithRegistrar:(NSObject<FlutterPluginRegistrar>*)registrar {
    //æ³¨å†Œæ–¹æ³•é€šé“
    FlutterMethodChannel* channel = [FlutterMethodChannel
      methodChannelWithName:@"flutter_crash_plugin"
            binaryMessenger:[registrar messenger]];
    //åˆå§‹åŒ–æ’ä»¶å®ä¾‹ï¼Œç»‘å®šæ–¹æ³•é€šé“ 
    FlutterCrashPlugin* instance = [[FlutterCrashPlugin alloc] init];
    //æ³¨å†Œæ–¹æ³•é€šé“å›è°ƒå‡½æ•°
    [registrar addMethodCallDelegate:instance channel:channel];
}

- (void)handleMethodCall:(FlutterMethodCall*)call result:(FlutterResult)result {
    if([@"setUp" isEqualToString:call.method]) {
        //Bugly SDKåˆå§‹åŒ–æ–¹æ³•
        NSString *appID = call.arguments[@"app_id"];
        [Bugly startWithAppId:appID];
    } else if ([@"postException" isEqualToString:call.method]) {
      //è·å–Buglyæ•°æ®ä¸ŠæŠ¥æ‰€éœ€è¦çš„å„ä¸ªå‚æ•°ä¿¡æ¯
      NSString *message = call.arguments[@"crash_message"];
      NSString *detail = call.arguments[@"crash_detail"];

      NSArray *stack = [detail componentsSeparatedByString:@"\n"];
      //è°ƒç”¨Buglyæ•°æ®ä¸ŠæŠ¥æ¥å£
      [Bugly reportExceptionWithCategory:4 name:message reason:stack[0] callStack:stack extraInfo:@{} terminateApp:NO];
      result(@0);
  }
  else {
    //æ–¹æ³•æœªå®ç°
    result(FlutterMethodNotImplemented);
  }
}

@end
```

è‡³æ­¤ï¼Œåœ¨å®Œæˆäº†Bugly iOS SDKçš„æ¥å£å°è£…ä¹‹åï¼ŒFlutterCrashPluginæ’ä»¶çš„iOSéƒ¨åˆ†ä¹Ÿå°±æå®šäº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å»çœ‹çœ‹Androidéƒ¨åˆ†å¦‚ä½•å®ç°å§ã€‚

### Androidæ¥å£å®ç°

ä¸iOSç±»ä¼¼ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨Android Studioæ‰“å¼€exampleä¸‹çš„androidå·¥ç¨‹è¿›è¡Œæ’ä»¶å¼€å‘å·¥ä½œã€‚åŒæ ·ï¼Œåœ¨æ‰“å¼€androidå·¥ç¨‹å‰ï¼Œä½ éœ€è¦ç¡®ä¿æ•´ä¸ªå·¥ç¨‹ä»£ç è‡³å°‘buildè¿‡ä¸€æ¬¡ï¼Œå¦åˆ™IDEä¼šæŠ¥é”™ã€‚

> å¤‡æ³¨ï¼šä»¥ä¸‹æ“ä½œæ­¥éª¤å‚è€ƒ[Buglyå¼‚å¸¸ä¸ŠæŠ¥Android SDKæ¥å…¥æŒ‡å—](https://bugly.qq.com/docs/user-guide/instruction-manual-android/)

**é¦–å…ˆ**ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ’ä»¶å·¥ç¨‹ä¸‹çš„build.gradleæ–‡ä»¶å¼•å…¥Bugly SDKï¼Œå³crashreportä¸nativecrashreportï¼Œå…¶ä¸­å‰è€…æä¾›äº†Javaå’Œè‡ªå®šä¹‰å¼‚å¸¸çš„çš„æ•°æ®ä¸ŠæŠ¥èƒ½åŠ›ï¼Œè€Œåè€…åˆ™æ˜¯JNIçš„å¼‚å¸¸ä¸ŠæŠ¥å°è£… ï¼š

```
dependencies {
    implementation 'com.tencent.bugly:crashreport:latest.release' 
    implementation 'com.tencent.bugly:nativecrashreport:latest.release' 
}
```

**ç„¶å**ï¼Œåœ¨åŸç”Ÿæ¥å£FlutterCrashPluginç±»ä¸­ï¼Œä¾æ¬¡åˆå§‹åŒ–æ’ä»¶å®ä¾‹ã€ç»‘å®šæ–¹æ³•é€šé“ï¼Œå¹¶åœ¨æ–¹æ³•é€šé“ä¸­å…ˆåä¸ºsetupä¸postExceptionæä¾›Bugly Android SDKçš„å®ç°ç‰ˆæœ¬ï¼š

```
public class FlutterCrashPlugin implements MethodCallHandler {
  //æ³¨å†Œå™¨ï¼Œé€šå¸¸ä¸ºMainActivity
  public final Registrar registrar;
  //æ³¨å†Œæ’ä»¶
  public static void registerWith(Registrar registrar) {
    //æ³¨å†Œæ–¹æ³•é€šé“
    final MethodChannel channel = new MethodChannel(registrar.messenger(), "flutter_crash_plugin");
    //åˆå§‹åŒ–æ’ä»¶å®ä¾‹ï¼Œç»‘å®šæ–¹æ³•é€šé“ï¼Œå¹¶æ³¨å†Œæ–¹æ³•é€šé“å›è°ƒå‡½æ•° 
    channel.setMethodCallHandler(new FlutterCrashPlugin(registrar));
  }

  private FlutterCrashPlugin(Registrar registrar) {
    this.registrar = registrar;
  }

  @Override
  public void onMethodCall(MethodCall call, Result result) {
    if(call.method.equals("setUp")) {
      //Bugly SDKåˆå§‹åŒ–æ–¹æ³•
      String appID = call.argument("app_id");

      CrashReport.initCrashReport(registrar.activity().getApplicationContext(), appID, true);
      result.success(0);
    }
    else if(call.method.equals("postException")) {
      //è·å–Buglyæ•°æ®ä¸ŠæŠ¥æ‰€éœ€è¦çš„å„ä¸ªå‚æ•°ä¿¡æ¯
      String message = call.argument("crash_message");
      String detail = call.argument("crash_detail");
      //è°ƒç”¨Buglyæ•°æ®ä¸ŠæŠ¥æ¥å£
      CrashReport.postException(4,"Flutter Exception",message,detail,null);
      result.success(0);
    }
    else {
      result.notImplemented();
    }
  }
}
```

åœ¨å®Œæˆäº†Bugly Androidæ¥å£çš„å°è£…ä¹‹åï¼Œç”±äºAndroidç³»ç»Ÿçš„æƒé™è®¾ç½®è¾ƒç»†ï¼Œè€ƒè™‘åˆ°Buglyè¿˜éœ€è¦ç½‘ç»œã€æ—¥å¿—è¯»å–ç­‰æƒé™ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦åœ¨æ’ä»¶å·¥ç¨‹çš„AndroidManifest.xmlæ–‡ä»¶ä¸­ï¼Œå°†è¿™äº›æƒé™ä¿¡æ¯æ˜¾ç¤ºåœ°å£°æ˜å‡ºæ¥ï¼Œå®Œæˆå¯¹ç³»ç»Ÿçš„æ³¨å†Œï¼š

```
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
  package="com.hangchen.flutter_crash_plugin">
    <!-- ç”µè¯çŠ¶æ€è¯»å–æƒé™ --> 
    <uses-permission android:name="android.permission.READ_PHONE_STATE" />
    <!-- ç½‘ç»œæƒé™ --> 
    <uses-permission android:name="android.permission.INTERNET" />
    <!-- è®¿é—®ç½‘ç»œçŠ¶æ€æƒé™ --> 
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <!-- è®¿é—®wifiçŠ¶æ€æƒé™ --> 
    <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
    <!-- æ—¥å¿—è¯»å–æƒé™ --> 
    <uses-permission android:name="android.permission.READ_LOGS" />
</manifest>
```

è‡³æ­¤ï¼Œåœ¨å®Œæˆäº†æå…‰Android SDKçš„æ¥å£å°è£…å’Œæƒé™é…ç½®ä¹‹åï¼ŒFlutterCrashPluginæ’ä»¶çš„Androidéƒ¨åˆ†ä¹Ÿæå®šäº†ã€‚

FlutterCrashPluginæ’ä»¶ä¸ºFlutteråº”ç”¨æä¾›äº†æ•°æ®ä¸ŠæŠ¥çš„å°è£…ï¼Œä¸è¿‡è¦æƒ³Flutterå·¥ç¨‹èƒ½å¤ŸçœŸæ­£åœ°ä¸ŠæŠ¥å¼‚å¸¸æ¶ˆæ¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸ºFlutterå·¥ç¨‹å…³è”Buglyçš„åº”ç”¨é…ç½®ã€‚

### åº”ç”¨å·¥ç¨‹é…ç½®

åœ¨å•ç‹¬ä¸ºAndroid/iOSåº”ç”¨è¿›è¡Œæ•°æ®ä¸ŠæŠ¥é…ç½®ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å»[Buglyçš„å®˜æ–¹ç½‘ç«™](https://bugly.qq.com)ï¼Œä¸ºåº”ç”¨æ³¨å†Œå”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆå³AppKeyï¼‰ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨Buglyä¸­ï¼ŒAndroidåº”ç”¨ä¸iOSåº”ç”¨è¢«è§†ä¸ºä¸åŒçš„äº§å“ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ†åˆ«æ³¨å†Œï¼š

![](https://static001.geekbang.org/resource/image/63/f3/63ca78fb4d188345c1659c9b8fb523f3.png?wh=956%2A842)

å›¾3 Androidåº”ç”¨Demoé…ç½®

![](https://static001.geekbang.org/resource/image/47/cb/4764fd46d9087c949b9d7270fd0043cb.png?wh=918%2A864)

å›¾4 iOSåº”ç”¨Demoé…ç½®

åœ¨å¾—åˆ°äº†AppKeyä¹‹åï¼Œæˆ‘ä»¬éœ€è¦**ä¾æ¬¡è¿›è¡ŒAndroidä¸iOSçš„é…ç½®å·¥ä½œ**ã€‚

iOSçš„é…ç½®å·¥ä½œç›¸å¯¹ç®€å•ï¼Œæ•´ä¸ªé…ç½®è¿‡ç¨‹å®Œå…¨æ˜¯åº”ç”¨ä¸Bugly SDKçš„å…³è”å·¥ä½œï¼Œè€Œè¿™äº›å…³è”å·¥ä½œä»…éœ€è¦é€šè¿‡Dartå±‚è°ƒç”¨setUpæ¥å£ï¼Œè®¿é—®åŸç”Ÿä»£ç å®¿ä¸»æ‰€å°è£…çš„Bugly APIå°±å¯ä»¥å®Œæˆï¼Œå› æ­¤æ— éœ€é¢å¤–æ“ä½œã€‚

è€ŒAndroidçš„é…ç½®å·¥ä½œåˆ™ç›¸å¯¹ç¹çäº›ã€‚ç”±äºæ¶‰åŠNDKå’ŒAndroid Pç½‘ç»œå®‰å…¨çš„é€‚é…ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ†åˆ«åœ¨build.gradleå’ŒAndroidManifest.xmlæ–‡ä»¶è¿›è¡Œç›¸åº”çš„é…ç½®å·¥ä½œã€‚

**é¦–å…ˆ**ï¼Œç”±äºBugly SDKéœ€è¦æ”¯æŒNDKï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨Appçš„build.gradleæ–‡ä»¶ä¸­ä¸ºå…¶å¢åŠ NDKçš„æ¶æ„æ”¯æŒï¼š

```
defaultConfig {
    ndk {
        // è®¾ç½®æ”¯æŒçš„SOåº“æ¶æ„
        abiFilters 'armeabi' , 'x86', 'armeabi-v7a', 'x86_64', 'arm64-v8a'
    }
}
```

**ç„¶å**ï¼Œç”±äºAndroid Pé»˜è®¤é™åˆ¶httpæ˜æ–‡ä¼ è¾“æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸ºBuglyå£°æ˜ä¸€é¡¹ç½‘ç»œå®‰å…¨é…ç½®network\_security\_config.xmlï¼Œå…è®¸å…¶ä½¿ç”¨httpä¼ è¾“æ•°æ®ï¼Œå¹¶åœ¨AndroidManifest.xmlä¸­æ–°å¢åŒåç½‘ç»œå®‰å…¨é…ç½®ï¼š

```
//res/xml/network_security_config.xml
<?xml version="1.0" encoding="utf-8"?>
<!-- ç½‘ç»œå®‰å…¨é…ç½® --> 
<network-security-config>
    <!-- å…è®¸æ˜æ–‡ä¼ è¾“æ•°æ® -->  
    <domain-config cleartextTrafficPermitted="true">
        <!-- å°†Buglyçš„åŸŸååŠ å…¥ç™½åå• --> 
        <domain includeSubdomains="true">android.bugly.qq.com</domain>
    </domain-config>
</network-security-config>

//AndroidManifest/xml
<application
  ...
  android:networkSecurityConfig="@xml/network_security_config"
  ...>
</application>
```

è‡³æ­¤ï¼ŒFlutterå·¥ç¨‹æ‰€éœ€çš„åŸç”Ÿé…ç½®å·¥ä½œå’Œæ¥å£å®ç°ï¼Œå°±å…¨éƒ¨æå®šäº†ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨Flutterå·¥ç¨‹ä¸­çš„main.dartæ–‡ä»¶ä¸­ï¼Œ**ä½¿ç”¨FlutterCrashPluginæ’ä»¶æ¥å®ç°å¼‚å¸¸æ•°æ®ä¸ŠæŠ¥èƒ½åŠ›äº†**ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬**é¦–å…ˆ**è¿˜éœ€è¦åœ¨pubspec.yamlæ–‡ä»¶ä¸­ï¼Œå°†å·¥ç¨‹å¯¹å®ƒçš„ä¾èµ–æ˜¾ç¤ºåœ°å£°æ˜å‡ºæ¥ï¼š

```
dependencies:
  flutter_push_plugin:
    git:
      url: https://github.com/cyndibaby905/39_flutter_crash_plugin
```

åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨mainå‡½æ•°é‡Œä¸ºåº”ç”¨çš„å¼‚å¸¸æä¾›äº†ç»Ÿä¸€çš„å›è°ƒï¼Œå¹¶åœ¨å›è°ƒå‡½æ•°å†…ä½¿ç”¨postExceptionæ–¹æ³•å°†å¼‚å¸¸ä¸ŠæŠ¥è‡³Buglyã€‚

è€Œåœ¨SDKçš„åˆå§‹åŒ–æ–¹æ³•é‡Œï¼Œç”±äºBuglyè§†iOSå’ŒAndroidä¸ºä¸¤ä¸ªç‹¬ç«‹çš„åº”ç”¨ï¼Œå› æ­¤æˆ‘ä»¬åˆ¤æ–­äº†ä»£ç çš„è¿è¡Œå®¿ä¸»ï¼Œåˆ†åˆ«ä½¿ç”¨ä¸¤ä¸ªä¸åŒçš„App IDå¯¹å…¶è¿›è¡Œäº†åˆå§‹åŒ–å·¥ä½œã€‚

æ­¤å¤–ï¼Œä¸ºäº†ä¸ä½ æ¼”ç¤ºå…·ä½“çš„å¼‚å¸¸æ‹¦æˆªåŠŸèƒ½ï¼Œæˆ‘ä»¬è¿˜åœ¨ä¸¤ä¸ªæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶å¤„ç†ä¸­åˆ†åˆ«æŠ›å‡ºäº†åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç±»å¼‚å¸¸ï¼š

```
//ä¸ŠæŠ¥æ•°æ®è‡³Bugly
Future<Null> _reportError(dynamic error, dynamic stackTrace) async {
  FlutterCrashPlugin.postException(error, stackTrace);
}

Future<Null> main() async {
  //æ³¨å†ŒFlutteræ¡†æ¶çš„å¼‚å¸¸å›è°ƒ
  FlutterError.onError = (FlutterErrorDetails details) async {
    //è½¬å‘è‡³Zoneçš„é”™è¯¯å›è°ƒ
    Zone.current.handleUncaughtError(details.exception, details.stack);
  };
  //è‡ªå®šä¹‰é”™è¯¯æç¤ºé¡µé¢
  ErrorWidget.builder = (FlutterErrorDetails flutterErrorDetails){
    return Scaffold(
      body: Center(
        child: Text("Custom Error Widget"),
      )
    );
  };
  //ä½¿ç”¨runZoneæ–¹æ³•å°†runAppçš„è¿è¡Œæ”¾ç½®åœ¨Zoneä¸­ï¼Œå¹¶æä¾›ç»Ÿä¸€çš„å¼‚å¸¸å›è°ƒ
  runZoned<Future<Null>>(() async {
    runApp(MyApp());
  }, onError: (error, stackTrace) async {
    await _reportError(error, stackTrace);
  });
}

class MyApp extends StatefulWidget {
  @override
  State<StatefulWidget> createState() => _MyAppState();
}

class _MyAppState extends State<MyApp> {
  @override
  void initState() {
    //ç”±äºBuglyè§†iOSå’ŒAndroidä¸ºä¸¤ä¸ªç‹¬ç«‹çš„åº”ç”¨ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ä¸åŒçš„App IDè¿›è¡Œåˆå§‹åŒ–
    if(Platform.isAndroid){
      FlutterCrashPlugin.setUp('43eed8b173');
    }else if(Platform.isIOS){
      FlutterCrashPlugin.setUp('088aebe0d5');
    }
    super.initState();
  }
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      home: MyHomePage(),
    );
  }
}

class MyHomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('Crashy'),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: <Widget>[
            RaisedButton(
              child: Text('Dart exception'),
              onPressed: () {
                //è§¦å‘åŒæ­¥å¼‚å¸¸
                throw StateError('This is a Dart exception.');
              },
            ),
            RaisedButton(
              child: Text('async Dart exception'),
              onPressed: () {
                //è§¦å‘å¼‚æ­¥å¼‚å¸¸
                Future.delayed(Duration(seconds: 1))
                      .then((e) => throw StateError('This is a Dart exception in Future.'));
              },
            )
          ],
        ),
      ),
    );
  }
}
```

è¿è¡Œè¿™æ®µä»£ç ï¼Œåˆ†åˆ«ç‚¹å‡»Dart exceptionæŒ‰é’®å’Œasync Dart exceptionæŒ‰é’®å‡ æ¬¡ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„åº”ç”¨ä»¥åŠæ§åˆ¶å°å¹¶æ²¡æœ‰æç¤ºä»»ä½•å¼‚å¸¸ä¿¡æ¯ã€‚

![](https://static001.geekbang.org/resource/image/2c/48/2c87e21fcfc55b1b80b599032f2de148.png?wh=1125%2A2436)

å›¾5 å¼‚å¸¸æ‹¦æˆªæ¼”ç¤ºç¤ºä¾‹ï¼ˆiOSï¼‰

![](https://static001.geekbang.org/resource/image/dd/f7/dd668e2fe931b66cf315b04fdfedecf7.png?wh=1080%2A1920)

å›¾6 å¼‚å¸¸æ‹¦æˆªæ¼”ç¤ºç¤ºä¾‹ï¼ˆAndroidï¼‰

**ç„¶å**ï¼Œæˆ‘ä»¬æ‰“å¼€[Buglyå¼€å‘è€…åå°](https://bugly.qq.com/v2/workbench/apps)ï¼Œé€‰æ‹©å¯¹åº”çš„Appï¼Œåˆ‡æ¢åˆ°é”™è¯¯åˆ†æé€‰é¡¹æŸ¥çœ‹å¯¹åº”çš„é¢æ¿ä¿¡æ¯ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒBuglyå·²ç»æˆåŠŸæ¥æ”¶åˆ°ä¸ŠæŠ¥çš„å¼‚å¸¸ä¸Šä¸‹æ–‡äº†ã€‚

![](https://static001.geekbang.org/resource/image/d5/c0/d54b4af764a71ed8865c2888e8df36c0.png?wh=1916%2A708)

å›¾7 Bugly iOSé”™è¯¯åˆ†æä¸ŠæŠ¥æ•°æ®æŸ¥çœ‹

![](https://static001.geekbang.org/resource/image/a8/25/a819f51de79ea327cd04cff2b4ab7525.png?wh=1934%2A734)

å›¾8 Bugly Androidé”™è¯¯åˆ†æä¸ŠæŠ¥æ•°æ®æŸ¥çœ‹

## æ€»ç»“

å¥½äº†ï¼Œä»Šå¤©çš„åˆ†äº«å°±åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æ¥å°ç»“ä¸‹å§ã€‚

å¯¹äºFlutteråº”ç”¨çš„å¼‚å¸¸æ•è·ï¼Œå¯ä»¥åˆ†ä¸ºå•ä¸ªå¼‚å¸¸æ•è·å’Œå¤šå¼‚å¸¸ç»Ÿä¸€æ‹¦æˆªä¸¤ç§æƒ…å†µã€‚

å…¶ä¸­ï¼Œå•å¼‚å¸¸æ•è·ï¼Œä½¿ç”¨Dartæä¾›çš„åŒæ­¥å¼‚å¸¸try-catchï¼Œä»¥åŠå¼‚æ­¥å¼‚å¸¸catchErroræœºåˆ¶å³å¯å®ç°ã€‚è€Œå¯¹å¤šä¸ªå¼‚å¸¸çš„ç»Ÿä¸€æ‹¦æˆªï¼Œå¯ä»¥ç»†åˆ†ä¸ºå¦‚ä¸‹ä¸¤ç§æƒ…å†µï¼šä¸€æ˜¯Appå¼‚å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»£ç æ‰§è¡Œå—æ”¾ç½®åˆ°Zoneä¸­ï¼Œé€šè¿‡onErrorå›è°ƒè¿›è¡Œç»Ÿä¸€å¤„ç†ï¼›äºŒæ˜¯Frameworkå¼‚å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨FlutterError.onErrorå›è°ƒè¿›è¡Œæ‹¦æˆªã€‚

åœ¨æ•è·åˆ°å¼‚å¸¸ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ä¸ŠæŠ¥å¼‚å¸¸ä¿¡æ¯ï¼Œç”¨äºåç»­åˆ†æå®šä½é—®é¢˜ã€‚è€ƒè™‘åˆ°Buglyçš„ç¤¾åŒºæ´»è·ƒåº¦æ¯”è¾ƒé«˜ï¼Œæ‰€ä»¥æˆ‘ä»¥Buglyä¸ºä¾‹ï¼Œä¸ä½ è®²è¿°äº†ä»¥åŸç”Ÿæ’ä»¶å°è£…çš„å½¢å¼ï¼Œå¦‚ä½•è¿›è¡Œå¼‚å¸¸ä¿¡æ¯ä¸ŠæŠ¥ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒFlutteræä¾›çš„å¼‚å¸¸æ‹¦æˆªåªèƒ½æ‹¦æˆªDartå±‚çš„å¼‚å¸¸ï¼Œè€Œæ— æ³•æ‹¦æˆªEngineå±‚çš„å¼‚å¸¸ã€‚è¿™æ˜¯å› ä¸ºï¼ŒEngineå±‚çš„å®ç°å¤§éƒ¨åˆ†æ˜¯C++çš„ä»£ç ï¼Œä¸€æ—¦å‡ºç°å¼‚å¸¸ï¼Œæ•´ä¸ªç¨‹åºå°±ç›´æ¥Crashæ‰äº†ã€‚ä¸è¿‡é€šå¸¸æ¥è¯´ï¼Œè¿™ç±»å¼‚å¸¸å‡ºç°çš„æ¦‚ç‡æä½ï¼Œä¸€èˆ¬éƒ½æ˜¯Flutteråº•å±‚çš„Bugï¼Œä¸æˆ‘ä»¬åœ¨åº”ç”¨å±‚çš„å®ç°æ²¡å¤ªå¤§å…³ç³»ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿæ— éœ€è¿‡åº¦æ‹…å¿ƒã€‚

å¦‚æœæˆ‘ä»¬æƒ³è¦è¿½è¸ªEngineå±‚çš„å¼‚å¸¸ï¼ˆæ¯”å¦‚ï¼Œç»™FlutteræIssueï¼‰ï¼Œåˆ™éœ€è¦å€ŸåŠ©äºåŸç”Ÿç³»ç»Ÿæä¾›çš„Crashç›‘å¬æœºåˆ¶ã€‚è¿™ï¼Œå°±æ˜¯ä¸€ä¸ªå¾ˆç¹ççš„å·¥ä½œäº†ã€‚

å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ•°æ®ä¸ŠæŠ¥SDK Buglyå°±æä¾›äº†è¿™æ ·çš„èƒ½åŠ›ï¼Œå¯ä»¥è‡ªåŠ¨æ”¶é›†åŸç”Ÿä»£ç çš„Crashã€‚è€Œåœ¨Buglyæ”¶é›†åˆ°å¯¹åº”çš„Crashä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åšçš„äº‹æƒ…å°±æ˜¯ï¼Œå°†Flutter Engineå±‚å¯¹åº”çš„ç¬¦å·è¡¨ä¸‹è½½ä¸‹æ¥ï¼Œä½¿ç”¨Androidæä¾›çš„ndk-stackã€iOSæä¾›çš„symbolicatecrashæˆ–atoså‘½ä»¤ï¼Œå¯¹ç›¸åº”Crashå †æ ˆè¿›è¡Œè§£æï¼Œä»è€Œå¾—å‡ºEngineå±‚å´©æºƒçš„å…·ä½“ä»£ç ã€‚

å…³äºè¿™äº›æ­¥éª¤çš„è¯¦ç»†è¯´æ˜ï¼Œä½ å¯ä»¥å‚è€ƒFlutter[å®˜æ–¹æ–‡æ¡£](https://github.com/flutter/flutter/wiki/Crashes)ã€‚

æˆ‘æŠŠä»Šå¤©åˆ†äº«æ¶‰åŠçš„çŸ¥è¯†ç‚¹æ‰“åŒ…åˆ°äº†[GitHub](https://github.com/cyndibaby905/39_crashy_demo)ä¸­ï¼Œä½ å¯ä»¥ä¸‹è½½ä¸‹æ¥ï¼Œåå¤è¿è¡Œå‡ æ¬¡ï¼ŒåŠ æ·±ç†è§£ä¸è®°å¿†ã€‚

## æ€è€ƒé¢˜

æœ€åï¼Œæˆ‘ç»™ä½ ç•™ä¸‹ä¸¤é“æ€è€ƒé¢˜å§ã€‚

ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œè¯·æ‰©å±•\_reportErrorå’Œè‡ªå®šä¹‰é”™è¯¯æç¤ºé¡µé¢çš„å®ç°ï¼Œåœ¨Debugç¯å¢ƒä¸‹å°†å¼‚å¸¸æ•°æ®æ‰“å°è‡³æ§åˆ¶å°ï¼Œå¹¶ä¿ç•™åŸæœ‰ç³»ç»Ÿé”™è¯¯æç¤ºé¡µé¢å®ç°ã€‚

```
//ä¸ŠæŠ¥æ•°æ®è‡³Bugly
Future<Null> _reportError(dynamic error, dynamic stackTrace) async {
  FlutterCrashPlugin.postException(error, stackTrace);
}

//è‡ªå®šä¹‰é”™è¯¯æç¤ºé¡µé¢
ErrorWidget.builder = (FlutterErrorDetails flutterErrorDetails){
  return Scaffold(
    body: Center(
      child: Text("Custom Error Widget"),
    )
  );
};
```

ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå¹¶å‘Isolateçš„å¼‚å¸¸å¯ä»¥é€šè¿‡ä»Šå¤©åˆ†äº«ä¸­ä»‹ç»çš„æ•è·æœºåˆ¶å»æ‹¦æˆªå—ï¼Ÿå¦‚æœä¸è¡Œï¼Œåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ

```
//å¹¶å‘Isolate
doSth(msg) => throw ConcurrentModificationError('This is a Dart exception.');

//ä¸»Isolate
Isolate.spawn(doSth, "Hi");
```

æ¬¢è¿ä½ åœ¨è¯„è®ºåŒºç»™æˆ‘ç•™è¨€åˆ†äº«ä½ çš„è§‚ç‚¹ï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ç­‰å¾…ä½ ï¼æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ9ï¼‰</strong></div><ul>
<li><span>å›çœ¸~</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>public class MainActivityFlutterTest extends AppCompatActivity {
    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        View flutterView = Flutter.createView(MainActivityFlutterTest.this, getLifecycle(), &quot;route1&quot;);
        setContentView(flutterView);
    }
}è€å¸ˆï¼Œè¯·é—®ä¸‹å¦‚æœç”¨è¿™ç§æ–¹å¼åœ¨åŸç”Ÿä¸­æ·»åŠ flutterview ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨è¿™ä¸ªåŸç”Ÿactiivtyä¸­è®¾ç½®mehodChannel å—  ï¼Œè²Œä¼¼MethodChannel éœ€è¦BinaryMessengerï¼Œè¿™ä¸ªæ€ä¹ˆè®¾ç½®å‘€</p>2019-11-07</li><br/><li><span>æµ£ç†Šç‰¹å·¥é˜Ÿ</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è€å¸ˆï¼Œæˆ‘å‚è€ƒæ‚¨githubä¸Šçš„ä»£ç åï¼Œåœ¨jsonè½¬æ¢å‡ºç° type &#39;int&#39; is not a subtype of type &#39;double&#39; è¿™ä¸ªç±»å‹çš„å¼‚å¸¸æ—¶ï¼Œå‘ç°FlutterError.onErrorå›è°ƒå’ŒrunZonedçš„onErroréƒ½ä¸æ‰§è¡Œå•Šï¼Œåˆ°æ˜¯è¿›äº†è‡ªå®šä¹‰çš„é”™è¯¯ç•Œé¢</p>2019-10-30</li><br/><li><span>Carlo</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œæˆ‘ä½¿ç”¨äº†Firebase Crashlyticsã€‚ï¼ˆé€šè¿‡å®˜æ–¹æ’ä»¶firebase_crashlyticsï¼‰ä½†æ˜¯å¾—å€’çš„crash stack traceæ ¹æœ¬æ²¡æœ‰ç”¨å•Šã€‚ï¼ˆåªèƒ½çŸ¥é“æ˜¯ç‚¹å‡»ink_well é€ æˆäº†crashï¼Œä½†æ˜¯æ²¡å‘Šè¯‰æ˜¯å“ªä¸ªfileï¼Œå“ªè¡Œä»£ç ï¼‰

Crashlytics.crash (firebase_crashlytics.dart:50)
_InkResponseState._handleTap (ink_well.dart:635)
_InkResponseState.build.&lt;fn&gt; (ink_well.dart:711)
GestureRecognizer.invokeCallback (recognizer.dart:182)
TapGestureRecognizer._checkUp (tap.dart:365)
TapGestureRecognizer.handlePrimaryPointer (tap.dart:275)
PrimaryPointerGestureRecognizer.handleEvent (recognizer.dart:455)
PointerRouter._dispatch (pointer_router.dart:75)
PointerRouter.route (pointer_router.dart:102)
_WidgetsFlutterBinding&amp;BindingBase&amp;GestureBinding.handleEvent (binding.dart:218)
_WidgetsFlutterBinding&amp;BindingBase&amp;GestureBinding.dispatchEvent (binding.dart:198)</p>2019-10-04</li><br/><li><span>äº¡å‘½ä¹‹å¾’</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆ ï¼Œæƒ³é—®ä¸‹ flutter å¼€å‘webé¡µé¢å¯ä»¥æ€ä¹ˆåšå˜›</p>2019-09-27</li><br/><li><span>wtsky ã€‚</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œcheckboxç­‰ç±»å‹æ§ä»¶ï¼Œå¿…é¡»å’Œstatefulwidget  setStateæ–¹æ³•é…åˆä½¿ç”¨å—</p>2019-09-26</li><br/><li><span>åˆ˜è¶…</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>FlutterError.onError è¿™ä¸ªå›è°ƒ,åªæœ‰åœ¨releaseæ¨¡å¼ä¸‹,æ‰ä¼šç”Ÿæ•ˆ,å…·ä½“å¯çœ‹.https:&#47;&#47;github.com&#47;flutter&#47;flutter&#47;issues&#47;48972</p>2020-05-25</li><br/><li><span>IF-Processing</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æˆ‘çœ‹å’±ä»¬çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œåœ¨åˆå§‹åŒ–appidæ—¶ï¼ŒæŠŠidæ”¾å…¥ä»£ç é‡Œäº†ï¼Œè¿™æ ·æ¯æ¬¡ä¿®æ”¹éƒ½éœ€è¦ä¿®æ”¹ä»£ç ï¼Œæäº¤ä»¥åŠç¼–è¯‘ã€‚flutteræœ‰æ²¡æœ‰ç±»ä¼¼é…ç½®æ–‡ä»¶çš„æœºåˆ¶å‘¢ï¼Ÿå¦‚æœæ²¡æœ‰ï¼Œåšä¸€ä¸ªç±»ä¼¼Configçš„ç±»ï¼Œæ ¹æ®ä¸åŒçš„ç›®æ ‡ç¯å¢ƒï¼Œä½¿ç”¨ä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œè¿™æ ·æ˜¯å¦å¯è¡Œï¼Œæœ‰å•¥å‘æ²¡æœ‰ï¼Ÿ</p>2020-02-06</li><br/><li><span>ç”˜é™µç¬‘ç¬‘ç”Ÿ</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ–‡å­—ä¸­â€œåœ¨å®Œæˆäº†æå…‰ Android SDK çš„æ¥å£å°è£…å’Œæƒé™é…ç½®ä¹‹åâ€ï¼Œåº”è¯¥æ˜¯â€œå®Œæˆäº†Bugly.....â€</p>2020-03-28</li><br/><li><span>ç«è…¿</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>Flutteråœ¨è§†é¢‘æ’­æ”¾è¿™å—æœ‰æ²¡æœ‰å¥½çš„è§£å†³æ–¹æ¡ˆï¼Ÿ æœ€è¿‘å»æ‰¾äº†ä¸€äº›Flutter Textureçš„èµ„æ–™ï¼Œæ„Ÿè§‰æ•ˆç‡ä¸Šä¼šæ¯”Nativeçš„å·®å¾ˆå¤šã€‚ </p>2019-12-26</li><br/>
</ul>