ä½ å¥½ï¼Œæˆ‘æ˜¯è’‹å®ä¼Ÿã€‚

ä»Šå¤©æˆ‘ä»¬æ¥èŠä¸€èŠReact Nativeä¸­åŠ¨ç”»çš„åŸç†ã€‚åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘æƒ³è¯·ä½ æ€è€ƒä¸€ä¸‹ï¼šåŠ¨ç”»çš„æœ¬è´¨åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ

ä½ å¯èƒ½çŸ¥é“ï¼Œä¸çœŸå®ä¸–ç•Œä¸­è¿ç»­è¿åŠ¨çš„äº‹ç‰©ä¸åŒï¼Œæˆ‘ä»¬åœ¨æ‰‹æœºã€ç”µè„‘ã€ç”µå½±é™¢çš„å±å¹•ä¸­çœ‹åˆ°çš„åŠ¨ç”»ï¼Œå®é™…æ˜¯ç”±ä¸€å¼ å¼ å¿«é€Ÿåˆ‡æ¢å›¾ç‰‡ç»„æˆçš„ã€‚çœ‹åŠ¨ç”»æ—¶ï¼Œæˆ‘ä»¬çš„çœ¼ç›æ¥æ”¶åˆ°çš„æ˜¯ä¸€å¼ å¼ å¹¶ä¸è¿ç»­çš„é™æ€å›¾ç‰‡ï¼Œä½†æˆ‘ä»¬çš„å¤§è„‘æŠŠè¿™äº›ä¸è¿ç»­çš„å›¾ç‰‡â€œæƒ³è±¡â€æˆäº†ä¸€ç³»åˆ—è¿ç»­äº‹ä»¶ï¼Œè¿™å°±æ˜¯åŠ¨ç”»çš„åŸºæœ¬åŸç†ã€‚

è€Œæ‰‹æœºåŠ¨ç”»è¦æƒ³æµç•…ï¼Œä¸€èˆ¬è€Œè¨€éœ€è¦ä¿è¯æ¯ 1 ç§’æ¸²æŸ“ 60 å¸§çš„é€Ÿåº¦ã€‚è¿™é‡Œçš„æ¯ä¸€å¸§éƒ½æ˜¯ä¸€å¼ é™æ€å›¾ç‰‡ï¼Œä¹Ÿå°±æ˜¯è¯´ 1 ç§’é’Ÿéœ€è¦æ¸²æŸ“å‡º 60 ä¸ªé™æ€å›¾ç‰‡ã€‚è¿™ä¹Ÿæ„å‘³ç€æ‰‹æœºå¤„ç†æ¯ä¸€å¸§åŠ¨ç”»çš„è€—æ—¶ï¼Œéœ€è¦ä¿è¯åœ¨ 16.6msï¼ˆ=1000/60ï¼‰ä»¥å†…ï¼Œå¦‚æœå¤„ç†ä¸€å¸§çš„è€—æ—¶è¶…è¿‡ 16.6ms ï¼Œå°±ä¼šæ‰å¸§ã€‚æ‰å¸§å¤šäº†ï¼Œæˆ‘ä»¬çš„å¤§è„‘å°±ä¼šæ„Ÿè§‰åˆ°åŠ¨ç”»ä¸­çš„ä¸è¿ç»­æ€§ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„å¡é¡¿ã€‚

åŠ¨ç”»å¯¹æ¸²æŸ“æ€§èƒ½çš„è¦æ±‚å¾ˆé«˜ã€‚ç†è®ºä¸Šï¼Œä½ å¯ä»¥ä½¿ç”¨ setInterval æ¯ 16.6ms æ‰§è¡Œä¸€æ¬¡ setState æ”¹å˜çŠ¶æ€ï¼Œæ¸²æŸ“æ–°çš„è§†å›¾ï¼Œæ¥å®ç°åŠ¨ç”»ã€‚ä½†å®é™…ä¸Šï¼ŒsetState æ˜¯ä¸€ç§è€—æ—¶æ¯”è¾ƒé•¿çš„æ›´æ–°é¡µé¢çš„æ–¹æ³•ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤æ‚é¡µé¢ã€å¤æ‚äº¤äº’çš„æƒ…å†µä¸‹ï¼ŒsetInterval + setState çš„æ–¹æ¡ˆå¹¶ä¸é€‚åˆç”¨æ¥å®ç°åŠ¨ç”»ã€‚

æ‰€ä»¥ï¼Œä¸ºäº†ä¿éšœåŠ¨ç”»çš„æµç•…æ€§ï¼Œåœ¨æ¶‰åŠåŠ¨ç”»çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œ**æˆ‘ä»¬è¿˜éœ€è¦å¼•å…¥åŠ¨ç”»åº“**ã€‚

åœ¨ä¸Šä¸€è®²ä¸­ï¼Œæˆ‘ç»™ä½ ä»‹ç»äº† React Native ä¸­å¸¸ç”¨çš„ä¸‰ç§åŠ¨ç”»å·¥å…·ï¼ŒåŒ…æ‹¬ï¼šé€‚åˆè½»é‡çº§åŠ¨ç”»åœºæ™¯ä½¿ç”¨çš„ React Native è‡ªå¸¦çš„ [Animated](https://reactnative.cn/docs/animated) åŠ¨ç”»ï¼›é€‚åˆæ— äº¤äº’åœºæ™¯çš„ã€èƒ½æ‰¾ UI è®¾è®¡å¸ˆå¸®å¿™è‡ªåŠ¨ç”Ÿæˆçš„ [Lottie](https://github.com/lottie-react-native/lottie-react-native) åŠ¨ç”»ï¼›ä»¥åŠæˆ‘ä»Šå¤©é‡ç‚¹è¦å’Œä½ èŠçš„ã€é€‚ç”¨äºå¯äº¤äº’åœºæ™¯çš„ [Reanimated](https://docs.swmansion.com/react-native-reanimated/) åŠ¨ç”»ã€‚

## åˆå­¦ Reanimated

Reanimated çš„åå­—æ¥æºäºå®ƒçš„é‚£å¥å£å·ï¼š

> React Nativeâ€™s Animated library reimplemented.

Reanimated åå­—ä¸­çš„ Re å°±æ˜¯ Reimplemented é‡æ–°å®ç°çš„æ„æ€ï¼ŒAnimated ä»£è¡¨å°±æ˜¯ React Native è‡ªå¸¦çš„åŠ¨ç”»åº“ Animatedï¼ŒåŠ èµ·æ¥å°±æ˜¯é‡æ–°å®ç°çš„ Animated åŠ¨ç”»åº“çš„æ„æ€ã€‚å®ƒçš„æ½œå°è¯å¥½åƒå°±æ˜¯ï¼šå¦‚æœä½ è§‰å¾— React Native è‡ªå¸¦çš„ Animated åŠ¨ç”»åº“ä¸å¥½ç”¨ï¼Œå°±æ¥è¯•è¯•æˆ‘å§ï¼Œæˆ‘æŠŠ React Native å®˜æ–¹çš„åŠ¨ç”»åº“ç»™é‡æ–°å®ç°äº†ã€‚

æˆ‘ä»¬å…ˆç”¨**â€œåˆ‡æ¢å®½åº¦çš„åŠ¨ç”»â€**çš„ä¾‹å­ï¼Œçœ‹çœ‹ Reanimated åˆ°åº•åº”è¯¥å¦‚ä½•ä½¿ç”¨ã€‚

è¿™ä¸ªä¾‹å­æ˜¯è¿™æ ·çš„ï¼šç°åœ¨ä½ æœ‰ä¸€ä¸ªè§†å›¾å’Œä¸€ä¸ªæŒ‰é’®ï¼Œè§†å›¾çš„é«˜åº¦æ˜¯å›ºå®šçš„ï¼Œè§†å›¾çš„å®½åº¦å¯ä»¥ç”¨åŠ¨ç”»æ¥æ§åˆ¶ï¼Œä½ æ¯ç‚¹ä¸€ä¸‹åˆ‡æ¢å®½åº¦çš„æ–‡å­—ï¼Œè§†å›¾å®½åº¦éƒ½ä¼šéšæœºæ”¹å˜ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/05/69/05ae457ac9eba406300aafa246549069.png?wh=1920x886)

ä½ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨é¡µé¢ä¸­è“è‰²è§†å›¾åˆå§‹åŒ–çš„å®½åº¦æ˜¯ 10 åƒç´ ï¼Œå½“ä½ ç‚¹å‡»åˆ‡æ¢å®½åº¦çš„æ–‡å­—åï¼Œè“è‰²è§†å›¾çš„å®½åº¦ä¼šåœ¨ 0~350 åƒç´ ä¹‹é—´éšæœºå˜åŒ–ã€‚å› ä¸ºæ˜¯åŠ¨ç”»ï¼Œæ‰€ä»¥è“è‰²è§†å›¾çš„å®½åº¦å¹¶ä¸æ˜¯ä¸€ä¸‹å°±å˜å®½çš„ï¼Œè€Œæ˜¯è¿ç»­æ”¹å˜çš„ã€‚åœ¨ 1s å†…ï¼Œå…ˆå¢é•¿å‡ åƒç´ ï¼Œç„¶åå†å¢é•¿å‡ åƒç´ ï¼Œä¾æ¬¡ç±»æ¨ç›´åˆ°ç›®æ ‡é•¿åº¦ï¼Œå› ä¸ºåˆ·æ–°çš„å¸§ç‡å¾ˆå¿«ï¼Œå› æ­¤äººçš„è‚‰çœ¼çœ‹èµ·æ¥å°±æ˜¯å®½åº¦å°±æ˜¯è¿ç»­å˜åŒ–çš„ã€‚

é‚£æˆ‘ä»¬æ€ä¹ˆç”¨Reanimatedå®ç°è¿™ä¸ªåŠ¨ç”»æ•ˆæœå‘¢ï¼Ÿ

åˆ«æ€¥ï¼Œä¸ºäº†å¸®ä½ æ›´å¥½åœ°åƒé€è¿™ä¸ªæ–°çŸ¥è¯†ï¼Œæˆ‘ä»¬å¼•å…¥ä¹‹å‰å­¦è¿‡çš„Stateï¼Œå¯¹æ¯”ç€æ¥å­¦ä¹ ã€‚é‚£ä¹ˆï¼Œä½¿ç”¨ Reanimated å®ç°è§†å›¾â€œåŠ¨ç”»â€å’Œä½¿ç”¨ State å®ç°è§†å›¾â€œå˜åŒ–â€æœ‰ä»€ä¹ˆç›¸ä¼¼ä¹‹å¤„å‘¢ï¼Ÿä½ å¯ä»¥çœ‹ä¸‹å®ƒä»¬çš„æ›´æ–°æ­¥éª¤çš„å¯¹æ¯”ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/b4/7e/b4653520a9bd29e348671f19b439317e.png?wh=1920x970)

ä½ å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯ç”¨ State æ›´æ–°é¡µé¢ï¼Œè¿˜æ˜¯ç”¨ Reanimated æ›´æ–°åŠ¨ç”»ï¼Œéƒ½éœ€è¦ 4 æ­¥ã€‚å…·ä½“å®ƒä»¬æœ‰ä»€ä¹ˆç›¸ä¼¼ä¹‹å¤„å‘¢ï¼Ÿæˆ‘ä»¬ç›´æ¥æ¥åˆ†æ Reanimatedä¸­çš„è¿™4ä¸ªæ¦‚å¿µï¼š

ç¬¬ä¸€ä¸ªæ¦‚å¿µï¼šå…±äº«å€¼ï¼ˆSharedValueï¼‰ã€‚**Reanimatedä¸­å…±äº«å€¼è¿™ä¸ªæ¦‚å¿µç±»ä¼¼äº React ä¸­çš„çŠ¶æ€ State**ï¼Œæˆ‘ä»¬ç®€å•å¯¹æ¯”ä¸‹å®ƒä»¬å„è‡ªçš„ä»£ç ï¼Œå…ˆçœ‹çœ‹Stateçš„ï¼š

```plain
// State ç¤ºä¾‹ä»£ç 
import { useState } from 'react';
const [randomWidth, setRandomWidth] = useState(10);
// randomWidth === 10
```

åœ¨ State ç¤ºä¾‹ä»£ç ä¸­ï¼Œé©±åŠ¨è§†å›¾å˜åŒ–çš„æœ€åˆå› å­æ˜¯çŠ¶æ€ã€‚ç”¨äºåˆå§‹åŒ–çŠ¶æ€çš„é’©å­å‡½æ•° useState æ˜¯ä» react ä¸­å¼•å…¥çš„ï¼Œç„¶ååœ¨ç»„ä»¶ä¸­ä½¿ç”¨ useState åˆ›å»ºå‡ºä¸€ä¸ªéšæœºå®½åº¦çŠ¶æ€ randomWidthï¼Œä»¥åŠä¸€ä¸ªæ”¹å˜è¯¥çŠ¶æ€çš„å‡½æ•° setRandomWidthã€‚å…¶ä¸­ï¼Œåˆå§‹åŒ–å‡ºæ¥çš„ randomWidth æ˜¯ä¸€ä¸ªé»˜è®¤èµ‹å€¼æ•°å­—10ã€‚

æ¥ç€æˆ‘ä»¬çœ‹çœ‹Reanimatedçš„ä»£ç ï¼š

```plain
// Reanimated ç¤ºä¾‹ä»£ç 
import { useSharedValue} from 'react-native-reanimated';
const randomWidth = useSharedValue(10);
// randomWidth.value === 10
```

åœ¨ Reanimated çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œé©±åŠ¨åŠ¨ç”»çš„æœ€åˆå› å­æ˜¯å…±äº«å€¼ï¼ˆShareValueï¼‰ã€‚ç”¨äºåˆå§‹åŒ–å…±äº«å€¼çš„é’©å­å‡½æ•° useSharedValue æ˜¯ä» react-native-reanimated ä¸­å¼•å…¥çš„ã€‚ç„¶åä½¿ç”¨ useSharedValue åˆ›å»ºå‡ºä¸€ä¸ªå¯¹è±¡ randomWidthï¼ŒrandomWidth çš„ value å±æ€§æ˜¯ä¸€ä¸ªé»˜è®¤èµ‹å€¼æ•°å­— 10ã€‚

ç¬¬äºŒä¸ªæ¦‚å¿µï¼šè¡ç”Ÿå€¼ï¼ˆDerivedValueï¼‰ã€‚**Reanimated çš„è¡ç”Ÿå€¼ï¼ˆDerivedValueï¼‰è¿™ä¸ªæ¦‚å¿µç±»ä¼¼äº React ä¸­çš„çŠ¶æ€è¡ç”Ÿå€¼**ã€‚æˆ‘ä»¬åŒæ ·å…ˆæ¥çœ‹Stateçš„ç¤ºä¾‹ä»£ç ï¼š

```plain
// State ç¤ºä¾‹ä»£ç 
const style = {
  width: randomWidth
}
```

åœ¨ State ç¤ºä¾‹ä»£ç ä¸­ï¼Œä½ å¯ä»¥åœ¨ç»„ä»¶å‡½æ•°ä¸­çš„ä»»æ„ä½ç½®ç›´æ¥ä½¿ç”¨çŠ¶æ€ randomWidthï¼Œæˆ–è€…å°†çŠ¶æ€ randomWidth å°è£…åˆ°æ ·å¼å¯¹è±¡ style ä¸­ã€‚

ç„¶åæ˜¯Reanimatedçš„ç¤ºä¾‹ä»£ç ï¼š

```plain
// Reanimated ç¤ºä¾‹ä»£ç 
import { useAnimatedStyle } from 'react-native-reanimated';

// é”™è¯¯ç¤ºèŒƒ
const style = {
  width: randomWidth.value
}

// æ­£ç¡®ç¤ºèŒƒ
const style = useAnimatedStyle(() => {
  return {
    width: randomWidth.value,
  };
});
```

ä½†åœ¨ Reanimated ç¤ºä¾‹ä»£ç ä¸­ï¼Œå¦‚æœä½ ç›´æ¥å°† `const style = {width: randomWidth.value}` ç»„æˆçš„æ ·å¼å¯¹è±¡èµ‹å€¼ç»™ JSX å…ƒç´ ï¼Œæ§åˆ¶è§†å›¾å®½åº¦æ”¹å˜çš„åŠ¨ç”»æ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚è¿™æ˜¯ Reanimated é©±åŠ¨åŠ¨ç”»å’Œ State é©±åŠ¨è§†å›¾çš„æœºåˆ¶ä¸ä¸€æ ·å¯¼è‡´çš„ã€‚

è¿™æ—¶ä½ éœ€è¦ä» react-native-reanimated ä¸­å¼•å…¥é’©å­å‡½æ•° useAnimatedStyleï¼Œè¿™ä¸ªé’©å­å‡½æ•°æ˜¯ä¸“é—¨ç”¨æ¥å¤„ç†åŠ¨ç”»æ ·å¼çš„è¡ç”Ÿå€¼çš„ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå…¥å‚å‡½æ•°çš„è¿”å›å€¼å°±æ˜¯åŠ¨ç”»ç»„ä»¶çš„æ ·å¼å€¼ã€‚

ç¬¬ä¸‰ä¸ªæ¦‚å¿µï¼ŒåŠ¨ç”»ç»„ä»¶ï¼ˆAnimatedComponentï¼‰ã€‚**Reanimated çš„åŠ¨ç”»ç»„ä»¶å’Œ React/React Native ä¸­çš„ç»„ä»¶ï¼ˆComponentï¼‰æ¦‚å¿µæ˜¯ç±»ä¼¼çš„**ã€‚æˆ‘ä»¬åŒæ ·å…ˆçœ‹ State ç¤ºä¾‹ä»£ç ï¼š

```plain
// State ç¤ºä¾‹ä»£ç 
import { View } from 'react-native';

<View style={[{ width: 100}, style]} />
```

åœ¨ State ç¤ºä¾‹ä»£ç ä¸­ï¼Œä½ è¦ä» react-native åº“ä¸­å¼•å…¥ View ç»„ä»¶ï¼Œå¹¶å°†ç»„ä»¶ View å®ä¾‹åŒ–ä¸º JSX å…ƒç´ ã€‚

ç„¶åå†çœ‹Reanimatedçš„ç¤ºä¾‹ä»£ç ï¼š

```plain
// Reanimated ç¤ºä¾‹ä»£ç 
import Animated from 'react-native-reanimated';

<Animated.View style={[{ width: 100}, style]} />
```

ä½ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Reanimated ç¤ºä¾‹ä»£ç ä¸­ï¼Œä½ éœ€è¦ä» react-native-reanimated å¼•å…¥ Animated å¯¹è±¡ï¼Œåœ¨è¯¥å¯¹è±¡ä¸ŠæŒ‚äº†å¸¸ç”¨çš„ react-native ç»„ä»¶ï¼Œæ¯”å¦‚ç¤ºä¾‹ä»£ç ä¸­çš„ `Animated.View`ï¼Œè¿˜æœ‰ `Animated.Text`ã€ `Animated.FlatList`ç­‰ç­‰ã€‚

è¿™äº›ç”± Reanimated åŒ…è£…å¥½çš„åŠ¨ç”»ç»„ä»¶ï¼Œæ¯”å¦‚ `Animated.View` ç­‰ç­‰ï¼Œä½¿ç”¨æ–¹å¼å’Œ `View` åŸºæœ¬ç±»ä¼¼ã€‚ä¸åŒçš„æ˜¯å…±äº«å€¼ï¼ˆShareValueï¼‰å’Œè¡ç”Ÿå€¼ï¼ˆDerivedValueï¼‰æ˜¯ä¸“é—¨ç»™åŠ¨ç”»ç»„ä»¶ï¼ˆAnimatedComponentï¼‰ç”¨çš„ï¼Œæ™®é€šç»„ä»¶ï¼ˆComponentï¼‰ç”¨ä¸äº†ã€‚

ç¬¬å››ä¸ªæ¦‚å¿µï¼Œæ›´æ–°å…±äº«å€¼ã€‚**Reanimated çš„æ›´æ–°å…±äº«å€¼çš„æ–¹å¼å’Œ React/React Native æ›´æ–°çŠ¶æ€çš„æ–¹å¼æ–¹å¼æ˜¯ä¸ä¸€æ ·çš„ã€‚**

Stateçš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```plain
// State ç¤ºä¾‹ä»£ç 
const [randomWidth, setRandomWidth] = useState(10);
setRandomWidth(Math.random() * 350)
```

åœ¨ State ç¤ºä¾‹ä»£ç ä¸­ï¼Œä½ æ˜¯é€šè¿‡é’©å­å‡½æ•° useState ç”Ÿæˆçš„çŠ¶æ€æ›´æ–°å‡½æ•° setRandomWidth æ¥æ›´æ–°çŠ¶æ€çš„ã€‚

ç„¶åæ˜¯Reanimatedçš„ç¤ºä¾‹ä»£ç ï¼š

```plain
// Reanimated ç¤ºä¾‹ä»£ç 
const randomWidth = useSharedValue(10);
// ä¸å¸¦åŠ¨ç”»çš„æ›´æ–°
randomWidth.value = Math.random() * 350;
// å¸¦åŠ¨ç”»çš„æ›´æ–°
randomWidth.value = withTiming(Math.random() * 350);
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Reanimated ç¤ºä¾‹ä»£ç ä¸­ï¼Œæ²¡æœ‰å…±äº«å€¼çš„æ›´æ–°å‡½æ•°ï¼Œå®ƒåªç”Ÿæˆäº†ä¸€ä¸ªå…±äº«å€¼å¯¹è±¡ï¼Œå…¶çœŸæ­£çš„å€¼æ˜¯æŒ‚åœ¨ value å±æ€§ä¸‹çš„ã€‚ä½ å¯ä»¥ç›´æ¥é€šè¿‡ç­‰å· `=` æŠŠæœ€æ–°çš„è§†å›¾å®½åº¦ `Math.random() * 350` èµ‹å€¼ç»™`randomWidth.value`ã€‚

äº‹å®ä¸Šï¼ŒReanimated æœ‰ä¸¤ç§æ›´æ–°æ–¹å¼ï¼Œä¸€ç§æ˜¯ä¸å¸¦åŠ¨ç”»æ›²çº¿çš„æ›´æ–°æ–¹å¼ï¼Œå¦ä¸€ç§æ˜¯å¸¦**åŠ¨ç”»æ›²çº¿**çš„æ›´æ–°æ–¹å¼ã€‚

ä½ ç›´æ¥æŠŠè§†å›¾å®½åº¦ `Math.random() * 350` èµ‹å€¼ç»™`randomWidth.value`ï¼Œå°±æ˜¯é€šè¿‡æŒ‡å®šä¸€ä¸ªæœ€ç»ˆå…±äº«å€¼çš„æ–¹å¼è¿›è¡Œæ›´æ–°çš„ï¼Œæ¯”å¦‚ä» 10 åƒç´ å®½åº¦ç›´æ¥å˜ä¸º 100 åƒç´ å®½åº¦ã€‚è¿™ç§æ›´æ–°æ–¹å¼æ˜¯ä¸€æ­¥åˆ°ä½çš„ï¼Œæ²¡æœ‰åŠ¨ç”»æ›²çº¿ã€‚

çœŸæ­£çš„åŠ¨ç”»æ˜¯ä» 10 åƒç´ å®½åº¦ï¼Œå¢é•¿åˆ° 11 åƒç´ ï¼Œç„¶åå¢é•¿åˆ° 12 åƒç´ ï¼Œä»¥æ­¤ç±»æ¨ï¼Œé€šè¿‡è¿ç»­çš„æ–¹å¼å¢é•¿åˆ° 100 åƒç´ å®½åº¦çš„ã€‚å…·ä½“åœ°è¯´ï¼Œæ§åˆ¶æ¯ä¸€å¸§å¢é•¿å¤šå°‘åƒç´ ã€å‡å°‘å¤šå°‘åƒç´ ï¼Œæ˜¯é€šè¿‡ç±»ä¼¼ `withTiming` çš„åŠ¨ç”»æ›²çº¿å®ç°çš„ã€‚`withTiming` åŠ¨ç”»æ›²çº¿çš„æ„æ€æ˜¯ï¼Œå¯åŠ¨ä¸€ä¸ªåŸºäºæ—¶é—´çš„åŠ¨ç”»ï¼Œåœ¨æ¯ä¸ªå•ä½æ—¶é—´å†…å¢é•¿æˆ–å‡å°‘çš„åƒç´ æ˜¯ç›¸ç­‰çš„ã€‚

ä½¿ç”¨ `withTiming(100)` æ›´æ–°å…±äº«å€¼æ—¶ï¼Œå°±ä¼šå¯åŠ¨åŸºäºæ—¶é—´çš„åŠ¨ç”»æ›²çº¿ï¼Œå…¶é»˜è®¤çš„æŒç»­æ—¶é—´æ˜¯ 300msã€‚ç†è®ºä¸Šï¼Œåœ¨è¿™ 300ms å†…ï¼Œè§†å›¾çš„å®½åº¦ä¼šä» 10 åƒç´ å¼€å§‹ï¼Œä»¥æ¯ä¸€å¸§å¢åŠ ä¸€ä¸ªå›ºå®šçš„å®½åº¦çš„é€Ÿåº¦ï¼Œå¢åŠ åˆ° 100 åƒç´ ã€‚

åˆ‡æ¢å®½åº¦åŠ¨ç”»çš„å®Œæ•´ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```plain
import Animated, {
  useSharedValue,
  withTiming,
  useAnimatedStyle,
  Easing,
} from 'react-native-reanimated';
import { View, Button } from 'react-native';
import React from 'react';

function AnimatedStyleUpdateExample(): React.ReactElement {
  const randomWidth = useSharedValue(10);

  const style = useAnimatedStyle(() => {
    console.log('==Animated==')
    return {
      width: withTiming(randomWidth.value),
    };
  });

  console.log('==render==')

  return (
    <View>
      <Animated.View
        style={[
          { width: 100, height: 30, backgroundColor: 'cornflowerblue'},
          style,
        ]}
      />
      <Button
        title="åˆ‡æ¢å®½åº¦"
        onPress={() => {
          randomWidth.value = Math.random() * 350;
        }}
      />
    </View>
  );
}
```

ä»ä¸Šé¢çš„ä»£ç ä½ å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ Reanimated æ›´æ–°åŠ¨ç”»çš„æ–¹å¼å’Œä½¿ç”¨ State æ›´æ–°é¡µé¢çš„æ–¹å¼ï¼Œæœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„ã€‚

å…¶ä¸­ï¼Œè¿˜æœ‰ä¸€ç‚¹æ˜¯ä½ éœ€è¦æ³¨æ„çš„ï¼Œå°±æ˜¯ **Reanimated å’Œ State çš„æ›´æ–°æœºåˆ¶å¹¶ä¸ä¸€æ ·**ã€‚

åœ¨ä½¿ç”¨ Reanimated æ”¹å˜å…±äº«å€¼è§¦å‘åŠ¨ç”»æ›´æ–°æ—¶ï¼Œåªä¼šè§¦å‘ç¤ºä¾‹ä»£ç ä¸­ useAnimatedStyle çš„å…¥å‚å‡½æ•°çš„æ‰§è¡Œï¼Œè€Œä¸ä¼šè§¦å‘ AnimatedStyleUpdateExample ç»„ä»¶å‡½æ•°çš„æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŠ¨ç”»æ›´æ–°æ˜¯ä¸ä¼šæ‰“å° â€œ==render==â€ æ—¥å¿—çš„ï¼Œåªä¼šæ‰“å°â€œ==Animated==â€æ—¥å¿—ã€‚

ä½†æ•´ä½“ä¸Šè®²ï¼ŒäºŒè€…éƒ½æ˜¯é€šè¿‡æ•°æ®æ¥é©±åŠ¨è§†å›¾å˜åŒ–ã€‚Reanimated æ˜¯ä¸“é—¨ç”¨æ¥å¤„ç†åŠ¨ç”»å½¢å¼çš„è§†å›¾æ›´æ–°çš„ï¼Œè€Œ State æ˜¯ä¸“é—¨ç”¨æ¥å¤„ç†ç»„ä»¶ã€é¡µé¢æ¸²æŸ“çš„è§†å›¾æ›´æ–°çš„ã€‚

## Reanimated çš„åŸç†

å…³äº Reanimated çš„å…¥é—¨æ¦‚å¿µï¼Œæˆ‘ä»¬å…ˆä»‹ç»åˆ°è¿™é‡Œï¼Œç›¸ä¿¡é€šè¿‡ Reanimated å’Œ State çš„ç±»æ¯”å­¦ä¹ ï¼Œä½ å·²ç»èƒ½æŠŠ Reanimated ç”¨èµ·æ¥äº†ã€‚

ä½†è¿™ç§å­¦ä¹ æ–¹å¼éš¾å…å¯èƒ½è®©ä½ å¯¹æ¦‚å¿µæŒæ¡å¾—ä¸å¤Ÿå‡†ç¡®ï¼Œç”šè‡³å‡ºç°ä¸€äº›ç†è§£åå·®ã€‚æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬è¦å†è¿›ä¸€æ­¥ï¼Œäº†è§£Reanimated å·¥ä½œåŸç†ï¼ŒæŠŠå…¶ä¸­çš„åŸºç¡€æ¦‚å¿µå¼„æ‰å®äº†ï¼ŒæŠŠä¸€äº›ç†è§£æœ‰è¯¯çš„åœ°æ–¹çº æ­£å›æ¥ã€‚

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çš„åŠ¨ç”»ä»£ç å’ŒçŠ¶æ€ä»£ç éƒ½æ˜¯ç”¨ JavaScript å†™åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­çš„ï¼Œä½ å¯èƒ½ä¼šè®¤ä¸ºä½ å†™çš„åŠ¨ç”»éƒ¨åˆ†çš„ JavaScript å’ŒçŠ¶æ€éƒ¨åˆ†çš„ JavaScript éƒ½æ˜¯è¿è¡Œåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„ï¼Œä½†å…¶å®å¹¶ä¸æ˜¯è¿™æ ·çš„ã€‚

å¬åˆ°è¿™ä¸ªç»“è®ºï¼Œä½ å¯èƒ½ä¼šå¾ˆæƒŠè®¶ï¼š**ä¸ºä»€ä¹ˆåŠ¨ç”»ä»£ç å’ŒçŠ¶æ€ä»£ç éƒ½æ”¾åœ¨åŒä¸€ä¸ªJavaScript æ–‡ä»¶ä¸­ï¼Œä½†åŠ¨ç”»éƒ¨åˆ†ä»£ç å´ç”±å¦ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œå‘¢ï¼Ÿ**

ç­”æ¡ˆå°±æ˜¯ï¼šæŠŠåŠ¨ç”»ä»£ç æ”¾åˆ° UI ä¸»çº¿ç¨‹æ¥æ‰§è¡Œæ€§èƒ½ä¼šæ›´å¥½ï¼ŒåŠ¨ç”»ä¸å®¹æ˜“å¡é¡¿ã€‚

ä½ å¯èƒ½çŸ¥é“ï¼Œ React Native æœ‰ä¸¤ä¸ªå¸¸ç”¨çš„çº¿ç¨‹ï¼šä¸€ä¸ªæ˜¯ React Native çš„ JavaScript çº¿ç¨‹ï¼Œå¦ä¸€ä¸ªæ˜¯ UI ä¸»çº¿ç¨‹ã€‚

ä¸€æ–¹é¢ï¼ŒJavaScript çº¿ç¨‹å’Œ UI ä¸»çº¿ç¨‹æ˜¯å¼‚æ­¥é€šä¿¡çš„ï¼Œè¿™ä¹Ÿæ„å‘³ç€ï¼Œå¦‚æœæ˜¯ç”± JavaScript çº¿ç¨‹å‘èµ·åŠ¨ç”»çš„æ‰§è¡Œï¼ŒUI çº¿ç¨‹å¹¶ä¸èƒ½åŒæ­¥åœ°æ”¶åˆ°è¯¥å‘½ä»¤å¹¶ä¸”ç«‹åˆ»æ‰§è¡Œï¼ŒUI çº¿ç¨‹è‡³å°‘è¦å¤„ç†å®Œæˆå½“å‰ä¸€å¸§çš„æ¸²æŸ“ä»»åŠ¡åï¼Œæ‰ä¼šæ‰§è¡Œ JavaScript çº¿ç¨‹çš„åŠ¨ç”»å‘½ä»¤ã€‚ä¹Ÿå°±æ˜¯è¯´å¼‚æ­¥é€šè®¯ä¼šå¯¼è‡´åŠ¨ç”»è‡³å°‘å»¶è¿Ÿ 1 å¸§ã€‚

å¦ä¸€æ–¹é¢ï¼ŒJavaScript çº¿ç¨‹å¤„ç†çš„äº‹ä»¶å¾ˆå¤šï¼ŒåŒ…æ‹¬æ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘ã€React Diffã€äº‹ä»¶å“åº”ç­‰ç­‰ï¼Œå®¹æ˜“æŠ¢å åŠ¨ç”»çš„æ‰§è¡Œèµ„æºã€‚

**æ­£å› ä¸º JavaScript çº¿ç¨‹éå¸¸ç¹å¿™ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æŠŠåŠ¨ç”»ä»£ç äº¤ç”± JavaScript çº¿ç¨‹æ‰§è¡Œï¼Œå®ƒå°±ä¼šæ›´åŠ ç¹å¿™ã€‚**å‰é¢æˆ‘ä»¬ä¹Ÿè®²è¿‡ï¼Œå¤„ç† 1 å¸§åŠ¨ç”»çš„è€—æ—¶éœ€è¦æ§åˆ¶åœ¨ 16.6ms ä»¥å†…ï¼Œå¦‚æœè¶…è¿‡ 16.6ms å°±ä¼šå¯¼è‡´åŠ¨ç”»æ‰å¸§ï¼Œæ‰å¸§ä¸¥é‡çš„æ—¶å€™ï¼Œç”¨æˆ·å°±ä¼šæ„Ÿè§‰åˆ°å¡é¡¿ã€‚

å¥½ï¼Œæ—¢ç„¶åŠ¨ç”»éƒ¨åˆ†çš„ JavaScript ä»£ç æ”¾åœ¨ JavaScript çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå­˜åœ¨è‡³å°‘1å¸§çš„å»¶è¿Ÿï¼Œå¹¶ä¸”å®¹æ˜“å¯¼è‡´å¡é¡¿ã€‚é‚£æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

æœ‰ä¸¤ç§æ€è·¯ã€‚

**ç¬¬ä¸€ç§æ€è·¯å°±æ˜¯React Native è‡ªå¸¦çš„ Animated åŠ¨ç”»åº“ç”¨çš„æ€è·¯**ã€‚å®ƒæ˜¯åœ¨ç»„ä»¶åˆå§‹åŒ–æ—¶ï¼ŒæŠŠåŠ¨ç”»çš„åˆå§‹å€¼ã€åŠ¨ç”»çš„å½¢å¼ã€åŠ¨ç”»çš„ç»“æŸå€¼ç­‰é…ç½®éƒ½ä¼ ç»™ UI ä¸»çº¿ç¨‹ã€‚å¼€å‘è€…æœ‰ä¸ªå¼€å¯ UI ä¸»çº¿ç¨‹æ‰§è¡ŒåŠ¨ç”»ä»»åŠ¡çš„å¼€å…³ useNativeDriverï¼Œå½“å¼€å‘è€…å¼€å¯ useNativeDriver è¿™ä¸ªå¼€å…³åï¼ŒåŠ¨ç”»å°±æ˜¯åœ¨ UI ä¸»çº¿ç¨‹æ‰§è¡Œäº†ã€‚

ä½†æ˜¯ Animated åŠ¨ç”»åº“çš„ç¼ºé™·ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå®ƒä¼ ç»™ UI ä¸»çº¿ç¨‹çš„æ˜¯åŠ¨ç”»é…ç½®ã€‚é…ç½®åªæ˜¯å•çº¯çš„æ•°æ®ï¼Œå®ƒä¸å…·å¤‡å›¾çµå®Œå¤‡çš„ç‰¹æ€§ï¼Œä¸èƒ½é…ç½®å¤æ‚çš„é€»è¾‘ã€‚æ‰€ä»¥React Native å®˜æ–¹ä¹ŸæŒ‡å‡ºäº†ï¼šAnimated ä¸èƒ½ç”¨æ¥æ”¹å˜å…ƒç´ å®½åº¦ã€é«˜åº¦ç­‰å¸ƒå±€å±æ€§ï¼Œä¸èƒ½å¤„ç†é™¤äº† ScrollView ç»„ä»¶çš„ onScroll äº‹ä»¶å¤–çš„å…¶ä»–æ‰‹åŠ¿äº‹ä»¶ã€‚

æ¢å¥è¯è¯´ï¼Œåœ¨ä¿éšœæ€§èƒ½çš„å‰æä¸‹ï¼Œç®€å•çš„åŠ¨ç”»ã€æ— äº¤äº’çš„åŠ¨ç”»ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è‡ªå¸¦çš„ Animated åŠ¨ç”»åº“æ¥å¤„ç†ï¼›å¦‚æœæ˜¯é€»è¾‘ç¨å¾®å¤æ‚ç‚¹çš„ã€å¸¦äº¤äº’çš„åŠ¨ç”»ï¼Œè‡ªå¸¦çš„ Animated åŠ¨ç”»åº“å°±å¹²ä¸äº†äº†ã€‚

é‚£ Reanimated åŠ¨ç”»åº“èƒ½å¤Ÿå¤„ç†å¤æ‚åŠ¨ç”»ã€æœ‰äº¤äº’çš„åŠ¨ç”»å—ï¼Ÿå®ƒæ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ

å¯ä»¥ã€‚Reanimated åŠ¨ç”»åº“é‡‡ç”¨äº†å¦ä¸€ç§æ€è·¯ï¼Œå®ƒæŠŠåŠ¨ç”»ç›¸å…³çš„ JavaScript å‡½æ•°åŠå…¶ä¸Šä¸‹æ–‡ä¼ ç»™äº† UI ä¸»çº¿ç¨‹ã€‚ä¸è¿‡ï¼ŒUI ä¸»çº¿ç¨‹å¹¶æ²¡æœ‰èƒ½è¿è¡Œ JavaScript å‡½æ•°çš„è™šæ‹Ÿæœºï¼Œäºæ˜¯ Reanimated åˆåˆ›å»ºäº†ä¸€ä¸ª JavaScript è™šæ‹Ÿæœºæ¥è¿è¡Œä¼ è¿‡æ¥çš„ JavaScript å‡½æ•°ã€‚

æ¢å¥è¯è¯´ï¼Œåœ¨ä½¿ç”¨ Reanimated ä¹‹å‰ï¼ŒReact Native åªä¼šåœ¨ JavaScript çº¿ç¨‹åˆ›å»ºä¸€ä¸ª JavaScript è™šæ‹Ÿæœºï¼Œæ¥è¿è¡Œ JavaScript ä»£ç ã€‚è€Œä½¿ç”¨ Reanimated ä¹‹åï¼ŒReanimated ä¼šåœ¨ UI ä¸»çº¿ç¨‹ä¸­åˆ›å»ºå¦ä¸€ä¸ª JavaScript è™šæ‹Ÿæœºæ¥è¿è¡ŒåŠ¨ç”»éƒ¨åˆ†ç›¸å…³çš„ä»£ç ã€‚

æˆ‘ç»™ä½ ç”»äº†ä¸€å¼  Reanimated çš„åŸç†å›¾ï¼Œä½ å¯ä»¥çœ‹ä¸‹ï¼ŒåŠ æ·±ä¸€ä¸‹ç†è§£ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/70/76/70de3bd8fa6af059a0abe3c7a1db2376.png?wh=1920x944)

åœ¨è¿™å¼ åŸç†å›¾ä¸­ï¼Œä½ ä¼šçœ‹åˆ°æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼šJavaScript çº¿ç¨‹å’Œ UI çº¿ç¨‹ã€‚

åœ¨ JavaScript çº¿ç¨‹ä¸­åŒ…æ‹¬äº†ä¸‰ä¸ªåŠ¨ç”»ç›¸å…³çš„å‡½æ•°æˆ–å€¼ï¼Œ[useSharedValue](https://github.com/software-mansion/react-native-reanimated/blob/65a31e473b4e9fa4bee83de01e807039f71b7666/src/reanimated2/hook/useSharedValue.ts#L16)ï¼ˆå…¶åº•å±‚ä¼šè°ƒç”¨ [cancelAnimation](https://github.com/software-mansion/react-native-reanimated/blob/65a31e473b4e9fa4bee83de01e807039f71b7666/src/reanimated2/animation/util.ts#L264-L268) ï¼‰ã€[useAnimatedStyle](https://github.com/software-mansion/react-native-reanimated/blob/65a31e473b4e9fa4bee83de01e807039f71b7666/src/reanimated2/hook/useAnimatedStyle.ts#L456-L467) å’Œ [useAnimatedGestureHandler](https://github.com/software-mansion/react-native-reanimated/blob/65a31e473b4e9fa4bee83de01e807039f71b7666/src/reanimated2/hook/useAnimatedGestureHandler.ts#L54-L98)ã€‚è¿™ä¸‰éƒ¨åˆ†çš„ä»£ç ä¼šåœ¨å…¶åº•å±‚ï¼Œå°†ç›¸å…³çš„å›è°ƒå‡½æ•°æ ‡è®°ä¸ºâ€œworkletâ€ ï¼Œè¢«æ ‡è®°çš„â€œworkletâ€ å‡½æ•°æˆ–å€¼ä¼šè¢«æ”¾åœ¨ä¸€ä¸ªç”± Reanimated åˆ›å»ºçš„ JavaScript è™šæ‹Ÿæœºä¸­æ‰§è¡Œã€‚

è€Œè¿™ä¸ªç”± Reanimated åˆ›å»ºçš„ JavaScript è™šæ‹Ÿæœºï¼Œä¼šåœ¨ UI çº¿ç¨‹ä¸­æ‰§è¡Œä¼ è¿‡æ¥çš„â€œworkletâ€ å‡½æ•°ï¼Œå¹¶ä¸”æ‰§è¡Œçš„å‡½æ•°è¿˜å¯ä»¥åŒæ­¥åœ°æ“ä½œ UIã€‚

**é‚£ JavaScript çº¿ç¨‹å’Œ UIä¸»çº¿ç¨‹æ˜¯æ€ä¹ˆé…åˆå·¥ä½œçš„å‘¢ï¼Ÿ**

æˆ‘ä»¬ç»“åˆå®½åº¦åˆ‡æ¢åŠ¨ç”»çš„ä»£ç ç¤ºä¾‹ï¼Œæ¥çœ‹ä¸‹åŸç†å›¾ä¸­çš„å„ä¸ªéƒ¨åˆ†æ˜¯æ€ä¹ˆè¿è¡Œçš„ï¼š

```plain
const randomWidth = useSharedValue(10);
const style = useAnimatedStyle(()=>({width: randomWidth.value});

// è¿è¡Œåœ¨ JS çº¿ç¨‹çš„ç‚¹å‡»äº‹ä»¶
const handlePress = () => {
  randomWidth.value = Math.random() * 350;
}
```

åœ¨ JavaScript ä»£ç åˆå§‹åŒ–æ—¶ï¼Œå…ˆæ‰§è¡Œçš„æ˜¯ useSharedValue å‡½æ•°ï¼Œå®ƒä¼šç”Ÿæˆä¸€ä¸ªå…±äº«å€¼å¯¹è±¡ randomWidthã€‚randomWidth å¯¹è±¡ä¸ŠæŒ‚äº†ä¸€ä¸ª value å±æ€§ã€‚è¿™ä¸ª value å±æ€§æ—¢å¯ä»¥åœ¨ JavaScript çº¿ç¨‹è·å–å’Œä¿®æ”¹ï¼Œä¹Ÿå¯ä»¥åœ¨ UI çº¿ç¨‹ä¸­çš„ JavaScript è™šæ‹Ÿæœºä¸­è·å–å’Œä¿®æ”¹ã€‚

ç„¶åæ‰§è¡Œçš„æ˜¯ useAnimatedStyle å‡½æ•°ã€‚useAnimatedStyle çš„å…¥å‚ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ï¼ŒReanimated ä¼šå°† useAnimatedStyle çš„å…¥å‚å‡½æ•°å’Œä¸å®ƒç›¸å…³çš„ä¸Šä¸‹æ–‡éƒ½æ”¾åˆ° UI çº¿ç¨‹ä¸­çš„ JavaScript è™šæ‹Ÿæœºä¸­ã€‚

æœ€åå°±æ˜¯å¤„ç†ç‚¹å‡»äº‹ä»¶äº†ã€‚ä½†ç”±äºè¿™ä¸€è®²ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰æ¥è§¦åˆ°æ‰‹åŠ¿ React Native Gesture Handlerï¼Œæ‰€ä»¥æˆ‘å…ˆç”¨æ™®é€šçš„äº‹ä»¶å¤„ç†å‡½æ•° handlePress æ¥å¤„ç†ç‚¹å‡»äº‹ä»¶äº†ã€‚ä½¿ç”¨æ™®é€šçš„äº‹ä»¶å¤„ç†å‡½æ•°æœ‰ä¸€ä¸ªå¼Šç«¯ï¼šå®ƒæ˜¯åœ¨ JavaScript çº¿ç¨‹ä¸­è§¦å‘çš„ã€‚æ‰€ä»¥ï¼Œå¦‚æœè¦ç”Ÿæˆçš„æ˜¯æŸç§å¯¹äº‹ä»¶çš„å“åº”é€Ÿåº¦æœ‰è¦æ±‚çš„åŠ¨ç”»ï¼Œæ¯”å¦‚æ‹–æ‹½ç±»çš„åŠ¨ç”»ï¼Œå°±å®¹æ˜“å¯¼è‡´å¡é¡¿ã€‚

è§£å†³æ–¹æ¡ˆå°±æ˜¯æŠŠå¤„ç†ç‚¹å‡»äº‹ä»¶çš„å‡½æ•°ï¼Œä¹Ÿæ”¾åˆ° UI çº¿ç¨‹ä¸­ï¼Œè®©ç‹¬ç«‹çš„ JavaScript è™šæ‹Ÿæœºæ¥æ‰§è¡Œã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨ useAnimatedGestureHandler å°†å…¶åŒ…è£…èµ·æ¥ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```plain
// è¿è¡Œ UI çº¿ç¨‹çš„ç‚¹å‡»äº‹ä»¶
const handleAnimatedPress = useAnimatedGestureHandler({
    onEnd: (_) => {
      randomWidth.value = Math.random() * 350;
    },
})
```

ä¸è¿‡ï¼Œä»£ç ä¸­çš„åŠ¨ç”»æ‰‹åŠ¿å¤„ç†å‡½æ•° handleAnimatedPressï¼Œéœ€è¦ç»“åˆ React Native Gesture Handler çš„æ‰‹åŠ¿ç»„ä»¶ä¸€èµ·ä½¿ç”¨ï¼Œå…·ä½“å¦‚ä½•ç»“åˆä½¿ç”¨ï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²å†è®²ã€‚

åœ¨è¿™ä¸€è®²ï¼Œä½ åªéœ€è¦çŸ¥é“ï¼Œæˆ‘ä»¬ä½¿ç”¨ Reanimated ç”ŸæˆåŠ¨ç”»çš„æ—¶å€™ï¼Œåªæœ‰åœ¨ JavaScript ä»£ç åˆå§‹åŒ–æ—¶ï¼Œç›¸å…³çš„åŠ¨ç”»ä»£ç ä¼šåœ¨ JavaScript çº¿ç¨‹æ‰§è¡Œã€‚åˆå§‹åŒ–å®Œæˆåï¼ŒuseSharedValue ç”Ÿæˆçš„å…±äº«å€¼æ˜¯åœ¨ JavaScript çº¿ç¨‹å’Œ UI çº¿ç¨‹çš„ JavaScript è™šæ‹Ÿæœºä¸­å…±äº«çš„ã€‚

å¹¶ä¸”ï¼Œåœ¨åˆå§‹åŒ–å®Œæˆåï¼ŒuseAnimatedStyle çš„æ ·å¼å…¥å‚å‡½æ•°å’Œ useAnimatedGestureHandler çš„æ‰‹åŠ¿å‡½æ•°ï¼Œä»¥åŠç›¸å…³çš„ä¸Šä¸‹æ–‡éƒ½ä¼šæ”¾åˆ° UI çº¿ç¨‹ä¸­çš„ JavaScript è™šæ‹Ÿæœºä¸­å»ã€‚

ç®€è€Œè¨€ä¹‹ï¼ŒReanimated åŠ¨ç”»æ€§èƒ½å¥½çš„åŸå› å°±åœ¨äºï¼ŒReact Native çš„ JavaScript çº¿ç¨‹æ˜¯æ€§èƒ½ç“¶é¢ˆç‚¹ï¼Œè€Œ UI çº¿ç¨‹ä¸æ˜¯ï¼Œ**åœ¨ Reanimated çœŸæ­£æ‰§è¡ŒåŠ¨ç”»æ—¶ï¼Œä½ å·²ç»æŠŠæ‰€æœ‰ä¸åŠ¨ç”»ç›¸å…³ JavaScript å‡½æ•°éƒ½æ”¾åˆ°äº† UI çº¿ç¨‹ä¸­ç‹¬ç«‹çš„ JavaScript è™šæ‹Ÿæœºä¸­äº†ï¼Œå¹¶ä¸ä¼šå’Œ JavaScript çº¿ç¨‹æŠ¢å ç¡¬ä»¶èµ„æºï¼Œå› æ­¤ Reanimated æ‰§è¡ŒåŠ¨ç”»çš„æ€§èƒ½ä¼šæ›´å¥½ã€‚**

## é™„åŠ ææ–™

1. å®˜æ–¹çš„å‡ ä¸ªå…¥é—¨è§†é¢‘éƒ½æ˜¯ 1 ä¸ªå°æ—¶ä»¥ä¸Šçš„ï¼Œæˆ‘ä¸ºä½ é€‰äº†ä¸€ä¸ª 17 åˆ†é’Ÿå…¥é—¨çš„è§†é¢‘[ã€ŠIntroduction to React Native Reanimated 2ã€‹](https://www.youtube.com/watch?v=yz9E10Dq8Bg)ï¼Œå¯ä»¥å¸®ä½ å¿«é€Ÿå…¥é—¨ã€‚
2. å…¥é—¨ä¹‹åï¼Œå»ºè®®ä½ å†çœ‹çœ‹å®˜æ–¹çš„æ–‡ç« ï¼Œå®ƒä¼šå¸®ä½ æ›´å¥½çš„ç†è§£ Reanimated2 çš„ [åŸç†](https://docs.swmansion.com/react-native-reanimated/docs/)ã€‚
3. é™¤äº† [useAnimatedStyle](https://docs.swmansion.com/react-native-reanimated/docs/api/hooks/useAnimatedStyle) ã€[useAnimatedStyle](https://docs.swmansion.com/react-native-reanimated/docs/api/hooks/useAnimatedStyle) å’Œ [useAnimatedGestureHandler](https://docs.swmansion.com/react-native-reanimated/docs/api/hooks/useAnimatedGestureHandler) ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›é’©å­å‡½æ•°ä¹Ÿå¯ä»¥æŠŠå®ƒçš„å…¥å‚å‡½æ•°æ”¾åˆ° UI çº¿ç¨‹ä¸­æ‰§è¡Œï¼ŒåŒ…æ‹¬ [useDerivedValue](https://docs.swmansion.com/react-native-reanimated/docs/api/hooks/useDerivedValue)ã€[useAnimatedScrollHandler](https://docs.swmansion.com/react-native-reanimated/docs/api/hooks/useAnimatedScrollHandler)ã€[useAnimatedReaction](https://docs.swmansion.com/react-native-reanimated/docs/api/hooks/useAnimatedReaction) å’Œ [useAnimatedProps](https://docs.swmansion.com/react-native-reanimated/docs/api/hooks/useAnimatedProps)ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡æŠŠ [â€œworkletâ€](https://docs.swmansion.com/react-native-reanimated/docs/fundamentals/worklets) å­—é¢é‡æ”¾åˆ°å‡½æ•°é¡¶éƒ¨ï¼Œè¿™æ · Reanimated å°±ä¼šæŠŠè¯¥å‡½æ•°æ”¾åˆ° UI çº¿ç¨‹ä¸­æ‰§è¡Œäº†ã€‚
4. å¸¸è§çš„åŠ¨ç”»æ›²çº¿æœ‰ [withTiming](https://docs.swmansion.com/react-native-reanimated/docs/api/animations/withTiming)ã€[withSpring](https://docs.swmansion.com/react-native-reanimated/docs/api/animations/withSpring)ã€[withDecay](https://docs.swmansion.com/react-native-reanimated/docs/api/animations/withDecay) å’Œ [withDelay](https://docs.swmansion.com/react-native-reanimated/docs/api/animations/withDelay)ï¼Œç”šè‡³ä½ è¿˜å¯ä»¥ä½¿ç”¨ [Easing.bezier](https://docs.swmansion.com/react-native-reanimated/docs/2.2.0/animations/#timing) è‡ªå®šä¹‰åŠ¨ç”»æ›²çº¿ã€‚
5. è¿™èŠ‚è¯¾ä¸­çš„ Demoï¼Œæˆ‘ä¹Ÿæ”¾åˆ°äº† [GitHub](https://github.com/jiangleo/react-native-classroom/tree/main/src/14_Animated) ä¸Šã€‚

## æ€»ç»“

å¯¹äºäº¤äº’ç±»çš„åŠ¨ç”»ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§é€‰æ‹©ï¼Œä¸€ç§æ˜¯ React Native è‡ªå¸¦çš„ Animated åŠ¨ç”»åº“ï¼Œå¦ä¸€ç§æ˜¯ç¤¾åŒºçš„ Reanimated åŠ¨ç”»åº“ã€‚

ä¸ºäº†å®ç°æµç•…çš„åŠ¨ç”»æ•ˆæœï¼ŒäºŒè€…éƒ½æŠŠåŸæœ¬æ¥ JavaScript çº¿ç¨‹æ‰§è¡Œçš„åŠ¨ç”»ä»»åŠ¡ï¼Œæ”¾åˆ°äº† UI çº¿ç¨‹ä¸­æ¥æ‰§è¡Œã€‚ä¸åŒçš„æ˜¯ï¼Œå®˜æ–¹åŠ¨ç”»åº“é‡‡ç”¨çš„æ˜¯ä¼ é€’åŠ¨ç”»é…ç½®çš„å½¢å¼ï¼Œç¤¾åŒºåŠ¨ç”»åº“é‡‡ç”¨çš„æ˜¯ä¼ é€’ JavaScript å‡½æ•°çš„å½¢å¼ï¼Œå› æ­¤ Reanimated åŠ¨ç”»åº“çš„åº”ç”¨åœºæ™¯æ›´åŠ å¹¿æ³›ã€‚

åœ¨ä»Šå¤©è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä¹Ÿå¸®ä½ ä¹Ÿæ­èµ·äº†ä¸¤åº§çŸ¥è¯†çš„æ¡¥ï¼šä¸€åº§æ¡¥æ˜¯è¿æ¥çš„æ˜¯ Reanimated å’Œ State ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼Œè¿™åº§æ¡¥çš„ç›®çš„æ˜¯å¸®ä½ å¿«é€Ÿå­¦ä¹  Reanimatedï¼›å¦ä¸€åº§æ¡¥è¿æ¥çš„æ˜¯ Reanimated å’Œ React Native æ¶æ„ï¼Œè¿™åº§æ¡¥çš„ç›®çš„æ˜¯å¸®ä½ å¼„æ¸…æ¥š Reanimated çš„åº•å±‚åŸç†ã€‚

é™¤äº†å­¦ä¹  Reanimated æœ¬èº«çŸ¥è¯†å¤–ï¼Œæˆ‘ä¹Ÿå¸Œæœ›ä½ èƒ½æŒæ¡è¿™ç§â€œæ­æ¡¥ä¿®è·¯â€å¼çš„å­¦ä¹ æ–¹æ³•ã€‚ä½ æŒæ¡çš„çŸ¥è¯†ç‚¹è¶Šå¤šï¼Œä½ æ­çš„æ¡¥ã€ä¿®çš„è·¯å°±è¶Šå¤šï¼Œä¸‹æ¬¡ä½ ç¢°åˆ°æ–°çš„çŸ¥è¯†æ—¶ï¼Œä½ å­¦ä¹ çš„é€Ÿåº¦ä¹Ÿå°±è¶Šå¿«ï¼Œè¿›æ­¥ä¹Ÿå°±è¶Šå¿«ã€‚

## ä½œä¸š

1. è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬é€šè¿‡ç‚¹å‡»äº‹ä»¶æ¥è®¾ç½®è§†å›¾çš„å®½åº¦ã€‚è¯·ä½ ä½¿ç”¨ `Animated.ScrollView` å’Œ `useAnimatedScrollHandler` å®ç°é€šè¿‡æ»šåŠ¨æ§åˆ¶è§†å›¾å¤§å°çš„åŠ¨ç”»ã€‚
2. èƒ½è¯´è¯´ä½ åœ¨å·¥ä½œä¸­çš„å“ªäº›åœºæ™¯ä¸­ç”¨åˆ°äº†åŠ¨ç”»å—ï¼Ÿå¸Œæœ›ä½ èƒ½å’Œæˆ‘ä»¬åˆ†äº«ä¸€ä¸‹ä½ ä½¿ç”¨åŠ¨ç”»çš„å¿ƒå¾—ã€‚

æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æƒ³æ³•ã€‚æˆ‘æ˜¯è’‹å®ä¼Ÿï¼Œå’±ä»¬ä¸‹èŠ‚è¯¾è§ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ5ï¼‰</strong></div><ul>
<li><span>WclyğŸ‘º</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯·é—®ç°åœ¨Reanimatedæ”¯æŒRNæ–°æ¶æ„äº†å—ï¼Ÿ</p>2022-11-28</li><br/><li><span>worm</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆæ‚¨å¥½ï¼ŒReanimated æ˜¯å¦‚ä½•æŠŠ JS åŠ¨ç”»ä»£ç æ”¾åˆ° UI ä¸»çº¿ç¨‹çš„ JS è™šæ‹Ÿæœºä¸­çš„å‘¢ï¼Ÿè¿™éƒ¨åˆ†æ˜¯ C++ å®ç°çš„å§ï¼Ÿæœ‰æ²¡æœ‰è¿™éƒ¨åˆ†çš„è®²è§£ææ–™æˆ–è€…å®ç°çš„æºç ä½ç½®ï¼Ÿ</p>2022-05-11</li><br/><li><span>happy</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œé—®ä¸ªé—®é¢˜ã€‚è¢«RNçš„åŠ¨ç”»æŠ“ç‹‚ï¼Œæƒ³å®ç°ä¸€ä¸ªScrollViewï¼Œå†…éƒ¨æœ‰å¾ˆé•¿çš„åˆ—è¡¨ï¼Œç„¶åè¦å®ç°ä¸€ä¸ªåˆ‡æ¢scrollViewçš„é«˜åº¦çš„åŠ¨ç”»ï¼Œå†…å®¹çš„ä¸ä¼šåŠ¨ã€‚æ•´ä½“å°±æ˜¯é«˜åº¦å˜å¤§å˜å°çš„ä¸€ä¸ªåŠ¨ç”»ï¼Œæ„Ÿè§‰éƒ½å¾ˆéš¾å®ç°ã€‚ã€‚ã€‚Animatedæä¾›çš„è²Œä¼¼éƒ½æ˜¯transformä¹‹ç±»çš„åŠ¨ç”»ï¼Œæ²¡æœ‰è®¾ç½®heightçš„è¿™ç§åŠ¨ç”»å—ï¼Ÿ</p>2022-07-29</li><br/><li><span>*****</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æœ‰äººç¢°åˆ°è¿‡ android debug æ—¶ demo  crashå—ï¼Ÿ</p>2024-03-12</li><br/><li><span>è§å­—å¦‚æ™¤</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æˆ‘è®°å¾— react-native-gesture-handler ä¹Ÿæ˜¯ä½¿ç”¨äº† UIçº¿ç¨‹ï¼Œéƒ½äº¤ç»™ UI çº¿ç¨‹ï¼ŒUI çº¿ç¨‹ä¼šä¸ä¼šä¹Ÿâ€œä¸å ªé‡è´Ÿâ€ï¼Ÿ</p>2022-06-08</li><br/>
</ul>