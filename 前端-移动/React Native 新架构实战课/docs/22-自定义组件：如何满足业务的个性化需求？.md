ä½ å¥½ï¼Œæˆ‘æ˜¯ä¼—æ–‡ï¼Œè¿™ä¸€è®²è¿˜æ˜¯ç”±æˆ‘å’Œæƒ å§æ¥è®²è§£ã€‚

ä¸Šä¸€è®²ï¼Œæˆ‘ä»¬è®²äº†å¦‚ä½•æ„å»ºæ··åˆåº”ç”¨ã€‚å½“ç¯å¢ƒé…ç½®ã€è½½ä½“é¡µã€è°ƒè¯•æ‰“åŒ…éƒ½ OK åï¼Œæˆ‘ä»¬å°±è¦å¼€å§‹å¤æ‚ä¸šåŠ¡çš„å¼€å‘äº†ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œé™¤äº†è´Ÿè´£ React Native æ¡†æ¶æœ¬èº«çš„ç»´æŠ¤è¿­ä»£å¤–ï¼Œå¦ä¸€ä¸ªé‡è¦çš„å·¥ä½œå°±æ˜¯é…åˆå‰ç«¯ä¸šåŠ¡ï¼Œå¼€å‘å¯¹åº”çš„ Native ç»„ä»¶ã€‚

é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ç”¨è¿™äº›è‡ªå®šä¹‰çš„ Native ç»„ä»¶å‘¢ï¼Ÿ

æ¯”å¦‚ï¼Œæœ‰æ—¶å€™ App éœ€è¦è®¿é—®å¹³å° APIï¼Œä½† React Native å¯èƒ½è¿˜æ²¡æœ‰ç›¸åº”çš„æ¨¡å—åŒ…è£…ï¼›æˆ–è€…ä½ éœ€è¦å¤ç”¨å…¬å¸å†…çš„ä¸€äº›ç”¨ Java/OC å†™çš„é€šç”¨ç»„ä»¶ï¼Œè€Œä¸æ˜¯ç”¨ JavaScript é‡æ–°å®ç°ä¸€éï¼›åˆæˆ–è€…ä½ éœ€è¦å®ç°æŸäº›é«˜æ€§èƒ½çš„ã€å¤šçº¿ç¨‹çš„ä»£ç ï¼Œè­¬å¦‚å›¾ç‰‡å¤„ç†ã€æ•°æ®åº“ï¼Œæˆ–è€…å„ç§é«˜çº§æ‰©å±•ç­‰ã€‚

å½“ç„¶ï¼Œä½ å¯ä»¥é€šè¿‡å®˜æ–¹æ–‡æ¡£ï¼ˆ[Android](https://reactnative.cn/docs/native-modules-android)/[iOS](https://reactnative.cn/docs/native-modules-ios)ï¼‰ï¼Œå¿«é€Ÿè®¿é—®ä½ çš„åŸç”Ÿæ¨¡å—ã€‚ä½†å®˜æ–¹æ–‡æ¡£æä¾›çš„ä¸»è¦æ˜¯ç®€å•çš„ Demo å’Œæ­¥éª¤ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œä½ å¯èƒ½è¿˜éœ€è¦è‡ªå®šä¹‰ç»„ä»¶çš„æ–¹æ–¹é¢é¢ï¼ŒåŒ…æ‹¬æ–°æ¶æ„å®šä¹‰ç»„ä»¶çš„å…¨æµç¨‹ï¼Œä»¥åŠå®é™…ä¸šåŠ¡ä¸­çš„è¸©å‘æŒ‡å—ç­‰ã€‚

ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä¼šå…ˆå¸¦ä½ è¡¥é½ç»„ä»¶çš„ç›¸å…³åŸºç¡€çŸ¥è¯†ï¼ŒåŒ…æ‹¬ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€ç»„ä»¶ä¼ è¾“æ•°æ®ç±»å‹ï¼Œå¹¶ä»¥æ–°æ¶æ„çš„TurboModule å’Œ Fabric ä¸ºæ¡ˆä¾‹ï¼Œå¸¦ä½ äº†è§£è‡ªå®šä¹‰ç»„ä»¶çš„æ–¹æ–¹é¢é¢ã€‚ä½ ä¹Ÿèƒ½å€Ÿæ­¤å¯¹React Nativeæ–°æ¶æ„å»ºç«‹èµ·åˆæ­¥è®¤è¯†ã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬å…ˆäº†è§£ä¸‹æœŸå¾…å·²ä¹…çš„ React Native æ–°æ¶æ„ã€‚

## æ–°æ¶æ„ä»‹ç»

æˆ‘ä»¬ç°åœ¨å…ˆé€šè¿‡ä¸‹é¢è¿™å¼ å›¾ç®€å•å¯¹æ¯”ä¸‹æ–°è€æ¶æ„ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/3e/31/3eb92714433185cd0a095yy2e1a36331.jpg?wh=1920x932)

æ–°æ¶æ„å˜æ›´ç‚¹ä¸»è¦åœ¨ä¸‹é¢è¿™å‡ ä¸ªæ–¹é¢ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/4d/8d/4df0702732be0a4922444d575980828d.png?wh=1894x1216)

å‰é¢ä¹Ÿè¯´äº†ï¼Œæˆ‘ä»¬ä¸€è®²å°†ä»¥ TurboModule å’Œ Fabric ä¸ºæ¡ˆä¾‹å¯¹è‡ªå®šä¹‰ç»„ä»¶è¿›è¡Œè®²è§£ã€‚æ‰€ä»¥ä½ ç°åœ¨éœ€è¦å¯¹æ–°æ¶æ„æœ‰ä¸€ä¸ªåˆæ­¥çš„è®¤è¯†ï¼Œç‰¹åˆ«æ˜¯è¦æ³¨æ„ï¼ŒTurboModule å’Œ Fabric å¯¹æ¯”æ—§ç‰ˆçš„ Native Module å’Œ UIManager æœ‰å“ªäº›å·®å¼‚å’Œä¼˜åŠ¿ã€‚

å¦‚æœä½ è¿˜æƒ³äº†è§£æ–°æ¶æ„çš„æ›´å¤šä¿¡æ¯ï¼Œä½ å¯ä»¥å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://reactnative.dev/docs/new-architecture-intro)ã€‚è¿™é‡ŒåŒ…æ‹¬äº†æ–°æ¶æ„ä»‹ç»ã€å¦‚ä½•åœ¨ Androidã€iOS ä¸Šå¼€å¯æ–°æ¶æ„ã€å¦‚ä½•åœ¨ Androidã€iOS ä¸Šå¼€å¯ä½¿ç”¨ TurboModule å’Œ Fabricç­‰ã€‚ä½ ä¹Ÿå¯ä»¥æ ¹æ®å®˜æ–¹æ–‡æ¡£è¯•ç€ç¼–è¯‘è¿è¡Œæ–°æ¶æ„ã€‚

è€Œä¸”ï¼Œ[react-native-screens](https://github.com/software-mansion/react-native-screens)ã€[react-native-gesture-handler](https://github.com/software-mansion/react-native-gesture-handler) ç­‰çŸ¥å React Native åº“çš„æ–°ç‰ˆéƒ½å·²é€‚é…äº†æ–°æ¶æ„ï¼Œæ„Ÿå…´è¶£çš„è¯ï¼Œä½ å¯ä»¥å»äº†è§£ä¸‹ã€‚

å¥½çš„ï¼Œç°åœ¨æˆ‘ä»¬è¿›å…¥è¿™ä¸€è®²çš„æ­£é¢˜ï¼Œå…ˆæ¥äº†è§£ä¸€ä¸‹ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚

## ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ

ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼ŒæŒ‡çš„æ˜¯åœ¨ç»„ä»¶åˆ›å»ºã€æ›´æ–°ã€é”€æ¯çš„è¿‡ç¨‹ä¸­ä¼´éšçš„å„ç§å„æ ·çš„å‡½æ•°æ‰§è¡Œã€‚è¿™äº›åœ¨ç»„ä»¶ç‰¹å®šçš„æ—¶æœŸè¢«è§¦å‘çš„å‡½æ•°ï¼Œç»Ÿç§°ä¸ºç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚

è®©ç»„ä»¶æ‹¥æœ‰ç”Ÿå‘½å‘¨æœŸï¼Œæˆ‘ä»¬å°±å¯ä»¥æ›´å¥½åœ°ç®¡ç†ç»„ä»¶çš„çŠ¶æ€ã€å†…å­˜ï¼Œè·Ÿéšè½½ä½“é¡µçš„ç”Ÿå‘½å‘¨æœŸåšç›¸åº”çš„å¤„ç†ã€‚

### Android

åœ¨Androidç«¯ï¼Œä¸€ä¸ª Module ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬ï¼š

```plain
æ„é€  -> åˆå§‹åŒ– -> onHostResume() -> onHostPause() -> onHostDestroy()
```

è¿™å‡ ä¸ªç”Ÿå‘½å‘¨æœŸçš„æ„æ€æ˜¯ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/1b/1b/1bdfff7c48055490ce06ab49eff5f01b.png?wh=1824x1110)

å¦‚æœä½ ä¸ç†Ÿæ‚‰ Android Activity/Fragment ç”Ÿå‘½å‘¨æœŸï¼Œé‚£ä½ å¯ä»¥çœ‹ä¸‹[è¿™ç¯‡æ–‡ç« ](https://www.jianshu.com/p/1b3f829810a1)åŠ æ·±ä¸‹ç†è§£ã€‚

é‚£ä¹ˆå¦‚ä½•è®© Native Module å…·å¤‡ç”Ÿå‘½å‘¨æœŸå‘¢ï¼Ÿ

React Native ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ¥å£ï¼šcom.facebook.react.bridge.LifecycleEventListenerã€‚æˆ‘ä»¬åªéœ€è¦åœ¨ç»„ä»¶ä¸­æ·»åŠ è¿™ä¸ªæ¥å£çš„æ³¨å†Œå’Œå–æ¶ˆæ³¨å†Œï¼Œå°±å¯ä»¥è®©ç»„ä»¶å…·å¤‡ç”Ÿå‘½å‘¨æœŸäº†ã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œä¸è¦å¿˜è®°åœ¨ onHostDestroy() ä¸­ç§»é™¤æ³¨å†Œï¼Œå¦åˆ™ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```plain
public class TestJavaModule extends ReactContextBaseJavaModule 
 implements LifecycleEventListener, ReactModuleWithSpec, TurboModule {
    public TestJavaModule(ReactApplicationContext reactContext) {
       super(reactContext.real());
       reactContext.addLifecycleEventListener(this);
    }

    @Override
    public String getName() {
       return getClass().getSimpleName();
    }

    @Override
    public void onHostResume() {
    }

    @Override
    public void onHostPause() {
    }

    @Override
    public void onHostDestroy() {
       getReactApplicationContext().removeLifecycleEventListener(this); 
    }
}
```

å…¶å®ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸåŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯è§‚å¯Ÿè€…æ¨¡å¼ã€‚å½“è½½ä½“é¡µè§¦å‘è‡ªèº«çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒæ—¶ï¼Œè°ƒç”¨ ReactInstanceManager çš„ onHostXXX() æ–¹æ³•ï¼ŒReactInstanceManager è¿›è€Œè°ƒç”¨ ReactContext çš„å¯¹åº”å›è°ƒã€‚

æ¯”å¦‚è½½ä½“é¡µè°ƒç”¨ onResume() æ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ ReactContext çš„ onHostResume()ï¼Œå†…éƒ¨ä¼šéå†æ³¨å†Œçš„äº‹ä»¶è¿›è¡Œå›è°ƒï¼š

```plain
public void onHostResume(@Nullable Activity activity) {
    Iterator iterator = this.mLifecycleEventListeners.iterator();
    while(iterator.hasNext()) {
        LifecycleEventListener listener = (LifecycleEventListener) iterator.next();
        // è§‚å¯Ÿè€…æ¨¡å¼ï¼Œè½½ä½“é¡µæ—¶è°ƒç”¨å·²æ³¨å†Œç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒ
        listener.onHostResume();
    }
}
```

ä»¥ä¸Šå°±æ˜¯ Android ç«¯ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„è®²è§£ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ iOS ç«¯ã€‚

### iOS

iOSä¸­ NativeModules ç»„ä»¶çš„åˆ›å»ºé”€æ¯æ—¶æœºï¼Œä¸bridgeçš„åˆ›å»ºé”€æ¯æ—¶æœºå®Œå…¨ä¸€è‡´ï¼š

- allocï¼šåˆ›å»ºå½“å‰ç»„ä»¶ï¼›
- deallocï¼šé”€æ¯å½“å‰ç»„ä»¶ã€‚

åˆ›å»ºä¸€ä¸ªç»„ä»¶TestNativeModuleï¼Œé€šè¿‡RCT\_EXPORT\_MODULE() å£°æ˜ç»„ä»¶ï¼Œé»˜è®¤ä¼šæ ¹æ®ç±»åå£°æ˜ç»„ä»¶åï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡åœ¨å‚æ•°ä¸­ä¼ å…¥å…¶ä»–å­—ç¬¦ä¸²ä½œä¸ºç»„ä»¶çš„åã€‚

```plain
@implementation TestNativeModule
RCT_EXPORT_MODULE()

- (instancetype)init{
Â  self = [super init];
Â  return self;
}
- (void)dealloc{
  NSLog(@"dealloc");
}
```

è€Œ **TurboModule** ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå´ä¸ NativeModule ä¸åŒã€‚TurboModule é‡‡ç”¨æ‡’åŠ è½½æ¨¡å¼ï¼Œåœ¨ Bridge åˆ›å»ºåé¡µé¢ä¸­ç¬¬ä¸€æ¬¡ import å½“å‰TurboModule ï¼Œä¹Ÿå°±æ˜¯ JavaScript ç«¯é€šè¿‡ **TurboModuleRegistry.getEnforcing**æ–¹æ³•åŠ è½½ç»„ä»¶æ—¶ï¼Œ Native ä¼šåˆ›å»ºå¯¹åº”çš„ TurboModule å¹¶è¿›è¡Œç¼“å­˜ã€‚å¦‚æœ JS ç«¯æ²¡æœ‰åŠ è½½å½“å‰è‡ªå®šä¹‰ç»„ä»¶ï¼Œè¯¥ç»„ä»¶å°±ä¸ä¼šè¿›è¡Œåˆå§‹åŒ–ã€‚

JS ç«¯åŠ è½½ç»„ä»¶æ–¹å¼å¦‚ä¸‹ï¼š

```plain
export default (TurboModuleRegistry.getEnforcing<Spec>(
   'TestTurboModule')
  : Spec);
```

è€ŒTurboModule çš„é”€æ¯æ—¶æœºä¸ Bridge çš„é”€æ¯æ—¶æœºä¸€è‡´ã€‚ Bridge è¿›è¡Œé”€æ¯æ—¶ä¼šå‘é€ä¸€ä¸ª RCTBridgeDidInvalidateModulesNotification é€šçŸ¥ï¼ŒTurboModuleManagerä¼šç›‘å¬è¯¥äº‹ä»¶ï¼Œä¾æ¬¡å¯¹æ‰€æœ‰å·²åˆ›å»ºçš„ TurboModule è¿›è¡Œé”€æ¯ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```plain
- (void)bridgeDidInvalidateModules:(NSNotification *)notification
{
Â  RCTBridge *bridge = notification.userInfo[@"bridge"];
Â  if (bridge != _bridge) {
Â  Â  return;
Â  }
Â  [self _invalidateModules];//é”€æ¯æ‰€æœ‰TurboModules
}
```

äº†è§£å®Œäº†ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹ç»„ä»¶çš„ä¼ è¾“æ•°æ®ç±»å‹ã€‚åœ¨ç»„ä»¶è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒNative ä¸ JavaScript ä¸å¯é¿å…åœ°éœ€è¦è¿›è¡Œæ•°æ®äº¤äº’ï¼Œå¦‚ JavaScript è°ƒç”¨ç»„ä»¶æ–¹æ³•ä¼ å…¥æ•°æ®ï¼ŒNative å‘ JavaScript å›ä¼ ç»“æœï¼Œè€Œ React Native ä¹Ÿå¸®æˆ‘ä»¬å°è£…å¥½äº†å¯¹åº”çš„æ•°æ®ç±»å‹ã€‚

## ç»„ä»¶ä¼ è¾“æ•°æ®ç±»å‹

åœ¨ Native ä¸ JavaScript é€šä¿¡çš„è¿‡ç¨‹ä¸­ï¼Œç»„ä»¶éœ€è¦è·å–è¾“å…¥å‚æ•°ã€å›ä¼ ç»“æœï¼Œå¯¹æ­¤ React Native ç»™æˆ‘ä»¬åŒ…è£…äº†ç›¸åº”çš„æ•°æ®ç±»å‹ï¼Œæ–¹ä¾¿å¿«é€Ÿæ“ä½œï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªDemoæ¥ç®€å•äº†è§£ä¸‹ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬è®©JavaScriptç«¯è°ƒç”¨ TestModule çš„ testMethod æ–¹æ³•ï¼Œä¼ å…¥å‚æ•° type å’Œ messageï¼Œæ¥æ”¶ native å›ä¼ æ•°æ®ï¼š

```plain
NativeModules.TestModule.testMethod({type: 1, message: "fromJS"}, (result)=>{
    console.info(result);
  }
);
```

ç„¶åæˆ‘ä»¬æ¥çœ‹TestModule åœ¨ Androidã€iOS ä¾§çš„å®ç°ã€‚å…ˆæ¥çœ‹ Android ç«¯æ˜¯æ€ä¹ˆåšçš„ã€‚

ä¸è¿‡ï¼Œåœ¨å®ç° TestModule ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸‹ Android ç«¯çš„ç»„ä»¶ä¼ è¾“æ•°æ®ç±»å‹ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/61/87/615f0162574e42c30557a1356472ee87.png?wh=744x924)

è¿™é‡Œä½ è¦æ³¨æ„ï¼Œæ•°å­—ç±»å‹æœ‰ç‚¹ç‰¹æ®Šã€‚å› ä¸º JavaScript ä¸æ”¯æŒ long 64 ä½é•¿ç±»å‹ï¼Œåªæ”¯æŒ int (32)å’Œdoubleï¼Œæ‰€ä»¥å¯¹äºé•¿æ•°å­—ï¼ŒJavaScriptç«¯ç»Ÿä¸€ç”¨ double è¡¨ç¤ºã€‚é‚£ä¹ˆ Android ç«¯å¦‚ä½•è½¬æ¢æˆè‡ªå·±éœ€è¦çš„æ•°æ®ç±»å‹å‘¢ï¼Ÿ

æˆ‘ä»¬ä»¥ long ä¸ºä¾‹ï¼Œå¯ä»¥è¿™æ ·å‚è€ƒ[å®˜æ–¹issue](https://github.com/facebook/react-native/issues/12506)è¿™æ ·å¤„ç†ï¼š

```plain
double value = readableMap.getDouble(key);
try {
    // åˆ¤æ–­æ˜¯å¦ä¸º long çš„èŒƒå›´: è¶…è¿‡äº† int çš„æœ€å¤§å€¼ä¸”ä¸ºæ•´æ•°
    if (value > Integer.MAX_VALUE && value % 1 == 0) {
        long cv = (long) value;
        // è½¬æ¢æˆ long å‹è¿”å›
    }
} catch (Exception e) {
    // å¼‚å¸¸æ—¶ï¼Œä»ä½¿ç”¨ double
}
```

è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å…ˆå°† JavaScript ä¼ å…¥çš„æ•°å€¼ç»Ÿä¸€ä»¥åŒç²¾åº¦æµ®ç‚¹æ•° double æ¥è·å–ã€‚è·å–å®Œåï¼Œåˆ¤æ–­è¿™ä¸ªå€¼æ˜¯å¦è¶…å‡ºäº†æ•´æ•°çš„æœ€å¤§å€¼ä¸”ä¸ä¸ºå°æ•°ï¼Œæ¡ä»¶ç¬¦åˆå°±å°†å®ƒè½¬æ¢æˆé•¿æ•´æ•° longï¼Œå¦åˆ™è¿˜æ˜¯ä»¥ double æ¥è¿”å›ã€‚

äº†è§£å®Œ Android ç«¯çš„ç»„ä»¶æ•°æ®ä¼ è¾“ç±»å‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥å®ç°ä¸Šæ–‡ä¸­çš„ TestModuleäº†ï¼š

```plain
public class TestModule extends ReactContextBaseJavaModule implements ReactModuleWithSpec, TurboModule {
   public TestModule(ReactApplicationContext reactContext) {
      super(reactContext.real());
   }

   @Override
   public String getName() {
      return getClass().getSimpleName();
   }
   
   @ReactMethod
   public void testMethod(ReadableMap data, Callback callback) {
      // è·å– JS çš„è°ƒç”¨è¾“å…¥å‚æ•°
      int type = data.getInt("type");
      String message = data.getString("message");
      // å›ä¼ æ•°æ®ç»™ JS
      WritableMap resultMap = new WritableNativeMap();
      map.putInt("code", 1);
      map.putString("message", "success");
      callback.invoke(resultMap);
   }
}
```

ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº† Native ç»„ä»¶ TestModuleï¼Œå†…éƒ¨å®ç°äº† JavaScript éœ€è¦è°ƒç”¨çš„ testMethod æ–¹æ³•ã€‚æ­¤æ–¹æ³•åŒ…å«ä¸¤ä¸ªå‚æ•°ï¼šReadableMap å’Œ Callbackã€‚ReadableMap ä¸º JavaScript ä¼ å…¥å‚æ•°çš„å­—å…¸ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹åº”çš„ key è·å–åˆ° JavaScript çš„å…¥å‚å€¼ï¼Œè€Œ Callback æ˜¯åœ¨ Native å›ä¼ æ•°æ®æ—¶éœ€è¦ä½¿ç”¨çš„ï¼Œåé¢æˆ‘ä»¬è¿˜æœ‰å¯¹é€šä¿¡æ–¹å¼è¿™éƒ¨åˆ†çš„è®²è§£ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦äº†è§£ä¸€ä¸‹å°±å¥½ã€‚

å…·ä½“å®ç°ä¸Šï¼Œæˆ‘ä»¬æ˜¯é¦–å…ˆè·å– JavaScript è°ƒç”¨ä¼ å…¥çš„ type å’Œ messageï¼Œç„¶åå†é€šè¿‡ WritableMap å†™å…¥æ•°æ®ï¼Œæœ€åé€šè¿‡ callback å›ä¼ ç»™ JavaScriptã€‚

ä»¥ä¸Šå°±æ˜¯ Android ç«¯çš„ React Native è¯»å†™æ•°æ®ç±»å‹ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹ iOS ç«¯ã€‚

iOSç«¯ä¹Ÿæ˜¯ä¸€æ ·ï¼Œåœ¨å®ç°å‰é¢è¿™ä¸ª demo å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆçœ‹ä¸‹ iOS ç«¯æ”¯æŒçš„ä¼ å…¥æ•°æ®ç±»å‹ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/af/f8/afbea1f2yyfa12fec0df7248913d97f8.png?wh=772x956)

é‚£ä¹ˆï¼ŒiOSç«¯ä¸­æ˜¯å¦‚ä½•å®ç°ä¸Šæ–‡ä¸­çš„TestModuleçš„å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥åœ¨Moduleä¸­è¿›è¡Œcallbackï¼Œç„¶åé€šè¿‡NSArrayæ¥è¿”å›ï¼Œå¦‚ä¸‹ï¼š

```plain
RCT_EXPORT_METHOD(getValueWithCallback : (RCTResponseSenderBlock)callback){
Â  if (!callback) {
Â  Â  return;
Â  }
Â  callback(@[ @"value from callback!" ]);
}

```

ä¸è¿‡ï¼Œæˆ‘ä»¬è¿™ä¸ªç»„ä»¶æ¡ˆä¾‹ï¼Œåªæ˜¯æ¼”ç¤ºäº† Native å¯ä»¥é€šè¿‡ callback å‘ JavaScript å›ä¼ æ•°æ®ã€‚é‚£ä¹ˆé™¤äº† callbackï¼ŒReact Native ä¸åŸç”Ÿè¿˜æœ‰ä»€ä¹ˆé€šä¿¡æ–¹å¼å‘¢ï¼Ÿ

## React Native ä¸åŸç”Ÿçš„é€šä¿¡æ–¹å¼

æ€»ä½“æ¥è¯´ï¼Œnative å‘ JavaScript ä¼ é€’æ•°æ®çš„æ–¹å¼åˆ†æˆä»¥ä¸‹ä¸‰ç§ï¼š

- Callbackï¼šç”± JavaScript ä¸»å¯¼è§¦å‘ï¼ŒNative è¿›è¡Œå›ä¼ ï¼Œä¸€æ¬¡è§¦å‘åªèƒ½ä¼ é€’ä¸€æ¬¡ï¼›
- Promiseï¼šç”± JavaScript ä¸»å¯¼è§¦å‘ï¼ŒNative è¿›è¡Œå›ä¼ ï¼Œä¸€æ¬¡è§¦å‘åªèƒ½ä¼ é€’ä¸€æ¬¡ã€‚Promise æ˜¯ ES6 çš„æ–°ç‰¹æ€§ï¼Œç±»ä¼¼ RXJava çš„é“¾å¼è°ƒç”¨ã€‚Promise æœ‰ä¸‰ç§çŠ¶æ€ï¼Œåˆ†åˆ«æ˜¯pending (è¿›è¡Œæ—¶)ã€resolve (å·²å®Œæˆ)ã€reject (å·²å¤±è´¥)ï¼›
- å‘é€äº‹ä»¶ï¼šç”± Native ä¸»å¯¼è§¦å‘ï¼Œå¯ä¼ é€’å¤šæ¬¡ï¼Œç±»ä¼¼ Android çš„å¹¿æ’­å’Œ iOS çš„é€šçŸ¥ä¸­å¿ƒã€‚

Callback åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­å·²ç»å‡ºç°è¿‡äº†ï¼Œæˆ‘ä»¬é€šè¿‡ callback.invoke(xx) å°±å¯ä»¥å°†æ•°æ®å›ä¼ ç»™ JavaScriptï¼Œä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œè¿™è¾¹æˆ‘ä»¬å°±ä¸å†èµ˜è¿°äº†ã€‚ç°åœ¨æˆ‘ä»¬ä¸»è¦æ¥çœ‹ä¸‹ Promise å’Œå‘é€äº‹ä»¶çš„ç¤ºä¾‹ï¼Œä»¥ä¾¿æ›´å¥½åœ°äº†è§£ React Native å’ŒåŸç”Ÿä¹‹é—´æ˜¯å¦‚ä½•è¿›è¡Œé€šä¿¡çš„ã€‚

**é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸‹Promise ç¤ºä¾‹**ï¼Œæˆ‘ä»¬ä» JavaScript å¦‚ä½•è§¦å‘ã€Native å¦‚ä½•å›ä¼ æ•°æ®ä¸¤æ–¹é¢æ¥è¿›è¡Œè®²è§£ã€‚

é¦–å…ˆï¼ŒJavaScript ç«¯è°ƒç”¨å®¢æˆ·ç«¯å®šä¹‰çš„ SystemPropsModule çš„ getSystemModel æ¥è·å–æ‰‹æœºçš„è®¾å¤‡ç±»å‹ï¼Œè·å–ç»“æœçš„æ–¹å¼ä½¿ç”¨ Promise æ–¹å¼ ï¼ˆthenâ€¦ catchâ€¦ï¼‰ï¼š

```plain
NativeModules.SystemPropsModule.getSystemModel().then(result=> {
  console.log(result);
}).catch(error=> {
   console.log(error);
});
```

ç„¶åï¼ŒNative ç«¯å®šä¹‰ SystemPropsModuleï¼Œå®ç° getSystemModel æ–¹æ³•ï¼Œå†…éƒ¨ä½¿ç”¨ promise è·å–æ‰‹æœºçš„ model æ•°æ®ã€‚ä½¿ç”¨ promise.reolve(xx) ä¸ºæˆåŠŸï¼Œpromise.reject(xx) ä¸ºå¤±è´¥ï¼š

```plain
SystemPropsModuleï¼š
...
@ReactMethod
public void getSystemModel(Promise promise) {
    // å›ä¼ æˆåŠŸï¼Œä½¿ç”¨ resolve
    promise.resolve(Build.MODEL);
}
...
```

**æ¥ä¸‹æ¥çœ‹å‘é€äº‹ä»¶ç¤ºä¾‹**ï¼Œæˆ‘ä»¬ä» JavaScript å¦‚ä½•ç›‘å¬ Native äº‹ä»¶ã€Native å¦‚ä½•å‘é€äº‹ä»¶è¿™ä¸¤æ–¹é¢æ¥è¿›è¡Œè®²è§£ã€‚

é¦–å…ˆï¼ŒJavaScript ç«¯ä½¿ç”¨ EventEmitterManager æ¥æ³¨å†Œ Native çš„äº‹ä»¶ç›‘å¬ã€‚é€šè¿‡ NativeModules è·å– EventEmitterManagerï¼Œéšåä½¿ç”¨å®ƒæ„å»ºå‡º NativeEventEmitterï¼Œæœ€åé€šè¿‡ NativeEventEmitter æ³¨å†Œç›‘å¬ï¼š

```plain
componentWillMount(){
   // æ‹¿åˆ°åŸç”Ÿæ¨¡å—
   var eventEmitterManager = NativeModules.EventEmitterManager;
   const nativeEventEmitter = new NativeEventEmitter(eventEmitterManager);
   const eventEmitterManagerEvent = EventEmitterManager.EventEmitterManagerEvent;
   // ç›‘å¬ Native å‘é€çš„é€šçŸ¥
   this.listener = nativeEventEmitter.addListener(eventEmitterManagerEvent, (data) => 
       console.log("Receive native event: " + data);
   );
}

componentWillUnmount(){
   // ç§»é™¤ç›‘å¬
   this.listener.remove();
}
```

åœ¨ Native ç«¯çš„ä½¿ç”¨åˆ™å¾ˆç®€å•ã€‚æˆ‘ä»¬è·å– RCTDeviceEventEmitter è¿™ä¸ª JSModuleï¼Œä½¿ç”¨ emit æ–¹æ³•å°±å¯ä»¥å‘ JavaScript å‘é€äº‹ä»¶äº†ï¼š

```plain
reactContext.getJSModule(DeviceEventManagerModule.RCTDeviceEventEmitter.class)
  .emit("msg", "say hello");
```

è‡ªå®šä¹‰ç»„ä»¶ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œæˆ‘ä»¬å…ˆä»‹ç»åˆ°è¿™é‡Œã€‚æ¥ä¸‹æ¥è¿›å…¥å®æˆ˜é˜¶æ®µï¼Œæˆ‘ä»¬å°†åˆ†åˆ«ä»¥ä¸€ä¸ªæ•°æ®å­˜å– TurboModule å’Œè§†é¢‘æ’­æ”¾ Fabric component çš„æ¡ˆä¾‹ï¼ŒåŠ æ·±ä½ å¯¹è‡ªå®šä¹‰ç»„ä»¶çš„ç†è§£ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹TurboModuleã€‚

## TurboModuleï¼šæ•°æ®å­˜å–

TurboModule é‡‡ç”¨æ‡’åŠ è½½æ¨¡å¼ï¼Œåœ¨è¿è¡Œæ—¶ç¬¬ä¸€æ¬¡ import è¯¥ TurboModule æ—¶ï¼Œ Native ä¼šåˆ›å»ºå¯¹åº”çš„ TurboModule å¹¶è¿›è¡Œç¼“å­˜ã€‚è€Œæ—§ç‰ˆæœ¬çš„ NativeModule éƒ½æ˜¯åœ¨åˆ›å»ºç¯å¢ƒæ—¶ç»Ÿä¸€è¿›è¡Œæ„é€ çš„ï¼Œä¼šå¯¹ React Native çš„å¯åŠ¨æ€§èƒ½æœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ä»¥ä¸€ä¸ªå®é™…çš„æ¡ˆä¾‹æ¥å¸¦ä½ äº†è§£ TurboModuleã€‚å½“ä½ éœ€è¦ä½¿ç”¨ native æ•°æ®å­˜å–ç›¸å…³èƒ½åŠ›ï¼Œå¦‚è·¨è¿›ç¨‹å­˜å–ã€åå¥½å­˜å–ã€åŠ å¯†å­˜å–ç­‰ï¼Œè€Œ React Native è‡ªå¸¦çš„æ•°æ®å­˜å‚¨ module æ»¡è¶³ä¸äº†ä½ çš„éœ€æ±‚ï¼Œä½ å¯ä»¥é€šè¿‡è‡ªå®šä¹‰æ•°æ®å­˜å‚¨çš„ TurboMoudle æ¥å®ç°ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ JavaScript ä¾§ã€‚

### JavaScript

åœ¨ Spec ä¸­å®šä¹‰æ–¹æ³•ï¼Œå®šä¹‰å¥½å­˜å’Œå–çš„æ–¹æ³•åï¼Œå†å¯¼å‡º StorageModuleï¼š

```plain
export interface Spec extends TurboModule {
+save: (key: string, value: string, callback: (value: Object) => void) => void;
+get: (key: string, callback: (value: Object) => void) => void;
}
// å¯¼å‡º StorageModule
export default (TurboModuleRegistry.getEnforcing<Spec>(
'StorageModule',
): Spec);
```

è°ƒç”¨ï¼š

```plain
NativeModules.StorageModule.save("testKey", "testValue", (result)=>{
    console.info(result);
  }
);
NativeModules.StorageModule.get("testKey", (result)=>{
    console.info(result);
  }
);
```

æ¥ä¸‹æ¥æˆ‘ä»¬å†çœ‹çœ‹ Android ç«¯å’Œ iOS ç«¯çš„å®ç°ã€‚

### Android

åœ¨å®ç° StorageModule ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ··åˆå·¥ç¨‹ä¸­ï¼Œå°† React Native æ–°æ¶æ„çš„è¿è¡Œé…ç½®æ­å»ºå¥½ï¼Œè¿™å¥—é…ç½®å¯ä»¥è¿è¡Œ TurboModuleã€Fabricï¼Œåé¢çš„ Fabric æ¡ˆä¾‹ä¹Ÿæ˜¯åŸºäºæ­¤é…ç½®æ¥è¿è¡Œçš„ã€‚

è€Œä¸”ï¼Œä¸Šä¸€è®²åœ¨æˆ‘ä»¬å·²ç»è®²è§£äº†å¦‚ä½•åŸºäº React Native æœ€æ–°ç‰ˆæœ¬ï¼ˆ0.68.0ï¼‰æ­å»ºæ··åˆåº”ç”¨ï¼Œæˆ‘ä»¬å†è¿™ä¸ªåŸºç¡€ä¸Šå¼€å¯æ–°æ¶æ„é…ç½®å°±å¥½äº†ã€‚

**ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬è¦åšäº›å‡†å¤‡å·¥ä½œï¼Œä¹Ÿå°±æ˜¯è·å– newarchitecture çš„æ¨¡ç‰ˆä»£ç ã€‚**

æˆ‘ä»¬ä»¥ 0.68.0 ç‰ˆæœ¬åˆ›å»ºä¸€ä¸ª React Native å·¥ç¨‹ï¼Œæ¥è·å–æ–°æ¶æ„çš„æ¨¡ç‰ˆä»£ç ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªå·¥ç¨‹åå«åšReactNativeNewArchï¼š

```plain
npx react-native init ReactNativeNewArch --version 0.68.0
```

åˆ›å»ºå¥½åï¼Œä½ å°†çœ‹åˆ°å¦‚ä¸‹å·¥ç¨‹ä»£ç ï¼ŒåŒ…å« Java å’Œ C++ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/f6/3a/f64e5f3da0730b6a6a8928dc9736ea3a.png?wh=1164x1394)

è¿™äº›å·¥ç¨‹ä»£ç ä¸»è¦æ˜¯æ–°æ¶æ„çš„ JSIã€Fabricã€TurboModule çš„æ³¨å†Œå’ŒåŠ è½½ä»£ç ï¼Œå†…éƒ¨é€»è¾‘éå¸¸å¤æ‚ï¼Œè¿™ä¸€è®²æˆ‘ä»¬å°±ä¸åšè¿‡å¤šåˆ†æäº†ï¼Œå…ˆä¸“æ³¨äºå®æ“éƒ¨åˆ†ã€‚

å¦‚æœæˆ‘ä»¬æƒ³åŸºäºè¿™ä¸ª Demo å»è¿è¡Œæ–°æ¶æ„ï¼Œå¯ä»¥åšå¦‚ä¸‹æ“ä½œï¼š

```plain
1. ä¿®æ”¹ android ç›®å½•ä¸‹çš„ gradle.properties:
# å¼€å¯æ–°æ¶æ„
newArchEnabled=true
# é…ç½® java home ä¸º JDK 11
org.gradle.java.home=/Library/Java/JavaVirtualMachines/jdk-11.0.2.jdk/Contents/Home

2. è¿è¡Œ
yarn react-native run-android
```

**ç¬¬äºŒæ­¥ï¼Œæ‹·è´ newarchitecture çš„æ¨¡ç‰ˆä»£ç åˆ°æˆ‘ä»¬ä¹‹å‰çš„æ··åˆå·¥ç¨‹ã€‚**

è¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°† Java å±‚å’Œ C++ å±‚ä»£ç æ‹·è´åˆ°æ··åˆå·¥ç¨‹ä¸­ï¼Œéœ€è¦æ‹·è´çš„ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š

```plain
Java å±‚ï¼š
- MainComponentsRegistry.java
- MainApplicationTurboModuleManagerDelegate.java

C++ å±‚ï¼š
- jni ç›®å½•
```

æ‹·è´å®Œçš„æ•ˆæœæ˜¯è¿™æ ·çš„ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/b5/73/b51022154e4d1831428ced687c224173.png?wh=880x1076)

**ç¬¬ä¸‰æ­¥æ˜¯ä¿®æ”¹æ‹·è´çš„ä»£ç ï¼Œä¸»è¦æ˜¯ä¸‹é¢è¿™å››ç‚¹ã€‚**

**1.MainApplicationTurboModuleManagerDelegate.javaï¼š**

ä¿®æ”¹ so åº“åç§°ä¸ºæˆ‘ä»¬è‡ªå®šä¹‰åç§° geektime\_new\_archã€‚

```plain
@Override
protected synchronized void maybeLoadOtherSoLibraries() {
  if (!sIsSoLibraryLoaded) {
    SoLoader.loadLibrary("geektime_new_arch");
    sIsSoLibraryLoaded = true;
  }
}
```

**2.jni/Android.mkï¼š**ä¿®æ”¹ Android.mk ä¸­çš„ so åº“åç§°ä¸ºä¸Šé¢çš„ geektime\_new\_archã€‚

```plain
# You can customize the name of your application .so file here.
LOCAL_MODULE := geektime_new_arch
```

**3.jni/MainApplicationTurboModuleManagerDelegate.hï¼š**ä¿®æ”¹ MainApplicationTurboModuleManagerDelegate å¯¹åº”çš„ Java ç±»è·¯å¾„ï¼Œæˆªå›¾ä¸­æ‹·è´å¥½çš„ MainApplicationTurboModuleManagerDelegate.java è·¯å¾„ä¸º com/reactnativenewarch/newarchitecture/modulesã€‚

```plain
static constexpr auto kJavaDescriptor =
    "Lcom/reactnativenewarch/newarchitecture/modules/MainApplicationTurboModuleManagerDelegate;";
```

**4.jni/MainComponentsRegistry.hï¼š**ä¿®æ”¹ MainComponentsRegistry å¯¹åº”çš„ Java ç±»è·¯å¾„ï¼Œæˆªå›¾ä¸­æ‹·è´å¥½çš„ MainComponentsRegistry.java è·¯å¾„ä¸º com/reactnativenewarch/newarchitecture/componentsã€‚

```plain
constexpr static auto kJavaDescriptor =
    "Lcom/reactnativenewarch/newarchitecture/components/MainComponentsRegistry;";
```

**åšå®Œåï¼Œæœ€åä¸€æ­¥å°±æ˜¯ä¿®æ”¹ React Native åˆå§‹åŒ–ä»£ç äº†ã€‚**

è¿™é‡Œæœ‰ä¸¤å¤„è¦ä¿®æ”¹ã€‚ç¬¬ä¸€å¤„æ˜¯è®¾ç½® ReactPackageTurboModuleManagerDelegateBuilder ä¸ºä¸Šé¢çš„ MainApplicationTurboModuleManagerDelegateï¼ˆTurboModule ç”¨ï¼‰ï¼›ç¬¬äºŒå¤„æ˜¯è®¾ç½® setJSIModulesPackageï¼ˆFabric ç”¨ï¼ŒJSI å®ç°ï¼‰ï¼š

```plain
public void initRN() {
    ReactInstanceManagerBuilder builder = ReactInstanceManager.builder()
        .setApplication((Application) getApplicationContext())
        .addPackage(new MainReactPackage())
        .setJSMainModulePath("index.android")
        .setInitialLifecycleState(LifecycleState.BEFORE_CREATE)
        .setReactPackageTurboModuleManagerDelegateBuilder(new MainApplicationTurboModuleManagerDelegate.Builder())
        .setJSIModulesPackage(getJSIModulePackage());

    ReactInstanceManager reactInstanceManager = builder.build();
}
```

å…¶ä¸­ getJSIModulePackage() æˆ‘ç‰¹æ„æ‘˜å‡ºæ¥æ”¾åœ¨äº†ä¸‹é¢ã€‚è¿™æ®µä»£ç å®ç°éœ€è¦ä»æ¨¡ç‰ˆä»£ç çš„ MainApplicationReactNativeHost çš„ getJSIModulePackage æ‹·è´ï¼Œå†…éƒ¨è°ƒç”¨äº†ä¸Šé¢çš„ MainComponentsRegistry è¿›è¡Œæ³¨å†Œï¼š

```plain
static JSIModulePackage getJSIModulePackage() {
  return new JSIModulePackage() {
    @Override
    public List<JSIModuleSpec> getJSIModules(
      final ReactApplicationContext reactApplicationContext,
      final JavaScriptContextHolder jsContext) {
      final List<JSIModuleSpec> specs = new ArrayList<>();
      specs.add(
          new JSIModuleSpec() {
            @Override
            public JSIModuleType getJSIModuleType() {
              return JSIModuleType.UIManager;
            }

            @Override
            public JSIModuleProvider<UIManager> getJSIModuleProvider() {
              final ComponentFactory componentFactory = new ComponentFactory();
              CoreComponentsRegistry.register(componentFactory);
              MainComponentsRegistry.register(componentFactory);

              List<ViewManager> viewManagers = new ArrayList<>();
              ViewManagerRegistry viewManagerRegistry = new ViewManagerRegistry(viewManagers);
              return new FabricJSIModuleProvider(
                  reactApplicationContext,
                  componentFactory,
                  new EmptyReactNativeConfig(),
                  viewManagerRegistry);
            }
          });
      return specs;
    }
  };
}
```

è‡³æ­¤ï¼Œæˆ‘ä»¬æ–°æ¶æ„çš„è¿è¡Œç¯å¢ƒå°±é…ç½®å¥½äº†ã€‚ç”±äºç›®å‰æ–°æ¶æ„æ–‡ç« éå¸¸å°‘ï¼Œå‡ ä¹æ²¡æœ‰æ··åˆå·¥ç¨‹è¿è¡Œæ–°æ¶æ„çš„æ–¹æ¡ˆï¼Œä¸Šé¢è¿™äº›ä¸»è¦æ˜¯æˆ‘ä»¬ç”¨äº†å¤§é‡çš„æ—¶é—´å»è°ƒç ”å’Œæµ‹è¯•çš„ç»“æœï¼Œä½ å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚

å¥½äº†ï¼Œå›åˆ°æ­£é¢˜ã€‚åœ¨æ··åˆå·¥ç¨‹ä¸­ï¼Œæ–°æ¶æ„çš„è¿è¡Œç¯å¢ƒæ­å»ºå¥½åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç®€å•å¿«é€Ÿåœ°æ¥å†™ TurboModule å’Œ Fabric äº†ã€‚

æˆ‘ä»¬ç»§ç»­æ¥è¿›è¡Œæ•°æ®å­˜å‚¨çš„ Demo åœ¨ Java å±‚å®šä¹‰å¹¶å®ç° StorageModuleã€‚Android ç«¯æˆ‘ä»¬ä½¿ç”¨ SharedPreferences æ¥å®ç°è½»é‡çº§åå¥½å­˜å–ã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œä½ éœ€è¦ç»§æ‰¿ ReactModuleWithSpecå’ŒTurboModuleï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```plain
// 1. å®šä¹‰ StorageModuleï¼Œç»§æ‰¿ ReactContextBaseJavaModule ç±»
// å®ç° ReactModuleWithSpec & TurboModule æ¥å£
public class StorageModule extends ReactContextBaseJavaModule
    implements ReactModuleWithSpec, TurboModule {
    // native å­˜å‚¨çš„ sp æ–‡ä»¶åç§°
    private static final String SP_NAME = "rn_storage";
    // è¿”å›ç»™ JS çš„ç»“æœç 
    private static final int CODE_SUCCESS = 1;
    private static final int CODE_ERROR = 2;

    public StorageModule(ReactApplicationContextWrapper reactContext) {
       super(reactContext);
    }

    // è¿”å› module åç§°ï¼Œä¸€èˆ¬ä»¥ç±»åä½œä¸º module åç§°
    @Override
    public String getName() {
       return StorageModule.class.getSimpleName();
    }
  
    // å®šä¹‰ä¾› JS è°ƒç”¨çš„å­˜å‚¨æ•°æ®æ–¹æ³•ï¼ŒisBlockingSynchronousMethod è¡¨ç¤ºæ˜¯å¦åŒæ­¥æ‰§è¡Œ
    @ReactMethod(isBlockingSynchronousMethod = true)
    public void save(String key, String value, Callback callback) {
       WritableMap result = new WritableNativeMap();
       // å¦‚æœ js ä¼ å…¥çš„ key ä¸ºç©ºï¼Œåˆ™å›ä¼ å¤±è´¥ç å’Œä¿¡æ¯
       if (TextUtils.isEmpty(key)) {
           result.putInt("code", CODE_ERROR);
           result.putString("msg", "key is empty or null");
           callback.invoke(result);
           return;
       }
       // è°ƒç”¨ native çš„ sp è¿›è¡Œæ•°æ®å­˜å‚¨
       SharedPreferences sp = getReactApplicationContext().getSharedPreferences(SP_NAME, Context.MODE_PRIVATE);
       sp.edit().putString(key, value).apply();
       result.putInt("code", CODE_SUCCESS);
       result.putString("msg", "save success");
       // å›ä¼  js å‘ŠçŸ¥å­˜å‚¨æˆåŠŸ
       callback.invoke(result);
   }

    // å®šä¹‰ä¾› JS è°ƒç”¨çš„è·å–æ•°æ®æ–¹æ³•ï¼ŒisBlockingSynchronousMethod è¡¨ç¤ºæ˜¯å¦åŒæ­¥æ‰§è¡Œ
   @ReactMethod(isBlockingSynchronousMethod = true)
   public void get(String key, Callback callback) {
      // å¦‚æœ js ä¼ å…¥çš„ key ä¸ºç©ºï¼Œåˆ™å›ä¼ å¤±è´¥ç å’Œä¿¡æ¯
      WritableMap result = new WritableNativeMap();
      if (TextUtils.isEmpty(key)) {
         result.putInt("code", CODE_ERROR);
         result.putString("msg", "key is empty or null");
         callback.invoke(result);
         return;
      }
      // è°ƒç”¨ native çš„ sp è·å– key å¯¹åº”çš„ value å€¼
      SharedPreferences sp = getReactApplicationContext().getSharedPreferences(SP_NAME, Context.MODE_PRIVATE);
      String value = sp.getString(key, "");
      result.putInt("code", CODE_SUCCESS);
      result.putString("data", value);
      // å°†ç»“æœå›ä¼ ç»™ js
      callback.invoke(result);
  }
}
```

ç„¶åæ˜¯æ³¨å†Œç»„ä»¶ï¼Œæ³¨æ„ Package éœ€è¦ç»§æ‰¿ TurboReactPackageï¼š

```plain
public class MyTurboModulePackage extends TurboReactPackage {
    @Override
    public NativeModule getModule(String name, ReactApplicationContext reactContext) {
        switch(name) {
           case "StorageModule":
              return new StorageModule(reactContext);
              break;
           default:
              return null;
        }
    }
    
    @Override
    public ReactModuleInfoProvider getReactModuleInfoProvider() {
      //...
    }
}
```

æ¥ä¸‹æ¥æ³¨å†Œåˆ° ReactInstanceManager ï¼ˆä½¿ç”¨ reactInstanceManagerBuilderæ³¨å†Œï¼‰ï¼š

```plain
ReactInstanceManagerBuilder builder = ReactInstanceManager.builder()
   .addPackage(new MyTurboModulePackage());
... // å…¶ä»– RN åˆå§‹åŒ–é…ç½®
ReactInstanceManager reactInstanceManager = builder.build();
```

ç„¶åæˆ‘ä»¬åˆ©ç”¨æ–°æ¶æ„æä¾›çš„ Codegenï¼Œç”Ÿæˆæ–°æ¶æ„éœ€è¦çš„ native ä»£ç ã€‚ä¸è¿‡ï¼Œåœ¨ä½¿ç”¨ codegen ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨é¡¹ç›®ä¸­åº”ç”¨ç›¸å…³çš„æ’ä»¶ï¼š

(1) åœ¨å·¥ç¨‹æ ¹ç›®å½•å®‰è£… react-native-gradle-pluginã€‚

```plain
yarn add react-native-gradle-plugin
```

(2) åœ¨å·¥ç¨‹æ ¹ç›®è·¯çš„ settings.gradle ä¸­é…ç½® react-native-gradle-pluginï¼Œä½¿ç”¨å¤åˆæ„å»ºå¼•å…¥ã€‚

```plain
include ':app'
rootProject.name = "GeekTimeRNAndroid"
includeBuild('./node_modules/react-native-gradle-plugin')
```

(3) åœ¨ app/build.gradle ä¸­åº”ç”¨æ’ä»¶ã€‚

```plain
apply plugin: "com.facebook.react"
```

è¿™æ ·åšåï¼Œå·¥ç¨‹çš„ gradle ä»»åŠ¡ä¸­å°±ä¼šå‡ºç° generateCodegenArtifactsFromSchema taskã€‚

```plain
é…ç½®å¥½åï¼Œæˆ‘ä»¬ä»¥åå°±å¯ä»¥ä½¿ç”¨ codegen èƒ½åŠ›äº†ï¼Œç„¶åæ‰§è¡Œ generateCodegenArtifactsFromSchemaï¼Œæœ€åè¿è¡ŒAppå°±å¯ä»¥äº†ã€‚
../gradlew generateCodegenArtifactsFromSchema
```

Androidç«¯çš„å°±æ˜¯è¿™æ ·ï¼Œç°åœ¨æˆ‘ä»¬çœ‹iOSç«¯éœ€è¦æ€ä¹ˆåšã€‚

### iOS

åœ¨iOSç«¯ä¸­ï¼Œé¦–å…ˆæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªç±»å¹¶éµå¾ªä¸€ä¸ªåè®® spec ï¼Œåè®®ä¸­åŒ…å«æ³¨å†Œçš„APIå£°æ˜ã€‚è€Œä¸”ï¼Œè¯¥åè®®éœ€è¦éµå¾ª RCTBridgeModule åè®®å’Œ RCTTurboModule åè®®ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªJSIã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```plain
//å®šä¹‰ä¸€ä¸ªSpecåè®®
@protocol DataStorageTurboModuleSpec <RCTBridgeModule, RCTTurboModule>
- (NSString *)getString:(NSString *)string;
@end

//JSIå®ç°
namespace facebook {
namespace react {
class JSI_EXPORT DataStorageTurboModuleSpecJSI : public ObjCTurboModule {
Â   public:
Â    DataStorageTurboModuleSpecJSI(const ObjCTurboModule::InitParams &params);
  };
} // namespace react
} // namespace facebook

//å®šä¹‰ä¸€äº›æ–¹æ³•
namespace facebook {
Â  namespace react {
Â  Â Â static facebook::jsi::Value __hostFunction_DataStorageTurboModuleSpecJSI_getString(
Â  Â  facebook::jsi::Runtime &rt,
Â  Â  TurboModule &turboModule,
Â  Â  const facebook::jsi::Value *args,
Â  Â  size_t count){
Â    return static_cast<ObjCTurboModule &>(turboModule)
Â  Â  Â  .invokeObjCMethod(rt, VoidKind, "getString", @selector(getString:), args, count);
  }
Â Â  DataStorageTurboModuleSpecJSI::NativeSampleTurboModuleSpecJSI(const ObjCTurboModule::InitParams &params)
Â  Â  : ObjCTurboModule(params)
Â  {
    //MethodMetadata ç¬¬ä¸€ä¸ªå‚æ•°ä¸º0ä»£è¡¨è¯¥æ–¹æ³•æœ‰ä¸€ä¸ªå‚æ•°
Â  Â  methodMap_["getString"] = MethodMetadata{1, __hostFunction_DataStorageTurboModuleSpecJSI_getString};
Â  }
}
}

//TurboModuleéµå¾ªSpecåè®®
@interface DataStorageTurboModule : NSObject <DataStorageTurboModuleSpec>

@end
```

ä¹‹åï¼Œæˆ‘ä»¬è¦åœ¨è¯¥ç±»ä¸­æ³¨å†Œç»„ä»¶åå’ŒAPIï¼š

```plain
//DataStorageTurboModule.mm
@implementation DataStorageTurboModule
RCT_EXPORT_MODULE()

- (std::shared_ptr<facebook::react::TurboModule>)getTurboModule:
Â  Â  (const facebook::react::ObjCTurboModule::InitParams &)params{
  //æŒ‡å®šJSI
Â  return std::make_shared<DataStorageTurboModuleSpecJSI>(params);
}

RCT_EXPORT_METHOD(getString:(NSString *)string){
  NSLog(@"");
}
@end
```

ä»¥ä¸Šä¾¿æ˜¯è‡ªå®šä¹‰ä¸€ä¸ª TurboModuleçš„æµç¨‹ã€‚å…¶å®å®šä¹‰ TurboModule å¹¶ä¸å¤æ‚ï¼Œè€Œä¸” Facebook ä¹Ÿæä¾›äº†ä»£ç ç”Ÿæˆå·¥å…· codegenï¼Œæ¯”è¾ƒå¤æ‚çš„æ˜¯åœ¨æ··åˆå·¥ç¨‹ä¸­æ­å»ºæ–°æ¶æ„çš„è¿è¡Œç¯å¢ƒã€‚å‰é¢æˆ‘ä»¬èŠ±äº†ä¸å°‘å†…å®¹è®²è¿°å¦‚ä½•åœ¨å®¢æˆ·ç«¯å¼€å¯æ–°æ¶æ„ï¼Œæ¥ä¸‹æ¥çš„ Fabric ç»„ä»¶ä»‹ç»ä¹Ÿå°†åœ¨æ–°æ¶æ„ç¯å¢ƒåŸºç¡€ä¸Šè¿›è¡Œè®²è§£ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­æ¥çœ‹Fabric è‡ªå®šä¹‰ç»„ä»¶ã€‚

## Fabricï¼šè§†é¢‘æ’­æ”¾

Fabric å¯¹æ ‡æ—§æ¡†æ¶çš„ UIManagerã€‚FabricUIManager å¯ä»¥å’Œ C++ å±‚ç›´æ¥è¿›è¡Œé€šè®¯ï¼Œè§£é™¤äº†åŸæœ‰çš„ UIManager ä¾èµ–å•ä¸ª bridge çš„é—®é¢˜ã€‚æœ‰äº† JSI åï¼Œä»¥å‰æ‰¹é‡ä¾èµ– bridge çš„ UI æ“ä½œï¼Œéƒ½å¯ä»¥åŒæ­¥æ‰§è¡Œåˆ° C++ å±‚ï¼Œæ€§èƒ½å¾—åˆ°å¤§å¹…æå‡ï¼Œç‰¹åˆ«æ˜¯åœ¨åˆ—è¡¨å¿«é€Ÿæ»‘åŠ¨ã€å¤æ‚åŠ¨ç”»äº¤äº’æ–¹é¢æå‡æ›´åŠ æ˜æ˜¾ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬ä»¥ä¸€ä¸ªè§†é¢‘æ’­æ”¾ç»„ä»¶ä¸ºä¾‹ï¼Œè®²è®²å¦‚ä½•å®šä¹‰ Fabric ç»„ä»¶ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ JavaScript ç«¯çš„å®ç°ã€‚

### JavaScipt

JavaScriptéœ€è¦å®šä¹‰å±æ€§ä»¥åŠ APIï¼Œå¹¶ export ç»„ä»¶ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```plain
type NativeProps = $ReadOnly<{|
  ...ViewProps,
  url?: string
|}>; // å®šä¹‰è§†é¢‘æ’­æ”¾çš„å±æ€§ï¼Œurl ä¸ºè§†é¢‘åœ°å€

export type VideoViewType = HostComponent<NativeProps>;

// å®šä¹‰è§†é¢‘æ’­æ”¾çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬å¼€å§‹æ’­æ”¾ã€åœæ­¢æ’­æ”¾ã€æš‚åœæ’­æ”¾
interface NativeCommands {
  +callNativeMethodToPlayVideo: (
  ) => void;
  +callNativeMethodToStopVideo: (
  ) => void;
  +callNativeMethodToPauseVideo: (
  ) => void;
}

//å¯¼å‡ºå¤–éƒ¨è°ƒç”¨çš„å‘½ä»¤ï¼ŒåŒ…æ‹¬å¼€å§‹æ’­æ”¾ã€åœæ­¢æ’­æ”¾ã€æš‚åœæ’­æ”¾
export const Commands: NativeCommands = codegenNativeCommands<NativeCommands>({
  supportedCommands: ['callNativeMethodToPlayVideo'],
  supportedCommands: ['callNativeMethodToStopVideo'],
  supportedCommands: ['callNativeMethodToPauseVideo'],
});

// å¯¼å‡ºåŒ…è£…å¥½çš„ç»„ä»¶ï¼Œå…¶ä¸­ VideoView ä¸ºå¼•å…¥ Native çš„ç»„ä»¶
export default (codegenNativeComponent<NativeProps>(
  'VideoView',
): VideoViewType);

```

JavaScript ç«¯ä½¿ç”¨è¯¥ç»„ä»¶ï¼š

```plain
// å¯¼å…¥ ViewView ç»„ä»¶å’Œå·¥å…·
import VideoView, {
  Commands as VideoViewCommands,
} from './VideoNativeComponent';

// å¤–éƒ¨è°ƒç”¨æ­¤æ–¹æ³•å³å¯è°ƒç”¨ ViewView è§†é¢‘æ’­æ”¾èƒ½åŠ›
export default function MyView(props: {}): React.Node {
  return (
     <View>
         <VideoView url={"url"} style={{flex: 1}} />
         <Button title="play" onPress={()=>{
             VideoViewCommands.callNativeMethodToPlayVideo();
           }
         }
     </View>
  )
}
```

æ¥ä¸‹æ¥æˆ‘ä»¬å†çœ‹çœ‹ Android ç«¯å’Œ iOS ç«¯çš„å®ç°ã€‚

### Android

ç”±äºåœ¨å‰é¢ TurboModule çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬å·²ç»è®²è§£äº†å¦‚ä½•åœ¨æ··åˆå·¥ç¨‹ä¸­å¼€å¯æ–°æ¶æ„è¿è¡Œæ¨¡å¼ï¼Œæˆ‘ä¹ˆè¿™é‡Œå°±ä¸å†é‡å¤äº†ã€‚å‰é¢çš„æ–¹æ³•åŒæ ·é€‚ç”¨äº Fabricï¼Œæˆ‘ä»¬åªéœ€è¦æ­å»ºä¸€æ¬¡å°±å¥½äº†ã€‚æ‰€ä»¥ç°åœ¨è¦åœ¨ Android ç«¯å®ç° Fabric ç»„ä»¶ä¹Ÿéå¸¸ç®€å•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å…·ä½“å®ç°ã€‚

**ç¬¬ä¸€æ­¥ï¼Œå®šä¹‰è§†é¢‘æ’­æ”¾æ¥å£ã€‚**

è¿™é‡Œæˆ‘ä»¬è¦å®šä¹‰ VideoViewManagerInterfaceï¼Œå…¶ä¸­åŒ…å«ä¸‰ä¸ªæ–¹æ³•ï¼šæ’­æ”¾è§†é¢‘ã€åœæ­¢æ’­æ”¾ã€æš‚åœæ’­æ”¾ï¼š

```plain
public interface VideoViewManagerInterface<T extends View> {
   void playVideo(T view, String url);
   void stopVideo(T view);
   void pauseVideo(T view);
}
```

**ç¬¬äºŒæ­¥ï¼Œå®šä¹‰è§†é¢‘æ’­æ”¾ Viewã€‚**

è¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬è¦å®ç°è§†é¢‘æ’­æ”¾çš„ Viewã€‚åœ¨ View ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®ç°è§†é¢‘çš„æ’­æ”¾ã€åœæ­¢å’Œæš‚åœåŠŸèƒ½ã€‚ä½†æ’­æ”¾èƒ½åŠ›çš„å®ç°å¹¶ä¸æ˜¯æˆ‘ä»¬è®²è§£çš„é‡ç‚¹ï¼Œæˆ‘ä»¬è¿™ä¸€è®²ä¾§é‡äºæ–°æ¶æ„ä¸­ Frabic ç»„ä»¶çš„å®ç°æµç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™è¾¹ä½¿ç”¨ä¼ªä»£ç ï¼š

```plain
public class MyVideoView extends View {
   // ...
     
   public void playVideo(String url) {
       // æ’­æ”¾è§†é¢‘å®ç°
   }
     
   public void stopVideo() {
      // åœæ­¢è§†é¢‘æ’­æ”¾å®ç°
   }

   public void pauseVideo() {
      // æš‚åœè§†é¢‘æ’­æ”¾å®ç°
   }
}
```

**ç¬¬ä¸‰æ­¥ï¼Œå®šä¹‰ ViewManagerã€‚**

åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬è¦å®ç°æš´éœ²ç»™ React Native è°ƒç”¨çš„èƒ½åŠ›ï¼ŒåŒ…æ‹¬è§†é¢‘æ’­æ”¾ã€åœæ­¢ï¼Œä»¥åŠæš‚åœï¼Œå†…éƒ¨ä¼šè½¬å‘åˆ°ä¸Šé¢æˆ‘ä»¬å®šä¹‰çš„è§†é¢‘æ’­æ”¾ View çš„å®ç°ä¸­ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```plain
@ReactModule(name = VideoViewManager.REACT_CLASS)
public class VideoViewManager: ViewGroupManager<VideoView>(), VideoViewManagerInterface<VideoView> {
     private static final String REACT_CLASS = "VideoView";
     
     public VideoViewManager() {
     }

     override
     public String getName() {
        return REACT_CLASS;
     }
     
     override
     public VideoView createViewInstance(ThemedReactContext reactContext) {
        return new MyVideoView(reactContext);
     }
     
     @ReactProp(name = "url")
     override 
     public void playVideo(VideoView view, String url) {
        view.playVideo(url);
     }
     
     override 
     public void stopVideo(VideoView view) {
        view.stopVideo();
     }

     override 
     public void pauseVideo(VideoView view) {
        view.pauseVideo();
     }
}
```

**æœ€åä¸€æ­¥å°±æ˜¯æ³¨å†Œ ViewManagerã€‚**æˆ‘ä»¬åœ¨ ReactInstanceManager çš„ JSIModulesPackage ä¸­æ³¨å†Œ VideoViewManagerï¼š

```plain
List<ViewManager> viewManagers = new ArrayList<>();
viewManagers.add(new VideoViewManager())
ViewManagerRegistry viewManagerRegistry = new ViewManagerRegistry(viewManagers);

return new FabricJSIModuleProvider(
    reactApplicationContext,
    componentFactory,
    new EmptyReactNativeConfig(),
    viewManagerRegistry);
```

ç„¶åæˆ‘ä»¬åˆ©ç”¨æ–°æ¶æ„æä¾›çš„ Codegenï¼Œè°ƒç”¨ gradlew generateCodegenArtifactsFromSchema ç”Ÿæˆä»£ç  Native ä»£ç ï¼š

```plain
../gradlew generateCodegenArtifactsFromSchema
```

æœ€åï¼Œè¿è¡Œå³å¯ã€‚Android ç«¯çš„å®ç°å°±æ˜¯è¿™æ ·ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†çœ‹ä¸‹ iOS ç«¯ã€‚

### iOS

åœ¨iOSç«¯æ±‡æ€»ï¼Œé¦–å…ˆæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªç»§æ‰¿äºRCTViewComponentView çš„ä¸€ä¸ªç±»ä½œä¸ºè§†é¢‘ç»„ä»¶ï¼Œå¦‚ä¸‹ï¼š

```plain
@interface VideoComponentView : RCTViewComponentView
//å£°æ˜æ’­æ”¾å™¨ç»„ä»¶çš„ä¸€äº›æ–¹æ³•
//æ’­æ”¾è§†é¢‘
- (void)playVideo;
//åœæ­¢è§†é¢‘
- (void)stopVideo;
//æš‚åœè§†é¢‘
- (void)pauseVideo;
@end
```

ä¹‹åï¼Œè¯¥ç±»éœ€è¦éµå¾ªä¸€ä¸ªåè®®ï¼Œåè®®ä¸­éœ€è¦å£°æ˜æ‰§è¡ŒCommandçš„æ–¹æ³•åï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```plain
@protocol VideoComponentViewProtocol <NSObject>
- (void)callNativeMethodToPlayVideo;
- (void)callNativeMethodToStopyVideo;
- (void)callNativeMethodToPauseVideo;
@end

RCT_EXTERN inline void VideoComponentCommand(
        id<VideoComponentViewProtocol> componentView,
Â        NSString const *commandName,
Â        NSArray const *args)

    if([commandName isEqualToString:@"callNativeMethodToPlayVideo"]){
        [componentView callNativeMethodToPlayVideo];
        return;
    }
    
    if(![commandName isEqualToString:@"callNativeMethodToStopVideo"]){
        [componentView callNativeMethodToStopVideo];
        return;
    }
    
    if(![commandName isEqualToString:@"callNativeMethodToPauseVideo"]){
        [componentView callNativeMethodToPauseVideo];    
        return;
    }
    return;
)
```

æ¥ä¸‹æ¥ï¼ŒComponentViewéœ€è¦éµå¾ªè¯¥Protocolåè®®ï¼Œå¹¶åœ¨æ‰§è¡Œcommonæ—¶è°ƒç”¨å¯¹åº”çš„æ–¹æ³•ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è®¾ç½®ç»„ä»¶çš„å±æ€§ï¼š

```plain
using namespace facebook::react;

@interface VideoComponentView() <VideoComponentViewProtocol>
@end

@implementation VideoComponentView{
  VideoPlayer *_videoPlayer;
}

#pragma mark - Native Commands
- (void)handleCommand:(const NSString *)commandName args:(const NSArray *)args{
Â  VideoComponentCommand(self, commandName, args);
}

- (void)callNativeMethodToPlayVideo{
Â  //å®ç°è§†é¢‘æ’­æ”¾åŠŸèƒ½
  [_videoPlayer startPlay];
}

- (void)callNativeMethodToStopVideo{
  //å®ç°è§†é¢‘åœæ­¢åŠŸèƒ½
  [_videoPlayer stopPlay];
}

- (void)callNativeMethodToPauseVideo{
  //å®ç°è§†é¢‘æš‚åœåŠŸèƒ½
  [_videoPlayer pausePlay];
}

#pragma mark - Props
//éµå¾ªdescriptoråè®®
+ (ComponentDescriptorProvider)componentDescriptorProvider{
Â  return concreteComponentDescriptorProvider<VideoComponentDescriptor>();
}

- (instancetype)initWithFrame:(CGRect)frame{
Â  if (self = [super initWithFrame:frame]) {
Â  Â  static const auto defaultProps = std::make_shared<const ComponentViewProps>();
Â  Â  _props = defaultProps;

Â  Â  _videoPlayer = [[VideoPlayer alloc] init];
Â  Â  self.contentView = _videoPlayer;
Â  }
Â  return self;
}

- (void)updateProps:(Props::Shared const &)props oldProps:(Props::Shared const &)oldProps{
Â  [super updateProps:props oldProps:oldProps];
}

- (void)onChange:(UIView *)sender{
Â  // No-op
Â  //Â  std::dynamic_pointer_cast<const ViewEventEmitter>(_eventEmitter)
Â  //Â  Â  Â  ->onChange(ViewEventEmitter::OnChange{.value = static_cast<bool>(sender.on)});
}

@end

Class<RCTComponentViewProtocol> VideoViewCls(void){
Â  return VideoComponentView.class;
}
```

æ¥ç€ï¼Œæ³¨å†Œå±æ€§éµå¾ªVideoComponentDescriptorï¼Œå¹¶ä¸”éœ€è¦æŒ‡å®šè¯¥ç»„ä»¶çš„åå­—ï¼š

```plain
namespace facebook {
namespace react {
using VideoComponentDescriptor = ConcreteComponentDescriptor<VideoViewShadowNode>;
} // namespace react
} // namespace facebook

namespace facebook {
namespace react {
    extern const char VideoViewComponentName[];
    using VideoViewShadowNode = ConcreteViewShadowNode<
Â  Â       VideoViewComponentName,//ç»„ä»¶å
Â  Â       VideoViewProps>;//æ³¨å†Œå±æ€§
} // namespace react
} // namespace facebook

namespace facebook {
namespace react {
extern const char VideoViewComponentName[] = "VideoView";//ç»„ä»¶å
} // namespace react
} // namespace facebook

namespace facebook {
namespace react {
//å±æ€§å®šä¹‰
class VideoViewProps final : public ViewProps {
Â public:
Â  VideoViewProps() = default;
Â  VideoViewProps(const PropsParserContext& context, const VideoViewProps &sourceProps, const RawProps &rawProps);

  #pragma mark - Props
  std::string url{""};//è§†é¢‘url
};
} // namespace react
} // namespace facebook

```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±åˆ›å»ºå¥½äº†ä¸€ä¸ª React Native çš„ Fabric ç»„ä»¶ã€å®šä¹‰å±æ€§ä»¥åŠ API çš„æ–¹æ³•ã€‚  
ä»¥ä¸Šä¾¿æ˜¯å¦‚ä½•ä½¿ç”¨ Fabric è‡ªå®šä¹‰è§†é¢‘æ’­æ”¾ç»„ä»¶ï¼Œåœ¨æ··åˆå·¥ç¨‹ä¸­æ­å»ºå¥½æ–°æ¶æ„çš„è¿è¡Œç¯å¢ƒåï¼Œåªéœ€è¦éµå®ˆ Fabric çš„ç»„ä»¶å®šä¹‰æ–¹å¼ï¼Œè¿›è¡Œæ¥å£å®šä¹‰ã€åŠŸèƒ½å®ç°å’Œç»„ä»¶æ³¨å†Œå³å¯ã€‚å…³äºä¸€äº›å¤æ‚çš„ Fabric ç»„ä»¶ï¼Œå¯ä»¥æŸ¥çœ‹ [https://github.com/software-mansion/react-native-gesture-handler/tree/main/FabricExample](https://github.com/software-mansion/react-native-gesture-handler/tree/main/FabricExample)ï¼Œ[https://github.com/software-mansion/react-native-reanimated/tree/main/FabricExample](https://github.com/software-mansion/react-native-reanimated/tree/main/FabricExample)ï¼Œç›®å‰ react-native-gesture-handlerã€react-native-reanimated éƒ½å·²ç»é€‚é…äº†æ–°æ¶æ„ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å»å­¦ä¹ ä¸‹ã€‚

## æ€»ç»“

è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ç³»ç»Ÿè®²è§£äº†ä¸ªæ€§åŒ–ç»„ä»¶çš„ä½¿ç”¨åœºæ™¯ã€ç”Ÿå‘½å‘¨æœŸã€ä¼ è¾“ç±»å‹ï¼Œä»¥åŠé€šä¿¡æ–¹å¼ï¼Œå¹¶é€šè¿‡ä¸¤ä¸ªå®é™…æ¡ˆä¾‹è®²è§£äº†å¦‚ä½•åœ¨æ–°æ¶æ„ä¸‹å®šåˆ¶ä¸ªæ€§åŒ–çš„ TurboModules ä¸ Fabricã€‚è€Œä¸”ï¼Œæˆ‘ä»¬ä¹Ÿç®€å•ä»‹ç»äº†ä¸€ä¸‹React Nativeæ–°æ¶æ„ï¼Œä½ å¯ä»¥é€šè¿‡å®˜æ–¹æ–‡æ¡£è¿›è¡Œæ–°æ¶æ„çš„ä½“éªŒã€‚

è¿™ä¸€è®²æ˜¯æˆ‘ä»¬ Native ç›¸å…³çš„ä¸‰è®²ä¸­èŠ±çš„æ—¶é—´æœ€é•¿çš„ï¼Œä¹Ÿæ˜¯æœ€â€œä¼¤è‚â€çš„ï¼Œæˆ‘ä»¬å‰å‰åååŠ è°ƒç ”èŠ±äº†ä¸¤ä¸ªæœˆçš„æ—¶é—´ã€‚ä½†æˆ‘ä»¬ç›¸ä¿¡ï¼Œæ–°æ¶æ„åœ¨æœªæ¥ä¼šæœ‰å¾ˆå¥½çš„å‘å±•ï¼Œè¿™æ˜¯å¯ä»¥é¢„è§çš„ã€‚å› ä¸ºå®ƒè§£å†³äº† React Native å‡ ä¸ªæœ€ç—›çš„ç‚¹ï¼ŒåŒ…æ‹¬å¯åŠ¨é€Ÿåº¦ã€è¿è¡Œæ—¶æ€§èƒ½ç­‰ã€‚å¦‚æœæ–°æ¶æ„è¿˜èƒ½åœ¨æ˜“ç”¨æ€§ä¸Šç»§ç»­ä¼˜åŒ–ï¼Œå°†ä¼šå¤§å¤§æ‹“å±• React Native çš„ç”¨æˆ·ç¾¤ä½“ã€‚

å› ä¸ºç›®å‰æ–°æ¶æ„è¿˜å¤„äºæœªå‘å¸ƒçš„çŠ¶æ€ï¼Œç½‘ä¸Šç›¸å…³çš„æ–‡ç« å¤§éƒ½æ˜¯å¯¹å®˜æ–¹çº¯ React Native æ¨¡å¼ Demo å’Œä»‹ç»ï¼Œå°‘æ•°å‡ ç¯‡ä¼šæ·±æŒ–åŸç†ï¼Œä½†è®²æ··åˆæ¨¡å¼çš„æ–°æ¶æ„è¿è¡Œæ–‡ç« å‡ ä¹æ²¡æœ‰ã€‚æˆ‘ä»¬è¿™ä¸€è®²ä¸­å¯¹ TurboModule å’Œ Fabric çš„è®²è§£ï¼Œæ›´ä¾§é‡äºå¦‚ä½•åœ¨æ··åˆå·¥ç¨‹ä¸­å¼€å¯å¹¶è¿è¡Œã€‚å¦‚æœæœ‰å¯¹ TurboModuleã€Fabricã€JSI çš„åŸç†æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œåé¢æœ‰æœºä¼šæˆ‘ä»¬å†æ¥åˆ†äº«ã€‚

## ä½œä¸š

1. è®¾è®¡ä¸€ä¸ªæ‰“å° Native æ—¥å¿—çš„ TurboModuleï¼Œä»¥åŠä¸€ä¸ª Native åŠ è½½è¿›åº¦æ¡çš„ Fabric ç»„ä»¶ã€‚

æ¬¢è¿åœ¨è¯„è®ºåŒºå†™ä¸‹ä½ çš„æƒ³æ³•å’Œç»éªŒï¼Œå’Œæˆ‘ä»¬å¤šå¤šäº¤æµã€‚æˆ‘ä»¬ä¸‹ä¸€è®²è§ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ2ï¼‰</strong></div><ul>
<li><span>é™ˆå½¦ç¥–</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>WritableMap resultMap = new WritableNativeMap(); ä¸‹é¢ä¸¤è¡Œæœ‰é—®é¢˜
è¿™è¡Œåº•ä¸‹çš„ä»£ç æœ‰é—®é¢˜ï¼Œå˜é‡åé”™äº†ï¼Œåº”è¯¥æ˜¯ resultMap.putInt(&quot;code&quot;, 1) è€Œä¸æ˜¯ map
</p>2023-07-12</li><br/><li><span>Geek_ce9101</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æœ€è¿‘æœ‰ä¸ªé¡¹ç›®ï¼Œæƒ³ç›´æ¥ä¸Šrnï¼Œä½†æ€•æœªæ¥æä¸å®šï¼Œæœäº†å¾ˆå¤šï¼Œæ²¡å‘ç°æœ‰ä»€ä¹ˆæ˜¯åŸå£°å¯ä»¥è€Œrnä¸å¯ä»¥çš„ï¼Œé™¤äº†ä¸€äº›åŠ¨ç”»æ€§èƒ½ä¹‹ç±»çš„</p>2022-05-27</li><br/>
</ul>