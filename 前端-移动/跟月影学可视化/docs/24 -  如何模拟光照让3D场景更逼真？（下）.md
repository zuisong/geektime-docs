ä½ å¥½ï¼Œæˆ‘æ˜¯æœˆå½±ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬æ¥ç€æ¥è®²ï¼Œæ€ä¹ˆæ¨¡æ‹Ÿå…‰ç…§ã€‚

ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬è®²äº†å››ç§å…‰ç…§çš„æ¼«åå°„æ¨¡å‹ã€‚å®é™…ä¸Šï¼Œå› ä¸ºç‰©ä½“çš„è¡¨é¢æè´¨ä¸åŒï¼Œåå°„å…‰ä¸ä»…æœ‰æ¼«åå°„ï¼Œè¿˜æœ‰é•œé¢åå°„ã€‚

![](https://static001.geekbang.org/resource/image/2a/d5/2ac147c6eb17d547a3ff355e58d65ed5.jpg?wh=1920%2A796 "é•œé¢åå°„ä¸æ¼«åå°„")

ä»€ä¹ˆæ˜¯é•œé¢åå°„å‘¢ï¼Ÿå¦‚æœè‹¥å¹²å¹³è¡Œå…‰ç…§å°„åœ¨è¡¨é¢å…‰æ»‘çš„ç‰©ä½“ä¸Šï¼Œåå°„å‡ºæ¥çš„å…‰ä¾ç„¶å¹³è¡Œï¼Œè¿™ç§åå°„å°±æ˜¯é•œé¢åå°„ã€‚é•œé¢åå°„çš„æ€§è´¨æ˜¯ï¼Œå…¥å°„å…‰ä¸æ³•çº¿çš„å¤¹è§’ç­‰äºåå°„å…‰ä¸æ³•çº¿çš„å¤¹è§’ã€‚

è¶Šå…‰æ»‘çš„æè´¨ï¼Œå®ƒçš„é•œé¢åå°„æ•ˆæœä¹Ÿå°±è¶Šå¼ºã€‚æœ€ç›´æ¥çš„è¡¨ç°å°±æ˜¯ç‰©ä½“è¡¨é¢ä¼šæœ‰é—ªè€€çš„å…‰æ–‘ï¼Œä¹Ÿå«é•œé¢é«˜å…‰ã€‚ä½†å¹¶ä¸æ˜¯æ‰€æœ‰å…‰éƒ½èƒ½äº§ç”Ÿé•œé¢åå°„ï¼Œæˆ‘ä»¬ä¸ŠèŠ‚è¯¾è®²çš„å››ç§å…‰æºä¸­ï¼Œç¯å¢ƒå…‰å› ä¸ºæ²¡æœ‰æ–¹å‘ï¼Œæ‰€ä»¥ä¸å‚ä¸é•œé¢åå°„ã€‚å‰©ä¸‹çš„å¹³è¡Œå…‰ã€ç‚¹å…‰æºã€èšå…‰ç¯è¿™ä¸‰ç§å…‰æºï¼Œéƒ½æ˜¯èƒ½å¤Ÿäº§ç”Ÿé•œé¢åå°„çš„æœ‰å‘å…‰ã€‚

[![](https://static001.geekbang.org/resource/image/15/0f/15a2e5bcf5dc18b4e0e02efc9e79fc0f.jpeg?wh=1920%2A651 "é•œé¢é«˜å…‰")](https://commons.wikimedia.org)

é‚£ä¹ˆä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥è®¨è®ºä¸€ä¸‹å¦‚ä½•å®ç°é•œé¢åå°„ï¼Œç„¶åå°†å®ƒå’Œä¸ŠèŠ‚è¯¾çš„æ¼«åå°„ç»“åˆèµ·æ¥ï¼Œå°±å¯ä»¥å®ç°æ ‡å‡†çš„å…‰ç…§æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯Phongåå°„æ¨¡å‹äº†ï¼Œä»è€Œèƒ½è®©æˆ‘ä»¬å®ç°çš„å¯è§†åŒ–åœºæ™¯æ›´åŠ æ¥è¿‘äºè‡ªç„¶ç•Œçš„æ•ˆæœã€‚

## å¦‚ä½•å®ç°æœ‰å‘å…‰çš„é•œé¢åå°„?

é¦–å…ˆï¼Œé•œé¢åå°„éœ€è¦åŒæ—¶è€ƒè™‘å…‰çš„å…¥å°„æ–¹å‘ä»¥åŠç›¸æœºä¹Ÿå°±æ˜¯è§‚å¯Ÿè€…æ‰€åœ¨çš„æ–¹å‘ã€‚

[![](https://static001.geekbang.org/resource/image/f2/c9/f2f1bee42562acf44941aa2b077181c9.jpeg?wh=1920%2A713 "è§‚å¯Ÿè€…ä¸å…‰çš„å…¥å°„æ–¹å‘")](https://blog.csdn.net/xyh930929/article/details/83418396)

æ¥ç€ï¼Œæˆ‘ä»¬å†æ¥è¯´è¯´æ€ä¹ˆå®ç°é•œé¢åå°„æ•ˆæœï¼Œä¸€èˆ¬æ¥è¯´éœ€è¦4ä¸ªæ­¥éª¤ã€‚

**ç¬¬ä¸€æ­¥ï¼Œæ±‚å‡ºåå°„å…‰çº¿çš„æ–¹å‘å‘é‡**ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥ç‚¹å…‰æºä¸ºä¾‹ï¼Œè¦æ±‚å‡ºåå°„å…‰çš„æ–¹å‘ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨GLSLçš„å†…ç½®å‡½æ•°reflectï¼Œè¿™ä¸ªå‡½æ•°èƒ½å¤Ÿè¿”å›ä¸€ä¸ªå‘é‡ç›¸å¯¹äºæŸä¸ªæ³•å‘é‡çš„åå°„å‘é‡ï¼Œæ­£å¥½å°±æ˜¯æˆ‘ä»¬è¦çš„é•œé¢åå°„ç»“æœã€‚

```
// æ±‚å…‰æºä¸ç‚¹åæ ‡çš„æ–¹å‘å‘é‡
vec3 dir = (viewMatrix * vec4(pointLightPosition, 1.0)).xyz - vPos;

// å½’ä¸€åŒ–
dir = normalize(dir);

// æ±‚åå°„å‘é‡
vec3 reflectionLight = reflect(-dir, vNormal);
```

ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬è¦æ ¹æ®ç›¸æœºä½ç½®è®¡ç®—è§†çº¿ä¸åå°„å…‰çº¿å¤¹è§’çš„ä½™å¼¦ï¼Œç”¨åˆ°åŸç†æ˜¯å‘é‡çš„ç‚¹ä¹˜ã€‚

```
vec3 eyeDirection = vCameraPos - vPos;
eyeDirection = normalize(eyeDirection);
// ä¸è§†çº¿å¤¹è§’ä½™å¼¦
float eyeCos = max(dot(eyeDirection, reflectionLight), 0.0);
```

ç¬¬ä¸‰æ­¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ç³»æ•°å’ŒæŒ‡æ•°å‡½æ•°è®¾ç½®é•œé¢åå°„å¼ºåº¦ã€‚æŒ‡æ•°è¶Šå¤§ï¼Œé•œé¢è¶Šèšç„¦ï¼Œé«˜å…‰çš„å…‰æ–‘èŒƒå›´å°±è¶Šå°ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬æŒ‡æ•°å–50.0ï¼Œç³»æ•°å–2.0ã€‚ç³»æ•°èƒ½æ”¹å˜åå°„äº®åº¦ï¼Œç³»æ•°è¶Šå¤§ï¼Œåå°„çš„äº®åº¦å°±è¶Šé«˜ã€‚

```
float specular = 2.0 *  pow(eyeCos, 50.0);
```

æœ€åï¼Œæˆ‘ä»¬å°†æ¼«åå°„å’Œé•œé¢åå°„ç»“åˆèµ·æ¥ï¼Œå°±ä¼šè®©è·ç¦»å…‰æºè¿‘çš„ç‰©ä½“ä¸Šï¼Œå½¢æˆå…‰æ–‘ã€‚

```
// åˆæˆé¢œè‰²
gl_FragColor.rgb = specular + (ambientLight + diffuse) * materialReflection;
gl_FragColor.a = 1.0;
```

![](https://static001.geekbang.org/resource/image/36/09/36db1c0828a5a6e6aa1c4747431cee09.gif?wh=540%2A476%3Fwh%3D540%2A476)

ä¸Šé¢çš„ä»£ç æ˜¯ä»¥ç‚¹å…‰æºä¸ºä¾‹æ¥å®ç°çš„å…‰æ–‘ï¼Œå…¶å®åªè¦æ˜¯æœ‰å‘å…‰ï¼Œéƒ½å¯ä»¥ç”¨åŒæ ·çš„æ–¹æ³•æ±‚å‡ºé•œé¢åå°„ï¼Œåªä¸è¿‡å¯¹åº”çš„å…¥å°„å…‰æ–¹å‘è®¡ç®—æœ‰æ‰€ä¸åŒï¼Œä¹Ÿå°±æ˜¯ç€è‰²å™¨ä»£ç ä¸­çš„dirå˜é‡è®¡ç®—æ–¹å¼ä¸ä¸€æ ·ã€‚ ä½ å¯ä»¥åˆ©ç”¨æˆ‘ä¸ŠèŠ‚è¯¾è®²çš„å†…å®¹ï¼Œè‡ªå·±åŠ¨æ‰‹è¯•è¯•ã€‚

## å¦‚ä½•å®ç°å®Œæ•´çš„Phongåå°„æ¨¡å‹?

é‚£åœ¨è‡ªç„¶ç•Œä¸­ï¼Œé™¤äº†ç¯å¢ƒå…‰ä»¥å¤–ï¼Œå…¶ä»–æ¯ç§å…‰æºåœ¨ç©ºé—´ä¸­éƒ½å¯ä»¥å­˜åœ¨ä¸æ­¢ä¸€ä¸ªï¼Œè€Œä¸”å› ä¸ºå‡ ä½•ä½“æè´¨ä¸åŒï¼Œç‰©ä½“è¡¨é¢ä¹Ÿå¯èƒ½æ—¢å‡ºç°æ¼«åå°„ï¼Œåˆå‡ºç°é•œé¢åå°„ã€‚

å¯èƒ½å‡ºç°çš„æƒ…å†µè¿™ä¹ˆå¤šï¼Œåˆ†æå’Œè®¡ç®—èµ·æ¥ä¹Ÿä¼šéå¸¸å¤æ‚ã€‚ä¸ºäº†æ–¹ä¾¿å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå¤šç§å…‰æºå’Œä¸åŒæè´¨ç»“åˆèµ·æ¥ï¼Œå½¢æˆæ ‡å‡†çš„åå°„æ¨¡å‹ï¼Œè¿™ä¸€æ¨¡å‹è¢«ç§°ä¸º[Phongåå°„æ¨¡å‹](https://en.wikipedia.org/wiki/Phong_reflection_model)ã€‚

Phongåå°„æ¨¡å‹çš„å®Œæ•´å…¬å¼å¦‚ä¸‹ï¼š

$$  
I\_{\\mathrm{p}}=k\_{\\mathrm{a}} i\_{\\mathrm{a}}+\\sum\_{m \\in \\text { lights }}\\left(k\_{\\mathrm{d}}\\left(\\hat{L}\_{m} \\cdot \\hat{N}\\right) i\_{m, \\mathrm{d}}+k\_{\\mathrm{s}}\\left(\\hat{R}\_{m} \\cdot \\hat{V}\\right)^{\\alpha} i\_{m, \\mathrm{s}}\\right)  
$$

å…¬å¼é‡Œçš„$k\_{\\mathrm{a}}$ã€$k\_{\\mathrm{d}}$å’Œ$k\_{\\mathrm{s}}$åˆ†åˆ«å¯¹åº”ç¯å¢ƒåå°„ç³»æ•°ã€æ¼«åå°„ç³»æ•°å’Œé•œé¢åå°„ç³»æ•°ã€‚$\\hat{L}\_{m}$æ˜¯å…¥å°„å…‰ï¼Œ$N$æ˜¯æ³•å‘é‡ï¼Œ$\\hat{R}\_{m}$æ˜¯åå°„å…‰ï¼Œ$V$æ˜¯è§†çº¿å‘é‡ã€‚$i$æ˜¯å¼ºåº¦ï¼Œæ¼«åå°„å’Œé•œé¢åå°„çš„å¼ºåº¦å¯è€ƒè™‘å› ä¸ºè·ç¦»çš„è¡°å‡ã€‚$âº$æ˜¯å’Œç‰©ä½“æè´¨æœ‰å…³çš„å¸¸é‡ï¼Œå†³å®šäº†é•œé¢é«˜å…‰çš„èŒƒå›´ã€‚

æ ¹æ®ä¸Šé¢çš„å…¬å¼ï¼Œæˆ‘ä»¬æŠŠå¤šä¸ªå…‰ç…§çš„è®¡ç®—ç»“æœç›¸åŠ ï¼Œå°±èƒ½å¾—åˆ°å…‰ç…§ä¸‹å‡ ä½•ä½“çš„æœ€ç»ˆé¢œè‰²äº†ã€‚ä¸è¿‡ï¼Œè¿™é‡Œçš„Phongåå°„æ¨¡å‹å®é™…ä¸Šæ˜¯çœŸå®ç‰©ç†ä¸–ç•Œå…‰ç…§çš„ç®€åŒ–æ¨¡å‹ï¼Œå› ä¸ºå®ƒåªè€ƒè™‘å…‰æºçš„å…‰ä½œç”¨äºç‰©ä½“ï¼Œæ²¡æœ‰è€ƒè™‘å„ä¸ªç‰©ä½“ä¹‹é—´çš„åå°„å…‰ã€‚æ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆå®ç°å‡ºçš„æ•ˆæœä¹Ÿåªæ˜¯è‡ªç„¶ç•Œæ•ˆæœçš„ä¸€ç§è¿‘ä¼¼ï¼Œä¸è¿‡è¿™ç§è¿‘ä¼¼ä¹Ÿé«˜åº¦ç¬¦åˆçœŸå®æƒ…å†µäº†ã€‚

åœ¨ä¸€èˆ¬çš„å›¾å½¢åº“æˆ–è€…å›¾å½¢æ¡†æ¶ä¸­ï¼Œä¼šæä¾›ç¬¦åˆPhongåå°„æ¨¡å‹çš„ç‰©ä½“æè´¨ï¼Œæ¯”å¦‚ThreeJSä¸­ï¼Œå°±æ”¯æŒå„ç§å…‰æºå’Œåå°„æè´¨ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹å®Œæ•´çš„Phongåå°„æ¨¡å‹ã€‚å®ƒå¯ä»¥å¸®åŠ©ä½ å¯¹è¿™ä¸ªæ¨¡å‹æœ‰æ›´æ·±å…¥çš„ç†è§£ï¼Œè®©ä½ ä»¥åä½¿ç”¨ThreeJSç­‰å…¶ä»–å›¾å½¢åº“ï¼Œä¹Ÿèƒ½å¤Ÿæ›´åŠ å¾—å¿ƒåº”æ‰‹ã€‚æ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼šå®šä¹‰å…‰æºæ¨¡å‹ã€å®šä¹‰å‡ ä½•ä½“æè´¨å’Œå®ç°ç€è‰²å™¨ã€‚

### 1. å®šä¹‰å…‰æºæ¨¡å‹

æˆ‘ä»¬å…ˆæ¥å®šä¹‰å…‰æºæ¨¡å‹å¯¹è±¡ã€‚ç¯å¢ƒå…‰æ¯”è¾ƒç‰¹æ®Šï¼Œæˆ‘ä»¬å°†å®ƒå•ç‹¬æŠ½è±¡å‡ºæ¥ï¼Œæ”¾åœ¨ä¸€ä¸ªambientLightçš„å±æ€§ä¸­ï¼Œè€Œå…¶ä»–çš„å…‰æºä¸€å…±æœ‰5ä¸ªå±æ€§ä¸æè´¨æ— å…³ï¼Œæˆ‘åˆ—äº†ä¸€å¼ è¡¨æ”¾åœ¨äº†ä¸‹é¢ã€‚

![](https://static001.geekbang.org/resource/image/88/d2/88ec1e9768fa4047964b19f8fc3d7fd2.jpg?wh=1920%2A890)

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®šä¹‰ä¸€ä¸ªPhongç±»ã€‚è¿™ä¸ªç±»ç”±ä¸€ä¸ªç¯å¢ƒå…‰å±æ€§å’Œå…¶ä»–ä¸‰ç§å…‰æºçš„é›†åˆç»„åˆè€Œæˆï¼Œè¡¨ç¤ºä¸€ä¸ªå¯ä»¥æ·»åŠ å’Œåˆ é™¤å…‰æºçš„å¯¹è±¡ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯æ·»åŠ å’Œåˆ é™¤å…‰æºï¼Œå¹¶æŠŠå…‰æºçš„å±æ€§é€šè¿‡uniformsè®¿é—®å™¨å±æ€§è½¬æ¢æˆå¯¹åº”çš„uniformå˜é‡ï¼Œä¸»è¦çš„ä»£ç å¦‚ä¸‹ï¼š

```
class Phong {
  constructor(ambientLight = [0.5, 0.5, 0.5]) {
    this.ambientLight = ambientLight;
    this.directionalLights = new Set();
    this.pointLights = new Set();
    this.spotLights = new Set();
  }

  addLight(light) {
    const {position, direction, color, decay, angle} = light;
    if(!position && !direction) throw new TypeError('invalid light');
    light.color = color || [1, 1, 1];
    if(!position) this.directionalLights.add(light);
    else {
      light.decay = decay || [0, 0, 1];
      if(!angle) {
        this.pointLights.add(light);
      } else {
        this.spotLights.add(light);
      }
    }
  }

  removeLight(light) {
    if(this.directionalLights.has(light)) this.directionalLights.delete(light);
    else if(this.pointLights.has(light)) this.pointLights.delete(light);
    else if(this.spotLights.has(light)) this.spotLights.delete(light);
  }

  get uniforms() {
    const MAX_LIGHT_COUNT = 16; // æœ€å¤šæ¯ç§å…‰æºè®¾ç½®16ä¸ª
    this._lightData = this._lightData || {};
    const lightData = this._lightData;

    lightData.directionalLightDirection = lightData.directionalLightDirection || {value: new Float32Array(MAX_LIGHT_COUNT * 3)};
    lightData.directionalLightColor = lightData.directionalLightColor || {value: new Float32Array(MAX_LIGHT_COUNT * 3)};

    lightData.pointLightPosition = lightData.pointLightPosition || {value: new Float32Array(MAX_LIGHT_COUNT * 3)};
    lightData.pointLightColor = lightData.pointLightColor || {value: new Float32Array(MAX_LIGHT_COUNT * 3)};
    lightData.pointLightDecay = lightData.pointLightDecay || {value: new Float32Array(MAX_LIGHT_COUNT * 3)};

    lightData.spotLightDirection = lightData.spotLightDirection || {value: new Float32Array(MAX_LIGHT_COUNT * 3)};
    lightData.spotLightPosition = lightData.spotLightPosition || {value: new Float32Array(MAX_LIGHT_COUNT * 3)};
    lightData.spotLightColor = lightData.spotLightColor || {value: new Float32Array(MAX_LIGHT_COUNT * 3)};
    lightData.spotLightDecay = lightData.spotLightDecay || {value: new Float32Array(MAX_LIGHT_COUNT * 3)};
    lightData.spotLightAngle = lightData.spotLightAngle || {value: new Float32Array(MAX_LIGHT_COUNT)};

    [...this.directionalLights].forEach((light, idx) => {
      lightData.directionalLightDirection.value.set(light.direction, idx * 3);
      lightData.directionalLightColor.value.set(light.color, idx * 3);
    });

    [...this.pointLights].forEach((light, idx) => {
      lightData.pointLightPosition.value.set(light.position, idx * 3);
      lightData.pointLightColor.value.set(light.color, idx * 3);
      lightData.pointLightDecay.value.set(light.decay, idx * 3);
    });

    [...this.spotLights].forEach((light, idx) => {
      lightData.spotLightPosition.value.set(light.position, idx * 3);
      lightData.spotLightColor.value.set(light.color, idx * 3);
      lightData.spotLightDecay.value.set(light.decay, idx * 3);
      lightData.spotLightDirection.value.set(light.direction, idx * 3);
      lightData.spotLightAngle.value[idx] = light.angle;
    });

    return {
      ambientLight: {value: this.ambientLight},
      ...lightData,
    };
  }
}
```

æœ‰äº†è¿™ä¸ªç±»ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºå¹¶æ·»åŠ å„ç§å…‰æºäº†ã€‚æˆ‘åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæ·»åŠ äº†ä¸€ä¸ªå¹³è¡Œå…‰å’Œä¸¤ä¸ªç‚¹å…‰æºï¼Œä½ å¯ä»¥çœ‹çœ‹ã€‚

```
const phong = new Phong();
// æ·»åŠ ä¸€ä¸ªå¹³è¡Œå…‰
phong.addLight({
  direction: [-1, 0, 0],
});
// æ·»åŠ ä¸¤ä¸ªç‚¹å…‰æº
phong.addLight({
  position: [-3, 3, 0],
  color: [1, 0, 0],
});

phong.addLight({
  position: [3, 3, 0],
  color: [0, 0, 1],
});
```

### 2. å®šä¹‰å‡ ä½•ä½“æè´¨

å®šä¹‰å®Œå…‰æºä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰å‡ ä½•ä½“çš„**æè´¨**ï¼ˆmaterialï¼‰ï¼Œå› ä¸ºå‡ ä½•ä½“æè´¨å†³å®šäº†å…‰åå°„çš„æ€§è´¨ã€‚

åœ¨å‰é¢çš„è¯¾ç¨‹é‡Œï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†ä¸€ç§ä¸å‡ ä½•ä½“æè´¨æœ‰å…³çš„å˜é‡ï¼Œå³ç‰©ä½“çš„åå°„ç‡ï¼ˆMaterialReflectionï¼‰ã€‚é‚£åœ¨å‰é¢è®¡ç®—é•œé¢åå°„çš„å…¬å¼ï¼Œfloat specular = 2.0 * pow(eyeCos, 50.0);ä¸­ä¹Ÿæœ‰ä¸¤ä¸ªå¸¸é‡2.0å’Œ50.0ï¼ŒæŠŠå®ƒä»¬ä¹Ÿæå–å‡ºæ¥ï¼Œæˆ‘ä»¬å°±èƒ½å¾—åˆ°ä¸¤ä¸ªæ–°çš„å˜é‡ã€‚å…¶ä¸­ï¼Œ2.0å¯¹åº”specularFactorï¼Œè¡¨ç¤ºé•œé¢åå°„å¼ºåº¦ï¼Œ50.0æŒ‡çš„æ˜¯shininessï¼Œè¡¨ç¤ºé•œé¢åå°„çš„å…‰æ´åº¦ã€‚

è¿™æ ·ï¼Œæˆ‘ä»¬å°±æœ‰äº†3ä¸ªä¸æè´¨æœ‰å…³çš„å˜é‡ï¼Œåˆ†åˆ«æ˜¯matrialReflection ï¼ˆæè´¨åå°„ç‡ï¼‰ã€specularFactor ï¼ˆé•œé¢åå°„å¼ºåº¦ï¼‰ã€ä»¥åŠshininess ï¼ˆé•œé¢åå°„å…‰æ´åº¦ï¼‰ã€‚

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªMatrialç±»ï¼Œæ¥å®šä¹‰ç‰©ä½“çš„æè´¨ã€‚ä¸å…‰æºç±»ç›¸æ¯”ï¼Œè¿™ä¸ªç±»éå¸¸ç®€å•ï¼Œåªæ˜¯è®¾ç½®è¿™ä¸‰ä¸ªå‚æ•°ï¼Œå¹¶é€šè¿‡uniformsè®¿é—®å™¨å±æ€§ï¼Œè·å¾—å®ƒçš„uniformæ•°æ®ç»“æ„å½¢å¼ã€‚

```
class Material {
  constructor(reflection, specularFactor = 0, shininess = 50) {
    this.reflection = reflection;
    this.specularFactor = specularFactor;
    this.shininess = shininess;
  }

  get uniforms() {
    return {
      materialReflection: {value: this.reflection},
      specularFactor: {value: this.specularFactor},
      shininess: {value: this.shininess},
    };
  }
}

```

é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºmatrialå¯¹è±¡äº†ã€‚è¿™é‡Œï¼Œæˆ‘ä¸€å…±åˆ›å»º4ä¸ªmatrialå¯¹è±¡ï¼Œåˆ†åˆ«å¯¹åº”è¦æ˜¾ç¤ºçš„å››ä¸ªå‡ ä½•ä½“çš„æè´¨ã€‚

```
const matrial1 = new Material(new Color('#0000ff'), 2.0);
const matrial2 = new Material(new Color('#ff00ff'), 2.0);
const matrial3 = new Material(new Color('#008000'), 2.0);
const matrial4 = new Material(new Color('#ff0000'), 2.0);
```

æœ‰äº†phongå¯¹è±¡å’Œmatrialå¯¹è±¡ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»™å‡ ä½•ä½“åˆ›å»ºWebGLç¨‹åºäº†ã€‚é‚£æˆ‘ä»¬å°±ä½¿ç”¨ä¸Šé¢å››ä¸ªWebGLç¨‹åºï¼Œæ¥åˆ›å»ºçœŸæ­£çš„å‡ ä½•ä½“ç½‘æ ¼ï¼Œå¹¶å°†å®ƒä»¬æ¸²æŸ“å‡ºæ¥å§ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```
const program1 = new Program(gl, {
  vertex,
  fragment,
  uniforms: {
    ...matrial1.uniforms,
    ...phong.uniforms,
  },
});
const program2 = new Program(gl, {
  vertex,
  fragment,
  uniforms: {
    ...matrial2.uniforms,
    ...phong.uniforms,
  },
});
const program3 = new Program(gl, {
  vertex,
  fragment,
  uniforms: {
    ...matrial3.uniforms,
    ...phong.uniforms,
  },
});
const program4 = new Program(gl, {
  vertex,
  fragment,
  uniforms: {
    ...matrial4.uniforms,
    ...phong.uniforms,
  },
});
```

### 3. å®ç°ç€è‰²å™¨

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹ï¼Œæ”¯æŒphongåå°„æ¨¡å‹çš„ç‰‡å…ƒç€è‰²å™¨ä»£ç æ˜¯æ€ä¹ˆå®ç°çš„ã€‚è¿™ä¸ªç€è‰²å™¨ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬ä¸€æ®µä¸€æ®µæ¥çœ‹ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹å…‰ç…§ç›¸å…³çš„uniformå˜é‡çš„å£°æ˜ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å£°æ˜äº†vec3å’Œfloatæ•°ç»„ï¼Œæ•°ç»„çš„å¤§å°ä¸º16ã€‚è¿™æ ·ï¼Œå¯¹äºæ¯ä¸€ç§å…‰æºï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æ”¯æŒ16ä¸ªã€‚

```
#define MAX_LIGHT_COUNT 16
uniform mat4 viewMatrix;

uniform vec3 ambientLight;
uniform vec3 directionalLightDirection[MAX_LIGHT_COUNT];
uniform vec3 directionalLightColor[MAX_LIGHT_COUNT];
uniform vec3 pointLightColor[MAX_LIGHT_COUNT];
uniform vec3 pointLightPosition[MAX_LIGHT_COUNT];
uniform vec3 pointLightDecay[MAX_LIGHT_COUNT];
uniform vec3 spotLightColor[MAX_LIGHT_COUNT];
uniform vec3 spotLightDirection[MAX_LIGHT_COUNT];
uniform vec3 spotLightPosition[MAX_LIGHT_COUNT];
uniform vec3 spotLightDecay[MAX_LIGHT_COUNT];
uniform float spotLightAngle[MAX_LIGHT_COUNT];

uniform vec3 materialReflection;
uniform float shininess;
uniform float specularFactor;
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®ç°è®¡ç®—phongåå°„æ¨¡å‹çš„ä¸»é¢˜é€»è¾‘ã€‚äº‹å®ä¸Šï¼Œå¤„ç†å¹³è¡Œå…‰ã€ç‚¹å…‰æºã€èšå…‰ç¯çš„ä¸»ä½“é€»è¾‘ç±»ä¼¼ï¼Œéƒ½æ˜¯å¾ªç¯å¤„ç†æ¯ä¸ªå…‰æºï¼Œå†è®¡ç®—å…¥å°„å…‰æ–¹å‘ï¼Œç„¶åè®¡ç®—æ¼«åå°„ä»¥åŠé•œé¢åå°„ï¼Œæœ€ç»ˆå°†ç»“æœè¿”å›ã€‚

```
float getSpecular(vec3 dir, vec3 normal, vec3 eye) {
  vec3 reflectionLight = reflect(-dir, normal);
  float eyeCos = max(dot(eye, reflectionLight), 0.0);
  return specularFactor *  pow(eyeCos, shininess);
}
      
vec4 phongReflection(vec3 pos, vec3 normal, vec3 eye) {
  float specular = 0.0;
  vec3 diffuse = vec3(0);
  
  // å¤„ç†å¹³è¡Œå…‰
  for(int i = 0; i < MAX_LIGHT_COUNT; i++) {
    vec3 dir = directionalLightDirection[i];
    if(dir.x == 0.0 && dir.y == 0.0 && dir.z == 0.0) continue;
    vec4 d = viewMatrix * vec4(dir, 0.0);
    dir = normalize(-d.xyz);
    float cos = max(dot(dir, normal), 0.0);
    diffuse += cos * directionalLightColor[i];
    specular += getSpecular(dir, normal, eye);
  }

  // å¤„ç†ç‚¹å…‰æº
  for(int i = 0; i < MAX_LIGHT_COUNT; i++) {
    vec3 decay = pointLightDecay[i];
    if(decay.x == 0.0 && decay.y == 0.0 && decay.z == 0.0) continue;
    vec3 dir = (viewMatrix * vec4(pointLightPosition[i], 1.0)).xyz - pos;
    float dis = length(dir);
    dir = normalize(dir);
    float cos = max(dot(dir, normal), 0.0);
    float d = min(1.0, 1.0 / (decay.x * pow(dis, 2.0) + decay.y * dis + decay.z));
    diffuse += d * cos * pointLightColor[i];
    specular += getSpecular(dir, normal, eye);
  }

  // å¤„ç†èšå…‰ç¯
  for(int i = 0; i < MAX_LIGHT_COUNT; i++) {
    vec3 decay = spotLightDecay[i];
    if(decay.x == 0.0 && decay.y == 0.0 && decay.z == 0.0) continue;

    vec3 dir = (viewMatrix * vec4(spotLightPosition[i], 1.0)).xyz - pos;
    float dis = length(dir);
    dir = normalize(dir);

    // èšå…‰ç¯çš„æœå‘
    vec3 spotDir = (viewMatrix * vec4(spotLightDirection[i], 0.0)).xyz;
    // é€šè¿‡ä½™å¼¦å€¼åˆ¤æ–­å¤¹è§’èŒƒå›´
    float ang = cos(spotLightAngle[i]);
    float r = step(ang, dot(dir, normalize(-spotDir)));

    float cos = max(dot(dir, normal), 0.0);
    float d = min(1.0, 1.0 / (decay.x * pow(dis, 2.0) + decay.y * dis + decay.z));
    diffuse += r * d * cos * spotLightColor[i];
    specular += r * getSpecular(dir, normal, eye);
  }

  return vec4(diffuse, specular);
}
```

æœ€åï¼Œæˆ‘ä»¬åœ¨mainå‡½æ•°ä¸­ï¼Œè°ƒç”¨phongReflectionå‡½æ•°æ¥åˆæˆé¢œè‰²ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
void main() {
  vec3 eyeDirection = normalize(vCameraPos - vPos);
  vec4 phong = phongReflection(vPos, vNormal, eyeDirection);

  // åˆæˆé¢œè‰²
  gl_FragColor.rgb = phong.w + (phong.xyz + ambientLight) * materialReflection;
  gl_FragColor.a = 1.0;
}
```

æœ€ç»ˆå‘ˆç°çš„è§†è§‰æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://static001.geekbang.org/resource/image/36/09/36db1c0828a5a6e6aa1c4747431cee09.gif?wh=540%2A476%3Fwh%3D540%2A476)

ä½ æ³¨æ„ä¸€ä¸‹ä¸Šå›¾å³ä¾§çš„çƒä½“ã€‚å› ä¸ºæˆ‘ä»¬ä¸€å…±è®¾ç½®äº†3ä¸ªå…‰æºï¼Œä¸€ä¸ªå¹³è¡Œå…‰ã€ä¸¤ä¸ªç‚¹å…‰æºï¼Œå®ƒä»¬éƒ½èƒ½å¤Ÿäº§ç”Ÿé•œé¢åå°„ã€‚æ‰€ä»¥ï¼Œè¿™äº›å…‰æºå åŠ åœ¨ä¸€èµ·åï¼Œè¿™ä¸ªçƒä½“å°±å‘ˆç°å‡º3ä¸ªé•œé¢é«˜å…‰ã€‚

## Phongåå°„æ¨¡å‹çš„å±€é™æ€§

è™½ç„¶ï¼Œphongåå°„æ¨¡å‹å·²ç»æ¯”è¾ƒæ¥è¿‘äºçœŸå®çš„ç‰©ç†æ¨¡å‹ï¼Œä¸è¿‡å®ƒä»ç„¶æ˜¯çœŸå®æ¨¡å‹çš„ä¸€ç§è¿‘ä¼¼ã€‚å› ä¸ºå®ƒæ²¡æœ‰è€ƒè™‘ç‰©ä½“åå°„å…‰å¯¹å…¶ä»–ç‰©ä½“çš„å½±å“ï¼Œä¹Ÿæ²¡æœ‰è€ƒè™‘ç‰©ä½“å¯¹å…‰çº¿é®æŒ¡äº§ç”Ÿçš„é˜´å½±ã€‚

å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥å®Œå–„è¿™ä¸ªæ¨¡å‹ã€‚æ¯”å¦‚ï¼Œå°†ç‰©ä½“æœ¬èº«åå°„å…‰ï¼ˆä¸»è¦æ˜¯é•œé¢åå°„å…‰ï¼‰å¯¹å…¶ä»–ç‰©ä½“çš„å½±å“çº³å…¥åˆ°æ¨¡å‹ä¸­ã€‚å¦å¤–ï¼Œæˆ‘ä»¬ä¹Ÿè¦è€ƒè™‘ç‰©ä½“çš„é˜´å½±ã€‚å½“æˆ‘ä»¬æŠŠè¿™äº›å› ç´ æ›´å¤šåœ°è€ƒè™‘è¿›å»çš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„æ¨¡å‹å°±ä¼šæ›´åŠ æ¥è¿‘çœŸå®ä¸–ç•Œçš„ç‰©ç†æ¨¡å‹ã€‚

å½“æˆ‘ä»¬æ¸²æŸ“3Då›¾å½¢çš„æ—¶å€™ï¼Œè¦å‘ˆç°è¶Šæ¥è¿‘çœŸå®çš„æ•ˆæœï¼Œå¾€å¾€è¦è€ƒè™‘æ›´å¤šçš„å‚æ•°ï¼Œå› æ­¤æ‰€éœ€çš„è®¡ç®—é‡ä¹Ÿè¶Šå¤§ï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦æœ‰æ›´å¼ºçš„æ¸²æŸ“èƒ½åŠ›ï¼Œæ¯”å¦‚ï¼Œæ›´å¥½çš„æ˜¾å¡ï¼Œæ›´å¿«çš„CPUå’ŒGPUï¼Œå¹¶ä¸”ä¹Ÿéœ€è¦æˆ‘ä»¬å°½å¯èƒ½åœ°ä¼˜åŒ–è®¡ç®—çš„æ€§èƒ½ã€‚

ä½†æ˜¯ï¼Œæœ‰å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç»†èŠ‚å’Œæ€§èƒ½ä¸Šåšå‡ºå¹³è¡¡å’Œå–èˆã€‚é‚£æ€§èƒ½ä¼˜åŒ–çš„éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬è¯¾ç¨‹çš„é‡ç‚¹ï¼Œæˆ‘ä¼šåœ¨æ€§èƒ½ç¯‡è¯¦ç»†æ¥è®²ã€‚è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±é‡ç‚¹å…³æ³¨åå°„æ¨¡å‹ï¼Œæ€»ç»“å‡ºå®Œæ•´çš„Phongåå°„æ¨¡å‹å°±å¯ä»¥äº†ã€‚

## è¦ç‚¹æ€»ç»“

ä»Šå¤©ï¼Œæˆ‘ä»¬æŠŠç¯å¢ƒå…‰ã€å¹³è¡Œå…‰ã€ç‚¹å…‰æºã€èšå…‰ç¯è¿™å››ç§å…‰æºæ•´åˆï¼Œå¹¶ä¸”åœ¨ä¸ŠèŠ‚è¯¾è®²çš„æ¼«åå°„çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº†é•œé¢åå°„ï¼Œå½¢æˆäº†å®Œæ•´çš„Phongåå°„æ¨¡å‹ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å®ç°çš„ç€è‰²å™¨ä»£ç èƒ½å¤Ÿç»“åˆå››ç§å…‰æºçš„æ•ˆæœï¼Œé™¤äº†ç¯å¢ƒå…‰å¤–ï¼Œæ¯ç§å…‰æºè¿˜å¯ä»¥è®¾ç½®å¤šä¸ªã€‚

åœ¨Phongåå°„æ¨¡å‹ä¸­ï¼Œå…‰ç…§åœ¨ç‰©ä½“ä¸Šçš„æœ€ç»ˆæ•ˆæœï¼Œç”±å„ä¸ªå…‰æºçš„æ€§è´¨ï¼ˆå‚æ•°ï¼‰å’Œç‰©ä½“çš„è¡¨é¢æè´¨å…±åŒå†³å®šã€‚

Phongåå°„æ¨¡å‹ä¹Ÿåªæ˜¯çœŸå®ä¸–ç•Œçš„ä¸€ç§è¿‘ä¼¼ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰è€ƒè™‘ç‰©ä½“ä¹‹é—´åå°„å…‰çš„ç›¸äº’å½±å“ï¼Œä¹Ÿæ²¡æœ‰è€ƒè™‘å…‰çº¿çš„é®æŒ¡ã€‚å¦‚æœæŠŠè¿™äº›å› ç´ è€ƒè™‘è¿›å»ï¼Œé‚£æˆ‘ä»¬çš„æ¨¡å‹å¯ä»¥æ›´æ¥è¿‘çœŸå®ä¸–ç•Œäº†ã€‚

## å°è¯•ç‰›åˆ€

æˆ‘ä»¬çŸ¥é“ï¼Œå¹³è¡Œå…‰ã€ç‚¹å…‰æºå’Œèšå…‰ç¯æ˜¯ä¸‰ç§å¸¸è§çš„æ–¹å‘å…‰ï¼Œä½†çœŸå®ä¸–ç•Œè¿˜æœ‰å…¶ä»–çš„æ–¹å‘å…‰ï¼Œæ¯”å¦‚æ¢ç…§ç¯ï¼Œå®ƒæ˜¯ä¸€ç§æœ‰èŒƒå›´çš„å¹³è¡Œå…‰ï¼Œç±»ä¼¼äºèšå…‰ç¯ï¼Œä½†åˆä¸å®Œå…¨ä¸€æ ·ã€‚ä½ èƒ½ç»™ç‰©ä½“å®ç°æ¢ç…§ç¯æ•ˆæœå—ï¼Ÿ

è¿™é‡Œï¼Œæˆ‘å…ˆæŠŠéœ€è¦ç”¨åˆ°çš„å‚æ•°å‘Šè¯‰ä½ ï¼ŒåŒ…æ‹¬å…‰æºæ–¹å‘searchLightDirectionã€å…‰æºåŠå¾„searchLightRadiusã€å…‰æºä½ç½®searchLightPositionã€å…‰ç…§é¢œè‰²searchLightColorã€‚ä½ å¯ä»¥ç”¨OGLå®ç°æ¢ç…§ç¯æ•ˆæœï¼Œç„¶åæŠŠå¯¹åº”çš„ç€è‰²å™¨ä»£ç å†™åœ¨ç•™è¨€åŒºã€‚

![](https://static001.geekbang.org/resource/image/ce/6d/ce4bcyye0f4ac139625d96a2d5aeb06d.jpeg?wh=1920%2A881 "æ¢ç…§ç¯ç¤ºæ„å›¾")

è€Œä¸”ï¼Œæ¢ç…§ç¯çš„å…‰ç…§æˆªé¢ä¸ä¸€å®šæ˜¯åœ†å½¢ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶ä»–å›¾å½¢ï¼Œæ¯”å¦‚ä¸‰è§’å½¢ã€è±å½¢ã€æ­£æ–¹å½¢ï¼Œä½ ä¹Ÿå¯ä»¥è¯•ç€è®©å®ƒæ”¯æŒä¸åŒçš„å…‰ç…§æˆªé¢ã€‚

æ¬¢è¿åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œåˆ†äº«ä½ çš„ç­”æ¡ˆå’Œæ€è€ƒï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼

* * *

## æºç 

è¯¾ç¨‹ä¸­å®Œæ•´ä»£ç è¯¦è§[GitHubä»“åº“](https://github.com/akira-cn/graphics/tree/master/lights)

## æ¨èé˜…è¯»

[Phongåå°„æ¨¡å‹ç®€ä»‹](https://en.wikipedia.org/wiki/Phong_reflection_mode)
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ7ï¼‰</strong></div><ul>
<li><span>å“ˆç€æœ‹å‹</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>åŸºæœ¬ç­‰åŒäºæŠŠè®¡ç®—æœºå›¾å½¢å­¦å¤ä¹ äº†ä¸€éå“¦</p>2021-09-23</li><br/><li><span>é‡å­è”·è–‡</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å°è¯•ç‰›åˆ€ï¼Œè¿™æ˜¯åœ†å½¢æ¢ç…§ç¯çš„å®ç°ï¼š
&#47;&#47; æ¢ç…§ç¯
for (int i = 0; i &lt; MAX_LIGHT_COUNT; i++) {
    vec3 decay = searchLightDecay[i];
    if (decay.x == 0.0 &amp;&amp; decay.y == 0.0 &amp;&amp; decay.z == 0.0) {
        continue;
    }
    vec3 dir = (viewMatrix * vec4(searchLightDirection[i], 0.0)).xyz;
    dir = normalize(-dir);
    float c = max(dot(dir, normal), 0.0);
    vec3 v = (viewMatrix * vec4(searchLightPosition[i], 1.0)).xyz - pos;
    float l = dot(v, dir);
    float d = min(1.0, 1.0 &#47; (decay.x * pow(l, 2.0) + decay.y * l + decay.z));
    float r = step(length(v - dir * l), searchLightRadius[i]) * step(0.0, dot(v, dir));
    vec3 color = searchLightColor[i];
    diffuse += c * d * r * color;
    specular += getSpecular(dir, normal, eye) * d * r * color;
}
æ³¨æ„æˆ‘çš„ specular æ˜¯ vec3 å’Œè€å¸ˆçš„ä¸ä¸€æ ·ã€‚
å…¥å°„å…‰çš„æ–¹å‘ dir çš„è®¡ç®—ç±»ä¼¼å¹³è¡Œå…‰ï¼Œä¸å—å…‰æºä½ç½®çš„å½±å“ã€‚
v æ˜¯å½“å‰åæ ‡åˆ°æ¢ç…§ç¯åœ†å¿ƒçš„å‘é‡ï¼Œä¸ dir ç‚¹ä¹˜åå°±å¯ä»¥å¾—åˆ° v å¹³è¡Œäº dir æ–¹å‘çš„åˆ†é‡çš„é•¿åº¦ lï¼ˆå› ä¸º dir æ˜¯å•ä½å‘é‡ï¼Œæ‰€ä»¥çœå»äº† é™¤ä»¥ length(dir) çš„æ“ä½œï¼‰ã€‚
d æ˜¯å’Œè€å¸ˆä¸€æ ·çš„ç®—æ³•å¾—åˆ°çš„è¡°å‡ç³»æ•°ã€‚
r æ˜¯å®ç°åœ†å½¢å…‰ç…§èŒƒå›´çš„å…³é”®ï¼Œå‰é¢å·²ç»å¾—åˆ°äº† v å¹³è¡Œäº dir çš„åˆ†é‡çš„é•¿åº¦ lï¼Œdir * l å°±å¯ä»¥å¾—åˆ°çœŸæ­£çš„åˆ†é‡ vâˆ¥ï¼Œå†ç”¨ v - vâˆ¥ å¾—åˆ° vâŠ¥ï¼Œä¹Ÿå°±æ˜¯ v å‚ç›´äº dir çš„åˆ†é‡ï¼Œæ¯”è¾ƒ vâŠ¥ çš„é•¿åº¦ä¸æ¢ç…§ç¯åŠå¾„çš„å¤§å°å°±èƒ½çŸ¥é“å½“å‰åæ ‡æ˜¯å¦åœ¨æ¢ç…§ç¯çš„èŒƒå›´å†…ï¼ˆä»¥ä¸Šå…¶å®å°±æ˜¯ç‚¹ä¹˜åœ¨å‘é‡åˆ†è§£ä¸Šçš„åº”ç”¨ï¼‰ã€‚
è‡³æ­¤ï¼Œè¿˜æ²¡æœ‰ç»“æŸï¼Œæ¢ç…§ç¯æ˜¯æœ‰ position å±æ€§çš„ï¼Œå› æ­¤ä½äºæ¢ç…§ç¯ç…§å°„æ–¹å‘èƒŒé¢180Â°èŒƒå›´å†…çš„ç‰©ä½“ä¸åº”è¯¥è¢«ç…§äº®ï¼Œè¿™æ˜¯æ¢ç…§ç¯ä¸å¹³è¡Œå…‰çš„å¦ä¸€ä¸ªåŒºåˆ«ã€‚æ‰€ä»¥éœ€è¦åˆ¤æ–­æ¢ç…§ç¯åœ†å¿ƒåˆ°å½“å‰åæ ‡çš„å‘é‡ä¹Ÿå°±æ˜¯ -v ä¸ç…§å°„æ–¹å‘ä¹Ÿå°±æ˜¯ -dirï¼ˆdir åœ¨ normalize æ—¶å–åäº†ï¼Œæ‰€ä»¥è¿™é‡Œå†å–åè¡¨ç¤ºç…§å°„çš„æ–¹å‘ï¼‰æ˜¯å¦åŒå‘ï¼Œæˆ–è€…è¯´å¤¹è§’æ˜¯å¦å°äº 90Â°ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­ dot(-v, -dir) æ˜¯å¦å¤§äºé›¶ï¼Œdot(v, dir) ä¸ dot(-v, -dir) çš„ç»“æœæ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥çœå»äº†å–åçš„æ“ä½œã€‚</p>2022-11-02</li><br/><li><span>åº</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>è¯¾åç»ƒä¹ ï¼Œä¸‰è§’å½¢ã€è±å½¢ã€æ­£æ–¹å½¢ç­‰å¤šè¾¹å½¢å…‰ç…§æˆªé¢æ¢ç…§ç¯æ€è·¯ï¼š
1.å…‰ç…§æˆªé¢ä½œä¸‰è§’å‰–åˆ†
2.åæ ‡ç‚¹ä¸æ¯ä¸ªå‰–åˆ†å‡ºæ¥çš„ä¸‰è§’å½¢ç»„æˆå››é¢ä½“ï¼ŒæŠŠå‰–åˆ†å‡ºæ¥çš„ä¸‰è§’å½¢ä¸‰è§’å½¢å½“åšå››é¢ä½“çš„åº•é¢
3.åˆ¤æ–­æ¯ä¸ªå››é¢ä½“åº•é¢ä¸å…¶ä»–ä¸‰ä¸ªé¢çš„å¤¹è§’ï¼Œå¦‚æœä¸‰ä¸ªå¤¹è§’éƒ½å°äºç­‰äº90åº¦ï¼Œè¯´æ˜è¯¥åæ ‡ç‚¹èƒ½è¢«æ¢ç…§åˆ°
4.è®¡ç®—ä¸¤ä¸ªé¢çš„å¤¹è§’å¯ä»¥ç”¨ä¸¤ä¸ªé¢çš„æ³•å‘é‡è®¡ç®—</p>2024-06-22</li><br/><li><span>åº</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å­—æ•°é™åˆ¶ï¼Œæ¥ä¸Šä¸€ä¸ªè¯„è®ºï¼Œè¡¥ä¸Šé¡¶ç‚¹ç€è‰²å™¨ä»£ç å’Œç¤ºä¾‹ç¯å…‰è¾“å…¥ï¼š
const vertex = &#47;* glsl *&#47; `
      precision highp float;

      attribute vec3 position;
      attribute vec3 normal;
      uniform mat4 modelViewMatrix;
      uniform mat4 projectionMatrix;
      uniform mat3 normalMatrix;

      varying vec3 vNormal;
      varying vec3 vPos;

      void main() {
        vec4 pos = modelViewMatrix * vec4(position, 1.0);
        vPos = pos.xyz;
        vNormal = normalize(normalMatrix * normal);
        gl_Position = projectionMatrix * pos;
      }
    `;

const ambientLight = {value: [0.2, 0.2, 0.1]};

  const directional = {
    searchLightPosition: {value: [3, 3, 0]},
    searchLightDirection: {value: [-1, -1, 0]},
    searchLightRadius: {value: 1},
    searchLightColor: {value: [1, 1, 1]},
  };</p>2024-06-22</li><br/><li><span>åº</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>åœ†å½¢æ¢ç…§ç¯æ€è·¯ï¼Œä¸è¿‡ç”¨äº†äºŒæ¬¡æ–¹å’Œå¼€æ–¹ï¼Œåº”è¯¥æœ‰æ›´é«˜æ•ˆçš„æ–¹æ³•

const fragment = &#47;* glsl *&#47; `
      precision highp float;

      uniform mat4 viewMatrix;
      uniform vec3 ambientLight;
      uniform vec3 materialReflection;

      uniform vec3 searchLightDirection;
      uniform float searchLightRadius;
      uniform vec3 searchLightPosition;
      uniform vec3 searchLightColor;

      varying vec3 vNormal;
      varying vec3 vPos;

      void main() {
        &#47;&#47; åœ†å¿ƒä¸Šæ–¹å‘å‘é‡ dir
        vec3 dir = (viewMatrix * vec4(searchLightDirection, 0.0)).xyz;
        &#47;&#47; åœ†å¿ƒåˆ°å½“å‰ç‚¹å‘é‡åå‘ invLight
        vec3 invLight = (viewMatrix * vec4(searchLightPosition, 1.0)).xyz - vPos;
        vec3 invNormal = normalize(invLight);
        &#47;&#47; dir,invLightå¤¹è§’åœ¨å¤§äº-90åº¦åˆ°90åº¦æ—¶ï¼Œæ‰èƒ½ç…§åˆ°
        &#47;&#47; å½“å‰ç‚¹åˆ°åœ†å¿ƒæ‰€åœ¨æ–¹å‘çº¿çš„è·ç¦»ï¼Œå°äºåŠå¾„ï¼Œè¯´æ˜èƒ½ç…§åˆ°
        float cosTheta = dot(invNormal, normalize(-dir));
        float r1 = step(0.0, cosTheta);
        float r2 = step(length(invLight) * sqrt( 1.0 - cosTheta * cosTheta),searchLightRadius); &#47;&#47; ç”¨äº†äºŒæ¬¡æ–¹å’Œå¼€æ–¹ï¼Œæ„Ÿè§‰æœ‰æ›´å¥½çš„æ–¹æ³•
        &#47;&#47; if (cosTheta &gt;= 0.0 &amp;&amp; length(invLight) * sqrt( 1.0 - cosTheta * cosTheta) &lt;= searchLightRadius) {
        &#47;&#47; æ–¹å‘æ˜¯dir
        vec3 dirNormal = normalize(dir);
        &#47;&#47; å…‰çº¿åˆ°ç‚¹åæ ‡çš„è·ç¦»ï¼Œç”¨æ¥è®¡ç®—è¡°å‡
        &#47;&#47; float dis = length(invLight) * cosTheta;
        &#47;&#47; ä¸æ³•çº¿å¤¹è§’ä½™å¼¦
        float cos = max(dot(invNormal, vNormal), 0.0);
        vec3 diffuse =  r1 * r2 * cos * searchLightColor;
        gl_FragColor.rgb = (ambientLight + diffuse) * materialReflection;
        &#47;&#47; } else {
        &#47;&#47;   gl_FragColor.rgb = (ambientLight) * materialReflection;
        &#47;&#47; }
        gl_FragColor.a = 1.0;
      }
    `;
</p>2024-06-22</li><br/><li><span>Geek_00734e</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>void main() {
        &#47;&#47; å…‰çº¿åˆ°ç‚¹åæ ‡çš„æ–¹å‘
        vec3 invLight = (viewMatrix * vec4(searchLightPosition, 1.0)).xyz - vPos;
        &#47;&#47; vec3 invLight = searchLightPosition - vPos;
        vec3 invNormal = normalize(invLight);
        &#47;&#47; å…‰çº¿åˆ°ç‚¹åæ ‡çš„è·ç¦»ï¼Œç”¨æ¥è®¡ç®—è¡°å‡
        float dis = length(invLight);
        &#47;&#47; æ±‚å…‰çº¿ä¸­å¿ƒä¸æ³•çº¿å¤¹è§’çš„ä½™å¼¦
        float cosmid = max(dot(normalize(vDir), vNormal), 0.0);
        &#47;&#47; æ±‚å…‰çº¿ä¸æ³•çº¿å¤¹è§’çš„ä½™å¼¦
        float cosa = max(dot(invNormal, vNormal), 0.0);
        &#47;&#47; ç…§å°„èŒƒå›´åŠå¾„
        float radius = searchLightRadius &#47; cosmid;
        &#47;&#47; å…‰çº¿ä¸­å¿ƒå°„çº¿ä¸å°„çº¿å¤¹è§’
        float cosb = max(dot(normalize(vDir), invNormal), 0.0);
        &#47;&#47; æ ¹æ®æ­£å¼¦å®šç†æ±‚å¯¹åº”è¾¹é•¿åº¦
        float sinb = sqrt(1.0 - cosb * cosb);
        float sinc = sin(PI&#47;2.0 - acos(cosa) - acos(cosb));
        float lenb = dis * sinb &#47; sinc;
        &#47;&#47; è¾¹é•¿åº¦å°äºåŠå¾„çš„ä¸º1.0
        float r = step(lenb, radius);
        &#47;&#47; è®¡ç®—è¡°å‡
        float decay = min(1.0, 1.0 &#47;
          (searchLightDecayFactor.x * pow(dis, 2.0) + searchLightDecayFactor.y * dis + searchLightDecayFactor.z));
        &#47;&#47; è®¡ç®—æ¼«åå°„
        vec3 diffuse = r * decay * cosmid * searchLightColor;
        
        &#47;&#47; åˆæˆé¢œè‰²
        gl_FragColor.rgb = (ambientLight + diffuse) * materialReflection;
        gl_FragColor.a = 1.0;
      }
æ¢ç…§ç¯  ä½†æ˜¯æ„Ÿè§‰ç®—æ³• ä¸å¤Ÿå®Œç¾ï¼Œå®åœ¨æ‰¾ä¸åˆ°åˆé€‚çš„æ€è·¯äº†</p>2022-01-19</li><br/><li><span>Geek_00734e</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ¢ç…§ç¯é‚£ä¸ªè¯¾åä½œä¸šæœ‰ç­”æ¡ˆå—ï¼Ÿæ€æ¥æƒ³å»åšä¸å‡ºæ¥ï¼Œæˆ‘çš„æ€è·¯æ˜¯æ±‚å…‰æºä¸­å¿ƒå°„çº¿è·Ÿç•Œé¢çš„äº¤ç‚¹ï¼Œå…‰çº¿ç…§å°„åˆ°çš„èŒƒå›´ä¸º r&#47;cos(Î¸)  ï¼ˆÎ¸ä¸ºå…‰çº¿ä¸ç•Œé¢æ³•çº¿å¤¹è§’), å¯æ˜¯è¿™ä¸ªæ€è·¯è¦æ±‚å°„çº¿ä¸å¹³é¢äº¤ç‚¹ï¼Œè¿™ä¸ªä¸çŸ¥é“æ€ä¹ˆæ±‚ï¼Œæ˜¯ä¸æ˜¯æˆ‘æ€è·¯æœ‰é—®é¢˜ï¼Œæ„Ÿè§‰ä¸å¤§å¯¹ã€‚
æˆ‘çš„ç†è§£å…‰æºæ–¹å‘ searchLightDirectionè¿™ä¸ªå‚æ•°å¯ä»¥å‚ç…§å¹³è¡Œå…‰çš„æ–¹å¼ã€å…‰æºä½ç½® searchLightPositionç”¨äºè®¡ç®—è·ç¦»è¡°å‡ã€å…‰æºåŠå¾„ searchLightRadius ç”¨äºç¡®å®šç…§å°„åˆ°çš„èŒƒå›´ è¿™ä¸ªé€»è¾‘æ€ä¹ˆç®—</p>2022-01-18</li><br/>
</ul>