ä½ å¥½ï¼Œæˆ‘æ˜¯æœˆå½±ã€‚

å‰é¢å‡ èŠ‚è¯¾ï¼Œæˆ‘ä»¬å­¦ä¹ äº†åˆ©ç”¨å‘é‡å’ŒçŸ©é˜µå…¬å¼ï¼Œæ¥å¤„ç†åƒç´ å’Œç”Ÿæˆçº¹ç†çš„æŠ€å·§ï¼Œä½†æ˜¯è¿™äº›æŠ€å·§éƒ½æœ‰ä¸€å®šçš„å±€é™æ€§ï¼šæ¯ä¸ªåƒç´ æ˜¯å½¼æ­¤ç‹¬ç«‹çš„ï¼Œä¸èƒ½å…±äº«ä¿¡æ¯ã€‚

ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿå› ä¸ºGPUæ˜¯å¹¶è¡Œæ¸²æŸ“çš„ï¼Œæ‰€ä»¥åœ¨ç€è‰²å™¨çš„æ‰§è¡Œä¸­ï¼Œæ¯ä¸ªåƒç´ çš„ç€è‰²éƒ½æ˜¯åŒæ—¶è¿›è¡Œçš„ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±ä¸èƒ½è·å¾—æŸä¸€ä¸ªåƒç´ åæ ‡å‘¨å›´åæ ‡ç‚¹çš„é¢œè‰²ä¿¡æ¯ï¼Œä¹Ÿä¸èƒ½è·å¾—è¦æ¸²æŸ“å›¾åƒçš„å…¨å±€ä¿¡æ¯ã€‚

è¿™ä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬è¦å®ç°ä¸å‘¨å›´åƒç´ ç‚¹è”åŠ¨çš„æ•ˆæœï¼Œæ¯”å¦‚ç»™ç”Ÿæˆçš„çº¹ç†æ·»åŠ å¹³æ»‘æ•ˆæœæ»¤é•œï¼Œå°±ä¸èƒ½ç›´æ¥é€šè¿‡ç€è‰²å™¨çš„è¿ç®—æ¥å®ç°äº†ã€‚

å› æ­¤ï¼Œåœ¨WebGLä¸­ï¼Œåƒè¿™æ ·ä¸èƒ½ç›´æ¥é€šè¿‡ç€è‰²å™¨è¿ç®—æ¥å®ç°çš„æ•ˆæœï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å…¶ä»–çš„åŠæ³•æ¥å®ç°ï¼Œå…¶ä¸­ä¸€ç§åŠæ³•å°±æ˜¯ä½¿ç”¨**åæœŸå¤„ç†é€šé“**ã€‚æ‰€è°“åæœŸå¤„ç†é€šé“ï¼Œæ˜¯æŒ‡å°†æ¸²æŸ“å‡ºæ¥çš„å›¾åƒä½œä¸ºçº¹ç†è¾“å…¥ç»™æ–°ç€è‰²å™¨å¤„ç†ï¼Œæ˜¯ä¸€ç§äºŒæ¬¡åŠ å·¥çš„æ‰‹æ®µã€‚è¿™ä¹ˆä¸€æ¥ï¼Œè™½ç„¶æˆ‘ä»¬ä¸èƒ½ä»å½“å‰æ¸²æŸ“ä¸­è·å–å‘¨å›´çš„åƒç´ ä¿¡æ¯ï¼Œå´å¯ä»¥ä»çº¹ç†ä¸­è·å–ä»»æ„uvåæ ‡ä¸‹çš„åƒç´ ä¿¡æ¯ï¼Œä¹Ÿå°±ç›¸å½“äºå¯ä»¥è·å–ä»»æ„ä½ç½®çš„åƒç´ ä¿¡æ¯äº†ã€‚

ä½¿ç”¨åæœŸå¤„ç†é€šé“çš„ä¸€èˆ¬è¿‡ç¨‹æ˜¯ï¼Œæˆ‘ä»¬å…ˆæ­£å¸¸åœ°å°†æ•°æ®é€å…¥ç¼“å†²åŒºï¼Œç„¶åæ‰§è¡ŒWebGLProgramã€‚åªä¸è¿‡ï¼Œåœ¨æ‰§è¡Œäº†WebGLProgramä¹‹åï¼Œæˆ‘ä»¬è¦å°†è¾“å‡ºçš„ç»“æœå†ä½œä¸ºçº¹ç†ï¼Œé€å…¥å¦ä¸€ä¸ªWebGLProgramè¿›è¡Œå¤„ç†ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥è¿›è¡Œä¸€æ¬¡ï¼Œä¹Ÿå¯ä»¥å¾ªç¯å¤šæ¬¡ã€‚æœ€åï¼Œç»è¿‡ä¸¤æ¬¡WebGLProgramå¤„ç†ä¹‹åï¼Œæˆ‘ä»¬å†è¾“å‡ºç»“æœã€‚

![](https://static001.geekbang.org/resource/image/a9/75/a9b5a5f90e2c3e465a0a6d2b7070ef75.jpg?wh=1959%2A1776 "åæœŸé€šé“å¤„ç†çš„ä¸€èˆ¬è¿‡ç¨‹ç¤ºæ„å›¾")

ä½ å¯ä»¥å…ˆä»”ç»†çœ‹çœ‹è¿™å¼ æµç¨‹æ€»ç»“å›¾ï¼ŒåŠ æ·±ä¸€ä¸‹å°è±¡ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šç»“åˆè¿™ä¸ªè¿‡ç¨‹ï¼Œè¯´è¯´æ€ä¹ˆç”¨åæœŸå¤„ç†é€šé“ï¼Œæ¥å®ç°Bluræ»¤é•œã€è¾‰å…‰æ•ˆæœå’ŒçƒŸé›¾æ•ˆæœï¼Œè¿™æ ·ä½ å°±èƒ½ç†è§£å¾—æ›´æ·±åˆ»äº†ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥å®ç°Bluræ»¤é•œã€‚

## å¦‚ä½•ç”¨åæœŸå¤„ç†é€šé“å®ç°Bluræ»¤é•œï¼Ÿ

å…¶å®åœ¨ç¬¬11èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å·²ç»åœ¨Canvas2Dä¸­å®ç°äº†Bbluræ»¤é•œï¼ˆé«˜æ–¯æ¨¡ç³Šçš„å¹³æ»‘æ•ˆæœæ»¤é•œï¼‰ï¼Œä½†Canvas2Då®ç°æ»¤é•œçš„æ€§èƒ½ä¸ä½³ï¼Œå°¤å…¶æ˜¯åœ¨å›¾ç‰‡è¾ƒå¤§ï¼Œéœ€è¦å¤§é‡è®¡ç®—çš„æ—¶å€™ã€‚

è€Œåœ¨WebGLä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åæœŸå¤„ç†æ¥å®ç°é«˜æ€§èƒ½çš„Bluræ»¤é•œã€‚ä¸‹é¢ï¼Œæˆ‘å°±ä»¥ç»™éšæœºä¸‰è§’å½¢å›¾æ¡ˆåŠ Bluræ»¤é•œä¸ºä¾‹ï¼Œæ¥è¯´è¯´å…·ä½“çš„æ“ä½œã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å®ç°ä¸€ä¸ªç»˜åˆ¶éšæœºä¸‰è§’å½¢å›¾æ¡ˆçš„ç€è‰²å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
#ifdef GL_ES
precision highp float;
#endif

float line_distance(in vec2 st, in vec2 a, in vec2 b) {
  vec3 ab = vec3(b - a, 0);
  vec3 p = vec3(st - a, 0);
  float l = length(ab);
  return cross(p, normalize(ab)).z;
}

float seg_distance(in vec2 st, in vec2 a, in vec2 b) {
  vec3 ab = vec3(b - a, 0);
  vec3 p = vec3(st - a, 0);
  float l = length(ab);
  float d = abs(cross(p, normalize(ab)).z);
  float proj = dot(p, ab) / l;
  if(proj >= 0.0 && proj <= l) return d;
  return min(distance(st, a), distance(st, b));
}

float triangle_distance(in vec2 st, in vec2 a, in vec2 b, in vec2 c) {
  float d1 = line_distance(st, a, b);
  float d2 = line_distance(st, b, c);
  float d3 = line_distance(st, c, a);

  if(d1 >= 0.0 && d2 >= 0.0 && d3 >= 0.0 || d1 <= 0.0 && d2 <= 0.0 && d3 <= 0.0) {
    return -min(abs(d1), min(abs(d2), abs(d3))); // å†…éƒ¨è·ç¦»ä¸ºè´Ÿ
  }
  
  return min(seg_distance(st, a, b), min(seg_distance(st, b, c), seg_distance(st, c, a))); // å¤–éƒ¨ä¸ºæ­£
}

float random (vec2 st) {
  return fract(sin(dot(st.xy,
                      vec2(12.9898,78.233)))*
      43758.5453123);
}

vec3 hsb2rgb(vec3 c){
  vec3 rgb = clamp(abs(mod(c.x*6.0+vec3(0.0,4.0,2.0), 6.0)-3.0)-1.0, 0.0, 1.0);
  rgb = rgb * rgb * (3.0 - 2.0 * rgb);
  return c.z * mix(vec3(1.0), rgb, c.y);
}

varying vec2 vUv;

void main() {
  vec2 st = vUv;
  st *= 10.0;
  vec2 i_st = floor(st);
  vec2 f_st = 2.0 * fract(st) - vec2(1);
  float r = random(i_st);
  float sign = 2.0 * step(0.5, r) - 1.0;
  
  float d = triangle_distance(f_st, vec2(-1), vec2(1), sign * vec2(1, -1));
  gl_FragColor.rgb = (smoothstep(-0.85, -0.8, d) - smoothstep(0.0, 0.05, d)) * hsb2rgb(vec3(r + 1.2, 0.5, r));
  gl_FragColor.a = 1.0;
}
```

è¿™ä¸ªç€è‰²å™¨ç»˜åˆ¶å‡ºçš„æ•ˆæœå¦‚ä¸‹å›¾ï¼š

![](https://static001.geekbang.org/resource/image/bc/5b/bce2b0fbe3954c9a690a46f422de4f5b.jpeg?wh=1920%2A1080)

æ¥ç€å°±æ˜¯é‡ç‚¹äº†ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨åæœŸå¤„ç†é€šé“å¯¹å®ƒè¿›è¡Œé«˜æ–¯æ¨¡ç³Šã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å‡†å¤‡å¦ä¸€ä¸ªç€è‰²å™¨ï¼šblurFragmentã€‚é€šè¿‡å®ƒï¼Œæˆ‘ä»¬èƒ½å°†ç¬¬ä¸€æ¬¡æ¸²æŸ“åç”Ÿæˆçš„çº¹ç†tMapå†…å®¹ç»™æ˜¾ç¤ºå‡ºæ¥ã€‚

```
#ifdef GL_ES
precision highp float;
#endif

varying vec2 vUv;
uniform sampler2D tMap;

void main() {
  vec4 color = texture2D(tMap, vUv);
  gl_FragColor.rgb = color.rgb;
  gl_FragColor.a = color.a;
}
```

ç„¶åï¼Œæˆ‘ä»¬è¦ä¿®æ”¹JavaScriptä»£ç ï¼ŒæŠŠæ¸²æŸ“åˆ†ä¸ºä¸¤æ¬¡ã€‚ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶ï¼Œæˆ‘ä»¬å¯ç”¨programç¨‹åºï¼Œä½†ä¸ç›´æ¥æŠŠå›¾å½¢è¾“å‡ºåˆ°ç”»å¸ƒä¸Šï¼Œè€Œæ˜¯è¾“å‡ºåˆ°ä¸€ä¸ªå¸§ç¼“å†²å¯¹è±¡ï¼ˆFrame Buffer Objectï¼‰ä¸Šã€‚ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶ï¼Œæˆ‘ä»¬å†å¯ç”¨blurProgramç¨‹åºï¼Œå°†ç¬¬ä¸€æ¬¡æ¸²æŸ“å®Œæˆçš„çº¹ç†ï¼ˆfbo.textureï¼‰ä½œä¸ºblurFragmentçš„tMapå˜é‡ï¼Œè¿™æ¬¡çš„è¾“å‡ºç»˜åˆ¶åˆ°ç”»å¸ƒä¸Šã€‚ä»£ç å¦‚ä¸‹ï¼š

```
...

renderer.useProgram(program);

renderer.setMeshData([{
  positions: [
    [-1, -1],
    [-1, 1],
    [1, 1],
    [1, -1],
  ],
  attributes: {
    uv: [
      [0, 0],
      [0, 1],
      [1, 1],
      [1, 0],
    ],
  },
  cells: [[0, 1, 2], [2, 0, 3]],
}]);

const fbo = renderer.createFBO();
renderer.bindFBO(fbo);
renderer.render();
renderer.bindFBO(null);

const blurProgram = renderer.compileSync(blurFragment, vertex);
renderer.useProgram(blurProgram);
renderer.setMeshData(program.meshData);
renderer.uniforms.tMap = fbo.texture;
renderer.render();
```

å…¶ä¸­ï¼Œrenderer.createFBOæ˜¯åˆ›å»ºå¸§ç¼“å†²å¯¹è±¡ï¼ŒbindFBOæ˜¯ç»‘å®šå¸§ç¼“å†²å¯¹è±¡ã€‚ä¸ºäº†æ–¹ä¾¿è°ƒç”¨ï¼Œæˆ‘åœ¨è¿™é‡Œé€šè¿‡gl-rendereråšäº†ä¸€å±‚ç®€å•çš„å°è£…ã€‚

é‚£ç»è¿‡ä¸¤æ¬¡æ¸²æŸ“ä¹‹åï¼Œæˆ‘ä»¬è¿è¡Œç¨‹åºè¾“å‡ºçš„ç»“æœå’Œä¹‹å‰è¾“å‡ºçš„å¹¶ä¸ä¼šæœ‰ä»€ä¹ˆåŒºåˆ«ã€‚å› ä¸ºç¬¬äºŒæ¬¡æ¸²æŸ“åªä¸è¿‡æ˜¯å°†ç¬¬ä¸€æ¬¡æ¸²æŸ“åˆ°å¸§ç¼“å†²çš„ç»“æœåŸå°ä¸åŠ¨åœ°è¾“å‡ºåˆ°ç”»å¸ƒä¸Šäº†ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¿®æ”¹blurFragmentçš„ä»£ç ï¼Œåœ¨å…¶ä¸­æ·»åŠ é«˜æ–¯æ¨¡ç³Šçš„ä»£ç ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
#ifdef GL_ES
precision highp float;
#endif

varying vec2 vUv;
uniform sampler2D tMap;
uniform int axis;

void main() {
  vec4 color = texture2D(tMap, vUv);

  // é«˜æ–¯çŸ©é˜µçš„æƒé‡å€¼
  float weight[5];
  weight[0] = 0.227027;
  weight[1] = 0.1945946;
  weight[2] = 0.1216216;
  weight[3] = 0.054054;
  weight[4] = 0.016216;

  // æ¯ä¸€ä¸ªç›¸é‚»åƒç´ çš„åæ ‡é—´éš”ï¼Œè¿™é‡Œçš„512å¯ä»¥ç”¨å®é™…çš„Canvasåƒç´ å®½ä»£æ›¿
  float tex_offset = 1.0 / 512.0;

  vec3 result = color.rgb;
  result *= weight[0];
  for(int i = 1; i < 5; ++i) {
    float f = float(i);
    if(axis == 0) { // xè½´çš„é«˜æ–¯æ¨¡ç³Š
      result += texture2D(tMap, vUv + vec2(tex_offset * f, 0.0)).rgb * weight[i];
      result += texture2D(tMap, vUv - vec2(tex_offset * f, 0.0)).rgb * weight[i];
    } else { // yè½´çš„é«˜æ–¯æ¨¡ç³Š
      result += texture2D(tMap, vUv + vec2(0.0, tex_offset * f)).rgb * weight[i];
      result += texture2D(tMap, vUv - vec2(0.0, tex_offset * f)).rgb * weight[i];
    }
  }

  gl_FragColor.rgb = result.rgb;
  gl_FragColor.a = color.a;
}

```

å› ä¸ºé«˜æ–¯æ¨¡ç³Šæœ‰ä¸¤ä¸ªæ–¹å‘ï¼Œxå’Œyæ–¹å‘ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡³å°‘è¦æ‰§è¡Œä¸¤æ¬¡æ¸²æŸ“ï¼Œä¸€æ¬¡å¯¹xè½´ï¼Œå¦ä¸€æ¬¡å¯¹yè½´ã€‚å¦‚æœæƒ³è¦è¾¾åˆ°æ›´å¥½çš„æ•ˆæœï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ‰§è¡Œå¤šæ¬¡æ¸²æŸ“ã€‚

é‚£æˆ‘ä»¬å°±ä»¥åˆ†åˆ«å¯¹xè½´å’Œyè½´æ‰§è¡Œ2æ¬¡æ¸²æŸ“ä¸ºä¾‹ï¼Œä¿®æ”¹åçš„JavaScriptä»£ç å¦‚ä¸‹ï¼š

```
// åˆ›å»ºä¸¤ä¸ªFBOå¯¹è±¡äº¤æ›¿ä½¿ç”¨
const fbo1 = renderer.createFBO();
const fbo2 = renderer.createFBO();

// ç¬¬ä¸€æ¬¡ï¼Œæ¸²æŸ“åŸå§‹å›¾å½¢
renderer.bindFBO(fbo1);
renderer.render();

// ç¬¬äºŒæ¬¡ï¼Œå¯¹xè½´é«˜æ–¯æ¨¡ç³Š
renderer.useProgram(blurProgram);
renderer.setMeshData(program.meshData);
renderer.bindFBO(fbo2);
renderer.uniforms.tMap = fbo1.texture;
renderer.uniforms.axis = 0;
renderer.render();

// ç¬¬ä¸‰æ¬¡ï¼Œå¯¹yè½´é«˜æ–¯æ¨¡ç³Š
renderer.useProgram(blurProgram);
renderer.bindFBO(fbo1);
renderer.uniforms.tMap = fbo2.texture;
renderer.uniforms.axis = 1;
renderer.render();

// ç¬¬å››æ¬¡ï¼Œå¯¹xè½´é«˜æ–¯æ¨¡ç³Š
renderer.useProgram(blurProgram);
renderer.bindFBO(fbo2);
renderer.uniforms.tMap = fbo1.texture;
renderer.uniforms.axis = 0;
renderer.render();

// ç¬¬äº”æ¬¡ï¼Œå¯¹yè½´é«˜æ–¯æ¨¡ç³Š
renderer.useProgram(blurProgram);
renderer.bindFBO(null);
renderer.uniforms.tMap = fbo2.texture;
renderer.uniforms.axis = 1;
renderer.render();
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªFBOå¯¹è±¡ï¼Œç„¶åå°†å®ƒä»¬äº¤æ›¿ä½¿ç”¨ã€‚æˆ‘ä»¬ä¸€å…±è¿›è¡Œ5æ¬¡ç»˜åˆ¶ï¼Œå…ˆå¯¹åŸå§‹å›¾ç‰‡æ‰§è¡Œ1æ¬¡æ¸²æŸ“ï¼Œå†è¿›è¡Œ4æ¬¡åæœŸå¤„ç†ã€‚

è¿™é‡Œå•Šï¼Œæˆ‘è¿˜è¦å‘Šè¯‰ä½ ä¸€ä¸ªå°æŠ€å·§ã€‚æœ¬æ¥å•Šï¼Œåœ¨æ‰§è¡Œçš„è¿™5æ¬¡ç»˜åˆ¶ä¸­ï¼Œå‰å››æ¬¡éƒ½æ˜¯è¾“å‡ºåˆ°å¸§ç¼“å†²å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡³å°‘éœ€è¦4ä¸ªFBOå¯¹è±¡ã€‚ä½†æ˜¯ï¼Œç”±äºæˆ‘ä»¬å¯ä»¥äº¤æ›¿ä½¿ç”¨FBOå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æŠŠç”¨è¿‡çš„å¯¹è±¡é‡å¤ä½¿ç”¨ã€‚å› æ­¤ï¼Œæ— è®ºéœ€è¦ç»˜åˆ¶å¤šå°‘æ¬¡ï¼Œæˆ‘ä»¬éƒ½åªè¦åˆ›å»ºä¸¤ä¸ªå¯¹è±¡å°±å¯ä»¥ï¼Œä¹Ÿå°±èŠ‚çº¦äº†å†…å­˜ã€‚

æœ€ç»ˆï¼Œæˆ‘ä»¬å°±èƒ½é€šè¿‡åæœŸå¤„ç†é€šé“å®ç°Bluræ»¤é•œï¼Œç»™ä¸‰è§’å½¢å›¾æ¡ˆåŠ ä¸Šæ¨¡ç³Šçš„æ•ˆæœäº†ã€‚æ¸²æŸ“ç»“æœå¦‚ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/0d/91/0d14fea4328158fe9d32f09181a22f91.jpeg?wh=1920%2A1080)

## å¦‚ä½•ç”¨åæœŸå¤„ç†é€šé“å®ç°è¾‰å…‰æ•ˆæœï¼Ÿ

åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ˜¯å¯¹æ‰€æœ‰å…ƒç´ è¿›è¡Œé«˜æ–¯æ¨¡ç³Šçš„ã€‚é‚£é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¯¹ç‰¹å®šå…ƒç´ è¿›è¡Œé«˜æ–¯æ¨¡ç³Šã€‚åœ¨å¯è§†åŒ–å’Œæ¸¸æˆå¼€å‘ä¸­ï¼Œå°±å¸¸ç”¨è¿™ç§æŠ€å·§æ¥å®ç°å…ƒç´ çš„â€œè¾‰å…‰â€æ•ˆæœã€‚æ¯”å¦‚ï¼Œä¸‹é¢è¿™å¼ å›¾å°±æ˜¯ç”¨è¾‰å…‰æ•ˆæœå®ç°çš„æµ©ç€šå®‡å®™èƒŒæ™¯ã€‚

[![](https://static001.geekbang.org/resource/image/e9/4a/e9b5daeefdde2111cb955d2b91986b4a.jpeg?wh=1920%2A1080 "å…¨å±€è¾‰å…‰æ•ˆæœï¼ˆå›¾ç‰‡æ¥æºäºçŸ¥ä¹ï¼šHå…‰å¤§å°å§ï¼‰")](https://zhuanlan.zhihu.com/p/44131797)

é‚£ç±»ä¼¼è¿™æ ·çš„è¾‰å…‰æ•ˆæœè¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥åœ¨å‰é¢æ·»åŠ é«˜æ–¯æ¨¡ç³Šä¾‹å­çš„åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬ç»™blurFragmentåŠ äº†ä¸€ä¸ªå…³äºäº®åº¦çš„æ»¤é•œï¼Œå°†é¢œè‰²äº®åº¦å¤§äºfilterå€¼çš„ä¸‰è§’å½¢è¿‡æ»¤å‡ºæ¥æ·»åŠ é«˜æ–¯æ¨¡ç³Šã€‚ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ã€‚

```
uniform float filter;
      
void main() {
  vec4 color = texture2D(tMap, vUv);
  float brightness = dot(color.rgb, vec3(0.2126, 0.7152, 0.0722));
  brightness = step(filter, brightness);

  // é«˜æ–¯çŸ©é˜µçš„æƒé‡å€¼
  float weight[5];
  weight[0] = 0.227027;
  weight[1] = 0.1945946;
  weight[2] = 0.1216216;
  weight[3] = 0.054054;
  weight[4] = 0.016216;

  // æ¯ä¸€ä¸ªç›¸é‚»åƒç´ çš„åæ ‡é—´éš”ï¼Œè¿™é‡Œçš„512å¯ä»¥ç”¨å®é™…çš„Canvasåƒç´ å®½ä»£æ›¿
  float tex_offset = 1.0 / 512.0;

  vec3 result = color.rgb;
  result *= weight[0];
  for(int i = 1; i < 5; ++i) {
    float f = float(i);
    if(axis == 0) { // xè½´çš„é«˜æ–¯æ¨¡ç³Š
      result += texture2D(tMap, vUv + vec2(tex_offset * f, 0.0)).rgb * weight[i];
      result += texture2D(tMap, vUv - vec2(tex_offset * f, 0.0)).rgb * weight[i];
    } else { // yè½´çš„é«˜æ–¯æ¨¡ç³Š
      result += texture2D(tMap, vUv + vec2(0.0, tex_offset * f)).rgb * weight[i];
      result += texture2D(tMap, vUv - vec2(0.0, tex_offset * f)).rgb * weight[i];
    }
  }

  gl_FragColor.rgb = brightness * result.rgb;
  gl_FragColor.a = color.a;
}

```

ç„¶åï¼Œæˆ‘ä»¬å†å¢åŠ ä¸€ä¸ªbloomFragmentç€è‰²å™¨ï¼Œç”¨æ¥åšæœ€åçš„æ•ˆæœæ··åˆã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°ä¸€ä¸ªå«åš[**Tone Mapping**](https://zh.wikipedia.org/wiki/%E8%89%B2%E8%B0%83%E6%98%A0%E5%B0%84)ï¼ˆè‰²è°ƒæ˜ å°„ï¼‰çš„æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•å°±æ¯”è¾ƒå¤æ‚äº†ï¼Œåœ¨è¿™é‡Œï¼Œä½ åªè¦çŸ¥é“å®ƒå¯ä»¥å°†å¯¹æ¯”åº¦è¿‡å¤§çš„å›¾åƒè‰²è°ƒæ˜ å°„åˆ°åˆç†çš„èŒƒå›´å†…å°±å¯ä»¥äº†ï¼Œå…¶ä»–çš„å†…å®¹ä½ å¯ä»¥åœ¨è¯¾åçœ‹ä¸€ä¸‹æˆ‘ç»™å‡ºçš„å‚è€ƒé“¾æ¥ã€‚

è¿™ä¸ªç€è‰²å™¨çš„ä»£ç å¦‚ä¸‹ï¼š

```
#ifdef GL_ES
  precision highp float;
#endif

uniform sampler2D tMap;
uniform sampler2D tSource;

varying vec2 vUv;

void main() {
  vec3 color = texture2D(tSource, vUv).rgb;
  vec3 bloomColor = texture2D(tMap, vUv).rgb;
  color += bloomColor;
  // tone mapping
  float exposure = 2.0;
  float gamma = 1.3;
  vec3 result = vec3(1.0) - exp(-color * exposure);
  // also gamma correct while we're at it
  if(length(bloomColor) > 0.0) {
    result = pow(result, vec3(1.0 / gamma));
  }
  gl_FragColor.rgb = result;
  gl_FragColor.a = 1.0;
}
```

æœ€åï¼Œæˆ‘ä»¬ä¿®æ”¹JavaScriptæ¸²æŸ“çš„é€»è¾‘ï¼Œæ·»åŠ æ–°çš„åæœŸå¤„ç†è§„åˆ™ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬è¦ä½¿ç”¨ä¸‰ä¸ªFBOå¯¹è±¡ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªFBOå¯¹è±¡åœ¨æ¸²æŸ“åŸå§‹å›¾å½¢ä¹‹åï¼Œè¿˜è¦åœ¨æ··åˆæ•ˆæœæ—¶ä½¿ç”¨ï¼Œåä¸¤ä¸ªå¯¹è±¡æ˜¯ç”¨æ¥äº¤æ›¿ä½¿ç”¨å®Œæˆé«˜æ–¯æ¨¡ç³Šçš„ã€‚æœ€åï¼Œæˆ‘ä»¬å†å°†åŸå§‹å›¾å½¢å’Œé«˜æ–¯æ¨¡ç³Šçš„ç»“æœè¿›è¡Œæ•ˆæœæ··åˆå°±å¯ä»¥äº†ã€‚ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ï¼š

```
// åˆ›å»ºä¸‰ä¸ªFBOå¯¹è±¡ï¼Œfbo1å’Œfbo2äº¤æ›¿ä½¿ç”¨
const fbo0 = renderer.createFBO();
const fbo1 = renderer.createFBO();
const fbo2 = renderer.createFBO();

// ç¬¬ä¸€æ¬¡ï¼Œæ¸²æŸ“åŸå§‹å›¾å½¢
renderer.bindFBO(fbo0);
renderer.render();

// ç¬¬äºŒæ¬¡ï¼Œå¯¹xè½´é«˜æ–¯æ¨¡ç³Š
renderer.useProgram(blurProgram);
renderer.setMeshData(program.meshData);
renderer.bindFBO(fbo2);
renderer.uniforms.tMap = fbo0.texture;
renderer.uniforms.axis = 0;
renderer.uniforms.filter = 0.7;
renderer.render();

// ç¬¬ä¸‰æ¬¡ï¼Œå¯¹yè½´é«˜æ–¯æ¨¡ç³Š
renderer.useProgram(blurProgram);
renderer.bindFBO(fbo1);
renderer.uniforms.tMap = fbo2.texture;
renderer.uniforms.axis = 1;
renderer.uniforms.filter = 0;
renderer.render();

// ç¬¬å››æ¬¡ï¼Œå¯¹xè½´é«˜æ–¯æ¨¡ç³Š
renderer.useProgram(blurProgram);
renderer.bindFBO(fbo2);
renderer.uniforms.tMap = .texture;
renderer.uniforms.axis = 0;
renderer.uniforms.filter = 0;
renderer.render();

// ç¬¬äº”æ¬¡ï¼Œå¯¹yè½´é«˜æ–¯æ¨¡ç³Š
renderer.useProgram(blurProgram);
renderer.bindFBO(fbo1);
renderer.uniforms.tMap = fbo2.texture;
renderer.uniforms.axis = 1;
renderer.uniforms.filter = 0;
renderer.render();

// ç¬¬å…­æ¬¡ï¼Œå åŠ è¾‰å…‰
renderer.useProgram(bloomProgram);
renderer.setMeshData(program.meshData);
renderer.bindFBO(null);
renderer.uniforms.tSource = fbo0.texture;
renderer.uniforms.tMap = fbo1.texture;
renderer.uniforms.axis = 1;
renderer.uniforms.filter = 0;
renderer.render();
```

è¿™æ ·æ¸²æŸ“ä¹‹åï¼Œæˆ‘å°±èƒ½è®©ä¸‰è§’å½¢å›¾æ¡ˆä¸­å‡ ä¸ªæ¯”è¾ƒäº®çš„ä¸‰è§’å½¢ï¼Œäº§ç”Ÿä¸€ç§å¾®å¾®å‘å…‰çš„æ•ˆæœã€‚æ¸²æŸ“æ•ˆæœå¦‚ä¸‹ï¼š

![](https://static001.geekbang.org/resource/image/69/c5/6905c7b0ff6b8b8d903e0eaeefcbfbc5.jpeg?wh=1920%2A1080 "å±€éƒ¨è¾‰å…‰æ•ˆæœç¤ºæ„å›¾")

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®ç°äº†æœ€ç»ˆçš„å±€éƒ¨è¾‰å…‰æ•ˆæœã€‚å®ç°å®ƒçš„å…³é”®ï¼Œå°±æ˜¯åœ¨é«˜æ–¯æ¨¡ç³ŠåŸç†çš„åŸºç¡€ä¸Šï¼Œå°†å±€éƒ¨é«˜æ–¯æ¨¡ç³Šçš„å›¾åƒä¸åŸå§‹å›¾åƒå åŠ ã€‚

## å¦‚ä½•ç”¨åæœŸå¤„ç†é€šé“å®ç°çƒŸé›¾æ•ˆæœï¼Ÿ

é™¤äº†æ¨¡ç³Šå’Œè¾‰å…‰æ•ˆæœä¹‹å¤–ï¼ŒåæœŸå¤„ç†é€šé“è¿˜ç»å¸¸ç”¨æ¥å®ç°çƒŸé›¾æ•ˆæœã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å®ç°ä¸€ä¸ªå°åœ†çš„çƒŸé›¾æ•ˆæœã€‚å…·ä½“çš„å®ç°è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä¸¤æ­¥ï¼šç¬¬ä¸€æ­¥å’Œå‰é¢ä¸¤ä¸ªä¾‹å­ä¸€æ ·ï¼Œæˆ‘ä»¬é€šè¿‡åˆ›å»ºä¸€ä¸ªshaderï¼Œç”»å‡ºä¸€ä¸ªç®€å•çš„åœ†ã€‚ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬å¯¹è¿™ä¸ªåœ†è¿›è¡ŒåæœŸå¤„ç†ï¼Œä¸è¿‡è¿™æ¬¡çš„å¤„ç†æ–¹æ³•å°±å’Œå®ç°è¾‰å…‰ä¸åŒäº†ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å°±ä¸€èµ·æ¥çœ‹ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®€å•çš„shaderï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨è·ç¦»åœºåœ¨ç”»å¸ƒä¸Šç”»ä¸€ä¸ªåœ†ã€‚è¿™ä¸ªshaderæˆ‘ä»¬éå¸¸ç†Ÿæ‚‰ï¼Œå…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š

```
#ifdef GL_ES
precision highp float;
#endif

varying vec2 vUv;

void main() {
  vec2 st = vUv - vec2(0.5);
  float d = length(st);
  gl_FragColor.rgb = vec3(1.0 - smoothstep(0.05, 0.055, d));
  gl_FragColor.a = 1.0;
}
```

![](https://static001.geekbang.org/resource/image/72/77/72d1816d29d1401636e0099016f80477.jpeg?wh=1920%2A1080)

æ¥ç€ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹shaderä»£ç ï¼Œå¢åŠ uTimeã€tMapè¿™ä¸¤ä¸ªå˜é‡ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚å…¶ä¸­ï¼ŒuTimeç”¨æ¥æ§åˆ¶å›¾åƒéšæ—¶é—´å˜åŒ–ï¼Œè€ŒtMapæ˜¯æˆ‘ä»¬ç”¨æ¥åšåæœŸå¤„ç†çš„å˜é‡ã€‚

```
#ifdef GL_ES
precision highp float;
#endif

varying vec2 vUv;
uniform sampler2D tMap;
uniform float uTime;

void main() {
  vec3 smoke = vec3(0);
  if(uTime <= 0.0) {
    vec2 st = vUv - vec2(0.5);
    float d = length(st);
    smoke = vec3(1.0 - smoothstep(0.05, 0.055, d));
  }
  vec3 diffuse = texture2D(tMap, vUv).rgb;
  gl_FragColor.rgb = diffuse + smoke;
  gl_FragColor.a = 1.0;
}
```

ç„¶åï¼Œæˆ‘ä»¬ä¾ç„¶åˆ›å»ºä¸¤ä¸ªFBOï¼Œç”¨å®ƒä»¬äº¤æ›¿è¿›è¡Œç»˜åˆ¶ã€‚æœ€åï¼Œæˆ‘ä»¬æŠŠç»˜åˆ¶çš„å†…å®¹è¾“å‡ºåˆ°ç”»å¸ƒä¸Šã€‚è¿™é‡Œï¼Œæˆ‘ä½¿ç”¨äº†ä¸€ä¸ªifè¯­å¥ï¼Œæ ¹æ®ç»˜åˆ¶è¿‡ç¨‹åˆ¤æ–­åˆå§‹ç»˜åˆ¶è¿˜æ˜¯åç»­çš„å åŠ è¿‡ç¨‹ï¼Œå°±èƒ½æŠŠç€è‰²å™¨åˆå¹¶æˆä¸€ä¸ªã€‚è¿™æ ·ä¸€æ¥ï¼Œä¸ç®¡æ˜¯è¾“å‡ºåˆ°ç”»å¸ƒè¿˜æ˜¯FBOï¼Œæˆ‘ä»¬ä½¿ç”¨åŒä¸€ä¸ªprogramå°±å¯ä»¥äº†ã€‚

```
const fbo = {
  readFBO: renderer.createFBO(),
  writeFBO: renderer.createFBO(),
  get texture() {
    return this.readFBO.texture;
  },
  swap() {
    const tmp = this.writeFBO;
    this.writeFBO = this.readFBO;
    this.readFBO = tmp;
  },
};

function update(t) {
  // è¾“å‡ºåˆ°ç”»å¸ƒ
  renderer.bindFBO(null);
  renderer.uniforms.uTime = t / 1000;
  renderer.uniforms.tMap = fbo.texture;
  renderer.render();
  // åŒæ—¶è¾“å‡ºåˆ°FBO
  renderer.bindFBO(fbo.writeFBO);
  renderer.uniforms.tMap = fbo.texture;
  // äº¤æ¢è¯»å†™ç¼“å†²ä»¥ä¾¿ä¸‹ä¸€æ¬¡å†™å…¥
  fbo.swap();
  renderer.render();
  requestAnimationFrame(update);
}
update(0);
```

ä½ ä¼šå‘ç°ï¼Œä¸Šé¢çš„ä»£ç æ‰§è¡Œä»¥åè¾“å‡ºçš„ç”»é¢å¹¶æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶ï¼Œä¹Ÿå°±æ˜¯å½“uTimeä¸º0çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç›´æ¥ç”»äº†ä¸€ä¸ªåœ†ã€‚è€Œå½“æˆ‘ä»¬ä»ä¸Šä¸€æ¬¡ç»˜åˆ¶çš„çº¹ç†ä¸­è·å–ä¿¡æ¯ï¼Œé‡æ–°æ¸²æŸ“æ—¶ï¼Œå› ä¸ºæ¯æ¬¡è·å–çš„çº¹ç†å›¾æ¡ˆéƒ½æ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥ç°åœ¨çš„ç”»é¢ä¾ç„¶æ˜¯é™æ­¢çš„åœ†ã€‚

å¦‚æœæˆ‘ä»¬æƒ³è®©è¿™ä¸ªå›¾åŠ¨èµ·æ¥ï¼Œæ¯”å¦‚è¯´è®©å®ƒå‘ä¸Šå‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦åœ¨æ¯æ¬¡ç»˜åˆ¶çš„æ—¶å€™ï¼Œæ”¹å˜ä¸€ä¸‹é‡‡æ ·çš„yåæ ‡ï¼Œå°±æ˜¯æ¯æ¬¡ä»tMapå–æ ·æ—¶å–å½“å‰çº¹ç†åæ ‡ç¨å¾®ä¸‹æ–¹ä¸€ç‚¹çš„åƒç´ ç‚¹å°±å¯ä»¥äº†ã€‚å…·ä½“çš„æ“ä½œä»£ç å¦‚ä¸‹ï¼š

```
void main() {
  vec3 smoke = vec3(0);
  if(uTime <= 0.0) {
    vec2 st = vUv - vec2(0.5);
    float d = length(st);
    smoke = vec3(1.0 - smoothstep(0.05, 0.055, d));
  }
  vec2 st = vUv;
  st.y -= 0.001;
  vec3 diffuse = texture2D(tMap, st).rgb;
  gl_FragColor.rgb = diffuse + smoke;
  gl_FragColor.a = 1.0;
}

```

![](https://static001.geekbang.org/resource/image/ec/44/ec596ee38eabbbyy06061fe638a3df44.gif?wh=516%2A516)

ä¸è¿‡ï¼Œç”±äºçº¹ç†é‡‡æ ·ç²¾åº¦çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¾—åˆ°çš„ä¸Šå‡åœ†è¿˜ä¼šæœ‰ä¸€ä¸ªæ‰©æ•£çš„æ•ˆæœã€‚ä¸è¿‡è¿™æ²¡æœ‰å…³ç³»ï¼Œå®ƒä¸å½±å“æˆ‘ä»¬æ¥ä¸‹æ¥è¦å®ç°çš„çƒŸé›¾æ•ˆæœã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ªçƒŸé›¾çš„æ‰©æ•£æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯ä»¥æŸä¸ªåƒç´ ä½ç½®ä»¥åŠå‘¨è¾¹åƒç´ çš„çº¹ç†é¢œè‰²æ¥è®¡ç®—æ–°çš„é¢œè‰²å€¼ã€‚ä¸ºäº†æ–¹ä¾¿ä½ ç†è§£ï¼Œæˆ‘å°±ä»¥ä¸€ä¸ª5\*5çš„ç”»å¸ƒä¸ºä¾‹æ¥è¯¦ç»†è¯´è¯´ã€‚å‡è®¾ï¼Œè¿™ä¸ªç”»å¸ƒåªæœ‰ä¸­å¿ƒäº”ä¸ªä½ç½®çš„é¢œè‰²æ˜¯çº¯ç™½ï¼ˆ1.0ï¼‰ï¼Œå‘¨å›´éƒ½æ˜¯é»‘è‰²ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://static001.geekbang.org/resource/image/8e/6b/8ed93106a13428492bd5bc2eyy8d676b.jpeg?wh=1920%2A1080)

åœ¨è¿™ä¸ªæ‰©æ•£æ¨¡å‹ä¸­ï¼Œæ¯ä¸ªæ ¼å­åˆ°ä¸‹ä¸€æ—¶åˆ»çš„é¢œè‰²å˜åŒ–é‡ï¼Œç­‰äºå®ƒå‘¨å›´å››ä¸ªæ ¼å­çš„é¢œè‰²å€¼ä¹‹å’Œå‡å»å®ƒè‡ªèº«é¢œè‰²å€¼çš„4å€ï¼Œä¹˜ä»¥æ‰©æ•£ç³»æ•°ã€‚

å‡è®¾æ‰©æ•£ç³»æ•°æ˜¯å¸¸é‡0.1ï¼Œé‚£ä¹ˆç¬¬ä¸€è½®æ¯ä¸€æ ¼çš„é¢œè‰²å€¼æˆ‘åœ¨è¡¨æ ¼ä¸Šæ ‡å‡ºæ¥äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://static001.geekbang.org/resource/image/6f/44/6f46f3354b470d217110764cfc3f0344.jpg?wh=1920%2A1080)

å¯ä»¥çœ‹åˆ°ï¼Œä¸Šå›¾ä¸­æœ‰ä¸‰ç§é¢œè‰²çš„æ ¼å­ï¼Œåˆ†åˆ«æ˜¯çº¢è‰²ã€è“è‰²å’Œç»¿è‰²ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹é¢œè‰²å€¼çš„è®¡ç®—è¿‡ç¨‹ã€‚

é¦–å…ˆæ˜¯ä¸­é—´çº¢è‰²çš„é‚£ä¸ªæ ¼å­ã€‚å› ä¸ºå®ƒå››å‘¨çš„æ ¼å­é¢œè‰²éƒ½æ˜¯1.0ï¼Œæ‰€ä»¥å®ƒçš„é¢œè‰²å˜åŒ–é‡æ˜¯ï¼š0.1 * ((1.0 + 1.0 + 1.0 + 1.0) - 4 * 1.0) = 0ï¼Œé‚£ä¹ˆä¸‹ä¸€å¸§çš„é¢œè‰²å€¼è¿˜æ˜¯1.0ä¸å˜ã€‚

å…¶æ¬¡ï¼Œçº¢æ ¼å­å‘¨å›´çš„å››ä¸ªè“è‰²æ ¼å­ã€‚å®ƒä»¬ä¸‹ä¸€å¸§çš„é¢œè‰²å˜åŒ–é‡ä¸ºï¼š0.1 * ((1.0 + 0 + 0 + 0)- 4 * 1.0) = -0.3ï¼Œé‚£ä¹ˆå®ƒä»¬ä¸‹ä¸€å¸§çš„é¢œè‰²å€¼éƒ½è¦å‡å»0.3 å°±æ˜¯ 0.7ã€‚

æœ€åï¼Œåœ¨è®¡ç®—ç»¿è‰²æ ¼å­ä¸‹ä¸€å¸§çš„é¢œè‰²å€¼æ—¶ï¼Œè¦åˆ†ä¸ºä¸¤ç§æƒ…å†µã€‚

ç¬¬ä¸€ç§ï¼Œå½“è¦è®¡ç®—çš„ç»¿è‰²æ ¼å­å’Œä¸¤ä¸ªè“è‰²æ ¼å­ç›¸é‚»çš„æ—¶å€™ï¼Œé¢œè‰²å˜åŒ–é‡ä¸ºï¼š0.1 * ((1.0 + 1.0 + 0 + 0) - 4 * 0) = 0.2ï¼Œæ‰€ä»¥ç»¿æ ¼å­ä¸‹ä¸€å¸§çš„é¢œè‰²å€¼å˜ä¸º0.2ã€‚

ç¬¬äºŒç§ï¼Œå½“è¿™ä¸ªç»¿è‰²æ ¼å­åªå’Œä¸€ä¸ªè“è‰²æ ¼å­ç›¸é‚»çš„æ—¶å€™ï¼Œé¢œè‰²å˜åŒ–é‡ä¸º0.1ï¼Œé‚£ä¹ˆç»¿æ ¼å­ä¸‹ä¸€å¸§çš„é¢œè‰²å€¼å°±å˜ä¸º0.1ã€‚

å°±è¿™æ ·ï¼Œæˆ‘ä»¬æŠŠæ¯ä¸€å¸§é¢œè‰²æŒ‰ç…§è¿™ä¸ªè§„åˆ™ä¸æ–­è¿­ä»£ä¸‹å»ï¼Œå°±èƒ½å¾—åˆ°ä¸€ä¸ªçƒŸé›¾æ‰©æ•£æ•ˆæœäº†ã€‚é‚£æˆ‘ä»¬ä¸‹ä¸€æ­¥å°±æ˜¯æŠŠå®ƒå®ç°åˆ°Shaderä¸­ï¼Œä¸è¿‡ï¼Œåœ¨Fragment Shaderä¸­æ·»åŠ æ‰©æ•£æ¨¡å‹çš„æ—¶å€™ï¼Œä¸ºäº†è®©è¿™ä¸ªçƒŸé›¾æ•ˆæœï¼Œèƒ½ä¸Šå‡å¾—æ›´æ˜æ˜¾ï¼Œæˆ‘ç¨ç¨ä¿®æ”¹äº†ä¸€ä¸‹æ‰©æ•£å…¬å¼çš„æƒé‡ï¼Œè®©å®ƒå‘ä¸Šçš„å¹…åº¦æ¯”è¾ƒå¤§ã€‚

```
#ifdef GL_ES
precision highp float;
#endif

varying vec2 vUv;
uniform sampler2D tMap;
uniform float uTime;

void main() {
  vec3 smoke = vec3(0);
  if(uTime <= 0.0) {
    vec2 st = vUv - vec2(0.5);
    float d = length(st);
    smoke = vec3(step(d, 0.05));
    // smoke = vec3(1.0 - smoothstep(0.05, 0.055, d));
  }

  vec2 st = vUv;

  float offset = 1.0 / 256.0;
  vec3 diffuse = texture2D(tMap, st).rgb;

  vec4 left = texture2D(tMap, st + vec2(-offset, 0.0));
  vec4 right = texture2D(tMap, st + vec2(offset, 0.0));
  vec4 up = texture2D(tMap, st + vec2(0.0, -offset));
  vec4 down = texture2D(tMap, st + vec2(0.0, offset));

  float diff = 8.0 * 0.016 * (
    left.r + 
    right.r + 
    down.r + 
    2.0 * up.r - 
    5.0 * diffuse.r
  );

  gl_FragColor.rgb = (diffuse + diff) + smoke;
  gl_FragColor.a = 1.0;
}

```

![](https://static001.geekbang.org/resource/image/81/27/816c8798dbe1bd0999c225fa068d8e27.gif?wh=516%2A516)

ä½ ä¼šå‘ç°ï¼Œè¿™ä¸ªæ•ˆæœè¿˜ä¸æ˜¯ç‰¹åˆ«çœŸå®ã€‚é‚£ä¸ºäº†è¾¾åˆ°æ›´çœŸå®çš„çƒŸé›¾æ•ˆæœï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨æ‰©æ•£å‡½æ•°ä¸Šå¢åŠ ä¸€äº›å™ªå£°ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
void main() {
  vec3 smoke = vec3(0);
  if(uTime <= 0.0) {
    vec2 st = vUv - vec2(0.5);
    float d = length(st);
    smoke = vec3(step(d, 0.05));
    // smoke = vec3(1.0 - smoothstep(0.05, 0.055, d));
  }

  vec2 st = vUv;

  float offset = 1.0 / 256.0;
  vec3 diffuse = texture2D(tMap, st).rgb;

  vec4 left = texture2D(tMap, st + vec2(-offset, 0.0));
  vec4 right = texture2D(tMap, st + vec2(offset, 0.0));
  vec4 up = texture2D(tMap, st + vec2(0.0, -offset));
  vec4 down = texture2D(tMap, st + vec2(0.0, offset));

  float rand = noise(st + 5.0 * uTime);
  float diff = 8.0 * 0.016 * (
    (1.0 + rand) * left.r + 
    (1.0 - rand) * right.r + 
    down.r + 
    2.0 * up.r - 
    5.0 * diffuse.r
  );

  gl_FragColor.rgb = (diffuse + diff) + smoke;
  gl_FragColor.a = 1.0;
}
```

è¿™æ ·ï¼Œæˆ‘ä»¬æœ€ç»ˆå®ç°çš„æ•ˆæœçœ‹èµ·æ¥å°±ä¼šæ›´çœŸå®ä¸€äº›ï¼š

![](https://static001.geekbang.org/resource/image/aa/1c/aa617ae27b63fc4687279a17298a721c.gif?wh=514%2A504)

## è¦ç‚¹æ€»ç»“

ä»Šå¤©ï¼Œæˆ‘ä»¬å­¦ä¹ äº†æ€ä¹ˆåœ¨WebGLä¸­ï¼Œä½¿ç”¨åæœŸå¤„ç†é€šé“æ¥å¢å¼ºå›¾åƒçš„è§†è§‰æ•ˆæœã€‚æˆ‘ä»¬è®²äº†ä¸¤ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„æ•ˆæœï¼Œä¸€ä¸ªæ˜¯Bluræ»¤é•œä»¥åŠåŸºäºå®ƒå®ç°è¾‰å…‰æ•ˆæœï¼Œå¦ä¸€ä¸ªæ˜¯çƒŸé›¾æ•ˆæœã€‚

é‚£åæœŸå¤„ç†é€šé“å®ç°è¿™äº›æ•ˆæœçš„æ ¸å¿ƒåŸç†å…¶å®éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯æŠŠç¬¬ä¸€æ¬¡æ¸²æŸ“åçš„å†…å®¹è¾“å‡ºåˆ°å¸§ç¼“å†²å¯¹è±¡FBOä¸­ï¼Œç„¶åæŠŠè¿™ä¸ªå¯¹è±¡çš„å†…å®¹ä½œä¸ºçº¹ç†å›¾ç‰‡ï¼Œå†è¿›è¡Œä¸‹ä¸€æ¬¡æ¸²æŸ“ï¼Œè¿™ä¸ªæ¸²æŸ“çš„è¿‡ç¨‹å¯ä»¥é‡å¤è‹¥å¹²æ¬¡ã€‚æœ€åï¼Œæˆ‘ä»¬å†æŠŠç»“æœè¾“å‡ºåˆ°å±å¹•ä¸Šï¼Œå°±å¯ä»¥äº†ã€‚

åˆ°è¿™é‡Œï¼Œè§†è§‰åŸºç¡€ç¯‡çš„å†…å®¹ï¼Œæˆ‘ä»¬å°±å…¨éƒ¨è®²å®Œäº†ã€‚åœ¨è¿™ä¸ªæ¨¡å—é‡Œï¼Œæˆ‘ä»¬å›´ç»•å¤„ç†å›¾åƒçš„ç»†èŠ‚ï¼Œç³»ç»Ÿåœ°å­¦ä¹ äº†æ€ä¹ˆè¡¨ç¤ºé¢œè‰²ï¼Œæ€ä¹ˆç”Ÿæˆé‡å¤å›¾æ¡ˆï¼Œæ€ä¹ˆæ„é€ å’Œä½¿ç”¨æ»¤é•œå¤„ç†å›¾åƒï¼Œæ€ä¹ˆè¿›è¡Œçº¹ç†é€ å‹ï¼Œè¿˜æœ‰æ€ä¹ˆä½¿ç”¨ä¸åŒçš„åæ ‡ç³»ç»˜å›¾ï¼Œæ€ä¹ˆä½¿ç”¨å™ªå£°å’Œç½‘æ ¼å™ªå£°ç”Ÿæˆå¤æ‚çº¹ç†ã€ä»¥åŠä»Šå¤©å­¦ä¹ çš„æ€ä¹ˆä½¿ç”¨åæœŸå¤„ç†é€šé“å¢å¼ºå›¾åƒã€‚æˆ‘æŠŠæ ¸å¿ƒçš„å†…å®¹æ€»ç»“æˆäº†ä¸€å¼ è„‘å›¾ï¼Œä½ å¯ä»¥å€ŸåŠ©å®ƒï¼Œæ¥å¤ä¹ å·©å›ºè¿™ä¸€æ¨¡å—çš„å†…å®¹ï¼ŒæŸ¥ç¼ºè¡¥æ¼ã€‚

![](https://static001.geekbang.org/resource/image/0b/48/0bcbeb9b391a1b7392b69f9ceaa66548.jpg?wh=2472%2A2465)

## å°è¯•ç‰›åˆ€

ç¬¬ä¸€é¢˜ï¼Œä»Šå¤©ï¼Œæˆ‘ä»¬å®ç°çš„çƒŸé›¾æ‰©æ•£æ•ˆæœè¿˜ä¸å¤Ÿå®Œå–„ï¼Œä¹Ÿä¸å¤Ÿæœ‰è¶£ï¼Œä½ èƒ½è¯•ç€æ”¹è¿›å®ƒï¼Œè®©å®ƒå˜å¾—æ›´æœ‰è¶£å—ï¼Ÿä½ å¯ä»¥å‚è€ƒæˆ‘ç»™å‡ºçš„ä¸¤ä¸ªå»ºè®®ï¼Œä¹Ÿå¯ä»¥è¯•è¯•å…¶ä»–çš„æ•ˆæœã€‚

1.ç»™å®šä¸€ä¸ªå‘é‡ï¼Œè¡¨ç¤ºé£å‘å’Œé£é€Ÿï¼Œè®©çƒŸé›¾éšç€è¿™ä¸ªé£æ‰©æ•£ï¼Œè¿™ä¸ªé£å¯ä»¥éšç€æ—¶é—´æ…¢æ…¢å˜åŒ–ï¼ˆä½ å¯ä»¥ä½¿ç”¨å‰é¢å­¦è¿‡çš„å™ªå£°æ¥å®ç°é£çš„å˜åŒ–ï¼‰ï¼Œçœ‹çœ‹èƒ½å¤Ÿåšå‡ºä»€ä¹ˆæ•ˆæœã€‚

2.å°è¯•è®©çƒŸé›¾è·Ÿéšç€é¼ æ ‡ç§»åŠ¨è½¨è¿¹æ‰©æ•£ï¼Œè¾¾åˆ°ç±»ä¼¼ä¸‹é¢çš„æ•ˆæœã€‚

![](https://static001.geekbang.org/resource/image/f1/89/f180f7ca5c2yy5a9304b504893cf8289.gif?wh=600%2A398)

å¦‚æœä½ è§‰å¾—éš¾ä»¥å®ç°ï¼Œè¿™é‡Œæœ‰[ä¸€ç¯‡æ–‡ç« ](https://gamedevelopment.tutsplus.com/tutorials/how-to-write-a-smoke-shader--cms-25587)è¯¦ç»†è®²äº†çƒŸé›¾ç”Ÿæˆçš„æ–¹æ³•ï¼Œä½ å¯ä»¥ä»”ç»†ç ”ç©¶ä¸€ä¸‹ã€‚

ç¬¬äºŒé¢˜ï¼Œå®é™…ä¸Šï¼ŒåæœŸå¤„ç†é€šé“å¯ä¸æ­¢æ˜¯å®ç°Bluræ»¤é•œã€è¾‰å…‰æˆ–è€…çƒŸé›¾æ•ˆæœé‚£ä¹ˆç®€å•ï¼Œå®ƒè¿˜å¯ä»¥å®ç°å¾ˆå¤šä¸åŒçš„åŠŸèƒ½ã€‚æ¯”å¦‚ï¼ŒSpriteJSå®˜ç½‘ä¸Šé‚£ç§ç±»ä¼¼äº[æ¢ç…§ç¯](%28https://spritejs.org/demo/#/shader_and_pass/pass%29)çš„æ•ˆæœï¼Œå°±æ˜¯ç”¨åæœŸå¤„ç†é€šé“å®ç°çš„ã€‚ä½ å¯ä»¥ç”¨gl-rendereræ¥å®ç°è¿™ç±»æ•ˆæœå—ï¼Ÿ

![](https://static001.geekbang.org/resource/image/5d/14/5df356fdb628efe1173089e90238e814.gif?wh=396%2A406)

æ¬¢è¿åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œåˆ†äº«ä½ çš„ç­”æ¡ˆå’Œæ€è€ƒï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼

* * *

## æºç 

å®Œæ•´çš„ç¤ºä¾‹ä»£ç è§[GitHubä»“åº“](https://github.com/akira-cn/graphics/tree/master/pass)

## æ¨èé˜…è¯»

\[1] [åŸå§‹FBOå¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨æ–¹æ³•](https://blog.csdn.net/xufeng0991/article/details/76736971)

\[2] [How to Write a Smoke Shader](https://gamedevelopment.tutsplus.com/tutorials/how-to-write-a-smoke-shader--cms-25587)
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ4ï¼‰</strong></div><ul>
<li><span>é˜¿é‘«</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æ¢ç…§ç¯æ•ˆæœï¼š https:&#47;&#47;codepen.io&#47;dajiangjun&#47;pen&#47;KKzNqLjã€‚è²Œä¼¼ä¸ç”¨åæœŸé€šé“å¤„ç†æ›´åŠ ç®€å•</p>2020-08-21</li><br/><li><span>æœ‰ä¸€ç§è¸å®</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>åå¤„ç†æ–¹å¼å®ç°æ¢ç…§ç¯æ•ˆæœï¼šhttps:&#47;&#47;github.com&#47;IDonotK&#47;graphics&#47;blob&#47;master&#47;homework&#47;h17&#47;index3.html
å…‰åœºå‡½æ•°æœ‰å¾…ä¼˜åŒ–ï¼ŒçœŸå®çš„æ‰‹ç”µç­’å…‰åœºå‡½æ•°æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ</p>2023-12-26</li><br/><li><span>èƒ¡æµ©</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å¥½ç§€å•Š</p>2020-08-08</li><br/><li><span>æ¨Šç‘</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>update ä¸­çš„ renderer.uniforms.tMap = fbo.texture;
å‡ºç°äº†ä¸¤æ¬¡ï¼Œè™½ç„¶ä¸å½±å“æ•ˆæœï¼Œä½†æ˜¯å¹²æ‰°äº†å­¦ä¹ ï¼›æƒ³äº†åŠå¤©ä¹Ÿæ²¡æƒ³åˆ°æœ‰ä»€ä¹ˆç‰¹æ®Šç”¨å¤„ï¼Ÿï¼Ÿï¼Ÿ
ç¬¬äºŒæ¬¡å¯ä»¥åˆ äº†å§</p>2021-03-04</li><br/>
</ul>