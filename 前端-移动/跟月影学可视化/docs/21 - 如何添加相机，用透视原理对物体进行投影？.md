ä½ å¥½ï¼Œæˆ‘æ˜¯æœˆå½±ã€‚

ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬åœ¨ç»˜åˆ¶3Då‡ ä½•ä½“çš„æ—¶å€™ï¼Œå®é™…ä¸Šæœ‰ä¸€ä¸ªå‡è®¾ï¼Œé‚£å°±æ˜¯è§‚å¯Ÿè€…å§‹ç»ˆä»ä¸‰ç»´ç©ºé—´åæ ‡ç³»çš„æ­£é¢ï¼Œä¹Ÿå°±æ˜¯zè½´æ­£æ–¹å‘ï¼Œçœ‹å‘åæ ‡åŸç‚¹ã€‚ä½†åœ¨çœŸå®ä¸–ç•Œçš„æ¨¡å‹é‡Œï¼Œè§‚å¯Ÿè€…å¯ä»¥å¤„åœ¨ä»»ä½•ä¸€ä¸ªä½ç½®ä¸Šã€‚

é‚£ä»Šå¤©ï¼Œæˆ‘ä»¬å°±åœ¨ä¸ŠèŠ‚è¯¾çš„åŸºç¡€ä¸Šï¼Œå¼•å…¥ä¸€ä¸ªç©ºé—´è§‚å¯Ÿè€…çš„è§’è‰²ï¼Œæˆ–è€…è¯´æ˜¯ç›¸æœºï¼ˆCameraï¼‰ï¼Œæ¥æ€»ç»“ä¸€ä¸ªæ›´é€šç”¨çš„ç»˜å›¾æ¨¡å‹ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½ç»˜åˆ¶å‡ºï¼Œä»ä¸‰ç»´ç©ºé—´ä¸­ä»»æ„ä¸€ä¸ªä½ç½®è§‚å¯Ÿç‰©ä½“çš„æ•ˆæœäº†ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥è¯´è¯´ä»€ä¹ˆæ˜¯ç›¸æœºã€‚

## å¦‚ä½•ç†è§£ç›¸æœºå’Œè§†å›¾çŸ©é˜µï¼Ÿ

æˆ‘ä»¬ç°åœ¨å‡è®¾ï¼Œåœ¨WebGLçš„ä¸‰ç»´ä¸–ç•Œä»»æ„ä½ç½®ä¸Šæœ‰ä¸€ä¸ªç›¸æœºï¼Œå®ƒå¯ä»¥ç”¨ä¸€ä¸ªä¸‰ç»´åæ ‡ï¼ˆPositionï¼‰å’Œä¸€ä¸ªä¸‰ç»´å‘é‡æ–¹å‘ï¼ˆLookAt Targetï¼‰æ¥è¡¨ç¤ºã€‚

åœ¨åˆå§‹æƒ…å†µä¸‹ï¼Œç›¸æœºçš„å‚è€ƒåæ ‡å’Œä¸–ç•Œåæ ‡æ˜¯é‡åˆçš„ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬ç§»åŠ¨æˆ–è€…æ—‹è½¬ç›¸æœºçš„æ—¶å€™ï¼Œç›¸æœºçš„å‚è€ƒåæ ‡å’Œä¸–ç•Œåæ ‡å°±ä¸é‡åˆäº†ã€‚

è€Œæˆ‘ä»¬æœ€ç»ˆè¦åœ¨Canvasç”»å¸ƒä¸Šç»˜åˆ¶å‡ºçš„æ˜¯ï¼Œä»¥ç›¸æœºä¸ºè§‚å¯Ÿè€…çš„å›¾å½¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦ç”¨ä¸€ä¸ªå˜æ¢ï¼Œå°†ä¸–ç•Œåæ ‡è½¬æ¢ä¸ºç›¸æœºåæ ‡ã€‚è¿™ä¸ªå˜æ¢çš„çŸ©é˜µå°±æ˜¯**è§†å›¾çŸ©é˜µ**ï¼ˆViewMatrixï¼‰ã€‚

è®¡ç®—è§†å›¾çŸ©é˜µæ¯”è¾ƒç®€å•çš„ä¸€ç§æ–¹æ³•æ˜¯ï¼Œæˆ‘ä»¬å…ˆè®¡ç®—ç›¸æœºçš„æ¨¡å‹çŸ©é˜µï¼Œç„¶åå¯¹çŸ©é˜µä½¿ç”¨lookAtå‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å¾—åˆ°çš„çŸ©é˜µå°±æ˜¯è§†å›¾çŸ©é˜µçš„é€†çŸ©é˜µã€‚ç„¶åï¼Œæˆ‘ä»¬å†å¯¹è¿™ä¸ªé€†çŸ©é˜µæ±‚ä¸€æ¬¡é€†ï¼Œå°±å¯ä»¥å¾—åˆ°è§†å›¾çŸ©é˜µäº†ã€‚

è¿™ä¹ˆè¯´è¿˜æ˜¯æœ‰ç‚¹æ¯”è¾ƒæŠ½è±¡ï¼Œæˆ‘ä»¬é€šè¿‡ä»£ç æ¥ç†è§£ã€‚

```
function updateCamera(eye, target = [0, 0, 0]) {
  const [x, y, z] = eye;
  const m = new Mat4(
    1, 0, 0, 0,
    0, 1, 0, 0,
    0, 0, 1, 0,
    x, y, z, 1,
  );
  const up = [0, 1, 0];
  m.lookAt(eye, target, up).inverse();
  renderer.uniforms.viewMatrix = m;
}
```

å¦‚ä¸Šé¢ä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬è®¾ç½®ç›¸æœºåˆå§‹ä½ç½®çŸ©é˜µmï¼Œç„¶åæ‰§è¡Œm.lookAt(eye, target, up)ï¼Œè¿™é‡Œçš„upæ˜¯ä¸€ä¸ªå‘é‡ï¼Œè¡¨ç¤ºæœä¸Šçš„æ–¹å‘ï¼Œæˆ‘ä»¬æŠŠå®ƒå®šä¹‰ä¸ºyè½´æ­£å‘ã€‚ç„¶åæˆ‘ä»¬è°ƒç”¨inverseï¼Œå°†è¿™ä¸ªç»“æœæ±‚é€†ï¼Œå¾—åˆ°çš„å°±æ˜¯è§†å›¾çŸ©é˜µã€‚

ä¸ºäº†è®©ä½ çœ‹åˆ°ç›¸æœºçš„æ•ˆæœï¼Œæˆ‘ä»¬æ”¹å†™ä¸ŠèŠ‚è¯¾åœ†æŸ±ä½“çš„é¡¶ç‚¹ç€è‰²å™¨ä»£ç ï¼ŒåŠ å…¥è§†å›¾çŸ©é˜µã€‚

```
 attribute vec3 a_vertexPosition;
  attribute vec4 color;
  attribute vec3 normal;

  varying vec4 vColor;
  varying float vCos;
  uniform mat4 projectionMatrix;
  uniform mat4 modelMatrix;
  uniform mat4 viewMatrix;
  uniform mat3 normalMatrix;
  
  const vec3 lightPosition = vec3(1, 0, 0);

  void main() {
    gl_PointSize = 1.0;
    vColor = color;
    vec4 pos = viewMatrix * modelMatrix * vec4(a_vertexPosition, 1.0);
    vec4 lp = viewMatrix * vec4(lightPosition, 1.0);
    vec3 invLight = lp.xyz - pos.xyz;
    vec3 norm = normalize(normalMatrix * normal);
    vCos = max(dot(normalize(invLight), norm), 0.0);
    gl_Position = projectionMatrix * pos;
  }
```

è¿™æ ·ï¼Œå¦‚æœæˆ‘ä»¬å°±æŠŠç›¸æœºä½ç½®æ”¹å˜äº†ã€‚æˆ‘ä»¬ä»¥updateCamera(\[0.5, 0, 0.5]); ä¸ºä¾‹ï¼Œè¿™æ ·æœå‘(0, 0, 0)æ‹æ‘„å›¾åƒçš„æœ€ç»ˆæ•ˆæœå°±å¦‚ä¸‹æ‰€ç¤ºã€‚

![](https://static001.geekbang.org/resource/image/0c/3d/0cb89b225568d718d3b0e29ec2107a3d.jpeg?wh=1920%2A660)

## å‰ªè£ç©ºé—´å’ŒæŠ•å½±å¯¹3Då›¾åƒçš„å½±å“

åœ¨å‰é¢çš„è¯¾ç¨‹ä¸­æˆ‘ä»¬è¯´è¿‡ï¼ŒWebGLçš„é»˜è®¤åæ ‡èŒƒå›´æ˜¯ä»-1åˆ°1çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰å½“å›¾åƒçš„xã€yã€zçš„å€¼åœ¨-1åˆ°1åŒºé—´å†…æ‰ä¼šè¢«æ˜¾ç¤ºåœ¨ç”»å¸ƒä¸Šï¼Œè€Œåœ¨å…¶ä»–ä½ç½®ä¸Šçš„å›¾åƒéƒ½ä¼šè¢«å‰ªè£æ‰ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬ä¿®æ”¹æ¨¡å‹çŸ©é˜µï¼Œè®©åœ†æŸ±ä½“æ²¿xã€yè½´å¹³ç§»ï¼Œå‘å³ä¸Šæ–¹å„å¹³ç§»0.5ï¼Œé‚£ä¹ˆåœ†æŸ±ä¸­xã€yå€¼å¤§äº1çš„éƒ¨åˆ†éƒ½ä¼šè¢«å‰ªè£æ‰ï¼Œå› ä¸ºè¿™äº›éƒ¨åˆ†å·²ç»è¶…è¿‡äº†Canvasè¾¹ç¼˜ã€‚æ“ä½œä»£ç å’Œæœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š

```
function update() {
  const modelMatrix = fromRotation(rotationX, rotationY, rotationZ);
  modelMatrix[12] = 0.5; // ç»™ x è½´å¢åŠ  0.5 çš„å¹³ç§»
  modelMatrix[13] = 0.5; // ç»™ y è½´ä¹Ÿå¢åŠ  0.5 çš„å¹³ç§»
  renderer.uniforms.modelMatrix = modelMatrix;
  renderer.uniforms.normalMatrix = normalFromMat4([], modelMatrix);
  ...
}
```

![](https://static001.geekbang.org/resource/image/0c/69/0ce1b0da1ddaf4c993f928a6fc16a869.jpeg?wh=1920%2A761 "ç»™xã€yå¢åŠ 0.5å¹³ç§»åçš„æ•ˆæœ")

å¯¹äºåªæœ‰xã€yçš„äºŒç»´åæ ‡ç³»æ¥è¯´ï¼Œè¿™ä¸€ç‚¹å¾ˆå¥½ç†è§£ã€‚ä½†æ˜¯ï¼Œå¯¹äºä¸‰ç»´åæ ‡ç³»æ¥è¯´ï¼Œä¸ä»…xã€yè½´ä¼šè¢«å‰ªè£ï¼Œzè½´åŒæ ·ä¹Ÿä¼šè¢«å‰ªè£ã€‚æˆ‘ä»¬è¿˜æ˜¯ç›´æ¥ä¿®æ”¹ä»£ç ï¼Œç»™zè½´å¢åŠ 0.5çš„å¹³ç§»ã€‚ä½ ä¼šçœ‹åˆ°ï¼Œæœ€ç»ˆç»˜åˆ¶å‡ºæ¥çš„å›¾å½¢éå¸¸å¥‡æ€ªã€‚

![](https://static001.geekbang.org/resource/image/a0/8c/a0808ebaf37784b633271e1b41047e8c.jpeg?wh=1920%2A728 "ç»™zè½´å¢åŠ 0.5å¹³ç§»åçš„æ•ˆæœ")

ä¼šæ˜¾ç¤ºè¿™ä¹ˆå¥‡æ€ªçš„ç»“æœï¼Œå°±æ˜¯å› ä¸ºzè½´è¶…è¿‡èŒƒå›´çš„éƒ¨åˆ†ä¹Ÿè¢«å‰ªè£æ‰äº†ï¼Œå¯¼è‡´æŠ•å½±å‡ºç°äº†é—®é¢˜ã€‚

æ—¢ç„¶æ˜¯æŠ•å½±å‡ºç°äº†é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆå›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬éƒ½å¯¹zè½´åšè¿‡å“ªäº›æŠ•å½±æ“ä½œã€‚åœ¨ç»˜åˆ¶åœ†æŸ±ä½“çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªæ˜¯ç”¨æŠ•å½±çŸ©é˜µéå¸¸ç®€å•åœ°åè½¬äº†ä¸€ä¸‹zè½´ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œæ²¡åšè¿‡å…¶ä»–ä»»ä½•æ“ä½œäº†ã€‚æ‰€ä»¥ï¼Œä¸ºäº†è®©å›¾å½¢åœ¨å‰ªè£ç©ºé—´ä¸­æ­£ç¡®æ˜¾ç¤ºï¼Œæˆ‘ä»¬ä¸èƒ½åªåè½¬zè½´ï¼Œè¿˜éœ€è¦å°†å›¾åƒä»ä¸‰ç»´ç©ºé—´ä¸­**æŠ•å½±**åˆ°å‰ªè£åæ ‡å†…ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå›¾åƒæ˜¯æ€ä¹ˆè¢«æŠ•å½±åˆ°å‰ªè£åæ ‡å†…çš„å‘¢ï¼Ÿ

ä¸€èˆ¬æ¥è¯´ï¼ŒæŠ•å½±æœ‰ä¸¤ç§æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯**æ­£æŠ•å½±**ä¸**é€è§†æŠ•å½±**ã€‚ä½ å¯ä»¥ç»“åˆæˆ‘ç»™å‡ºçš„ç¤ºæ„å›¾ï¼Œæ¥ç†è§£å®ƒä»¬å„è‡ªçš„ç‰¹ç‚¹ã€‚

**é¦–å…ˆæ˜¯æ­£æŠ•å½±**ï¼Œå®ƒåˆå«åšå¹³è¡ŒæŠ•å½±ã€‚æ­£æŠ•å½±æ˜¯å°†ç‰©ä½“æŠ•å½±åˆ°ä¸€ä¸ªé•¿æ–¹ä½“çš„ç©ºé—´ï¼ˆåˆç§°ä¸ºè§†æ™¯ä½“ï¼‰ï¼Œå¹¶ä¸”æ— è®ºç›¸æœºä¸ç‰©ä½“è·ç¦»å¤šè¿œï¼ŒæŠ•å½±çš„å¤§å°éƒ½ä¸å˜ã€‚

[![](https://static001.geekbang.org/resource/image/d6/b1/d69c5a24cf92bea9ebf24f6222a225b1.jpeg?wh=1920%2A1049 "æ­£æŠ•å½±ç¤ºæ„å›¾")](https://glumes.com/post/opengl/opengl-tutorial-projection-matrix/)

è€Œ**é€è§†æŠ•å½±**åˆ™æ›´æ¥è¿‘æˆ‘ä»¬çš„è§†è§‰æ„ŸçŸ¥ã€‚å®ƒæŠ•å½±çš„è§„å¾‹æ˜¯ï¼Œç¦»ç›¸æœºè¿‘çš„ç‰©ä½“å¤§ï¼Œç¦»ç›¸æœºè¿œçš„ç‰©ä½“å°ã€‚ä¸æ­£æŠ•å½±ä¸åŒï¼Œæ­£æŠ•å½±çš„è§†æ™¯ä½“æ˜¯ä¸€ä¸ªé•¿æ–¹ä½“ï¼Œè€Œé€è§†æŠ•å½±çš„è§†æ™¯ä½“æ˜¯ä¸€ä¸ªæ£±å°ã€‚

[![](https://static001.geekbang.org/resource/image/fd/43/fd76c623daba4a80f6c557e03a82bb43.jpeg?wh=1920%2A1080 "é€è§†æŠ•å½±ç¤ºæ„å›¾")](https://glumes.com/post/opengl/opengl-tutorial-projection-matrix/)

çŸ¥é“äº†ä¸åŒæŠ•å½±æ–¹å¼çš„ç‰¹ç‚¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®æŠ•å½±æ–¹å¼å’Œç»™å®šçš„å‚æ•°æ¥è®¡ç®—æŠ•å½±çŸ©é˜µäº†ã€‚å› ä¸ºæ•°å­¦æ¨å¯¼è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘åœ¨è¿™é‡Œå°±ä¸è¯¦ç»†æ¨å¯¼äº†ï¼Œç›´æ¥ç»™å‡ºå¯¹åº”çš„JavaScriptå‡½æ•°ï¼Œä½ åªè¦è®°ä½orthoå’Œperspectiveè¿™ä¸¤ä¸ªæŠ•å½±å‡½æ•°å°±å¯ä»¥äº†ï¼Œå‡½æ•°å¦‚ä¸‹æ‰€ç¤ºã€‚

å…¶ä¸­ï¼Œorthoæ˜¯è®¡ç®—æ­£æŠ•å½±çš„å‡½æ•°ï¼Œå®ƒçš„å‚æ•°æ˜¯è§†æ™¯ä½“xã€yã€zä¸‰ä¸ªæ–¹å‘çš„åæ ‡èŒƒå›´ï¼Œå®ƒçš„è¿”å›å€¼å°±æ˜¯æŠ•å½±çŸ©é˜µã€‚è€Œperspectiveæ˜¯è®¡ç®—é€è§†æŠ•å½±çš„å‡½æ•°ï¼Œå®ƒçš„å‚æ•°æ˜¯è¿‘æ™¯å¹³é¢nearã€è¿œæ™¯å¹³é¢farã€è§†è§’fovå’Œå®½é«˜æ¯”ç‡aspectï¼Œè¿”å›å€¼ä¹Ÿæ˜¯æŠ•å½±çŸ©é˜µã€‚

```
// è®¡ç®—æ­£æŠ•å½±çŸ©é˜µ
function ortho(out, left, right, bottom, top, near, far) {
   let lr = 1 / (left - right);
   let bt = 1 / (bottom - top);
   let nf = 1 / (near - far);
   out[0] = -2 * lr;
   out[1] = 0;
   out[2] = 0;
   out[3] = 0;
   out[4] = 0;
   out[5] = -2 * bt;
   out[6] = 0;
   out[7] = 0;
   out[8] = 0;
   out[9] = 0;
   out[10] = 2 * nf;
   out[11] = 0;
   out[12] = (left + right) * lr;
   out[13] = (top + bottom) * bt;
   out[14] = (far + near) * nf;
   out[15] = 1;
   return out;
}

// è®¡ç®—é€è§†æŠ•å½±çŸ©é˜µ
function perspective(out, fovy, aspect, near, far) {
   let f = 1.0 / Math.tan(fovy / 2);
   let nf = 1 / (near - far);
   out[0] = f / aspect;
   out[1] = 0;
   out[2] = 0;
   out[3] = 0;
   out[4] = 0;
   out[5] = f;
   out[6] = 0;
   out[7] = 0;
   out[8] = 0;
   out[9] = 0;
   out[10] = (far + near) * nf;
   out[11] = -1;
   out[12] = 0;
   out[13] = 0;
   out[14] = 2 * far * near * nf;
   out[15] = 0;
   return out;
}
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆè¯•è¯•å¯¹åœ†æŸ±ä½“è¿›è¡Œæ­£æŠ•å½±ã€‚å‡è®¾ï¼Œåœ¨æ­£æŠ•å½±çš„æ—¶å€™ï¼Œæˆ‘ä»¬è®©è§†æ™¯ä½“ä¸‰ä¸ªæ–¹å‘çš„èŒƒå›´éƒ½æ˜¯(-2,2)ã€‚ä»¥åˆšæ‰çš„ç›¸æœºä½ç½®ä¸ºå‚ç…§ï¼ˆä»»ä½•ä¸€ä¸ªä½ç½®è§‚å¯Ÿéƒ½ä¸€æ ·ï¼Œä¸ç®¡ç‰©ä½“åœ¨å“ªé‡Œï¼Œéƒ½æ˜¯åªæœ‰ä¹‹å‰å¤§å°çš„ä¸€åŠã€‚å› ä¸ºè§†æ™¯ä½“èŒƒå›´å¢åŠ äº†ï¼‰ï¼Œæˆ‘ä»¬ç»˜åˆ¶å‡ºæ¥çš„åœ†æŸ±ä½“çš„å¤§å°åªæœ‰ä¹‹å‰çš„ä¸€åŠã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬é€šè¿‡æŠ•å½±å˜æ¢å°†ç©ºé—´åæ ‡èŒƒå›´å¢å¤§äº†ä¸€å€ã€‚

```
import {ortho} from '../common/lib/math/functions/Mat4Func.js';
function projection(left, right, bottom, top, near, far) {
  return ortho([], left, right, bottom, top, near, far);
}

const projectionMatrix = projection(-2, 2, -2, 2, -2, 2);
renderer.uniforms.projectionMatrix = projectionMatrix; // æŠ•å½±çŸ©é˜µ 

updateCamera([0.5, 0, 0.5]); // è®¾ç½®ç›¸æœºä½ç½®
```

![](https://static001.geekbang.org/resource/image/05/yb/05fdd4fe5e56eaf27e1f1a00825e8yyb.jpeg?wh=1920%2A508)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†è¯•ä¸€ä¸‹å¯¹åœ†æŸ±ä½“è¿›è¡Œé€è§†æŠ•å½±ã€‚åœ¨è¿›è¡Œé€è§†æŠ•å½±çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°†ç›¸æœºçš„ä½ç½®æ”¾åœ¨(2, 2, 3)çš„åœ°æ–¹ã€‚

```
import {perspective} from '../common/lib/math/functions/Mat4Func.js';

function projection(near = 0.1, far = 100, fov = 45, aspect = 1) {
  return perspective([], fov * Math.PI / 180, aspect, near, far);
}

const projectionMatrix = projection();
renderer.uniforms.projectionMatrix = projectionMatrix;

updateCamera([2, 2, 3]); // è®¾ç½®ç›¸æœºä½ç½®
```

![](https://static001.geekbang.org/resource/image/cb/38/cb20b6589554e7bae62567d68bff7938.jpeg?wh=1920%2A547)

æˆ‘ä»¬å‘ç°ï¼Œåœ¨é€è§†æŠ•å½±ä¸‹ï¼Œè·ç¦»è§‚å¯Ÿè€…ï¼ˆç›¸æœºï¼‰è¿‘çš„éƒ¨åˆ†å¤§ï¼Œè·ç¦»å®ƒè¿œçš„éƒ¨åˆ†å°ã€‚è¿™æ›´ç¬¦åˆçœŸå®ä¸–ç•Œä¸­æˆ‘ä»¬çœ‹åˆ°çš„æ•ˆæœï¼Œæ‰€ä»¥ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨ç»˜åˆ¶3Då›¾å½¢æ—¶ï¼Œæˆ‘ä»¬æ›´åå‘ä½¿ç”¨é€è§†æŠ•å½±ã€‚

## 3Dç»˜å›¾æ ‡å‡†æ¨¡å‹

å®é™…ä¸Šï¼Œé€šè¿‡ä¸ŠèŠ‚è¯¾å’Œåˆšæ‰çš„å†…å®¹ï¼Œæˆ‘ä»¬å·²ç»èƒ½æ€»ç»“å‡º3Dç»˜åˆ¶å‡ ä½•ä½“çš„åŸºæœ¬æ•°å­¦æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯3Dç»˜å›¾çš„**æ ‡å‡†æ¨¡å‹**ã€‚è¿™ä¸ªæ ‡å‡†æ¨¡å‹ä¸€å…±æœ‰å››ä¸ªçŸ©é˜µï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š**æŠ•å½±çŸ©é˜µã€è§†å›¾çŸ©é˜µï¼ˆViewMatrixï¼‰ã€æ¨¡å‹çŸ©é˜µï¼ˆModelMatrixï¼‰ã€æ³•å‘é‡çŸ©é˜µï¼ˆNormalMatrixï¼‰**ã€‚

å…¶ä¸­ï¼Œå‰ä¸‰ä¸ªçŸ©é˜µç”¨æ¥è®¡ç®—æœ€ç»ˆæ˜¾ç¤ºçš„å‡ ä½•ä½“çš„é¡¶ç‚¹ä½ç½®ï¼Œç¬¬å››ä¸ªçŸ©é˜µç”¨æ¥å®ç°å…‰ç…§ç­‰æ•ˆæœã€‚æ¯”è¾ƒæˆç†Ÿçš„å›¾å½¢åº“ï¼Œå¦‚[ThreeJS](https://threejs.org/)ã€[BabylonJS](https://www.babylonjs.com/)ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯é‡‡ç”¨è¿™ä¸ªæ ‡å‡†æ¨¡å‹æ¥è¿›è¡Œ3Dç»˜å›¾çš„ã€‚æ‰€ä»¥ç†è§£è¿™ä¸ªæ¨¡å‹ï¼Œä¹Ÿæœ‰åŠ©äºå¢å¼ºæˆ‘ä»¬å¯¹å›¾å½¢åº“çš„è®¤è¯†ï¼Œå¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°å»ä½¿ç”¨è¿™äº›æµè¡Œçš„å›¾å½¢åº“ã€‚

åœ¨å‰é¢çš„è¯¾ç¨‹ä¸­ï¼Œå› ä¸ºWebGLåŸç”Ÿçš„APIåœ¨ä½¿ç”¨ä¸Šæ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨äº†ç®€æ˜“çš„gl-rendereråº“æ¥ç®€åŒ–2Dç»˜å›¾è¿‡ç¨‹ã€‚è€Œ3Dç»˜å›¾æ˜¯ä¸€ä¸ªæ¯”2Dç»˜å›¾æ›´åŠ å¤æ‚çš„è¿‡ç¨‹ï¼Œå³ä½¿æ˜¯gl-rendereråº“ä¹Ÿæœ‰ç‚¹åŠ›ä¸ä»å¿ƒï¼Œæˆ‘ä»¬éœ€è¦æ›´åŠ å¼ºå¤§çš„ç»˜å›¾åº“ï¼Œæ¥ç®€åŒ–æˆ‘ä»¬çš„ç»˜åˆ¶ï¼Œä»¥ä¾¿äºæˆ‘ä»¬èƒ½å¤ŸæŠŠç²¾åŠ›ä¸“æ³¨äºç†è§£å›¾å½¢å­¦æœ¬èº«çš„æ ¸å¿ƒå†…å®¹ã€‚

å½“ç„¶ï¼Œä½¿ç”¨ThreeJSæˆ–BabeylonJSéƒ½æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚ä½†æ˜¯åœ¨è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä¼šä½¿ç”¨ä¸€ä¸ªæ›´åŠ è½»é‡çº§çš„å›¾å½¢åº“ï¼Œå«åš[OGL](https://github.com/oframe/ogl)ã€‚å®ƒæ‹¥æœ‰æˆ‘ä»¬å¯è§†åŒ–ç»˜å›¾éœ€è¦çš„æ‰€æœ‰åŸºæœ¬åŠŸèƒ½ï¼Œè€Œä¸”ï¼Œç›¸æ¯”äºThreeJSç­‰æµè¡Œå›¾å½¢åº“ï¼Œå®ƒçš„APç›¸å¯¹æ›´åº•å±‚ã€æ›´ç®€å•ä¸€äº›ã€‚å› æ­¤ä¸ä¼šæœ‰å¤ªå¤šé«˜çº§çš„ç‰¹æ€§å¯¹æˆ‘ä»¬çš„å­¦ä¹ é€ æˆå¹²æ‰°ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘å°±ç”¨è¿™ä¸ªåº“æ¥ç»˜åˆ¶ä¸€äº›ç®€å•çš„åœ†æŸ±ä½“ã€ç«‹æ–¹ä½“ç­‰ç­‰ï¼Œè®©ä½ å¯¹è¿™ä¸ªåº“çš„ä½¿ç”¨æœ‰ä¸€ä¸ªå…¨é¢çš„äº†è§£ã€‚

## å¦‚ä½•ä½¿ç”¨OGLç»˜åˆ¶åŸºæœ¬çš„å‡ ä½•ä½“

OGLåº“ä½¿ç”¨çš„ä¹Ÿæ˜¯æˆ‘ä»¬åˆšæ‰è¯´çš„æ ‡å‡†æ¨¡å‹ï¼Œå› æ­¤ï¼Œä½¿ç”¨å®ƒæ‰€ä»¥ç»˜åˆ¶å‡ ä½•ä½“éå¸¸ç®€å•ï¼Œåˆ†æˆä»¥ä¸‹7ä¸ªæ­¥éª¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://static001.geekbang.org/resource/image/5b/4c/5b2b4622f1bea87199788d20a2629b4c.jpg?wh=2253%2A693%3Fwh%3D2253%2A693)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¯¦ç»†æ¥çœ‹çœ‹æ¯ä¸€æ­¥çš„æ“ä½œã€‚

é¦–å…ˆï¼Œæ˜¯åˆ›å»ºRendererå¯¹è±¡ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªç”»å¸ƒå®½é«˜ä¸º512çš„Rendererå¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
const canvas = document.querySelector('canvas');
const renderer = new Renderer({
  canvas,
  width: 512,
  height: 512,
});

```

ç„¶åï¼Œæˆ‘ä»¬åœ¨OGLä¸­ï¼Œé€šè¿‡new Cameraæ¥åˆ›å»ºç›¸æœºï¼Œé»˜è®¤åˆ›å»ºå‡ºçš„æ˜¯é€è§†æŠ•å½±ç›¸æœºã€‚è¿™é‡Œæˆ‘ä»¬æŠŠè§†è§’è®¾ç½®ä¸º35åº¦ï¼Œä½ç½®è®¾ç½®ä¸º(0,1,7)ï¼Œæœå‘ä¸º(0,0,0)ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
const gl = renderer.gl;
gl.clearColor(1, 1, 1, 1);
const camera = new Camera(gl, {fov: 35});
camera.position.set(0, 1, 7);
camera.lookAt([0, 0, 0]);
```

æ¥ç€ï¼Œæˆ‘ä»¬åˆ›å»ºåœºæ™¯ã€‚OGLä½¿ç”¨æ ‘å½¢æ¸²æŸ“çš„æ–¹å¼ï¼Œæ‰€ä»¥åœ¨ç”¨OGLåˆ›å»ºåœºæ™¯æ—¶ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨Transformå…ƒç´ ã€‚Transformç±»å‹æ˜¯åŸºæœ¬å…ƒç´ ï¼Œå®ƒå¯ä»¥æ·»åŠ å­å…ƒç´ å’Œè®¾ç½®å‡ ä½•å˜æ¢ï¼Œå¦‚æœçˆ¶å…ƒç´ è®¾ç½®äº†å˜æ¢ï¼Œè¿™äº›å˜æ¢ä¹Ÿä¼šè¢«åº”ç”¨åˆ°å­å…ƒç´ ã€‚

```
const scene = new Transform();
```

ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºå‡ ä½•ä½“å¯¹è±¡ã€‚OGLå†…ç½®äº†è®¸å¤šå¸¸ç”¨çš„å‡ ä½•ä½“å¯¹è±¡ï¼ŒåŒ…æ‹¬çƒä½“Sphereã€ç«‹æ–¹ä½“Boxã€æŸ±/é”¥ä½“Cylinderä»¥åŠç¯é¢Torusç­‰ç­‰ã€‚ä½¿ç”¨è¿™äº›å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿåˆ›å»ºè¿™äº›å‡ ä½•ä½“çš„é¡¶ç‚¹ä¿¡æ¯ã€‚é‚£åœ¨è¿™é‡Œï¼Œæˆ‘åˆ›å»ºäº†4ä¸ªå‡ ä½•ä½“å¯¹è±¡ï¼Œåˆ†åˆ«æ˜¯çƒä½“ã€ç«‹æ–¹ä½“ã€æ¤ä½“å’Œç¯é¢ã€‚

```
const sphereGeometry = new Sphere(gl);
const cubeGeometry = new Box(gl);
const cylinderGeometry = new Cylinder(gl);
const torusGeometry = new Torus(gl);
```

å†ç„¶åï¼Œæˆ‘ä»¬åˆ›å»º WebGL ç¨‹åºã€‚å¹¶ä¸”ï¼Œæˆ‘ä»¬åœ¨ç€è‰²å™¨ä¸­ç»™è¿™äº›å‡ ä½•ä½“è®¾ç½®äº†æµ…è“è‰²å’Œç®€å•çš„å…‰ç…§æ•ˆæœã€‚

```
const vertex = /* glsl */ `
  precision highp float;

  attribute vec3 position;
  attribute vec3 normal;
  uniform mat4 modelViewMatrix;
  uniform mat4 projectionMatrix;
  uniform mat3 normalMatrix;
  varying vec3 vNormal;
  void main() {
      vNormal = normalize(normalMatrix * normal);
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }
`;

const fragment = /* glsl */ `
  precision highp float;

  varying vec3 vNormal;
  void main() {
      vec3 normal = normalize(vNormal);
      float lighting = dot(normal, normalize(vec3(-0.3, 0.8, 0.6)));
      gl_FragColor.rgb = vec3(0.2, 0.8, 1.0) + lighting * 0.1;
      gl_FragColor.a = 1.0;
  }
`;

const program = new Program(gl, {
  vertex,
  fragment,
});
```

æœ‰äº†WebGLç¨‹åºä¹‹åï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒå’Œå‡ ä½•ä½“å¯¹è±¡æ¥æ„å»ºçœŸæ­£çš„ç½‘æ ¼ï¼ˆMeshï¼‰å…ƒç´ ï¼Œæœ€ç»ˆå†æŠŠè¿™äº›å…ƒç´ æ¸²æŸ“åˆ°ç”»å¸ƒä¸Šã€‚æˆ‘ä»¬åˆ›å»ºäº†4ä¸ªç½‘æ ¼å¯¹è±¡ï¼Œå®ƒä»¬çš„å½¢çŠ¶åˆ†åˆ«æ˜¯ç¯é¢ã€çƒä½“ã€ç«‹æ–¹ä½“å’Œåœ†æŸ±ï¼Œæˆ‘ä»¬ç»™å®ƒä»¬è®¾ç½®äº†ä¸åŒçš„ä½ç½®ï¼Œç„¶åå°†å®ƒä»¬æ·»åŠ åˆ°åœºæ™¯sceneä¸­å»ã€‚

```
const torus = new Mesh(gl, {geometry: torusGeometry, program});
torus.position.set(0, 1.3, 0);
torus.setParent(scene);

const sphere = new Mesh(gl, {geometry: sphereGeometry, program});
sphere.position.set(1.3, 0, 0);
sphere.setParent(scene);

const cube = new Mesh(gl, {geometry: cubeGeometry, program});
cube.position.set(0, -1.3, 0);
cube.setParent(scene);

const cylinder = new Mesh(gl, {geometry: cylinderGeometry, program});
cylinder.position.set(-1.3, 0, 0);
cylinder.setParent(scene);
```

æœ€åï¼Œæˆ‘ä»¬å°†å®ƒä»¬ç”¨ç›¸æœºcameraå¯¹è±¡çš„è®¾å®šæ¸²æŸ“å‡ºæ¥ï¼Œå¹¶åˆ†åˆ«è®¾ç½®ç»•yè½´æ—‹è½¬çš„åŠ¨ç”»ï¼Œä½ å°±èƒ½çœ‹åˆ°è¿™4ä¸ªå›¾åƒæ—‹è½¬çš„ç”»é¢äº†ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
requestAnimationFrame(update);
function update() {
  requestAnimationFrame(update);

  torus.rotation.y -= 0.02;
  sphere.rotation.y -= 0.03;
  cube.rotation.y -= 0.04;
  cylinder.rotation.y -= 0.02;

  renderer.render({scene, camera});
}
```

![](https://static001.geekbang.org/resource/image/b8/41/b8eb9696d1201035d962bf39f6105141.gif?wh=530%2A490)

## è¦ç‚¹æ€»ç»“

åœ¨è¿™ä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬åœ¨ä¸‰ç»´ç©ºé—´é‡Œï¼Œå¼•å…¥äº†ç›¸æœºå’Œè§†å›¾çŸ©é˜µçš„æ¦‚å¿µï¼Œç›¸æœºåˆ†ä¸ºé€è§†ç›¸æœºå’Œæ­£äº¤ç›¸æœºï¼Œå®ƒä»¬æœ‰ä¸åŒçš„æŠ•å½±æ–¹å¼ï¼Œå¹¶ä¸”è®¾ç½®å®ƒä»¬è¿˜å¯ä»¥æ”¹å˜å‰ªè£ç©ºé—´ã€‚è§†å›¾çŸ©é˜µå’Œå‰ä¸€èŠ‚è¯¾ä»‹ç»çš„æŠ•å½±çŸ©é˜µã€æ¨¡å‹çŸ©é˜µã€æ³•å‘é‡çŸ©é˜µä¸€èµ·ï¼Œæ„æˆäº†3Dç»˜å›¾æ ‡å‡†æ¨¡å‹ï¼Œè¿™æ˜¯ä¸€èˆ¬çš„å›¾å½¢åº“éµå¾ªçš„æ ‡å‡†ç»˜å›¾æ–¹å¼ã€‚

ä¸ºäº†å·©å›ºå­¦ä¹ åˆ°çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬ä½¿ç”¨OGLåº“æ¥å°è¯•ç»˜åˆ¶ä¸åŒçš„3Då‡ ä½•ä½“ï¼Œæˆ‘ä»¬ä¾æ¬¡ç”¨OGLç»˜åˆ¶äº†çƒä½“ã€ç«‹æ–¹ä½“ã€åœ†æŸ±ä½“å’Œç¯é¢ã€‚OGLç»˜åˆ¶å›¾å½¢çš„åŸºæœ¬æ­¥éª¤å¯ä»¥æ€»ç»“ä¸º7æ­¥ï¼Œå¦‚ä¸‹å›¾ï¼š

![](https://static001.geekbang.org/resource/image/5b/4c/5b2b4622f1bea87199788d20a2629b4c.jpg?wh=2253%2A693%3Fwh%3D2253%2A693)

## å°è¯•ç‰›åˆ€

1. åœ¨ä¸Šé¢çš„ä¾‹å­é‡Œï¼Œä½¿ç”¨OGLç»˜åˆ¶çš„çƒä½“çœ‹èµ·æ¥ä¸æ˜¯å¾ˆåœ†ï¼Œä½ å¯ä»¥ç ”ç©¶ä¸€ä¸‹[OGLçš„ä»£ç ](https://github.com/oframe/ogl)ï¼Œä¿®æ”¹ä¸€ä¸‹åˆ›å»ºçƒä½“çš„å‚æ•°ï¼Œè®©å®ƒçœ‹èµ·æ¥æ›´åœ†ã€‚
2. ä½ èƒ½è¯•ç€ä¿®æ”¹ä¸€ä¸‹ç‰‡å…ƒç€è‰²å™¨ï¼Œè®©ä¸Šé¢ç»˜åˆ¶çš„4ä¸ªå‡ ä½•ä½“å‘ˆç°ä¸åŒçš„é¢œè‰²å—ï¼Ÿå°†å®ƒä»¬åˆ†åˆ«æ”¹æˆçº¢è‰²ã€é»„è‰²ã€è“è‰²å’Œç»¿è‰²ã€‚

æ¬¢è¿åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œåˆ†äº«ä½ çš„ç­”æ¡ˆå’Œæ€è€ƒï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼

* * *

## æºç 

è¯¾ç¨‹ä¸­å®Œæ•´ç¤ºä¾‹ä»£ç è¯¦è§[GitHubä»“åº“](https://github.com/akira-cn/graphics/tree/master/3d-camera)

## æ¨èé˜…è¯»

[OGL](https://github.com/oframe/ogl)
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ1ï¼‰</strong></div><ul>
<li><span>ç½— ä¹¾ æ—</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç¬¬ä¸€é¢˜ï¼š

    const sphereGeometry = new Sphere(gl, {
      widthSegments: 160,
    });

ç¬¬äºŒé¢˜ï¼š
const fragment = &#47;* glsl *&#47; `
      precision highp float;
      varying vec3 vNormal;

      uniform vec3 uColor;

      void main() {
          vec3 normal = normalize(vNormal);
          float lighting = dot(normal, normalize(vec3(-0.3, 0.8, 0.6)));
          gl_FragColor.rgb = uColor + lighting * 0.1;
          gl_FragColor.a = 1.0;
      }
    `;
    function  createProgram(r,g,b){
      return new Program(gl,{
        vertex,
        fragment,
        uniforms:{
          uColor:{value:new Vec3(r,g,b)}
        }
      })
    }
    const program_red =createProgram(1.0,0,0);
    const program_green =createProgram(0,1.0,0);
    const program_blue = createProgram(0.0,0,1.0);
    const program_yellow =  createProgram(1.0,1.0,0);

    const torus = new Mesh(gl, {geometry: torusGeometry, program:program_red});
    torus.position.set(0, 1.3, 0);
    torus.setParent(scene);

    const sphere = new Mesh(gl, {geometry: sphereGeometry, program:program_green});
    sphere.position.set(1.3, 0, 0);
    sphere.setParent(scene);

    const cube = new Mesh(gl, {geometry: cubeGeometry, program:program_blue});
    cube.position.set(0, -1.3, 0);
    cube.setParent(scene);

    const cylinder = new Mesh(gl, {geometry: cylinderGeometry, program:program_yellow});
    cylinder.position.set(-1.3, 0, 0);
    cylinder.setParent(scene);

æœ›è€å¸ˆæŒ‡æ­£
</p>2020-08-11</li><br/>
</ul>