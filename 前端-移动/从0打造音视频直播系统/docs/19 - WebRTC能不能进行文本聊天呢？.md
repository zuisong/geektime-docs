WebRTCä¸ä½†å¯ä»¥è®©ä½ è¿›è¡ŒéŸ³è§†é¢‘é€šè¯ï¼Œè€Œä¸”è¿˜å¯ä»¥ç”¨å®ƒä¼ è¾“æ™®é€šçš„äºŒè¿›åˆ¶æ•°æ®ï¼Œæ¯”å¦‚è¯´å¯ä»¥åˆ©ç”¨å®ƒå®ç°æ–‡æœ¬èŠå¤©ã€æ–‡ä»¶çš„ä¼ è¾“ç­‰ç­‰ã€‚

WebRTCçš„**æ•°æ®é€šé“ï¼ˆRTCDataChannelï¼‰**æ˜¯ä¸“é—¨ç”¨æ¥ä¼ è¾“é™¤äº†éŸ³è§†é¢‘æ•°æ®ä¹‹å¤–çš„ä»»ä½•æ•°æ®ï¼Œæ‰€ä»¥å®ƒçš„åº”ç”¨éå¸¸å¹¿æ³›ï¼Œå¦‚å®æ—¶æ–‡å­—èŠå¤©ã€æ–‡ä»¶ä¼ è¾“ã€è¿œç¨‹æ¡Œé¢ã€æ¸¸æˆæ§åˆ¶ã€P2PåŠ é€Ÿç­‰éƒ½æ˜¯å®ƒçš„åº”ç”¨åœºæ™¯ã€‚

åƒæ–‡æœ¬èŠå¤©ã€æ–‡ä»¶ä¼ è¾“è¿™ç±»åº”ç”¨ï¼Œå¤§å¤šæ•°äººèƒ½æƒ³åˆ°çš„é€šå¸¸æ˜¯é€šè¿‡æœåŠ¡å™¨ä¸­è½¬æ•°æ®çš„æ–¹æ¡ˆï¼Œä½† WebRTC åˆ™ä¼˜å…ˆä½¿ç”¨çš„æ˜¯**P2Pæ–¹æ¡ˆï¼Œå³ä¸¤ç«¯ä¹‹é—´ç›´æ¥ä¼ è¾“æ•°æ®**ï¼Œè¿™æ ·å°±å¤§å¤§å‡è½»äº†æœåŠ¡å™¨çš„å‹åŠ›ã€‚å½“ç„¶WebRTCä¹Ÿå¯ä»¥é‡‡ç”¨ä¸­ç»§çš„æ–¹æ¡ˆï¼Œè¿™å°±éœ€è¦ä½ æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡éœ€è¦è¿›è¡Œé€‰æ‹©ï¼Œéå¸¸çµæ´»ã€‚

## RTCDataChannel ä»‹ç»

RTCDataChannel å°±æ˜¯ WebRTC ä¸­ä¸“é—¨ç”¨æ¥ä¼ è¾“ééŸ³è§†é¢‘æ•°æ®çš„ç±»ï¼Œå®ƒçš„è®¾è®¡æ¨¡ä»¿äº†WebSocket çš„å®ç°ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œå…³äºè¿™ä¸€ç‚¹æˆ‘å°†åœ¨ä¸‹é¢çš„â€œRTCDataChannel çš„äº‹ä»¶â€ éƒ¨åˆ†å‘ä½ åšæ›´è¯¦ç»†çš„ä»‹ç»ã€‚

å¦å¤–ï¼ŒRTCDataChannel æ”¯æŒçš„æ•°æ®ç±»å‹ä¹Ÿéå¸¸å¤šï¼ŒåŒ…æ‹¬ï¼šå­—ç¬¦ä¸²ã€Blobã€ArrayBuffer ä»¥åŠ ArrayBufferViewã€‚

å®é™…ä¸Šï¼Œå…³äºè¿™å‡ ç§ç±»å‹çš„è”ç³»ä¸åŒºåˆ«æˆ‘åœ¨å‰é¢[ã€Š04 | å¯ä»¥æŠŠé‡‡é›†åˆ°çš„éŸ³è§†é¢‘æ•°æ®å½•åˆ¶ä¸‹æ¥å—ï¼Ÿã€‹](https://time.geekbang.org/column/article/109105)ä¸€æ–‡ä¸­å·²ç»å‘ä½ åšè¿‡è¯¦ç»†çš„ä»‹ç»ï¼Œå¦‚æœä½ ç°åœ¨è®°ä¸æ¸…äº†ï¼Œå¯ä»¥å†å»å›é¡¾ä¸€ä¸‹ã€‚

WebRTC çš„ RTCDataChannel ä½¿ç”¨çš„ä¼ è¾“åè®®ä¸º SCTPï¼Œå³ Stream Control Transport Protocolã€‚ä¸‹é¢å›¾è¡¨è¡¨ç¤ºçš„å°±æ˜¯åœ¨ TCPã€UDP åŠ SCTPç­‰ä¸åŒä¼ è¾“æ¨¡å¼ä¸‹ï¼Œæ•°æ®ä¼ è¾“çš„å¯é æ€§ã€ä¼ é€’æ–¹å¼ã€æµæ§ç­‰ä¿¡æ¯çš„å¯¹æ¯”ï¼š

![](https://static001.geekbang.org/resource/image/33/83/33b5d2000a04b0a49b85f8b676727b83.png?wh=1142%2A534)

RTCDataChannel æ—¢å¯ä»¥åœ¨å¯é çš„ã€æœ‰åºçš„æ¨¡å¼ä¸‹å·¥ä½œï¼Œä¹Ÿå¯åœ¨ä¸å¯é çš„ã€æ— åºçš„æ¨¡å¼ä¸‹å·¥ä½œï¼Œå…·ä½“ä½¿ç”¨å“ªç§æ¨¡å¼å¯ä»¥æ ¹æ®ç”¨æˆ·çš„é…ç½®æ¥å†³å®šã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«ã€‚

- **å¯é æœ‰åºæ¨¡å¼ï¼ˆTCP æ¨¡å¼ï¼‰**ï¼šåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯å¯ä»¥æœ‰åºåˆ°è¾¾ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†é¢å¤–çš„å¼€é”€ï¼Œæ‰€ä»¥åœ¨è¿™ç§æ¨¡å¼ä¸‹**æ¶ˆæ¯ä¼ è¾“ä¼šæ¯”è¾ƒæ…¢**ã€‚
- **ä¸å¯é æ— åºæ¨¡å¼ï¼ˆUDP æ¨¡å¼ï¼‰**ï¼šåœ¨æ­¤ç§æ¨¡å¼ä¸‹ï¼Œä¸ä¿è¯æ¶ˆæ¯å¯è¾¾ï¼Œä¹Ÿä¸ä¿è¯æ¶ˆæ¯æœ‰åºï¼Œä½†åœ¨è¿™ç§æ¨¡å¼ä¸‹æ²¡æœ‰ä»€ä¹ˆé¢å¤–å¼€é”€ï¼Œæ‰€ä»¥å®ƒ**éå¸¸å¿«**ã€‚
- **éƒ¨åˆ†å¯é æ¨¡å¼ï¼ˆSCTP æ¨¡å¼ï¼‰**ï¼šåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯çš„å¯è¾¾æ€§å’Œæœ‰åºæ€§å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿›è¡Œé…ç½®ã€‚

é‚£æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹åˆ°åº•è¯¥å¦‚ä½•é…ç½® RTCDataChannle å¯¹è±¡å§ã€‚

## é…ç½® RTCDataChannel

åœ¨åˆ›å»º RTCDataChannel å¯¹è±¡ä¹‹å‰ï¼Œé¦–å…ˆè¦åˆ›å»º RTCPeerConnection å¯¹è±¡ï¼Œå› ä¸º **RTCDataChannel å¯¹è±¡æ˜¯ç”± RTCPeerConnection å¯¹è±¡ç”Ÿæˆçš„**ã€‚æœ‰äº† RTCPeerConnection å¯¹è±¡åï¼Œè°ƒç”¨å®ƒçš„ createDataChannel æ–¹æ³•ï¼Œå°±å¯ä»¥å°† RTCDataChannel åˆ›å»ºå‡ºæ¥äº†ã€‚å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š

```
...
var pc = new RTCPeerConnection(); //åˆ›å»º RTCPeerConnection å¯¹è±¡
var dc = pc.createDataChannel("dc", options); //åˆ›å»º RTCDataChannelå¯¹è±¡
...
```

ä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ° RTCDataChannel å¯¹è±¡æ˜¯ç”± RTCPeerConnection å¯¹è±¡åˆ›å»ºçš„ï¼Œåœ¨åˆ›å»º RTCDataChannel å¯¹è±¡æ—¶æœ‰ä¸¤ä¸ªå‚æ•°ã€‚

- ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ ‡ç­¾ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œç›¸å½“äºç»™ RTCDataChannel èµ·äº†ä¸€ä¸ªåå­—ï¼›
- ç¬¬äºŒä¸ªå‚æ•°æ˜¯ optionsï¼Œå…¶å½¢å¼å¦‚ä¸‹ï¼š

```
var options = {
	ordered: false,
	maxPacketLifeTime: 3000
};
```

å…¶å®**options**å¯ä»¥æŒ‡å®šå¾ˆå¤šé€‰é¡¹ï¼Œæ¯”å¦‚åƒä¸Šé¢æ‰€è®¾ç½®çš„ï¼ŒæŒ‡å®šäº†åˆ›å»ºçš„ RTCDataChannel æ˜¯å¦æ˜¯æœ‰åºçš„ï¼Œä»¥åŠæœ€å¤§çš„å­˜æ´»æ—¶é—´ã€‚

ä¸‹é¢æˆ‘å°±å‘ä½ è¯¦ç»†ä»‹ç»ä¸€ä¸‹ options æ‰€æ”¯æŒçš„é€‰é¡¹ã€‚

- **ordered**ï¼šæ¶ˆæ¯çš„ä¼ é€’æ˜¯å¦æœ‰åºã€‚
- **maxPacketLifeTime**ï¼šé‡ä¼ æ¶ˆæ¯å¤±è´¥çš„æœ€é•¿æ—¶é—´ã€‚ä¹Ÿå°±æ˜¯è¯´è¶…è¿‡è¿™ä¸ªæ—¶é—´åï¼Œå³ä½¿æ¶ˆæ¯é‡ä¼ å¤±è´¥äº†ä¹Ÿä¸å†è¿›è¡Œé‡ä¼ äº†ã€‚
- **maxRetransmits**ï¼šé‡ä¼ æ¶ˆæ¯å¤±è´¥çš„æœ€å¤§æ¬¡æ•°ã€‚
- **protocol**ï¼šç”¨æˆ·è‡ªå®šä¹‰çš„å­åè®®ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥æ ¹æ®ç”¨æˆ·è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚è€Œå®šä¹‰çš„ç§æœ‰åè®®ï¼Œé»˜è®¤ä¸ºç©ºã€‚
- **negotiated**ï¼šå¦‚æœä¸ºtrueï¼Œåˆ™ä¼šåˆ é™¤å¦ä¸€æ–¹æ•°æ®é€šé“çš„è‡ªåŠ¨è®¾ç½®ã€‚è¿™ä¹Ÿæ„å‘³ç€ä½ å¯ä»¥é€šè¿‡è‡ªå·±çš„æ–¹å¼åœ¨å¦ä¸€ä¾§åˆ›å»ºå…·æœ‰ç›¸åŒIDçš„æ•°æ®é€šé“ã€‚
- **id**ï¼šå½“negotiatedä¸ºtrueæ—¶ï¼Œå…è®¸ä½ æä¾›è‡ªå·±çš„IDä¸channelè¿›è¡Œç»‘å®šã€‚

åœ¨ä¸Šé¢çš„é€‰é¡¹ä¸­ï¼Œå‰ä¸‰é¡¹æ˜¯ç»å¸¸ä½¿ç”¨çš„ï¼Œä¹Ÿæ˜¯ä½ è¦é‡ç‚¹ææ¸…æ¥šçš„ã€‚ä¸è¿‡éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œ **maxRetransmits ä¸ maxPacketLifeTime æ˜¯äº’æ–¥çš„**ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸¤è€…ä¸èƒ½åŒæ—¶å­˜åœ¨ï¼Œåªèƒ½äºŒé€‰ä¸€ã€‚

## RTCDataChannel çš„äº‹ä»¶

RTCDataChannel çš„äº‹ä»¶å¤„ç†ä¸ WebSocket çš„äº‹ä»¶å¤„ç†éå¸¸ç›¸ä¼¼ï¼ŒRTCDataChannel åœ¨æ‰“å¼€ã€å…³é—­ã€æ¥æ”¶åˆ°æ¶ˆæ¯ä»¥åŠå‡ºé”™æ—¶éƒ½ä¼šæœ‰æ¥æ”¶åˆ°äº‹ä»¶ã€‚

è€Œå½“ä½ åœ¨ä½¿ç”¨ RTCDataChannel æ—¶ï¼Œå¯¹ä¸Šé¢æ‰€æè¿°çš„è¿™äº›äº‹ä»¶éƒ½è¦è¿›è¡Œå¤„ç†ï¼Œæ‰€ä»¥å°±å½¢æˆäº†ä¸‹é¢è¿™æ ·çš„ä»£ç æ¨¡æ¿ï¼š

```
...
dc.onerror = (error)=> { //å‡ºé”™
	...
};

dc.onopen = ()=> {//æ‰“å¼€
	...
};

dc.onclose = () => {//å…³é—­
	...
};

dc.onmessage = (event)=>{//æ”¶åˆ°æ¶ˆæ¯
	...
};
...
```

æ‰€ä»¥åœ¨ä½¿ç”¨ RTCDataChannel å¯¹è±¡æ—¶ï¼Œä½ åªè¦æŒ‰ä¸Šé¢çš„æ¨¡æ¿é€ä¸€å®ç°å…¶é€»è¾‘å°±å¥½äº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿ

## å®æ—¶æ–‡å­—èŠå¤©

æœ‰äº†ä¸Šé¢çš„çŸ¥è¯†ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥**çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œçœ‹çœ‹å¦‚ä½•é€šè¿‡ RTCDataChannel å¯¹è±¡å®ç°ä¸€ä¸ªå®æ—¶æ–‡å­—èŠå¤©åº”ç”¨**ã€‚

ä½ å¯ä»¥æƒ³åƒè¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œåœ¨ä¸¤å°ä¸åŒçš„ PC ä¸Šï¼ˆä¸€ä¸ªç§°ä¸º Aï¼Œå¦ä¸€ä¸ªç§°ä¸ºBï¼‰ï¼Œç”¨æˆ·æ‰“å¼€æµè§ˆå™¨ï¼Œåœ¨é¡µé¢ä¸Šæ˜¾ç¤ºä¸¤ä¸ªtextareaï¼Œä¸€ä¸ªä½œä¸ºæ–‡æœ¬è¾“å…¥æ¡†ï¼Œå¦ä¸€ä¸ªä½œä¸ºèŠå¤©è®°å½•çš„æ˜¾ç¤ºæ¡†ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://static001.geekbang.org/resource/image/de/f6/de14364397f293a96695e5f2677650f6.png?wh=1142%2A1056)

æ–‡æœ¬èŠå¤©å›¾

å½“Aå‘Bå‘æ¶ˆæ¯æ—¶ï¼ŒJavaScriptä¼šä»è¾“å…¥æ¡†ä¸­æå–æ–‡æœ¬ï¼Œç„¶åé€šè¿‡RTCDataChannelå‘é€å‡ºå»ã€‚å®é™…ä¸Šï¼Œæ–‡æœ¬é€šè¿‡ RTCDataChannel å‘é€å‡ºå»åï¼Œæœ€ç»ˆæ˜¯ç»è¿‡ RTCPeerConnection ä¼ é€å‡ºå»çš„ã€‚åŒç†ï¼ŒBå‘Aå‘é€æ–‡æœ¬æ•°æ®æ—¶ä¹Ÿæ˜¯åŒæ ·çš„æµç¨‹ã€‚å¦ä¸€æ–¹é¢ï¼Œå½“Bæ”¶åˆ°Aå‘é€è¿‡æ¥çš„æ–‡æœ¬æ•°æ®åï¼Œä¹Ÿè¦é€šè¿‡RTCDataChannelå¯¹è±¡æ¥æ¥æ”¶æ–‡æœ¬æ•°æ®ã€‚

å¯¹äº RTCDataChannel å¯¹è±¡çš„åˆ›å»ºä¸»è¦æœ‰**In-bandåå•†å’ŒOut-of-bandåå•†**ä¸¤ç§æ–¹å¼ã€‚

### 1. In-band åå•†æ–¹å¼

æ­¤æ–¹å¼æ˜¯é»˜è®¤æ–¹å¼ã€‚é‚£ä»€ä¹ˆæ˜¯ In-band åå•†æ–¹å¼å‘¢ï¼Ÿå‡è®¾é€šä¿¡åŒæ–¹ä¸­çš„ä¸€æ–¹è°ƒç”¨ **createDataChannel** åˆ›å»º RTCDataChannel å¯¹è±¡æ—¶ï¼Œå°† options å‚æ•°ä¸­çš„ **negotiated** å­—æ®µè®¾ç½®ä¸ºfalseï¼Œåˆ™é€šä¿¡çš„å¦ä¸€æ–¹å°±å¯ä»¥é€šè¿‡å®ƒçš„ RTCPeerConnection å¯¹è±¡çš„ **ondatachannel** äº‹ä»¶æ¥å¾—åˆ°ä¸å¯¹æ–¹é€šä¿¡çš„ RTCDataChannel å¯¹è±¡äº†ï¼Œè¿™ç§æ–¹å¼å°±æ˜¯ In-band åå•†æ–¹å¼ã€‚

é‚£In-band åå•†æ–¹å¼åˆ°åº•æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬å°±æ¥è¯¦ç»†æè¿°ä¸€ä¸‹ã€‚

- Aç«¯è°ƒç”¨ createDataChannel åˆ›å»º RTCDataChannel å¯¹è±¡ã€‚
- Aç«¯ä¸Bç«¯äº¤æ¢ SDPï¼Œå³è¿›è¡Œåª’ä½“åå•†ï¼ˆoffer/answerï¼‰ã€‚
- åª’ä½“åå•†å®Œæˆä¹‹åï¼ŒåŒæ–¹è¿æ¥å°±å»ºç«‹æˆåŠŸäº†ã€‚æ­¤æ—¶ï¼ŒAç«¯å°±å¯ä»¥å‘Bç«¯å‘é€æ¶ˆæ¯äº†ã€‚
- å½“Bç«¯æ”¶åˆ°Aç«¯å‘çš„æ¶ˆæ¯åï¼ŒBç«¯çš„ ondatachannel äº‹ä»¶è¢«è§¦å‘ï¼ŒBç«¯çš„å¤„ç†ç¨‹åºå°±å¯ä»¥ä»è¯¥äº‹ä»¶çš„å‚æ•°ä¸­è·å¾—ä¸Aç«¯é€šä¿¡çš„ RTCDataChannel å¯¹è±¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥å¯¹è±¡ä¸Aç«¯åˆ›å»ºçš„ RTCDataChannel å…·æœ‰ç›¸åŒçš„å±æ€§ã€‚
- æ­¤æ—¶åŒæ–¹çš„ RTCDataChannel å¯¹è±¡å°±å¯ä»¥è¿›è¡ŒåŒå‘é€šä¿¡äº†ã€‚

è¯¥æ–¹æ³•çš„**ä¼˜åŠ¿æ˜¯ RTCDataChannel å¯¹è±¡å¯ä»¥åœ¨éœ€è¦æ—¶è‡ªåŠ¨åˆ›å»ºï¼Œä¸éœ€è¦åº”ç”¨ç¨‹åºåšé¢å¤–çš„é€»è¾‘å¤„ç†**ã€‚

### 2. Out-of-band åå•†æ–¹å¼

RTCDataChannel å¯¹è±¡è¿˜èƒ½ä½¿ç”¨ Out-of-band åå•†æ–¹å¼åˆ›å»ºï¼Œè¿™ç§æ–¹å¼ä¸å†æ˜¯ä¸€ç«¯è°ƒç”¨ createDataChannelï¼Œå¦ä¸€ç«¯ç›‘å¬ ondatachannel äº‹ä»¶ï¼Œä»è€Œå®ç°åŒæ–¹çš„æ•°æ®é€šä¿¡ï¼›è€Œæ˜¯ä¸¤ç«¯éƒ½è°ƒç”¨ createDataChannel æ–¹æ³•åˆ›å»º RTCDataChannel å¯¹è±¡ï¼Œå†é€šè¿‡ ID ç»‘å®šæ¥å®ç°åŒæ–¹çš„æ•°æ®é€šä¿¡ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

- Aç«¯è°ƒç”¨ createDataChannel({negotiated: true, id: 0}) æ–¹æ³•ï¼›
- Bä¹Ÿè°ƒç”¨ createDataChannel({negotiated: true, id: 0}) æ–¹æ³•ï¼›
- åŒæ–¹äº¤æ¢ SDPï¼Œ å³è¿›è¡Œåª’ä½“åå•†ï¼ˆ offer/answerï¼‰ï¼›
- ä¸€æ—¦åŒæ–¹è¿æ¥å»ºç«‹èµ·æ¥ï¼Œæ•°æ®é€šé“å¯ä»¥è¢«ç«‹å³ä½¿ç”¨ï¼Œå®ƒä»¬æ˜¯é€šè¿‡ ID è¿›è¡ŒåŒ¹é…çš„ï¼ˆè¿™é‡Œçš„IDå°±æ˜¯ä¸Šé¢ options ä¸­æŒ‡å®šçš„IDï¼ŒID å·å¿…é¡»ä¸€è‡´ï¼‰ã€‚

è¿™ç§æ–¹æ³•çš„ä¼˜åŠ¿æ˜¯ï¼ŒBç«¯ä¸éœ€ç­‰å¾…æœ‰æ¶ˆæ¯å‘é€æ¥å†åˆ›å»ºRTCDataChannelå¯¹è±¡ï¼Œæ‰€ä»¥åŒæ–¹å‘é€æ•°æ®æ—¶ä¸ç”¨è€ƒè™‘é¡ºåºé—®é¢˜ï¼Œå³è°éƒ½å¯ä»¥å…ˆå‘æ•°æ®ï¼Œè¿™æ˜¯ä¸In-bandæ–¹å¼çš„æœ€å¤§ä¸åŒï¼Œè¿™ä¹Ÿ**ä½¿å¾—åº”ç”¨ä»£ç å˜å¾—ç®€å•**ï¼Œå› ä¸ºä½ ä¸éœ€è¦å¤„ç† ondatachannel äº‹ä»¶äº†ã€‚

å¦å¤–ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½ é€‰çš„ ID ä¸èƒ½æ˜¯ä»»æ„å€¼ã€‚IDå€¼æ˜¯ä»0å¼€å§‹è®¡æ•°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ ç¬¬ä¸€æ¬¡åˆ›å»ºçš„ RTCDataChannel å¯¹è±¡çš„ ID æ˜¯0ï¼Œç¬¬äºŒä¸ªæ˜¯ 1ï¼Œä¾æ¬¡ç±»æ¨ã€‚æ‰€ä»¥è¿™äº›IDåªèƒ½ä¸WebRTCå®ç°åå•†çš„SCTPæµæ•°é‡ä¸€æ ·ï¼Œå¦‚æœä½ ä½¿ç”¨çš„ ID å¤ªå¤§äº†ï¼Œè€Œåˆæ²¡æœ‰é‚£ä¹ˆå¤šçš„ SCTP æµçš„è¯ï¼Œé‚£ä¹ˆä½ çš„æ•°æ®é€šé“å°±ä¸èƒ½æ­£å¸¸å·¥ä½œäº†ã€‚

## å…·ä½“ä¾‹å­

äº†è§£å®Œç›¸å…³ç†è®ºåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å®è·µèµ·æ¥ï¼Œç»“åˆå…·ä½“ä¾‹å­å°†è¿™äº›ç†è®ºåº”ç”¨èµ·æ¥ã€‚

åœ¨æœ¬æ–‡çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ In-band åå•†æ–¹å¼æ¥åˆ›å»º RTCDataChannel å¯¹è±¡ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥ä¸€æ­¥ä¸€æ­¥æ“ä½œï¼Œçœ‹çœ‹ä¸€ä¸ªæ–‡æœ¬èŠå¤©åº”ç”¨æ˜¯å¦‚ä½•å®ç°çš„ã€‚

### 1. æ·»åŠ äº‹ä»¶

ä¸ºé¡µé¢ä¸Šçš„æ¯ä¸ªæŒ‰é’®æ·»åŠ  **onclick äº‹ä»¶**ï¼Œå…·ä½“å¦‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ‰€ç¤ºï¼š

```
  var startButton = document.querySelector('button#startButton');
  var callButton = document.querySelector('button#callButton');
  var sendButton = document.querySelector('button#sendButton');
  var closeButton = document.querySelector('button#closeButton');

  startButton.onclick = connectServer; //createConnection;
  callButton.onclick = call;
  sendButton.onclick = sendData;
  closeButton.onclick = closeDataChannels;
```

åœ¨è¿™ä¸ªæ®µä»£ç ä¸­å®šä¹‰äº† 4 ä¸ª buttonï¼Œå…¶ä¸­ Start æŒ‰é’®ç”¨äºä¸ä¿¡ä»¤æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼›Call ç”¨äºåˆ›å»º RTCDataChannel å¯¹è±¡ï¼›Send ç”¨äºå‘é€æ–‡æœ¬æ•°æ®ï¼›Closeç”¨äºå…³é—­è¿æ¥é‡Šæ”¾èµ„æºã€‚

### 2. åˆ›å»ºè¿æ¥

ç”¨æˆ·åœ¨é¡µé¢ä¸Šç‚¹å‡» **Start** æŒ‰é’®æ—¶ï¼Œä¼šè°ƒç”¨ **connectServer** æ–¹æ³•ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```
  function connectServer(){
  
    socket = io.connect();  //ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥
	 
	 ...

	 socket.on('created', function(room) { //ç¬¬ä¸€ä¸ªç”¨æˆ·åŠ å…¥åæ”¶åˆ°çš„æ¶ˆæ¯
	   createConnection();
	 });
    
	 socket.on('joined', function(room) { //ç¬¬äºŒä¸ªç”¨æˆ·åŠ å…¥åæ”¶åˆ°çš„æ¶ˆæ¯
	   createConnection();
	 });

	 ...
  }
```

ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒconnectServer å‡½æ•°é¦–å…ˆè°ƒç”¨ `io.connect()` è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨ï¼Œç„¶åå†æ ¹æ®ä¿¡ä»¤æœåŠ¡å™¨ä¸‹å‘çš„æ¶ˆæ¯åšä¸åŒçš„å¤„ç†ã€‚

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æœ¬ä¾‹ä¸­æˆ‘ä»¬ä½¿ç”¨äº† socket.io åº“ä¸ä¿¡ä»¤æœåŠ¡å™¨å»ºç«‹è¿æ¥ã€‚

å¦‚æœæ¶ˆæ¯æ˜¯ **created** æˆ– **joined**ï¼Œåˆ™è°ƒç”¨ createConnection åˆ›å»º RTCPeerConnectionã€‚å…¶ä»£ç å¦‚ä¸‹ï¼š

```
  var servers = {'iceServers': [{
	      'urls': 'turn:youdomain:3478',
	      'credential': "passwd",
	      'username': "username"
	    }]
  };
 
  pc = new RTCPeerConnection(servers, pcConstraint);
  pc.onicecandidate = handleIceCandidate; //æ”¶é›†å€™é€‰è€…
  pc.ondatachannel = onDataChannelAdded;  //å½“å¯¹æ¥åˆ›å»ºæ•°æ®é€šé“æ—¶ä¼šå›è°ƒè¯¥æ–¹æ³•ã€‚
```

é€šè¿‡ä¸Šé¢çš„ä»£ç å°±å°† RTCPeerConnectionå¯¹è±¡åˆ›å»ºå¥½äº†ã€‚

### 3. åˆ›å»º RTCDataChannel

å½“ç”¨æˆ·ç‚¹å‡» Call æŒ‰é’®æ—¶ï¼Œä¼šåˆ›å»ºRTCDataChannelï¼Œå¹¶å‘é€ offerã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```
  dc = pc.createDataChannel('sendDataChannel',
	    dataConstraint); //ä¸€ç«¯ä¸»åŠ¨åˆ›å»º RTCDataChannel
  
  ...
  dc.onmessage = receivedMessage; //å½“æœ‰æ–‡æœ¬æ•°æ®æ¥æ—¶ï¼Œå›è°ƒè¯¥å‡½æ•°ã€‚
	 
  pc.createOffer(setLocalAndSendMessage,
        onCreateSessionDescriptionError); //åˆ›å»ºofferï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™åœ¨ setLocalAndSendMessage å‡½æ•°ä¸­å°† SDP å‘é€ç»™è¿œç«¯
```

å½“å…¶ä¸­ä¸€æ–¹åˆ›å»ºäº† RTCDataChannel ä¸”é€šä¿¡åŒæ–¹å®Œæˆäº†åª’ä½“åå•†ã€äº¤æ¢äº† SDP ä¹‹åï¼Œå¦ä¸€ç«¯æ”¶åˆ°å‘é€ç«¯çš„æ¶ˆæ¯ï¼Œondatachannel äº‹ä»¶å°±ä¼šè¢«è§¦å‘ã€‚æ­¤æ—¶å°±ä¼šè°ƒç”¨å®ƒçš„å›è°ƒå‡½æ•°onDataChannelAdded ï¼Œé€šè¿‡ onDataChannelAdded å‡½æ•°çš„å‚æ•° event ä½ å°±å¯ä»¥è·å–åˆ°å¦ä¸€ç«¯çš„ RTCDataChannel å¯¹è±¡äº†ã€‚å…·ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š

```
  function onDataChannelAdded(event) {
      dc = event.channel;
      dc.onmessage = receivedMessage;
      ...
  }
```

è‡³æ­¤ï¼ŒåŒæ–¹å°±å¯ä»¥é€šè¿‡ RTCDataChannel å¯¹è±¡è¿›è¡ŒåŒå‘é€šä¿¡äº†ã€‚

### 4. æ•°æ®çš„å‘é€ä¸æ¥æ”¶

æ•°æ®çš„å‘é€éå¸¸ç®€å•ï¼Œå½“ç”¨æˆ·ç‚¹å‡» Send æŒ‰é’®åï¼Œæ–‡æœ¬æ•°æ®å°±ä¼šé€šè¿‡ RTCDataChannel ä¼ è¾“åˆ°è¿œç«¯ã€‚å…¶ä»£ç å¦‚ä¸‹ï¼š

```
  function sendData() {
      var data = dataChannelSend.value;
      dc.send(data);
  }
```

è€Œå¯¹äºæ¥æ”¶æ•°æ®ï¼Œåˆ™æ˜¯é€šè¿‡ RTCDataChannel çš„ onmessage äº‹ä»¶å®ç°çš„ã€‚å½“è¯¥äº‹ä»¶è§¦å‘åï¼Œä¼šè°ƒç”¨ receivedMessage æ–¹æ³•ã€‚é€šè¿‡å…¶å‚æ•°å°±å¯ä»¥è·å–åˆ°å¯¹ç«¯å‘é€çš„æ–‡æœ¬æ•°æ®äº†ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```
  function receivedMessage(e) {
      var msg = e.data;
      if (msg) {
          dataChannelReceive.value += "<- " + msg + "\n";
      } 
  };
```

ä»¥ä¸Šå°±æ˜¯æ–‡æœ¬èŠå¤©çš„å¤§ä½“é€»è¾‘ã€‚å…·ä½“çš„ä»£ç ä½ å¯ä»¥åˆ°ï¼ˆæ–‡æœ«çš„ï¼‰[GitHubé“¾æ¥](https://github.com/avdance/webrtc_web/tree/master/19_chat/)ä¸Šè·å–ã€‚

## å°ç»“

æœ¬æ–‡æˆ‘ä»¬ç»“åˆå…·ä½“çš„ä¾‹å­â€”â€”å®æ—¶æ–‡å­—èŠå¤©ï¼Œå‘ä½ è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ RTCDataChannel è¿›è¡ŒééŸ³è§†é¢‘æ•°æ®çš„ä¼ è¾“ã€‚

RTCDataChannelçš„åˆ›å»ºæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯é»˜è®¤çš„In-bandåå•†æ–¹å¼ï¼Œå¦ä¸€ç§æ˜¯Out-of-bandåå•†æ–¹å¼ã€‚åœ¨æœ¬æ–‡ä¾‹å­çš„å®è·µéƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¸»è¦åº”ç”¨çš„æ˜¯ç¬¬ä¸€ç§æ–¹å¼ã€‚ä½†ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘æ›´æ¨èä½¿ç”¨ç¬¬äºŒç§æ–¹å¼ï¼Œå› ä¸ºå®ƒæ›´é«˜æ•ˆã€æ›´ç®€æ´ã€‚

å¦å¤–ï¼Œåœ¨ä½¿ç”¨ RTCDataChannel æ—¶ï¼Œè¿˜æœ‰ä¸¤ç‚¹ä½ éœ€è¦æ³¨æ„ï¼š

1. RTCDataChannelå¯¹è±¡çš„åˆ›å»ºè¦åœ¨åª’ä½“åå•†ï¼ˆoffer/answerï¼‰ ä¹‹å‰åˆ›å»ºï¼Œå¦åˆ™ WebRTC å°±ä¼šä¸€ç›´å¤„äº connecting çŠ¶æ€ï¼Œä»è€Œå¯¼è‡´æ•°æ®æ— æ³•è¿›è¡Œä¼ è¾“ã€‚
2. RTCDataChannelå¯¹è±¡æ˜¯å¯ä»¥åŒå‘ä¼ è¾“æ•°æ®çš„ï¼Œæ‰€ä»¥æ¥æ”¶ä¸å‘é€ä½¿ç”¨ä¸€ä¸ª RTCDataChannelå¯¹è±¡å³å¯ï¼Œè€Œä¸éœ€è¦ä¸ºå‘é€å’Œæ¥æ”¶å•ç‹¬åˆ›å»º RTCDataChannel å¯¹è±¡ã€‚

å½“ç„¶æœ¬æ–‡åªæ˜¯ä»‹ç»äº†RTCDataChannelçš„â€œä¸€ç§â€å…·ä½“åº”ç”¨ï¼Œè‹¥ä½ æœ‰å…´è¶£è¿˜å¯ä»¥è‡ªè¡Œå®è·µå…¶ä»–æ›´æœ‰è¶£çš„å®ç°ã€‚

## æ€è€ƒæ—¶é—´

ä»Šå¤©ç•™ç»™ä½ çš„æ€è€ƒé¢˜æ˜¯ï¼šSCTP åè®®æ˜¯è¿è¡Œåœ¨ TCP åè®®ä¹‹ä¸Šè¿˜æ˜¯ UDP åè®®ä¹‹ä¸Šå‘¢ï¼Ÿ

æ¬¢è¿åœ¨ç•™è¨€åŒºä¸æˆ‘åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè®°å½•ä½ çš„æ€è€ƒè¿‡ç¨‹ã€‚æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚

## å‚è€ƒ

å…·ä½“ä»£ç åœ°å€ï¼š[https://github.com/avdance/webrtc\_web/tree/master/19\_chat/](https://github.com/avdance/webrtc_web/tree/master/19_chat/)
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ12ï¼‰</strong></div><ul>
<li><span>Geek_c1c44a</span> ğŸ‘ï¼ˆ7ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆæ‚¨å¥½ï¼Œè¯·é—®zoomå’Œç›´æ’­æŠ€æœ¯ç›¸å…³å—ï¼Ÿzoomå¯èƒ½ä½¿ç”¨ä»€ä¹ˆåè®®å‘¢ï¼Ÿ</p>2019-08-27</li><br/><li><span>è®¸ç«¥ç«¥</span> ğŸ‘ï¼ˆ6ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>SCTP åè®®åŸºäºUDPï¼Œè‡ªè¡Œå®ç°TCPç›¸å…³çš„åŠŸèƒ½ã€‚</p>2019-08-27</li><br/><li><span>John</span> ğŸ‘ï¼ˆ5ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è¿™ä¸ªé—®é¢˜å¥½åƒåº”è¯¥é—®åœ¨è¿™ä¸ªç« èŠ‚: å¦‚æœåšç™¾äººç¾¤èŠçš„åŠŸèƒ½ ä¸ç”¨ä¸­é—´æœåŠ¡å™¨ åªç”¨webrtcæŠ€æœ¯å’Œpeerconnection å¤§å®¶è§‰å¾—æ™®é€šå¸¦å®½å’Œæ‰‹æœºèƒ½å¤Ÿæ‰¿è½½ä¹ˆ</p>2019-11-16</li><br/><li><span>ä¸‰è§’å½¢å°äºé›¶</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>&quot;æ–‡æœ¬é€šè¿‡ RTCDataChannel å‘é€å‡ºå»åï¼Œæœ€ç»ˆæ˜¯ç»è¿‡ RTCPeerConnection ä¼ é€å‡ºå»çš„&quot; 
ä¹‹å‰æåˆ°è¿‡ RTCPeerConnection å¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ªåŠŸèƒ½è¶…å¼ºçš„ socketï¼Œé‚£ä¹ˆ DataChannel çš„ SCTP ä¹Ÿæ˜¯ä½¿ç”¨è¿™ä¸ªè¶…å¼ºçš„ socket æ¥å®ç°çš„å—ï¼Ÿ 

å¦‚æœéœ€è¦ relayï¼Œé‚£ä¹ˆ turn server ä¹Ÿä¼šè´Ÿè´£å¸®å¿™ relay é€šä¿¡åŒæ–¹å¾€ DataChannel é‡Œå‘çš„æ•°æ®å—ï¼Ÿ </p>2020-11-22</li><br/><li><span>å®‡å®™ä¹‹ç‹</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>çœ‹åˆ°æ‚¨GitHubä¾‹å­é‡Œé¢19_chatç”¨äº†var pcConfig = {
  &#39;iceServers&#39;: [{
    &#39;urls&#39;: &#39;turn:stun.al.learningrtc.cn:3478&#39;,
    &#39;credential&#39;: &quot;mypasswd&quot;,
    &#39;username&#39;: &quot;garrylea&quot;
  }]
};
è¿™æ®µæ˜¯ä¸æ˜¯æ²¡ç”¨ï¼Œå¥½åƒæ˜¯æ‚¨è‡ªå·±çš„æœåŠ¡å™¨ï¼Œæˆ‘æŠŠå®ƒèµ‹å€¼ç©ºvar pcConfig=null;ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚å¦å¤–å½“å¼€ä¸¤ä¸ªçª—å£çš„æ—¶å€™ï¼Œæœ‰æ—¶ä¼šæ‰çº¿ä¸€ä¸ªï¼Œå†è¿æ¥æœåŠ¡å™¨èƒ½è¿ä¸Šï¼Œä½†æ˜¯å‘é€æ¡†å°±è€æ˜¯ç°çš„äº†ï¼Œå°±è¦ä¸¤ä¸ªéƒ½æ–­æ‰é‡æ–°å†è”äº†ï¼Œè¿™ä¸€èˆ¬æ˜¯ä»€ä¹ˆåŸå› ï¼Œè°¢è°¢è€å¸ˆï¼
</p>2020-09-19</li><br/><li><span>å³°</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œä¸€ä¸ªé¢˜å¤–è¯ï¼Œè¿™ä¹ˆå¤šå¯ä½œåç«¯çš„è¯­è¨€ï¼Œc++ã€pythonã€goã€javaã€c#è¯¥å¦‚ä½•é€‰æ‹©äº†ï¼Ÿ</p>2019-08-28</li><br/><li><span>æœ¨æœ¨</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>SCTPæ˜¯è¿è¡Œåœ¨UDPä¸Šçš„ï¼Œæœ¬è´¨ä¸Šæ˜¯å¯¹UDPçš„å°è£…ï¼Œåœ¨åº”ç”¨å±‚å®ç°äº†æœ‰åºæ€§ä¸å¯é æ€§çš„é…ç½®ã€‚</p>2019-08-27</li><br/><li><span>Bubbly</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>var options = {
	key : fs.readFileSync(&#39;.&#47;cert&#47;1557605_www.learningrtc.cn.key&#39;),
	cert: fs.readFileSync(&#39;.&#47;cert&#47;1557605_www.learningrtc.cn.pem&#39;)
}
è€å¸ˆï¼Œè¿™é‡Œçš„keyå’Œpeméƒ½æ²¡æœ‰å‘€</p>2020-10-23</li><br/><li><span>cheese</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>åœ¨createå’Œjoinåï¼ŒåŒæ–¹æˆåŠŸè¿æ¥åï¼Œèƒ½å¦ç”¨Datachannelæ¥ä¼ è¾“ä¿¡ä»¤å‘¢ï¼Ÿæ¯”å¦‚ï¼šå…³é—­éº¦å…‹é£ä¹‹ç±»çš„</p>2020-04-09</li><br/><li><span>Geek_5a0689</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è€å¸ˆï¼Œæˆ‘çš„server.jsåœ¨æˆ‘éƒ¨ç½²çš„è…¾è®¯äº‘æœåŠ¡å™¨ä¸Šè·‘èµ·æ¥äº†ï¼Œä½†æ˜¯åœ¨æˆ‘æœ¬æœºçš„htmlé¡µé¢è¯·æ±‚çš„æ—¶å€™ï¼Œæ²¡æœ‰ä»»ä½•ååº”ï¼Œçœ‹æœåŠ¡å™¨ä¸Šçš„æ—¥å¿—ä¹Ÿæ˜¯æ²¡æœ‰ä»»ä½•çš„æ‰“å°ï¼Œæ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿæˆ‘ç›´æ¥è·‘çš„gitä¸Šé¢çš„ä»£ç éƒ½ä¸å¯ä»¥</p>2020-03-19</li><br/><li><span>å¸Œæœ›æ”¹åå­—ä¸è¢«å‘ç°çš„ä¿Šwen</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>åŒä¸€ä¸ªpeerconnectionï¼Œdatachannelå‘é€çš„æ–‡å­—èƒ½å’Œè§†é¢‘streamä¿æŒåŒæ­¥å—</p>2019-08-29</li><br/><li><span>Geek_c9206f</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å¦‚æœåŒæ—¶æœ‰å¤šä¸ªä¼šè¯å‘¢DataChannelè¿˜èƒ½å¯¹ä¸Šå˜›</p>2024-10-11</li><br/>
</ul>