ä½ å¥½ï¼Œæˆ‘æ˜¯winterã€‚

åœ¨å‰é¢çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ äº†DOMç›¸å…³çš„APIï¼Œç‹­ä¹‰çš„DOM APIä»…ä»…åŒ…å«DOMæ ‘å½¢ç»“æ„ç›¸å…³çš„å†…å®¹ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å†æ¥å­¦ä¹ ä¸€ç±»æ–°çš„APIï¼šCSSOMã€‚

æˆ‘æƒ³ï¼Œä½ åœ¨æœ€åˆæ¥è§¦æµè§ˆå™¨APIçš„æ—¶å€™ï¼Œåº”è¯¥éƒ½æœ‰è·Ÿæˆ‘ç±»ä¼¼çš„æƒ³æ³•ï¼šâ€œå¥½æƒ³è¦element.widthã€element.heightè¿™æ ·çš„APIå•Šâ€ã€‚

è¿™æ ·çš„APIå¯ä»¥ç›´æ¥è·å–å…ƒç´ çš„æ˜¾ç¤ºç›¸å…³ä¿¡æ¯ï¼Œå®ƒä»¬æ˜¯éå¸¸ç¬¦åˆäººçš„ç¬¬ä¸€å°è±¡ç›´è§‰çš„è®¾è®¡ï¼Œä½†æ˜¯ï¼Œåå DOM API ä¸­æ²¡æœ‰è¿™æ ·çš„å†…å®¹ã€‚

éšç€å­¦ä¹ çš„æ·±å…¥ï¼Œæˆ‘æ‰çŸ¥é“ï¼Œè¿™æ ·çš„è®¾è®¡æ˜¯æœ‰èƒŒåçš„é€»è¾‘çš„ï¼Œæ­£å¦‚HTMLå’ŒCSSåˆ†åˆ«æ‰¿æ‹…äº†è¯­ä¹‰å’Œè¡¨ç°çš„åˆ†å·¥ï¼ŒDOMå’ŒCSSOMä¹Ÿæœ‰è¯­ä¹‰å’Œè¡¨ç°çš„åˆ†å·¥ã€‚

DOMä¸­çš„æ‰€æœ‰çš„å±æ€§éƒ½æ˜¯ç”¨æ¥è¡¨ç°è¯­ä¹‰çš„å±æ€§ï¼ŒCSSOMçš„åˆ™éƒ½æ˜¯è¡¨ç°çš„å±æ€§ï¼Œwidthå’Œheightè¿™ç±»æ˜¾ç¤ºç›¸å…³çš„å±æ€§ï¼Œéƒ½å±äºæˆ‘ä»¬ä»Šå¤©è¦è®²çš„CSSOMã€‚

é¡¾åæ€ä¹‰ï¼ŒCSSOMæ˜¯CSSçš„å¯¹è±¡æ¨¡å‹ï¼Œåœ¨W3Cæ ‡å‡†ä¸­ï¼Œå®ƒåŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼šæè¿°æ ·å¼è¡¨å’Œè§„åˆ™ç­‰CSSçš„æ¨¡å‹éƒ¨åˆ†ï¼ˆCSSOMï¼‰ï¼Œå’Œè·Ÿå…ƒç´ è§†å›¾ç›¸å…³çš„Viewéƒ¨åˆ†ï¼ˆCSSOM Viewï¼‰ã€‚

åœ¨å®é™…ä½¿ç”¨ä¸­ï¼ŒCSSOM Viewæ¯”CSSOMæ›´å¸¸ç”¨ä¸€äº›ï¼Œå› ä¸ºæˆ‘ä»¬å¾ˆå°‘éœ€è¦ç”¨ä»£ç å»åŠ¨æ€åœ°ç®¡ç†æ ·å¼è¡¨ã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ18ï¼‰</strong></div><ul>
<li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK6oo2CoIk3mBNfuro6TSWVCVxsWcfvt0GL1avaXbNdErjp7sussmunAU8eebbhUKcwV6Y7XeNYlA/132" width="30px"><span>Geek_ianp87</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>display:inline;çš„å…ƒç´ ä¼šä¸ä¼šäº§ç”Ÿç›’ï¼Ÿ</div>2019-10-09</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/02/a3/b7e7a787.jpg" width="30px"><span>Russell</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<div>è¿™ä¸ªå’‹æ¢è¡Œå•Šã€‚ã€‚ã€‚ ä¸å¥½æ„æ€ï¼Œè€å¸ˆå¥½ï¼Œæˆ‘æƒ³å’¨è¯¢æµè§ˆå™¨APIçš„ç§ç±»ã€‚ æˆ‘å¯ä»¥è®¤ä¸ºæ˜¯ï¼ŒDOMï¼ŒBOMï¼ŒCSSOMè¿™å‡ ç±»ä¹ˆï¼Ÿ</div>2019-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/35/d0/f2ac6d91.jpg" width="30px"><span>é˜¿æˆ</span> ğŸ‘ï¼ˆ61ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<div>Look via gist: https:&#47;&#47;gist.github.com&#47;aimergenge&#47;2bcf41ac4c4d2586e48ccd5cec5c9768

void function () {
  const canvas = document.createElement(&#39;canvas&#39;)

  canvas.width = document.documentElement.offsetWidth
  canvas.height = document.documentElement.offsetHeight

  canvas.style.position = &#39;absolute&#39;
  canvas.style.left = &#39;0&#39;
  canvas.style.right = &#39;0&#39;
  canvas.style.top = &#39;0&#39;
  canvas.style.bottom = &#39;0&#39;
  canvas.style.zIndex = &#39;99999&#39;

  document.body.appendChild(canvas)

  const ctx = canvas.getContext(&#39;2d&#39;)
  draw(ctx, getAllRects())

  function draw (ctx, rects) {
    let i = 0
    ctx.strokeStyle = &#39;red&#39;
    window.requestAnimationFrame(_draw)

    function _draw () {
      let {x, y, width, height} = rects[i++]
      ctx.strokeRect(x, y, width, height)
      if (i &lt; rects.length) {
        window.requestAnimationFrame(_draw)
      } else {
        console.log(&#39;%cDONE&#39;, &#39;background-color: green; color: white; padding: 0.3em 0.5em;&#39;)
      }
    }
  }

  function getAllRects () {
    const allElements = document.querySelectorAll(&#39;*&#39;)
    const rects = []
    const {x: htmlX, y: htmlY} = document.documentElement.getBoundingClientRect()
    allElements.forEach(element =&gt; {
      const eachElRects = Array.from(element.getClientRects()).filter(rect =&gt; {
        return rect.width || rect.height
      }).map(rect =&gt; {
        return {
          x: rect.x - htmlX,
          y: rect.y - htmlY,
          width: rect.width,
          height: rect.height
        }
      })
      rects.push(...eachElRects)
    })
    return rects
  }
}()
</div>2019-03-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/fb/29/aaa16933.jpg" width="30px"><span>welkin</span> ğŸ‘ï¼ˆ14ï¼‰ ğŸ’¬ï¼ˆ6ï¼‰<div>å¸Œæœ›ä½œè€…èƒ½è®²ä¸€ä¸‹è™šæ‹Ÿdom
è¿˜æœ‰æµè§ˆå™¨çš„é‡ç»˜å’Œé‡æ’
ä»¥åŠæ€§èƒ½ä¼˜åŒ–ï¼Œè·¨åŸŸçš„å¸¸ç”¨æ“ä½œ(å¸Œæœ›ç»†è‡´ä¸€ç‚¹)
åŒ…æ‹¬ä¸€äº›æ¼æ´å’Œæ”»å‡»ï¼Œæ¯”å¦‚xssï¼Œsqlæ³¨å…¥
è¿˜æœ‰ä¸€äº›æŠ€æœ¯æ ˆï¼Œå’Œä¸€äº›å¯¹äºå‰ç«¯éœ€è¦äº†è§£çš„æ–¹æ¡ˆï¼Œæ¯”å¦‚ç¦»çº¿æ–¹æ¡ˆç­‰</div>2019-03-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/7b/85/385fe515.jpg" width="30px"><span>çƒ­å¿ƒç½‘å‹å¥½å®…ğŸ’«</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>ä¸€ç›´å¿ç€æ²¡é—®ï¼Œå“ªæ¥è¿™ä¹ˆå¤šçŒ«ç‰‡ğŸ¤£</div>2019-04-25</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/10/60/de/5c67895a.jpg" width="30px"><span>å‘¨é£</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>&lt;body&gt;
 &lt;canvas id=&quot;rect&quot;&gt;&lt;&#47;canvas&gt; 
&lt;script type=&quot;text&#47;javascript&quot;&gt;    
             const canvas = document.getElementById(&#39;rect&#39;);
             canvas.width =document.documentElement.getBoundingClientRect().width;
             canvas.height = document.documentElement.getBoundingClientRect().height;
             canvas.style.position=&quot;absolute&quot;;
             canvas.style.top=0;
             canvas.style.left=0;
             canvas.style.border=&#39;1px solid red&#39;;
             const ctx = canvas.getContext(&#39;2d&#39;);
             function travaldom(root){                    
               if(root.tagName &amp;&amp; root.tagName !==&#39;text&#39; &amp;&amp; root.tagName!==&#39;canvas&#39;){
                  const startX = root.getBoundingClientRect().x;
                  const startY = root.getBoundingClientRect().y;
                  const width = root.getBoundingClientRect().width;
                  const height = root.getBoundingClientRect().height;
                  ctx.beginPath();
                  ctx.lineWidth=&quot;1&quot;;
                  ctx.strokeStyle=&quot;blue&quot;;
                  ctx.rect(startX,startY,width,height);
                  ctx.stroke();
               }
               root.childNodes.forEach(node=&gt;{
                   travaldom(node);
               });
             }
             travaldom(document);
        &lt;&#47;script&gt;	
&lt;&#47;body&gt;</div>2019-04-07</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/d6/dc/c454588f.jpg" width="30px"><span>ç—•è¿‘ç—•è¿œ</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>è¯·é—®è€å¸ˆï¼Œå¦‚ä½•è§£å†³UIè‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œå®šä½æ ‡ç­¾æ˜¾ç¤ºå…ƒç´ ä¸å¯è§çš„é—®é¢˜</div>2019-03-17</li><br/><li><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ericK6f30odtlIjX0Sw5cA3v259nLp2ibba5nQdzRk8cckZlruN6XtvEmRYKblibosiaiauVxh1NDxicESg/132" width="30px"><span>å®‹å®‹</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å‰é¢è®²æµè§ˆå™¨æ¸²æŸ“æ—¶æœ‰è®²åˆ°ï¼ŒCSSç»è¿‡è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æè¢«è§£ææˆä¸€é¢—æŠ½è±¡è¯­æ³•æ ‘ã€‚
è¿™ä¸ªæŠ½è±¡è¯­æ³•æ ‘å’ŒCSSOMæœ‰ä»€ä¹ˆå…³è”ä¹ˆï¼Ÿå› ä¸ºå¾ˆå¤šæ–‡ç« éƒ½è®²CSSç»è¿‡è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æè¢«è§£ææˆCSSOMï¼Œæ„Ÿè§‰å¾ˆç–‘æƒ‘ã€‚</div>2019-03-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/14/f7/2f/10cbed82.jpg" width="30px"><span>pcxpccccx_</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>å†²å†²å†²</div>2020-03-22</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/02/a3/b7e7a787.jpg" width="30px"><span>Russell</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>emm~~ æˆ‘åˆè¯»äº†ä¸€éæ–‡æ¡£ï¼Œå‘ç°äº†å¯¹æˆ‘æ¥è¯´å¾ˆå…³é”®è¯ï¼Œâ€œç‹­ä¹‰çš„â€ã€‚ é‚£æˆ‘ç°åœ¨çš„ç†è§£æ˜¯é…±ç´«çš„ã€‚  å¹¿ä¹‰çš„ç†è§£ï¼Œå°±æ˜¯BOM+DOMï¼ŒCSSOMæ˜¯DOMæ‰©å±•çš„ä¸€éƒ¨åˆ†ï¼›å¦‚æœç‹­ä¹‰çš„è®¤ä¸ºDOMå°±æ˜¯æ ‘å½¢ç»“æ„çš„è¯ï¼Œå°±å¯ä»¥åˆ†å‡ºæ¥DOMã€CSSOMä¸¤éƒ¨åˆ†å†…å®¹äº†ã€‚ æˆ‘è¿™æ ·æƒ³å¯¹ä¹ˆï¼Ÿ</div>2019-04-03</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/1d/08/0f/9ed70716.jpg" width="30px"><span>éæ´²å°ç™½ç‹¼</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>function elementTreeDFS(el, callback) {
    if (el instanceof HTMLElement) {
        callback(el);
        const children = Array.from(el.children);
        children.forEach(element =&gt; elementTreeDFS(element, callback));
    }
}
function renderCanvas() {
    const canvas = document.createElement(&#39;canvas&#39;);
    const ctx = canvas.getContext(&#39;2d&#39;);
    canvas.width = document.documentElement.offsetWidth || document.body.offsetWidth;
    canvas.height = document.documentElement.offsetHeight || document.body.offsetHeight;
    elementTreeDFS(document.documentElement, (el) =&gt; {
        const bounding = el.getBoundingClientRect();
        if (bounding.left || bounding.top || bounding.right || bounding.bottom || bounding.width || bounding.height) {
            ctx?.strokeRect(bounding.left, bounding.top, bounding.width, bounding.height);
        }
    });
    canvas.toBlob((blob) =&gt; {
        console.log(URL.createObjectURL(blob));
    }, &#39;image&#47;jpg&#39;, 1);
}
renderCanvas();
</div>2024-08-27</li><br/><li><img src="" width="30px"><span>Fiona B Y Fan</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>é€šè¿‡document.getStyleSheetsä¿®æ”¹styleä»¥åŠwindow.getComputedStyle window.getBoundingClientRect window.getClientRectsæ–¹æ³•ä¼šå¯¼è‡´é‡æ’å’Œé‡ç»˜ï¼Œå½±å“æ€§èƒ½ï¼Œä¸æ˜¯åº”è¯¥å°‘ç”¨å—</div>2022-04-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/27/98/fb/aa63be6f.jpg" width="30px"><span>pasico</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>

function dfs(top, callback){
    let node = top
    let stack = Array.from(node.children).reverse()
    callback(node)
    while(stack.length){
        node = stack.pop()
        callback(node)
        stack.push(...Array.from(node.children).reverse())
    }
}

function traverse(){
    let body = document.body
    &#47;&#47; let color = 0
    let time = 0
    let count = 0
    let can = document.createElement(&#39;canvas&#39;)
    can.style.position = &#39;fixed&#39;
    can.style.top=0
    can.style.left=0
    let ctx = can.getContext(&#39;2d&#39;)
    const callback=(node)=&gt;{
        time+=50
        count++
        setTimeout(()=&gt;{            
            var {x,y,width,height} = node.getBoundingClientRect()
            console.log(&#39;count&#39;, count, node, x, y, width, height)
            if(node === body){
                can.style.width = width
                can.width = width
                can.style.height = height
                can.height = height
            }
            &#47;&#47; color++
            &#47;&#47; ctx.fillStyle=`rgb(${color%255},${color%255},${color%255})`;
            &#47;&#47; ctx.fillRect(x,y,width, height)
            ctx.strokeStyle = &#39;green&#39;;
            ctx.strokeRect(x, y, width, height);
        }, time)
    }
    dfs(body, callback)
    body.appendChild(can)
}

traverse()</div>2022-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/12/51/9f/1840385e.jpg" width="30px"><span>èƒ¡æ°¸</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>
    const newWindow = window.open(&quot;about:blank&quot;, &quot;_blank&quot;, &quot;width=100,height=100,left=100,right=100&quot;)
    const canvas = newWindow.document.body.appendChild(newWindow.document.createElement(&#39;canvas&#39;));
    canvas.width = document.documentElement.offsetWidth
    canvas.height = document.documentElement.offsetHeight

    canvas.style.position = &#39;absolute&#39;
    canvas.style.left = &#39;0&#39;
    canvas.style.right = &#39;0&#39;
    canvas.style.top = &#39;0&#39;
    canvas.style.bottom = &#39;0&#39;
    canvas.style.zIndex = &#39;99999&#39;

    const ctx = canvas.getContext(&#39;2d&#39;);
    const { x: htmlX, y: htmlY } = document.documentElement.getBoundingClientRect()

    let tagsArr = new Set();
    void function getAllElementsTag() {
        const body = document.body;
        const { width, height } = document.documentElement.getBoundingClientRect();
        return recurtion(body);
    }()


    function drawCanvas(ele) {
        const offsetX = ele.getBoundingClientRect().x - htmlX;
        const offsetY = ele.getBoundingClientRect().y - htmlY;
        const { width, height } = ele.getBoundingClientRect();
        ctx.strokeStyle = &#39;red&#39;;
        ctx.strokeRect(offsetX, offsetY, width, height);
    }


    function recurtion(ele) {
        tagsArr.add(ele.nodeName.slice(0).toLowerCase());
        drawCanvas(ele)
        if (!ele.hasChildNodes()) return;
        ele.childNodes.forEach(item =&gt; {
            if (item.hasChildNodes()) {
                return recurtion(item)
            }
            if (!&#47;#&#47;.test(item.nodeName)) {
                drawCanvas(item)
            }

            tagsArr.add(item.nodeName.slice(0).toLowerCase())
        })
    }</div>2021-06-16</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/11/bc/e8/43109d54.jpg" width="30px"><span>Peter</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>
&#47;&#47; åˆ›å»ºè¦†ç›–åœ¨ç½‘é¡µä¸Šæ–¹çš„canvas
const cvs = document.createElement(&#39;canvas&#39;)
cvs.width = document.documentElement.scrollWidth;
cvs.height = document.documentElement.scrollHeight;
cvs.style.position = &#39;absolute&#39;;
cvs.style.zIndex = 1000;
cvs.style.left = 0;
cvs.style.top = 0;
ctx = cvs.getContext(&#39;2d&#39;);
ctx.strokeStyle=&quot;red&quot;;

&#47;&#47; æŸ¥æ‰¾æ‰€æœ‰å—å…ƒç´ ï¼Œè®¡ç®—ä½ç½®å¹¶åœ¨å¯¹åº”åæ ‡ç»˜åˆ¶è¾¹æ¡†åœ¨canvasä¸Šã€‚
const BlockLevel = [&#39;block&#39;, &#39;inline-block&#39;, &#39;inline-table&#39;, &#39;table&#39;, &#39;flex&#39;, &#39;grid&#39;, &#39;flow-root&#39;];
[].forEach.call(document.body.getElementsByTagName(&#39;*&#39;), (item) =&gt; {
    if (BlockLevel.indexOf(getComputedStyle(item).display) &gt; -1) {
        const rect = item.getBoundingClientRect();
        const { x, y, width, height } = rect;
        ctx.strokeRect(x, y, width, height);
    }
})

document.body.append(cvs);
</div>2020-06-30</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/13/26/22/dd505e6d.jpg" width="30px"><span>Yully</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>removeRuleè¢«deleteRuleå–ä»£äº†ï¼Œå»ºè®®ç”¨deleteRuleï¼Œç”¨æ³•éƒ½ä¸€æ ·</div>2020-06-05</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/17/ee/18/802b61e5.jpg" width="30px"><span>è¥¿ä¼¯åˆ©äºšé›ªæ©‡çŠ¬</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>IEçš„edgeç‰ˆæœ¬scrolläº‹ä»¶ï¼Œäº‹ä»¶ä¸­ä¸€ä¸ªå…ƒç´ è¿›è¡Œå®šä½ï¼Œæœ‰æ®‹å½±ï¼Œè°·æ­Œå°±æ˜¯å¹³æ»‘ç§»åŠ¨</div>2020-02-17</li><br/><li><img src="https://static001.geekbang.org/account/avatar/00/15/02/a3/b7e7a787.jpg" width="30px"><span>Russell</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<div>ä¸å¯¹ï¼Œæˆ‘è§‰å¾—æˆ‘è¿™ä¹ˆç†è§£ä¸å¯¹ã€‚ã€‚ã€‚</div>2019-04-03</li><br/>
</ul>