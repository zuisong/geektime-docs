ä½ å¥½ï¼Œæˆ‘æ˜¯winterã€‚è¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬æ¥è®²ä¸€è®²JavaScriptçš„æ‰§è¡Œã€‚

é¦–å…ˆæˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬æ˜¯æµè§ˆå™¨æˆ–è€…Nodeçš„å¼€å‘è€…ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ä½¿ç”¨JavaScriptå¼•æ“ã€‚

å½“æ‹¿åˆ°ä¸€æ®µJavaScriptä»£ç æ—¶ï¼Œæµè§ˆå™¨æˆ–è€…Nodeç¯å¢ƒé¦–å…ˆè¦åšçš„å°±æ˜¯ï¼›ä¼ é€’ç»™JavaScriptå¼•æ“ï¼Œå¹¶ä¸”è¦æ±‚å®ƒå»æ‰§è¡Œã€‚

ç„¶è€Œï¼Œæ‰§è¡ŒJavaScriptå¹¶éä¸€é”¤å­ä¹°å–ï¼Œå®¿ä¸»ç¯å¢ƒå½“é‡åˆ°ä¸€äº›äº‹ä»¶æ—¶ï¼Œä¼šç»§ç»­æŠŠä¸€æ®µä»£ç ä¼ é€’ç»™JavaScriptå¼•æ“å»æ‰§è¡Œï¼Œæ­¤å¤–ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜ä¼šæä¾›APIç»™JavaScriptå¼•æ“ï¼Œæ¯”å¦‚setTimeoutè¿™æ ·çš„APIï¼Œå®ƒä¼šå…è®¸JavaScriptåœ¨ç‰¹å®šçš„æ—¶æœºæ‰§è¡Œã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬é¦–å…ˆåº”è¯¥å½¢æˆä¸€ä¸ªæ„Ÿæ€§çš„è®¤çŸ¥ï¼šä¸€ä¸ªJavaScriptå¼•æ“ä¼šå¸¸é©»äºå†…å­˜ä¸­ï¼Œå®ƒç­‰å¾…ç€æˆ‘ä»¬ï¼ˆå®¿ä¸»ï¼‰æŠŠJavaScriptä»£ç æˆ–è€…å‡½æ•°ä¼ é€’ç»™å®ƒæ‰§è¡Œã€‚

åœ¨ES3å’Œæ›´æ—©çš„ç‰ˆæœ¬ä¸­ï¼ŒJavaScriptæœ¬èº«è¿˜æ²¡æœ‰å¼‚æ­¥æ‰§è¡Œä»£ç çš„èƒ½åŠ›ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå®¿ä¸»ç¯å¢ƒä¼ é€’ç»™JavaScriptå¼•æ“ä¸€æ®µä»£ç ï¼Œå¼•æ“å°±æŠŠä»£ç ç›´æ¥é¡ºæ¬¡æ‰§è¡Œäº†ï¼Œè¿™ä¸ªä»»åŠ¡ä¹Ÿå°±æ˜¯å®¿ä¸»å‘èµ·çš„ä»»åŠ¡ã€‚

ä½†æ˜¯ï¼Œåœ¨ES5ä¹‹åï¼ŒJavaScriptå¼•å…¥äº†Promiseï¼Œè¿™æ ·ï¼Œä¸éœ€è¦æµè§ˆå™¨çš„å®‰æ’ï¼ŒJavaScriptå¼•æ“æœ¬èº«ä¹Ÿå¯ä»¥å‘èµ·ä»»åŠ¡äº†ã€‚

ç”±äºæˆ‘ä»¬è¿™é‡Œä¸»è¦è®²JavaScriptè¯­è¨€ï¼Œé‚£ä¹ˆé‡‡çº³JSCå¼•æ“çš„æœ¯è¯­ï¼Œæˆ‘ä»¬æŠŠå®¿ä¸»å‘èµ·çš„ä»»åŠ¡ç§°ä¸ºå®è§‚ä»»åŠ¡ï¼ŒæŠŠJavaScriptå¼•æ“å‘èµ·çš„ä»»åŠ¡ç§°ä¸ºå¾®è§‚ä»»åŠ¡ã€‚

## å®è§‚å’Œå¾®è§‚ä»»åŠ¡

JavaScriptå¼•æ“ç­‰å¾…å®¿ä¸»ç¯å¢ƒåˆ†é…å®è§‚ä»»åŠ¡ï¼Œåœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œé€šå¸¸ç­‰å¾…çš„è¡Œä¸ºéƒ½æ˜¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œæ‰€ä»¥åœ¨Nodeæœ¯è¯­ä¸­ï¼Œä¹Ÿä¼šæŠŠè¿™ä¸ªéƒ¨åˆ†ç§°ä¸ºäº‹ä»¶å¾ªç¯ã€‚

ä¸è¿‡ï¼Œæœ¯è¯­æœ¬èº«å¹¶éæˆ‘ä»¬éœ€è¦é‡ç‚¹è®¨è®ºçš„å†…å®¹ï¼Œæˆ‘ä»¬åœ¨è¿™é‡ŒæŠŠé‡ç‚¹æ”¾åœ¨äº‹ä»¶å¾ªç¯çš„åŸç†ä¸Šã€‚åœ¨åº•å±‚çš„C/C++ä»£ç ä¸­ï¼Œè¿™ä¸ªäº‹ä»¶å¾ªç¯æ˜¯ä¸€ä¸ªè·‘åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­çš„å¾ªç¯ï¼Œæˆ‘ä»¬ç”¨ä¼ªä»£ç æ¥è¡¨ç¤ºï¼Œå¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š

```C
while(TRUE) {
    r = wait();
    execute(r);
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªå¾ªç¯åšçš„äº‹æƒ…åŸºæœ¬ä¸Šå°±æ˜¯åå¤â€œç­‰å¾…-æ‰§è¡Œâ€ã€‚å½“ç„¶ï¼Œå®é™…çš„ä»£ç ä¸­å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œè¿˜æœ‰è¦åˆ¤æ–­å¾ªç¯æ˜¯å¦ç»“æŸã€å®è§‚ä»»åŠ¡é˜Ÿåˆ—ç­‰é€»è¾‘ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ä½ ç†è§£ï¼Œæˆ‘å°±æŠŠè¿™äº›éƒ½çœç•¥æ‰äº†ã€‚

è¿™é‡Œæ¯æ¬¡çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå…¶å®éƒ½æ˜¯ä¸€ä¸ªå®è§‚ä»»åŠ¡ã€‚æˆ‘ä»¬å¯ä»¥å¤§æ¦‚ç†è§£ï¼šå®è§‚ä»»åŠ¡çš„é˜Ÿåˆ—å°±ç›¸å½“äºäº‹ä»¶å¾ªç¯ã€‚

åœ¨å®è§‚ä»»åŠ¡ä¸­ï¼ŒJavaScriptçš„Promiseè¿˜ä¼šäº§ç”Ÿå¼‚æ­¥ä»£ç ï¼ŒJavaScriptå¿…é¡»ä¿è¯è¿™äº›å¼‚æ­¥ä»£ç åœ¨ä¸€ä¸ªå®è§‚ä»»åŠ¡ä¸­å®Œæˆï¼Œå› æ­¤ï¼Œæ¯ä¸ªå®è§‚ä»»åŠ¡ä¸­åˆåŒ…å«äº†ä¸€ä¸ªå¾®è§‚ä»»åŠ¡é˜Ÿåˆ—ï¼š

![](https://static001.geekbang.org/resource/image/16/65/16f70a9a51a65d5302166b0d78414d65.jpg?wh=1398%2A1636)

æœ‰äº†å®è§‚ä»»åŠ¡å’Œå¾®è§‚ä»»åŠ¡æœºåˆ¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°JavaScriptå¼•æ“çº§å’Œå®¿ä¸»çº§çš„ä»»åŠ¡äº†ï¼Œä¾‹å¦‚ï¼šPromiseæ°¸è¿œåœ¨é˜Ÿåˆ—å°¾éƒ¨æ·»åŠ å¾®è§‚ä»»åŠ¡ã€‚setTimeoutç­‰å®¿ä¸»APIï¼Œåˆ™ä¼šæ·»åŠ å®è§‚ä»»åŠ¡ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹Promiseã€‚

## Promise

Promiseæ˜¯JavaScriptè¯­è¨€æä¾›çš„ä¸€ç§æ ‡å‡†åŒ–çš„å¼‚æ­¥ç®¡ç†æ–¹å¼ï¼Œå®ƒçš„æ€»ä½“æ€æƒ³æ˜¯ï¼Œéœ€è¦è¿›è¡Œioã€ç­‰å¾…æˆ–è€…å…¶å®ƒå¼‚æ­¥æ“ä½œçš„å‡½æ•°ï¼Œä¸è¿”å›çœŸå®ç»“æœï¼Œè€Œè¿”å›ä¸€ä¸ªâ€œæ‰¿è¯ºâ€ï¼Œå‡½æ•°çš„è°ƒç”¨æ–¹å¯ä»¥åœ¨åˆé€‚çš„æ—¶æœºï¼Œé€‰æ‹©ç­‰å¾…è¿™ä¸ªæ‰¿è¯ºå…‘ç°ï¼ˆé€šè¿‡Promiseçš„thenæ–¹æ³•çš„å›è°ƒï¼‰ã€‚

Promiseçš„åŸºæœ¬ç”¨æ³•ç¤ºä¾‹å¦‚ä¸‹ï¼š

```
    function sleep(duration) {
        return new Promise(function(resolve, reject) {
            setTimeout(resolve,duration);
        })
    }
    sleep(1000).then( ()=> console.log("finished"));
```

è¿™æ®µä»£ç å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°sleepï¼Œå®ƒçš„ä½œç”¨æ˜¯ç­‰å€™ä¼ å…¥å‚æ•°æŒ‡å®šçš„æ—¶é•¿ã€‚

Promiseçš„thenå›è°ƒæ˜¯ä¸€ä¸ªå¼‚æ­¥çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥ç ”ç©¶ä¸€ä¸‹Promiseå‡½æ•°ä¸­çš„æ‰§è¡Œé¡ºåºï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€æ®µä»£ç ç¤ºä¾‹ï¼š

```
    var r = new Promise(function(resolve, reject){
        console.log("a");
        resolve()
    });
    r.then(() => console.log("c"));
    console.log("b")
```

æˆ‘ä»¬æ‰§è¡Œè¿™æ®µä»£ç åï¼Œæ³¨æ„è¾“å‡ºçš„é¡ºåºæ˜¯ a b cã€‚åœ¨è¿›å…¥console.log(â€œbâ€) ä¹‹å‰ï¼Œæ¯«æ— ç–‘é—® r å·²ç»å¾—åˆ°äº†resolveï¼Œä½†æ˜¯Promiseçš„resolveå§‹ç»ˆæ˜¯å¼‚æ­¥æ“ä½œï¼Œæ‰€ä»¥cæ— æ³•å‡ºç°åœ¨bä¹‹å‰ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬è¯•è¯•è·ŸsetTimeoutæ··ç”¨çš„Promiseã€‚

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘è®¾ç½®äº†ä¸¤æ®µäº’ä¸ç›¸å¹²çš„å¼‚æ­¥æ“ä½œï¼šé€šè¿‡setTimeoutæ‰§è¡Œconsole.log(â€œdâ€)ï¼Œé€šè¿‡Promiseæ‰§è¡Œconsole.log(â€œcâ€)ã€‚

```
    var r = new Promise(function(resolve, reject){
        console.log("a");
        resolve()
    });
    setTimeout(()=>console.log("d"), 0)
    r.then(() => console.log("c"));
    console.log("b")
```

æˆ‘ä»¬å‘ç°ï¼Œä¸è®ºä»£ç é¡ºåºå¦‚ä½•ï¼Œdå¿…å®šå‘ç”Ÿåœ¨cä¹‹åï¼Œå› ä¸ºPromiseäº§ç”Ÿçš„æ˜¯JavaScriptå¼•æ“å†…éƒ¨çš„å¾®ä»»åŠ¡ï¼Œè€ŒsetTimeoutæ˜¯æµè§ˆå™¨APIï¼Œå®ƒäº§ç”Ÿå®ä»»åŠ¡ã€‚

ä¸ºäº†ç†è§£å¾®ä»»åŠ¡å§‹ç»ˆå…ˆäºå®ä»»åŠ¡ï¼Œæˆ‘ä»¬è®¾è®¡ä¸€ä¸ªå®éªŒï¼šæ‰§è¡Œä¸€ä¸ªè€—æ—¶1ç§’çš„Promiseã€‚

```
    setTimeout(()=>console.log("d"), 0)
    var r = new Promise(function(resolve, reject){
        resolve()
    });
    r.then(() => { 
        var begin = Date.now();
        while(Date.now() - begin < 1000);
        console.log("c1") 
        new Promise(function(resolve, reject){
            resolve()
        }).then(() => console.log("c2"))
    });
```

è¿™é‡Œæˆ‘ä»¬å¼ºåˆ¶äº†1ç§’çš„æ‰§è¡Œè€—æ—¶ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿ä»»åŠ¡c2æ˜¯åœ¨dä¹‹åè¢«æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ã€‚

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿è€—æ—¶ä¸€ç§’çš„c1æ‰§è¡Œå®Œæ¯•ï¼Œå†enqueçš„c2ï¼Œä»ç„¶å…ˆäºdæ‰§è¡Œäº†ï¼Œè¿™å¾ˆå¥½åœ°è§£é‡Šäº†å¾®ä»»åŠ¡ä¼˜å…ˆçš„åŸç†ã€‚

é€šè¿‡ä¸€ç³»åˆ—çš„å®éªŒï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ä¸€ä¸‹å¦‚ä½•åˆ†æå¼‚æ­¥æ‰§è¡Œçš„é¡ºåºï¼š

- é¦–å…ˆæˆ‘ä»¬åˆ†ææœ‰å¤šå°‘ä¸ªå®ä»»åŠ¡ï¼›
- åœ¨æ¯ä¸ªå®ä»»åŠ¡ä¸­ï¼Œåˆ†ææœ‰å¤šå°‘ä¸ªå¾®ä»»åŠ¡ï¼›
- æ ¹æ®è°ƒç”¨æ¬¡åºï¼Œç¡®å®šå®ä»»åŠ¡ä¸­çš„å¾®ä»»åŠ¡æ‰§è¡Œæ¬¡åºï¼›
- æ ¹æ®å®ä»»åŠ¡çš„è§¦å‘è§„åˆ™å’Œè°ƒç”¨æ¬¡åºï¼Œç¡®å®šå®ä»»åŠ¡çš„æ‰§è¡Œæ¬¡åºï¼›
- ç¡®å®šæ•´ä¸ªé¡ºåºã€‚

æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªç¨å¾®å¤æ‚çš„ä¾‹å­ï¼š

```
    function sleep(duration) {
        return new Promise(function(resolve, reject) {
            console.log("b");
            setTimeout(resolve,duration);
        })
    }
    console.log("a");
    sleep(5000).then(()=>console.log("c"));
```

è¿™æ˜¯ä¸€æ®µéå¸¸å¸¸ç”¨çš„å°è£…æ–¹æ³•ï¼Œåˆ©ç”¨PromiseæŠŠsetTimeoutå°è£…æˆå¯ä»¥ç”¨äºå¼‚æ­¥çš„å‡½æ•°ã€‚

æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ï¼ŒsetTimeoutæŠŠæ•´ä¸ªä»£ç åˆ†å‰²æˆäº†2ä¸ªå®è§‚ä»»åŠ¡ï¼Œè¿™é‡Œä¸è®ºæ˜¯5ç§’è¿˜æ˜¯0ç§’ï¼Œéƒ½æ˜¯ä¸€æ ·çš„ã€‚

ç¬¬ä¸€ä¸ªå®è§‚ä»»åŠ¡ä¸­ï¼ŒåŒ…å«äº†å…ˆååŒæ­¥æ‰§è¡Œçš„ console.log(â€œaâ€); å’Œ console.log(â€œbâ€);ã€‚

setTimeoutåï¼Œç¬¬äºŒä¸ªå®è§‚ä»»åŠ¡æ‰§è¡Œè°ƒç”¨äº†resolveï¼Œç„¶åthenä¸­çš„ä»£ç å¼‚æ­¥å¾—åˆ°æ‰§è¡Œï¼Œæ‰€ä»¥è°ƒç”¨äº†console.log(â€œcâ€)ï¼Œæœ€ç»ˆè¾“å‡ºçš„é¡ºåºæ‰æ˜¯ï¼š a b cã€‚

Promiseæ˜¯JavaScriptä¸­çš„ä¸€ä¸ªå®šä¹‰ï¼Œä½†æ˜¯å®é™…ç¼–å†™ä»£ç æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå®ƒä¼¼ä¹å¹¶ä¸æ¯”å›è°ƒçš„æ–¹å¼ä¹¦å†™æ›´ç®€å•ï¼Œä½†æ˜¯ä»ES6å¼€å§‹ï¼Œæˆ‘ä»¬æœ‰äº†async/awaitï¼Œè¿™ä¸ªè¯­æ³•æ”¹è¿›è·ŸPromiseé…åˆï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°æ”¹å–„ä»£ç ç»“æ„ã€‚

## æ–°ç‰¹æ€§ï¼šasync/await

async/awaitæ˜¯ES2016æ–°åŠ å…¥çš„ç‰¹æ€§ï¼Œå®ƒæä¾›äº†ç”¨forã€ifç­‰ä»£ç ç»“æ„æ¥ç¼–å†™å¼‚æ­¥çš„æ–¹å¼ã€‚å®ƒçš„è¿è¡Œæ—¶åŸºç¡€æ˜¯Promiseï¼Œé¢å¯¹è¿™ç§æ¯”è¾ƒæ–°çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹åŸºæœ¬ç”¨æ³•ã€‚

asyncå‡½æ•°å¿…å®šè¿”å›Promiseï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰è¿”å›Promiseçš„å‡½æ•°éƒ½å¯ä»¥è®¤ä¸ºæ˜¯å¼‚æ­¥å‡½æ•°ã€‚

asyncå‡½æ•°æ˜¯ä¸€ç§ç‰¹æ®Šè¯­æ³•ï¼Œç‰¹å¾æ˜¯åœ¨functionå…³é”®å­—ä¹‹å‰åŠ ä¸Šasyncå…³é”®å­—ï¼Œè¿™æ ·ï¼Œå°±å®šä¹‰äº†ä¸€ä¸ªasyncå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­ä½¿ç”¨awaitæ¥ç­‰å¾…ä¸€ä¸ªPromiseã€‚

```
function sleep(duration) {
    return new Promise(function(resolve, reject) {
        setTimeout(resolve,duration);
    })
}
async function foo(){
    console.log("a")
    await sleep(2000)
    console.log("b")
}
```

è¿™æ®µä»£ç åˆ©ç”¨äº†æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„sleepå‡½æ•°ã€‚åœ¨å¼‚æ­¥å‡½æ•°fooä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨sleepã€‚

asyncå‡½æ•°å¼ºå¤§ä¹‹å¤„åœ¨äºï¼Œå®ƒæ˜¯å¯ä»¥åµŒå¥—çš„ã€‚æˆ‘ä»¬åœ¨å®šä¹‰äº†ä¸€æ‰¹åŸå­æ“ä½œçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åˆ©ç”¨asyncå‡½æ•°ç»„åˆå‡ºæ–°çš„asyncå‡½æ•°ã€‚

```
function sleep(duration) {
    return new Promise(function(resolve, reject) {
        setTimeout(resolve,duration);
    })
}
async function foo(name){
    await sleep(2000)
    console.log(name)
}
async function foo2(){
    await foo("a");
    await foo("b");
}
```

è¿™é‡Œfoo2ç”¨awaitè°ƒç”¨äº†ä¸¤æ¬¡å¼‚æ­¥å‡½æ•°fooï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæˆ‘ä»¬æŠŠsleepè¿™æ ·çš„å¼‚æ­¥æ“ä½œæ”¾å…¥æŸä¸€ä¸ªæ¡†æ¶æˆ–è€…åº“ä¸­ï¼Œä½¿ç”¨è€…å‡ ä¹ä¸éœ€è¦äº†è§£Promiseçš„æ¦‚å¿µå³å¯è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹äº†ã€‚

æ­¤å¤–ï¼Œgenerator/iteratorä¹Ÿå¸¸å¸¸è¢«è·Ÿå¼‚æ­¥ä¸€èµ·æ¥è®²ï¼Œæˆ‘ä»¬å¿…é¡»è¯´æ˜ generator/iterator å¹¶éå¼‚æ­¥ä»£ç ï¼Œåªæ˜¯åœ¨ç¼ºå°‘async/awaitçš„æ—¶å€™ï¼Œä¸€äº›æ¡†æ¶ï¼ˆæœ€è‘—åçš„è¦æ•°coï¼‰ä½¿ç”¨è¿™æ ·çš„ç‰¹æ€§æ¥æ¨¡æ‹Ÿasync/awaitã€‚

ä½†æ˜¯generatorå¹¶éè¢«è®¾è®¡æˆå®ç°å¼‚æ­¥ï¼Œæ‰€ä»¥æœ‰äº†async/awaitä¹‹åï¼Œgenerator/iteratoræ¥æ¨¡æ‹Ÿå¼‚æ­¥çš„æ–¹æ³•åº”è¯¥è¢«åºŸå¼ƒã€‚

## ç»“è¯­

åœ¨ä»Šå¤©çš„æ–‡ç« é‡Œï¼Œæˆ‘ä»¬å­¦ä¹ äº†JavaScriptæ‰§è¡Œéƒ¨åˆ†çš„çŸ¥è¯†ï¼Œé¦–å…ˆæˆ‘ä»¬å­¦ä¹ äº†JavaScriptçš„å®è§‚ä»»åŠ¡å’Œå¾®è§‚ä»»åŠ¡ç›¸å…³çš„çŸ¥è¯†ã€‚æˆ‘ä»¬æŠŠå®¿ä¸»å‘èµ·çš„ä»»åŠ¡ç§°ä¸ºå®è§‚ä»»åŠ¡ï¼ŒæŠŠJavaScriptå¼•æ“å‘èµ·çš„ä»»åŠ¡ç§°ä¸ºå¾®è§‚ä»»åŠ¡ã€‚è®¸å¤šçš„å¾®è§‚ä»»åŠ¡çš„é˜Ÿåˆ—ç»„æˆäº†å®è§‚ä»»åŠ¡ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å±•å¼€ä»‹ç»äº†ç”¨Promiseæ¥æ·»åŠ å¾®è§‚ä»»åŠ¡çš„æ–¹å¼ï¼Œå¹¶ä¸”ä»‹ç»äº†async/awaitè¿™ä¸ªè¯­æ³•çš„æ”¹è¿›ã€‚

æœ€åï¼Œç•™ç»™ä½ ä¸€ä¸ªå°ç»ƒä¹ ï¼šæˆ‘ä»¬ç°åœ¨è¦å®ç°ä¸€ä¸ªçº¢ç»¿ç¯ï¼ŒæŠŠä¸€ä¸ªåœ†å½¢divæŒ‰ç…§ç»¿è‰²3ç§’ï¼Œé»„è‰²1ç§’ï¼Œçº¢è‰²2ç§’å¾ªç¯æ”¹å˜èƒŒæ™¯è‰²ï¼Œä½ ä¼šæ€æ ·ç¼–å†™è¿™ä¸ªä»£ç å‘¢ï¼Ÿæ¬¢è¿ä½ ç•™è¨€è®¨è®ºã€‚
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ15ï¼‰</strong></div><ul>
<li><span>æ¨å­¦èŒ‚</span> ğŸ‘ï¼ˆ557ï¼‰ ğŸ’¬ï¼ˆ16ï¼‰<p>function sleep(duration){
    return new Promise(function(resolve){
        setTimeout(resolve, duration);
    })
}
async function changeColor(duration,color){
    document.getElementById(&quot;traffic-light&quot;).style.background = color;
    await sleep(duration);

}
async function main(){
    while(true){
        await changeColor(3000,&quot;green&quot;);
        await changeColor(1000, &quot;yellow&quot;);
        await changeColor(2000, &quot;red&quot;);
    }
}
main()</p>2019-02-23</li><br/><li><span>è´¹é©¬</span> ğŸ‘ï¼ˆ35ï¼‰ ğŸ’¬ï¼ˆ5ï¼‰<p>const lightEle = document.getElementById(&#39;traffic-light&#39;);
function changeTrafficLight(color, duration) {
  return new Promise(function(resolve, reject) {
    lightEle.style.background = color;
    setTimeout(resolve, duration);
  })
}

async function trafficScheduler() {
  await changeTrafficLight(&#39;green&#39;, 3000);
  await changeTrafficLight(&#39;yellow&#39;, 1000);
  await changeTrafficLight(&#39;red&#39;, 2000);
  trafficScheduler();
}

trafficScheduler();</p>2019-02-23</li><br/><li><span>deiphi</span> ğŸ‘ï¼ˆ33ï¼‰ ğŸ’¬ï¼ˆ8ï¼‰<p>&#47;&#47; æ¯”è¾ƒåŸå§‹çš„å†™æ³•
function color () { 
	console.log(&#39;green&#39;);
	
	setTimeout(() =&gt; {
			console.log(&#39;yellow&#39;);
			
			setTimeout(() =&gt; {
				console.log(&#39;red&#39;);
				
				setTimeout(color, 2000);
			}, 1000)
	}, 3000);
}
color();</p>2019-02-26</li><br/><li><span>è®¸å‰ä¸­</span> ğŸ‘ï¼ˆ13ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>async&#47;awaitå‡½æ•°å±äºå®è§‚è¿˜æ˜¯å¾®è§‚ï¼Ÿ</p>2019-02-24</li><br/><li><span>å¥¥æ–¯ç‰¹æ´›å¤«æ–¯åŸº</span> ğŸ‘ï¼ˆ12ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>åŒæ­¥çš„ä»£ç å’ŒsetTimeoutéƒ½æ˜¯å®ä»»åŠ¡ï¼Ÿ</p>2019-02-26</li><br/><li><span>å°å­”</span> ğŸ‘ï¼ˆ8ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>1. async&#47;await ï¼Œé‡åˆ°awaitæ—¶å°±ä¼šé€€å‡ºæ‰§è¡Œï¼Œæˆ‘æƒ³é—®ä¸‹ï¼Œé€€å‡ºä¹‹åæ˜¯å¤„äºç­‰å¾…awaitæ‰§è¡Œå®Œå†å¼€å§‹ä¹‹åå—ï¼Ÿ
2. å¦‚æœpromiseä¸­äº§ç”ŸsetTimeoutå‡½æ•°ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œçš„setTimeoutæ˜¯å¤„äºå¾®è§‚ä»»åŠ¡å¯¹å—ï¼Ÿå› ä¸ºè¿™æ˜¯jså¼•æ“ç›´æ¥å‘èµ·çš„ï¼Ÿ
</p>2019-04-09</li><br/><li><span>å‘¨åºçŒ¿</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>&#47;&#47; å¦ç±»çš„å†™æ³•
 var lightDiv = document.getElementById(&#39;light&#39;)
    function wait(seconds){
      return new Promise((resolve)=&gt;{
        setTimeout(resolve,seconds)
      })
    }

    function light(color, waitTime){
      this.color = color
      this.waitTime = waitTime
    }
    light.prototype.run = function(){
      lightDiv.style.backgroundColor = this.color
      return wait(this.waitTime).then(()=&gt;{
        return this.nextLight.run()
      })
    }

    let redLight = new light(&#39;red&#39;,2000)
    let yellowLight = new light(&#39;yellow&#39;,1000)
    let greenLight = new light(&#39;green&#39;,3000)

    redLight.nextLight = greenLight
    yellowLight.nextLight = redLight
    greenLight.nextLight = yellowLight

    redLight.run()</p>2019-02-26</li><br/><li><span>ä¸æ›¾æ½‡æ´’</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>è€å¸ˆä½ å¥½ï¼Œçœ‹äº†è¿™ç¯‡æ–‡ç« åå—ç›ŠåŒªæµ…ï¼Œæœ‰ä¸ªå°é—®é¢˜:
åœ¨Promiseæ®µçš„æœ€åä¸€ä¸ªä¾‹å­ä¸­ï¼Œæœ€åä¸€å¥ä»£ç :
sleep(5000).then(()=&gt;{console.log(&#39;c&#39;)})ï¼Œ
è¿™é‡Œé¢çš„æ‰“å°cæ˜¯å±äºç¬¬ä¸€ä¸ªå®ä»»åŠ¡è¿˜æ˜¯å±äºsetTimeäº§ç”Ÿçš„ç¬¬äºŒä¸ªå®ä»»åŠ¡å‘¢?</p>2019-02-23</li><br/><li><span>è®¸ç«¥ç«¥</span> ğŸ‘ï¼ˆ4ï¼‰ ğŸ’¬ï¼ˆ6ï¼‰<p>async function controlLoop () {
  await changeColor(&#39;green&#39;, 3000)
  await changeColor(&#39;yellow&#39;, 1000)
  await changeColor(&#39;red&#39;, 2000)
  await controlLoop()
}

async function changeColor (color, time) {
  console.log(color + &#39; begin&#39;)
  return new Promise((resolve) =&gt; {
    setTimeout(() =&gt; {
      console.log(color + &#39; end&#39;)
      resolve()
    }, time)
  })
}

controlLoop()</p>2019-02-23</li><br/><li><span>ğŸ‡¨ğŸ‡³ğŸ‡¨ğŸ‡³ğŸ‡¨ğŸ‡³</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ2ï¼‰<p>async&#47;awiat åªæ˜¯generator&#47;iteratorçš„è¯­æ³•ç³–è€Œå·²</p>2019-07-08</li><br/><li><span>å¤§åŠ›</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç”¨äº†async, awaitåè²Œä¼¼å®è§‚ä¸å¾®è§‚ä»»åŠ¡åˆ†å¾—æ²¡é‚£ä¹ˆæ¸…æ™°äº†ã€‚</p>2019-06-18</li><br/><li><span>Geek_e21f0d</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>let lightStates = [{
        color: &#39;green&#39;,
        duration: 3000
    },
    {
        color: &#39;yellow&#39;,
        duration: 1000
    },
    {
        color: &#39;red&#39;,
        duration: 2000
    }];
    let setLightColorAndVisibleDuration = function(color, duration) {
        &#47;&#47;set light color
        return new Promise((resolve) =&gt; {
            setTimeout(() =&gt; {
                resolve();
            }, duration);
        });
    }
    let startShowLight = async function() {
        let index = 0;
        while(index &lt;= lightStates.length - 1) {
            let nextState = lightStates[index];
            await setLightColorAndVisibleDuration(nextState.color, nextState.duration);
            index++;
        }
        
    };
    startShowLight();</p>2019-02-26</li><br/><li><span>NeverEver</span> ğŸ‘ï¼ˆ3ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>æˆ‘æƒ³åˆ°çš„æ–¹æ³•æ˜¯ç”¨Recursionã€‚å†™ä¸€ä¸ªå‡½æ•°setColorï¼Œéœ€è¦ä¸€ä¸ªå‚æ•°colorï¼Œå‡½æ•°é‡Œé¦–å…ˆæŠŠdivçš„backgroundColorè®¾ç½®colorï¼Œç„¶åç”¨setTimeoutæ¥è®¾ç½®ä¸‹ä¸€ä¸ªé¢œè‰²ï¼Œæ ¹æ®ä¼ å…¥çš„colorç›¸åº”æ›´æ”¹æ—¶é—´å’Œé¢œè‰²å³å¯</p>2019-02-23</li><br/><li><span>Geek_55d7cf</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>é™¤äº†setTimeoutè¿˜æœ‰å“ªäº›å®è§‚ä»»åŠ¡å‘¢ï¼Ÿ
</p>2019-04-05</li><br/><li><span>é˜¿æˆ</span> ğŸ‘ï¼ˆ2ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>ç•¥ç®€é™‹...
&#47;&#47; sleep,green,red,yellow already defined
async function main () {
  while (true) {
    green()
    await sleep(3)
    yellow ()
    await sleep (1)
    red()
    await sleep(2)
  }
}
main()</p>2019-02-23</li><br/>
</ul>