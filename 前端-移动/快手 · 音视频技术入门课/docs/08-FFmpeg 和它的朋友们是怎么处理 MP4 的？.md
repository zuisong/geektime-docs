ä½ å¥½ï¼Œæˆ‘æ˜¯åˆ˜æ­§ã€‚

æˆ‘ä»¬æ—¥å¸¸çœ‹ç”µè§†å‰§ï¼Œå½•è§†é¢‘æ—¶ï¼Œæœ€å¸¸è§çš„å°±æ˜¯MP4æ ¼å¼äº†ã€‚ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ï¼ŒMP4æ ¼å¼ä¸ºä»€ä¹ˆä½¿ç”¨å¾—è¿™ä¹ˆå¹¿æ³›å‘¢ï¼Ÿ

å› ä¸ºMP4æ ‡å‡†éå¸¸çµæ´»ï¼Œå¯æ‰©å±•æ€§æ¯”è¾ƒå¥½ï¼Œæœ‰å¾ˆå¤šå¸¸è§çš„æ ¼å¼æ˜¯åŸºäºMP4åšäº†ä¸€äº›æ‰©å±•ï¼Œç„¶åè¢«åº”ç”¨åˆ°æ¯”è¾ƒå¹¿çš„èŒƒå›´ï¼Œæ¯”å¦‚CMAFã€DASHã€HLSã€‚è€Œä¸”MP4çš„å‚è€ƒæ ‡å‡†æ˜¯ä¸€ä¸ªå¼€æ”¾çš„æ ‡å‡†ï¼Œæˆ‘ä»¬é€šå¸¸ä»¥ç¼–å·ä¸ºISO-14496-12æ¥æŸ¥æ‰¾æ ‡å‡†æ–‡æ¡£ã€‚å› ä¸ºMP4çš„ä½¿ç”¨èŒƒå›´æ¯”è¾ƒå¹¿ï¼Œæˆ‘ä»¬åœ¨[ç¬¬3èŠ‚è¯¾](https://time.geekbang.org/column/article/544986)çš„æ—¶å€™ï¼Œä¹Ÿç€é‡è®²äº†MP4å°è£…å®¹å™¨æ ¼å¼ï¼Œä½ å¯ä»¥å›é¡¾ä¸€ä¸‹ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/68/6b/689b8f155c2ed9yy6dbb007fa474586b.png?wh=1920x1083 "MP4æ‰©å±•å‡ºæ¥çš„æ ¼å¼")

åŸºäºMP4çš„é‡è¦åœ°ä½ï¼Œæˆ‘è¿™èŠ‚è¯¾æ¥ç»™ä½ è®²ä¸€è®²ï¼Œå¦‚ä½•ç”¨FFmpegã€GPACç­‰å·¥å…·ç”Ÿæˆä¸è§£æMP4ã€‚

å°½ç®¡FFmpegçš„ç›®æ ‡æ˜¯è‡ªå·±ä¸å»åˆ›é€ æ ‡å‡†ï¼Œä½†æ˜¯éš¾å…ä¼šæœ‰ä¸€äº›å·¥å…·æˆ–è€…ç”¨æˆ·ä¼šæ ¹æ®è‡ªå·±çš„è‡†æµ‹åšä¸€äº›å®šåˆ¶æˆ–è€…ä¿®æ”¹ï¼Œå¯¼è‡´ä¸æˆ‘ä»¬å…¬è®¤çš„æ ‡å‡†å‡ºç°ä¸€äº›åå·®ã€‚ä¸ºäº†è®©MP4çš„æ ‡å‡†æ€§æ›´å¥½åœ°å¾—åˆ°éªŒè¯ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šé€‰æ‹©ä½¿ç”¨å¤šç§å·¥å…·ï¼Œæ‰€ä»¥è¿™èŠ‚è¯¾é™¤äº†ç»™ä½ ä»‹ç»FFmpegå¯¹MP4çš„muxä¸demuxï¼ˆå°è£…ä¸è§£å°è£…ï¼‰ä¹‹å¤–ï¼Œæˆ‘è¿˜ä¼šä»‹ç»ä¸€äº›å…¶ä»–çš„MP4ç›¸å…³çš„å·¥å…·ï¼Œä¾‹å¦‚MP4Boxã€Shaka- Packagerã€‚

åœ¨æˆ‘ä»¬ä½¿ç”¨FFmpegåšéŸ³è§†é¢‘å¤„ç†çš„æ—¶å€™ï¼Œç»å¸¸ä¼šä½¿ç”¨FFmpegç”ŸæˆMP4æ–‡ä»¶ï¼Œæˆ–è€…ä½¿ç”¨FFmpegè¾“å…¥MP4æ–‡ä»¶ç„¶åè½¬æ¢æˆå…¶ä»–æ ¼å¼ã€‚è¿™é‡Œæˆ‘ä»¬å°±å…ˆæ¥äº†è§£ä¸€ä¸‹FFmpegå¯¹MP4éƒ½æœ‰å“ªäº›èƒ½åŠ›æ”¯æŒã€‚è¿™å°±éœ€è¦ç”¨åˆ°[ä¸ŠèŠ‚è¯¾](https://time.geekbang.org/column/article/548420)çš„çŸ¥è¯†äº†ï¼Œä½ å¯ä»¥åœä¸‹æ¥å…ˆæƒ³ä¸€ä¸‹æˆ‘ä»¬åº”è¯¥æ€ä¹ˆåœ¨FFmpegä¸­æŸ¥æ‰¾è‡ªå·±æƒ³è¦çš„å¸®åŠ©ä¿¡æ¯ã€‚

### ç”¨FFmpegç”ŸæˆMP4æ–‡ä»¶

é¦–å…ˆï¼ŒæŸ¥çœ‹MP4çš„muxerå¯¹åº”çš„å‚æ•°ï¼Œè¾“å…¥ffmpeg -h muxer=mp4ï¼Œçœ‹ä¸€ä¸‹è¾“å‡ºçš„å†…å®¹ã€‚

```plain
Muxer mp4 [MP4 (MPEG-4 Part 14)]:
    Common extensions: mp4.
    Mime type: video/mp4.
    Default video codec: h264.
    Default audio codec: aac.
mov/mp4/tgp/psp/tg2/ipod/ismv/f4v muxer AVOptions:
  -movflags          <flags>      E.......... MOV muxer flags (default 0)
     rtphint                      E.......... Add RTP hint tracks
     empty_moov                   E.......... Make the initial moov atom empty
     frag_keyframe                E.......... Fragment at video keyframes
     frag_every_frame              E.......... Fragment at every frame
     separate_moof                E.......... Write separate moof/mdat atoms for each track
     frag_custom                  E.......... Flush fragments on caller requests
     isml                         E.......... Create a live smooth streaming feed (for pushing to a publishing point)
     faststart                    E.......... Run a second pass to put the index (moov atom) at the beginning of the file
     omit_tfhd_offset              E.......... Omit the base data offset in tfhd atoms
     disable_chpl                 E.......... Disable Nero chapter atom
     default_base_moof              E.......... Set the default-base-is-moof flag in tfhd atoms
     dash                         E.......... Write DASH compatible fragmented MP4
     cmaf                         E.......... Write CMAF compatible fragmented MP4
     frag_discont                 E.......... Signal that the next fragment is discontinuous from earlier ones
     delay_moov                   E.......... Delay writing the initial moov until the first fragment is cut, or until the first fragment flush
     global_sidx                  E.......... Write a global sidx index at the start of the file
     skip_sidx                    E.......... Skip writing of sidx atom
     write_colr                   E.......... Write colr atom even if the color info is unspecified (Experimental, may be renamed or changed, do not use from scripts)
     prefer_icc                   E.......... If writing colr atom prioritise usage of ICC profile if it exists in stream packet side data
     write_gama                   E.......... Write deprecated gama atom
     use_metadata_tags              E.......... Use mdta atom for metadata.
     skip_trailer                 E.......... Skip writing the mfra/tfra/mfro trailer for fragmented files
     negative_cts_offsets              E.......... Use negative CTS offsets (reducing the need for edit lists)
  -moov_size         <int>        E.......... maximum moov size so it can be placed at the begin (from 0 to INT_MAX) (default 0)
  -rtpflags          <flags>      E.......... RTP muxer flags (default 0)
     latm                         E.......... Use MP4A-LATM packetization instead of MPEG4-GENERIC for AAC
     rfc2190                      E.......... Use RFC 2190 packetization instead of RFC 4629 for H.263
     skip_rtcp                    E.......... Don't send RTCP sender reports
     h264_mode0                   E.......... Use mode 0 for H.264 in RTP
     send_bye                     E.......... Send RTCP BYE packets when finishing
  -skip_iods         <boolean>    E.......... Skip writing iods atom. (default true)
  -iods_audio_profile <int>        E.......... iods audio profile atom. (from -1 to 255) (default -1)
  -iods_video_profile <int>        E.......... iods video profile atom. (from -1 to 255) (default -1)
  -frag_duration     <int>        E.......... Maximum fragment duration (from 0 to INT_MAX) (default 0)
  -min_frag_duration <int>        E.......... Minimum fragment duration (from 0 to INT_MAX) (default 0)
  -frag_size         <int>        E.......... Maximum fragment size (from 0 to INT_MAX) (default 0)
  -ism_lookahead     <int>        E.......... Number of lookahead entries for ISM files (from 0 to 255) (default 0)
  -video_track_timescale <int>        E.......... set timescale of all video tracks (from 0 to INT_MAX) (default 0)
  -brand             <string>     E.......... Override major brand
  -use_editlist      <boolean>    E.......... use edit list (default auto)
  -fragment_index    <int>        E.......... Fragment number of the next fragment (from 1 to INT_MAX) (default 1)
  -mov_gamma         <float>      E.......... gamma value for gama atom (from 0 to 10) (default 0)
  -frag_interleave   <int>        E.......... Interleave samples within fragments (max number of consecutive samples, lower is tighter interleaving, but with more overhead) (from 0 to INT_MAX) (default 0)
  -encryption_scheme <string>     E.......... Configures the encryption scheme, allowed values are none, cenc-aes-ctr
  -encryption_key    <binary>     E.......... The media encryption key (hex)
  -encryption_kid    <binary>     E.......... The media encryption key identifier (hex)
  -use_stream_ids_as_track_ids <boolean>    E.......... use stream ids as track ids (default false)
  -write_btrt        <boolean>    E.......... force or disable writing btrt (default auto)
  -write_tmcd        <boolean>    E.......... force or disable writing tmcd (default auto)
  -write_prft        <int>        E.......... Write producer reference time box with specified time source (from 0 to 2) (default 0)
     wallclock       1            E..........
     pts             2            E..........
  -empty_hdlr_name   <boolean>    E.......... write zero-length name string in hdlr atoms within mdia and minf atoms (default false)
  -movie_timescale   <int>        E.......... set movie timescale (from 1 to INT_MAX) (default 1000)
```

å°±åƒå¼€å¤´æˆ‘è¯´çš„é‚£æ ·ï¼Œå› ä¸ºMP4çš„çµæ´»æ€§æ¯”è¾ƒå¥½ï¼Œå˜ç§å½¢æ€ä¹Ÿæ¯”è¾ƒå¤šï¼Œä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼ŒFFmpegå°±å¢åŠ äº†å¾ˆå¤šç¬¦åˆæ ‡å‡†ä½†åˆæœ‰å¯èƒ½ç”¨ä¸åˆ°çš„å‚æ•°ï¼Œæˆ‘ä»¬ä¸€ä¼šå„¿æŠ½å–ä¸€äº›ä¾‹å­æ¥è®²è®²ã€‚

åœ¨è®²ä¾‹å­ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªå¸®åŠ©ä¿¡æ¯é‡Œé¢çš„å†…å®¹ï¼Œå¸®åŠ©ä¿¡æ¯çš„å¤´éƒ¨ç»™å‡ºäº†MP4çš„æ–‡ä»¶æ‰©å±•å.mp4ï¼Œè§†é¢‘é»˜è®¤ç”¨H.264ç¼–ç ï¼ŒéŸ³é¢‘é»˜è®¤ç”¨AACç¼–ç ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹FFmpegå°è£…MP4å¸¸ç”¨çš„å‚æ•°æœ‰å“ªäº›ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/47/a2/4788f2d19294d9f4b036bf0ed8042aa2.png?wh=2069x2864)

ä»å‚æ•°çš„åˆ—è¡¨ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒMP4çš„muxeræ”¯æŒçš„å‚æ•°æ¯”è¾ƒå¤æ‚ï¼Œä¾‹å¦‚æ”¯æŒåœ¨è§†é¢‘å…³é”®å¸§å¤„åˆ‡ç‰‡ã€æ”¯æŒè®¾ç½®moovå®¹å™¨çš„æœ€å¤§å¤§å°ã€æ”¯æŒè®¾ç½®encryptåŠ å¯†ç­‰ã€‚ä¸‹é¢æˆ‘ä»¬ç”¨å¸¸è§çš„å‚æ•°æ¥ä¸¾å‡ ä¸ªä¾‹å­ã€‚

### faststartå‚æ•°

æ­£å¸¸æƒ…å†µä¸‹ï¼ŒFFmpegç”Ÿæˆmoovæ˜¯åœ¨mdatå†™å®Œæˆä¹‹åï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡å‚æ•°faststartæŠŠmoovå®¹å™¨ç§»åŠ¨åˆ°mdatå‰é¢ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒä¸‹é¢è¿™ä¸ªä¾‹å­ã€‚

```plain
./ffmpeg -i input.flv -c copy -f mp4 output.mp4
```

ä½¿ç”¨mp4infoæŸ¥çœ‹output.mp4çš„å®¹å™¨å‡ºç°é¡ºåºã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/59/bf/59b0386632994a0d4bba6yy7f7d958bf.png?wh=1728x1250)

å¯ä»¥çœ‹åˆ°å›¾ä¸­moovå®¹å™¨æ˜¯åœ¨mdatçš„ä¸‹è¾¹ï¼Œå¦‚æœä½¿ç”¨å‚æ•°faststartï¼Œå°±ä¼šåœ¨ç”Ÿæˆä¸Šè¾¹çš„ç»“æ„ä¹‹åå°†moovç§»åŠ¨åˆ°mdatå‰é¢ã€‚

```plain
./ffmpeg -i input.flv -c copy -f mp4 -movflags faststart output.mp4
```

ç„¶åæˆ‘ä»¬å†ä½¿ç”¨mp4infoæŸ¥çœ‹MP4çš„å®¹å™¨é¡ºåºï¼Œå¯ä»¥çœ‹åˆ°moovè¢«ç§»åŠ¨åˆ°äº†mdatå‰é¢ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/c9/94/c9bcd9d90d3a4b2d41e6472d52a3de94.png?wh=1728x1250)

### DASHå‚æ•°

å½“ç”ŸæˆDASHæ ¼å¼çš„æ—¶å€™ï¼Œé‡Œé¢æœ‰ä¸€ç§ç‰¹æ®Šçš„MP4æ ¼å¼ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠå®ƒç†è§£æˆMP4åˆ‡ç‰‡ï¼Œå¯ä»¥é€šè¿‡DASHå‚æ•°ç”Ÿæˆã€‚

```plain
./ffmpeg -i input.flv -c copy -f mp4 -movflags dash output.mp4
```

ä½¿ç”¨mp4infoæŸ¥çœ‹å®¹å™¨æ ¼å¼çš„ä¿¡æ¯ï¼Œç¨å¾®æœ‰äº›ç‰¹æ®Šï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å›¾ç‰‡ã€‚  
![å›¾ç‰‡](https://static001.geekbang.org/resource/image/db/ed/db6ef849yya8855082932af6807e50ed.png?wh=1728x1254)

ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªDASHæ ¼å¼çš„MP4æ–‡ä»¶å­˜å‚¨çš„å®¹å™¨ä¿¡æ¯ä¸å¸¸è§„çš„MP4æ ¼å¼æœ‰äº›å·®åˆ«ï¼Œä»¥sidxã€moofä¸mdatè¿™ä¸‰ç§å®¹å™¨ä¸ºä¸»ã€‚

æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨åšMP4åˆ‡ç‰‡æ“ä½œçš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚ï¼Œeditlistçš„æ—¶é—´æˆ³ç›¸å…³è®¡ç®—å˜é‡ä¸å®é™…æ•°æ®å¯¹åº”çš„æ—¶é—´æˆ³æœ‰åå·®ï¼Œå¯¼è‡´è§†é¢‘ä¸¢å¸§æˆ–éŸ³ç”»ç•¥æœ‰ä¸åŒæ­¥çš„ç°è±¡ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥è€ƒè™‘æŠŠuse\_edilistæ“ä½œé¡¹è®¾ç½®æˆå¿½ç•¥ã€‚

**MP4åˆ‡ç‰‡å¾ˆå¸¸ç”¨ï¼Œå½“æˆ‘ä»¬åšHLS/DASHç›´æ’­ã€ç”Ÿæˆç‚¹æ’­å†…å®¹ï¼Œè¿˜æœ‰åšMP4ä¸Šä¼ äº‘ç«¯å®æ—¶è½¬ç ç­‰æ“ä½œæ—¶ï¼ŒMP4åˆ‡ç‰‡éƒ½æ˜¯æ¯”è¾ƒå¸¸è§çš„æ“ä½œã€‚**

é€šè¿‡è¿™äº›ä¾‹å­ï¼Œç›¸ä¿¡ä½ å·²ç»å¯¹MP4ç”Ÿæˆéƒ¨åˆ†çš„èƒ½åŠ›æœ‰ä¸€äº›äº†è§£äº†ï¼Œå‰©ä½™çš„èƒ½åŠ›æˆ‘ä»¬å¯ä»¥è¯¾åè‡ªå·±ä¸€ç‚¹ç‚¹æŒ–æ˜ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹FFmpegçš„MP4æ–‡ä»¶è§£ææ“ä½œã€‚

### ç”¨FFmpegè§£æMP4æ–‡ä»¶

é¦–å…ˆFFmpegåœ¨è§£æMP4æ–‡ä»¶æ ¼å¼çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå› ä¸ºMP4çš„å†…å®¹ç”Ÿæˆå¾—ä¸æ ‡å‡†äº§ç”Ÿä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ï¼Œä¾‹å¦‚å‰é¢æˆ‘ä»¬æåˆ°çš„éŸ³è§†é¢‘ä¸åŒæ­¥æˆ–è€…è§†é¢‘æŠ–åŠ¨ç­‰é—®é¢˜ã€‚FFmpegé’ˆå¯¹å‡ºç°çš„è¿™ç±»é—®é¢˜ä¹Ÿåšäº†æ ¼å¼ä¸Šçš„å…¼å®¹ï¼Œä½†ç”¨æˆ·å¯èƒ½éœ€è¦è‡ªå·±æ‰‹åŠ¨è®¾ç½®ä¸€äº›å‚æ•°ï¼Œå®šåˆ¶ä¸€ä¸‹ï¼Œæ‰å¯ä»¥è§£å†³è¿™äº›é—®é¢˜ã€‚

FFmpegè¿™ä¹ˆåšçš„ä¸»è¦åŸå› æ˜¯ä¹‹å‰å¤§éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨æ—¶æ˜¯æ­£å¸¸çš„ï¼Œå¼‚å¸¸ç´ æåªæœ‰å°‘éƒ¨åˆ†ç”¨æˆ·æ‰ä¼šé‡åˆ°ã€‚ä¸ºäº†å°½é‡ä¸æ”¹å˜åŸæœ‰ç”¨æˆ·çš„ä½¿ç”¨ä¹ æƒ¯ï¼Œåªèƒ½é€šè¿‡æ–°ç”¨æˆ·è‡ªå·±è®¾ç½®å‚æ•°çš„å½¢å¼æ¥é¿å…å‡ºç°å¼‚å¸¸æƒ…å†µã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹æ“ä½œé€‰é¡¹ã€‚

```plain
Demuxer mov,mp4,m4a,3gp,3g2,mj2 [QuickTime / MOV]:
    Common extensions: mov,mp4,m4a,3gp,3g2,mj2,psp,m4b,ism,ismv,isma,f4v,avif.
mov,mp4,m4a,3gp,3g2,mj2 AVOptions:
  -use_absolute_path <boolean>    .D.V....... allow using absolute path when opening alias, this is a possible security issue (default false)
  -seek_streams_individually <boolean>    .D.V....... Seek each stream individually to the closest point (default true)
  -ignore_editlist   <boolean>    .D.V....... Ignore the edit list atom. (default false)
  -advanced_editlist <boolean>    .D.V....... Modify the AVIndex according to the editlists. Use this option to decode in the order specified by the edits. (default true)
  -ignore_chapters   <boolean>    .D.V.......  (default false)
  -use_mfra_for      <int>        .D.V....... use mfra for fragment timestamps (from -1 to 2) (default auto)
     auto            -1           .D.V....... auto
     dts             1            .D.V....... dts
     pts             2            .D.V....... pts
  -use_tfdt          <boolean>    .D.V....... use tfdt for fragment timestamps (default true)
  -export_all        <boolean>    .D.V....... Export unrecognized metadata entries (default false)
  -export_xmp        <boolean>    .D.V....... Export full XMP metadata (default false)
  -activation_bytes  <binary>     .D......... Secret bytes for Audible AAX files
  -audible_key       <binary>     .D......... AES-128 Key for Audible AAXC files
  -audible_iv        <binary>     .D......... AES-128 IV for Audible AAXC files
  -audible_fixed_key <binary>     .D......... Fixed key used for handling Audible AAX files
  -decryption_key    <binary>     .D......... The media decryption key (hex)
  -enable_drefs      <boolean>    .D.V....... Enable external track support. (default false)
  -max_stts_delta    <int>        .D......... treat offsets above this value as invalid (from 0 to UINT32_MAX) (default 4294487295)
```

ä»å†…å®¹ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒFFmpegçš„MP4 demuxeré‡Œæä¾›äº†editlistç›¸å…³çš„ä¸€äº›æ“ä½œï¼Œæ¯”å¦‚ignore\_editlistã€-use\_tfdtç­‰ã€‚MP4åˆ‡ç‰‡æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°åˆ‡ç‰‡çš„æ—¶é—´æˆ³ä¸editlistå‚è€ƒè®¡ç®—å‡ºæ¥çš„æ—¶é—´æˆ³å¯¹ä¸ä¸Šçš„é—®é¢˜ï¼Œç”¨æˆ·å°±å¯ä»¥ä½¿ç”¨-use\_tfdté€‰é¡¹ï¼Œæ¥é€‰æ‹©æ˜¯å¦ä½¿ç”¨tfdté‡Œé¢çš„æ—¶é—´æˆ³ã€‚

FFmpegä¸ºä»€ä¹ˆä¼šç»™MP4çš„demuxeråŠ è¿™ä¹ˆå¤šå…¼å®¹æ€§çš„å‚æ•°å‘¢ï¼Ÿ

å› ä¸ºå¯ä»¥ç”Ÿæˆå’Œå¤„ç†MP4æ–‡ä»¶çš„å·¥å…·ä¸æ­¢FFmpegï¼Œè¿˜æœ‰å…¶ä»–çš„å·¥å…·ï¼Œä¾‹å¦‚GPACã€Shaka-Packagerã€‚å·¥å…·å¤šäº†ï¼Œç”Ÿæˆå‡ºæ¥çš„MP4æ–‡ä»¶å¯èƒ½ä¸ç»Ÿä¸€ï¼Œå­˜åœ¨ä¸€å®šçš„å·®å¼‚ï¼Œè¿™ä¸ªå·®å¼‚å°±å¯èƒ½å¼•èµ·å…¼å®¹æ€§é—®é¢˜ã€‚

## å¦‚ä½•ç”¨GPACç”ŸæˆMP4ï¼Ÿ

å…¶å®è¦è¯´ç”ŸæˆMP4æ›´æ¥è¿‘å‚è€ƒæ ‡å‡†çš„ï¼Œå°±è¦æ•°GPACäº†ï¼Œå¯èƒ½ä½ ä¹‹å‰å¹¶æ²¡æœ‰å¬è¯´è¿‡GPACï¼Œä½†æ˜¯GPACé‡Œçš„MP4Boxå·¥å…·ä½ åº”è¯¥å¬è¯´è¿‡ã€‚ä¸‹é¢æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹MP4Boxã€‚å’Œä½¿ç”¨FFmpegç±»ä¼¼ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹helpä¿¡æ¯ã€‚

```plain
MP4Box --help
```

è¿™æ˜¯è¾“å‡ºçš„å†…å®¹ã€‚

```plain
MP4Box [option] input [option]



General Options:

-h (string):                   print help
	* general: general options help
	* hint: hinting options help
	* dash: DASH segmenter help
	* import: import options help
	* encode: encode options help
	* meta: meta handling options help
	* extract: extraction options help
	* dump: dump options help
	* swf: Flash (SWF) options help
	* crypt: ISMA E&A options help
	* format: supported formats help
	* live: BIFS streamer help
	* core: libgpac core options
	* all: print all the above help screens
	* opts: print all options
	* VAL: search for option named VAL (without - or --) in MP4Box, libgpac core and all filters

-hx (string):                  look for given string in all possible options
-nodes:                        list supported MPEG4 nodes
-node (string):                get given MPEG4 node syntax and QP infolist
-xnodes:                       list supported X3D nodes
-xnode (string):               get given X3D node syntax
-snodes:                       list supported SVG nodes
-languages:                    list supported ISO 639 languages
-boxes:                        list all supported ISOBMF boxes and their syntax
-fstat:                        print filter session statistics (import/export/encrypt/decrypt/dashing)
-fgraph:                       print filter session graph (import/export/encrypt/decrypt/dashing)
-v:                            verbose mode
-version:                      get build version
---  INPUT:                    escape option if INPUT starts with - character
```

å¸®åŠ©ä¿¡æ¯é‡Œæœ‰æ›´è¯¦ç»†çš„å‚æ•°å¸®åŠ©ä¿¡æ¯ï¼Œä½¿ç”¨-håŠ å¯¹åº”çš„å‚æ•°å°±å¯ä»¥å¾—åˆ°ï¼Œä¾‹å¦‚MP4Box -h dashï¼Œå°±å¯ä»¥æŸ¥çœ‹dashåˆ‡ç‰‡å¸®åŠ©ä¿¡æ¯äº†ã€‚

æˆ‘ä»¬ä½¿ç”¨ MP4BoxæŸ¥çœ‹ä¸€ä¸‹MP4æ–‡ä»¶ä¿¡æ¯ã€‚

```plain
# MP4Box -info ~/Movies/Test/ToS-4k-1920.mov

* Movie Info *
	Timescale 1000 - 2 tracks
	Computed Duration 00:12:14.167 - Indicated Duration 00:12:14.167
	Fragmented File: no
	File Brand qt   - version 512
		Compatible brands: qt
	Created: UNKNOWN DATE	Modified: UNKNOWN DATE
File has no MPEG4 IOD/OD
1 UDTA types: A9737772 (1)

Track # 1 Info - TrackID 1 - TimeScale 24
Media Duration 00:12:14.166 - Indicated Duration 00:12:14.166
Track has 1 edit lists: track duration is 00:12:14.167
Media Info: Language "Undetermined (und)" - Type "vide:avc1" - 17620 samples
Visual Sample Entry Info: width=1920 height=800 (depth=24 bits)
Visual Track layout: x=0 y=0 width=1920 height=800
MPEG-4 Config: Visual Stream - ObjectTypeIndication 0x21
AVC/H264 Video - Visual Size 1920 x 800
	AVC Info: 1 SPS - 1 PPS - Profile High @ Level 4
	NAL Unit length bits: 32
	Pixel Aspect Ratio 1:1 - Indicated track size 1920 x 800
	Chroma format YUV 4:2:0 - Luma bit depth 8 - chroma bit depth 8
	SPS#1 hash: DEC7C9D830854068543D5AE5BC84AA68081EC57C
	PPS#1 hash: 12874FF8439E10C45D6C9B519B94BDAADC9759BD
Self-synchronized
	RFC6381 Codec Parameters: avc1.640028
	Average GOP length: 17 samples
	Max sample duration: 1 / 24

Track # 2 Info - TrackID 2 - TimeScale 44100
Media Duration 00:12:14.122 - Indicated Duration 00:12:14.122
Track has 1 edit lists: track duration is 00:12:14.123
Media Info: Language "Undetermined (und)" - Type "soun:mp4a" - 31616 samples
MPEG-4 Config: Audio Stream - ObjectTypeIndication 0x40
MPEG-4 Audio AAC LC (AOT=2 implicit) - 2 Channel(s) - SampleRate 44100
Synchronized on stream 1
	RFC6381 Codec Parameters: mp4a.40.2
Alternate Group ID 1
	All samples are sync
	Max sample duration: 1024 / 44100
```

å…¶å®ä»å¸®åŠ©ä¿¡æ¯ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒMP4Boxä¹Ÿå¯ä»¥åˆ‡DASHå’ŒHLSï¼Œé™¤äº†MP4Boxï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°è¯•ä½¿ç”¨Shaka-Packageræ¥åšå¯¹åº”çš„æ“ä½œã€‚

## Shaka-Packagerçš„HLSä¸DASH

Shaka-Packageræ˜¯Googleçš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œé™¤äº†ç”¨FFmpegå’ŒGPACåšHLSã€DASHä¹‹å¤–ï¼Œç”¨Shaka-Packagerå…¶å®ä¹Ÿæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œæˆ‘ä»¬ç¨å¾®äº†è§£ä¸€ä¸‹ã€‚

ä¾‹å¦‚ï¼Œç”¨Shaka-Packageråšä¸€ä¸ªHLSè§†é¢‘æµåŠ å¯†æ“ä½œã€‚

```plain
packager 'input=../in.mp4,stream=video,segment_template=output$Number$.m4s,playlist_name=video_playlist.m3u8,init_segment=init.mp4'
--hls_master_playlist_output="master_playlist.m3u8"
--hls_base_url="http://127.0.0.1/" --enable_raw_key_encryption
--protection_scheme cbcs --keys
key=61616161616161616161616161616161:key_id=61616161616161616161616161616161
--clear_lead 0
```

è¿™æ ·å°±å¯ä»¥é€šè¿‡Shaka-Packagerç”Ÿæˆä¸€ä¸ªDRMçš„HLSäº†ï¼Œè¾“å…¥ä¸€ä¸ªMP4æ–‡ä»¶ï¼Œè§†é¢‘æµè¾“å‡ºm4sï¼Œåˆ—è¡¨åä¸ºvideo\_playlist.m3u8ï¼Œmp4åˆ‡ç‰‡çš„åˆå§‹æ–‡ä»¶åä¸ºinit.mp4ï¼Œmasteråˆ—è¡¨åä¸ºmaster\_playlist.m3u8ï¼Œä½¿ç”¨raw\_keyæ–¹å¼åŠ å¯†å†…å®¹ï¼ŒåŠ å¯†ä¿æŠ¤æ¨¡å¼ä¸ºcbcsæ¨¡å¼ï¼Œå¯†é’¥æ˜¯61616161616161616161616161616161ï¼Œåˆ‡ç‰‡çš„initä¹‹åçš„ç¬¬ä¸€ä¸ªMP4åˆ‡ç‰‡æ–‡ä»¶ä¸åŠ å¯†ï¼Œä»ç¬¬äºŒç‰‡å¼€å§‹åŠ å¯†ã€‚

Shaka-Packagerä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„é¡¹ç›®ï¼Œæ›´å¤šçš„èƒ½åŠ›éœ€è¦ä½ è‡ªå·±æ…¢æ…¢å»æŒ–æ˜ã€‚[Shaka-Packagerå®˜æ–¹æ–‡æ¡£](https://shaka-project.github.io/shaka-packager/html/)çš„å†…å®¹ä¹Ÿæ¯”è¾ƒå…¨ï¼Œä½ å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚

æ€»çš„æ¥è¯´ï¼ŒShaka-Packagerå’ŒGPACæ¯”FFmpegè¦ç®€å•å¾—å¤šï¼Œä½¿ç”¨çš„APIæ“ä½œä¹Ÿæ¯”è¾ƒå®¹æ˜“ï¼Œæ‰€ä»¥å¦‚æœä¸æ˜¯å¤šæ ¼å¼ã€å¤šcodecï¼Œå¯¹å…¼å®¹æ€§è¦æ±‚ä¸é«˜ä¸”éŸ³è§†é¢‘åº”ç”¨åœºæ™¯ç®€å•çš„è¯ï¼ŒShaka-Packagerå’ŒGPACä¹Ÿæ˜¯ä¸é”™çš„é€‰æ‹©ã€‚

## å°ç»“

MP4æ ¼å¼å› å…¶å¼€æ”¾æ€§å’Œçµæ´»æ€§ï¼Œä½¿ç”¨èŒƒå›´éå¸¸å¹¿æ³›ï¼Œç”¨MP4åšåˆ‡ç‰‡åå¯ä»¥å°è£…æˆHLSæˆ–è€…DASHåšåˆ†å‘ï¼Œæ—¥å¸¸çš„ä½¿ç”¨é¢‘ç‡æ˜¯æ¯”è¾ƒé«˜çš„ã€‚å› æ­¤å®ƒæ˜¯æˆ‘ä»¬å¿…é¡»è¦æŒæ¡çš„ä¸€ç§æ ¼å¼ã€‚

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/0a/fd/0a1f3cc5b0d97efaeyy3f97c69e08bfd.png?wh=1920x835)

èƒ½å¤Ÿç”Ÿæˆå’Œè§£æMP4çš„å·¥å…·æœ‰å¾ˆå¤šï¼ŒFFmpegå°±æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚è€ƒè™‘å…¼å®¹æ€§çš„é—®é¢˜ï¼ŒFFmpegç»™å‡ºäº†å¾ˆå¤šå‚æ•°ï¼Œå…¶ä¸­æœ‰ä¸€äº›æ¯”è¾ƒå¸¸ç”¨çš„å‚æ•°ï¼Œå¦‚faststartï¼ˆæŠŠmoovå®¹å™¨ç§»åŠ¨åˆ°mdatå‰é¢ï¼‰ã€DASHï¼ˆå…¼å®¹DASHæ ¼å¼çš„MP4åˆ†ç‰‡ï¼‰ç­‰å‚æ•°æ˜¯éœ€è¦æˆ‘ä»¬æŒæ¡çš„ã€‚é™¤äº†FFmpegä¹‹å¤–ï¼Œåœ¨ç®€å•åœºæ™¯ä¸‹æˆ‘ä»¬è¿˜å¯ä»¥ç”¨GPACæˆ–è€…Shaka-PackageråšMP4çš„æµåª’ä½“å¤„ç†ã€‚

å­¦å®Œä»Šå¤©çš„å†…å®¹ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨FFmpegåšä¸€äº›MP4çš„æ—¥å¸¸å¤„ç†äº†ï¼Œå¦‚æœä½ æƒ³è¦è·å¾—æ›´å¤šçš„èƒ½åŠ›æ”¯æŒï¼Œéœ€è¦å†æ·±å…¥ç ”ç©¶ä¸€ä¸‹è¿™ä¸‰ä¸ªå·¥å…·çš„å‚æ•°ï¼Œå¹¶ä¸”åŠ¨æ‰‹å»æ“ä½œä¸€ä¸‹ã€‚

## æ€è€ƒé¢˜

ä¸€ä¸ªè§†é¢‘æµè½¬æˆMP4æ–‡ä»¶æ—¶ï¼Œå¦‚ä½•ç”¨FFmpegå¯¹è§†é¢‘æµå†…å®¹åšåŠ å¯†å‘¢ï¼ŸåŠ å¯†ä¹‹åå¦‚ä½•ç”¨FFmpegè§£å¯†å¹¶é¡ºåˆ©åœ°æ’­æ”¾å‡ºæ¥å‘¢ï¼Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºç•™ä¸‹ä½ çš„æ€è€ƒï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼
<div><strong>ç²¾é€‰ç•™è¨€ï¼ˆ4ï¼‰</strong></div><ul>
<li><span>peter</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ1ï¼‰<p>è¯·æ•™è€å¸ˆå‡ ä¸ªé—®é¢˜ï¼š
Q1ï¼šFFmpegèƒ½å¤Ÿç”ŸæˆMP4æ–‡ä»¶å—ï¼Ÿ
æ–‡ä¸­æé«˜ç”¨GPACç­‰å·¥å…·MP4æ–‡ä»¶ï¼Œè¯·é—®FFmpegèƒ½ç”ŸæˆMP4æ–‡ä»¶å—ï¼Ÿ

Q2ï¼šæ€ä¹ˆé€šè¿‡æŸ¥å¸®åŠ©æ¥è§£å†³ä¸€ä¸ªå…·ä½“é—®é¢˜ï¼Ÿ
é—®é¢˜ï¼šæˆ‘ä¹°äº†è€å¸ˆçš„ã€ŠFFmpegä»å…¥é—¨åˆ°ç²¾é€šã€‹ï¼Œæ“ä½œç¬¬äºŒç« çš„ä¸€ä¸ªä¾‹å­æ—¶é‡åˆ°é—®é¢˜ï¼š
ffplay -debug vis_mb_type -window_title &quot;show vis_mb_type&quot; -ss 30 -t 20 -autoexit cas.mp4

Undefined constant or missing &#39;(&#39; in &#39;vis_mb_type&#39;
[aac @ 00000237ca4cff80] Unable to parse option value &quot;vis_mb_type&quot;
[aac @ 00000237ca4cff80] Error setting option debug to value vis_mb_type.

é¦–å…ˆè¿™ä¸ªé—®é¢˜æ€ä¹ˆè§£å†³ï¼Ÿ å…¶æ¬¡ï¼Œæˆ‘ç”¨çš„æœ€æ–°çš„5.1ç‰ˆæœ¬ï¼Œä¹¦ä¸Šç”¨çš„ä¼¼ä¹æ˜¯3.Xç‰ˆæœ¬ï¼Œæ„Ÿè§‰åº”è¯¥æ˜¯ç‰ˆæœ¬ä¸åŒå¯¼è‡´çš„ã€‚æˆ‘å°è¯•äº†æŸ¥å¸®åŠ©æ¥è§£å†³ï¼Œä½†æ²¡æœ‰æˆåŠŸã€‚ è¯·é—®ï¼šæ€ä¹ˆä»å¸®åŠ©ä¸­æŸ¥vis_mb_typeçš„ç”¨æ³•ï¼Ÿ 


Q3ï¼šFFmpegï¼Œè€å¸ˆç”¨çš„æ—¶å€™ç‰ˆæœ¬æ˜¯å¤šå°‘ï¼Ÿ
æˆ‘ç”¨çš„æ˜¯æœ€æ–°çš„5.1ç‰ˆæœ¬ï¼Œæ‰§è¡Œffmpeg -h muxer=mp4åï¼Œæ˜¾ç¤ºï¼šDefault video codec: mpeg4ï¼Œ
ç¼ºçœè§†é¢‘ç¼–ç æ˜¯mpeg4ï¼Œä¸æ˜¯h264ã€‚

Q4ï¼šmoov ä¸ mdat çš„å‰åä½ç½®å…³ç³»ï¼Œå¯¹æ’­æ”¾æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ

Q5ï¼šèƒ½å¦æä¾›å¯æ‰§è¡Œçš„mp4infoï¼Œä»¥åŠGPACå’ŒShaka-Packagerï¼Ÿ
æˆ‘ä»å®˜ç½‘ä¸‹è½½äº†mp4info,è§£å‹åæ˜¯â€œMP4Info-0.3.3.gemâ€ï¼Œæ— æ³•æ‰§è¡Œã€‚è€å¸ˆå¦‚æœæœ‰å¯æ‰§è¡Œçš„mp4infoï¼Œèƒ½å¦æä¾›ä¸€ä¸ªä¸‹è½½åœ°å€ï¼Ÿè¿˜æœ‰GPACå’ŒShaka-Packagerç­‰å·¥å…·ï¼Œèƒ½å¦æ”¾åˆ°ä¸€ä¸ªåœ°æ–¹ä¾›ä¸‹è½½ï¼Ÿ ï¼ˆè¿™ä¸ªæœ‰ç‚¹éš¾ä¸ºè€å¸ˆï¼ŒæŠ±æ­‰ï¼Œä¸æ–¹ä¾¿çš„è¯å¯ä»¥å¿½ç•¥è¿™ä¸ªé—®é¢˜ï¼›æˆ‘çš„å·¥ä½œå’ŒéŸ³è§†é¢‘æ— å…³ï¼Œå¹³æ—¶å·¥ä½œå¿™ï¼Œæ¯å¤©åªèƒ½æŠ½å‡ºéƒ¨åˆ†æ—¶é—´çœ‹ä¸“æ ï¼Œå®åœ¨æ²¡æœ‰æ—¶é—´ï¼‰</p>2022-08-10</li><br/><li><span>jcy</span> ğŸ‘ï¼ˆ1ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>ç®€å•è§£ç­”æ€è€ƒé¢˜ï¼š

åŠ å¯†è§†é¢‘
ffmpeg -i test.mkv -vcodec copy -acodec copy -t 5 -encryption_scheme cenc-aes-ctr -encryption_key 76a6c65c5ea762046bd749a2e632ccbb -encryption_kid a7e61c373e219033c21091fa607bf3b8 test.mp4

è§£å¯†æ’­æ”¾ï¼š
ffplay SampleVideo_1280x720_1mb_encrypted.mp4 -decryption_key 76a6c65c5ea762046bd749a2e632ccbb</p>2022-08-24</li><br/><li><span>ifelse</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>å­¦ä¹ æ‰“å¡</p>2023-12-26</li><br/><li><span>æœ¨å¶äººKing</span> ğŸ‘ï¼ˆ0ï¼‰ ğŸ’¬ï¼ˆ0ï¼‰<p>æ‰“å¡</p>2023-07-05</li><br/>
</ul>